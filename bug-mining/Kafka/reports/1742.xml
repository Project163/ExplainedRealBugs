<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:05:11 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-6238] Issues with protocol version when applying a rolling upgrade to 1.0.0</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-6238</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Hello,&lt;/p&gt;

&lt;p&gt;I am trying to perform a rolling upgrade from 0.10.0.1 to 1.0.0, and according to the instructions in the documentation, I should only have to upgrade the &quot;inter.broker.protocol.version&quot; parameter in the first step. But after setting the value to &quot;0.10.0&quot; or &quot;0.10.0.1&quot; (tried both), the broker refuses to start with the following error:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[2017-11-20 08:28:46,620] FATAL  (kafka.Kafka$)
java.lang.IllegalArgumentException: requirement failed: log.message.format.version 1.0-IV0 cannot be used when inter.broker.protocol.version is set to 0.10.0.1
        at scala.Predef$.require(Predef.scala:224)
        at kafka.server.KafkaConfig.validateValues(KafkaConfig.scala:1205)
        at kafka.server.KafkaConfig.&amp;lt;init&amp;gt;(KafkaConfig.scala:1170)
        at kafka.server.KafkaConfig$.fromProps(KafkaConfig.scala:881)
        at kafka.server.KafkaConfig$.fromProps(KafkaConfig.scala:878)
        at kafka.server.KafkaServerStartable$.fromProps(KafkaServerStartable.scala:28)
        at kafka.Kafka$.main(Kafka.scala:82)
        at kafka.Kafka.main(Kafka.scala)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I checked the instructions for rolling upgrades to previous versions (namely 0.11.0.0), and in here it&apos;s stated that is also needed to upgrade the &quot;log.message.format.version&quot; parameter in two stages. I have tried that and the upgrade worked. It seems it still applies to version 1.0.0, so I&apos;m not sure if this is wrong documentation, or an actual issue with kafka since it should work as stated in the docs.&lt;/p&gt;

&lt;p&gt;Regards,&lt;br/&gt;
Diego Louz&#225;n&lt;/p&gt;</description>
                <environment></environment>
        <key id="13119610">KAFKA-6238</key>
            <summary>Issues with protocol version when applying a rolling upgrade to 1.0.0</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hachikuji">Jason Gustafson</assignee>
                                    <reporter username="dlouzan">Diego Louzan Martinez</reporter>
                        <labels>
                    </labels>
                <created>Mon, 20 Nov 2017 11:05:27 +0000</created>
                <updated>Tue, 29 Jan 2019 12:26:38 +0000</updated>
                            <resolved>Wed, 21 Feb 2018 09:43:12 +0000</resolved>
                                    <version>1.0.0</version>
                                    <fixVersion>1.0.1</fixVersion>
                    <fixVersion>1.1.0</fixVersion>
                    <fixVersion>2.0.0</fixVersion>
                                    <component>documentation</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="16259118" author="ijuma" created="Mon, 20 Nov 2017 11:28:12 +0000"  >&lt;p&gt;Thanks for the report. This is a bug in the documentation. It is correct if you are upgrading from 0.11.0.x, but not if you are upgrading from an older version.&lt;/p&gt;</comment>
                            <comment id="16259120" author="ijuma" created="Mon, 20 Nov 2017 11:29:00 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hachikuji&quot; class=&quot;user-hover&quot; rel=&quot;hachikuji&quot;&gt;hachikuji&lt;/a&gt;, can you please submit a fix?&lt;/p&gt;</comment>
                            <comment id="16263636" author="hachikuji" created="Thu, 23 Nov 2017 01:03:26 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/apache/kafka/pull/4256&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/4256&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16264421" author="githubbot" created="Thu, 23 Nov 2017 14:48:07 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/4256&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/4256&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16362659" author="bobrik" created="Tue, 13 Feb 2018 16:59:31 +0000"  >&lt;p&gt;We&apos;re upgrading from 0.11.0 and still see:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Feb 13 16:46:15 myhost kafka[16170]: java.lang.IllegalArgumentException: requirement failed: log.message.format.version 1.0-IV0 cannot be used when inter.broker.protocol.version is set to 0.11.0
Feb 13 16:46:15 myhost kafka[16170]:         at scala.Predef$.require(Predef.scala:277)
Feb 13 16:46:15 myhost kafka[16170]:         at kafka.server.KafkaConfig.validateValues(KafkaConfig.scala:1206)
Feb 13 16:46:15 myhost kafka[16170]:         at kafka.server.KafkaConfig.&amp;lt;init&amp;gt;(KafkaConfig.scala:1170)
Feb 13 16:46:15 myhost kafka[16170]:         at kafka.server.KafkaConfig$.fromProps(KafkaConfig.scala:881)
Feb 13 16:46:15 myhost kafka[16170]:         at kafka.server.KafkaConfig$.fromProps(KafkaConfig.scala:878)
Feb 13 16:46:15 myhost kafka[16170]:         at kafka.server.KafkaServerStartable$.fromProps(KafkaServerStartable.scala:28)
Feb 13 16:46:15 myhost kafka[16170]:         at kafka.Kafka$.main(Kafka.scala:82)
Feb 13 16:46:15 myhost kafka[16170]:         at kafka.Kafka.main(Kafka.scala)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This is with only inter.broker.protocol.version=0.11.0. Docs say:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;If you are upgrading from 0.11.0.x and you have not overridden the message format, then you only need to override the inter-broker protocol format.&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;inter.broker.protocol.version=CURRENT_KAFKA_VERSION (e.g. 0.8.2, 0.9.0, 0.10.0, 0.10.1, 0.10.2, 0.11.0).&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16367880" author="hachikuji" created="Fri, 16 Feb 2018 21:06:00 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bobrik&quot; class=&quot;user-hover&quot; rel=&quot;bobrik&quot;&gt;bobrik&lt;/a&gt; Thanks for reporting. It looks like there is a bug in the config validation. I will submit a patch. I think a workaround would be to set the message format to 0.11.0 at the same time as the inter-broker version. Then you can remove them both after the second rolling restart.&lt;/p&gt;</comment>
                            <comment id="16367886" author="bobrik" created="Fri, 16 Feb 2018 21:13:45 +0000"  >&lt;p&gt;Thanks, that&apos;s precisely what we&apos;ve done.&lt;/p&gt;</comment>
                            <comment id="16368135" author="hachikuji" created="Sat, 17 Feb 2018 07:57:12 +0000"  >&lt;p&gt;Reopening this since there is a bug in the config validation.&lt;/p&gt;</comment>
                            <comment id="16368451" author="hachikuji" created="Sun, 18 Feb 2018 07:05:07 +0000"  >&lt;p&gt;PR here: &lt;a href=&quot;https://github.com/apache/kafka/pull/4583&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/4583&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16371152" author="damianguy" created="Wed, 21 Feb 2018 09:43:12 +0000"  >&lt;p&gt;Issue resolved by pull request 4583&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/kafka/pull/4583&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/4583&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16371154" author="githubbot" created="Wed, 21 Feb 2018 09:43:15 +0000"  >&lt;p&gt;dguy closed pull request #4583: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6238&quot; title=&quot;Issues with protocol version when applying a rolling upgrade to 1.0.0&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-6238&quot;&gt;&lt;del&gt;KAFKA-6238&lt;/del&gt;&lt;/a&gt;; Fix inter-broker protocol message format compatibility check&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/4583&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/4583&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/clients/src/main/java/org/apache/kafka/common/record/RecordFormat.java b/clients/src/main/java/org/apache/kafka/common/record/RecordFormat.java&lt;br/&gt;
new file mode 100644&lt;br/&gt;
index 00000000000..e71ec599f41&lt;br/&gt;
&amp;#8212; /dev/null&lt;br/&gt;
+++ b/clients/src/main/java/org/apache/kafka/common/record/RecordFormat.java&lt;br/&gt;
@@ -0,0 +1,41 @@&lt;br/&gt;
+/*&lt;br/&gt;
+ * Licensed to the Apache Software Foundation (ASF) under one or more&lt;br/&gt;
+ * contributor license agreements. See the NOTICE file distributed with&lt;br/&gt;
+ * this work for additional information regarding copyright ownership.&lt;br/&gt;
+ * The ASF licenses this file to You under the Apache License, Version 2.0&lt;br/&gt;
+ * (the &quot;License&quot;); you may not use this file except in compliance with&lt;br/&gt;
+ * the License. You may obtain a copy of the License at&lt;br/&gt;
+ *&lt;br/&gt;
+ *    &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
+ *&lt;br/&gt;
+ * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
+ * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
+ * See the License for the specific language governing permissions and&lt;br/&gt;
+ * limitations under the License.&lt;br/&gt;
+ */&lt;br/&gt;
+package org.apache.kafka.common.record;&lt;br/&gt;
+&lt;br/&gt;
+public enum RecordFormat {&lt;br/&gt;
+    V0(0), V1(1), V2(2);&lt;br/&gt;
+&lt;br/&gt;
+    public final byte value;&lt;br/&gt;
+&lt;br/&gt;
+    RecordFormat(int value) &lt;/p&gt;
{
+        this.value = (byte) value;
+    }
&lt;p&gt;+&lt;br/&gt;
+    public static RecordFormat lookup(byte version) {&lt;br/&gt;
+        switch (version) &lt;/p&gt;
{
+            case 0: return V0;
+            case 1: return V1;
+            case 2: return V2;
+            default: throw new IllegalArgumentException(&quot;Unknown format version: &quot; + version);
+        }
&lt;p&gt;+    }&lt;br/&gt;
+&lt;br/&gt;
+    public static RecordFormat current() &lt;/p&gt;
{
+        return V2;
+    }
&lt;p&gt;+&lt;br/&gt;
+}&lt;br/&gt;
diff --git a/core/src/main/scala/kafka/api/ApiVersion.scala b/core/src/main/scala/kafka/api/ApiVersion.scala&lt;br/&gt;
index b8329c1ece2..9270a7a3b01 100644&lt;br/&gt;
&amp;#8212; a/core/src/main/scala/kafka/api/ApiVersion.scala&lt;br/&gt;
+++ b/core/src/main/scala/kafka/api/ApiVersion.scala&lt;br/&gt;
@@ -17,7 +17,7 @@&lt;/p&gt;

&lt;p&gt; package kafka.api&lt;/p&gt;

&lt;p&gt;-import org.apache.kafka.common.record.RecordBatch&lt;br/&gt;
+import org.apache.kafka.common.record.RecordFormat&lt;/p&gt;

&lt;p&gt; /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;This class contains the different Kafka versions.&lt;br/&gt;
@@ -90,11 +90,23 @@ object ApiVersion {&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;   def latestVersion = versionNameMap.values.max&lt;/p&gt;

&lt;p&gt;+  def allVersions: Set&lt;span class=&quot;error&quot;&gt;&amp;#91;ApiVersion&amp;#93;&lt;/span&gt; = &lt;/p&gt;
{
+    versionNameMap.values.toSet
+  }
&lt;p&gt;+&lt;br/&gt;
+  def minVersionForMessageFormat(messageFormatVersion: RecordFormat): String = {&lt;br/&gt;
+    messageFormatVersion match &lt;/p&gt;
{
+      case RecordFormat.V0 =&amp;gt; &quot;0.8.0&quot;
+      case RecordFormat.V1 =&amp;gt; &quot;0.10.0&quot;
+      case RecordFormat.V2 =&amp;gt; &quot;0.11.0&quot;
+      case _ =&amp;gt; throw new IllegalArgumentException(s&quot;Invalid message format version $messageFormatVersion&quot;)
+    }
&lt;p&gt;+  }&lt;br/&gt;
 }&lt;/p&gt;

&lt;p&gt; sealed trait ApiVersion extends Ordered&lt;span class=&quot;error&quot;&gt;&amp;#91;ApiVersion&amp;#93;&lt;/span&gt; {&lt;br/&gt;
   val version: String&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;val messageFormatVersion: Byte&lt;br/&gt;
+  val messageFormatVersion: RecordFormat&lt;br/&gt;
   val id: Int&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;   override def compare(that: ApiVersion): Int =&lt;br/&gt;
@@ -106,90 +118,90 @@ sealed trait ApiVersion extends Ordered&lt;span class=&quot;error&quot;&gt;&amp;#91;ApiVersion&amp;#93;&lt;/span&gt; {&lt;br/&gt;
 // Keep the IDs in order of versions&lt;br/&gt;
 case object KAFKA_0_8_0 extends ApiVersion &lt;/p&gt;
{
   val version: String = &quot;0.8.0.X&quot;
-  val messageFormatVersion: Byte = RecordBatch.MAGIC_VALUE_V0
+  val messageFormatVersion = RecordFormat.V0
   val id: Int = 0
 }

&lt;p&gt; case object KAFKA_0_8_1 extends ApiVersion &lt;/p&gt;
{
   val version: String = &quot;0.8.1.X&quot;
-  val messageFormatVersion: Byte = RecordBatch.MAGIC_VALUE_V0
+  val messageFormatVersion = RecordFormat.V0
   val id: Int = 1
 }

&lt;p&gt; case object KAFKA_0_8_2 extends ApiVersion &lt;/p&gt;
{
   val version: String = &quot;0.8.2.X&quot;
-  val messageFormatVersion: Byte = RecordBatch.MAGIC_VALUE_V0
+  val messageFormatVersion = RecordFormat.V0
   val id: Int = 2
 }

&lt;p&gt; case object KAFKA_0_9_0 extends ApiVersion &lt;/p&gt;
{
   val version: String = &quot;0.9.0.X&quot;
-  val messageFormatVersion: Byte = RecordBatch.MAGIC_VALUE_V0
+  val messageFormatVersion = RecordFormat.V0
   val id: Int = 3
 }

&lt;p&gt; case object KAFKA_0_10_0_IV0 extends ApiVersion &lt;/p&gt;
{
   val version: String = &quot;0.10.0-IV0&quot;
-  val messageFormatVersion: Byte = RecordBatch.MAGIC_VALUE_V1
+  val messageFormatVersion = RecordFormat.V1
   val id: Int = 4
 }

&lt;p&gt; case object KAFKA_0_10_0_IV1 extends ApiVersion &lt;/p&gt;
{
   val version: String = &quot;0.10.0-IV1&quot;
-  val messageFormatVersion: Byte = RecordBatch.MAGIC_VALUE_V1
+  val messageFormatVersion = RecordFormat.V1
   val id: Int = 5
 }

&lt;p&gt; case object KAFKA_0_10_1_IV0 extends ApiVersion &lt;/p&gt;
{
   val version: String = &quot;0.10.1-IV0&quot;
-  val messageFormatVersion: Byte = RecordBatch.MAGIC_VALUE_V1
+  val messageFormatVersion = RecordFormat.V1
   val id: Int = 6
 }

&lt;p&gt; case object KAFKA_0_10_1_IV1 extends ApiVersion &lt;/p&gt;
{
   val version: String = &quot;0.10.1-IV1&quot;
-  val messageFormatVersion: Byte = RecordBatch.MAGIC_VALUE_V1
+  val messageFormatVersion = RecordFormat.V1
   val id: Int = 7
 }

&lt;p&gt; case object KAFKA_0_10_1_IV2 extends ApiVersion &lt;/p&gt;
{
   val version: String = &quot;0.10.1-IV2&quot;
-  val messageFormatVersion: Byte = RecordBatch.MAGIC_VALUE_V1
+  val messageFormatVersion = RecordFormat.V1
   val id: Int = 8
 }

&lt;p&gt; case object KAFKA_0_10_2_IV0 extends ApiVersion &lt;/p&gt;
{
   val version: String = &quot;0.10.2-IV0&quot;
-  val messageFormatVersion: Byte = RecordBatch.MAGIC_VALUE_V1
+  val messageFormatVersion = RecordFormat.V1
   val id: Int = 9
 }

&lt;p&gt; case object KAFKA_0_11_0_IV0 extends ApiVersion &lt;/p&gt;
{
   val version: String = &quot;0.11.0-IV0&quot;
-  val messageFormatVersion: Byte = RecordBatch.MAGIC_VALUE_V2
+  val messageFormatVersion = RecordFormat.V2
   val id: Int = 10
 }

&lt;p&gt; case object KAFKA_0_11_0_IV1 extends ApiVersion &lt;/p&gt;
{
   val version: String = &quot;0.11.0-IV1&quot;
-  val messageFormatVersion: Byte = RecordBatch.MAGIC_VALUE_V2
+  val messageFormatVersion = RecordFormat.V2
   val id: Int = 11
 }

&lt;p&gt; case object KAFKA_0_11_0_IV2 extends ApiVersion &lt;/p&gt;
{
   val version: String = &quot;0.11.0-IV2&quot;
-  val messageFormatVersion: Byte = RecordBatch.MAGIC_VALUE_V2
+  val messageFormatVersion = RecordFormat.V2
   val id: Int = 12
 }

&lt;p&gt; case object KAFKA_1_0_IV0 extends ApiVersion &lt;/p&gt;
{
   val version: String = &quot;1.0-IV0&quot;
-  val messageFormatVersion: Byte = RecordBatch.MAGIC_VALUE_V2
+  val messageFormatVersion = RecordFormat.V2
   val id: Int = 13
 }

&lt;p&gt; case object KAFKA_1_1_IV0 extends ApiVersion &lt;/p&gt;
{
   val version: String = &quot;1.1-IV0&quot;
-  val messageFormatVersion: Byte = RecordBatch.MAGIC_VALUE_V2
+  val messageFormatVersion = RecordFormat.V2
   val id: Int = 14
 }
&lt;p&gt;diff --git a/core/src/main/scala/kafka/log/Log.scala b/core/src/main/scala/kafka/log/Log.scala&lt;br/&gt;
index fec984cf5e1..257dd8f9ba4 100644&lt;br/&gt;
&amp;#8212; a/core/src/main/scala/kafka/log/Log.scala&lt;br/&gt;
+++ b/core/src/main/scala/kafka/log/Log.scala&lt;br/&gt;
@@ -465,7 +465,7 @@ class Log(@volatile var dir: File,&lt;/p&gt;

&lt;p&gt;   private def loadProducerState(lastOffset: Long, reloadFromCleanShutdown: Boolean): Unit = lock synchronized {&lt;br/&gt;
     checkIfMemoryMappedBufferClosed()&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;val messageFormatVersion = config.messageFormatVersion.messageFormatVersion&lt;br/&gt;
+    val messageFormatVersion = config.messageFormatVersion.messageFormatVersion.value&lt;br/&gt;
     info(s&quot;Loading producer state from offset $lastOffset for partition $topicPartition with message &quot; +&lt;br/&gt;
       s&quot;format version $messageFormatVersion&quot;)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;@@ -663,7 +663,7 @@ class Log(@volatile var dir: File,&lt;br/&gt;
               appendInfo.sourceCodec,&lt;br/&gt;
               appendInfo.targetCodec,&lt;br/&gt;
               config.compact,&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;config.messageFormatVersion.messageFormatVersion,&lt;br/&gt;
+              config.messageFormatVersion.messageFormatVersion.value,&lt;br/&gt;
               config.messageTimestampType,&lt;br/&gt;
               config.messageTimestampDifferenceMaxMs,&lt;br/&gt;
               leaderEpoch,&lt;br/&gt;
diff --git a/core/src/main/scala/kafka/server/KafkaApis.scala b/core/src/main/scala/kafka/server/KafkaApis.scala&lt;br/&gt;
index b84587f55c2..9e79afa2a5b 100644
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/core/src/main/scala/kafka/server/KafkaApis.scala&lt;br/&gt;
+++ b/core/src/main/scala/kafka/server/KafkaApis.scala&lt;br/&gt;
@@ -59,7 +59,7 @@ import DescribeLogDirsResponse.LogDirInfo&lt;br/&gt;
 import org.apache.kafka.common.security.auth.
{KafkaPrincipal, SecurityProtocol}
&lt;p&gt; import org.apache.kafka.common.security.token.delegation.&lt;/p&gt;
{DelegationToken, TokenInformation}&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;-import scala.collection.&lt;/p&gt;
{mutable, _}
&lt;p&gt;+import scala.collection._&lt;br/&gt;
 import scala.collection.JavaConverters._&lt;br/&gt;
 import scala.collection.mutable.ArrayBuffer&lt;br/&gt;
 import scala.util.&lt;/p&gt;
{Failure, Success, Try}
&lt;p&gt;@@ -1347,7 +1347,8 @@ class KafkaApis(val requestChannel: RequestChannel,&lt;br/&gt;
       if (apiVersionRequest.hasUnsupportedRequestVersion)&lt;br/&gt;
         apiVersionRequest.getErrorResponse(requestThrottleMs, Errors.UNSUPPORTED_VERSION.exception)&lt;br/&gt;
       else&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;ApiVersionsResponse.apiVersionsResponse(requestThrottleMs, config.interBrokerProtocolVersion.messageFormatVersion)&lt;br/&gt;
+        ApiVersionsResponse.apiVersionsResponse(requestThrottleMs,&lt;br/&gt;
+          config.interBrokerProtocolVersion.messageFormatVersion.value)&lt;br/&gt;
     }&lt;br/&gt;
     sendResponseMaybeThrottle(request, createResponseCallback)&lt;br/&gt;
   }&lt;br/&gt;
diff --git a/core/src/main/scala/kafka/server/KafkaConfig.scala b/core/src/main/scala/kafka/server/KafkaConfig.scala&lt;br/&gt;
index 529d0e639d9..8b2fb1044e0 100755
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/core/src/main/scala/kafka/server/KafkaConfig.scala&lt;br/&gt;
+++ b/core/src/main/scala/kafka/server/KafkaConfig.scala&lt;br/&gt;
@@ -1330,8 +1330,13 @@ class KafkaConfig(val props: java.util.Map&lt;span class=&quot;error&quot;&gt;&amp;#91;_, _&amp;#93;&lt;/span&gt;, doLog: Boolean, dynamicConfigO&lt;br/&gt;
     require(!advertisedListeners.exists(endpoint =&amp;gt; endpoint.host==&quot;0.0.0.0&quot;),&lt;br/&gt;
       s&quot;${KafkaConfig.AdvertisedListenersProp} cannot use the nonroutable meta-address 0.0.0.0. &quot;+&lt;br/&gt;
       s&quot;Use a routable IP address.&quot;)&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;require(interBrokerProtocolVersion &amp;gt;= logMessageFormatVersion,&lt;/li&gt;
	&lt;li&gt;s&quot;log.message.format.version $logMessageFormatVersionString cannot be used when inter.broker.protocol.version is set to $interBrokerProtocolVersionString&quot;)&lt;br/&gt;
+&lt;br/&gt;
+    val messageFormatVersion = logMessageFormatVersion.messageFormatVersion&lt;br/&gt;
+    require(interBrokerProtocolVersion.messageFormatVersion.value &amp;gt;= messageFormatVersion.value,&lt;br/&gt;
+      s&quot;log.message.format.version $logMessageFormatVersionString can only be used when &quot; +&lt;br/&gt;
+        &quot;inter.broker.protocol.version is set to version &quot; +&lt;br/&gt;
+        s&quot;${ApiVersion.minVersionForMessageFormat(messageFormatVersion)} or higher&quot;)&lt;br/&gt;
+&lt;br/&gt;
     val interBrokerUsesSasl = interBrokerSecurityProtocol == SecurityProtocol.SASL_PLAINTEXT || interBrokerSecurityProtocol == SecurityProtocol.SASL_SSL&lt;br/&gt;
     require(!interBrokerUsesSasl || saslInterBrokerHandshakeRequestEnable || saslMechanismInterBrokerProtocol == SaslConfigs.GSSAPI_MECHANISM,&lt;br/&gt;
       s&quot;Only GSSAPI mechanism is supported for inter-broker communication with SASL when inter.broker.protocol.version is set to $interBrokerProtocolVersionString&quot;)&lt;br/&gt;
diff --git a/core/src/main/scala/kafka/server/ReplicaManager.scala b/core/src/main/scala/kafka/server/ReplicaManager.scala&lt;br/&gt;
index f4bfe39c9ef..470842e9d9e 100644
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/core/src/main/scala/kafka/server/ReplicaManager.scala&lt;br/&gt;
+++ b/core/src/main/scala/kafka/server/ReplicaManager.scala&lt;br/&gt;
@@ -1002,7 +1002,7 @@ class ReplicaManager(val config: KafkaConfig,&lt;br/&gt;
   }&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;   def getMagic(topicPartition: TopicPartition): Option&lt;span class=&quot;error&quot;&gt;&amp;#91;Byte&amp;#93;&lt;/span&gt; =&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;getReplica(topicPartition).flatMap(&lt;em&gt;.log.map(&lt;/em&gt;.config.messageFormatVersion.messageFormatVersion))&lt;br/&gt;
+    getReplica(topicPartition).flatMap(&lt;em&gt;.log.map(&lt;/em&gt;.config.messageFormatVersion.messageFormatVersion.value))&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;   def maybeUpdateMetadataCache(correlationId: Int, updateMetadataRequest: UpdateMetadataRequest) : Seq&lt;span class=&quot;error&quot;&gt;&amp;#91;TopicPartition&amp;#93;&lt;/span&gt; =  {&lt;br/&gt;
     replicaStateChangeLock synchronized {&lt;br/&gt;
diff --git a/core/src/test/scala/unit/kafka/api/ApiVersionTest.scala b/core/src/test/scala/unit/kafka/api/ApiVersionTest.scala&lt;br/&gt;
index 6fc69747f5d..88c9d523f9b 100644&lt;br/&gt;
&amp;#8212; a/core/src/test/scala/unit/kafka/api/ApiVersionTest.scala&lt;br/&gt;
+++ b/core/src/test/scala/unit/kafka/api/ApiVersionTest.scala&lt;br/&gt;
@@ -17,6 +17,7 @@&lt;/p&gt;

&lt;p&gt; package kafka.api&lt;/p&gt;

&lt;p&gt;+import org.apache.kafka.common.record.RecordFormat&lt;br/&gt;
 import org.junit.Test&lt;br/&gt;
 import org.junit.Assert._&lt;/p&gt;

&lt;p&gt;@@ -74,4 +75,16 @@ class ApiVersionTest &lt;/p&gt;
{
     assertEquals(KAFKA_1_0_IV0, ApiVersion(&quot;1.0.1&quot;))
   }

&lt;p&gt;+  @Test&lt;br/&gt;
+  def testMinVersionForMessageFormat(): Unit = &lt;/p&gt;
{
+    assertEquals(&quot;0.8.0&quot;, ApiVersion.minVersionForMessageFormat(RecordFormat.V0))
+    assertEquals(&quot;0.10.0&quot;, ApiVersion.minVersionForMessageFormat(RecordFormat.V1))
+    assertEquals(&quot;0.11.0&quot;, ApiVersion.minVersionForMessageFormat(RecordFormat.V2))
+
+    // Ensure that all message format versions have a defined min version so that we remember
+    // to update the function
+    for (messageFormatVersion &amp;lt;- RecordFormat.values)
+      assertNotNull(ApiVersion.minVersionForMessageFormat(messageFormatVersion))
+  }
&lt;p&gt;+&lt;br/&gt;
 }&lt;br/&gt;
diff --git a/core/src/test/scala/unit/kafka/server/KafkaConfigTest.scala b/core/src/test/scala/unit/kafka/server/KafkaConfigTest.scala&lt;br/&gt;
index 6b263342118..0213c12814e 100755&lt;br/&gt;
&amp;#8212; a/core/src/test/scala/unit/kafka/server/KafkaConfigTest.scala&lt;br/&gt;
+++ b/core/src/test/scala/unit/kafka/server/KafkaConfigTest.scala&lt;br/&gt;
@@ -522,6 +522,30 @@ class KafkaConfigTest {&lt;br/&gt;
     }&lt;br/&gt;
   }&lt;/p&gt;

&lt;p&gt;+  @Test&lt;br/&gt;
+  def testInterBrokerVersionMessageFormatCompatibility(): Unit = {&lt;br/&gt;
+    def buildConfig(interBrokerProtocol: ApiVersion, messageFormat: ApiVersion): KafkaConfig = &lt;/p&gt;
{
+      val props = TestUtils.createBrokerConfig(0, TestUtils.MockZkConnect, port = 8181)
+      props.put(KafkaConfig.InterBrokerProtocolVersionProp, interBrokerProtocol.version)
+      props.put(KafkaConfig.LogMessageFormatVersionProp, messageFormat.version)
+      KafkaConfig.fromProps(props)
+    }
&lt;p&gt;+&lt;br/&gt;
+    ApiVersion.allVersions.foreach { interBrokerVersion =&amp;gt;&lt;br/&gt;
+      ApiVersion.allVersions.foreach { messageFormatVersion =&amp;gt;&lt;br/&gt;
+        if (interBrokerVersion.messageFormatVersion.value &amp;gt;= messageFormatVersion.messageFormatVersion.value) &lt;/p&gt;
{
+          val config = buildConfig(interBrokerVersion, messageFormatVersion)
+          assertEquals(messageFormatVersion, config.logMessageFormatVersion)
+          assertEquals(interBrokerVersion, config.interBrokerProtocolVersion)
+        }
&lt;p&gt; else {&lt;br/&gt;
+          intercept&lt;span class=&quot;error&quot;&gt;&amp;#91;IllegalArgumentException&amp;#93;&lt;/span&gt; &lt;/p&gt;
{
+            buildConfig(interBrokerVersion, messageFormatVersion)
+          }
&lt;p&gt;+        }&lt;br/&gt;
+      }&lt;br/&gt;
+    }&lt;br/&gt;
+  }&lt;br/&gt;
+&lt;br/&gt;
   @Test&lt;br/&gt;
   def testFromPropsInvalid() {&lt;br/&gt;
     def getBaseProperties(): Properties = {&lt;br/&gt;
diff --git a/docs/upgrade.html b/docs/upgrade.html&lt;br/&gt;
index b3ae68f3daf..3ac293d8498 100644&lt;br/&gt;
&amp;#8212; a/docs/upgrade.html&lt;br/&gt;
+++ b/docs/upgrade.html&lt;br/&gt;
@@ -36,10 +36,10 @@ &amp;lt;h4&amp;gt;&amp;lt;a id=&quot;upgrade_1_1_0&quot; href=&quot;#upgrade_1_1_0&quot;&amp;gt;Upgrading from 0.8.x, 0.9.x, 0.1&lt;br/&gt;
             &amp;lt;li&amp;gt;log.message.format.version=CURRENT_MESSAGE_FORMAT_VERSION  (See &amp;lt;a href=&quot;#upgrade_10_performance_impact&quot;&amp;gt;potential performance impact&lt;br/&gt;
                 following the upgrade&amp;lt;/a&amp;gt; for the details on what this configuration does.)&amp;lt;/li&amp;gt;&lt;br/&gt;
         &amp;lt;/ul&amp;gt;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;If you are upgrading from 0.11.0.x and you have not overridden the message format, then you only need to override&lt;br/&gt;
+        If you are upgrading from 0.11.0.x or 1.0.x and you have not overridden the message format, then you only need to override&lt;br/&gt;
         the inter-broker protocol format.&lt;br/&gt;
         &amp;lt;ul&amp;gt;&lt;/li&gt;
	&lt;li&gt;&amp;lt;li&amp;gt;inter.broker.protocol.version=CURRENT_KAFKA_VERSION (e.g. 0.8.2, 0.9.0, 0.10.0, 0.10.1, 0.10.2, 0.11.0, 1.0).&amp;lt;/li&amp;gt;&lt;br/&gt;
+            &amp;lt;li&amp;gt;inter.broker.protocol.version=CURRENT_KAFKA_VERSION (0.11.0 or 1.0).&amp;lt;/li&amp;gt;&lt;br/&gt;
         &amp;lt;/ul&amp;gt;&lt;br/&gt;
     &amp;lt;/li&amp;gt;&lt;br/&gt;
     &amp;lt;li&amp;gt; Upgrade the brokers one at a time: shut down the broker, update the code, and restart it. &amp;lt;/li&amp;gt;&lt;br/&gt;
@@ -106,10 +106,11 @@ &amp;lt;h4&amp;gt;&amp;lt;a id=&quot;upgrade_1_0_0&quot; href=&quot;#upgrade_1_0_0&quot;&amp;gt;Upgrading from 0.8.x, 0.9.x, 0.1&lt;br/&gt;
             &amp;lt;li&amp;gt;log.message.format.version=CURRENT_MESSAGE_FORMAT_VERSION  (See &amp;lt;a href=&quot;#upgrade_10_performance_impact&quot;&amp;gt;potential performance impact&lt;br/&gt;
 		following the upgrade&amp;lt;/a&amp;gt; for the details on what this configuration does.)&amp;lt;/li&amp;gt;&lt;br/&gt;
         &amp;lt;/ul&amp;gt;&lt;/li&gt;
	&lt;li&gt;If you are upgrading from 0.11.0.x and you have not overridden the message format, then you only need to override&lt;/li&gt;
	&lt;li&gt;the inter-broker protocol format.&lt;br/&gt;
+	If you are upgrading from 0.11.0.x and you have not overridden the message format, you must set&lt;br/&gt;
+	both the message format version and the inter-broker protocol version to 0.11.0.&lt;br/&gt;
         &amp;lt;ul&amp;gt;&lt;/li&gt;
	&lt;li&gt;&amp;lt;li&amp;gt;inter.broker.protocol.version=CURRENT_KAFKA_VERSION (e.g. 0.8.2, 0.9.0, 0.10.0, 0.10.1, 0.10.2, 0.11.0).&amp;lt;/li&amp;gt;&lt;br/&gt;
+            &amp;lt;li&amp;gt;inter.broker.protocol.version=0.11.0&amp;lt;/li&amp;gt;&lt;br/&gt;
+            &amp;lt;li&amp;gt;log.message.format.version=0.11.0&amp;lt;/li&amp;gt;&lt;br/&gt;
         &amp;lt;/ul&amp;gt;&lt;br/&gt;
     &amp;lt;/li&amp;gt;&lt;br/&gt;
     &amp;lt;li&amp;gt; Upgrade the brokers one at a time: shut down the broker, update the code, and restart it. &amp;lt;/li&amp;gt;&lt;br/&gt;
@@ -117,9 +118,11 @@ &amp;lt;h4&amp;gt;&amp;lt;a id=&quot;upgrade_1_0_0&quot; href=&quot;#upgrade_1_0_0&quot;&amp;gt;Upgrading from 0.8.x, 0.9.x, 0.1&lt;br/&gt;
     &amp;lt;li&amp;gt; Restart the brokers one by one for the new protocol version to take effect. &amp;lt;/li&amp;gt;&lt;br/&gt;
     &amp;lt;li&amp;gt; If you have overridden the message format version as instructed above, then you need to do one more rolling restart to&lt;br/&gt;
         upgrade it to its latest version. Once all (or most) consumers have been upgraded to 0.11.0 or later,&lt;/li&gt;
	&lt;li&gt;change log.message.format.version to 1.0 on each broker and restart them one by one. Note that the older Scala consumer&lt;/li&gt;
	&lt;li&gt;does not support the new message format introduced in 0.11, so to avoid the performance cost of down-conversion (or to&lt;/li&gt;
	&lt;li&gt;take advantage of &amp;lt;a href=&quot;#upgrade_11_exactly_once_semantics&quot;&amp;gt;exactly once semantics&amp;lt;/a&amp;gt;), the newer Java consumer must be used.&amp;lt;/li&amp;gt;&lt;br/&gt;
+        change log.message.format.version to 1.0 on each broker and restart them one by one. If you are upgrading from&lt;br/&gt;
+        0.11.0 and log.message.format.version is set to 0.11.0, you can update the config and skip the rolling restart.&lt;br/&gt;
+        Note that the older Scala consumer does not support the new message format introduced in 0.11, so to avoid the&lt;br/&gt;
+        performance cost of down-conversion (or to take advantage of &amp;lt;a href=&quot;#upgrade_11_exactly_once_semantics&quot;&amp;gt;exactly once semantics&amp;lt;/a&amp;gt;),&lt;br/&gt;
+        the newer Java consumer must be used.&amp;lt;/li&amp;gt;&lt;br/&gt;
 &amp;lt;/ol&amp;gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; &amp;lt;p&amp;gt;&amp;lt;b&amp;gt;Additional Upgrade Notes:&amp;lt;/b&amp;gt;&amp;lt;/p&amp;gt;&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13212528">KAFKA-7881</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 38 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3mzrr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>