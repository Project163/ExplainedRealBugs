<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:08:40 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-6446] KafkaProducer with transactionId endless waits when bootstrap server is down</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-6446</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;When bootstrap server is down, a&#160;KafkaProducer&#160;with transactionId endless waits on&#160;initTransactions.&#160;&lt;/p&gt;

&lt;p&gt;The timeouts don&apos;t apply to that operation: don&apos;t&#160;honor the&#160;&lt;tt&gt;TRANSACTION_TIMEOUT_CONFIG.&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;Attached an example of my code to reproduce the scenario.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I opened this issue as suggested by&#160;&lt;a href=&quot;https://stackoverflow.com/users/1240763/gary-russell&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Gary Russell&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://stackoverflow.com/questions/48226546/defaultkafkaproducerfactory-with-transactionidprefix-endless-waits-when-bootstra&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://stackoverflow.com/questions/48226546/defaultkafkaproducerfactory-with-transactionidprefix-endless-waits-when-bootstra&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13130988">KAFKA-6446</key>
            <summary>KafkaProducer with transactionId endless waits when bootstrap server is down</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="huxi_2b">huxihx</assignee>
                                    <reporter username="edosciullo">Eduardo Sciullo</reporter>
                        <labels>
                            <label>exactly-once</label>
                    </labels>
                <created>Mon, 15 Jan 2018 10:29:18 +0000</created>
                <updated>Tue, 5 Mar 2019 00:46:43 +0000</updated>
                            <resolved>Tue, 27 Mar 2018 16:21:58 +0000</resolved>
                                    <version>0.11.0.0</version>
                    <version>1.0.0</version>
                                    <fixVersion>2.0.0</fixVersion>
                                    <component>clients</component>
                    <component>producer </component>
                        <due></due>
                            <votes>5</votes>
                                    <watches>12</watches>
                                                                                                                <comments>
                            <comment id="16343150" author="pnpie" created="Mon, 29 Jan 2018 09:57:48 +0000"  >&lt;p&gt;Hello,&lt;br/&gt;
I have a look at this and it appears that TRANSACTION_TIMEOUT_CONFIG is defined as the time to wait when &lt;b&gt;a producer tries to get the producer id from transaction coordinator by specifying transaction id&lt;/b&gt;, more concretely it&apos;s for &lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/clients/src/main/java/org/apache/kafka/common/requests/InitProducerIdRequest.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;InitProducerIdRequest&lt;/a&gt;.&lt;br/&gt;
But where we hang here is before InitProducerIdRequest, we need to find the transaction coordinator by sending a &lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/clients/src/main/java/org/apache/kafka/common/requests/FindCoordinatorRequest.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;FindCoordinatorRequest&lt;/a&gt;, in this phase we didn&apos;t deal with timeout so it leads to the &lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/clients/src/main/java/org/apache/kafka/clients/producer/internals/Sender.java#L161-L167&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Sender thread endless retrying to send FindCoordinatorRequest&lt;/a&gt;.&lt;/p&gt;


&lt;p&gt;I think anyway the producer shoud not be stuck in initTransactions() when it can&apos;t connect to the kafka cluster ? We should define a new TIMEOUT for connecting to the cluster (FindCoordinatorRequest) or applying the TRANSACTION_TIMEOUT_CONFIG to it directly ?&lt;/p&gt;</comment>
                            <comment id="16358163" author="huxi_2b" created="Fri, 9 Feb 2018 09:36:20 +0000"  >&lt;p&gt;Sounds like it&apos;s easy to&#160;replace await() with the timed version. However,&#160; there is another serious problem in this case in which Sender thread got stuck in the infinite loop in `maybeSendTransactionalRequest` which impedes the thread to be closed. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=becket_qin&quot; class=&quot;user-hover&quot; rel=&quot;becket_qin&quot;&gt;becket_qin&lt;/a&gt; Does it make sense?&lt;/p&gt;</comment>
                            <comment id="16358168" author="edosciullo" created="Fri, 9 Feb 2018 09:45:43 +0000"  >&lt;p&gt;The same behavior appears for commitTransaction, abortTransaction, etc.. methods of KafkaProducer (don&apos;t&#160;honor the&#160;&lt;tt&gt;TRANSACTION_TIMEOUT_CONFIG).&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=huxi_2b&quot; class=&quot;user-hover&quot; rel=&quot;huxi_2b&quot;&gt;huxi_2b&lt;/a&gt; I think that&#160;replace await() with the timed version is a good idea.&lt;/p&gt;</comment>
                            <comment id="16358171" author="huxi_2b" created="Fri, 9 Feb 2018 09:52:11 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=edosciullo&quot; class=&quot;user-hover&quot; rel=&quot;edosciullo&quot;&gt;edosciullo&lt;/a&gt; I tried this way and the fix passed on my local env. Since initTranscations is the very first method when a transaction&#160;starts, it&apos;s probably okay for us to only refine this method.&#160;&lt;/p&gt;

&lt;p&gt;However, even with this fix, the producer still failed be closed after throwing TimeoutException due to the fact that Sender thread got stuck and did not respond. I am not sure if it&apos;s fully safe to simply break from the catch clause in `maybeSendTransactionalRequest`.&lt;/p&gt;</comment>
                            <comment id="16361744" author="huxi_2b" created="Tue, 13 Feb 2018 02:51:55 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=apurva&quot; class=&quot;user-hover&quot; rel=&quot;apurva&quot;&gt;apurva&lt;/a&gt; Please take some time to see the comments above? Thanks.&lt;/p&gt;</comment>
                            <comment id="16361853" author="apurva" created="Tue, 13 Feb 2018 05:49:26 +0000"  >&lt;p&gt;IMO, the right solution here would be for the producer to transition to a `FATAL_ERROR` state so that the only possible operation afterward is to `close()` the producer. In reality, if a `transactionalId` is specified, but the producer can&apos;t connect the cluster and initialize transactions, it should be able to do nothing else. Otherwise we risk violating transactional semantics.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16361999" author="githubbot" created="Tue, 13 Feb 2018 08:43:56 +0000"  >&lt;p&gt;huxihx opened a new pull request #4563: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6446&quot; title=&quot;KafkaProducer with transactionId endless waits when bootstrap server is down&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-6446&quot;&gt;&lt;del&gt;KAFKA-6446&lt;/del&gt;&lt;/a&gt;: KafkaProducer should use timed version of `await` to avoid endless waiting&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/4563&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/4563&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6446&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-6446&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;   Replaced await() with timed version to avoid endless waiting and refined the code to have Sender thread able to exit from infinitely connecting the `bad` broker.&lt;/p&gt;

&lt;p&gt;   *More detailed description of your change,&lt;br/&gt;
   if necessary. The PR title and PR message become&lt;br/&gt;
   the squashed commit message, so use a separate&lt;br/&gt;
   comment to ping reviewers.*&lt;/p&gt;

&lt;p&gt;   *Summary of testing strategy (including rationale)&lt;br/&gt;
   for the feature or bug fix. Unit and/or integration&lt;br/&gt;
   tests are expected for any behaviour change and&lt;br/&gt;
   system tests should be considered for larger changes.*&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16415868" author="githubbot" created="Tue, 27 Mar 2018 16:21:21 +0000"  >&lt;p&gt;hachikuji closed pull request #4563: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6446&quot; title=&quot;KafkaProducer with transactionId endless waits when bootstrap server is down&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-6446&quot;&gt;&lt;del&gt;KAFKA-6446&lt;/del&gt;&lt;/a&gt;: KafkaProducer should use timed version of `await` to avoid endless waiting&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/4563&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/4563&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/clients/src/main/java/org/apache/kafka/clients/producer/KafkaProducer.java b/clients/src/main/java/org/apache/kafka/clients/producer/KafkaProducer.java&lt;br/&gt;
index 5fc9a1b9b38..a5af5b60093 100644&lt;br/&gt;
&amp;#8212; a/clients/src/main/java/org/apache/kafka/clients/producer/KafkaProducer.java&lt;br/&gt;
+++ b/clients/src/main/java/org/apache/kafka/clients/producer/KafkaProducer.java&lt;br/&gt;
@@ -256,6 +256,7 @@&lt;br/&gt;
     private final ProducerInterceptors&amp;lt;K, V&amp;gt; interceptors;&lt;br/&gt;
     private final ApiVersions apiVersions;&lt;br/&gt;
     private final TransactionManager transactionManager;&lt;br/&gt;
+    private TransactionalRequestResult initTransactionsResult;&lt;/p&gt;

&lt;p&gt;     /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;A producer is instantiated by providing a set of key-value pairs as configuration. Valid configuration strings&lt;br/&gt;
@@ -555,18 +556,36 @@ private static int parseAcks(String acksString) {&lt;/li&gt;
	&lt;li&gt;2. Gets the internal producer id and epoch, used in all future transactional&lt;/li&gt;
	&lt;li&gt;messages issued by the producer.&lt;br/&gt;
      *&lt;br/&gt;
+     * Note that this method will raise 
{@link TimeoutException}
&lt;p&gt; if the transactional state cannot&lt;br/&gt;
+     * be initialized before expiration of &lt;/p&gt;
{@code max.block.ms}
&lt;p&gt;. Additionally, it will raise &lt;/p&gt;
{@link InterruptException}
&lt;p&gt;+     * if interrupted. It is safe to retry in either case, but once the transactional state has been successfully&lt;br/&gt;
+     * initialized, this method should no longer be used.&lt;br/&gt;
+     *&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;@throws IllegalStateException if no transactional.id has been configured&lt;/li&gt;
	&lt;li&gt;@throws org.apache.kafka.common.errors.UnsupportedVersionException fatal error indicating the broker&lt;/li&gt;
	&lt;li&gt;does not support transactions (i.e. if its version is lower than 0.11.0.0)&lt;/li&gt;
	&lt;li&gt;@throws org.apache.kafka.common.errors.AuthorizationException fatal error indicating that the configured&lt;/li&gt;
	&lt;li&gt;transactional.id is not authorized. See the exception for more details&lt;/li&gt;
	&lt;li&gt;@throws KafkaException if the producer has encountered a previous fatal error or for any other unexpected error&lt;br/&gt;
+     * @throws TimeoutException if the time taken for initialize the transaction has surpassed &amp;lt;code&amp;gt;max.block.ms&amp;lt;/code&amp;gt;.&lt;br/&gt;
+     * @throws InterruptException if the thread is interrupted while blocked&lt;br/&gt;
      */&lt;br/&gt;
     public void initTransactions() {&lt;br/&gt;
         throwIfNoTransactionManager();&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;TransactionalRequestResult result = transactionManager.initializeTransactions();&lt;/li&gt;
	&lt;li&gt;sender.wakeup();&lt;/li&gt;
	&lt;li&gt;result.await();&lt;br/&gt;
+        if (initTransactionsResult == null) 
{
+            initTransactionsResult = transactionManager.initializeTransactions();
+            sender.wakeup();
+        }
&lt;p&gt;+&lt;br/&gt;
+        try &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+            if (initTransactionsResult.await(maxBlockTimeMs, TimeUnit.MILLISECONDS)) {
+                initTransactionsResult = null;
+            } else {
+                throw new TimeoutException(&quot;Timeout expired while initializing transactional state in &quot; + maxBlockTimeMs + &quot;ms.&quot;);
+            }+        }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt; catch (InterruptedException e) &lt;/p&gt;
{
+            throw new InterruptException(&quot;Initialize transactions interrupted.&quot;, e);
+        }
&lt;p&gt;     }&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     /**&lt;br/&gt;
diff --git a/clients/src/main/java/org/apache/kafka/clients/producer/internals/Sender.java b/clients/src/main/java/org/apache/kafka/clients/producer/internals/Sender.java&lt;br/&gt;
index 7eea4992b33..426b273b885 100644&lt;br/&gt;
&amp;#8212; a/clients/src/main/java/org/apache/kafka/clients/producer/internals/Sender.java&lt;br/&gt;
+++ b/clients/src/main/java/org/apache/kafka/clients/producer/internals/Sender.java&lt;br/&gt;
@@ -329,7 +329,7 @@ private boolean maybeSendTransactionalRequest(long now) {&lt;br/&gt;
             return false;&lt;/p&gt;

&lt;p&gt;         AbstractRequest.Builder&amp;lt;?&amp;gt; requestBuilder = nextRequestHandler.requestBuilder();&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;while (true) {&lt;br/&gt;
+        while (running) {&lt;br/&gt;
             Node targetNode = null;&lt;br/&gt;
             try {&lt;br/&gt;
                 if (nextRequestHandler.needsCoordinator()) {&lt;br/&gt;
diff --git a/clients/src/main/java/org/apache/kafka/clients/producer/internals/TransactionalRequestResult.java b/clients/src/main/java/org/apache/kafka/clients/producer/internals/TransactionalRequestResult.java&lt;br/&gt;
index ff93da872dc..9c02e94c045 100644
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/clients/src/main/java/org/apache/kafka/clients/producer/internals/TransactionalRequestResult.java&lt;br/&gt;
+++ b/clients/src/main/java/org/apache/kafka/clients/producer/internals/TransactionalRequestResult.java&lt;br/&gt;
@@ -59,7 +59,10 @@ public void await() {&lt;br/&gt;
     }&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     public boolean await(long timeout, TimeUnit unit) throws InterruptedException &lt;/p&gt;
{
-        return latch.await(timeout, unit);
+        boolean success = latch.await(timeout, unit);
+        if (!isSuccessful())
+            throw error();
+        return success;
     }

&lt;p&gt;     public RuntimeException error() {&lt;br/&gt;
diff --git a/clients/src/test/java/org/apache/kafka/clients/producer/KafkaProducerTest.java b/clients/src/test/java/org/apache/kafka/clients/producer/KafkaProducerTest.java&lt;br/&gt;
index 9f70fd7e708..8bfc5e7d28a 100644&lt;br/&gt;
&amp;#8212; a/clients/src/test/java/org/apache/kafka/clients/producer/KafkaProducerTest.java&lt;br/&gt;
+++ b/clients/src/test/java/org/apache/kafka/clients/producer/KafkaProducerTest.java&lt;br/&gt;
@@ -548,4 +548,65 @@ public void testPartitionsForWithNullTopic() &lt;/p&gt;
{
             // expected
         }
&lt;p&gt;     }&lt;br/&gt;
+&lt;br/&gt;
+    @Test(expected = TimeoutException.class)&lt;br/&gt;
+    public void testInitTransactionTimeout() {&lt;br/&gt;
+        Properties props = new Properties();&lt;br/&gt;
+        props.put(ProducerConfig.TRANSACTIONAL_ID_CONFIG, &quot;bad-transaction&quot;);&lt;br/&gt;
+        props.put(ProducerConfig.MAX_BLOCK_MS_CONFIG, 5);&lt;br/&gt;
+        props.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, &quot;localhost:9000&quot;);&lt;br/&gt;
+&lt;br/&gt;
+        Time time = new MockTime();&lt;br/&gt;
+        Cluster cluster = TestUtils.singletonCluster(&quot;topic&quot;, 1);&lt;br/&gt;
+        Node node = cluster.nodes().get(0);&lt;br/&gt;
+&lt;br/&gt;
+        Metadata metadata = new Metadata(0, Long.MAX_VALUE, true);&lt;br/&gt;
+        metadata.update(cluster, Collections.&amp;lt;String&amp;gt;emptySet(), time.milliseconds());&lt;br/&gt;
+&lt;br/&gt;
+        MockClient client = new MockClient(time, metadata);&lt;br/&gt;
+        client.setNode(node);&lt;br/&gt;
+&lt;br/&gt;
+        Producer&amp;lt;String, String&amp;gt; producer = new KafkaProducer&amp;lt;&amp;gt;(&lt;br/&gt;
+                new ProducerConfig(ProducerConfig.addSerializerToConfig(props, new StringSerializer(), new StringSerializer())),&lt;br/&gt;
+                new StringSerializer(), new StringSerializer(), metadata, client);&lt;br/&gt;
+        try &lt;/p&gt;
{
+            producer.initTransactions();
+            fail(&quot;initTransactions() should have raised TimeoutException&quot;);
+        }
&lt;p&gt; finally &lt;/p&gt;
{
+            producer.close(0, TimeUnit.MILLISECONDS);
+        }&lt;br/&gt;
+    }&lt;br/&gt;
+&lt;br/&gt;
+    @Test(expected = KafkaException.class)&lt;br/&gt;
+    public void testOnlyCanExecuteCloseAfterInitTransactionsTimeout() {&lt;br/&gt;
+        Properties props = new Properties();&lt;br/&gt;
+        props.put(ProducerConfig.TRANSACTIONAL_ID_CONFIG, &quot;bad-transaction&quot;);&lt;br/&gt;
+        props.put(ProducerConfig.MAX_BLOCK_MS_CONFIG, 5);&lt;br/&gt;
+        props.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, &quot;localhost:9000&quot;);&lt;br/&gt;
+&lt;br/&gt;
+        Time time = new MockTime();&lt;br/&gt;
+        Cluster cluster = TestUtils.singletonCluster(&quot;topic&quot;, 1);&lt;br/&gt;
+        Node node = cluster.nodes().get(0);&lt;br/&gt;
+&lt;br/&gt;
+        Metadata metadata = new Metadata(0, Long.MAX_VALUE, true);&lt;br/&gt;
+        metadata.update(cluster, Collections.&amp;lt;String&amp;gt;emptySet(), time.milliseconds());&lt;br/&gt;
+&lt;br/&gt;
+        MockClient client = new MockClient(time, metadata);&lt;br/&gt;
+        client.setNode(node);&lt;br/&gt;
+&lt;br/&gt;
+        Producer&amp;lt;String, String&amp;gt; producer = new KafkaProducer&amp;lt;&amp;gt;(&lt;br/&gt;
+                new ProducerConfig(ProducerConfig.addSerializerToConfig(props, new StringSerializer(), new StringSerializer())),&lt;br/&gt;
+                new StringSerializer(), new StringSerializer(), metadata, client);&lt;br/&gt;
+        try {
+            producer.initTransactions();
+        } catch (TimeoutException e) {
+            // expected
+        }&lt;br/&gt;
+        // other transactional operations should not be allowed if we catch the error after initTransactions failed&lt;br/&gt;
+        try {
+            producer.beginTransaction();
+        } finally {+            producer.close(0, TimeUnit.MILLISECONDS);+        }
&lt;p&gt;+    }&lt;br/&gt;
 }&lt;br/&gt;
diff --git a/core/src/test/scala/integration/kafka/api/TransactionsTest.scala b/core/src/test/scala/integration/kafka/api/TransactionsTest.scala&lt;br/&gt;
index 911808a49cd..8435e5a3a6c 100644&lt;br/&gt;
&amp;#8212; a/core/src/test/scala/integration/kafka/api/TransactionsTest.scala&lt;br/&gt;
+++ b/core/src/test/scala/integration/kafka/api/TransactionsTest.scala&lt;br/&gt;
@@ -19,7 +19,7 @@ package kafka.api&lt;/p&gt;

&lt;p&gt; import java.lang.&lt;/p&gt;
{Long =&amp;gt; JLong}
&lt;p&gt; import java.util.Properties&lt;br/&gt;
-import java.util.concurrent.&lt;/p&gt;
{ExecutionException, TimeUnit}
&lt;p&gt;+import java.util.concurrent.TimeUnit&lt;/p&gt;

&lt;p&gt; import kafka.integration.KafkaServerTestHarness&lt;br/&gt;
 import kafka.server.KafkaConfig&lt;br/&gt;
@@ -27,7 +27,7 @@ import kafka.utils.TestUtils&lt;br/&gt;
 import kafka.utils.TestUtils.consumeRecords&lt;br/&gt;
 import org.apache.kafka.clients.consumer.&lt;/p&gt;
{ConsumerConfig, KafkaConsumer, OffsetAndMetadata}
&lt;p&gt; import org.apache.kafka.clients.producer.&lt;/p&gt;
{KafkaProducer, ProducerRecord}
&lt;p&gt;-import org.apache.kafka.common.TopicPartition&lt;br/&gt;
+import org.apache.kafka.common.&lt;/p&gt;
{KafkaException, TopicPartition}
&lt;p&gt; import org.apache.kafka.common.errors.ProducerFencedException&lt;br/&gt;
 import org.apache.kafka.common.security.auth.SecurityProtocol&lt;br/&gt;
 import org.junit.&lt;/p&gt;
{After, Before, Test}
&lt;p&gt;@@ -532,6 +532,19 @@ class TransactionsTest extends KafkaServerTestHarness {&lt;br/&gt;
     }&lt;br/&gt;
   }&lt;/p&gt;

&lt;p&gt;+  @Test(expected = classOf&lt;span class=&quot;error&quot;&gt;&amp;#91;KafkaException&amp;#93;&lt;/span&gt;)&lt;br/&gt;
+  def testConsecutivelyRunInitTransactions(): Unit = {&lt;br/&gt;
+    val producer = createTransactionalProducer(transactionalId = &quot;normalProducer&quot;)&lt;br/&gt;
+&lt;br/&gt;
+    try &lt;/p&gt;
{
+      producer.initTransactions()
+      producer.initTransactions()
+      fail(&quot;Should have raised a KafkaException&quot;)
+    }
&lt;p&gt; finally &lt;/p&gt;
{
+      producer.close()
+    }
&lt;p&gt;+  }&lt;br/&gt;
+&lt;br/&gt;
   private def sendTransactionalMessagesWithValueRange(producer: KafkaProducer[Array&lt;span class=&quot;error&quot;&gt;&amp;#91;Byte&amp;#93;&lt;/span&gt;, Array&lt;span class=&quot;error&quot;&gt;&amp;#91;Byte&amp;#93;&lt;/span&gt;], topic: String,&lt;br/&gt;
                                                       start: Int, end: Int, willBeCommitted: Boolean): Unit = {&lt;br/&gt;
     for (i &amp;lt;- start until end) {&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13112154">KAFKA-6127</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13215815">KAFKA-7932</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13219436">KAFKA-8040</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13112154">KAFKA-6127</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12906089" name="Test.java" size="1278" author="edosciullo" created="Mon, 15 Jan 2018 10:20:41 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 34 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3owtz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>