<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:37:19 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-756] Processor thread blocks due to infinite loop during fetch response send</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-756</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;This looks to be because of an infinite loop during fetch response send. This happens because we try to send bytes from a log which has been truncated during send. The total size to send is calculated at the beginning of the iteration and it does not take into account the change in log size during send. When send happens, it uses the size calculated at the start and loops continuously hoping to send more data.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12631817">KAFKA-756</key>
            <summary>Processor thread blocks due to infinite loop during fetch response send</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sriramsub">Sriram</assignee>
                                    <reporter username="sriramsub">Sriram</reporter>
                        <labels>
                            <label>bugs</label>
                            <label>p1</label>
                    </labels>
                <created>Mon, 11 Feb 2013 21:37:45 +0000</created>
                <updated>Fri, 22 Feb 2013 05:31:50 +0000</updated>
                            <resolved>Tue, 12 Feb 2013 20:31:58 +0000</resolved>
                                    <version>0.8.0</version>
                                    <fixVersion>0.8.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13576199" author="sriramsub" created="Mon, 11 Feb 2013 23:10:26 +0000"  >&lt;p&gt;This does two things&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Checks during writeTo in FileMessageSet to ensure the underlying view has not changed. If it has, we throw an exception and SocketServer will close the key&lt;/li&gt;
	&lt;li&gt;We do not write the fetch response for all the topics to the channel in a blocking manner. We give a chance to the processor thread to address other waiting requests. This change is to mainly to get feedback.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13576216" author="sriramsub" created="Mon, 11 Feb 2013 23:38:35 +0000"  >&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Ignore the second change. Will have an updated patch.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13576248" author="sriramsub" created="Tue, 12 Feb 2013 00:32:53 +0000"  >&lt;p&gt;writeTo of multiSend is modified to keep writing till we cannot write any more to the socket.&lt;/p&gt;</comment>
                            <comment id="13576271" author="junrao" created="Tue, 12 Feb 2013 01:07:00 +0000"  >&lt;p&gt;Thanks for patch v2. Looks good overall. A few minor comments:&lt;/p&gt;

&lt;p&gt;1. SocketServer: Could we add a space at the beginning and the end of &quot;using key&quot;?&lt;/p&gt;

&lt;p&gt;2. MultiSend.writeTo(): totalWrite is hard to distinguish from totalWritten. Could we change it to sth like totalWrittenPerCall instead?&lt;/p&gt;

&lt;p&gt;3. Should we add some trace level logging in FileMessageSet.writeTo() and MultiSend.writeTo()?&lt;/p&gt;</comment>
                            <comment id="13576357" author="jkreps" created="Tue, 12 Feb 2013 04:03:09 +0000"  >&lt;p&gt;I don&apos;t understand the intention of the mutlisend change. Can you give a little background...?&lt;/p&gt;

&lt;p&gt;The one change seems to remove a while loop, the other adds one...&lt;/p&gt;

&lt;p&gt;Also, did you do any testing on this?&lt;/p&gt;</comment>
                            <comment id="13576408" author="sriramsub" created="Tue, 12 Feb 2013 05:59:30 +0000"  >&lt;p&gt;There are two parts to this change.&lt;/p&gt;

&lt;p&gt;1. The change in FileMessageSet is the actual fix that prevents the infinite loop.&lt;br/&gt;
2. The change in MultiSend is subtle and is more of an optimization. A fetchresponse can typically take a while to transmit all the bytes to the fetcher today (depends on the fetch size and number of topics). This blocks the processor thread today and thereby all the responses in that processor queue. We had two possible solutions for this. &lt;br/&gt;
a. A solution I had proposed is to have a configurable maxsize value that would be used by Processor::write. Once the maxsize is reached, the write would return and will try to write the remaining in the next processor thread iteration. This would also enable other requests and responses to be handled that are ready.&lt;br/&gt;
b. Jun&apos;s proposal is to fill up the socket buffer as much as possible and stop the iteration when it cannot take more data. The patch v2 does that. It essentially continues to write to the buffer till an incomplete write happens. In such a scenario we return to the processor iteration loop and give a chance to process the other requests and responses.&lt;/p&gt;

&lt;p&gt;The 2nd change was made to get feedbacks from others on their thoughts. We are testing the change as part of system tests and are running it currently in the test cluster to monitor how it performs.&lt;/p&gt;</comment>
                            <comment id="13576705" author="jkreps" created="Tue, 12 Feb 2013 15:43:32 +0000"  >&lt;p&gt;Ah, I get it. I was wondering about the loop. Usually you just do a write and then wait for the event loop to come around again. I think the subtlty here is that an individual send may be much smaller than the socket buffer size so you need to keep writing. Nice.&lt;/p&gt;</comment>
                            <comment id="13576813" author="jkreps" created="Tue, 12 Feb 2013 17:37:52 +0000"  >&lt;p&gt;+1&lt;/p&gt;

&lt;p&gt;It would be good to understand how you tested this. Can we reproduce the blocking behavior w/o this patch (i.e. add a println and send some stuff with a larger fetch size than socket size). Can we do the same after the patch and validate that it is behaving as we expect...&lt;/p&gt;</comment>
                            <comment id="13576920" author="sriramsub" created="Tue, 12 Feb 2013 19:30:41 +0000"  >&lt;p&gt;Added some more tracing&lt;/p&gt;</comment>
                            <comment id="13576980" author="junrao" created="Tue, 12 Feb 2013 20:31:58 +0000"  >&lt;p&gt;Thanks for patch v3. Committed to 0.8 with the following minor changes.&lt;/p&gt;

&lt;p&gt;1. Added file name in the trace log in FileMessageSet.&lt;/p&gt;

&lt;p&gt;2. Rename a local var in Transmission to make it consistent with existing vars.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12569047" name="KAFKA-756-v3.patch" size="9336" author="sriramsub" created="Tue, 12 Feb 2013 19:30:41 +0000"/>
                            <attachment id="12568898" name="KAFKA-756.patch" size="2784" author="sriramsub" created="Mon, 11 Feb 2013 23:10:26 +0000"/>
                            <attachment id="12568911" name="Kafka-756-v2.patch" size="5690" author="sriramsub" created="Tue, 12 Feb 2013 00:37:45 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>312313</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 40 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1hwaf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>312659</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>