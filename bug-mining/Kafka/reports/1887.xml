<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:09:44 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-6742] TopologyTestDriver error when dealing with stores from GlobalKTable</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-6742</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;&lt;font color=&quot;#ff0000&quot;&gt;This junit test simply fails:&lt;/font&gt;&lt;/p&gt;

&lt;p&gt;@Test&lt;/p&gt;

&lt;p&gt;&lt;b&gt;public&lt;/b&gt; &lt;b&gt;void&lt;/b&gt; globalTable() {&lt;/p&gt;

&lt;p&gt;StreamsBuilder builder = &lt;b&gt;new&lt;/b&gt; StreamsBuilder();&lt;/p&gt;

&lt;p&gt;@SuppressWarnings(&quot;unused&quot;)&lt;/p&gt;

&lt;p&gt;&lt;b&gt;final&lt;/b&gt; KTable&amp;lt;String,String&amp;gt; localTable = builder&lt;/p&gt;

&lt;p&gt;.table(&quot;local&quot;,&#160;&lt;/p&gt;

&lt;p&gt;Consumed.&lt;em&gt;with&lt;/em&gt;(Serdes.&lt;em&gt;String&lt;/em&gt;(), Serdes.&lt;em&gt;String&lt;/em&gt;()),&lt;/p&gt;

&lt;p&gt;Materialized.&lt;em&gt;as&lt;/em&gt;(&quot;localStore&quot;))&lt;/p&gt;

&lt;p&gt;;&lt;/p&gt;

&lt;p&gt;@SuppressWarnings(&quot;unused&quot;)&lt;/p&gt;

&lt;p&gt;&lt;b&gt;final&lt;/b&gt; GlobalKTable&amp;lt;String,String&amp;gt; globalTable = builder&lt;/p&gt;

&lt;p&gt;.globalTable(&quot;global&quot;,&#160;&lt;/p&gt;

&lt;p&gt;Consumed.&lt;em&gt;with&lt;/em&gt;(Serdes.&lt;em&gt;String&lt;/em&gt;(), Serdes.&lt;em&gt;String&lt;/em&gt;()),&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; Materialized.&lt;em&gt;as&lt;/em&gt;(&quot;globalStore&quot;))&lt;/p&gt;

&lt;p&gt;;&lt;/p&gt;

&lt;p&gt;//&lt;/p&gt;

&lt;p&gt;Properties props = &lt;b&gt;new&lt;/b&gt; Properties();&lt;/p&gt;

&lt;p&gt;props.setProperty(StreamsConfig.&lt;b&gt;&lt;em&gt;APPLICATION_ID_CONFIG&lt;/em&gt;&lt;/b&gt;, &quot;test&quot;);&lt;/p&gt;

&lt;p&gt;props.setProperty(StreamsConfig.&lt;b&gt;&lt;em&gt;BOOTSTRAP_SERVERS_CONFIG&lt;/em&gt;&lt;/b&gt;, &quot;localhost&quot;);&lt;/p&gt;

&lt;p&gt;TopologyTestDriver testDriver = &lt;b&gt;new&lt;/b&gt; TopologyTestDriver(builder.build(), props);&lt;/p&gt;

&lt;p&gt;//&lt;/p&gt;

&lt;p&gt;&lt;b&gt;final&lt;/b&gt; KeyValueStore&amp;lt;String,String&amp;gt; localStore = testDriver.getKeyValueStore(&quot;localStore&quot;);&lt;/p&gt;

&lt;p&gt;Assert.&lt;em&gt;assertNotNull&lt;/em&gt;(localStore);&lt;/p&gt;

&lt;p&gt;Assert.&lt;em&gt;assertNotNull&lt;/em&gt;(testDriver.getAllStateStores().get(&quot;localStore&quot;));&lt;/p&gt;

&lt;p&gt;//&lt;/p&gt;

&lt;p&gt;&lt;b&gt;final&lt;/b&gt; KeyValueStore&amp;lt;String,String&amp;gt; globalStore = testDriver.getKeyValueStore(&quot;globalStore&quot;);&lt;/p&gt;

&lt;p&gt;Assert.&lt;em&gt;assertNotNull&lt;/em&gt;(globalStore);&lt;/p&gt;

&lt;p&gt;Assert.&lt;em&gt;assertNotNull&lt;/em&gt;(testDriver.getAllStateStores().get(&quot;globalStore&quot;));&lt;/p&gt;

&lt;p&gt;//&lt;/p&gt;

&lt;p&gt;&#160; &#160; &lt;b&gt;final&lt;/b&gt; ConsumerRecordFactory&amp;lt;String,String&amp;gt; crf = &lt;b&gt;new&lt;/b&gt; ConsumerRecordFactory&amp;lt;&amp;gt;(&lt;b&gt;new&lt;/b&gt; StringSerializer(), &lt;b&gt;new&lt;/b&gt; StringSerializer());&lt;/p&gt;

&lt;p&gt;testDriver.pipeInput(crf.create(&quot;local&quot;, &quot;one&quot;, &quot;TheOne&quot;));&lt;/p&gt;

&lt;p&gt;testDriver.pipeInput(crf.create(&quot;global&quot;, &quot;one&quot;, &quot;TheOne&quot;));&lt;/p&gt;

&lt;p&gt;//&lt;/p&gt;

&lt;p&gt;Assert.&lt;em&gt;assertEquals&lt;/em&gt;(&quot;TheOne&quot;, localStore.get(&quot;one&quot;));&lt;/p&gt;

&lt;p&gt;Assert.&lt;em&gt;assertEquals&lt;/em&gt;(&quot;TheOne&quot;, globalStore.get(&quot;one&quot;));&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;#ff0000&quot;&gt;to make it work I had to modify the&#160;TopologyTestDriver class as follow:&lt;/font&gt;&lt;/p&gt;

&lt;p&gt;...&lt;/p&gt;

&lt;p&gt;&#160; &#160; &lt;b&gt;public&lt;/b&gt; Map&amp;lt;String, StateStore&amp;gt; getAllStateStores() {&lt;/p&gt;

&lt;p&gt;//&#160; &#160; &#160; &#160; final Map&amp;lt;String, StateStore&amp;gt; allStores = new HashMap&amp;lt;&amp;gt;();&lt;/p&gt;

&lt;p&gt;//&#160; &#160; &#160; &#160; for (final String storeName : internalTopologyBuilder.allStateStoreName())&lt;/p&gt;

{ //&#160; &#160; &#160; &#160; &#160; &#160; allStores.put(storeName, ((ProcessorContextImpl) task.context()).getStateMgr().getStore(storeName)); //&#160; &#160; &#160; &#160; }

&lt;p&gt;//&#160; &#160; &#160; &#160; return allStores;&lt;/p&gt;

&lt;p&gt;&#160; &#160; &lt;font color=&quot;#ff0000&quot;&gt;// &lt;b&gt;FIXME&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;

&lt;p&gt;&#160; &#160; &lt;b&gt;final&lt;/b&gt; ProcessorStateManager psm = ((ProcessorContextImpl) task.context()).getStateMgr();&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; &lt;b&gt;final&lt;/b&gt; Map&amp;lt;String, StateStore&amp;gt; allStores = &lt;b&gt;new&lt;/b&gt; HashMap&amp;lt;&amp;gt;();&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; &lt;b&gt;for&lt;/b&gt; (&lt;b&gt;final&lt;/b&gt; String storeName : internalTopologyBuilder.allStateStoreName()) &lt;/p&gt;
{ &#160; &#160; &#160; &#160; &#160; &#160;

StateStore res = psm.getStore(storeName); &#160; &#160; &#160; &#160; &#160; &#160;

if (res == null) &#160; &#160; &#160; &#160; &#160; &#160;

&#160; res = psm.getGlobalStore(storeName); &#160; &#160; &#160; &#160; &#160; &#160;

allStores.put(storeName, res); &#160; &#160; &#160; &#160;

}

&lt;p&gt;&#160; &#160; &#160; &#160; &lt;b&gt;return&lt;/b&gt; allStores;&lt;/p&gt;

&lt;p&gt;&#160; &#160; }&lt;/p&gt;

&lt;p&gt;...&lt;/p&gt;

&lt;p&gt;&#160; &#160; &lt;b&gt;public&lt;/b&gt; StateStore getStateStore(&lt;b&gt;final&lt;/b&gt; String name) {&lt;/p&gt;

&lt;p&gt;//&#160; &#160; &#160; &#160; return ((ProcessorContextImpl) task.context()).getStateMgr().getStore(name);&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; &lt;font color=&quot;#ff0000&quot;&gt;// &lt;b&gt;FIXME&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;

&lt;p&gt;&#160; &#160; &lt;b&gt;final&lt;/b&gt; ProcessorStateManager psm = ((ProcessorContextImpl) task.context()).getStateMgr();&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; StateStore res = psm.getStore(name);&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; &lt;b&gt;if&lt;/b&gt; (res == &lt;b&gt;null&lt;/b&gt;)&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; res = psm.getGlobalStore(name);&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; &lt;b&gt;return&lt;/b&gt; res;&lt;/p&gt;

&lt;p&gt;&#160; &#160; }&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;#ff0000&quot;&gt;moreover I think it would be very useful to make the internal MockProducer&#160;public for testing cases where a producer&#160;is used along side with the &quot;normal&quot; stream processing by adding the method:&lt;/font&gt;&lt;/p&gt;

&lt;p&gt;&#160; &#160; /**&lt;/p&gt;

&lt;p&gt;&#160;&#160; &#160; * &lt;b&gt;@return&lt;/b&gt; records sent with this producer are automatically streamed to the topology.&lt;/p&gt;

&lt;p&gt;&#160;&#160; &#160; */&lt;/p&gt;

&lt;p&gt;&#160; &#160; &lt;b&gt;public&lt;/b&gt; &lt;b&gt;final&lt;/b&gt; Producer&amp;lt;&lt;b&gt;byte&lt;/b&gt;[], &lt;b&gt;byte&lt;/b&gt;[]&amp;gt; getProducer() &lt;/p&gt;
{&#160; &#160; &#160;

return producer; &#160; &#160;

}

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;#ff0000&quot;&gt;unfortunately this introduces another problem that could be verified by adding the following lines to the previous junit test:&lt;/font&gt;&lt;/p&gt;

&lt;p&gt;...&lt;/p&gt;

&lt;p&gt;**&lt;/p&gt;

&lt;p&gt;//&lt;/p&gt;

&lt;p&gt;ConsumerRecord&amp;lt;&lt;b&gt;byte&lt;/b&gt;[],&lt;b&gt;byte&lt;/b&gt;[]&amp;gt; cr = crf.create(&quot;dummy&quot;, &quot;two&quot;, &quot;Second&quot;); // just to serialize keys and values&lt;/p&gt;

&lt;p&gt;testDriver.getProducer().send(&lt;b&gt;new&lt;/b&gt; ProducerRecord&amp;lt;&amp;gt;(&quot;local&quot;, &lt;b&gt;null&lt;/b&gt;, cr.timestamp(), cr.key(), cr.value()));&lt;/p&gt;

&lt;p&gt;testDriver.getProducer().send(&lt;b&gt;new&lt;/b&gt; ProducerRecord&amp;lt;&amp;gt;(&quot;global&quot;, &lt;b&gt;null&lt;/b&gt;, cr.timestamp(), cr.key(), cr.value()));&lt;/p&gt;

&lt;p&gt;testDriver.advanceWallClockTime(0);&lt;/p&gt;

&lt;p&gt;Assert.&lt;em&gt;assertEquals&lt;/em&gt;(&quot;TheOne&quot;, localStore.get(&quot;one&quot;));&lt;/p&gt;

&lt;p&gt;Assert.&lt;em&gt;assertEquals&lt;/em&gt;(&quot;Second&quot;, localStore.get(&quot;two&quot;));&lt;/p&gt;

&lt;p&gt;Assert.&lt;em&gt;assertEquals&lt;/em&gt;(&quot;TheOne&quot;, globalStore.get(&quot;one&quot;));&lt;/p&gt;

&lt;p&gt;Assert.&lt;em&gt;assertEquals&lt;/em&gt;(&quot;Second&quot;, globalStore.get(&quot;two&quot;));&lt;/p&gt;

&lt;p&gt;}&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;#ff0000&quot;&gt;that could be fixed with:&lt;/font&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160; &#160; &lt;b&gt;private&lt;/b&gt; &lt;b&gt;void&lt;/b&gt; captureOutputRecords() {&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; // Capture all the records sent to the producer ...&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; &lt;b&gt;final&lt;/b&gt; List&amp;lt;ProducerRecord&amp;lt;&lt;b&gt;byte&lt;/b&gt;[], &lt;b&gt;byte&lt;/b&gt;[]&amp;gt;&amp;gt; output = producer.history();&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; producer.clear();&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; &lt;b&gt;for&lt;/b&gt; (&lt;b&gt;final&lt;/b&gt; ProducerRecord&amp;lt;&lt;b&gt;byte&lt;/b&gt;[], &lt;b&gt;byte&lt;/b&gt;[]&amp;gt; record : output) {&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; &#160; &#160; Queue&amp;lt;ProducerRecord&amp;lt;&lt;b&gt;byte&lt;/b&gt;[], &lt;b&gt;byte&lt;/b&gt;[]&amp;gt;&amp;gt; outputRecords = outputRecordsByTopic.get(record.topic());&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; &#160; &#160; &lt;b&gt;if&lt;/b&gt; (outputRecords == &lt;b&gt;null&lt;/b&gt;)&lt;/p&gt;

{ &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; outputRecords = *new* LinkedList&amp;lt;&amp;gt;(); &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; outputRecordsByTopic.put(record.topic(), outputRecords); &#160; &#160; &#160; &#160; &#160; &#160; }

&lt;p&gt;&#160; &#160; &#160; &#160; &#160; &#160; outputRecords.add(record);&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; &#160; &#160; // Forward back into the topology if the produced record is to an internal or a source topic ...&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; &#160; &#160; &lt;b&gt;final&lt;/b&gt; String outputTopicName = record.topic();&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; &#160; &#160; &lt;b&gt;if&lt;/b&gt; (internalTopics.contains(outputTopicName) || processorTopology.sourceTopics().contains(outputTopicName)&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; &#160; &#160; || globalPartitionsByTopic.containsKey(outputTopicName)) {&#160; &lt;font color=&quot;#ff0000&quot;&gt;// &lt;b&gt;FIXME&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &lt;b&gt;final&lt;/b&gt; &lt;b&gt;byte&lt;/b&gt;[] serializedKey = record.key();&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &lt;b&gt;final&lt;/b&gt; &lt;b&gt;byte&lt;/b&gt;[] serializedValue = record.value();&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; pipeInput(&lt;b&gt;new&lt;/b&gt; ConsumerRecord&amp;lt;&amp;gt;(&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; outputTopicName,&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; -1,&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; -1L,&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; record.timestamp(),&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; TimestampType.&lt;b&gt;&lt;em&gt;CREATE_TIME&lt;/em&gt;&lt;/b&gt;,&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; 0L,&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; serializedKey == &lt;b&gt;null&lt;/b&gt; ? 0 : serializedKey.length,&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; serializedValue == &lt;b&gt;null&lt;/b&gt; ? 0 : serializedValue.length,&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; serializedKey,&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; serializedValue));&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; &#160; &#160; }&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; }&lt;/p&gt;

&lt;p&gt;&#160; &#160; }&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Thank you&lt;/b&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13149700">KAFKA-6742</key>
            <summary>TopologyTestDriver error when dealing with stores from GlobalKTable</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="vale68">Valentino Proietti</assignee>
                                    <reporter username="vale68">Valentino Proietti</reporter>
                        <labels>
                    </labels>
                <created>Tue, 3 Apr 2018 10:06:59 +0000</created>
                <updated>Wed, 25 Apr 2018 09:42:53 +0000</updated>
                            <resolved>Tue, 17 Apr 2018 16:41:48 +0000</resolved>
                                    <version>1.1.0</version>
                                    <fixVersion>1.1.1</fixVersion>
                    <fixVersion>2.0.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16424242" author="guozhang" created="Tue, 3 Apr 2018 16:22:21 +0000"  >&lt;p&gt;Hello &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vale68&quot; class=&quot;user-hover&quot; rel=&quot;vale68&quot;&gt;vale68&lt;/a&gt; Thanks for reporting the issue. Is it possible for you to submit a PR to illustrate your problem? And if it is indeed an issue we can go ahead and review / merge your PR: &lt;a href=&quot;https://cwiki.apache.org/confluence/display/KAFKA/Contributing+Code+Changes#ContributingCodeChanges-PullRequest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://cwiki.apache.org/confluence/display/KAFKA/Contributing+Code+Changes#ContributingCodeChanges-PullRequest&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;By looking at the code above it is a bit difficult to fully understand your point.&lt;/p&gt;</comment>
                            <comment id="16425091" author="vale68" created="Wed, 4 Apr 2018 06:54:58 +0000"  >&lt;p&gt;Hello &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt;, I will create the PR asap. Thank you&lt;/p&gt;</comment>
                            <comment id="16425309" author="githubbot" created="Wed, 4 Apr 2018 10:38:35 +0000"  >&lt;p&gt;Vale68 opened a new pull request #4823: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6742&quot; title=&quot;TopologyTestDriver error when dealing with stores from GlobalKTable&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-6742&quot;&gt;&lt;del&gt;KAFKA-6742&lt;/del&gt;&lt;/a&gt;: TopologyTestDriver error when dealing with stores from GlobalKTable&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/4823&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/4823&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   @guozhangwang&lt;/p&gt;

&lt;p&gt;   While TopologyTestDriver works well with stores created from KTable it does not with stores from GlobalKTable.&lt;br/&gt;
   Moreover, for my testing purposes but I think it can be useful to others, I need to get access to the MockProducer inside TopologyTestDriver.&lt;/p&gt;

&lt;p&gt;   I have added 4 new tests to TopologyTestDriverTest, two for stores from KTable and two for stores from GlobalKTable.&lt;/p&gt;

&lt;p&gt;   While I was changing the TopologyTestDriver I&apos;ve also make it implement java.io.Closeable.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16426277" author="mjsax" created="Wed, 4 Apr 2018 22:38:01 +0000"  >&lt;p&gt;Your description of the JIRA is a little unclear to me:&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;This junit test simply fails:&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;What does this exactly mean? Is there an exception? Or does an assertion fail (if yet, which one)?&lt;/p&gt;</comment>
                            <comment id="16426603" author="vale68" created="Thu, 5 Apr 2018 08:00:53 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mjsax&quot; class=&quot;user-hover&quot; rel=&quot;mjsax&quot;&gt;mjsax&lt;/a&gt;: please follow the PR, I&apos;m sorry for the confusing description.&lt;/p&gt;

&lt;p&gt;Anyway the test I was talking about fails in the following assert:&lt;/p&gt;

&lt;p&gt;&lt;b&gt;final&lt;/b&gt;&#160;KeyValueStore&amp;lt;String,String&amp;gt; globalStore = testDriver.getKeyValueStore(&quot;globalStore&quot;);&lt;/p&gt;

&lt;p&gt;Assert.&lt;em&gt;assertNotNull&lt;/em&gt;(globalStore);&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16429570" author="mjsax" created="Sun, 8 Apr 2018 00:44:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vale68&quot; class=&quot;user-hover&quot; rel=&quot;vale68&quot;&gt;vale68&lt;/a&gt; I added you to the list of contributors and assigned this ticket to you. You can assign tickets to yourself now, too.&lt;/p&gt;</comment>
                            <comment id="16430231" author="vale68" created="Mon, 9 Apr 2018 08:02:52 +0000"  >&lt;p&gt;Thank you &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mjsax&quot; class=&quot;user-hover&quot; rel=&quot;mjsax&quot;&gt;mjsax&lt;/a&gt; !&lt;/p&gt;</comment>
                            <comment id="16441131" author="guozhang" created="Tue, 17 Apr 2018 16:41:48 +0000"  >&lt;p&gt;Issue resolved by pull request 4823&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/kafka/pull/4823&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/4823&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16441136" author="githubbot" created="Tue, 17 Apr 2018 16:42:59 +0000"  >&lt;p&gt;guozhangwang closed pull request #4823: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6742&quot; title=&quot;TopologyTestDriver error when dealing with stores from GlobalKTable&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-6742&quot;&gt;&lt;del&gt;KAFKA-6742&lt;/del&gt;&lt;/a&gt;: TopologyTestDriver error when dealing with stores from GlobalKTable&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/4823&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/4823&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/streams/test-utils/src/main/java/org/apache/kafka/streams/TopologyTestDriver.java b/streams/test-utils/src/main/java/org/apache/kafka/streams/TopologyTestDriver.java&lt;br/&gt;
index abcc99d362f..7eca27b826b 100644&lt;br/&gt;
&amp;#8212; a/streams/test-utils/src/main/java/org/apache/kafka/streams/TopologyTestDriver.java&lt;br/&gt;
+++ b/streams/test-utils/src/main/java/org/apache/kafka/streams/TopologyTestDriver.java&lt;br/&gt;
@@ -41,6 +41,7 @@&lt;br/&gt;
 import org.apache.kafka.streams.processor.StateStore;&lt;br/&gt;
 import org.apache.kafka.streams.processor.TaskId;&lt;br/&gt;
 import org.apache.kafka.streams.processor.internals.GlobalProcessorContextImpl;&lt;br/&gt;
+import org.apache.kafka.streams.processor.internals.GlobalStateManager;&lt;br/&gt;
 import org.apache.kafka.streams.processor.internals.GlobalStateManagerImpl;&lt;br/&gt;
 import org.apache.kafka.streams.processor.internals.GlobalStateUpdateTask;&lt;br/&gt;
 import org.apache.kafka.streams.processor.internals.InternalProcessorContext;&lt;br/&gt;
@@ -59,6 +60,7 @@&lt;br/&gt;
 import org.apache.kafka.streams.test.ConsumerRecordFactory;&lt;br/&gt;
 import org.apache.kafka.streams.test.OutputVerifier;&lt;/p&gt;

&lt;p&gt;+import java.io.Closeable;&lt;br/&gt;
 import java.io.IOException;&lt;br/&gt;
 import java.util.ArrayList;&lt;br/&gt;
 import java.util.Collection;&lt;br/&gt;
@@ -162,18 +164,20 @@&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;@see OutputVerifier&lt;br/&gt;
  */&lt;br/&gt;
 @InterfaceStability.Evolving&lt;br/&gt;
-public class TopologyTestDriver {&lt;br/&gt;
+public class TopologyTestDriver implements Closeable 
{
 
     private final Time mockTime;
     private final InternalTopologyBuilder internalTopologyBuilder;
 
     private final static int PARTITION_ID = 0;
     private final static TaskId TASK_ID = new TaskId(0, PARTITION_ID);
-    private StreamTask task;
-    private GlobalStateUpdateTask globalStateTask;
+    private final StreamTask task;
+    private final GlobalStateUpdateTask globalStateTask;
+    private final GlobalStateManager globalStateManager;
 
     private final StateDirectory stateDirectory;
     private final ProcessorTopology processorTopology;
+    
     private final MockProducer&amp;lt;byte[], byte[]&amp;gt; producer;
 
     private final Set&amp;lt;String&amp;gt; internalTopics = new HashSet&amp;lt;&amp;gt;();
@@ -264,7 +268,7 @@ public void onRestoreEnd(TopicPartition topicPartition, String storeName, long t
                 consumer.updateEndOffsets(Collections.singletonMap(partition, 0L));
             }&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final GlobalStateManagerImpl stateManager = new GlobalStateManagerImpl(&lt;br/&gt;
+            globalStateManager = new GlobalStateManagerImpl(&lt;br/&gt;
                 new LogContext(&quot;mock &quot;),&lt;br/&gt;
                 globalTopology,&lt;br/&gt;
                 consumer,&lt;br/&gt;
@@ -273,16 +277,19 @@ public void onRestoreEnd(TopicPartition topicPartition, String storeName, long t&lt;br/&gt;
                 streamsConfig);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;             final GlobalProcessorContextImpl globalProcessorContext&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;= new GlobalProcessorContextImpl(streamsConfig, stateManager, streamsMetrics, cache);&lt;/li&gt;
	&lt;li&gt;stateManager.setGlobalProcessorContext(globalProcessorContext);&lt;br/&gt;
+                = new GlobalProcessorContextImpl(streamsConfig, globalStateManager, streamsMetrics, cache);&lt;br/&gt;
+            globalStateManager.setGlobalProcessorContext(globalProcessorContext);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;             globalStateTask = new GlobalStateUpdateTask(&lt;br/&gt;
                 globalTopology,&lt;br/&gt;
                 globalProcessorContext,&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;stateManager,&lt;br/&gt;
+                globalStateManager,&lt;br/&gt;
                 new LogAndContinueExceptionHandler(),&lt;br/&gt;
                 new LogContext());&lt;br/&gt;
             globalStateTask.initialize();&lt;br/&gt;
+        } else 
{
+            globalStateManager = null;
+            globalStateTask = null;
         }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         if (!partitionsByTopic.isEmpty()) &lt;/p&gt;
{
@@ -303,6 +310,8 @@ public void onRestoreEnd(TopicPartition topicPartition, String storeName, long t
                 producer);
             task.initializeStateStores();
             task.initializeTopology();
+        }
&lt;p&gt; else &lt;/p&gt;
{
+            task = null;
         }
&lt;p&gt;     }&lt;/p&gt;

&lt;p&gt;@@ -372,7 +381,8 @@ private void captureOutputRecords() {&lt;/p&gt;

&lt;p&gt;             // Forward back into the topology if the produced record is to an internal or a source topic ...&lt;br/&gt;
             final String outputTopicName = record.topic();&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (internalTopics.contains(outputTopicName) || processorTopology.sourceTopics().contains(outputTopicName)) {&lt;br/&gt;
+            if (internalTopics.contains(outputTopicName) || processorTopology.sourceTopics().contains(outputTopicName)&lt;br/&gt;
+                    || globalPartitionsByTopic.containsKey(outputTopicName)) {&lt;br/&gt;
                 final byte[] serializedKey = record.key();&lt;br/&gt;
                 final byte[] serializedValue = record.value();&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;@@ -410,8 +420,10 @@ public void pipeInput(final List&amp;lt;ConsumerRecord&amp;lt;byte[], byte[]&amp;gt;&amp;gt; records) {&lt;br/&gt;
      */&lt;br/&gt;
     public void advanceWallClockTime(final long advanceMs) {&lt;br/&gt;
         mockTime.sleep(advanceMs);&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;task.maybePunctuateSystemTime();&lt;/li&gt;
	&lt;li&gt;task.commit();&lt;br/&gt;
+        if (task != null) 
{
+            task.maybePunctuateSystemTime();
+            task.commit();
+        }
&lt;p&gt;         captureOutputRecords();&lt;br/&gt;
     }&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;@@ -450,7 +462,7 @@ public void advanceWallClockTime(final long advanceMs) &lt;/p&gt;
{
         final V value = valueDeserializer.deserialize(record.topic(), record.value());
         return new ProducerRecord&amp;lt;&amp;gt;(record.topic(), record.partition(), record.timestamp(), key, value);
     }
&lt;p&gt;-&lt;br/&gt;
+    &lt;br/&gt;
     /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Get all 
{@link StateStore StateStores}
&lt;p&gt; from the topology.&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;The stores can be a &quot;regular&quot; or global stores.&lt;br/&gt;
@@ -467,7 +479,7 @@ public void advanceWallClockTime(final long advanceMs) {&lt;br/&gt;
     public Map&amp;lt;String, StateStore&amp;gt; getAllStateStores() 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {         final Map&amp;lt;String, StateStore&amp;gt; allStores = new HashMap&amp;lt;&amp;gt;();         for (final String storeName }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;@@ -487,7 +499,12 @@ public void advanceWallClockTime(final long advanceMs) {&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;@see #getSessionStore(String)&lt;br/&gt;
      */&lt;br/&gt;
     public StateStore getStateStore(final String name) {&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;return ((ProcessorContextImpl) task.context()).getStateMgr().getStore(name);&lt;br/&gt;
+        StateStore res = task == null ? null : &lt;br/&gt;
+            ((ProcessorContextImpl) task.context()).getStateMgr().getStore(name);&lt;br/&gt;
+        if (res == null &amp;amp;&amp;amp; globalStateManager != null) 
{
+            res = globalStateManager.getGlobalStore(name);
+        }
&lt;p&gt;+        return res;&lt;br/&gt;
     }&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     /**&lt;br/&gt;
diff --git a/streams/test-utils/src/test/java/org/apache/kafka/streams/TopologyTestDriverTest.java b/streams/test-utils/src/test/java/org/apache/kafka/streams/TopologyTestDriverTest.java&lt;br/&gt;
index b74a754a4d6..d757f3384b9 100644&lt;br/&gt;
&amp;#8212; a/streams/test-utils/src/test/java/org/apache/kafka/streams/TopologyTestDriverTest.java&lt;br/&gt;
+++ b/streams/test-utils/src/test/java/org/apache/kafka/streams/TopologyTestDriverTest.java&lt;br/&gt;
@@ -27,6 +27,7 @@&lt;br/&gt;
 import org.apache.kafka.common.serialization.StringSerializer;&lt;br/&gt;
 import org.apache.kafka.common.utils.Bytes;&lt;br/&gt;
 import org.apache.kafka.common.utils.SystemTime;&lt;br/&gt;
+import org.apache.kafka.streams.kstream.Materialized;&lt;br/&gt;
 import org.apache.kafka.streams.processor.Processor;&lt;br/&gt;
 import org.apache.kafka.streams.processor.ProcessorContext;&lt;br/&gt;
 import org.apache.kafka.streams.processor.ProcessorSupplier;&lt;br/&gt;
@@ -584,6 +585,10 @@ public void shouldForwardRecordsFromSubtopologyToSubtopology() {&lt;br/&gt;
     public void shouldPopulateGlobalStore() {&lt;br/&gt;
         testDriver = new TopologyTestDriver(setupGlobalStoreTopology(SOURCE_TOPIC_1), config);&lt;/p&gt;

&lt;p&gt;+        final KeyValueStore&amp;lt;byte[], byte[]&amp;gt; globalStore = testDriver.getKeyValueStore(SOURCE_TOPIC_1 + &quot;-globalStore&quot;);&lt;br/&gt;
+        Assert.assertNotNull(globalStore);&lt;br/&gt;
+        Assert.assertNotNull(testDriver.getAllStateStores().get(SOURCE_TOPIC_1 + &quot;-globalStore&quot;));&lt;br/&gt;
+&lt;br/&gt;
         testDriver.pipeInput(consumerRecord1);&lt;/p&gt;

&lt;p&gt;         final List&amp;lt;Record&amp;gt; processedRecords = mockProcessors.get(0).processedRecords;&lt;br/&gt;
@@ -897,4 +902,21 @@ public void close() {}&lt;br/&gt;
             );&lt;br/&gt;
         }&lt;br/&gt;
     }&lt;br/&gt;
+    &lt;br/&gt;
+    @Test&lt;br/&gt;
+    public void shouldFeedStoreFromGlobalKTable() {&lt;br/&gt;
+        final StreamsBuilder builder = new StreamsBuilder();&lt;br/&gt;
+        builder.globalTable(&quot;topic&quot;,  &lt;br/&gt;
+            Consumed.with(Serdes.String(), Serdes.String()),&lt;br/&gt;
+            Materialized.&amp;lt;String, String, KeyValueStore&amp;lt;Bytes, byte[]&amp;gt;&amp;gt;as(&quot;globalStore&quot;));&lt;br/&gt;
+        try (final TopologyTestDriver testDriver = new TopologyTestDriver(builder.build(), config)) &lt;/p&gt;
{
+            final KeyValueStore&amp;lt;String, String&amp;gt; globalStore = testDriver.getKeyValueStore(&quot;globalStore&quot;);
+            Assert.assertNotNull(globalStore);
+            Assert.assertNotNull(testDriver.getAllStateStores().get(&quot;globalStore&quot;));
+            final ConsumerRecordFactory&amp;lt;String, String&amp;gt; recordFactory = new ConsumerRecordFactory&amp;lt;&amp;gt;(new StringSerializer(), new StringSerializer());
+            testDriver.pipeInput(recordFactory.create(&quot;topic&quot;, &quot;k1&quot;, &quot;value1&quot;));
+            // we expect to have both in the global store, the one from pipeInput and the one from the producer
+            Assert.assertEquals(&quot;value1&quot;, globalStore.get(&quot;k1&quot;));
+        }
&lt;p&gt;+    }&lt;br/&gt;
 }&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 31 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3s31b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>