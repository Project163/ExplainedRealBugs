<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:37:37 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-732] MirrorMaker with shallow.iterator.enable=true produces unreadble messages</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-732</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Trying to use MirrorMaker between two 0.8 clusters&lt;/p&gt;

&lt;p&gt;When using shallow.iterator.enable=true on the consumer side, the performance gain is big (when incoming messages are compressed) and the producer does not complain but write the messages uncompressed without the compression flag.&lt;/p&gt;

&lt;p&gt;If you try:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;enable compression on the producer, it obviously makes things worse since the data get double-compressed (the wiki warns about this)&lt;/li&gt;
	&lt;li&gt;disable compression and the compressed messages are written in bulk in an uncompressed message, thus making it unreadable.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;If I follow correctly the current state of code from MirrorMaker to the produce request, there is no way for the producer to know whether the message is deep or not. So I wonder how it worked on 0.7?&lt;/p&gt;

&lt;p&gt;Here is the code as i read it (correct me if i&apos;m wrong):&lt;/p&gt;

&lt;p&gt;1. MirrorMakerThread.run(): create KeyedMessage[Array&lt;span class=&quot;error&quot;&gt;&amp;#91;Byte&amp;#93;&lt;/span&gt;,Array&lt;span class=&quot;error&quot;&gt;&amp;#91;Byte&amp;#93;&lt;/span&gt;](topic, message)&lt;br/&gt;
2. Producer.send() -&amp;gt; DefaultEventHandler.handle()&lt;br/&gt;
3. DefaultEventHandler.serialize(): use DefaultEncoder for the message (does nothing)&lt;br/&gt;
4. DefaultEventHandler.dispatchSerializedData():&lt;br/&gt;
4.1 DefaultEventHandler.partitionAndCollate(): group messages by broker/partition/topic&lt;br/&gt;
4.2 DefaultEventHandler.dispatchSerializeData(): cycle through each broker&lt;br/&gt;
4.3 DefaultEventHandler.groupMessagesToSet(): Create a ByteBufferMessageSet for each partition/topic grouping all the messages together, and compressing them if needed&lt;br/&gt;
4.4 DefaultEventHandler.send(): send the ByteBufferMessageSets for this broker in one ProduceRequest&lt;/p&gt;

&lt;p&gt;The gist is that in DEH.groupMessagesToSet(), you don&apos;t know wether the raw message in KeyedMessage.message is shallow or not. So I think I missed something... Also it doesn&apos;t seem possible to send batch of deep messages in one ProduceRequest.&lt;/p&gt;

&lt;p&gt;I would love to provide a patch (or if you tell me that i&apos;m doing it wrong, it&apos;s even better), since I can easily test it on my test clusters but I will need guidance here.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12629028">KAFKA-732</key>
            <summary>MirrorMaker with shallow.iterator.enable=true produces unreadble messages</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="junrao">Jun Rao</assignee>
                                    <reporter username="brugidou">Maxime Brugidou</reporter>
                        <labels>
                    </labels>
                <created>Thu, 24 Jan 2013 08:54:01 +0000</created>
                <updated>Wed, 3 Apr 2013 13:53:31 +0000</updated>
                            <resolved>Thu, 7 Mar 2013 00:09:40 +0000</resolved>
                                    <version>0.8.0</version>
                    <version>0.8.1</version>
                                    <fixVersion>0.8.0</fixVersion>
                                    <component>core</component>
                    <component>producer </component>
                        <due></due>
                            <votes>3</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="13580942" author="junrao" created="Tue, 19 Feb 2013 01:24:45 +0000"  >&lt;p&gt;I seems that it&apos;s non-trivial to support shallow iteration in 0.8. The main reason is that the encoder api is changed to encode(event: T) =&amp;gt; byte[], from encode(event: T) =&amp;gt; Message. So, in 0.7, we can get a compressed message from the source and simply pass it to the producer in mirrorMaker. In 0.8, there is no easy way that we can do that.&lt;/p&gt;

&lt;p&gt;So, I suggest that we remove the shallowIteration option in ConsumerConfig and revisit this issue post 0.8.&lt;/p&gt;</comment>
                            <comment id="13583930" author="nehanarkhede" created="Fri, 22 Feb 2013 05:36:04 +0000"  >&lt;p&gt;Moving this out of 0.8 as per discussion on mailing list&lt;/p&gt;</comment>
                            <comment id="13595292" author="junrao" created="Wed, 6 Mar 2013 23:40:33 +0000"  >&lt;p&gt;Attach a patch that removes the shallow iteration option in the consumer.&lt;/p&gt;</comment>
                            <comment id="13595298" author="nehanarkhede" created="Wed, 6 Mar 2013 23:47:41 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13595322" author="junrao" created="Thu, 7 Mar 2013 00:09:40 +0000"  >&lt;p&gt;Thanks for the review. Committed to 0.8.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12640515">KAFKA-845</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12572439" name="kafka-732.patch" size="5592" author="junrao" created="Wed, 6 Mar 2013 23:40:33 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>308646</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 37 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1cqyf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>282498</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>