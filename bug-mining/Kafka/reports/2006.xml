<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:13:49 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-4950] ConcurrentModificationException when iterating over Kafka Metrics</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-4950</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;It looks like the when calling &lt;tt&gt;PartitionStates.partitionSet()&lt;/tt&gt;, while the resulting Hashmap is being built, the internal state of the allocations can change, which leads to ConcurrentModificationException during the copy operation.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.util.ConcurrentModificationException
        at java.util.LinkedHashMap$LinkedHashIterator.nextNode(LinkedHashMap.java:719)
        at java.util.LinkedHashMap$LinkedKeyIterator.next(LinkedHashMap.java:742)
        at java.util.AbstractCollection.addAll(AbstractCollection.java:343)
        at java.util.HashSet.&amp;lt;init&amp;gt;(HashSet.java:119)
        at org.apache.kafka.common.internals.PartitionStates.partitionSet(PartitionStates.java:66)
        at org.apache.kafka.clients.consumer.internals.SubscriptionState.assignedPartitions(SubscriptionState.java:291)
        at org.apache.kafka.clients.consumer.internals.ConsumerCoordinator$ConsumerCoordinatorMetrics$1.measure(ConsumerCoordinator.java:783)
        at org.apache.kafka.common.metrics.KafkaMetric.value(KafkaMetric.java:61)
        at org.apache.kafka.common.metrics.KafkaMetric.value(KafkaMetric.java:52)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// client code:
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.util.Collections;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.util.HashMap;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.util.Map;

&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; com.codahale.metrics.Gauge;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; com.codahale.metrics.Metric;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; com.codahale.metrics.MetricSet;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.kafka.clients.consumer.KafkaConsumer;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.kafka.common.MetricName;

&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; com.codahale.metrics.MetricRegistry.name;

&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;KafkaMetricSet &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; MetricSet {

    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; KafkaConsumer client;

    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; KafkaMetricSet(KafkaConsumer client) {
        &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.client = client;
    }

    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, Metric&amp;gt; getMetrics() {
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, Metric&amp;gt; gauges = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HashMap&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, Metric&amp;gt;();
        Map&amp;lt;MetricName, org.apache.kafka.common.Metric&amp;gt; m = client.metrics();
        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (Map.Entry&amp;lt;MetricName, org.apache.kafka.common.Metric&amp;gt; e : m.entrySet()) {
            gauges.put(name(e.getKey().group(), e.getKey().name(), &lt;span class=&quot;code-quote&quot;&gt;&quot;count&quot;&lt;/span&gt;), &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Gauge&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Double&lt;/span&gt;&amp;gt;() {
                @Override
                &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Double&lt;/span&gt; getValue() {
                    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; e.getValue().value(); &lt;span class=&quot;code-comment&quot;&gt;// exception thrown here 
&lt;/span&gt;                }
            });
        }
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; Collections.unmodifiableMap(gauges);
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13059149">KAFKA-4950</key>
            <summary>ConcurrentModificationException when iterating over Kafka Metrics</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="yabon">S&#233;bastien Launay</assignee>
                                    <reporter username="dpostoronca">Dumitru Postoronca</reporter>
                        <labels>
                    </labels>
                <created>Sat, 25 Mar 2017 15:08:14 +0000</created>
                <updated>Wed, 8 Aug 2018 22:45:33 +0000</updated>
                            <resolved>Wed, 8 Aug 2018 22:45:33 +0000</resolved>
                                    <version>0.10.1.1</version>
                                    <fixVersion>1.0.3</fixVersion>
                    <fixVersion>1.1.2</fixVersion>
                    <fixVersion>2.0.1</fixVersion>
                    <fixVersion>2.1.0</fixVersion>
                                    <component>consumer</component>
                        <due></due>
                            <votes>5</votes>
                                    <watches>15</watches>
                                                                                                                <comments>
                            <comment id="15960720" author="ijuma" created="Fri, 7 Apr 2017 12:49:09 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vahid&quot; class=&quot;user-hover&quot; rel=&quot;vahid&quot;&gt;vahid&lt;/a&gt;, would you like to pick this one up?&lt;/p&gt;</comment>
                            <comment id="15963308" author="vahid" created="Mon, 10 Apr 2017 18:34:38 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ijuma&quot; class=&quot;user-hover&quot; rel=&quot;ijuma&quot;&gt;ijuma&lt;/a&gt; Yup, thanks!&lt;/p&gt;</comment>
                            <comment id="15977116" author="vahid" created="Thu, 20 Apr 2017 17:34:08 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dpostoronca&quot; class=&quot;user-hover&quot; rel=&quot;dpostoronca&quot;&gt;dpostoronca&lt;/a&gt; Would you mind sharing a bit more of your client code to avoid the compile errors? Thanks.&lt;/p&gt;</comment>
                            <comment id="15977294" author="dpostoronca" created="Thu, 20 Apr 2017 19:18:35 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vahid&quot; class=&quot;user-hover&quot; rel=&quot;vahid&quot;&gt;vahid&lt;/a&gt;: updated description with whole class. The code is basically mapping Kakfa metrics to Codahale metrics. I think the dependency version is &lt;tt&gt;&apos;io.dropwizard.metrics:metrics-core:3.1.2&apos;&lt;/tt&gt;.&lt;br/&gt;
The metrics library then calls the gauge.getValue() method every minute, to get the current value, thus effectively executing &lt;tt&gt;e.getValue().value()&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="16005658" author="vahid" created="Wed, 10 May 2017 23:31:46 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dpostoronca&quot; class=&quot;user-hover&quot; rel=&quot;dpostoronca&quot;&gt;dpostoronca&lt;/a&gt; Thanks for providing the additional details. I cannot reproduce the error when running a simple consumer (that polls and collects the metrics in a loop) with the provided &lt;tt&gt;KafkaMetricSet&lt;/tt&gt; class. I see that both &lt;tt&gt;PartitionStates.partitionSet()&lt;/tt&gt; and the overloaded &lt;tt&gt;getValue()&lt;/tt&gt; methods are called but they don&apos;t seem to interfere with each other. Perhaps I&apos;m missing something? &lt;/p&gt;</comment>
                            <comment id="16011958" author="dpostoronca" created="Tue, 16 May 2017 08:14:53 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vahid&quot; class=&quot;user-hover&quot; rel=&quot;vahid&quot;&gt;vahid&lt;/a&gt;: I would try to simulate by having two threads, one calling &lt;tt&gt;partitionSet()&lt;/tt&gt; in a loop and another calling any other method in PartitionStates, for example &lt;tt&gt;moveToEnd(..)&lt;/tt&gt; or perhaps &lt;tt&gt;remove(topicPartition)&lt;/tt&gt;. You would have two threads modifying the same &lt;tt&gt;map&lt;/tt&gt; variable.&lt;/p&gt;

&lt;p&gt;A real-life use-case might be thread #1 reporting metrics to Graphite (calling &lt;tt&gt;partitionSet()&lt;/tt&gt;, basically) and thread #2 reacting to a rebalance and calling &lt;tt&gt;remove(topicPartition)&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="16016640" author="vahid" created="Thu, 18 May 2017 23:19:32 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dpostoronca&quot; class=&quot;user-hover&quot; rel=&quot;dpostoronca&quot;&gt;dpostoronca&lt;/a&gt; Still no luck on my side reproducing this error. I run two threads as you suggested. In one thread I run (in a loop) your metric collection code above (that leads to calling &lt;tt&gt;PartitionStates.partitionSet()&lt;/tt&gt;; and in the other, I do repeating &lt;tt&gt;poll&lt;/tt&gt; calls (that lead to calling &lt;tt&gt;PartitionStates.moveToEnd(..)&lt;/tt&gt;). Both threads run with the same consumer instance.&lt;/p&gt;</comment>
                            <comment id="16148437" author="gibe" created="Thu, 31 Aug 2017 04:46:39 +0000"  >&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;I was able to reproduce the issue using the following piece of code:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; KafkaConsumer&amp;lt;K, V&amp;gt; consumer = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; KafkaConsumer&amp;lt;K, V&amp;gt;(props);
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// consumer.subscribe(....);
&lt;/span&gt;
        &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Runnable&lt;/span&gt;() {

            @Override
            &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void run() {
                &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;) {
                    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (Metric metric : consumer.metrics().values()) {
                        metric.value();
                    }
                }
            }
        }).start();

        &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;) {
            consumer.poll(100);
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I know that the consumer should not be used from several threads. However in my case I&apos;m accessing them through the consumer JMX MBeans and then I have little control on when or from where they are called.&lt;/p&gt;

&lt;p&gt;Here is an extract of the stacktrace I got when I access them from JMX MBeans:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;javax.management.RuntimeMBeanException: java.util.ConcurrentModificationException
	at com.sun.jmx.interceptor.DefaultMBeanServerInterceptor.rethrow(DefaultMBeanServerInterceptor.java:839)
	at com.sun.jmx.interceptor.DefaultMBeanServerInterceptor.rethrowMaybeMBeanException(DefaultMBeanServerInterceptor.java:852)
	at com.sun.jmx.interceptor.DefaultMBeanServerInterceptor.getAttribute(DefaultMBeanServerInterceptor.java:651)
	at com.sun.jmx.mbeanserver.JmxMBeanServer.getAttribute(JmxMBeanServer.java:678)
        ....
Caused by: java.util.ConcurrentModificationException
	at java.util.LinkedHashMap$LinkedHashIterator.nextNode(LinkedHashMap.java:719)
	at java.util.LinkedHashMap$LinkedKeyIterator.next(LinkedHashMap.java:742)
	at java.util.AbstractCollection.addAll(AbstractCollection.java:343)
	at java.util.HashSet.&amp;lt;init&amp;gt;(HashSet.java:119)
	at org.apache.kafka.common.internals.PartitionStates.partitionSet(PartitionStates.java:66)
	at org.apache.kafka.clients.consumer.internals.SubscriptionState.assignedPartitions(SubscriptionState.java:293)
	at org.apache.kafka.clients.consumer.internals.ConsumerCoordinator$ConsumerCoordinatorMetrics$1.measure(ConsumerCoordinator.java:884)
	at org.apache.kafka.common.metrics.KafkaMetric.value(KafkaMetric.java:61)
	at org.apache.kafka.common.metrics.KafkaMetric.value(KafkaMetric.java:52)
	at org.apache.kafka.common.metrics.JmxReporter$KafkaMbean.getAttribute(JmxReporter.java:183)
	at com.sun.jmx.interceptor.DefaultMBeanServerInterceptor.getAttribute(DefaultMBeanServerInterceptor.java:647)
	... 40 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16172126" author="githubbot" created="Tue, 19 Sep 2017 18:25:08 +0000"  >&lt;p&gt;GitHub user slaunay opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/3907&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3907&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-4950&quot; title=&quot;ConcurrentModificationException when iterating over Kafka Metrics&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-4950&quot;&gt;&lt;del&gt;KAFKA-4950&lt;/del&gt;&lt;/a&gt;: Fix ConcurrentModificationException on assigned-partitions metric&lt;/p&gt;

&lt;p&gt;    Code change:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;prevent `java.util.ConcurrentModificationException` being thrown when fetching the consumer coordinator assigned-partitions metric value from a `MetricsReporter` (e.g. a reporter exporting metrics periodically running in a separate thread) because of a race condition by using a volatile field for storing the number of assigned partitions:&lt;br/&gt;
    ```&lt;br/&gt;
    java.util.ConcurrentModificationException: null&lt;br/&gt;
            at java.util.LinkedHashMap$LinkedHashIterator.nextNode(LinkedHashMap.java:719)&lt;br/&gt;
            at java.util.LinkedHashMap$LinkedKeyIterator.next(LinkedHashMap.java:742)&lt;br/&gt;
            at java.util.AbstractCollection.addAll(AbstractCollection.java:343)&lt;br/&gt;
            at java.util.HashSet.&amp;lt;init&amp;gt;(HashSet.java:119)&lt;br/&gt;
            at org.apache.kafka.common.internals.PartitionStates.partitionSet(PartitionStates.java:66)&lt;br/&gt;
            at org.apache.kafka.clients.consumer.internals.SubscriptionState.assignedPartitions(SubscriptionState.java:293)&lt;br/&gt;
            at org.apache.kafka.clients.consumer.internals.ConsumerCoordinator$ConsumerCoordinatorMetrics$1.measure(ConsumerCoordinator.java:880)&lt;br/&gt;
            ...&lt;br/&gt;
            at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)&lt;br/&gt;
            at java.util.concurrent.FutureTask.runAndReset(FutureTask.java:308)&lt;br/&gt;
            at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$301(ScheduledThreadPoolExecutor.java:180)&lt;br/&gt;
            at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:294)&lt;br/&gt;
            at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)&lt;br/&gt;
            at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)&lt;br/&gt;
            at java.lang.Thread.run(Thread.java:748)&lt;br/&gt;
    ```&lt;/li&gt;
	&lt;li&gt;new unit test to reproduce the issue and detect potential future regression&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    I am using a volatile field on `SubscriptionState` rather than changing the `PartitionStates.map` field to some thread safe `LinkedHashMap` alternative to avoid bringing an unnecessary concurrent structure to other components relying on `PartitionStates`.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/slaunay/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/slaunay/kafka&lt;/a&gt; bugfix/&lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-4950&quot; title=&quot;ConcurrentModificationException when iterating over Kafka Metrics&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-4950&quot;&gt;&lt;del&gt;KAFKA-4950&lt;/del&gt;&lt;/a&gt;-cme-assigned-partitions-metric&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/3907.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3907.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #3907&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 3787ac4c6070d0d4271cac27d9b43b2fdbe8b78f&lt;br/&gt;
Author: Sebastien Launay &amp;lt;sebastien@opendns.com&amp;gt;&lt;br/&gt;
Date:   2017-09-15T23:26:44Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-4950&quot; title=&quot;ConcurrentModificationException when iterating over Kafka Metrics&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-4950&quot;&gt;&lt;del&gt;KAFKA-4950&lt;/del&gt;&lt;/a&gt;; Fix CME on assigned-partitions metric&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;prevent java.util.ConcurrentModificationException being thrown when&lt;br/&gt;
      fetching the consumer coordinator assigned-partitions metric value from&lt;br/&gt;
      a MetricsReporter (e.g. a reporter exporting metrics periodically running&lt;br/&gt;
      in a separate thread) because of a race condition by using a volatile field&lt;br/&gt;
      for storing the number of assigned partitions:&lt;br/&gt;
    java.util.ConcurrentModificationException: null&lt;br/&gt;
            at java.util.LinkedHashMap$LinkedHashIterator.nextNode(LinkedHashMap.java:719)&lt;br/&gt;
            at java.util.LinkedHashMap$LinkedKeyIterator.next(LinkedHashMap.java:742)&lt;br/&gt;
            at java.util.AbstractCollection.addAll(AbstractCollection.java:343)&lt;br/&gt;
            at java.util.HashSet.&amp;lt;init&amp;gt;(HashSet.java:119)&lt;br/&gt;
            at org.apache.kafka.common.internals.PartitionStates.partitionSet(PartitionStates.java:66)&lt;br/&gt;
            at org.apache.kafka.clients.consumer.internals.SubscriptionState.assignedPartitions(SubscriptionState.java:293)&lt;br/&gt;
            at org.apache.kafka.clients.consumer.internals.ConsumerCoordinator$ConsumerCoordinatorMetrics$1.measure(ConsumerCoordinator.java:880)&lt;br/&gt;
            ...&lt;br/&gt;
            at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)&lt;br/&gt;
            at java.util.concurrent.FutureTask.runAndReset(FutureTask.java:308)&lt;br/&gt;
            at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$301(ScheduledThreadPoolExecutor.java:180)&lt;br/&gt;
            at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:294)&lt;br/&gt;
            at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)&lt;br/&gt;
            at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)&lt;br/&gt;
            at java.lang.Thread.run(Thread.java:748)&lt;/li&gt;
	&lt;li&gt;new unit test to reproduce the issue and detect potential future regression&lt;/li&gt;
&lt;/ul&gt;


&lt;hr /&gt;</comment>
                            <comment id="16172134" author="yabon" created="Tue, 19 Sep 2017 18:29:46 +0000"  >&lt;p&gt;I am also getting such an error sporadically when using a custom version of &lt;a href=&quot;https://github.com/apakulov/kafka-graphite&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;kafka-graphite&lt;/a&gt; when periodically pushing consumer metrics to a Graphite server.&lt;/p&gt;

&lt;p&gt;You can find a unit test in the PR above to reproduce the &lt;tt&gt;ConcurrentModificationException&lt;/tt&gt; (fails consistently on my laptop).&lt;/p&gt;

&lt;p&gt;Let me know what you think of the bugfix.&lt;/p&gt;</comment>
                            <comment id="16240766" author="jeffwidman" created="Mon, 6 Nov 2017 19:39:15 +0000"  >&lt;p&gt;Should the component here be (new) consumer? Or does this also affect broker and/or producer?&lt;/p&gt;</comment>
                            <comment id="16247239" author="rsivaram" created="Fri, 10 Nov 2017 09:09:06 +0000"  >&lt;p&gt;Moving this to the next release since the PR is still under review.&lt;/p&gt;</comment>
                            <comment id="16343885" author="ewencp" created="Mon, 29 Jan 2018 19:40:40 +0000"  >&lt;p&gt;Moving from 1.0.1 to 1.0.2 as this isn&apos;t ready for 1.0.1.&lt;/p&gt;</comment>
                            <comment id="16512060" author="rsivaram" created="Thu, 14 Jun 2018 07:17:21 +0000"  >&lt;p&gt;Moving this out since it is not ready for 2,0.0&lt;/p&gt;</comment>
                            <comment id="16573994" author="githubbot" created="Wed, 8 Aug 2018 22:43:47 +0000"  >&lt;p&gt;hachikuji closed pull request #3907: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-4950&quot; title=&quot;ConcurrentModificationException when iterating over Kafka Metrics&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-4950&quot;&gt;&lt;del&gt;KAFKA-4950&lt;/del&gt;&lt;/a&gt;: Fix ConcurrentModificationException on assigned-partitions metric&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/3907&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3907&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/clients/src/main/java/org/apache/kafka/clients/consumer/internals/ConsumerCoordinator.java b/clients/src/main/java/org/apache/kafka/clients/consumer/internals/ConsumerCoordinator.java&lt;br/&gt;
index 87624803d70..ce2db3566e9 100644&lt;br/&gt;
&amp;#8212; a/clients/src/main/java/org/apache/kafka/clients/consumer/internals/ConsumerCoordinator.java&lt;br/&gt;
+++ b/clients/src/main/java/org/apache/kafka/clients/consumer/internals/ConsumerCoordinator.java&lt;br/&gt;
@@ -942,7 +942,8 @@ private ConsumerCoordinatorMetrics(Metrics metrics, String metricGrpPrefix) {&lt;br/&gt;
             Measurable numParts =&lt;br/&gt;
                 new Measurable() {&lt;br/&gt;
                     public double measure(MetricConfig config, long now) &lt;/p&gt;
{
-                        return subscriptions.assignedPartitions().size();
+                        // Get the number of assigned partitions in a thread safe manner
+                        return subscriptions.numAssignedPartitions();
                     }
&lt;p&gt;                 };&lt;br/&gt;
             metrics.addMetric(metrics.metricName(&quot;assigned-partitions&quot;,&lt;br/&gt;
diff --git a/clients/src/main/java/org/apache/kafka/clients/consumer/internals/SubscriptionState.java b/clients/src/main/java/org/apache/kafka/clients/consumer/internals/SubscriptionState.java&lt;br/&gt;
index e28973452a7..542c413d33e 100644&lt;br/&gt;
&amp;#8212; a/clients/src/main/java/org/apache/kafka/clients/consumer/internals/SubscriptionState.java&lt;br/&gt;
+++ b/clients/src/main/java/org/apache/kafka/clients/consumer/internals/SubscriptionState.java&lt;br/&gt;
@@ -268,6 +268,14 @@ public void seek(TopicPartition tp, long offset) &lt;/p&gt;
{
         return this.assignment.partitionSet();
     }

&lt;p&gt;+    /**&lt;br/&gt;
+     * Provides the number of assigned partitions in a thread safe manner.&lt;br/&gt;
+     * @return the number of assigned partitions.&lt;br/&gt;
+     */&lt;br/&gt;
+    public int numAssignedPartitions() &lt;/p&gt;
{
+        return this.assignment.size();
+    }
&lt;p&gt;+&lt;br/&gt;
     public List&amp;lt;TopicPartition&amp;gt; fetchablePartitions() {&lt;br/&gt;
         List&amp;lt;TopicPartition&amp;gt; fetchable = new ArrayList&amp;lt;&amp;gt;(assignment.size());&lt;br/&gt;
         for (PartitionStates.PartitionState&amp;lt;TopicPartitionState&amp;gt; state : assignment.partitionStates()) {&lt;br/&gt;
diff --git a/clients/src/main/java/org/apache/kafka/common/internals/PartitionStates.java b/clients/src/main/java/org/apache/kafka/common/internals/PartitionStates.java&lt;br/&gt;
index 605372c6ec7..5b904c26717 100644&lt;br/&gt;
&amp;#8212; a/clients/src/main/java/org/apache/kafka/common/internals/PartitionStates.java&lt;br/&gt;
+++ b/clients/src/main/java/org/apache/kafka/common/internals/PartitionStates.java&lt;br/&gt;
@@ -36,11 +36,17 @@&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;topic would &quot;wrap around&quot; and appear twice. However, as partitions are fetched in different orders and partition&lt;/li&gt;
	&lt;li&gt;leadership changes, we will deviate from the optimal. If this turns out to be an issue in practice, we can improve&lt;/li&gt;
	&lt;li&gt;it by tracking the partitions per node or calling `set` every so often.&lt;br/&gt;
+ *&lt;br/&gt;
+ * Note that this class is not thread-safe with the exception of 
{@link #size()}
&lt;p&gt; which returns the number of&lt;br/&gt;
+ * partitions currently tracked.&lt;br/&gt;
  */&lt;br/&gt;
 public class PartitionStates&amp;lt;S&amp;gt; {&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     private final LinkedHashMap&amp;lt;TopicPartition, S&amp;gt; map = new LinkedHashMap&amp;lt;&amp;gt;();&lt;/p&gt;

&lt;p&gt;+    /* the number of partitions that are currently assigned available in a thread safe manner */&lt;br/&gt;
+    private volatile int size = 0;&lt;br/&gt;
+&lt;br/&gt;
     public PartitionStates() {}&lt;/p&gt;

&lt;p&gt;     public void moveToEnd(TopicPartition topicPartition) {&lt;br/&gt;
@@ -52,10 +58,12 @@ public void moveToEnd(TopicPartition topicPartition) {&lt;br/&gt;
     public void updateAndMoveToEnd(TopicPartition topicPartition, S state) &lt;/p&gt;
{
         map.remove(topicPartition);
         map.put(topicPartition, state);
+        updateSize();
     }

&lt;p&gt;     public void remove(TopicPartition topicPartition) &lt;/p&gt;
{
         map.remove(topicPartition);
+        updateSize();
     }

&lt;p&gt;     /**&lt;br/&gt;
@@ -67,6 +75,7 @@ public void remove(TopicPartition topicPartition) {&lt;/p&gt;

&lt;p&gt;     public void clear() &lt;/p&gt;
{
         map.clear();
+        updateSize();
     }

&lt;p&gt;     public boolean contains(TopicPartition topicPartition) {&lt;br/&gt;
@@ -95,8 +104,11 @@ public S stateValue(TopicPartition topicPartition) &lt;/p&gt;
{
         return map.get(topicPartition);
     }

&lt;p&gt;+    /**&lt;br/&gt;
+     * Get the number of partitions that are currently being tracked. This is thread-safe.&lt;br/&gt;
+     */&lt;br/&gt;
     public int size() &lt;/p&gt;
{
-        return map.size();
+        return size;
     }

&lt;p&gt;     /**&lt;br/&gt;
@@ -108,6 +120,11 @@ public int size() {&lt;br/&gt;
     public void set(Map&amp;lt;TopicPartition, S&amp;gt; partitionToState) &lt;/p&gt;
{
         map.clear();
         update(partitionToState);
+        updateSize();
+    }
&lt;p&gt;+&lt;br/&gt;
+    private void updateSize() &lt;/p&gt;
{
+        size = map.size();
     }

&lt;p&gt;     private void update(Map&amp;lt;TopicPartition, S&amp;gt; partitionToState) {&lt;br/&gt;
diff --git a/clients/src/test/java/org/apache/kafka/clients/consumer/internals/ConsumerCoordinatorTest.java b/clients/src/test/java/org/apache/kafka/clients/consumer/internals/ConsumerCoordinatorTest.java&lt;br/&gt;
index 62c70a02686..2b6d3037728 100644&lt;br/&gt;
&amp;#8212; a/clients/src/test/java/org/apache/kafka/clients/consumer/internals/ConsumerCoordinatorTest.java&lt;br/&gt;
+++ b/clients/src/test/java/org/apache/kafka/clients/consumer/internals/ConsumerCoordinatorTest.java&lt;br/&gt;
@@ -30,6 +30,8 @@&lt;br/&gt;
 import org.apache.kafka.clients.consumer.RoundRobinAssignor;&lt;br/&gt;
 import org.apache.kafka.common.Cluster;&lt;br/&gt;
 import org.apache.kafka.common.KafkaException;&lt;br/&gt;
+import org.apache.kafka.common.Metric;&lt;br/&gt;
+import org.apache.kafka.common.MetricName;&lt;br/&gt;
 import org.apache.kafka.common.Node;&lt;br/&gt;
 import org.apache.kafka.common.TopicPartition;&lt;br/&gt;
 import org.apache.kafka.common.errors.ApiException;&lt;br/&gt;
@@ -55,6 +57,7 @@&lt;br/&gt;
 import org.apache.kafka.common.requests.SyncGroupResponse;&lt;br/&gt;
 import org.apache.kafka.common.utils.LogContext;&lt;br/&gt;
 import org.apache.kafka.common.utils.MockTime;&lt;br/&gt;
+import org.apache.kafka.test.TestCondition;&lt;br/&gt;
 import org.apache.kafka.test.TestUtils;&lt;br/&gt;
 import org.junit.After;&lt;br/&gt;
 import org.junit.Before;&lt;br/&gt;
@@ -77,6 +80,7 @@&lt;br/&gt;
 import java.util.concurrent.TimeoutException;&lt;br/&gt;
 import java.util.concurrent.atomic.AtomicBoolean;&lt;br/&gt;
 import java.util.concurrent.atomic.AtomicInteger;&lt;br/&gt;
+import java.util.concurrent.atomic.AtomicReference;&lt;br/&gt;
 import java.util.regex.Pattern;&lt;/p&gt;

&lt;p&gt; import static java.util.Collections.singleton;&lt;br/&gt;
@@ -440,7 +444,7 @@ public boolean matches(AbstractRequest body) {&lt;br/&gt;
         coordinator.poll(time.timer(Long.MAX_VALUE));&lt;/p&gt;

&lt;p&gt;         assertFalse(coordinator.rejoinNeededOrPending());&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;assertEquals(2, subscriptions.assignedPartitions().size());&lt;br/&gt;
+        assertEquals(2, subscriptions.numAssignedPartitions());&lt;br/&gt;
         assertEquals(2, subscriptions.groupSubscription().size());&lt;br/&gt;
         assertEquals(2, subscriptions.subscription().size());&lt;br/&gt;
         assertEquals(1, rebalanceListener.revokedCount);&lt;br/&gt;
@@ -685,7 +689,7 @@ public boolean matches(AbstractRequest body) {&lt;br/&gt;
         coordinator.joinGroupIfNeeded(time.timer(Long.MAX_VALUE));&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         assertFalse(coordinator.rejoinNeededOrPending());&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;assertEquals(2, subscriptions.assignedPartitions().size());&lt;br/&gt;
+        assertEquals(2, subscriptions.numAssignedPartitions());&lt;br/&gt;
         assertEquals(2, subscriptions.subscription().size());&lt;br/&gt;
         assertEquals(1, rebalanceListener.revokedCount);&lt;br/&gt;
         assertEquals(1, rebalanceListener.assignedCount);&lt;br/&gt;
@@ -1740,6 +1744,60 @@ public void testProtocolMetadataOrder() {&lt;br/&gt;
         }&lt;br/&gt;
     }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;+    @Test&lt;br/&gt;
+    public void testThreadSafeAssignedPartitionsMetric() throws Exception {&lt;br/&gt;
+        // Get the assigned-partitions metric&lt;br/&gt;
+        final Metric metric = metrics.metric(new MetricName(&quot;assigned-partitions&quot;, &quot;consumer&quot; + groupId + &quot;-coordinator-metrics&quot;,&lt;br/&gt;
+                &quot;&quot;, Collections.&amp;lt;String, String&amp;gt;emptyMap()));&lt;br/&gt;
+&lt;br/&gt;
+        // Start polling the metric in the background&lt;br/&gt;
+        final AtomicBoolean doStop = new AtomicBoolean();&lt;br/&gt;
+        final AtomicReference&amp;lt;Exception&amp;gt; exceptionHolder = new AtomicReference&amp;lt;&amp;gt;();&lt;br/&gt;
+        final AtomicInteger observedSize = new AtomicInteger();&lt;br/&gt;
+&lt;br/&gt;
+        Thread poller = new Thread() {&lt;br/&gt;
+            @Override&lt;br/&gt;
+            public void run() {&lt;br/&gt;
+                // Poll as fast as possible to reproduce ConcurrentModificationException&lt;br/&gt;
+                while (!doStop.get()) {&lt;br/&gt;
+                    try &lt;/p&gt;
{
+                        int size = ((Double) metric.metricValue()).intValue();
+                        observedSize.set(size);
+                    }
&lt;p&gt; catch (Exception e) &lt;/p&gt;
{
+                        exceptionHolder.set(e);
+                        return;
+                    }
&lt;p&gt;+                }&lt;br/&gt;
+            }&lt;br/&gt;
+        };&lt;br/&gt;
+        poller.start();&lt;br/&gt;
+&lt;br/&gt;
+        // Assign two partitions to trigger a metric change that can lead to ConcurrentModificationException&lt;br/&gt;
+        client.prepareResponse(groupCoordinatorResponse(node, Errors.NONE));&lt;br/&gt;
+        coordinator.ensureCoordinatorReady(time.timer(Long.MAX_VALUE));&lt;br/&gt;
+&lt;br/&gt;
+        // Change the assignment several times to increase likelihood of concurrent updates&lt;br/&gt;
+        Set&amp;lt;TopicPartition&amp;gt; partitions = new HashSet&amp;lt;&amp;gt;();&lt;br/&gt;
+        int totalPartitions = 10;&lt;br/&gt;
+        for (int partition = 0; partition &amp;lt; totalPartitions; partition++) &lt;/p&gt;
{
+            partitions.add(new TopicPartition(topic1, partition));
+            subscriptions.assignFromUser(partitions);
+        }
&lt;p&gt;+&lt;br/&gt;
+        // Wait for the metric poller to observe the final assignment change or raise an error&lt;br/&gt;
+        TestUtils.waitForCondition(new TestCondition() {&lt;br/&gt;
+            @Override&lt;br/&gt;
+            public boolean conditionMet() &lt;/p&gt;
{
+                return observedSize.get() == totalPartitions || exceptionHolder.get() != null;
+            }
&lt;p&gt;+        }, &quot;Failed to observe expected assignment change&quot;);&lt;br/&gt;
+&lt;br/&gt;
+        doStop.set(true);&lt;br/&gt;
+        poller.join();&lt;br/&gt;
+&lt;br/&gt;
+        assertNull(&quot;Failed fetching the metric at least once&quot;, exceptionHolder.get());&lt;br/&gt;
+    }&lt;br/&gt;
+&lt;br/&gt;
     @Test&lt;br/&gt;
     public void testCloseDynamicAssignment() throws Exception {&lt;br/&gt;
         ConsumerCoordinator coordinator = prepareCoordinatorForCloseTest(true, true, true);&lt;br/&gt;
diff --git a/clients/src/test/java/org/apache/kafka/clients/consumer/internals/SubscriptionStateTest.java b/clients/src/test/java/org/apache/kafka/clients/consumer/internals/SubscriptionStateTest.java&lt;br/&gt;
index 24255e8949f..05287e0c1ec 100644&lt;br/&gt;
&amp;#8212; a/clients/src/test/java/org/apache/kafka/clients/consumer/internals/SubscriptionStateTest.java&lt;br/&gt;
+++ b/clients/src/test/java/org/apache/kafka/clients/consumer/internals/SubscriptionStateTest.java&lt;br/&gt;
@@ -49,12 +49,14 @@&lt;br/&gt;
     public void partitionAssignment() &lt;/p&gt;
{
         state.assignFromUser(singleton(tp0));
         assertEquals(singleton(tp0), state.assignedPartitions());
+        assertEquals(1, state.numAssignedPartitions());
         assertFalse(state.hasAllFetchPositions());
         state.seek(tp0, 1);
         assertTrue(state.isFetchable(tp0));
         assertEquals(1L, state.position(tp0).longValue());
         state.assignFromUser(Collections.&amp;lt;TopicPartition&amp;gt;emptySet());
         assertTrue(state.assignedPartitions().isEmpty());
+        assertEquals(0, state.numAssignedPartitions());
         assertFalse(state.isAssigned(tp0));
         assertFalse(state.isFetchable(tp0));
     }
&lt;p&gt;@@ -64,28 +66,34 @@ public void partitionAssignmentChangeOnTopicSubscription() &lt;/p&gt;
{
         state.assignFromUser(new HashSet&amp;lt;&amp;gt;(Arrays.asList(tp0, tp1)));
         // assigned partitions should immediately change
         assertEquals(2, state.assignedPartitions().size());
+        assertEquals(2, state.numAssignedPartitions());
         assertTrue(state.assignedPartitions().contains(tp0));
         assertTrue(state.assignedPartitions().contains(tp1));
 
         state.unsubscribe();
         // assigned partitions should immediately change
         assertTrue(state.assignedPartitions().isEmpty());
+        assertEquals(0, state.numAssignedPartitions());
 
         state.subscribe(singleton(topic1), rebalanceListener);
         // assigned partitions should remain unchanged
         assertTrue(state.assignedPartitions().isEmpty());
+        assertEquals(0, state.numAssignedPartitions());
 
         state.assignFromSubscribed(singleton(t1p0));
         // assigned partitions should immediately change
         assertEquals(singleton(t1p0), state.assignedPartitions());
+        assertEquals(1, state.numAssignedPartitions());
 
         state.subscribe(singleton(topic), rebalanceListener);
         // assigned partitions should remain unchanged
         assertEquals(singleton(t1p0), state.assignedPartitions());
+        assertEquals(1, state.numAssignedPartitions());
 
         state.unsubscribe();
         // assigned partitions should immediately change
         assertTrue(state.assignedPartitions().isEmpty());
+        assertEquals(0, state.numAssignedPartitions());
     }

&lt;p&gt;     @Test&lt;br/&gt;
@@ -93,37 +101,45 @@ public void partitionAssignmentChangeOnPatternSubscription() &lt;/p&gt;
{
         state.subscribe(Pattern.compile(&quot;.*&quot;), rebalanceListener);
         // assigned partitions should remain unchanged
         assertTrue(state.assignedPartitions().isEmpty());
+        assertEquals(0, state.numAssignedPartitions());
 
         state.subscribeFromPattern(new HashSet&amp;lt;&amp;gt;(Collections.singletonList(topic)));
         // assigned partitions should remain unchanged
         assertTrue(state.assignedPartitions().isEmpty());
+        assertEquals(0, state.numAssignedPartitions());
 
         state.assignFromSubscribed(singleton(tp1));
         // assigned partitions should immediately change
         assertEquals(singleton(tp1), state.assignedPartitions());
+        assertEquals(1, state.numAssignedPartitions());
         assertEquals(singleton(topic), state.subscription());
 
         state.assignFromSubscribed(Collections.singletonList(t1p0));
         // assigned partitions should immediately change
         assertEquals(singleton(t1p0), state.assignedPartitions());
+        assertEquals(1, state.numAssignedPartitions());
         assertEquals(singleton(topic), state.subscription());
 
         state.subscribe(Pattern.compile(&quot;.*t&quot;), rebalanceListener);
         // assigned partitions should remain unchanged
         assertEquals(singleton(t1p0), state.assignedPartitions());
+        assertEquals(1, state.numAssignedPartitions());
 
         state.subscribeFromPattern(singleton(topic));
         // assigned partitions should remain unchanged
         assertEquals(singleton(t1p0), state.assignedPartitions());
+        assertEquals(1, state.numAssignedPartitions());
 
         state.assignFromSubscribed(Collections.singletonList(tp0));
         // assigned partitions should immediately change
         assertEquals(singleton(tp0), state.assignedPartitions());
+        assertEquals(1, state.numAssignedPartitions());
         assertEquals(singleton(topic), state.subscription());
 
         state.unsubscribe();
         // assigned partitions should immediately change
         assertTrue(state.assignedPartitions().isEmpty());
+        assertEquals(0, state.numAssignedPartitions());
     }

&lt;p&gt;     @Test&lt;br/&gt;
@@ -169,6 +185,7 @@ public void topicSubscription() {&lt;br/&gt;
         state.subscribe(singleton(topic), rebalanceListener);&lt;br/&gt;
         assertEquals(1, state.subscription().size());&lt;br/&gt;
         assertTrue(state.assignedPartitions().isEmpty());&lt;br/&gt;
+        assertEquals(0, state.numAssignedPartitions());&lt;br/&gt;
         assertTrue(state.partitionsAutoAssigned());&lt;br/&gt;
         state.assignFromSubscribed(singleton(tp0));&lt;br/&gt;
         state.seek(tp0, 1);&lt;br/&gt;
@@ -178,6 +195,7 @@ public void topicSubscription() &lt;/p&gt;
{
         assertFalse(state.isAssigned(tp0));
         assertFalse(state.isFetchable(tp1));
         assertEquals(singleton(tp1), state.assignedPartitions());
+        assertEquals(1, state.numAssignedPartitions());
     }

&lt;p&gt;     @Test&lt;br/&gt;
@@ -261,6 +279,7 @@ public void unsubscribeUserSubscribe() &lt;/p&gt;
{
         state.unsubscribe();
         state.assignFromUser(singleton(tp0));
         assertEquals(singleton(tp0), state.assignedPartitions());
+        assertEquals(1, state.numAssignedPartitions());
     }

&lt;p&gt;     @Test&lt;br/&gt;
@@ -269,17 +288,21 @@ public void unsubscription() &lt;/p&gt;
{
         state.subscribeFromPattern(new HashSet&amp;lt;&amp;gt;(Arrays.asList(topic, topic1)));
         state.assignFromSubscribed(singleton(tp1));
         assertEquals(singleton(tp1), state.assignedPartitions());
+        assertEquals(1, state.numAssignedPartitions());
 
         state.unsubscribe();
         assertEquals(0, state.subscription().size());
         assertTrue(state.assignedPartitions().isEmpty());
+        assertEquals(0, state.numAssignedPartitions());
 
         state.assignFromUser(singleton(tp0));
         assertEquals(singleton(tp0), state.assignedPartitions());
+        assertEquals(1, state.numAssignedPartitions());
 
         state.unsubscribe();
         assertEquals(0, state.subscription().size());
         assertTrue(state.assignedPartitions().isEmpty());
+        assertEquals(0, state.numAssignedPartitions());
     }

&lt;p&gt;     private static class MockRebalanceListener implements ConsumerRebalanceListener {&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 14 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3cslb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>