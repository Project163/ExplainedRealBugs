<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:03:25 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-5771] org.apache.kafka.streams.state.internals.Segments#segments method returns incorrect results when segments were added out of order</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-5771</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;following unit test in org.apache.kafka.streams.state.internals.SegmentsTest will fail&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;org.apache.kafka.streams.state.internals.SegmentsTest.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    @Test
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void shouldGetSegmentsWithinTimeRangeOutOfOrder() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
        segments.getOrCreateSegment(4, context);
        segments.getOrCreateSegment(2, context);
        segments.getOrCreateSegment(0, context);
        segments.getOrCreateSegment(1, context);
        segments.getOrCreateSegment(3, context);

        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; List&amp;lt;Segment&amp;gt; segments = &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.segments.segments(0, 2 * 60 * 1000);
        assertEquals(3, segments.size());
        assertEquals(0, segments.get(0).id);
        assertEquals(1, segments.get(1).id);
        assertEquals(2, segments.get(2).id);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</description>
                <environment></environment>
        <key id="13097030">KAFKA-5771</key>
            <summary>org.apache.kafka.streams.state.internals.Segments#segments method returns incorrect results when segments were added out of order</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="radzish">Alexander Radzishevsky</assignee>
                                    <reporter username="radzish">Alexander Radzishevsky</reporter>
                        <labels>
                    </labels>
                <created>Wed, 23 Aug 2017 14:03:27 +0000</created>
                <updated>Fri, 25 Aug 2017 17:39:23 +0000</updated>
                            <resolved>Fri, 25 Aug 2017 12:59:49 +0000</resolved>
                                    <version>0.11.0.0</version>
                                    <fixVersion>0.11.0.1</fixVersion>
                    <fixVersion>1.0.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16139018" author="mjsax" created="Wed, 23 Aug 2017 20:24:38 +0000"  >&lt;p&gt;Why would we need to add segments out of order? Can you elaborate?&lt;/p&gt;</comment>
                            <comment id="16139767" author="radzish" created="Thu, 24 Aug 2017 08:43:19 +0000"  >&lt;p&gt;See application below:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        KStreamBuilder builder = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; KStreamBuilder();

        &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; WINDOW_SIZE = TimeUnit.DAYS.toMillis(2);
        &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; WINDOW_ADVANCE = TimeUnit.HOURS.toMillis(1);

        KStream&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; articleViewsStream = builder.stream(&lt;span class=&quot;code-quote&quot;&gt;&quot;streams-article-views-input&quot;&lt;/span&gt;);

        KTable&amp;lt;Windowed&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt;, &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;&amp;gt; articleViewsTable = articleViewsStream
                .map((key, value) -&amp;gt; KeyValue.pair(value, value))
                .groupByKey()
                .count(
                        TimeWindows.of(WINDOW_SIZE).advanceBy(WINDOW_ADVANCE).until(WINDOW_SIZE),
                        &lt;span class=&quot;code-quote&quot;&gt;&quot;article-views&quot;&lt;/span&gt;
                );
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Everytime message is sent to topic, Segments.getOrCreateSegment gets called with segmentIds passed to it out of order.&lt;br/&gt;
This in turn produces incorrect results of count aggregation for some windows.&lt;/p&gt;

&lt;p&gt;I found that minSegmentId is not calculated correctly. If we fix Segments like this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Index: streams/src/main/java/org/apache/kafka/streams/state/internals/Segments.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
&amp;lt;+&amp;gt;UTF-8
===================================================================
--- streams/src/main/java/org/apache/kafka/streams/state/internals/Segments.java	(revision b78d7ba5d58fa77b831244444eef005a62883f9b)
+++ streams/src/main/java/org/apache/kafka/streams/state/internals/Segments.java	(revision )
@@ -85,9 +85,7 @@
             &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (previousSegment == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
                 newSegment.openDB(context);
                 maxSegmentId = segmentId &amp;gt; maxSegmentId ? segmentId : maxSegmentId;
-                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (minSegmentId == &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;.MAX_VALUE) {
-                    minSegmentId = maxSegmentId;
-                }
+                minSegmentId = segmentId &amp;lt; minSegmentId ? segmentId : minSegmentId;
             }
             &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; previousSegment == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; ? newSegment : previousSegment;
         } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;unit test I provided will pass, it will not break other tests and will make my application to work correctly.&lt;/p&gt;</comment>
                            <comment id="16140853" author="guozhang" created="Thu, 24 Aug 2017 22:28:42 +0000"  >&lt;p&gt;If I understands this correctly, this issue is dependent on the timestamps of the messages received in this stateful operator: i.e. if we have messages coming in whose timestamp have big gaps and hence would fall in non-consecutive &quot;bucket&quot; (which will be calculated as &lt;tt&gt;timestamp / segmentInterval&lt;/tt&gt;) this issue will be triggered, is that right? &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=radzish&quot; class=&quot;user-hover&quot; rel=&quot;radzish&quot;&gt;radzish&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Your fix seems right to me. Could you open a PR following this process? &lt;a href=&quot;https://cwiki.apache.org/confluence/display/KAFKA/Contributing+Code+Changes#ContributingCodeChanges-PullRequest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://cwiki.apache.org/confluence/display/KAFKA/Contributing+Code+Changes#ContributingCodeChanges-PullRequest&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16141432" author="githubbot" created="Fri, 25 Aug 2017 09:47:53 +0000"  >&lt;p&gt;GitHub user radzish opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/3737&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3737&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5771&quot; title=&quot;org.apache.kafka.streams.state.internals.Segments#segments method returns incorrect results when segments were added out of order&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-5771&quot;&gt;&lt;del&gt;KAFKA-5771&lt;/del&gt;&lt;/a&gt;: org.apache.kafka.streams.state.internals.Segments#segments method returns incorrect results when segments were added out of order&lt;/p&gt;

&lt;p&gt;    Suggested fix for the bug&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/radzish/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/radzish/kafka&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5771&quot; title=&quot;org.apache.kafka.streams.state.internals.Segments#segments method returns incorrect results when segments were added out of order&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-5771&quot;&gt;&lt;del&gt;KAFKA-5771&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/3737.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3737.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #3737&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 32f8da5d0b39c449303a8dcd34476ed2b68197e6&lt;br/&gt;
Author: radzish &amp;lt;radzish@gmail.com&amp;gt;&lt;br/&gt;
Date:   2017-08-25T09:39:18Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5771&quot; title=&quot;org.apache.kafka.streams.state.internals.Segments#segments method returns incorrect results when segments were added out of order&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-5771&quot;&gt;&lt;del&gt;KAFKA-5771&lt;/del&gt;&lt;/a&gt;: org.apache.kafka.streams.state.internals.Segments#segments method returns incorrect results when segments were added out of order&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16141437" author="radzish" created="Fri, 25 Aug 2017 09:54:01 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt;, is there anything else from my side I should do?&lt;/p&gt;</comment>
                            <comment id="16141580" author="damianguy" created="Fri, 25 Aug 2017 12:59:49 +0000"  >&lt;p&gt;Issue resolved by pull request 3737&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/kafka/pull/3737&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3737&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16141581" author="githubbot" created="Fri, 25 Aug 2017 13:00:41 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/3737&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3737&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16141935" author="guozhang" created="Fri, 25 Aug 2017 17:39:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=radzish&quot; class=&quot;user-hover&quot; rel=&quot;radzish&quot;&gt;radzish&lt;/a&gt; Your patch has been merged by Damian, so you are all set, thanks for the contribution!&lt;/p&gt;

&lt;p&gt;I have added you to the contributor list so that you can assign tickets to yourself in the future.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 12 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3j6xj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>