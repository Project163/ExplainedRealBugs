<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:03:56 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-5758] Reassigning a topic&apos;s partitions can adversely impact other topics</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-5758</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;We&apos;ve noticed that reassigning a topic&apos;s partitions seems to adversely impact other topics. Specifically, followers for other topics fall out of the ISR.&lt;/p&gt;

&lt;p&gt;While I&apos;m not 100% sure about why this happens, the scenario seems to be as follows:&lt;/p&gt;

&lt;p&gt;1. Reassignment is manually triggered on topic-partition X-Y, and broker A (which used to be a follower for X-Y) is no longer a follower.&lt;br/&gt;
2. Broker A makes `FetchRequest` including topic-partition X-Y to broker B, just after the reassignment.&lt;br/&gt;
3. Broker B can fulfill the `FetchRequest`, but while trying to do so it tries to record the position of &quot;follower&quot; A. This fails, because broker A is no longer a follower for X-Y (see exception below).&lt;br/&gt;
4. The entire `FetchRequest` request fails, and broker A&apos;s other followed topics start falling behind.&lt;br/&gt;
5. Depending on the length of the reassignment, this sequence repeats.&lt;/p&gt;

&lt;p&gt;In step 3, we see exceptions like:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Error when handling request Name: FetchRequest; Version: 3; CorrelationId: 46781859; ClientId: ReplicaFetcherThread-0-1001; ReplicaId: 1006; MaxWait: 500 ms; MinBytes: 1 bytes; MaxBytes:10485760 bytes; RequestInfo: 

&amp;lt;LOTS OF PARTITIONS&amp;gt;

kafka.common.NotAssignedReplicaException: Leader 1001 failed to record follower 1006&apos;s position -1 since the replica is not recognized to be one of the assigned replicas 1001,1004,1005 for partition [topic_being_reassigned,5].
at kafka.cluster.Partition.updateReplicaLogReadResult(Partition.scala:249)
	at kafka.server.ReplicaManager$$anonfun$updateFollowerLogReadResults$2.apply(ReplicaManager.scala:923)
	at kafka.server.ReplicaManager$$anonfun$updateFollowerLogReadResults$2.apply(ReplicaManager.scala:920)
	at scala.collection.mutable.ResizableArray$class.foreach(ResizableArray.scala:59)
	at scala.collection.mutable.ArrayBuffer.foreach(ArrayBuffer.scala:48)
	at kafka.server.ReplicaManager.updateFollowerLogReadResults(ReplicaManager.scala:920)
	at kafka.server.ReplicaManager.fetchMessages(ReplicaManager.scala:481)
	at kafka.server.KafkaApis.handleFetchRequest(KafkaApis.scala:534)
	at kafka.server.KafkaApis.handle(KafkaApis.scala:79)
	at kafka.server.KafkaRequestHandler.run(KafkaRequestHandler.scala:60)
	at java.lang.Thread.run(Thread.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Does my assessment make sense? If so, this behaviour seems problematic. A few changes that might improve matters (assuming I&apos;m on the right track):&lt;/p&gt;

&lt;p&gt;1. `FetchRequest` should be able to return partial results&lt;br/&gt;
2. The broker fulfilling the `FetchRequest` could ignore the `NotAssignedReplicaException`, and return results without recording the not-any-longer-follower position.&lt;/p&gt;

&lt;p&gt;This behaviour was experienced with 0.10.1.1, although looking at the changelogs and the code in question, I don&apos;t see any reason why it would have changed in later versions.&lt;/p&gt;

&lt;p&gt;Am very interested to have some discussion on this. Thanks!&lt;/p&gt;</description>
                <environment></environment>
        <key id="13096493">KAFKA-5758</key>
            <summary>Reassigning a topic&apos;s partitions can adversely impact other topics</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ijuma">Ismael Juma</assignee>
                                    <reporter username="dwvangeest">David van Geest</reporter>
                        <labels>
                            <label>reliability</label>
                    </labels>
                <created>Mon, 21 Aug 2017 17:11:36 +0000</created>
                <updated>Sat, 17 Mar 2018 09:13:46 +0000</updated>
                            <resolved>Mon, 2 Oct 2017 21:44:19 +0000</resolved>
                                    <version>0.10.1.1</version>
                                    <fixVersion>1.0.0</fixVersion>
                                    <component>core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="16135904" author="dwvangeest" created="Mon, 21 Aug 2017 21:59:16 +0000"  >&lt;p&gt;This problem seems to be particularly pronounced if the partition reassignment takes a long time. We have done this twice in production, and when the partition re-assignment took 5 minutes, that&apos;s when we experienced the greatest under-replication problems.&lt;/p&gt;

&lt;p&gt;When the partition reassignment took only 30 seconds (less data in the topic), there were small blips of under-replication.&lt;/p&gt;</comment>
                            <comment id="16136702" author="ijuma" created="Tue, 22 Aug 2017 12:22:20 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dwvangeest&quot; class=&quot;user-hover&quot; rel=&quot;dwvangeest&quot;&gt;dwvangeest&lt;/a&gt;, looks like a good find. We should not be failing the whole fetch request, we should only fail the relevant partition.&lt;/p&gt;</comment>
                            <comment id="16136708" author="ijuma" created="Tue, 22 Aug 2017 12:35:03 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=junrao&quot; class=&quot;user-hover&quot; rel=&quot;junrao&quot;&gt;junrao&lt;/a&gt;, what do you think we should do in this case? Option 1 doesn&apos;t seem right. Option 2 could work although it&apos;s a bit wasteful. An additional option:&lt;/p&gt;

&lt;p&gt;3. Return an error for that partition (`NOT_FOLLOWER` would be appropriate, but we don&apos;t have that, so we we&apos;d have to reuse an existing error)&lt;/p&gt;</comment>
                            <comment id="16136933" author="dwvangeest" created="Tue, 22 Aug 2017 15:24:17 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ijuma&quot; class=&quot;user-hover&quot; rel=&quot;ijuma&quot;&gt;ijuma&lt;/a&gt;, thanks for the response!&lt;/p&gt;

&lt;p&gt;I&apos;m not sure I understand the distinction between my option 1 and your option 3. In both, we&apos;re talking about returning partial results (along with an error of sorts for the partition that is no longer being followed) in the response to `FetchRequest` right? &lt;/p&gt;</comment>
                            <comment id="16136959" author="ijuma" created="Tue, 22 Aug 2017 15:42:35 +0000"  >&lt;p&gt;Option 3 is a normal pattern for the Kafka protocol (since APIs often involve batches) and we don&apos;t consider it a partial result. If that&apos;s what you meant when you described option 1, then great.&lt;/p&gt;</comment>
                            <comment id="16136974" author="dwvangeest" created="Tue, 22 Aug 2017 15:50:30 +0000"  >&lt;p&gt;Ah OK. So Option 3 still returns data for the other partitions then? If so, that&apos;s what I meant.&lt;/p&gt;</comment>
                            <comment id="16136980" author="ijuma" created="Tue, 22 Aug 2017 15:53:43 +0000"  >&lt;p&gt;Yes.&lt;/p&gt;</comment>
                            <comment id="16136984" author="dwvangeest" created="Tue, 22 Aug 2017 15:56:26 +0000"  >&lt;p&gt;Awesome, Option 3 makes sense to me. Sorry for not communicating my ideas very clearly there.&lt;/p&gt;</comment>
                            <comment id="16178119" author="ijuma" created="Sun, 24 Sep 2017 08:10:27 +0000"  >&lt;p&gt;Since this is a bug, I&apos;m reassigning to 1.0.0. Let&apos;s see if we can get it in by the code freeze.&lt;/p&gt;</comment>
                            <comment id="16178672" author="githubbot" created="Mon, 25 Sep 2017 07:34:21 +0000"  >&lt;p&gt;GitHub user ijuma opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/3954&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3954&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5758&quot; title=&quot;Reassigning a topic&amp;#39;s partitions can adversely impact other topics&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-5758&quot;&gt;&lt;del&gt;KAFKA-5758&lt;/del&gt;&lt;/a&gt;: Don&apos;t fail fetch request if replica is no longer a follower for a partition&lt;/p&gt;

&lt;p&gt;    We log a warning instead, which is what we also do if the partition hasn&apos;t been created&lt;br/&gt;
    yet.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/ijuma/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/ijuma/kafka&lt;/a&gt; kafka-5758-dont-fail-fetch-request-if-replica-is-not-follower&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/3954.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3954.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #3954&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 7e12d408619b41a37cc40f4c294d47875df312ce&lt;br/&gt;
Author: Ismael Juma &amp;lt;ismael@juma.me.uk&amp;gt;&lt;br/&gt;
Date:   2017-09-25T07:33:46Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5758&quot; title=&quot;Reassigning a topic&amp;#39;s partitions can adversely impact other topics&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-5758&quot;&gt;&lt;del&gt;KAFKA-5758&lt;/del&gt;&lt;/a&gt;: Don&apos;t fail fetch request if replica is no longer a follower for a partition&lt;/p&gt;

&lt;p&gt;    We log a warning instead, which is what we also do if the partition hasn&apos;t been created&lt;br/&gt;
    yet.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16179313" author="dwvangeest" created="Mon, 25 Sep 2017 16:55:20 +0000"  >&lt;p&gt;Cool, glad to see some progress on this!&lt;/p&gt;</comment>
                            <comment id="16186792" author="junrao" created="Sat, 30 Sep 2017 01:38:02 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dwvangeest&quot; class=&quot;user-hover&quot; rel=&quot;dwvangeest&quot;&gt;dwvangeest&lt;/a&gt;, the problem you described could happen transiently when the controller changes the assigned replica list since the leader may receive the changed list before the follower. However, this shouldn&apos;t last long. Did you see NotAssignedReplicaException continuously?&lt;/p&gt;</comment>
                            <comment id="16186868" author="dwvangeest" created="Sat, 30 Sep 2017 04:01:57 +0000"  >&lt;p&gt;I checked the logs again and we saw `NotAssignedReplicaException` 11 times over 5 minutes - essentially the duration of the partition re-assigment. This coincided with under-replication of other partitions... leading to the theory above. &lt;/p&gt;

&lt;p&gt;I agree that it&apos;s normal for these errors to occur transiently, and it seems like failing only the involved partition in a FetchRequest should mitigate the impact.&lt;/p&gt;</comment>
                            <comment id="16188465" author="junrao" created="Mon, 2 Oct 2017 17:30:51 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dwvangeest&quot; class=&quot;user-hover&quot; rel=&quot;dwvangeest&quot;&gt;dwvangeest&lt;/a&gt;, thanks for the info. I agree that it&apos;s better to handle the NotAssignedReplicaException explicitly. However, I am not sure if that&apos;s the root cause for replicas out of sync though since the exception is transient. How long were the replicas out of sync?&lt;/p&gt;</comment>
                            <comment id="16188888" author="githubbot" created="Mon, 2 Oct 2017 21:38:02 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/3954&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3954&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16190025" author="dwvangeest" created="Tue, 3 Oct 2017 17:36:03 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=junrao&quot; class=&quot;user-hover&quot; rel=&quot;junrao&quot;&gt;junrao&lt;/a&gt; yeah, I&apos;m not 100% sure either that it&apos;s the root cause - it just seemed the most obvious place to start. &lt;/p&gt;

&lt;p&gt;It&apos;s a little bit hard to tell how long the (supposedly unaffected) topics were under-replicated. Our replication graphs don&apos;t differentiate between topics, and the topics undergoing re-assignment did take a while to fullly re-replicate. If I had to guess, I would say somewhere between 3 - 5 minutes of under-replication for the non-reassigned topics. This 3 - 5 minute period started at the same time as the first `NotAssignedReplicaException`s. Does that help?&lt;/p&gt;</comment>
                            <comment id="16190609" author="junrao" created="Wed, 4 Oct 2017 00:57:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dwvangeest&quot; class=&quot;user-hover&quot; rel=&quot;dwvangeest&quot;&gt;dwvangeest&lt;/a&gt;, thanks for the info.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12996163">KAFKA-4027</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13142730">KAFKA-6613</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 6 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3j3nr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>