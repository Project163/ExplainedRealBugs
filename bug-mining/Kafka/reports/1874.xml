<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:08:55 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-6747] kafka-streams Invalid transition attempted from state READY to state ABORTING_TRANSACTION</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-6747</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=frederica&quot; class=&quot;user-hover&quot; rel=&quot;frederica&quot;&gt;frederica&lt;/a&gt; running tests against kafka-streams 1.1 and get the following stack trace (everything was working alright using kafka-streams 1.0):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ERROR org.apache.kafka.streams.processor.internals.AssignedStreamsTasks - stream-thread [feedBuilder-XXX-StreamThread-4] Failed to close stream task, 0_2
org.apache.kafka.common.KafkaException: TransactionalId feedBuilder-0_2: Invalid transition attempted from state READY to state ABORTING_TRANSACTION
        at org.apache.kafka.clients.producer.internals.TransactionManager.transitionTo(TransactionManager.java:757)
        at org.apache.kafka.clients.producer.internals.TransactionManager.transitionTo(TransactionManager.java:751)
        at org.apache.kafka.clients.producer.internals.TransactionManager.beginAbort(TransactionManager.java:230)
        at org.apache.kafka.clients.producer.KafkaProducer.abortTransaction(KafkaProducer.java:660)
        at org.apache.kafka.streams.processor.internals.StreamTask.closeSuspended(StreamTask.java:486)
        at org.apache.kafka.streams.processor.internals.StreamTask.close(StreamTask.java:546)
        at org.apache.kafka.streams.processor.internals.AssignedTasks.closeNonRunningTasks(AssignedTasks.java:166)
        at org.apache.kafka.streams.processor.internals.AssignedTasks.suspend(AssignedTasks.java:151)
        at org.apache.kafka.streams.processor.internals.TaskManager.suspendTasksAndState(TaskManager.java:242)
        at org.apache.kafka.streams.processor.internals.StreamThread$RebalanceListener.onPartitionsRevoked(StreamThread.java:291)
        at org.apache.kafka.clients.consumer.internals.ConsumerCoordinator.onJoinPrepare(ConsumerCoordinator.java:414)
        at org.apache.kafka.clients.consumer.internals.AbstractCoordinator.joinGroupIfNeeded(AbstractCoordinator.java:359)
        at org.apache.kafka.clients.consumer.internals.AbstractCoordinator.ensureActiveGroup(AbstractCoordinator.java:316)
        at org.apache.kafka.clients.consumer.internals.ConsumerCoordinator.poll(ConsumerCoordinator.java:290)
        at org.apache.kafka.clients.consumer.KafkaConsumer.pollOnce(KafkaConsumer.java:1149)
        at org.apache.kafka.clients.consumer.KafkaConsumer.poll(KafkaConsumer.java:1115)
        at org.apache.kafka.streams.processor.internals.StreamThread.pollRequests(StreamThread.java:827)
        at org.apache.kafka.streams.processor.internals.StreamThread.runOnce(StreamThread.java:784)
        at org.apache.kafka.streams.processor.internals.StreamThread.runLoop(StreamThread.java:750)
        at org.apache.kafka.streams.processor.internals.StreamThread.run(StreamThread.java:720)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This happens when starting the same stream-processing application on 3 JVMs all running on the same linux box, JVMs are named JVM-&lt;span class=&quot;error&quot;&gt;&amp;#91;2-4&amp;#93;&lt;/span&gt;. All 3 instances use separate stream state.dir. No record is ever processed because the input kafka topics are empty at this stage.&lt;/p&gt;

&lt;p&gt;JVM-2 starts first, joined shortly after by JVM-4 and JVM-3, find the state transition logs below. The above stacktrace is from JVM-4&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[JVM-2] stream-client [feedBuilder-XXX] State transition from RUNNING to REBALANCING
[JVM-2] stream-client [feedBuilder-XXX] State transition from REBALANCING to RUNNING
[JVM-4] stream-client [feedBuilder-XXX] State transition from RUNNING to REBALANCING
[JVM-2] stream-client [feedBuilder-XXX] State transition from RUNNING to REBALANCING
[JVM-2] stream-client [feedBuilder-XXX] State transition from REBALANCING to RUNNING
[JVM-3] stream-client [feedBuilder-XXX] State transition from RUNNING to REBALANCING
[JVM-2] stream-client [feedBuilder-XXX] State transition from RUNNING to REBALANCING
JVM-4 crashes here with above stacktrace
[JVM-2] stream-client [feedBuilder-XXX] State transition from REBALANCING to RUNNING
[JVM-4] stream-client [feedBuilder-XXX] State transition from REBALANCING to ERROR
[JVM-4] stream-client [feedBuilder-XXX] State transition from ERROR to PENDING_SHUTDOWN
[JVM-4] stream-client [feedBuilder-XXX] State transition from PENDING_SHUTDOWN to NOT_RUNNING
[JVM-4] stream-client [feedBuilder-XXX] State transition from RUNNING to REBALANCING
[JVM-3] stream-client [feedBuilder-XXX] State transition from REBALANCING to RUNNING
[JVM-2] stream-client [feedBuilder-XXX] State transition from RUNNING to REBALANCING
[JVM-3] stream-client [feedBuilder-XXX] State transition from RUNNING to REBALANCING
[JVM-2] stream-client [feedBuilder-XXX] State transition from REBALANCING to RUNNING
[JVM-3] stream-client [feedBuilder-XXX] State transition from REBALANCING to RUNNING
[JVM-4] stream-client [feedBuilder-XXX] State transition from REBALANCING to RUNNING
[JVM-2] stream-client [feedBuilder-XXX] State transition from RUNNING to PENDING_SHUTDOWN
[JVM-3] stream-client [feedBuilder-XXX] State transition from RUNNING to REBALANCING
[JVM-4] stream-client [feedBuilder-XXX] State transition from RUNNING to REBALANCING
[JVM-2] stream-client [feedBuilder-XXX] State transition from PENDING_SHUTDOWN to NOT_RUNNING
[JVM-4] stream-client [feedBuilder-XXX] State transition from REBALANCING to RUNNING
[JVM-3] stream-client [feedBuilder-XXX] State transition from REBALANCING to RUNNING
[JVM-3] stream-client [feedBuilder-XXX] State transition from RUNNING to PENDING_SHUTDOWN
[JVM-4] stream-client [feedBuilder-XXX] State transition from RUNNING to PENDING_SHUTDOWN
[JVM-3] stream-client [feedBuilder-XXX] State transition from PENDING_SHUTDOWN to NOT_RUNNING
[JVM-4] stream-client [feedBuilder-XXX] State transition from PENDING_SHUTDOWN to NOT_RUNNING
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13150202">KAFKA-6747</key>
            <summary>kafka-streams Invalid transition attempted from state READY to state ABORTING_TRANSACTION</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tedyu">Zhihong Yu</assignee>
                                    <reporter username="frederica">Frederic Arno</reporter>
                        <labels>
                    </labels>
                <created>Thu, 5 Apr 2018 02:29:16 +0000</created>
                <updated>Sun, 10 Nov 2019 07:59:19 +0000</updated>
                            <resolved>Thu, 5 Apr 2018 23:52:20 +0000</resolved>
                                    <version>1.1.0</version>
                                    <fixVersion>0.11.0.3</fixVersion>
                    <fixVersion>1.0.2</fixVersion>
                    <fixVersion>1.1.1</fixVersion>
                    <fixVersion>2.0.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="16426418" author="yuzhihong@gmail.com" created="Thu, 5 Apr 2018 02:33:34 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/apache/kafka/pull/4826&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/4826&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16427354" author="guozhang" created="Thu, 5 Apr 2018 17:56:42 +0000"  >&lt;p&gt;Thanks for the quick catch &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tedyu&quot; class=&quot;user-hover&quot; rel=&quot;tedyu&quot;&gt;tedyu&lt;/a&gt;!&lt;/p&gt;</comment>
                            <comment id="16427690" author="githubbot" created="Thu, 5 Apr 2018 22:29:07 +0000"  >&lt;p&gt;guozhangwang closed pull request #4826: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6747&quot; title=&quot;kafka-streams Invalid transition attempted from state READY to state ABORTING_TRANSACTION&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-6747&quot;&gt;&lt;del&gt;KAFKA-6747&lt;/del&gt;&lt;/a&gt; Check whether there is in-flight transaction before aborting transaction&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/4826&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/4826&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamTask.java b/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamTask.java&lt;br/&gt;
index 8d6e56a17aa..4b2e1b8cfb7 100644&lt;br/&gt;
&amp;#8212; a/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamTask.java&lt;br/&gt;
+++ b/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamTask.java&lt;br/&gt;
@@ -358,8 +358,8 @@ private void commitOffsets(final boolean startNewTransaction) {&lt;br/&gt;
                     producer.commitTransaction();&lt;br/&gt;
                     transactionInFlight = false;&lt;br/&gt;
                     if (startNewTransaction) &lt;/p&gt;
{
-                        transactionInFlight = true;
                         producer.beginTransaction();
+                        transactionInFlight = true;
                     }
&lt;p&gt;                 } else {&lt;br/&gt;
                     consumer.commitSync(consumedOffsetsAndMetadata);&lt;br/&gt;
@@ -482,7 +482,7 @@ public void closeSuspended(boolean clean,&lt;br/&gt;
             if (eosEnabled) {&lt;br/&gt;
                 if (!clean) {&lt;br/&gt;
                     try {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (!isZombie) {&lt;br/&gt;
+                        if (!isZombie &amp;amp;&amp;amp; transactionInFlight) 
{
                             producer.abortTransaction();
                         }
&lt;p&gt;                         transactionInFlight = false;&lt;br/&gt;
diff --git a/streams/src/test/java/org/apache/kafka/streams/processor/internals/StreamTaskTest.java b/streams/src/test/java/org/apache/kafka/streams/processor/internals/StreamTaskTest.java&lt;br/&gt;
index a30582905de..d6a5276a43d 100644&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/streams/src/test/java/org/apache/kafka/streams/processor/internals/StreamTaskTest.java&lt;br/&gt;
+++ b/streams/src/test/java/org/apache/kafka/streams/processor/internals/StreamTaskTest.java&lt;br/&gt;
@@ -782,6 +782,14 @@ public void shouldInitAndBeginTransactionOnCreateIfEosEnabled() 
{
         assertTrue(producer.transactionInFlight());
     }&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;+    @Test&lt;br/&gt;
+    public void shouldNotThrowOnCloseIfTaskWasNotInitializedWithEosEnabled() &lt;/p&gt;
{
+        task = createStatelessTask(true);
+
+        assertTrue(!producer.transactionInFlight());
+        task.close(false, false);
+    }
&lt;p&gt;+&lt;br/&gt;
     @Test&lt;br/&gt;
     public void shouldNotInitOrBeginTransactionOnCreateIfEosDisabled() {&lt;br/&gt;
         task = createStatelessTask(false);&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16969814" author="liwey" created="Fri, 8 Nov 2019 03:52:43 +0000"  >&lt;p&gt;What is the valid transition? I got&#160;Invalid transition attempted from state COMMITTING_TRANSACTION to state ABORTING_TRANSACTION, when the brokers are down. The code flow is to abort when commit throws exception.&lt;/p&gt;</comment>
                            <comment id="16971041" author="mjsax" created="Sun, 10 Nov 2019 07:59:19 +0000"  >&lt;p&gt;What exception did you get on commit? Some exceptions are fatal and you should not call anything on the producer any longer but just `close()` it.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 1 week, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3s63z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>