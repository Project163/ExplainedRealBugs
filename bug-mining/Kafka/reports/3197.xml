<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:30:01 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-13418] Brokers disconnect intermittently with TLS1.3</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-13418</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Using TLS1.3 (with JDK11) is causing a regression and an increase in inter-broker p99 latency, as mentioned by Yiming in &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-9320?focusedCommentId=17401818&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-17401818&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;Kafka-9320&lt;/a&gt;. We tested this with Kafka 2.8.&lt;br/&gt;
The issue seems to be because of a renegotiation exception being thrown by &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
read(ByteBuffer dst)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; &amp;amp; &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
write(ByteBuffer src)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; in &lt;br/&gt;
&lt;em&gt;clients/src/main/java/org/apache/kafka/common/network/SslTransportLayer.java&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;This exception is causing the connection to close between the brokers before read/write is completed. In our internal experiments we have seen the p99 latency stabilize when we remove this exception.&lt;/p&gt;

&lt;p&gt;Given that TLS1.3 does not support renegotiation, I would like to make it applicable just for TLS1.2.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13409007">KAFKA-13418</key>
            <summary>Brokers disconnect intermittently with TLS1.3</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="skokoori">shylaja kokoori</assignee>
                                    <reporter username="skokoori">shylaja kokoori</reporter>
                        <labels>
                    </labels>
                <created>Fri, 29 Oct 2021 00:17:47 +0000</created>
                <updated>Thu, 31 Mar 2022 16:57:43 +0000</updated>
                            <resolved>Tue, 29 Mar 2022 22:08:48 +0000</resolved>
                                    <version>2.8.0</version>
                                    <fixVersion>3.0.2</fixVersion>
                    <fixVersion>3.1.1</fixVersion>
                    <fixVersion>3.2.0</fixVersion>
                                    <component>clients</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17464190" author="shylaja.kokoori@intel.com" created="Thu, 23 Dec 2021 00:30:39 +0000"  >&lt;p&gt;After enabling SSL logging (javax.net.debug=ssl,handshake),&lt;br/&gt;
I see that unwrap call in the SslTransportLayer.read function returns handshakeStatus=NEED_WRAP when ssl key_update takes place. (log snippet below)&lt;/p&gt;

&lt;p&gt;Based on documentation provided in &lt;a href=&quot;https://datatracker.ietf.org/doc/html/rfc8446&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://datatracker.ietf.org/doc/html/rfc8446&lt;/a&gt;&lt;br/&gt;
key_updates normally happen during a read/write and connection has to be closed when it happens during handshake.&#160;&lt;br/&gt;
Given that here key_updates are happening after handshaking is done, will something like attached patch work? I am new to Kafka and any feedback would be helpful.&lt;/p&gt;

&lt;p&gt;Kafka log:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
javax.net.ssl|DEBUG|8D|ReplicaFetcherThread-0-2|2021-12-21 06:14:09.574 UTC|KeyUpdate.java:192|Consuming KeyUpdate post-handshake message (
&lt;span class=&quot;code-quote&quot;&gt;&quot;KeyUpdate&quot;&lt;/span&gt;: {
&#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;request_update&quot;&lt;/span&gt;: update_requested
}
)
javax.net.ssl|DEBUG|8D|ReplicaFetcherThread-0-2|2021-12-21 06:14:09.575 UTC|SSLCipher.java:1866|KeyLimit read side: algorithm = AES/GCM/NOPADDING:KEYUPDATE
countdown value = 137438953472
javax.net.ssl|DEBUG|8D|ReplicaFetcherThread-0-2|2021-12-21 06:14:09.575 UTC|KeyUpdate.java:236|KeyUpdate: read key updated
javax.net.ssl|DEBUG|8D|ReplicaFetcherThread-0-2|2021-12-21 06:14:09.575 UTC|KeyUpdate.java:271|Produced KeyUpdate post-handshake message (
&lt;span class=&quot;code-quote&quot;&gt;&quot;KeyUpdate&quot;&lt;/span&gt;: {
&#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;request_update&quot;&lt;/span&gt;: update_not_requested
}
)
javax.net.ssl|DEBUG|8D|ReplicaFetcherThread-0-2|2021-12-21 06:14:09.575 UTC|SSLCipher.java:2020|KeyLimit write side: algorithm = AES/GCM/NOPADDING:KEYUPDATE
countdown value = 137438953472
javax.net.ssl|DEBUG|8D|ReplicaFetcherThread-0-2|2021-12-21 06:14:09.575 UTC|KeyUpdate.java:323|KeyUpdate: write key updated
[2021-12-21 06:14:09,575] ERROR [SslTransportLayer channelId=2 key=channel=java.nio.channels.SocketChannel[connection-pending remote=/192.168.24.11:9093], selector=sun.nio.ch.EPollSelectorImpl@2eb1a872, interestOps=8, readyOps=0] Renegotiation requested, but it is not supported, channelId 2, appReadBuffer pos 0, netReadBuffer pos 0, netWriteBuffer pos 147 handshakeStatus NEED_WRAP State READY (org.apache.kafka.common.network.SslTransportLayer)
javax.net.ssl|DEBUG|8D|ReplicaFetcherThread-0-2|2021-12-21 06:14:09.578 UTC|Alert.java:238|Received alert message (
&lt;span class=&quot;code-quote&quot;&gt;&quot;Alert&quot;&lt;/span&gt;: {
&#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;level&quot;&lt;/span&gt; &#160; &#160; &#160;: &lt;span class=&quot;code-quote&quot;&gt;&quot;warning&quot;&lt;/span&gt;,
&#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;description&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;close_notify&quot;&lt;/span&gt;
}
)
javax.net.ssl|ALL|8D|ReplicaFetcherThread-0-2|2021-12-21 06:14:09.580 UTC|SSLEngineImpl.java:752|Closing outbound of SSLEngine&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17491548" author="ijuma" created="Sun, 13 Feb 2022 10:14:55 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=skokoori&quot; class=&quot;user-hover&quot; rel=&quot;skokoori&quot;&gt;skokoori&lt;/a&gt; Thanks for the report. Can you please submit a pull request? See &lt;a href=&quot;https://kafka.apache.org/contributing&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://kafka.apache.org/contributing&lt;/a&gt; .&lt;/p&gt;</comment>
                            <comment id="17491996" author="ijuma" created="Mon, 14 Feb 2022 13:41:24 +0000"  >&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rajinisivaram%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;rajinisivaram@gmail.com&quot;&gt;rajinisivaram@gmail.com&lt;/a&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17494824" author="shylaja.kokoori@intel.com" created="Fri, 18 Feb 2022 21:55:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ijuma&quot; class=&quot;user-hover&quot; rel=&quot;ijuma&quot;&gt;ijuma&lt;/a&gt; Thank you. Let me test with the latest trunk and will submit a pull request&lt;/p&gt;</comment>
                            <comment id="17499167" author="yzang" created="Mon, 28 Feb 2022 19:52:13 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=skokoori&quot; class=&quot;user-hover&quot; rel=&quot;skokoori&quot;&gt;skokoori&lt;/a&gt; for creating this issue, and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ijuma&quot; class=&quot;user-hover&quot; rel=&quot;ijuma&quot;&gt;ijuma&lt;/a&gt; for reviewing the pull request. This will solve the TLS issue Twitter has been seeing since upgrading to 2.7 with TLS 1.3&lt;/p&gt;</comment>
                            <comment id="17505290" author="ijuma" created="Sat, 12 Mar 2022 15:14:17 +0000"  >&lt;p&gt;Looks like the property that controls when the key update happens is a security property with a default of 2^37.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;There are cryptographic limits some algorithms have on the amount of plaintext which can be safely encrypted under a given set of keys. A new Security Property, &quot;jdk.tls.keyLimits&quot; has been added for TLS 1.3. When the amount of encrypted data by the algorithm has been reached a post-handshake Key and IV Update is triggered to derive new keys. This value is configurable so administrators can control their own security policies.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://bugs.openjdk.java.net/browse/JDK-8234226&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://bugs.openjdk.java.net/browse/JDK-8234226&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17514363" author="shylaja.kokoori@intel.com" created="Tue, 29 Mar 2022 23:13:49 +0000"  >&lt;p&gt;Thank you for addressing this &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ijuma&quot; class=&quot;user-hover&quot; rel=&quot;ijuma&quot;&gt;ijuma&lt;/a&gt;. I was running into an issue with one of the unit tests. Looks like you addressed it&lt;/p&gt;</comment>
                            <comment id="17514365" author="ijuma" created="Tue, 29 Mar 2022 23:22:18 +0000"  >&lt;p&gt;Thanks for your contribution &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=skokoori&quot; class=&quot;user-hover&quot; rel=&quot;skokoori&quot;&gt;skokoori&lt;/a&gt; ! Tricky bug this one. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="17515438" author="yzang" created="Thu, 31 Mar 2022 16:57:43 +0000"  >&lt;p&gt;Thanks a lot! &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ijuma&quot; class=&quot;user-hover&quot; rel=&quot;ijuma&quot;&gt;ijuma&lt;/a&gt; &#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=skokoori&quot; class=&quot;user-hover&quot; rel=&quot;skokoori&quot;&gt;skokoori&lt;/a&gt;&#160;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13037856" name="tls1_3.patch" size="1845" author="skokoori" created="Thu, 23 Dec 2021 00:29:20 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 32 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0w9jc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>ijuma</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>