<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:33:33 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-15391] Delete topic may lead to directory offline</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-15391</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;This is an edge case where the entire log directory is marked offline when we delete a topic. This symptoms of this scenario is characterised by the following logs:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[2023-08-14 09:22:12,600] ERROR Uncaught exception in scheduled task &apos;flush-log&apos; (org.apache.kafka.server.util.KafkaScheduler:152)  org.apache.kafka.common.errors.KafkaStorageException: Error while flushing log for test-0 in dir /tmp/kafka-15093588566723278510 with offset 221 (exclusive) and recovery point 221 Caused by: java.nio.file.NoSuchFileException: /tmp/kafka-15093588566723278510/test-0&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The above log is followed by logs such as:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[2023-08-14 09:22:12,601] ERROR Uncaught exception in scheduled task &apos;flush-log&apos; (org.apache.kafka.server.util.KafkaScheduler:152)org.apache.kafka.common.errors.KafkaStorageException: The log dir /tmp/kafka-15093588566723278510 is already offline due to a previous IO exception.&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The below sequence of events demonstrate the scenario where this bug manifests&lt;br/&gt;
1. &#160;On the broker, partition lock is acquired and UnifiedLog.roll() is called which schedules an async call for&#160;&lt;br/&gt;
flushUptoOffsetExclusive(). The roll may be called due to segment rotation time or size.&lt;br/&gt;
2. Admin client calls deleteTopic&lt;br/&gt;
3. On the broker, LogManager.asyncDelete() is called which will call UnifiedLog.renameDir()&lt;br/&gt;
4. The directory for the partition is successfully renamed with a &quot;delete&quot; suffix.&lt;br/&gt;
5. The async task scheduled in step 1 (flushUptoOffsetExclusive) starts executing. It tries to call localLog.flush() without acquiring a partition lock.&#160;&lt;br/&gt;
6. LocalLog calls Utils.flushDir() which fails with an IOException.&lt;br/&gt;
7. On IOException, log directory is added to logDirFailureChannel&lt;br/&gt;
8. Any new interaction with this logDir fails and a log line is printed such as&#160;&lt;br/&gt;
&quot;The log dir $logDir is already offline due to a previous IO exception&quot;&lt;br/&gt;
&#160;&lt;/p&gt;

&lt;p&gt;This is the reason DeleteTopicTest is flaky as well - &lt;a href=&quot;https://ge.apache.org/scans/tests?search.relativeStartTime=P28D&amp;amp;search.rootProjectNames=kafka&amp;amp;search.tags=trunk&amp;amp;search.timeZoneId=Europe/Berlin&amp;amp;tests.container=kafka.admin.DeleteTopicTest&amp;amp;tests.test=testDeleteTopicWithCleaner(&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ge.apache.org/scans/tests?search.relativeStartTime=P28D&amp;amp;search.rootProjectNames=kafka&amp;amp;search.tags=trunk&amp;amp;search.timeZoneId=Europe/Berlin&amp;amp;tests.container=kafka.admin.DeleteTopicTest&amp;amp;tests.test=testDeleteTopicWithCleaner(&lt;/a&gt;)&lt;/p&gt;</description>
                <environment></environment>
        <key id="13548188">KAFKA-15391</key>
            <summary>Delete topic may lead to directory offline</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ocadaruma">Haruki Okada</assignee>
                                    <reporter username="divijvaidya">Divij Vaidya</reporter>
                        <labels>
                    </labels>
                <created>Tue, 22 Aug 2023 11:18:55 +0000</created>
                <updated>Thu, 7 Aug 2025 09:29:57 +0000</updated>
                            <resolved>Thu, 24 Aug 2023 08:55:47 +0000</resolved>
                                                    <fixVersion>3.5.2</fixVersion>
                    <fixVersion>3.6.0</fixVersion>
                                    <component>core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17757388" author="ocadaruma" created="Tue, 22 Aug 2023 11:28:16 +0000"  >&lt;p&gt;-Related? &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-13403-&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-13403-&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Hmm, similar but seems different&lt;/p&gt;</comment>
                            <comment id="17757413" author="divijvaidya" created="Tue, 22 Aug 2023 12:40:40 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ocadaruma&quot; class=&quot;user-hover&quot; rel=&quot;ocadaruma&quot;&gt;ocadaruma&lt;/a&gt; It is a bit different from the perspective that the race condition is not with retention threads but instead between two async segment roll and request handler thread, but the fix is same. We shouldn&apos;t be erroring out if the file that we want to delete doesn&apos;t exist.&lt;/p&gt;</comment>
                            <comment id="17757442" author="ocadaruma" created="Tue, 22 Aug 2023 13:00:01 +0000"  >&lt;p&gt;I see, understood. Thanks&lt;/p&gt;</comment>
                            <comment id="17757792" author="ocadaruma" created="Wed, 23 Aug 2023 03:41:25 +0000"  >&lt;p&gt;May I take this ticket?&lt;/p&gt;

&lt;p&gt;I&apos;m interested since this issue may also happen on our cluster (3.3.2) so I&apos;m happy to solve that. I can submit a patch today&lt;/p&gt;</comment>
                            <comment id="17757874" author="divijvaidya" created="Wed, 23 Aug 2023 08:17:12 +0000"  >&lt;p&gt;Yes please &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ocadaruma&quot; class=&quot;user-hover&quot; rel=&quot;ocadaruma&quot;&gt;ocadaruma&lt;/a&gt; go ahead. Please note that there might be side-effects to changing Utils.delete i.e. what if there is another code which is relying on Utils.delete to throw a file not found exception. When making a change, please ensure that there is no such code. If there is we can probably add a new Utils.deleteIfExists function and use the new function at the places where we encounter this bug.&lt;/p&gt;</comment>
                            <comment id="17758026" author="ocadaruma" created="Wed, 23 Aug 2023 13:27:07 +0000"  >&lt;p&gt;For this issue, we may need to swallow NoSuchFileException in Utils.flushDir but yeah I&apos;ll check the usage and add another method instead of changing existing one if necessary&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310660">
                    <name>Completes</name>
                                            <outwardlinks description="fixes">
                                        <issuelink>
            <issuekey id="13553547">KAFKA-15572</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13625276">KAFKA-19571</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13441623">KAFKA-13855</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13408328">KAFKA-13403</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 11 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1jxkw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>divijvaidya</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>