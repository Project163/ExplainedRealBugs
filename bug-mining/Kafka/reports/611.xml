<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:42:33 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-1952] High CPU Usage in 0.8.2 release</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-1952</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Brokers with high partition count see increased CPU usage when migrating from 0.8.1.1 to 0.8.2.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12775065">KAFKA-1952</key>
            <summary>High CPU Usage in 0.8.2 release</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="junrao">Jun Rao</assignee>
                                    <reporter username="jkreps">Jay Kreps</reporter>
                        <labels>
                    </labels>
                <created>Fri, 13 Feb 2015 23:25:09 +0000</created>
                <updated>Fri, 20 Feb 2015 00:44:10 +0000</updated>
                            <resolved>Wed, 18 Feb 2015 21:40:23 +0000</resolved>
                                    <version>0.8.2.0</version>
                                    <fixVersion>0.8.2.1</fixVersion>
                                        <due></due>
                            <votes>1</votes>
                                    <watches>15</watches>
                                                                                                                <comments>
                            <comment id="14321130" author="junrao" created="Sat, 14 Feb 2015 01:52:14 +0000"  >&lt;p&gt;Created reviewboard &lt;a href=&quot;https://reviews.apache.org/r/31040/diff/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/31040/diff/&lt;/a&gt;&lt;br/&gt;
 against branch origin/0.8.2&lt;/p&gt;</comment>
                            <comment id="14321131" author="junrao" created="Sat, 14 Feb 2015 01:52:22 +0000"  >&lt;p&gt;The issue is that after purgatory refactoring, we make a checkSatisfied() call on every key in the request. However, each checkSatisfied() goes through every partition in the request. So, if you have 3K partitions in the request (like the replica fetcher), we will be making 9 million calls to methods like getPartition(). That&apos;s what&apos;s burning the CPU. This issue seems to only happen in a cluster when there is no data being produced.&lt;/p&gt;

&lt;p&gt;Attach a patch that addresses the issue.&lt;/p&gt;</comment>
                            <comment id="14322244" author="junrao" created="Sun, 15 Feb 2015 23:26:39 +0000"  >&lt;p&gt;Updated reviewboard &lt;a href=&quot;https://reviews.apache.org/r/31040/diff/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/31040/diff/&lt;/a&gt;&lt;br/&gt;
 against branch origin/0.8.2&lt;/p&gt;</comment>
                            <comment id="14322246" author="junrao" created="Sun, 15 Feb 2015 23:30:11 +0000"  >&lt;p&gt;Uploaded a new patch that addresses the review comments.&lt;/p&gt;

&lt;p&gt;Some test results.&lt;/p&gt;

&lt;p&gt;Create a 2 node cluster locally. Create a topic X with 3000 partitions and a replication factor of 2 (wait until all leaders are elected; this can take 5 minutes). Without the patch, when there is no produce load on the cluster, each broker uses 100% CPU and the localTime for each replica fetch request is about 1 sec. With the patch, each broker uses about 10% CPU and the localTime for each replica fetch request is about 9ms. &lt;/p&gt;

&lt;p&gt;Also tested the end to end latency with the patch. On the above 2 node cluster, create a topic test with 1 partition and a replication factor of 2. &lt;/p&gt;

&lt;p&gt;bin/kafka-run-class.sh kafka.tools.TestEndToEndLatency localhost:9092 localhost:2181 test 5000 500 -1&lt;br/&gt;
0	61.206&lt;br/&gt;
1000	26.766&lt;br/&gt;
2000	38.58&lt;br/&gt;
3000	25.647&lt;br/&gt;
4000	26.991&lt;br/&gt;
Avg latency: 28.5952 ms&lt;br/&gt;
Percentiles: 50th = 27, 99th = 41, 99.9th = 52&lt;/p&gt;

&lt;p&gt;The latency is bounded by the message commit time. With 3000 partitions, each replica fetch request take 9ms in localTime and another 9ms in sendTime. So the time to complete a produce  request (with ack=-1) is about 26ms on average. In any case, the end to end latency is way less than the maxWaitTime in the regular consumer and replica fetcher (both at 500ms), which is expected.&lt;/p&gt;

&lt;p&gt;Also measured the localTime and sendTime for the same replica fetch requests on 0.8.1.1. The numbers are comparable with 0.8.2.0 with the patch.&lt;/p&gt;</comment>
                            <comment id="14325435" author="junrao" created="Wed, 18 Feb 2015 05:30:14 +0000"  >&lt;p&gt;Created reviewboard &lt;a href=&quot;https://reviews.apache.org/r/31150/diff/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/31150/diff/&lt;/a&gt;&lt;br/&gt;
 against branch origin/trunk&lt;/p&gt;</comment>
                            <comment id="14325439" author="junrao" created="Wed, 18 Feb 2015 05:31:44 +0000"  >&lt;p&gt;Attach a patch for trunk. The CPU load and the end to end latency with the patch is comparable to those in 0.8.2.&lt;/p&gt;</comment>
                            <comment id="14326598" author="junrao" created="Wed, 18 Feb 2015 21:40:23 +0000"  >&lt;p&gt;Thanks for the review. Committed to 0.8.2.1 and trunk.&lt;/p&gt;</comment>
                            <comment id="14328306" author="panih2o" created="Thu, 19 Feb 2015 23:25:09 +0000"  >&lt;p&gt;Hi Jun,&lt;/p&gt;

&lt;p&gt;Can this patch be applied against kafka 8.2 source? I am not sure since kafka 8.2 source doesn&apos;t have any file matching this path i.e &apos;/core/src/main/scala/kafka/server/DelayedOperation.scala&apos;&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
Puneet Mehta&lt;/p&gt;</comment>
                            <comment id="14328371" author="junrao" created="Fri, 20 Feb 2015 00:29:06 +0000"  >&lt;p&gt;There is a separate patch for 0.8.2 and is always committed to the 0.8.2 branch.&lt;/p&gt;</comment>
                            <comment id="14328383" author="panih2o" created="Fri, 20 Feb 2015 00:44:10 +0000"  >&lt;p&gt;Thanks for the clarification, I kind of figured it out from the kafka git repo. &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12699423" name="kafka-1952.patch" size="2913" author="junrao" created="Wed, 18 Feb 2015 05:30:14 +0000"/>
                            <attachment id="12698871" name="kafka-1952.patch" size="4175" author="junrao" created="Sat, 14 Feb 2015 01:52:14 +0000"/>
                            <attachment id="12699014" name="kafka-1952_2015-02-15_15:26:33.patch" size="6320" author="junrao" created="Sun, 15 Feb 2015 23:26:38 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 39 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i25mmf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>