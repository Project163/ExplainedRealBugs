<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:38:52 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-990] Fix ReassignPartitionCommand and improve usability</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-990</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;1. The tool does not register for IsrChangeListener on controller failover.&lt;br/&gt;
2. There is a race condition where the previous listener can fire on controller failover and the replicas can be in ISR. Even after re-registering the ISR listener after failover, it will never be triggered.&lt;br/&gt;
3. The input the tool is a static list which is very hard to use. To improve this, as a first step the tool needs to take a list of topics and list of brokers to do the assignment to and then generate the reassignment plan.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12660544">KAFKA-990</key>
            <summary>Fix ReassignPartitionCommand and improve usability</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sriramsub">Sriram</assignee>
                                    <reporter username="sriramsub">Sriram</reporter>
                        <labels>
                    </labels>
                <created>Tue, 30 Jul 2013 02:01:39 +0000</created>
                <updated>Wed, 28 Aug 2013 05:24:02 +0000</updated>
                            <resolved>Wed, 28 Aug 2013 05:24:02 +0000</resolved>
                                                                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="13732938" author="nehanarkhede" created="Wed, 7 Aug 2013 23:40:53 +0000"  >&lt;p&gt;Thanks for patch v1. Could you please fix the compilation errors though?&lt;/p&gt;</comment>
                            <comment id="13733796" author="nehanarkhede" created="Thu, 8 Aug 2013 18:15:39 +0000"  >&lt;p&gt;Thanks for the rebased patch, Sriram. Overall, the changes look great. +1. One minor suggestion -&lt;/p&gt;

&lt;p&gt;ReassignPartitionsCommand&lt;/p&gt;

&lt;p&gt;For determining the replication factor for replica assignment, can we just use the first or last partition in the map instead of relying on a partition id 0? That way if we change the assumption that partition id should always start from 0, this will not break. -&lt;br/&gt;
topicInfo._2.head._2.size instead of topicInfo._2.get(TopicAndPartition(topicInfo._1, 0)).get.size&lt;/p&gt;

&lt;p&gt;If you are ok with this suggestion, I can make it on checkin.&lt;/p&gt;

&lt;p&gt;Also, it seems that #2 in the description above was not really a problem. This is because onPartitionReassignment checks areReplicasInIsr and hence restarts the reassignment correctly. This is however not true if we hit #1, which is a real issue.&lt;/p&gt;</comment>
                            <comment id="13733837" author="jjkoshy" created="Thu, 8 Aug 2013 18:53:23 +0000"  >&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Topics to move json file format seems unnecessarily complicated. Why not just a JSON array?&lt;/li&gt;
	&lt;li&gt;Use CommandLineUtils.checkRequiredArgs&lt;/li&gt;
	&lt;li&gt;May be helpful to also print out the existing partition assignment and the final assignment.&lt;/li&gt;
	&lt;li&gt;&quot;dryrun&quot; to &quot;dry-run&quot; which I think is the spelling unix tools like patch tend to use.&lt;/li&gt;
	&lt;li&gt;line 88: use head instead of assuming 0 exists (start partition id could be != 0)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I did not finish going through all the changes in controller, but thought I would put in my comments so far &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13735120" author="jjkoshy" created="Fri, 9 Aug 2013 18:36:26 +0000"  >&lt;p&gt;Can you elaborate on the change to shutdownBroker in KafkaController? I&lt;br/&gt;
think we need to include shutting down brokers because the previous shutdown&lt;br/&gt;
attempt may have been incomplete due to no other brokers in ISR for some&lt;br/&gt;
partition which would have prevented leader movement. Subsequent attempts&lt;br/&gt;
would now be rejected.&lt;/p&gt;

&lt;p&gt;Good catches on the controller failover. Agree with Neha that #2 is not a&lt;br/&gt;
problem for replicas that are in ISR, however, we do need to re-register the&lt;br/&gt;
ISR change listener for those replicas that are in ISR.&lt;/p&gt;

&lt;p&gt;Finally, we should probably open a separate jira to implement a feature to&lt;br/&gt;
cancel an ongoing reassignment given that it is a long-running operation.&lt;br/&gt;
The dry-run option reduces the need for this but nevertheless I think it&apos;s a&lt;br/&gt;
good feature to support in the future.&lt;/p&gt;
</comment>
                            <comment id="13735653" author="jjkoshy" created="Sat, 10 Aug 2013 01:17:01 +0000"  >&lt;p&gt;Looks like I might have looked at the wrong patch. I&apos;ll review this again this weekend.&lt;/p&gt;</comment>
                            <comment id="13737010" author="jjkoshy" created="Mon, 12 Aug 2013 16:36:41 +0000"  >&lt;p&gt;The rebased patch looks good - the shutdown changes I was referring to were in v1.&lt;/p&gt;

&lt;p&gt;+1 on the rebased patch - we can fix the minor comments either on check-in or in a separate jira.&lt;/p&gt;</comment>
                            <comment id="13737017" author="guozhang" created="Mon, 12 Aug 2013 16:40:47 +0000"  >&lt;p&gt;Looks good to me overall. One question though: in shutdownBroker, should we check liveOrShuttingDownBrokerIds or liveBrokerIds? I saw going back and forth, and hence a little confused which criteria should be applied here?&lt;/p&gt;</comment>
                            <comment id="13737024" author="jjkoshy" created="Mon, 12 Aug 2013 16:51:38 +0000"  >&lt;p&gt;It should be liveOrShuttingDownBrokerIds. This is required because a controlled shutdown attempt may&lt;br/&gt;
fail - if there are no other brokers in ISR for a partition led by the broker being shutdown. In this case we&lt;br/&gt;
would want to proceed with a retry (if there are retries left).&lt;/p&gt;</comment>
                            <comment id="13737045" author="junrao" created="Mon, 12 Aug 2013 17:06:21 +0000"  >&lt;p&gt;Thanks for the patch. Looks good overall. Some comments.&lt;/p&gt;

&lt;p&gt;1. KafkaController:&lt;br/&gt;
1.1 onPartitionReassignment(): The comment above the function needs to be updated. For example, we no longer register the ISR listener here.&lt;br/&gt;
1.2 initiateReassignPartitionForTopic(): We fail the reassignment if not all brokers in RAR are alive. I am wondering if this is necessary. A broker can go down when the reassignment process is in progress and we still need to handle this case.&lt;br/&gt;
1.3 Should watchIsrChangesForReassignedPartition() be private?&lt;/p&gt;

&lt;p&gt;2. ReassignPartitionsCommand&lt;br/&gt;
2.1 It seems that we don&apos;t allow the options &quot;topics-to-move-json-file&quot; and &quot;manual-assignment-json-file&quot; to co-exist. Could we add an explicit check and output an appropriate message?&lt;br/&gt;
2.2 If &quot;broker-list&quot; is not specified, it seems that we should default to the current list of live brokers.&lt;br/&gt;
2.3 Could we somehow make dryRun the default behavior? In other words, the user has to add another option to disable dry run.&lt;/p&gt;

&lt;p&gt;3. Since the reassignment process requires fetching old data and may pollute the pagecache, do you see any performance impact to produce/fetch request latency when the reassignment is in progress?&lt;/p&gt;

</comment>
                            <comment id="13737093" author="nehanarkhede" created="Mon, 12 Aug 2013 17:37:06 +0000"  >&lt;p&gt;1.2 If a broker goes down after the reassignment has started, it will not enter the ISR. So the reassignment will not complete. If the replica fails after the 2nd stage of reassignment is complete, it will get handled through the normal logic of handling failed replicas since the reassignment is complete at that point. I&apos;m not sure there is any value in starting an expensive process like reassignment of partitions when the target replicas are not even alive.&lt;br/&gt;
3. This is the same problem we have if we replace the broker machine and bring up another broker with the same id. I think the problem is off somehow throttling replica fetches. This is a good idea. Can we file a separate JIRA for this?&lt;/p&gt;</comment>
                            <comment id="13737162" author="swapnilghike" created="Mon, 12 Aug 2013 18:23:07 +0000"  >&lt;p&gt;The rebased patch also failed for me on 0.8 HEAD&lt;/p&gt;

&lt;p&gt;$patch -p1 --dry-run &amp;lt; ~/Downloads/&lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-990&quot; title=&quot;Fix ReassignPartitionCommand and improve usability&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-990&quot;&gt;&lt;del&gt;KAFKA-990&lt;/del&gt;&lt;/a&gt;-v1-rebased.patch &lt;br/&gt;
patching file core/src/main/scala/kafka/admin/ReassignPartitionsCommand.scala&lt;br/&gt;
patching file core/src/main/scala/kafka/utils/ZkUtils.scala&lt;br/&gt;
Hunk #1 succeeded at 620 (offset 42 lines).&lt;br/&gt;
patching file core/src/main/scala/kafka/admin/ReassignPartitionsCommand.scala&lt;br/&gt;
Hunk #1 FAILED at 29.&lt;br/&gt;
Hunk #2 FAILED at 81.&lt;/p&gt;</comment>
                            <comment id="13737199" author="swapnilghike" created="Mon, 12 Aug 2013 18:41:50 +0000"  >&lt;p&gt;v1 works with git apply.&lt;/p&gt;</comment>
                            <comment id="13737416" author="sriramsub" created="Mon, 12 Aug 2013 22:01:26 +0000"  >&lt;p&gt;Neha - fixed what you suggested&lt;/p&gt;

&lt;p&gt;Jun - &lt;/p&gt;

&lt;p&gt;1. KafkaController:&lt;br/&gt;
1.1 done &lt;br/&gt;
1.2 we can fail for now. we can revisit this.&lt;br/&gt;
1.3 done&lt;/p&gt;

&lt;p&gt;2. ReassignPartitionsCommand&lt;br/&gt;
2.1 I did not do that as it makes the code ugly and it does not cause any harm. Let me know if you are strong about this.&lt;br/&gt;
2.2 i think it is safer to be explicit instead of using the live brokers for the move and causing perf issues&lt;br/&gt;
2.3 done&lt;br/&gt;
3. polluting the page cache is debatable. We could do the log appends on the follower by-passing the cache but when the follower becomes the leader, it could cause lot of IO. Another option is to throttle the rate at which the appends happen on the follower that reduces the sudden influx of messages at the follower and fetch requests at the leader. Both of these are outside the scope of this JIRA.&lt;/p&gt;</comment>
                            <comment id="13737419" author="swapnilghike" created="Mon, 12 Aug 2013 22:03:53 +0000"  >&lt;p&gt;Comments on v1:&lt;/p&gt;

&lt;p&gt;I think a much clearer name for this tool would be ReassignReplicasCommand.&lt;/p&gt;

&lt;p&gt;Admin tool:&lt;br/&gt;
11. I think the tool should also have a verify/validate option that you can run after the replica reassignment has been completed. As of now, the reassignment of a certain partition can fail and the admin won&apos;t know without looking at the controller log.&lt;br/&gt;
12. It would be good to make dry-run the default behaviour.&lt;br/&gt;
13. topics could be a json array, but I don&apos;t have a strong opinion one way or the other.&lt;br/&gt;
14. we should explicitly check that the options for the manual replica assignment and the assignment using brokerList should not be allowed at the same time. We should also check that the brokerList option is always provided with the topicsToMoveJsonFile option.&lt;br/&gt;
15. The &quot;failed&quot; messages could probably go to System.err.&lt;br/&gt;
16. We should probably not use the partition Id 0 in calling assignReplicasToBrokers, can we instead use &lt;/p&gt;
{ val topicAndPartition = groupedByTopic.get(topicInfo._1).get.get(0); val replicationFactor= topicInfo._2.get(topicAndPartition).get.size}
&lt;p&gt; ?&lt;br/&gt;
17. dryrun --&amp;gt; dry-run? I just remember seeing the latter more often across other tools.&lt;/p&gt;

&lt;p&gt;On the controller:&lt;br/&gt;
21. I think a clearer name for initiateReassignPartitionForTopic would be initiateReassignReplicasForTopicPartition; and similar renames if any.&lt;br/&gt;
22. We should fix the comment in ReassignPartitionsIsrChangeListener&lt;br/&gt;
23. We should update controllerContext.partitionReplicaAssignment only once in KafkaController.updateAssignedReplicasForPartition(). There is an extra over-write as of now.&lt;br/&gt;
24. We should batch the requests in KafkaController.StopOldReplicasOfReassignedPartition() &lt;br/&gt;
25. We should call startNewReplicasForReassignedPartition directly in initiateReassignPartitionForTopic instead of calling onPartitionReassignment. As of now, every time areReplicasInIsr returns fals, the controller will call startNewReplicasForReassignedPartition and then log a StateChangeFailedException, because the replicas were already in the new state. This exception will be logged in every call of onPartitionReassignment except for the first call.&lt;br/&gt;
26. We should remove the false condition from onPartitionReassignment&lt;br/&gt;
27. Currently, for each partition that is reassigned, controller deletes the /admin/reassign_partitions zk path, and populates it with a new list with the reassigned partition removed from the original list. This is probably an overkill, and we can delete the zk path completely once the reassignment of all partitions has completed successfully or in error. Even if there was a controller failover when the reassignment was in progress, the new controller should be able to decide which partitions have already been reassigned and which have not been in initiateReassignPartitionForTopic.&lt;/p&gt;</comment>
                            <comment id="13743930" author="junrao" created="Mon, 19 Aug 2013 15:56:22 +0000"  >&lt;p&gt;Thanks for patch v2. A few more comments.&lt;/p&gt;

&lt;p&gt;2.1 I think it&apos;s better to guard this in the command line. The issue is that if a user provided both options, it&apos;s not clear which one takes precedence.&lt;br/&gt;
2.2 In that case, we should make sure that brokerList is a mandatory field (like zkConnect).&lt;/p&gt;

&lt;p&gt;30. KafkaController.initializeAndMaybeTriggerPartitionReassignment(): The following comment is weird.&lt;br/&gt;
    // need to call method&lt;/p&gt;

&lt;p&gt;31. Related to Swapnil&apos;s comment in #11, currently, the tool finishes after the ZK path is created. It would be useful to add an option to check the state of partition reassignment so that we know either all assignments have completed or the set of partitions that are remaining.&lt;/p&gt;</comment>
                            <comment id="13743944" author="sriramsub" created="Mon, 19 Aug 2013 16:06:38 +0000"  >&lt;p&gt;2.1 will do so.&lt;br/&gt;
2.2 We cannot make it mandatory. It is not required when explicit list is specified. In the case when only topics are specified we do make it mandatory.&lt;/p&gt;

&lt;p&gt;31. There is already a tool for that. It is called CheckReassignmentStatus.&lt;/p&gt;</comment>
                            <comment id="13743970" author="guozhang" created="Mon, 19 Aug 2013 16:33:32 +0000"  >&lt;p&gt;Just one more comment: as for Swapnil&apos;s 16, currently partition id 0 is also used for AddPartitionCommand. Shall we change that also?&lt;/p&gt;</comment>
                            <comment id="13751666" author="sriramsub" created="Tue, 27 Aug 2013 20:19:13 +0000"  >&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;made the dry run the default&lt;/li&gt;
	&lt;li&gt;added some more input validations for the tool&lt;/li&gt;
	&lt;li&gt;some renaming to the controller methods&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Swapnil - &lt;/p&gt;

&lt;p&gt;23. We seem to be updating only once. Let me know if that is not the case.&lt;br/&gt;
24. It is hard to batch with the way we have the code now. The handleStateChange works per topic partition&lt;br/&gt;
25. That would cause us to explicitly invoke startNewReplicasForReassignedPartition in each case outside onPartitionReassignment which is hard to maintain. &lt;br/&gt;
26. Same comment as above&lt;br/&gt;
27. This is a lot more than what we want to do in 0.8. The issue is if we do not update, we need to add more checks to ensure it is already done or has failed. We can try to optimize that in trunk.&lt;/p&gt;</comment>
                            <comment id="13751668" author="sriramsub" created="Tue, 27 Aug 2013 20:19:56 +0000"  >&lt;p&gt;Guozhang - We have not merged addpartition to trunk yet. We plan to do once we merge the 0.8 code to trunk.&lt;/p&gt;</comment>
                            <comment id="13752117" author="nehanarkhede" created="Wed, 28 Aug 2013 05:23:49 +0000"  >&lt;p&gt;+1 on v3. Also, it will be good to file a separate JIRA for Swapnil&apos;s suggestion #27&lt;/p&gt;</comment>
                            <comment id="13752119" author="nehanarkhede" created="Wed, 28 Aug 2013 05:24:02 +0000"  >&lt;p&gt;Thanks for the patches, committed v3 to 0.8&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12596883" name="KAFKA-990-v1-rebased.patch" size="27412" author="sriramsub" created="Thu, 8 Aug 2013 17:20:28 +0000"/>
                            <attachment id="12596414" name="KAFKA-990-v1.patch" size="22525" author="sriramsub" created="Tue, 6 Aug 2013 20:31:06 +0000"/>
                            <attachment id="12597574" name="KAFKA-990-v2.patch" size="34000" author="sriramsub" created="Mon, 12 Aug 2013 21:56:39 +0000"/>
                            <attachment id="12600230" name="KAFKA-990-v3.patch" size="37216" author="sriramsub" created="Tue, 27 Aug 2013 20:13:48 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>340735</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 12 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1mrmf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>341053</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>