<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:42:03 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-18206] EmbeddedKafkaCluster must set features</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-18206</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;The EmbeddedKafkaCluster classes respectively used by Streams and Connect relies on&#160;&lt;br/&gt;
KafkaClusterTestKit. We just found out that they do not set the features at all. They should.&lt;br/&gt;
&#160;&lt;br/&gt;
The other integration tests rely on classes wrapping KafkaClusterTestKit and they take care of setting the features. This is not ideal. I wonder whether we could push that functionality to KafkaClusterTestKit.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13601658">KAFKA-18206</key>
            <summary>EmbeddedKafkaCluster must set features</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="brandboat">Kuan Po Tseng</assignee>
                                    <reporter username="dajac">David Jacot</reporter>
                        <labels>
                    </labels>
                <created>Wed, 11 Dec 2024 09:32:42 +0000</created>
                <updated>Wed, 5 Feb 2025 17:20:18 +0000</updated>
                            <resolved>Wed, 5 Feb 2025 17:20:18 +0000</resolved>
                                                    <fixVersion>4.0.0</fixVersion>
                                    <component>streams</component>
                    <component>unit tests</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="17904840" author="brandboat" created="Wed, 11 Dec 2024 16:03:03 +0000"  >&lt;p&gt;Gentle ping &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dajac&quot; class=&quot;user-hover&quot; rel=&quot;dajac&quot;&gt;dajac&lt;/a&gt; , if I understand correctly, the &quot;set the features&quot; mentioned here refers to &lt;tt&gt;TestKitNodes#setFeature&lt;/tt&gt;, right? &lt;br/&gt;
Another thing I&#8217;d like to ask is, regarding the Streams and Connect needing to set the features, which specific features need to be set? I can write a test for this scenario to verify. Thanks!&lt;/p&gt;</comment>
                            <comment id="17904888" author="dajac" created="Wed, 11 Dec 2024 18:07:55 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=brandboat&quot; class=&quot;user-hover&quot; rel=&quot;brandboat&quot;&gt;brandboat&lt;/a&gt; That&apos;s right. However, I am not sure whether we should call setFeature from the embedded class. My advice is to look at how we did it in the other integration tests (e.g. in&#160;RaftClusterInstance). It would be great if we could actually unify the approaches. Regarding the features, it should set all the default features (see RaftClusterInstance).&lt;/p&gt;</comment>
                            <comment id="17905852" author="brandboat" created="Mon, 16 Dec 2024 00:58:28 +0000"  >&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;FYI, just want to let you know that below tests are failed when setting transaction.version to 2, and I am trying to find out the root cause, thanks.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
MirrorConnectorsIntegrationTransactionsTest &amp;gt; testOffsetTranslationBehindReplicationFlow() &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
MirrorConnectorsIntegrationExactlyOnceTest &amp;gt; testOffsetTranslationBehindReplicationFlow() &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
MirrorConnectorsIntegrationExactlyOnceTest &amp;gt; testReplication() &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ExactlyOnceSourceIntegrationTest &amp;gt; testConnectorReconfiguration() &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ExactlyOnceSourceIntegrationTest &amp;gt; testConnectorBoundary() &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
OffsetsApiIntegrationTest &amp;gt; testResetSourceConnectorOffsetsExactlyOnceSupportEnabled() &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
OffsetsApiIntegrationTest &amp;gt; testAlterSourceConnectorOffsetsExactlyOnceSupportEnabled() &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17907678" author="brandboat" created="Sun, 22 Dec 2024 11:04:27 +0000"  >&lt;p&gt;During the investigation of the failed tests, I found that some tests (e.g., &lt;tt&gt;OffsetApiIntegrationTest.testResetSourceConnectorOffsetsExactlyOnceSupportEnabled&lt;/tt&gt;) commit transactions without sending any records. This behavior is fine when using transaction versions 0 or 1 because the producer won&apos;t send EndTxnRequest to the broker &lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt;. However, with transaction version 2, the producer still sends an EndTxnRequest to the broker while in transaction coordinator, the txn state is still in EMPTY, resulting in an error from the broker.&lt;/p&gt;

&lt;p&gt;This issue can be reproduced with the test in below. I&apos;m unsure if this behavior is expected. If it&apos;s not, one potential fix could be to follow the approach used in TV_0 and TV_1, where the EndTxnRequest is not sent if no partitions or offsets have been successfully added to the transaction. I&apos;m happy to work on this fix if it&apos;s acceptable.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    @ClusterTests({
        @ClusterTest(brokers = 3, features = {
            @ClusterFeature(feature = Feature.TRANSACTION_VERSION, version = 0)}),
        @ClusterTest(brokers = 3, features = {
            @ClusterFeature(feature = Feature.TRANSACTION_VERSION, version = 1)}),
        @ClusterTest(brokers = 3, features = {
            @ClusterFeature(feature = Feature.TRANSACTION_VERSION, version = 2)})
    })
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testProducerEndTransaction2(ClusterInstance cluster) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; InterruptedException {
        Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;&amp;gt; properties = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HashMap&amp;lt;&amp;gt;();
        properties.put(ProducerConfig.TRANSACTIONAL_ID_CONFIG, &lt;span class=&quot;code-quote&quot;&gt;&quot;foobar&quot;&lt;/span&gt;);
        properties.put(ProducerConfig.CLIENT_ID_CONFIG, &lt;span class=&quot;code-quote&quot;&gt;&quot;test&quot;&lt;/span&gt;);
        properties.put(ProducerConfig.ENABLE_IDEMPOTENCE_CONFIG, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; (Producer&amp;lt;&lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[], &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[]&amp;gt; producer1 = cluster.producer(properties)) {

            producer1.initTransactions();
            producer1.beginTransaction();
            producer1.commitTransaction(); &lt;span class=&quot;code-comment&quot;&gt;// In TV_2, we&apos;ll get InvalidTxnStateException
&lt;/span&gt;        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Another test case, which is essentially the same as the previous one, starts with a transaction that includes records, and then proceeds to start the next transaction. When using transaction version 2, we encounter an error, but this time it&#8217;s a different error from the one seen in the previous case.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    @ClusterTests({
        @ClusterTest(brokers = 3, features = {
            @ClusterFeature(feature = Feature.TRANSACTION_VERSION, version = 0)}),
        @ClusterTest(brokers = 3, features = {
            @ClusterFeature(feature = Feature.TRANSACTION_VERSION, version = 1)}),
        @ClusterTest(brokers = 3, features = {
            @ClusterFeature(feature = Feature.TRANSACTION_VERSION, version = 2)})
    })
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testProducerEndTransaction(ClusterInstance cluster) {
        Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;&amp;gt; properties = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HashMap&amp;lt;&amp;gt;();
        properties.put(ProducerConfig.TRANSACTIONAL_ID_CONFIG, &lt;span class=&quot;code-quote&quot;&gt;&quot;foobar&quot;&lt;/span&gt;);
        properties.put(ProducerConfig.CLIENT_ID_CONFIG, &lt;span class=&quot;code-quote&quot;&gt;&quot;test&quot;&lt;/span&gt;);
        properties.put(ProducerConfig.ENABLE_IDEMPOTENCE_CONFIG, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; (Producer&amp;lt;&lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[], &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[]&amp;gt; producer1 = cluster.producer(properties)) {

            producer1.initTransactions();
            producer1.beginTransaction();
            producer1.send(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ProducerRecord&amp;lt;&amp;gt;(&lt;span class=&quot;code-quote&quot;&gt;&quot;test&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;key&quot;&lt;/span&gt;.getBytes(), &lt;span class=&quot;code-quote&quot;&gt;&quot;value&quot;&lt;/span&gt;.getBytes()));
            producer1.commitTransaction();

            producer1.beginTransaction();
            producer1.commitTransaction(); &lt;span class=&quot;code-comment&quot;&gt;// In TV_2, we&apos;ll get ProducerFencedException
&lt;/span&gt;        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt;: &lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/clients/src/main/java/org/apache/kafka/clients/producer/internals/TransactionManager.java#L857-L865&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/trunk/clients/src/main/java/org/apache/kafka/clients/producer/internals/TransactionManager.java#L857-L865&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17908311" author="brandboat" created="Thu, 26 Dec 2024 14:32:04 +0000"  >&lt;p&gt;gentle ping &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jolshan&quot; class=&quot;user-hover&quot; rel=&quot;jolshan&quot;&gt;jolshan&lt;/a&gt;, sorry for bothering you. I just wondering if the &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-18206?focusedCommentId=17907678&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#comment-17907678&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;above comment&lt;/a&gt; is something we need to be concerned about, or if I misunderstood anything?&lt;/p&gt;</comment>
                            <comment id="17909727" author="brandboat" created="Sat, 4 Jan 2025 10:12:48 +0000"  >&lt;p&gt;Regarding to the issue I mentioned above, here is the JIRA ticket &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-18401&quot; title=&quot;Transaction version 2 does not support commit transaction without records&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-18401&quot;&gt;&lt;del&gt;KAFKA-18401&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17910769" author="jolshan" created="Tue, 7 Jan 2025 19:07:20 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=brandboat&quot; class=&quot;user-hover&quot; rel=&quot;brandboat&quot;&gt;brandboat&lt;/a&gt; sorry I was on vacation for the holidays. I replied to your comments on the new JIRA.&lt;/p&gt;</comment>
                            <comment id="17911202" author="divijvaidya" created="Wed, 8 Jan 2025 18:41:04 +0000"  >&lt;p&gt;Jumping in to present an FYI with Embedded Cluster. When it is created by the tests, we use MockTime initialized to when the cluster was created. But in certain streams tests, we use actual Thread.Sleep (instead of incrementing the mock time). This leads to a situation where the time on the cluster is waaay behind the current time of test execution (ie clients have a time in future). It doesn&apos;t matter in usual scenarios but I found this problematic when working with constraints around create_time timestamp for messages. I will create a separate Jira to fix this once I have a better understanding of the bug.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            43 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1t1ns:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>