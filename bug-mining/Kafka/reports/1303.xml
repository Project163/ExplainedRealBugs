<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:58:17 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-4473] RecordCollector should handle retriable exceptions more strictly</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-4473</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;see: &lt;a href=&quot;https://groups.google.com/forum/#!topic/confluent-platform/DT5bk1oCVk8&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://groups.google.com/forum/#!topic/confluent-platform/DT5bk1oCVk8&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;There is probably a bug in the RecordCollector as described in my detailed Cluster test published in the aforementioned post.&lt;/p&gt;

&lt;p&gt;The class RecordCollector has the following behavior:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if there is no exception, add the message offset to a map&lt;/li&gt;
	&lt;li&gt;otherwise, do not add the message offset and instead log the above statement&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Is it possible that this offset map contains the latest offset to commit? If so, a message that fails might be overriden be a successful (later) message and the consumer commits every message up to the latest offset?&lt;/p&gt;</description>
                <environment></environment>
        <key id="13024750">KAFKA-4473</key>
            <summary>RecordCollector should handle retriable exceptions more strictly</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="damianguy">Damian Guy</assignee>
                                    <reporter username="Thomas Schulz">Thomas Schulz</reporter>
                        <labels>
                            <label>architecture</label>
                    </labels>
                <created>Thu, 1 Dec 2016 11:56:50 +0000</created>
                <updated>Tue, 20 Dec 2016 18:00:21 +0000</updated>
                            <resolved>Tue, 20 Dec 2016 17:59:40 +0000</resolved>
                                    <version>0.10.1.0</version>
                                    <fixVersion>0.10.2.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="15713038" author="guozhang" created="Thu, 1 Dec 2016 20:48:16 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Thomas+Schulz&quot; class=&quot;user-hover&quot; rel=&quot;Thomas Schulz&quot;&gt;Thomas Schulz&lt;/a&gt; Thanks for reporting this issue. I have a couple of questions to follow up:&lt;/p&gt;

&lt;p&gt;1. NotLeaderForPartitionException is a retriable error and hence it should be keep retrying instead of throwing it out. If you turn on the debug level logging do you see entries indicating it has been retrying?&lt;/p&gt;

&lt;p&gt;2. Averagely how long it took in your testing environment to bounce a broker?&lt;/p&gt;</comment>
                            <comment id="15715388" author="thomas schulz" created="Fri, 2 Dec 2016 15:18:46 +0000"  >&lt;p&gt;1. I did not configure the retries explicitly, i.e. &quot;ProducerConfig.RETRIES_CONFIG&quot;. The default is &quot;0&quot; according to the kafka documentation. But since KafkaStreams promotes &quot;at-least-once&quot; delivery, I expected it to set this value appriopriateley. You think this could be the reason?&lt;/p&gt;

&lt;p&gt;2. Almost instantly, maybe 2-3 seconds.&lt;/p&gt;</comment>
                            <comment id="15715394" author="thomas schulz" created="Fri, 2 Dec 2016 15:21:13 +0000"  >&lt;p&gt;To 1.) Even if the retries are in fact &quot;0&quot;, then this is certainly not a retriable error. I would expect an uncaught exception.&lt;/p&gt;</comment>
                            <comment id="15715586" author="thomas schulz" created="Fri, 2 Dec 2016 16:37:23 +0000"  >&lt;p&gt;UPDATE:&lt;/p&gt;

&lt;p&gt;I added the following config:&lt;br/&gt;
streamProperties.put(ProducerConfig.RETRIES_CONFIG, 3);&lt;br/&gt;
streamProperties.put(ProducerConfig.RETRY_BACKOFF_MS_CONFIG, 1000);&lt;/p&gt;

&lt;p&gt;With this configuration, I was not able to reproduce the message loss.&lt;/p&gt;

&lt;p&gt;50_000 -&amp;gt; 50_001&lt;br/&gt;
100_000 -&amp;gt; 100_000&lt;br/&gt;
200_000 -&amp;gt; 200_000&lt;/p&gt;

&lt;p&gt;This is probably the solution.&lt;/p&gt;

&lt;p&gt;Thanks for the hint. With regard to this specific test setup, consider the bug as resolved.&lt;/p&gt;</comment>
                            <comment id="15716796" author="guozhang" created="Fri, 2 Dec 2016 22:56:42 +0000"  >&lt;p&gt;Thanks for the update &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Thomas+Schulz&quot; class=&quot;user-hover&quot; rel=&quot;Thomas Schulz&quot;&gt;Thomas Schulz&lt;/a&gt;. I think what you observe still needs to further fixing since naively for such retriable exceptions we should retry infinitely since otherwise there is still a risk of dropping a message on the floor and proceed.&lt;/p&gt;

&lt;p&gt;I will try to propose a ultimate solution for this while working on exactly-once semantics and hence to keep this JIRA open for now.&lt;/p&gt;</comment>
                            <comment id="15744756" author="githubbot" created="Tue, 13 Dec 2016 10:10:37 +0000"  >&lt;p&gt;GitHub user dguy opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/2249&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2249&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-4473&quot; title=&quot;RecordCollector should handle retriable exceptions more strictly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-4473&quot;&gt;&lt;del&gt;KAFKA-4473&lt;/del&gt;&lt;/a&gt;: RecordCollector should handle retriable exceptions more strictly&lt;/p&gt;

&lt;p&gt;    The `RecordCollectorImpl` currently drops messages on the floor if an exception is non-null in the producer callback. This will result in message loss and violates at-least-once processing.&lt;br/&gt;
    Rather than just log an error in the callback, save the exception in a field. On subsequent calls to `send`, `flush`, `close`, first check for the existence of an exception and throw a `StreamsException` if it is non-null. Also, in the callback, if an exception has already occurred, the `offsets` map should not be updated.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/dguy/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/dguy/kafka&lt;/a&gt; kafka-4473&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/2249.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2249.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #2249&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 9ceaa67a9967edfa7522bb9daea64c1bc44738c0&lt;br/&gt;
Author: Damian Guy &amp;lt;damian.guy@gmail.com&amp;gt;&lt;br/&gt;
Date:   2016-12-12T17:47:27Z&lt;/p&gt;

&lt;p&gt;    throw exception in record collector instead of just dropping messages on the floor&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15764820" author="guozhang" created="Tue, 20 Dec 2016 17:59:41 +0000"  >&lt;p&gt;Issue resolved by pull request 2249&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/kafka/pull/2249&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2249&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15764822" author="githubbot" created="Tue, 20 Dec 2016 18:00:21 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/2249&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2249&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 47 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i370of:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>