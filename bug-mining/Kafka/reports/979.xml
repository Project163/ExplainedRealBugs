<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:53:15 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-3047] Explicit offset assignment in Log.append can corrupt the log</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-3047</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;&lt;tt&gt;Log.append()&lt;/tt&gt; has &lt;tt&gt;assignOffsets&lt;/tt&gt; parameter, which, when set to false, should cause Kafka to use the offsets specified in the &lt;tt&gt;ByteBufferMessageSet&lt;/tt&gt; and not recalculate them based on &lt;tt&gt;nextOffsetMetadata&lt;/tt&gt;. However, in that function, &lt;tt&gt;appendInfo.firstOffset&lt;/tt&gt; is unconditionally set to &lt;tt&gt;nextOffsetMetadata.messageOffset&lt;/tt&gt;. This can cause corruption of the log in the following scenario:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;&lt;tt&gt;nextOffsetMetadata.messageOffset&lt;/tt&gt; is 2001&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;append(messageSet, assignOffsets = false)&lt;/tt&gt; is called, where &lt;tt&gt;messageSet&lt;/tt&gt; contains offsets 1001...1500&lt;/li&gt;
	&lt;li&gt;after &lt;tt&gt;val appendInfo = analyzeAndValidateMessageSet(messages)&lt;/tt&gt; call, &lt;tt&gt;appendInfo.fistOffset&lt;/tt&gt; is 1001 and &lt;tt&gt;appendInfo.lastOffset&lt;/tt&gt; is 1500&lt;/li&gt;
	&lt;li&gt;after &lt;tt&gt;appendInfo.firstOffset = nextOffsetMetadata.messageOffset&lt;/tt&gt; call, &lt;tt&gt;appendInfo.fistOffset&lt;/tt&gt; is 2001 and &lt;tt&gt;appendInfo.lastOffset&lt;/tt&gt; is 1500&lt;/li&gt;
	&lt;li&gt;consistency check &lt;tt&gt;if(!appendInfo.offsetsMonotonic || appendInfo.firstOffset &amp;lt; nextOffsetMetadata.messageOffset)&lt;/tt&gt; succeeds (the second condition can never fail due to unconditional assignment) and writing proceeds&lt;/li&gt;
	&lt;li&gt;the message set is appended to current log segment starting at offset 2001, but the offsets in the set are 1001...1500&lt;/li&gt;
	&lt;li&gt;the system shuts down abruptly&lt;/li&gt;
	&lt;li&gt;on restart, the following unrecoverable error is reported:&lt;/li&gt;
&lt;/ul&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Exception in thread &lt;span class=&quot;code-quote&quot;&gt;&quot;main&quot;&lt;/span&gt; kafka.common.InvalidOffsetException: Attempt to append an offset (1001) to position 12345 no larger than the last offset appended (1950) to xyz/00000000000000000000.index.
  at kafka.log.OffsetIndex$$anonfun$append$1.apply$mcV$sp(OffsetIndex.scala:207)
  at kafka.log.OffsetIndex$$anonfun$append$1.apply(OffsetIndex.scala:197)
  at kafka.log.OffsetIndex$$anonfun$append$1.apply(OffsetIndex.scala:197)
  at kafka.utils.CoreUtils$.inLock(CoreUtils.scala:262)
  at kafka.log.OffsetIndex.append(OffsetIndex.scala:197)
  at kafka.log.LogSegment.recover(LogSegment.scala:188)
  at kafka.log.Log$$anonfun$loadSegments$4.apply(Log.scala:188)
  at kafka.log.Log$$anonfun$loadSegments$4.apply(Log.scala:160)
  at scala.collection.TraversableLike$WithFilter$$anonfun$foreach$1.apply(TraversableLike.scala:778)
  at scala.collection.IndexedSeqOptimized$&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;foreach(IndexedSeqOptimized.scala:33)
  at scala.collection.mutable.ArrayOps$ofRef.foreach(ArrayOps.scala:186)
  at scala.collection.TraversableLike$WithFilter.foreach(TraversableLike.scala:777)
  at kafka.log.Log.loadSegments(Log.scala:160)
  at kafka.log.Log.&amp;lt;init&amp;gt;(Log.scala:90)
  at kafka.log.LogManager$$anonfun$loadLogs$2$$anonfun$3$$anonfun$apply$10$$anonfun$apply$1.apply$mcV$sp(LogManager.scala:150)
  at kafka.utils.CoreUtils$$anon$1.run(CoreUtils.scala:60)
  at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471)
  at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:334)
  at java.util.concurrent.FutureTask.run(FutureTask.java:166)
  at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1110)
  at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:603)
  at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:722)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt; 

&lt;p&gt;&lt;b&gt;Proposed fix:&lt;/b&gt; the assignment &lt;tt&gt;appendInfo.firstOffset = nextOffsetMetadata.messageOffset&lt;/tt&gt; should only happen in &lt;tt&gt;if (assignOffsets)&lt;/tt&gt; branch of code.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12924690">KAFKA-3047</key>
            <summary>Explicit offset assignment in Log.append can corrupt the log</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ijuma">Ismael Juma</assignee>
                                    <reporter username="mmakowski">Maciek Makowski</reporter>
                        <labels>
                    </labels>
                <created>Tue, 29 Dec 2015 14:28:58 +0000</created>
                <updated>Tue, 5 Jul 2016 09:26:22 +0000</updated>
                            <resolved>Sun, 13 Mar 2016 08:32:06 +0000</resolved>
                                    <version>0.9.0.0</version>
                                    <fixVersion>0.10.0.0</fixVersion>
                                    <component>log</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15184628" author="githubbot" created="Tue, 8 Mar 2016 08:12:05 +0000"  >&lt;p&gt;GitHub user ijuma opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/1029&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/1029&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3047&quot; title=&quot;Explicit offset assignment in Log.append can corrupt the log&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3047&quot;&gt;&lt;del&gt;KAFKA-3047&lt;/del&gt;&lt;/a&gt;: Explicit offset assignment in Log.append can corrupt the log&lt;/p&gt;

&lt;p&gt;    This fix was suggested by Maciek Makowski, who also reported the problem.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/ijuma/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/ijuma/kafka&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3047&quot; title=&quot;Explicit offset assignment in Log.append can corrupt the log&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3047&quot;&gt;&lt;del&gt;KAFKA-3047&lt;/del&gt;&lt;/a&gt;-log-append-can-corrupt-the-log&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/1029.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/1029.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #1029&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 58d098c589697259482207631f5cfe1d8271a186&lt;br/&gt;
Author: Ismael Juma &amp;lt;ismael@juma.me.uk&amp;gt;&lt;br/&gt;
Date:   2016-03-08T08:10:17Z&lt;/p&gt;

&lt;p&gt;    Only set `firstOffset` again if `assignOffsets` is true&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15184629" author="ijuma" created="Tue, 8 Mar 2016 08:13:47 +0000"  >&lt;p&gt;Thanks for the report and suggested fix Maciek.&lt;/p&gt;</comment>
                            <comment id="15191427" author="guozhang" created="Fri, 11 Mar 2016 19:27:51 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mmakowski&quot; class=&quot;user-hover&quot; rel=&quot;mmakowski&quot;&gt;mmakowski&lt;/a&gt;, thanks for reporting this. I&apos;m curious how you encountered this issue, since currently &lt;tt&gt;append(messageSet, assignOffsets = false&lt;/tt&gt; is only called by the replica fetcher thread, in which &lt;tt&gt;nextOffsetMetadata.messageOffset&lt;/tt&gt; and &lt;tt&gt;messageSet&lt;/tt&gt;&apos;s offset should be usually consistent. Just trying to see if it some other scenarios to lead to this issue?&lt;/p&gt;</comment>
                            <comment id="15191589" author="mmakowski" created="Fri, 11 Mar 2016 22:18:53 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ijuma&quot; class=&quot;user-hover&quot; rel=&quot;ijuma&quot;&gt;ijuma&lt;/a&gt;: thanks for the fix!&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt;: I discovered it when I attempted to use the &lt;tt&gt;Log&lt;/tt&gt; component on its own &amp;#8211; I wanted a library that would do reliable logging and housekeeping, but without the networking. So no, nothing in Kafka proper that I&apos;m aware of would expose it.&lt;/p&gt;</comment>
                            <comment id="15191642" author="guozhang" created="Fri, 11 Mar 2016 22:55:33 +0000"  >&lt;p&gt;Good to know, thanks for explanation!&lt;/p&gt;</comment>
                            <comment id="15192220" author="ijuma" created="Sun, 13 Mar 2016 08:32:06 +0000"  >&lt;p&gt;Guozhang merged this, but JIRA was down so he could not close the issue. I downgraded the priority because this doesn&apos;t affect Kafka&apos;s usage of `Log`.&lt;/p&gt;</comment>
                            <comment id="15195108" author="githubbot" created="Tue, 15 Mar 2016 11:09:34 +0000"  >&lt;p&gt;GitHub user ijuma opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/1071&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/1071&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    MINOR: Add test that verifies fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3047&quot; title=&quot;Explicit offset assignment in Log.append can corrupt the log&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3047&quot;&gt;&lt;del&gt;KAFKA-3047&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Also clean-up `LogTest` a little.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/ijuma/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/ijuma/kafka&lt;/a&gt; kafka-3047-explicit-offset-assignment-corrupt-log-test&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/1071.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/1071.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #1071&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit aab8f78cee26b869f14b6f3652cbac2245362076&lt;br/&gt;
Author: Ismael Juma &amp;lt;ismael@juma.me.uk&amp;gt;&lt;br/&gt;
Date:   2016-03-15T11:08:21Z&lt;/p&gt;

&lt;p&gt;    Add test that verifies fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3047&quot; title=&quot;Explicit offset assignment in Log.append can corrupt the log&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3047&quot;&gt;&lt;del&gt;KAFKA-3047&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15196012" author="githubbot" created="Tue, 15 Mar 2016 19:15:48 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/1071&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/1071&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15362262" author="josephfrancis" created="Tue, 5 Jul 2016 09:20:25 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt;, &lt;br/&gt;
We were running kafka 0.9 in production and encountered this issue while restarting a slow broker.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;[2016-06-24 10:04:47,546] ERROR There was an error in one of the threads during logs loading: kafka.common.InvalidOffsetException: Attempt to append an offset (36392155) to position 32437 no larger than the last offset appended (36392171) to /xyz.index. (kafka.log.LogManager)
[2016-06-24 10:04:47,550] FATAL Fatal error during KafkaServer startup. Prepare to shutdown (kafka.server.KafkaServer)
kafka.common.InvalidOffsetException: Attempt to append an offset (36392155) to position 32437 no larger than the last offset appended (36392171) to /xyz.index.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Just mentioning this as this happened to us in a working production cluster.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 20 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2qdgv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>guozhang</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>