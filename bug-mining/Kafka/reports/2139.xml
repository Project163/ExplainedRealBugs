<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:16:46 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-7652] Kafka Streams Session store performance degradation from 0.10.2.2 to 0.11.0.0</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-7652</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;I&apos;m creating this issue in response to &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt;&apos;s request on the mailing list:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://lists.apache.org/thread.html/97d620f4fd76be070ca4e2c70e2fda53cafe051e8fc4505dbcca0321@%3Cusers.kafka.apache.org%3E&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://lists.apache.org/thread.html/97d620f4fd76be070ca4e2c70e2fda53cafe051e8fc4505dbcca0321@%3Cusers.kafka.apache.org%3E&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;We are attempting to upgrade our Kafka Streams application from 0.10.2.1 but experience a severe performance degradation. The highest amount of CPU time seems spent in retrieving from the local cache. Here&apos;s an example thread profile with 0.11.0.0:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://i.imgur.com/l5VEsC2.png&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://i.imgur.com/l5VEsC2.png&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;When things are running smoothly we&apos;re gated by retrieving from the state store with acceptable performance. Here&apos;s an example thread profile with 0.10.2.1:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://i.imgur.com/IHxC2cZ.png&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://i.imgur.com/IHxC2cZ.png&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Some investigation reveals that it appears we&apos;re performing about 3 orders magnitude more&#160;lookups on the NamedCache over a comparable time period. I&apos;ve attached logs of the NamedCache flush logs for 0.10.2.1 and 0.11.0.3.&lt;/p&gt;

&lt;p&gt;We&apos;re using session windows and have the app configured for&#160;commit.interval.ms&#160;= 30 * 1000 and cache.max.bytes.buffering = 10485760&lt;/p&gt;

&lt;p&gt;I&apos;m happy to share more details if they would be helpful. Also happy to run tests on our data.&lt;/p&gt;

&lt;p&gt;I also found this issue, which seems like it may be related:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-4904&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-4904&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;KIP-420: &lt;a href=&quot;https://cwiki.apache.org/confluence/display/KAFKA/KIP-420%3A+Add+Single+Value+Fetch+in+Session+Stores&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://cwiki.apache.org/confluence/display/KAFKA/KIP-420%3A+Add+Single+Value+Fetch+in+Session+Stores&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13199105">KAFKA-7652</key>
            <summary>Kafka Streams Session store performance degradation from 0.10.2.2 to 0.11.0.0</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="guozhang">Guozhang Wang</assignee>
                                    <reporter username="jonathanpdx">Jonathan Gordon</reporter>
                        <labels>
                            <label>kip</label>
                    </labels>
                <created>Sat, 17 Nov 2018 19:38:49 +0000</created>
                <updated>Wed, 29 May 2019 04:54:28 +0000</updated>
                            <resolved>Thu, 18 Apr 2019 16:07:54 +0000</resolved>
                                    <version>0.11.0.0</version>
                    <version>0.11.0.1</version>
                    <version>0.11.0.2</version>
                    <version>0.11.0.3</version>
                    <version>1.1.1</version>
                    <version>2.0.0</version>
                    <version>2.0.1</version>
                                    <fixVersion>2.3.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="16740913" author="githubbot" created="Sat, 12 Jan 2019 00:37:40 +0000"  >&lt;p&gt;guozhangwang commented on pull request #6134: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7652&quot; title=&quot;Kafka Streams Session store performance degradation from 0.10.2.2 to 0.11.0.0&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7652&quot;&gt;&lt;del&gt;KAFKA-7652&lt;/del&gt;&lt;/a&gt;: Fix SessionStore&apos;s findSession(single-key)&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/6134&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/6134&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   1. Let `findSessions(final K key)` to call on underlying bytes store directly, using the more restricted range.&lt;/p&gt;

&lt;p&gt;   2. Fix the conservative upper range for multi-key range in session schema.&lt;/p&gt;

&lt;p&gt;   3. Minor: removed unnecessary private WrappedSessionStoreBytesIterator  class as it is only used in unit test.&lt;/p&gt;

&lt;p&gt;   4. Minor: removed unnecessary schema#init function by using the direct bytes-to-binary function.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16740923" author="guozhang" created="Sat, 12 Jan 2019 00:48:45 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jonathanpdx&quot; class=&quot;user-hover&quot; rel=&quot;jonathanpdx&quot;&gt;jonathanpdx&lt;/a&gt; I&apos;ve finally be able to reproduce the issue you&apos;ve discovered and here is a fix I&apos;ve put it up: &lt;a href=&quot;https://github.com/apache/kafka/pull/6134&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/6134&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This is aimed for trunk (2.2.0), but once confirmed it fixed the issue I will have a cherry-pick fix for older branches as well.&lt;/p&gt;

&lt;p&gt;Sorry for the long wait!&lt;/p&gt;</comment>
                            <comment id="16744760" author="githubbot" created="Thu, 17 Jan 2019 07:39:56 +0000"  >&lt;p&gt;guozhangwang commented on pull request #6161: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7652&quot; title=&quot;Kafka Streams Session store performance degradation from 0.10.2.2 to 0.11.0.0&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7652&quot;&gt;&lt;del&gt;KAFKA-7652&lt;/del&gt;&lt;/a&gt;: Part II; Add single-point query for SessionStore and use for flushing / getter&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/6161&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/6161&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   &lt;a href=&quot;https://github.com/apache/kafka/pull/2972&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2972&lt;/a&gt; tried to fix a bug about flushing operation, but it was not complete, since `findSessions(key, earliestEnd, latestStart)` does not guarantee to only return a single entry since its semantics are to return any sessions whose end &amp;gt; earliestEnd and whose start &amp;lt; latestStart.&lt;/p&gt;

&lt;p&gt;   I&apos;ve tried various ways to fix it completely and I ended up having to add a single-point query to the public ReadOnlySessionStore API for the exact needed semantics. It is used for flushing to read the old values (otherwise the wrong old values will be sent downstreams, hence it is a correctness issue) and also for getting the value for value-getters (it is for perf only).&lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16746627" author="githubbot" created="Fri, 18 Jan 2019 20:08:17 +0000"  >&lt;p&gt;guozhangwang commented on pull request #6134: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7652&quot; title=&quot;Kafka Streams Session store performance degradation from 0.10.2.2 to 0.11.0.0&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7652&quot;&gt;&lt;del&gt;KAFKA-7652&lt;/del&gt;&lt;/a&gt;: Part I; Fix SessionStore&apos;s findSession(single-key)&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/6134&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/6134&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16750785" author="githubbot" created="Thu, 24 Jan 2019 06:48:28 +0000"  >&lt;p&gt;guozhangwang commented on pull request #6191: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7652&quot; title=&quot;Kafka Streams Session store performance degradation from 0.10.2.2 to 0.11.0.0&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7652&quot;&gt;&lt;del&gt;KAFKA-7652&lt;/del&gt;&lt;/a&gt;: Part III; Put to underlying before Flush&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/6191&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/6191&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   This is on top of the Part II PR and hence should be only reviewed when the part II PR is merged.&lt;/p&gt;

&lt;p&gt;   1) In the caching layer&apos;s flush listener call, we should always write to the underlying store, before flushing (see &lt;a href=&quot;https://github.com/apache/kafka/pull/4331&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/4331&lt;/a&gt; &apos;s point 4) for detailed explanation). When fixing 4331, it only touches on KV stores, but it turns out that we should fix for window and session store as well.&lt;/p&gt;

&lt;p&gt;   2) Also apply the optimization that was in session-store already: when the new value bytes and old value bytes are all null (this is possible e.g. if there is a put(K, V) followed by a remove(K) or put(K, null) and these two operations only hit the cache), upon flushing this mean the underlying store does not have this value at all and also no intermediate value has been sent to downstream as well. We can skip both putting a null to the underlying store as well as calling the flush listener sending `null -&amp;gt; null` in this case.&lt;/p&gt;

&lt;p&gt;   Modifies corresponding unit tests.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16756771" author="githubbot" created="Thu, 31 Jan 2019 01:31:34 +0000"  >&lt;p&gt;guozhangwang commented on pull request #6161: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7652&quot; title=&quot;Kafka Streams Session store performance degradation from 0.10.2.2 to 0.11.0.0&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7652&quot;&gt;&lt;del&gt;KAFKA-7652&lt;/del&gt;&lt;/a&gt;: Part II; Add single-point query for SessionStore and use for flushing / getter&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/6161&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/6161&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16766843" author="githubbot" created="Wed, 13 Feb 2019 06:36:43 +0000"  >&lt;p&gt;guozhangwang commented on pull request #6191: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7652&quot; title=&quot;Kafka Streams Session store performance degradation from 0.10.2.2 to 0.11.0.0&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7652&quot;&gt;&lt;del&gt;KAFKA-7652&lt;/del&gt;&lt;/a&gt;: Part III; Put to underlying before Flush&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/6191&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/6191&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16766848" author="guozhang" created="Wed, 13 Feb 2019 06:38:40 +0000"  >&lt;p&gt;I think this issue should have been fixed with the three PRs listed above. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jonathanpdx&quot; class=&quot;user-hover&quot; rel=&quot;jonathanpdx&quot;&gt;jonathanpdx&lt;/a&gt; would appreciate if you can try it out and validate if it is true.&lt;/p&gt;</comment>
                            <comment id="16777630" author="jonathanpdx" created="Tue, 26 Feb 2019 06:27:13 +0000"  >&lt;p&gt;I tested out with trunk on Feb 22 (commit&#160;0d461e4ea0a8353c358ae661837f471995943bb0) and we&apos;re still seeing&#160;the same performance&#160;issue. Aside from logging the output of the NamedCache stats, is there data I can provide to help further narrow down the issue? Any other ideas?&lt;/p&gt;</comment>
                            <comment id="16778224" author="guozhang" created="Tue, 26 Feb 2019 17:29:13 +0000"  >&lt;p&gt;Oh that&apos;s bad news.. &lt;/p&gt;

&lt;p&gt;1) when you profile on latest trunk did you see the same pattern as observed in &lt;a href=&quot;https://i.imgur.com/IHxC2cZ.png&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://i.imgur.com/IHxC2cZ.png&lt;/a&gt; as well as in the trace logging compared with 0.10.2.x?&lt;br/&gt;
2) practically the lookups in the caching layer is very cheap and hence even increased a lot it should not contribute to much overhead, whereas the fetches on the underlying store would be much more expensive. Could you confirm if the performance bottleneck is from the underlying rocksDB, or from the caching layer access?&lt;/p&gt;</comment>
                            <comment id="16780115" author="jonathanpdx" created="Thu, 28 Feb 2019 05:23:25 +0000"  >&lt;blockquote&gt;&lt;p&gt;1) when you profile on latest trunk did you see the same pattern as observed in&#160;&lt;a href=&quot;https://i.imgur.com/IHxC2cZ.png&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://i.imgur.com/IHxC2cZ.png&lt;/a&gt;&#160;as well as in the trace logging compared with 0.10.2.x?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;The image you linked is actually for 0.10.2.x, which is our current deployment. It shows us gated by RocksDB, but that&apos;s actually &lt;b&gt;faster&lt;/b&gt; than what we saw in 0.11.0.0, the recent trunk, or the test I just ran against 2.2.0-rc0:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://i.imgur.com/L6PWIEF.png&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://i.imgur.com/L6PWIEF.png&lt;/a&gt;&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;2) practically the lookups in the caching layer is very cheap and hence even increased a lot it should not contribute to much overhead, whereas the fetches on the underlying store would be much more expensive. Could you confirm if the performance bottleneck is from the underlying rocksDB, or from the caching layer access?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;For 2.2.0-rc0, we&apos;re spending the bulk of our time trying to retrieve records from the NamedCache. See:&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12960523/12960523_0.10.2.1-NamedCache.txt&quot; title=&quot;0.10.2.1-NamedCache.txt attached to KAFKA-7652&quot;&gt;0.10.2.1-NamedCache.txt&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12960522/12960522_2.2.0-rc0_b-NamedCache.txt&quot; title=&quot;2.2.0-rc0_b-NamedCache.txt attached to KAFKA-7652&quot;&gt;2.2.0-rc0_b-NamedCache.txt&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;While I agree it seems it should be more performant per retrieval, as you can see from the latest logs, it&apos;s the difference between&#160;1,096,089 (2.2.0-rc0) and&#160;19,245 (0.10.2.1) hits per second to the cache. The two orders of magnitude appear to outweigh whatever performance benefit we&apos;d receive from the caching layer.&#160;&lt;/p&gt;

&lt;p&gt;This is just one of 8 tasks. During their respective runs, the services consumed 8.4M messages (0.10.2.1) with no lag vs&#160;637K messages&#160;(2.2.0-rc0) with considerable lag. I&apos;d be happy to run again with whatever custom logging or configuration you suggest to help further pinpoint the problem.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16781177" author="githubbot" created="Fri, 1 Mar 2019 01:36:25 +0000"  >&lt;p&gt;guozhangwang commented on pull request #6349: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7652&quot; title=&quot;Kafka Streams Session store performance degradation from 0.10.2.2 to 0.11.0.0&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7652&quot;&gt;&lt;del&gt;KAFKA-7652&lt;/del&gt;&lt;/a&gt;: &lt;span class=&quot;error&quot;&gt;&amp;#91;WIP&amp;#93;&lt;/span&gt; Peel off the segmenting layer on session store caching&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/6349&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/6349&lt;/a&gt;&lt;/p&gt;




&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16781178" author="guozhang" created="Fri, 1 Mar 2019 01:37:12 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jonathanpdx&quot; class=&quot;user-hover&quot; rel=&quot;jonathanpdx&quot;&gt;jonathanpdx&lt;/a&gt; The new profiling image is very helpful.&lt;/p&gt;

&lt;p&gt;Could you try out this PR: &lt;a href=&quot;https://github.com/apache/kafka/pull/6349&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/6349&lt;/a&gt; on top of trunk (or 2.2, should work as well) and let me know if it helps?&lt;/p&gt;


&lt;p&gt;Guozhang&lt;/p&gt;</comment>
                            <comment id="16782139" author="jonathanpdx" created="Fri, 1 Mar 2019 21:59:54 +0000"  >&lt;p&gt;That did it! This is really encouraging. Any chance it&apos;ll make it into 2.2.0?&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12960840/12960840_2.3.0-7652-NamedCache.txt&quot; title=&quot;2.3.0-7652-NamedCache.txt attached to KAFKA-7652&quot;&gt;2.3.0-7652-NamedCache.txt&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="16782175" author="guozhang" created="Fri, 1 Mar 2019 22:40:13 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jonathanpdx&quot; class=&quot;user-hover&quot; rel=&quot;jonathanpdx&quot;&gt;jonathanpdx&lt;/a&gt; we are not voting on the 2.2.0 RC1 right now, if it is accepted then 2.2.0 is final and this PR would not be included; if it is cancelled we will see if we can push it into 2.2.0.&lt;/p&gt;

&lt;p&gt;On the other hand, the PR I gave you is a bit hacky as it is just to validate the root cause, and I&apos;d like to have a thorough profiling and see if we should consider this as a general regression fix not only for session store, but also for window stores. We will start the investigation right away, but in the worst case if we cannot get the clean fix into 2.2.0 we will cut out a 2.2.1 release immediately for this purpose as well. At the mean time, I think it is safe for your application to turn off caching since in session-windowed aggregations, as long as your records timestamp is monotonically increasing and there&apos;s little out-of-ordering data, your will keep merging / expanding your sessions as you accepts new data which means that you&apos;d not have too many overwrites on the store that can be de-duplicated &amp;#8211; if you see the downstream traffic increased by a log if caching is not used please let me know, and we can look into that as well.&lt;/p&gt;

&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ableegoldman&quot; class=&quot;user-hover&quot; rel=&quot;ableegoldman&quot;&gt;ableegoldman&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="16793208" author="githubbot" created="Fri, 15 Mar 2019 00:39:19 +0000"  >&lt;p&gt;ableegoldman commented on pull request #6448: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7652&quot; title=&quot;Kafka Streams Session store performance degradation from 0.10.2.2 to 0.11.0.0&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7652&quot;&gt;&lt;del&gt;KAFKA-7652&lt;/del&gt;&lt;/a&gt;: Restrict range of fetch/findSessions in cache&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/6448&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/6448&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Reduce the total key space cache iterators have to search for segmented byte stores by wrapping several single-segment iterators.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16793213" author="ableegoldman" created="Fri, 15 Mar 2019 00:47:40 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jonathanpdx&quot; class=&quot;user-hover&quot; rel=&quot;jonathanpdx&quot;&gt;jonathanpdx&lt;/a&gt;. I&apos;ve been looking into the caching layer more deeply and discussed with Guozhang,&#160;we believe his earlier patch is not&#160;an appropriate fix&#160;so I&#160;have opened a PR that should address this more completely.&lt;/p&gt;

&lt;p&gt;If you could, please&#160;try this out on top of trunk and let me know if it helps/how it compares:&#160;&lt;a href=&quot;https://github.com/apache/kafka/pull/6448&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/6448&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16820588" author="githubbot" created="Wed, 17 Apr 2019 23:42:51 +0000"  >&lt;p&gt;guozhangwang commented on pull request #6448: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7652&quot; title=&quot;Kafka Streams Session store performance degradation from 0.10.2.2 to 0.11.0.0&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7652&quot;&gt;&lt;del&gt;KAFKA-7652&lt;/del&gt;&lt;/a&gt;: Restrict range of fetch/findSessions in cache&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/6448&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/6448&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16821258" author="guozhang" created="Thu, 18 Apr 2019 16:07:54 +0000"  >&lt;p&gt;It should be fixed by the latest PR (details about the performance benchmarks can be found inside the PR).&lt;/p&gt;</comment>
                            <comment id="16850501" author="githubbot" created="Wed, 29 May 2019 04:54:28 +0000"  >&lt;p&gt;guozhangwang commented on pull request #6349: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7652&quot; title=&quot;Kafka Streams Session store performance degradation from 0.10.2.2 to 0.11.0.0&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7652&quot;&gt;&lt;del&gt;KAFKA-7652&lt;/del&gt;&lt;/a&gt;: &lt;span class=&quot;error&quot;&gt;&amp;#91;WIP&amp;#93;&lt;/span&gt; Peel off the segmenting layer on session store caching&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/6349&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/6349&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12960523" name="0.10.2.1-NamedCache.txt" size="2967" author="jonathanpdx" created="Thu, 28 Feb 2019 04:09:48 +0000"/>
                            <attachment id="12960522" name="2.2.0-rc0_b-NamedCache.txt" size="2985" author="jonathanpdx" created="Thu, 28 Feb 2019 04:09:48 +0000"/>
                            <attachment id="12960840" name="2.3.0-7652-NamedCache.txt" size="3164" author="jonathanpdx" created="Fri, 1 Mar 2019 21:58:05 +0000"/>
                            <attachment id="12948607" name="kafka_10_2_1_flushes.txt" size="4826" author="jonathanpdx" created="Sat, 17 Nov 2018 19:24:10 +0000"/>
                            <attachment id="12948608" name="kafka_11_0_3_flushes.txt" size="4885" author="jonathanpdx" created="Sat, 17 Nov 2018 19:24:10 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 24 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|s00m54:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>