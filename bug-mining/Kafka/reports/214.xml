<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:37:26 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-734] Migration tool needs a revamp, it was poorly written and has many performance bugs</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-734</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Migration tool has a number of problems ranging from poor logging to poor design. This needs to be thought through again&lt;/p&gt;</description>
                <environment></environment>
        <key id="12629185">KAFKA-734</key>
            <summary>Migration tool needs a revamp, it was poorly written and has many performance bugs</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="nehanarkhede">Neha Narkhede</assignee>
                                    <reporter username="nehanarkhede">Neha Narkhede</reporter>
                        <labels>
                            <label>p1</label>
                    </labels>
                <created>Thu, 24 Jan 2013 23:32:41 +0000</created>
                <updated>Sun, 24 Feb 2013 22:30:06 +0000</updated>
                            <resolved>Sun, 24 Feb 2013 22:30:02 +0000</resolved>
                                    <version>0.8.0</version>
                                                    <component>tools</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13564845" author="nehanarkhede" created="Mon, 28 Jan 2013 23:35:38 +0000"  >&lt;p&gt;Few changes to the migration tool -&lt;/p&gt;

&lt;p&gt;1. Do not share the list of producers amongst all the consumer threads. Since every consumer thread used the circular iterator over the same ordered list of producers, they spent most of their time locking the producer queues. This is fixed by partitioning the list of producers amongst the consumer threads. Intuitively, it seems that it is enough to have one consumer thread use on producer, but since the producer spends a significant amount of time waiting for an ack from the broker, it is useful to have multiple producers per consumer thread on the migration tool. &lt;br/&gt;
2. There was a debug statement that was unprotected in the MigrationThread that caused the thread to spent time blocked on log4j. &lt;br/&gt;
3. There is still another problem that is not related directly to the migration tool, but is a problem with the rebalancing logic in the consumer for wildcard subscription. I tried firing up 2 migration tool instances, each with 32 consumer threads to migrate ~300 topics, most of which had 1 partition. Since the rebalancing logic is per topic, it causes the 1st migration tool to take almost all of the load. This is a bug in the rebalancing logic which disallows us from horizontally scaling out consumption in the presence of multiple topics, each with a small number of partitions. Will file another bug to track this.&lt;/p&gt;</comment>
                            <comment id="13564995" author="junrao" created="Tue, 29 Jan 2013 02:15:25 +0000"  >&lt;p&gt;Thanks for the patch. Some comments:&lt;/p&gt;

&lt;p&gt;1. Utils.partition(): It&apos;s probably better to move this method to MigrationTool since it&apos;s customized for its use case. Also, it would be great if we can add some examples of how this method works.&lt;/p&gt;

&lt;p&gt;2. Producer: asyncProducerID is no longer used.&lt;/p&gt;</comment>
                            <comment id="13565582" author="nehanarkhede" created="Tue, 29 Jan 2013 17:48:53 +0000"  >&lt;p&gt;Thanks for the review, Jun!&lt;/p&gt;

&lt;p&gt;1. Moved it to the migration tool. However, didn&apos;t find a good place to stick the unit test. So left it in utils test, let me know if you can think of a better place.&lt;br/&gt;
2. Removed.&lt;/p&gt;</comment>
                            <comment id="13568900" author="nehanarkhede" created="Fri, 1 Feb 2013 17:32:37 +0000"  >&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;KafkaMigrationTool&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Simplified the partitioning logic of the producers and changed partitionProducers to return a list of producer ids per consumer&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;UtilsTest&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Added a unit test for the partitioning logic for the producers, that covers all the cases -&lt;br/&gt;
producers = consumers&lt;br/&gt;
producers &amp;lt; consumers&lt;br/&gt;
producers &amp;gt; consumers&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Tested this on a backlog of roughly 100s of GB. Prior to the changes, a migration tool couldn&apos;t keep up with production traffic. After applying this patch, it performs well, catches up and can keep up as well&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13574271" author="nehanarkhede" created="Fri, 8 Feb 2013 05:42:46 +0000"  >&lt;p&gt;More improvements to migration tool -&lt;/p&gt;

&lt;p&gt;1. Added a shutdown hook and shutdown logic&lt;/p&gt;

&lt;p&gt;2. Changed the design of migration tool as per Jun&apos;s suggestion. Basically, it looks more like the request channel idea from the socket server. The migration threads are consumers that add to a common producer channel. The producer threads pull from the common channel and send data across. This ensures that if one of the producers slow down, the data keeps flowing through rest of the producers.&lt;/p&gt;

&lt;p&gt;3. Didn&apos;t get a chance to test this on a large workload, there might be bugs.&lt;/p&gt;</comment>
                            <comment id="13574273" author="nehanarkhede" created="Fri, 8 Feb 2013 05:43:33 +0000"  >&lt;p&gt;Few problems that are not solved yet -&lt;/p&gt;

&lt;p&gt;1. If consumer threads shutdown on their own, there is no way to shutdown the entire tool&lt;br/&gt;
2. If producer threads shutdown, there is no way to shutdown the entire tool&lt;/p&gt;</comment>
                            <comment id="13579438" author="jfung" created="Fri, 15 Feb 2013 19:26:41 +0000"  >&lt;ul&gt;
	&lt;li&gt;
	&lt;ul&gt;
		&lt;li&gt;Tried the latest patch v4 and got the following FATAL error:&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;2013-02-15 17:36:01,324&amp;#93;&lt;/span&gt; INFO Property queue.enqueue.timeout.ms is overridden to -1 (kafka.utils.VerifiableProperties)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2013-02-15 17:36:01,358&amp;#93;&lt;/span&gt; ERROR Kafka migration tool failed:  (kafka.tools.KafkaMigrationTool)&lt;br/&gt;
java.lang.IllegalArgumentException: Topic cannot be null.&lt;br/&gt;
        at kafka.producer.KeyedMessage.&amp;lt;init&amp;gt;(KeyedMessage.scala:25)&lt;br/&gt;
        at kafka.tools.KafkaMigrationTool$ProducerThread.&amp;lt;init&amp;gt;(KafkaMigrationTool.java:349)&lt;br/&gt;
        at kafka.tools.KafkaMigrationTool.main(KafkaMigrationTool.java:236)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2013-02-15 17:36:01,359&amp;#93;&lt;/span&gt; FATAL Migration thread failure due to  (kafka.tools.KafkaMigrationTool$MigrationThread)&lt;br/&gt;
java.lang.reflect.InvocationTargetException&lt;br/&gt;
        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)&lt;br/&gt;
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)&lt;br/&gt;
        at java.lang.reflect.Method.invoke(Method.java:597)&lt;br/&gt;
        at kafka.tools.KafkaMigrationTool$MigrationThread.run(KafkaMigrationTool.java:310)&lt;br/&gt;
Caused by: java.lang.InterruptedException&lt;br/&gt;
        at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.reportInterruptAfterWait(AbstractQueuedSynchronizer.java:1961)&lt;br/&gt;
        at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:1996)&lt;br/&gt;
        at java.util.concurrent.LinkedBlockingQueue.take(LinkedBlockingQueue.java:399)&lt;br/&gt;
        at kafka.consumer.ConsumerIterator.makeNext(ConsumerIterator.scala:60)&lt;br/&gt;
        at kafka.consumer.ConsumerIterator.makeNext(ConsumerIterator.scala:32)&lt;br/&gt;
        at kafka.utils.IteratorTemplate.maybeComputeNext(IteratorTemplate.scala:59)&lt;br/&gt;
        at kafka.utils.IteratorTemplate.hasNext(IteratorTemplate.scala:51)&lt;br/&gt;
        ... 5 more&lt;/p&gt;</comment>
                            <comment id="13584803" author="nehanarkhede" created="Fri, 22 Feb 2013 23:15:00 +0000"  >&lt;p&gt;Fixed 2 bugs -&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The shutdown message does not have a null topic anymore&lt;/li&gt;
	&lt;li&gt;I was initially shutting down the migration and producer threads in the finally block at the end of the main method, which is pretty stupid of me. Fixed that&lt;/li&gt;
	&lt;li&gt;Caught InvocationTargetException so that we log the root cause. Otherwise java only throws the invocationtargetexception&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13585201" author="junrao" created="Sat, 23 Feb 2013 19:41:29 +0000"  >&lt;p&gt;Thanks for patch v5. Just some minor comments. Once they are addressed, the patch can be checked in.&lt;/p&gt;

&lt;p&gt;50. KafkaMigrationTool:&lt;br/&gt;
50.1 Should client.id for producer be set to the client.id in the producer property + the producer thread id?&lt;br/&gt;
50.2 In the shutdown hook, we need to call consumerConnector_07.shutdown first.&lt;br/&gt;
50.3 In MigrationThread, we don&apos;t need isRunning since it&apos;s never used.&lt;br/&gt;
50.4 In the catch clause of main(), it&apos;s probably better to print out the error and stacktrace, in addition to the logging in log4j. This way, if people forget to set log4j properly, they can still see why the tool failed.&lt;br/&gt;
50.5 At the end of shutdown hook, it&apos;s probably useful to print out sth like &quot;migration tool shuts down successfully&quot;.&lt;/p&gt;


</comment>
                            <comment id="13585516" author="nehanarkhede" created="Sun, 24 Feb 2013 22:30:02 +0000"  >&lt;p&gt;isRunning is required. Other that, incorporated other changes and fixed a producer thread shutdown bug&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12566851" name="kafka-734-v1.patch" size="20994" author="nehanarkhede" created="Mon, 28 Jan 2013 23:35:38 +0000"/>
                            <attachment id="12567013" name="kafka-734-v2.patch" size="23337" author="nehanarkhede" created="Tue, 29 Jan 2013 17:48:53 +0000"/>
                            <attachment id="12567608" name="kafka-734-v3.patch" size="24167" author="nehanarkhede" created="Fri, 1 Feb 2013 17:32:37 +0000"/>
                            <attachment id="12568535" name="kafka-734-v4.patch" size="27404" author="nehanarkhede" created="Fri, 8 Feb 2013 05:42:46 +0000"/>
                            <attachment id="12570554" name="kafka-734-v5.patch" size="27752" author="nehanarkhede" created="Fri, 22 Feb 2013 23:15:00 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>309029</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 39 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1dyin:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>289689</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>