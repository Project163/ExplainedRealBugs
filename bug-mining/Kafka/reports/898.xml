<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:51:37 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-2978] Topic partition is not sometimes consumed after rebalancing of consumer group</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-2978</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Hi there, we are evaluating Kafka 0.9 to find if it is stable enough and ready for production. We wrote a tool that basically verifies that each produced message is also properly consumed. We found the issue described below while stressing Kafka using this tool.&lt;/p&gt;

&lt;p&gt;Adding more and more consumers to a consumer group may result in unsuccessful rebalancing. Data from one or more partitions are not consumed and are not effectively available to the client application (e.g. for 15 minutes). Situation can be resolved externally by touching the consumer group again (add or remove a consumer) which forces another rebalancing that may or may not be successful.&lt;/p&gt;

&lt;p&gt;Significantly higher CPU utilization was observed in such cases (from about 3% to 17%). The CPU utilization takes place in both the affected consumer and Kafka broker according to htop and profiling using jvisualvm. &lt;/p&gt;

&lt;p&gt;Jvisualvm indicates the issue may be related to &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-2936&quot; title=&quot;Socket server selector can stuck on one send in tight loop.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-2936&quot;&gt;&lt;del&gt;KAFKA-2936&lt;/del&gt;&lt;/a&gt; (see its screenshots in the GitHub repo below), but I&apos;m very unsure. I don&apos;t also know if the issue is in consumer or broker because both are affected and I don&apos;t know Kafka internals.&lt;/p&gt;

&lt;p&gt;The issue is not deterministic but it can be easily reproduced after a few minutes just by executing more and more consumers. More parallelism with multiple CPUs probably gives the issue more chances to appear.&lt;/p&gt;

&lt;p&gt;The tool itself together with very detailed instructions for quite reliable reproduction of the issue and initial analysis are available here:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/avast/kafka-tests&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/avast/kafka-tests&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/avast/kafka-tests/tree/issue1/issues/1_rebalancing&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/avast/kafka-tests/tree/issue1/issues/1_rebalancing&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;Prefer fixed tag &lt;tt&gt;issue1&lt;/tt&gt; to branch &lt;tt&gt;master&lt;/tt&gt; which may change.&lt;/li&gt;
	&lt;li&gt;Note there are also various screenshots of jvisualvm together with full logs from all components of the tool.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;My colleague was able to independently reproduce the issue according to the instructions above. If you have any questions or if you need any help with the tool, just let us know. This issue is blocker for us.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12920802">KAFKA-2978</key>
            <summary>Topic partition is not sometimes consumed after rebalancing of consumer group</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hachikuji">Jason Gustafson</assignee>
                                    <reporter username="turek@avast.com">Michal Turek</reporter>
                        <labels>
                    </labels>
                <created>Thu, 10 Dec 2015 16:01:03 +0000</created>
                <updated>Mon, 14 Dec 2015 22:54:46 +0000</updated>
                            <resolved>Mon, 14 Dec 2015 22:54:46 +0000</resolved>
                                    <version>0.9.0.0</version>
                                    <fixVersion>0.9.0.1</fixVersion>
                                    <component>consumer</component>
                    <component>core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15051185" author="ijuma" created="Thu, 10 Dec 2015 16:28:47 +0000"  >&lt;p&gt;Thanks for the report Michal. Is there any chance you could test the latest code in the 0.9.0 branch instead of the 0.9.0.0 release? The branch contains a number of important fixes that were found and fixed after the release (and will be included in 0.9.0.1).&lt;/p&gt;</comment>
                            <comment id="15051193" author="turek@avast.com" created="Thu, 10 Dec 2015 16:31:16 +0000"  >&lt;p&gt;Sure, I will try that and let you know the results.&lt;/p&gt;</comment>
                            <comment id="15051205" author="ijuma" created="Thu, 10 Dec 2015 16:38:54 +0000"  >&lt;p&gt;Thanks! cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hachikuji&quot; class=&quot;user-hover&quot; rel=&quot;hachikuji&quot;&gt;hachikuji&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15051313" author="turek@avast.com" created="Thu, 10 Dec 2015 17:36:21 +0000"  >&lt;p&gt;Ismael, I afraid I have reproduced the issue using code from the 0.9.0 branch, the behavior is exactly the same as with official 0.9.0.0 release. The following is just for repeatability...&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;git pull https://github.com/apache/kafka.git
cd kafka
git checkout 0.9.0

git log | head -n3
commit a5fa661227b0b0b7da86b10b48e94bfb87d0b71d
Author: Edward Ribeiro &amp;lt;edward.ribeiro@gmail.com&amp;gt;
Date:   Wed Dec 9 20:34:09 2015 -0800

gradle
./gradlew clean
./gradlew releaseTarGz -x signArchives
# ./core/build/distributions/kafka_2.10-0.9.0.0.tgz

# Install the JARs locally to ~/.m2/repository/...
mvn install:install-file -Dfile=clients/build/libs/kafka-clients-0.9.0.0.jar -DgroupId=org.apache.kafka -DartifactId=kafka-clients -Dversion=0.9.0.0-localbuild -Dpackaging=jar
mvn install:install-file -Dfile=clients/build/libs/kafka-clients-0.9.0.0-sources.jar -DgroupId=org.apache.kafka -DartifactId=kafka-clients -Dversion=0.9.0.0-localbuild -Dclassifier=sources -Dpackaging=jar
mvn install:install-file -Dfile=clients/build/libs/kafka-clients-0.9.0.0-javadoc.jar -DgroupId=org.apache.kafka -DartifactId=kafka-clients -Dversion=0.9.0.0-localbuild -Dclassifier=javadoc -Dpackaging=jar

        &amp;lt;dependency&amp;gt;
            &amp;lt;groupId&amp;gt;org.apache.kafka&amp;lt;/groupId&amp;gt;
            &amp;lt;artifactId&amp;gt;kafka-clients&amp;lt;/artifactId&amp;gt;
            &amp;lt;version&amp;gt;0.9.0.0-localbuild&amp;lt;/version&amp;gt;
        &amp;lt;/dependency&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15051330" author="ijuma" created="Thu, 10 Dec 2015 17:46:03 +0000"  >&lt;p&gt;Thanks for checking Michal.&lt;/p&gt;</comment>
                            <comment id="15051461" author="hachikuji" created="Thu, 10 Dec 2015 18:56:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=turek%40avast.com&quot; class=&quot;user-hover&quot; rel=&quot;turek@avast.com&quot;&gt;turek@avast.com&lt;/a&gt; Thanks for the report. I&apos;ll assign this to myself and take a look. Out of curiosity, how large were the groups generally before you started seeing this problem?&lt;/p&gt;</comment>
                            <comment id="15051764" author="hachikuji" created="Thu, 10 Dec 2015 22:26:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=turek%40avast.com&quot; class=&quot;user-hover&quot; rel=&quot;turek@avast.com&quot;&gt;turek@avast.com&lt;/a&gt; I was able to reproduce this on the 0.9.0 branch (the detailed instructions are really helpful by the way). Interestingly, I tried several runs against trunk and could not reproduce. Would you mind trying against trunk as well? &lt;/p&gt;</comment>
                            <comment id="15051920" author="hachikuji" created="Fri, 11 Dec 2015 00:41:14 +0000"  >&lt;p&gt;I think I see what&apos;s going on and the problem will affect trunk just as well. There is a window when a rebalance completes where a pending fetch can cause the consumed position to get out of sync with the fetched position. Here&apos;s the sequence:&lt;/p&gt;

&lt;p&gt;1. Fetch is sent at offset 0: (fetched: 0, consumed: 0)&lt;br/&gt;
2. Rebalance is triggered: (fetched: 0, consumed: 0)&lt;br/&gt;
3. Fetch returns and is buffered. We set the next fetch position: (fetched: 25, consumed: 0)&lt;br/&gt;
4. Rebalance finishes and all offsets are reset: (fetched: 0, consumed: 0)&lt;br/&gt;
5. Buffered fetch is returned to the user and we update the consumed position: (fetched: 0, consumed: 25)&lt;/p&gt;

&lt;p&gt;This can only happen if we get assigned the same partition in the rebalance. But when it does happen, we stop fetching against that partition since fetches are only sent if the fetched position matches the consumed position. This should be straightforward to fix, but I want to check if there are any other implications of a pending fetch which we haven&apos;t considered.&lt;/p&gt;</comment>
                            <comment id="15052087" author="guozhang" created="Fri, 11 Dec 2015 03:19:09 +0000"  >&lt;p&gt;Thanks for the investigation, this makes sense.&lt;/p&gt;</comment>
                            <comment id="15052149" author="githubbot" created="Fri, 11 Dec 2015 04:32:52 +0000"  >&lt;p&gt;GitHub user hachikuji opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/666&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/666&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-2978&quot; title=&quot;Topic partition is not sometimes consumed after rebalancing of consumer group&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-2978&quot;&gt;&lt;del&gt;KAFKA-2978&lt;/del&gt;&lt;/a&gt;: consumer stops fetching when consumed and fetch positions get out of sync&lt;/p&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/hachikuji/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/hachikuji/kafka&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-2978&quot; title=&quot;Topic partition is not sometimes consumed after rebalancing of consumer group&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-2978&quot;&gt;&lt;del&gt;KAFKA-2978&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/666.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/666.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #666&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 8a441def79cc8fa21da97759068c0caf7b7b425a&lt;br/&gt;
Author: Jason Gustafson &amp;lt;jason@confluent.io&amp;gt;&lt;br/&gt;
Date:   2015-12-11T04:30:43Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-2978&quot; title=&quot;Topic partition is not sometimes consumed after rebalancing of consumer group&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-2978&quot;&gt;&lt;del&gt;KAFKA-2978&lt;/del&gt;&lt;/a&gt;: consumer stops fetching when consumed and fetch positions get out of sync&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15052777" author="turek@avast.com" created="Fri, 11 Dec 2015 13:48:24 +0000"  >&lt;p&gt;Jason, I have just tried to break the updated consumer code from your &lt;a href=&quot;https://github.com/hachikuji/kafka/tree/KAFKA-2978&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/hachikuji/kafka/tree/KAFKA-2978&lt;/a&gt; repository and all my tests passed. The testing took about one hour and more than 1 million of messages were produced and properly consumed by both consumer groups. I have started and stopped consumers and producers many times, there was no unexpected delay in message flow. I believe your changes fix the bug, great work, thank you!&lt;/p&gt;

&lt;p&gt;Do you have any idea when will be 0.9.0.1 ready and released?&lt;/p&gt;</comment>
                            <comment id="15053206" author="hachikuji" created="Fri, 11 Dec 2015 18:53:40 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=turek%40avast.com&quot; class=&quot;user-hover&quot; rel=&quot;turek@avast.com&quot;&gt;turek@avast.com&lt;/a&gt; Thanks for confirming that the fix worked. I&apos;m not sure about the release timeline for 0.9.0.1, but my guess is that they&apos;ll probably give it a few more weeks to shake out any other critical bugs. What do you think, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="15056886" author="githubbot" created="Mon, 14 Dec 2015 22:54:43 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/666&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/666&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15056887" author="guozhang" created="Mon, 14 Dec 2015 22:54:46 +0000"  >&lt;p&gt;Issue resolved by pull request 666&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/kafka/pull/666&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/666&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12917796">KAFKA-2936</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10431"><![CDATA[Important]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 49 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2pq3b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>guozhang</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>