<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:28:31 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-13128] Flaky Test StoreQueryIntegrationTest.shouldQueryStoresAfterAddingAndRemovingStreamThread</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-13128</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;h3&gt;&lt;a name=&quot;Stacktrace&quot;&gt;&lt;/a&gt;Stacktrace&lt;/h3&gt;

&lt;p&gt;java.lang.AssertionError: Expected: is not null but: was null &lt;br/&gt;
&#160; at org.hamcrest.MatcherAssert.assertThat(MatcherAssert.java:20) &lt;br/&gt;
&#160; at org.hamcrest.MatcherAssert.assertThat(MatcherAssert.java:6)&lt;br/&gt;
&#160; at org.apache.kafka.streams.integration.StoreQueryIntegrationTest.lambda$shouldQueryStoresAfterAddingAndRemovingStreamThread$19(StoreQueryIntegrationTest.java:461)&lt;br/&gt;
&#160; at org.apache.kafka.streams.integration.StoreQueryIntegrationTest.until(StoreQueryIntegrationTest.java:506)&lt;br/&gt;
&#160; at org.apache.kafka.streams.integration.StoreQueryIntegrationTest.shouldQueryStoresAfterAddingAndRemovingStreamThread(StoreQueryIntegrationTest.java:455)&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://ci-builds.apache.org/job/Kafka/job/kafka-pr/job/PR-11085/5/testReport/org.apache.kafka.streams.integration/StoreQueryIntegrationTest/Build___JDK_16_and_Scala_2_13___shouldQueryStoresAfterAddingAndRemovingStreamThread_2/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci-builds.apache.org/job/Kafka/job/kafka-pr/job/PR-11085/5/testReport/org.apache.kafka.streams.integration/StoreQueryIntegrationTest/Build___JDK_16_and_Scala_2_13___shouldQueryStoresAfterAddingAndRemovingStreamThread_2/&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13391453">KAFKA-13128</key>
            <summary>Flaky Test StoreQueryIntegrationTest.shouldQueryStoresAfterAddingAndRemovingStreamThread</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="ableegoldman">A. Sophie Blee-Goldman</reporter>
                        <labels>
                            <label>flaky-test</label>
                    </labels>
                <created>Fri, 23 Jul 2021 01:27:24 +0000</created>
                <updated>Wed, 5 Jul 2023 14:51:44 +0000</updated>
                            <resolved>Thu, 24 Mar 2022 14:34:26 +0000</resolved>
                                    <version>2.8.1</version>
                    <version>3.0.0</version>
                                    <fixVersion>3.2.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17385841" author="ableegoldman" created="Fri, 23 Jul 2021 01:48:41 +0000"  >&lt;p&gt;The failure is from the second line in this series of assertions&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
assertThat(store1.get(key), is(notNullValue()));
assertThat(store1.get(key2), is(notNullValue()));
assertThat(store1.get(key3), is(notNullValue()));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;which is basically the first time we attempt IQ after starting up. The test setup includes starting Streams and waiting for it to reach RUNNING, then adding a new thread, and finally producing a set of 100 records for each of the three keys. After that it waits for all records to be processed&#160;&lt;b&gt;for &lt;em&gt;key3&lt;/em&gt;&lt;/b&gt; and then proceeds to the above assertions.&lt;/p&gt;

&lt;p&gt;I suspect the problem is that we only wait for all data to be processed for&#160;&lt;em&gt;key3&lt;/em&gt;, but not the other two keys. In theory this should work, since the data for&#160;&lt;em&gt;key3&lt;/em&gt; is produced last and would have the largest timestamps meaning the keys should be processed more or less in order. However the input topic actually has two partitions, so it could be that&#160;&lt;em&gt;key1&lt;/em&gt; and&#160;&lt;em&gt;key3&lt;/em&gt; correspond to task 1 while&#160;&lt;em&gt;key2&lt;/em&gt; corresponds to task 2. Again, that shouldn&apos;t affect the order in which records are processed&#160;&#8211; as long as the tasks are on the same thread.&lt;/p&gt;

&lt;p&gt;But we started up a new thread in between waiting for Streams to reach RUNNING and producing data to the input topics. This new thread has to be assigned one of the tasks, but due to cooperative rebalancing it will take two full (though short) rebalances before the new thread can actually start processing any tasks. Therefore as long as the original thread continues to own the task corresponding to&#160;&lt;em&gt;key3&lt;/em&gt; after the new thread is added, it can easily get through all records for&#160;&lt;em&gt;key3&lt;/em&gt;. Which would mean the test can proceed to the above assertions while the new thread is still waiting to start processing any data for&#160;&lt;em&gt;key2&lt;/em&gt; at all.&lt;/p&gt;

&lt;p&gt;There are a few ways we can address this given how many things had to happen exactly right in order to see this failure, but the simplest fix is to just wait on all three keys to be fully processed rather than just the one. This seems to align with the original intention of the test best as well&lt;/p&gt;</comment>
                            <comment id="17394546" author="ableegoldman" created="Fri, 6 Aug 2021 06:25:53 +0000"  >&lt;p&gt;Failed again for a different reason &#8211; just flaky, seems we need to wait for the thread to fully start up&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;{{java.lang.AssertionError: Unexpected exception thrown while getting the value from store.&lt;br/&gt;
Expected: is (a string containing &quot;Cannot get state store source-table because the stream thread is PARTITIONS_ASSIGNED, not RUNNING&quot; or a string containing &quot;The state store, source-table, may have migrated to another instance&quot;)&lt;br/&gt;
     but: was &quot;Cannot get state store source-table because the stream thread is STARTING, not RUNNING&quot;}}&lt;/p&gt;</comment>
                            <comment id="17396062" author="wcarlson5" created="Mon, 9 Aug 2021 14:02:29 +0000"  >&lt;p&gt;I fixed the second failure in this PR a little bit ago&#160;&lt;a href=&quot;https://github.com/apache/kafka/pull/11153&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/11153&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17411902" author="jlprat" created="Wed, 8 Sep 2021 12:43:08 +0000"  >&lt;p&gt;Sorry to reopen this issue, it just occurred in this PR &lt;a href=&quot;https://github.com/apache/kafka/pull/11302&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/11302&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;It&apos;s a different error though:&lt;/p&gt;

&lt;p&gt;{{}}&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.AssertionError: Unexpected exception thrown &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; getting the value from store.
Expected: is (a string containing &lt;span class=&quot;code-quote&quot;&gt;&quot;Cannot get state store source-table because the stream thread is PARTITIONS_ASSIGNED, not RUNNING&quot;&lt;/span&gt; or a string containing &lt;span class=&quot;code-quote&quot;&gt;&quot;The state store, source-table, may have migrated to another instance&quot;&lt;/span&gt; or a string containing &lt;span class=&quot;code-quote&quot;&gt;&quot;Cannot get state store source-table because the stream thread is STARTING, not RUNNING&quot;&lt;/span&gt;)
&#160; but: was &lt;span class=&quot;code-quote&quot;&gt;&quot;Cannot get state store source-table because the stream thread is PARTITIONS_REVOKED, not RUNNING&quot;&lt;/span&gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;a href=&quot;https://ci-builds.apache.org/job/Kafka/job/kafka-pr/job/PR-11302/3/testReport/junit/org.apache.kafka.streams.integration/StoreQueryIntegrationTest/Build___JDK_8_and_Scala_2_12___shouldQueryStoresAfterAddingAndRemovingStreamThread/?cloudbees-analytics-link=scm-reporting%2Ftests%2Ffailed&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci-builds.apache.org/job/Kafka/job/kafka-pr/job/PR-11302/3/testReport/junit/org.apache.kafka.streams.integration/StoreQueryIntegrationTest/Build___JDK_8_and_Scala_2_12___shouldQueryStoresAfterAddingAndRemovingStreamThread/?cloudbees-analytics-link=scm-reporting%2Ftests%2Ffailed&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Let me know if I should have opened a new issue instead of reopening this one.&lt;/p&gt;

&lt;p&gt;{{}}&lt;/p&gt;</comment>
                            <comment id="17413135" author="cadonna" created="Fri, 10 Sep 2021 11:52:55 +0000"  >&lt;p&gt;And also here:&lt;br/&gt;
&lt;a href=&quot;https://ci-builds.apache.org/job/Kafka/job/kafka-pr/job/PR-11250/9/testReport/junit/org.apache.kafka.streams.integration/StoreQueryIntegrationTest/Build___JDK_11_and_Scala_2_13___shouldQueryStoresAfterAddingAndRemovingStreamThread/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci-builds.apache.org/job/Kafka/job/kafka-pr/job/PR-11250/9/testReport/junit/org.apache.kafka.streams.integration/StoreQueryIntegrationTest/Build___JDK_11_and_Scala_2_13___shouldQueryStoresAfterAddingAndRemovingStreamThread/&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.AssertionError: 
Expected: is not &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
 but: was &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
 at org.hamcrest.MatcherAssert.assertThat(MatcherAssert.java:20)
 at org.hamcrest.MatcherAssert.assertThat(MatcherAssert.java:6)
 at org.apache.kafka.streams.integration.StoreQueryIntegrationTest.lambda$shouldQueryStoresAfterAddingAndRemovingStreamThread$15(StoreQueryIntegrationTest.java:494)
 at org.apache.kafka.streams.integration.StoreQueryIntegrationTest.until(StoreQueryIntegrationTest.java:545)
 at org.apache.kafka.streams.integration.StoreQueryIntegrationTest.shouldQueryStoresAfterAddingAndRemovingStreamThread(StoreQueryIntegrationTest.java:488)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17444226" author="ableegoldman" created="Tue, 16 Nov 2021 02:17:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wcarlson5&quot; class=&quot;user-hover&quot; rel=&quot;wcarlson5&quot;&gt;wcarlson5&lt;/a&gt;&#160; unassigning you in case someone else wants to pick this up and fix the remaining source(s?) of failure&lt;/p&gt;</comment>
                            <comment id="17448496" author="jlprat" created="Wed, 24 Nov 2021 10:21:09 +0000"  >&lt;p&gt;It might be that &lt;a href=&quot;https://github.com/apache/kafka/pull/11334&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/11334&lt;/a&gt; fixed this flaky test&lt;/p&gt;</comment>
                            <comment id="17511841" author="cadonna" created="Thu, 24 Mar 2022 12:50:57 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wcarlson5&quot; class=&quot;user-hover&quot; rel=&quot;wcarlson5&quot;&gt;wcarlson5&lt;/a&gt; Do you think we can close this ticket?&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 33 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0t99k:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>