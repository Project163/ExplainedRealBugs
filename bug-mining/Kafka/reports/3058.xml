<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:28:30 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-9203] kafka-client 2.3.1 fails to consume lz4 compressed topic</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-9203</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;I run kafka cluster 2.1.1&lt;/p&gt;

&lt;p&gt;when I upgraded the consumer app to use kafka-client 2.3.0 (or 2.3.1) instead of 2.2.0, I immediately started getting the following exceptions in a loop when consuming a topic with LZ4-compressed messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2019-11-18 11:59:16.888 ERROR [afka-consumer-thread] &#160;&#160;&#160;&#160;com.avast.utils2.kafka.consumer.ConsumerThread: Unexpected exception occurred while polling and processing messages: org.apache.kafka.common.KafkaExce
ption: Received exception when fetching the next record from FILEREP_LONER_REQUEST-4. If needed, please seek past the record to continue consumption. 
org.apache.kafka.common.KafkaException: Received exception when fetching the next record from FILEREP_LONER_REQUEST-4. If needed, please seek past the record to continue consumption. 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at org.apache.kafka.clients.consumer.internals.Fetcher$PartitionRecords.fetchRecords(Fetcher.java:1473) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at org.apache.kafka.clients.consumer.internals.Fetcher$PartitionRecords.access$1600(Fetcher.java:1332) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at org.apache.kafka.clients.consumer.internals.Fetcher.fetchRecords(Fetcher.java:645) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at org.apache.kafka.clients.consumer.internals.Fetcher.fetchedRecords(Fetcher.java:606) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at org.apache.kafka.clients.consumer.KafkaConsumer.pollForFetches(KafkaConsumer.java:1263) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at org.apache.kafka.clients.consumer.KafkaConsumer.poll(KafkaConsumer.java:1225) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at org.apache.kafka.clients.consumer.KafkaConsumer.poll(KafkaConsumer.java:1201) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at com.avast.utils2.kafka.consumer.ConsumerThread.pollAndProcessMessagesFromKafka(ConsumerThread.java:180) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at com.avast.utils2.kafka.consumer.ConsumerThread.run(ConsumerThread.java:149) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at com.avast.filerep.saver.RequestSaver$.$anonfun$main$8(RequestSaver.scala:28) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at com.avast.filerep.saver.RequestSaver$.$anonfun$main$8$adapted(RequestSaver.scala:19) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at resource.AbstractManagedResource.$anonfun$acquireFor$1(AbstractManagedResource.scala:88) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at scala.util.control.Exception$Catch.$anonfun$either$1(Exception.scala:252) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at scala.util.control.Exception$Catch.apply(Exception.scala:228) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at scala.util.control.Exception$Catch.either(Exception.scala:252) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at resource.AbstractManagedResource.acquireFor(AbstractManagedResource.scala:88) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at resource.ManagedResourceOperations.apply(ManagedResourceOperations.scala:26) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at resource.ManagedResourceOperations.apply$(ManagedResourceOperations.scala:26) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at resource.AbstractManagedResource.apply(AbstractManagedResource.scala:50) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at resource.ManagedResourceOperations.acquireAndGet(ManagedResourceOperations.scala:25) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at resource.ManagedResourceOperations.acquireAndGet$(ManagedResourceOperations.scala:25) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at resource.AbstractManagedResource.acquireAndGet(AbstractManagedResource.scala:50) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at resource.ManagedResourceOperations.foreach(ManagedResourceOperations.scala:53) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at resource.ManagedResourceOperations.foreach$(ManagedResourceOperations.scala:53) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at resource.AbstractManagedResource.foreach(AbstractManagedResource.scala:50) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at com.avast.filerep.saver.RequestSaver$.$anonfun$main$6(RequestSaver.scala:19) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at com.avast.filerep.saver.RequestSaver$.$anonfun$main$6$adapted(RequestSaver.scala:18) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at resource.AbstractManagedResource.$anonfun$acquireFor$1(AbstractManagedResource.scala:88) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at scala.util.control.Exception$Catch.$anonfun$either$1(Exception.scala:252) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at scala.util.control.Exception$Catch.apply(Exception.scala:228) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at scala.util.control.Exception$Catch.either(Exception.scala:252) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at resource.AbstractManagedResource.acquireFor(AbstractManagedResource.scala:88) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at resource.ManagedResourceOperations.apply(ManagedResourceOperations.scala:26) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at resource.ManagedResourceOperations.apply$(ManagedResourceOperations.scala:26) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at resource.AbstractManagedResource.apply(AbstractManagedResource.scala:50) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at resource.ManagedResourceOperations.acquireAndGet(ManagedResourceOperations.scala:25) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at resource.ManagedResourceOperations.acquireAndGet$(ManagedResourceOperations.scala:25) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at resource.AbstractManagedResource.acquireAndGet(AbstractManagedResource.scala:50) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at resource.ManagedResourceOperations.foreach(ManagedResourceOperations.scala:53) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at resource.ManagedResourceOperations.foreach$(ManagedResourceOperations.scala:53) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at resource.AbstractManagedResource.foreach(AbstractManagedResource.scala:50) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at com.avast.filerep.saver.RequestSaver$.$anonfun$main$4(RequestSaver.scala:18) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at com.avast.filerep.saver.RequestSaver$.$anonfun$main$4$adapted(RequestSaver.scala:17) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at resource.AbstractManagedResource.$anonfun$acquireFor$1(AbstractManagedResource.scala:88) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at scala.util.control.Exception$Catch.$anonfun$either$1(Exception.scala:252) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at scala.util.control.Exception$Catch.apply(Exception.scala:228) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at scala.util.control.Exception$Catch.either(Exception.scala:252) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at resource.AbstractManagedResource.acquireFor(AbstractManagedResource.scala:88) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at resource.ManagedResourceOperations.apply(ManagedResourceOperations.scala:26) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at resource.ManagedResourceOperations.apply$(ManagedResourceOperations.scala:26) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at resource.AbstractManagedResource.apply(AbstractManagedResource.scala:50) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at resource.ManagedResourceOperations.acquireAndGet(ManagedResourceOperations.scala:25) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at resource.ManagedResourceOperations.acquireAndGet$(ManagedResourceOperations.scala:25) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at resource.AbstractManagedResource.acquireAndGet(AbstractManagedResource.scala:50) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at resource.ManagedResourceOperations.foreach(ManagedResourceOperations.scala:53) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at resource.ManagedResourceOperations.foreach$(ManagedResourceOperations.scala:53) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at resource.AbstractManagedResource.foreach(AbstractManagedResource.scala:50) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at com.avast.filerep.saver.RequestSaver$.$anonfun$main$2(RequestSaver.scala:17) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at com.avast.filerep.saver.RequestSaver$.$anonfun$main$2$adapted(RequestSaver.scala:16) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at resource.AbstractManagedResource.$anonfun$acquireFor$1(AbstractManagedResource.scala:88) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at scala.util.control.Exception$Catch.$anonfun$either$1(Exception.scala:252) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at scala.util.control.Exception$Catch.apply(Exception.scala:228) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at scala.util.control.Exception$Catch.either(Exception.scala:252) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at resource.AbstractManagedResource.acquireFor(AbstractManagedResource.scala:88) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at resource.ManagedResourceOperations.apply(ManagedResourceOperations.scala:26) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at resource.ManagedResourceOperations.apply$(ManagedResourceOperations.scala:26) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at resource.AbstractManagedResource.apply(AbstractManagedResource.scala:50) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at resource.ManagedResourceOperations.acquireAndGet(ManagedResourceOperations.scala:25) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at resource.ManagedResourceOperations.acquireAndGet$(ManagedResourceOperations.scala:25) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at resource.AbstractManagedResource.acquireAndGet(AbstractManagedResource.scala:50) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at resource.ManagedResourceOperations.foreach(ManagedResourceOperations.scala:53) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at resource.ManagedResourceOperations.foreach$(ManagedResourceOperations.scala:53) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at resource.AbstractManagedResource.foreach(AbstractManagedResource.scala:50) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at com.avast.filerep.saver.RequestSaver$.main(RequestSaver.scala:16) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at com.avast.filerep.saver.RequestSaver.main(RequestSaver.scala) 
Caused by: org.apache.kafka.common.KafkaException: java.io.IOException: Stream frame descriptor corrupted 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at org.apache.kafka.common.record.CompressionType$4.wrapForInput(CompressionType.java:113) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at org.apache.kafka.common.record.DefaultRecordBatch.compressedIterator(DefaultRecordBatch.java:257) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at org.apache.kafka.common.record.DefaultRecordBatch.streamingIterator(DefaultRecordBatch.java:335) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at org.apache.kafka.clients.consumer.internals.Fetcher$PartitionRecords.nextFetchedRecord(Fetcher.java:1450) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at org.apache.kafka.clients.consumer.internals.Fetcher$PartitionRecords.fetchRecords(Fetcher.java:1487) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at org.apache.kafka.clients.consumer.internals.Fetcher$PartitionRecords.access$1600(Fetcher.java:1332) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at org.apache.kafka.clients.consumer.internals.Fetcher.fetchRecords(Fetcher.java:645) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at org.apache.kafka.clients.consumer.internals.Fetcher.fetchedRecords(Fetcher.java:606) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at org.apache.kafka.clients.consumer.KafkaConsumer.pollForFetches(KafkaConsumer.java:1294) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;... 70 common frames omitted 
Caused by: java.io.IOException: Stream frame descriptor corrupted 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at org.apache.kafka.common.record.KafkaLZ4BlockInputStream.readHeader(KafkaLZ4BlockInputStream.java:132) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at org.apache.kafka.common.record.KafkaLZ4BlockInputStream.&amp;lt;init&amp;gt;(KafkaLZ4BlockInputStream.java:78) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;at org.apache.kafka.common.record.CompressionType$4.wrapForInput(CompressionType.java:110) 
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;... 78 common frames omitted

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;(the producer app is using kafka client 0.10.2.1)&lt;/p&gt;

&lt;p&gt;I retried with a new consumer group but it didn&apos;t help. Kafka-client downgrade back to 2.2.0 helped. This makes me think LZ4 may be broken in kafka-client 2.3.x&lt;/p&gt;</description>
                <environment></environment>
        <key id="13269046">KAFKA-9203</key>
            <summary>kafka-client 2.3.1 fails to consume lz4 compressed topic</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ijuma">Ismael Juma</assignee>
                                    <reporter username="dwatzke">David Watzke</reporter>
                        <labels>
                    </labels>
                <created>Mon, 18 Nov 2019 11:03:48 +0000</created>
                <updated>Fri, 23 Jul 2021 21:33:28 +0000</updated>
                            <resolved>Tue, 3 Dec 2019 16:27:50 +0000</resolved>
                                    <version>2.3.0</version>
                    <version>2.3.1</version>
                                    <fixVersion>2.3.2</fixVersion>
                    <fixVersion>2.4.0</fixVersion>
                                    <component>compression</component>
                    <component>consumer</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16976693" author="ijuma" created="Mon, 18 Nov 2019 16:47:44 +0000"  >&lt;p&gt;Thanks for the report. We have many tests and workloads running with lz4 and this is the first time I am seeing this issue, so it&apos;s more subtle than &quot;lz4 broken with kafka 2.3&quot;. Do you know which client was used to compress these messages? Was it the Java producer 2.2?&lt;/p&gt;</comment>
                            <comment id="16976701" author="ijuma" created="Mon, 18 Nov 2019 16:57:45 +0000"  >&lt;p&gt;We upgraded lz4-java from 1.5.0 to 1.6.0 in Kafka 2.3. I wonder if that could be the reason:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/lz4/lz4-java/blob/master/CHANGES.md&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/lz4/lz4-java/blob/master/CHANGES.md&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16977373" author="dwatzke" created="Tue, 19 Nov 2019 10:54:48 +0000"  >&lt;p&gt;producer is using kafka client 0.10.2.1&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;updated lz4-java lib does&#160;indeed sound like a very probable cause&lt;/p&gt;</comment>
                            <comment id="16977528" author="ijuma" created="Tue, 19 Nov 2019 14:26:16 +0000"  >&lt;p&gt;Are you able to swap the lz4 jar when when running your app with kafka 2.3 to verify this?&lt;/p&gt;</comment>
                            <comment id="16978217" author="dwatzke" created="Wed, 20 Nov 2019 08:58:46 +0000"  >&lt;p&gt;So I&apos;ve got interesting info for you.&lt;/p&gt;

&lt;p&gt;I redeployed the broken consumer app with kafka-client 2.3.1 and lz4-java 1.6.0 and tried the following combos:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;kafka-client 2.3.1 + lz4-java 1.6.0 = broken&lt;/li&gt;
	&lt;li&gt;kafka-client 2.3.1 + lz4-java 1.5.0 = broken&lt;/li&gt;
	&lt;li&gt;kafka-client 2.2.0 + lz4-java 1.6.0 = works&lt;/li&gt;
	&lt;li&gt;kafka-client 2.2.0 + lz4-java 1.5.0 = works&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Looks like the issue may not be connected to lz4-java lib update after all.&lt;/p&gt;</comment>
                            <comment id="16978406" author="ijuma" created="Wed, 20 Nov 2019 13:12:04 +0000"  >&lt;p&gt;Thanks for testing! The only change in this code was:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/kafka/commit/90043d5f7e1b09a959080c2064f758d5890fc454#diff-eaa7e4414f285da2ff8e4508456078d2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/commit/90043d5f7e1b09a959080c2064f758d5890fc454#diff-eaa7e4414f285da2ff8e4508456078d2&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Are you able to build your own clients jar? If so, you can either revert that change yourself from the 2.3 branch or I can create a branch with the commit reverted.&lt;/p&gt;</comment>
                            <comment id="16978418" author="dwatzke" created="Wed, 20 Nov 2019 13:21:14 +0000"  >&lt;p&gt;It would be most helpful if you could build the jar for me - I could test it out afterwards.&lt;/p&gt;</comment>
                            <comment id="16985448" author="ijuma" created="Sat, 30 Nov 2019 23:11:11 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dwatzke&quot; class=&quot;user-hover&quot; rel=&quot;dwatzke&quot;&gt;dwatzke&lt;/a&gt;&#160;I attached a clients jar build from the following branch:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/ijuma/kafka/commits/kafka-9203-revert-pr-6679&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/ijuma/kafka/commits/kafka-9203-revert-pr-6679&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;It&apos;s apache/kafka/2.3 with &lt;a href=&quot;https://github.com/apache/kafka/commit/90043d5f7e1b09a959080c2064f758d5890fc454#diff-eaa7e4414f285da2ff8e4508456078d2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;90043d5f7e&lt;/a&gt;&#160;reverted.&lt;/p&gt;</comment>
                            <comment id="16986765" author="dwatzke" created="Tue, 3 Dec 2019 09:57:06 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ijuma&quot; class=&quot;user-hover&quot; rel=&quot;ijuma&quot;&gt;ijuma&lt;/a&gt;&#160;Thank you. With the attached clients jar it works fine! So it really is caused by this commit.&lt;/p&gt;</comment>
                            <comment id="16986927" author="githubbot" created="Tue, 3 Dec 2019 14:02:33 +0000"  >&lt;p&gt;ijuma commented on pull request #7769: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-9203&quot; title=&quot;kafka-client 2.3.1 fails to consume lz4 compressed topic&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-9203&quot;&gt;&lt;del&gt;KAFKA-9203&lt;/del&gt;&lt;/a&gt;: Revert &quot;MINOR: Remove workarounds for lz4-java bug affecting byte buffers (#6679)&quot;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/7769&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/7769&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   This reverts commit 90043d5f as it caused a regression in some cases:&lt;/p&gt;

&lt;p&gt;   &amp;gt; Caused by: java.io.IOException: Stream frame descriptor corrupted&lt;br/&gt;
   &amp;gt;         at org.apache.kafka.common.record.KafkaLZ4BlockInputStream.readHeader(KafkaLZ4BlockInputStream.java:132)&lt;br/&gt;
   &amp;gt;         at org.apache.kafka.common.record.KafkaLZ4BlockInputStream.&amp;lt;init&amp;gt;(KafkaLZ4BlockInputStream.java:78)&lt;br/&gt;
   &amp;gt;         at org.apache.kafka.common.record.CompressionType$4.wrapForInput(CompressionType.java:110)&lt;/p&gt;

&lt;p&gt;   I will investigate why after, but I want to get the safe fix into 2.4.0.&lt;br/&gt;
   The reporter of &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-9203&quot; title=&quot;kafka-client 2.3.1 fails to consume lz4 compressed topic&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-9203&quot;&gt;&lt;del&gt;KAFKA-9203&lt;/del&gt;&lt;/a&gt; has verified that reverting this change&lt;br/&gt;
   makes the problem go away.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16986929" author="ijuma" created="Tue, 3 Dec 2019 14:05:56 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dwatzke&quot; class=&quot;user-hover&quot; rel=&quot;dwatzke&quot;&gt;dwatzke&lt;/a&gt;&#160;Thanks for testing! I submitted a PR to revert the change as an immediate step and will try to resubmit the original change after I understand the underlying issue.&lt;/p&gt;</comment>
                            <comment id="16987057" author="githubbot" created="Tue, 3 Dec 2019 16:26:22 +0000"  >&lt;p&gt;ijuma commented on pull request #7769: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-9203&quot; title=&quot;kafka-client 2.3.1 fails to consume lz4 compressed topic&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-9203&quot;&gt;&lt;del&gt;KAFKA-9203&lt;/del&gt;&lt;/a&gt;: Revert &quot;MINOR: Remove workarounds for lz4-java bug affecting byte buffers (#6679)&quot;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/7769&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/7769&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="17125575" author="manthanit" created="Thu, 4 Jun 2020 06:24:06 +0000"  >&lt;p&gt;I know that tickets is resolved but:&lt;/p&gt;

&lt;p&gt;During uplift to 2.3.1 we encountered similar issue. But the issue only happens when we used old version of lz4 1.3 with kafka clients 2.3.1.&lt;/p&gt;

&lt;p&gt;If we use lz4-1.6. with kafka clients 2.3.1 everything works fine.&lt;/p&gt;

&lt;p&gt;So I assume that revert should not be done for 2.3.2 as this is just a dependencies issue on user side.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Also the reporter said that he encounter issue when data sent in with old producer 0.10.x and consumed by new kafka clients 2.3.1.&lt;/p&gt;

&lt;p&gt;But this can&apos;t be true because then it mean that lz4 1.3 and lz4 1.6 produce binary incompatible data.&lt;/p&gt;</comment>
                            <comment id="17126293" author="ijuma" created="Fri, 5 Jun 2020 00:33:33 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=manthanit&quot; class=&quot;user-hover&quot; rel=&quot;manthanit&quot;&gt;manthanit&lt;/a&gt;. Thanks for providing this information. I was personally quite puzzled how the original change caused problems. But I reverted it out of caution since it was a clean-up and I wasn&apos;t sure if there was a bug in the underlying library. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dwatzke&quot; class=&quot;user-hover&quot; rel=&quot;dwatzke&quot;&gt;dwatzke&lt;/a&gt;&#160;Is there any chance you were including multiple versions of lz4 in the classpath by accident?&lt;/p&gt;</comment>
                            <comment id="17290739" author="xvrl" created="Thu, 25 Feb 2021 07:24:55 +0000"  >&lt;p&gt;I submitted a PR that will help detect if we have an older buggy lz4 version on the classpath. This should help prevent these situations and provide a more helpful error message. &lt;a href=&quot;https://github.com/apache/kafka/pull/10196&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/10196&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17386555" author="ijuma" created="Fri, 23 Jul 2021 21:33:28 +0000"  >&lt;p&gt;Merged the PR from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xvrl&quot; class=&quot;user-hover&quot; rel=&quot;xvrl&quot;&gt;xvrl&lt;/a&gt;.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12987228" name="kafka-clients-2.3.2-SNAPSHOT.jar" size="2733355" author="ijuma" created="Sat, 30 Nov 2019 23:07:55 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 16 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z08qkw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>