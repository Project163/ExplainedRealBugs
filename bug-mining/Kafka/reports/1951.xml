<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:12:04 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-6711] GlobalStateManagerImpl should not write offsets of in-memory stores in checkpoint file</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-6711</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;We are using an InMemoryStore along with GlobalKTable and I noticed that after each restart I am losing all my data. When I debug it, `/tmp/kafka-streams/category-client-1/global/.checkpoint` file contains offset for my GlobalKTable topic.&#160;I had checked&#160;GlobalStateManagerImpl implementation and noticed that it is not guarded for cases similar to mine. I am fairly new to Kafka land and probably there might be another way to fix issue.&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13147742">KAFKA-6711</key>
            <summary>GlobalStateManagerImpl should not write offsets of in-memory stores in checkpoint file</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cemo">Cemalettin Ko&#231;</assignee>
                                    <reporter username="cemo">Cemalettin Ko&#231;</reporter>
                        <labels>
                            <label>newbie</label>
                    </labels>
                <created>Sat, 24 Mar 2018 20:26:43 +0000</created>
                <updated>Fri, 24 Aug 2018 00:42:30 +0000</updated>
                            <resolved>Thu, 14 Jun 2018 11:48:15 +0000</resolved>
                                    <version>1.0.1</version>
                                    <fixVersion>0.10.2.2</fixVersion>
                    <fixVersion>0.11.0.3</fixVersion>
                    <fixVersion>1.0.2</fixVersion>
                    <fixVersion>1.1.1</fixVersion>
                    <fixVersion>2.0.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>12</watches>
                                                                                                                <comments>
                            <comment id="16414308" author="guozhang" created="Mon, 26 Mar 2018 18:40:00 +0000"  >&lt;p&gt;Hello &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cemo&quot; class=&quot;user-hover&quot; rel=&quot;cemo&quot;&gt;cemo&lt;/a&gt;, it is by-design that in-memory state stores will not persist any data to the local storage engine upon closing, and hence when restarting it will lose all the data and hence will need to re-bootstrap from the topic again. For normal state stores we are having the check that &lt;tt&gt;if (store.persistent() &amp;amp;&amp;amp; storeToChangelogTopic.containsKey(storeName)) // write checkpoint values&lt;/tt&gt;, but I agree with you that in global store implementation, i.e. &lt;tt&gt;GlobalStateManagerImpl&lt;/tt&gt; we do not have this check, which I think is a bug. I.e. we should do the similar check and hence do not write offsets in the checkpoint file. Would you like to fix this issue?&lt;/p&gt;

&lt;p&gt;As for your own observed issue, we do have a JIRA open for adding the checkpoint feature for in-memory stores so that data will not be lost upon closing: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3184&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-3184&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="16414555" author="cemo" created="Mon, 26 Mar 2018 21:07:14 +0000"  >&lt;p&gt;I will fix &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt;.&#160;&lt;/p&gt;</comment>
                            <comment id="16414569" author="guozhang" created="Mon, 26 Mar 2018 21:09:42 +0000"  >&lt;p&gt;Great! I&apos;ve assigned the ticket to you.&lt;/p&gt;</comment>
                            <comment id="16414673" author="cemo" created="Mon, 26 Mar 2018 22:29:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; Would you please check implementation please:&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/cemo/kafka/commits/b-kafka-6711&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/cemo/kafka/commits/b-kafka-6711&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I have done something preliminary. I will add necessary tests as well after your guidance.&lt;/p&gt;</comment>
                            <comment id="16416164" author="githubbot" created="Tue, 27 Mar 2018 20:08:41 +0000"  >&lt;p&gt;cemo opened a new pull request #4782: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6711&quot; title=&quot;GlobalStateManagerImpl should not write offsets of in-memory stores in checkpoint file&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-6711&quot;&gt;&lt;del&gt;KAFKA-6711&lt;/del&gt;&lt;/a&gt;: GlobalStateManagerImpl should not write offsets of in-mem&#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/4782&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/4782&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   &#8230;ory stores in checkpoint file&lt;/p&gt;

&lt;p&gt;   *More detailed description of your change,&lt;br/&gt;
   if necessary. The PR title and PR message become&lt;br/&gt;
   the squashed commit message, so use a separate&lt;br/&gt;
   comment to ping reviewers.*&lt;/p&gt;

&lt;p&gt;   *Summary of testing strategy (including rationale)&lt;br/&gt;
   for the feature or bug fix. Unit and/or integration&lt;br/&gt;
   tests are expected for any behaviour change and&lt;br/&gt;
   system tests should be considered for larger changes.*&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16416168" author="cemo" created="Tue, 27 Mar 2018 20:11:23 +0000"  >&lt;p&gt;Sorry to open quickly issue &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&#160;Bot polluted issue.&#160;&lt;/p&gt;

&lt;p&gt;Here is the my quick shot to issue. Please not that I am pretty much to new Kafka land. Review twice &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/kafka/pull/4782&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/4782&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16416847" author="githubbot" created="Wed, 28 Mar 2018 05:38:23 +0000"  >&lt;p&gt;cemo closed pull request #4782: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6711&quot; title=&quot;GlobalStateManagerImpl should not write offsets of in-memory stores in checkpoint file&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-6711&quot;&gt;&lt;del&gt;KAFKA-6711&lt;/del&gt;&lt;/a&gt;: GlobalStateManagerImpl should not write offsets of in-mem&#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/4782&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/4782&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStateManagerImpl.java b/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStateManagerImpl.java&lt;br/&gt;
index 56e6bed0850..bd4f67e9de1 100644&lt;br/&gt;
&amp;#8212; a/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStateManagerImpl.java&lt;br/&gt;
+++ b/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStateManagerImpl.java&lt;br/&gt;
@@ -41,6 +41,7 @@&lt;br/&gt;
 import java.util.ArrayList;&lt;br/&gt;
 import java.util.Collection;&lt;br/&gt;
 import java.util.Collections;&lt;br/&gt;
+import java.util.HashMap;&lt;br/&gt;
 import java.util.HashSet;&lt;br/&gt;
 import java.util.List;&lt;br/&gt;
 import java.util.Map;&lt;br/&gt;
@@ -334,10 +335,33 @@ public void close(final Map&amp;lt;TopicPartition, Long&amp;gt; offsets) throws IOException {&lt;/p&gt;

&lt;p&gt;     @Override&lt;br/&gt;
     public void checkpoint(final Map&amp;lt;TopicPartition, Long&amp;gt; offsets) {&lt;br/&gt;
+&lt;br/&gt;
+        // Find non persistent store&apos;s topics&lt;br/&gt;
+        final Map&amp;lt;String, String&amp;gt; storeToChangelogTopic = topology.storeToChangelogTopic();&lt;br/&gt;
+        final Set&amp;lt;String&amp;gt; globalNonPersistentStoresTopics = new HashSet&amp;lt;&amp;gt;();&lt;br/&gt;
+        for (final StateStore store : topology.globalStateStores()) {&lt;br/&gt;
+            if (!store.persistent() &amp;amp;&amp;amp; storeToChangelogTopic.containsKey(store.name())) &lt;/p&gt;
{
+                globalNonPersistentStoresTopics.add(storeToChangelogTopic.get(store.name()));
+            }
&lt;p&gt;+        }&lt;br/&gt;
+&lt;br/&gt;
         checkpointableOffsets.putAll(offsets);&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (!checkpointableOffsets.isEmpty()) {&lt;br/&gt;
+&lt;br/&gt;
+        final Map&amp;lt;TopicPartition, Long&amp;gt; filteredOffsets = new HashMap&amp;lt;&amp;gt;();&lt;br/&gt;
+&lt;br/&gt;
+        // Skip non persistent store&lt;br/&gt;
+        for (final Map.Entry&amp;lt;TopicPartition, Long&amp;gt; topicPartitionOffset : checkpointableOffsets.entrySet()) {&lt;br/&gt;
+            final String topic = topicPartitionOffset.getKey().topic();&lt;br/&gt;
+            if (globalNonPersistentStoresTopics.contains(topic)) {&lt;br/&gt;
+                log.debug(&quot;Skipping global store&apos; topic {}&quot;, topic);&lt;br/&gt;
+            } else 
{
+                filteredOffsets.put(topicPartitionOffset.getKey(), topicPartitionOffset.getValue());
+            }
&lt;p&gt;+        }&lt;br/&gt;
+&lt;br/&gt;
+        if (!filteredOffsets.isEmpty()) {&lt;br/&gt;
             try &lt;/p&gt;
{
-                checkpoint.write(checkpointableOffsets);
+                checkpoint.write(filteredOffsets);
             }
&lt;p&gt; catch (IOException e) {&lt;br/&gt;
                 log.warn(&quot;Failed to write offset checkpoint file to {} for global stores: {}&quot;, checkpoint, e);&lt;br/&gt;
             }&lt;br/&gt;
diff --git a/streams/src/test/java/org/apache/kafka/streams/processor/internals/GlobalStateManagerImplTest.java b/streams/src/test/java/org/apache/kafka/streams/processor/internals/GlobalStateManagerImplTest.java&lt;br/&gt;
index df8d2010d24..c449ec5f527 100644&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/streams/src/test/java/org/apache/kafka/streams/processor/internals/GlobalStateManagerImplTest.java&lt;br/&gt;
+++ b/streams/src/test/java/org/apache/kafka/streams/processor/internals/GlobalStateManagerImplTest.java&lt;br/&gt;
@@ -488,6 +488,16 @@ public void shouldCheckpointRestoredOffsetsToFile() throws IOException 
{
         assertThat(readOffsetsCheckpoint(), equalTo(checkpointMap));
     }&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;+    @Test&lt;br/&gt;
+    public void shouldSkipGlobalInMemoryStoreOffsetsToFile() throws IOException &lt;/p&gt;
{
+        stateManager.initialize();
+        initializeConsumer(10, 1, t3);
+        stateManager.register(store3, stateRestoreCallback);
+        stateManager.close(Collections.&amp;lt;TopicPartition, Long&amp;gt;emptyMap());
+
+        assertThat(readOffsetsCheckpoint(), equalTo(Collections.&amp;lt;TopicPartition, Long&amp;gt;emptyMap()));
+    }
&lt;p&gt;+&lt;br/&gt;
     private Map&amp;lt;TopicPartition, Long&amp;gt; readOffsetsCheckpoint() throws IOException {&lt;br/&gt;
         final OffsetCheckpoint offsetCheckpoint = new OffsetCheckpoint(new File(stateManager.baseDir(),&lt;br/&gt;
                                                                                 ProcessorStateManager.CHECKPOINT_FILE_NAME));&lt;br/&gt;
diff --git a/streams/src/test/java/org/apache/kafka/test/NoOpReadOnlyStore.java b/streams/src/test/java/org/apache/kafka/test/NoOpReadOnlyStore.java&lt;br/&gt;
index ae46b8dadaa..08945d5047a 100644&lt;br/&gt;
&amp;#8212; a/streams/src/test/java/org/apache/kafka/test/NoOpReadOnlyStore.java&lt;br/&gt;
+++ b/streams/src/test/java/org/apache/kafka/test/NoOpReadOnlyStore.java&lt;br/&gt;
@@ -95,7 +95,7 @@ public void close() {&lt;/p&gt;

&lt;p&gt;     @Override&lt;br/&gt;
     public boolean persistent() &lt;/p&gt;
{
-        return false;
+        return rocksdbStore;
     }

&lt;p&gt;     @Override&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16416859" author="githubbot" created="Wed, 28 Mar 2018 05:55:27 +0000"  >&lt;p&gt;cemo opened a new pull request #4782: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6711&quot; title=&quot;GlobalStateManagerImpl should not write offsets of in-memory stores in checkpoint file&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-6711&quot;&gt;&lt;del&gt;KAFKA-6711&lt;/del&gt;&lt;/a&gt;: GlobalStateManagerImpl should not write offsets of in-mem&#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/4782&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/4782&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   This PR is addressing issues when persisting non persistent stores into checkpoint file. &lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;x&amp;#93;&lt;/span&gt; Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16509909" author="mjsax" created="Tue, 12 Jun 2018 17:25:47 +0000"  >&lt;p&gt;I am talking this over to get the fix into 2.0 release.&lt;/p&gt;</comment>
                            <comment id="16511822" author="githubbot" created="Thu, 14 Jun 2018 00:01:52 +0000"  >&lt;p&gt;mjsax opened a new pull request #5219: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6711&quot; title=&quot;GlobalStateManagerImpl should not write offsets of in-memory stores in checkpoint file&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-6711&quot;&gt;&lt;del&gt;KAFKA-6711&lt;/del&gt;&lt;/a&gt;: GlobalStateManagerImpl should not write offsets of in-memory stores in checkpoint file&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5219&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5219&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   *More detailed description of your change,&lt;br/&gt;
   if necessary. The PR title and PR message become&lt;br/&gt;
   the squashed commit message, so use a separate&lt;br/&gt;
   comment to ping reviewers.*&lt;/p&gt;

&lt;p&gt;   *Summary of testing strategy (including rationale)&lt;br/&gt;
   for the feature or bug fix. Unit and/or integration&lt;br/&gt;
   tests are expected for any behaviour change and&lt;br/&gt;
   system tests should be considered for larger changes.*&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16512359" author="githubbot" created="Thu, 14 Jun 2018 11:44:12 +0000"  >&lt;p&gt;rajinisivaram closed pull request #5219: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6711&quot; title=&quot;GlobalStateManagerImpl should not write offsets of in-memory stores in checkpoint file&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-6711&quot;&gt;&lt;del&gt;KAFKA-6711&lt;/del&gt;&lt;/a&gt;: GlobalStateManagerImpl should not write offsets of in-memory stores in checkpoint file&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5219&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5219&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStateManagerImpl.java b/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStateManagerImpl.java&lt;br/&gt;
index 78c4a363f29..a4ec23d4c49 100644&lt;br/&gt;
&amp;#8212; a/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStateManagerImpl.java&lt;br/&gt;
+++ b/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStateManagerImpl.java&lt;br/&gt;
@@ -42,6 +42,7 @@&lt;br/&gt;
 import java.util.ArrayList;&lt;br/&gt;
 import java.util.Collection;&lt;br/&gt;
 import java.util.Collections;&lt;br/&gt;
+import java.util.HashMap;&lt;br/&gt;
 import java.util.HashSet;&lt;br/&gt;
 import java.util.List;&lt;br/&gt;
 import java.util.Map;&lt;br/&gt;
@@ -62,6 +63,7 @@&lt;br/&gt;
     private final int retries;&lt;br/&gt;
     private final long retryBackoffMs;&lt;br/&gt;
     private final Duration pollTime;&lt;br/&gt;
+    private final Set&amp;lt;String&amp;gt; globalNonPersistentStoresTopics = new HashSet&amp;lt;&amp;gt;();&lt;/p&gt;

&lt;p&gt;     public GlobalStateManagerImpl(final LogContext logContext,&lt;br/&gt;
                                   final ProcessorTopology topology,&lt;br/&gt;
@@ -71,6 +73,14 @@ public GlobalStateManagerImpl(final LogContext logContext,&lt;br/&gt;
                                   final StreamsConfig config) {&lt;br/&gt;
         super(stateDirectory.globalStateDir(), StreamsConfig.EXACTLY_ONCE.equals(config.getString(StreamsConfig.PROCESSING_GUARANTEE_CONFIG)));&lt;/p&gt;

&lt;p&gt;+        // Find non persistent store&apos;s topics&lt;br/&gt;
+        final Map&amp;lt;String, String&amp;gt; storeToChangelogTopic = topology.storeToChangelogTopic();&lt;br/&gt;
+        for (final StateStore store : topology.globalStateStores()) {&lt;br/&gt;
+            if (!store.persistent()) &lt;/p&gt;
{
+                globalNonPersistentStoresTopics.add(storeToChangelogTopic.get(store.name()));
+            }
&lt;p&gt;+        }&lt;br/&gt;
+&lt;br/&gt;
         this.log = logContext.logger(GlobalStateManagerImpl.class);&lt;br/&gt;
         this.topology = topology;&lt;br/&gt;
         this.globalConsumer = globalConsumer;&lt;br/&gt;
@@ -337,13 +347,22 @@ public void close(final Map&amp;lt;TopicPartition, Long&amp;gt; offsets) throws IOException {&lt;br/&gt;
     @Override&lt;br/&gt;
     public void checkpoint(final Map&amp;lt;TopicPartition, Long&amp;gt; offsets) {&lt;br/&gt;
         checkpointableOffsets.putAll(offsets);&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (!checkpointableOffsets.isEmpty()) {&lt;/li&gt;
	&lt;li&gt;try 
{
-                checkpoint.write(checkpointableOffsets);
-            }
&lt;p&gt; catch (final IOException e) {&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;log.warn(&quot;Failed to write offset checkpoint file to {} for global stores: {}&quot;, checkpoint, e);&lt;br/&gt;
+&lt;br/&gt;
+        final Map&amp;lt;TopicPartition, Long&amp;gt; filteredOffsets = new HashMap&amp;lt;&amp;gt;();&lt;br/&gt;
+&lt;br/&gt;
+        // Skip non persistent store&lt;br/&gt;
+        for (final Map.Entry&amp;lt;TopicPartition, Long&amp;gt; topicPartitionOffset : checkpointableOffsets.entrySet()) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+            final String topic = topicPartitionOffset.getKey().topic();+            if (!globalNonPersistentStoresTopics.contains(topic)) {
+                filteredOffsets.put(topicPartitionOffset.getKey(), topicPartitionOffset.getValue());
             }         }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;+&lt;br/&gt;
+        try &lt;/p&gt;
{
+            checkpoint.write(filteredOffsets);
+        }
&lt;p&gt; catch (final IOException e) {&lt;br/&gt;
+            log.warn(&quot;Failed to write offset checkpoint file to {} for global stores: {}&quot;, checkpoint, e);&lt;br/&gt;
+        }&lt;br/&gt;
     }&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     @Override&lt;br/&gt;
diff --git a/streams/src/test/java/org/apache/kafka/streams/integration/GlobalKTableIntegrationTest.java b/streams/src/test/java/org/apache/kafka/streams/integration/GlobalKTableIntegrationTest.java&lt;br/&gt;
index 900e65276ee..013e2b68110 100644&lt;br/&gt;
&amp;#8212; a/streams/src/test/java/org/apache/kafka/streams/integration/GlobalKTableIntegrationTest.java&lt;br/&gt;
+++ b/streams/src/test/java/org/apache/kafka/streams/integration/GlobalKTableIntegrationTest.java&lt;br/&gt;
@@ -22,13 +22,13 @@&lt;br/&gt;
 import org.apache.kafka.common.serialization.Serdes;&lt;br/&gt;
 import org.apache.kafka.common.serialization.StringSerializer;&lt;br/&gt;
 import org.apache.kafka.common.utils.Bytes;&lt;br/&gt;
-import org.apache.kafka.streams.kstream.Consumed;&lt;br/&gt;
 import org.apache.kafka.streams.KafkaStreams;&lt;br/&gt;
 import org.apache.kafka.streams.KeyValue;&lt;br/&gt;
 import org.apache.kafka.streams.StreamsBuilder;&lt;br/&gt;
 import org.apache.kafka.streams.StreamsConfig;&lt;br/&gt;
 import org.apache.kafka.streams.integration.utils.EmbeddedKafkaCluster;&lt;br/&gt;
 import org.apache.kafka.streams.integration.utils.IntegrationTestUtils;&lt;br/&gt;
+import org.apache.kafka.streams.kstream.Consumed;&lt;br/&gt;
 import org.apache.kafka.streams.kstream.ForeachAction;&lt;br/&gt;
 import org.apache.kafka.streams.kstream.GlobalKTable;&lt;br/&gt;
 import org.apache.kafka.streams.kstream.KStream;&lt;br/&gt;
@@ -38,6 +38,7 @@&lt;br/&gt;
 import org.apache.kafka.streams.state.KeyValueStore;&lt;br/&gt;
 import org.apache.kafka.streams.state.QueryableStoreTypes;&lt;br/&gt;
 import org.apache.kafka.streams.state.ReadOnlyKeyValueStore;&lt;br/&gt;
+import org.apache.kafka.streams.state.Stores;&lt;br/&gt;
 import org.apache.kafka.test.IntegrationTest;&lt;br/&gt;
 import org.apache.kafka.test.TestCondition;&lt;br/&gt;
 import org.apache.kafka.test.TestUtils;&lt;br/&gt;
@@ -53,6 +54,9 @@&lt;br/&gt;
 import java.util.Map;&lt;br/&gt;
 import java.util.Properties;&lt;/p&gt;

&lt;p&gt;+import static org.hamcrest.core.IsEqual.equalTo;&lt;br/&gt;
+import static org.junit.Assert.assertThat;&lt;br/&gt;
+&lt;br/&gt;
 @Category(&lt;/p&gt;
{IntegrationTest.class}
&lt;p&gt;)&lt;br/&gt;
 public class GlobalKTableIntegrationTest {&lt;br/&gt;
     private static final int NUM_BROKERS = 1;&lt;br/&gt;
@@ -220,7 +224,27 @@ public boolean conditionMet() {&lt;br/&gt;
             }&lt;br/&gt;
         }, 30000L, &quot;waiting for final values&quot;);&lt;br/&gt;
     }&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;p&gt;+&lt;br/&gt;
+    @Test&lt;br/&gt;
+    public void shouldRestoreGlobalInMemoryKTableOnRestart() throws Exception &lt;/p&gt;
{
+        builder = new StreamsBuilder();
+        globalTable = builder.globalTable(
+            globalTableTopic,
+            Consumed.with(Serdes.Long(), Serdes.String()),
+            Materialized.as(Stores.inMemoryKeyValueStore(globalStore)));
+
+        produceInitialGlobalTableValues();
+
+        startStreams();
+        ReadOnlyKeyValueStore&amp;lt;Long, String&amp;gt; store = kafkaStreams.store(globalStore, QueryableStoreTypes.keyValueStore());
+        assertThat(store.approximateNumEntries(), equalTo(4L));
+        kafkaStreams.close();
+
+        startStreams();
+        store = kafkaStreams.store(globalStore, QueryableStoreTypes.keyValueStore());
+        assertThat(store.approximateNumEntries(), equalTo(4L));
+    }
&lt;p&gt;+&lt;br/&gt;
     private void createTopics() throws InterruptedException {&lt;br/&gt;
         streamTopic = &quot;stream-&quot; + testNo;&lt;br/&gt;
         globalTableTopic = &quot;globalTable-&quot; + testNo;&lt;br/&gt;
diff --git a/streams/src/test/java/org/apache/kafka/streams/processor/internals/GlobalStateManagerImplTest.java b/streams/src/test/java/org/apache/kafka/streams/processor/internals/GlobalStateManagerImplTest.java&lt;br/&gt;
index 2ca9c211c1c..e37f6a63243 100644&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/streams/src/test/java/org/apache/kafka/streams/processor/internals/GlobalStateManagerImplTest.java&lt;br/&gt;
+++ b/streams/src/test/java/org/apache/kafka/streams/processor/internals/GlobalStateManagerImplTest.java&lt;br/&gt;
@@ -488,6 +488,16 @@ public void shouldCheckpointRestoredOffsetsToFile() throws IOException 
{
         assertThat(readOffsetsCheckpoint(), equalTo(checkpointMap));
     }&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;+    @Test&lt;br/&gt;
+    public void shouldSkipGlobalInMemoryStoreOffsetsToFile() throws IOException &lt;/p&gt;
{
+        stateManager.initialize();
+        initializeConsumer(10, 1, t3);
+        stateManager.register(store3, stateRestoreCallback);
+        stateManager.close(Collections.emptyMap());
+
+        assertThat(readOffsetsCheckpoint(), equalTo(Collections.emptyMap()));
+    }
&lt;p&gt;+&lt;br/&gt;
     private Map&amp;lt;TopicPartition, Long&amp;gt; readOffsetsCheckpoint() throws IOException {&lt;br/&gt;
         final OffsetCheckpoint offsetCheckpoint = new OffsetCheckpoint(new File(stateManager.baseDir(),&lt;br/&gt;
                                                                                 ProcessorStateManager.CHECKPOINT_FILE_NAME));&lt;br/&gt;
diff --git a/streams/src/test/java/org/apache/kafka/test/NoOpReadOnlyStore.java b/streams/src/test/java/org/apache/kafka/test/NoOpReadOnlyStore.java&lt;br/&gt;
index ae46b8dadaa..08945d5047a 100644&lt;br/&gt;
&amp;#8212; a/streams/src/test/java/org/apache/kafka/test/NoOpReadOnlyStore.java&lt;br/&gt;
+++ b/streams/src/test/java/org/apache/kafka/test/NoOpReadOnlyStore.java&lt;br/&gt;
@@ -95,7 +95,7 @@ public void close() {&lt;/p&gt;

&lt;p&gt;     @Override&lt;br/&gt;
     public boolean persistent() &lt;/p&gt;
{
-        return false;
+        return rocksdbStore;
     }

&lt;p&gt;     @Override&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16513124" author="githubbot" created="Thu, 14 Jun 2018 23:24:16 +0000"  >&lt;p&gt;mjsax closed pull request #4782: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6711&quot; title=&quot;GlobalStateManagerImpl should not write offsets of in-memory stores in checkpoint file&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-6711&quot;&gt;&lt;del&gt;KAFKA-6711&lt;/del&gt;&lt;/a&gt;: GlobalStateManagerImpl should not write offsets of in-mem&#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/4782&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/4782&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStateManagerImpl.java b/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStateManagerImpl.java&lt;br/&gt;
index 56e6bed0850..17ae70ce0d1 100644&lt;br/&gt;
&amp;#8212; a/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStateManagerImpl.java&lt;br/&gt;
+++ b/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStateManagerImpl.java&lt;br/&gt;
@@ -41,6 +41,7 @@&lt;br/&gt;
 import java.util.ArrayList;&lt;br/&gt;
 import java.util.Collection;&lt;br/&gt;
 import java.util.Collections;&lt;br/&gt;
+import java.util.HashMap;&lt;br/&gt;
 import java.util.HashSet;&lt;br/&gt;
 import java.util.List;&lt;br/&gt;
 import java.util.Map;&lt;br/&gt;
@@ -242,7 +243,7 @@ private void restoreState(final StateRestoreCallback stateRestoreCallback,&lt;br/&gt;
         for (final TopicPartition topicPartition : topicPartitions) {&lt;br/&gt;
             globalConsumer.assign(Collections.singletonList(topicPartition));&lt;br/&gt;
             final Long checkpoint = checkpointableOffsets.get(topicPartition);&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (checkpoint != null) {&lt;br/&gt;
+            if (checkpoint != null &amp;amp;&amp;amp; checkpoint &amp;gt; StateRestorer.NO_CHECKPOINT) 
{
                 globalConsumer.seek(topicPartition, checkpoint);
             }
&lt;p&gt; else {&lt;br/&gt;
                 globalConsumer.seekToBeginning(Collections.singletonList(topicPartition));&lt;br/&gt;
@@ -334,10 +335,33 @@ public void close(final Map&amp;lt;TopicPartition, Long&amp;gt; offsets) throws IOException {&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     @Override&lt;br/&gt;
     public void checkpoint(final Map&amp;lt;TopicPartition, Long&amp;gt; offsets) {&lt;br/&gt;
+&lt;br/&gt;
+        // Find non persistent store&apos;s topics&lt;br/&gt;
+        final Map&amp;lt;String, String&amp;gt; storeToChangelogTopic = topology.storeToChangelogTopic();&lt;br/&gt;
+        final Set&amp;lt;String&amp;gt; globalNonPersistentStoresTopics = new HashSet&amp;lt;&amp;gt;();&lt;br/&gt;
+        for (final StateStore store : topology.globalStateStores()) {&lt;br/&gt;
+            if (!store.persistent() &amp;amp;&amp;amp; storeToChangelogTopic.containsKey(store.name())) &lt;/p&gt;
{
+                globalNonPersistentStoresTopics.add(storeToChangelogTopic.get(store.name()));
+            }
&lt;p&gt;+        }&lt;br/&gt;
+&lt;br/&gt;
         checkpointableOffsets.putAll(offsets);&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (!checkpointableOffsets.isEmpty()) {&lt;br/&gt;
+&lt;br/&gt;
+        final Map&amp;lt;TopicPartition, Long&amp;gt; filteredOffsets = new HashMap&amp;lt;&amp;gt;();&lt;br/&gt;
+&lt;br/&gt;
+        // Skip non persistent store&lt;br/&gt;
+        for (final Map.Entry&amp;lt;TopicPartition, Long&amp;gt; topicPartitionOffset : checkpointableOffsets.entrySet()) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+            final String topic = topicPartitionOffset.getKey().topic();+            if (globalNonPersistentStoresTopics.contains(topic)) {
+                filteredOffsets.put(topicPartitionOffset.getKey(), (long) StateRestorer.NO_CHECKPOINT);
+            } else {
+                filteredOffsets.put(topicPartitionOffset.getKey(), topicPartitionOffset.getValue());
+            }+        }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;+&lt;br/&gt;
+        if (!filteredOffsets.isEmpty()) {&lt;br/&gt;
             try &lt;/p&gt;
{
-                checkpoint.write(checkpointableOffsets);
+                checkpoint.write(filteredOffsets);
             }
&lt;p&gt; catch (IOException e) {&lt;br/&gt;
                 log.warn(&quot;Failed to write offset checkpoint file to {} for global stores: {}&quot;, checkpoint, e);&lt;br/&gt;
             }&lt;br/&gt;
diff --git a/streams/src/test/java/org/apache/kafka/streams/processor/internals/GlobalStateManagerImplTest.java b/streams/src/test/java/org/apache/kafka/streams/processor/internals/GlobalStateManagerImplTest.java&lt;br/&gt;
index df8d2010d24..39b7bb4747f 100644&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/streams/src/test/java/org/apache/kafka/streams/processor/internals/GlobalStateManagerImplTest.java&lt;br/&gt;
+++ b/streams/src/test/java/org/apache/kafka/streams/processor/internals/GlobalStateManagerImplTest.java&lt;br/&gt;
@@ -488,6 +488,16 @@ public void shouldCheckpointRestoredOffsetsToFile() throws IOException 
{
         assertThat(readOffsetsCheckpoint(), equalTo(checkpointMap));
     }&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;+    @Test&lt;br/&gt;
+    public void shouldSkipGlobalInMemoryStoreOffsetsToFile() throws IOException &lt;/p&gt;
{
+        stateManager.initialize();
+        initializeConsumer(10, 1, t3);
+        stateManager.register(store3, stateRestoreCallback);
+        stateManager.close(Collections.&amp;lt;TopicPartition, Long&amp;gt;emptyMap());
+
+        assertThat(readOffsetsCheckpoint(), equalTo(Collections.singletonMap(t3, (long) StateRestorer.NO_CHECKPOINT)));
+    }
&lt;p&gt;+&lt;br/&gt;
     private Map&amp;lt;TopicPartition, Long&amp;gt; readOffsetsCheckpoint() throws IOException {&lt;br/&gt;
         final OffsetCheckpoint offsetCheckpoint = new OffsetCheckpoint(new File(stateManager.baseDir(),&lt;br/&gt;
                                                                                 ProcessorStateManager.CHECKPOINT_FILE_NAME));&lt;br/&gt;
diff --git a/streams/src/test/java/org/apache/kafka/test/NoOpReadOnlyStore.java b/streams/src/test/java/org/apache/kafka/test/NoOpReadOnlyStore.java&lt;br/&gt;
index ae46b8dadaa..08945d5047a 100644&lt;br/&gt;
&amp;#8212; a/streams/src/test/java/org/apache/kafka/test/NoOpReadOnlyStore.java&lt;br/&gt;
+++ b/streams/src/test/java/org/apache/kafka/test/NoOpReadOnlyStore.java&lt;br/&gt;
@@ -95,7 +95,7 @@ public void close() {&lt;/p&gt;

&lt;p&gt;     @Override&lt;br/&gt;
     public boolean persistent() &lt;/p&gt;
{
-        return false;
+        return rocksdbStore;
     }

&lt;p&gt;     @Override&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16513125" author="githubbot" created="Thu, 14 Jun 2018 23:24:47 +0000"  >&lt;p&gt;mjsax closed pull request #4789: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6711&quot; title=&quot;GlobalStateManagerImpl should not write offsets of in-memory stores in checkpoint file&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-6711&quot;&gt;&lt;del&gt;KAFKA-6711&lt;/del&gt;&lt;/a&gt;: GlobalStateManagerImpl should not write offsets&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/4789&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/4789&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStateManagerImpl.java b/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStateManagerImpl.java&lt;br/&gt;
index 6052f96053c..be160bd5a33 100644&lt;br/&gt;
&amp;#8212; a/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStateManagerImpl.java&lt;br/&gt;
+++ b/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStateManagerImpl.java&lt;br/&gt;
@@ -167,7 +167,7 @@ private void restoreState(final StateRestoreCallback stateRestoreCallback,&lt;br/&gt;
         for (final TopicPartition topicPartition : topicPartitions) {&lt;br/&gt;
             consumer.assign(Collections.singletonList(topicPartition));&lt;br/&gt;
             final Long checkpoint = checkpointableOffsets.get(topicPartition);&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (checkpoint != null) {&lt;br/&gt;
+            if (checkpoint != null &amp;amp;&amp;amp; checkpoint &amp;gt; StateRestorer.NO_CHECKPOINT) 
{
                 consumer.seek(topicPartition, checkpoint);
             }
&lt;p&gt; else {&lt;br/&gt;
                 consumer.seekToBeginning(Collections.singletonList(topicPartition));&lt;br/&gt;
@@ -249,10 +249,33 @@ public void close(final Map&amp;lt;TopicPartition, Long&amp;gt; offsets) throws IOException {&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     @Override&lt;br/&gt;
     public void checkpoint(final Map&amp;lt;TopicPartition, Long&amp;gt; offsets) {&lt;br/&gt;
+&lt;br/&gt;
+        // Find non persistent store&apos;s topics&lt;br/&gt;
+        final Map&amp;lt;String, String&amp;gt; storeToChangelogTopic = topology.storeToChangelogTopic();&lt;br/&gt;
+        final Set&amp;lt;String&amp;gt; globalNonPersistentStoresTopics = new HashSet&amp;lt;&amp;gt;();&lt;br/&gt;
+        for (final StateStore store : topology.globalStateStores()) {&lt;br/&gt;
+            if (!store.persistent() &amp;amp;&amp;amp; storeToChangelogTopic.containsKey(store.name())) &lt;/p&gt;
{
+                globalNonPersistentStoresTopics.add(storeToChangelogTopic.get(store.name()));
+            }
&lt;p&gt;+        }&lt;br/&gt;
+&lt;br/&gt;
         checkpointableOffsets.putAll(offsets);&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (!checkpointableOffsets.isEmpty()) {&lt;br/&gt;
+&lt;br/&gt;
+        final Map&amp;lt;TopicPartition, Long&amp;gt; filteredOffsets = new HashMap&amp;lt;&amp;gt;();&lt;br/&gt;
+&lt;br/&gt;
+        // Skip non persistent store&lt;br/&gt;
+        for (final Map.Entry&amp;lt;TopicPartition, Long&amp;gt; topicPartitionOffset : checkpointableOffsets.entrySet()) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+            final String topic = topicPartitionOffset.getKey().topic();+            if (globalNonPersistentStoresTopics.contains(topic)) {
+                filteredOffsets.put(topicPartitionOffset.getKey(), (long) StateRestorer.NO_CHECKPOINT);
+            } else {
+                filteredOffsets.put(topicPartitionOffset.getKey(), topicPartitionOffset.getValue());
+            }+        }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;+&lt;br/&gt;
+        if (!filteredOffsets.isEmpty()) {&lt;br/&gt;
             try &lt;/p&gt;
{
-                checkpoint.write(checkpointableOffsets);
+                checkpoint.write(filteredOffsets);
             }
&lt;p&gt; catch (IOException e) &lt;/p&gt;
{
                 log.warn(&quot;Failed to write offsets checkpoint for global stores&quot;, e);
             }
&lt;p&gt;diff --git a/streams/src/test/java/org/apache/kafka/streams/processor/internals/GlobalStateManagerImplTest.java b/streams/src/test/java/org/apache/kafka/streams/processor/internals/GlobalStateManagerImplTest.java&lt;br/&gt;
index e9d61f5ad64..7e838763031 100644&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/streams/src/test/java/org/apache/kafka/streams/processor/internals/GlobalStateManagerImplTest.java&lt;br/&gt;
+++ b/streams/src/test/java/org/apache/kafka/streams/processor/internals/GlobalStateManagerImplTest.java&lt;br/&gt;
@@ -68,12 +68,13 @@&lt;br/&gt;
     private final MockStateRestoreListener stateRestoreListener = new MockStateRestoreListener();&lt;br/&gt;
     private final TopicPartition t1 = new TopicPartition(&quot;t1&quot;, 1);&lt;br/&gt;
     private final TopicPartition t2 = new TopicPartition(&quot;t2&quot;, 1);&lt;br/&gt;
+    private final TopicPartition t3 = new TopicPartition(&quot;t3&quot;, 1);&lt;br/&gt;
     private GlobalStateManagerImpl stateManager;&lt;br/&gt;
     private NoOpProcessorContext context;&lt;br/&gt;
     private StateDirectory stateDirectory;&lt;br/&gt;
     private String stateDirPath;&lt;br/&gt;
     private NoOpReadOnlyStore&amp;lt;Object, Object&amp;gt; store1;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;private NoOpReadOnlyStore store2;&lt;br/&gt;
+    private NoOpReadOnlyStore store2, store3;&lt;br/&gt;
     private MockConsumer&amp;lt;byte[], byte[]&amp;gt; consumer;&lt;br/&gt;
     private File checkpointFile;&lt;br/&gt;
     private ProcessorTopology topology;&lt;br/&gt;
@@ -83,18 +84,21 @@ public void before() throws IOException {&lt;br/&gt;
         final Map&amp;lt;String, String&amp;gt; storeToTopic = new HashMap&amp;lt;&amp;gt;();&lt;br/&gt;
         storeToTopic.put(&quot;t1-store&quot;, &quot;t1&quot;);&lt;br/&gt;
         storeToTopic.put(&quot;t2-store&quot;, &quot;t2&quot;);&lt;br/&gt;
+        storeToTopic.put(&quot;t3-store&quot;, &quot;t3&quot;);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         final Map&amp;lt;StateStore, ProcessorNode&amp;gt; storeToProcessorNode = new HashMap&amp;lt;&amp;gt;();&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;store1 = new NoOpReadOnlyStore&amp;lt;&amp;gt;(&quot;t1-store&quot;);&lt;br/&gt;
+        store1 = new NoOpReadOnlyStore&amp;lt;&amp;gt;(&quot;t1-store&quot;, true);&lt;br/&gt;
         storeToProcessorNode.put(store1, new MockProcessorNode(-1));&lt;/li&gt;
	&lt;li&gt;store2 = new NoOpReadOnlyStore(&quot;t2-store&quot;);&lt;br/&gt;
+        store2 = new NoOpReadOnlyStore(&quot;t2-store&quot;, true);&lt;br/&gt;
         storeToProcessorNode.put(store2, new MockProcessorNode(-1));&lt;br/&gt;
+        store3 = new NoOpReadOnlyStore(&quot;t3-store&quot;, false);&lt;br/&gt;
+        storeToProcessorNode.put(store3, new MockProcessorNode(-1));&lt;br/&gt;
         topology = new ProcessorTopology(Collections.&amp;lt;ProcessorNode&amp;gt;emptyList(),&lt;br/&gt;
                                          Collections.&amp;lt;String, SourceNode&amp;gt;emptyMap(),&lt;br/&gt;
                                          Collections.&amp;lt;String, SinkNode&amp;gt;emptyMap(),&lt;br/&gt;
                                          Collections.&amp;lt;StateStore&amp;gt;emptyList(),&lt;br/&gt;
                                          storeToTopic,&lt;/li&gt;
	&lt;li&gt;Arrays.&amp;lt;StateStore&amp;gt;asList(store1, store2));&lt;br/&gt;
+                                         Arrays.&amp;lt;StateStore&amp;gt;asList(store1, store2, store3));&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         context = new NoOpProcessorContext();&lt;br/&gt;
         stateDirPath = TestUtils.tempDirectory().getPath();&lt;br/&gt;
@@ -158,7 +162,7 @@ public void shouldInitializeStateStores() {&lt;br/&gt;
     @Test&lt;br/&gt;
     public void shouldReturnInitializedStoreNames() &lt;/p&gt;
{
         final Set&amp;lt;String&amp;gt; storeNames = stateManager.initialize(context);
-        assertEquals(Utils.mkSet(store1.name(), store2.name()), storeNames);
+        assertEquals(Utils.mkSet(store1.name(), store2.name(), store3.name()), storeNames);
     }

&lt;p&gt;     @Test&lt;br/&gt;
@@ -462,6 +466,16 @@ public void shouldCheckpointRestoredOffsetsToFile() throws IOException &lt;/p&gt;
{
         assertThat(readOffsetsCheckpoint(), equalTo(checkpointMap));
     }

&lt;p&gt;+    @Test&lt;br/&gt;
+    public void shouldSkipGlobalInMemoryStoreOffsetsToFile() throws IOException &lt;/p&gt;
{
+        stateManager.initialize(context);
+        initializeConsumer(10, 1, t3);
+        stateManager.register(store3, stateRestoreCallback);
+        stateManager.close(Collections.&amp;lt;TopicPartition, Long&amp;gt;emptyMap());
+
+        assertThat(readOffsetsCheckpoint(), equalTo(Collections.singletonMap(t3, (long) StateRestorer.NO_CHECKPOINT)));
+    }
&lt;p&gt;+&lt;br/&gt;
     private Map&amp;lt;TopicPartition, Long&amp;gt; readOffsetsCheckpoint() throws IOException {&lt;br/&gt;
         final OffsetCheckpoint offsetCheckpoint = new OffsetCheckpoint(new File(stateManager.baseDir(),&lt;br/&gt;
                                                                                 ProcessorStateManager.CHECKPOINT_FILE_NAME));&lt;br/&gt;
diff --git a/streams/src/test/java/org/apache/kafka/test/NoOpReadOnlyStore.java b/streams/src/test/java/org/apache/kafka/test/NoOpReadOnlyStore.java&lt;br/&gt;
index 0ada2e4432d..0fcbfe5d760 100644&lt;br/&gt;
&amp;#8212; a/streams/src/test/java/org/apache/kafka/test/NoOpReadOnlyStore.java&lt;br/&gt;
+++ b/streams/src/test/java/org/apache/kafka/test/NoOpReadOnlyStore.java&lt;br/&gt;
@@ -28,14 +28,21 @@&lt;br/&gt;
     private boolean open = true;&lt;br/&gt;
     public boolean initialized;&lt;br/&gt;
     public boolean flushed;&lt;br/&gt;
+    public boolean rocksdbStore;&lt;/p&gt;


&lt;p&gt;     public NoOpReadOnlyStore() &lt;/p&gt;
{
-        this(&quot;&quot;);
+        this(&quot;&quot;, false);
     }

&lt;p&gt;+&lt;br/&gt;
     public NoOpReadOnlyStore(final String name) &lt;/p&gt;
{
+        this(name, false);
+    }
&lt;p&gt;+&lt;br/&gt;
+    public NoOpReadOnlyStore(final String name, final boolean rocksdbStore) &lt;/p&gt;
{
         this.name = name;
+        this.rocksdbStore = rocksdbStore;
     }

&lt;p&gt;     @Override&lt;br/&gt;
@@ -80,7 +87,7 @@ public void close() {&lt;/p&gt;

&lt;p&gt;     @Override&lt;br/&gt;
     public boolean persistent() &lt;/p&gt;
{
-        return false;
+        return rocksdbStore;
     }

&lt;p&gt;     @Override&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16590885" author="gauba" created="Thu, 23 Aug 2018 22:32:11 +0000"  >&lt;p&gt;hello there&lt;/p&gt;

&lt;p&gt;We have developed a kafka-streams application using Kafka Server and Kafka Client both version 1.1.0. In 2 of our environment we are seeing this issue where offsets for GlobalTable (in-memory) stores are written in checkpoint file. We updated the kafka-client and kafka-streams libraries in our environment to 1.1.1 whereas the Kafka Server is still on 1.1.0. After deleting the&#160;GlobalTable checkpoint file the streaming application creating the file again but it still had the offsets written in it.&lt;/p&gt;

&lt;p&gt;My question here is will this fix only work if Kafka Server as well as Kafka Streams Client both are updated to version 1.1.1? Please advise.&lt;/p&gt;

&lt;p&gt;Here is the code snippet we use GlobalTable creation.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&#160;&#160; &#160;&#160;&#160;&#160; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; GlobalKTable&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, EdgeInfo&amp;gt; edgeInfos = builder.globalTable(SystemTopic.EDGE_INFO_BY_GUID.defaultSerializer().keySerde(),
&#160;&#160; &#160;&#160;&#160; &#160;&#160;&#160; &#160;&#160;&#160; &#160;SystemTopic.EDGE_INFO_BY_GUID.defaultSerializer().valueSerde(), SystemTopic.EDGE_INFO_BY_GUID.topicName(),
&#160;&#160; &#160;&#160;&#160; &#160;&#160;&#160; &#160;&#160;&#160; &#160;&lt;span class=&quot;code-quote&quot;&gt;&quot;store&quot;&lt;/span&gt;);&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;thanks&lt;/p&gt;

&lt;p&gt;Naveen Gauba&lt;/p&gt;</comment>
                            <comment id="16590995" author="mjsax" created="Fri, 24 Aug 2018 00:42:30 +0000"  >&lt;p&gt;Upgrading KafkaStreams to 1.1.1 should be sufficient to get this fix. There is no need to upgrade the brokers.&lt;/p&gt;

&lt;p&gt;However, your code seems not to use an in-memory store, but default RocksDB store. Thus, it&apos;s expected that the checkpoint file contains the offsets.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 12 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3rr07:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>mjsax</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>