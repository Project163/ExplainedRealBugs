<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:37:57 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-840] Controller tries to perform preferred replica election on failover before state machines have started up</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-840</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;If the admin/preferred_replica_election path is non-empty when a new controller starts, the controller attempts to perform preferred replica election before the partition and replica state machine have been initialized. In this case, the controller will try to make invalid state transitions. &lt;/p&gt;</description>
                <environment></environment>
        <key id="12639679">KAFKA-840</key>
            <summary>Controller tries to perform preferred replica election on failover before state machines have started up</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="swapnilghike">Swapnil Ghike</assignee>
                                    <reporter username="swapnilghike">Swapnil Ghike</reporter>
                        <labels>
                            <label>bugs</label>
                    </labels>
                <created>Thu, 28 Mar 2013 21:10:10 +0000</created>
                <updated>Thu, 4 Apr 2013 06:43:40 +0000</updated>
                            <resolved>Mon, 1 Apr 2013 16:17:43 +0000</resolved>
                                    <version>0.8.0</version>
                                    <fixVersion>0.8.0</fixVersion>
                                    <component>controller</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13616661" author="swapnilghike" created="Thu, 28 Mar 2013 21:14:27 +0000"  >&lt;p&gt;I think the right solution is to move   initializeAndMaybeTriggerPartitionReassignment() and initializeAndMaybeTriggerPreferredReplicaElection() after the controller mbean is registered and the controller logs that it is ready to serve. Attached a patch.&lt;/p&gt;</comment>
                            <comment id="13617001" author="nehanarkhede" created="Fri, 29 Mar 2013 02:21:56 +0000"  >&lt;p&gt;Thanks for the patch. In addition to fixing the issue at hand, I think it will be good to throw an IllegalOperationException if handleStateChanges() is invoked before startup() or after shutdown() in both PartitionStateMachine and ReplicaStateMachine&lt;/p&gt;</comment>
                            <comment id="13617919" author="swapnilghike" created="Sat, 30 Mar 2013 00:39:11 +0000"  >&lt;p&gt;1. Renamed inShuttingdown in partition/replica state machines to isRunning, because the former does not let us distinguish between a state machine that has not started, and a state machine that has started and is not shutting down. Made changes at other places accordingly.&lt;/p&gt;

&lt;p&gt;2. With this patch, if the state machine has not started, then handleStateChange() throws a StateChangeFailedException with a message &quot;because the state machine has not started&quot;. &lt;/p&gt;</comment>
                            <comment id="13618868" author="nehanarkhede" created="Mon, 1 Apr 2013 16:16:42 +0000"  >&lt;p&gt;Cool fix for handling the &quot;not started&quot;, &quot;started but shutdown&quot; conditions. +1&lt;br/&gt;
It&apos;s ok to not respond to new topic/new broker zookeeper watches, since on controller failover, the new controller will read the new topics/brokers and put them in New state.&lt;/p&gt;</comment>
                            <comment id="13618869" author="nehanarkhede" created="Mon, 1 Apr 2013 16:17:43 +0000"  >&lt;p&gt;Patch v2 is checked in, thanks Swapnil!&lt;/p&gt;</comment>
                            <comment id="13619181" author="swapnilghike" created="Mon, 1 Apr 2013 21:18:48 +0000"  >&lt;p&gt;I made a mistake. Patch v2 ignores a broker/topic change listener callback if the state machines have not started up. However, if such a callback occurs after the controller context has been initialized in controller failover, the topic/broker change will not be noticed by the state machines.&lt;/p&gt;

&lt;p&gt;The right fix is to have to two separate flags in the state machines - hasStarted and hasShutdown.&lt;/p&gt;</comment>
                            <comment id="13619965" author="nehanarkhede" created="Tue, 2 Apr 2013 16:31:14 +0000"  >&lt;p&gt;Thanks for the patch! One issue is that the !hasShutdown check should be within the lock, otherwise the state machine can end up trying to respond to a zookeeper listener even after it has shutdown. Today, this cannot happen since we close the zkclient before the controller shuts down, but this is a defensive check which will protect us if the shutdown order changes in the future.&lt;/p&gt;</comment>
                            <comment id="13620165" author="swapnilghike" created="Tue, 2 Apr 2013 19:31:00 +0000"  >&lt;p&gt;Makes sense. Should we also de-register the topic/broker change listeners when the partition/replica state machines are shutting down?&lt;/p&gt;</comment>
                            <comment id="13620167" author="nehanarkhede" created="Tue, 2 Apr 2013 19:35:35 +0000"  >&lt;p&gt;That would make sense, but with the current shutdown logic of the server, zkclient is closed before controller is shutdown. So doing that will raise an error. &lt;/p&gt;</comment>
                            <comment id="13620182" author="swapnilghike" created="Tue, 2 Apr 2013 19:50:19 +0000"  >&lt;p&gt;Cool, attached a new patch &apos;after-commit-v2&apos;.&lt;/p&gt;</comment>
                            <comment id="13620190" author="nehanarkhede" created="Tue, 2 Apr 2013 19:52:05 +0000"  >&lt;p&gt;+1 on the latest patch, thanks Swapnil!&lt;/p&gt;</comment>
                            <comment id="13621849" author="swapnilghike" created="Thu, 4 Apr 2013 06:19:37 +0000"  >&lt;p&gt;Did we check in the &apos;after-commit-v2&apos; patch? Thanks.&lt;/p&gt;</comment>
                            <comment id="13621861" author="nehanarkhede" created="Thu, 4 Apr 2013 06:43:40 +0000"  >&lt;p&gt;Committed &apos;after-commit-v2&apos; patch to 0.8&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12576438" name="kafka-840-after-commit-v1.patch" size="5943" author="swapnilghike" created="Mon, 1 Apr 2013 21:18:48 +0000"/>
                            <attachment id="12576640" name="kafka-840-after-commit-v2.patch" size="6231" author="swapnilghike" created="Tue, 2 Apr 2013 19:50:19 +0000"/>
                            <attachment id="12576206" name="kafka-840-v2.patch" size="7683" author="swapnilghike" created="Sat, 30 Mar 2013 00:39:28 +0000"/>
                            <attachment id="12575951" name="kafka-840.patch" size="1385" author="swapnilghike" created="Thu, 28 Mar 2013 21:14:27 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>320148</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 33 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1j8m7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>320489</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>