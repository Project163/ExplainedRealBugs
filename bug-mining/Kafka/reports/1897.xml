<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:10:06 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-6853] ResponseMetadata calculates latency incorrectly (and therefore ZooKeeperRequestLatencyMs is incorrect)</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-6853</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;responseTimeMs always negative.&lt;/p&gt;

&lt;p&gt;Currently:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;ResponseMetadata(sendTimeMs: &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;, receivedTimeMs: &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;) {
  def responseTimeMs: &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt; = sendTimeMs - receivedTimeMs
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Should be:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;ResponseMetadata(sendTimeMs: &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;, receivedTimeMs: &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;) {
  def responseTimeMs: &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt; = receivedTimeMs - sendTimeMs
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13156837">KAFKA-6853</key>
            <summary>ResponseMetadata calculates latency incorrectly (and therefore ZooKeeperRequestLatencyMs is incorrect)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="Fuud">Fuud</reporter>
                        <labels>
                    </labels>
                <created>Thu, 3 May 2018 11:20:40 +0000</created>
                <updated>Thu, 3 May 2018 16:55:24 +0000</updated>
                            <resolved>Thu, 3 May 2018 16:55:24 +0000</resolved>
                                    <version>1.1.0</version>
                                    <fixVersion>1.1.1</fixVersion>
                    <fixVersion>2.0.0</fixVersion>
                                    <component>core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16462292" author="githubbot" created="Thu, 3 May 2018 11:24:49 +0000"  >&lt;p&gt;Fuud opened a new pull request #4961: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6853&quot; title=&quot;ResponseMetadata calculates latency incorrectly (and therefore ZooKeeperRequestLatencyMs is incorrect)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-6853&quot;&gt;&lt;del&gt;KAFKA-6853&lt;/del&gt;&lt;/a&gt;: ResponseMetadata calculates latency incorrectly &lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/4961&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/4961&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   ResponseMetadata.responseTimeMs is always negative. &lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16462760" author="githubbot" created="Thu, 3 May 2018 16:46:33 +0000"  >&lt;p&gt;ijuma closed pull request #4961: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6853&quot; title=&quot;ResponseMetadata calculates latency incorrectly (and therefore ZooKeeperRequestLatencyMs is incorrect)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-6853&quot;&gt;&lt;del&gt;KAFKA-6853&lt;/del&gt;&lt;/a&gt;: ZooKeeperRequestLatencyMs is incorrect&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/4961&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/4961&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/core/src/main/scala/kafka/zookeeper/ZooKeeperClient.scala b/core/src/main/scala/kafka/zookeeper/ZooKeeperClient.scala&lt;br/&gt;
old mode 100644&lt;br/&gt;
new mode 100755&lt;br/&gt;
index 74a3a2db7ff..5c4cd685565&lt;br/&gt;
&amp;#8212; a/core/src/main/scala/kafka/zookeeper/ZooKeeperClient.scala&lt;br/&gt;
+++ b/core/src/main/scala/kafka/zookeeper/ZooKeeperClient.scala&lt;br/&gt;
@@ -476,7 +476,7 @@ sealed abstract class AsyncResponse {&lt;br/&gt;
 }&lt;/p&gt;

&lt;p&gt; case class ResponseMetadata(sendTimeMs: Long, receivedTimeMs: Long) &lt;/p&gt;
{
-  def responseTimeMs: Long = sendTimeMs - receivedTimeMs
+  def responseTimeMs: Long = receivedTimeMs - sendTimeMs
 }

&lt;p&gt; case class CreateResponse(resultCode: Code, path: String, ctx: Option&lt;span class=&quot;error&quot;&gt;&amp;#91;Any&amp;#93;&lt;/span&gt;, name: String, metadata: ResponseMetadata) extends AsyncResponse&lt;br/&gt;
diff --git a/core/src/test/scala/integration/kafka/api/MetricsTest.scala b/core/src/test/scala/integration/kafka/api/MetricsTest.scala&lt;br/&gt;
index baadd66382f..cea3d279d62 100644&lt;br/&gt;
&amp;#8212; a/core/src/test/scala/integration/kafka/api/MetricsTest.scala&lt;br/&gt;
+++ b/core/src/test/scala/integration/kafka/api/MetricsTest.scala&lt;br/&gt;
@@ -217,12 +217,16 @@ class MetricsTest extends IntegrationTestHarness with SaslSetup {&lt;br/&gt;
   }&lt;/p&gt;

&lt;p&gt;   private def verifyBrokerZkMetrics(server: KafkaServer, topic: String): Unit = &lt;/p&gt;
{
-    // Latency is rounded to milliseconds, so check the count instead.
-    val initialCount = yammerHistogramCount(&quot;kafka.server:type=ZooKeeperClientMetrics,name=ZooKeeperRequestLatencyMs&quot;)
+    val histogram = yammerHistogram(&quot;kafka.server:type=ZooKeeperClientMetrics,name=ZooKeeperRequestLatencyMs&quot;)
+    // Latency is rounded to milliseconds, so check the count instead
+    val initialCount = histogram.count
     servers.head.zkClient.getLeaderForPartition(new TopicPartition(topic, 0))
-    val newCount = yammerHistogramCount(&quot;kafka.server:type=ZooKeeperClientMetrics,name=ZooKeeperRequestLatencyMs&quot;)
+    val newCount = histogram.count
     assertTrue(&quot;ZooKeeper latency not recorded&quot;,  newCount &amp;gt; initialCount)
 
+    val min = histogram.min
+    assertTrue(s&quot;Min latency should not be negative: $min&quot;, min &amp;gt;= 0)
+
     assertEquals(s&quot;Unexpected ZK state&quot;, &quot;CONNECTED&quot;, yammerMetricValue(&quot;SessionState&quot;))
   }

&lt;p&gt;@@ -286,12 +290,12 @@ class MetricsTest extends IntegrationTestHarness with SaslSetup {&lt;br/&gt;
     }&lt;br/&gt;
   }&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private def yammerHistogramCount(name: String): Long = {&lt;br/&gt;
+  private def yammerHistogram(name: String): Histogram = {&lt;br/&gt;
     val allMetrics = Metrics.defaultRegistry.allMetrics.asScala&lt;br/&gt;
     val (_, metric) = allMetrics.find 
{ case (n, _) =&amp;gt; n.getMBeanName.endsWith(name) }
&lt;p&gt;       .getOrElse(fail(s&quot;Unable to find broker metric $name: allMetrics: ${allMetrics.keySet.map(_.getMBeanName)}&quot;))&lt;br/&gt;
     metric match {&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;case m: Histogram =&amp;gt; m.count&lt;br/&gt;
+      case m: Histogram =&amp;gt; m&lt;br/&gt;
       case m =&amp;gt; fail(s&quot;Unexpected broker metric of class ${m.getClass}&quot;)&lt;br/&gt;
     }&lt;br/&gt;
   }&lt;/li&gt;
&lt;/ul&gt;





&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 28 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3tasf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>