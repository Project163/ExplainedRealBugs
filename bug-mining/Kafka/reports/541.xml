<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:41:42 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-1702] Messages silently Lost by producer</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-1702</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>
&lt;p&gt;Hello,&lt;/p&gt;

&lt;p&gt;we lost millions of messages because of this &lt;tt&gt;try/catch&lt;/tt&gt; in  the producer &lt;tt&gt;DefaultEventHandler&lt;/tt&gt;:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/kafka/blob/0.8.1/core/src/main/scala/kafka/producer/async/DefaultEventHandler.scala#L114-L116&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/0.8.1/core/src/main/scala/kafka/producer/async/DefaultEventHandler.scala#L114-L116&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;If a Throwable is caught by this &lt;tt&gt;try/catch&lt;/tt&gt;, the retry policy will have no effect and all yet-to-be-sent messages are lost (the error will break the loop over the broker list).&lt;br/&gt;
This issue is very hard to detect because: the producer (async or sync) cannot even catch the error, and &lt;b&gt;all&lt;/b&gt; the metrics are updated as if everything was fine.&lt;/p&gt;

&lt;p&gt;Only the abnormal drop in the producers network I/O, or the incoming message rate on the brokers; or the alerting on errors in producer logs could have revealed the issue. &lt;/p&gt;

&lt;p&gt;This behavior was introduced by &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-300&quot; title=&quot;Implement leader election&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-300&quot;&gt;&lt;del&gt;KAFKA-300&lt;/del&gt;&lt;/a&gt;. I can&apos;t see a good reason for it, so here is a patch that will let the retry-policy do its job when such a &lt;tt&gt;Throwable&lt;/tt&gt; occurs.&lt;/p&gt;

&lt;p&gt;Thanks in advance for your help.&lt;/p&gt;

&lt;p&gt;Alexis&lt;/p&gt;

&lt;p&gt;ps: you might wonder how could this &lt;tt&gt;try/catch&lt;/tt&gt; ever caught something? &lt;tt&gt;DefaultEventHandler#groupMessagesToSet&lt;/tt&gt; looks so harmless. &lt;/p&gt;

&lt;p&gt;Here are the details:&lt;br/&gt;
We use Snappy compression. When the native snappy library is not installed on the host, Snappy, during the initialization of class &lt;tt&gt;org.xerial.snappy.Snappy&lt;/tt&gt;  will &lt;a href=&quot;https://github.com/xerial/snappy-java/blob/1.1.0/src/main/java/org/xerial/snappy/SnappyLoader.java#L312&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;write a C library&lt;/a&gt; in the JVM temp directory &lt;tt&gt;java.io.tmpdir&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;In our scenario, &lt;tt&gt;java.io.tmpdir&lt;/tt&gt; was a subdirectory of &lt;tt&gt;/tmp&lt;/tt&gt;. After an instance reboot (thank you &lt;a href=&quot;https://twitter.com/hashtag/AWSReboot?src=hash&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;AWS&lt;/a&gt;!), the JVM temp directory was removed. The JVM was then running with a non-existing temp dir. Snappy class would be impossible to initialize and the following message would be silently logged:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ERROR [2014-10-07 22:23:56,530] kafka.producer.async.DefaultEventHandler: Failed to send messages
! java.lang.NoClassDefFoundError: Could not initialize &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;org.xerial.snappy.Snappy
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</description>
                <environment></environment>
        <key id="12747623">KAFKA-1702</key>
            <summary>Messages silently Lost by producer</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="alexismidon">Alexis Midon</assignee>
                                    <reporter username="alexismidon">Alexis Midon</reporter>
                        <labels>
                    </labels>
                <created>Sun, 12 Oct 2014 23:42:56 +0000</created>
                <updated>Mon, 13 Oct 2014 23:17:03 +0000</updated>
                            <resolved>Mon, 13 Oct 2014 23:17:03 +0000</resolved>
                                    <version>0.8.1.1</version>
                                    <fixVersion>0.9.0.0</fixVersion>
                                    <component>producer </component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="14168929" author="junrao" created="Mon, 13 Oct 2014 04:15:11 +0000"  >&lt;p&gt;Thanks for the patch. Not sure why you want to wrap groupMessagesToSet in try/catch. I thought that&apos;s where the NoClassDefFoundError is thrown and you want to propagate it to the caller.&lt;/p&gt;

&lt;p&gt;With this patch, the producer in sync mode will get the exception. However, producer in async mode will still silently dropping messages. This is a general limitation and is being fixed in the new java producer through a callback.&lt;/p&gt;</comment>
                            <comment id="14168941" author="alexismidon" created="Mon, 13 Oct 2014 04:32:09 +0000"  >&lt;p&gt;I agree. In the async mode, until there is a callback, the best we can do is to make sure all the metrics are updated correctly, in particular ResendsPerSec, FailedSendsPerSec, which is critical for monitoring of async producers.&lt;/p&gt;

&lt;p&gt;In the sync mode, producer will get the exception, which is an improvement.&lt;/p&gt;

&lt;p&gt;thanks for your review&lt;/p&gt;</comment>
                            <comment id="14168942" author="alexismidon" created="Mon, 13 Oct 2014 04:35:43 +0000"  >&lt;p&gt;Also if #groupMessagesToSet is not in a try/catch, the error will break the loop on the broker list. All messages will get dropped, retries ignored, metrics won&apos;t get updated, etc.&lt;/p&gt;</comment>
                            <comment id="14170197" author="junrao" created="Mon, 13 Oct 2014 23:17:03 +0000"  >&lt;p&gt;Got it. +1 for the patch. Committed to trunk.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12674438" name="KAFKA-1702.0.patch" size="6980" author="alexismidon" created="Sun, 12 Oct 2014 23:45:28 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 6 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i21353:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>