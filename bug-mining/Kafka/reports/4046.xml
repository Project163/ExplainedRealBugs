<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:41:34 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-18418] Flaky test in KafkaStreamsTest::shouldThrowOnCleanupWhileShuttingDownStreamClosedWithCloseOptionLeaveGroupFalse</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-18418</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;KafkaStreams does not synchronize with CloseThread after shutdown thread starts at line &lt;a href=&quot;https://github.com/apache/kafka/blob/c1163549081561cade03bbc6a29bfe6caad332a2/streams/src/main/java/org/apache/kafka/streams/KafkaStreams.java#L1571&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/c1163549081561cade03bbc6a29bfe6caad332a2/streams/src/main/java/org/apache/kafka/streams/KafkaStreams.java#L1571&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;So it is possible for the shutdown helper update the state of the KafkaStreams (&lt;a href=&quot;https://github.com/apache/kafka/blob/c1163549081561cade03bbc6a29bfe6caad332a2/streams/src/main/java/org/apache/kafka/streams/KafkaStreams.java#L1530&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/c1163549081561cade03bbc6a29bfe6caad332a2/streams/src/main/java/org/apache/kafka/streams/KafkaStreams.java#L1530&lt;/a&gt;) before `waitOnState` is called (&lt;a href=&quot;https://github.com/apache/kafka/blob/c1163549081561cade03bbc6a29bfe6caad332a2/streams/src/main/java/org/apache/kafka/streams/KafkaStreams.java#L1577&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/c1163549081561cade03bbc6a29bfe6caad332a2/streams/src/main/java/org/apache/kafka/streams/KafkaStreams.java#L1577&lt;/a&gt;).  &lt;/p&gt;

&lt;p&gt;If this happens, `KafkaStreamsTest::shouldThrowOnCleanupWhileShuttingDownStreamClosedWithCloseOptionLeaveGroupFalse` will fail. &lt;/p&gt;

&lt;p&gt;Trace:&lt;br/&gt;
```&lt;br/&gt;
Gradle Test Run :streams:test &amp;gt; Gradle Test Executor 7 &amp;gt; KafkaStreamsTest &amp;gt; shouldThrowOnCleanupWhileShuttingDownStreamClosedWithCloseOptionLeaveGroupFalse() FAILED&lt;br/&gt;
    java.lang.AssertionError:&lt;br/&gt;
    Expected: &amp;lt;true&amp;gt;&lt;br/&gt;
         but: was &amp;lt;false&amp;gt;&lt;br/&gt;
        at org.hamcrest.MatcherAssert.assertThat(MatcherAssert.java:20)&lt;br/&gt;
        at org.hamcrest.MatcherAssert.assertThat(MatcherAssert.java:6)&lt;br/&gt;
        at org.apache.kafka.streams.KafkaStreamsTest.shouldThrowOnCleanupWhileShuttingDownStreamClosedWithCloseOptionLeaveGroupFalse(KafkaStreamsTest.java:986)&lt;br/&gt;
```&lt;/p&gt;

&lt;p&gt;Please check code &lt;a href=&quot;https://github.com/aoli-al/kafka/tree/KAFKA-159&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/aoli-al/kafka/tree/KAFKA-159&lt;/a&gt;, and run `./gradlew :streams:test --tests &quot;org.apache.kafka.streams.KafkaStreamsTest.shouldThrowOnCleanupWhileShuttingDownStreamClosedWithCloseOptionLeaveGroupFalse&quot;` to reproduce the failure.&lt;/p&gt;
</description>
                <environment></environment>
        <key id="13603972">KAFKA-18418</key>
            <summary>Flaky test in KafkaStreamsTest::shouldThrowOnCleanupWhileShuttingDownStreamClosedWithCloseOptionLeaveGroupFalse</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="aoli-al">Ao Li</assignee>
                                    <reporter username="aoli-al">Ao Li</reporter>
                        <labels>
                    </labels>
                <created>Mon, 6 Jan 2025 19:37:46 +0000</created>
                <updated>Thu, 9 Jan 2025 18:20:27 +0000</updated>
                            <resolved>Thu, 9 Jan 2025 18:20:27 +0000</resolved>
                                                    <fixVersion>4.1.0</fixVersion>
                                    <component>streams</component>
                    <component>unit tests</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17910404" author="JIRAUSER306156" created="Mon, 6 Jan 2025 21:01:27 +0000"  >&lt;p&gt;Actually, many tests fail because of this:&lt;/p&gt;

&lt;p&gt;KafkaStreamsTest.shouldNotBlockInCloseForZeroDuration&lt;br/&gt;
KafkaStreamsTest.shouldReturnFalseOnCloseWhenThreadsHaventTerminated&lt;br/&gt;
KafkaStreamsTest.shouldNotBlockInCloseWithCloseOptionLeaveGroupFalseForZeroDuration&lt;br/&gt;
KafkaStreamsTest.shouldReturnFalseOnCloseWithCloseOptionWithLeaveGroupTrueWhenThreadsHaventTerminated&lt;br/&gt;
KafkaStreamsTest.shouldNotBlockInCloseWithCloseOptionLeaveGroupTrueForZeroDuration&lt;br/&gt;
KafkaStreamsTest.shouldReturnFalseOnCloseWithCloseOptionWithLeaveGroupFalseWhenThreadsHaventTerminated&lt;br/&gt;
KafkaStreamsTest.shouldThrowOnCleanupWhileShuttingDown&lt;/p&gt;

&lt;p&gt;Maybe its worth to find a fix in the KafkaStreams instead of fixing each unit test. &lt;/p&gt;</comment>
                            <comment id="17910473" author="mjsax" created="Tue, 7 Jan 2025 02:14:02 +0000"  >&lt;p&gt;Thanks for filing this ticket. I understand the race condition for `shouldThrowOnCleanupWhileShuttingDownStreamClosedWithCloseOptionLeaveGroupFalse()` &#8211; great find!&lt;/p&gt;

&lt;p&gt;However, I don&apos;t think that your PR actually fully fixes it &#8211; left a commend on the PR.&lt;/p&gt;

&lt;p&gt;The fix I propose should hopefully fix all tests? &#8211; I don&apos;t think there is a bug in `KafkaStreams` class, so nothing to be fixed there &#8211; it&apos;s really a testing setup race-condition IMHO.&lt;/p&gt;</comment>
                            <comment id="17910687" author="JIRAUSER306156" created="Tue, 7 Jan 2025 16:37:01 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mjsax&quot; class=&quot;user-hover&quot; rel=&quot;mjsax&quot;&gt;mjsax&lt;/a&gt; Thanks for your comments! I&apos;ve submitted a new PR based on your review. &lt;/p&gt;

&lt;p&gt;This time, I also tested the new patch using &lt;a href=&quot;https://github.com/cmu-pasta/fray&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Fray&lt;/a&gt;, and it did not report any issue after 10 minutes. (p.s. if you are interested, Fray is a concurrency testing framework we built to test concurrent programs under different thread interleavings deterministically. You may have noticed that I submitted many bug reports related to concurrency issues, and they were all found by Fray!)&lt;/p&gt;</comment>
                            <comment id="17910910" author="mjsax" created="Wed, 8 Jan 2025 03:02:23 +0000"  >&lt;p&gt;Thanks. Interesting.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;You may have noticed that I submitted many bug reports related to concurrency issues, and they were all found by Fray&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Yes, I did notice. Super helpful!&lt;/p&gt;

&lt;p&gt;\cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cadonna&quot; class=&quot;user-hover&quot; rel=&quot;cadonna&quot;&gt;cadonna&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lucasbru&quot; class=&quot;user-hover&quot; rel=&quot;lucasbru&quot;&gt;lucasbru&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bbejeck&quot; class=&quot;user-hover&quot; rel=&quot;bbejeck&quot;&gt;bbejeck&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=alisa23&quot; class=&quot;user-hover&quot; rel=&quot;alisa23&quot;&gt;alisa23&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ableegoldman&quot; class=&quot;user-hover&quot; rel=&quot;ableegoldman&quot;&gt;ableegoldman&lt;/a&gt;&#160;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            43 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1tfxs:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>