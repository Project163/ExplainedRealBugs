<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:24:34 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-9374] Worker can be disabled by blocked connectors</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-9374</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;If a connector hangs during any of its &lt;tt&gt;initialize&lt;/tt&gt;, &lt;tt&gt;start&lt;/tt&gt;, &lt;tt&gt;stop&lt;/tt&gt;, &lt;tt&gt;taskConfigs&lt;/tt&gt;, &lt;tt&gt;taskClass&lt;/tt&gt;, &lt;tt&gt;version&lt;/tt&gt;, &lt;tt&gt;config&lt;/tt&gt;, or &lt;tt&gt;validate&lt;/tt&gt; methods, the worker will be disabled for some types of requests thereafter, including connector creation, connector reconfiguration, and connector deletion.&lt;br/&gt;
&lt;del&gt;This only occurs in distributed mode and is due to the threading model used by the &lt;a href=&quot;https://github.com/apache/kafka/blob/03f763df8a8d9482d8c099806336f00cf2521465/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/distributed/DistributedHerder.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;DistributedHerder&lt;/a&gt; class.&lt;/del&gt; This affects both distributed and standalone mode. Distributed herders perform some connector work synchronously in their &lt;tt&gt;tick&lt;/tt&gt; thread, which also handles group membership and some REST requests. The majority of the herder methods for the standalone herder are &lt;tt&gt;synchronized&lt;/tt&gt;, including those for creating, updating, and deleting connectors; as long as one of those methods blocks, all subsequent calls to any of these methods will also be blocked.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;One potential solution could be to treat connectors that fail to start, stop, etc. in time similarly to tasks that fail to stop within the &lt;a href=&quot;https://github.com/apache/kafka/blob/03f763df8a8d9482d8c099806336f00cf2521465/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/WorkerConfig.java#L121-L126&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;task graceful shutdown timeout period&lt;/a&gt;&#160;by handling all connector interactions on a separate thread, waiting for them to complete within a timeout, and abandoning the thread (and transitioning the connector to the &lt;tt&gt;FAILED&lt;/tt&gt; state, if it has been created at all) if that timeout expires.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13277872">KAFKA-9374</key>
            <summary>Worker can be disabled by blocked connectors</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ChrisEgerton">Chris Egerton</assignee>
                                    <reporter username="ChrisEgerton">Chris Egerton</reporter>
                        <labels>
                    </labels>
                <created>Tue, 7 Jan 2020 07:15:14 +0000</created>
                <updated>Mon, 24 Jul 2023 07:13:53 +0000</updated>
                            <resolved>Thu, 11 Jun 2020 15:25:13 +0000</resolved>
                                    <version>1.0.0</version>
                    <version>1.0.1</version>
                    <version>1.0.2</version>
                    <version>1.1.0</version>
                    <version>1.1.1</version>
                    <version>2.0.0</version>
                    <version>2.0.1</version>
                    <version>2.1.0</version>
                    <version>2.1.1</version>
                    <version>2.2.0</version>
                    <version>2.2.1</version>
                    <version>2.2.2</version>
                    <version>2.3.0</version>
                    <version>2.3.1</version>
                    <version>2.4.0</version>
                                    <fixVersion>2.6.0</fixVersion>
                                    <component>connect</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17009522" author="tombentley" created="Tue, 7 Jan 2020 08:56:10 +0000"  >&lt;p&gt;&quot;Abandoning&quot; the thread isn&apos;t really a solution. You cannot be sure that thread will ever die. Abandon enough threads and it starts to look like a resource leak. Also, any connector which hangs in one of those methods is buggy and that bug will come to light (and potentially be fixed) sooner if the connector fails in a noticeable way which the end user is likely to notice. By papering over the cracks like this isn&apos;t the end user more likely to just try recreating the connector (which maybe works some of the time)? Thus potentially letting the bug live longer?&lt;/p&gt;</comment>
                            <comment id="17009998" author="chrisegerton" created="Tue, 7 Jan 2020 19:02:32 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tombentley&quot; class=&quot;user-hover&quot; rel=&quot;tombentley&quot;&gt;tombentley&lt;/a&gt;&#160;yeah, it&apos;s not great if a lot threads are created and then abandoned. However, I&apos;d like to make the following observations:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;We already use this approach with connector tasks and it seems to be working well enough; the only time in the wild I&apos;ve seen it be a problem is due to an issue in the Connect framework, specifically &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-9051&quot; title=&quot;Source task source offset reads can block graceful shutdown&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-9051&quot;&gt;&lt;del&gt;KAFKA-9051&lt;/del&gt;&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;A single poorly-behaved connector should not be able to block the worker&apos;s REST API; users could have dozens if not hundreds of connectors running on their worker&lt;/li&gt;
	&lt;li&gt;If a connector config has already been written to the config topic but the connector blocks in its &lt;tt&gt;start&lt;/tt&gt; method, removing it can be extremely difficult if the worker that&apos;s blocked by that connector is the leader or if the cluster only consists of a single worker; it may even be necessary to directly write to the internal config topic to do so&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Because we want the worker to remain available even when connectors hang, I think sacrificing a thread in this situation is preferable to sacrificing the entire worker. If there&apos;s a way to avoid continually creating and then abandoning new threads when poorly-behaved connectors are created and then block indefinitely &lt;em&gt;and&lt;/em&gt; keep the worker going with no impact on the REST API or other connectors and tasks, we should definitely consider it. However, as far as I know, once a Java thread is blocked there is no guaranteed, safe way of blocking or terminating it (well, besides &lt;a href=&quot;https://stackoverflow.com/a/32909191/12417563&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;As far as failing the connector in a noticeable way&#8211;I completely agree. I mentioned that we could transition connectors that have at least been created (i.e., written to the config topic) to a failed state should they block for too long, which would be a start as far as alerting the user that their connector is buggy goes. Additionally, if a connector blocks in something like its &lt;tt&gt;validate&lt;/tt&gt; or &lt;tt&gt;config&lt;/tt&gt; method, we could also fail the REST request that led to that method invocation.&lt;/p&gt;</comment>
                            <comment id="17010527" author="tombentley" created="Wed, 8 Jan 2020 09:52:18 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ChrisEgerton&quot; class=&quot;user-hover&quot; rel=&quot;ChrisEgerton&quot;&gt;ChrisEgerton&lt;/a&gt; yeah, I agree there&apos;s no tenable alternative for recovering the thread, and protecting the worker is a worthy aim. I like the idea of using an error response (for those cases associated with a request) in addition to transitioning the connector to failed.&lt;/p&gt;

&lt;p&gt;Would the timeout be configurable (not arguing that it should, merely asking)?&lt;/p&gt;</comment>
                            <comment id="17032791" author="githubbot" created="Sat, 8 Feb 2020 02:36:58 +0000"  >&lt;p&gt;C0urante commented on pull request #8069: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-9374&quot; title=&quot;Worker can be disabled by blocked connectors&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-9374&quot;&gt;&lt;del&gt;KAFKA-9374&lt;/del&gt;&lt;/a&gt;: Make connector interactions asynchronous&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/8069&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/8069&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   &lt;span class=&quot;error&quot;&gt;&amp;#91;Jira ticket&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-9374&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-9374&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;   These changes allow herders to continue to function even when a connector they&lt;br/&gt;
   are running hangs in its start, stop, initialize, validate, and/or config&lt;br/&gt;
   methods.&lt;/p&gt;

&lt;p&gt;   The main idea is to make these connector interactions asynchronous and accept&lt;br/&gt;
   a callback that can be invoked upon the completion (successful or otherwise) of&lt;br/&gt;
   these interactions. The distributed herder handles any follow-up logic by adding&lt;br/&gt;
   a new herder request to its queue in that callback, which helps preserve some&lt;br/&gt;
   synchronization and ordering guarantees provided by the current tick model.&lt;/p&gt;

&lt;p&gt;   There are several items that still need to be addressed:&lt;/p&gt;

&lt;p&gt;   1)  The standalone herder has not been updated to utilize the new asynchronous&lt;br/&gt;
       connector wrapper API provided by the Worker and AbstractHerder classes&lt;/p&gt;

&lt;p&gt;   2)  There is a minor TODO in the DistributedHerderTest class regarding the need&lt;br/&gt;
       to migrate some testing logic into the AbstractHerderTest class&lt;/p&gt;

&lt;p&gt;   3)  More significantly, since connector shutdown is now handled asynchronously,&lt;br/&gt;
       there are two problems with the current changes:&lt;/p&gt;

&lt;p&gt;       a - It is possible (even likely) that a new instance of a connector will be&lt;br/&gt;
           created before an older instance has been shut down. This is especially&lt;br/&gt;
           problematic if a connector claims a shared resource such as a port&lt;br/&gt;
           number and could potentially lead to unnecessary connector failure on&lt;br/&gt;
           startup.&lt;/p&gt;

&lt;p&gt;       b - There is no time allocated during shutdown of the herder for its&lt;br/&gt;
           connectors to shutdown, which may lead to improper resource cleanup.&lt;/p&gt;

&lt;p&gt;   Existing unit tests for the distributed herder and worker have been modified to reflect these changes, and a new integration test named `BlockingConnectorTest` has been added to ensure that they work in practice.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="17034006" author="chrisegerton" created="Mon, 10 Feb 2020 23:12:03 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tombentley&quot; class=&quot;user-hover&quot; rel=&quot;tombentley&quot;&gt;tombentley&lt;/a&gt;, sorry for the delay in reply.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;After some thought, it seems that setting a timeout on interactions with connectors but keeping those actions synchronous within the herder&apos;s tick method isn&apos;t really a viable approach. There doesn&apos;t seem to be a good value to use for that timeout; if it&apos;s too conservative it may be impossible to start some connectors that have to do heavy-duty initialization on startup, and if it&apos;s too liberal there will still be the original problem (for however long the timeout is) of the worker being effectively disabled during that period, and potentially even dropping out of the group due.&lt;/p&gt;

&lt;p&gt;Instead, in&#160;&lt;a href=&quot;https://github.com/apache/kafka/pull/8069&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/8069&lt;/a&gt;, I&apos;ve made changes to make most connector interactions (specifically, calls to the start, &lt;tt&gt;stop&lt;/tt&gt;, &lt;tt&gt;config&lt;/tt&gt;, &lt;tt&gt;validate&lt;/tt&gt;, and &lt;tt&gt;initialize&lt;/tt&gt; methods)&#160;completely asynchronous and handle any follow-up logic via callback. In the &lt;tt&gt;DistributedHerder&lt;/tt&gt; class, this callback adds a new herder request to the queue, which helps keep the class thread-safe and preserves some of the guarantees provided by the current &lt;tt&gt;tick&lt;/tt&gt; model.&lt;/p&gt;

&lt;p&gt;Unfortunately, this means that status tracking for connectors becomes... difficult. If we don&apos;t establish a timeout for any of our connector interactions, we also then don&apos;t have a good metric for know if/when to update the status of a connector to &lt;tt&gt;FAILED&lt;/tt&gt;. At this point, the best we may be able to do is include log messages detailing when certain connector interactions are scheduled, and when those interactions are complete. That should at least provide a decent method for diagnosing via log files whether a connector is blocking and effectively a zombie. In the future, a KIP may be warranted for adding a new metric to track the number and types of zombie connectors/tasks.&lt;/p&gt;

&lt;p&gt;This also still leaves the door open for zombie thread creation; any connector that blocks in any of the aforementioned methods will still be taking up a thread until/unless it returns control to the framework.&lt;/p&gt;</comment>
                            <comment id="17133331" author="rhauch" created="Thu, 11 Jun 2020 15:25:13 +0000"  >&lt;p&gt;Merged to `trunk` and backported to the `2.6` branch for inclusion in 2.6.0.&lt;/p&gt;</comment>
                            <comment id="17358713" author="rhauch" created="Mon, 7 Jun 2021 16:34:58 +0000"  >&lt;p&gt;Please ignore link to &lt;a href=&quot;https://github.com/apache/kafka/pull/10833&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;GitHub Pull Request #10833&lt;/a&gt;. I created it with the wrong KAFKA issue number.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13382500">KAFKA-12904</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13544600">KAFKA-15238</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13522596">KAFKA-14670</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13303713">KAFKA-9975</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 23 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0a90w:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>kkonstantine</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>