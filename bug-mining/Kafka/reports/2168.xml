<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:17:10 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-7672] The local state not fully restored after KafkaStream rebalanced, resulting in data loss</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-7672</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Normally, when a task is&#160;migrated to a new thread and no checkpoint file was found under its task folder, Kafka Stream needs to restore the local state for remote changelog topic completely and then resume&#160;running. However, in some scenarios, we found&#160;that Kafka Stream &lt;b&gt;NOT&lt;/b&gt;&#160;restore this state even no checkpoint was found, but just clean the state folder and transition to running state directly, resulting the historic data loss.&#160;&lt;/p&gt;

&lt;p&gt;To be specific, I will give the detailed logs for Kafka Stream in our project to show this scenario:&#160;&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;2018-10-23 08:27:07,684 INFO&#160; org.apache.kafka.clients.consumer.internals.ConsumerCoordinator - &lt;span class=&quot;error&quot;&gt;&amp;#91;Consumer clientId=AuditTrailBatch-StreamThread-1-consumer, groupId=AuditTrailBatch&amp;#93;&lt;/span&gt; Revoking previously assigned partitions &lt;span class=&quot;error&quot;&gt;&amp;#91;AuditTrailBatch-0-5&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;2018-10-23 08:27:07,684 INFO&#160; org.apache.kafka.streams.processor.internals.StreamThread&#160;&#160;&#160; - stream-thread &lt;span class=&quot;error&quot;&gt;&amp;#91;AuditTrailBatch-StreamThread-1&amp;#93;&lt;/span&gt; State transition from PARTITIONS_ASSIGNED to PARTITIONS_REVOKED&lt;/p&gt;

&lt;p&gt;2018-10-23 08:27:10,856 INFO&#160; org.apache.kafka.clients.consumer.internals.AbstractCoordinator - &lt;span class=&quot;error&quot;&gt;&amp;#91;Consumer clientId=AuditTrailBatch-StreamThread-1-consumer, groupId=AuditTrailBatch&amp;#93;&lt;/span&gt; (Re-)joining group&lt;/p&gt;

&lt;p&gt;2018-10-23 08:27:53,153 INFO&#160; org.apache.kafka.clients.consumer.internals.AbstractCoordinator - &lt;span class=&quot;error&quot;&gt;&amp;#91;Consumer clientId=AuditTrailBatch-StreamThread-1-consumer, groupId=AuditTrailBatch&amp;#93;&lt;/span&gt; Successfully joined group with generation 323&lt;/p&gt;

&lt;p&gt;2018-10-23 08:27:53,153 INFO&#160; org.apache.kafka.clients.consumer.internals.ConsumerCoordinator - &lt;span class=&quot;error&quot;&gt;&amp;#91;Consumer clientId=AuditTrailBatch-StreamThread-1-consumer, groupId=AuditTrailBatch&amp;#93;&lt;/span&gt; Setting newly assigned partitions &lt;span class=&quot;error&quot;&gt;&amp;#91;AuditTrailBatch-store1-repartition-1&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;2018-10-23 08:27:53,153 INFO&#160; org.apache.kafka.streams.processor.internals.StreamThread&#160;&#160;&#160; - stream-thread &lt;span class=&quot;error&quot;&gt;&amp;#91;AuditTrailBatch-StreamThread-1&amp;#93;&lt;/span&gt; State transition from PARTITIONS_REVOKED to PARTITIONS_ASSIGNED&lt;/p&gt;

&lt;p&gt;2018-10-23 08:27:53,153 INFO&#160; org.apache.kafka.streams.processor.internals.StreamThread&#160;&#160;&#160; - stream-thread &lt;span class=&quot;error&quot;&gt;&amp;#91;AuditTrailBatch-StreamThread-1&amp;#93;&lt;/span&gt; &lt;b&gt;Creating producer client for task 1_1&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;2018-10-23 08:27:53,622 INFO&#160; org.apache.kafka.streams.processor.internals.StreamThread&#160;&#160;&#160; - stream-thread &lt;span class=&quot;error&quot;&gt;&amp;#91;AuditTrailBatch-StreamThread-1&amp;#93;&lt;/span&gt; partition assignment took 469 ms.&lt;/p&gt;

&lt;p&gt;2018-10-23 08:27:54,357 INFO&#160; org.apache.kafka.streams.processor.internals.StoreChangelogReader - stream-thread &lt;span class=&quot;error&quot;&gt;&amp;#91;AuditTrailBatch-StreamThread-1&amp;#93;&lt;/span&gt;&lt;b&gt;No checkpoint found for task 1_1 state store AuditTrailBatch-store1-changelog-1 with EOS turned on.&lt;/b&gt; &lt;b&gt;Reinitializing the task and restore its state from the beginning.&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;2018-10-23 08:27:54,357 INFO&#160; org.apache.kafka.clients.consumer.internals.Fetcher&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; - &lt;span class=&quot;error&quot;&gt;&amp;#91;Consumer clientId=AuditTrailBatch-StreamThread-1-restore-consumer, groupId=&amp;#93;&lt;/span&gt;&lt;b&gt;Resetting offset for partition AuditTrailBatch-store1-changelog-1 to offset 0.&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;2018-10-23 08:27:54,653 INFO&#160; org.apache.kafka.streams.processor.internals.StreamThread&#160;&#160;&#160; - stream-thread &lt;span class=&quot;error&quot;&gt;&amp;#91;AuditTrailBatch-StreamThread-1&amp;#93;&lt;/span&gt;&lt;b&gt;State transition from PARTITIONS_ASSIGNED to RUNNING&lt;/b&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;From the logs above, we can get the procedure for thread AuditTrailBatch-StreamThread-1:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;the previous running task&#160;assigned to&#160;thread 1 is task 0_5 (the corresponding&#160;partition is AuditTrailBatch-0-5)&lt;/li&gt;
	&lt;li&gt;group begins to rebalance, the new task 1_1 is assigned to thread 1.&lt;/li&gt;
	&lt;li&gt;no checkpoint was found under 1_1 state folder, so reset the offset to 0 and clean the local state folder.&lt;/li&gt;
	&lt;li&gt;thread&#160;1 transitions to RUNNING state directly without the restoration for task 1_1,&#160;so the historic data for state 1_1 is lost for thread 1.&#160;&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&lt;b&gt;ThoubleShoot&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;To investigate the cause for this issue, we analysis the source code in KafkaStream and found the key is the variable named &quot;completedRestorers&quot;.&lt;/p&gt;

&lt;p&gt;This is the definition of the variable:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Set&amp;lt;TopicPartition&amp;gt; completedRestorers = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HashSet&amp;lt;&amp;gt;();&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Each thread object has its own&#160;completedRestorers, which is created in the thread initialization, and not accessed crossly by other threads. The completedRestorers is used to record the partitions that has been restored completely in the thread.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (restorer.hasCompleted(pos, endOffsets.get(partition))) {
  restorer.restoreDone();
  endOffsets.remove(partition);
  completedRestorers.add(partition);
}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Once the partition is added to&#160;completedRestorers set, it will be returned by&#160;restore() and pass to the next caller&#160;updateRestored(), and then the transitionToRunning() will set this task to running state.&#160;&lt;/p&gt;

&lt;p&gt;But we found that&#160;completedRestorers &lt;b&gt;never&lt;/b&gt; be cleared during the&#160;life cycle of this thread, even in the reset function:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;//org/apache/kafka/streams/processor/internals/StoreChangelogReader.java
&lt;/span&gt;
@Override
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void reset() {
 partitionInfo.clear();
 stateRestorers.clear();
 needsRestoring.clear();
 endOffsets.clear();
 needsInitializing.clear();
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;It will cause a problem: we assume that the task 1 once assigned to thread A, so its partition has been added to completeRestores. Then it&#160;migrated to another thread (maybe in a different instance). After several rounds of rebalancing, it transitioned to thread A again and no checkpoint was here for some reason.&#160;The right way&#160;is to clean the state folder and restore it for beginning, but now, it found this task&apos;s partition&#160;is already in&#160;completedRestorers list, so it will consider&#160;this task as restored completely and resumed running directly.&lt;/p&gt;

&lt;p&gt;To avoid it, we should clean the historical&#160;completedRestorers set every time after reassignment.&#160;So I add the clear operation in the reset() and validate it works.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;//org/apache/kafka/streams/processor/internals/StoreChangelogReader.java
&lt;/span&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void reset() {
  partitionInfo.clear();
  stateRestorers.clear();
  needsRestoring.clear();
  endOffsets.clear();
  needsInitializing.clear();
  &lt;span class=&quot;code-comment&quot;&gt;//add by linyli
&lt;/span&gt;  completedRestorers.clear();
 }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;PS:&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;In addition, I also investigate why no checkpoint was found for this state sometimes, and I found that the most common sense is when a task is&#160;migrated from one thread to another thread in the &lt;b&gt;same&lt;/b&gt; instance.&lt;/p&gt;

&lt;p&gt;Why?&lt;/p&gt;

&lt;p&gt;From source code about task reassignment, we know that the task needs write to its checkpoint file in EOS when it&apos;s closed by the previous thread, and the next thread will create the task and read from the checkpoint file for restoration. But the read/write process for this checkpoint file is&#160;Asynchronous! So it&apos;s most probably that the next thread read before the previous one finished writing, causing no checkpoint found issue and need extra restoration, which is totally a waste of time and network.&lt;/p&gt;

&lt;p&gt;To avoid the concurrency of read/write, I advise to add some wait time when read checkpoint to restore.&lt;/p&gt;

&lt;p&gt;This is my fix:&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;//org/apache/kafka/streams/processor/internals/AbstractStateManager.java
&lt;/span&gt;AbstractStateManager(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; File baseDir,
 &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; eosEnabled) {
 &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.baseDir = baseDir;
 &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.eosEnabled = eosEnabled;

 &lt;span class=&quot;code-comment&quot;&gt;//add by linyli to fix checkpoint file latency in the same instance.
&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt;
 {
   File checkpointfile = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; File(baseDir, CHECKPOINT_FILE_NAME);
   &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(!checkpointfile.exists()) {
     &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(1000);
 }
 }&lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (InterruptedException e)
 {

 }

 &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.checkpoint = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; OffsetCheckpoint(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; File(baseDir, CHECKPOINT_FILE_NAME));
}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13200478">KAFKA-7672</key>
            <summary>The local state not fully restored after KafkaStream rebalanced, resulting in data loss</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="linyli">linyue li</assignee>
                                    <reporter username="linyli">linyue li</reporter>
                        <labels>
                    </labels>
                <created>Mon, 26 Nov 2018 03:31:46 +0000</created>
                <updated>Thu, 18 Apr 2019 22:26:03 +0000</updated>
                            <resolved>Sat, 23 Feb 2019 05:51:10 +0000</resolved>
                                    <version>1.1.0</version>
                    <version>1.1.1</version>
                    <version>2.0.0</version>
                    <version>2.1.0</version>
                                    <fixVersion>2.2.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>3</votes>
                                    <watches>20</watches>
                                                                                                                <comments>
                            <comment id="16698502" author="mjsax" created="Mon, 26 Nov 2018 06:03:01 +0000"  >&lt;p&gt;Thanks for reporting this and for the detailed analysis!&lt;/p&gt;</comment>
                            <comment id="16698803" author="bchen225242" created="Mon, 26 Nov 2018 11:17:40 +0000"  >&lt;p&gt;Thanks Linyue for reporting and reproducing the bug! In fact, we have also detected similar issue in our streaming use cases, fixing this would be of great value. For implementation detail, let&apos;s discuss some strong consistency guarantee instead of thread sleep, because I believe data loss is a non-tolerable issue for many use cases.&lt;/p&gt;

&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ishiihara&quot; class=&quot;user-hover&quot; rel=&quot;ishiihara&quot;&gt;ishiihara&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shnguyen&quot; class=&quot;user-hover&quot; rel=&quot;shnguyen&quot;&gt;shnguyen&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16705999" author="liquanpei" created="Sat, 1 Dec 2018 20:49:11 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=linyli&quot; class=&quot;user-hover&quot; rel=&quot;linyli&quot;&gt;linyli&lt;/a&gt; Do you plan to work on a fix for this issue?&#160;&lt;/p&gt;

&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mjsax&quot; class=&quot;user-hover&quot; rel=&quot;mjsax&quot;&gt;mjsax&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16706600" author="linyli" created="Mon, 3 Dec 2018 02:22:00 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=liquanpei&quot; class=&quot;user-hover&quot; rel=&quot;liquanpei&quot;&gt;liquanpei&lt;/a&gt; Ok, I will open a PR according to the fix given in my description.&lt;/p&gt;</comment>
                            <comment id="16706634" author="mjsax" created="Mon, 3 Dec 2018 03:49:22 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=linyli&quot; class=&quot;user-hover&quot; rel=&quot;linyli&quot;&gt;linyli&lt;/a&gt; Thanks for picking this up. However, I agree with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bchen225242&quot; class=&quot;user-hover&quot; rel=&quot;bchen225242&quot;&gt;bchen225242&lt;/a&gt; that adding `Thread.sleep()`&#160;does not seem to be&#160;a proper fix. I did not look into the details myself yet. Can you think of a fix that does not depend in timing and thus does not introduce a race condition? Or maybe &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bchen225242&quot; class=&quot;user-hover&quot; rel=&quot;bchen225242&quot;&gt;bchen225242&lt;/a&gt;? If necessary, I can help out, too.&lt;/p&gt;</comment>
                            <comment id="16706639" author="linyli" created="Mon, 3 Dec 2018 04:10:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mjsax&quot; class=&quot;user-hover&quot; rel=&quot;mjsax&quot;&gt;mjsax&lt;/a&gt; I&apos;ve not figured out the more suitable solution for race condition yet. I tried to use the signal to avoid read/write competition, but it may bring up some other complicated problems. Therefore, a more comprehensive considerations is &lt;font color=&quot;#333333&quot;&gt;needed for this issue&lt;/font&gt;. But my first fix in the reset() function can resolve the data loss issue, so could we create the PR just for the first fix and open another branch to fix the race condition issue?&#160;&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16706754" author="guozhang" created="Mon, 3 Dec 2018 06:50:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=linyli&quot; class=&quot;user-hover&quot; rel=&quot;linyli&quot;&gt;linyli&lt;/a&gt; Thanks for reporting the issues! I suggest you submit a PR for the first issue only as it is more straight-forward to fix.&lt;/p&gt;

&lt;p&gt;As for the second issue, one idea is to force the store flushing and checkpoint file writing in the task suspension when EOS is turned on, because due to the rebalance protocol we know that everyone will be synchronized at the rebalance barrier so no one would try to access any persistent storage that is being written during the task suspension call. Of course this would mean we reduce the effectiveness of task suspension / resumption and hence long latency, but it would provide the safest solution.&lt;/p&gt;</comment>
                            <comment id="16734415" author="bchen225242" created="Fri, 4 Jan 2019 17:59:18 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; Are you suggesting sth similar to this?&#160;&lt;a href=&quot;https://github.com/apache/kafka/compare/trunk...abbccdda:bug_fix&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/compare/trunk...abbccdda:bug_fix&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16734491" author="guozhang" created="Fri, 4 Jan 2019 19:08:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bchen225242&quot; class=&quot;user-hover&quot; rel=&quot;bchen225242&quot;&gt;bchen225242&lt;/a&gt; are you referring to the fix of the second issue? My suggestion was to check if EOS is turned on, and if yes, before writing the checkpoint file via {{ Utils.atomicMoveWithFallback}} call flush the corresponding store to make sure all data are persistent already.&lt;/p&gt;</comment>
                            <comment id="16734504" author="bchen225242" created="Fri, 4 Jan 2019 19:19:25 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; Yes the second issue. So since `atomicMoveWithFallback` is using NIO, will the operation introduce race condition for next task to read the checkpoint file if it doesn&apos;t exist already?&lt;/p&gt;</comment>
                            <comment id="16735387" author="guozhang" created="Mon, 7 Jan 2019 02:10:47 +0000"  >&lt;p&gt;Ah I see you point.&lt;/p&gt;

&lt;p&gt;I think the root cause of the second issue is that, &quot;read / write asynchronous&quot; but not on that single call. It is that the checkpoint file written only when the task is closed (not suspended). More specifically, a task&apos;s life time during rebalancing is that:&lt;/p&gt;

&lt;p&gt;1) before rebalance, suspend: commit, flush the store, BUT when EOS is turned on not writing checkpoint file.&lt;br/&gt;
2) after rebalance, closeSuspended: close stateManager, which will finally write the checkpoint file.&lt;/p&gt;

&lt;p&gt;There is a barrier between 1) and 2), but threads can execute step 2) in parallel. This means that when EOS is turned on, on thread may not finish closeSuspended and write the checkpoint file, while another thread has already executed step 2) to create the migrated-in task, and read the file and found it is not there. In this case, the other thread will re-bootstrap from beginning.&lt;/p&gt;

&lt;p&gt;The proposal I had is to enforce step 1) to also write the checkpoint file.&lt;/p&gt;</comment>
                            <comment id="16735422" author="bchen225242" created="Mon, 7 Jan 2019 03:40:01 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; Thanks for the explanation!&#160;It&apos;s a little bit confusing why we don&apos;t write checkpoint file when EOS is on... anyway is this the fix you are talking about:&#160;&lt;a href=&quot;https://github.com/apache/kafka/compare/trunk...abbccdda:bug_fix&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/compare/trunk...abbccdda:bug_fix&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16738896" author="guozhang" created="Thu, 10 Jan 2019 01:33:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=linyli&quot; class=&quot;user-hover&quot; rel=&quot;linyli&quot;&gt;linyli&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bchen225242&quot; class=&quot;user-hover&quot; rel=&quot;bchen225242&quot;&gt;bchen225242&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;While trying to prepare a PR for the first issue that was brought up I found its was actually a bit more complicated than what I thought. And this may be correlated to the reported issue in &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6767&quot; title=&quot;OffsetCheckpoint write assumes parent directory exists&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-6767&quot;&gt;KAFKA-6767&lt;/a&gt; as well. Here&apos;s a quick thing:&lt;/p&gt;

&lt;p&gt;1. During &lt;tt&gt;TaskManager#createTasks&lt;/tt&gt;, we currently have this logic:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        changelogReader.reset();
        standby.closeNonAssignedSuspendedTasks(assignedStandbyTasks);
        active.closeNonAssignedSuspendedTasks(assignedActiveTasks);
        addStreamTasks(assignment);
        addStandbyTasks();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This has a bunch of issues: first of all, for activeTasks, it may has both &quot;suspended&quot; and &quot;restoring&quot; tasks. We simply reset the changelogReader and then close suspended tasks, and then create new tasks and resume other suspended tasks. Which means that, &quot;restoring&quot; tasks are not closed in this phase, BUT its corresponding restorer may have been cleaned up. We should instead, close those restoring tasks that are not assigned in the new rebalance: I&apos;ve filed a WIP PR just to demonstrate this: &lt;a href=&quot;https://github.com/apache/kafka/pull/6113&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/6113&lt;/a&gt;. The point here is that, suppose we have a task checkpointed at 100, and log-end offset is 200, and by the time we trigger a new rebalance, this task has been restoring up to 150, but this task is not assigned to the thread anymore, we should close its states (note its topology is not initialized yet, only its state are initialized) and write the checkpoint file again with 150.&lt;/p&gt;

&lt;p&gt;Secondly, even with 6113 there are still a few race conditions: when closing a suspended task, or a restoring task (as in 6113), we maybe writing a checkpoint file, but at the same time another thread either within the same JVM or even at a different JVM (i.e. we may have more than one instance sitting at the same machine) reading this checkpoint file.&lt;/p&gt;

&lt;p&gt;So here&apos;s my proposal: &lt;/p&gt;

&lt;p&gt;1. I will finish up PR 6113 to &quot;close restoring tasks&quot; appropriately for now, and update the changelogReader accordingly. Part of this credit still belongs to &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=linyli&quot; class=&quot;user-hover&quot; rel=&quot;linyli&quot;&gt;linyli&lt;/a&gt; since you&apos;ve observed the issue.&lt;br/&gt;
2. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bchen225242&quot; class=&quot;user-hover&quot; rel=&quot;bchen225242&quot;&gt;bchen225242&lt;/a&gt; can complete the fix for the second issue.&lt;br/&gt;
3. After KIP-345, and we&apos;ve implemented the incremental rebalancing protocol as well. We should consider removing the whole logic of task-suspension / resumption as its benefits will be provided by the incremental rebalance already. This can largely cleanup our messy code hierarchy on assigned tasks / task manager as well.&lt;/p&gt;

&lt;p&gt;WDYT?&lt;/p&gt;</comment>
                            <comment id="16738897" author="guozhang" created="Thu, 10 Jan 2019 01:35:12 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bchen225242&quot; class=&quot;user-hover&quot; rel=&quot;bchen225242&quot;&gt;bchen225242&lt;/a&gt; I read your new fix, and it was not what I&apos;ve in mind actually. I was thinking to write the checkpoint file on &lt;tt&gt;StreamTask#suspend&lt;/tt&gt;, after we&apos;ve done the commit call.&lt;/p&gt;</comment>
                            <comment id="16738970" author="githubbot" created="Thu, 10 Jan 2019 04:08:02 +0000"  >&lt;p&gt;abbccdda commented on pull request #6115:  &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7672&quot; title=&quot;The local state not fully restored after KafkaStream rebalanced, resulting in data loss&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7672&quot;&gt;&lt;del&gt;KAFKA-7672&lt;/del&gt;&lt;/a&gt; : force write checkpoint during StreamTask #suspend&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/6115&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/6115&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   This fix is aiming for #2 issue pointed out within &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7672&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-7672&lt;/a&gt;&lt;br/&gt;
   In the current setup, we do offset checkpoint file write when EOS is turned on during #suspend, which introduces the potential race condition during StateManager #closeSuspend call. To mitigate the problem, we attempt to always write checkpoint file in #suspend call.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16738973" author="bchen225242" created="Thu, 10 Jan 2019 04:10:11 +0000"  >&lt;p&gt;Thanks for the thorough investigation and summary here &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt;! I updated the fix based on my understanding: &lt;a href=&quot;https://github.com/apache/kafka/pull/6115/files&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/6115/&lt;/a&gt;&#160;take another look when you got time, thank you!&lt;/p&gt;</comment>
                            <comment id="16740178" author="linyli" created="Fri, 11 Jan 2019 08:53:28 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Sorry to not fully understand the not closed restoring task you mentioned above. Is it the scenario when a task has so many records to restore from changelog topic that it not turns to RUNNING state from PARTITIONS_ASSIGNED state before a new rebalance arrives? So we should firstly close this restoring task with updated checkpoint file before the changelogReader reset all the info? &#160;&lt;/p&gt;

&lt;p&gt;And I also read your PR &lt;a href=&quot;https://github.com/apache/kafka/pull/6113/files&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/6113/files&lt;/a&gt; which already contains my fix,&#160; do I still need to contribute something else such like the test code? Thanks~&lt;/p&gt;</comment>
                            <comment id="16761686" author="suiyuan2009" created="Wed, 6 Feb 2019 11:55:52 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=linyli&quot; class=&quot;user-hover&quot; rel=&quot;linyli&quot;&gt;linyli&lt;/a&gt;, I also met this issue, but I find that if the program reached &quot;Reinitializing the task and restore its state from the beginning&quot; log, the statestore should be restored since following code is not related to `completedRestorers`. I also didn&apos;t find code like `if partition in completedRestorers, do nothing`..&lt;/p&gt;</comment>
                            <comment id="16762318" author="suiyuan2009" created="Thu, 7 Feb 2019 02:56:38 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=linyli&quot; class=&quot;user-hover&quot; rel=&quot;linyli&quot;&gt;linyli&lt;/a&gt;, I see, each time `restore` function only `poll` once, also each time when&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
No checkpoint found &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; task {} state store {} changelog {} with EOS turned on. Reinitializing the task and restore its state from the beginning
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;reached, this time&apos;s `restore` invocation will directly return the completed partitions since&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
needsRestoring.isEmpty()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;is true.&lt;/p&gt;

&lt;p&gt;We added some hack code to&#160;StateRestoreListener, but it didn&apos;t help, so I read the code again, seems even `onRestoreStart` will not be invoked..&lt;/p&gt;</comment>
                            <comment id="16763230" author="guozhang" created="Fri, 8 Feb 2019 01:54:32 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=linyli&quot; class=&quot;user-hover&quot; rel=&quot;linyli&quot;&gt;linyli&lt;/a&gt; I think if we can get both &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bchen225242&quot; class=&quot;user-hover&quot; rel=&quot;bchen225242&quot;&gt;bchen225242&lt;/a&gt;&apos;s PR and mine before the 2.2 release that would be great. Once it is merged I&apos;d appreciate if you can test them out and see if they indeed resolved the issue.&lt;/p&gt;</comment>
                            <comment id="16766723" author="linyli" created="Wed, 13 Feb 2019 03:09:51 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; Thanks for the fix, and I&apos;ll validate it once it&apos;s merged.&lt;/p&gt;</comment>
                            <comment id="16775500" author="githubbot" created="Fri, 22 Feb 2019 18:50:58 +0000"  >&lt;p&gt;guozhangwang commented on pull request #6113: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7672&quot; title=&quot;The local state not fully restored after KafkaStream rebalanced, resulting in data loss&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7672&quot;&gt;&lt;del&gt;KAFKA-7672&lt;/del&gt;&lt;/a&gt;: Restoring tasks need to be closed upon task suspension&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/6113&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/6113&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16775806" author="githubbot" created="Sat, 23 Feb 2019 05:49:31 +0000"  >&lt;p&gt;guozhangwang commented on pull request #6115:  &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7672&quot; title=&quot;The local state not fully restored after KafkaStream rebalanced, resulting in data loss&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7672&quot;&gt;&lt;del&gt;KAFKA-7672&lt;/del&gt;&lt;/a&gt; : force write checkpoint during StreamTask #suspend&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/6115&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/6115&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16775807" author="guozhang" created="Sat, 23 Feb 2019 05:51:10 +0000"  >&lt;p&gt;With both PRs merged in, I&apos;m resolving this ticket now. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=linyli&quot; class=&quot;user-hover&quot; rel=&quot;linyli&quot;&gt;linyli&lt;/a&gt; please feel free to validate if the newest 2.2 / trunk branch has fixed your observed issue.&lt;/p&gt;</comment>
                            <comment id="16821530" author="mjsax" created="Thu, 18 Apr 2019 22:26:03 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; Do&#160; you think it might be worth to backport this to older versions, too? The PR was rather complex, and I am not sure how severe we think this issue is?&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10430"><![CDATA[Patch]]></customfieldvalue>
    <customfieldvalue key="10431"><![CDATA[Important]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 30 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|s00ui0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>vvcephei</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>