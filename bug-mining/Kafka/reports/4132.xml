<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:42:28 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-18943] Kafka Streams incorrectly commits TX during task revokation</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-18943</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;We found a very rare edge case in Kafka Streams commit logic, that may lead to duplicates for EOSv2 under certain circumstances.&lt;/p&gt;

&lt;p&gt;Background:&lt;/p&gt;

&lt;p&gt;When tasks are revoked cleanly, we need to commit the progress the revoked tasks made before we can release them. For EOSv2, if we commit, a thread always needs to commit all tasks it owns. Thus, during revocation, if a single revoked tasks did make progress, we need to include all non-revoked task in the commit.&lt;/p&gt;

&lt;p&gt;To avoid unnecessary commits (which are expensive), we have an optimization in place, that is supposed to skip the commit, if no revoked task did make progress (ie, for revoked tasks w/o progress, we can release them safely w/o the need to commit, and if all tasks can be revoked w/o a commit, we don&apos;t commit at all).&lt;/p&gt;

&lt;p&gt;This optimization has a bug, and may commit an open TX, even if no revoked task did make progress, and because the commit is done accidentally, we do not add offsets to the TX. Thus, we may commit result data of non-revoked tasks, w/o including the non-revoked tasks advanced offsets.&lt;/p&gt;

&lt;p&gt;If this happens, and an fatal error happens right afterwards (ie before a consecutive commit for the same non-revoked tasks was done, which would mask the error by commit the correct offsets with the consecutive TX), we would seek to an incorrect (too old) offset after recovery, and re-process the same input data a second time, producing duplicate results.&lt;/p&gt;

&lt;p&gt;These issue results in duplicates if the following conditions are all met at the same time:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;a thread has more than one task assigned&lt;/li&gt;
	&lt;li&gt;when tasks are revoked, at least one task is not revoked&lt;/li&gt;
	&lt;li&gt;all revoked tasks did not make any progress (or to rephrase: no revoked task did make progress)&lt;/li&gt;
	&lt;li&gt;at least one non-revoked task did make progress&lt;/li&gt;
	&lt;li&gt;after the incorrect commit, and before the next successful commit, a fatal error happen, triggering a rebalance, task re-assignment and a &quot;fetch offsets&quot; happen after the rebalance&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The bug was introduced via &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-14294&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-14294&lt;/a&gt; in 3.4.0 release.&lt;/p&gt;

&lt;p&gt;Looking into the details, it actually seems that there is some other issue, that &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-14294&quot; title=&quot;Kafka Streams should commit transaction when no records are processed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-14294&quot;&gt;&lt;del&gt;KAFKA-14294&lt;/del&gt;&lt;/a&gt; did not address: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-14294&quot; title=&quot;Kafka Streams should commit transaction when no records are processed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-14294&quot;&gt;&lt;del&gt;KAFKA-14294&lt;/del&gt;&lt;/a&gt; attempts to commit tasks after output was produced by a punctuation, even if offsets did not advance. However, it does apply this logic only for regular commits, but for the task-revoked-case, we don&apos;t commit. Thus, if a revoked task did not advance offsets, but did produce output data, no commit happens (while it seems we should commit the open TX for this case, too; this might even apply to the ALOS case, too).&lt;/p&gt;

&lt;p&gt;Thus, there is two possible fixes.&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Try to identify all corner case and patch it up&lt;/li&gt;
	&lt;li&gt;Drop the optimization and just commit all tasks on `TaskManager#handleRevocation()`&lt;/li&gt;
&lt;/ol&gt;
</description>
                <environment></environment>
        <key id="13611104">KAFKA-18943</key>
            <summary>Kafka Streams incorrectly commits TX during task revokation</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mjsax">Matthias J. Sax</assignee>
                                    <reporter username="mjsax">Matthias J. Sax</reporter>
                        <labels>
                    </labels>
                <created>Fri, 7 Mar 2025 23:27:45 +0000</created>
                <updated>Sun, 28 Sep 2025 22:32:15 +0000</updated>
                            <resolved>Thu, 13 Mar 2025 23:58:53 +0000</resolved>
                                    <version>3.4.0</version>
                                    <fixVersion>3.9.1</fixVersion>
                    <fixVersion>4.0.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17935426" author="ableegoldman" created="Fri, 14 Mar 2025 06:59:31 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mjsax&quot; class=&quot;user-hover&quot; rel=&quot;mjsax&quot;&gt;mjsax&lt;/a&gt;&#160; this didn&apos;t get into 4.0. right? should we change the Fix version to 4.0.1? (unless in the unlikely event we have to roll a new RC for 4.0, in which case we could aim to include this fix in it)&lt;/p&gt;</comment>
                            <comment id="17935714" author="mjsax" created="Sat, 15 Mar 2025 08:09:34 +0000"  >&lt;p&gt;Due to RC4, we could actually include the fix in 4.0.0 &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&#160;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13485938">KAFKA-14294</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            34 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1unfs:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>