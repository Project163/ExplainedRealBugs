<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:12:28 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-7082] Concurrent createTopics calls may throw NodeExistsException</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-7082</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;This exception is unexpected causing an `UnknownServerException` to be thrown back to the client. Example below:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
org.apache.zookeeper.KeeperException$NodeExistsException: KeeperErrorCode = NodeExists &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; /config/topics/connect-configs
        at org.apache.zookeeper.KeeperException.create(KeeperException.java:119)
        at org.apache.zookeeper.KeeperException.create(KeeperException.java:51)
        at kafka.zookeeper.AsyncResponse.maybeThrow(ZooKeeperClient.scala:472)
        at kafka.zk.KafkaZkClient.createRecursive(KafkaZkClient.scala:1400)
        at kafka.zk.KafkaZkClient.create$1(KafkaZkClient.scala:262)
        at kafka.zk.KafkaZkClient.setOrCreateEntityConfigs(KafkaZkClient.scala:269)
        at kafka.zk.AdminZkClient.createOrUpdateTopicPartitionAssignmentPathInZK(AdminZkClient.scala:99)
        at kafka.server.AdminManager$$anonfun$2.apply(AdminManager.scala:126)
        at kafka.server.AdminManager$$anonfun$2.apply(AdminManager.scala:81)
        at scala.collection.TraversableLike$$anonfun$map$1.apply(TraversableLike.scala:234)
        at scala.collection.TraversableLike$$anonfun$map$1.apply(TraversableLike.scala:234)
        at scala.collection.Iterator$&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;foreach(Iterator.scala:891)
        at scala.collection.AbstractIterator.foreach(Iterator.scala:1334)
        at scala.collection.IterableLike$&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;foreach(IterableLike.scala:72)
        at scala.collection.AbstractIterable.foreach(Iterable.scala:54)
        at scala.collection.TraversableLike$&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;map(TraversableLike.scala:234)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13167250">KAFKA-7082</key>
            <summary>Concurrent createTopics calls may throw NodeExistsException</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ijuma">Ismael Juma</assignee>
                                    <reporter username="ijuma">Ismael Juma</reporter>
                        <labels>
                            <label>regression</label>
                    </labels>
                <created>Wed, 20 Jun 2018 20:33:33 +0000</created>
                <updated>Fri, 20 Jul 2018 11:00:35 +0000</updated>
                            <resolved>Thu, 21 Jun 2018 23:53:41 +0000</resolved>
                                    <version>1.1.0</version>
                                    <fixVersion>1.1.1</fixVersion>
                    <fixVersion>2.0.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16519850" author="githubbot" created="Thu, 21 Jun 2018 23:47:47 +0000"  >&lt;p&gt;ijuma closed pull request #5259: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7082&quot; title=&quot;Concurrent createTopics calls may throw NodeExistsException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7082&quot;&gt;&lt;del&gt;KAFKA-7082&lt;/del&gt;&lt;/a&gt;: Concurrent create topics may throw NodeExistsException&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5259&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5259&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/core/src/main/scala/kafka/zk/AdminZkClient.scala b/core/src/main/scala/kafka/zk/AdminZkClient.scala&lt;br/&gt;
index 8a6b3ee212d..060c0b4d4ae 100644&lt;br/&gt;
&amp;#8212; a/core/src/main/scala/kafka/zk/AdminZkClient.scala&lt;br/&gt;
+++ b/core/src/main/scala/kafka/zk/AdminZkClient.scala&lt;br/&gt;
@@ -93,7 +93,6 @@ class AdminZkClient(zkClient: KafkaZkClient) extends Logging {&lt;br/&gt;
                                                      update: Boolean = false) {&lt;br/&gt;
     validateCreateOrUpdateTopic(topic, partitionReplicaAssignment, config, update)&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// Configs only matter if a topic is being created. Changing configs via AlterTopic is not supported&lt;br/&gt;
     if (!update) 
{
       // write out the config if there is any, this isn&apos;t transactional with the partition assignments
       zkClient.setOrCreateEntityConfigs(ConfigType.Topic, topic, config)
diff --git a/core/src/main/scala/kafka/zk/KafkaZkClient.scala b/core/src/main/scala/kafka/zk/KafkaZkClient.scala
index bb342945ea8..ec4932ab47b 100644
--- a/core/src/main/scala/kafka/zk/KafkaZkClient.scala
+++ b/core/src/main/scala/kafka/zk/KafkaZkClient.scala
@@ -246,6 +246,12 @@ class KafkaZkClient private (zooKeeperClient: ZooKeeperClient, isSecure: Boolean
   /**
    * Sets or creates the entity znode path with the given configs depending
    * on whether it already exists or not.
+   *
+   * If this is method is called concurrently, the last writer wins. In cases where we update configs and then
+   * partition assignment (i.e. create topic), it&apos;s possible for one thread to set this and the other to set the
+   * partition assignment. As such, the recommendation is to never call create topic for the same topic with different
+   * configs/partition assignment concurrently.
+   *
    * @param rootEntityType entity type
    * @param sanitizedEntityName entity name
    * @throws KeeperException if there is an error while setting or creating the znode
@@ -257,16 +263,19 @@ class KafkaZkClient private (zooKeeperClient: ZooKeeperClient, isSecure: Boolean
       retryRequestUntilConnected(setDataRequest)
     }&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;def create(configData: Array&lt;span class=&quot;error&quot;&gt;&amp;#91;Byte&amp;#93;&lt;/span&gt;) = {&lt;br/&gt;
+    def createOrSet(configData: Array&lt;span class=&quot;error&quot;&gt;&amp;#91;Byte&amp;#93;&lt;/span&gt;): Unit = {&lt;br/&gt;
       val path = ConfigEntityZNode.path(rootEntityType, sanitizedEntityName)&lt;/li&gt;
	&lt;li&gt;createRecursive(path, ConfigEntityZNode.encode(config))&lt;br/&gt;
+      try createRecursive(path, ConfigEntityZNode.encode(config))&lt;br/&gt;
+      catch 
{
+        case _: NodeExistsException =&amp;gt; set(configData).maybeThrow
+      }
&lt;p&gt;     }&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     val configData = ConfigEntityZNode.encode(config)&lt;/p&gt;

&lt;p&gt;     val setDataResponse = set(configData)&lt;br/&gt;
     setDataResponse.resultCode match &lt;/p&gt;
{
-      case Code.NONODE =&amp;gt; create(configData)
+      case Code.NONODE =&amp;gt; createOrSet(configData)
       case _ =&amp;gt; setDataResponse.maybeThrow
     }
&lt;p&gt;   }&lt;br/&gt;
diff --git a/core/src/test/scala/unit/kafka/zk/AdminZkClientTest.scala b/core/src/test/scala/unit/kafka/zk/AdminZkClientTest.scala&lt;br/&gt;
index fe5fbff55d0..39745e5e608 100644&lt;br/&gt;
&amp;#8212; a/core/src/test/scala/unit/kafka/zk/AdminZkClientTest.scala&lt;br/&gt;
+++ b/core/src/test/scala/unit/kafka/zk/AdminZkClientTest.scala&lt;br/&gt;
@@ -28,8 +28,10 @@ import kafka.utils.TestUtils._&lt;br/&gt;
 import kafka.utils.&lt;/p&gt;
{Logging, TestUtils}
&lt;p&gt; import kafka.zk.&lt;/p&gt;
{AdminZkClient, KafkaZkClient, ZooKeeperTestHarness}
&lt;p&gt; import org.apache.kafka.common.TopicPartition&lt;br/&gt;
+import org.apache.kafka.common.config.TopicConfig&lt;br/&gt;
 import org.apache.kafka.common.errors.&lt;/p&gt;
{InvalidReplicaAssignmentException, InvalidTopicException, TopicExistsException}
&lt;p&gt; import org.apache.kafka.common.metrics.Quota&lt;br/&gt;
+import org.apache.kafka.test.&lt;/p&gt;
{TestUtils =&amp;gt; JTestUtils}
&lt;p&gt; import org.easymock.EasyMock&lt;br/&gt;
 import org.junit.Assert._&lt;br/&gt;
 import org.junit.&lt;/p&gt;
{After, Test}
&lt;p&gt;@@ -132,7 +134,7 @@ class AdminZkClientTest extends ZooKeeperTestHarness with Logging with RackAware&lt;br/&gt;
   }&lt;/p&gt;

&lt;p&gt;   @Test&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;def testConcurrentTopicCreation() 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+  def testMockedConcurrentTopicCreation() {
     val topic = &quot;test.topic&quot;
 
     // simulate the ZK interactions that can happen when a topic is concurrently created by multiple processes
@@ -147,6 +149,28 @@ class AdminZkClientTest extends ZooKeeperTestHarness with Logging with RackAware
     }   }&lt;/span&gt; &lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;+  @Test&lt;br/&gt;
+  def testConcurrentTopicCreation() {&lt;br/&gt;
+    val topic = &quot;test-concurrent-topic-creation&quot;&lt;br/&gt;
+    TestUtils.createBrokersInZk(zkClient, List(0, 1, 2, 3, 4))&lt;br/&gt;
+    val props = new Properties&lt;br/&gt;
+    props.setProperty(TopicConfig.MIN_IN_SYNC_REPLICAS_CONFIG, &quot;2&quot;)&lt;br/&gt;
+    def createTopic(): Unit = {&lt;br/&gt;
+      try adminZkClient.createTopic(topic, 3, 1, props)&lt;br/&gt;
+      catch &lt;/p&gt;
{ case _: TopicExistsException =&amp;gt; () }
&lt;p&gt;+      val (_, partitionAssignment) = zkClient.getPartitionAssignmentForTopics(Set(topic)).head&lt;br/&gt;
+      assertEquals(3, partitionAssignment.size)&lt;br/&gt;
+      partitionAssignment.foreach &lt;/p&gt;
{ case (partition, replicas) =&amp;gt;
+        assertEquals(s&quot;Unexpected replication factor for $partition&quot;, 1, replicas.size)
+      }
&lt;p&gt;+      val savedProps = zkClient.getEntityConfigs(ConfigType.Topic, topic)&lt;br/&gt;
+      assertEquals(props, savedProps)&lt;br/&gt;
+    }&lt;br/&gt;
+&lt;br/&gt;
+    TestUtils.assertConcurrent(&quot;Concurrent topic creation failed&quot;, Seq(createTopic, createTopic),&lt;br/&gt;
+      JTestUtils.DEFAULT_MAX_WAIT_MS.toInt)&lt;br/&gt;
+  }&lt;br/&gt;
+&lt;br/&gt;
   /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;This test creates a topic with a few config overrides and checks that the configs are applied to the new topic&lt;/li&gt;
	&lt;li&gt;then changes the config and checks that the new values take effect.&lt;/li&gt;
&lt;/ul&gt;





&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16550587" author="williamguan" created="Fri, 20 Jul 2018 09:52:55 +0000"  >&lt;p&gt;Hi, I think the broker should only accept the first create request when handling more than one request.&lt;/p&gt;

&lt;p&gt;What if there are two people trying to create a topic with different partitions? One of them would found his messages were send to wrong partitions because both of them receive no exception while trying to create.&lt;/p&gt;</comment>
                            <comment id="16550650" author="ijuma" created="Fri, 20 Jul 2018 11:00:35 +0000"  >&lt;p&gt;If you have two people trying to create the same topic with different partitions concurrently, you have a problem in any case, right? That is, under which scenario is this a reasonable thing to do? That aside, yes, the PR states:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
This is a minimal change to make the behaviour match ZkUtils.
This is better, but one could argue that it&apos;s not perfect. A more
sophisticated approach can be tackled separately.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 17 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3v2e7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>junrao</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>