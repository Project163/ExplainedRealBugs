<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:19:40 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-8325] Remove from the incomplete set failed. This should be impossible</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-8325</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;I got this error when using the Kafka producer. So far it happened twice, with an interval of about 1 week.&lt;/p&gt;


&lt;p&gt;&lt;tt&gt;ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;2019-05-05 08:43:07,505&amp;#93;&lt;/span&gt; org.apache.kafka.clients.producer.internals.Sender: &lt;span class=&quot;error&quot;&gt;&amp;#91;Producer clientId=&amp;lt;redacted&amp;gt;, transactionalId=&amp;lt;redacted&amp;gt;&amp;#93;&lt;/span&gt; Uncaught error in kafka producer I/O thread:&lt;/tt&gt;&lt;br/&gt;
{{ ! java.lang.IllegalStateException: Remove from the incomplete set failed. This should be impossible.}}&lt;br/&gt;
{{ ! at org.apache.kafka.clients.producer.internals.IncompleteBatches.remove(IncompleteBatches.java:44)}}&lt;br/&gt;
{{ ! at org.apache.kafka.clients.producer.internals.RecordAccumulator.deallocate(RecordAccumulator.java:645)}}&lt;br/&gt;
{{ ! at org.apache.kafka.clients.producer.internals.Sender.failBatch(Sender.java:717)}}&lt;br/&gt;
{{ ! at org.apache.kafka.clients.producer.internals.Sender.sendProducerData(Sender.java:365)}}&lt;br/&gt;
{{ ! at org.apache.kafka.clients.producer.internals.Sender.run(Sender.java:308)}}&lt;br/&gt;
{{ ! at org.apache.kafka.clients.producer.internals.Sender.run(Sender.java:233)}}&lt;br/&gt;
{{ ! at java.lang.Thread.run(Thread.java:748)}}&lt;/p&gt;</description>
                <environment></environment>
        <key id="13231763">KAFKA-8325</key>
            <summary>Remove from the incomplete set failed. This should be impossible</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="bob-barrett">Bob Barrett</assignee>
                                    <reporter username="mbarbon">Mattia Barbon</reporter>
                        <labels>
                    </labels>
                <created>Mon, 6 May 2019 13:46:55 +0000</created>
                <updated>Thu, 22 Aug 2019 06:37:15 +0000</updated>
                            <resolved>Thu, 22 Aug 2019 06:37:14 +0000</resolved>
                                    <version>2.1.0</version>
                    <version>2.3.0</version>
                                    <fixVersion>2.3.1</fixVersion>
                                    <component>producer </component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="16838718" author="mingaliu" created="Mon, 13 May 2019 17:18:38 +0000"  >&lt;p&gt;We also run into this problem after we upgrade to Kafka 2.2.&lt;/p&gt;</comment>
                            <comment id="16891090" author="mbarbon" created="Tue, 23 Jul 2019 14:45:29 +0000"  >&lt;p&gt;It happens with the 2.3 client as well&lt;/p&gt;</comment>
                            <comment id="16893166" author="bob-barrett" created="Thu, 25 Jul 2019 22:22:50 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mbarbon&quot; class=&quot;user-hover&quot; rel=&quot;mbarbon&quot;&gt;mbarbon&lt;/a&gt; Would you be able to upload producer logs from around the time this error was raised? This error is caused when the&#160;producer tries to deallocate a batch that has already been deallocated. There are multiple reasons a batch would be removed; the stack trace in this case shows the producer attempting to remove a batch that has expired. Additional logs might tell us what actually removed the batch before this call was made. If you don&apos;t have logs, are you aware of any&#160;interesting producer&#160;event around the time of this error, such an aborted transaction or a request timeout?&lt;/p&gt;</comment>
                            <comment id="16893750" author="mbarbon" created="Fri, 26 Jul 2019 11:44:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bob-barrett&quot; class=&quot;user-hover&quot; rel=&quot;bob-barrett&quot;&gt;bob-barrett&lt;/a&gt; all the cases seem to be instances of&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;tt&gt;WARN&#160; &lt;span class=&quot;error&quot;&gt;&amp;#91;2019-07-26 13:09:27.670&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;20295:kafka-producer-network-thread&amp;#93;&lt;/span&gt; org.apache.kafka.clients.producer.internals.Sender: &lt;span class=&quot;error&quot;&gt;&amp;#91;Producer clientId=232-prd-0, transactionalId=232-prd-0&amp;#93;&lt;/span&gt; Got error produce response in correlation id 4397 on topic-partition topic-31, splitting and retrying (2147483647 attempts left). Error: MESSAGE_TOO_LARGE&lt;/tt&gt;&lt;br/&gt;
{{ WARN&#160; &lt;span class=&quot;error&quot;&gt;&amp;#91;2019-07-26 13:09:27.839&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;20295:kafka-producer-network-thread&amp;#93;&lt;/span&gt; org.apache.kafka.clients.producer.internals.Sender: &lt;span class=&quot;error&quot;&gt;&amp;#91;Producer clientId=232-prd-0, transactionalId=232-prd-0&amp;#93;&lt;/span&gt; Got error produce response with correlation id 4404 on topic-partition }}&lt;tt&gt;topic&lt;/tt&gt;&lt;tt&gt;-31, retrying (2147483646 attempts left). Error: OUT_OF_ORDER_SEQUENCE_NUMBER&lt;/tt&gt;&lt;br/&gt;
{{ ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;2019-07-26 13:09:30.562&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;20295:kafka-producer-network-thread&amp;#93;&lt;/span&gt; org.apache.kafka.clients.producer.internals.Sender: &lt;span class=&quot;error&quot;&gt;&amp;#91;Producer clientId=232-prd-0, transactionalId=232-prd-0&amp;#93;&lt;/span&gt; Uncaught error in kafka producer I/O thread:}}&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16899717" author="lukestephenson" created="Mon, 5 Aug 2019 01:48:31 +0000"  >&lt;p&gt;I&apos;m also seeing this issue with version 2.2.1 of the client (brokers are running kafka 2.1.1).&lt;/p&gt;

&lt;p&gt;In my application, when the KafkaProducer&#160;callback is invoked, I&apos;m completing a Scala Future.&#160; This is also triggering a `java.lang.IllegalStateException: Promise already completed.` to be logged.&#160; So that&apos;s in alignment with the `IncompleteBatches` reporting.&lt;/p&gt;

&lt;p&gt;As &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bob-barrett&quot; class=&quot;user-hover&quot; rel=&quot;bob-barrett&quot;&gt;bob-barrett&lt;/a&gt; reported, the initial cause of this seems to be triggered by&#160;&lt;/p&gt;

&lt;p&gt;```&lt;br/&gt;
Got error produce response in correlation id 1386 on topic-partition&#160;my.topic-0, splitting and retrying (30 attempts left). Error: MESSAGE_TOO_LARGE&lt;br/&gt;
```&lt;/p&gt;

&lt;p&gt;Also might be relevant, I just enabled zstd compression in the week prior to seeing this Exception for the first time&lt;/p&gt;</comment>
                            <comment id="16899811" author="lukestephenson" created="Mon, 5 Aug 2019 06:21:52 +0000"  >&lt;p&gt;I suspect the trigger for this is having a large `batch.size` on the producer.&#160; I had configured:&lt;/p&gt;

&lt;p&gt;&quot;batch.size&quot; = 1000000&lt;/p&gt;

&lt;p&gt;I was initially under the impression that this was just used to&#160;influence&#160;throughput by causing the producer to wait for more bytes.&#160; However, when the batch is &quot;split and retried&quot;, it also uses the `batch.size` value for splitting.&lt;/p&gt;

&lt;p&gt;Curious if the other people who raised this bug also had a high value for this setting.&#160; I&apos;ve reduced the value by half and I&apos;ve stopped seeing the Exception with similar load.&lt;/p&gt;</comment>
                            <comment id="16900495" author="lukestephenson" created="Tue, 6 Aug 2019 00:06:40 +0000"  >&lt;p&gt;I played around further with `batch.size` and setting it to large values can cause some strange behaviour on the producer.  Here is one example &lt;a href=&quot;https://github.com/lukestephenson-zendesk/kafka-bug&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/lukestephenson-zendesk/kafka-bug&lt;/a&gt;.  (See project readme for an overview)&lt;/p&gt;</comment>
                            <comment id="16901429" author="bob-barrett" created="Tue, 6 Aug 2019 20:18:15 +0000"  >&lt;p&gt;Looks like the problem is that when handling a MESSAGE_TOO_LARGE error, we don&apos;t correctly remove the original batch from the list of in-flight batches, but we do deallocate it in the accumulator. When we check the in-flight batches for expiration, we then try to deallocate the batch a second time, which causes this error. I&apos;ll have a fix out this week.&#160;Thanks for the report and the logs,&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mbarbon&quot; class=&quot;user-hover&quot; rel=&quot;mbarbon&quot;&gt;mbarbon&lt;/a&gt; and&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lukestephenson&quot; class=&quot;user-hover&quot; rel=&quot;lukestephenson&quot;&gt;lukestephenson&lt;/a&gt;!&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lukestephenson&quot; class=&quot;user-hover&quot; rel=&quot;lukestephenson&quot;&gt;lukestephenson&lt;/a&gt;, thanks for providing that demo code! Regarding the OutOfMemory you found, I think the underlying cause is the same: because we don&apos;t remove the batch from the list of in-flight batches, and because we retry MESSAGE_TOO_LARGE errors infinitely, the batches build up and eventually use all the available memory. I&apos;ll run your program with my fix and see if it fixes the issue. As&#160;for why we don&apos;t decrement retries after splitting batches, it&apos;s because we want to treat the new, smaller batches as separate requests that&#160;get the same number of attempts as any other request. If we didn&apos;t do this, and the producer batch size was too high relative to the number of retries, we might run out of retries before splitting down to a safe size and fail to produce the records, even though each individual&#160;one is viable. Eventually we&apos;ll split large batches down to a single record, and if that is still too large we don&apos;t retry. In the case of your demo,&#160;I suspect the memory ran out before the split batches got down below the broker size limit, but that should be addressed by the fix for this bug.&lt;/p&gt;</comment>
                            <comment id="16902452" author="githubbot" created="Wed, 7 Aug 2019 20:35:16 +0000"  >&lt;p&gt;bob-barrett commented on pull request #7176: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-8325&quot; title=&quot;Remove from the incomplete set failed. This should be impossible&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-8325&quot;&gt;&lt;del&gt;KAFKA-8325&lt;/del&gt;&lt;/a&gt;: Remove batch from in-flight requests when handling MESSAG&#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/7176&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/7176&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   &#8230;E_TOO_LARGE error&lt;/p&gt;

&lt;p&gt;   This patch fixes a bug in the handling of MESSAGE_TOO_LARGE errors. The large batch is split, the smaller batches are re-added to the accumulator, and the batch is deallocated, but it was not removed from the list of in-flight batches. When the batch was eventually expired from the in-flight batches, the producer would try to deallocate it a second time, causing an error. This patch changes the behavior to correctly remove the batch from the list of in-flight requests.&lt;/p&gt;

&lt;p&gt;   *More detailed description of your change,&lt;br/&gt;
   if necessary. The PR title and PR message become&lt;br/&gt;
   the squashed commit message, so use a separate&lt;br/&gt;
   comment to ping reviewers.*&lt;/p&gt;

&lt;p&gt;   *Summary of testing strategy (including rationale)&lt;br/&gt;
   for the feature or bug fix. Unit and/or integration&lt;br/&gt;
   tests are expected for any behaviour change and&lt;br/&gt;
   system tests should be considered for larger changes.*&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16913015" author="githubbot" created="Thu, 22 Aug 2019 06:29:25 +0000"  >&lt;p&gt;hachikuji commented on pull request #7176: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-8325&quot; title=&quot;Remove from the incomplete set failed. This should be impossible&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-8325&quot;&gt;&lt;del&gt;KAFKA-8325&lt;/del&gt;&lt;/a&gt;: Remove batch from in-flight requests when handling MESSAG&#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/7176&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/7176&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 12 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z02f74:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>