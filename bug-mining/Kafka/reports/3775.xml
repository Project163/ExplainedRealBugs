<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:38:47 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-15018] Potential tombstone offsets corruption for exactly-once source connectors</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-15018</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;When exactly-once support is enabled for source connectors, source offsets can potentially be written to two different offsets topics: a topic specific to the connector, and the global offsets topic (which was used for all connectors prior to KIP-618 / version 3.3.0).&lt;/p&gt;

&lt;p&gt;Precedence is given to offsets in the per-connector offsets topic, but if none are found for a given partition, then the global offsets topic is used as a fallback.&lt;/p&gt;

&lt;p&gt;When committing offsets, a transaction is used to ensure that source records and source offsets are written to the Kafka cluster targeted by the source connector. This transaction only includes the connector-specific offsets topic. Writes to the global offsets topic take place after writes to the connector-specific offsets topic have completed successfully, and if they fail, a warning message is logged, but no other action is taken.&lt;/p&gt;

&lt;p&gt;Normally, this ensures that, for offsets committed by exactly-once-supported source connectors, the per-connector offsets topic is at least as up-to-date as the global offsets topic, and sometimes even ahead.&lt;/p&gt;

&lt;p&gt;However, for tombstone offsets, we lose that guarantee. If a tombstone offset is successfully written to the per-connector offsets topic, but cannot be written to the global offsets topic, then the global offsets topic will still contain that source offset, but the per-connector topic will not. Due to the fallback-on-global logic used by the worker, if a task requests offsets for one of the tombstoned partitions, the worker will provide it with the offsets present in the global offsets topic, instead of indicating to the task that no offsets can be found.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13537375">KAFKA-15018</key>
            <summary>Potential tombstone offsets corruption for exactly-once source connectors</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sagarrao">Sagar Rao</assignee>
                                    <reporter username="ChrisEgerton">Chris Egerton</reporter>
                        <labels>
                    </labels>
                <created>Tue, 23 May 2023 17:11:34 +0000</created>
                <updated>Tue, 7 May 2024 18:29:13 +0000</updated>
                            <resolved>Tue, 7 May 2024 18:29:13 +0000</resolved>
                                    <version>3.3.0</version>
                    <version>3.3.1</version>
                    <version>3.3.2</version>
                    <version>3.4.0</version>
                    <version>3.4.1</version>
                    <version>3.5.0</version>
                                    <fixVersion>3.8.0</fixVersion>
                                    <component>connect</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17725502" author="chrisegerton" created="Tue, 23 May 2023 17:13:49 +0000"  >&lt;p&gt;One possible fix for this could be to preemptively write tombstone offsets to the global offsets topic before writing any offsets to the per-connector offsets topic, and preserve the existing write logic for all non-tombstone offsets.&lt;/p&gt;

&lt;p&gt;Tombstone offsets should be fairly rare and so in the common case, this will have no impact on connector performance or availability. However, when this case is hit, the proposed fix would require two synchronous writes to topics that are potentially hosted on different clusters. This is not ideal, but it&apos;s unclear whether a better alternative exists.&lt;/p&gt;</comment>
                            <comment id="17725713" author="yash.mayya" created="Wed, 24 May 2023 09:20:55 +0000"  >&lt;p&gt;Thanks for filing this bug ticket &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ChrisEgerton&quot; class=&quot;user-hover&quot; rel=&quot;ChrisEgerton&quot;&gt;ChrisEgerton&lt;/a&gt;, it&apos;s an interesting one. This bug also affects regular source connectors that are configured to use a separate offsets topic right (and not only exactly-once support enabled source connectors as indicated in the ticket title / description)?&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I like the idea of synchronously writing tombstones to the global offsets store before writing them to the connector specific offsets store - it&apos;s clean and simple. You have a valid point about two synchronous writes to topics on potentially separate Kafka clusters being sub-optimal, however I also agree with your later point on tombstone offsets being pretty uncommon based on the connectors and use-cases I&apos;ve encountered so far. I think it&apos;s a very reasonable trade-off to make (i.e. slightly worse performance for an edge case over potential correctness issues for the same edge case).&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;An alternate idea I had was to treat tombstones values differently from the absence of an offset - i.e. use a special value to represent tombstones in the offset store. This would allow us to distinguish between no offset being present in the connector specific offset store for a particular partition versus it being explicitly wiped by a connector task via a null / tombstone offset. The &quot;special&quot; value wouldn&apos;t be persisted in the topic, it would only be present in the in-memory store which represents the materialized view of the offset topic. However, we&apos;d need to do some additional work to ensure that this value isn&apos;t leaked to connectors / tasks - basically, it should only be surfaced to the ConnectorOffsetBackingStore in order to make a decision on whether or not to use the offset from the global offsets store. I personally think that the other approach is cleaner overall though, WDYT?&lt;/p&gt;</comment>
                            <comment id="17727444" author="sagarrao" created="Tue, 30 May 2023 09:47:34 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yash.mayya&quot; class=&quot;user-hover&quot; rel=&quot;yash.mayya&quot;&gt;yash.mayya&lt;/a&gt; . I have assigned this to myself. I went through your 2 approaches and feel that option 1 (the option also mentioned by Chris) might be the cleaner one to handle this case. While the second option is viable, it would need some more changes to have it incorporated correctly- as you pointed out.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 24 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1i3ds:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>