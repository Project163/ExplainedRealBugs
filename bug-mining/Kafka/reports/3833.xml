<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:39:19 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-16969] KRaft unable to upgrade to v3.7.1 and later when multiple log dir is set</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-16969</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;After &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-16606&quot; title=&quot;JBOD support in KRaft does not seem to be gated by the metadata version&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-16606&quot;&gt;&lt;del&gt;KAFKA-16606&lt;/del&gt;&lt;/a&gt;, we added validation metadata version for JBOD support. This validation works well in isolated KRaft mode (i.e. separate controller/broker node). But when in combined mode, this validation will let the node fail to startup. The log will be like this:&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[2024-06-15 16:00:45,621] INFO [BrokerServer id=1] Waiting &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the broker metadata publishers to be installed (kafka.server.BrokerServer)
[2024-06-15 16:00:45,621] INFO [BrokerServer id=1] Finished waiting &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the broker metadata publishers to be installed (kafka.server.BrokerServer)
[2024-06-15 16:00:45,621] INFO [BrokerServer id=1] Waiting &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the controller to acknowledge that we are caught up (kafka.server.BrokerServer)
[2024-06-15 16:00:45,621] INFO [MetadataLoader id=1] InitializeNewPublishers: initializing MetadataVersionPublisher(id=1) with a snapshot at offset 4 (org.apache.kafka.image.loader.MetadataLoader)
[2024-06-15 16:00:45,621] ERROR Encountered metadata publishing fault: Broker configuration does not support the cluster MetadataVersion (org.apache.kafka.server.fault.LoggingFaultHandler)
java.lang.IllegalArgumentException: requirement failed: Multiple log directories (aka JBOD) are not supported in the current MetadataVersion 3.6-IV2. Need 3.7-IV2 or higher
&#160; &#160; at scala.Predef$.require(Predef.scala:337)
&#160; &#160; at kafka.server.KafkaConfig.validateWithMetadataVersion(KafkaConfig.scala:2545)
&#160; &#160; at kafka.server.MetadataVersionConfigValidator.onMetadataVersionChanged(MetadataVersionConfigValidator.java:62)
&#160; &#160; at kafka.server.MetadataVersionConfigValidator.onMetadataUpdate(MetadataVersionConfigValidator.java:55)
&#160; &#160; at org.apache.kafka.image.loader.MetadataLoader.initializeNewPublishers(MetadataLoader.java:309)
&#160; &#160; at org.apache.kafka.image.loader.MetadataLoader.lambda$scheduleInitializeNewPublishers$0(MetadataLoader.java:266)
&#160; &#160; at org.apache.kafka.queue.KafkaEventQueue$EventContext.run(KafkaEventQueue.java:127)
&#160; &#160; at org.apache.kafka.queue.KafkaEventQueue$EventHandler.handleEvents(KafkaEventQueue.java:210)
&#160; &#160; at org.apache.kafka.queue.KafkaEventQueue$EventHandler.run(KafkaEventQueue.java:181)
&#160; &#160; at java.base/java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:1623)
[2024-06-15 16:00:45,622] ERROR Encountered fatal fault: Unhandled error initializing MetadataVersionPublisher(id=1) with a snapshot at offset 4 (org.apache.kafka.server.fault.ProcessTerminatingFaultHandler)
org.apache.kafka.server.fault.FaultHandlerException: Broker configuration does not support the cluster MetadataVersion
&#160; &#160; at scala.Predef$.require(Predef.scala:337)
&#160; &#160; at kafka.server.KafkaConfig.validateWithMetadataVersion(KafkaConfig.scala:2545)
&#160; &#160; at kafka.server.MetadataVersionConfigValidator.onMetadataVersionChanged(MetadataVersionConfigValidator.java:62)
&#160; &#160; at kafka.server.MetadataVersionConfigValidator.onMetadataUpdate(MetadataVersionConfigValidator.java:55)
&#160; &#160; at org.apache.kafka.image.loader.MetadataLoader.initializeNewPublishers(MetadataLoader.java:309)
&#160; &#160; at org.apache.kafka.image.loader.MetadataLoader.lambda$scheduleInitializeNewPublishers$0(MetadataLoader.java:266)
&#160; &#160; at org.apache.kafka.queue.KafkaEventQueue$EventContext.run(KafkaEventQueue.java:127)
&#160; &#160; at org.apache.kafka.queue.KafkaEventQueue$EventHandler.handleEvents(KafkaEventQueue.java:210)
&#160; &#160; at org.apache.kafka.queue.KafkaEventQueue$EventHandler.run(KafkaEventQueue.java:181)
&#160; &#160; at java.base/java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:1623)
Caused by: java.lang.IllegalArgumentException: requirement failed: Multiple log directories (aka JBOD) are not supported in the current MetadataVersion 3.6-IV2. Need 3.7-IV2 or higher
&#160; &#160; ... 10 more&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;This will block combined node setting multiple log dirs upgrade to v3.7.1 or later.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13582755">KAFKA-16969</key>
            <summary>KRaft unable to upgrade to v3.7.1 and later when multiple log dir is set</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="soarez">Igor Soarez</assignee>
                                    <reporter username="showuon">Luke Chen</reporter>
                        <labels>
                    </labels>
                <created>Sat, 15 Jun 2024 08:11:58 +0000</created>
                <updated>Tue, 18 Jun 2024 20:42:10 +0000</updated>
                            <resolved>Tue, 18 Jun 2024 03:14:09 +0000</resolved>
                                    <version>3.7.1</version>
                    <version>3.8.0</version>
                                    <fixVersion>3.7.1</fixVersion>
                    <fixVersion>3.8.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17855208" author="showuon" created="Sat, 15 Jun 2024 09:12:25 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=soarez&quot; class=&quot;user-hover&quot; rel=&quot;soarez&quot;&gt;soarez&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mimaison&quot; class=&quot;user-hover&quot; rel=&quot;mimaison&quot;&gt;mimaison&lt;/a&gt; , given the v3.7.1/v3.8.0 is going to be released, I&apos;ve prepared a PR to revert the change we did in &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-16606&quot; title=&quot;JBOD support in KRaft does not seem to be gated by the metadata version&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-16606&quot;&gt;&lt;del&gt;KAFKA-16606&lt;/del&gt;&lt;/a&gt;. It&apos;s up to you to decide if we want to fix this issue soon, or revert it for now, and fix it later. Thanks.&lt;/p&gt;

&lt;p&gt;PR: &lt;a href=&quot;https://github.com/apache/kafka/pull/16352&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/16352&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17855209" author="soarez" created="Sat, 15 Jun 2024 09:16:01 +0000"  >&lt;p&gt;Thanks for finding Luke. I think we should revert it for now and I&apos;ll see if there&apos;s a way to deal with combined mode.&#160;&lt;/p&gt;</comment>
                            <comment id="17855211" author="showuon" created="Sat, 15 Jun 2024 09:27:51 +0000"  >&lt;p&gt;Or maybe we just disable the JBOD config validation when in combined mode? But what does that mean when a cluster containing combined mode nodes and isolated nodes??&lt;/p&gt;</comment>
                            <comment id="17855219" author="soarez" created="Sat, 15 Jun 2024 10:17:23 +0000"  >&lt;p&gt;This needs to target also 3.7.1 and 3.8.0, since &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-16606&quot; title=&quot;JBOD support in KRaft does not seem to be gated by the metadata version&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-16606&quot;&gt;&lt;del&gt;KAFKA-16606&lt;/del&gt;&lt;/a&gt; was backported there too. &#128542;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=showuon&quot; class=&quot;user-hover&quot; rel=&quot;showuon&quot;&gt;showuon&lt;/a&gt; the error message says:&lt;br/&gt;
Multiple log directories (aka JBOD) are not supported in the current MetadataVersion 3.6-IV2. Need 3.7-IV2 or higher&lt;br/&gt;
A few questions:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Where is the value `3.6-IV2` coming from?&lt;/li&gt;
	&lt;li&gt;Did you use that value as the metadata version to format storage?&lt;/li&gt;
	&lt;li&gt;Did you run the features command to upgrade metadata.version before configuring JBOD?&#160;&lt;/li&gt;
	&lt;li&gt;Can you share the config and/or reproducing instructions?&#160;&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;EDIT&amp;#93;&lt;/span&gt; I see now this is from the system tests. I&apos;ll look in there for these answers.&lt;/p&gt;</comment>
                            <comment id="17855222" author="soarez" created="Sat, 15 Jun 2024 10:55:25 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=showuon&quot; class=&quot;user-hover&quot; rel=&quot;showuon&quot;&gt;showuon&lt;/a&gt; I think maybe it&apos;s the system tests that need to be changed. Perhaps the test is upgrading from 3.6-IV2 and configuring the broker with the defaults &lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/tests/kafkatest/services/kafka/config.py#L26&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/trunk/tests/kafkatest/services/kafka/config.py#L26&lt;/a&gt; which include setting two log directories. That&apos;s the exact situation that&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-16606&quot; title=&quot;JBOD support in KRaft does not seem to be gated by the metadata version&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-16606&quot;&gt;&lt;del&gt;KAFKA-16606&lt;/del&gt;&lt;/a&gt; was meant to catch, it is incorrect to configure a KRaft broker with multiple log directories pre 3.7-IV2, and it seems the system tests may be doing that.&lt;/p&gt;</comment>
                            <comment id="17855230" author="showuon" created="Sat, 15 Jun 2024 12:43:16 +0000"  >&lt;p&gt;Yes, you&apos;re right. The reproduce steps is like:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Run storage_tool.sh in v3.6 release to format a combined node containing multiple log.dirs value&lt;/li&gt;
	&lt;li&gt;Run bin/kafka-server-start.sh in v3.7.1 to start the combined KRaft node&lt;/li&gt;
	&lt;li&gt;The node failed to startup with:&lt;/li&gt;
&lt;/ol&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Caused by: java.lang.IllegalArgumentException: requirement failed: Multiple log directories (aka JBOD) are not supported in the current MetadataVersion 3.6-IV2. Need 3.7-IV2 or higher&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&amp;gt; That&apos;s the exact situation that&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-16606&quot; title=&quot;JBOD support in KRaft does not seem to be gated by the metadata version&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-16606&quot;&gt;&lt;del&gt;KAFKA-16606&lt;/del&gt;&lt;/a&gt; was meant to catch, it is incorrect to configure a KRaft broker with multiple log directories pre 3.7-IV2, and it seems the system tests may be doing that.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Yes, we should catch this error since this is the wrong configuration. But this &quot;error behavior&quot; has existed for many releases. I don&apos;t know if our &quot;fix&quot; will cause surprise to users or not. Besides, like in isolated node, even if the user set the wrong config, we only log the error without exit the startup process. So after metadata version upgraded, everything works well. I think that should be what we expected. WDYT?&lt;/p&gt;</comment>
                            <comment id="17855401" author="soarez" created="Sun, 16 Jun 2024 12:50:59 +0000"  >&lt;p&gt;This was discussed in &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-16606&quot; title=&quot;JBOD support in KRaft does not seem to be gated by the metadata version&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-16606&quot;&gt;&lt;del&gt;KAFKA-16606&lt;/del&gt;&lt;/a&gt;, the reasoning was that since JBOD is not yet production ready, we shouldn&apos;t expect this will breaking anyone&apos;s deployment, and that preventing the broker from starting could be better than allowing for an outage at some moment in the future when a dir fails.&lt;a href=&quot;https://issues.apache.org/jira/secure/DeleteComment!default.jspa?id=13576930&amp;amp;commentId=17840150&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/DeleteComment!default.jspa?id=13576930&amp;amp;commentId=17840150&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;But you make a good point about how we deal with incorrect config in isolated mode. I think then we should change the behavior to just log an error or warning and not cause the broker to stop.&lt;/p&gt;</comment>
                            <comment id="17855463" author="showuon" created="Mon, 17 Jun 2024 02:10:44 +0000"  >&lt;p&gt;&amp;gt; I think then we should change the behavior to just log an error or warning and not cause the broker to stop.&lt;/p&gt;

&lt;p&gt;Agree! We also need to remember to add an entry in doc &lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/docs/upgrade.html#L97&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; to mention this behavior change.&lt;/p&gt;</comment>
                            <comment id="17855495" author="soarez" created="Mon, 17 Jun 2024 06:20:50 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=showuon&quot; class=&quot;user-hover&quot; rel=&quot;showuon&quot;&gt;showuon&lt;/a&gt; please see &lt;a href=&quot;https://github.com/apache/kafka/pull/16366&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/16366&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310660">
                    <name>Completes</name>
                                            <outwardlinks description="fixes">
                                        <issuelink>
            <issuekey id="13582699">KAFKA-16961</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13582699">KAFKA-16961</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 21 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1ptgw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>