<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:37:05 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-15372] MM2 rolling restart can drop configuration changes silently</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-15372</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;When MM2 is restarted, it tries to update the Connector configuration in all flows. This is a one-time trial, and fails if the Connect worker is not the leader of the group.&lt;/p&gt;

&lt;p&gt;In a distributed setup and with a rolling restart, it is possible that for a specific flow, the Connect worker of the just restarted MM2 instance is not the leader, meaning that Connector configurations can get dropped.&lt;/p&gt;

&lt;p&gt;For example, assuming 2 MM2 instances, and one flow A-&amp;gt;B:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;MM2 instance 1 is restarted, the worker inside MM2 instance 2 becomes the leader of A-&amp;gt;B Connect group.&lt;/li&gt;
	&lt;li&gt;MM2 instance 1 tries to update the Connector configurations, but fails (instance 2 has the leader, not instance 1)&lt;/li&gt;
	&lt;li&gt;MM2 instance 2 is restarted, leadership moves to worker in MM2 instance 1&lt;/li&gt;
	&lt;li&gt;MM2 instance 2 tries to update the Connector configurations, but fails&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;At this point, the configuration changes before the restart are never applied. Many times, this can also happen silently, without any indication.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13547744">KAFKA-15372</key>
            <summary>MM2 rolling restart can drop configuration changes silently</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gharris1727">Greg Harris</assignee>
                                    <reporter username="durban">Daniel Urban</reporter>
                        <labels>
                    </labels>
                <created>Thu, 17 Aug 2023 15:09:41 +0000</created>
                <updated>Wed, 14 Feb 2024 19:42:16 +0000</updated>
                            <resolved>Tue, 12 Dec 2023 21:58:23 +0000</resolved>
                                                    <fixVersion>3.6.2</fixVersion>
                    <fixVersion>3.7.0</fixVersion>
                                    <component>mirrormaker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17755629" author="gharris1727" created="Thu, 17 Aug 2023 16:56:23 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=durban&quot; class=&quot;user-hover&quot; rel=&quot;durban&quot;&gt;durban&lt;/a&gt; Thanks for the bug report.&lt;/p&gt;

&lt;p&gt;Is this reproducible with 3.5.0 and `dedicated.mode.enable.internal.rest` set to `true`? This configuration was added in &lt;a href=&quot;https://cwiki.apache.org/confluence/display/KAFKA/KIP-710%3A+Full+support+for+distributed+mode+in+dedicated+MirrorMaker+2.0+clusters&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://cwiki.apache.org/confluence/display/KAFKA/KIP-710%3A+Full+support+for+distributed+mode+in+dedicated+MirrorMaker+2.0+clusters&lt;/a&gt; .&lt;/p&gt;</comment>
                            <comment id="17755643" author="durban" created="Thu, 17 Aug 2023 17:13:37 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gharris1727&quot; class=&quot;user-hover&quot; rel=&quot;gharris1727&quot;&gt;gharris1727&lt;/a&gt;, I don&apos;t have a deterministic reproduction of the issue.&lt;/p&gt;

&lt;p&gt;The reproduction of the problem requires multiple MM2 instances, but the internal REST is not needed at all (the startup and Connector config update does not touch the REST).&lt;/p&gt;

&lt;p&gt;Encountered this on a 3.4 build which contains the MM2 internal REST feature.&lt;/p&gt;</comment>
                            <comment id="17755647" author="gharris1727" created="Thu, 17 Aug 2023 17:25:52 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=durban&quot; class=&quot;user-hover&quot; rel=&quot;durban&quot;&gt;durban&lt;/a&gt; I should clarify, I believe the behavior you described is the expected (but undesirable) behavior for versions before 3.5.0 and earlier, and for 3.5.0+ with the configuration set to the default `false`.&lt;/p&gt;

&lt;p&gt;When the internal REST API is enabled, the worker which is starting (that is not the leader) should forward configurations to the leader via the internal REST API. If you&apos;re not seeing the REST forwarding being attempted, or the forwarding failing, that would explain why configuration updates are being dropped.&lt;/p&gt;

&lt;p&gt;If the above does not apply, then I&apos;m interested to hear more details of your reproduction case. Thanks!&lt;/p&gt;</comment>
                            <comment id="17755833" author="durban" created="Fri, 18 Aug 2023 07:23:01 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gharris1727&quot; class=&quot;user-hover&quot; rel=&quot;gharris1727&quot;&gt;gharris1727&lt;/a&gt;&#160; Not sure if I follow this part: &quot;should forward configurations to the leader via the internal REST API.&quot;&lt;/p&gt;

&lt;p&gt;I checked org.apache.kafka.connect.mirror.MirrorMaker#configureConnector which then calls org.apache.kafka.connect.runtime.distributed.DistributedHerder#putConnectorConfig, and I don&apos;t really see any sign of forwarding to the leader. The callback of the validation explicitly handles the non-leader state with a failure:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!isLeader()) {
    callback.onCompletion(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; NotLeaderException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Only the leader can set connector configs.&quot;&lt;/span&gt;, leaderUrl()), &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;So I think that current trunk is also affected by this, there is no Connector configuration forwarding to the leader in MM2. Additionally, I&apos;m not sure if a single forward attempt is enough to ensure correctness, but that is an implementation detail.&lt;/p&gt;

&lt;p&gt;Unfortunately, I really don&apos;t have an exact reproduction, but I saw this happening in an actual cluster, the leadership changes occurred as I detailed in the ticket description.&lt;/p&gt;</comment>
                            <comment id="17755997" author="durban" created="Fri, 18 Aug 2023 14:30:18 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gharris1727&quot; class=&quot;user-hover&quot; rel=&quot;gharris1727&quot;&gt;gharris1727&lt;/a&gt; I have a bit more information: we managed to deterministically reproduce the issue if we use a 2 instance cluster, and make a change in the config, then wait a long time between the instance restarts. In our specific test we wait 3 minutes after stopping the first MM2 instance, then wait 3 minutes after starting the first MM2 instance, then wait 3 minutes after stopping the second MM2 instance, and so on.&lt;/p&gt;

&lt;p&gt;At the end of this process, the config change does not get applied.&lt;/p&gt;

&lt;p&gt;I think this all depends on the rebalance - if the rebalance finishes before the MM2 instance bounces back, the leadership will always move to the other node.&lt;/p&gt;

&lt;p&gt;Again, all of this is tested on a 3.4.1 build which has the MM2 internal REST enabled, but I&apos;m pretty sure that trunk is affected.&lt;/p&gt;</comment>
                            <comment id="17756048" author="gharris1727" created="Fri, 18 Aug 2023 16:27:31 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=durban&quot; class=&quot;user-hover&quot; rel=&quot;durban&quot;&gt;durban&lt;/a&gt; thank you for the sanity check, I see the flaw now.&lt;/p&gt;

&lt;p&gt;The NotLeaderException is created/thrown in the Herder, and the caller (typically the ConnectorsResource) is responsible for handling the error and forwarding to the leader. See HerderRequestHandler#completeOrForwardRequest.&lt;br/&gt;
I thought the MirrorMaker class used this handler for applying the connector configuration on startup, but it doesn&apos;t. It never triggers the forwarding logic that normal REST requests have.&lt;/p&gt;

&lt;p&gt;More importantly, KIP-710 only added &lt;em&gt;internal rest resources&lt;/em&gt;, which are for writing task configurations and fencing zombies. It didn&apos;t include the connector configuration endpoint, which is typically public-api.&lt;br/&gt;
This was an oversight in the KIP-710 design/implementation, and should be fixed. Currently, KIP-710 only benefits the internal herder requests for writing task configurations and fencing zombies, it is not capable of forwarding connector configurations.&lt;br/&gt;
Since KIP-710 already added the necessary configuration options to enable/disable the internal REST, and this arguably should have been covered by the original implementation, I think we can address this in a bug-fix.&lt;/p&gt;

&lt;p&gt;Alternatively, we could have MirrorMaker periodically apply its local configurations, retrying until it receives leadership, and then stopping. This wouldn&apos;t require changes to the REST API, and would cover some additional error scenarios, but would possibly cause configurations to flap between versions as leadership changes.&lt;/p&gt;

&lt;p&gt;To workaround this issue, users will need to fully stop and fully start MM2, to allow the first node to apply configurations successfully.&lt;/p&gt;</comment>
                            <comment id="17756062" author="gharris1727" created="Fri, 18 Aug 2023 17:04:00 +0000"  >&lt;p&gt;Here&apos;s a proof-of-concept for the fix: &lt;a href=&quot;https://github.com/apache/kafka/pull/14245&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/14245&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17757542" author="gharris1727" created="Tue, 22 Aug 2023 15:42:30 +0000"  >&lt;p&gt;Reading through the KIP-710 thread, it appears that the public API was intentionally left out of the implementation to avoid security problems. &lt;br/&gt;
In particular, the connector config endpoint security is typically managed by a rest extension and by default is unsecured, while the internal endpoints are already secured by default. If we were to keep the current security posture of KIP-710 (all endpoints secured) and add a new endpoint, we would need to secure it by default. This would be a divergence between MM2 dedicated mode and normal Connect Distributed mode that the KIP discussion wanted to avoid.&lt;/p&gt;

&lt;p&gt;Because of that, I don&apos;t think we can implement connector config forwarding in a bugfix, it&apos;s going to at least need a slightly longer discussion about securing the original endpoint vs duplicating the endpoint.&lt;br/&gt;
I think that means that we&apos;ll need to implement the alternative solution, which delays applying the configuration until the worker becomes the leader.&lt;/p&gt;</comment>
                            <comment id="17761381" author="JIRAUSER301284" created="Fri, 1 Sep 2023 19:15:06 +0000"  >&lt;p&gt;I implemented the REST-less fix, but it&apos;s complex enough that I don&apos;t feel comfortable including it in the upcoming release.&lt;/p&gt;</comment>
                            <comment id="17795958" author="gharris1727" created="Tue, 12 Dec 2023 23:16:53 +0000"  >&lt;p&gt;This is now set to release for 3.7 and 3.6, but I had some issues with the 3.5 backport that I had to revert. In particular, the DedicatedMirrorTest has this persistent failure:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;&#160; &#160; org.apache.kafka.test.NoRetryException
&#160; &#160; &#160; &#160; at app//org.apache.kafka.connect.mirror.integration.DedicatedMirrorIntegrationTest.lambda$awaitTaskConfigurations$8(DedicatedMirrorIntegrationTest.java:363)
&#160; &#160; &#160; &#160; at app//org.apache.kafka.test.TestUtils.lambda$waitForCondition$4(TestUtils.java:337)
&#160; &#160; &#160; &#160; at app//org.apache.kafka.test.TestUtils.retryOnExceptionWithTimeout(TestUtils.java:385)
&#160; &#160; &#160; &#160; at app//org.apache.kafka.test.TestUtils.waitForCondition(TestUtils.java:334)
&#160; &#160; &#160; &#160; at app//org.apache.kafka.test.TestUtils.waitForCondition(TestUtils.java:318)
&#160; &#160; &#160; &#160; at app//org.apache.kafka.test.TestUtils.waitForCondition(TestUtils.java:308)
&#160; &#160; &#160; &#160; at app//org.apache.kafka.connect.mirror.integration.DedicatedMirrorIntegrationTest.awaitTaskConfigurations(DedicatedMirrorIntegrationTest.java:353)
&#160; &#160; &#160; &#160; at app//org.apache.kafka.connect.mirror.integration.DedicatedMirrorIntegrationTest.testMultiNodeCluster(DedicatedMirrorIntegrationTest.java:301)&#160; &#160; &#160; &#160; 
Caused by:
&#160; &#160; &#160; &#160; java.util.concurrent.ExecutionException: org.apache.kafka.connect.runtime.distributed.RebalanceNeededException: Request cannot be completed because a rebalance is expected
&#160; &#160; &#160; &#160; &#160; &#160; at org.apache.kafka.connect.util.ConvertingFutureCallback.result(ConvertingFutureCallback.java:123)
&#160; &#160; &#160; &#160; &#160; &#160; at org.apache.kafka.connect.util.ConvertingFutureCallback.get(ConvertingFutureCallback.java:115)
&#160; &#160; &#160; &#160; &#160; &#160; at org.apache.kafka.connect.mirror.integration.DedicatedMirrorIntegrationTest.lambda$awaitTaskConfigurations$8(DedicatedMirrorIntegrationTest.java:357)
&#160; &#160; &#160; &#160; &#160; &#160; ... 7 more&#160; &#160; &#160; &#160; &#160; &#160; 
Caused by:
&#160; &#160; &#160; &#160; &#160; &#160; org.apache.kafka.connect.runtime.distributed.RebalanceNeededException: Request cannot be completed because a rebalance is expected&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310660">
                    <name>Completes</name>
                                            <outwardlinks description="fixes">
                                        <issuelink>
            <issuekey id="13340566">KAFKA-10719</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13334434">KAFKA-10586</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 47 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1juu8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>