<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:06:15 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-6148] ClassCastException in BigQuery connector</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-6148</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;I am trying to run a com.wepay.kafka.connect.bigquery.BigQuerySinkConnector connector, but getting the following exception.  &lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;2017-10-30 21:48:49,007&amp;#93;&lt;/span&gt; ERROR WorkerSinkTask&lt;/p&gt;
{id=bigquery-connector-log-0} Offset commit failed, rewinding to last committed offsets (org.apache.kafka.connect.runtime.WorkerSinkTask:311)&lt;br/&gt;
java.lang.ClassCastException: org.apache.kafka.clients.consumer.OffsetAndMetadata cannot be cast to org.apache.kafka.clients.consumer.OffsetAndMetadata&lt;br/&gt;
	at com.wepay.kafka.connect.bigquery.BigQuerySinkTask.updateOffsets(BigQuerySinkTask.java:107)&lt;br/&gt;
	at com.wepay.kafka.connect.bigquery.BigQuerySinkTask.flush(BigQuerySinkTask.java:96)&lt;br/&gt;
	at org.apache.kafka.connect.sink.SinkTask.preCommit(SinkTask.java:117)&lt;br/&gt;
	at org.apache.kafka.connect.runtime.WorkerSinkTask.commitOffsets(WorkerSinkTask.java:305)&lt;br/&gt;
	at org.apache.kafka.connect.runtime.WorkerSinkTask.iteration(WorkerSinkTask.java:164)&lt;br/&gt;
	at org.apache.kafka.connect.runtime.WorkerSinkTask.execute(WorkerSinkTask.java:148)&lt;br/&gt;
	at org.apache.kafka.connect.runtime.WorkerTask.doRun(WorkerTask.java:146)&lt;br/&gt;
	at org.apache.kafka.connect.runtime.WorkerTask.run(WorkerTask.java:190)&lt;br/&gt;
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)&lt;br/&gt;
	at java.util.concurrent.FutureTask.run(FutureTask.java:266)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:748)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2017-10-30 21:48:49,012&amp;#93;&lt;/span&gt; ERROR Commit of WorkerSinkTask{id=bigquery-connector-log-0}
&lt;p&gt; offsets threw an unexpected exception:  (org.apache.kafka.connect.runtime.WorkerSinkTask:205)&lt;br/&gt;
java.lang.ClassCastException: org.apache.kafka.clients.consumer.OffsetAndMetadata cannot be cast to org.apache.kafka.clients.consumer.OffsetAndMetadata&lt;br/&gt;
	at com.wepay.kafka.connect.bigquery.BigQuerySinkTask.updateOffsets(BigQuerySinkTask.java:107)&lt;br/&gt;
	at com.wepay.kafka.connect.bigquery.BigQuerySinkTask.flush(BigQuerySinkTask.java:96)&lt;br/&gt;
	at org.apache.kafka.connect.sink.SinkTask.preCommit(SinkTask.java:117)&lt;br/&gt;
	at org.apache.kafka.connect.runtime.WorkerSinkTask.commitOffsets(WorkerSinkTask.java:305)&lt;br/&gt;
	at org.apache.kafka.connect.runtime.WorkerSinkTask.iteration(WorkerSinkTask.java:164)&lt;br/&gt;
	at org.apache.kafka.connect.runtime.WorkerSinkTask.execute(WorkerSinkTask.java:148)&lt;br/&gt;
	at org.apache.kafka.connect.runtime.WorkerTask.doRun(WorkerTask.java:146)&lt;br/&gt;
	at org.apache.kafka.connect.runtime.WorkerTask.run(WorkerTask.java:190)&lt;br/&gt;
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)&lt;br/&gt;
	at java.util.concurrent.FutureTask.run(FutureTask.java:266)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:748)&lt;/p&gt;

&lt;p&gt;I have checked the version number of kafka client in the plug in and kafka connect itself and they are the same.  &lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;kafka-clients-0.11.0.0.jar matches&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I am still suspecting a type of versioning issue.  Do you have any advice? &lt;/p&gt;

&lt;p&gt;Thanks. &lt;/p&gt;</description>
                <environment></environment>
        <key id="13113156">KAFKA-6148</key>
            <summary>ClassCastException in BigQuery connector</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kkonstantine">Konstantine Karantasis</assignee>
                                    <reporter username="burd0047">Eugene Burd</reporter>
                        <labels>
                    </labels>
                <created>Mon, 30 Oct 2017 22:01:39 +0000</created>
                <updated>Tue, 30 Jan 2018 16:49:44 +0000</updated>
                            <resolved>Tue, 30 Jan 2018 16:49:29 +0000</resolved>
                                    <version>0.11.0.2</version>
                    <version>1.0.0</version>
                                    <fixVersion>0.11.0.3</fixVersion>
                    <fixVersion>1.0.1</fixVersion>
                                    <component>connect</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16238589" author="ewencp" created="Fri, 3 Nov 2017 23:44:33 +0000"  >&lt;p&gt;I think this is due to the new classpath isolation. I see from &lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/isolation/PluginUtils.java#L120-L121&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/trunk/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/isolation/PluginUtils.java#L120-L121&lt;/a&gt; that we covered excluding org.apache.kafka.common and org.apache.kafka.connect and thought that covered the classes we needed to ensure were loaded from the system classloader, but SinkTask also uses a class from org.apache.kafka.clients.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kkonstantine&quot; class=&quot;user-hover&quot; rel=&quot;kkonstantine&quot;&gt;kkonstantine&lt;/a&gt; seem like an accurate assessment? If so, any connector that overrides flush() or precommit() could potentially run into issues (though I&apos;m not sure if the issue is ultimately caused by having a separate method call there that uses the type). I think the code in the BigQuery connector is actually unnecessary &amp;#8211; just flushing the data is sufficient since the same offsets will be used and do not need to be set on the context object explicitly &amp;#8211; but this is also a bug in Connect itself. Looks like the fix is easy and should probably be backported back to the first release branch with classloader isolation.&lt;/p&gt;</comment>
                            <comment id="16238621" author="ewencp" created="Sat, 4 Nov 2017 00:08:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=burd0047&quot; class=&quot;user-hover&quot; rel=&quot;burd0047&quot;&gt;burd0047&lt;/a&gt; Can you clarify which version of the BigQuery connector you are using? I don&apos;t see a branch or tag that was using 0.11.0.0 Kafka, they all still look like they are on 0.10.2 series.&lt;/p&gt;</comment>
                            <comment id="16239851" author="kkonstantine" created="Mon, 6 Nov 2017 03:30:35 +0000"  >&lt;p&gt;The issue is that the connector is bringing in dependency jars for &lt;tt&gt;kafka-connect-api&lt;/tt&gt; and through that dendency &lt;tt&gt;kafka-clients&lt;/tt&gt;. &lt;/p&gt;

&lt;p&gt;Instead of including these dependencies, the connector should mark them as provided instead or at least make sure it excludes them during its packaging. &lt;/p&gt;

&lt;p&gt;Such practice could create problems both when &lt;tt&gt;CLASSPATH} is used, or classloading isolation with {{plugin.path&lt;/tt&gt; is used. Still, in the latter case the issue is more severe, as reported in the ticket description above. The current workaround will be to remove these jars from the connector&apos;s dependencies (ideally marking them as provided in its build script).&lt;/p&gt;

&lt;p&gt;I&apos;ll be issuing a fix shortly. My main dilemma is how strict to be about it. Fail starting up a worker that finds Connect plugins that include &lt;tt&gt;org.apache.kafka&lt;/tt&gt; packages that are not supposed to, or be lenient and ignore the imported jars, by filtering out the remaining packages so they can be loaded by the system classloader.  &lt;/p&gt;</comment>
                            <comment id="16239880" author="burd0047" created="Mon, 6 Nov 2017 04:09:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ewencp&quot; class=&quot;user-hover&quot; rel=&quot;ewencp&quot;&gt;ewencp&lt;/a&gt; You are correct, there is not git check in with 0.11.  After encountering this error, I figured it was a version difference between the plugin path &amp;amp; the classpath and upgraded the bigquery connector to .11 locally.  This still didn&apos;t remedy the problem.  &lt;/p&gt;

&lt;p&gt;Additionally, you are correct - the code is unnecessary and commenting it out resolved the issue.  I will work on a PR for that project.  &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kkonstantine&quot; class=&quot;user-hover&quot; rel=&quot;kkonstantine&quot;&gt;kkonstantine&lt;/a&gt; - that makes sense.  I will try modifying the gradle script to exclude the connect jars.  Regarding your approach to the fix, I prefer a harder failure that is verbose with what to do over a failure later on (on offset commit) that is not verbose.  &lt;/p&gt;

&lt;p&gt;Thanks both for your help. &lt;/p&gt;</comment>
                            <comment id="16239906" author="kkonstantine" created="Mon, 6 Nov 2017 04:51:31 +0000"  >&lt;p&gt;The lenient approach won&apos;t fail. It will just ignore the &lt;tt&gt;org.apache.kafka&lt;/tt&gt; dependencies that are included with a connector and should not be loaded by a plugin&apos;s classloader. &lt;/p&gt;</comment>
                            <comment id="16343893" author="ewencp" created="Mon, 29 Jan 2018 19:42:13 +0000"  >&lt;p&gt;Moving from 1.0.1 to 1.0.2 as this isn&apos;t ready for 1.0.1.&lt;/p&gt;</comment>
                            <comment id="16343898" author="kkonstantine" created="Mon, 29 Jan 2018 19:45:45 +0000"  >&lt;p&gt;&#160;There&apos;s a&#160;PR that hadn&apos;t been automatically linked to this ticket.&#160;&lt;/p&gt;

&lt;p&gt;Here it is:&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/kafka/pull/4457&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/4457&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16345349" author="githubbot" created="Tue, 30 Jan 2018 16:45:10 +0000"  >&lt;p&gt;hachikuji closed pull request #4457: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6148&quot; title=&quot;ClassCastException in BigQuery connector&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-6148&quot;&gt;&lt;del&gt;KAFKA-6148&lt;/del&gt;&lt;/a&gt;: ClassCastException in connectors that include kafka-clients&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/4457&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/4457&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/isolation/PluginUtils.java b/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/isolation/PluginUtils.java&lt;br/&gt;
index 9ef7c3a40e3..c2611c625b3 100644&lt;br/&gt;
&amp;#8212; a/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/isolation/PluginUtils.java&lt;br/&gt;
+++ b/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/isolation/PluginUtils.java&lt;br/&gt;
@@ -117,8 +117,7 @@&lt;br/&gt;
             + &quot;|org\\.omg\\.stub\\.java&lt;br class=&quot;atl-forced-newline&quot; /&gt;.rmi&quot;&lt;br/&gt;
             + &quot;|org\\.w3c&lt;br class=&quot;atl-forced-newline&quot; /&gt;.dom&quot;&lt;br/&gt;
             + &quot;|org\\.xml&lt;br class=&quot;atl-forced-newline&quot; /&gt;.sax&quot;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;+ &quot;|org\\.apache\\.kafka&lt;br class=&quot;atl-forced-newline&quot; /&gt;.common&quot;&lt;/li&gt;
	&lt;li&gt;+ &quot;|org\\.apache\\.kafka&lt;br class=&quot;atl-forced-newline&quot; /&gt;.connect&quot;&lt;br/&gt;
+            + &quot;|org\\.apache&lt;br class=&quot;atl-forced-newline&quot; /&gt;.kafka&quot;&lt;br/&gt;
             + &quot;|org&lt;br class=&quot;atl-forced-newline&quot; /&gt;.slf4j&quot;&lt;br/&gt;
             + &quot;)&lt;br class=&quot;atl-forced-newline&quot; /&gt;..*$&quot;;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;diff --git a/connect/runtime/src/test/java/org/apache/kafka/connect/runtime/isolation/PluginUtilsTest.java b/connect/runtime/src/test/java/org/apache/kafka/connect/runtime/isolation/PluginUtilsTest.java&lt;br/&gt;
index f9532a6d8cb..7b258a592ef 100644&lt;br/&gt;
&amp;#8212; a/connect/runtime/src/test/java/org/apache/kafka/connect/runtime/isolation/PluginUtilsTest.java&lt;br/&gt;
+++ b/connect/runtime/src/test/java/org/apache/kafka/connect/runtime/isolation/PluginUtilsTest.java&lt;br/&gt;
@@ -104,6 +104,15 @@ public void testConnectFrameworkClasses() throws Exception &lt;/p&gt;
{
         assertFalse(PluginUtils.shouldLoadInIsolation(
                 &quot;org.apache.kafka.connect.storage.OffsetBackingStore&quot;)
         );
+        assertFalse(PluginUtils.shouldLoadInIsolation(
+                &quot;org.apache.kafka.clients.producer.ProducerConfig&quot;)
+        );
+        assertFalse(PluginUtils.shouldLoadInIsolation(
+                &quot;org.apache.kafka.clients.consumer.ConsumerConfig&quot;)
+        );
+        assertFalse(PluginUtils.shouldLoadInIsolation(
+                &quot;org.apache.kafka.clients.admin.KafkaAdminClient&quot;)
+        );
     }

&lt;p&gt;     @Test&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 42 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3lw0f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>