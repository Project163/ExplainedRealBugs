<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:00:07 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-4848] Stream thread getting into deadlock state while trying to get rocksdb lock in retryWithBackoff</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-4848</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;We see a deadlock state when streams thread to process a task takes longer than MAX_POLL_INTERVAL_MS_CONFIG time. In this case this threads partitions are assigned to some other thread including rocksdb lock. When it tries to process the next task it cannot get rocks db lock and simply keeps waiting for that lock forever.&lt;/p&gt;

&lt;p&gt;in retryWithBackoff for AbstractTaskCreator we have a backoffTimeMs = 50L.&lt;br/&gt;
If it does not get lock the we simply increase the time by 10x and keep trying inside the while true loop.&lt;/p&gt;

&lt;p&gt;We need to have a upper bound for this backoffTimeM. If the time is greater than  MAX_POLL_INTERVAL_MS_CONFIG and it still hasn&apos;t got the lock means this thread&apos;s partitions are moved somewhere else and it may not get the lock again.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13048547">KAFKA-4848</key>
            <summary>Stream thread getting into deadlock state while trying to get rocksdb lock in retryWithBackoff</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sjmittal">Sachin Mittal</assignee>
                                    <reporter username="sjmittal">Sachin Mittal</reporter>
                        <labels>
                    </labels>
                <created>Mon, 6 Mar 2017 15:09:57 +0000</created>
                <updated>Thu, 20 Apr 2017 00:50:03 +0000</updated>
                            <resolved>Tue, 21 Mar 2017 05:01:52 +0000</resolved>
                                    <version>0.10.2.0</version>
                                    <fixVersion>0.10.2.1</fixVersion>
                    <fixVersion>0.11.0.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15897462" author="sjmittal" created="Mon, 6 Mar 2017 15:15:24 +0000"  >&lt;p&gt;The deadlock issue is like this.&lt;br/&gt;
If a thread has two partitions and while processing first partition it takes more than MAX_POLL_INTERVAL_MS_CONFIG time, then this thread is evicted from the group and both partitions are now migrated to some other thread. Now when it tries to process the second partition it tries to get the lock to rocks db. It won&apos;t get the lock since that partition is now moved to some other thread. So it keeps increasing the backoffTimeMs and keeps trying to get the lock forever. This reaching a deadlock.&lt;br/&gt;
To fix this we need some upper bound of the time limit till it tries to get that lock. And that upper bound has to be MAX_POLL_INTERVAL_MS_CONFIG, because if by that time it has not got the lock, we can see that this thread was evicted from the group and need to rejoin again to get new partitions.&lt;/p&gt;

&lt;p&gt;See in attached file:&lt;br/&gt;
DEBUG 2017-03-01 18:17:42,465 &lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread-1&amp;#93;&lt;/span&gt;: org.apache.kafka.streams.processor.internals.StreamThread - stream-thread &lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread-1&amp;#93;&lt;/span&gt; creating new task 0_4&lt;/p&gt;

&lt;p&gt;DEBUG 2017-03-01 18:24:19,202 &lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread-1&amp;#93;&lt;/span&gt;: org.apache.kafka.streams.processor.internals.StreamThread - stream-thread &lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread-1&amp;#93;&lt;/span&gt; creating new task 0_8&lt;/p&gt;

&lt;p&gt;Note from above 2 lines it took more than 5 minutes to process task 0_4. As a result partitions moved to a different thread.&lt;/p&gt;

&lt;p&gt;Next see following entries for 0_8&lt;/p&gt;

&lt;p&gt;WARN 2017-03-01 18:24:20,205 &lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread-1&amp;#93;&lt;/span&gt;: org.apache.kafka.streams.processor.internals.StreamThread - Could not create task 0_8. Will retry.&lt;br/&gt;
WARN 2017-03-01 18:24:21,257 &lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread-1&amp;#93;&lt;/span&gt;: org.apache.kafka.streams.processor.internals.StreamThread - Could not create task 0_8. Will retry.&lt;br/&gt;
WARN 2017-03-01 18:24:22,360 &lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread-1&amp;#93;&lt;/span&gt;: org.apache.kafka.streams.processor.internals.StreamThread - Could not create task 0_8. Will retry.&lt;br/&gt;
WARN 2017-03-01 18:24:23,563 &lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread-1&amp;#93;&lt;/span&gt;: org.apache.kafka.streams.processor.internals.StreamThread - Could not create task 0_8. Will retry.&lt;br/&gt;
WARN 2017-03-01 18:24:24,966 &lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread-1&amp;#93;&lt;/span&gt;: org.apache.kafka.streams.processor.internals.StreamThread - Could not create task 0_8. Will retry.&lt;br/&gt;
WARN 2017-03-01 18:24:26,768 &lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread-1&amp;#93;&lt;/span&gt;: org.apache.kafka.streams.processor.internals.StreamThread - Could not create task 0_8. Will retry.&lt;br/&gt;
WARN 2017-03-01 18:24:29,371 &lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread-1&amp;#93;&lt;/span&gt;: org.apache.kafka.streams.processor.internals.StreamThread - Could not create task 0_8. Will retry.&lt;br/&gt;
WARN 2017-03-01 18:24:34,435 &lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread-1&amp;#93;&lt;/span&gt;: org.apache.kafka.streams.processor.internals.StreamThread - Could not create task 0_8. Will retry.&lt;br/&gt;
WARN 2017-03-01 18:24:41,837 &lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread-1&amp;#93;&lt;/span&gt;: org.apache.kafka.streams.processor.internals.StreamThread - Could not create task 0_8. Will retry.&lt;br/&gt;
WARN 2017-03-01 18:24:55,640 &lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread-1&amp;#93;&lt;/span&gt;: org.apache.kafka.streams.processor.internals.StreamThread - Could not create task 0_8. Will retry.&lt;br/&gt;
WARN 2017-03-01 18:25:22,242 &lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread-1&amp;#93;&lt;/span&gt;: org.apache.kafka.streams.processor.internals.StreamThread - Could not create task 0_8. Will retry.&lt;br/&gt;
WARN 2017-03-01 18:26:14,445 &lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread-1&amp;#93;&lt;/span&gt;: org.apache.kafka.streams.processor.internals.StreamThread - Could not create task 0_8. Will retry.&lt;br/&gt;
WARN 2017-03-01 18:27:57,848 &lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread-1&amp;#93;&lt;/span&gt;: org.apache.kafka.streams.processor.internals.StreamThread - Could not create task 0_8. Will retry.&lt;br/&gt;
WARN 2017-03-01 18:31:23,689 &lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread-1&amp;#93;&lt;/span&gt;: org.apache.kafka.streams.processor.internals.StreamThread - Could not create task 0_8. Will retry.&lt;br/&gt;
WARN 2017-03-01 18:38:14,294 &lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread-1&amp;#93;&lt;/span&gt;: org.apache.kafka.streams.processor.internals.StreamThread - Could not create task 0_8. Will retry.&lt;br/&gt;
WARN 2017-03-01 18:51:54,497 &lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread-1&amp;#93;&lt;/span&gt;: org.apache.kafka.streams.processor.internals.StreamThread - Could not create task 0_8. Will retry.&lt;br/&gt;
WARN 2017-03-01 19:19:13,900 &lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread-1&amp;#93;&lt;/span&gt;: org.apache.kafka.streams.processor.internals.StreamThread - Could not create task 0_8. Will retry.&lt;br/&gt;
WARN 2017-03-01 20:13:53,014 &lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread-1&amp;#93;&lt;/span&gt;: org.apache.kafka.streams.processor.internals.StreamThread - Could not create task 0_8. Will retry.&lt;br/&gt;
WARN 2017-03-01 22:03:07,629 &lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread-1&amp;#93;&lt;/span&gt;: org.apache.kafka.streams.processor.internals.StreamThread - Could not create task 0_8. Will retry.&lt;br/&gt;
WARN 2017-03-02 01:41:35,831 &lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread-1&amp;#93;&lt;/span&gt;: org.apache.kafka.streams.processor.internals.StreamThread - Could not create task 0_8. Will retry.&lt;br/&gt;
WARN 2017-03-02 08:58:31,234 &lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread-1&amp;#93;&lt;/span&gt;: org.apache.kafka.streams.processor.internals.StreamThread - Could not create task 0_8. Will retry.&lt;/p&gt;

&lt;p&gt;From 2017-03-01 18:24:20,205 to 017-03-02 08:58:31,234 it kept trying to get the lock, hence deadlock.&lt;/p&gt;</comment>
                            <comment id="15897463" author="sjmittal" created="Mon, 6 Mar 2017 15:15:52 +0000"  >&lt;p&gt;Please refer &lt;a href=&quot;https://github.com/apache/kafka/pull/2642&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2642&lt;/a&gt; as potential fix for the issue.&lt;/p&gt;</comment>
                            <comment id="15922762" author="guozhang" created="Mon, 13 Mar 2017 19:09:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sjmittal&quot; class=&quot;user-hover&quot; rel=&quot;sjmittal&quot;&gt;sjmittal&lt;/a&gt; BTW I have added you to the contributor list.&lt;/p&gt;</comment>
                            <comment id="15934096" author="githubbot" created="Tue, 21 Mar 2017 04:57:01 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/2642&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2642&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15935696" author="guozhang" created="Wed, 22 Mar 2017 02:47:34 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sjmittal&quot; class=&quot;user-hover&quot; rel=&quot;sjmittal&quot;&gt;sjmittal&lt;/a&gt; Could I ask you a follow-up question: are these two threads within the same process, or are they from different processes that sits in the same machine?&lt;/p&gt;</comment>
                            <comment id="15935744" author="sjmittal" created="Wed, 22 Mar 2017 03:55:48 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; We ran only once instance of streams application per machine. So if two threads would access same partition on the same machine then this issue would arise.&lt;/p&gt;

&lt;p&gt;I am not sure what would happen with different threads of different instances (processes) on same machine would try to get lock of same partition.&lt;/p&gt;</comment>
                            <comment id="15953734" author="enothereska" created="Mon, 3 Apr 2017 16:23:24 +0000"  >&lt;p&gt;Needs to go to 0.10.2.1 too. Reopening to track that.&lt;/p&gt;</comment>
                            <comment id="15953777" author="sjmittal" created="Mon, 3 Apr 2017 16:45:06 +0000"  >&lt;p&gt;Please let me know if this will be done in 0.10.2 branch. Do I need to issue a PR for the same.&lt;/p&gt;

&lt;p&gt;Also note that in that branch some fixes which are there in trunk like catching the commit failed exception of offset commits is not there, which would be  a pre-requiste for this fix.&lt;/p&gt;

&lt;p&gt;So let me know how are we planning on 0.10.2.1 release.&lt;/p&gt;

</comment>
                            <comment id="15953804" author="enothereska" created="Mon, 3 Apr 2017 16:53:52 +0000"  >&lt;p&gt;Sachin, stay tuned, the committers are looking into it for now.&lt;/p&gt;</comment>
                            <comment id="15975831" author="guozhang" created="Thu, 20 Apr 2017 00:50:03 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sjmittal&quot; class=&quot;user-hover&quot; rel=&quot;sjmittal&quot;&gt;sjmittal&lt;/a&gt; It is cherry-picked into 0.10.2 now I think.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12856293" name="thr-1" size="285364" author="sjmittal" created="Mon, 6 Mar 2017 15:09:57 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 30 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3b013:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>