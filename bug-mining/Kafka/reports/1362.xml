<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:59:15 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-4725] Kafka broker fails due to OOM when producer exceeds throttling quota for extended periods of time</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-4725</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Steps to Reproduce:&lt;/p&gt;

&lt;p&gt;1. Create a non-compacted topic with 1 partition&lt;br/&gt;
2. Set a produce quota of 512 KB/s&lt;br/&gt;
3. Send messages at 20 MB/s&lt;br/&gt;
4. Observe heap memory growth as time progresses&lt;/p&gt;

&lt;p&gt;Investigation:&lt;/p&gt;

&lt;p&gt;While running performance tests with a user configured with a produce quota, we found that the lead broker serving the requests would exhaust heap memory if the producer sustained a inbound request throughput greater than the produce quota. &lt;/p&gt;

&lt;p&gt;Upon further investigation, we took a heap dump from that broker process and discovered the ThrottledResponse object has a indirect reference to the byte[] holding the messages associated with the ProduceRequest. &lt;/p&gt;

&lt;p&gt;We&apos;re happy contributing a patch but in the meantime wanted to first raise the issue and get feedback from the community.&lt;/p&gt;</description>
                <environment>Ubuntu Trusty (14.04.5), Oracle JDK 8</environment>
        <key id="13039912">KAFKA-4725</key>
            <summary>Kafka broker fails due to OOM when producer exceeds throttling quota for extended periods of time</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="jchao">Jeff Chao</reporter>
                        <labels>
                            <label>reliability</label>
                    </labels>
                <created>Thu, 2 Feb 2017 18:57:44 +0000</created>
                <updated>Tue, 7 Feb 2017 23:13:54 +0000</updated>
                            <resolved>Tue, 7 Feb 2017 23:13:54 +0000</resolved>
                                    <version>0.10.1.1</version>
                                    <fixVersion>0.10.2.0</fixVersion>
                                    <component>core</component>
                    <component>producer </component>
                        <due></due>
                            <votes>2</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="15851730" author="ijuma" created="Fri, 3 Feb 2017 17:01:05 +0000"  >&lt;p&gt;Nice catch, a contribution via a PR would be welcome indeed.&lt;/p&gt;</comment>
                            <comment id="15851880" author="halorgium" created="Fri, 3 Feb 2017 18:31:39 +0000"  >&lt;p&gt;Hi there, &lt;/p&gt;

&lt;p&gt;Jeff and I have prototyped a fix for this bug. We repeated our stress tests against a new build and have not yet been able to reproduce the leak. &lt;/p&gt;

&lt;p&gt;The branch is hosted on GitHub at &lt;a href=&quot;https://github.com/apache/kafka/compare/0.10.1.1...heroku:fix-throttled-response-leak&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/compare/0.10.1.1...heroku:fix-throttled-response-leak&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Before we open a PR, which base branch should we set as the target for the PR?&lt;/p&gt;

&lt;p&gt;Thanks, &lt;br/&gt;
Tim&lt;/p&gt;</comment>
                            <comment id="15851885" author="ijuma" created="Fri, 3 Feb 2017 18:34:10 +0000"  >&lt;p&gt;Great. The target should be trunk, we cherry-pick to other branches during the merge.&lt;/p&gt;</comment>
                            <comment id="15851898" author="jchao" created="Fri, 3 Feb 2017 18:36:12 +0000"  >&lt;p&gt;Ok, we&apos;ll base it off trunk and open up a PR. Thanks.&lt;/p&gt;</comment>
                            <comment id="15852189" author="githubbot" created="Fri, 3 Feb 2017 21:57:47 +0000"  >&lt;p&gt;GitHub user halorgium opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/2496&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2496&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-4725&quot; title=&quot;Kafka broker fails due to OOM when producer exceeds throttling quota for extended periods of time&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-4725&quot;&gt;&lt;del&gt;KAFKA-4725&lt;/del&gt;&lt;/a&gt;: Stop leaking messages in produce request body when requests are delayed&lt;/p&gt;

&lt;p&gt;    This change is in response to &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-4725&quot; title=&quot;Kafka broker fails due to OOM when producer exceeds throttling quota for extended periods of time&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-4725&quot;&gt;&lt;del&gt;KAFKA-4725&lt;/del&gt;&lt;/a&gt;(&lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-4725&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-4725&lt;/a&gt;). &lt;/p&gt;

&lt;p&gt;    When a produce request is received, if the user/client is exceeding their produce quota, the response will be delayed until the quota is refilled appropriately. &lt;/p&gt;

&lt;p&gt;    Unfortunately, the request body is still referenced in the callback which in turn leaks the messages contained within the request. &lt;/p&gt;

&lt;p&gt;    This change allows the `KafkaApis` method to take ownership of the request body from the `RequestChannel.Request` object. &lt;/p&gt;

&lt;p&gt;    I am not sure whether this breaks other invariants which are assumed within other parts of Kafka. &lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/heroku/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/heroku/kafka&lt;/a&gt; fix-throttled-response-leak&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/2496.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2496.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #2496&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit ddb0541b156db546fbf6e065670fb25d6e4baba2&lt;br/&gt;
Author: Tim Carey-Smith &amp;lt;tim@spork.in&amp;gt;&lt;br/&gt;
Date:   2017-02-01T23:18:43Z&lt;/p&gt;

&lt;p&gt;    Stop leaking produce request in throttled requests&lt;/p&gt;

&lt;p&gt;    Further isolate the request from the callbacks&lt;/p&gt;

&lt;p&gt;    Remove pointless changes&lt;/p&gt;

&lt;p&gt;    Move body ownership logic into RequestChannel&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15856965" author="halorgium" created="Tue, 7 Feb 2017 22:51:42 +0000"  >&lt;p&gt;We have run stress tests on builds which include this patch based on the 0.10.1.1 tag, the 0.10.2 branch and the trunk branch. &lt;br/&gt;
We were unable to reproduce the memory leak and feel comfortable with this change. &lt;/p&gt;</comment>
                            <comment id="15856990" author="githubbot" created="Tue, 7 Feb 2017 23:13:37 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/2496&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2496&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15856992" author="junrao" created="Tue, 7 Feb 2017 23:13:54 +0000"  >&lt;p&gt;Issue resolved by pull request 2496&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/kafka/pull/2496&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2496&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12850666" name="oom-references.png" size="581656" author="jchao" created="Thu, 2 Feb 2017 18:57:44 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 40 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i39jiv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>junrao</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>