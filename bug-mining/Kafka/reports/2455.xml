<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:21:31 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-9307] Transaction coordinator could be left in unknown state after ZK session timeout</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-9307</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;We observed a case where the transaction coordinator could not load transaction state from __transaction-state topic partition. Clients would continue seeing&#160;COORDINATOR_LOAD_IN_PROGRESS exceptions until the broker hosting the coordinator is restarted.&lt;/p&gt;

&lt;p&gt;This is the sequence of events that leads to the issue:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;The broker is the leader of one (or more) transaction state topic partitions.&lt;/li&gt;
	&lt;li&gt;The broker loses its ZK session due to a network issue.&lt;/li&gt;
	&lt;li&gt;Broker reestablishes session with ZK, though there are still transient network issues.&lt;/li&gt;
	&lt;li&gt;Broker is made follower of the transaction state topic partition it was leading earlier.&lt;/li&gt;
	&lt;li&gt;During the become-follower transition, the broker loses its ZK session again.&lt;/li&gt;
	&lt;li&gt;The become-follower transition for this broker fails in-between, leaving us in a partial leader / partial follower state for the transaction topic. This meant that we could not unload the transaction metadata. However, the broker successfully caches the leader epoch of associated with the LeaderAndIsrRequest.&lt;/li&gt;
	&lt;li&gt;Later, when the ZK session is finally established successfully, the broker ignores the become-follower transition as the leader epoch was same as the one it had cached. This prevented the transaction metadata from being unloaded.&lt;/li&gt;
	&lt;li&gt;Because this partition was a partial follower, we had setup replica fetchers. The partition continued to fetch from the leader until it was made part of the ISR.&lt;/li&gt;
	&lt;li&gt;Once it was part of the ISR, preferred leader election kicked in and elected this broker as the leader.&lt;/li&gt;
	&lt;li&gt;When processing the become-leader transition, the transaction state load operation failed as we already had transaction metadata loaded at a previous epoch.&lt;/li&gt;
	&lt;li&gt;This meant that this partition was left in the &quot;loading&quot; state and we thus returned COORDINATOR_LOAD_IN_PROGRESS errors.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Restarting the broker that hosts the transaction state coordinator is the only way to recover from this situation.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13274893">KAFKA-9307</key>
            <summary>Transaction coordinator could be left in unknown state after ZK session timeout</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dhruvilshah">Dhruvil Shah</assignee>
                                    <reporter username="dhruvilshah">Dhruvil Shah</reporter>
                        <labels>
                    </labels>
                <created>Tue, 17 Dec 2019 04:21:57 +0000</created>
                <updated>Tue, 26 Jan 2021 20:26:43 +0000</updated>
                            <resolved>Mon, 23 Dec 2019 23:51:28 +0000</resolved>
                                    <version>2.2.0</version>
                    <version>2.2.1</version>
                    <version>2.2.2</version>
                    <version>2.3.0</version>
                    <version>2.3.1</version>
                    <version>2.4.0</version>
                                    <fixVersion>2.2.3</fixVersion>
                    <fixVersion>2.3.2</fixVersion>
                    <fixVersion>2.4.1</fixVersion>
                                    <component>core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16997882" author="dhruvilshah" created="Tue, 17 Dec 2019 04:35:42 +0000"  >&lt;p&gt;Exception during step 6 that led to partial completion of become-follower transition:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[2019-12-12 03:08:17,864] ERROR [KafkaApi-3] Error when handling request: clientId=2, correlationId=1, api=LEADER_AND_ISR,
...
{topic=__transaction_state,partition_states=[{...
{partition=41,controller_epoch=16,leader=4,leader_epoch=112,isr=[2,4,1],zk_version=208,replicas=[3,4,2,1],is_new=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;}
...
org.apache.zookeeper.KeeperException$SessionExpiredException: KeeperErrorCode = Session expired &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; /brokers/topics/__transaction_state
	at org.apache.zookeeper.KeeperException.create(KeeperException.java:130)
	at org.apache.zookeeper.KeeperException.create(KeeperException.java:54)
	at kafka.zookeeper.AsyncResponse.resultException(ZooKeeperClient.scala:537)
	at kafka.zk.KafkaZkClient$$anonfun$getReplicaAssignmentForTopics$1.apply(KafkaZkClient.scala:579)
	at kafka.zk.KafkaZkClient$$anonfun$getReplicaAssignmentForTopics$1.apply(KafkaZkClient.scala:574)
	at scala.collection.TraversableLike$$anonfun$flatMap$1.apply(TraversableLike.scala:241)
	at scala.collection.TraversableLike$$anonfun$flatMap$1.apply(TraversableLike.scala:241)
	at scala.collection.mutable.ResizableArray$&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;foreach(ResizableArray.scala:59)
	at scala.collection.mutable.ArrayBuffer.foreach(ArrayBuffer.scala:48)
	at scala.collection.TraversableLike$&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;flatMap(TraversableLike.scala:241)
	at scala.collection.AbstractTraversable.flatMap(Traversable.scala:104)
	at kafka.zk.KafkaZkClient.getReplicaAssignmentForTopics(KafkaZkClient.scala:574)
	at kafka.zk.KafkaZkClient.getTopicPartitionCount(KafkaZkClient.scala:624)
	at kafka.coordinator.transaction.TransactionStateManager.getTransactionTopicPartitionCount(TransactionStateManager.scala:279)
	at kafka.coordinator.transaction.TransactionStateManager.validateTransactionTopicPartitionCountIsStable(TransactionStateManager.scala:465)
	at kafka.coordinator.transaction.TransactionStateManager.removeTransactionsForTxnTopicPartition(TransactionStateManager.scala:434)
	at kafka.coordinator.transaction.TransactionCoordinator.handleTxnEmigration(TransactionCoordinator.scala:282)
	at kafka.server.KafkaApis$$anonfun$kafka$server$KafkaApis$$onLeadershipChange$1$2.apply(KafkaApis.scala:190)
	at kafka.server.KafkaApis$$anonfun$kafka$server$KafkaApis$$onLeadershipChange$1$2.apply(KafkaApis.scala:186)
	at scala.collection.mutable.HashSet.foreach(HashSet.scala:78)
	at kafka.server.KafkaApis.kafka$server$KafkaApis$$onLeadershipChange$1(KafkaApis.scala:186)
	at kafka.server.KafkaApis$$anonfun$2.apply(KafkaApis.scala:202)
	at kafka.server.KafkaApis$$anonfun$2.apply(KafkaApis.scala:202)
	at kafka.server.ReplicaManager.becomeLeaderOrFollower(ReplicaManager.scala:1153)
	at kafka.server.KafkaApis.handleLeaderAndIsrRequest(KafkaApis.scala:202) 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16997883" author="dhruvilshah" created="Tue, 17 Dec 2019 04:36:45 +0000"  >&lt;p&gt;Exception during step 10 that caused transaction metadata load to fail after become-leader transition:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2019-12-12 03:11:56,320] ERROR [Transaction State Manager 3]: The metadata cache &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; txn partition 41 has already exist with epoch 111 and 6 entries &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; trying to add to it; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; should not happen (kafka.coordinator.transaction.TransactionStateManager)
[2019-12-12 03:11:56,320] ERROR Uncaught exception in scheduled task &lt;span class=&quot;code-quote&quot;&gt;&apos;load-txns-&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;-partition-__transaction_state-41&apos;&lt;/span&gt; (kafka.utils.KafkaScheduler)
java.lang.IllegalStateException: The metadata cache &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; txn partition 41 has already exist with epoch 111 and 6 entries &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; trying to add to it; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; should not happen
	at kafka.coordinator.transaction.TransactionStateManager.addLoadedTransactionsToCache(TransactionStateManager.scala:369)
	at kafka.coordinator.transaction.TransactionStateManager$$anonfun$kafka$coordinator$transaction$TransactionStateManager$$loadTransactions$1$1.apply$mcV$sp(TransactionStateManager.scala:394)
	at kafka.coordinator.transaction.TransactionStateManager$$anonfun$kafka$coordinator$transaction$TransactionStateManager$$loadTransactions$1$1.apply(TransactionStateManager.scala:393)
	at kafka.coordinator.transaction.TransactionStateManager$$anonfun$kafka$coordinator$transaction$TransactionStateManager$$loadTransactions$1$1.apply(TransactionStateManager.scala:393)
	at kafka.utils.CoreUtils$.inLock(CoreUtils.scala:251)
	at kafka.utils.CoreUtils$.inWriteLock(CoreUtils.scala:259)
	at kafka.coordinator.transaction.TransactionStateManager.kafka$coordinator$transaction$TransactionStateManager$$loadTransactions$1(TransactionStateManager.scala:392)
	at kafka.coordinator.transaction.TransactionStateManager$$anonfun$loadTransactionsForTxnTopicPartition$2.apply$mcV$sp(TransactionStateManager.scala:426)
	at kafka.utils.KafkaScheduler$$anonfun$1.apply$mcV$sp(KafkaScheduler.scala:114)
	at kafka.utils.CoreUtils$$anon$1.run(CoreUtils.scala:63)
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
	at java.util.concurrent.FutureTask.run(FutureTask.java:266)
	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$201(ScheduledThreadPoolExecutor.java:180)
	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:293)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16997885" author="dhruvilshah" created="Tue, 17 Dec 2019 04:41:02 +0000"  >&lt;p&gt;Become-follower transition ignored during step 7:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[2019-12-12 03:08:18,241] TRACE [Broker id=3] Received LeaderAndIsr request PartitionState(controllerEpoch=16, leader=4, leaderEpoch=112, isr=2,4,1, zkVersion=208, replicas=3,4,2,1, isNew=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;) correlation id 1 from controller 2 epoch 16 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition __transaction_state-41 (state.change.logger)
[2019-12-12 03:08:18,247] WARN [Broker id=3] Ignoring LeaderAndIsr request from controller 2 with correlation id 1 epoch 16 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition __transaction_state-41 since its associated leader epoch 112 is not higher than the current leader epoch 112 (state.change.logger)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16997925" author="githubbot" created="Tue, 17 Dec 2019 06:34:15 +0000"  >&lt;p&gt;dhruvilshah3 commented on pull request #7840: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-9307&quot; title=&quot;Transaction coordinator could be left in unknown state after ZK session timeout&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-9307&quot;&gt;&lt;del&gt;KAFKA-9307&lt;/del&gt;&lt;/a&gt;: Make transaction metadata loading resilient to previous errors&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/7840&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/7840&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="17001265" author="githubbot" created="Fri, 20 Dec 2019 22:38:32 +0000"  >&lt;p&gt;dhruvilshah3 commented on pull request #7840: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-9307&quot; title=&quot;Transaction coordinator could be left in unknown state after ZK session timeout&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-9307&quot;&gt;&lt;del&gt;KAFKA-9307&lt;/del&gt;&lt;/a&gt;: Make transaction metadata loading resilient to previous errors&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/7840&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/7840&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="17001266" author="githubbot" created="Fri, 20 Dec 2019 22:38:35 +0000"  >&lt;p&gt;dhruvilshah3 commented on pull request #7840: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-9307&quot; title=&quot;Transaction coordinator could be left in unknown state after ZK session timeout&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-9307&quot;&gt;&lt;del&gt;KAFKA-9307&lt;/del&gt;&lt;/a&gt;: Make transaction metadata loading resilient to previous errors&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/7840&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/7840&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Allow transaction metadata to be reloaded, even if it already exists as of a previous epoch. This helps with cases where a previous become-follower transition failed to unload corresponding metadata.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="17002540" author="githubbot" created="Mon, 23 Dec 2019 23:20:45 +0000"  >&lt;p&gt;hachikuji commented on pull request #7840: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-9307&quot; title=&quot;Transaction coordinator could be left in unknown state after ZK session timeout&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-9307&quot;&gt;&lt;del&gt;KAFKA-9307&lt;/del&gt;&lt;/a&gt;: Make transaction metadata loading resilient to previous errors&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/7840&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/7840&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13250832">KAFKA-8803</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13233643">KAFKA-8374</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 47 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z09qnk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>