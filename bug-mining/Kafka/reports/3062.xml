<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:28:33 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-13008] Stream will stop processing data for a long time while waiting for the partition lag</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-13008</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;In KIP-695, we improved the task idling mechanism by checking partition lag. It&apos;s a good improvement for timestamp sync. But I found it will cause the stream stop processing the data for a long time while waiting for the partition metadata.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I&apos;ve been investigating this case for a while, and figuring out the issue will happen in below situation (or similar situation):&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;start 2 streams (each with 1 thread) to consume from a topicA (with 3 partitions: A-0, A-1, A-2)&lt;/li&gt;
	&lt;li&gt;After 2 streams started, the partitions assignment are: (I skipped some other processing related partitions for simplicity)&lt;br/&gt;
 stream1-thread1: A-0, A-1 &lt;br/&gt;
 stream2-thread1: A-2&lt;/li&gt;
	&lt;li&gt;start processing some data, assume now, the position and high watermark is:&lt;br/&gt;
 A-0: offset: 2, highWM: 2&lt;br/&gt;
 A-1: offset: 2, highWM: 2&lt;br/&gt;
 A-2: offset: 2, highWM: 2&lt;/li&gt;
	&lt;li&gt;Now, stream3 joined, so trigger rebalance with this assignment:&lt;br/&gt;
 stream1-thread1: A-0 &lt;br/&gt;
 stream2-thread1: A-2&lt;br/&gt;
 stream3-thread1: A-1&lt;/li&gt;
	&lt;li&gt;Suddenly, stream3 left, so now, rebalance again, with the step 2 assignment:&lt;br/&gt;
 stream1-thread1: A-0, &lt;b&gt;A-1&lt;/b&gt; &lt;br/&gt;
 stream2-thread1: A-2&lt;br/&gt;
 (note: after initialization, the&#160; position of A-1 will be: position: null, highWM: null)&lt;/li&gt;
	&lt;li&gt;Now, note that, the partition A-1 used to get assigned to stream1-thread1, and now, it&apos;s back. And also, assume the partition A-1 has slow input (ex: 1 record per 30 mins), and partition A-0 has fast input (ex: 10K records / sec). So, now, the stream1-thread1 won&apos;t process any data until we got input from partition A-1 (even if partition A-0 is buffered a lot, and we have `&lt;tt&gt;max.task.idle.ms&lt;/tt&gt;` set to 0).&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The reason why the stream1-thread1 won&apos;t process any data is because we can&apos;t get the lag of partition A-1. And why we can&apos;t get the lag? It&apos;s because&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;In KIP-695, we use consumer&apos;s cache to get the partition lag, to avoid remote call&lt;/li&gt;
	&lt;li&gt;The lag for a partition will be cleared if the assignment in this round doesn&apos;t have this partition. check &lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/clients/src/main/java/org/apache/kafka/clients/consumer/internals/SubscriptionState.java#L272&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. So, in the above example, the metadata cache for partition A-1 will be cleared in step 4, and re-initialized (to null) in step 5&lt;/li&gt;
	&lt;li&gt;In KIP-227, we introduced a fetch session to have incremental fetch request/response. That is, if the session existed, the client(consumer) will get the update only when the fetched partition have update (ex: new data). So, in the above case, the partition A-1 has slow input (ex: 1 record per 30 mins), it won&apos;t have update until next 30 mins, or wait for the fetch session become inactive for (default) 2 mins to be evicted. Either case, the metadata won&apos;t be updated for a while.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;In KIP-695, if we don&apos;t get the partition lag, we can&apos;t determine the partition data status to do timestamp sync, so we&apos;ll keep waiting and not processing any data. That&apos;s why this issue will happen.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Proposed solution:&lt;/b&gt;&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;If we don&apos;t get the current lag for a partition, or the current lag &amp;gt; 0, we start to wait for max.task.idle.ms, and reset the deadline when we get the partition lag, like what we did in previous KIP-353&lt;/li&gt;
	&lt;li&gt;Introduce a waiting time config when no partition lag, or partition lag keeps &amp;gt; 0 (need KIP)&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vvcephei&quot; class=&quot;user-hover&quot; rel=&quot;vvcephei&quot;&gt;vvcephei&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; , any suggestions?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ableegoldman&quot; class=&quot;user-hover&quot; rel=&quot;ableegoldman&quot;&gt;ableegoldman&lt;/a&gt;&#160; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mjsax&quot; class=&quot;user-hover&quot; rel=&quot;mjsax&quot;&gt;mjsax&lt;/a&gt; , this is the root cause that in &lt;a href=&quot;https://github.com/apache/kafka/pull/10736,&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/10736,&lt;/a&gt; we discussed and thought there&apos;s a data lose situation. FYI.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13386435">KAFKA-13008</key>
            <summary>Stream will stop processing data for a long time while waiting for the partition lag</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="guozhang">Guozhang Wang</assignee>
                                    <reporter username="showuon">Luke Chen</reporter>
                        <labels>
                    </labels>
                <created>Tue, 29 Jun 2021 06:44:53 +0000</created>
                <updated>Fri, 23 Jul 2021 23:47:43 +0000</updated>
                            <resolved>Fri, 23 Jul 2021 23:47:42 +0000</resolved>
                                    <version>3.0.0</version>
                                    <fixVersion>3.0.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="17371930" author="showuon" created="Wed, 30 Jun 2021 09:49:20 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vvcephei&quot; class=&quot;user-hover&quot; rel=&quot;vvcephei&quot;&gt;vvcephei&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; , any suggestions for this issue?&lt;/p&gt;

&lt;p&gt;IMO, this is not the expected behavior because what we expected to wait is the partition info not retrieved, yet. But in this case, the partition info is indeed retrieved (in fetch session&apos;s perspective), but the partition cache for that partition is cleared.&lt;/p&gt;

&lt;p&gt;Thank you.&lt;/p&gt;</comment>
                            <comment id="17376019" author="ableegoldman" created="Tue, 6 Jul 2021 20:51:45 +0000"  >&lt;p&gt;Nice find! I agree, this does not seem like the expected behavior, and given that it&apos;s been causing a test to fail regularly I think we can assert that this should not happen.&#160;&lt;/p&gt;

&lt;p&gt;One thing I don&apos;t understand, and maybe this is because I don&apos;t have much context on the incremental fetch internals, is: why would we not get the metadata again after the partition is re-assigned in step 5? Surely if a partition was removed from the assignment and then added back, this should constitute a new &apos;session&apos;, and thus it should get the metadata again on assignment? If not that sounds like a bug in the incremental fetch to me, but again, I&apos;m not too familiar with it so there could be a valid reason it works this way.&#160;&lt;/p&gt;

&lt;p&gt;If so, then maybe we should consider allowing metadata to remain around after a partition is unassigned, in case it gets this same partition back within the session? Could there be other consequences of this lack of metadata, outside of Streams?&lt;/p&gt;</comment>
                            <comment id="17376189" author="showuon" created="Wed, 7 Jul 2021 03:28:36 +0000"  >&lt;p&gt;Actually, I&apos;m not very familiar with detailed incremental session, too. But from the , &lt;a href=&quot;https://cwiki.apache.org/confluence/display/KAFKA/KIP-227%3A+Introduce+Incremental+FetchRequests+to+Increase+Partition+Scalability&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;KIP-227&lt;/a&gt;: we can see the old session will be evict only when matching 1 of the following 3 condition:&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13030208/13030208_image-2021-07-07-11-19-55-630.png&quot; height=&quot;161&quot; width=&quot;762&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;And because in the step 5, all above 3 conditions won&apos;t match, the new session won&apos;t evict the old session. Also, during that time, the old session already contain the &quot;up-to-date&quot; partition info of the partition A-1 (because partition A-1 was assigned to this session), so no partition A-1 update will be received.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;This is my understanding. Please correct me if I&apos;m wrong. Thank you.&lt;/p&gt;</comment>
                            <comment id="17377644" author="cmccabe" created="Thu, 8 Jul 2021 23:41:21 +0000"  >&lt;p&gt;Thanks, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=showuon&quot; class=&quot;user-hover&quot; rel=&quot;showuon&quot;&gt;showuon&lt;/a&gt;... this is a good find.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ableegoldman&quot; class=&quot;user-hover&quot; rel=&quot;ableegoldman&quot;&gt;ableegoldman&lt;/a&gt; wrote:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Surely if a partition was removed from the assignment and then added back, this should constitute a new &apos;session&apos;, and thus it should get the metadata again on assignment&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Sessions may be changed without creating a new session. They wouldn&apos;t be much use otherwise, since many consumers often change their subscriptions or mute partitions, etc.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;If so, then maybe we should consider allowing metadata to remain around after a partition is unassigned, in case it gets this same partition back within the session? Could there be other consequences of this lack of metadata, outside of Streams?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The issue is that the metadata would be incorrect. If the fetch session doesn&apos;t contain a partition, we really can&apos;t say anything about what its lag is, other than potentially caching a stale value. But we don&apos;t know how long the partition could be muted (it could be hours, for example).&lt;/p&gt;

&lt;p&gt;Ultimately there is a tradeoff here between having the most up-to-date lag information for each partition, and efficiency. I&apos;m not totally sure what the best way to resolve this is (we&apos;d have to look at the Streams use-case more carefully).&lt;/p&gt;</comment>
                            <comment id="17378338" author="vvcephei" created="Fri, 9 Jul 2021 22:42:32 +0000"  >&lt;p&gt;Woah, this is an excellent find, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=showuon&quot; class=&quot;user-hover&quot; rel=&quot;showuon&quot;&gt;showuon&lt;/a&gt; !&lt;/p&gt;

&lt;p&gt;You and Sophie are absolutely right. We chose to use the cached lag so that we wouldn&apos;t have to wait for a full round-trip every time we want to know whether we&apos;re approximately caught up.&lt;/p&gt;

&lt;p&gt;Colin is right, too; we don&apos;t want to use a metadata cache that can be arbitrarily old. There are plenty of applications that go days without a rebalance, which would certainly violate the semantics we&apos;re going for here.&lt;/p&gt;

&lt;p&gt;Re-reading KIP-227, it seems like there should be a way for the client to add re-acquired partitions like this to the incremental fetch request so that it can reinitialize its metadata cache. In other words, it seems like getting a partition assigned that you haven&apos;t owned for a while is effectively the same case as getting a partition that you&apos;ve never owned, and there does seem to be a mechanism for the latter.&lt;/p&gt;

&lt;p&gt;Does that sound right to you, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cmccabe&quot; class=&quot;user-hover&quot; rel=&quot;cmccabe&quot;&gt;cmccabe&lt;/a&gt; ?&lt;/p&gt;</comment>
                            <comment id="17379462" author="ableegoldman" created="Mon, 12 Jul 2021 23:22:36 +0000"  >&lt;blockquote&gt;&lt;p&gt;Re-reading KIP-227, it seems like there should be a way for the client to add re-acquired partitions like this to the incremental fetch request so that it can reinitialize its metadata cache. In other words, it seems like getting a partition assigned that you haven&apos;t owned for a while is effectively the same case as getting a partition that you&apos;ve never owned, and there does seem to be a mechanism for the latter.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Thanks John, that is exactly what I was trying to suggest above, but I may have mungled it with my lack of understanding of the incremental fetch design. Given how long this bug went unnoticed and the in-depth investigation it took to uncover the bug (again, nicely done &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=showuon&quot; class=&quot;user-hover&quot; rel=&quot;showuon&quot;&gt;showuon&lt;/a&gt;), it seems like any user of the plain consumer client in addition to Streams could be easily tripped up by this. And just personally, I had to read the analysis twice to really understand what was going on, since the behavior was/is so unintuitive to me.&lt;/p&gt;</comment>
                            <comment id="17379482" author="guozhang" created="Tue, 13 Jul 2021 00:34:32 +0000"  >&lt;p&gt;Thanks for the great find &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=showuon&quot; class=&quot;user-hover&quot; rel=&quot;showuon&quot;&gt;showuon&lt;/a&gt;!&lt;/p&gt;

&lt;p&gt;I took a look at the server-side code, and I think we can consider two things:&lt;/p&gt;

&lt;p&gt;1) slightly augment the session handling logic so that within a session, if a partition was newly requested (here, we would not try to distinguish whether it was requested for the very first time, or it was re-added after a while), even if the requested position has reached the log end i.e. there&apos;s no data to return, we still return in the response to encode the log end information. WDYT &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cmccabe&quot; class=&quot;user-hover&quot; rel=&quot;cmccabe&quot;&gt;cmccabe&lt;/a&gt;?&lt;/p&gt;

&lt;p&gt;2) since 1) would be a broker change and even if we do that, it may not help all cases for streams, we would still need some remedies. One (somewhat hacky..) idea is to actually pay the round-trip in such cases (only when the config is set to &amp;gt;= 0), but that since fetch request would not do for old versioned brokers, we would use the offset request (either consumer or admin has the API to do that) to get the log end offset. In fact, in Streams when we get the assigned partitions we always need to get the log end offset for changes at first to check if any restoration is needed, we can, just add source topic partitions as well in that phase and expose as the initial values for the main consumer as well. Note this is only done once after every rebalance, and no more.&lt;/p&gt;</comment>
                            <comment id="17379505" author="ableegoldman" created="Tue, 13 Jul 2021 01:56:35 +0000"  >&lt;p&gt;Thanks Guozhang, +1 on that approach (though I&apos;ll let Colin confirm whether #1 does make sense or not). We&apos;ll definitely need a Streams/client side fix if the &apos;real&apos; fix is going to be on the broker side. My only question is whether this is something that might trip up other plain consumer client users in addition to Streams, and if so, whether there&apos;s anything we could do in the consumer client itself. But AFAIK it&apos;s only Streams that really relies on this metadata in this critical way, so I&apos;m happy with the Streams-side fix as well&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13274222">KAFKA-9295</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13030208" name="image-2021-07-07-11-19-55-630.png" size="98602" author="showuon" created="Wed, 7 Jul 2021 03:19:57 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 18 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0sedk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>