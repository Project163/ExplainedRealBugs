<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:24:40 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-10167] Streams EOS-Beta should not try to get end-offsets as read-committed</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-10167</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;This is a bug discovered with the new EOS protocol (KIP-447), here&apos;s the context:&lt;/p&gt;

&lt;p&gt;In Streams when we are assigned with the new active tasks, we would first try to restore the state from the changelog topic all the way to the log end offset, and then we can transit from the `restoring` to the `running` state to start processing the task.&lt;/p&gt;

&lt;p&gt;Before KIP-447, the end-offset call is only triggered after we&apos;ve passed the synchronization barrier at the txn-coordinator which would guarantee that the txn-marker has been sent and received (otherwise we would error with CONCURRENT_TRANSACTIONS and let the producer retry), and when the txn-marker is received, it also means that the marker has been fully replicated, which in turn guarantees that the data written before that marker has been fully replicated. As a result, when we send the list-offset with `read-committed` flag we are guaranteed that the returned offset == LSO == high-watermark.&lt;/p&gt;

&lt;p&gt;After KIP-447 however, we do not fence on the txn-coordinator but on group-coordinator upon offset-fetch, and the group-coordinator would return the fetching offset right after it has received the replicated the txn-marker sent to it. However, since the txn-marker are sent to different brokers in parallel, and even within the same broker markers of different partitions are appended / replicated independently as well, so when the fetch-offset request returns it is NOT guaranteed that the LSO on other data partitions would have been advanced as well. And hence in that case the `endOffset` call may returned a smaller offset, causing data loss.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13311589">KAFKA-10167</key>
            <summary>Streams EOS-Beta should not try to get end-offsets as read-committed</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="guozhang">Guozhang Wang</assignee>
                                    <reporter username="guozhang">Guozhang Wang</reporter>
                        <labels>
                    </labels>
                <created>Tue, 16 Jun 2020 00:20:33 +0000</created>
                <updated>Thu, 18 Jun 2020 23:13:38 +0000</updated>
                            <resolved>Thu, 18 Jun 2020 23:13:38 +0000</resolved>
                                    <version>2.6.0</version>
                                    <fixVersion>2.6.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17136215" author="guozhang" created="Tue, 16 Jun 2020 00:40:20 +0000"  >&lt;p&gt;The proposed solution is that even under EOS, do not try to use consumer.endOffset that would set `read-committed` flag, but to just use list-offset with `read-uncommitted` to get the end-offset.&lt;/p&gt;

&lt;p&gt;The rationale is that, since we know that this changelog-topic is a single-writer, single-reader, and we control all the writer / reader of it, we can safely assume that the on-going txn is only from our previous writer. &lt;/p&gt;

&lt;p&gt;If the task migration is due to a graceful rebalance (i.e. the task is indeed being revoked from the other host), then the old host would always commit in which it would block on `producer.flush` to make sure all data are written (although by default we do not override replication factor on changelog topics and producer&apos;s ack.mode, so if user change the one without the other they may bump into other issues where data are not replicated completely and hence high-watermark returned from list-offset can be smaller). And therefore the end-offset returned would return the actual log-end-offset with or without the txn-marker, either of which is fine.&lt;/p&gt;

&lt;p&gt;If the task migration is due to an unexpected task migration (i.e. the task was not proactively revoked, the old host may not know it is out of the group or has been crashed), then although not all records sent from the old host are guaranteed to be on the broker and be covered with end-offset, it is fine since these records will be aborted eventually anyways.&lt;/p&gt;</comment>
                            <comment id="17136216" author="guozhang" created="Tue, 16 Jun 2020 00:42:42 +0000"  >&lt;p&gt;I&apos;ve also thought about whether we need to block on mainConsumer#committed before getting the end-offset, and now I think that is not necessary either since the end-offset only requires that data is flushed &amp;#8212; again, remember we have this single-writer single-reader scenario and when we are in the initialize-changelog-reader phase, we know that the other old producer would not be able to write any more unabortable data to that partition.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13310878">KAFKA-10148</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 22 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0fvjs:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>