<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:15:47 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-7505] Flaky test: SslTransportLayerTest.testListenerConfigOverride</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-7505</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;This test seems to fail quite a bit recently. I&apos;ve seen it happen with Java 11 quite a bit so it could be more likely to fail there.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.AssertionError: expected:&amp;lt;AUTHENTICATION_FAILED&amp;gt; but was:&amp;lt;AUTHENTICATE&amp;gt; at org.junit.Assert.fail(Assert.java:88) at org.junit.Assert.failNotEquals(Assert.java:834) at org.junit.Assert.assertEquals(Assert.java:118) at org.junit.Assert.assertEquals(Assert.java:144) at org.apache.kafka.common.network.NetworkTestUtils.waitForChannelClose(NetworkTestUtils.java:104) at org.apache.kafka.common.network.NetworkTestUtils.waitForChannelClose(NetworkTestUtils.java:109) at org.apache.kafka.common.network.SslTransportLayerTest.testListenerConfigOverride(SslTransportLayerTest.java:319)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13191458">KAFKA-7505</key>
            <summary>Flaky test: SslTransportLayerTest.testListenerConfigOverride</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rsivaram">Rajini Sivaram</assignee>
                                    <reporter username="ijuma">Ismael Juma</reporter>
                        <labels>
                    </labels>
                <created>Sun, 14 Oct 2018 15:42:15 +0000</created>
                <updated>Fri, 3 May 2019 23:14:44 +0000</updated>
                            <resolved>Thu, 18 Oct 2018 14:12:46 +0000</resolved>
                                                    <fixVersion>2.1.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16649440" author="ijuma" created="Sun, 14 Oct 2018 15:42:40 +0000"  >&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rsivaram&quot; class=&quot;user-hover&quot; rel=&quot;rsivaram&quot;&gt;rsivaram&lt;/a&gt; in case she has thoughts.&lt;/p&gt;</comment>
                            <comment id="16650102" author="rsivaram" created="Mon, 15 Oct 2018 11:41:57 +0000"  >&lt;p&gt;The stack trace shows that the client didn&apos;t see SSL handshake notification from the broker when the broker failed handshake and then closed the connection.&lt;/p&gt;

&lt;p&gt;The sequence with older versions where this succeeds:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Client writes SSL handshake data&lt;/li&gt;
	&lt;li&gt;Broker process handshake data from client, fails handshake&lt;/li&gt;
	&lt;li&gt;Broker flushes handshake failure notification, waiting if necessary for flush to complete&lt;/li&gt;
	&lt;li&gt;Client reads data from broker, processes SSL handshake notification&lt;/li&gt;
	&lt;li&gt;Client processes failure as an authentication exception&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;We see the same sequence with Java 11 most of the time, but sometimes it fails because client is attempting to write more data to the broker (which is possible with the TLS protocol). The sequence is:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Client writes some SSL handshake data&lt;/li&gt;
	&lt;li&gt;Broker process handshake data from client, fails handshake&lt;/li&gt;
	&lt;li&gt;Broker flushes failure notification, waiting if necessary for flush to complete&lt;/li&gt;
	&lt;li&gt;Client attempts to write more data, fails with an I/O exception since broker has closed the connection&lt;/li&gt;
	&lt;li&gt;Client processes failure as an I/O exception&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;We guarantee that we never process an ordinary I/O exception as an authentication exception, but we don&apos;t actually guarantee the reverse. The tests however are strict because we want to try and handle all known authentication failure scenarios. I will see if we can fix this scenario in our implementation.&lt;/p&gt;</comment>
                            <comment id="16650322" author="githubbot" created="Mon, 15 Oct 2018 14:51:11 +0000"  >&lt;p&gt;rajinisivaram opened a new pull request #5800: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7505&quot; title=&quot;Flaky test: SslTransportLayerTest.testListenerConfigOverride&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7505&quot;&gt;&lt;del&gt;KAFKA-7505&lt;/del&gt;&lt;/a&gt;: Process incoming bytes on write error to report SSL failures&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5800&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5800&lt;/a&gt;&lt;/p&gt;



&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16655266" author="githubbot" created="Thu, 18 Oct 2018 14:08:46 +0000"  >&lt;p&gt;rajinisivaram closed pull request #5800: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7505&quot; title=&quot;Flaky test: SslTransportLayerTest.testListenerConfigOverride&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7505&quot;&gt;&lt;del&gt;KAFKA-7505&lt;/del&gt;&lt;/a&gt;: Process incoming bytes on write error to report SSL failures&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5800&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5800&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/clients/src/main/java/org/apache/kafka/common/network/SslTransportLayer.java b/clients/src/main/java/org/apache/kafka/common/network/SslTransportLayer.java&lt;br/&gt;
index a5ff06d9ada..a6696f79f66 100644&lt;br/&gt;
&amp;#8212; a/clients/src/main/java/org/apache/kafka/common/network/SslTransportLayer.java&lt;br/&gt;
+++ b/clients/src/main/java/org/apache/kafka/common/network/SslTransportLayer.java&lt;br/&gt;
@@ -254,11 +254,12 @@ public void handshake() throws IOException {&lt;br/&gt;
             throw closingException();&lt;/p&gt;

&lt;p&gt;         int read = 0;&lt;br/&gt;
+        boolean readable = key.isReadable();&lt;br/&gt;
         try {&lt;br/&gt;
             // Read any available bytes before attempting any writes to ensure that handshake failures&lt;br/&gt;
             // reported by the peer are processed even if writes fail (since peer closes connection&lt;br/&gt;
             // if handshake fails)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (key.isReadable())&lt;br/&gt;
+            if (readable)&lt;br/&gt;
                 read = readFromSocketChannel();&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;             doHandshake();&lt;br/&gt;
@@ -267,15 +268,16 @@ public void handshake() throws IOException {&lt;br/&gt;
         } catch (IOException e) {&lt;br/&gt;
             maybeThrowSslAuthenticationException();&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// this exception could be due to a write. If there is data available to unwrap,&lt;/li&gt;
	&lt;li&gt;// process the data so that any SSL handshake exceptions are reported&lt;/li&gt;
	&lt;li&gt;if (handshakeStatus == HandshakeStatus.NEED_UNWRAP &amp;amp;&amp;amp; netReadBuffer.position() &amp;gt; 0) {&lt;/li&gt;
	&lt;li&gt;try 
{
-                    handshakeUnwrap(false);
-                }
&lt;p&gt; catch (SSLException e1) &lt;/p&gt;
{
-                    maybeProcessHandshakeFailure(e1, false, e);
-                }
&lt;p&gt;+            // This exception could be due to a write. If there is data available to unwrap in the buffer, or data available&lt;br/&gt;
+            // in the socket channel to read and unwrap, process the data so that any SSL handshake exceptions are reported.&lt;br/&gt;
+            try &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+                do {
+                    handshakeUnwrap(false, true);
+                } while (readable &amp;amp;&amp;amp; readFromSocketChannel() &amp;gt; 0);+            }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt; catch (SSLException e1) &lt;/p&gt;
{
+                maybeProcessHandshakeFailure(e1, false, e);
             }
&lt;p&gt;+&lt;br/&gt;
             // If we get here, this is not a handshake failure, throw the original IOException&lt;br/&gt;
             throw e;&lt;br/&gt;
         }&lt;br/&gt;
@@ -334,7 +336,7 @@ private void doHandshake() throws IOException {&lt;br/&gt;
                 log.trace(&quot;SSLHandshake NEED_UNWRAP channelId {}, appReadBuffer pos {}, netReadBuffer pos {}, netWriteBuffer pos {}&quot;,&lt;br/&gt;
                           channelId, appReadBuffer.position(), netReadBuffer.position(), netWriteBuffer.position());&lt;br/&gt;
                 do {&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;handshakeResult = handshakeUnwrap(read);&lt;br/&gt;
+                    handshakeResult = handshakeUnwrap(read, false);&lt;br/&gt;
                     if (handshakeResult.getStatus() == Status.BUFFER_OVERFLOW) {&lt;br/&gt;
                         int currentAppBufferSize = applicationBufferSize();&lt;br/&gt;
                         appReadBuffer = Utils.ensureCapacity(appReadBuffer, currentAppBufferSize);&lt;br/&gt;
@@ -456,12 +458,13 @@ private SSLEngineResult handshakeWrap(boolean doWrite) throws IOException {&lt;br/&gt;
     }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     /**&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;* Perform handshake unwrap&lt;/li&gt;
	&lt;li&gt;* @param doRead boolean&lt;/li&gt;
	&lt;li&gt;* @return SSLEngineResult&lt;/li&gt;
	&lt;li&gt;* @throws IOException&lt;/li&gt;
	&lt;li&gt;*/&lt;/li&gt;
	&lt;li&gt;private SSLEngineResult handshakeUnwrap(boolean doRead) throws IOException {&lt;br/&gt;
+     * Perform handshake unwrap&lt;br/&gt;
+     * @param doRead boolean If true, read more from the socket channel&lt;br/&gt;
+     * @param ignoreHandshakeStatus If true, continue to unwrap if data available regardless of handshake status&lt;br/&gt;
+     * @return SSLEngineResult&lt;br/&gt;
+     * @throws IOException&lt;br/&gt;
+     */&lt;br/&gt;
+    private SSLEngineResult handshakeUnwrap(boolean doRead, boolean ignoreHandshakeStatus) throws IOException {&lt;br/&gt;
         log.trace(&quot;SSLHandshake handshakeUnwrap {}&quot;, channelId);&lt;br/&gt;
         SSLEngineResult result;&lt;br/&gt;
         int read = 0;&lt;br/&gt;
@@ -470,6 +473,7 @@ private SSLEngineResult handshakeUnwrap(boolean doRead) throws IOException {&lt;br/&gt;
         boolean cont;&lt;br/&gt;
         do {&lt;br/&gt;
             //prepare the buffer with the incoming data&lt;br/&gt;
+            int position = netReadBuffer.position();&lt;br/&gt;
             netReadBuffer.flip();&lt;br/&gt;
             result = sslEngine.unwrap(netReadBuffer, appReadBuffer);&lt;br/&gt;
             netReadBuffer.compact();&lt;br/&gt;
@@ -478,8 +482,9 @@ private SSLEngineResult handshakeUnwrap(boolean doRead) throws IOException {&lt;br/&gt;
                 result.getHandshakeStatus() == HandshakeStatus.NEED_TASK) 
{
                 handshakeStatus = runDelegatedTasks();
             }&lt;/li&gt;
	&lt;li&gt;cont = result.getStatus() == SSLEngineResult.Status.OK &amp;amp;&amp;amp;&lt;/li&gt;
	&lt;li&gt;handshakeStatus == HandshakeStatus.NEED_UNWRAP;&lt;br/&gt;
+            cont = (result.getStatus() == SSLEngineResult.Status.OK &amp;amp;&amp;amp;&lt;br/&gt;
+                    handshakeStatus == HandshakeStatus.NEED_UNWRAP) ||&lt;br/&gt;
+                    (ignoreHandshakeStatus &amp;amp;&amp;amp; netReadBuffer.position() != position);&lt;br/&gt;
             log.trace(&quot;SSLHandshake handshakeUnwrap: handshakeStatus {} status {}&quot;, handshakeStatus, result.getStatus());&lt;br/&gt;
         } while (netReadBuffer.position() != 0 &amp;amp;&amp;amp; cont);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;@@ -828,8 +833,17 @@ private void handshakeFailure(SSLException sslException, boolean flush) throws I&lt;/p&gt;

&lt;p&gt;         state = State.HANDSHAKE_FAILED;&lt;br/&gt;
         handshakeException = new SslAuthenticationException(&quot;SSL handshake failed&quot;, sslException);&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (!flush || flush(netWriteBuffer))&lt;br/&gt;
+&lt;br/&gt;
+        // Attempt to flush any outgoing bytes. If flush doesn&apos;t complete, delay exception handling until outgoing bytes&lt;br/&gt;
+        // are flushed. If write fails because remote end has closed the channel, log the I/O exception and  continue to&lt;br/&gt;
+        // handle the handshake failure as an authentication exception.&lt;br/&gt;
+        try 
{
+            if (!flush || flush(netWriteBuffer))
+                throw handshakeException;
+        }
&lt;p&gt; catch (IOException e) &lt;/p&gt;
{
+            log.debug(&quot;Failed to flush all bytes before closing channel&quot;, e);
             throw handshakeException;
+        }
&lt;p&gt;     }&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     // SSL handshake failures are typically thrown as SSLHandshakeException, SSLProtocolException,&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13231561">KAFKA-8322</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 4 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3z6bz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>ijuma</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>