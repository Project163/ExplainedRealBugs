<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:37:29 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-16003] The znode /config/topics is not updated during KRaft migration in &quot;dual-write&quot; mode</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-16003</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;I tried the following scenario ...&lt;/p&gt;

&lt;p&gt;I have a ZooKeeper-based cluster and create a my-topic-1 topic (without specifying any specific configuration for it). The correct znodes are created under /config/topics and /brokers/topics.&lt;/p&gt;

&lt;p&gt;I start a migration to KRaft but not moving forward from &quot;dual write&quot; mode. While in this mode, I create a new my-topic-2 topic (still without any specific config). I see that a new znode is created under /brokers/topics but NOT under /config/topics. It seems that the KRaft controller is not updating this information in ZooKeeper during the dual-write. The controller log shows that the write to ZooKeeper was done, but not everything I would say:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2023-12-13 10:23:26,229 TRACE [KRaftMigrationDriver id=3] Create Topic my-topic-2, ID Macbp8BvQUKpzmq2vG_8dA. Transitioned migration state from ZkMigrationLeadershipState{kraftControllerId=3, kraftControllerEpoch=7, kraftMetadataOffset=445, kraftMetadataEpoch=7, lastUpdatedTimeMs=1702462785587, migrationZkVersion=236, controllerZkEpoch=3, controllerZkVersion=3} to ZkMigrationLeadershipState{kraftControllerId=3, kraftControllerEpoch=7, kraftMetadataOffset=445, kraftMetadataEpoch=7, lastUpdatedTimeMs=1702462785587, migrationZkVersion=237, controllerZkEpoch=3, controllerZkVersion=3} (org.apache.kafka.metadata.migration.KRaftMigrationDriver) [controller-3-migration-driver-event-handler]
2023-12-13 10:23:26,229 DEBUG [KRaftMigrationDriver id=3] Made the following ZK writes when handling KRaft delta: {CreateTopic=1} (org.apache.kafka.metadata.migration.KRaftMigrationDriver) [controller-3-migration-driver-event-handler] &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13561663">KAFKA-16003</key>
            <summary>The znode /config/topics is not updated during KRaft migration in &quot;dual-write&quot; mode</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mimaison">Mickael Maison</assignee>
                                    <reporter username="ppatierno">Paolo Patierno</reporter>
                        <labels>
                    </labels>
                <created>Wed, 13 Dec 2023 10:59:19 +0000</created>
                <updated>Wed, 17 Apr 2024 17:59:47 +0000</updated>
                            <resolved>Thu, 25 Jan 2024 14:46:53 +0000</resolved>
                                    <version>3.6.1</version>
                                    <fixVersion>3.7.1</fixVersion>
                    <fixVersion>3.8.0</fixVersion>
                                    <component>controller</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17796445" author="davidarthur" created="Wed, 13 Dec 2023 20:11:33 +0000"  >&lt;p&gt;Thanks for the report &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ppatierno&quot; class=&quot;user-hover&quot; rel=&quot;ppatierno&quot;&gt;ppatierno&lt;/a&gt;. Does this cause any particular problems on the ZK broker? &lt;/p&gt;

&lt;p&gt;Also, if you create the topic in KRaft with some configs, do you see the &quot;/config/topics&quot; ZNode get created?&lt;/p&gt;</comment>
                            <comment id="17796646" author="ppatierno" created="Thu, 14 Dec 2023 09:59:52 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davidarthur&quot; class=&quot;user-hover&quot; rel=&quot;davidarthur&quot;&gt;davidarthur&lt;/a&gt; I did the following additional try ...&lt;/p&gt;

&lt;p&gt;I decided to have the broker with auto.create.topics.enable=false.&lt;/p&gt;

&lt;p&gt;Then when in dual-write mode, I created a my-topic-no-config (so without providing any further configuration) and a my-topic-config (providing further configuration, i.e. --config delete.retention.ms=10000). The result is that the topic with further configuration appears in the /config/topics znode. Both topics appear in the /brokers/topics.&lt;/p&gt;

&lt;p&gt;The thing is that, when you rollback to ZooKeeper and you start a kafka console producer, for example, it works fine for the my-topic-config topic (which was created in KRaft dual-write with further configuration and lives in both /config/topics and /brokers/topics znodes) but it doesn&apos;t work with the my-topic-no-config (which was created with no further configuration so doesn&apos;t appear in the /config/topics). The producer raises the usual error &quot;&lt;span class=&quot;error&quot;&gt;&amp;#91;2023-12-14 10:49:03,811&amp;#93;&lt;/span&gt; WARN &lt;span class=&quot;error&quot;&gt;&amp;#91;Producer clientId=console-producer&amp;#93;&lt;/span&gt; Error while fetching metadata with correlation id 6 : {my-topic-1=UNKNOWN_TOPIC_OR_PARTITION} (org.apache.kafka.clients.NetworkClient)&quot; as the topic doesn&apos;t exist at all (and of course cannot be created automatically). So I think this scenario &quot;brakes&quot; somehow the cluster.&lt;/p&gt;</comment>
                            <comment id="17796650" author="ppatierno" created="Thu, 14 Dec 2023 10:02:01 +0000"  >&lt;p&gt;Just adding that if in this scenario you try to create the my-topic-no-config, the console tool raises the error:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Error &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; executing topic command : Topic &lt;span class=&quot;code-quote&quot;&gt;&apos;my-topic-no-config&apos;&lt;/span&gt; already exists.
[2023-12-14 11:00:29,229] ERROR org.apache.kafka.common.errors.TopicExistsException: Topic &lt;span class=&quot;code-quote&quot;&gt;&apos;my-topic-no-config&apos;&lt;/span&gt; already exists.
&#160;(kafka.admin.TopicCommand$) &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;So it seems that after rolling back you cannot ... use that topic because doesn&apos;t exist for the broker using producer API ... you cannot create that topic because it exists when using admin API ... or?&lt;/p&gt;</comment>
                            <comment id="17796778" author="ppatierno" created="Thu, 14 Dec 2023 14:38:35 +0000"  >&lt;p&gt;I ran the tests again by using producer and consumer with topics after the rollback and it seems I am able to use them. Not sure what I did differently before when it was not working.&lt;/p&gt;

&lt;p&gt;So in the end, the /config/topics is anyway not mirrored when in dual-write if a topic was created with no configuration. The topic usage seems not having an impact when rollback is done. Anyway, I think that it creates inconsistency because rolling back to ZooKeeper, you should have everything the ZooKeeper way so the topic should be shown in /config/topics even if created with no configuration imho.&lt;/p&gt;</comment>
                            <comment id="17796888" author="davidarthur" created="Thu, 14 Dec 2023 19:49:51 +0000"  >&lt;p&gt;I agree that the dual-write code should mimic the ZK controller exactly. I&apos;ll fix the missing ZNode issue. However, I&apos;m not sure the lack of &quot;/config/topics/my-topic-no-config&quot; explains the behavior you&apos;re seeing. Looking through the code, all the times we read from /config/topics/&amp;lt;topic&amp;gt; there is handling for NONODE which returns an empty map.&lt;/p&gt;

&lt;p&gt;Can you give me precise reproduction steps? Including broker configs and what commands you ran?&lt;/p&gt;

&lt;p&gt;Edit: just saw your latest comment. Can you confirm that there is no issue after rolling back to ZK mode?&lt;/p&gt;</comment>
                            <comment id="17797043" author="ppatierno" created="Fri, 15 Dec 2023 06:15:40 +0000"  >&lt;p&gt;The are no issues in the sense that topics are still usable by producer and consumer after the rollback. Anyway the /config/topics/my-topic-no-config is still missing. Thanks for look into this even if AFAICS, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mimaison&quot; class=&quot;user-hover&quot; rel=&quot;mimaison&quot;&gt;mimaison&lt;/a&gt;&#160; already assigned it to him.&lt;/p&gt;</comment>
                            <comment id="17797215" author="davidarthur" created="Fri, 15 Dec 2023 14:54:48 +0000"  >&lt;p&gt;Ah, great! Thanks again for the report &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ppatierno&quot; class=&quot;user-hover&quot; rel=&quot;ppatierno&quot;&gt;ppatierno&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mimaison&quot; class=&quot;user-hover&quot; rel=&quot;mimaison&quot;&gt;mimaison&lt;/a&gt; thanks for picking this one up. I did look into it briefly yesterday and I think the simplest thing is to create the znode in in ZkTopicMigrationClient#createTopic when we create the main topic ZNode. The topic configs (if any) will later get written by ZkConfigMigrationClient. &lt;/p&gt;</comment>
                            <comment id="17797249" author="mimaison" created="Fri, 15 Dec 2023 16:44:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davidarthur&quot; class=&quot;user-hover&quot; rel=&quot;davidarthur&quot;&gt;davidarthur&lt;/a&gt; Yes this is what I had in mind. I should have a PR ready later on today.&lt;/p&gt;</comment>
                            <comment id="17797957" author="mimaison" created="Sun, 17 Dec 2023 18:50:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davidarthur&quot; class=&quot;user-hover&quot; rel=&quot;davidarthur&quot;&gt;davidarthur&lt;/a&gt; I think we should include this in 3.7 as it&apos;s possible it will be the last 3.X release and the expectation is that in dual mode, ZooKeeper behaves exactly like before.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 47 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1m8co:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>