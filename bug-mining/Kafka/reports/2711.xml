<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:24:39 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-10123] Regression resetting offsets in consumer when fetching from old broker</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-10123</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;We saw this error in system tests:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.NullPointerException
        at org.apache.kafka.clients.consumer.internals.Fetcher.prepareFetchRequests(Fetcher.java:1111)
        at org.apache.kafka.clients.consumer.internals.Fetcher.sendFetches(Fetcher.java:246)
        at org.apache.kafka.clients.consumer.KafkaConsumer.pollForFetches(KafkaConsumer.java:1296)
        at org.apache.kafka.clients.consumer.KafkaConsumer.poll(KafkaConsumer.java:1248)
        at org.apache.kafka.clients.consumer.KafkaConsumer.poll(KafkaConsumer.java:1216)
        at kafka.tools.ConsoleConsumer$ConsumerWrapper.receive(ConsoleConsumer.scala:437)
        at kafka.tools.ConsoleConsumer$.process(ConsoleConsumer.scala:103)
        at kafka.tools.ConsoleConsumer$.run(ConsoleConsumer.scala:77)
        at kafka.tools.ConsoleConsumer$.main(ConsoleConsumer.scala:54)
        at kafka.tools.ConsoleConsumer.main(ConsoleConsumer.scala)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The logs showed that the consumer was in the middle of an offset reset when this happened. We changed the validation logic in &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-9724&quot; title=&quot;Consumer wrongly ignores fetched records &amp;quot;since it no longer has valid position&amp;quot;&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-9724&quot;&gt;&lt;del&gt;KAFKA-9724&lt;/del&gt;&lt;/a&gt; to include the following check with the intent of skipping validation for old brokers:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
            NodeApiVersions nodeApiVersions = apiVersions.get(leaderAndEpoch.leader.get().idString());
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (nodeApiVersions == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; || hasUsableOffsetForLeaderEpochVersion(nodeApiVersions)) {
                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; assignedState(tp).maybeValidatePosition(leaderAndEpoch);
            } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
                &lt;span class=&quot;code-comment&quot;&gt;// If the broker does not support a newer version of OffsetsForLeaderEpoch, we skip validation
&lt;/span&gt;                completeValidation(tp);
                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
            }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The problem seems to be the shortcut call to `completeValidation`, which executes the following logic:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (hasPosition()) {
                transitionState(FetchStates.FETCHING, () -&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.nextRetryTimeMs = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
            }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We should be protected by the call to `hasPosition` here, but in the case of the `AWAIT_RESET` state, we are incorrectly returning true. This causes us to enter the `FETCHING` state without a position, which ultimately leads to the NPE.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13310292">KAFKA-10123</key>
            <summary>Regression resetting offsets in consumer when fetching from old broker</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mumrah">David Arthur</assignee>
                                    <reporter username="hachikuji">Jason Gustafson</reporter>
                        <labels>
                    </labels>
                <created>Tue, 9 Jun 2020 05:33:36 +0000</created>
                <updated>Thu, 18 Jun 2020 05:33:45 +0000</updated>
                            <resolved>Thu, 18 Jun 2020 05:33:45 +0000</resolved>
                                                    <fixVersion>2.5.1</fixVersion>
                    <fixVersion>2.6.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="17129791" author="vvcephei" created="Tue, 9 Jun 2020 20:51:35 +0000"  >&lt;p&gt;I&apos;ve just also added this as a blocker for 2.5.1, because the commit for &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-9724&quot; title=&quot;Consumer wrongly ignores fetched records &amp;quot;since it no longer has valid position&amp;quot;&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-9724&quot;&gt;&lt;del&gt;KAFKA-9724&lt;/del&gt;&lt;/a&gt; is also included in 2.5.1, which alone is enough reason to include the fix in 2.5.1.&lt;/p&gt;

&lt;p&gt;We also think it might have been the root cause of the Streams EOS soak cluster losing all its threads over the course of a week.&lt;/p&gt;

&lt;p&gt;I&apos;m including this information in case it helps...&lt;/p&gt;

&lt;p&gt;Here&apos;s the stack trace:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[2020-06-03 02:19:01,503] ERROR [stream-soak-test-d8d40c42-1175-4611-994a-ff3fde11cef2-StreamThread-1] stream-thread [stream-soak-test-d8d40c42-1175-4611-994a-ff3fde11cef2-StreamThread-1] Error caught during partition revocation, will abort the current process and re-&lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; at the end of rebalance:  (org.apache.kafka.streams.processor.internals.StreamThread)

org.apache.kafka.streams.errors.StreamsException: stream-thread [stream-soak-test-d8d40c42-1175-4611-994a-ff3fde11cef2-StreamThread-1] failed to suspend stream tasks
        at org.apache.kafka.streams.processor.internals.TaskManager.suspendActiveTasksAndState(TaskManager.java:253)
        at org.apache.kafka.streams.processor.internals.StreamsRebalanceListener.onPartitionsRevoked(StreamsRebalanceListener.java:116)
        at org.apache.kafka.clients.consumer.internals.ConsumerCoordinator.invokePartitionsRevoked(ConsumerCoordinator.java:297)
        at org.apache.kafka.clients.consumer.internals.ConsumerCoordinator.onJoinComplete(ConsumerCoordinator.java:393)
        at org.apache.kafka.clients.consumer.internals.AbstractCoordinator.joinGroupIfNeeded(AbstractCoordinator.java:439)
        at org.apache.kafka.clients.consumer.internals.AbstractCoordinator.ensureActiveGroup(AbstractCoordinator.java:358)
        at org.apache.kafka.clients.consumer.internals.ConsumerCoordinator.poll(ConsumerCoordinator.java:490)
        at org.apache.kafka.clients.consumer.KafkaConsumer.updateAssignmentMetadataIfNeeded(KafkaConsumer.java:1275)
        at org.apache.kafka.clients.consumer.KafkaConsumer.poll(KafkaConsumer.java:1241)
        at org.apache.kafka.clients.consumer.KafkaConsumer.poll(KafkaConsumer.java:1216)
        at org.apache.kafka.streams.processor.internals.StreamThread.pollRequests(StreamThread.java:853)
        at org.apache.kafka.streams.processor.internals.StreamThread.runOnce(StreamThread.java:745)
        at org.apache.kafka.streams.processor.internals.StreamThread.runLoop(StreamThread.java:697)
        at org.apache.kafka.streams.processor.internals.StreamThread.run(StreamThread.java:670)
Caused by: org.apache.kafka.streams.errors.StreamsException: org.apache.kafka.clients.consumer.NoOffsetForPartitionException: Undefined offset with no reset policy &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partitions: [logs.json.zookeeper-0, logs.&lt;span class=&quot;code-keyword&quot;&gt;operator&lt;/span&gt;-0, logs.kubernetes-0, logs.json.kafka-0]
        at org.apache.kafka.streams.processor.internals.StreamTask.commit(StreamTask.java:512)
        at org.apache.kafka.streams.processor.internals.StreamTask.suspend(StreamTask.java:632)
        at org.apache.kafka.streams.processor.internals.StreamTask.suspend(StreamTask.java:601)
        at org.apache.kafka.streams.processor.internals.AssignedStreamsTasks.suspendRunningTasks(AssignedStreamsTasks.java:146)
        at org.apache.kafka.streams.processor.internals.AssignedStreamsTasks.suspendOrCloseTasks(AssignedStreamsTasks.java:129)
        at org.apache.kafka.streams.processor.internals.TaskManager.suspendActiveTasksAndState(TaskManager.java:246)
        ... 13 more
Caused by: org.apache.kafka.clients.consumer.NoOffsetForPartitionException: Undefined offset with no reset policy &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partitions: [logs.json.zookeeper-0, logs.&lt;span class=&quot;code-keyword&quot;&gt;operator&lt;/span&gt;-0, logs.kubernetes-0, logs.json.kafka-0]
        at org.apache.kafka.clients.consumer.internals.SubscriptionState.resetMissingPositions(SubscriptionState.java:658)
        at org.apache.kafka.clients.consumer.KafkaConsumer.updateFetchPositions(KafkaConsumer.java:2392)
        at org.apache.kafka.clients.consumer.KafkaConsumer.position(KafkaConsumer.java:1764)
        at org.apache.kafka.clients.consumer.KafkaConsumer.position(KafkaConsumer.java:1723)
        at org.apache.kafka.streams.processor.internals.StreamTask.commit(StreamTask.java:503)
        ... 18 more&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Not the same error, but it seems related-ish.&lt;/p&gt;

&lt;p&gt;Note:&lt;/p&gt;

&lt;p&gt;Streams/Client version and commit: 2.5.x &lt;font color=&quot;#e01e5a&quot;&gt;5842d2f3&lt;/font&gt;&lt;/p&gt;

&lt;p&gt;Broker version and commit: kafka_2.12-2.5.x bad93b775&lt;/p&gt;

&lt;p&gt;(the previous soak test with the clients on commit &lt;font color=&quot;#e01e5a&quot;&gt;b59f880f&lt;/font&gt; did not have this error)&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13310165">KAFKA-10119</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 22 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0fnk8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>