<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:40:51 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-1382] Update zkVersion on partition state update failures</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-1382</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Our updateIsr code is currently:&lt;/p&gt;

&lt;p&gt;  private def updateIsr(newIsr: Set&lt;span class=&quot;error&quot;&gt;&amp;#91;Replica&amp;#93;&lt;/span&gt;) {&lt;br/&gt;
    debug(&quot;Updated ISR for partition &lt;span class=&quot;error&quot;&gt;&amp;#91;%s,%d&amp;#93;&lt;/span&gt; to %s&quot;.format(topic, partitionId, newIsr.mkString(&quot;,&quot;)))&lt;br/&gt;
    val newLeaderAndIsr = new LeaderAndIsr(localBrokerId, leaderEpoch, newIsr.map(r =&amp;gt; r.brokerId).toList, zkVersion)&lt;br/&gt;
    // use the epoch of the controller that made the leadership decision, instead of the current controller epoch&lt;br/&gt;
    val (updateSucceeded, newVersion) = ZkUtils.conditionalUpdatePersistentPath(zkClient,&lt;br/&gt;
      ZkUtils.getTopicPartitionLeaderAndIsrPath(topic, partitionId),&lt;br/&gt;
      ZkUtils.leaderAndIsrZkData(newLeaderAndIsr, controllerEpoch), zkVersion)&lt;br/&gt;
    if (updateSucceeded)&lt;/p&gt;
{
      inSyncReplicas = newIsr
      zkVersion = newVersion
      trace(&quot;ISR updated to [%s] and zkVersion updated to [%d]&quot;.format(newIsr.mkString(&quot;,&quot;), zkVersion))
    }
&lt;p&gt; else &lt;/p&gt;
{
      info(&quot;Cached zkVersion [%d] not equal to that in zookeeper, skip updating ISR&quot;.format(zkVersion))
    }

&lt;p&gt;We encountered an interesting scenario recently when a large producer fully&lt;br/&gt;
saturated the broker&apos;s NIC for over an hour. The large volume of data led to&lt;br/&gt;
a number of ISR shrinks (and subsequent expands). The NIC saturation&lt;br/&gt;
affected the zookeeper client heartbeats and led to a session timeout. The&lt;br/&gt;
timeline was roughly as follows:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Attempt to expand ISR&lt;/li&gt;
	&lt;li&gt;Expansion written to zookeeper (confirmed in zookeeper transaction logs)&lt;/li&gt;
	&lt;li&gt;Session timeout after around 13 seconds (the configured timeout is 20&lt;br/&gt;
  seconds) so that lines up.&lt;/li&gt;
	&lt;li&gt;zkclient reconnects to zookeeper (with the same session ID) and retries&lt;br/&gt;
  the write - but uses the old zkVersion. This fails because the zkVersion&lt;br/&gt;
  has already been updated (above).&lt;/li&gt;
	&lt;li&gt;The ISR expand keeps failing after that and the only way to get out of it&lt;br/&gt;
  is to bounce the broker.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;In the above code, if the zkVersion is different we should probably update&lt;br/&gt;
the cached version and even retry the expansion until it succeeds.&lt;/p&gt;
</description>
                <environment></environment>
        <key id="12707613">KAFKA-1382</key>
            <summary>Update zkVersion on partition state update failures</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sriharsha">Harsha</assignee>
                                    <reporter username="jjkoshy">Joel Jacob Koshy</reporter>
                        <labels>
                    </labels>
                <created>Thu, 10 Apr 2014 01:00:37 +0000</created>
                <updated>Wed, 27 Apr 2016 23:25:52 +0000</updated>
                            <resolved>Tue, 10 Jun 2014 21:56:46 +0000</resolved>
                                                    <fixVersion>0.8.1.2</fixVersion>
                    <fixVersion>0.8.2.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>16</watches>
                                                                                                                <comments>
                            <comment id="13965027" author="guozhang" created="Thu, 10 Apr 2014 05:47:01 +0000"  >&lt;p&gt;When the session timeout happens, would the controller&apos;s session timeout listener be fired? If yes, would we just increment the zkVersion in the callback function?&lt;/p&gt;</comment>
                            <comment id="13965431" author="junrao" created="Thu, 10 Apr 2014 15:15:37 +0000"  >&lt;p&gt;It sounds like we get a ZK connectionLossException, instead of a session expiration. If it&apos;s the latter, the session ID would be different. ConnectionLossException is handled in zkclient by simply retrying the operation. This doesn&apos;t quite work for conditional updates since if the previous operation succeeded, the underlying ZK version would have changed. We can&apos;t just blindly update the cached zkVersion either since the zkVersion could be different because the controller has changed the zk path at the same time, which takes precedence.&lt;/p&gt;

&lt;p&gt;Not sure what&apos;s the best way to fix this. One way is to add some metadata in the zk value to indicate the id of the writer. Then, we can use that information to verify if the last (potential conflicting) update is made by the caller itself or not. We will have to add such metadata in a backward compatible way.&lt;/p&gt;</comment>
                            <comment id="13965445" author="guozhang" created="Thu, 10 Apr 2014 15:26:33 +0000"  >&lt;p&gt;Could we patch controller such that when such an ISR write has failed, read the stored value, and if it is the same as the value trying to write, let it pass just like the broker registration function?&lt;/p&gt;</comment>
                            <comment id="13965456" author="junrao" created="Thu, 10 Apr 2014 15:34:17 +0000"  >&lt;p&gt;Controller&apos;s update to isr will always succeed. It keeps re-reading the current value in ZK and then does the conditional update. The leader&apos;s update to isr has to fail if the previous update was made by the controller. Checking the value itself will work for most cases, but may not cover 100%. It can happen that the controller updated isr to the same value that the leader wants to write. In this case, we still want to fail the update made by the leader.&lt;/p&gt;</comment>
                            <comment id="13965458" author="guozhang" created="Thu, 10 Apr 2014 15:36:54 +0000"  >&lt;p&gt;Yeah I meant to say &quot;broker&quot; in the last comment.&lt;/p&gt;

&lt;p&gt;Why in this corner case we still want to fail the update instead of just letting it pass?&lt;/p&gt;</comment>
                            <comment id="13965567" author="junrao" created="Thu, 10 Apr 2014 17:25:19 +0000"  >&lt;p&gt;Basically once a controller has updated isr, the leader can&apos;t touch it until it has received the latest info from the controller. Say a leader had a zk version conflict when updating isr and it sees the latest value (written by the controller) is the same as the value it&apos;s trying the write, and we allow it. What could happen is that the leader could successfully shrink the isr again before the controller&apos;s decision is propagated to all brokers. Once the leader shrinks the isr, it can commit new messages, which may not be in the new leader that the controller selected. We have lost committed data at this point.&lt;/p&gt;</comment>
                            <comment id="13965706" author="jjkoshy" created="Thu, 10 Apr 2014 19:08:42 +0000"  >&lt;p&gt;We do have the leader epoch maintained for each partition - so we won&apos;t blindly update the zkVersion but only update it if the leaderEpoch stored in zookeeper is what we currently know.&lt;/p&gt;</comment>
                            <comment id="13966743" author="junrao" created="Fri, 11 Apr 2014 16:36:48 +0000"  >&lt;p&gt;Joel,&lt;/p&gt;

&lt;p&gt;Yes, that&apos;s a good point. When the leader tries to update the isr and sees a zk version conflict, we could read the data back and make sure the content is the same, including the leader epoch. If so, we can assume the previous update actually succeeded. This should be easy to patch.&lt;/p&gt;</comment>
                            <comment id="13984416" author="jblackburn" created="Tue, 29 Apr 2014 15:37:57 +0000"  >&lt;p&gt;The other thing about this is that it can quickly churn through log.  There are log lines every few milliseconds at INFO level leading to  GBs of log in a very short time, e.g.:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;[2014-04-28 00:01:37,010] INFO Partition [RSF_OPTIONS,10] on broker 1: Cached zkVersion [21] not equal to that in zookeeper, ski
p updating ISR (kafka.cluster.Partition)
[2014-04-28 00:01:37,017] INFO Partition [RSF_OPTIONS,10] on broker 1: Expanding ISR &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition [RSF_OPTIONS,10] from 1 to 1,
0 (kafka.cluster.Partition)
[2014-04-28 00:01:37,019] ERROR Conditional update of path /brokers/topics/RSF_OPTIONS/partitions/10/state with data {&quot;controlle
r_epoch&lt;span class=&quot;code-quote&quot;&gt;&quot;:19,&quot;&lt;/span&gt;leader&lt;span class=&quot;code-quote&quot;&gt;&quot;:1,&quot;&lt;/span&gt;version&lt;span class=&quot;code-quote&quot;&gt;&quot;:1,&quot;&lt;/span&gt;leader_epoch&lt;span class=&quot;code-quote&quot;&gt;&quot;:6,&quot;&lt;/span&gt;isr&quot;:[1,0]} and expected version 21 failed due to org.apache.zookeeper.Keep
erException$BadVersionException: KeeperErrorCode = BadVersion &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; /brokers/topics/RSF_OPTIONS/partitions/10/state (kafka.utils.Z
kUtils$)
[2014-04-28 00:01:37,019] INFO Partition [RSF_OPTIONS,10] on broker 1: Cached zkVersion [21] not equal to that in zookeeper, ski
p updating ISR (kafka.cluster.Partition)
[2014-04-28 00:01:37,019] INFO Partition [RSF,14] on broker 1: Expanding ISR &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition [RSF,14] from 1 to 1,0 (kafka.cluster
.Partition)
[2014-04-28 00:01:37,020] ERROR Conditional update of path /brokers/topics/RSF/partitions/14/state with data {&lt;span class=&quot;code-quote&quot;&gt;&quot;controller_epoch&quot;&lt;/span&gt;
:19,&lt;span class=&quot;code-quote&quot;&gt;&quot;leader&quot;&lt;/span&gt;:1,&lt;span class=&quot;code-quote&quot;&gt;&quot;version&quot;&lt;/span&gt;:1,&lt;span class=&quot;code-quote&quot;&gt;&quot;leader_epoch&quot;&lt;/span&gt;:6,&lt;span class=&quot;code-quote&quot;&gt;&quot;isr&quot;&lt;/span&gt;:[1,0]} and expected version 21 failed due to org.apache.zookeeper.KeeperExcept
ion$BadVersionException: KeeperErrorCode = BadVersion &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; /brokers/topics/RSF/partitions/14/state (kafka.utils.ZkUtils$)
[2014-04-28 00:01:37,020] INFO Partition [RSF,14] on broker 1: Cached zkVersion [21] not equal to that in zookeeper, skip updati
ng ISR (kafka.cluster.Partition)
[2014-04-28 00:01:37,035] INFO Partition [RSF_OPTIONS,10] on broker 1: Expanding ISR &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition [RSF_OPTIONS,10] from 1 to 1,
0 (kafka.cluster.Partition)
[2014-04-28 00:01:37,037] ERROR Conditional update of path /brokers/topics/RSF_OPTIONS/partitions/10/state with data {&quot;controlle
r_epoch&lt;span class=&quot;code-quote&quot;&gt;&quot;:19,&quot;&lt;/span&gt;leader&lt;span class=&quot;code-quote&quot;&gt;&quot;:1,&quot;&lt;/span&gt;version&lt;span class=&quot;code-quote&quot;&gt;&quot;:1,&quot;&lt;/span&gt;leader_epoch&lt;span class=&quot;code-quote&quot;&gt;&quot;:6,&quot;&lt;/span&gt;isr&quot;:[1,0]} and expected version 21 failed due to org.apache.zookeeper.Keep
erException$BadVersionException: KeeperErrorCode = BadVersion &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; /brokers/topics/RSF_OPTIONS/partitions/10/state (kafka.utils.Z
kUtils$)
[2014-04-28 00:01:37,037] INFO Partition [RSF_OPTIONS,10] on broker 1: Cached zkVersion [21] not equal to that in zookeeper, ski
p updating ISR (kafka.cluster.Partition)
[2014-04-28 00:01:37,037] INFO Partition [RSF,14] on broker 1: Expanding ISR &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition [RSF,14] from 1 to 1,0 (kafka.cluster
.Partition)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14008575" author="sriharsha" created="Mon, 26 May 2014 05:08:19 +0000"  >&lt;p&gt;Created reviewboard &lt;a href=&quot;https://reviews.apache.org/r/21899/diff/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/21899/diff/&lt;/a&gt;&lt;br/&gt;
 against branch origin/trunk&lt;/p&gt;</comment>
                            <comment id="14014511" author="sriharsha" created="Sat, 31 May 2014 04:19:30 +0000"  >&lt;p&gt;Updated reviewboard &lt;a href=&quot;https://reviews.apache.org/r/21899/diff/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/21899/diff/&lt;/a&gt;&lt;br/&gt;
 against branch origin/trunk&lt;/p&gt;</comment>
                            <comment id="14014854" author="sriharsha" created="Sat, 31 May 2014 22:50:42 +0000"  >&lt;p&gt;Updated reviewboard &lt;a href=&quot;https://reviews.apache.org/r/21899/diff/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/21899/diff/&lt;/a&gt;&lt;br/&gt;
 against branch origin/trunk&lt;/p&gt;</comment>
                            <comment id="14018059" author="sriharsha" created="Wed, 4 Jun 2014 19:30:50 +0000"  >&lt;p&gt;Updated reviewboard &lt;a href=&quot;https://reviews.apache.org/r/21899/diff/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/21899/diff/&lt;/a&gt;&lt;br/&gt;
 against branch origin/trunk&lt;/p&gt;</comment>
                            <comment id="14020857" author="sriharsha" created="Sat, 7 Jun 2014 16:01:10 +0000"  >&lt;p&gt;Updated reviewboard &lt;a href=&quot;https://reviews.apache.org/r/21899/diff/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/21899/diff/&lt;/a&gt;&lt;br/&gt;
 against branch origin/trunk&lt;/p&gt;</comment>
                            <comment id="14026007" author="sriharsha" created="Tue, 10 Jun 2014 01:23:51 +0000"  >&lt;p&gt;Updated reviewboard &lt;a href=&quot;https://reviews.apache.org/r/21899/diff/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/21899/diff/&lt;/a&gt;&lt;br/&gt;
 against branch origin/trunk&lt;/p&gt;</comment>
                            <comment id="14027095" author="nehanarkhede" created="Tue, 10 Jun 2014 21:56:46 +0000"  >&lt;p&gt;Thanks for the patches, pushed to trunk.&lt;/p&gt;</comment>
                            <comment id="14027099" author="nehanarkhede" created="Tue, 10 Jun 2014 21:59:23 +0000"  >&lt;p&gt;Oops, I&apos;m sorry, I didn&apos;t see Jun&apos;s latest comments before committing. I guess we need a follow up patch with Jun&apos;s suggestions addressed.&lt;/p&gt;</comment>
                            <comment id="14027110" author="sriharsha" created="Tue, 10 Jun 2014 22:06:52 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nehanarkhede&quot; class=&quot;user-hover&quot; rel=&quot;nehanarkhede&quot;&gt;nehanarkhede&lt;/a&gt; I am working on patch based on Jun&apos;s comments. Will send updated patch.&lt;/p&gt;</comment>
                            <comment id="14027984" author="sriharsha" created="Wed, 11 Jun 2014 16:37:38 +0000"  >&lt;p&gt;Updated reviewboard &lt;a href=&quot;https://reviews.apache.org/r/21899/diff/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/21899/diff/&lt;/a&gt;&lt;br/&gt;
 against branch origin/trunk&lt;/p&gt;</comment>
                            <comment id="14032927" author="sriharsha" created="Mon, 16 Jun 2014 20:50:28 +0000"  >&lt;p&gt;Updated reviewboard &lt;a href=&quot;https://reviews.apache.org/r/21899/diff/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/21899/diff/&lt;/a&gt;&lt;br/&gt;
 against branch origin/trunk&lt;/p&gt;</comment>
                            <comment id="14032963" author="sriharsha" created="Mon, 16 Jun 2014 21:19:34 +0000"  >&lt;p&gt;Updated reviewboard &lt;a href=&quot;https://reviews.apache.org/r/21899/diff/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/21899/diff/&lt;/a&gt;&lt;br/&gt;
 against branch origin/trunk&lt;/p&gt;</comment>
                            <comment id="14036082" author="sriharsha" created="Wed, 18 Jun 2014 18:18:50 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=junrao&quot; class=&quot;user-hover&quot; rel=&quot;junrao&quot;&gt;junrao&lt;/a&gt; Can you please take a look at the latest patch and let me know if it looks good or not.&lt;br/&gt;
Thanks,&lt;br/&gt;
Harsha&lt;/p&gt;</comment>
                            <comment id="14036932" author="nehanarkhede" created="Thu, 19 Jun 2014 04:14:25 +0000"  >&lt;p&gt;Thanks for the follow up patch. Pushed to trunk&lt;/p&gt;</comment>
                            <comment id="14036964" author="junrao" created="Thu, 19 Jun 2014 04:58:35 +0000"  >&lt;p&gt;Thanks for the patch. This looks good to me.&lt;/p&gt;</comment>
                            <comment id="14120028" author="nyetter" created="Wed, 3 Sep 2014 16:20:24 +0000"  >&lt;p&gt;Is it possible to apply this patch to 0.8.1.1?  Or better yet, can we get a 0.8.1.2 release with this patch included?&lt;/p&gt;

&lt;p&gt;We have experienced this bug multiple times in production, causing data loss.  We had been taking the approach of waiting for 0.8.2 and crossing our fingers, but that release no longer has even a target release date on the roadmap.&lt;/p&gt;</comment>
                            <comment id="14131013" author="jhooda" created="Fri, 12 Sep 2014 02:01:18 +0000"  >&lt;p&gt;We are in same fix. Can you please comment if this can be patched safely on 0.8.1.1?&lt;/p&gt;</comment>
                            <comment id="14131033" author="nehanarkhede" created="Fri, 12 Sep 2014 02:31:05 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nyetter&quot; class=&quot;user-hover&quot; rel=&quot;nyetter&quot;&gt;nyetter&lt;/a&gt; There is an ongoing discussion on the mailing list regarding 0.8.1.2. Marking this JIRA to be considered for 0.8.1.2&lt;/p&gt;</comment>
                            <comment id="14133349" author="jhooda" created="Sun, 14 Sep 2014 19:08:52 +0000"  >&lt;p&gt;Not sure if this is related. We applied the final patch on 0.8.1.1 and noticed a null pointer that we haven&apos;t noticed earlier&lt;/p&gt;

&lt;p&gt;---------------------&lt;del&gt;8&amp;lt;&lt;/del&gt;-------------------------------------------------------&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2014-09-13 15:26:36,254&amp;#93;&lt;/span&gt; ERROR Error processing config change: (kafka.server.TopicConfigManager)&lt;br/&gt;
java.lang.NullPointerException&lt;br/&gt;
        at scala.collection.convert.Wrappers$JListWrapper.length(Wrappers.scala:85)&lt;br/&gt;
        at scala.collection.SeqLike$class.size(SeqLike.scala:106)&lt;br/&gt;
        at scala.collection.AbstractSeq.size(Seq.scala:40)&lt;br/&gt;
        at kafka.server.TopicConfigManager.kafka$server$TopicConfigManager$$processConfigChanges(TopicConfigManager.scala:89)&lt;br/&gt;
        at kafka.server.TopicConfigManager$ConfigChangeListener$.handleChildChange(TopicConfigManager.scala:144)&lt;br/&gt;
        at org.I0Itec.zkclient.ZkClient$7.run(ZkClient.java:570)&lt;br/&gt;
        at org.I0Itec.zkclient.ZkEventThread.run(ZkEventThread.java:71)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2014-09-13 15:26:36,273&amp;#93;&lt;/span&gt; INFO New leader is 1 (kafka.server.ZookeeperLeaderElector$LeaderChangeListener)&lt;br/&gt;
---------------------&lt;del&gt;8&amp;lt;&lt;/del&gt;-------------------------------------------------------&lt;/p&gt;

&lt;p&gt;Our configuration is 3 brokers 3 zookeepers and topic replication set to 3.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
jagbir&lt;/p&gt;</comment>
                            <comment id="14133383" author="sriharsha" created="Sun, 14 Sep 2014 21:10:55 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jhooda&quot; class=&quot;user-hover&quot; rel=&quot;jhooda&quot;&gt;jhooda&lt;/a&gt;&lt;br/&gt;
 can you share how did you applied this patch against 0.8.1.1. I tried doing the following 0.8.1 branch&lt;br/&gt;
git apply --check  ../&lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-1382&quot; title=&quot;Update zkVersion on partition state update failures&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-1382&quot;&gt;&lt;del&gt;KAFKA-1382&lt;/del&gt;&lt;/a&gt;_2014-06-16_14:19:27.patch &lt;br/&gt;
I get &lt;br/&gt;
error: patch failed: core/src/main/scala/kafka/cluster/Partition.scala:18&lt;br/&gt;
error: core/src/main/scala/kafka/cluster/Partition.scala: patch does not apply&lt;/p&gt;

&lt;p&gt;I tried it on &lt;a href=&quot;http://kafka.apache.org/downloads.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://kafka.apache.org/downloads.html&lt;/a&gt; kafka-0.8.1.1-src.tgz it doesn&apos;t apply cleanly.&lt;/p&gt;</comment>
                            <comment id="14133446" author="jhooda" created="Sun, 14 Sep 2014 23:43:43 +0000"  >&lt;p&gt;Hi Sriharsha,&lt;/p&gt;

&lt;p&gt;This is what I did&lt;/p&gt;

&lt;p&gt;prompt&amp;gt; git clone &lt;a href=&quot;http://git-wip-us.apache.org/repos/asf/kafka.git&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://git-wip-us.apache.org/repos/asf/kafka.git&lt;/a&gt;&lt;br/&gt;
prompt&amp;gt; git checkout refs/tags/0.8.1.1 -b kafka-1382&lt;br/&gt;
prompt&amp;gt; wget &lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12646741/KAFKA-1382.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12646741/KAFKA-1382.patch&lt;/a&gt;&lt;br/&gt;
prompt&amp;gt; patch -p1 &amp;lt; &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-1382&quot; title=&quot;Update zkVersion on partition state update failures&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-1382&quot;&gt;&lt;del&gt;KAFKA-1382&lt;/del&gt;&lt;/a&gt;.patch&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
Jagbir&lt;/p&gt;</comment>
                            <comment id="14134070" author="sriharsha" created="Mon, 15 Sep 2014 16:23:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jhooda&quot; class=&quot;user-hover&quot; rel=&quot;jhooda&quot;&gt;jhooda&lt;/a&gt;&lt;br/&gt;
Thanks for the info. I tried to reproduce this by running a 3 node cluster with 3 zookeeper.&lt;br/&gt;
Ran simple tests like creating a topic, altering the topic config , producing data into the topic and reading off the topic, shutting down one of the brokers and also kill -9 a broker. None of the above cases produced the error. Could you please provide the logs and also when did this error happened.&lt;/p&gt;</comment>
                            <comment id="14134726" author="jhooda" created="Tue, 16 Sep 2014 00:03:59 +0000"  >&lt;p&gt;Hi Sriharsha,&lt;/p&gt;

&lt;p&gt;Thanks for looking into the issue. We are trying to consistently replicate the behavior and will get back.&lt;/p&gt;

&lt;p&gt;Jagbir&lt;/p&gt;</comment>
                            <comment id="14138191" author="nyetter" created="Wed, 17 Sep 2014 23:22:58 +0000"  >&lt;p&gt;We put a decent amount of effort at replicating this scenario and were unable to.  It has only happened to us in the wild, and never for any apparent reason.&lt;/p&gt;</comment>
                            <comment id="15089248" author="dude9527" created="Fri, 8 Jan 2016 14:16:58 +0000"  >&lt;p&gt;we hit this bug in kafka0.8.2.1, three nodes. zookeeper version is 3.4.6. the log is :&lt;/p&gt;


&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;2016-01-05 08:49:27,047&amp;#93;&lt;/span&gt; INFO Partition &lt;span class=&quot;error&quot;&gt;&amp;#91;error-signatureId-956a8fd7-a3ec-4718-bb77-45b3a97eb0cd,0&amp;#93;&lt;/span&gt; on broker 3: Shrinking ISR for partition [error-signatureId-956a8fd&lt;br/&gt;
7-a3ec-4718-bb77-45b3a97eb0cd,0] from 3,1 to 3 (kafka.cluster.Partition)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2016-01-05 08:49:27,227&amp;#93;&lt;/span&gt; ERROR Uncaught exception in thread &apos;kafka-network-thread-39091-0&apos;: (kafka.utils.Utils$)&lt;br/&gt;
java.util.NoSuchElementException: None.get&lt;br/&gt;
        at scala.None$.get(Option.scala:347)&lt;br/&gt;
        at scala.None$.get(Option.scala:345)&lt;br/&gt;
        at kafka.network.ConnectionQuotas.dec(SocketServer.scala:524)&lt;br/&gt;
        at kafka.network.AbstractServerThread.close(SocketServer.scala:165)&lt;br/&gt;
        at kafka.network.AbstractServerThread.close(SocketServer.scala:157)&lt;br/&gt;
        at kafka.network.Processor.close(SocketServer.scala:374)&lt;br/&gt;
        at kafka.network.Processor.processNewResponses(SocketServer.scala:406)&lt;br/&gt;
        at kafka.network.Processor.run(SocketServer.scala:318)&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:745)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2016-01-05 08:49:27,248&amp;#93;&lt;/span&gt; INFO Reconnect due to socket error: java.io.IOException: connection timeout (kafka.consumer.SimpleConsumer)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2016-01-05 08:49:27,248&amp;#93;&lt;/span&gt; INFO Reconnect due to socket error: java.io.IOException: Connection reset by peer (kafka.consumer.SimpleConsumer)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2016-01-05 08:49:27,278&amp;#93;&lt;/span&gt; ERROR Uncaught exception in thread &apos;kafka-network-thread-39091-1&apos;: (kafka.utils.Utils$)&lt;br/&gt;
java.util.NoSuchElementException: None.get&lt;br/&gt;
        at scala.None$.get(Option.scala:347)&lt;br/&gt;
        at scala.None$.get(Option.scala:345)&lt;br/&gt;
        at kafka.network.ConnectionQuotas.dec(SocketServer.scala:524)&lt;br/&gt;
        at kafka.network.AbstractServerThread.close(SocketServer.scala:165)&lt;br/&gt;
        at kafka.network.AbstractServerThread.close(SocketServer.scala:157)&lt;br/&gt;
        at kafka.network.Processor.close(SocketServer.scala:374)&lt;br/&gt;
        at kafka.network.Processor.processNewResponses(SocketServer.scala:406)&lt;br/&gt;
        at kafka.network.Processor.run(SocketServer.scala:318)&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:745)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2016-01-05 08:49:27,918&amp;#93;&lt;/span&gt; INFO re-registering broker info in ZK for broker 3 (kafka.server.KafkaHealthcheck)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2016-01-05 08:49:36,312&amp;#93;&lt;/span&gt; INFO Registered broker 3 at path /brokers/ids/3 with address AI-iPaaS-ATS03:39091. (kafka.utils.ZkUtils$)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2016-01-05 08:49:36,312&amp;#93;&lt;/span&gt; INFO done re-registering broker (kafka.server.KafkaHealthcheck)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2016-01-05 08:49:36,313&amp;#93;&lt;/span&gt; INFO Subscribing to /brokers/topics path to watch for new topics (kafka.server.KafkaHealthcheck)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2016-01-05 08:49:36,332&amp;#93;&lt;/span&gt; INFO New leader is 1 (kafka.server.ZookeeperLeaderElector$LeaderChangeListener)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2016-01-05 08:49:36,343&amp;#93;&lt;/span&gt; INFO Partition &lt;span class=&quot;error&quot;&gt;&amp;#91;error-signatureId-956a8fd7-a3ec-4718-bb77-45b3a97eb0cd,0&amp;#93;&lt;/span&gt; on broker 3: Cached zkVersion &lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt; not equal to that in zookeeper, s&lt;br/&gt;
kip updating ISR (kafka.cluster.Partition)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2016-01-05 08:49:36,343&amp;#93;&lt;/span&gt; INFO Partition &lt;span class=&quot;error&quot;&gt;&amp;#91;error-signatureId-e8c1c145-4109-48d8-a46f-4eca92143594,0&amp;#93;&lt;/span&gt; on broker 3: Shrinking ISR for partition [error-signatureId-e8c1c14&lt;br/&gt;
5-4109-48d8-a46f-4eca92143594,0] from 3,2 to 3 (kafka.cluster.Partition)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2016-01-05 08:49:36,372&amp;#93;&lt;/span&gt; INFO Partition &lt;span class=&quot;error&quot;&gt;&amp;#91;error-signatureId-e8c1c145-4109-48d8-a46f-4eca92143594,0&amp;#93;&lt;/span&gt; on broker 3: Cached zkVersion &lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt; not equal to that in zookeeper, s&lt;br/&gt;
kip updating ISR (kafka.cluster.Partition)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2016-01-05 08:49:36,373&amp;#93;&lt;/span&gt; INFO Partition &lt;span class=&quot;error&quot;&gt;&amp;#91;error-signatureId-59206ee6-e9b7-470d-9b1d-638e2cc7ebad,0&amp;#93;&lt;/span&gt; on broker 3: Shrinking ISR for partition [error-signatureId-59206ee&lt;br/&gt;
6-e9b7-470d-9b1d-638e2cc7ebad,0] from 3,2 to 3 (kafka.cluster.Partition)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2016-01-05 08:49:36,402&amp;#93;&lt;/span&gt; INFO Partition &lt;span class=&quot;error&quot;&gt;&amp;#91;error-signatureId-59206ee6-e9b7-470d-9b1d-638e2cc7ebad,0&amp;#93;&lt;/span&gt; on broker 3: Cached zkVersion &lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt; not equal to that in zookeeper, s&lt;br/&gt;
kip updating ISR (kafka.cluster.Partition)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2016-01-05 08:49:36,402&amp;#93;&lt;/span&gt; INFO Partition &lt;span class=&quot;error&quot;&gt;&amp;#91;error-signatureId-be6798c3-57d8-4ddc-a155-04983987b160,0&amp;#93;&lt;/span&gt; on broker 3: Shrinking ISR for partition [error-signatureId-be6798c&lt;br/&gt;
3-57d8-4ddc-a155-04983987b160,0] from 3,1 to 3 (kafka.cluster.Partition)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2016-01-05 08:49:36,426&amp;#93;&lt;/span&gt; INFO Partition &lt;span class=&quot;error&quot;&gt;&amp;#91;error-signatureId-be6798c3-57d8-4ddc-a155-04983987b160,0&amp;#93;&lt;/span&gt; on broker 3: Cached zkVersion &lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt; not equal to that in zookeeper, s&lt;br/&gt;
kip updating ISR (kafka.cluster.Partition)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2016-01-05 08:49:36,426&amp;#93;&lt;/span&gt; INFO Partition &lt;span class=&quot;error&quot;&gt;&amp;#91;error-signatureId-38fd31e8-3a0a-4b06-b278-a8f10bab232f,0&amp;#93;&lt;/span&gt; on broker 3: Shrinking ISR for partition [error-signatureId-38fd31e&lt;/p&gt;</comment>
                            <comment id="15158799" author="fpj" created="Tue, 23 Feb 2016 12:38:55 +0000"  >&lt;p&gt;hi there, it isn&apos;t clear to me if you&apos;ve hit this bug or if your broker simply got stale versions. even with the fix proposed here, you can still get conflicting versions, which will lead to those messages. was your cluster able to recover after you&apos;ve seen those messages? what&apos;s the precise behavior you have observed?&lt;/p&gt;</comment>
                            <comment id="15160030" author="dude9527" created="Wed, 24 Feb 2016 01:38:38 +0000"  >&lt;p&gt;we hit this when there is a network problem, which the kakfa broker 3 can not connect to zookeeper.  After the network work normal, the broker can not update the zk and will loop the cached zk version not equal the zookeeper infinitely and the brokercan not recover until restart it.&lt;/p&gt;</comment>
                            <comment id="15261182" author="kanek" created="Wed, 27 Apr 2016 23:25:52 +0000"  >&lt;p&gt;We&apos;ve been hitting this bug too on kafka 0.8.2.1:&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;2016-04-27 23:21:13,310&amp;#93;&lt;/span&gt;  4843558914 &lt;span class=&quot;error&quot;&gt;&amp;#91;kafka-scheduler-4&amp;#93;&lt;/span&gt; INFO  kafka.cluster.Partition  - Partition &lt;span class=&quot;error&quot;&gt;&amp;#91;mp-unknown,220&amp;#93;&lt;/span&gt; on broker 104224875: Shrinking ISR for partition &lt;span class=&quot;error&quot;&gt;&amp;#91;mp-unknown,220&amp;#93;&lt;/span&gt; from 104224875,104224876 to 104224875&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2016-04-27 23:21:13,312&amp;#93;&lt;/span&gt;  4843558916 &lt;span class=&quot;error&quot;&gt;&amp;#91;kafka-scheduler-4&amp;#93;&lt;/span&gt; INFO  kafka.cluster.Partition  - Partition &lt;span class=&quot;error&quot;&gt;&amp;#91;mp-unknown,220&amp;#93;&lt;/span&gt; on broker 104224875: Cached zkVersion &lt;span class=&quot;error&quot;&gt;&amp;#91;5&amp;#93;&lt;/span&gt; not equal to that in zookeeper, skip updating ISR&lt;/p&gt;

&lt;p&gt;Looks like we had some network problems when this happened. Network restored but broker never rejoined ISR set.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12924177">KAFKA-3042</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12646741" name="KAFKA-1382.patch" size="5265" author="sriharsha" created="Mon, 26 May 2014 05:08:19 +0000"/>
                            <attachment id="12647750" name="KAFKA-1382_2014-05-30_21:19:21.patch" size="5386" author="sriharsha" created="Sat, 31 May 2014 04:19:30 +0000"/>
                            <attachment id="12647797" name="KAFKA-1382_2014-05-31_15:50:25.patch" size="35218" author="sriharsha" created="Sat, 31 May 2014 22:50:42 +0000"/>
                            <attachment id="12648374" name="KAFKA-1382_2014-06-04_12:30:40.patch" size="20999" author="sriharsha" created="Wed, 4 Jun 2014 19:30:49 +0000"/>
                            <attachment id="12648820" name="KAFKA-1382_2014-06-07_09:00:56.patch" size="24114" author="sriharsha" created="Sat, 7 Jun 2014 16:01:09 +0000"/>
                            <attachment id="12649503" name="KAFKA-1382_2014-06-09_18:23:42.patch" size="28862" author="sriharsha" created="Tue, 10 Jun 2014 01:23:50 +0000"/>
                            <attachment id="12649821" name="KAFKA-1382_2014-06-11_09:37:22.patch" size="226763" author="sriharsha" created="Wed, 11 Jun 2014 16:37:37 +0000"/>
                            <attachment id="12650644" name="KAFKA-1382_2014-06-16_13:50:16.patch" size="30324" author="sriharsha" created="Mon, 16 Jun 2014 20:50:27 +0000"/>
                            <attachment id="12650654" name="KAFKA-1382_2014-06-16_14:19:27.patch" size="28217" author="sriharsha" created="Mon, 16 Jun 2014 21:19:34 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>385936</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 29 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1uhhr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>386200</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>