<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:25:58 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-10616] StreamThread killed by &quot;IllegalStateException: The processor is already closed&quot;</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-10616</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Application is hitting &quot;java.lang.IllegalStateException: The processor is already closed&quot;. Over the course of about a day, this exception killed 21/100 of the queries (StreamThreads). The (slightly trimmed) stacktrace:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.RuntimeException: Caught an exception &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; closing caching window store &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; store Aggregate-Aggregate-Materialize at org.apache.kafka.streams.state.internals.ExceptionUtils.throwSuppressed(ExceptionUtils.java:39) at org.apache.kafka.streams.state.internals.CachingWindowStore.close(CachingWindowStore.java:432) at org.apache.kafka.streams.processor.internals.ProcessorStateManager.close(ProcessorStateManager.java:527) at org.apache.kafka.streams.processor.internals.StreamTask.closeDirty(StreamTask.java:499) at org.apache.kafka.streams.processor.internals.TaskManager.handleLostAll(TaskManager.java:626) &#8230; Caused by: java.lang.IllegalStateException: The processor is already closed at org.apache.kafka.streams.processor.internals.ProcessorNode.throwIfClosed(ProcessorNode.java:172) at org.apache.kafka.streams.processor.internals.ProcessorNode.process(ProcessorNode.java:178) at org.apache.kafka.streams.processor.internals.ProcessorContextImpl.forwardInternal(ProcessorContextImpl.java:273) at org.apache.kafka.streams.processor.internals.ProcessorContextImpl.forward(ProcessorContextImpl.java:252) at org.apache.kafka.streams.processor.internals.ProcessorContextImpl.forward(ProcessorContextImpl.java:214) at org.apache.kafka.streams.kstream.internals.TimestampedCacheFlushListener.apply(TimestampedCacheFlushListener.java:45) at org.apache.kafka.streams.kstream.internals.TimestampedCacheFlushListener.apply(TimestampedCacheFlushListener.java:28) at org.apache.kafka.streams.state.internals.MeteredWindowStore.lambda$setFlushListener$1(MeteredWindowStore.java:110) at org.apache.kafka.streams.state.internals.CachingWindowStore.putAndMaybeForward(CachingWindowStore.java:118) at org.apache.kafka.streams.state.internals.CachingWindowStore.lambda$initInternal$0(CachingWindowStore.java:93) at org.apache.kafka.streams.state.internals.NamedCache.flush(NamedCache.java:151) at org.apache.kafka.streams.state.internals.NamedCache.flush(NamedCache.java:109) at org.apache.kafka.streams.state.internals.ThreadCache.flush(ThreadCache.java:116) at org.apache.kafka.streams.state.internals.CachingWindowStore.lambda$close$1(CachingWindowStore.java:427) at org.apache.kafka.streams.state.internals.ExceptionUtils.executeAll(ExceptionUtils.java:28) at org.apache.kafka.streams.state.internals.CachingWindowStore.close(CachingWindowStore.java:426)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I&apos;m&#160;guessing we close the topology before closing the state states, so records that get flushed during the caching store&apos;s close() will run into an already-closed processor. During a clean close we should always flush before closing anything (during prepareCommit()), but since this was a handleLostAll() we would just skip right to suspend() and close the topology.&lt;/p&gt;

&lt;p&gt;Presumably the right thing to do here is to flush the caches before closing anything during a dirty close.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13335844">KAFKA-10616</key>
            <summary>StreamThread killed by &quot;IllegalStateException: The processor is already closed&quot;</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="guozhang">Guozhang Wang</assignee>
                                    <reporter username="ableegoldman">A. Sophie Blee-Goldman</reporter>
                        <labels>
                    </labels>
                <created>Sat, 17 Oct 2020 04:55:38 +0000</created>
                <updated>Mon, 26 Oct 2020 22:33:01 +0000</updated>
                            <resolved>Mon, 26 Oct 2020 22:33:01 +0000</resolved>
                                                    <fixVersion>2.7.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17217208" author="sagarrao" created="Tue, 20 Oct 2020 02:09:07 +0000"  >&lt;p&gt;hey &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ableegoldman&quot; class=&quot;user-hover&quot; rel=&quot;ableegoldman&quot;&gt;ableegoldman&lt;/a&gt;, Can I take this one up?&lt;/p&gt;</comment>
                            <comment id="17217258" author="ableegoldman" created="Tue, 20 Oct 2020 04:29:37 +0000"  >&lt;p&gt;I spoke with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt;&#160; earlier and he said he already has a fix for this that he had to implement in some other work when he ran into the same issue. He&apos;s just going to cherrypick it into a new PR for this &#8211; sorry, forgot to assign the ticket to him&#160;&lt;/p&gt;</comment>
                            <comment id="17217261" author="ableegoldman" created="Tue, 20 Oct 2020 04:39:05 +0000"  >&lt;p&gt;By the way, we should actually fix this in 2.6 as well. There&apos;s no IllegalStateException killing the thread in that branch, but the underlying issue is still there: flushing records downstream to closed processors. AFAICT the only effect this has in the DSL operators is that these records would not be recorded in any metrics, but there could be more severe consequences if a PAPI user does something more interesting in the processor&apos;s close() method.&lt;/p&gt;

&lt;p&gt;It&apos;s possible we&apos;ll need a separate PR for the 2.6 branch, depending on what the fix for 2.7/trunk looks like. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sagarrao&quot; class=&quot;user-hover&quot; rel=&quot;sagarrao&quot;&gt;sagarrao&lt;/a&gt;&#160;if we do need a separate PR then feel free to pick it up&lt;/p&gt;</comment>
                            <comment id="17217271" author="sagarrao" created="Tue, 20 Oct 2020 05:08:05 +0000"  >&lt;p&gt;Alright thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ableegoldman&quot; class=&quot;user-hover&quot; rel=&quot;ableegoldman&quot;&gt;ableegoldman&lt;/a&gt;, Let me know if we would need a separate PR for this.. We might need another issue to be create for that?&lt;/p&gt;</comment>
                            <comment id="17217813" author="guozhang" created="Tue, 20 Oct 2020 17:29:48 +0000"  >&lt;p&gt;I think this is a long lurking bug caused by &lt;a href=&quot;https://github.com/apache/kafka/pull/9083&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/9083&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Generally speaking, before we close the topology we should always try to flush the state store manager (we actually do not really need to flush the whole store, but just the cache). I have this fix piggy-backed in my other PR &lt;a href=&quot;https://github.com/apache/kafka/pull/8988&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/8988&lt;/a&gt; but it is dragging very long and every 3-4 days I&apos;d have to rebase it again, so I do not feel that it could be merged soon.&lt;/p&gt;

&lt;p&gt;What I can do is to extract that fix along from the PR and merge it for 2.7 / 2.6.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 3 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0jrsw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>