<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:23:38 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-9823] Consumer should check equality of the generation for coordinator requests</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-9823</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;In consumer&apos;s requests to group coordinator (heartbeat, join-group, sync-group, commit; leave-group is not considered since consumer do not check its responses anyways), we encoded the generation / member information and the response may indicate that the member.id is invalid or generation is stale, which would cause consumer to reset and re-join group.&lt;/p&gt;

&lt;p&gt;However, when the response is sent back it is possible that the consumer has already started re-join due to other channels indicating it out of the group, and hence resetting would introduce unnecessarily more re-joining operations.&lt;/p&gt;

&lt;p&gt;We should, instead, remember the generation information that was sent along with the request and upon getting the response compare that with the current generation information. If they do not match it means the responded error indicating stale information has been updated in other places and hence can be handled differently (for example, in heartbeat handling we can just ignore the error).&lt;/p&gt;</description>
                <environment></environment>
        <key id="13296373">KAFKA-9823</key>
            <summary>Consumer should check equality of the generation for coordinator requests</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="guozhang">Guozhang Wang</assignee>
                                    <reporter username="guozhang">Guozhang Wang</reporter>
                        <labels>
                    </labels>
                <created>Sun, 5 Apr 2020 17:26:20 +0000</created>
                <updated>Tue, 28 Apr 2020 00:10:32 +0000</updated>
                            <resolved>Thu, 23 Apr 2020 19:25:41 +0000</resolved>
                                                    <fixVersion>2.6.0</fixVersion>
                                    <component>consumer</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17077853" author="githubbot" created="Wed, 8 Apr 2020 05:40:00 +0000"  >&lt;p&gt;guozhangwang commented on pull request #8445: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-9823&quot; title=&quot;Consumer should check equality of the generation for coordinator requests&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-9823&quot;&gt;&lt;del&gt;KAFKA-9823&lt;/del&gt;&lt;/a&gt;: Remember the sent generation for the coordinator request&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/8445&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/8445&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   For join / sync / commit / heartbeat request, we would remember the sent generation in the created handler object, and then upon getting the error code, we could check whether the sent generation still matches the current generation. If not, it means that the member has already reset its generation or has participated in a new rebalance already. This means:&lt;/p&gt;

&lt;p&gt;   1. For join / sync-group request, we do not need to call reset-generation any more for illegal-generation / unknown-member. But we would still set the error since at a given time only one join/sync round-trip would be in flight, and hence we should not be participating in a new rebalance. Also for fenced instance error we still treat it as fatal since we should not be participating in a new rebalance, so this is still not expected.&lt;/p&gt;

&lt;p&gt;   2. For commit request, we do not set the corresponding error for illegal-generation / unknown-member / fenced-instance but raise rebalance-in-progress. For commit-sync it would be still thrown to user, while for commit-async it would be logged and swallowed.&lt;/p&gt;

&lt;p&gt;   3. For heartbeat request, we do not treat illegal-generation / unknown-member / fenced-instance errors and just consider it as succeeded since this should be a stale heartbeat which can be ignored.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="17080224" author="guozhang" created="Fri, 10 Apr 2020 04:48:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-9659&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-9659&lt;/a&gt; seems related to this issue as well.&lt;/p&gt;</comment>
                            <comment id="17087408" author="githubbot" created="Mon, 20 Apr 2020 06:26:03 +0000"  >&lt;p&gt;kkonstantine commented on a change in pull request #8445:&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/8445#discussion_r411123324&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/8445#discussion_r411123324&lt;/a&gt;&lt;/p&gt;



&lt;p&gt;##########&lt;br/&gt;
File path: clients/src/main/java/org/apache/kafka/clients/consumer/internals/AbstractCoordinator.java&lt;br/&gt;
##########&lt;br/&gt;
@@ -737,16 +751,21 @@ public void handle(SyncGroupResponse syncResponse,&lt;br/&gt;
                     log.debug(&quot;SyncGroup failed because the group began another rebalance&quot;);&lt;br/&gt;
                     future.raise(error);&lt;br/&gt;
                 } else if (error == Errors.FENCED_INSTANCE_ID) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;log.error(&quot;Received fatal exception: group.instance.id gets fenced&quot;);&lt;br/&gt;
+                    // for sync-group request, even if the generation has changed we would not expect the instance id&lt;br/&gt;
+                    // gets fenced, and hence we always treat this as a fatal error&lt;br/&gt;
+                    log.error(&quot;SyncGroup failed with {} due to group.instance.id {} gets fenced&quot;,&lt;br/&gt;
+                        sentGeneration, rebalanceConfig.groupInstanceId);&lt;br/&gt;
                     future.raise(error);&lt;br/&gt;
                 } else if (error == Errors.UNKNOWN_MEMBER_ID
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; error == Errors.ILLEGAL_GENERATION) {&lt;/th&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/li&gt;
	&lt;li&gt;log.debug(&quot;SyncGroup failed: {}&quot;, error.message());&lt;/li&gt;
	&lt;li&gt;resetGenerationOnResponseError(ApiKeys.SYNC_GROUP, error);&lt;br/&gt;
+                    log.info(&quot;SyncGroup failed with {}: {}, would request re-join&quot;, sentGeneration, error.message());&lt;br/&gt;
+                    if (generationUnchanged())&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Review comment:&lt;br/&gt;
       Makes sense. Thanks&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="17087410" author="githubbot" created="Mon, 20 Apr 2020 06:30:51 +0000"  >&lt;p&gt;kkonstantine commented on a change in pull request #8445:&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/8445#discussion_r411125481&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/8445#discussion_r411125481&lt;/a&gt;&lt;/p&gt;



&lt;p&gt;##########&lt;br/&gt;
File path: clients/src/main/java/org/apache/kafka/clients/consumer/internals/AbstractCoordinator.java&lt;br/&gt;
##########&lt;br/&gt;
@@ -737,16 +751,21 @@ public void handle(SyncGroupResponse syncResponse,&lt;br/&gt;
                     log.debug(&quot;SyncGroup failed because the group began another rebalance&quot;);&lt;br/&gt;
                     future.raise(error);&lt;br/&gt;
                 } else if (error == Errors.FENCED_INSTANCE_ID) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;log.error(&quot;Received fatal exception: group.instance.id gets fenced&quot;);&lt;br/&gt;
+                    // for sync-group request, even if the generation has changed we would not expect the instance id&lt;br/&gt;
+                    // gets fenced, and hence we always treat this as a fatal error&lt;br/&gt;
+                    log.error(&quot;SyncGroup failed with {} due to group.instance.id {} gets fenced&quot;,&lt;br/&gt;
+                        sentGeneration, rebalanceConfig.groupInstanceId);&lt;br/&gt;
                     future.raise(error);&lt;br/&gt;
                 } else if (error == Errors.UNKNOWN_MEMBER_ID
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; error == Errors.ILLEGAL_GENERATION) {&lt;/th&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/li&gt;
	&lt;li&gt;log.debug(&quot;SyncGroup failed: {}&quot;, error.message());&lt;/li&gt;
	&lt;li&gt;resetGenerationOnResponseError(ApiKeys.SYNC_GROUP, error);&lt;br/&gt;
+                    log.info(&quot;SyncGroup failed with {}: {}, would request re-join&quot;, sentGeneration, error.message());&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Review comment:&lt;br/&gt;
       Not sure how this comment was changed, but this still doesn&apos;t read well for me. &lt;br/&gt;
   Still seems that the message should say `... will request re-join&quot;`&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 30 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0dank:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>