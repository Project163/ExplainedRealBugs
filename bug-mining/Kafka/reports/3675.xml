<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:37:31 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-16171] Controller failover during ZK migration can prevent metadata updates to ZK brokers</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-16171</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;h2&gt;&lt;a name=&quot;Description&quot;&gt;&lt;/a&gt;Description&lt;/h2&gt;

&lt;p&gt;During the ZK migration, after KRaft becomes the active controller we enter a state called hybrid mode. This means we have a mixture of ZK and KRaft brokers. The KRaft controller updates the ZK brokers using the deprecated controller RPCs (LeaderAndIsr, UpdateMetadata, etc).&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;A race condition exists where the KRaft controller will get stuck in a retry loop while initializing itself after a failover which prevents it from sending these RPCs to ZK brokers.&lt;/p&gt;
&lt;h2&gt;&lt;a name=&quot;Impact&quot;&gt;&lt;/a&gt;Impact&lt;/h2&gt;

&lt;p&gt;Since the KRaft controller cannot send any RPCs to the ZK brokers, the ZK brokers will not receive any metadata updates. The ZK brokers will be able to send requests to the controller (such as AlterPartitions), but the metadata updates which come as a result of those requests will never be seen. This essentially looks like the controller is unavailable from the ZK brokers perspective.&lt;/p&gt;
&lt;h2&gt;&lt;a name=&quot;DetectionandMitigation&quot;&gt;&lt;/a&gt;Detection and Mitigation&lt;/h2&gt;

&lt;p&gt;This bug can be seen by observing failed ZK writes from a recently elected controller.&lt;/p&gt;

&lt;p&gt;The tell-tale error message is:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Check op on KRaft Migration ZNode failed. Expected zkVersion = 507823. This indicates that another KRaft controller is making writes to ZooKeeper. &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;with a stacktrace like:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.lang.RuntimeException: Check op on KRaft Migration ZNode failed. Expected zkVersion = 507823. This indicates that another KRaft controller is making writes to ZooKeeper.
	at kafka.zk.KafkaZkClient.handleUnwrappedMigrationResult$1(KafkaZkClient.scala:2613)
	at kafka.zk.KafkaZkClient.unwrapMigrationResponse$1(KafkaZkClient.scala:2639)
	at kafka.zk.KafkaZkClient.$anonfun$retryMigrationRequestsUntilConnected$2(KafkaZkClient.scala:2664)
	at scala.collection.StrictOptimizedIterableOps.map(StrictOptimizedIterableOps.scala:100)
	at scala.collection.StrictOptimizedIterableOps.map$(StrictOptimizedIterableOps.scala:87)
	at scala.collection.mutable.ArrayBuffer.map(ArrayBuffer.scala:43)
	at kafka.zk.KafkaZkClient.retryMigrationRequestsUntilConnected(KafkaZkClient.scala:2664)
	at kafka.zk.migration.ZkTopicMigrationClient.$anonfun$createTopic$1(ZkTopicMigrationClient.scala:158)
	at kafka.zk.migration.ZkTopicMigrationClient.createTopic(ZkTopicMigrationClient.scala:141)
	at org.apache.kafka.metadata.migration.KRaftMigrationZkWriter.lambda$handleTopicsSnapshot$27(KRaftMigrationZkWriter.java:441)
	at org.apache.kafka.metadata.migration.KRaftMigrationDriver.applyMigrationOperation(KRaftMigrationDriver.java:262)
	at org.apache.kafka.metadata.migration.KRaftMigrationDriver.access$300(KRaftMigrationDriver.java:64)
	at org.apache.kafka.metadata.migration.KRaftMigrationDriver$SyncKRaftMetadataEvent.lambda$run$0(KRaftMigrationDriver.java:791)
	at org.apache.kafka.metadata.migration.KRaftMigrationDriver.lambda$countingOperationConsumer$6(KRaftMigrationDriver.java:880)
	at org.apache.kafka.metadata.migration.KRaftMigrationZkWriter.lambda$handleTopicsSnapshot$28(KRaftMigrationZkWriter.java:438)
	at java.base/java.lang.Iterable.forEach(Iterable.java:75)
	at org.apache.kafka.metadata.migration.KRaftMigrationZkWriter.handleTopicsSnapshot(KRaftMigrationZkWriter.java:436)
	at org.apache.kafka.metadata.migration.KRaftMigrationZkWriter.handleSnapshot(KRaftMigrationZkWriter.java:115)
	at org.apache.kafka.metadata.migration.KRaftMigrationDriver$SyncKRaftMetadataEvent.run(KRaftMigrationDriver.java:790)
	at org.apache.kafka.queue.KafkaEventQueue$EventContext.run(KafkaEventQueue.java:127)
	at org.apache.kafka.queue.KafkaEventQueue$EventHandler.handleEvents(KafkaEventQueue.java:210)
	at org.apache.kafka.queue.KafkaEventQueue$EventHandler.run(KafkaEventQueue.java:181)
	at java.base/java.lang.Thread.run(Thread.java:1583)
	at org.apache.kafka.common.utils.KafkaThread.run(KafkaThread.java:66)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;To mitigate this problem, a new KRaft controller should be elected. This can be done by restarting the problematic active controller. To verify that the new controller does not encounter the race condition, look for&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[KRaftMigrationDriver id=9991] 9991 transitioning from SYNC_KRAFT_TO_ZK to KRAFT_CONTROLLER_TO_BROKER_COMM state &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;
&lt;h2&gt;&lt;a name=&quot;Details&quot;&gt;&lt;/a&gt;Details&lt;/h2&gt;

&lt;p&gt;Controller A loses leadership via Raft event (e.g., from a timeout in the Raft layer). A KRaftLeaderEvent is added to KRaftMigrationDriver event queue behind any pending MetadataChangeEvents.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Controller B is elected and a KRaftLeaderEvent is added to KRaftMigrationDriver&apos;s queue. Since this controller is inactive, it processes the event immediately. This event simply loads the migration state from ZK (/migration) to check if the migration has been completed. This information is used to determine the downstream transitions in the state machine. Controller B passes through WAIT_FOR_ACTIVE_CONTROLLER and transitions to BECOME_CONTROLLER since the migration is done. While handling the BecomeZkControllerEvent, the controller forcibly takes ZK controller leadership by writing its ID into /controller and its epoch into /controller_epoch.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The change to /controller_epoch causes all of the pending writes on Controller A to fail since those writes are doing a check op on /controller_epoch as part of the multi-op writes to ZK.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;However, there is a race between Controller B loading the state in /migration and when it updates /controller_epoch. It is possible for Controller A to successfully write to ZK with its older epoch. This causes the znode version of /migration to increase which will cause Controller B to get stuck.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;It is safe for the old controller to be making these writes, since we only dual-write committed state from KRaft (i.e., &#8220;write-behind), but this race causes the new controller to have a stale version of /migration.&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13565459">KAFKA-16171</key>
            <summary>Controller failover during ZK migration can prevent metadata updates to ZK brokers</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davidarthur">David Arthur</assignee>
                                    <reporter username="davidarthur">David Arthur</reporter>
                        <labels>
                    </labels>
                <created>Fri, 19 Jan 2024 15:54:43 +0000</created>
                <updated>Wed, 13 Mar 2024 15:49:44 +0000</updated>
                            <resolved>Wed, 13 Mar 2024 15:49:44 +0000</resolved>
                                    <version>3.6.0</version>
                    <version>3.6.1</version>
                    <version>3.7.0</version>
                                    <fixVersion>3.6.2</fixVersion>
                    <fixVersion>3.7.0</fixVersion>
                                    <component>controller</component>
                    <component>kraft</component>
                    <component>migration</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                        <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 42 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1mvrc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>