<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:11:59 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-6749] TopologyTestDriver fails when topoloy under test uses EXACTLY_ONCE</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-6749</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Stream processing topologies which are configured to use &lt;tt&gt;EXACTLY_ONCE&lt;/tt&gt; processing guarantee cannot be tested with the &lt;tt&gt;TopologyTestDriver&lt;/tt&gt;. Tests usually crash with &lt;tt&gt;java.lang.IllegalStateException: MockProducer hasn&apos;t been initialized for transactions&lt;/tt&gt; within the second call to &lt;tt&gt;TopologyTestDriver.pipeInput()&lt;/tt&gt;, the first call works fine.&lt;/p&gt;

&lt;p&gt;Changing the processing guarantee to &lt;tt&gt;AT_LEAST_ONCE&lt;/tt&gt; makes tests pass.&lt;/p&gt;

&lt;p&gt;This is a problem because it is expected that proper processor topologies can be successfully tested using &lt;tt&gt;TopologyTestDriver&lt;/tt&gt;, however &lt;tt&gt;TopologyTestDriver&lt;/tt&gt; can&apos;t handle &lt;tt&gt;EXACTLY_ONCE&lt;/tt&gt; and crashes during tests. To a developer, this usually means that there is something wrong with their processor topologies.&lt;/p&gt;

&lt;p&gt;Kafka developpers can reproduce this by adding:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
put(StreamsConfig.PROCESSING_GUARANTEE_CONFIG, StreamsConfig.EXACTLY_ONCE);&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;to line 88 of TopologyTestDriverTest: streams/test-utils/src/test/java/org/apache/kafka/streams/TopologyTestDriverTest.java&lt;/p&gt;

&lt;p&gt;Originally &lt;a href=&quot;http://mail-archives.apache.org/mod_mbox/kafka-users/201804.mbox/%3C54ab29ad-44e1-35bd-9c16-c1d8d68a88db%40gmail.com%3E&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;reported on the ML&lt;/a&gt;.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13150262">KAFKA-6749</key>
            <summary>TopologyTestDriver fails when topoloy under test uses EXACTLY_ONCE</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jadireddi">Jagadesh Adireddi</assignee>
                                    <reporter username="frederica">Frederic Arno</reporter>
                        <labels>
                            <label>newbie</label>
                    </labels>
                <created>Thu, 5 Apr 2018 10:35:16 +0000</created>
                <updated>Wed, 13 Jun 2018 21:39:38 +0000</updated>
                            <resolved>Wed, 13 Jun 2018 21:39:38 +0000</resolved>
                                    <version>1.1.0</version>
                                    <fixVersion>1.1.1</fixVersion>
                    <fixVersion>2.0.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16447208" author="githubbot" created="Sun, 22 Apr 2018 11:12:36 +0000"  >&lt;p&gt;jadireddi opened a new pull request #4912: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6749&quot; title=&quot;TopologyTestDriver fails when topoloy under test uses EXACTLY_ONCE&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-6749&quot;&gt;&lt;del&gt;KAFKA-6749&lt;/del&gt;&lt;/a&gt;: Fixed TopologyTestDriver to process stream processing guarantee as exactly once&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/4912&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/4912&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6749&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-6749&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Fixed Stream processing topologies which are configured to use EXACTLY_ONCE processing guarantee can be tested with the `TopologyTestDriver`.&lt;/p&gt;

&lt;p&gt;   *More detailed description of your change,&lt;br/&gt;
   if necessary. The PR title and PR message become&lt;br/&gt;
   the squashed commit message, so use a separate&lt;br/&gt;
   comment to ping reviewers.*&lt;/p&gt;

&lt;p&gt;   *Summary of testing strategy (including rationale)&lt;br/&gt;
   for the feature or bug fix. Unit and/or integration&lt;br/&gt;
   tests are expected for any behaviour change and&lt;br/&gt;
   system tests should be considered for larger changes.*&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16472905" author="githubbot" created="Sat, 12 May 2018 05:06:32 +0000"  >&lt;p&gt;jadireddi closed pull request #4912: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6749&quot; title=&quot;TopologyTestDriver fails when topoloy under test uses EXACTLY_ONCE&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-6749&quot;&gt;&lt;del&gt;KAFKA-6749&lt;/del&gt;&lt;/a&gt;: Fixed TopologyTestDriver to process stream processing guarantee as exactly once&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/4912&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/4912&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;





&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16472915" author="githubbot" created="Sat, 12 May 2018 05:34:56 +0000"  >&lt;p&gt;jadireddi opened a new pull request #4912: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6749&quot; title=&quot;TopologyTestDriver fails when topoloy under test uses EXACTLY_ONCE&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-6749&quot;&gt;&lt;del&gt;KAFKA-6749&lt;/del&gt;&lt;/a&gt;: Fixed TopologyTestDriver to process stream processing guarantee as exactly once&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/4912&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/4912&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6749&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-6749&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Fixed Stream processing topologies which are configured to use EXACTLY_ONCE processing guarantee can be tested with the `TopologyTestDriver`.&lt;/p&gt;

&lt;p&gt;   *More detailed description of your change,&lt;br/&gt;
   if necessary. The PR title and PR message become&lt;br/&gt;
   the squashed commit message, so use a separate&lt;br/&gt;
   comment to ping reviewers.*&lt;/p&gt;

&lt;p&gt;   *Summary of testing strategy (including rationale)&lt;br/&gt;
   for the feature or bug fix. Unit and/or integration&lt;br/&gt;
   tests are expected for any behaviour change and&lt;br/&gt;
   system tests should be considered for larger changes.*&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16511683" author="githubbot" created="Wed, 13 Jun 2018 21:31:54 +0000"  >&lt;p&gt;mjsax closed pull request #4912: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6749&quot; title=&quot;TopologyTestDriver fails when topoloy under test uses EXACTLY_ONCE&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-6749&quot;&gt;&lt;del&gt;KAFKA-6749&lt;/del&gt;&lt;/a&gt;: Fixed TopologyTestDriver to process stream processing guarantee as exactly once&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/4912&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/4912&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/streams/test-utils/src/main/java/org/apache/kafka/streams/TopologyTestDriver.java b/streams/test-utils/src/main/java/org/apache/kafka/streams/TopologyTestDriver.java&lt;br/&gt;
index 7f752652da4..723780110ff 100644&lt;br/&gt;
&amp;#8212; a/streams/test-utils/src/main/java/org/apache/kafka/streams/TopologyTestDriver.java&lt;br/&gt;
+++ b/streams/test-utils/src/main/java/org/apache/kafka/streams/TopologyTestDriver.java&lt;br/&gt;
@@ -195,6 +195,7 @@&lt;br/&gt;
     private final Map&amp;lt;TopicPartition, AtomicLong&amp;gt; offsetsByTopicPartition = new HashMap&amp;lt;&amp;gt;();&lt;/p&gt;

&lt;p&gt;     private final Map&amp;lt;String, Queue&amp;lt;ProducerRecord&amp;lt;byte[], byte[]&amp;gt;&amp;gt;&amp;gt; outputRecordsByTopic = new HashMap&amp;lt;&amp;gt;();&lt;br/&gt;
+    private final boolean eosEnabled;&lt;/p&gt;

&lt;p&gt;     /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Create a new test diver instance.&lt;br/&gt;
@@ -345,6 +346,7 @@ public void onRestoreEnd(final TopicPartition topicPartition, final String store&lt;br/&gt;
             task = null;&lt;br/&gt;
             context = null;&lt;br/&gt;
         }&lt;br/&gt;
+        eosEnabled = streamsConfig.getString(StreamsConfig.PROCESSING_GUARANTEE_CONFIG).equals(StreamsConfig.EXACTLY_ONCE);&lt;br/&gt;
     }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     /**&lt;br/&gt;
@@ -439,6 +441,10 @@ private void captureOutputRecords() {&lt;br/&gt;
         // Capture all the records sent to the producer ...&lt;br/&gt;
         final List&amp;lt;ProducerRecord&amp;lt;byte[], byte[]&amp;gt;&amp;gt; output = producer.history();&lt;br/&gt;
         producer.clear();&lt;br/&gt;
+        if (eosEnabled &amp;amp;&amp;amp; !producer.closed()) &lt;/p&gt;
{
+            producer.initTransactions();
+            producer.beginTransaction();
+        }
&lt;p&gt;         for (final ProducerRecord&amp;lt;byte[], byte[]&amp;gt; record : output) {&lt;br/&gt;
             outputRecordsByTopic.computeIfAbsent(record.topic(), k -&amp;gt; new LinkedList&amp;lt;&amp;gt;()).add(record);&lt;/p&gt;

&lt;p&gt;@@ -666,6 +672,9 @@ public void close() {&lt;br/&gt;
             }&lt;br/&gt;
         }&lt;br/&gt;
         captureOutputRecords();&lt;br/&gt;
+        if (!eosEnabled) &lt;/p&gt;
{
+            producer.close();
+        }
&lt;p&gt;         stateDirectory.clean();&lt;br/&gt;
     }&lt;/p&gt;

&lt;p&gt;diff --git a/streams/test-utils/src/test/java/org/apache/kafka/streams/TopologyTestDriverTest.java b/streams/test-utils/src/test/java/org/apache/kafka/streams/TopologyTestDriverTest.java&lt;br/&gt;
index 7552637dc26..135fb3ffd8a 100644&lt;br/&gt;
&amp;#8212; a/streams/test-utils/src/test/java/org/apache/kafka/streams/TopologyTestDriverTest.java&lt;br/&gt;
+++ b/streams/test-utils/src/test/java/org/apache/kafka/streams/TopologyTestDriverTest.java&lt;br/&gt;
@@ -50,6 +50,8 @@&lt;br/&gt;
 import org.junit.After;&lt;br/&gt;
 import org.junit.Assert;&lt;br/&gt;
 import org.junit.Test;&lt;br/&gt;
+import org.junit.runner.RunWith;&lt;br/&gt;
+import org.junit.runners.Parameterized;&lt;/p&gt;

&lt;p&gt; import java.util.ArrayList;&lt;br/&gt;
 import java.util.Collection;&lt;br/&gt;
@@ -61,6 +63,7 @@&lt;br/&gt;
 import java.util.Objects;&lt;br/&gt;
 import java.util.Properties;&lt;br/&gt;
 import java.util.Set;&lt;br/&gt;
+import java.util.Arrays;&lt;br/&gt;
 import java.util.regex.Pattern;&lt;/p&gt;

&lt;p&gt; import static org.hamcrest.CoreMatchers.equalTo;&lt;br/&gt;
@@ -70,6 +73,7 @@&lt;br/&gt;
 import static org.junit.Assert.assertTrue;&lt;br/&gt;
 import static org.junit.Assert.fail;&lt;/p&gt;

&lt;p&gt;+@RunWith(value = Parameterized.class)&lt;br/&gt;
 public class TopologyTestDriverTest {&lt;br/&gt;
     private final static String SOURCE_TOPIC_1 = &quot;source-topic-1&quot;;&lt;br/&gt;
     private final static String SOURCE_TOPIC_2 = &quot;source-topic-2&quot;;&lt;br/&gt;
@@ -108,6 +112,23 @@&lt;br/&gt;
         new StringSerializer(),&lt;br/&gt;
         new LongSerializer());&lt;/p&gt;

&lt;p&gt;+    private final boolean eosEnabled;&lt;br/&gt;
+&lt;br/&gt;
+    @Parameterized.Parameters(name = &quot;Eos enabled = &lt;/p&gt;
{0}
&lt;p&gt;&quot;)&lt;br/&gt;
+    public static Collection&amp;lt;Object[]&amp;gt; data() {&lt;br/&gt;
+        final List&amp;lt;Object[]&amp;gt; values = new ArrayList&amp;lt;&amp;gt;();&lt;br/&gt;
+        for (final boolean eosEnabled : Arrays.asList(true, false)) {&lt;br/&gt;
+            values.add(new Object[] &lt;/p&gt;
{eosEnabled}
&lt;p&gt;);&lt;br/&gt;
+        }&lt;br/&gt;
+        return values;&lt;br/&gt;
+    }&lt;br/&gt;
+&lt;br/&gt;
+    public TopologyTestDriverTest(final boolean eosEnabled) {&lt;br/&gt;
+        this.eosEnabled = eosEnabled;&lt;br/&gt;
+        if (eosEnabled) &lt;/p&gt;
{
+            config.put(StreamsConfig.PROCESSING_GUARANTEE_CONFIG, StreamsConfig.EXACTLY_ONCE);
+        }
&lt;p&gt;+    }&lt;/p&gt;

&lt;p&gt;     private final static class Record {&lt;br/&gt;
         private final Object key;&lt;br/&gt;
@@ -353,6 +374,8 @@ public void shouldCloseProcessor() &lt;/p&gt;
{
 
         testDriver.close();
         assertTrue(mockProcessors.get(0).closed);
+        // As testDriver is already closed, bypassing @After tearDown testDriver.close().
+        testDriver = null;
     }

&lt;p&gt;     @Test&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 22 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3s6hb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>