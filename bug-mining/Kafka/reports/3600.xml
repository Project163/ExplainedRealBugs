<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:36:22 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-15653] NPE in ChunkedByteStream</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-15653</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;When looping franz-go integration tests, I received an UNKNOWN_SERVER_ERROR from producing. The broker logs for the failing request:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[2023-10-19 22:29:58,160] ERROR [ReplicaManager broker=2] Error processing append operation on partition 2fa8995d8002fbfe68a96d783f26aa2c5efc15368bf44ed8f2ab7e24b41b9879-24 (kafka.server.ReplicaManager)
java.lang.NullPointerException
	at org.apache.kafka.common.utils.ChunkedBytesStream.&amp;lt;init&amp;gt;(ChunkedBytesStream.java:89)
	at org.apache.kafka.common.record.CompressionType$3.wrapForInput(CompressionType.java:105)
	at org.apache.kafka.common.record.DefaultRecordBatch.recordInputStream(DefaultRecordBatch.java:273)
	at org.apache.kafka.common.record.DefaultRecordBatch.compressedIterator(DefaultRecordBatch.java:277)
	at org.apache.kafka.common.record.DefaultRecordBatch.skipKeyValueIterator(DefaultRecordBatch.java:352)
	at org.apache.kafka.storage.internals.log.LogValidator.validateMessagesAndAssignOffsetsCompressed(LogValidator.java:358)
	at org.apache.kafka.storage.internals.log.LogValidator.validateMessagesAndAssignOffsets(LogValidator.java:165)
	at kafka.log.UnifiedLog.append(UnifiedLog.scala:805)
	at kafka.log.UnifiedLog.appendAsLeader(UnifiedLog.scala:719)
	at kafka.cluster.Partition.$anonfun$appendRecordsToLeader$1(Partition.scala:1313)
	at kafka.cluster.Partition.appendRecordsToLeader(Partition.scala:1301)
	at kafka.server.ReplicaManager.$anonfun$appendToLocalLog$6(ReplicaManager.scala:1210)
	at scala.collection.StrictOptimizedMapOps.map(StrictOptimizedMapOps.scala:28)
	at scala.collection.StrictOptimizedMapOps.map$(StrictOptimizedMapOps.scala:27)
	at scala.collection.mutable.HashMap.map(HashMap.scala:35)
	at kafka.server.ReplicaManager.appendToLocalLog(ReplicaManager.scala:1198)
	at kafka.server.ReplicaManager.appendEntries$1(ReplicaManager.scala:754)
	at kafka.server.ReplicaManager.$anonfun$appendRecords$18(ReplicaManager.scala:874)
	at kafka.server.ReplicaManager.$anonfun$appendRecords$18$adapted(ReplicaManager.scala:874)
	at kafka.server.KafkaRequestHandler$.$anonfun$wrap$3(KafkaRequestHandler.scala:73)
	at kafka.server.KafkaRequestHandler.run(KafkaRequestHandler.scala:130)
	at java.base/java.lang.Thread.run(Unknown Source)

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>Docker container on a Linux laptop, using the latest release.</environment>
        <key id="13554860">KAFKA-15653</key>
            <summary>NPE in ChunkedByteStream</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jolshan">Justine Olshan</assignee>
                                    <reporter username="twmb">Travis Bischel</reporter>
                        <labels>
                    </labels>
                <created>Thu, 19 Oct 2023 22:37:03 +0000</created>
                <updated>Wed, 29 Nov 2023 21:50:22 +0000</updated>
                            <resolved>Wed, 15 Nov 2023 12:39:04 +0000</resolved>
                                    <version>3.6.0</version>
                                    <fixVersion>3.6.1</fixVersion>
                    <fixVersion>3.7.0</fixVersion>
                                    <component>producer </component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>10</watches>
                                                                                                                <comments>
                            <comment id="17777542" author="twmb" created="Fri, 20 Oct 2023 02:34:32 +0000"  >&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[2023-10-20 02:31:00,204] ERROR [ReplicaManager broker=1] Error processing append operation on partition 2c69b88eab8670ef1fd0e55b81b9e000995386afd8756ea342494d36911e6f01-29 (kafka.server.ReplicaManager)
java.lang.NullPointerException: Cannot invoke &quot;java.nio.ByteBuffer.hasArray()&quot; because &quot;this.intermediateBufRef&quot; is null 
        at org.apache.kafka.common.utils.ChunkedBytesStream.&amp;lt;init&amp;gt;(ChunkedBytesStream.java:89)
        at org.apache.kafka.common.record.CompressionType$3.wrapForInput(CompressionType.java:105)
        at org.apache.kafka.common.record.DefaultRecordBatch.recordInputStream(DefaultRecordBatch.java:273)
        at org.apache.kafka.common.record.DefaultRecordBatch.compressedIterator(DefaultRecordBatch.java:277)
        at org.apache.kafka.common.record.DefaultRecordBatch.skipKeyValueIterator(DefaultRecordBatch.java:352)
        at org.apache.kafka.storage.internals.log.LogValidator.validateMessagesAndAssignOffsetsCompressed(LogValidator.java:358)
        at org.apache.kafka.storage.internals.log.LogValidator.validateMessagesAndAssignOffsets(LogValidator.java:165)
        at kafka.log.UnifiedLog.$anonfun$append$2(UnifiedLog.scala:805)
        at kafka.log.UnifiedLog.append(UnifiedLog.scala:1845)
        at kafka.log.UnifiedLog.appendAsLeader(UnifiedLog.scala:719)
        at kafka.cluster.Partition.$anonfun$appendRecordsToLeader$1(Partition.scala:1313)
        at kafka.cluster.Partition.appendRecordsToLeader(Partition.scala:1301)
        at kafka.server.ReplicaManager.$anonfun$appendToLocalLog$6(ReplicaManager.scala:1210)
        at scala.collection.TraversableLike.$anonfun$map$1(TraversableLike.scala:286)
        at scala.collection.immutable.HashMap$HashMap1.foreach(HashMap.scala:400)
        at scala.collection.immutable.HashMap$HashTrieMap.foreach(HashMap.scala:728)
        at scala.collection.immutable.HashMap$HashTrieMap.foreach(HashMap.scala:728)
        at scala.collection.TraversableLike.map(TraversableLike.scala:286)
        at scala.collection.TraversableLike.map$(TraversableLike.scala:279)
        at scala.collection.AbstractTraversable.map(Traversable.scala:108)
        at kafka.server.ReplicaManager.appendToLocalLog(ReplicaManager.scala:1198)
        at kafka.server.ReplicaManager.appendRecords(ReplicaManager.scala:754)
        at kafka.server.KafkaApis.handleProduceRequest(KafkaApis.scala:686)
        at kafka.server.KafkaApis.handle(KafkaApis.scala:180)
        at kafka.server.KafkaRequestHandler.run(KafkaRequestHandler.scala:149)
        at java.base/java.lang.Thread.run(Thread.java:833)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17777549" author="ijuma" created="Fri, 20 Oct 2023 03:00:41 +0000"  >&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=divijvaidya&quot; class=&quot;user-hover&quot; rel=&quot;divijvaidya&quot;&gt;divijvaidya&lt;/a&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17777639" author="divijvaidya" created="Fri, 20 Oct 2023 08:54:41 +0000"  >&lt;p&gt;I will look into this tomorrow. Assigning this to myself.&lt;/p&gt;</comment>
                            <comment id="17777647" author="divijvaidya" created="Fri, 20 Oct 2023 09:16:04 +0000"  >&lt;p&gt;In 3.6, we started using Buffer pool local to each request handler thread to perform decompression. The above stack trace indicates a null when we ask for a buffer from the buffer pool, returned by bufferQueue.pollfirst() at &lt;a href=&quot;https://github.com/apache/kafka/blob/c81a7252195261f649faba166ee723552bed4d81/clients/src/main/java/org/apache/kafka/common/utils/BufferSupplier.java#L76&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/c81a7252195261f649faba166ee723552bed4d81/clients/src/main/java/org/apache/kafka/common/utils/BufferSupplier.java#L76&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;Ideally that should not be possible bufferQueue.pollfirst() returns null only when bufferQueue is empty. And we already check fr bufferQueue being empty in the line above. Also this function is not thread safe. It doesn&apos;t need to be thread safe because a particular instance of buffer pool (DefaultSupplier) is associated with single thread (the request handler thread) and only one thread should be accessing it at one time.&#160;&lt;/p&gt;

&lt;p&gt;Either we are incorrectly accessing DefaultBufferSupplier.get() from two threads and causing race condition OR somehow in the same thread reference is being set to null/or garbage collected?!&lt;/p&gt;



&lt;p&gt;I will try to eyeball to code here to see if I can find something. But practically &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=twmb&quot; class=&quot;user-hover&quot; rel=&quot;twmb&quot;&gt;twmb&lt;/a&gt; it would be greatly useful if you can share your integration/unit test with us so that we can find a deterministic way to reproduce it.&lt;/p&gt;</comment>
                            <comment id="17777664" author="divijvaidya" created="Fri, 20 Oct 2023 09:36:47 +0000"  >&lt;p&gt;I think the potential bug could be in how we are closing the ChunkedBytesStream and returning the buffer for re-use later.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@Override
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void close() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
    &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] mybuf = intermediateBuf;
    intermediateBuf = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;

    InputStream input = in;
    in = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;

    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (mybuf != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
        bufferSupplier.release(intermediateBufRef);
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (input != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
        input.close();
} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I &lt;del&gt;am suspecting this because, we are setting underlying buffer behind the ByteBuffer to be null, which will allow it to be garbage collected. But we don&apos;t want it to be GC&apos;ed because we simply want to return it to the pool so that it can be used later again.&lt;/del&gt;&lt;/p&gt;

&lt;p&gt;&lt;del&gt;I will verify this tomorrow with a test and have a fix out soon.&lt;/del&gt;&lt;br/&gt;
Nevermind, it will not be GC&apos;ed because we have a reference to it via mybuf. I verified it using a test.&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@Test
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testValidReturnToBufferSupplierOnClose() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException, InterruptedException {
    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; BufferSupplier threadSpecificSupplier = BufferSupplier.create();
    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; delegateSkipToSourceStream = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;

    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ByteBuffer inputBuffer = ByteBuffer.allocate(SIZE_LITTLE_LARGE_THAN_INTERMEDIATE_BUFFER_SIZE);
    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ByteBuffer originalIntermediateBufferRef;

    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; (ChunkedBytesStream is = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ChunkedBytesStream(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ByteBufferInputStream(inputBuffer.duplicate()), threadSpecificSupplier, DEFAULT_INTERMEDIATE_BUFFER_SIZE, delegateSkipToSourceStream)) {
        assertNotNull(is.intermediateBufRef);
        &lt;span class=&quot;code-comment&quot;&gt;// read everything to verify sanity
&lt;/span&gt;        Utils.readFully(is, ByteBuffer.allocate(inputBuffer.capacity()));
        &lt;span class=&quot;code-comment&quot;&gt;// store reference of intermediate buffer provided by buffer supplier
&lt;/span&gt;        originalIntermediateBufferRef = is.intermediateBufRef;
    }

    &lt;span class=&quot;code-comment&quot;&gt;// The intermediate buffer should have been returned to buffer supplier.
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// Force GC to rule out any lingering references. Notably &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; is just a hint and may not cause actual GC.
&lt;/span&gt;    &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.gc();
    &lt;span class=&quot;code-comment&quot;&gt;// Wait to GC to &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; it&apos;s magic.
&lt;/span&gt;    &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(2000);

    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; (ChunkedBytesStream is = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ChunkedBytesStream(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ByteBufferInputStream(inputBuffer.duplicate()), threadSpecificSupplier, DEFAULT_INTERMEDIATE_BUFFER_SIZE, delegateSkipToSourceStream)) {
        assertNotNull(is.intermediateBufRef);
        assertEquals(originalIntermediateBufferRef, is.intermediateBufRef);
    }
} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17777835" author="twmb" created="Fri, 20 Oct 2023 15:24:50 +0000"  >&lt;p&gt;Maybe related?&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.kafka.common.errors.InvalidRequestException: Error getting request for apiKey: PRODUCE, apiVersion: 9, connectionId: 127.0.0.1:9092-127.0.0.1:46394-145, listenerName: ListenerName(PLAINTEXT), principal: User:ANONYMOUS
Caused by: java.nio.BufferUnderflowException
        at java.base/java.nio.Buffer.nextGetIndex(Buffer.java:699)
        at java.base/java.nio.HeapByteBuffer.get(HeapByteBuffer.java:165)
        at org.apache.kafka.common.utils.ByteUtils.readUnsignedVarint(ByteUtils.java:160)
        at org.apache.kafka.common.protocol.ByteBufferAccessor.readUnsignedVarint(ByteBufferAccessor.java:70)
        at org.apache.kafka.common.message.ProduceRequestData.read(ProduceRequestData.java:195)
        at org.apache.kafka.common.message.ProduceRequestData.&amp;lt;init&amp;gt;(ProduceRequestData.java:114)
        at org.apache.kafka.common.requests.ProduceRequest.parse(ProduceRequest.java:256)
        at org.apache.kafka.common.requests.AbstractRequest.doParseRequest(AbstractRequest.java:178)
        at org.apache.kafka.common.requests.AbstractRequest.parseRequest(AbstractRequest.java:172)
        at org.apache.kafka.common.requests.RequestContext.parseRequest(RequestContext.java:95)
        at kafka.network.RequestChannel$Request.&amp;lt;init&amp;gt;(RequestChannel.scala:108)
        at kafka.network.Processor.$anonfun$processCompletedReceives$1(SocketServer.scala:1148)
        at java.base/java.util.LinkedHashMap$LinkedValues.forEach(LinkedHashMap.java:647)
        at kafka.network.Processor.processCompletedReceives(SocketServer.scala:1126)
        at kafka.network.Processor.run(SocketServer.scala:1012)
        at java.base/java.lang.Thread.run(Thread.java:833)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Next comment I&apos;ll attach a small script that can be used to repro; I&apos;m testing it a few times to iron out bash kinks&lt;/p&gt;</comment>
                            <comment id="17777846" author="twmb" created="Fri, 20 Oct 2023 15:45:29 +0000"  >&lt;p&gt;Sorry, one more note: I&apos;m also occasionally getting InvalidRecordException frequently without NPE. The attached repro script ignores InvalidRecordException because it&apos;s easier to get a failure that contains NPE when ignoring that error, when not ignoring that error, frequently the test fails with InvalidRecordException without an NPE (so, different sort of problem &amp;#8211; but perhaps related).&lt;/p&gt;

&lt;p&gt;Attached is a script that will clone the franz-go repo, optionally install Go, and loop docker compose up/down with integration tests. Once the script stops, container logs are in CONTAINER_LOGS, and franz-go debug logs are in FRANZ_FAIL. In FRANZ_FAIL, you can search for `--- FAIL` to see the error that caused the test to stop (usually UNKNOWN_SERVER_ERROR) and then search for the first instance of that error &amp;#8211; it will be returned from producing. In CONTAINER_LOGS, you can look for NullPointerException or InvalidRecordException.&lt;/p&gt;

&lt;p&gt; &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13063753/13063753_repro.sh&quot; title=&quot;repro.sh attached to KAFKA-15653&quot;&gt;repro.sh&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; &lt;/p&gt;</comment>
                            <comment id="17778570" author="divijvaidya" created="Mon, 23 Oct 2023 08:25:41 +0000"  >&lt;p&gt;Thank you for the nice script &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=twmb&quot; class=&quot;user-hover&quot; rel=&quot;twmb&quot;&gt;twmb&lt;/a&gt; . I am able to reproduce it locally on my setup. Notably, I don&apos;t have to restart Kafka server to reproduce this.&#160;&lt;/p&gt;

&lt;p&gt;I haven&apos;t found the root cause yet. Will keep this Jira updated if I find anything.&#160;&lt;/p&gt;</comment>
                            <comment id="17778603" author="divijvaidya" created="Mon, 23 Oct 2023 10:02:38 +0000"  >&lt;p&gt;I think I found a quite fundamental problem here.&lt;/p&gt;

&lt;p&gt;By design, BufferPool is not thread safe in Kafka &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;. And that is acceptable because the buffer pool instance is local to a request handler thread &lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;. Hence we assume that a particular buffer pool will always be accessed only by it&apos;s owner thread.&lt;/p&gt;

&lt;p&gt;However, unfortunately, seems like that this assumption is not true!&lt;/p&gt;

&lt;p&gt;I have same BufferPool being accessed by two different request handler threads. The first access is legitimate while trying to process an API request at &lt;span class=&quot;error&quot;&gt;&amp;#91;3&amp;#93;&lt;/span&gt;. The second access comes from a change introduced in &lt;a href=&quot;https://github.com/apache/kafka/commit/56dcb837a2f1c1d8c016cfccf8268a910bb77a36&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/commit/56dcb837a2f1c1d8c016cfccf8268a910bb77a36&lt;/a&gt; where we are passing the stateful variable of a request (including the buffer supplier) to a callback which could be executed by a different request handler thread &lt;span class=&quot;error&quot;&gt;&amp;#91;4&amp;#93;&lt;/span&gt; . Hence, we will end up in a situation where stateful members such as requestLocal of one thread is being accessed by another different thread. This is a bug.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Impact of the bug&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;This bug has been present since 3.5 but the impact is visible in 3.6 because in 3.6 we expanded the use of request local buffer pool to perform decompression. Earlier the buffer pool was only being used in read path and by log cleaner. The callback mentioned above calls appendToLocalLog and prior to 3.6 this code path wasn&apos;t using requestLocal.&lt;/p&gt;

&lt;p&gt;All 3.6 operations which call the following line in ReplicaManager are impacted which is basically use case of transactions and also specifically to AddPartitionsToTxnManager API calls.&lt;/p&gt;

&lt;p&gt;```&lt;br/&gt;
addPartitionsToTxnManager.foreach(&lt;em&gt;.addTxnData(node, notYetVerifiedTransaction, KafkaRequestHandler.wrap(appendEntries(entriesPerPartition)(&lt;/em&gt;))))&lt;br/&gt;
```&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Possible solutions&lt;/b&gt;&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jolshan&quot; class=&quot;user-hover&quot; rel=&quot;jolshan&quot;&gt;jolshan&lt;/a&gt; can you please take a look and see if we can avoid leaking the requestLocal (bufferpool) belonging to one thread to the other thread?&lt;/p&gt;

&lt;p&gt;One way we can fix this is to store the bufferpool reference in ThreadLocal and instead of passing the reference around, whenever we want to use bufferpool, we will directly ask the executing thread for it. This will ensure that a thread is always using it&apos;s own instance of the buffer pool. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ijuma&quot; class=&quot;user-hover&quot; rel=&quot;ijuma&quot;&gt;ijuma&lt;/a&gt; since you wrote the original requestLocal buffer pool, what do you think about this solution?&lt;/p&gt;

&lt;p&gt;Another option is to extract out function `appendEntries` outside of&#160;`appendRecords` since it is `appendEntries` is invoked as a callback and shouldn&apos;t rely on local variable/state of `appendRecords`.&lt;/p&gt;



&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://github.com/apache/kafka/blob/9c77c17c4eae19af743e551e8e7d8b49b07c4e99/clients/src/main/java/org/apache/kafka/common/utils/BufferSupplier.java#L27&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/9c77c17c4eae19af743e551e8e7d8b49b07c4e99/clients/src/main/java/org/apache/kafka/common/utils/BufferSupplier.java#L27&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://github.com/apache/kafka/blob/9c77c17c4eae19af743e551e8e7d8b49b07c4e99/core/src/main/scala/kafka/server/KafkaRequestHandler.scala#L96&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/9c77c17c4eae19af743e551e8e7d8b49b07c4e99/core/src/main/scala/kafka/server/KafkaRequestHandler.scala#L96&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;3&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://github.com/apache/kafka/blob/9c77c17c4eae19af743e551e8e7d8b49b07c4e99/core/src/main/scala/kafka/server/KafkaRequestHandler.scala#L154&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/9c77c17c4eae19af743e551e8e7d8b49b07c4e99/core/src/main/scala/kafka/server/KafkaRequestHandler.scala#L154&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;4&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://github.com/apache/kafka/blob/526d0f63b5d82f8fb50c97aea9c61f8f85467e92/core/src/main/scala/kafka/server/ReplicaManager.scala#L874&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/526d0f63b5d82f8fb50c97aea9c61f8f85467e92/core/src/main/scala/kafka/server/ReplicaManager.scala#L874&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;5&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://docs.oracle.com/javase/8/docs/api/java/lang/ThreadLocal.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://docs.oracle.com/javase/8/docs/api/java/lang/ThreadLocal.html&lt;/a&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17778655" author="ijuma" created="Mon, 23 Oct 2023 13:07:38 +0000"  >&lt;p&gt;Good catch. I think we should review the design of this change in closer detail to understand the full implications - is the buffer supplier the only issue or are there others? The assumption is that anything that is executed in a different thread would have to ensure thread-safety, etc.&lt;/p&gt;</comment>
                            <comment id="17778709" author="jolshan" created="Mon, 23 Oct 2023 15:18:30 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=divijvaidya&quot; class=&quot;user-hover&quot; rel=&quot;divijvaidya&quot;&gt;divijvaidya&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ijuma&quot; class=&quot;user-hover&quot; rel=&quot;ijuma&quot;&gt;ijuma&lt;/a&gt; for looking at this. I am also investigating now.&lt;/p&gt;

&lt;p&gt;For folks who are affected by this issue, disabling verification either by static config + rolling or dynamically should stop the issue.&lt;/p&gt;

&lt;p&gt;{{transaction.partition.verification.enable=false&lt;/p&gt;

&lt;p&gt;}}&lt;/p&gt;

&lt;p&gt;Just for clarification, the AddPartitionsToTxn code was not added until 3.6 since the 3.5 version was reverted (&lt;a href=&quot;https://github.com/apache/kafka/commit/928070e3206867fa81bafbb138373bcb0e2ba962)&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/commit/928070e3206867fa81bafbb138373bcb0e2ba962)&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;However, there was some other way to access the bug in 3.5? I will work in the background to resolve this, but was a little bit confused about that part.&#160;&lt;/p&gt;</comment>
                            <comment id="17778721" author="divijvaidya" created="Mon, 23 Oct 2023 16:02:16 +0000"  >&lt;p&gt;&amp;gt; However, there was some other way to access the bug in 3.5? I will work in the background to resolve this, but was a little bit confused about that part.&#160;&lt;/p&gt;

&lt;p&gt;My assumption that the bug is present in 3.5 was based on the 3.5 tag associated with the original commit. I missed the part that it has been reverted. Given that, I don&apos;t think 3.5 is impacted and neither does the reproducer suggest so.&lt;/p&gt;

&lt;p&gt;I will not get to work on the fix at least this week. So I will move this Jira to unassigned. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jolshan&quot; class=&quot;user-hover&quot; rel=&quot;jolshan&quot;&gt;jolshan&lt;/a&gt; please feel free to pick up if you are working on this. &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=twmb&quot; class=&quot;user-hover&quot; rel=&quot;twmb&quot;&gt;twmb&lt;/a&gt;, would you like to verify the workaround that Justine mentioned above and see if that unblocks you? Once we are sure about the workaround, we can find a way to communicate it to the broader community&#160;until a fix is in place.&lt;/p&gt;


&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17778827" author="twmb" created="Mon, 23 Oct 2023 20:57:41 +0000"  >&lt;p&gt;I&apos;ve loop tested this a few times at this point, and so far the configuration option `transaction.partition.verification.enable=false` prevents test failures. I&apos;m going to go ahead and close &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-15657&quot; title=&quot;Unexpected errors when producing transactionally in 3.6&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-15657&quot;&gt;&lt;del&gt;KAFKA-15657&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-15656&quot; title=&quot;Frequent INVALID_RECORD on Kafka 3.6&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-15656&quot;&gt;&lt;del&gt;KAFKA-15656&lt;/del&gt;&lt;/a&gt; which both seem like different manifestations of this issue.&lt;/p&gt;</comment>
                            <comment id="17778831" author="jolshan" created="Mon, 23 Oct 2023 21:10:34 +0000"  >&lt;p&gt;I will definitely work on this &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=divijvaidya&quot; class=&quot;user-hover&quot; rel=&quot;divijvaidya&quot;&gt;divijvaidya&lt;/a&gt;.&lt;br/&gt;
I plan on moving the method appendEntries out and supplying the correct requestLocal in the callback.&lt;/p&gt;

&lt;p&gt;I am also filing a new Jira to address the requestLocal&apos;s future, since this mistake was easy to make.&#160;&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-15674&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-15674&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17779000" author="divijvaidya" created="Tue, 24 Oct 2023 09:12:35 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jolshan&quot; class=&quot;user-hover&quot; rel=&quot;jolshan&quot;&gt;jolshan&lt;/a&gt; . I will add my thoughts on how to prevent this in future the new Jira you started. As a summary, I think we might want to start working towards a &quot;debug&quot; mode in the broker which will enable assertions for different invariants in Kafka. Invariants could be derived from formal verification that Jack and others have shared with the community earlier OR from tribal knowledge in the community such as network threads should not perform any storage IO. The release qualification will run the broker in &quot;debug&quot; mode and will validate these assertions while running different series of tests.&#160;&lt;/p&gt;

&lt;p&gt;EDIT - I started a thread in dev mailing list to solicit ideas on detecting &amp;amp; preventing hard bugs &lt;a href=&quot;https://lists.apache.org/thread/zjcyp4h9kkl3gjfblgcwodf2y8oyy0hj&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://lists.apache.org/thread/zjcyp4h9kkl3gjfblgcwodf2y8oyy0hj&lt;/a&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17780567" author="githubbot" created="Sat, 28 Oct 2023 00:19:28 +0000"  >&lt;p&gt;jolshan opened a new pull request, #564:&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka-site/pull/564&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka-site/pull/564&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;   &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-15653&quot; title=&quot;NPE in ChunkedByteStream&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-15653&quot;&gt;&lt;del&gt;KAFKA-15653&lt;/del&gt;&lt;/a&gt; can be painful for folks with compression. Adding a note about the issue and how to mitigate it.&lt;/p&gt;

</comment>
                            <comment id="17780569" author="githubbot" created="Sat, 28 Oct 2023 00:27:14 +0000"  >&lt;p&gt;ijuma commented on code in PR #564:&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka-site/pull/564#discussion_r1375131837&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka-site/pull/564#discussion_r1375131837&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;##########&lt;br/&gt;
36/upgrade.html:&lt;br/&gt;
##########&lt;br/&gt;
@@ -116,6 +116,12 @@ &amp;lt;h5&amp;gt;&amp;lt;a id=&quot;upgrade_360_notable&quot; href=&quot;#upgrade_360_notable&quot;&amp;gt;Notable changes in 3&lt;br/&gt;
             For more information about the early access tiered storage feature, please check &amp;lt;a href=&quot;https://cwiki.apache.org/confluence/display/KAFKA/KIP-405%3A+Kafka+Tiered+Storage&quot;&amp;gt;KIP-405&amp;lt;/a&amp;gt; and&lt;br/&gt;
             &amp;lt;a href=&quot;https://cwiki.apache.org/confluence/display/KAFKA/Kafka+Tiered+Storage+Early+Access+Release+Notes&quot;&amp;gt;Tiered Storage Early Access Release Note&amp;lt;/a&amp;gt;.&lt;br/&gt;
         &amp;lt;/li&amp;gt;&lt;br/&gt;
+        &amp;lt;li&amp;gt;Transaction partition verification (&amp;lt;a href=&quot;https://cwiki.apache.org/confluence/display/KAFKA/KIP-890%3A+Transactions+Server-Side+Defense&quot;&amp;gt;KIP-890&amp;lt;/a&amp;gt;)&lt;br/&gt;
+            has been added to data partitions to prevent hanging transactions. Workloads with compression can experience InvalidRecordExceptions and UnknownServerExceptions.&lt;br/&gt;
+            For workloads with compression, &amp;lt;code&amp;gt;transaction.partition.verification.enable&amp;lt;/code&amp;gt; should be set to false. Note that the default for 3.6 is true.&lt;/p&gt;

&lt;p&gt;Review Comment:&lt;br/&gt;
   I&apos;d just say &quot;This feature can be disabled by setting...&quot; (instead of &quot;For workloads with compression...&quot;.&lt;/p&gt;



&lt;p&gt;##########&lt;br/&gt;
36/upgrade.html:&lt;br/&gt;
##########&lt;br/&gt;
@@ -116,6 +116,12 @@ &amp;lt;h5&amp;gt;&amp;lt;a id=&quot;upgrade_360_notable&quot; href=&quot;#upgrade_360_notable&quot;&amp;gt;Notable changes in 3&lt;br/&gt;
             For more information about the early access tiered storage feature, please check &amp;lt;a href=&quot;https://cwiki.apache.org/confluence/display/KAFKA/KIP-405%3A+Kafka+Tiered+Storage&quot;&amp;gt;KIP-405&amp;lt;/a&amp;gt; and&lt;br/&gt;
             &amp;lt;a href=&quot;https://cwiki.apache.org/confluence/display/KAFKA/Kafka+Tiered+Storage+Early+Access+Release+Notes&quot;&amp;gt;Tiered Storage Early Access Release Note&amp;lt;/a&amp;gt;.&lt;br/&gt;
         &amp;lt;/li&amp;gt;&lt;br/&gt;
+        &amp;lt;li&amp;gt;Transaction partition verification (&amp;lt;a href=&quot;https://cwiki.apache.org/confluence/display/KAFKA/KIP-890%3A+Transactions+Server-Side+Defense&quot;&amp;gt;KIP-890&amp;lt;/a&amp;gt;)&lt;br/&gt;
+            has been added to data partitions to prevent hanging transactions. Workloads with compression can experience InvalidRecordExceptions and UnknownServerExceptions.&lt;br/&gt;
+            For workloads with compression, &amp;lt;code&amp;gt;transaction.partition.verification.enable&amp;lt;/code&amp;gt; should be set to false. Note that the default for 3.6 is true.&lt;br/&gt;
+            The configuration can also be updated dynamically and is applied to the broker.&lt;br/&gt;
+            This will be fixed in a future release. See &amp;lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-15653&quot;&amp;gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-15653&quot; title=&quot;NPE in ChunkedByteStream&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-15653&quot;&gt;&lt;del&gt;KAFKA-15653&lt;/del&gt;&lt;/a&gt;&amp;lt;/a&amp;gt; for more details.&lt;/p&gt;

&lt;p&gt;Review Comment:&lt;br/&gt;
   Can we say it will be fixed in 3.6.1?.&lt;/p&gt;


</comment>
                            <comment id="17781095" author="githubbot" created="Mon, 30 Oct 2023 19:03:06 +0000"  >&lt;p&gt;jolshan merged PR #564:&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka-site/pull/564&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka-site/pull/564&lt;/a&gt;&lt;/p&gt;

</comment>
                            <comment id="17781286" author="divijvaidya" created="Tue, 31 Oct 2023 09:34:10 +0000"  >&lt;p&gt;Our existing tests in Apache Kafka missed catching this bug. Creating a ticket at &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-15764&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-15764&lt;/a&gt; to bolster our test suite and fill the missing gap.&lt;/p&gt;</comment>
                            <comment id="17786206" author="hcai@pinterest.com" created="Wed, 15 Nov 2023 07:42:55 +0000"  >&lt;p&gt;Is this Jira resolved?&#160; I saw all the three linked PRs are merged in already.&lt;/p&gt;</comment>
                            <comment id="17786338" author="jolshan" created="Wed, 15 Nov 2023 12:39:52 +0000"  >&lt;p&gt;Yes. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hcai%40pinterest.com&quot; class=&quot;user-hover&quot; rel=&quot;hcai@pinterest.com&quot;&gt;hcai@pinterest.com&lt;/a&gt; this is resolved. &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-15784&quot; title=&quot;Ensure atomicity of in memory update and write when transactionally committing offsets&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-15784&quot;&gt;&lt;del&gt;KAFKA-15784&lt;/del&gt;&lt;/a&gt; which was discovered while working on this is still open, but I&apos;m working on it.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310361">
                    <name>Blocked</name>
                                            <outwardlinks description="Blocked">
                                        <issuelink>
            <issuekey id="13559972">KAFKA-15947</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13556211">KAFKA-15764</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13063753" name="repro.sh" size="4250" author="twmb" created="Fri, 20 Oct 2023 15:44:37 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 51 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1l2ps:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>