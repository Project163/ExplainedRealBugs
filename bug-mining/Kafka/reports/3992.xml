<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:41:03 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-17954] Error getting oldest-iterator-open-since-ms from JMX</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-17954</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;In &lt;a href=&quot;https://cwiki.apache.org/confluence/display/KAFKA/KIP-989%3A+Improved+StateStore+Iterator+metrics+for+detecting+leaks&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;KIP-989&lt;/a&gt; we introduced a new metric, &lt;tt&gt;oldest-iterator-open-since-ms&lt;/tt&gt;, which reports the timestamp that the oldest currently open KeyValueIterator was opened at.&lt;/p&gt;

&lt;p&gt;On-scrape, we sometimes see this &lt;tt&gt;WARN&lt;/tt&gt; log message:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Error getting JMX attribute &apos;oldest-iterator-open-since-ms&apos;
java.util.NoSuchElementException
at&#160;java.base/java.util.concurrent.ConcurrentSkipListMap.firstKey(ConcurrentSkipListMap.java:1859)
at&#160;java.base/java.util.concurrent.ConcurrentSkipListSet.first(ConcurrentSkipListSet.java:396)
at&#160;org.apache.kafka.streams.state.internals.MeteredKeyValueStore.lambda$registerMetrics$5(MeteredKeyValueStore.java:179)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;del&gt;However, if no iterators are currently open, this Gauge returns &lt;tt&gt;null&lt;/tt&gt;.&lt;/del&gt;&lt;/p&gt;

&lt;p&gt;&lt;del&gt;When using the Prometheus &lt;tt&gt;JmxScraper&lt;/tt&gt; to scrape this metric, its value is added to a &lt;tt&gt;ConcurrentHashMap&lt;/tt&gt;, which does &lt;em&gt;not&lt;/em&gt; permit &lt;tt&gt;null&lt;/tt&gt; values.&lt;/del&gt;&lt;/p&gt;

&lt;p&gt;&lt;del&gt;We should find some other way to report the absence of this metric that does not cause problems with &lt;tt&gt;ConcurrentHashMap&lt;/tt&gt;.&lt;/del&gt;&lt;/p&gt;

&lt;p&gt;My initial analysis was incorrect. The problem appears to be caused by the &lt;tt&gt;openIterators&lt;/tt&gt; Set in &lt;tt&gt;MeteredKeyValueStore&lt;/tt&gt;:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;  &#160; protected NavigableSet&amp;lt;MeteredIterator&amp;gt; openIterators = new ConcurrentSkipListSet&amp;lt;&amp;gt;(Comparator.comparingLong(MeteredIterator::startTimestamp)); &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This is used by the Gauge to report the metric:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;openIterators.isEmpty() ? null : openIterators.first().startTimestamp() &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The source of the exception is the right-hand side of this ternary expression, specifically &lt;tt&gt;openIterators.first()&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;The condition of this expression should ensure that there is at least one element to retrieve by the right-hand side.&#160;&lt;b&gt;However, if the last Iterator is removed from this Set concurrently to the Gauge being reported, after the emptiness check, but before retrieving the element, we can throw the above exception here.&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;This can happen because interactive queries and stream threads operate concurrently from the thread that reads the Gauge to report metrics.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13597978">KAFKA-17954</key>
            <summary>Error getting oldest-iterator-open-since-ms from JMX</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="nicktelford">Nicholas Telford</assignee>
                                    <reporter username="nicktelford">Nicholas Telford</reporter>
                        <labels>
                    </labels>
                <created>Wed, 6 Nov 2024 21:57:20 +0000</created>
                <updated>Wed, 10 Sep 2025 01:03:11 +0000</updated>
                            <resolved>Tue, 19 Nov 2024 05:59:16 +0000</resolved>
                                    <version>3.8.0</version>
                                    <fixVersion>3.8.2</fixVersion>
                    <fixVersion>3.9.1</fixVersion>
                    <fixVersion>4.0.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17896110" author="mjsax" created="Wed, 6 Nov 2024 23:25:59 +0000"  >&lt;p&gt;Seem it would be simple to change from `null` to `0` (or `-1`) ?&lt;/p&gt;</comment>
                            <comment id="17896309" author="nicktelford" created="Thu, 7 Nov 2024 13:12:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mjsax&quot; class=&quot;user-hover&quot; rel=&quot;mjsax&quot;&gt;mjsax&lt;/a&gt; actually it looks like my initial analysis was wrong. This is actually just a concurrency issue. I&apos;ve updated the description with the new RCA.&lt;/p&gt;</comment>
                            <comment id="17896313" author="nicktelford" created="Thu, 7 Nov 2024 13:27:02 +0000"  >&lt;p&gt;Simple fix: catch the &lt;tt&gt;NoSuchElementException&lt;/tt&gt;! &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/biggrin.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13606948">KAFKA-18689</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13620593">KAFKA-19398</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1sf88:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>