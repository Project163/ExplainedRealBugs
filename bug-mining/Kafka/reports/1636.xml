<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:03:24 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-5152] Kafka Streams keeps restoring state after shutdown is initiated during startup</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-5152</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;If streams shutdown is initiated during state restore (e.g. an uncaught exception is thrown) streams will not shut down until all stores are first finished restoring.&lt;/p&gt;

&lt;p&gt;As restore progresses, stream threads appear to be taken out of service as part of the shutdown sequence, causing rebalancing of tasks. This compounds the problem by slowing down the restore process even further, since the remaining threads now have to also restore the reassigned tasks before they can shut down.&lt;/p&gt;

&lt;p&gt;A more severe issue is that if there is a new rebalance triggered during the end of the waitingSync phase (e.g. due to a new member joining the group, or some members timed out the SyncGroup response), then some consumer clients of the group may already proceed with the &lt;tt&gt;onPartitionsAssigned&lt;/tt&gt; and blocked on trying to grab the file dir lock not yet released from other clients, while the other clients holding the lock are consistently re-sending &lt;tt&gt;JoinGroup&lt;/tt&gt; requests while the rebalance cannot be completed because the clients blocked on the file dir lock will not be kicked out of the group as its heartbeat thread has been consistently sending HBRequest. Hence this is a deadlock caused by not releasing the file dir locks in task suspension.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13068320">KAFKA-5152</key>
            <summary>Kafka Streams keeps restoring state after shutdown is initiated during startup</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="damianguy">Damian Guy</assignee>
                                    <reporter username="xvrl">Xavier L&#233;aut&#233;</reporter>
                        <labels>
                    </labels>
                <created>Tue, 2 May 2017 04:58:47 +0000</created>
                <updated>Fri, 1 Mar 2019 22:42:45 +0000</updated>
                            <resolved>Tue, 22 Aug 2017 18:13:44 +0000</resolved>
                                    <version>0.10.2.1</version>
                                    <fixVersion>0.11.0.1</fixVersion>
                    <fixVersion>1.0.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="16001300" author="guozhang" created="Mon, 8 May 2017 18:36:55 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xvrl&quot; class=&quot;user-hover&quot; rel=&quot;xvrl&quot;&gt;xvrl&lt;/a&gt; for reporting this issue. I think it is contributed from two issues:&lt;/p&gt;

&lt;p&gt;1. When an instance is shutdown, we should be able to interrupt the current on-going restoration process and let it close asap. We can consider adding this support.&lt;/p&gt;

&lt;p&gt;2. When the whole app is shutting down, some instances / threads may exit earlier than others. In this case we&apos;d prefer not triggering more rebalances among the rest of the late threads going through the shutdown process. This has been (hopefully) addressed in &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-4881&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-4881&lt;/a&gt;, in which the exiting consumer will not send the exit group request to coordinator, and hence it will not immediately marked as dead and trigger a rebalance.&lt;/p&gt;</comment>
                            <comment id="16092330" author="guozhang" created="Tue, 18 Jul 2017 23:31:03 +0000"  >&lt;p&gt;Here are a couple alternative solutions to resolve this issue:&lt;/p&gt;

&lt;p&gt;1. Revert the task-suspension optimization, this is the worst-case solution we can get to work around it.&lt;/p&gt;

&lt;p&gt;2. Move the restoration process completely out of the &lt;tt&gt;onPartitionsAssigned&lt;/tt&gt; callback, in the thread&apos;s main while loop. More specifically the workflow of the thread will be:&lt;/p&gt;

&lt;p&gt;a) only create the active / standby tasks without executing the restoration of states on the active tasks; release the dir file locks in &lt;tt&gt;onPartitionAssigned&lt;/tt&gt; for those suspended-and-not-reassigned tasks. Mark all the created active tasks as not-ready first and pause all these task&apos;s corresponding source topic-partitions.&lt;/p&gt;

&lt;p&gt;b) whose state has not been restored up to date (for those suspended-and-reassigned tasks double check that the they should not be included since their state should be up-to-date)&lt;/p&gt;

&lt;p&gt;b) in the main loop:&lt;/p&gt;

&lt;p&gt;b.1) check for all the not-ready tasks and see if their stores have completed restoration (restored offset = logend offset), if yes mark these tasks as active now and resume their corresponding source topic-partitions.&lt;/p&gt;

&lt;p&gt;b.2) process / punctuate / commit if possible for active tasks which have already some records fetched.&lt;/p&gt;

&lt;p&gt;b.3) restore the state for both standby tasks and active-not-ready tasks.&lt;/p&gt;

&lt;p&gt;One thing needed for care though, is that since now tasks within the same thread can start processing at different time, but for IQ we still need to only make the instance / thread as RUNNING after all its tasks are now running.&lt;/p&gt;</comment>
                            <comment id="16110017" author="githubbot" created="Wed, 2 Aug 2017 00:10:18 +0000"  >&lt;p&gt;GitHub user guozhangwang opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/3607&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3607&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;span class=&quot;error&quot;&gt;&amp;#91;DO NOT MERGE&amp;#93;&lt;/span&gt; Existing StreamThread exception handling issues&lt;/p&gt;

&lt;p&gt;    This is for @dguy as a reference while working on the first step of &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5152&quot; title=&quot;Kafka Streams keeps restoring state after shutdown is initiated during startup&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-5152&quot;&gt;&lt;del&gt;KAFKA-5152&lt;/del&gt;&lt;/a&gt;, as a list of existing issues that need to be address at stream thread layer.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/guozhangwang/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/guozhangwang/kafka&lt;/a&gt; KMinor-stream-thread-exception-handling&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/3607.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3607.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #3607&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 2d45430191c3dc417992c08454f9c550c1e6bb93&lt;br/&gt;
Author: Guozhang Wang &amp;lt;wangguoz@gmail.com&amp;gt;&lt;br/&gt;
Date:   2017-07-25T22:43:18Z&lt;/p&gt;

&lt;p&gt;    handle commit failed exception on stream thread&lt;/p&gt;

&lt;p&gt;commit 9655791794dfa2623ba9f109676b112779fdceca&lt;br/&gt;
Author: Guozhang Wang &amp;lt;wangguoz@gmail.com&amp;gt;&lt;br/&gt;
Date:   2017-07-26T00:39:07Z&lt;/p&gt;

&lt;p&gt;    minor fixes&lt;/p&gt;

&lt;p&gt;commit 26226d61529007acc0ccc151e6f6675fc9757d34&lt;br/&gt;
Author: Guozhang Wang &amp;lt;wangguoz@gmail.com&amp;gt;&lt;br/&gt;
Date:   2017-07-26T01:01:57Z&lt;/p&gt;

&lt;p&gt;    add a bunch of TODOs for exception handling&lt;/p&gt;

&lt;p&gt;commit 3b054f556364be04d7f83a40b212e0c7facc4a23&lt;br/&gt;
Author: Guozhang Wang &amp;lt;wangguoz@gmail.com&amp;gt;&lt;br/&gt;
Date:   2017-07-27T22:09:43Z&lt;/p&gt;

&lt;p&gt;    rebase from trunk&lt;/p&gt;

&lt;p&gt;commit 4b0f4f9cb30537fd0b45b192e2a5d81005ffa3c5&lt;br/&gt;
Author: Guozhang Wang &amp;lt;wangguoz@gmail.com&amp;gt;&lt;br/&gt;
Date:   2017-07-27T22:26:46Z&lt;/p&gt;

&lt;p&gt;    minor fixes&lt;/p&gt;

&lt;p&gt;commit 5d2dffa72443139909d3e28f1684363a6e6f5585&lt;br/&gt;
Author: Guozhang Wang &amp;lt;wangguoz@gmail.com&amp;gt;&lt;br/&gt;
Date:   2017-07-27T22:29:39Z&lt;/p&gt;

&lt;p&gt;    github comments&lt;/p&gt;

&lt;p&gt;commit 41ba5721ec9fe88b91416621a6236794d37a74de&lt;br/&gt;
Author: Guozhang Wang &amp;lt;wangguoz@gmail.com&amp;gt;&lt;br/&gt;
Date:   2017-08-02T00:08:13Z&lt;/p&gt;

&lt;p&gt;    rebase from trunk&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16121510" author="githubbot" created="Thu, 10 Aug 2017 11:46:33 +0000"  >&lt;p&gt;GitHub user dguy opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/3653&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3653&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5152&quot; title=&quot;Kafka Streams keeps restoring state after shutdown is initiated during startup&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-5152&quot;&gt;&lt;del&gt;KAFKA-5152&lt;/del&gt;&lt;/a&gt;: move state restoration out of rebalance and into poll loop&lt;/p&gt;

&lt;p&gt;    In `onPartitionsAssigned`: &lt;br/&gt;
    1. release all locks for non-assigned suspended tasks.&lt;br/&gt;
    2. resume any suspended tasks.&lt;br/&gt;
    3. Create new tasks, but don&apos;t attempt to take the state lock.&lt;br/&gt;
    4. Pause partitions for any new tasks.&lt;br/&gt;
    5. set the state to `PARTITIONS_ASSIGNED`&lt;/p&gt;

&lt;p&gt;    In `StreamThread#runLoop`&lt;br/&gt;
    1. poll&lt;br/&gt;
    2. if state is `PARTITIONS_ASSIGNED`&lt;br/&gt;
     2.1  attempt to initialize any new tasks, i.e, take out the state locks and init state stores&lt;br/&gt;
     2.2 restore some data for changelogs, i.e., poll once on the restore consumer and return the partitions that have been fully restored&lt;br/&gt;
     2.3 update tasks with restored partitions and move any that have completed restoration to running&lt;br/&gt;
     2.4 resume consumption for any tasks where all partitions have been restored.&lt;br/&gt;
     2.5 if all active tasks are running, transition to `RUNNING` and assign standby partitions to the restoreConsumer.&lt;/p&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/dguy/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/dguy/kafka&lt;/a&gt; 0.11.0-restore-on-poll&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/3653.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3653.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #3653&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 27016b9e9706ee95bcedd9a1408c71e62a0f178e&lt;br/&gt;
Author: Damian Guy &amp;lt;damian.guy@gmail.com&amp;gt;&lt;br/&gt;
Date:   2017-08-09T19:02:17Z&lt;/p&gt;

&lt;p&gt;    restore state on the poll loop&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16128595" author="githubbot" created="Wed, 16 Aug 2017 10:14:37 +0000"  >&lt;p&gt;Github user dguy closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/3653&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3653&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16128797" author="githubbot" created="Wed, 16 Aug 2017 13:28:29 +0000"  >&lt;p&gt;GitHub user dguy opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/3675&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3675&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5152&quot; title=&quot;Kafka Streams keeps restoring state after shutdown is initiated during startup&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-5152&quot;&gt;&lt;del&gt;KAFKA-5152&lt;/del&gt;&lt;/a&gt;: perform state restoration in poll loop&lt;/p&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/dguy/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/dguy/kafka&lt;/a&gt; kafka-5152&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/3675.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3675.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #3675&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 4da235927f9eebf2442533b44bf017454d372747&lt;br/&gt;
Author: Damian Guy &amp;lt;damian.guy@gmail.com&amp;gt;&lt;br/&gt;
Date:   2017-08-14T17:23:53Z&lt;/p&gt;

&lt;p&gt;    perform state restoration in poll loop&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16137132" author="guozhang" created="Tue, 22 Aug 2017 18:13:44 +0000"  >&lt;p&gt;Issue resolved by pull request 3675&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/kafka/pull/3675&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3675&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16137135" author="githubbot" created="Tue, 22 Aug 2017 18:14:39 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/3675&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3675&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16193865" author="githubbot" created="Thu, 5 Oct 2017 22:49:00 +0000"  >&lt;p&gt;Github user guozhangwang closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/3607&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3607&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310060">
                    <name>Container</name>
                                            <outwardlinks description="contains">
                                        <issuelink>
            <issuekey id="12977909">KAFKA-3826</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13072043">KAFKA-5242</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                                                <inwardlinks description="is depended upon by">
                                        <issuelink>
            <issuekey id="13083742">KAFKA-5545</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 6 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3ecjr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>