<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:00:52 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-5055] Kafka Streams skipped-records-rate sensor producing nonzero values even when FailOnInvalidTimestamp is used as extractor</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-5055</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;According to the code and the documentation for this metric, the only reason for a skipped record is an invalid timestamp, except that a) I am reading from a topic that is populated solely by Kafka Connect and b) I am using `FailOnInvalidTimestamp` as the timestamp extractor.&lt;/p&gt;

&lt;p&gt;Either I&apos;m missing something in the documentation (i.e. another reason for skipped records) or there is a bug in the code that calculates this metric.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13063296">KAFKA-5055</key>
            <summary>Kafka Streams skipped-records-rate sensor producing nonzero values even when FailOnInvalidTimestamp is used as extractor</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dpoldrugo">Davor Poldrugo</assignee>
                                    <reporter username="nthean">Nikki Thean</reporter>
                        <labels>
                    </labels>
                <created>Tue, 11 Apr 2017 19:40:26 +0000</created>
                <updated>Wed, 3 May 2017 21:20:32 +0000</updated>
                            <resolved>Wed, 3 May 2017 21:19:40 +0000</resolved>
                                                    <fixVersion>0.11.0.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="15975899" author="guozhang" created="Thu, 20 Apr 2017 01:35:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nthean&quot; class=&quot;user-hover&quot; rel=&quot;nthean&quot;&gt;nthean&lt;/a&gt; Thanks for reporting this. Could you share your full streams config properties in this ticket? Also what&apos;s the non-zero value you observed on &lt;tt&gt;skipped-records-rate&lt;/tt&gt;?&lt;/p&gt;</comment>
                            <comment id="15979433" author="nthean" created="Fri, 21 Apr 2017 21:37:49 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; Sure. Streams config properties were &lt;a href=&quot;https://gist.github.com/nixsticks/ccbfdbb6141e0f7362cef53d9e39d39b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gist.github.com/nixsticks/ccbfdbb6141e0f7362cef53d9e39d39b&lt;/a&gt;. &lt;/p&gt;

&lt;p&gt;The nonzero value &amp;#8211; it depends. I have a topic that receives billions of records per day, not sure how many per second. The nonzero value tends to be very low when the lag is high (when I start reading the topic at earliest offset), and then rises to about 400 once I am consuming recent records.&lt;/p&gt;</comment>
                            <comment id="15981662" author="guozhang" created="Mon, 24 Apr 2017 18:47:16 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nthean&quot; class=&quot;user-hover&quot; rel=&quot;nthean&quot;&gt;nthean&lt;/a&gt;, looking into it now.&lt;/p&gt;</comment>
                            <comment id="15990086" author="dpoldrugo" created="Sun, 30 Apr 2017 01:18:22 +0000"  >&lt;p&gt;Hi guys!&lt;br/&gt;
I think the problem is because of a bug in the method &lt;tt&gt;org.apache.kafka.streams.processor.internals.StreamTask#addRecords&lt;/tt&gt;:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; addRecords(TopicPartition partition, Iterable&amp;lt;ConsumerRecord&amp;lt;&lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[], &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[]&amp;gt;&amp;gt; records) {
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; oldQueueSize = partitionGroup.numBuffered();
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; newQueueSize = partitionGroup.addRawRecords(partition, records);

        log.trace(&lt;span class=&quot;code-quote&quot;&gt;&quot;{} Added records into the buffered queue of partition {}, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; queue size is {}&quot;&lt;/span&gt;, logPrefix, partition, newQueueSize);

        &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; after adding these records, its partition queue&apos;s buffered size has been
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// increased beyond the threshold, we can then pause the consumption &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; partition
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (newQueueSize &amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.maxBufferedSize) {
            consumer.pause(singleton(partition));
        }

        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; newQueueSize - oldQueueSize;
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This line is the problem:&lt;br/&gt;
&lt;tt&gt;final int oldQueueSize = partitionGroup.numBuffered();&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;Instead of getting &lt;tt&gt;oldQueueSize&lt;/tt&gt; for current TopicPartition it gets queue size for all the partitions, because &lt;tt&gt;partitionGroup.numBuffered()&lt;/tt&gt; returns the queue size across all partitions.&lt;/p&gt;

&lt;p&gt;Then &lt;tt&gt;return newQueueSize - oldQueueSize&lt;/tt&gt; returns a negative value. Because it&apos;s more probable that the sum of all Queue sizes across partitions is bigger then the Queue size of this partition.&lt;/p&gt;

&lt;p&gt;This goes back to &lt;tt&gt;org.apache.kafka.streams.processor.internals.StreamThread#runLoop&lt;/tt&gt;:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (TopicPartition partition : records.partitions()) {
    StreamTask task = activeTasksByPartition.get(partition);
    numAddedRecords += task.addRecords(partition, records.records(partition));
}
streamsMetrics.skippedRecordsSensor.record(records.count() - numAddedRecords, timerStartedMs);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;There it gets summed into &lt;tt&gt;numAddedRecords&lt;/tt&gt; - by actually decreasing the value (because it&apos;s negative), and this leads to wrong sensor value in &lt;tt&gt;records.count() - numAddedRecords&lt;/tt&gt;, because &lt;tt&gt;numAddedRecords&lt;/tt&gt; is now smaller because of a bug, not because of an invalid timestamp.&lt;/p&gt;

&lt;p&gt;BugFix proposal:&lt;br/&gt;
In the method &lt;tt&gt;org.apache.kafka.streams.processor.internals.StreamTask#addRecords&lt;/tt&gt;&lt;br/&gt;
change:&lt;br/&gt;
&lt;tt&gt;final int oldQueueSize = partitionGroup.numBuffered();&lt;/tt&gt;&lt;br/&gt;
to&lt;br/&gt;
&lt;tt&gt;final int oldQueueSize = partitionGroup.numBuffered(partition);&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;If this is the cause of the bug, can I do a pull request?&lt;/p&gt;</comment>
                            <comment id="15990126" author="mjsax" created="Sun, 30 Apr 2017 05:06:26 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dpoldrugo&quot; class=&quot;user-hover&quot; rel=&quot;dpoldrugo&quot;&gt;dpoldrugo&lt;/a&gt; Thanks a lot for looking into this. I agree that this is the bug we are looking for (it was my guess anyway, that the reported value is just not correct.&lt;/p&gt;

&lt;p&gt;Please go ahead with the PR.&lt;/p&gt;</comment>
                            <comment id="15990127" author="mjsax" created="Sun, 30 Apr 2017 05:07:39 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; Can you add Davor to the contributor list, so we can assign this JIRA to him. Thx.&lt;/p&gt;</comment>
                            <comment id="15990377" author="githubbot" created="Sun, 30 Apr 2017 21:15:24 +0000"  >&lt;p&gt;GitHub user dpoldrugo opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/2949&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2949&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5055&quot; title=&quot;Kafka Streams skipped-records-rate sensor producing nonzero values even when FailOnInvalidTimestamp is used as extractor&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-5055&quot;&gt;&lt;del&gt;KAFKA-5055&lt;/del&gt;&lt;/a&gt;: Kafka Streams skipped-records-rate sensor bug&lt;/p&gt;

&lt;p&gt;    Fix as described in the &lt;span class=&quot;error&quot;&gt;&amp;#91;KAFKA-5055 Jira comment&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5055?focusedCommentId=15990086&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-15990086&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-5055?focusedCommentId=15990086&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-15990086&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;    @mjsax @guozhangwang take a look&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/dpoldrugo/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/dpoldrugo/kafka&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5055&quot; title=&quot;Kafka Streams skipped-records-rate sensor producing nonzero values even when FailOnInvalidTimestamp is used as extractor&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-5055&quot;&gt;&lt;del&gt;KAFKA-5055&lt;/del&gt;&lt;/a&gt;-skipped-records-rate-sensor-bug&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/2949.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2949.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #2949&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit a8768f4f4431c84880bec617f9c91b866fc003c7&lt;br/&gt;
Author: dpoldrugo &amp;lt;davor.poldrugo@infobip.com&amp;gt;&lt;br/&gt;
Date:   2017-04-30T20:48:36Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5055&quot; title=&quot;Kafka Streams skipped-records-rate sensor producing nonzero values even when FailOnInvalidTimestamp is used as extractor&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-5055&quot;&gt;&lt;del&gt;KAFKA-5055&lt;/del&gt;&lt;/a&gt; Kafka Streams skipped-records-rate sensor bug&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15991978" author="guozhang" created="Tue, 2 May 2017 01:58:12 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dpoldrugo&quot; class=&quot;user-hover&quot; rel=&quot;dpoldrugo&quot;&gt;dpoldrugo&lt;/a&gt; Thanks! Added.&lt;/p&gt;</comment>
                            <comment id="15995700" author="guozhang" created="Wed, 3 May 2017 21:19:40 +0000"  >&lt;p&gt;Issue resolved by pull request 2949&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/kafka/pull/2949&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2949&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15995701" author="githubbot" created="Wed, 3 May 2017 21:20:32 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/2949&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2949&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 28 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3di5j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>