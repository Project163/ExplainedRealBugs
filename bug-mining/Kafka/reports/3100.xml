<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:29:00 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-13249] Checkpoints do not contain latest offsets on shutdown when using EOS</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-13249</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;When using EOS the &lt;tt&gt;.checkpoint&lt;/tt&gt; file created when a stateful streams app is shutdown does not always contain changelog offsets which represent the latest state of the state store. The offsets can often be behind the end of the changelog - sometimes quite significantly.&lt;/p&gt;

&lt;p&gt;This leads to a state restore being required when the streams app restarts after shutting down cleanly as streams thinks (based on the incorrect offsets in the checkpoint) that the state store is not up to date with the changelog.&#160;&lt;/p&gt;

&lt;p&gt;This is increasing the time we see it takes to do a clean restart of a single instance streams app from around 10 second to sometime over 2 minutes in our case.&lt;/p&gt;

&lt;p&gt;I suspect the bug appears because an assumption about the &lt;tt&gt;commitNeeded&lt;/tt&gt;&#160;field in the following method in &lt;tt&gt;StreamTask&lt;/tt&gt;:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; void maybeWriteCheckpoint(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; enforceCheckpoint) {
  &lt;span class=&quot;code-comment&quot;&gt;// commitNeeded indicates we may have processed some records since last commit
&lt;/span&gt;  &lt;span class=&quot;code-comment&quot;&gt;// and hence we need to refresh checkpointable offsets regardless whether we should checkpoint or not
&lt;/span&gt;  &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (commitNeeded) {
    stateMgr.updateChangelogOffsets(checkpointableOffsets());
  }

  &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;.maybeWriteCheckpoint(enforceCheckpoint);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;In a steady state case for a simple single instance single thread stream app where an app simply starts, runs and then shuts down the &lt;tt&gt;if (commitNeeded)&lt;/tt&gt; test always fails when running with EOS which results in the latest checkpoint offsets never getting updated into the &lt;tt&gt;stateMgr&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Tracing back to the callers of &lt;tt&gt;maybeWriteCheckpoint&lt;/tt&gt; it&apos;s easy to see this is the case as there&apos;s only 1 place in the code which calls &lt;tt&gt;maybeWriteCheckpoint&lt;/tt&gt; during this steady state. The &lt;tt&gt;postCommit(final boolean enforceCheckpoint)&lt;/tt&gt; method, specifically the call in the &lt;tt&gt;RUNNING&lt;/tt&gt; state.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; RUNNING:
  &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (enforceCheckpoint || !eosEnabled) {
    maybeWriteCheckpoint(enforceCheckpoint);
  }
  log.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Finalized commit &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; {} task with eos {} enforce checkpoint {}&quot;&lt;/span&gt;, state(), eosEnabled, enforceCheckpoint);
  &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;We can see from this code that &lt;tt&gt;maybeWriteCheckpoint&lt;/tt&gt; will only ever to called if &lt;tt&gt;enforceCheckpoint=true&lt;/tt&gt; because we know &lt;tt&gt;eosEnabled=true&lt;/tt&gt; as we&apos;re running with EOS.&lt;/p&gt;

&lt;p&gt;So then where does &lt;tt&gt;postCommit&lt;/tt&gt; get called with &lt;tt&gt;enforceCheckpoint=true&lt;/tt&gt;? Again looking only at the steady state case we find that it&apos;s only called from &lt;tt&gt;TaskManager.tryCloseCleanAllActiveTasks&lt;/tt&gt; which is only called from &lt;tt&gt;TaskManager.shutdown&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;The thing about the call in &lt;tt&gt;tryCloseCleanAllActiveTasks&lt;/tt&gt; is that it happens &lt;b&gt;after&lt;/b&gt; all active tasks have commited. Which means that &lt;tt&gt;StreamTask.commitNeeded=false&lt;/tt&gt; for all tasks so it follows that the test back in &lt;tt&gt;maybeWriteCheckpoint&lt;/tt&gt; always fails and we don&apos;t end up getting the latest offsets stored into the state manager.&lt;/p&gt;

&lt;p&gt;I think the fix is to simply change the test in &lt;tt&gt;maybeWriteCheckpoint&lt;/tt&gt; to be &lt;tt&gt;if (commitNeeded || enforceCheckpoint) { ...&lt;/tt&gt; as we know we must always update the changelog offserts before we write the checkpoint.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13398060">KAFKA-13249</key>
            <summary>Checkpoints do not contain latest offsets on shutdown when using EOS</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hutchiko">Oliver Hutchison</assignee>
                                    <reporter username="hutchiko">Oliver Hutchison</reporter>
                        <labels>
                    </labels>
                <created>Sun, 29 Aug 2021 21:48:31 +0000</created>
                <updated>Thu, 30 Sep 2021 18:04:31 +0000</updated>
                            <resolved>Tue, 14 Sep 2021 23:12:14 +0000</resolved>
                                    <version>2.7.0</version>
                    <version>2.8.0</version>
                    <version>3.0.0</version>
                                    <fixVersion>2.8.2</fixVersion>
                    <fixVersion>3.0.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17406472" author="hutchiko" created="Sun, 29 Aug 2021 22:07:52 +0000"  >&lt;p&gt;I have created a PR with a test which shows this behaviour &lt;a href=&quot;https://github.com/apache/kafka/pull/11283&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/11283&lt;/a&gt; &lt;/p&gt;

&lt;p&gt;The test &lt;tt&gt;EosIntegrationTest.shouldWriteLatestOffsetsToCheckpointOnShutdown&lt;/tt&gt; verifies that the &lt;tt&gt;.checkpoint&lt;/tt&gt; file and the state store data are up to date with the changelog after shutdown. &lt;/p&gt;</comment>
                            <comment id="17406988" author="ableegoldman" created="Mon, 30 Aug 2021 23:03:37 +0000"  >&lt;p&gt;Thanks for the detailed report! I agree with your analysis, it does appear that we can end up writing stale offsets if the thread is shut down immediately following a &quot;normal&quot; commit that occurs during active processing. And given the small commit interval typical of EOS applications, we almost always perform this kind of commit before breaking out of the StreamThread&apos;s processing loop, meaning most of the time we will indeed have just committed all tasks when we get to checking the shutdown signal and entering&#160;&lt;tt&gt;TaskManager.shutdown()&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;I&apos;ll give your PR a pass &amp;#8211; thanks also for submitting a patch with the bug report &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&#160;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13370433">KAFKA-12634</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 11 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0ue0w:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>