<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:37:20 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-15834] Subscribing to non-existent topic blocks StreamThread from stopping</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-15834</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;In NamedTopologyIntegrationTest#shouldContinueProcessingOtherTopologiesWhenNewTopologyHasMissingInputTopics a topology is created which references an input topic which does not exist. The test as-written passes, but the KafkaStreams#close(Duration) at the end times out, and leaves StreamsThreads running.&lt;/p&gt;

&lt;p&gt;From some cursory investigation it appears that this is happening:&lt;br/&gt;
1. The consumer calls the StreamsPartitionAssignor, which calls TaskManager#handleRebalanceStart as a side-effect&lt;br/&gt;
2. handleRebalanceStart sets the rebalanceInProgress flag&lt;br/&gt;
3. This flag is checked by StreamThread.runLoop, and causes the loop to remain running.&lt;br/&gt;
4. The consumer never calls StreamsRebalanceListener#onPartitionsAssigned, because the topic does not exist&lt;br/&gt;
5. Because no partitions are ever assigned, the TaskManager#handleRebalanceComplete never clears the rebalanceInProgress flag&lt;br/&gt;
&#160;&lt;br/&gt;
This log message is printed in a tight loop while the close is ongoing and the consumer is being polled with zero duration:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[2023-11-15 11:42:43,661] WARN [Consumer clientId=NamedTopologyIntegrationTestshouldContinueProcessingOtherTopologiesWhenNewTopologyHasMissingInputTopics-942756f8-5213-4c44-bb6b-5f805884e026-StreamThread-1-consumer, groupId=NamedTopologyIntegrationTestshouldContinueProcessingOtherTopologiesWhenNewTopologyHasMissingInputTopics] Received unknown topic or partition error in fetch for partition unique_topic_prefix-topology-1-store-repartition-0 (org.apache.kafka.clients.consumer.internals.FetchCollector:321)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Practically, this means that this test leaks two StreamsThreads and the associated clients and sockets, and delays the completion of the test until the KafkaStreams#close(Duration) call times out.&lt;/p&gt;

&lt;p&gt;Either we should change the rebalanceInProgress flag to avoid getting stuck in this rebalance state, or figure out a way to shut down a StreamsThread that is in an extended rebalance state during shutdown.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13558120">KAFKA-15834</key>
            <summary>Subscribing to non-existent topic blocks StreamThread from stopping</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="gharris1727">Greg Harris</reporter>
                        <labels>
                    </labels>
                <created>Wed, 15 Nov 2023 20:02:05 +0000</created>
                <updated>Mon, 5 Feb 2024 19:39:50 +0000</updated>
                            <resolved>Tue, 16 Jan 2024 18:21:25 +0000</resolved>
                                    <version>3.6.0</version>
                                    <fixVersion>3.8.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17786564" author="mjsax" created="Thu, 16 Nov 2023 01:16:46 +0000"  >&lt;p&gt;Thank for reporting and such a detailed analysis, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gharris1727&quot; class=&quot;user-hover&quot; rel=&quot;gharris1727&quot;&gt;gharris1727&lt;/a&gt;!&#160;&lt;/p&gt;</comment>
                            <comment id="17787677" author="ableegoldman" created="Sun, 19 Nov 2023 22:16:02 +0000"  >&lt;p&gt;Yeah great analysis, thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gharris1727&quot; class=&quot;user-hover&quot; rel=&quot;gharris1727&quot;&gt;gharris1727&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;I&apos;m a bit confused by point #4, however &#8211; is this a change in behavior (possibly related to KIP-848)? It&apos;s my understanding that the #onPartitionsAssigned callback is guaranteed to always be invoked regardless of whether the set of partitions being newly assigned is non-empty or not. This is in contrast with the #onPartitionsRevoked and #onPartitionsLost callbacks, which are only invoked when the set of partitions to act upon is non-empty.&lt;/p&gt;

&lt;p&gt;I think one could argue that this inconsistency is not ideal, but the behavior of always invoking #onPartitionsAssigned is a stated guarantee in the public contract of ConsumerRebalanceListener. See &lt;a href=&quot;https://github.com/apache/kafka/blob/254335d24ab6b6d13142dcdb53fec3856c16de9e/clients/src/main/java/org/apache/kafka/clients/consumer/ConsumerRebalanceListener.java#L67&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this paragraph&lt;/a&gt; of the javadocs. In other words, I don&apos;t think we can change this without a KIP, and if this behavior was modified recently then we need to revert that change until a KIP is accepted.&lt;/p&gt;</comment>
                            <comment id="17787678" author="ableegoldman" created="Sun, 19 Nov 2023 22:19:53 +0000"  >&lt;p&gt;I just checked the current code and it looks like we do still respect the guarantee of invoking #onPartitionsAssigned in all cases. So I don&apos;t think step #4 is correct. Did you happen to see anything in the logs that would suggest the StreamThread was continuing in its regular loop and never stopping due to the rebalanceInProgress flag? Or is it possible that it&apos;s hanging somewhere in the shutdown process (or even in the rebalance itself)?&lt;/p&gt;

&lt;p&gt;I&apos;m just wondering if it might be related to the Producer, not the Consumer. I know we had some issues with the Producer#close hanging in the past, and that it was related to users deleting topics from under the app, which would be a similar situation to what you found here. I&apos;m not sure if we ever fixed that, maybe &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mjsax&quot; class=&quot;user-hover&quot; rel=&quot;mjsax&quot;&gt;mjsax&lt;/a&gt; will remember the ticket for the Producer issue?&lt;/p&gt;</comment>
                            <comment id="17787679" author="ableegoldman" created="Sun, 19 Nov 2023 22:34:45 +0000"  >&lt;p&gt;Found the ticket: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-9398&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-9398&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;And yes, it&apos;s still unresolved.&#160;&lt;/p&gt;

&lt;p&gt;Given all the above, I think we can honestly just disable/remove the test, as the named topologies feature was never made into a real public API. I do know of a few people who are using it anyway but they&apos;re aware it was only an experimental feature and not fully supported by Streams. So imo we don&apos;t need to go out of our way to fix any flaky tests: provided we can demonstrate that the issue is specific to named topologies and not potentially an issue with Streams itself. Of course in this case it&apos;s actually the latter, but we&apos;ve recognized the root cause as a known issue, so I don&apos;t think there&apos;s anything more this test can do for us besides be flaky and annoy everyone.&lt;/p&gt;

&lt;p&gt;Thanks for digging into this!&#160;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310760">
                    <name>Testing</name>
                                                                <inwardlinks description="Discovered while testing">
                                        <issuelink>
            <issuekey id="13558285">KAFKA-15845</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 51 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1lmtk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>