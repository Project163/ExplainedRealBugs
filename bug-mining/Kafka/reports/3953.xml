<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:40:39 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-17769] Fix flaky PlaintextConsumerSubscriptionTest.testSubscribeInvalidTopicCanUnsubscribe</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-17769</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;4 flaky out of 110 trunk builds in past 2 weeks. (&lt;a href=&quot;https://ge.apache.org/scans/tests?search.rootProjectNames=kafka&amp;amp;search.startTimeMax=1728584869905&amp;amp;search.startTimeMin=1726156800000&amp;amp;search.tags=trunk&amp;amp;search.timeZoneId=Asia%2FTaipei&amp;amp;tests.container=kafka.api.PlaintextConsumerSubscriptionTest&amp;amp;tests.test=testSubscribeInvalidTopicCanUnsubscribe(String%2C%20String)%5B3%5D&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Report Link&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;This issue can be reproduced in my local within 50 loops.&lt;br/&gt;
&#160;&lt;br/&gt;
(&lt;a href=&quot;https://ge.apache.org/s/o4ir4xtitsu52/tests/task/:core:test/details/kafka.api.PlaintextConsumerSubscriptionTest/testSubscribeInvalidTopicCanUnsubscribe(String%2C%20String)%5B3%5D?top-execution=1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Oct 4 2024 at 10:35:49 CST&lt;/a&gt;):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
org.apache.kafka.common.KafkaException: Failed to close kafka consumer	

at org.apache.kafka.clients.consumer.internals.AsyncKafkaConsumer.close(AsyncKafkaConsumer.java:1249)	
at org.apache.kafka.clients.consumer.internals.AsyncKafkaConsumer.close(AsyncKafkaConsumer.java:1204)	
at org.apache.kafka.clients.consumer.KafkaConsumer.close(KafkaConsumer.java:1718)	
at kafka.api.IntegrationTestHarness.$anonfun$tearDown$3(IntegrationTestHarness.scala:249)	
at kafka.api.IntegrationTestHarness.$anonfun$tearDown$3$adapted(IntegrationTestHarness.scala:249)	
at scala.collection.IterableOnceOps.foreach(IterableOnce.scala:619)	
at scala.collection.IterableOnceOps.foreach$(IterableOnce.scala:617)	
at scala.collection.AbstractIterable.foreach(Iterable.scala:935)	
at kafka.api.IntegrationTestHarness.tearDown(IntegrationTestHarness.scala:249)	
at java.lang.reflect.Method.invoke(Method.java:566)	
at java.util.stream.ForEachOps$ForEachOp$OfRef.accept(ForEachOps.java:183)	
at java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:195)	
at java.util.stream.ReferencePipeline$2$1.accept(ReferencePipeline.java:177)	
at java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:195)	
at java.util.stream.ForEachOps$ForEachOp$OfRef.accept(ForEachOps.java:183)	
at java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:195)	
at java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:195)	
at java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:195)	
at java.util.stream.ForEachOps$ForEachOp$OfRef.accept(ForEachOps.java:183)	
at java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:195)	
at java.util.Spliterators$ArraySpliterator.forEachRemaining(Spliterators.java:948)	
at java.util.stream.ReferencePipeline$Head.forEach(ReferencePipeline.java:658)	
at java.util.stream.ReferencePipeline$7$1.accept(ReferencePipeline.java:274)	
at java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:195)	
at java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:195)	
at java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:195)	
at java.util.Spliterators$ArraySpliterator.forEachRemaining(Spliterators.java:948)	
at java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:484)	
at java.util.stream.AbstractPipeline.wrapAndCopyInto(AbstractPipeline.java:474)	
at java.util.stream.ForEachOps$ForEachOp.evaluateSequential(ForEachOps.java:150)	
at java.util.stream.ForEachOps$ForEachOp$OfRef.evaluateSequential(ForEachOps.java:173)	
at java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:234)	
at java.util.stream.ReferencePipeline.forEach(ReferencePipeline.java:497)	
at java.util.stream.ReferencePipeline$7$1.accept(ReferencePipeline.java:274)	
at java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:195)	
at java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:195)	
at java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:195)	
at java.util.ArrayList$ArrayListSpliterator.forEachRemaining(ArrayList.java:1655)	
at java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:484)	
at java.util.stream.AbstractPipeline.wrapAndCopyInto(AbstractPipeline.java:474)	
at java.util.stream.ForEachOps$ForEachOp.evaluateSequential(ForEachOps.java:150)	
at java.util.stream.ForEachOps$ForEachOp$OfRef.evaluateSequential(ForEachOps.java:173)	
at java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:234)	
at java.util.stream.ReferencePipeline.forEach(ReferencePipeline.java:497)	
at java.util.stream.ReferencePipeline$7$1.accept(ReferencePipeline.java:274)	
at java.util.ArrayList$ArrayListSpliterator.forEachRemaining(ArrayList.java:1655)	
at java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:484)	
at java.util.stream.AbstractPipeline.wrapAndCopyInto(AbstractPipeline.java:474)	
at java.util.stream.ForEachOps$ForEachOp.evaluateSequential(ForEachOps.java:150)	
at java.util.stream.ForEachOps$ForEachOp$OfRef.evaluateSequential(ForEachOps.java:173)	
at java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:234)	
at java.util.stream.ReferencePipeline.forEach(ReferencePipeline.java:497)	
at java.util.ArrayList.forEach(ArrayList.java:1541)	
at java.util.ArrayList.forEach(ArrayList.java:1541)

Caused by: org.apache.kafka.common.errors.InvalidRequestException: MemberId can&apos;t be empty. &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;b&gt;Root Cause&lt;/b&gt;: &lt;br/&gt;
The following hearbeat requests might happen in flight simultaneously in new consumer:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The first heartbeat, which will get memberId from group coordinator (memberEpoch = 0)&lt;/li&gt;
	&lt;li&gt;The next heartbeat after an unsubscribe event (memberEpoch = -1)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The second heartbeat will be sent with empty memberId while the first heartbeat is still in flight. And the coordinator won&apos;t accept it (memberId = empty, memberEpoch = -1 ).&#160;&lt;/p&gt;

&lt;p&gt;This corner case occurs only when unsubscribe() is called shortly after the first poll.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13594962">KAFKA-17769</key>
            <summary>Fix flaky PlaintextConsumerSubscriptionTest.testSubscribeInvalidTopicCanUnsubscribe</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="Yu-Lin Chen">Yu-Lin Chen</assignee>
                                    <reporter username="Yu-Lin Chen">Yu-Lin Chen</reporter>
                        <labels>
                            <label>flaky-test</label>
                            <label>integration-test</label>
                            <label>kip-848-client-support</label>
                    </labels>
                <created>Thu, 10 Oct 2024 18:57:07 +0000</created>
                <updated>Tue, 15 Oct 2024 07:27:01 +0000</updated>
                            <resolved>Tue, 15 Oct 2024 07:27:01 +0000</resolved>
                                                    <fixVersion>4.0.0</fixVersion>
                                    <component>clients</component>
                    <component>consumer</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17888408" author="JIRAUSER300183" created="Thu, 10 Oct 2024 19:22:38 +0000"  >&lt;p&gt;Hey &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Yu-Lin+Chen&quot; class=&quot;user-hover&quot; rel=&quot;Yu-Lin Chen&quot;&gt;Yu-Lin Chen&lt;/a&gt; , thanks for getting into this. I don&apos;t quite get the root cause you describe though. The expectation is that the new consumer does not send a HB request if there&apos;s a previous one in-flight&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/kafka/blob/167e2f71f051fe7672265d1b5ae008622d3ea526/clients/src/main/java/org/apache/kafka/clients/consumer/internals/RequestState.java#L80&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/167e2f71f051fe7672265d1b5ae008622d3ea526/clients/src/main/java/org/apache/kafka/clients/consumer/internals/RequestState.java#L80&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;(called from &lt;a href=&quot;https://github.com/apache/kafka/blob/167e2f71f051fe7672265d1b5ae008622d3ea526/clients/src/main/java/org/apache/kafka/clients/consumer/internals/AbstractHeartbeatRequestManager.java#L186&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/167e2f71f051fe7672265d1b5ae008622d3ea526/clients/src/main/java/org/apache/kafka/clients/consumer/internals/AbstractHeartbeatRequestManager.java#L186&lt;/a&gt; )&lt;/p&gt;

&lt;p&gt;Isn&apos;t that the case?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17888532" author="yu-lin chen" created="Fri, 11 Oct 2024 06:42:54 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lianetm&quot; class=&quot;user-hover&quot; rel=&quot;lianetm&quot;&gt;lianetm&lt;/a&gt;,&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;The expectation is that the new consumer does not send a HB request if there&apos;s a previous one in-flight&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;&#160;&lt;br/&gt;
However, when membershipManager().state() is MemberState.LEAVING, the result of canSendRequest() will be ignored.&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/kafka/blob/167e2f71f051fe7672265d1b5ae008622d3ea526/clients/src/main/java/org/apache/kafka/clients/consumer/internals/AbstractHeartbeatRequestManager.java#L181&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/167e2f71f051fe7672265d1b5ae008622d3ea526/clients/src/main/java/org/apache/kafka/clients/consumer/internals/AbstractHeartbeatRequestManager.java#L181&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The memberState will transite to LEAVING state after process UnsubscribeEvent application event.&#160;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/kafka/blob/167e2f71f051fe7672265d1b5ae008622d3ea526/clients/src/main/java/org/apache/kafka/clients/consumer/internals/events/ApplicationEventProcessor.java#L264&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;process(final UnsubscribeEvent event)&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/kafka/blob/167e2f71f051fe7672265d1b5ae008622d3ea526/clients/src/main/java/org/apache/kafka/clients/consumer/internals/AbstractMembershipManager.java#L582&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;membershipManager().leaveGroup()&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/kafka/blob/167e2f71f051fe7672265d1b5ae008622d3ea526/clients/src/main/java/org/apache/kafka/clients/consumer/internals/AbstractMembershipManager.java#L620&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;transitionToSendingLeaveGroup(false)&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17888553" author="chia7712" created="Fri, 11 Oct 2024 07:54:33 +0000"  >&lt;p&gt;That is a trade off.&lt;/p&gt;

&lt;p&gt;If we don&#8217;t allow to have two heartbeat request, we may lose leave request when previous non-leave request is in-flight.&lt;/p&gt;

&lt;p&gt;If we allow to have two heartbeat request, we may send leave group with empty member before getting member id from previous request.&lt;/p&gt;

&lt;p&gt;That is why we need KIP-1082, allowing we send leave group with pre-defined member id even if previous request is not completed.&lt;/p&gt;</comment>
                            <comment id="17888621" author="yu-lin chen" created="Fri, 11 Oct 2024 12:08:52 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chia7712&quot; class=&quot;user-hover&quot; rel=&quot;chia7712&quot;&gt;chia7712&lt;/a&gt; ,&lt;/p&gt;

&lt;p&gt;Thanks for the explanation, after checked &#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-16639&quot; title=&quot;AsyncKafkaConsumer#close does not send heartbeat to leave group&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-16639&quot;&gt;&lt;del&gt;KAFKA-16639&lt;/del&gt;&lt;/a&gt;/&lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-15305&quot; title=&quot;The background thread should try to process the remaining task until the shutdown timer is expired&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-15305&quot;&gt;&lt;del&gt;KAFKA-15305&lt;/del&gt;&lt;/a&gt;, I think the issue will be solved after KIP-1082.&lt;/p&gt;

&lt;p&gt;To fix the flaky test before that, we can check the existence of memberId before starting the test.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 4 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1rwoo:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>