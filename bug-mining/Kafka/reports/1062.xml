<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:54:18 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-3160] Kafka LZ4 framing code miscalculates header checksum</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-3160</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-1493&quot; title=&quot;Use a well-documented LZ4 compression format and remove redundant LZ4HC option&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-1493&quot;&gt;&lt;del&gt;KAFKA-1493&lt;/del&gt;&lt;/a&gt; partially implements the LZ4 framing specification, but it incorrectly calculates the header checksum. This causes KafkaLZ4BlockInputStream to raise an error &lt;span class=&quot;error&quot;&gt;&amp;#91;IOException(DESCRIPTOR_HASH_MISMATCH)&amp;#93;&lt;/span&gt; if a client sends &lt;b&gt;correctly&lt;/b&gt; framed LZ4 data. It also causes KafkaLZ4BlockOutputStream to generate incorrectly framed LZ4 data, which means clients decoding LZ4 messages from kafka will always receive incorrectly framed data.&lt;/p&gt;

&lt;p&gt;Specifically, the current implementation includes the 4-byte MagicNumber in the checksum, which is incorrect.&lt;br/&gt;
&lt;a href=&quot;http://cyan4973.github.io/lz4/lz4_Frame_format.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cyan4973.github.io/lz4/lz4_Frame_format.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Third-party clients that attempt to use off-the-shelf lz4 framing find that brokers reject messages as having a corrupt checksum. So currently non-java clients must &apos;fixup&apos; lz4 packets to deal with the broken checksum.&lt;/p&gt;

&lt;p&gt;Magnus first identified this issue in librdkafka; kafka-python has the same problem.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12934556">KAFKA-3160</key>
            <summary>Kafka LZ4 framing code miscalculates header checksum</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dana.powers">Dana Powers</assignee>
                                    <reporter username="dana.powers">Dana Powers</reporter>
                        <labels>
                            <label>compatibility</label>
                            <label>compression</label>
                            <label>lz4</label>
                    </labels>
                <created>Wed, 27 Jan 2016 19:43:00 +0000</created>
                <updated>Mon, 9 May 2016 17:52:11 +0000</updated>
                            <resolved>Sat, 7 May 2016 18:36:46 +0000</resolved>
                                    <version>0.8.2.0</version>
                    <version>0.8.2.1</version>
                    <version>0.8.2.2</version>
                    <version>0.9.0.0</version>
                    <version>0.9.0.1</version>
                                    <fixVersion>0.10.0.0</fixVersion>
                                    <component>compression</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="15120439" author="ijuma" created="Wed, 27 Jan 2016 23:51:19 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=edenhill&quot; class=&quot;user-hover&quot; rel=&quot;edenhill&quot;&gt;edenhill&lt;/a&gt;, you&apos;re working on this, right? You should probably assign the issue to yourself to avoid duplicated work.&lt;/p&gt;</comment>
                            <comment id="15234221" author="dana.powers" created="Sun, 10 Apr 2016 17:45:18 +0000"  >&lt;p&gt;Magnus: have you made any progress on this? The more I think about it, the more I think this needs to get included w/ KIP-31. If the goal of KIP-31 is to avoid recompression, and the goal of this JIRA is to fix the compression format, and in all cases we need to maintain compatibility with old clients, then I think the only way to solve all conditions is to make the pre-KIP-31 FetchRequest / ProduceRequest versions use the broken LZ4 format, and require the fixed format in the new FetchRequest / ProduceRequest version:&lt;/p&gt;

&lt;p&gt;Old 0.8/0.9 clients (current behavior): produce messages w/ broken checksum; consume messages w/ incorrect checksum only&lt;br/&gt;
New 0.10 clients (proposed behavior): produce messages in &quot;new KIP-31 format&quot; w/ correct checksum; consume messages in &quot;new KIP-31 format&quot; w/ correct checksum only&lt;/p&gt;

&lt;p&gt;Proposed behavior for 0.10 broker:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;convert all &quot;old format&quot; messages to &quot;new KIP-31 format&quot; + fix checksum to correct value&lt;/li&gt;
	&lt;li&gt;require incoming &quot;new KIP-31 format&quot; messages to have correct checksum, otherwise throw error&lt;/li&gt;
	&lt;li&gt;when serving requests for &quot;old format&quot;, fixup checksum to be incorrect when converting &quot;new KIP-31 format&quot; messages to old format&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Thoughts?&lt;/p&gt;</comment>
                            <comment id="15234245" author="edenhill" created="Sun, 10 Apr 2016 18:33:24 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dana.powers&quot; class=&quot;user-hover&quot; rel=&quot;dana.powers&quot;&gt;dana.powers&lt;/a&gt; My broker patch adds a new Attribute bit to specify the fixed LZ4F framing but still relies on clients being backwards compatible with the broken framing format, but that was before KIP-31 was a thing..&lt;/p&gt;

&lt;p&gt;Your proposed solution with reusing the KIP-31 behaviour is much better, I&apos;d definately like to see this in broker 0.10.&lt;br/&gt;
This will also formally add LZ4 support to the protocol (it is not even mentioned in the Kafka protocol docs) and be compatible with KIP-35 (e.g., ProduceRequest &amp;gt;= v2 supports LZ4).&lt;/p&gt;

&lt;p&gt;I&apos;m a strong +1 on this.&lt;/p&gt;</comment>
                            <comment id="15234312" author="guozhang" created="Sun, 10 Apr 2016 22:26:40 +0000"  >&lt;p&gt;One thing with serving old format consume request is that now we need to modify the bytes and hence cannot do zero-copy anymore, but since for 0.10.0 upgrade there will be a temporary performance degradation anyways this may be just fine.&lt;/p&gt;</comment>
                            <comment id="15234514" author="githubbot" created="Mon, 11 Apr 2016 05:41:28 +0000"  >&lt;p&gt;GitHub user dpkp opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/1212&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/1212&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3160&quot; title=&quot;Kafka LZ4 framing code miscalculates header checksum&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3160&quot;&gt;&lt;del&gt;KAFKA-3160&lt;/del&gt;&lt;/a&gt;: Fix LZ4 Framing&lt;/p&gt;

&lt;p&gt;    This contribution is my original work and I license the work under Apache 2.0.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/dpkp/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/dpkp/kafka&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3160&quot; title=&quot;Kafka LZ4 framing code miscalculates header checksum&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3160&quot;&gt;&lt;del&gt;KAFKA-3160&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/1212.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/1212.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #1212&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit b64e5f9f054131ae7bf6b9a10be861f5fb0caeab&lt;br/&gt;
Author: Dana Powers &amp;lt;dana.powers@gmail.com&amp;gt;&lt;br/&gt;
Date:   2016-04-11T04:35:43Z&lt;/p&gt;

&lt;p&gt;    Update KafkaLZ4Block* implementation to 1.5.1 framing spec&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;update spec to 1.5.1; remove dictID&lt;/li&gt;
	&lt;li&gt;fix frame descriptor HC check (dont include magic bytes)&lt;/li&gt;
	&lt;li&gt;dont require HC validation on input by default&lt;/li&gt;
	&lt;li&gt;add useBrokenHC boolean for output compatibility&lt;/li&gt;
	&lt;li&gt;nominal support for contentChecksum / contentSize flags&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;commit f1380d0e5f6e1e9d7b48a9cff3fbcd13b7a5fe3f&lt;br/&gt;
Author: Dana Powers &amp;lt;dana.powers@gmail.com&amp;gt;&lt;br/&gt;
Date:   2016-04-11T05:35:31Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3160&quot; title=&quot;Kafka LZ4 framing code miscalculates header checksum&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3160&quot;&gt;&lt;del&gt;KAFKA-3160&lt;/del&gt;&lt;/a&gt;: use LZ4 v1.5.1 framing for all v1 messages; keep old framing for v0 messages&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15234578" author="ijuma" created="Mon, 11 Apr 2016 06:54:45 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt;, this proposal doesn&apos;t seem to affect when we lose zero-copy. That depends on the fetch request version (&amp;lt;= 1), topic message format configuration (v0) and whether we have messages stored with format v1. This proposal just changes the LZ4 format for message format 1. Do I understand correctly &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dana.powers&quot; class=&quot;user-hover&quot; rel=&quot;dana.powers&quot;&gt;dana.powers&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="15234610" author="edenhill" created="Mon, 11 Apr 2016 07:22:41 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ijuma&quot; class=&quot;user-hover&quot; rel=&quot;ijuma&quot;&gt;ijuma&lt;/a&gt; It needs to go through slow-path to &quot;fix-down&quot; (i.e., break the checksum) for older clients connecting to a newer broker.&lt;br/&gt;
But yeah, the plan is to bundle this functionality with Message format 1, so that Message format v0 attribute flag LZ4 has a broken checksum, while Message format 1 with attribute flag LZ4 has a correct checksum.&lt;/p&gt;</comment>
                            <comment id="15255290" author="ijuma" created="Sat, 23 Apr 2016 16:21:20 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=edenhill&quot; class=&quot;user-hover&quot; rel=&quot;edenhill&quot;&gt;edenhill&lt;/a&gt;, yeah, I understand that, but we do the slow path for that case already.&lt;/p&gt;</comment>
                            <comment id="15255295" author="ijuma" created="Sat, 23 Apr 2016 16:33:26 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dana.powers&quot; class=&quot;user-hover&quot; rel=&quot;dana.powers&quot;&gt;dana.powers&lt;/a&gt;, I asked Jun about this and he mentioned that we would need a KIP for this change as it touches the file format. Would you be able so submit one?&lt;/p&gt;</comment>
                            <comment id="15275336" author="githubbot" created="Sat, 7 May 2016 18:36:44 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/1212&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/1212&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15275337" author="ijuma" created="Sat, 7 May 2016 18:36:46 +0000"  >&lt;p&gt;Issue resolved by pull request 1212&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/kafka/pull/1212&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/1212&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15275852" author="githubbot" created="Mon, 9 May 2016 01:59:10 +0000"  >&lt;p&gt;GitHub user dpkp opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/1344&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/1344&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Fixup &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3160&quot; title=&quot;Kafka LZ4 framing code miscalculates header checksum&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3160&quot;&gt;&lt;del&gt;KAFKA-3160&lt;/del&gt;&lt;/a&gt;: catch decompression errors in constructor&lt;/p&gt;

&lt;p&gt;    After testing &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3160&quot; title=&quot;Kafka LZ4 framing code miscalculates header checksum&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3160&quot;&gt;&lt;del&gt;KAFKA-3160&lt;/del&gt;&lt;/a&gt; a bit more, I found that the error code was not being set properly in ProduceResponse. This happened because the validation error is raised in the CompressionFactory constructor, which was not wrapped in a try / catch.&lt;/p&gt;

&lt;p&gt;    @ijuma @junrao &lt;/p&gt;

&lt;p&gt;    (This contribution is my original work and I license the work under Apache 2.0.)&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/dpkp/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/dpkp/kafka&lt;/a&gt; decompress_error_code&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/1344.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/1344.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #1344&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit bac92e133cb80aa13ee155a1200bf085947376b7&lt;br/&gt;
Author: Dana Powers &amp;lt;dana.powers@gmail.com&amp;gt;&lt;br/&gt;
Date:   2016-05-09T01:54:22Z&lt;/p&gt;

&lt;p&gt;    Fixup to &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3160&quot; title=&quot;Kafka LZ4 framing code miscalculates header checksum&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3160&quot;&gt;&lt;del&gt;KAFKA-3160&lt;/del&gt;&lt;/a&gt;: catch decompression errors in constructor; return CorruptMessageError&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15276710" author="githubbot" created="Mon, 9 May 2016 17:52:11 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/1344&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/1344&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 28 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2s1vr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>