<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:55:03 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-3902] Optimize KTable.filter() to reduce unnecessary traffic</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-3902</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;&lt;tt&gt;KTable.filter()&lt;/tt&gt; operator is implemented in &lt;tt&gt;KTableFilter&lt;/tt&gt;, and can be optimized to reduce unnecessary data traffic to downstream operators. More specifically:&lt;/p&gt;

&lt;p&gt;1. Some context: when a KTable participates in a downstream operators (e.g. if that operator is an aggregation), then we need to materialize this KTable and send both its old value as well as new value as a pair &lt;/p&gt;
{old -&amp;gt; new}
&lt;p&gt; to the downstream operator. In practice it usually needs to send the pair. &lt;/p&gt;

&lt;p&gt;So let&apos;s discuss about them separately, take the following example source stream for your KTable&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;&amp;lt;a: 1&amp;gt;, &amp;lt;b: 2&amp;gt;, &amp;lt;a: 3&amp;gt; ...&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;When the KTable needs to be materialized, it will transform the source messages into the pairs of:&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;&amp;lt;a: {null -&amp;gt; 1}&amp;gt;, &amp;lt;b: {nul -&amp;gt; 2}&amp;gt;, &amp;lt;a: {1 -&amp;gt; 3}&amp;gt;&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;2. If &quot;send old value&quot; is not enabled, then when the filter predicate returns false, we MUST send a &amp;lt;key: null&amp;gt; to the downstream operator to indicate that this key is being filtered in the table. Otherwise, for example if your filter is &quot;value &amp;lt; 2&quot;, then the updated value &amp;lt;a: 3&amp;gt; will just be filtered, resulting in incorrect semantics.&lt;/p&gt;

&lt;p&gt;If it returns true we should still send the original &amp;lt;key: value&amp;gt; to downstream operators.&lt;/p&gt;

&lt;p&gt;3. If &quot;send old value&quot; is enabled, then there are a couple of cases we can consider:&lt;/p&gt;

&lt;p&gt;    a. If old value is &amp;lt;key: null&amp;gt; and new value is &amp;lt;key: not-null&amp;gt;, and the filter predicate return false for the new value, then in this case it is safe to optimize and not returning anything to the downstream operator, since in this case we know there is no value for the key previously anyways; otherwise we send the original pair.&lt;/p&gt;

&lt;p&gt;    b. If old value is &amp;lt;key: not-null&amp;gt; and new value is &amp;lt;key: null&amp;gt;, indicating to delete this key, and the filter predicate return false for the old value, then in this case it is safe to optimize and not returning anything to the downstream operator, since we know that the old value has already been filtered in a previous message; otherwise we send the original pair.&lt;/p&gt;

&lt;p&gt;    c. If both old and new values are not null, and:&lt;/p&gt;

&lt;p&gt;        1) predicate return true on both, send the original pair;&lt;br/&gt;
        2) predicate return false on both, we can optimize and do not send anything;&lt;br/&gt;
        3) predicate return true on old and false on new, send the key: {old -&amp;gt; null};&lt;br/&gt;
        4) predicate return false on old and true on new, send the key: {null -&amp;gt; new};&lt;/p&gt;</description>
                <environment></environment>
        <key id="12982829">KAFKA-3902</key>
            <summary>Optimize KTable.filter() to reduce unnecessary traffic</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="phderome">Phil Derome</assignee>
                                    <reporter username="guozhang">Guozhang Wang</reporter>
                        <labels>
                            <label>architecture</label>
                            <label>performance</label>
                    </labels>
                <created>Sat, 25 Jun 2016 05:04:37 +0000</created>
                <updated>Fri, 1 Jul 2016 23:48:57 +0000</updated>
                            <resolved>Fri, 1 Jul 2016 23:47:39 +0000</resolved>
                                                    <fixVersion>0.10.0.1</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15350099" author="githubbot" created="Sun, 26 Jun 2016 12:33:12 +0000"  >&lt;p&gt;GitHub user phderome opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/1556&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/1556&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3902&quot; title=&quot;Optimize KTable.filter() to reduce unnecessary traffic&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3902&quot;&gt;&lt;del&gt;KAFKA-3902&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    The contribution is my original work and that I license the work to the project under the project&apos;s open source license.&lt;/p&gt;

&lt;p&gt;    Contributors: Guozhang Wang, Phil Derome&lt;br/&gt;
    @guozhangwang &lt;/p&gt;

&lt;p&gt;    Added checkEmpty to validate processor does nothing  and added a inhibit check for filter to fix issue.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/phderome/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/phderome/kafka&lt;/a&gt; DEROME-3902&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/1556.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/1556.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #1556&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit e07388bf389f09894a10e1af5916420962d47e2a&lt;br/&gt;
Author: Philippe Derome &amp;lt;phderome@gmail.com&amp;gt;&lt;br/&gt;
Date:   2016-06-26T03:16:36Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3902&quot; title=&quot;Optimize KTable.filter() to reduce unnecessary traffic&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3902&quot;&gt;&lt;del&gt;KAFKA-3902&lt;/del&gt;&lt;/a&gt;&lt;br/&gt;
    Added checkEmpty to validate processor does nothing  and added a inhibit check for filter to fix issue.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15350131" author="phderome" created="Sun, 26 Jun 2016 14:28:10 +0000"  >&lt;p&gt;I am currently having a problem when porting Confluent UserRegionLambdaExample into the Kafka build after converting to JDK 7. Problem is at run time with LongDeserializer in console consumer. I am investigating and would say that the fix is not ready until this issue is addressed.&lt;/p&gt;

&lt;p&gt;bin/kafka-console-consumer --topic LargeRegions --from-beginning \&lt;br/&gt;
&amp;gt; --zookeeper localhost:2181 --property print.key=true --property value.deserializer=org.apache.kafka.common.serialization.LongDeserializer&lt;br/&gt;
asia	Processed a total of 1 messages&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2016-06-26 10:22:22,126&amp;#93;&lt;/span&gt; ERROR Unknown error when running consumer:  (kafka.tools.ConsoleConsumer$)&lt;br/&gt;
org.apache.kafka.common.errors.SerializationException: Size of data received by LongDeserializer is not 8&lt;/p&gt;
</comment>
                            <comment id="15350149" author="phderome" created="Sun, 26 Jun 2016 15:07:56 +0000"  >&lt;p&gt;The problem above is not quite a real problem because enableSendingOldValues is false by default and so nulls are still sent out as per Guozhang&apos; s description of case 2.&lt;/p&gt;

&lt;p&gt;I am assuming it can be set to true unconditionally in KTableFilter, which would satisfy provably case 3 more easily.&lt;/p&gt;

&lt;p&gt;This appears to trigger the change I want (Confluent&apos;s example with UserRegion once modified to work with JDK 7 non-lambdas does not publish null on LargeRegions and publishes when I want to), but am not entirely sure of the over all impact.&lt;/p&gt;

&lt;p&gt;KStreamRepartitionJoinTest currently broke as my local branch is not up to date with trunk and I am missing some recent unit files. I&apos;ll see if I can get that resolved in the next little while. I am 31 commits behind trunk and that&apos;s one key file that needs modified.&lt;/p&gt;

&lt;p&gt;Cheers,&lt;/p&gt;

&lt;p&gt;Phil&lt;/p&gt;</comment>
                            <comment id="15359840" author="guozhang" created="Fri, 1 Jul 2016 23:47:39 +0000"  >&lt;p&gt;Issue resolved by pull request 1556&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/kafka/pull/1556&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/1556&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15359841" author="githubbot" created="Fri, 1 Jul 2016 23:47:41 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/1556&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/1556&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15359843" author="guozhang" created="Fri, 1 Jul 2016 23:48:57 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=phderome&quot; class=&quot;user-hover&quot; rel=&quot;phderome&quot;&gt;phderome&lt;/a&gt; Thanks for your patch! It has been merged in trunk and 0.10.0 branch.&lt;/p&gt;

&lt;p&gt;I have added you as contributor to Kafka and moving forward you can assign tickets to yourself.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 20 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i30247:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>