<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:26:51 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-9672] Dead brokers in ISR cause isr-expiration to fail with exception</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-9672</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;We&apos;re running Kafka 2.4 and facing a pretty strange situation.&lt;br/&gt;
 Let&apos;s say there were three brokers in the cluster 0, 1, and 2. Then:&lt;br/&gt;
 1. Broker 3 was added.&lt;br/&gt;
 2. Partitions were reassigned from broker 0 to broker 3.&lt;br/&gt;
 3. Broker 0 was shut down (not gracefully) and removed from the cluster.&lt;br/&gt;
 4. We see the following state in ZooKeeper:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ls /brokers/ids
[1, 2, 3]

get /brokers/topics/foo
{&lt;span class=&quot;code-quote&quot;&gt;&quot;version&quot;&lt;/span&gt;:2,&lt;span class=&quot;code-quote&quot;&gt;&quot;partitions&quot;&lt;/span&gt;:{&lt;span class=&quot;code-quote&quot;&gt;&quot;0&quot;&lt;/span&gt;:[2,1,3]},&lt;span class=&quot;code-quote&quot;&gt;&quot;adding_replicas&quot;&lt;/span&gt;:{},&lt;span class=&quot;code-quote&quot;&gt;&quot;removing_replicas&quot;&lt;/span&gt;:{}}

get /brokers/topics/foo/partitions/0/state
{&lt;span class=&quot;code-quote&quot;&gt;&quot;controller_epoch&quot;&lt;/span&gt;:123,&lt;span class=&quot;code-quote&quot;&gt;&quot;leader&quot;&lt;/span&gt;:1,&lt;span class=&quot;code-quote&quot;&gt;&quot;version&quot;&lt;/span&gt;:1,&lt;span class=&quot;code-quote&quot;&gt;&quot;leader_epoch&quot;&lt;/span&gt;:42,&lt;span class=&quot;code-quote&quot;&gt;&quot;isr&quot;&lt;/span&gt;:[0,2,3,1]}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;It means, the dead broker 0 remains in the partitions&apos;s ISR. A big share of the partitions in the cluster have this issue.&lt;/p&gt;

&lt;p&gt;This is actually causing an errors:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Uncaught exception in scheduled task &lt;span class=&quot;code-quote&quot;&gt;&apos;isr-expiration&apos;&lt;/span&gt; (kafka.utils.KafkaScheduler)
org.apache.kafka.common.errors.ReplicaNotAvailableException: Replica with id 12 is not available on broker 17
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;It means that effectively &lt;tt&gt;isr-expiration&lt;/tt&gt; task is not working any more.&lt;/p&gt;

&lt;p&gt;I have a suspicion that this was introduced by &lt;a href=&quot;https://github.com/apache/kafka/commit/57baa4079d9fc14103411f790b9a025c9f2146a4#diff-5450baca03f57b9f2030f93a480e6969R856&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this commit (line selected)&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Unfortunately, I haven&apos;t been able to reproduce this in isolation.&lt;/p&gt;

&lt;p&gt;Any hints about how to reproduce (so I can write a patch) or mitigate the issue on a running cluster are welcome.&lt;/p&gt;

&lt;p&gt;Generally, I assume that not throwing &lt;tt&gt;ReplicaNotAvailableException&lt;/tt&gt; on a dead (i.e. non-existent) broker, considering them out-of-sync and removing from the ISR should fix the problem.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13290048">KAFKA-9672</key>
            <summary>Dead brokers in ISR cause isr-expiration to fail with exception</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jagsancio">Jose Armando Garcia Sancio</assignee>
                                    <reporter username="ivanyu">Ivan Yurchenko</reporter>
                        <labels>
                    </labels>
                <created>Fri, 6 Mar 2020 12:12:14 +0000</created>
                <updated>Sat, 20 Feb 2021 01:08:29 +0000</updated>
                            <resolved>Sat, 20 Feb 2021 01:08:29 +0000</resolved>
                                    <version>2.4.0</version>
                    <version>2.4.1</version>
                                    <fixVersion>3.0.0</fixVersion>
                                    <component>core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="17236416" author="jagsancio" created="Fri, 20 Nov 2020 20:09:42 +0000"  >&lt;p&gt;I was not able to reproduce this issue but looking at the code and the trace of messages sent by the controller this is what I think it is happening.&lt;/p&gt;

&lt;p&gt;Assuming that the initial partition assignment and state is:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Replicas: 0, 1, 2
ISR: 0, 1, 2
Leader: 0
LeaderEpoch: 1&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This state is replicated to all of the replicas (0, 1, 2) using the LeaderAndIsr requests.&lt;/p&gt;

&lt;p&gt;When the user attempts to perform a reassignment of replacing 0 with 3, the controller bumps the epoch and assignment info&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Replicas: 0, 1, 2, 3
Adding: 3
Removing: 0
ISR: 0, 1, 2
Leader: 0
LeaderEpoch: 2&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This state is replicated to all of the replicas (0, 1, 2, 3) using the LeaderAndIsr request.&lt;/p&gt;

&lt;p&gt;The system roughly stays in this state until the all of the target replicas have join the ISR. When all of the target replicas have join the ISR the controller wants to perform the following flow:&lt;/p&gt;

&lt;p&gt;1 - The controller moves the leader if necessary (leader is not in the new replicas set) and stops the leader from letting &quot;removing&quot; replicas to join the ISR.&lt;/p&gt;

&lt;p&gt;The second requirement (stopping the leader from adding &quot;removing&quot; replicas to the ISR) is accomplished by bumping the leader epoch and only sending the new leader epoch to the target replicas (1, 2, 3). Unfortunately, due to how the controller is implemented this is accomplished by deleting the &quot;removing&quot; replicas from the in memory state without modifying the ISR state. At this point we have the ZK state:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Replicas: 0, 1, 2, 3
Adding:
Removing: 0
ISR: 0, 1, 2, 3
Leader: 1
LeaderEpoch: 3&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;but the following LeaderAndIsr requests are sent to replicas 1, 2, 3&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Replicas: 1, 2, 3
Adding:
Removing:
ISR: 0, 1, 2, 3
Leader: 1
LeaderEpoch: 3&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This works because replica 0 will have an invalid leader epoch which means that it&apos;s Fetch request will be ignored by the (new) leader.&lt;/p&gt;

&lt;p&gt;2 - The controller removes replica 0 from the ISR by updating ZK and sending the appropriate LeaderAndIsr requests.&lt;/p&gt;

&lt;p&gt;3 - The controller removes replica 0 from the replica set by updating ZK and sending the appropriate LeaderAndIsr requests.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Conclusion&lt;/p&gt;

&lt;p&gt;If this flow executes to completion, everything is okay. The problem is what happens if step 2. and 3. don&apos;t get to execute. I am unable to reproduce this with tests or by walking the code but if 2. and 3. don&apos;t execute but the controller stays alive there is a flow where the controller persists the following state to ZK&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Replicas: 1, 2, 3
Adding:
Removing:
ISR: 0, 1, 2, 3
Leader: 1
LeaderEpoch: 3&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Which causes the reassignment flow to terminate with the system staying in this state. This state is persistent at this line in the controller code:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/kafka/blob/43fd630d80332f2b3b3512a712100825a8417704/core/src/main/scala/kafka/controller/KafkaController.scala#L728&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/43fd630d80332f2b3b3512a712100825a8417704/core/src/main/scala/kafka/controller/KafkaController.scala#L728&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17236420" author="jagsancio" created="Fri, 20 Nov 2020 20:13:49 +0000"  >&lt;p&gt;Based on my observations here: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-9672?focusedCommentId=17236416&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-17236416&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-9672?focusedCommentId=17236416&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-17236416&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Solution 1: I think the ideal solution is to never allow the ISR to be a superset of the replica set. Unfortunately, this is not easy to with how the controller implementation manages writes to ZK.&lt;/p&gt;

&lt;p&gt;Solution 2: Another solution is to allow the ISR to be a superset of the replica set but also allow the Leader to remove replicas from the ISR if they are not in the replica set.&lt;/p&gt;</comment>
                            <comment id="17287444" author="junrao" created="Sat, 20 Feb 2021 01:08:29 +0000"  >&lt;p&gt;merged the PR to trunk&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 38 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0c8ts:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>