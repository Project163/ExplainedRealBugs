<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:10:05 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-3417] Invalid characters in config properties not being validated?</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-3417</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;I ran into an error using a &lt;tt&gt;client.id&lt;/tt&gt; with invalid characters (per the &lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/core/src/main/scala/kafka/common/Config.scala#L25-L35&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;config validator&lt;/a&gt;). I was able to get that exact error using the &lt;tt&gt;kafka-console-consumer&lt;/tt&gt; script, presumably because I supplied a consumer properties file and it validated prior to hitting the server. However, when I use a client library (sarama for Go in this case), an error in the metrics subsystem is thrown &lt;a href=&quot;https://github.com/apache/kafka/blob/977ebbe9bafb6c1a6e1be69620f745712118fe80/clients/src/main/java/org/apache/kafka/common/metrics/Metrics.java#L380&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;The stacktrace is:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;stack.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;[2016-03-17 17:43:47,342] ERROR [KafkaApi-0] error when handling request Name: FetchRequest; Version: 0; CorrelationId: 2; ClientId: foo:bar; ReplicaId: -1; MaxWait: 250 ms; MinBytes: 1 bytes; RequestInfo: [foo,0] -&amp;gt; PartitionFetchInfo(0,32768) (kafka.server.KafkaApis)
org.apache.kafka.common.KafkaException: Error creating mbean attribute &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; metricName :MetricName [name=throttle-time, group=Fetch, description=Tracking average throttle-time per client, tags={client-id=foo:bar}]
	at org.apache.kafka.common.metrics.JmxReporter.addAttribute(JmxReporter.java:113)
	at org.apache.kafka.common.metrics.JmxReporter.metricChange(JmxReporter.java:76)
	at org.apache.kafka.common.metrics.Metrics.registerMetric(Metrics.java:288)
	at org.apache.kafka.common.metrics.Sensor.add(Sensor.java:177)
	at org.apache.kafka.common.metrics.Sensor.add(Sensor.java:162)
    ...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Assuming the cause os related to the invalid characters, when the request header is decoded, the &lt;tt&gt;clientId&lt;/tt&gt; should be validated prior to being used?&lt;/p&gt;</description>
                <environment></environment>
        <key id="12951264">KAFKA-3417</key>
            <summary>Invalid characters in config properties not being validated?</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mimaison">Mickael Maison</assignee>
                                    <reporter username="b@devel.io">Byron Ruth</reporter>
                        <labels>
                    </labels>
                <created>Thu, 17 Mar 2016 17:28:04 +0000</created>
                <updated>Tue, 1 May 2018 16:31:25 +0000</updated>
                            <resolved>Tue, 1 May 2018 16:31:25 +0000</resolved>
                                    <version>0.9.0.1</version>
                                    <fixVersion>2.0.0</fixVersion>
                                    <component>config</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="15200031" author="b@devel.io" created="Thu, 17 Mar 2016 17:51:05 +0000"  >&lt;p&gt;I posted on the sarama Go client repo as well for steps to reproduce the behavior: &lt;a href=&quot;https://github.com/Shopify/sarama/issues/632&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/Shopify/sarama/issues/632&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15201387" author="b@devel.io" created="Fri, 18 Mar 2016 12:20:03 +0000"  >&lt;p&gt;Looking at the source a bit more, the `group.id` appears to be restricted to same character set as `client.id`, but group ids with invalid characters are being permitted. For example:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;./kafka-console-consumer --&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt;-consumer --consumer.config consumer.properties --topic foo --bootstrap-server 192.168.99.100:9092
foobar
^CProcessed a total of 1 messages
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;where `consumer.properties` contains:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;group.id=foo:bar
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The logs appear to have accepts that `group.id`:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;[2016-03-18 11:59:15,859] INFO [GroupCoordinator 0]: Preparing to restabilize group foo:bar with old generation 0 (kafka.coordinator.GroupCoordinator)
[2016-03-18 11:59:15,875] INFO [GroupCoordinator 0]: Stabilized group foo:bar generation 1 (kafka.coordinator.GroupCoordinator)
[2016-03-18 11:59:15,905] INFO [GroupCoordinator 0]: Assignment received from leader &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; group foo:bar &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; generation 1 (kafka.coordinator.GroupCoordinator)
[2016-03-18 12:02:29,094] INFO [GroupCoordinator 0]: Preparing to restabilize group foo:bar with old generation 1 (kafka.coordinator.GroupCoordinator)
[2016-03-18 12:02:29,106] INFO [GroupCoordinator 0]: Group foo:bar generation 1 is dead and removed (kafka.coordinator.GroupCoordinator)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16116480" author="githubbot" created="Mon, 7 Aug 2017 11:53:18 +0000"  >&lt;p&gt;GitHub user mimaison opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/3635&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3635&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3417&quot; title=&quot;Invalid characters in config properties not being validated?&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3417&quot;&gt;&lt;del&gt;KAFKA-3417&lt;/del&gt;&lt;/a&gt;: Quote client-id and wrap reporter calls in try/catch blocks&lt;/p&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/mimaison/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/mimaison/kafka&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3417&quot; title=&quot;Invalid characters in config properties not being validated?&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3417&quot;&gt;&lt;del&gt;KAFKA-3417&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/3635.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3635.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #3635&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit ec36fa8052ea60411c77ed82c4b3d7b83fb1f4d3&lt;br/&gt;
Author: Mickael Maison &amp;lt;mickael.maison@gmail.com&amp;gt;&lt;br/&gt;
Date:   2017-08-07T11:51:49Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3417&quot; title=&quot;Invalid characters in config properties not being validated?&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3417&quot;&gt;&lt;del&gt;KAFKA-3417&lt;/del&gt;&lt;/a&gt;: Quote client-id and wrap reporter calls in try/catch blocks&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16458497" author="githubbot" created="Mon, 30 Apr 2018 11:34:04 +0000"  >&lt;p&gt;rajinisivaram closed pull request #3635: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3417&quot; title=&quot;Invalid characters in config properties not being validated?&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3417&quot;&gt;&lt;del&gt;KAFKA-3417&lt;/del&gt;&lt;/a&gt;: Wrap reporter calls in try/catch blocks&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/3635&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3635&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/clients/src/main/java/org/apache/kafka/common/metrics/Metrics.java b/clients/src/main/java/org/apache/kafka/common/metrics/Metrics.java&lt;br/&gt;
index dee69f5a345..7a8667c98c9 100644&lt;br/&gt;
&amp;#8212; a/clients/src/main/java/org/apache/kafka/common/metrics/Metrics.java&lt;br/&gt;
+++ b/clients/src/main/java/org/apache/kafka/common/metrics/Metrics.java&lt;br/&gt;
@@ -524,8 +524,13 @@ public void addMetric(MetricName metricName, MetricValueProvider&amp;lt;?&amp;gt; metricValueP&lt;br/&gt;
     public synchronized KafkaMetric removeMetric(MetricName metricName) {&lt;br/&gt;
         KafkaMetric metric = this.metrics.remove(metricName);&lt;br/&gt;
         if (metric != null) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;for (MetricsReporter reporter : reporters)&lt;/li&gt;
	&lt;li&gt;reporter.metricRemoval(metric);&lt;br/&gt;
+            for (MetricsReporter reporter : reporters) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+                try {
+                    reporter.metricRemoval(metric);
+                } catch (Exception e) {
+                    log.error(&quot;Error when removing metric from &quot; + reporter.getClass().getName(), e);
+                }+            }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;         }&lt;br/&gt;
         return metric;&lt;br/&gt;
     }&lt;br/&gt;
@@ -552,8 +557,13 @@ synchronized void registerMetric(KafkaMetric metric) {&lt;br/&gt;
         if (this.metrics.containsKey(metricName))&lt;br/&gt;
             throw new IllegalArgumentException(&quot;A metric named &apos;&quot; + metricName + &quot;&apos; already exists, can&apos;t register another one.&quot;);&lt;br/&gt;
         this.metrics.put(metricName, metric);&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;for (MetricsReporter reporter : reporters)&lt;/li&gt;
	&lt;li&gt;reporter.metricChange(metric);&lt;br/&gt;
+        for (MetricsReporter reporter : reporters) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+            try {
+                reporter.metricChange(metric);
+            } catch (Exception e) {
+                log.error(&quot;Error when registering metric on &quot; + reporter.getClass().getName(), e);
+            }+        }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;     }&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     /**&lt;br/&gt;
@@ -634,8 +644,13 @@ public void close() {&lt;br/&gt;
             }&lt;br/&gt;
         }&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;for (MetricsReporter reporter : this.reporters)&lt;/li&gt;
	&lt;li&gt;reporter.close();&lt;br/&gt;
+        for (MetricsReporter reporter : reporters) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+            try {
+                reporter.close();
+            } catch (Exception e) {
+                log.error(&quot;Error when closing &quot; + reporter.getClass().getName(), e);
+            }+        }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;     }&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; }&lt;br/&gt;
diff --git a/core/src/test/scala/unit/kafka/server/BaseRequestTest.scala b/core/src/test/scala/unit/kafka/server/BaseRequestTest.scala&lt;br/&gt;
index f91afd492fe..99355bca37a 100644&lt;br/&gt;
&amp;#8212; a/core/src/test/scala/unit/kafka/server/BaseRequestTest.scala&lt;br/&gt;
+++ b/core/src/test/scala/unit/kafka/server/BaseRequestTest.scala&lt;br/&gt;
@@ -154,6 +154,18 @@ abstract class BaseRequestTest extends KafkaServerTestHarness &lt;/p&gt;
{
     skipResponseHeader(response)
   }

&lt;p&gt;+  /**&lt;br/&gt;
+   * Sends a request built by the builder, waits for the response and parses it &lt;br/&gt;
+   */&lt;br/&gt;
+  def requestResponse(socket: Socket, clientId: String, correlationId: Int, requestBuilder: AbstractRequest.Builder&lt;span class=&quot;error&quot;&gt;&amp;#91;_ &amp;lt;: AbstractRequest&amp;#93;&lt;/span&gt;): Struct = &lt;/p&gt;
{
+    val apiKey = requestBuilder.apiKey
+    val request = requestBuilder.build()
+    val header = new RequestHeader(apiKey, request.version, clientId, correlationId)
+    val response = requestAndReceive(socket, request.serialize(header).array)
+    val responseBuffer = skipResponseHeader(response)
+    apiKey.parseResponse(request.version, responseBuffer)
+  }
&lt;p&gt;+  &lt;br/&gt;
   /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Serializes and sends the requestStruct to the given api.&lt;/li&gt;
	&lt;li&gt;A ByteBuffer containing the response (without the response header) is returned.&lt;br/&gt;
diff --git a/core/src/test/scala/unit/kafka/server/KafkaMetricReporterExceptionHandlingTest.scala b/core/src/test/scala/unit/kafka/server/KafkaMetricReporterExceptionHandlingTest.scala&lt;br/&gt;
new file mode 100644&lt;br/&gt;
index 00000000000..30f3b234613
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;/dev/null&lt;br/&gt;
+++ b/core/src/test/scala/unit/kafka/server/KafkaMetricReporterExceptionHandlingTest.scala&lt;br/&gt;
@@ -0,0 +1,116 @@&lt;br/&gt;
+/**&lt;br/&gt;
+ * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);&lt;br/&gt;
+ * you may not use this file except in compliance with the License.&lt;br/&gt;
+ * You may obtain a copy of the License at&lt;br/&gt;
+ *&lt;br/&gt;
+ * &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
+ *&lt;br/&gt;
+ * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
+ * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
+ * See the License for the specific language governing permissions and&lt;br/&gt;
+ * limitations under the License.&lt;br/&gt;
+ **/&lt;br/&gt;
+&lt;br/&gt;
+package kafka.server&lt;br/&gt;
+&lt;br/&gt;
+import java.net.Socket&lt;br/&gt;
+import java.util.Properties&lt;br/&gt;
+&lt;br/&gt;
+import kafka.utils.TestUtils&lt;br/&gt;
+import org.apache.kafka.common.network.ListenerName&lt;br/&gt;
+import org.apache.kafka.common.requests.
{ListGroupsRequest,ListGroupsResponse}
&lt;p&gt;+import org.apache.kafka.common.metrics.MetricsReporter&lt;br/&gt;
+import org.apache.kafka.common.metrics.KafkaMetric&lt;br/&gt;
+import org.apache.kafka.common.security.auth.SecurityProtocol&lt;br/&gt;
+import org.apache.kafka.common.protocol.Errors&lt;br/&gt;
+&lt;br/&gt;
+import org.junit.Assert._&lt;br/&gt;
+import org.junit.&lt;/p&gt;
{Before, Test}
&lt;p&gt;+import org.junit.After&lt;br/&gt;
+import java.util.concurrent.atomic.AtomicInteger&lt;br/&gt;
+&lt;br/&gt;
+/*&lt;br/&gt;
+ * this test checks that a reporter that throws an exception will not affect other reporters&lt;br/&gt;
+ * and will not affect the broker&apos;s message handling&lt;br/&gt;
+ */&lt;br/&gt;
+class KafkaMetricReporterExceptionHandlingTest extends BaseRequestTest {&lt;br/&gt;
+&lt;br/&gt;
+  override def numBrokers: Int = 1&lt;br/&gt;
+&lt;br/&gt;
+  override def propertyOverrides(properties: Properties): Unit = &lt;/p&gt;
{
+    properties.put(KafkaConfig.MetricReporterClassesProp, classOf[KafkaMetricReporterExceptionHandlingTest.BadReporter].getName + &quot;,&quot; + classOf[KafkaMetricReporterExceptionHandlingTest.GoodReporter].getName)
+  }
&lt;p&gt;+&lt;br/&gt;
+  @Before&lt;br/&gt;
+  override def setUp() &lt;/p&gt;
{
+    super.setUp()
+
+    // need a quota prop to register a &quot;throttle-time&quot; metrics after server startup
+    val quotaProps = new Properties()
+    quotaProps.put(DynamicConfig.Client.RequestPercentageOverrideProp, &quot;0.1&quot;)
+    adminZkClient.changeClientIdConfig(&quot;&amp;lt;default&amp;gt;&quot;, quotaProps)
+  }
&lt;p&gt;+&lt;br/&gt;
+  @After&lt;br/&gt;
+  override def tearDown() &lt;/p&gt;
{
+    KafkaMetricReporterExceptionHandlingTest.goodReporterRegistered.set(0)
+    KafkaMetricReporterExceptionHandlingTest.badReporterRegistered.set(0)
+    
+    super.tearDown()
+  }
&lt;p&gt;+&lt;br/&gt;
+  @Test&lt;br/&gt;
+  def testBothReportersAreInvoked() {&lt;br/&gt;
+    val port = anySocketServer.boundPort(ListenerName.forSecurityProtocol(SecurityProtocol.PLAINTEXT))&lt;br/&gt;
+    val socket = new Socket(&quot;localhost&quot;, port)&lt;br/&gt;
+    socket.setSoTimeout(10000)&lt;br/&gt;
+&lt;br/&gt;
+    try &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+      TestUtils.retry(10000) {
+        val error = new ListGroupsResponse(requestResponse(socket, &quot;clientId&quot;, 0, new ListGroupsRequest.Builder())).error()
+        assertEquals(Errors.NONE, error)
+        assertEquals(KafkaMetricReporterExceptionHandlingTest.goodReporterRegistered.get, KafkaMetricReporterExceptionHandlingTest.badReporterRegistered.get)
+        assertTrue(KafkaMetricReporterExceptionHandlingTest.goodReporterRegistered.get &amp;gt; 0)
+      }+    }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt; finally &lt;/p&gt;
{
+      socket.close()
+    }
&lt;p&gt;+  }&lt;br/&gt;
+}&lt;br/&gt;
+&lt;br/&gt;
+object KafkaMetricReporterExceptionHandlingTest {&lt;br/&gt;
+  var goodReporterRegistered = new AtomicInteger&lt;br/&gt;
+  var badReporterRegistered = new AtomicInteger&lt;br/&gt;
+&lt;br/&gt;
+  class GoodReporter extends MetricsReporter {&lt;br/&gt;
+&lt;br/&gt;
+    def configure(configs: java.util.Map&lt;span class=&quot;error&quot;&gt;&amp;#91;String, _&amp;#93;&lt;/span&gt;) &lt;/p&gt;
{
+    }&lt;br/&gt;
+&lt;br/&gt;
+    def init(metrics: java.util.List&lt;span class=&quot;error&quot;&gt;&amp;#91;KafkaMetric&amp;#93;&lt;/span&gt;) {+    }
&lt;p&gt;+&lt;br/&gt;
+    def metricChange(metric: KafkaMetric) &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+      if (metric.metricName.group == &amp;quot;Request&amp;quot;) {
+        goodReporterRegistered.incrementAndGet
+      }+    }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;+&lt;br/&gt;
+    def metricRemoval(metric: KafkaMetric) &lt;/p&gt;
{
+    }&lt;br/&gt;
+&lt;br/&gt;
+    def close() {+    }
&lt;p&gt;+  }&lt;br/&gt;
+&lt;br/&gt;
+  class BadReporter extends GoodReporter {&lt;br/&gt;
+&lt;br/&gt;
+    override def metricChange(metric: KafkaMetric) &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+      if (metric.metricName.group == &amp;quot;Request&amp;quot;) {
+        badReporterRegistered.incrementAndGet
+        throw new RuntimeException(metric.metricName.toString)
+      }+    }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;+  }&lt;br/&gt;
+}&lt;br/&gt;
diff --git a/core/src/test/scala/unit/kafka/server/RequestQuotaTest.scala b/core/src/test/scala/unit/kafka/server/RequestQuotaTest.scala&lt;br/&gt;
index ed85415eacc..8a50fcafd1a 100644&lt;/p&gt;&lt;/li&gt;
			&lt;li&gt;a/core/src/test/scala/unit/kafka/server/RequestQuotaTest.scala&lt;br/&gt;
+++ b/core/src/test/scala/unit/kafka/server/RequestQuotaTest.scala&lt;br/&gt;
@@ -14,7 +14,6 @@&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; package kafka.server&lt;/p&gt;

&lt;p&gt;-import java.net.Socket&lt;br/&gt;
 import java.nio.ByteBuffer&lt;br/&gt;
 import java.util.&lt;/p&gt;
{Collections, LinkedHashMap, Properties}
&lt;p&gt; import java.util.concurrent.&lt;/p&gt;
{Executors, Future, TimeUnit}
&lt;p&gt;@@ -331,15 +330,6 @@ class RequestQuotaTest extends BaseRequestTest {&lt;br/&gt;
     }&lt;br/&gt;
   }&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private def requestResponse(socket: Socket, clientId: String, correlationId: Int, requestBuilder: AbstractRequest.Builder&lt;span class=&quot;error&quot;&gt;&amp;#91;_ &amp;lt;: AbstractRequest&amp;#93;&lt;/span&gt;): Struct = 
{
-    val apiKey = requestBuilder.apiKey
-    val request = requestBuilder.build()
-    val header = new RequestHeader(apiKey, request.version, clientId, correlationId)
-    val response = requestAndReceive(socket, request.serialize(header).array)
-    val responseBuffer = skipResponseHeader(response)
-    apiKey.parseResponse(request.version, responseBuffer)
-  }
&lt;p&gt;-&lt;br/&gt;
   case class Client(clientId: String, apiKey: ApiKeys) {&lt;br/&gt;
     var correlationId: Int = 0&lt;br/&gt;
     val builder = requestBuilder(apiKey)&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;





&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 29 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2uu67:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>