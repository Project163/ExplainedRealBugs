<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:27:23 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-9527] Application Reset Tool Returns NPE when --to-datetime or --by-duration are run on --input-topics with empty partitions </title>
                <link>https://issues.apache.org/jira/browse/KAFKA-9527</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;When running the streams application reset tool with --by-duration or --to-datetime if any partitions for a given input topic are empty a NPE is thrown.&#160; I tested this with a topic with 3 partitions, I received a NPE until all 3 partitions had at least one message.&#160; The behavior was the same for both --to-datetime and --by-duration.&#160;&lt;/p&gt;

&lt;p&gt;Error below:&lt;/p&gt;

&lt;p&gt;Reset-offsets for input topics &lt;span class=&quot;error&quot;&gt;&amp;#91;sample-cdc-topic&amp;#93;&lt;/span&gt;Reset-offsets for input topics &lt;span class=&quot;error&quot;&gt;&amp;#91;sample-cdc-topic&amp;#93;&lt;/span&gt;Following input topics offsets will be reset to (for consumer group des-demo-stream)ERROR: java.lang.NullPointerExceptionjava.lang.NullPointerException at kafka.tools.StreamsResetter.resetToDatetime(StreamsResetter.java:496) at kafka.tools.StreamsResetter.maybeReset(StreamsResetter.java:426) at kafka.tools.StreamsResetter.maybeResetInputAndSeekToEndIntermediateTopicOffsets(StreamsResetter.java:374) at kafka.tools.StreamsResetter.run(StreamsResetter.java:164) at kafka.tools.StreamsResetter.run(StreamsResetter.java:131) at kafka.tools.StreamsResetter.main(StreamsResetter.java:678)&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13284098">KAFKA-9527</key>
            <summary>Application Reset Tool Returns NPE when --to-datetime or --by-duration are run on --input-topics with empty partitions </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="marcolotz">Marco Lotz</assignee>
                                    <reporter username="jbfletch">jbfletch</reporter>
                        <labels>
                    </labels>
                <created>Sat, 8 Feb 2020 20:39:16 +0000</created>
                <updated>Mon, 12 Apr 2021 16:29:20 +0000</updated>
                            <resolved>Mon, 12 Apr 2021 16:28:44 +0000</resolved>
                                    <version>2.3.0</version>
                                    <fixVersion>3.0.0</fixVersion>
                                    <component>streams</component>
                    <component>tools</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="17276987" author="marcolotz" created="Tue, 2 Feb 2021 09:39:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mjsax&quot; class=&quot;user-hover&quot; rel=&quot;mjsax&quot;&gt;mjsax&lt;/a&gt;&#160;what would be the expected behaviour in this scenario? I see three possible behaviours:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Throwing a Kafka specific exception&lt;/li&gt;
	&lt;li&gt;Ignoring the empty partition silently&lt;/li&gt;
	&lt;li&gt;Ignoring the empty partition and logging a warn&#160;&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;I would guess that 2 is the way to go, because an empty partition is technically speaking, reset to any duration or timestamp that can be requested.&lt;/p&gt;</comment>
                            <comment id="17277626" author="mjsax" created="Wed, 3 Feb 2021 01:50:42 +0000"  >&lt;p&gt;I guess the problem is, that we don&apos;t have any timestamp information from the time index, and thus we cannot get the offset we want to commit. &#8211; Silently ignoring seems the worst option from the three you suggested, because in the end, we don&apos;t know where the application will effectively start to consume &#8211; either there is an exiting committed offset or we might fall back to `auto.offset.reset`. Note, that we cannot make any assumption what the time gap between resetting and restarting is, and thus, new data might be written into the topic in the meantime. Thus,&#160;I think we should at least inform the user that no offset was committed for some partitions (and report the corresponding partitions), thus, option 3 might be the best? Option 1 would also be ok IMHO. With one is better seems to depend how &quot;robust&quot; the tool should be (don&apos;t have strong opinion about it). The point is that both options allow the user to react without the danger of unexpected behavior on restart of the application.&lt;/p&gt;

&lt;p&gt;Btw: I would assume that this issue not only affects the &quot;stream reset tool&quot; but also the &quot;consumer group&quot; tool that offset a similar feature (cf. KIP-122 &lt;a href=&quot;https://cwiki.apache.org/confluence/display/KAFKA/KIP-122%3A+Add+Reset+Consumer+Group+Offsets+tooling&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://cwiki.apache.org/confluence/display/KAFKA/KIP-122%3A+Add+Reset+Consumer+Group+Offsets+tooling&lt;/a&gt;&#160;and KIP-171 &lt;a href=&quot;https://cwiki.apache.org/confluence/display/KAFKA/KIP-171+-+Extend+Consumer+Group+Reset+Offset+for+Stream+Application&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://cwiki.apache.org/confluence/display/KAFKA/KIP-171+-+Extend+Consumer+Group+Reset+Offset+for+Stream+Application&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;Not sure what behavior &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jbfletch&quot; class=&quot;user-hover&quot; rel=&quot;jbfletch&quot;&gt;jbfletch&lt;/a&gt;&#160;had in mind? Maybe &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jeqo&quot; class=&quot;user-hover&quot; rel=&quot;jeqo&quot;&gt;jeqo&lt;/a&gt;&#160;(who proposed the feature originally) has some input?&lt;/p&gt;

&lt;p&gt;Btw: the ticket is assigned to &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jbfletch&quot; class=&quot;user-hover&quot; rel=&quot;jbfletch&quot;&gt;jbfletch&lt;/a&gt;&#160;so she should first agree to hand it off to you before you start working on it.&lt;/p&gt;</comment>
                            <comment id="17278285" author="marcolotz" created="Wed, 3 Feb 2021 18:34:00 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mjsax&quot; class=&quot;user-hover&quot; rel=&quot;mjsax&quot;&gt;mjsax&lt;/a&gt;&#160;I see your point. Indeed in this scenario makes more sense to notify the user about it.&lt;/p&gt;

&lt;p&gt;The bug is caused because of this line &lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/clients/src/main/java/org/apache/kafka/clients/consumer/internals/Fetcher.java#L516&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;&#160;- that returns by default a null value on the map.&lt;br/&gt;
 The following method&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
client.seek(topicPartition, topicPartitionsAndOffset.get(topicPartition).offset());&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;uses it as an argument without optional handling - which indeed causes a NPE for keys with null values on the map.&lt;br/&gt;
 &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jbfletch&quot; class=&quot;user-hover&quot; rel=&quot;jbfletch&quot;&gt;jbfletch&lt;/a&gt;&#160;it think it should be straight forward to fix, do you mind if I assign the bug to me?&lt;/p&gt;</comment>
                            <comment id="17278369" author="jeqo" created="Wed, 3 Feb 2021 21:38:13 +0000"  >&lt;p&gt;Hi there!&lt;/p&gt;

&lt;p&gt;The NPE is caused by topic partitions where no offset is found after a timestamp, not by consumer offsets related to the topic partition.&lt;/p&gt;

&lt;p&gt;This could mean topic-partition that hasn&apos;t received records yet, or a topic partition with no records after a retention delete exec (actually I&apos;m not sure about this scenario if it returns null or the latest known offset, but anyway).&lt;/p&gt;

&lt;p&gt;At the moment, here is how it&apos;s handled in the consumer group&apos;s reset-offset: &lt;a href=&quot;https://github.com/apache/kafka/blob/70404baffa47b99914d34143e779b0e65522a5ef/core/src/main/scala/kafka/admin/ConsumerGroupCommand.scala#L672-L688&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/70404baffa47b99914d34143e779b0e65522a5ef/core/src/main/scala/kafka/admin/ConsumerGroupCommand.scala#L672-L688&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Where, if offset by timestamp is null, then it fallbacks to the end offset. &lt;/p&gt;

&lt;p&gt;Resetting to the latest offset seem like a sensible default, as resetting by timestamp/duration command allows to go backwards (most cases) or forward (same as to-latest?). Resetting to offset=0 when no records (i.e. as backwards as possible) or offset=latest when all records removed seem to match the semantics.&lt;/p&gt;

&lt;p&gt;Also, dry-run could be seen as a kind of &quot;logging&quot;.&lt;/p&gt;

&lt;p&gt;Bringing this into the table to be considered while the NPE is fixed.&lt;/p&gt;</comment>
                            <comment id="17278386" author="mjsax" created="Wed, 3 Feb 2021 22:04:12 +0000"  >&lt;blockquote&gt;&lt;p&gt;Where, if offset by timestamp is null, then it fallbacks to the end offset.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Interesting. Was this part of the KIP design or just a PR-scoped decision? Overall, it might be best to align both tools to do the same thing?&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Also, dry-run could be seen as a kind of &quot;logging&quot;.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Well, what would --dry-run print for this case? The offset number of end-offset or a hint that it did not &quot;seek by time&quot; but defaulted to &quot;end offset&quot;. The later seems more reasonable to me? Personally, I would still suggest to also log a WARN for this case during execution, as we should not rely on people to do a dry-run first.&lt;/p&gt;</comment>
                            <comment id="17278390" author="jeqo" created="Wed, 3 Feb 2021 22:14:27 +0000"  >&lt;p&gt;&amp;gt; Interesting. Was this part of the KIP design or just a PR-scoped decision? Overall, it might be best to align both tools to do the same thing?&lt;/p&gt;

&lt;p&gt;I can&apos;t find comments about this in the KIP or the thread, so a PR-scoped decision most probably.&lt;/p&gt;

&lt;p&gt;&amp;gt; Well, what would --dry-run print for this case?&#160;&lt;/p&gt;

&lt;p&gt;Atm prints the end offset.&lt;/p&gt;

&lt;p&gt;&amp;gt; The later seems more reasonable to me? Personally, I would still suggest to also log a WARN for this case during execution, as we should not rely on people to do a dry-run first.&lt;/p&gt;

&lt;p&gt;Good point. Will create a ticket to follow this up.&lt;/p&gt;</comment>
                            <comment id="17278393" author="jeqo" created="Wed, 3 Feb 2021 22:18:24 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-12287&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-12287&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17278825" author="marcolotz" created="Thu, 4 Feb 2021 13:30:35 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jeqo&quot; class=&quot;user-hover&quot; rel=&quot;jeqo&quot;&gt;jeqo&lt;/a&gt; Understood. About returning the latest offset - if we perform no .seek() operation on empty partitions, the consumer offset will be handled by &quot;auto.offset.reset&quot; configuration - and thus by default return latest.&lt;/p&gt;

&lt;p&gt;Should I rely on this configuration or you rather have an explicit&#160;client.seekToEnd() call?&lt;/p&gt;

&lt;p&gt;Since the reporter is currently inactive and is an old ticket, I am taking it over and will forward a PR in a bit.&lt;/p&gt;</comment>
                            <comment id="17278849" author="marcolotz" created="Thu, 4 Feb 2021 14:03:31 +0000"  >&lt;p&gt;PR ready.&lt;br/&gt;
Please let me know your thoughts and what needs changing (e.g. explicit seekToEnd or the displayed message).&lt;br/&gt;
Also, I couldn&apos;t find a reason for the CI failing on JDK11 and passing on 8 and 15. Did I make something wrong or is it flaky?&lt;/p&gt;</comment>
                            <comment id="17279941" author="jbfletch" created="Fri, 5 Feb 2021 19:28:44 +0000"  >&lt;p&gt;Thanks for taking this on &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=marcolotz&quot; class=&quot;user-hover&quot; rel=&quot;marcolotz&quot;&gt;marcolotz&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17279999" author="mjsax" created="Fri, 5 Feb 2021 21:12:54 +0000"  >&lt;p&gt;Thanks everyone. I&apos;ll try to review the PR soon &#8211; but we have 2.8.0 deadline and we want to do a 2.6.2 release that I need to take care of first. &#8211; We can discuss more details on the PR. And yes, we have flaky tests so don&apos;t worry about it.&lt;/p&gt;</comment>
                            <comment id="17280187" author="jeqo" created="Sat, 6 Feb 2021 13:08:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=marcolotz&quot; class=&quot;user-hover&quot; rel=&quot;marcolotz&quot;&gt;marcolotz&lt;/a&gt;, relying on &quot;auto.offset.reset&quot; would be different from seeking to end in the specific scenario where there is new records available in a topic-partition that was empty when offsets were reset.&lt;/p&gt;

&lt;p&gt;In this scenario, when consumers resume polling, consumption from this topic-partition will be different depending on &quot;auto.offset.reset&quot;: latest or earliest.&lt;/p&gt;

&lt;p&gt;`seekToEnd` will make the starting point consistent though. To keep this change consistent with consumer-groups reset-offset, `seekToEnd` should be used.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 40 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0bafk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>