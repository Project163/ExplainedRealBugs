<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:58:01 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-4486] Kafka Streams - exception in process still commits offsets</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-4486</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>
&lt;p&gt;I&apos;m building a streams application and would like to be able to control the commits manually using ProcessorContext#commit() from an instance of org.apache.kafka.streams.processor.Processor.&lt;/p&gt;

&lt;p&gt;My use case is that I want to read messages from a topic and push them to AWS SQS and I need to be able to guarantee that all messages reach the queue at least once. I also want to use SQS batching support so my approach at the moment is that in Processor#process i&apos;m saving X records in a data structure and when I have a full batch I send it off and if successful i commit. If I for any reason can&apos;t deliver the records I don&apos;t want the offsets being committed so that when processing works again I can start processing from the last successful record.&lt;/p&gt;

&lt;p&gt;When I was trying out the error handling I noticed that if I create a Processor and in the process method always throw an exception that will trigger StreamThread#shutdownTaskAndState which calls StreamThread#commitOffsets and next time I run the application it starts as if the previous &quot;record&quot; was successfully processed.&lt;/p&gt;

&lt;p&gt;Is there a way to achieve what I&apos;m looking for?&lt;/p&gt;

&lt;p&gt;I found a similar discussion in &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3491&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-3491&lt;/a&gt; but that issue is still open.&lt;/p&gt;</description>
                <environment>Java 8</environment>
        <key id="13025268">KAFKA-4486</key>
            <summary>Kafka Streams - exception in process still commits offsets</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="enothereska">Eno Thereska</assignee>
                                    <reporter username="joel.lundell">Joel Lundell</reporter>
                        <labels>
                    </labels>
                <created>Sat, 3 Dec 2016 00:36:14 +0000</created>
                <updated>Sat, 10 Dec 2016 01:18:37 +0000</updated>
                            <resolved>Sat, 10 Dec 2016 01:18:10 +0000</resolved>
                                    <version>0.10.1.0</version>
                                    <fixVersion>0.10.2.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="15721213" author="guozhang" created="Mon, 5 Dec 2016 04:41:06 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=joel.lundell&quot; class=&quot;user-hover&quot; rel=&quot;joel.lundell&quot;&gt;joel.lundell&lt;/a&gt; Thanks for reporting your use case, which exception were you trying to throw that always triggered `StreamThread#shutdownTaskAndStat`? Streams tries to distinguish retriable exception from fatal ones and upon seeing a fatal error we should not commit the offsets while closing the instance.&lt;/p&gt;</comment>
                            <comment id="15722633" author="joel.lundell" created="Mon, 5 Dec 2016 16:09:09 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt;, I&apos;m throwing a org.apache.kafka.streams.errors.StreamsException. &lt;/p&gt;

&lt;p&gt;Let me know if I can help out in any way. &lt;/p&gt;

&lt;p&gt;Thank you, Joel.&lt;/p&gt;</comment>
                            <comment id="15722715" author="joel.lundell" created="Mon, 5 Dec 2016 16:47:15 +0000"  >&lt;p&gt;I debugged a little more and the exception escapes the run loop in StreamThread but independent on the type of exception they end up in the same finally clause and the thread shuts down. Can you point to where it tries to distinguish retriable from fatal? &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    /**
     * Execute the stream processors
     * @&lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; KafkaException &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; any Kafka-related exceptions
     * @&lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; any other non-Kafka exceptions
     */
    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void run() {
        log.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;{} Starting&quot;&lt;/span&gt;, logPrefix);

        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            runLoop();
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (KafkaException e) {
            &lt;span class=&quot;code-comment&quot;&gt;// just re-&lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; the exception as it should be logged already
&lt;/span&gt;            &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; e;
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception e) {
            &lt;span class=&quot;code-comment&quot;&gt;// we have caught all Kafka related exceptions, and other runtime exceptions
&lt;/span&gt;            &lt;span class=&quot;code-comment&quot;&gt;// should be due to user application errors
&lt;/span&gt;            log.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;{} Streams application error during processing: &quot;&lt;/span&gt;, logPrefix, e);
            &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; e;
        } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
            shutdown();
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15723370" author="guozhang" created="Mon, 5 Dec 2016 21:06:52 +0000"  >&lt;p&gt;The distinguishment is not in Streams, but in the embedded Producer / Consumer clients. Anyways, I think your raised issue is indeed a bug that we should fix: if shutdown is called through the raised exception, commit offsets step should not be triggered, though other steps like flushing the store, releasing state store dir lock should still complete.&lt;/p&gt;

&lt;p&gt;We will start to propose a fix asap on this JIRA.&lt;/p&gt;</comment>
                            <comment id="15729122" author="githubbot" created="Wed, 7 Dec 2016 16:10:03 +0000"  >&lt;p&gt;GitHub user enothereska opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/2225&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2225&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-4486&quot; title=&quot;Kafka Streams - exception in process still commits offsets&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-4486&quot;&gt;&lt;del&gt;KAFKA-4486&lt;/del&gt;&lt;/a&gt;: Don&apos;t commit offsets on exception&lt;/p&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/enothereska/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/enothereska/kafka&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-4486&quot; title=&quot;Kafka Streams - exception in process still commits offsets&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-4486&quot;&gt;&lt;del&gt;KAFKA-4486&lt;/del&gt;&lt;/a&gt;-exception-commit&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/2225.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2225.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #2225&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit fcd0e1edbd06dc47a64b72d57d155391b7680238&lt;br/&gt;
Author: Eno Thereska &amp;lt;eno.thereska@gmail.com&amp;gt;&lt;br/&gt;
Date:   2016-12-07T16:09:20Z&lt;/p&gt;

&lt;p&gt;    Don&apos;t commit offsets on exception&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15729125" author="enothereska" created="Wed, 7 Dec 2016 16:10:53 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=joel.lundell&quot; class=&quot;user-hover&quot; rel=&quot;joel.lundell&quot;&gt;joel.lundell&lt;/a&gt; thanks for the JIRA. I&apos;ve opened a PR, mind giving it a go and reporting if it sorts your scenario? Thanks.&lt;/p&gt;</comment>
                            <comment id="15733801" author="joel.lundell" created="Fri, 9 Dec 2016 00:09:23 +0000"  >&lt;p&gt;Hi! This was on the critical path of a project so I had to work around it. I won&apos;t have time to test it until sometime next week.&lt;/p&gt;

&lt;p&gt;If you can publish a snapshot so that I can just use maven to get it I could try it out faster. &lt;/p&gt;

&lt;p&gt;Thank you,&lt;br/&gt;
Joel&lt;/p&gt;</comment>
                            <comment id="15736909" author="guozhang" created="Sat, 10 Dec 2016 01:18:10 +0000"  >&lt;p&gt;Issue resolved by pull request 2225&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/kafka/pull/2225&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2225&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15736912" author="githubbot" created="Sat, 10 Dec 2016 01:18:37 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/2225&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2225&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 49 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i373vj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>