<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:24:03 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-9603] Number of open files keeps increasing in Streams application</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-9603</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Problem appeared when upgrading from &lt;b&gt;2.0.1&lt;/b&gt; to &lt;b&gt;2.3.1&lt;/b&gt;. &lt;/p&gt;

&lt;p&gt;Relevant Kafka Streams code:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
KStream&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, Event1&amp;gt; events1 =
    builder.stream(FIRST_TOPIC_NAME, Consumed.with(stringSerde, event1Serde, event1TimestampExtractor(), &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;))
           .mapValues(...);        

KStream&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, Event2&amp;gt; events2 =
    builder.stream(SECOND_TOPIC_NAME, Consumed.with(stringSerde, event2Serde, event2TimestampExtractor(), &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;))
           .mapValues(...);        

&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; joinWindows = JoinWindows.of(Duration.of(1, MINUTES).toMillis())
                             .until(Duration.of(1, HOURS).toMillis());

events2.join(events1, &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;::join, joinWindows, Joined.with(stringSerde, event2Serde, event1Serde))
               .foreach(...);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Number of open *.sst files keeps increasing until eventually it hits the os limit (65536) and causes this exception:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Caused by: org.rocksdb.RocksDBException: While open a file &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; appending: /.../0_8/KSTREAM-JOINOTHER-0000000010-store/KSTREAM-JOINOTHER-0000000010-store.1579435200000/001354.sst: Too many open files
	at org.rocksdb.RocksDB.flush(Native Method)
	at org.rocksdb.RocksDB.flush(RocksDB.java:2394)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Here are example files that are opened and never closed:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
/.../0_27/KSTREAM-JOINTHIS-0000000009-store/KSTREAM-JOINTHIS-0000000009-store.1582459200000/000114.sst
/.../0_27/KSTREAM-JOINOTHER-0000000010-store/KSTREAM-JOINOTHER-0000000010-store.1582459200000/000065.sst
/.../0_29/KSTREAM-JOINTHIS-0000000009-store/KSTREAM-JOINTHIS-0000000009-store.1582156800000/000115.sst
/.../0_29/KSTREAM-JOINTHIS-0000000009-store/KSTREAM-JOINTHIS-0000000009-store.1582459200000/000112.sst
/.../0_31/KSTREAM-JOINTHIS-0000000009-store/KSTREAM-JOINTHIS-0000000009-store.1581854400000/000051.sst
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>Spring Boot 2.2.4, OpenJDK 13, Centos image</environment>
        <key id="13287449">KAFKA-9603</key>
            <summary>Number of open files keeps increasing in Streams application</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cadonna">Bruno Cadonna</assignee>
                                    <reporter username="biljazovic">Bruno Iljazovic</reporter>
                        <labels>
                    </labels>
                <created>Tue, 25 Feb 2020 09:00:02 +0000</created>
                <updated>Tue, 9 Mar 2021 09:12:28 +0000</updated>
                            <resolved>Wed, 20 May 2020 22:11:31 +0000</resolved>
                                    <version>2.1.0</version>
                    <version>2.2.0</version>
                    <version>2.3.1</version>
                    <version>2.4.0</version>
                                    <fixVersion>2.6.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>3</votes>
                                    <watches>10</watches>
                                                                                                                <comments>
                            <comment id="17044774" author="ableegoldman" created="Tue, 25 Feb 2020 19:30:56 +0000"  >&lt;p&gt;Hey &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=biljazovic&quot; class=&quot;user-hover&quot; rel=&quot;biljazovic&quot;&gt;biljazovic&lt;/a&gt;, can you tell if this happened during restoration or were there a large number of unclosed files long after it resumed processing?&lt;/p&gt;

&lt;p&gt;The reason I ask is that during restoration Streams toggles on &quot;bulk loading&quot; mode which involves turning off auto-compaction and dumping all the data from the changelog into (uncompacted) L0 files. These are the first level files and tend to be relatively small, so if you end up with a lot of them. Once restoration is done Streams will issue a manual compaction to merge these into a fewer number of larger files, but of course you can hit system limits before it completes if you have a lot of data to restore&lt;/p&gt;</comment>
                            <comment id="17045379" author="biljazovic" created="Wed, 26 Feb 2020 10:48:12 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ableegoldman&quot; class=&quot;user-hover&quot; rel=&quot;ableegoldman&quot;&gt;ableegoldman&lt;/a&gt; thank you on your reply.&lt;/p&gt;

&lt;p&gt;This happens after restoration, sometimes even after a day of processing new messages.&lt;/p&gt;</comment>
                            <comment id="17046169" author="ableegoldman" created="Thu, 27 Feb 2020 05:11:43 +0000"  >&lt;p&gt;Admittedly a day does seem like a long time, but the rocksdb background compaction may merge the small L0 files less aggressively once they&apos;re under a certain threshold...just a wild guess. Do you mean the large number of files continues to grow up to 24hr after restoration completes, or just that it goes up during restoration and doesn&apos;t go back down again for a day?&lt;/p&gt;

&lt;p&gt;If you can increase the limit I&apos;d recommend starting there, if you have a large number of stores/task or tasks/instance then the open files can really build up.&#160;&lt;/p&gt;</comment>
                            <comment id="17046170" author="ableegoldman" created="Thu, 27 Feb 2020 05:13:36 +0000"  >&lt;p&gt;Do you notice that some of the task directories, or some of the files within a task directory, are not being actively used and haven&apos;t been touched since the upgrade?&#160;&lt;/p&gt;</comment>
                            <comment id="17046775" author="biljazovic" created="Thu, 27 Feb 2020 16:18:03 +0000"  >&lt;p&gt;Number of open files grows at constant speed from low values - on version 2.0.1 it stays at around 3000, but on 2.3.1 and 2.4.0 it starts at about 3000 and goes up from there slowly, eventually hitting 60k. With that big of a difference I didn&apos;t think increasing the OS limit would help. Up until the limit is hit, new versions process messages in the same way as the old version.&lt;/p&gt;

&lt;p&gt;More things I noticed today:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Number of files is increasing only under odd-numbered tasks&lt;/li&gt;
	&lt;li&gt;numerous files are all under ~10K in size, and in the same directory they are all around the same file size, except for one or two which are &amp;gt;5M&lt;/li&gt;
	&lt;li&gt;Memory usage or CPU usage is not higher than on previous version&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I&apos;m not sure if the same files that are opened at the beginning are still opened hours later, or if most of them are closed and new ones are opened. I&apos;ll have to check that tomorrow.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17058145" author="ableegoldman" created="Thu, 12 Mar 2020 18:00:19 +0000"  >&lt;p&gt;Hey &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=biljazovic&quot; class=&quot;user-hover&quot; rel=&quot;biljazovic&quot;&gt;biljazovic&lt;/a&gt;&#160;any new info or results? It does seem like there may be something odd going on here. Also, just to clarify this occurred when upgrading Streams from 2.0 to 2.3 right? Is the &quot;2.4&quot; listed in the affected versions the broker version?&lt;/p&gt;</comment>
                            <comment id="17058646" author="biljazovic" created="Fri, 13 Mar 2020 11:27:35 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ableegoldman&quot; class=&quot;user-hover&quot; rel=&quot;ableegoldman&quot;&gt;ableegoldman&lt;/a&gt; Unfortunately no new info, we are running 2.0 Streams for now. Problems are in both Streams versions 2.3 and 2.4. Broker versions are 2.1.1.0, message format versions 2.1-IV2&lt;/p&gt;</comment>
                            <comment id="17071090" author="biljazovic" created="Mon, 30 Mar 2020 16:00:21 +0000"  >&lt;p&gt;Tested with Kafka 2.1 and 2.2 (brokers unchanged), both have similar issues. Number of .sst files is increasing &lt;b&gt;only in every other&lt;/b&gt; task directory. &lt;/p&gt;

&lt;p&gt;Also, files that are created and opened at the start are never closed until the crash.&lt;/p&gt;</comment>
                            <comment id="17079050" author="lpandzic" created="Thu, 9 Apr 2020 08:21:42 +0000"  >&lt;p&gt;Hello, I took this task over from Bruno on the project.&lt;/p&gt;

&lt;p&gt;I&apos;ve tried:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;upgrading to 2.3&lt;/li&gt;
	&lt;li&gt;upgrading to 2.4.1&lt;/li&gt;
	&lt;li&gt;limiting number of open files with &lt;font color=&quot;#000000&quot;&gt;RocksDBConfigSetterForSeen&lt;/font&gt; - options.setMaxOpenFiles() to 1000 and 10000&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Nothing helped and results are that one instance of the service keeps opening more files continuously at a relatively steady rate (around 6k per hour).&lt;/p&gt;</comment>
                            <comment id="17079588" author="guozhang" created="Thu, 9 Apr 2020 17:28:07 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lpandzic&quot; class=&quot;user-hover&quot; rel=&quot;lpandzic&quot;&gt;lpandzic&lt;/a&gt; Thanks for the update, we will try to reproduce the observed issue first and then try to see if some leads can be found.&lt;/p&gt;</comment>
                            <comment id="17080229" author="lpandzic" created="Fri, 10 Apr 2020 05:03:46 +0000"  >&lt;p&gt;Thanks, it seems I&apos;ve been able to reproduce the issue in our test environment. I&apos;ll try to reproduce it locally and isolate the cause as much as possible, ideally I&apos;ll be able to share a project that reproduces the issue.&lt;/p&gt;</comment>
                            <comment id="17080887" author="guozhang" created="Fri, 10 Apr 2020 19:08:51 +0000"  >&lt;p&gt;Great, thanks! I&apos;d be waiting for you to share the mini project then &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="17085556" author="a6kme" created="Fri, 17 Apr 2020 08:43:53 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lpandzic&quot; class=&quot;user-hover&quot; rel=&quot;lpandzic&quot;&gt;lpandzic&lt;/a&gt;&#160;Potentially related issue with using Confluent ksql. ksql is built using kafka streams. -&#160;&lt;a href=&quot;https://github.com/confluentinc/ksql/issues/5057&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/confluentinc/ksql/issues/5057&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17090649" author="lpandzic" created="Thu, 23 Apr 2020 14:15:31 +0000"  >&lt;p&gt;Sadly, I&apos;ve been unable to reproduce the issue locally.&lt;/p&gt;

&lt;p&gt;On production however I was able to isolate the issue to upgrade of kafka-streams from 2.1.1 to 2.2.0.&lt;/p&gt;</comment>
                            <comment id="17090715" author="cadonna" created="Thu, 23 Apr 2020 15:56:53 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lpandzic&quot; class=&quot;user-hover&quot; rel=&quot;lpandzic&quot;&gt;lpandzic&lt;/a&gt; Thank you for the information. &lt;/p&gt;

&lt;p&gt;In the description is stated&lt;/p&gt;

&lt;p&gt;&lt;cite&gt;Problem appeared when upgrading from 2.0.1 to 2.3.1.&lt;/cite&gt;&lt;/p&gt;

&lt;p&gt;I guess you investigated more and you could restrict the issue to the upgrade from 2.1.1 to 2.2.0. Is this correct?&lt;/p&gt;

&lt;p&gt;I checked the RocksDB versions of this two Kafka Streams versions.&lt;br/&gt;
Kafka Streams 2.1.1 uses RocksDB 5.14.2.&lt;br/&gt;
Kafka Streams 2.2.0 uses RocksDB 5.15.10.&lt;/p&gt;</comment>
                            <comment id="17091641" author="lpandzic" created="Fri, 24 Apr 2020 15:03:51 +0000"  >&lt;p&gt;Yes, that&apos;s what I meant but &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=biljazovic&quot; class=&quot;user-hover&quot; rel=&quot;biljazovic&quot;&gt;biljazovic&lt;/a&gt; warned me about some other circumstances...&lt;/p&gt;

&lt;p&gt;Our application is running inside docker with rocksdb stateDir volume mapped to host.&lt;/p&gt;

&lt;p&gt;On kafka-streams 2.2.0 with `lsof` the problem is visible from within the container (raising number of file descriptors).&lt;/p&gt;

&lt;p&gt;On kafka-streams 2.1.0 and 2.1.1 &apos;lsof&apos; is stable from within the container, but not from host, lsof on host exhibits similar behavior to 2.2.0 from container - rising number of descriptors. Number of files problem is present on both (versions and host/container).&lt;/p&gt;</comment>
                            <comment id="17091707" author="lpandzic" created="Fri, 24 Apr 2020 16:25:29 +0000"  >&lt;p&gt;Small update: I&apos;ve been able to reproduce the last problem even with kafka-streams 2.0.1 and rocksdb 5.14.2 so it seems the problem is down to rocksdb...&lt;/p&gt;</comment>
                            <comment id="17093228" author="lpandzic" created="Mon, 27 Apr 2020 09:11:21 +0000"  >&lt;p&gt;I&apos;ve created a public github repository that reproduces the issue - &lt;a href=&quot;https://github.com/lpandzic/kafka-9603&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/lpandzic/kafka-9603&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;To reproduce follow the steps in README.md.&lt;/p&gt;</comment>
                            <comment id="17093312" author="biljazovic" created="Mon, 27 Apr 2020 10:12:57 +0000"  >&lt;p&gt;To expand on this, it seems that RocksDB version doesn&apos;t affect this problem.&lt;/p&gt;

&lt;p&gt;Instead, from Streams version 2.1.0 on, when two instances of consumer applications are started, auto compaction in RocksDB is disabled for &lt;b&gt;standby tasks&lt;/b&gt; on both instances. Furthermore, when one instance is paused, then resumed, then same with the other instance, both instances compact their stores normally.&lt;/p&gt;</comment>
                            <comment id="17093749" author="guozhang" created="Mon, 27 Apr 2020 17:07:51 +0000"  >&lt;p&gt;Thanks for uploading the reproduction repo guys! It indeed seems like regression bug.&lt;/p&gt;</comment>
                            <comment id="17097996" author="rensgroothuijsen" created="Sat, 2 May 2020 15:34:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=biljazovic&quot; class=&quot;user-hover&quot; rel=&quot;biljazovic&quot;&gt;biljazovic&lt;/a&gt; It does indeed appear to affect standby tasks only. When I run the reproduction but leave num.standby.replicas at 0, the numbers remain relatively stable.&lt;/p&gt;</comment>
                            <comment id="17105703" author="cadonna" created="Tue, 12 May 2020 20:08:33 +0000"  >&lt;p&gt;I think I found the cause of this issue. With segmented state stores (i.e., state stores used to store windowed data), bulk loading mode of RocksDB might be turned on but never off on stand-by tasks. I opened the following PR with a fix:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/kafka/pull/8661&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/8661&lt;/a&gt; &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 26 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0buw0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>