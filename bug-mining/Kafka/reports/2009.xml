<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:13:52 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-7261] Request and response total metrics record bytes instead of request count</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-7261</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Request and response total metrics seem to be recording total bytes rather than total requests since they record using a common sensor.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13177805">KAFKA-7261</key>
            <summary>Request and response total metrics record bytes instead of request count</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rsivaram">Rajini Sivaram</assignee>
                                    <reporter username="rsivaram">Rajini Sivaram</reporter>
                        <labels>
                    </labels>
                <created>Wed, 8 Aug 2018 21:50:33 +0000</created>
                <updated>Sun, 12 Aug 2018 18:15:01 +0000</updated>
                            <resolved>Sun, 12 Aug 2018 18:15:01 +0000</resolved>
                                                    <fixVersion>1.0.3</fixVersion>
                    <fixVersion>1.1.2</fixVersion>
                    <fixVersion>2.0.1</fixVersion>
                    <fixVersion>2.1.0</fixVersion>
                                    <component>metrics</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="16574696" author="githubbot" created="Thu, 9 Aug 2018 11:11:10 +0000"  >&lt;p&gt;rajinisivaram opened a new pull request #5484: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7261&quot; title=&quot;Request and response total metrics record bytes instead of request count&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7261&quot;&gt;&lt;del&gt;KAFKA-7261&lt;/del&gt;&lt;/a&gt;: Fix request total metric to count requests instead of bytes&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5484&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5484&lt;/a&gt;&lt;/p&gt;




&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16577689" author="githubbot" created="Sun, 12 Aug 2018 17:38:25 +0000"  >&lt;p&gt;rajinisivaram closed pull request #5484: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7261&quot; title=&quot;Request and response total metrics record bytes instead of request count&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7261&quot;&gt;&lt;del&gt;KAFKA-7261&lt;/del&gt;&lt;/a&gt;: Fix request total metric to count requests instead of bytes&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5484&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5484&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/clients/src/main/java/org/apache/kafka/common/metrics/stats/Meter.java b/clients/src/main/java/org/apache/kafka/common/metrics/stats/Meter.java&lt;br/&gt;
index 09263cecae8..91d4461d2b5 100644&lt;br/&gt;
&amp;#8212; a/clients/src/main/java/org/apache/kafka/common/metrics/stats/Meter.java&lt;br/&gt;
+++ b/clients/src/main/java/org/apache/kafka/common/metrics/stats/Meter.java&lt;br/&gt;
@@ -61,6 +61,9 @@ public Meter(SampledStat rateStat, MetricName rateMetricName, MetricName totalMe&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Construct a Meter with provided time unit and provided 
{@link SampledStat}
&lt;p&gt; stats for Rate&lt;br/&gt;
      */&lt;br/&gt;
     public Meter(TimeUnit unit, SampledStat rateStat, MetricName rateMetricName, MetricName totalMetricName) &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+        if (!(rateStat instanceof SampledTotal) &amp;amp;&amp;amp; !(rateStat instanceof Count)) {
+            throw new IllegalArgumentException(&quot;Meter is supported only for SampledTotal and Count&quot;);
+        }         this.total = new Total();         this.rate = new Rate(unit, rateStat);         this.rateMetricName = rateMetricName;@@ -77,6 +80,8 @@ public Meter(TimeUnit unit, SampledStat rateStat, MetricName rateMetricName, Met     @Override     public void record(MetricConfig config, double value, long timeMs) {
         rate.record(config, value, timeMs);
-        total.record(config, value, timeMs);
+        // Total metrics with Count stat should record 1.0 (as recorded in the count)
+        double totalValue = (rate.stat instanceof Count) ? 1.0 : value;
+        total.record(config, totalValue, timeMs);
     } }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;diff --git a/clients/src/main/java/org/apache/kafka/common/network/NetworkReceive.java b/clients/src/main/java/org/apache/kafka/common/network/NetworkReceive.java&lt;br/&gt;
index 355233125bc..55354ac8d64 100644&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/clients/src/main/java/org/apache/kafka/common/network/NetworkReceive.java&lt;br/&gt;
+++ b/clients/src/main/java/org/apache/kafka/common/network/NetworkReceive.java&lt;br/&gt;
@@ -146,4 +146,12 @@ public ByteBuffer payload() 
{
         return this.buffer;
     }&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;+    /**&lt;br/&gt;
+     * Returns the total size of the receive including payload and size buffer&lt;br/&gt;
+     * for use in metrics. This is consistent with &lt;/p&gt;
{@link NetworkSend#size()}
&lt;p&gt;+     */&lt;br/&gt;
+    public int size() &lt;/p&gt;
{
+        return payload().limit() + size.limit();
+    }
&lt;p&gt;+&lt;br/&gt;
 }&lt;br/&gt;
diff --git a/clients/src/main/java/org/apache/kafka/common/network/Selector.java b/clients/src/main/java/org/apache/kafka/common/network/Selector.java&lt;br/&gt;
index 8ca7fff381a..7e32509933e 100644&lt;br/&gt;
&amp;#8212; a/clients/src/main/java/org/apache/kafka/common/network/Selector.java&lt;br/&gt;
+++ b/clients/src/main/java/org/apache/kafka/common/network/Selector.java&lt;br/&gt;
@@ -862,7 +862,7 @@ private void addToCompletedReceives() {&lt;br/&gt;
     private void addToCompletedReceives(KafkaChannel channel, Deque&amp;lt;NetworkReceive&amp;gt; stagedDeque) &lt;/p&gt;
{
         NetworkReceive networkReceive = stagedDeque.poll();
         this.completedReceives.add(networkReceive);
-        this.sensors.recordBytesReceived(channel.id(), networkReceive.payload().limit());
+        this.sensors.recordBytesReceived(channel.id(), networkReceive.size());
     }

&lt;p&gt;     // only for testing&lt;br/&gt;
diff --git a/clients/src/test/java/org/apache/kafka/common/metrics/MetricsTest.java b/clients/src/test/java/org/apache/kafka/common/metrics/MetricsTest.java&lt;br/&gt;
index 59bc84e40de..5c75d03b0e6 100644&lt;br/&gt;
&amp;#8212; a/clients/src/test/java/org/apache/kafka/common/metrics/MetricsTest.java&lt;br/&gt;
+++ b/clients/src/test/java/org/apache/kafka/common/metrics/MetricsTest.java&lt;br/&gt;
@@ -465,8 +465,12 @@ public void testRateWindowing() throws Exception {&lt;br/&gt;
         Sensor s = metrics.sensor(&quot;test.sensor&quot;, cfg);&lt;br/&gt;
         MetricName rateMetricName = metrics.metricName(&quot;test.rate&quot;, &quot;grp1&quot;);&lt;br/&gt;
         MetricName totalMetricName = metrics.metricName(&quot;test.total&quot;, &quot;grp1&quot;);&lt;br/&gt;
+        MetricName countRateMetricName = metrics.metricName(&quot;test.count.rate&quot;, &quot;grp1&quot;);&lt;br/&gt;
+        MetricName countTotalMetricName = metrics.metricName(&quot;test.count.total&quot;, &quot;grp1&quot;);&lt;br/&gt;
         s.add(new Meter(TimeUnit.SECONDS, rateMetricName, totalMetricName));&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;KafkaMetric totalMetric = metrics.metrics().get(metrics.metricName(&quot;test.total&quot;, &quot;grp1&quot;));&lt;br/&gt;
+        s.add(new Meter(TimeUnit.SECONDS, new Count(), countRateMetricName, countTotalMetricName));&lt;br/&gt;
+        KafkaMetric totalMetric = metrics.metrics().get(totalMetricName);&lt;br/&gt;
+        KafkaMetric countTotalMetric = metrics.metrics().get(countTotalMetricName);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         int sum = 0;&lt;br/&gt;
         int count = cfg.samples() - 1;&lt;br/&gt;
@@ -484,11 +488,21 @@ public void testRateWindowing() throws Exception &lt;/p&gt;
{
         // prior to any time passing
         double elapsedSecs = (cfg.timeWindowMs() * (cfg.samples() - 1) + cfg.timeWindowMs() / 2) / 1000.0;
 
-        KafkaMetric rateMetric = metrics.metrics().get(metrics.metricName(&quot;test.rate&quot;, &quot;grp1&quot;));
+        KafkaMetric rateMetric = metrics.metrics().get(rateMetricName);
+        KafkaMetric countRateMetric = metrics.metrics().get(countRateMetricName);
         assertEquals(&quot;Rate(0...2) = 2.666&quot;, sum / elapsedSecs, rateMetric.value(), EPS);
+        assertEquals(&quot;Count rate(0...2) = 0.02666&quot;, count / elapsedSecs, countRateMetric.value(), EPS);
         assertEquals(&quot;Elapsed Time = 75 seconds&quot;, elapsedSecs,
                 ((Rate) rateMetric.measurable()).windowSize(cfg, time.milliseconds()) / 1000, EPS);
         assertEquals(sum, totalMetric.value(), EPS);
+        assertEquals(count, countTotalMetric.value(), EPS);
+
+        // Verify that rates are expired, but total is cumulative
+        time.sleep(cfg.timeWindowMs() * cfg.samples());
+        assertEquals(0, rateMetric.value(), EPS);
+        assertEquals(0, countRateMetric.value(), EPS);
+        assertEquals(sum, totalMetric.value(), EPS);
+        assertEquals(count, countTotalMetric.value(), EPS);
     }

&lt;p&gt;     public static class ConstantMeasurable implements Measurable &lt;/p&gt;
{
diff --git a/clients/src/test/java/org/apache/kafka/common/network/NioEchoServer.java b/clients/src/test/java/org/apache/kafka/common/network/NioEchoServer.java
index 53f9d95a55a..64b7e4e6792 100644
--- a/clients/src/test/java/org/apache/kafka/common/network/NioEchoServer.java
+++ b/clients/src/test/java/org/apache/kafka/common/network/NioEchoServer.java
@@ -120,7 +120,7 @@ public void verifyAuthenticationMetrics(int successfulAuthentications, final int
         waitForMetric(&quot;failed-authentication&quot;, failedAuthentications);
     }

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private void waitForMetric(String name, final double expectedValue) throws InterruptedException {&lt;br/&gt;
+    public void waitForMetric(String name, final double expectedValue) throws InterruptedException {&lt;br/&gt;
         final String totalName = name + &quot;-total&quot;;&lt;br/&gt;
         final String rateName = name + &quot;-rate&quot;;&lt;br/&gt;
         if (expectedValue == 0.0) {&lt;br/&gt;
diff --git a/clients/src/test/java/org/apache/kafka/common/network/SslTransportLayerTest.java b/clients/src/test/java/org/apache/kafka/common/network/SslTransportLayerTest.java&lt;br/&gt;
index 6aef2f7eda6..d70a448df22 100644
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/clients/src/test/java/org/apache/kafka/common/network/SslTransportLayerTest.java&lt;br/&gt;
+++ b/clients/src/test/java/org/apache/kafka/common/network/SslTransportLayerTest.java&lt;br/&gt;
@@ -556,6 +556,27 @@ public void testUnsupportedCiphers() throws Exception 
{
         server.verifyAuthenticationMetrics(0, 1);
     }&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;+    @Test&lt;br/&gt;
+    public void testServerRequestMetrics() throws Exception {&lt;br/&gt;
+        String node = &quot;0&quot;;&lt;br/&gt;
+        server = createEchoServer(SecurityProtocol.SSL);&lt;br/&gt;
+        createSelector(sslClientConfigs, 16384, 16384, 16384);&lt;br/&gt;
+        InetSocketAddress addr = new InetSocketAddress(&quot;localhost&quot;, server.port());&lt;br/&gt;
+        selector.connect(node, addr, 102400, 102400);&lt;br/&gt;
+        NetworkTestUtils.waitForChannelReady(selector, node);&lt;br/&gt;
+        int messageSize = 1024 * 1024;&lt;br/&gt;
+        String message = TestUtils.randomString(messageSize);&lt;br/&gt;
+        selector.send(new NetworkSend(node, ByteBuffer.wrap(message.getBytes())));&lt;br/&gt;
+        while (selector.completedReceives().isEmpty()) &lt;/p&gt;
{
+            selector.poll(100L);
+        }
&lt;p&gt;+        int totalBytes = messageSize + 4; // including 4-byte size&lt;br/&gt;
+        server.waitForMetric(&quot;incoming-byte&quot;, totalBytes);&lt;br/&gt;
+        server.waitForMetric(&quot;outgoing-byte&quot;, totalBytes);&lt;br/&gt;
+        server.waitForMetric(&quot;request&quot;, 1);&lt;br/&gt;
+        server.waitForMetric(&quot;response&quot;, 1);&lt;br/&gt;
+    }&lt;br/&gt;
+&lt;br/&gt;
     /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;selector.poll() should be able to fetch more data than netReadBuffer from the socket.&lt;br/&gt;
      */&lt;/li&gt;
&lt;/ul&gt;





&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 14 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3wunj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>junrao</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>