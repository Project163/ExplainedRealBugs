<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:53:24 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-3427] broker can return incorrect version of fetch response when the broker hits an unknown exception</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-3427</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;In FetchResponse.handleError(), we generate FetchResponse like the following, which always defaults to version 0 of the response. &lt;br/&gt;
    FetchResponse(correlationId, fetchResponsePartitionData)&lt;/p&gt;</description>
                <environment></environment>
        <key id="12951659">KAFKA-3427</key>
            <summary>broker can return incorrect version of fetch response when the broker hits an unknown exception</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="junrao">Jun Rao</assignee>
                                    <reporter username="junrao">Jun Rao</reporter>
                        <labels>
                    </labels>
                <created>Sat, 19 Mar 2016 01:13:04 +0000</created>
                <updated>Sun, 25 Feb 2018 07:12:23 +0000</updated>
                            <resolved>Sun, 20 Mar 2016 01:05:11 +0000</resolved>
                                    <version>0.9.0.1</version>
                    <version>0.10.0.0</version>
                                    <fixVersion>0.10.0.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15202467" author="githubbot" created="Sat, 19 Mar 2016 01:25:15 +0000"  >&lt;p&gt;GitHub user junrao opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/1101&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/1101&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3427&quot; title=&quot;broker can return incorrect version of fetch response when the broker hits an unknown exception&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3427&quot;&gt;&lt;del&gt;KAFKA-3427&lt;/del&gt;&lt;/a&gt;: broker can return incorrect version of fetch response when the broker hits an unknown exception&lt;/p&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/junrao/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/junrao/kafka&lt;/a&gt; kafka-3427&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/1101.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/1101.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #1101&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit d0a0c11a7704d1d5237204051187f36f6ca6b750&lt;br/&gt;
Author: Jun Rao &amp;lt;junrao@gmail.com&amp;gt;&lt;br/&gt;
Date:   2016-03-19T01:21:29Z&lt;/p&gt;

&lt;p&gt;    add versionId in FetchResponse&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15203034" author="gwenshap" created="Sun, 20 Mar 2016 01:05:11 +0000"  >&lt;p&gt;Issue resolved by pull request 1101&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/kafka/pull/1101&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/1101&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15203035" author="githubbot" created="Sun, 20 Mar 2016 01:05:25 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/1101&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/1101&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15203351" author="junrao" created="Sun, 20 Mar 2016 16:34:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aauradkar&quot; class=&quot;user-hover&quot; rel=&quot;aauradkar&quot;&gt;aauradkar&lt;/a&gt;, do you think you could patch this for the 0.9.0 branch as well? In addition to patch FetchResponse.handleError(), we also need to patch ProduceResponse.handleError() since we added the throttledTime in the response and we were still using the old Scala request/response in KafkaApis in 0.9.0. Thanks,&lt;/p&gt;</comment>
                            <comment id="15203370" author="aauradkar" created="Sun, 20 Mar 2016 17:21:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=junrao&quot; class=&quot;user-hover&quot; rel=&quot;junrao&quot;&gt;junrao&lt;/a&gt; - Certainly, I can patch 0.9. &lt;/p&gt;</comment>
                            <comment id="15209485" author="githubbot" created="Thu, 24 Mar 2016 00:19:25 +0000"  >&lt;p&gt;GitHub user auradkar opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/1128&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/1128&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3427&quot; title=&quot;broker can return incorrect version of fetch response when the broker hits an unknown exception&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3427&quot;&gt;&lt;del&gt;KAFKA-3427&lt;/del&gt;&lt;/a&gt; - Broker should return correct version of FetchResponse on exception&lt;/p&gt;

&lt;p&gt;    Merging the fix from: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3427&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-3427&lt;/a&gt;&lt;br/&gt;
    The original version of the code, returned a response using V0 of the response protocol. This caused clients to break because they expected the throttle_time_ms field to be present.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/auradkar/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/auradkar/kafka&lt;/a&gt; k-34&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/1128.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/1128.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #1128&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit e1e3cf7ce20e1f0b58e602b48d8b974a64f60cd8&lt;br/&gt;
Author: Aditya Auradkar &amp;lt;aauradkar@linkedin.com&amp;gt;&lt;br/&gt;
Date:   2016-03-24T00:15:56Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3427&quot; title=&quot;broker can return incorrect version of fetch response when the broker hits an unknown exception&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3427&quot;&gt;&lt;del&gt;KAFKA-3427&lt;/del&gt;&lt;/a&gt;: Broker should return correct version of fetch response on exception&lt;br/&gt;
    Merging fix from trunk.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16375968" author="githubbot" created="Sun, 25 Feb 2018 07:12:23 +0000"  >&lt;p&gt;hachikuji closed pull request #1128: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3427&quot; title=&quot;broker can return incorrect version of fetch response when the broker hits an unknown exception&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3427&quot;&gt;&lt;del&gt;KAFKA-3427&lt;/del&gt;&lt;/a&gt; - Broker should return correct version of FetchResponse on exception&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/1128&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/1128&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/core/src/main/scala/kafka/api/FetchRequest.scala b/core/src/main/scala/kafka/api/FetchRequest.scala&lt;br/&gt;
index 04ca157717b..191c6274929 100644&lt;br/&gt;
&amp;#8212; a/core/src/main/scala/kafka/api/FetchRequest.scala&lt;br/&gt;
+++ b/core/src/main/scala/kafka/api/FetchRequest.scala&lt;br/&gt;
@@ -148,7 +148,9 @@ case class FetchRequest(versionId: Short = FetchRequest.CurrentVersion,&lt;br/&gt;
       case (topicAndPartition, data) =&amp;gt;&lt;br/&gt;
         (topicAndPartition, FetchResponsePartitionData(ErrorMapping.codeFor(e.getClass.asInstanceOf[Class&lt;span class=&quot;error&quot;&gt;&amp;#91;Throwable&amp;#93;&lt;/span&gt;]), -1, MessageSet.Empty))&lt;br/&gt;
     }&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;val errorResponse = FetchResponse(correlationId, fetchResponsePartitionData)&lt;br/&gt;
+&lt;br/&gt;
+    val fetchRequest = request.requestObj.asInstanceOf&lt;span class=&quot;error&quot;&gt;&amp;#91;FetchRequest&amp;#93;&lt;/span&gt;&lt;br/&gt;
+    val errorResponse = FetchResponse(correlationId, fetchResponsePartitionData, fetchRequest.versionId)&lt;br/&gt;
     requestChannel.sendResponse(new RequestChannel.Response(request, new FetchResponseSend(request.connectionId, errorResponse)))&lt;br/&gt;
   }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;diff --git a/core/src/main/scala/kafka/api/ProducerRequest.scala b/core/src/main/scala/kafka/api/ProducerRequest.scala&lt;br/&gt;
index ce78f78168d..0c7510e82a7 100644&lt;br/&gt;
&amp;#8212; a/core/src/main/scala/kafka/api/ProducerRequest.scala&lt;br/&gt;
+++ b/core/src/main/scala/kafka/api/ProducerRequest.scala&lt;br/&gt;
@@ -128,7 +128,8 @@ case class ProducerRequest(versionId: Short = ProducerRequest.CurrentVersion,&lt;br/&gt;
   }&lt;/p&gt;

&lt;p&gt;   override  def handleError(e: Throwable, requestChannel: RequestChannel, request: RequestChannel.Request): Unit = {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if(request.requestObj.asInstanceOf&lt;span class=&quot;error&quot;&gt;&amp;#91;ProducerRequest&amp;#93;&lt;/span&gt;.requiredAcks == 0) {&lt;br/&gt;
+    val produceRequest = request.requestObj.asInstanceOf&lt;span class=&quot;error&quot;&gt;&amp;#91;ProducerRequest&amp;#93;&lt;/span&gt;&lt;br/&gt;
+    if(produceRequest.requiredAcks == 0) 
{
         requestChannel.closeConnection(request.processor, request)
     }
&lt;p&gt;     else &lt;/p&gt;
{
@@ -136,7 +137,7 @@ case class ProducerRequest(versionId: Short = ProducerRequest.CurrentVersion,
         case (topicAndPartition, data) =&amp;gt;
           (topicAndPartition, ProducerResponseStatus(ErrorMapping.codeFor(e.getClass.asInstanceOf[Class[Throwable]]), -1l))
       }&lt;/li&gt;
	&lt;li&gt;val errorResponse = ProducerResponse(correlationId, producerResponseStatus)&lt;br/&gt;
+      val errorResponse = ProducerResponse(correlationId, producerResponseStatus, produceRequest.versionId)&lt;br/&gt;
       requestChannel.sendResponse(new Response(request, new RequestOrResponseSend(request.connectionId, errorResponse)))&lt;br/&gt;
     }&lt;br/&gt;
   }&lt;/li&gt;
&lt;/ul&gt;





&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 38 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2uwlz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>