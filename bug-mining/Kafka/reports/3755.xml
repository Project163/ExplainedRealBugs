<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:38:37 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-16073] Kafka Tiered Storage: Consumer Fetch Error Due to Delayed localLogStartOffset Update During Segment Deletion</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-16073</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;The identified bug in Apache Kafka&apos;s tiered storage feature involves a delayed update of &lt;tt&gt;localLogStartOffset&lt;/tt&gt; in the &lt;tt&gt;UnifiedLog.deleteSegments&lt;/tt&gt; method, impacting consumer fetch operations. When segments are deleted from the log&apos;s memory state, the &lt;tt&gt;localLogStartOffset&lt;/tt&gt; isn&apos;t promptly updated. Concurrently, &lt;tt&gt;ReplicaManager.handleOffsetOutOfRangeError&lt;/tt&gt; checks if a consumer&apos;s fetch offset is less than the &lt;tt&gt;localLogStartOffset&lt;/tt&gt;. If it&apos;s greater, Kafka erroneously sends an &lt;tt&gt;OffsetOutOfRangeException&lt;/tt&gt; to the consumer.&lt;/p&gt;

&lt;p&gt;In a specific concurrent scenario, imagine sequential offsets: &lt;tt&gt;offset1 &amp;lt; offset2 &amp;lt; offset3&lt;/tt&gt;. A client requests data at &lt;tt&gt;offset2&lt;/tt&gt;. While a background deletion process removes segments from memory, it hasn&apos;t yet updated the &lt;tt&gt;LocalLogStartOffset&lt;/tt&gt; from &lt;tt&gt;offset1&lt;/tt&gt; to &lt;tt&gt;offset3&lt;/tt&gt;. Consequently, when the fetch offset (&lt;tt&gt;offset2&lt;/tt&gt;) is evaluated against the stale &lt;tt&gt;offset1&lt;/tt&gt; in &lt;tt&gt;ReplicaManager.handleOffsetOutOfRangeError&lt;/tt&gt;, it incorrectly triggers an &lt;tt&gt;OffsetOutOfRangeException&lt;/tt&gt;. This issue arises from the out-of-sync update of &lt;tt&gt;localLogStartOffset&lt;/tt&gt;, leading to incorrect handling of consumer fetch requests and potential data access errors.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13563277">KAFKA-16073</key>
            <summary>Kafka Tiered Storage: Consumer Fetch Error Due to Delayed localLogStartOffset Update During Segment Deletion</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hzh0425@apache">hzh0425</assignee>
                                    <reporter username="hzh0425@apache">hzh0425</reporter>
                        <labels>
                            <label>KIP-405</label>
                            <label>kip-405</label>
                            <label>tiered-storage</label>
                    </labels>
                <created>Mon, 1 Jan 2024 14:30:23 +0000</created>
                <updated>Wed, 24 Apr 2024 09:53:03 +0000</updated>
                            <resolved>Wed, 24 Apr 2024 09:53:03 +0000</resolved>
                                    <version>3.6.1</version>
                                    <fixVersion>3.6.3</fixVersion>
                    <fixVersion>3.7.1</fixVersion>
                    <fixVersion>3.8.0</fixVersion>
                                    <component>core</component>
                    <component>Tiered-Storage</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="17801663" author="satish.duggana" created="Tue, 2 Jan 2024 06:19:38 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hzh0425%40apache&quot; class=&quot;user-hover&quot; rel=&quot;hzh0425@apache&quot;&gt;hzh0425@apache&lt;/a&gt; for filing JIRA with a detailed description. &lt;/p&gt;

&lt;p&gt;I am trying to summarize the scenario that you mentioned earlier in JIRA description with an example. Let me know if I am missing anything here. &lt;br/&gt;
Let us assume each segment has one offset in this example.&lt;/p&gt;

&lt;p&gt;log start offset 				0&lt;br/&gt;
log end offset					10&lt;br/&gt;
local log start offset 			4 &lt;br/&gt;
fetch offset					6 &lt;br/&gt;
new local log start offset 		7&lt;/p&gt;

&lt;p&gt;Deletion based on retention configs is started and eventually updating the local log start offset as 7.&lt;/p&gt;

&lt;p&gt;There is a race condition here where the segments list is updated by removing 4, 5, and 6 offset segments in LocalLog and then updates the local-log-start-offset. But fetch offset is being served concurrently and it may throw OffsetOutOfRangeException if the inmemory segments are already removed in LocalLog and local-log-start-offset is not yet updated as 7 when it executes the &lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/core/src/main/scala/kafka/server/ReplicaManager.scala#L1866&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;code&lt;/a&gt; as it fails the condition because fetch offset(6) &amp;lt; old local-log-start-offset(4).&lt;/p&gt;</comment>
                            <comment id="17801667" author="JIRAUSER298236" created="Tue, 2 Jan 2024 06:31:28 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=satish.duggana&quot; class=&quot;user-hover&quot; rel=&quot;satish.duggana&quot;&gt;satish.duggana&lt;/a&gt; Yes, it&apos;s exactly what you described. I actually encountered this case in a production environment&lt;br/&gt;
Do you have any ideas for repair? For example, when fetching localLogStartOffset, a lock should be added&lt;/p&gt;</comment>
                            <comment id="17802000" author="JIRAUSER298236" created="Wed, 3 Jan 2024 03:23:27 +0000"  >&lt;p&gt;ping &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=satish.duggana&quot; class=&quot;user-hover&quot; rel=&quot;satish.duggana&quot;&gt;satish.duggana&lt;/a&gt;&#65292; When you are free, please help to see if there are any other solutions&lt;/p&gt;</comment>
                            <comment id="17802024" author="satish.duggana" created="Wed, 3 Jan 2024 06:24:38 +0000"  >&lt;p&gt;That was a good catch &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hzh0425%40apache&quot; class=&quot;user-hover&quot; rel=&quot;hzh0425@apache&quot;&gt;hzh0425@apache&lt;/a&gt; !&lt;/p&gt;

&lt;p&gt;I think it is better to avoid holding a lock for local-log-start-offset updates or fetches, that can introduce other side effects.&lt;/p&gt;

&lt;p&gt;We discussed one possible solution is to address it by updating local-log-start-offset before the segments are removed from inmemory and scheduled for deletion but we need to think through the end to end scenarios. cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Kamal+C&quot; class=&quot;user-hover&quot; rel=&quot;Kamal C&quot;&gt;Kamal C&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17802095" author="JIRAUSER298236" created="Wed, 3 Jan 2024 09:53:44 +0000"  >&lt;p&gt;Yes, this is another good solution, localLogStartOffset will always &amp;gt;= baseSegment.startOffset().&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=satish.duggana&quot; class=&quot;user-hover&quot; rel=&quot;satish.duggana&quot;&gt;satish.duggana&lt;/a&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17803486" author="ckamal" created="Fri, 5 Jan 2024 10:11:00 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hzh0425%40apache&quot; class=&quot;user-hover&quot; rel=&quot;hzh0425@apache&quot;&gt;hzh0425@apache&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;Are you working on this issue? Shall I take it over?&lt;/p&gt;</comment>
                            <comment id="17803517" author="JIRAUSER298236" created="Fri, 5 Jan 2024 11:37:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ckamal&quot; class=&quot;user-hover&quot; rel=&quot;ckamal&quot;&gt;ckamal&lt;/a&gt;&#160;&lt;br/&gt;
yes, Im working on it, and we can solve it together&lt;/p&gt;</comment>
                            <comment id="17803768" author="JIRAUSER298236" created="Sat, 6 Jan 2024 07:57:25 +0000"  >&lt;p&gt;I think we can solve this issue by change the order the following code:&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// code placeholder
&lt;/span&gt;localLog.removeAndDeleteSegments(segmentsToDelete, asyncDelete = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, reason)

incrementStartOffset(localLog.segments.firstSegmentBaseOffset.getAsLong, LogStartOffsetIncrementReason.SegmentDeletion) &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;to&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// code placeholder
&lt;/span&gt;newLocalLogStartOffset = localLog.segments.higherSegment(deletable.last.baseOffset()).get().baseOffset()

incrementStartOffset(newLocalLogStartOffset, LogStartOffsetIncrementReason.SegmentDeletion) 

localLog.removeAndDeleteSegments(segmentsToDelete, asyncDelete = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, reason)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ckamal&quot; class=&quot;user-hover&quot; rel=&quot;ckamal&quot;&gt;ckamal&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=satish.duggana&quot; class=&quot;user-hover&quot; rel=&quot;satish.duggana&quot;&gt;satish.duggana&lt;/a&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17803940" author="ckamal" created="Sun, 7 Jan 2024 12:17:09 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hzh0425%40apache&quot; class=&quot;user-hover&quot; rel=&quot;hzh0425@apache&quot;&gt;hzh0425@apache&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;The approach LGTM. Could you please open a PR? we can discuss the solution over there.&lt;/p&gt;</comment>
                            <comment id="17803977" author="JIRAUSER298236" created="Sun, 7 Jan 2024 15:50:11 +0000"  >&lt;p&gt;Sure:&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ckamal&quot; class=&quot;user-hover&quot; rel=&quot;ckamal&quot;&gt;ckamal&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=satish.duggana&quot; class=&quot;user-hover&quot; rel=&quot;satish.duggana&quot;&gt;satish.duggana&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/kafka/pull/15141&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/15141&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17804124" author="satish.duggana" created="Mon, 8 Jan 2024 05:39:15 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hzh0425%40apache&quot; class=&quot;user-hover&quot; rel=&quot;hzh0425@apache&quot;&gt;hzh0425@apache&lt;/a&gt;, we can discuss the details in the PR.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310460">
                    <name>Child-Issue</name>
                                                                <inwardlinks description="is a child of">
                                        <issuelink>
            <issuekey id="13549279">KAFKA-15420</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10431"><![CDATA[Important]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 44 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1miaw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>