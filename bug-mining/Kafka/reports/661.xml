<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:43:07 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-2118] Cleaner cannot clean after shutdown during replaceSegments</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-2118</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;If a broker shuts down after the cleaner calls replaceSegments with more than one segment, the partition can be left in an uncleanable state. We saw this on a few brokers after doing a rolling update. The sequence of things we saw is:&lt;/p&gt;

&lt;p&gt;1) Cleaner cleaned segments with base offsets 0, 1094621529, and 1094831997 into a new segment 0.&lt;br/&gt;
2) Cleaner logged &quot;Swapping in cleaned segment 0 for segment(s) 0,1094621529,1094831997 in log xxx-15.&quot; and called replaceSegments.&lt;br/&gt;
3) 0.cleaned was renamed to 0.swap.&lt;br/&gt;
4) Broker shut down before deleting segments 1094621529 and 1094831997.&lt;br/&gt;
5) Broker started up and logged &quot;Found log file /mnt/persistent/kafka-logs/xxx-15/00000000000000000000.log.swap from interrupted swap operation, repairing.&quot;&lt;br/&gt;
6) Cleaner thread died with the exception &quot;kafka.common.InvalidOffsetException: Attempt to append an offset (1094911424) to position 1003 no larger than the last offset appended (1095045873) to /mnt/persistent/kafka-logs/xxx-15/00000000000000000000.index.cleaned.&quot;&lt;/p&gt;

&lt;p&gt;I think what&apos;s happening in #6 is that when the broker started back up and repaired the log, segment 0 ended up with a bunch of messages that were also in segment 1094621529 and 1094831997 (because the new segment 0 was created from cleaning all 3). But segments 1094621529 and 1094831997 were still on disk, so offsets on disk were no longer monotonically increasing, violating the assumption of OffsetIndex. We ended up fixing this by deleting segments 1094621529 and 1094831997 manually, and then removing the line for this partition from the cleaner-offset-checkpoint file (otherwise it would reference the non-existent segment 1094621529).&lt;/p&gt;

&lt;p&gt;This can happen even on a clean shutdown (the async deletes in replaceSegments might not happen).&lt;/p&gt;

&lt;p&gt;Cleaner logs post-startup:&lt;br/&gt;
2015-04-12 15:07:56,533 INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;kafka-log-cleaner-thread-0&amp;#93;&lt;/span&gt; kafka.log.LogCleaner - Cleaner 0: Beginning cleaning of log xxx-15.&lt;br/&gt;
2015-04-12 15:07:56,533 INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;kafka-log-cleaner-thread-0&amp;#93;&lt;/span&gt; kafka.log.LogCleaner - Cleaner 0: Building offset map for xxx-15...&lt;br/&gt;
2015-04-12 15:07:56,595 INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;kafka-log-cleaner-thread-0&amp;#93;&lt;/span&gt; kafka.log.LogCleaner - Cleaner 0: Building offset map for log xxx-15 for 6 segments in offset range [1094621529, 1095924157).&lt;br/&gt;
2015-04-12 15:08:01,443 INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;kafka-log-cleaner-thread-0&amp;#93;&lt;/span&gt; kafka.log.LogCleaner - Cleaner 0: Offset map for log xxx-15 complete.&lt;br/&gt;
2015-04-12 15:08:01,443 INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;kafka-log-cleaner-thread-0&amp;#93;&lt;/span&gt; kafka.log.LogCleaner - Cleaner 0: Cleaning log xxx-15 (discarding tombstones prior to Sun Apr 12 14:05:37 UTC 2015)...&lt;br/&gt;
2015-04-12 15:08:01,443 INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;kafka-log-cleaner-thread-0&amp;#93;&lt;/span&gt; kafka.log.LogCleaner - Cleaner 0: Cleaning segment 0 in log xxx-15 (last modified Sun Apr 12 14:05:38 UTC 2015) into 0, retaining deletes.&lt;br/&gt;
2015-04-12 15:08:04,283 INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;kafka-log-cleaner-thread-0&amp;#93;&lt;/span&gt; kafka.log.LogCleaner - Cleaner 0: Cleaning segment 1094621529 in log xxx-15 (last modified Sun Apr 12 13:49:27 UTC 2015) into 0, discarding deletes.&lt;br/&gt;
2015-04-12 15:08:05,079 INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;kafka-log-cleaner-thread-0&amp;#93;&lt;/span&gt; kafka.log.LogCleaner - Cleaner 0: Cleaning segment 1094831997 in log xxx-15 (last modified Sun Apr 12 14:04:28 UTC 2015) into 0, discarding deletes.&lt;br/&gt;
2015-04-12 15:08:05,157 ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;kafka-log-cleaner-thread-0&amp;#93;&lt;/span&gt; kafka.log.LogCleaner - &lt;span class=&quot;error&quot;&gt;&amp;#91;kafka-log-cleaner-thread-0&amp;#93;&lt;/span&gt;, Error due to&lt;br/&gt;
kafka.common.InvalidOffsetException: Attempt to append an offset (1094911424) to position 1003 no larger than the last offset appended (1095045873) to /mnt/persistent/kafka-logs/xxx-15/00000000000000000000.index.&lt;br/&gt;
cleaned.&lt;br/&gt;
at kafka.log.OffsetIndex$$anonfun$append$1.apply$mcV$sp(OffsetIndex.scala:207)&lt;br/&gt;
at kafka.log.OffsetIndex$$anonfun$append$1.apply(OffsetIndex.scala:197)&lt;br/&gt;
at kafka.log.OffsetIndex$$anonfun$append$1.apply(OffsetIndex.scala:197)&lt;br/&gt;
at kafka.utils.Utils$.inLock(Utils.scala:535)&lt;br/&gt;
at kafka.log.OffsetIndex.append(OffsetIndex.scala:197)&lt;br/&gt;
at kafka.log.LogSegment.append(LogSegment.scala:81)&lt;br/&gt;
at kafka.log.Cleaner.cleanInto(LogCleaner.scala:427)&lt;br/&gt;
at kafka.log.Cleaner$$anonfun$cleanSegments$1.apply(LogCleaner.scala:358)&lt;br/&gt;
at kafka.log.Cleaner$$anonfun$cleanSegments$1.apply(LogCleaner.scala:354)&lt;br/&gt;
at scala.collection.immutable.List.foreach(List.scala:318)&lt;br/&gt;
at kafka.log.Cleaner.cleanSegments(LogCleaner.scala:354)&lt;br/&gt;
at kafka.log.Cleaner$$anonfun$clean$4.apply(LogCleaner.scala:321)&lt;br/&gt;
at kafka.log.Cleaner$$anonfun$clean$4.apply(LogCleaner.scala:320)&lt;br/&gt;
at scala.collection.immutable.List.foreach(List.scala:318)&lt;br/&gt;
at kafka.log.Cleaner.clean(LogCleaner.scala:320)&lt;br/&gt;
at kafka.log.LogCleaner$CleanerThread.cleanOrSleep(LogCleaner.scala:221)&lt;br/&gt;
at kafka.log.LogCleaner$CleanerThread.doWork(LogCleaner.scala:199)&lt;br/&gt;
at kafka.utils.ShutdownableThread.run(ShutdownableThread.scala:60)&lt;br/&gt;
2015-04-12 15:08:05,157 INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;kafka-log-cleaner-thread-0&amp;#93;&lt;/span&gt; kafka.log.LogCleaner - &lt;span class=&quot;error&quot;&gt;&amp;#91;kafka-log-cleaner-thread-0&amp;#93;&lt;/span&gt;, Stopped&lt;/p&gt;</description>
                <environment></environment>
        <key id="12820575">KAFKA-2118</key>
            <summary>Cleaner cannot clean after shutdown during replaceSegments</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rsivaram">Rajini Sivaram</assignee>
                                    <reporter username="gian">Gian Merlino</reporter>
                        <labels>
                    </labels>
                <created>Mon, 13 Apr 2015 16:38:32 +0000</created>
                <updated>Mon, 27 Apr 2015 00:17:51 +0000</updated>
                            <resolved>Mon, 27 Apr 2015 00:17:51 +0000</resolved>
                                    <version>0.8.2.0</version>
                                    <fixVersion>0.9.0.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14494184" author="rsivaram" created="Tue, 14 Apr 2015 14:49:47 +0000"  >&lt;p&gt;Created reviewboard &lt;a href=&quot;https://reviews.apache.org/r/33168/diff/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/33168/diff/&lt;/a&gt;&lt;br/&gt;
 against branch origin/trunk&lt;/p&gt;</comment>
                            <comment id="14494214" author="rsivaram" created="Tue, 14 Apr 2015 15:06:03 +0000"  >&lt;p&gt;Looking at the code, the sequence for replacing segments is:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Cleaner cleans a sequence of segments into a new segment with suffix .cleaned&lt;/li&gt;
	&lt;li&gt;.cleaned is renamed to .swap.&lt;/li&gt;
	&lt;li&gt;Old segments are renamed, adding .deleted suffix&lt;/li&gt;
	&lt;li&gt;Async deletion of .deleted files is scheduled&lt;/li&gt;
	&lt;li&gt;.swap suffix is removed from the swap file, resulting in the swap file replacing the segments&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;The different scenarios for recovery are:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;If broker crashes before 2), .cleaned files are deleted on startup, aborting the clean operation. No issues here.&lt;/li&gt;
	&lt;li&gt;There is an issue if the broker crashes between 2) and 3). If the .swap file was created, but the old segment files were not yet renamed to .deleted, the current recovery process replaces the segment file with the swap file, but does not delete the old segment files.&lt;/li&gt;
	&lt;li&gt;If broker crashes after 3), recovery works fine on startup because old segment files no longer exist and any .deleted files found on startup are deleted, completing 4). If .swap was not yet renamed, it is renamed on startup, completing 5). There are no issues here. As far as I can tell, graceful shutdown is similar to this case and should work fine since the log files being deleted would have been renamed to .deleted.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;To fix the second scenario above, the recovery operation should delete any remaining log files corresponding to the .swap file before the .swap file replaces the actual log file.&lt;/p&gt;

&lt;p&gt;The attached patch fixes the recovery process by invoking the same replaceSegments() method during recovery, leaving all the logic for crash-safe swapping in one place.&lt;/p&gt;</comment>
                            <comment id="14495943" author="rsivaram" created="Wed, 15 Apr 2015 09:44:45 +0000"  >&lt;p&gt;Updated reviewboard &lt;a href=&quot;https://reviews.apache.org/r/33168/diff/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/33168/diff/&lt;/a&gt;&lt;br/&gt;
 against branch origin/trunk&lt;/p&gt;</comment>
                            <comment id="14495952" author="rsivaram" created="Wed, 15 Apr 2015 09:52:46 +0000"  >&lt;p&gt;Have updated the patch with an unit test to check recovery process after broker crash at different stages of a clean and swap operation. Test fails with current Kafka code and works with the updated code in the patch. &lt;/p&gt;

&lt;p&gt;Have also done manual testing by recreating the scenario described in this report by forcing termination during replaceSegments(). Have tested that the failure no longer occurs with the attached patch with the same manual test.&lt;/p&gt;</comment>
                            <comment id="14502061" author="rsivaram" created="Sun, 19 Apr 2015 19:03:22 +0000"  >&lt;p&gt;Updated reviewboard &lt;a href=&quot;https://reviews.apache.org/r/33168/diff/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/33168/diff/&lt;/a&gt;&lt;br/&gt;
 against branch origin/trunk&lt;/p&gt;</comment>
                            <comment id="14502104" author="rsivaram" created="Sun, 19 Apr 2015 20:05:51 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=junrao&quot; class=&quot;user-hover&quot; rel=&quot;junrao&quot;&gt;junrao&lt;/a&gt; Thank you for the review. Code comments have been updated in the latest patch.&lt;/p&gt;</comment>
                            <comment id="14502317" author="junrao" created="Mon, 20 Apr 2015 04:05:02 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rsivaram&quot; class=&quot;user-hover&quot; rel=&quot;rsivaram&quot;&gt;rsivaram&lt;/a&gt;, your latest patch looks good to me.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jkreps&quot; class=&quot;user-hover&quot; rel=&quot;jkreps&quot;&gt;jkreps&lt;/a&gt;, do you want to take another look of the patch?&lt;/p&gt;</comment>
                            <comment id="14503128" author="jkreps" created="Mon, 20 Apr 2015 16:26:06 +0000"  >&lt;p&gt;I don&apos;t think I&apos;ll get to it, go ahead without me. Just be careful, that code is a bit tricky.&lt;/p&gt;</comment>
                            <comment id="14513343" author="junrao" created="Mon, 27 Apr 2015 00:17:51 +0000"  >&lt;p&gt;Thanks for the latest patch. +1 and committed to trunk.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12725241" name="KAFKA-2118.patch" size="5859" author="rsivaram" created="Tue, 14 Apr 2015 14:49:46 +0000"/>
                            <attachment id="12725532" name="KAFKA-2118_2015-04-15_09:43:51.patch" size="11299" author="rsivaram" created="Wed, 15 Apr 2015 09:44:44 +0000"/>
                            <attachment id="12726458" name="KAFKA-2118_2015-04-19_19:02:38.patch" size="11614" author="rsivaram" created="Sun, 19 Apr 2015 19:03:21 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 30 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2d6rb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>