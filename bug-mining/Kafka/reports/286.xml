<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:38:20 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-905] Logs can have same offsets causing recovery failure</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-905</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Consider the following scenario - &lt;/p&gt;

&lt;p&gt;L                       F&lt;br/&gt;
1  m1,m2        1 m1,m2&lt;br/&gt;
3  m3,m4        3 m3,m4&lt;br/&gt;
5  m5,m6        5 m5,m6&lt;/p&gt;

&lt;p&gt;HW = 6           HW = 4&lt;/p&gt;

&lt;p&gt;Follower goes down and comes back up. Truncates its log to HW&lt;/p&gt;

&lt;p&gt;L                             F&lt;br/&gt;
1  m1,m2               1 m1,m2&lt;br/&gt;
3  m3,m4               3 m3,m4&lt;br/&gt;
5  m5,m6&lt;/p&gt;

&lt;p&gt;HW = 6            HW = 4&lt;/p&gt;

&lt;p&gt;Before follower catches up with the leader, leader goes down and follower becomes the leader. It then gets new messages&lt;/p&gt;

&lt;p&gt;F                       L&lt;br/&gt;
1  m1,m2        1  m1,m2&lt;br/&gt;
3  m3,m4        3  m3,m4&lt;br/&gt;
5  m5,m6      10 m5-m10&lt;/p&gt;

&lt;p&gt;HW=6              HW=4&lt;/p&gt;

&lt;p&gt;follower fetches from offset 7. Since offset 7 is within the compressed message 10 in the leader, the whole message chunk is sent to the follower&lt;/p&gt;

&lt;p&gt;F                        L      &lt;br/&gt;
1   m1,m2         1  m1,m2&lt;br/&gt;
3   m3,m4         3  m3,m4  &lt;br/&gt;
5   m5,m6       10  m5-m10&lt;br/&gt;
10 m5-m10&lt;/p&gt;

&lt;p&gt;HW=4               HW=10&lt;/p&gt;

&lt;p&gt;The follower logs now contain the same offsets. On recovery, re-indexing will fail due to repeated offsets.&lt;/p&gt;

&lt;p&gt;Possible ways to fix this - &lt;br/&gt;
1. The fetcher thread can do deep iteration instead of shallow iteration and drop the offsets that are less than the log end offset. This would however incur performance hit.&lt;br/&gt;
2. To optimize step 1, we could do the deep iteration till the logical offset of the fetched message set is greater than the log end offset of the follower log and then switch to shallow iteration.&lt;br/&gt;
3. On recovery we just truncate the active segment and refetch the data.&lt;/p&gt;

&lt;p&gt;All the above 3 steps are hacky. The right fix is to ensure we never corrupt the logs. We can incur data loss but should not compromise consistency. For 0.8, the easiest and simplest fix would be 3. &lt;/p&gt;</description>
                <environment></environment>
        <key id="12647785">KAFKA-905</key>
            <summary>Logs can have same offsets causing recovery failure</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sriramsub">Sriram</assignee>
                                    <reporter username="sriramsub">Sriram</reporter>
                        <labels>
                    </labels>
                <created>Wed, 15 May 2013 17:17:49 +0000</created>
                <updated>Mon, 10 Jun 2013 17:20:34 +0000</updated>
                            <resolved>Tue, 4 Jun 2013 00:05:35 +0000</resolved>
                                    <version>0.8.0</version>
                                    <fixVersion>0.8.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="13658556" author="sriramsub" created="Wed, 15 May 2013 17:24:10 +0000"  >&lt;p&gt;Attached a file that has the right formatting. JIRA seems to swallow the spaces.&lt;/p&gt;</comment>
                            <comment id="13670898" author="sriramsub" created="Thu, 30 May 2013 22:35:58 +0000"  >&lt;p&gt;We have decided to fix this using step 3 above. We just truncate the active segment to the start offset and re-fetch the data.&lt;/p&gt;</comment>
                            <comment id="13671553" author="junrao" created="Fri, 31 May 2013 15:12:37 +0000"  >&lt;p&gt;Thanks for the patch. Looks good. Some minor comments:&lt;/p&gt;

&lt;p&gt;1. Log: &lt;br/&gt;
1.1 logSegments.get(logSegments.size - 1) is used twice when handling InvalidOffsetExcetpion. Could we just call it once and reuse the result?&lt;br/&gt;
1.2 The info logging should probably be warning. Also, it would be useful to log the dir name so that we know the topic/partition.&lt;/p&gt;

&lt;p&gt;2. OffsetIndex: It would be useful to include the full file name in the message of the exception so that we know the topic/partition.&lt;/p&gt;

&lt;p&gt;3. The patch doesn&apos;t compile since it&apos;s missing the new file InvalidOffsetExcetpion.&lt;/p&gt;</comment>
                            <comment id="13671678" author="nehanarkhede" created="Fri, 31 May 2013 17:33:38 +0000"  >&lt;p&gt;Great catch, patch looks good except the new exception file is missing.&lt;/p&gt;</comment>
                            <comment id="13671741" author="jkreps" created="Fri, 31 May 2013 18:56:43 +0000"  >&lt;p&gt;This patch looks good. One thing worth pointing out is that any corruption will result in deleting the corrupt file which will potentially make it hard to debug.&lt;/p&gt;

&lt;p&gt;I am +1 if we have also a patch for trunk.&lt;/p&gt;</comment>
                            <comment id="13673796" author="sriramsub" created="Mon, 3 Jun 2013 23:44:55 +0000"  >&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;made the logging changes&lt;/li&gt;
	&lt;li&gt;added the missing file&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13673831" author="nehanarkhede" created="Tue, 4 Jun 2013 00:05:35 +0000"  >&lt;p&gt;Thanks for v2, committed it to 0.8&lt;/p&gt;</comment>
                            <comment id="13673852" author="sriramsub" created="Tue, 4 Jun 2013 00:24:01 +0000"  >&lt;p&gt;changes for trunk&lt;/p&gt;</comment>
                            <comment id="13679632" author="sriramsub" created="Mon, 10 Jun 2013 17:07:02 +0000"  >&lt;p&gt;Ping...Take a look at the patch for trunk.&lt;/p&gt;</comment>
                            <comment id="13679647" author="junrao" created="Mon, 10 Jun 2013 17:20:34 +0000"  >&lt;p&gt;I have a pending merge from trunk (kafka-896). I&apos;d like to get that in before this patch.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12586003" name="KAFKA-905-trunk.patch" size="6082" author="sriramsub" created="Tue, 4 Jun 2013 00:24:01 +0000"/>
                            <attachment id="12585994" name="KAFKA-905-v2.patch" size="6358" author="sriramsub" created="Mon, 3 Jun 2013 23:44:55 +0000"/>
                            <attachment id="12585495" name="KAFKA-905.patch" size="4849" author="sriramsub" created="Thu, 30 May 2013 22:35:58 +0000"/>
                            <attachment id="12583339" name="KAFKA-905.rtf" size="2813" author="sriramsub" created="Wed, 15 May 2013 17:24:10 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>328141</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 24 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1km7b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>328485</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>