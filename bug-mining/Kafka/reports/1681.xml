<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:03:53 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-5957] Producer IllegalStateException due to second deallocate after aborting a batch</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-5957</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Saw this recently in a system test failure:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;[2017-09-21 05:04:52,033] ERROR [Producer clientId=producer-1, transactionalId=my-second-transactional-id] Aborting producer batches due to fatal error (org.apache.kafka.clients.producer.internals.Sender)
org.apache.kafka.common.KafkaException: The client hasn&lt;span class=&quot;code-quote&quot;&gt;&apos;t received acknowledgment &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; some previously sent messages and can no longer retry them. It isn&apos;&lt;/span&gt;t safe to &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;.
        at org.apache.kafka.clients.producer.internals.Sender.run(Sender.java:211)
        at org.apache.kafka.clients.producer.internals.Sender.run(Sender.java:164)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
[2017-09-21 05:04:52,033] TRACE Aborting batch &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition output-topic-2 (org.apache.kafka.clients.producer.internals.ProducerBatch)
org.apache.kafka.common.KafkaException: The client hasn&lt;span class=&quot;code-quote&quot;&gt;&apos;t received acknowledgment &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; some previously sent messages and can no longer retry them. It isn&apos;&lt;/span&gt;t safe to &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;.
        at org.apache.kafka.clients.producer.internals.Sender.run(Sender.java:211)
        at org.apache.kafka.clients.producer.internals.Sender.run(Sender.java:164)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
[2017-09-21 05:04:52,134] TRACE [Producer clientId=producer-1, transactionalId=my-second-transactional-id] Not sending transactional request (type=EndTxnRequest, transactionalId=my-second-transactional-id, producerId=1000, producerEpoch=0, result=COMMIT) because we are in an error state (org.apache.kafka.clients.producer.internals.TransactionManager)
[2017-09-21 05:04:52,134] INFO [Producer clientId=producer-1, transactionalId=my-second-transactional-id] Closing the Kafka producer with timeoutMillis = 9223372036854775807 ms. (org.apache.kafka.clients.producer.KafkaProducer)
[2017-09-21 05:04:52,134] DEBUG [Producer clientId=producer-1, transactionalId=my-second-transactional-id] Beginning shutdown of Kafka producer I/O thread, sending remaining records. (org.apache.kafka.clients.producer.internals.Sender)
[2017-09-21 05:04:52,360] TRACE [Producer clientId=producer-1, transactionalId=my-second-transactional-id] Received produce response from node 1 with correlation id 245 (org.apache.kafka.clients.producer.internals.Sender)
[2017-09-21 05:04:52,360] DEBUG [Producer clientId=producer-1, transactionalId=my-second-transactional-id] ProducerId: 1000; Set last ack&apos;d sequence number &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; topic-partition output-topic-2 to 136 (org.apache.kafka.clients.producer.internals.Sender)
[2017-09-21 05:04:52,360] TRACE Successfully produced messages to output-topic-2 with base offset 387. (org.apache.kafka.clients.producer.internals.ProducerBatch)
[2017-09-21 05:04:52,360] DEBUG ProduceResponse returned &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; output-topic-2 after batch had already been aborted. (org.apache.kafka.clients.producer.internals.ProducerBatch)
[2017-09-21 05:04:52,360] ERROR [Producer clientId=producer-1, transactionalId=my-second-transactional-id] Uncaught error in request completion: (org.apache.kafka.clients.NetworkClient)
java.lang.IllegalStateException: Remove from the incomplete set failed. This should be impossible.
        at org.apache.kafka.clients.producer.internals.IncompleteBatches.remove(IncompleteBatches.java:44)
        at org.apache.kafka.clients.producer.internals.RecordAccumulator.deallocate(RecordAccumulator.java:612)
        at org.apache.kafka.clients.producer.internals.Sender.completeBatch(Sender.java:585)
        at org.apache.kafka.clients.producer.internals.Sender.completeBatch(Sender.java:561)
        at org.apache.kafka.clients.producer.internals.Sender.handleProduceResponse(Sender.java:475)
        at org.apache.kafka.clients.producer.internals.Sender.access$100(Sender.java:74)
        at org.apache.kafka.clients.producer.internals.Sender$1.onComplete(Sender.java:685)
        at org.apache.kafka.clients.ClientResponse.onComplete(ClientResponse.java:101)
        at org.apache.kafka.clients.NetworkClient.completeResponses(NetworkClient.java:481)
        at org.apache.kafka.clients.NetworkClient.poll(NetworkClient.java:473)
        at org.apache.kafka.clients.producer.internals.Sender.run(Sender.java:225)
        at org.apache.kafka.clients.producer.internals.Sender.run(Sender.java:177)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Although we allow a batch to be aborted before it returns, we are not careful about preventing a second call to &lt;tt&gt;deallocate()&lt;/tt&gt; which causes this error.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13104120">KAFKA-5957</key>
            <summary>Producer IllegalStateException due to second deallocate after aborting a batch</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hachikuji">Jason Gustafson</assignee>
                                    <reporter username="hachikuji">Jason Gustafson</reporter>
                        <labels>
                    </labels>
                <created>Thu, 21 Sep 2017 23:38:47 +0000</created>
                <updated>Tue, 23 Jul 2019 14:49:16 +0000</updated>
                            <resolved>Fri, 29 Sep 2017 02:24:56 +0000</resolved>
                                                    <fixVersion>1.0.0</fixVersion>
                                    <component>producer </component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16175704" author="githubbot" created="Fri, 22 Sep 2017 00:19:56 +0000"  >&lt;p&gt;GitHub user hachikuji opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/3942&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3942&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5957&quot; title=&quot;Producer IllegalStateException due to second deallocate after aborting a batch&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-5957&quot;&gt;&lt;del&gt;KAFKA-5957&lt;/del&gt;&lt;/a&gt;: Prevent second deallocate if response for aborted batch returns&lt;/p&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/hachikuji/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/hachikuji/kafka&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5957&quot; title=&quot;Producer IllegalStateException due to second deallocate after aborting a batch&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-5957&quot;&gt;&lt;del&gt;KAFKA-5957&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/3942.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3942.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #3942&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 4974842e629c098b0d36bc42e189bff211e7faac&lt;br/&gt;
Author: Jason Gustafson &amp;lt;jason@confluent.io&amp;gt;&lt;br/&gt;
Date:   2017-09-22T00:09:30Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5957&quot; title=&quot;Producer IllegalStateException due to second deallocate after aborting a batch&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-5957&quot;&gt;&lt;del&gt;KAFKA-5957&lt;/del&gt;&lt;/a&gt;: Prevent second deallocate if produce response for aborted batch returns&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16185267" author="githubbot" created="Fri, 29 Sep 2017 02:22:24 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/3942&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3942&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16891098" author="mbarbon" created="Tue, 23 Jul 2019 14:49:16 +0000"  >&lt;p&gt;This is still happening with versions 2.1 and 2.3 of the client, see &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-8325&quot; title=&quot;Remove from the incomplete set failed. This should be impossible&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-8325&quot;&gt;&lt;del&gt;KAFKA-8325&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 17 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3kdxb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>