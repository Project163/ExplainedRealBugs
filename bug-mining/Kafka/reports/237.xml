<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:37:44 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-804] Incorrect index in the log of a follower</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-804</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;In the follower, in log.append(), we use the offset of the 1st compressed message as the offset for appending index entries. This means that the index is pointing to an earlier position in the file than it should.  Instead, it should use the offset of the 1st uncompressed message for appending index.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12636905">KAFKA-804</key>
            <summary>Incorrect index in the log of a follower</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="junrao">Jun Rao</assignee>
                                    <reporter username="junrao">Jun Rao</reporter>
                        <labels>
                    </labels>
                <created>Thu, 14 Mar 2013 00:05:04 +0000</created>
                <updated>Tue, 19 Mar 2013 20:35:51 +0000</updated>
                            <resolved>Mon, 18 Mar 2013 22:57:52 +0000</resolved>
                                    <version>0.8.0</version>
                                    <fixVersion>0.8.0</fixVersion>
                                    <component>core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13601860" author="junrao" created="Thu, 14 Mar 2013 00:06:56 +0000"  >&lt;p&gt;Attach a patch. It always uses the nextOffset before append as the 1st offset.&lt;/p&gt;</comment>
                            <comment id="13602034" author="nehanarkhede" created="Thu, 14 Mar 2013 05:03:38 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13602414" author="jkreps" created="Thu, 14 Mar 2013 16:45:39 +0000"  >&lt;p&gt;I am not sure about this change. There are two choices to add to the index: the offset of the wrapper message which is the offset of the last message in the compressed set or the offset of the first message in the compressed set. Either of these are correct since the index entry needs to be a lower bound on the position, so this is not a bug. I do agree that we should ideally    produce the same index entries on the leader and follower, but I am not sure if we should choose the first or last message. The problem with choosing the first message is that the integrity of the index can only be validated using deep iteration on the log and the index then points to a message which doesn&apos;t have the index entry given in the index which is very odd.&lt;/p&gt;

&lt;p&gt;This code looks very confusing to me. I can&apos;t tell if this change is making it worse or the code is already just very confusing. I recommend we leave it as is on 0.8 and fix it on trunk where that code has been cleaned up. Let&apos;s also figure out the pros and cons of which offset the index should contain. &lt;/p&gt;</comment>
                            <comment id="13602457" author="junrao" created="Thu, 14 Mar 2013 17:23:47 +0000"  >&lt;p&gt;Yes, the log code is a bit more complicated now to address a few recent issues that we found :&lt;br/&gt;
kafka-802: flush interval based on compressed message set&lt;br/&gt;
kafka-765: corrupted messages cause broker to shut down&lt;br/&gt;
kafka-767: message size check needs to be done after offset assignment&lt;/p&gt;

&lt;p&gt;My main concern of not addressing this in 0.8 is that this makes it hard to do index verification in our system tests.&lt;/p&gt;

&lt;p&gt;Indexing the first message seems to make the most intuitive sense. Yes, we do need to patch DumpLogSegments to support deep message iteration, in order to do index verification.&lt;/p&gt;</comment>
                            <comment id="13602569" author="jkreps" created="Thu, 14 Mar 2013 18:57:09 +0000"  >&lt;p&gt;So does this patch have the fix for all those?&lt;/p&gt;</comment>
                            <comment id="13605513" author="jkreps" created="Mon, 18 Mar 2013 19:33:51 +0000"  >&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;I only see stats being updated in the case where assignOffsets is true.&lt;/li&gt;
	&lt;li&gt;Please fix the logging to be human readable.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Can you give a patch against trunk too?&lt;/p&gt;</comment>
                            <comment id="13605568" author="jkreps" created="Mon, 18 Mar 2013 20:11:52 +0000"  >&lt;p&gt;Also: &lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;the offsets tuple gets recreated which isnt needed&lt;/li&gt;
	&lt;li&gt;the count that is being done in analyzeAndValidateMessageSet is wrong and not being used. It should be removed (this can happen on trunk).&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13605773" author="junrao" created="Mon, 18 Mar 2013 22:57:52 +0000"  >&lt;p&gt;Thanks for the review. Committed to 0.8 by addressing the following issues.&lt;/p&gt;

&lt;p&gt;1. The stat for message rate is actually meant for monitoring data rates from producers. So it&apos;s correct to only account for it in the leader during offset assignment.&lt;/p&gt;

&lt;p&gt;2. Fixed the log.&lt;/p&gt;

&lt;p&gt;3. Fixed the issue with unnecessarily recreating the tuple.&lt;/p&gt;

&lt;p&gt;4. Didn&apos;t fix count in analyzeAndValidateMessageSet in this patch. Will fix it when merging to trunk. Will create a separate jira for review.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12573626" name="kafka-804.patch" size="5086" author="junrao" created="Thu, 14 Mar 2013 00:06:10 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>317397</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 36 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1irmv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>317738</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>