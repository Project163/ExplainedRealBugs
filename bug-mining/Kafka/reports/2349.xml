<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:19:43 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-8412] Still a nullpointer exception thrown on shutdown while flushing before closing producers</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-8412</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;I found a closed issue and replied there but decided to open one myself because although they&apos;re related they&apos;re slightly different. The original issue is at &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7678&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-7678&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The fix there has been to implement a null check around closing a producer because in some cases the producer is already null there (has been closed already)&lt;/p&gt;

&lt;p&gt;In version 2.1.1 we are getting a very similar exception, but in the &apos;flush&apos; method that is called pre-close. This is in the log:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
message: stream-thread [webhook-poster-7034dbb0-7423-476b-98f3-d18db675d6d6-StreamThread-1] Failed &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; closing StreamTask 1_26 due to the following error:
logger_name: org.apache.kafka.streams.processor.internals.AssignedStreamsTasks

java.lang.NullPointerException: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
&#160;&#160;&#160; at org.apache.kafka.streams.processor.internals.RecordCollectorImpl.flush(RecordCollectorImpl.java:245)
&#160;&#160;&#160; at org.apache.kafka.streams.processor.internals.StreamTask.flushState(StreamTask.java:493)
&#160;&#160;&#160; at org.apache.kafka.streams.processor.internals.StreamTask.commit(StreamTask.java:443)
&#160;&#160;&#160; at org.apache.kafka.streams.processor.internals.StreamTask.suspend(StreamTask.java:568)
&#160;&#160;&#160; at org.apache.kafka.streams.processor.internals.StreamTask.close(StreamTask.java:691)
&#160;&#160;&#160; at org.apache.kafka.streams.processor.internals.AssignedTasks.close(AssignedTasks.java:397)
&#160;&#160;&#160; at org.apache.kafka.streams.processor.internals.TaskManager.shutdown(TaskManager.java:260)
&#160;&#160;&#160; at org.apache.kafka.streams.processor.internals.StreamThread.completeShutdown(StreamThread.java:1181)
&#160;&#160;&#160; at org.apache.kafka.streams.processor.internals.StreamThread.run(StreamThread.java:758)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Followed by:&lt;br/&gt;
&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
message: task [1_26] Could not close task due to the following error:
logger_name: org.apache.kafka.streams.processor.internals.StreamTask

java.lang.NullPointerException: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
&#160;&#160;&#160; at org.apache.kafka.streams.processor.internals.RecordCollectorImpl.flush(RecordCollectorImpl.java:245)
&#160;&#160;&#160; at org.apache.kafka.streams.processor.internals.StreamTask.flushState(StreamTask.java:493)
&#160;&#160;&#160; at org.apache.kafka.streams.processor.internals.StreamTask.commit(StreamTask.java:443)
&#160;&#160;&#160; at org.apache.kafka.streams.processor.internals.StreamTask.suspend(StreamTask.java:568)
&#160;&#160;&#160; at org.apache.kafka.streams.processor.internals.StreamTask.close(StreamTask.java:691)
&#160;&#160;&#160; at org.apache.kafka.streams.processor.internals.AssignedTasks.close(AssignedTasks.java:397)
&#160;&#160;&#160; at org.apache.kafka.streams.processor.internals.TaskManager.shutdown(TaskManager.java:260)
&#160;&#160;&#160; at org.apache.kafka.streams.processor.internals.StreamThread.completeShutdown(StreamThread.java:1181)
&#160;&#160;&#160; at org.apache.kafka.streams.processor.internals.StreamThread.run(StreamThread.java:758)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If I look at the source code at this point, I see a nice null check in the close method, but not in the flush method that is called just before that:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void flush() {
&#160;&#160;&#160; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.log.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Flushing producer&quot;&lt;/span&gt;);
&#160;&#160;&#160; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.producer.flush();
&#160;&#160;&#160; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.checkForException();
}

&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void close() {
&#160;&#160;&#160; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.log.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Closing producer&quot;&lt;/span&gt;);
&#160;&#160;&#160; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.producer != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.producer.close();
&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.producer = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
&#160;&#160;&#160; }

&#160;&#160;&#160; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.checkForException();
}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Seems to my (ignorant) eye that the flush method should also be wrapped in a null check in the same way as has been done for close.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13235076">KAFKA-8412</key>
            <summary>Still a nullpointer exception thrown on shutdown while flushing before closing producers</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cpettitt-confluent">Chris Pettitt</assignee>
                                    <reporter username="Sebastiaan83">Sebastiaan</reporter>
                        <labels>
                    </labels>
                <created>Thu, 23 May 2019 08:35:08 +0000</created>
                <updated>Mon, 26 Aug 2019 16:55:47 +0000</updated>
                            <resolved>Mon, 26 Aug 2019 16:55:47 +0000</resolved>
                                    <version>2.1.1</version>
                                    <fixVersion>2.1.2</fixVersion>
                    <fixVersion>2.2.2</fixVersion>
                    <fixVersion>2.3.1</fixVersion>
                    <fixVersion>2.4.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="16846787" author="mjsax" created="Thu, 23 May 2019 15:30:18 +0000"  >&lt;p&gt;Thanks for reporting this. What I don&apos;t understand is, why we would flush after we closed a task already. Hence, I am not sure if a null-guard is the correct fix, but to rather make sure we don&apos;t call flush() in the first place.&lt;/p&gt;

&lt;p&gt;Can you maybe provide debug level logs? This might help to understand the scenario better.&lt;/p&gt;</comment>
                            <comment id="16846808" author="sebastiaan83" created="Thu, 23 May 2019 15:44:19 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mjsax&quot; class=&quot;user-hover&quot; rel=&quot;mjsax&quot;&gt;mjsax&lt;/a&gt; I can try to reproduce it in development some more but so far we&apos;ve only seen it in production.&lt;/p&gt;

&lt;p&gt;But my theory is that it is similar to the other ticket, a comment &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7678?focusedCommentId=16715220&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-16715220&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-7678?focusedCommentId=16715220&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-16715220&lt;/a&gt; says:&lt;/p&gt;

&lt;p&gt;&lt;em&gt;&quot;There are one or two edge cases which can cause record collector to be closed multiple times, we have noticed them recently and are thinking about cleanup the classes along the calling hierarchy (i.e. from Task Manager -&amp;gt; Task -&amp;gt; RecordCollector) for it. One example is:&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;&lt;em&gt;1) a task is &lt;b&gt;suspended&lt;/b&gt;, with EOS turned on (like your case), the record collector is closed().&lt;/em&gt;&lt;br/&gt;
 &lt;em&gt;2) then the instance got killed (SIGTERM) , which causes all threads to be closed, which will then cause all their owned tasks to be &lt;b&gt;closed&lt;/b&gt;. The same record collector close() call will be triggered again&quot;&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;So this could be the same issue but now not for close but for flush. The producer is already flushed and closed but the same thing is tried again. Of course I don&apos;t know anything about the internals of the client so take this with a grain of salt.&lt;/p&gt;</comment>
                            <comment id="16846851" author="mjsax" created="Thu, 23 May 2019 16:41:00 +0000"  >&lt;p&gt;Do you run with EOS enabled?&lt;/p&gt;

&lt;p&gt;Also, closing() and flushing() is a little different... I am not saying there is no issue, I just try to figure out what the correct fix is. Just adding a `null`-check could actually just mask the root cause of the bug, but not fix the bug itself.&lt;/p&gt;</comment>
                            <comment id="16847211" author="sebastiaan83" created="Fri, 24 May 2019 03:30:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mjsax&quot; class=&quot;user-hover&quot; rel=&quot;mjsax&quot;&gt;mjsax&lt;/a&gt; yes we are using EOS.&lt;/p&gt;

&lt;p&gt;And yeah you&apos;re right, I was surprised it was solved by a null check for the other ticket when it also seemed to me the situation should be avoided in the first place. But I&apos;ll leave that to the actual developers.&lt;/p&gt;</comment>
                            <comment id="16847746" author="guozhang" created="Fri, 24 May 2019 17:23:22 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mjsax&quot; class=&quot;user-hover&quot; rel=&quot;mjsax&quot;&gt;mjsax&lt;/a&gt; I looked through the code and the original JIRA (&lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7285&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-7285&lt;/a&gt;) again, and I think the above case I mentioned still exists, where the root cause is that in `suspend` we would close the record collector with EOS turned on while in `close` we may want to flush (from state commit), and close the collector again.&lt;/p&gt;

&lt;p&gt;What I&apos;m thinking is that, we can refactor the fix in &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7285&quot; title=&quot;Streams should be more fencing-sensitive during task suspension under EOS&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7285&quot;&gt;&lt;del&gt;KAFKA-7285&lt;/del&gt;&lt;/a&gt;, such that in suspend, we do the &quot;close-and-then-recreate&quot; completely and only leave the `initTxn` call in the `resume` function. In that case whenever we&apos;re closing we are assured there&apos;s still an open producer. With this, we no longer need the closed-check in close() function as well.&lt;/p&gt;</comment>
                            <comment id="16885740" author="mjsax" created="Tue, 16 Jul 2019 01:01:33 +0000"  >&lt;p&gt;Just cycling back to this.&lt;/p&gt;

&lt;p&gt;I am not sure if we should do the &quot;close-and-then-recreate&quot; strategy. The issues seems to be, that we blindly call `task#close()` for all tasks within `AssingedTasks#close()`. However, it seems that a proper fix would be to distinguish between active and suspended tasks, and call `closeSuspended()` for suspended ones, and `close()` for all others?&lt;/p&gt;

&lt;p&gt;With regard to&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7678&quot; title=&quot;Failed to close producer due to java.lang.NullPointerException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7678&quot;&gt;&lt;del&gt;KAFKA-7678&lt;/del&gt;&lt;/a&gt;: re-reading the ticket, the report says, that it should be a graceful shutdown via SIGTERM. Hence, I am wondering why the unclean shutdown path is actually executed (ie, why do we call `maybeAbortTransactionAndCloseRecordCollector()` &#8211; this should only happen for an unclean shutdown). \cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pachilo&quot; class=&quot;user-hover&quot; rel=&quot;pachilo&quot;&gt;pachilo&lt;/a&gt; who reported and work on the first NPE&lt;/p&gt;</comment>
                            <comment id="16886441" author="pachilo" created="Tue, 16 Jul 2019 20:43:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; also&#160;mentioned&#160;that we may need to refactor that part of the code&#160;&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7678?focusedCommentId=16715220&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#comment-16715220&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;in a comment on the KAFKA-7678 &lt;/a&gt;, wich is aligned with your proposal &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mjsax&quot; class=&quot;user-hover&quot; rel=&quot;mjsax&quot;&gt;mjsax&lt;/a&gt;.&lt;br/&gt;
In your opinion &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mjsax&quot; class=&quot;user-hover&quot; rel=&quot;mjsax&quot;&gt;mjsax&lt;/a&gt;, should we address that or first we could add a null check before calling the Producer#flush method? to then do the refactor&#160;of course.&lt;br/&gt;
&#160;&lt;/p&gt;</comment>
                            <comment id="16891218" author="mjsax" created="Tue, 23 Jul 2019 17:14:46 +0000"  >&lt;p&gt;I would rather refactor the code directly because it seems to be cleaner. WDYT &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="16899196" author="cpettitt-confluent" created="Fri, 2 Aug 2019 20:35:46 +0000"  >&lt;p&gt;Matthias, Guozhang proposed I pick up this ticket to get my feet wet. I hope you don&apos;t mind, but feel free to grab it back if you are very attached to it &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.&lt;/p&gt;</comment>
                            <comment id="16899244" author="mjsax" created="Fri, 2 Aug 2019 22:20:12 +0000"  >&lt;p&gt;Sure. I did not start yet to work on a PR anyway.&lt;/p&gt;</comment>
                            <comment id="16905459" author="cpettitt-confluent" created="Mon, 12 Aug 2019 18:17:21 +0000"  >&lt;p&gt;I&apos;m able to repro this and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mjsax&quot; class=&quot;user-hover&quot; rel=&quot;mjsax&quot;&gt;mjsax&lt;/a&gt;&apos;s solution should fix this.&lt;/p&gt;

&lt;p&gt;One other observation while I was in this code is that we essentially have state spread out across classes. As a dev new to the code, I would expect to push most of the state for the task down into StreamTask and only if we need fast lookup by state keep an index of these in AssignedTask, but treat this as an index and not as the authoritative state. In other words, I would prefer to see close on StreamTask do the right thing for the state it is in instead of having AssignedTasks be responsible for different types of close. This&#160;should also make it easier to test without involving mocks, as we are in AssignedTasks.&lt;/p&gt;

&lt;p&gt;So I see a few options:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Use &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mjsax&quot; class=&quot;user-hover&quot; rel=&quot;mjsax&quot;&gt;mjsax&lt;/a&gt;&apos;s solution and keep state as is.&lt;/li&gt;
	&lt;li&gt;Push state down into StreamTask, AssignedTasks just calls close as it does today.&lt;/li&gt;
	&lt;li&gt;Do #1 in first patch and follow up with #2 in a second patch focused on refactoring state.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mjsax&quot; class=&quot;user-hover&quot; rel=&quot;mjsax&quot;&gt;mjsax&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; thoughts?&lt;/p&gt;</comment>
                            <comment id="16905598" author="cpettitt-confluent" created="Mon, 12 Aug 2019 21:33:29 +0000"  >&lt;p&gt;Having played with this a bit more I think its best to go for #1 for now, which is a point fix with a pretty small scope, i.e. low risk.&lt;/p&gt;

&lt;p&gt;I do see value in rethinking state a bit particularly around ownership and transitions, perhaps as a separate ticket. As someone new coming to the code it is&#160;difficult to work out which states and transitions are valid at a glance, especially because it is distributed across at least AssignedTasks, AbstractTask, and StreamTask.&lt;/p&gt;</comment>
                            <comment id="16906525" author="githubbot" created="Tue, 13 Aug 2019 18:55:52 +0000"  >&lt;p&gt;cpettitt-confluent commented on pull request #7207: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-8412&quot; title=&quot;Still a nullpointer exception thrown on shutdown while flushing before closing producers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-8412&quot;&gt;&lt;del&gt;KAFKA-8412&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;WIP&amp;#93;&lt;/span&gt;: Still a nullpointer exception thrown on shutdown whi&#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/7207&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/7207&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   &#8230;le flushing before closing producers&lt;/p&gt;

&lt;p&gt;   Prior to this change an NPE is raised when calling AssignedTasks.close&lt;br/&gt;
   under the following conditions:&lt;/p&gt;

&lt;p&gt;   1. EOS is enabled&lt;br/&gt;
   2. The task was in a suspended state&lt;/p&gt;

&lt;p&gt;   The cause for the NPE is that when a clean close is requested for a&lt;br/&gt;
   StreamTask the StreamTask tries to commit. However, in the suspended&lt;br/&gt;
   state there is no producer so ultimately an NPE is thrown for the&lt;br/&gt;
   contained RecordCollector in flush.&lt;/p&gt;

&lt;p&gt;   It is my opinion that in the long term, this (and probably other&lt;br/&gt;
   surprising state interactions) could be cleaned up by consolidating&lt;br/&gt;
   state into one place instead of spreading it across AssignedTasks,&lt;br/&gt;
   StreamTask, and AbstractTask. However, that is a much larger, more risky&lt;br/&gt;
   change, and this issue is currently considered minor.&lt;/p&gt;

&lt;p&gt;   The fix put forth in this commit is to have AssignedTasks call&lt;br/&gt;
   closeSuspended when it knows the underlying StreamTask is suspended.&lt;/p&gt;

&lt;p&gt;   Currently the only externally visible way to detect this problem in test&lt;br/&gt;
   seems to be via logging. This is because the NPE is logged but then&lt;br/&gt;
   suppressed under the following sequence:&lt;/p&gt;

&lt;p&gt;   RecordCollectorImpl.flush:266&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;throws NPE (producer is null)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;   StreamTask.suspend:578&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;goes through the finally block and then reraises the NPE&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;   StreamTask.close:706&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;catches the NPE, calls closeSuspended with the NPE&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;   StreamTask.closeSuspended:676&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;rethrows the NPE after some cleanup&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;   AssignedTasks.close:341&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;catches and logs the exception&lt;/li&gt;
	&lt;li&gt;tries a &quot;dirty&quot; close (clean = true) which succeeds&lt;/li&gt;
	&lt;li&gt;firstException is NOT set because the test `!closeUnclean(task)`&lt;br/&gt;
         does not hold.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;   It seems this is not the intended behavior? If so, I will happily&lt;br/&gt;
   correct that and stop using logging as a way to detect failure.&lt;/p&gt;

&lt;p&gt;   Otherwise this commit does not currently pass checkstyle because I&apos;m&lt;br/&gt;
   using blacklisted imports: `LogCaptureAppender` and its various&lt;br/&gt;
   dependencies from `log4j`. I would appreciate guidance as to whether we&lt;br/&gt;
   should whitelist these or use another technique for detection.&lt;/p&gt;

&lt;p&gt;   Note also that this test is quite involved. I could have just tested&lt;br/&gt;
   that AssignedTasks calls closeSuspended when appropriate, but that is&lt;br/&gt;
   testing, IMO, a detail of the implementation and doesn&apos;t actually verify&lt;br/&gt;
   we reproduced the original problem as it was described. I feel much more&lt;br/&gt;
   confident that we are reproducing the behavior - and we can test exactly&lt;br/&gt;
   the conditions that lead to it - when testing across AssignedTasks and&lt;br/&gt;
   StreamTask. I believe this is an additional support for the argument of&lt;br/&gt;
   eventually consolidating the state split across classes.&lt;/p&gt;

&lt;p&gt;   *More detailed description of your change,&lt;br/&gt;
   if necessary. The PR title and PR message become&lt;br/&gt;
   the squashed commit message, so use a separate&lt;br/&gt;
   comment to ping reviewers.*&lt;/p&gt;

&lt;p&gt;   *Summary of testing strategy (including rationale)&lt;br/&gt;
   for the feature or bug fix. Unit and/or integration&lt;br/&gt;
   tests are expected for any behaviour change and&lt;br/&gt;
   system tests should be considered for larger changes.*&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16915942" author="githubbot" created="Mon, 26 Aug 2019 16:53:40 +0000"  >&lt;p&gt;guozhangwang commented on pull request #7207: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-8412&quot; title=&quot;Still a nullpointer exception thrown on shutdown while flushing before closing producers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-8412&quot;&gt;&lt;del&gt;KAFKA-8412&lt;/del&gt;&lt;/a&gt;: Still a nullpointer exception thrown on shutdown whi&#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/7207&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/7207&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 12 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z02zm8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>