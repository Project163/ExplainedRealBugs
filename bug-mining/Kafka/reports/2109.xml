<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:16:24 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-7704] kafka.server.ReplicaFetechManager.MaxLag.Replica metric is reported incorrectly</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-7704</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;We recently deployed kafka 2.1, and noticed a jump in kafka.server.ReplicaFetcherManager.MaxLag.Replica metric. At the same time, there is no under-replicated partitions for the cluster. &lt;/p&gt;

&lt;p&gt;The initial analysis shows that kafka 2.1.0 does not report metric correctly for topics that have no incoming traffic right now, but had traffic earlier. For those topics, ReplicaFetcherManager will consider the maxLag be the latest offset. &lt;/p&gt;

&lt;p&gt;For instance, we have a topic named `test_topic`: &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[root@kafkabroker03002:/mnt/kafka/test_topic-0]# ls -l
total 8
-rw-rw-r-- 1 kafka kafka 10485760 Dec  4 00:13 00000000099043947579.index
-rw-rw-r-- 1 kafka kafka        0 Sep 23 03:01 00000000099043947579.log
-rw-rw-r-- 1 kafka kafka       10 Dec  4 00:13 00000000099043947579.snapshot
-rw-rw-r-- 1 kafka kafka 10485756 Dec  4 00:13 00000000099043947579.timeindex
-rw-rw-r-- 1 kafka kafka        4 Dec  4 00:13 leader-epoch-checkpoint
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;kafka reports ReplicaFetcherManager.MaxLag.Replica be 99043947579&lt;/p&gt;

&lt;p&gt; &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/12950475/12950475_Screen+Shot+2018-12-03+at+4.33.35+PM.png&quot; width=&quot;720px&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt; &lt;/p&gt;
</description>
                <environment></environment>
        <key id="13202139">KAFKA-7704</key>
            <summary>kafka.server.ReplicaFetechManager.MaxLag.Replica metric is reported incorrectly</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="huxi_2b">huxihx</assignee>
                                    <reporter username="yuyang08">Yu Yang</reporter>
                        <labels>
                    </labels>
                <created>Tue, 4 Dec 2018 00:35:18 +0000</created>
                <updated>Thu, 6 Dec 2018 13:50:58 +0000</updated>
                            <resolved>Thu, 6 Dec 2018 13:50:58 +0000</resolved>
                                    <version>2.1.0</version>
                                    <fixVersion>2.1.1</fixVersion>
                    <fixVersion>2.2.0</fixVersion>
                                    <component>metrics</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16708142" author="githubbot" created="Tue, 4 Dec 2018 03:18:08 +0000"  >&lt;p&gt;huxihx opened a new pull request #5998: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7704&quot; title=&quot;kafka.server.ReplicaFetechManager.MaxLag.Replica metric is reported incorrectly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7704&quot;&gt;&lt;del&gt;KAFKA-7704&lt;/del&gt;&lt;/a&gt;: MaxLag.Replica metric is reported incorrectly&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5998&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5998&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   On the follower side, for the empty `LogAppendInfo` retrieved from the leader, fetcherLagStats set the wrong lag for fetcherLagStats due to `nextOffset` is zero in this case where it actually means no lagging, so the lag should be set to 0 if `nextOffset` is 0 or `logAppendInfo.lastOffset` is -1.&lt;/p&gt;

&lt;p&gt;   *More detailed description of your change,&lt;br/&gt;
   if necessary. The PR title and PR message become&lt;br/&gt;
   the squashed commit message, so use a separate&lt;br/&gt;
   comment to ping reviewers.*&lt;/p&gt;

&lt;p&gt;   *Summary of testing strategy (including rationale)&lt;br/&gt;
   for the feature or bug fix. Unit and/or integration&lt;br/&gt;
   tests are expected for any behaviour change and&lt;br/&gt;
   system tests should be considered for larger changes.*&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16709589" author="junrao" created="Wed, 5 Dec 2018 04:25:27 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yuyang08&quot; class=&quot;user-hover&quot; rel=&quot;yuyang08&quot;&gt;yuyang08&lt;/a&gt;, could you try the PR and see if it fixes the issue? Thanks,&lt;/p&gt;</comment>
                            <comment id="16711009" author="yuyang08" created="Thu, 6 Dec 2018 06:12:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=huxi_2b&quot; class=&quot;user-hover&quot; rel=&quot;huxi_2b&quot;&gt;huxi_2b&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=junrao&quot; class=&quot;user-hover&quot; rel=&quot;junrao&quot;&gt;junrao&lt;/a&gt; I verified that&#160; &lt;a href=&quot;https://github.com/apache/kafka/pull/5998&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5998&lt;/a&gt;&#160;does fix the maxlag metric issue. Thanks for the quick fix!&lt;/p&gt;</comment>
                            <comment id="16711463" author="githubbot" created="Thu, 6 Dec 2018 13:46:41 +0000"  >&lt;p&gt;junrao closed pull request #5998: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7704&quot; title=&quot;kafka.server.ReplicaFetechManager.MaxLag.Replica metric is reported incorrectly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7704&quot;&gt;&lt;del&gt;KAFKA-7704&lt;/del&gt;&lt;/a&gt;: MaxLag.Replica metric is reported incorrectly&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5998&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5998&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/core/src/main/scala/kafka/server/AbstractFetcherThread.scala b/core/src/main/scala/kafka/server/AbstractFetcherThread.scala&lt;br/&gt;
index 2cee83c2e74..02158fac879 100755&lt;br/&gt;
&amp;#8212; a/core/src/main/scala/kafka/server/AbstractFetcherThread.scala&lt;br/&gt;
+++ b/core/src/main/scala/kafka/server/AbstractFetcherThread.scala&lt;br/&gt;
@@ -272,10 +272,10 @@ abstract class AbstractFetcherThread(name: String,&lt;br/&gt;
                       partitionData)&lt;/p&gt;

&lt;p&gt;                     logAppendInfoOpt.foreach { logAppendInfo =&amp;gt;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;val nextOffset = logAppendInfo.lastOffset + 1&lt;br/&gt;
+                      val validBytes = logAppendInfo.validBytes&lt;br/&gt;
+                      val nextOffset = if (validBytes &amp;gt; 0) logAppendInfo.lastOffset + 1 else currentFetchState.fetchOffset&lt;br/&gt;
                       fetcherLagStats.getAndMaybePut(topicPartition).lag = Math.max(0L, partitionData.highWatermark - nextOffset)&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;val validBytes = logAppendInfo.validBytes&lt;br/&gt;
                       // ReplicaDirAlterThread may have removed topicPartition from the partitionStates after processing the partition data&lt;br/&gt;
                       if (validBytes &amp;gt; 0 &amp;amp;&amp;amp; partitionStates.contains(topicPartition)) {&lt;br/&gt;
                         // Update partitionStates only if there is no exception during processPartitionData&lt;/li&gt;
&lt;/ul&gt;





&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16711470" author="junrao" created="Thu, 6 Dec 2018 13:50:58 +0000"  >&lt;p&gt;Merged to trunk and 2.1.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12950475" name="Screen Shot 2018-12-03 at 4.33.35 PM.png" size="116819" author="yuyang08" created="Tue, 4 Dec 2018 00:33:44 +0000"/>
                            <attachment id="12950794" name="Screen Shot 2018-12-05 at 10.13.09 PM.png" size="153380" author="yuyang08" created="Thu, 6 Dec 2018 06:13:21 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 49 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|s014oo:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>