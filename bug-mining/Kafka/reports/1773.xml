<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:05:46 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-6415] KafkaLog4jAppender deadlocks when logging from producer network thread</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-6415</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;When a log entry is appended to a Kafka topic using KafkaLog4jAppender, the producer.send operation may block waiting for metadata. This can result in deadlocks in a couple of scenarios if a log entry from the producer network thread is also at a log level that results in the entry being appended to a Kafka topic.&lt;br/&gt;
1. Producer&apos;s network thread will attempt to send data to a Kafka topic and this is unsafe since producer.send may block waiting for metadata, causing a deadlock since the thread will not process the metadata request/response.&lt;br/&gt;
2. KafkaLog4jAppender#append is invoked while holding the lock of the logger. So the thread waiting for metadata in the initial send will be holding the logger lock. If the producer network thread has.a log entry that needs to be appended, it will attempt to acquire the logger lock and deadlock.&lt;/p&gt;

&lt;p&gt;This was probably the case right from the beginning when KafkaLog4jAppender was introduced, but did not cause any issues so far since there were only debug log entries in that path which were not logged to a Kafka topic by any of the tests. A recent info level log entry introduced by the commit &lt;a href=&quot;https://github.com/apache/kafka/commit/a3aea3cf4dbedb293f2d7859e0298bebc8e2185f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/commit/a3aea3cf4dbedb293f2d7859e0298bebc8e2185f&lt;/a&gt; is causing system test failures in log4j_appender_test.py due to the deadlock.&lt;/p&gt;

&lt;p&gt;The asynchronous append case can be fixed by moving all send operations to a separate thread. But KafkaLog4jAppender also has a syncSend option which blocks append while holding the logger lock until the send completes. Not sure how this can be fixed if we want to support log appends from the producer network thread.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13127972">KAFKA-6415</key>
            <summary>KafkaLog4jAppender deadlocks when logging from producer network thread</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rsivaram">Rajini Sivaram</assignee>
                                    <reporter username="rsivaram">Rajini Sivaram</reporter>
                        <labels>
                    </labels>
                <created>Tue, 2 Jan 2018 12:30:07 +0000</created>
                <updated>Tue, 2 Oct 2018 14:23:33 +0000</updated>
                            <resolved>Tue, 2 Oct 2018 14:23:33 +0000</resolved>
                                                    <fixVersion>2.1.0</fixVersion>
                                    <component>log</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16308193" author="githubbot" created="Tue, 2 Jan 2018 15:15:08 +0000"  >&lt;p&gt;rajinisivaram opened a new pull request #4375: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6415&quot; title=&quot;KafkaLog4jAppender deadlocks when logging from producer network thread&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-6415&quot;&gt;&lt;del&gt;KAFKA-6415&lt;/del&gt;&lt;/a&gt;: Avoid info log during metadata update in network thread&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/4375&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/4375&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   When a log entry is appended to a Kafka topic using `KafkaLog4jAppender`, the producer.send operation may block waiting for metadata. This can result in deadlocks in a couple of scenarios if a log entry from the producer network thread is also at a log level that results in the entry being appended to a Kafka topic.&lt;br/&gt;
   1. Producer&apos;s network thread will attempt to send data to a Kafka topic and this is unsafe since producer.send may block waiting for metadata, causing a deadlock since the thread will not process the metadata request/response.&lt;br/&gt;
   2. `KafkaLog4jAppender#append` is invoked while holding the lock of the logger. So the thread waiting for metadata in the initial send will be holding the logger lock. If the producer network thread has.a log entry that needs to be appended, it will attempt to acquire the logger lock and deadlock.&lt;/p&gt;

&lt;p&gt;   This is a temporary workaround to avoid deadlocks in system tests by avoiding logs at INFO level in the producer network thread during metadata update. The fix has been verified using the system tests log4j_appender_test.py which started failing when the info-level log entry was introduced.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16310133" author="githubbot" created="Wed, 3 Jan 2018 19:19:45 +0000"  >&lt;p&gt;rajinisivaram closed pull request #4375: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6415&quot; title=&quot;KafkaLog4jAppender deadlocks when logging from producer network thread&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-6415&quot;&gt;&lt;del&gt;KAFKA-6415&lt;/del&gt;&lt;/a&gt;: Use WARN log level for Metadata in system test&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/4375&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/4375&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/tools/src/main/java/org/apache/kafka/tools/VerifiableLog4jAppender.java b/tools/src/main/java/org/apache/kafka/tools/VerifiableLog4jAppender.java&lt;br/&gt;
index 4dd7bee9791..9533f6e58aa 100644&lt;br/&gt;
&amp;#8212; a/tools/src/main/java/org/apache/kafka/tools/VerifiableLog4jAppender.java&lt;br/&gt;
+++ b/tools/src/main/java/org/apache/kafka/tools/VerifiableLog4jAppender.java&lt;br/&gt;
@@ -204,6 +204,9 @@ public static VerifiableLog4jAppender createFromArgs(String[] args) &lt;/p&gt;
{
                 props.setProperty(&quot;log4j.appender.KAFKA.kerb5ConfPath&quot;, res.getString(&quot;kerb5ConfPath&quot;));
             }
&lt;p&gt;             props.setProperty(&quot;log4j.logger.kafka.log4j&quot;, &quot;INFO, KAFKA&quot;);&lt;br/&gt;
+            // Changing log level from INFO to WARN as a temporary workaround for &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6415&quot; title=&quot;KafkaLog4jAppender deadlocks when logging from producer network thread&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-6415&quot;&gt;&lt;del&gt;KAFKA-6415&lt;/del&gt;&lt;/a&gt;. This is to&lt;br/&gt;
+            // avoid deadlock in system tests when producer network thread appends to log while updating metadata.&lt;br/&gt;
+            props.setProperty(&quot;log4j.logger.org.apache.kafka.clients.Metadata&quot;, &quot;WARN, KAFKA&quot;);&lt;/p&gt;

&lt;p&gt;             if (configFile != null) {&lt;br/&gt;
                 try {&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="13168343">KAFKA-7099</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 45 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3of4v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>