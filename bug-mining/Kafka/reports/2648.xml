<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:24:02 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-10010] Should make state store registration idempotent</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-10010</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;The current lost all logic doesn&apos;t close standby task, which could potentially lead to a tricky condition like below:&lt;/p&gt;



&lt;p&gt;1. The standby task was initializing as `CREATED` state, and task corrupted exception was thrown from&#160;registerStateStores&lt;/p&gt;

&lt;p&gt;2. The task corrupted exception was caught, and do a non-affected task commit&lt;/p&gt;

&lt;p&gt;3. The task commit failed due to task migrated exception&lt;/p&gt;

&lt;p&gt;4. The handleLostAll didn&apos;t close the standby task, leaving it as CREATED state&lt;/p&gt;

&lt;p&gt;5. Next rebalance complete, the same task was assigned back as standby task.&lt;/p&gt;

&lt;p&gt;6. Illegal Argument exception caught :&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[2020-05-16T11:56:18-07:00] (streams-soak-trunk-eos-beta_soak_i-065b27929d3e7014a_streamslog) [2020-05-16 18:56:18,050] ERROR [stream-soak-test-ce5e4abb-24f5-48cd-9608-21c59b6b42a3-StreamThread-1] stream-thread [stream-soak-test-ce5e4abb-24f5-48cd-9608-21c59b6b42a3-StreamThread-1] Encountered the following exception during processing and the thread is going to shut down:&#160; (org.apache.kafka.streams.processor.internals.StreamThread)
[2020-05-16T11:56:18-07:00] (streams-soak-trunk-eos-beta_soak_i-065b27929d3e7014a_streamslog) java.lang.IllegalArgumentException: stream-thread [stream-soak-test-ce5e4abb-24f5-48cd-9608-21c59b6b42a3-StreamThread-1] standby-task [1_2] Store KSTREAM-AGGREGATE-STATE-STORE-0000000007 has already been registered.
&#160; &#160; &#160; &#160; at org.apache.kafka.streams.processor.internals.ProcessorStateManager.registerStore(ProcessorStateManager.java:269)
&#160; &#160; &#160; &#160; at org.apache.kafka.streams.processor.internals.AbstractProcessorContext.register(AbstractProcessorContext.java:112)
&#160; &#160; &#160; &#160; at org.apache.kafka.streams.state.internals.AbstractRocksDBSegmentedBytesStore.init(AbstractRocksDBSegmentedBytesStore.java:191)
&#160; &#160; &#160; &#160; at org.apache.kafka.streams.state.internals.WrappedStateStore.init(WrappedStateStore.java:48)
&#160; &#160; &#160; &#160; at org.apache.kafka.streams.state.internals.RocksDBWindowStore.init(RocksDBWindowStore.java:48)
&#160; &#160; &#160; &#160; at org.apache.kafka.streams.state.internals.WrappedStateStore.init(WrappedStateStore.java:48)
&#160; &#160; &#160; &#160; at org.apache.kafka.streams.state.internals.ChangeLoggingWindowBytesStore.init(ChangeLoggingWindowBytesStore.java:54)
&#160; &#160; &#160; &#160; at org.apache.kafka.streams.state.internals.WrappedStateStore.init(WrappedStateStore.java:48)
&#160; &#160; &#160; &#160; at org.apache.kafka.streams.state.internals.CachingWindowStore.init(CachingWindowStore.java:74)
&#160; &#160; &#160; &#160; at org.apache.kafka.streams.state.internals.WrappedStateStore.init(WrappedStateStore.java:48)
&#160; &#160; &#160; &#160; at org.apache.kafka.streams.state.internals.MeteredWindowStore.lambda$init$0(MeteredWindowStore.java:85)
&#160; &#160; &#160; &#160; at org.apache.kafka.streams.processor.internals.metrics.StreamsMetricsImpl.maybeMeasureLatency(StreamsMetricsImpl.java:804)
&#160; &#160; &#160; &#160; at org.apache.kafka.streams.state.internals.MeteredWindowStore.init(MeteredWindowStore.java:85)
&#160; &#160; &#160; &#160; at org.apache.kafka.streams.processor.internals.StateManagerUtil.registerStateStores(StateManagerUtil.java:82)
&#160; &#160; &#160; &#160; at org.apache.kafka.streams.processor.internals.StandbyTask.initializeIfNeeded(StandbyTask.java:89)
&#160; &#160; &#160; &#160; at org.apache.kafka.streams.processor.internals.TaskManager.tryToCompleteRestoration(TaskManager.java:358)
&#160; &#160; &#160; &#160; at org.apache.kafka.streams.processor.internals.StreamThread.runOnce(StreamThread.java:664)
&#160; &#160; &#160; &#160; at org.apache.kafka.streams.processor.internals.StreamThread.runLoop(StreamThread.java:550)
&#160; &#160; &#160; &#160; at org.apache.kafka.streams.processor.internals.StreamThread.run(StreamThread.java:509)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13305525">KAFKA-10010</key>
            <summary>Should make state store registration idempotent</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="bchen225242">Boyang Chen</assignee>
                                    <reporter username="bchen225242">Boyang Chen</reporter>
                        <labels>
                    </labels>
                <created>Sun, 17 May 2020 18:05:21 +0000</created>
                <updated>Mon, 1 Jun 2020 18:12:13 +0000</updated>
                            <resolved>Mon, 1 Jun 2020 18:12:13 +0000</resolved>
                                                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17109604" author="guozhang" created="Sun, 17 May 2020 18:25:04 +0000"  >&lt;p&gt;We intentionally did not close standby tasks because they are likely to be reassigned back. Here I feel the issue is that when we get an exception in registerStateStores, in order to keep the standby tasks in CREATED state we need to make sure any partially registered stores are de-registered in `closeStateManager`, thoughts?&lt;/p&gt;</comment>
                            <comment id="17109610" author="bchen225242" created="Sun, 17 May 2020 19:21:35 +0000"  >&lt;p&gt;The gain for keeping the standby task open is not much when the thread is already under corruption or task migrated. Adding a de-register logic would certainly increase the complexity, which I&apos;m not sure at the moment whether it is the correct move, because we need to handle that logic properly with another set of try-catch.&lt;/p&gt;</comment>
                            <comment id="17110518" author="ableegoldman" created="Mon, 18 May 2020 18:38:51 +0000"  >&lt;p&gt;It&apos;s possible the active &amp;lt;-&amp;gt; standby task conversion PR would actually fix this on the side, as it skips re-registering any store that&apos;s already registered. I&apos;d like to avoid closing standbys during handleLostAll since this will completely clear out any in-memory stores, for example&lt;/p&gt;</comment>
                            <comment id="17110522" author="ableegoldman" created="Mon, 18 May 2020 18:43:25 +0000"  >&lt;p&gt;When I first started looking into the store registration and initialization logic for that PR, I remember thinking there was a bug since we would attempt to re-register stores if we hit an exception halfway through registration. I snooped around and it seemed like there wasn&apos;t really a way to hit this bug, but I fixed it anyways.&lt;/p&gt;

&lt;p&gt;Seems like there actually was a way to hit this bug after all, so nice catch &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bchen225242&quot; class=&quot;user-hover&quot; rel=&quot;bchen225242&quot;&gt;bchen225242&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17110636" author="bchen225242" created="Mon, 18 May 2020 21:35:18 +0000"  >&lt;p&gt;Had offline discussion with the team, so far some action items:&lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;Make the state store registration idempotent to unblock the trunk soak&lt;/li&gt;
	&lt;li&gt;Add a logic to avoid aborting the txn when the task is in initialization phase (Get a separate ticket)&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17110638" author="bchen225242" created="Mon, 18 May 2020 21:37:01 +0000"  >&lt;p&gt;For more context, the &lt;a href=&quot;#r407722022]&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;reason&lt;/a&gt;&#160;we have to keep the txn commit before handle task corruption, since otherwise under EOS beta the stream thread could actually abort other healthy tasks.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 26 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0eu80:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>