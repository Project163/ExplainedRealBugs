<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:39:04 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-16903] Task should consider producer error previously occurred for different task</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-16903</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;A task does not consider a producer error that occurred for a different task.&lt;/p&gt;

&lt;p&gt;The following log messages show the issue.&lt;/p&gt;

&lt;p&gt;Task &lt;tt&gt;0_2&lt;/tt&gt; of a Streams app (EOSv2 enabled) crashes while sending records with an &lt;tt&gt;InvalidTxnStateException&lt;/tt&gt;:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[2024-05-30 10:20:35,881] ERROR [kafka-producer-network-thread | i-0af25f5c2bd9bba31-StreamThread-1-producer] stream-thread [i-0af25f5c2bd9bba31-StreamThread-1] stream-task [0_2] Error encountered sending record to topic stream-soak-test-node-name-repartition &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; task 0_2 due to:
org.apache.kafka.common.errors.InvalidTxnStateException: The producer attempted a transactional operation in an invalid state.
Exception handler choose to FAIL the processing, no more records would be sent. (org.apache.kafka.streams.processor.internals.RecordCollectorImpl)
org.apache.kafka.common.errors.InvalidTxnStateException: The producer attempted a transactional operation in an invalid state.

[2024-05-30 10:20:35,886] ERROR [i-0af25f5c2bd9bba31-StreamThread-1] stream-thread [i-0af25f5c2bd9bba31-StreamThread-1] Failed to process stream task 0_2 due to the following error: (org.apache.kafka.streams.processor.internals.TaskExecutor)
org.apache.kafka.streams.errors.StreamsException: Error encountered sending record to topic stream-soak-test-node-name-repartition &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; task 0_2 due to:
org.apache.kafka.common.errors.InvalidTxnStateException: The producer attempted a transactional operation in an invalid state.
Exception handler choose to FAIL the processing, no more records would be sent.
	at org.apache.kafka.streams.processor.internals.RecordCollectorImpl.recordSendError(RecordCollectorImpl.java:316)
	at org.apache.kafka.streams.processor.internals.RecordCollectorImpl.lambda$send$1(RecordCollectorImpl.java:285)
	at org.apache.kafka.clients.producer.KafkaProducer$AppendCallbacks.onCompletion(KafkaProducer.java:1565)
	at org.apache.kafka.clients.producer.internals.ProducerBatch.completeFutureAndFireCallbacks(ProducerBatch.java:311)
	at org.apache.kafka.clients.producer.internals.ProducerBatch.done(ProducerBatch.java:272)
	at org.apache.kafka.clients.producer.internals.ProducerBatch.completeExceptionally(ProducerBatch.java:236)
	at org.apache.kafka.clients.producer.internals.Sender.failBatch(Sender.java:829)
	at org.apache.kafka.clients.producer.internals.Sender.failBatch(Sender.java:818)
	at org.apache.kafka.clients.producer.internals.Sender.failBatch(Sender.java:770)
	at org.apache.kafka.clients.producer.internals.Sender.completeBatch(Sender.java:702)
	at org.apache.kafka.clients.producer.internals.Sender.lambda$&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;$2(Sender.java:627)
	at java.util.ArrayList.forEach(ArrayList.java:1259)
	at org.apache.kafka.clients.producer.internals.Sender.lambda$handleProduceResponse$3(Sender.java:612)
	at java.lang.Iterable.forEach(Iterable.java:75)
	at org.apache.kafka.clients.producer.internals.Sender.handleProduceResponse(Sender.java:612)
	at org.apache.kafka.clients.producer.internals.Sender.lambda$sendProduceRequest$9(Sender.java:916)
	at org.apache.kafka.clients.ClientResponse.onComplete(ClientResponse.java:154)
	at org.apache.kafka.clients.NetworkClient.completeResponses(NetworkClient.java:608)
	at org.apache.kafka.clients.NetworkClient.poll(NetworkClient.java:600)
	at org.apache.kafka.clients.producer.internals.Sender.runOnce(Sender.java:348)
	at org.apache.kafka.clients.producer.internals.Sender.run(Sender.java:250)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:750)
Caused by: org.apache.kafka.common.errors.InvalidTxnStateException: The producer attempted a transactional operation in an invalid state.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt; 

&lt;p&gt;Just before the exception of task 0_2  also task 0_0  encountered an exception while producing:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[2024-05-30 10:20:35,880] ERROR [kafka-producer-network-thread | i-0af25f5c2bd9bba31-StreamThread-1-producer] stream-thread [i-0af25f5c2bd9bba31-StreamThread-1] stream-task [0_0] Error encountered sending record to topic stream-soak-test-network-id-repartition &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; task 0_0 due to:
org.apache.kafka.common.errors.InvalidProducerEpochException: Producer attempted to produce with an old epoch.
Written offsets would not be recorded and no more records would be sent since the producer is fenced, indicating the task may be migrated out (org.apache.kafka.streams.processor.internals.RecordCollectorImpl)
org.apache.kafka.common.errors.InvalidProducerEpochException: Producer attempted to produce with an old epoch.

[2024-05-30 10:20:35,881] INFO [kafka-producer-network-thread | i-0af25f5c2bd9bba31-StreamThread-1-producer] [Producer clientId=i-0af25f5c2bd9bba31-StreamThread-1-producer, transactionalId=stream-soak-test-141294b0-59b9-496e-8857-65a1fe8bac5a-1] Transiting to abortable error state due to org.apache.kafka.common.errors.InvalidProducerEpochException: Producer attempted to produce with an old epoch. (org.apache.kafka.clients.producer.internals.TransactionManager)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt; 

&lt;p&gt;Apparently, task &lt;tt&gt;0_2&lt;/tt&gt; does not know anything about the exception thrown by task &lt;tt&gt;0_0&lt;/tt&gt;, otherwise task &lt;tt&gt;0_2&lt;/tt&gt; would not try to produce records and run into the &lt;tt&gt;InvalidTxnStateException&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;The root cause is that when a send exception happens, the exception is stored in field variable &lt;tt&gt;sendException&lt;/tt&gt; in each instance of &lt;tt&gt;RecordCollectorImpl&lt;/tt&gt;. There is one instance of &lt;tt&gt;RecordCollectorImpl&lt;/tt&gt; per task. That means, that when one task sets its &lt;tt&gt;sendException&lt;/tt&gt; field the other task does not know about it.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13581751">KAFKA-16903</key>
            <summary>Task should consider producer error previously occurred for different task</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cadonna">Bruno Cadonna</assignee>
                                    <reporter username="cadonna">Bruno Cadonna</reporter>
                        <labels>
                    </labels>
                <created>Thu, 6 Jun 2024 07:21:02 +0000</created>
                <updated>Mon, 10 Jun 2024 09:58:51 +0000</updated>
                            <resolved>Thu, 6 Jun 2024 19:39:18 +0000</resolved>
                                    <version>3.7.0</version>
                                    <fixVersion>3.8.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17853456" author="ableegoldman" created="Sun, 9 Jun 2024 03:02:25 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cadonna&quot; class=&quot;user-hover&quot; rel=&quot;cadonna&quot;&gt;cadonna&lt;/a&gt; is this really a regression that only affects 3.7 or has it been around for longer and you just happened to catch it in 3.7?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Just wondering because we were running some testing on a slightly older version (3.4 or 3.6, don&apos;t remember which) and I think we might have seen this.&lt;/p&gt;</comment>
                            <comment id="17853602" author="cadonna" created="Mon, 10 Jun 2024 09:58:51 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ableegoldman&quot; class=&quot;user-hover&quot; rel=&quot;ableegoldman&quot;&gt;ableegoldman&lt;/a&gt; I actually do not know. I found it on trunk. If you are sure that you found it on a earlier version, please set the affected version accordingly.&lt;br/&gt;
I actually suspect that it was there before, because we haven&apos;t changed that code for a while.  &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 22 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1pn9s:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>