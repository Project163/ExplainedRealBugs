<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:58:07 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-4509] Task reusage on rebalance fails for threads on same host</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-4509</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;In &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3559&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-3559&lt;/a&gt; task reusage on rebalance was introduces as a performance optimization. Instead of closing a task on rebalance (ie, &lt;tt&gt;onPartitionsRevoked()&lt;/tt&gt;, it only get&apos;s suspended for a potential reuse in &lt;tt&gt;onPartitionsAssigned()&lt;/tt&gt;. Only if a task cannot be reused, it will eventually get closed in &lt;tt&gt;onPartitionsAssigned()&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;This mechanism can fail, if multiple &lt;tt&gt;StreamThreads&lt;/tt&gt; run in the same host (same or different JVM). The scenario is as follows:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;assume 2 running threads A and B&lt;/li&gt;
	&lt;li&gt;assume 3 tasks t1, t2, t3&lt;/li&gt;
	&lt;li&gt;assignment: A-(t1,t2) and B-(t3)&lt;/li&gt;
	&lt;li&gt;on the same host, a new single threaded Stream application (same app-id) gets started (thread C)&lt;/li&gt;
	&lt;li&gt;on rebalance, t2 (could also be t1 &amp;#8211; does not matter) will be moved from A to C&lt;/li&gt;
	&lt;li&gt;as assignment is only sticky base on an heurictic t1 can sometimes be assigned to B, too &amp;#8211; and t3 get&apos;s assigned to A (thre is a race condition if this &quot;task flipping&quot; happens or not)&lt;/li&gt;
	&lt;li&gt;on revoke, A will suspend task t1 and t2 (not releasing any locks)&lt;/li&gt;
	&lt;li&gt;on assign&lt;/li&gt;
	&lt;li&gt;A tries to create t3 but as B did not release it yet, A dies with an &quot;cannot get lock&quot; exception&lt;/li&gt;
	&lt;li&gt;B tries to create t1 but as A did not release it yet, B dies with an &quot;cannot get lock&quot; exception&lt;/li&gt;
	&lt;li&gt;as A and B trie to create the task first, this will always fail if task flipping happened&lt;/li&gt;
	&lt;li&gt;C tries to create t2 but A did not release t2 lock yet (race condition) and C dies with an exception (this could even happen without &quot;task flipping&quot; between A and B)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;We want to fix this, by:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;first release unassigned suspended tasks in &lt;tt&gt;onPartitionsAssignment()&lt;/tt&gt;, and afterward create new tasks (this fixes the &quot;task flipping&quot; issue)&lt;/li&gt;
	&lt;li&gt;use a &quot;backoff and retry mechanism&quot; if a task cannot be created (to handle release-create race condition between different threads)&lt;/li&gt;
&lt;/ol&gt;
</description>
                <environment></environment>
        <key id="13026482">KAFKA-4509</key>
            <summary>Task reusage on rebalance fails for threads on same host</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mjsax">Matthias J. Sax</assignee>
                                    <reporter username="mjsax">Matthias J. Sax</reporter>
                        <labels>
                    </labels>
                <created>Wed, 7 Dec 2016 21:08:26 +0000</created>
                <updated>Tue, 3 Jan 2017 17:08:16 +0000</updated>
                            <resolved>Tue, 13 Dec 2016 20:11:25 +0000</resolved>
                                                    <fixVersion>0.10.2.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15733842" author="githubbot" created="Fri, 9 Dec 2016 00:33:52 +0000"  >&lt;p&gt;GitHub user mjsax opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/2233&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2233&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-4509&quot; title=&quot;Task reusage on rebalance fails for threads on same host&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-4509&quot;&gt;&lt;del&gt;KAFKA-4509&lt;/del&gt;&lt;/a&gt;: Task reusage on rebalance fails for threads on same host&lt;/p&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/mjsax/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/mjsax/kafka&lt;/a&gt; kafka-4509-task-reusage-fix&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/2233.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2233.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #2233&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit e93a96773b806096cc907a25e61a933bb4b8903e&lt;br/&gt;
Author: Matthias J. Sax &amp;lt;matthias@confluent.io&amp;gt;&lt;br/&gt;
Date:   2016-12-08T01:08:50Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-4509&quot; title=&quot;Task reusage on rebalance fails for threads on same host&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-4509&quot;&gt;&lt;del&gt;KAFKA-4509&lt;/del&gt;&lt;/a&gt;: Task reusage on rebalance fails for threads on same host&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15746135" author="guozhang" created="Tue, 13 Dec 2016 20:11:26 +0000"  >&lt;p&gt;Issue resolved by pull request 2233&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/kafka/pull/2233&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2233&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15746138" author="githubbot" created="Tue, 13 Dec 2016 20:12:08 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/2233&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2233&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13031659">KAFKA-4582</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 48 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i37bdb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>enothereska</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>