<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:23:39 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-9839] IllegalStateException on metadata update when broker learns about its new epoch after the controller</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-9839</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Broker throws&#160;&quot;java.lang.IllegalStateException: Epoch XXX larger than current broker epoch YYY&quot;&#160; on UPDATE_METADATA when the controller learns about the broker epoch and sends UPDATE_METADATA before KafkaZkCLient.registerBroker completes (the broker learns about its new epoch).&lt;/p&gt;

&lt;p&gt;Here is the scenario we observed in more detail:&lt;br/&gt;
1. ZK session expires on broker 1&lt;br/&gt;
2. Broker 1 establishes new session to ZK and creates znode&lt;br/&gt;
3. Controller learns about broker 1 and assigns epoch&lt;br/&gt;
4. Broker 1 receives UPDATE_METADATA from controller, but it does not know about its new epoch yet, so we get an exception:&lt;/p&gt;

&lt;p&gt;ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;KafkaApi-3&amp;#93;&lt;/span&gt; Error when handling request: clientId=1, correlationId=0, api=UPDATE_METADATA, body={&lt;br/&gt;
.........&lt;br/&gt;
java.lang.IllegalStateException: Epoch XXX larger than current broker epoch YYY at kafka.server.KafkaApis.isBrokerEpochStale(KafkaApis.scala:2725) at kafka.server.KafkaApis.handleUpdateMetadataRequest(KafkaApis.scala:320) at kafka.server.KafkaApis.handle(KafkaApis.scala:139) at kafka.server.KafkaRequestHandler.run(KafkaRequestHandler.scala:69) at java.lang.Thread.run(Thread.java:748)&lt;/p&gt;

&lt;p&gt;5.&#160;KafkaZkCLient.registerBroker completes on broker 1: &quot;INFO Stat of the created znode at /brokers/ids/1&quot;&lt;/p&gt;

&lt;p&gt;The result is the broker has a stale metadata for some time.&lt;/p&gt;

&lt;p&gt;Possible solutions:&lt;br/&gt;
1. Broker returns a more specific error and controller retries UPDATE_MEDATA&lt;br/&gt;
2. Broker accepts UPDATE_METADATA with larger broker epoch.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13297258">KAFKA-9839</key>
            <summary>IllegalStateException on metadata update when broker learns about its new epoch after the controller</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="apovzner">Anna Povzner</assignee>
                                    <reporter username="apovzner">Anna Povzner</reporter>
                        <labels>
                    </labels>
                <created>Thu, 9 Apr 2020 04:13:22 +0000</created>
                <updated>Mon, 10 Jan 2022 13:25:15 +0000</updated>
                            <resolved>Mon, 27 Apr 2020 20:28:28 +0000</resolved>
                                    <version>2.2.1</version>
                    <version>2.3.1</version>
                    <version>2.4.1</version>
                    <version>2.5.0</version>
                                    <fixVersion>2.5.1</fixVersion>
                                    <component>controller</component>
                    <component>core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="17079544" author="junrao" created="Thu, 9 Apr 2020 16:36:18 +0000"  >&lt;p&gt;Thanks for reporting this, Anna. Accepting&#160;UPDATE_METADATA (and other similar requests from the controller) with a larger broker epoch is probably the easier solution.&lt;/p&gt;</comment>
                            <comment id="17085702" author="sigurdsa" created="Fri, 17 Apr 2020 12:37:08 +0000"  >&lt;p&gt;We experienced the same issue, adding some logs if it could be helpful.&lt;/p&gt;

&lt;p&gt;After this happened the server got stuck in a loop for an hour where ISR was not in sync, and it wasn&apos;t fixed until a hard restart was done on the server.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Apr 16 10:01:11 VM-IWM-APP18 kafka-server-start.sh[9200]: [2020-04-16 10:01:11,527] WARN Client session timed out, have not heard from server in 6981ms &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; sessionid 0x50000484a370021 (org.apache.zookeeper.ClientCnxn)
Apr 16 10:01:11 VM-IWM-APP18 kafka-server-start.sh[9200]: [2020-04-16 10:01:11,892] INFO Client session timed out, have not heard from server in 6981ms &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; sessionid 0x50000484a370021, closing socket connection and attempting reconnect (org.apache.zookeeper.ClientCnxn)
Apr 16 10:01:12 VM-IWM-APP18 kafka-server-start.sh[9200]: [2020-04-16 10:01:12,930] INFO Opening socket connection to server
Apr 16 10:01:13 VM-IWM-APP18 kafka-server-start.sh[9200]: [2020-04-16 10:01:12,930] INFO Socket connection established to 
Apr 16 10:01:13 VM-IWM-APP18 kafka-server-start.sh[9200]: [2020-04-16 10:01:12,932] WARN Unable to reconnect to ZooKeeper service, session 0x50000484a370021 has expired (org.apache.zookeeper.ClientCnxn)
Apr 16 10:01:13 VM-IWM-APP18 kafka-server-start.sh[9200]: [2020-04-16 10:01:12,932] INFO Unable to reconnect to ZooKeeper service, session 0x50000484a370021 has expired, closing socket connection (org.apache.zookeeper.ClientCnxn)
Apr 16 10:01:13 VM-IWM-APP18 kafka-server-start.sh[9200]: [2020-04-16 10:01:12,932] INFO EventThread shut down &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; session: 0x50000484a370021 (org.apache.zookeeper.ClientCnxn)
Apr 16 10:01:13 VM-IWM-APP18 kafka-server-start.sh[9200]: [2020-04-16 10:01:12,932] INFO [ZooKeeperClient Kafka server] Session expired. (kafka.zookeeper.ZooKeeperClient)
Apr 16 10:01:13 VM-IWM-APP18 kafka-server-start.sh[9200]: [2020-04-16 10:01:12,934] INFO [ZooKeeperClient Kafka server] Initializing a &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; session to &amp;lt;1&amp;gt;&amp;lt;2&amp;gt;&amp;lt;3&amp;gt;&amp;lt;4&amp;gt;&amp;lt;5&amp;gt;. (kafka.zookeepe
Apr 16 10:01:13 VM-IWM-APP18 kafka-server-start.sh[9200]: [2020-04-16 10:01:12,934] INFO Initiating client connection, connectString=&amp;lt;1&amp;gt;&amp;lt;2&amp;gt;&amp;lt;3&amp;gt;&amp;lt;4&amp;gt;&amp;lt;5&amp;gt; sessionTimeout=6000 watcher=kafka
Apr 16 10:01:13 VM-IWM-APP18 kafka-server-start.sh[9200]: [2020-04-16 10:01:12,934] INFO Creating /brokers/ids/0 (is it secure? &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;) (kafka.zk.KafkaZkClient)
Apr 16 10:01:13 VM-IWM-APP18 kafka-server-start.sh[9200]: [2020-04-16 10:01:13,042] INFO Opening socket connection to server &amp;lt;1&amp;gt; Will not attempt to authenticate using SASL (unknown error) (org.apache.zookeeper.ClientCnxn)
Apr 16 10:01:13 VM-IWM-APP18 kafka-server-start.sh[9200]: [2020-04-16 10:01:13,042] INFO Socket connection established to &amp;lt;1&amp;gt;, initiating session (org.apache.zookeeper.ClientCnxn)
Apr 16 10:01:13 VM-IWM-APP18 kafka-server-start.sh[9200]: [2020-04-16 10:01:13,832] INFO Session establishment complete on server &amp;lt;1&amp;gt;, sessionid = 0x10000008d93001b, negotiated timeout = 6000 (org.apache.zookeeper.ClientCnxn)
Apr 16 10:01:13 VM-IWM-APP18 kafka-server-start.sh[9200]: [2020-04-16 10:01:13,874] ERROR [KafkaApi-0] Error when handling request: clientId=22, correlationId=0, api=UPDATE_METADATA, body={controller_id=22,controller_epoch=83,broker_epoch=25770069286,topic_states=[{topic
Apr 16 10:01:13 VM-IWM-APP18 kafka-server-start.sh[9200]: =47,replicas=[0],offline_replicas=[]},{partition=54,controller_epoch=83,leader=-1,leader_epoch=47,isr=[0],zk_version=47,replicas=[0],offline_replicas=[]},{partition=55,controller_epoch=83,leader=-1,leader_epoch=47
Apr 16 10:01:13 VM-IWM-APP18 kafka-server-start.sh[9200]: java.lang.IllegalStateException: Epoch 25770069286 larger than current broker epoch 25770067254
Apr 16 10:01:13 VM-IWM-APP18 kafka-server-start.sh[9200]:         at kafka.server.KafkaApis.isBrokerEpochStale(KafkaApis.scala:2612)
Apr 16 10:01:13 VM-IWM-APP18 kafka-server-start.sh[9200]:         at kafka.server.KafkaApis.handleUpdateMetadataRequest(KafkaApis.scala:242)
Apr 16 10:01:13 VM-IWM-APP18 kafka-server-start.sh[9200]:         at kafka.server.KafkaApis.handle(KafkaApis.scala:119)
Apr 16 10:01:13 VM-IWM-APP18 kafka-server-start.sh[9200]:         at kafka.server.KafkaRequestHandler.run(KafkaRequestHandler.scala:69)
Apr 16 10:01:13 VM-IWM-APP18 kafka-server-start.sh[9200]:         at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)
Apr 16 10:01:13 VM-IWM-APP18 kafka-server-start.sh[9200]: [2020-04-16 10:01:13,885] INFO Stat of the created znode at /brokers/ids/0 is: 25770069286,25770069286,1587024073851,1587024073851,1,0,0,72057596413149211,200,0,25770069286
Apr 16 10:01:13 VM-IWM-APP18 kafka-server-start.sh[9200]:  (kafka.zk.KafkaZkClient)
Apr 16 10:01:13 VM-IWM-APP18 kafka-server-start.sh[9200]: [2020-04-16 10:01:13,885] INFO Registered broker 0 at path /brokers/ids/0 with addresses: ArrayBuffer(EndPoint(192.168.220.120,9092,ListenerName(PLAINTEXT),PLAINTEXT)), czxid (broker epoch): 25770069286 (kafka.zk.
Apr 16 10:01:13 VM-IWM-APP18 kafka-server-start.sh[9200]: [2020-04-16 10:01:13,886] ERROR [KafkaApi-0] Error when handling request: clientId=22, correlationId=1, api=LEADER_AND_ISR, body={controller_id=22,controller_epoch=83,broker_epoch=25770069286,topic_states=[{topic=
Apr 16 10:01:13 VM-IWM-APP18 kafka-server-start.sh[9200]: poch=47,isr=[0],zk_version=47,replicas=[0],is_new=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;},{partition=85,controller_epoch=83,leader=-1,leader_epoch=47,isr=[0],zk_version=47,replicas=[0],is_new=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;},{partition=86,controller_epoch=83,leader=-1,lea
Apr 16 10:01:13 VM-IWM-APP18 kafka-server-start.sh[9200]: java.lang.IllegalStateException: Epoch 25770069286 larger than current broker epoch 25770067254
Apr 16 10:01:13 VM-IWM-APP18 kafka-server-start.sh[9200]:         at kafka.server.KafkaApis.isBrokerEpochStale(KafkaApis.scala:2612)
Apr 16 10:01:13 VM-IWM-APP18 kafka-server-start.sh[9200]:         at kafka.server.KafkaApis.handleLeaderAndIsrRequest(KafkaApis.scala:194)
Apr 16 10:01:13 VM-IWM-APP18 kafka-server-start.sh[9200]:         at kafka.server.KafkaApis.handle(KafkaApis.scala:117)
Apr 16 10:01:13 VM-IWM-APP18 kafka-server-start.sh[9200]:         at kafka.server.KafkaRequestHandler.run(KafkaRequestHandler.scala:69)
Apr 16 10:01:13 VM-IWM-APP18 kafka-server-start.sh[9200]:         at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)
Apr 16 10:01:14 VM-IWM-APP18 kafka-server-start.sh[9200]: [2020-04-16 10:01:14,867] INFO [ReplicaFetcherManager on broker 0] Removed fetcher &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partitions Set(plant_alarms-64, plant_values-146, plant_alarms-8, plant_alarms-0, plant_alarms-80, plant_alarms-128, plant_ala
Apr 16 10:01:14 VM-IWM-APP18 kafka-server-start.sh[9200]: [2020-04-16 10:01:14,867] INFO [Partition plant_alarms-48 broker=0] plant_alarms-48 starts at Leader Epoch 48 from offset 0. Previous Leader Epoch was: 46 (kafka.cluster.Partition)
Apr 16 10:01:15 VM-IWM-APP18 kafka-server-start.sh[9200]: [2020-04-16 10:01:15,119] INFO [Partition plant_alarms-10 broker=0] plant_alarms-10 starts at Leader Epoch 48 from offset 0. Previous Leader Epoch was: 46 (kafka.cluster.Partition)
Apr 16 10:01:15 VM-IWM-APP18 kafka-server-start.sh[9200]: [2020-04-16 10:01:15,356] INFO [Partition plant_values-6 broker=0] plant_values-6 starts at Leader Epoch 48 from offset 76. Previous Leader Epoch was: 46 (kafka.cluster.Partition)
...
...
Apr 16 10:58:15 VM-IWM-APP18 kafka-server-start.sh[32612]: [2020-04-16 10:58:15,130] INFO [Partition demo_plant_values-140 broker=0] demo_plant_values-140 starts at Leader Epoch 98 from offset 30769106. Previous Leader Epoch was: 97 (kafka.cluster.Partition)
Apr 16 10:58:15 VM-IWM-APP18 kafka-server-start.sh[32612]: [2020-04-16 10:58:15,135] INFO [Partition demo_plant_values-102 broker=0] demo_plant_values-102 starts at Leader Epoch 98 from offset 35753967. Previous Leader Epoch was: 97 (kafka.cluster.Partition)


&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17086185" author="apovzner" created="Sat, 18 Apr 2020 00:47:42 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=junrao&quot; class=&quot;user-hover&quot; rel=&quot;junrao&quot;&gt;junrao&lt;/a&gt;&#160;Thanks, yes I agree that accepting controller requests (UpdateMetadataRequest,&#160;LeaderAndIsrRequest,&#160;StopReplicaRequest) with newer broker epoch is the best approach &#8211; I don&apos;t see any drawbacks of accepting newer metadata. I am opening a PR with this solution shortly.&#160;&lt;/p&gt;</comment>
                            <comment id="17086227" author="githubbot" created="Sat, 18 Apr 2020 02:23:21 +0000"  >&lt;p&gt;apovzner commented on pull request #8509: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-9839&quot; title=&quot;IllegalStateException on metadata update when broker learns about its new epoch after the controller&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-9839&quot;&gt;&lt;del&gt;KAFKA-9839&lt;/del&gt;&lt;/a&gt;: Broker should accept control requests with newer broker epoch&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/8509&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/8509&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   A broker throws IllegalStateException if the broker epoch in the LeaderAndIsr/UpdateMetadataRequest/StopReplicaRequest is larger than its current broker epoch. However, there is no guarantee that the broker would receive the latest broker epoch before the controller: When the broker registers with ZK, there are few more instructions to process before this broker &quot;knows&quot; about its epoch, while the controller may already get notified and send UPDATE_METADATA request (as an example) with the new epoch. This will result in clients getting stale metadata from this broker. &lt;/p&gt;

&lt;p&gt;   With this PR, a broker accepts LeaderAndIsr/UpdateMetadataRequest/StopReplicaRequest if the broker epoch is newer than the current epoch.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="17174150" author="viktorsomogyi" created="Mon, 10 Aug 2020 07:41:24 +0000"  >&lt;p&gt;Detected this issue in a customer&apos;s environment, I&apos;ve backported it to 2.2.1 and it seemed to fix it for them. I&apos;ll publish my solution upstream soon.&lt;/p&gt;</comment>
                            <comment id="17177295" author="akatona" created="Thu, 13 Aug 2020 19:27:04 +0000"  >&lt;p&gt;This is in 2.6.0 too, but it&apos;s not in &lt;a href=&quot;https://dist.apache.org/repos/dist/release/kafka/2.6.0/RELEASE_NOTES.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;release notes of 2.6.0&lt;/a&gt;. Commit:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/kafka/commit/bd17085ec10c767bc82e6b19a3016cf5d50dad92&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/commit/bd17085ec10c767bc82e6b19a3016cf5d50dad92&lt;/a&gt; &lt;br/&gt;
Shouldn&apos;t it be there? It&apos;s in 2.5.1 release notes but it was released later, so that confused my colleague. &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 13 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0dfvc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>