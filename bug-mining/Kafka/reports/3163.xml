<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:29:35 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-13563] FindCoordinatorFuture never get cleared in non-group mode( consumer#assign)</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-13563</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;In &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-10793&quot; title=&quot;Race condition in FindCoordinatorFuture permanently severs connection to group coordinator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-10793&quot;&gt;&lt;del&gt;KAFKA-10793&lt;/del&gt;&lt;/a&gt;, we fix the race condition when lookup coordinator by clearing the &lt;em&gt;findCoordinatorFuture&lt;/em&gt; when handling the result, rather than in the listener callbacks. It works well under consumer group mode (i.e. Consumer#subscribe), but we found when user is using non consumer group mode (i.e. Consumer#assign) with group id provided (for offset commitment, so that there will be consumerCoordinator created), the &lt;em&gt;findCoordinatorFuture&lt;/em&gt; will never be cleared in some situations, and cause the offset committing keeps getting NOT_COORDINATOR error.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;After &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-10793&quot; title=&quot;Race condition in FindCoordinatorFuture permanently severs connection to group coordinator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-10793&quot;&gt;&lt;del&gt;KAFKA-10793&lt;/del&gt;&lt;/a&gt;, we clear the &lt;em&gt;findCoordinatorFuture&lt;/em&gt; in 2 places:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;heartbeat thread&lt;/li&gt;
	&lt;li&gt;AbstractCoordinator#ensureCoordinatorReady&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;But in non consumer group mode with group id provided, there will be no (1)heartbeat thread , and it only call (2)AbstractCoordinator#ensureCoordinatorReady when 1st time consumer wants to fetch committed offset position. That is, after 2nd lookupCoordinator call, we have no chance to clear the &lt;em&gt;findCoordinatorFuture&lt;/em&gt; .&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;To avoid the race condition as &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-10793&quot; title=&quot;Race condition in FindCoordinatorFuture permanently severs connection to group coordinator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-10793&quot;&gt;&lt;del&gt;KAFKA-10793&lt;/del&gt;&lt;/a&gt; mentioned, it&apos;s not safe to clear the &lt;em&gt;findCoordinatorFuture&lt;/em&gt; in the future listener. So, I think we can fix this issue by calling AbstractCoordinator#ensureCoordinatorReady when coordinator unknown in non consumer group case, under each Consumer#poll.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Reproduce steps:&lt;br/&gt;
&#160;&lt;br/&gt;
1. Start a 3 Broker cluster with a Topic having Replicas=3.&lt;br/&gt;
2. Start a Client with Producer and Consumer (with Consumer#assign(), not subscribe, and provide a group id) communicating over the Topic.&lt;br/&gt;
3. Stop the Broker that is acting as the&#160;Group Coordinator.&lt;br/&gt;
4. Observe successful Rediscovery of new Group Coordinator.&lt;br/&gt;
5. Restart the stopped Broker.&lt;br/&gt;
6. Stop the Broker that became the new Group Coordinator at step 4.&lt;br/&gt;
7. Observe &quot;Rediscovery will be attempted&quot; message but no &quot;Discovered group coordinator&quot; message.&lt;br/&gt;
&#160;&lt;br/&gt;
&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13419017">KAFKA-13563</key>
            <summary>FindCoordinatorFuture never get cleared in non-group mode( consumer#assign)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="showuon">Luke Chen</assignee>
                                    <reporter username="showuon">Luke Chen</reporter>
                        <labels>
                            <label>new-consumer-threading-should-fix</label>
                    </labels>
                <created>Wed, 22 Dec 2021 13:31:57 +0000</created>
                <updated>Thu, 9 Nov 2023 15:32:09 +0000</updated>
                            <resolved>Sun, 6 Feb 2022 23:10:56 +0000</resolved>
                                    <version>2.6.2</version>
                    <version>2.7.1</version>
                    <version>2.8.2</version>
                    <version>3.0.0</version>
                                    <fixVersion>3.1.1</fixVersion>
                    <fixVersion>3.2.0</fixVersion>
                                    <component>clients</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17465463" author="jim_b_o" created="Sun, 26 Dec 2021 21:36:10 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=showuon&quot; class=&quot;user-hover&quot; rel=&quot;showuon&quot;&gt;showuon&lt;/a&gt;&#160;I&apos;ve attached a reproducer (&lt;tt&gt;kafka.zip&lt;/tt&gt;). &#160;It includes a &lt;tt&gt;docker-compose.yml&lt;/tt&gt; that brings up a 3 node cluster and a &lt;tt&gt;Main&lt;/tt&gt; class with Producer and Consumer.&lt;/p&gt;

&lt;p&gt;P.S. The easiest way to find the current coordinator is to search the logs for `discovered`.&lt;/p&gt;</comment>
                            <comment id="17465513" author="showuon" created="Mon, 27 Dec 2021 02:33:48 +0000"  >&lt;p&gt;Thank you &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jim_b_o&quot; class=&quot;user-hover&quot; rel=&quot;jim_b_o&quot;&gt;jim_b_o&lt;/a&gt; ! I&apos;ll check it today. Thanks.&lt;/p&gt;</comment>
                            <comment id="17465999" author="showuon" created="Tue, 28 Dec 2021 08:13:25 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jim_b_o&quot; class=&quot;user-hover&quot; rel=&quot;jim_b_o&quot;&gt;jim_b_o&lt;/a&gt; , this issue is because of using `consumer#assign()`. It will be fine by using `consumer#subscribe`. I&apos;ll work on fix for this issue. Thank you for reporting and the reproduce steps.&lt;/p&gt;</comment>
                            <comment id="17469004" author="showuon" created="Wed, 5 Jan 2022 03:33:17 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ableegoldman&quot; class=&quot;user-hover&quot; rel=&quot;ableegoldman&quot;&gt;ableegoldman&lt;/a&gt;, you might want to check this issue, and the WIP PR: &#160;&lt;a href=&quot;https://github.com/apache/kafka/pull/11631&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/11631&lt;/a&gt; . Thank you.&lt;/p&gt;</comment>
                            <comment id="17469023" author="guozhang" created="Wed, 5 Jan 2022 05:09:06 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=showuon&quot; class=&quot;user-hover&quot; rel=&quot;showuon&quot;&gt;showuon&lt;/a&gt; thanks for the report, I&apos;ve reviewed the PR and left some comment.&lt;/p&gt;</comment>
                            <comment id="17602946" author="jaebinyo" created="Mon, 12 Sep 2022 04:42:05 +0000"  >&lt;p&gt;Affected versions should include 2.6.2, which included the &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-10793&quot; title=&quot;Race condition in FindCoordinatorFuture permanently severs connection to group coordinator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-10793&quot;&gt;&lt;del&gt;KAFKA-10793&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13343668">KAFKA-10793</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13037946" name="kafka.zip" size="56794" author="jim_b_o" created="Sun, 26 Dec 2021 21:32:04 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 9 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0xymo:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>