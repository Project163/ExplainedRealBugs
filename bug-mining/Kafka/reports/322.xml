<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:38:48 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-1010] Concurrency issue in getCluster() causes rebalance failure and dead consumer</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-1010</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;We&apos;re seeing the following stack trace on the consumer when brokers are (forcefully) removed from the cluster:&lt;/p&gt;

&lt;p&gt;Thu Aug 15 05:10:06 GMT 2013 Exception in thread &quot;main&quot; org.I0Itec.zkclient.exception.ZkNoNodeException: org.apache.zookeeper.KeeperException$NoNodeException: KeeperErrorCode = NoNode for /brokers/ids/4&lt;br/&gt;
at org.I0Itec.zkclient.exception.ZkException.create(ZkException.java:47)&lt;br/&gt;
at org.I0Itec.zkclient.ZkClient.retryUntilConnected(ZkClient.java:685)&lt;br/&gt;
at org.I0Itec.zkclient.ZkClient.readData(ZkClient.java:766)&lt;br/&gt;
at org.I0Itec.zkclient.ZkClient.readData(ZkClient.java:761)&lt;br/&gt;
at kafka.utils.ZkUtils$.readData(ZkUtils.scala:407)&lt;br/&gt;
at kafka.utils.ZkUtils$$anonfun$getCluster$1.apply(ZkUtils.scala:453)&lt;br/&gt;
at kafka.utils.ZkUtils$$anonfun$getCluster$1.apply(ZkUtils.scala:452)&lt;br/&gt;
at scala.collection.Iterator$class.foreach(Iterator.scala:631)&lt;br/&gt;
at scala.collection.JavaConversions$JIteratorWrapper.foreach(JavaConversions.scala:549)&lt;br/&gt;
at scala.collection.IterableLike$class.foreach(IterableLike.scala:79)&lt;br/&gt;
at scala.collection.JavaConversions$JListWrapper.foreach(JavaConversions.scala:596)&lt;br/&gt;
at kafka.utils.ZkUtils$.getCluster(ZkUtils.scala:452)&lt;br/&gt;
at kafka.consumer.ZookeeperConsumerConnector$ZKRebalancerListener$$anonfun$syncedRebalance$1.apply$mcVI$sp(ZookeeperConsumerConnector.scala:394)&lt;br/&gt;
at scala.collection.immutable.Range$ByOne$class.foreach$mVc$sp(Range.scala:282)&lt;br/&gt;
at scala.collection.immutable.Range$$anon$2.foreach$mVc$sp(Range.scala:265)&lt;br/&gt;
at kafka.consumer.ZookeeperConsumerConnector$ZKRebalancerListener.syncedRebalance(ZookeeperConsumerConnector.scala:391)&lt;br/&gt;
at kafka.consumer.ZookeeperConsumerConnector.kafka$consumer$ZookeeperConsumerConnector$$reinitializeConsumer(ZookeeperConsumerConnector.scala:722)&lt;br/&gt;
at kafka.consumer.ZookeeperConsumerConnector.consume(ZookeeperConsumerConnector.scala:206)&lt;br/&gt;
at kafka.javaapi.consumer.ZookeeperConsumerConnector.createMessageStreams(ZookeeperConsumerConnector.scala:77)&lt;br/&gt;
at kafka.javaapi.consumer.ZookeeperConsumerConnector.createMessageStreams(ZookeeperConsumerConnector.scala:89)&lt;/p&gt;

&lt;p&gt;I&apos;m pretty sure this is due to the following logic in getCluster():&lt;/p&gt;

&lt;p&gt;    val nodes = getChildrenParentMayNotExist(zkClient, BrokerIdsPath)&lt;br/&gt;
    for (node &amp;lt;- nodes) &lt;/p&gt;
{
      val brokerZKString = readData(zkClient, BrokerIdsPath + &quot;/&quot; + node)._1
      cluster.add(Broker.createBroker(node.toInt, brokerZKString))
    }

&lt;p&gt;which is obviously not safe since the nodes retrieved in the first call may have disappeared by the time we iterate to get the values.&lt;/p&gt;

&lt;p&gt;getCluster() seems to only be used in ZookeeperConsumerConnector.syncedRebalance and in ImportZkOffsets.updateZkOffsets (which doesn&apos;t actually look like it is using the values), so the simplest solution may be to just move the getCluster() call into the try block in syncedRebalance and kill the usage in the other call.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12663814">KAFKA-1010</key>
            <summary>Concurrency issue in getCluster() causes rebalance failure and dead consumer</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="smeder">Sam Meder</assignee>
                                    <reporter username="smeder">Sam Meder</reporter>
                        <labels>
                    </labels>
                <created>Thu, 15 Aug 2013 08:39:35 +0000</created>
                <updated>Fri, 16 Aug 2013 17:09:43 +0000</updated>
                            <resolved>Fri, 16 Aug 2013 17:09:43 +0000</resolved>
                                    <version>0.8.0</version>
                                    <fixVersion>0.8.0</fixVersion>
                                    <component>consumer</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13740819" author="smeder" created="Thu, 15 Aug 2013 09:08:09 +0000"  >&lt;p&gt;Simply move getCluster() call intro retry loop and eliminate second call. Also would be happy to provide a retry inside of getCluster based patch.&lt;/p&gt;</comment>
                            <comment id="13741148" author="guozhang" created="Thu, 15 Aug 2013 16:28:12 +0000"  >&lt;p&gt;This looks good to me. If the broker ephemeral node disappears after the first Zk Call, another rebalance should be triggered so it is safe to fail-fast this trial.&lt;/p&gt;

&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13742347" author="junrao" created="Fri, 16 Aug 2013 16:15:14 +0000"  >&lt;p&gt;Thanks for the patch. It doesn&apos;t seem to apply to 0.8 though. Could you rebase?&lt;/p&gt;

&lt;p&gt; git apply ~/Downloads/get_cluster_0_8.patch &lt;br/&gt;
error: patch failed: core/src/main/scala/kafka/tools/ImportZkOffsets.scala:96&lt;br/&gt;
error: core/src/main/scala/kafka/tools/ImportZkOffsets.scala: patch does not apply&lt;/p&gt;</comment>
                            <comment id="13742354" author="smeder" created="Fri, 16 Aug 2013 16:24:21 +0000"  >&lt;p&gt;weird, patch -p1 -i get_cluster_0_8.patch worked, but git apply didn&apos;t. Let me see if I can get something that git apply likes.&lt;/p&gt;</comment>
                            <comment id="13742365" author="smeder" created="Fri, 16 Aug 2013 16:31:27 +0000"  >&lt;p&gt;Git formatted patch is now attached.&lt;/p&gt;</comment>
                            <comment id="13742400" author="junrao" created="Fri, 16 Aug 2013 17:09:43 +0000"  >&lt;p&gt;Thanks for the patch. Committed to 0.8.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12598488" name="get_cluster_0_8_git.patch" size="1978" author="smeder" created="Fri, 16 Aug 2013 16:30:43 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>343815</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 14 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1nain:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>344117</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>