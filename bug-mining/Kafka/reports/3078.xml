<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:28:46 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-13194] LogCleaner may clean past highwatermark</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-13194</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Here we have the cleaning point being bounded to the active segment base offset and the first unstable offset. Which makes sense:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
   &lt;span class=&quot;code-comment&quot;&gt;// find first segment that cannot be cleaned
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// neither the active segment, nor segments with any messages closer to the head of the log than the minimum compaction lag time
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// may be cleaned
&lt;/span&gt;    val firstUncleanableDirtyOffset: &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt; = Seq(      &lt;span class=&quot;code-comment&quot;&gt;// we &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; not clean beyond the first unstable offset
&lt;/span&gt;      log.firstUnstableOffset,      &lt;span class=&quot;code-comment&quot;&gt;// the active segment is always uncleanable
&lt;/span&gt;      Option(log.activeSegment.baseOffset),      &lt;span class=&quot;code-comment&quot;&gt;// the first segment whose largest message timestamp is within a minimum time lag from now
&lt;/span&gt;      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (minCompactionLagMs &amp;gt; 0) {
        &lt;span class=&quot;code-comment&quot;&gt;// dirty log segments
&lt;/span&gt;        val dirtyNonActiveSegments = log.localNonActiveLogSegmentsFrom(firstDirtyOffset)
        dirtyNonActiveSegments.find { s =&amp;gt;
          val isUncleanable = s.largestTimestamp &amp;gt; now - minCompactionLagMs
          debug(s&lt;span class=&quot;code-quote&quot;&gt;&quot;Checking &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; log segment may be cleaned: log=&lt;span class=&quot;code-quote&quot;&gt;&apos;${log.name}&apos;&lt;/span&gt; segment.baseOffset=${s.baseOffset} &quot;&lt;/span&gt; +
            s&lt;span class=&quot;code-quote&quot;&gt;&quot;segment.largestTimestamp=${s.largestTimestamp}; now - compactionLag=${now - minCompactionLagMs}; &quot;&lt;/span&gt; +
            s&lt;span class=&quot;code-quote&quot;&gt;&quot;is uncleanable=$isUncleanable&quot;&lt;/span&gt;)
          isUncleanable
        }.map(_.baseOffset)
      } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; None
    ).flatten.min


&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;But LSO starts out as None.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@&lt;span class=&quot;code-keyword&quot;&gt;volatile&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; firstUnstableOffsetMetadata: Option[LogOffsetMetadata] = None

&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt;[log] def firstUnstableOffset: Option[&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;] = firstUnstableOffsetMetadata.map(_.messageOffset)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;For most code depending on the LSO, fetchLastStableOffsetMetadata is used to default it to the hwm if it&apos;s not set.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;

  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; def fetchLastStableOffsetMetadata: LogOffsetMetadata = {
    checkIfMemoryMappedBufferClosed()    &lt;span class=&quot;code-comment&quot;&gt;// cache the current high watermark to avoid a concurrent update invalidating the range check
&lt;/span&gt;    val highWatermarkMetadata = fetchHighWatermarkMetadata    firstUnstableOffsetMetadata match {
      &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; Some(offsetMetadata) &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; offsetMetadata.messageOffset &amp;lt; highWatermarkMetadata.messageOffset =&amp;gt;
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (offsetMetadata.messageOffsetOnly) {
          lock &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; {
            val fullOffset = convertToOffsetMetadataOrThrow(offsetMetadata.messageOffset)
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (firstUnstableOffsetMetadata.contains(offsetMetadata))
              firstUnstableOffsetMetadata = Some(fullOffset)
            fullOffset
          }
        } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
          offsetMetadata
        }
      &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; _ =&amp;gt; highWatermarkMetadata
    }
  }

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;This means that in the case where the hwm is prior to the active segment base, the log cleaner may clean past the hwm. This is most likely to occur after a broker restart when the log cleaner may start cleaning prior to replication becoming active.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13394750">KAFKA-13194</key>
            <summary>LogCleaner may clean past highwatermark</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="lucasbradstreet">Lucas Bradstreet</assignee>
                                    <reporter username="lucasbradstreet">Lucas Bradstreet</reporter>
                        <labels>
                    </labels>
                <created>Wed, 11 Aug 2021 19:55:36 +0000</created>
                <updated>Fri, 13 Aug 2021 22:36:52 +0000</updated>
                            <resolved>Fri, 13 Aug 2021 22:36:52 +0000</resolved>
                                                    <fixVersion>3.1.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17397601" author="jolshan" created="Wed, 11 Aug 2021 20:00:02 +0000"  >&lt;p&gt;There was code to change this in &lt;a href=&quot;https://github.com/apache/kafka/pull/9590,&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/9590,&lt;/a&gt;&#160;but if we want to fix faster, we should just make a new PR.&#160;&lt;/p&gt;

&lt;p&gt;Replacing&lt;br/&gt;
 // we do not clean beyond the first unstable offset&lt;br/&gt;
 log.firstUnstableOffset,&lt;/p&gt;

&lt;p&gt;with&lt;br/&gt;
 // we do not clean beyond the lastStableOffset (and therefore the high watermark)&lt;br/&gt;
 Option(log.lastStableOffset),&lt;/p&gt;</comment>
                            <comment id="17398964" author="junrao" created="Fri, 13 Aug 2021 22:36:52 +0000"  >&lt;p&gt;Merged the PR to trunk.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 13 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0ttls:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>