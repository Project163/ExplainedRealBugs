<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:29:28 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-13388] Kafka Producer nodes stuck in CHECKING_API_VERSIONS</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-13388</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;I have been seeing expired batch errors in my app.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
org.apache.kafka.common.errors.TimeoutException: Expiring 51 record(s) &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; xxx-17:120002 ms has passed since batch creation
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;I would have assumed a request timout or connection timeout should have also been logged. I could not find any other associated errors.&#160;&lt;/p&gt;

&lt;p&gt;I added some instrumenting to my app and have traced this down to broker connections hanging in&#160;CHECKING_API_VERSIONS state. &lt;del&gt;It appears there is no effective timeout for Kafka Producer broker connections in CHECKING_API_VERSIONS state.&lt;/del&gt;&lt;/p&gt;

&lt;p&gt;In the code see the after the NetworkClient connects to a broker node it makes a request to check api versions, when it receives the response it marks the node as ready. &lt;del&gt;I am seeing that sometimes a reply is not received for the check api versions request the connection just hangs in CHECKING_API_VERSIONS state until it is disposed I assume after the idle connection timeout.&lt;/del&gt;&lt;/p&gt;

&lt;p&gt;Update: not actually sure what causes the connection to get stuck in&#160;CHECKING_API_VERSIONS.&lt;/p&gt;

&lt;p&gt;&lt;del&gt;I am guessing the connection setup timeout should be still in play for this, but it is not.&lt;/del&gt; &lt;br/&gt;
 &lt;del&gt;There is a connectingNodes set that is consulted when checking timeouts and the node is removed&lt;/del&gt; &lt;br/&gt;
 &lt;del&gt;when ClusterConnectionStates.checkingApiVersions(String id) is called to transition the node into CHECKING_API_VERSIONS&lt;/del&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13407632">KAFKA-13388</key>
            <summary>Kafka Producer nodes stuck in CHECKING_API_VERSIONS</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dajac">David Jacot</assignee>
                                    <reporter username="dhofftgt">David Hoffman</reporter>
                        <labels>
                    </labels>
                <created>Wed, 20 Oct 2021 21:27:07 +0000</created>
                <updated>Wed, 26 Jan 2022 21:58:02 +0000</updated>
                            <resolved>Fri, 21 Jan 2022 16:56:53 +0000</resolved>
                                                    <fixVersion>3.0.1</fixVersion>
                    <fixVersion>3.1.1</fixVersion>
                    <fixVersion>3.2.0</fixVersion>
                                    <component>core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="17432238" author="dajac" created="Thu, 21 Oct 2021 06:41:46 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dhofftgt&quot; class=&quot;user-hover&quot; rel=&quot;dhofftgt&quot;&gt;dhofftgt&lt;/a&gt;&#160;Thanks for filing this issue. Which client version do you use? I just checked the code in trunk and it seems that the API_VERSIONS request should timeouts based on the `request.timeout.ms` (30s by default) like any other requests. To verify, you could turn on debug logs and you should see `Disconnecting from node {} due to request timeout.`.&lt;/p&gt;</comment>
                            <comment id="17432504" author="dhofftgt" created="Thu, 21 Oct 2021 14:09:09 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dajac&quot; class=&quot;user-hover&quot; rel=&quot;dajac&quot;&gt;dajac&lt;/a&gt; Thanks for looking into this and replying. We are using 2.7.1 at the moment. I do see that the api version request should timeout with the request.timeout.ms which is the default for our app. I can&apos;t turn on debug logging where I am seeing this issue due to the volume of logs. I have some code periodically inspecting the states of connections that dumps some info. I have seen connections that have those expired batches stuck in&#160;CHECKING_API_VERSIONS for longer than the request timeout. I will keep digging to see why.&#160;&lt;/p&gt;</comment>
                            <comment id="17432563" author="dajac" created="Thu, 21 Oct 2021 15:45:35 +0000"  >&lt;p&gt;Interesting... It would be great if you could provide more details (logs, dumps, etc.). There might be a bug somewhere.&#160;&lt;/p&gt;</comment>
                            <comment id="17432667" author="dhofftgt" created="Thu, 21 Oct 2021 18:45:54 +0000"  >&lt;p&gt;I have a screenshot of some logging I added that shows the connection stuck in&#160;CHECKING_API_VERSIONS state. The logging I added grabbed all the nodeIds from ClusterConnectionStates and determined if the Producer would treat them as &apos;not ready&apos; by checking the state, selector and whether there were in flight requests. If they were &apos;not ready&apos; it logged them and some other info. It ran on a schedule every 30 seconds.&lt;/p&gt;

&lt;p&gt;For this occurrence, I looked up the node id, and it was the leader of the partition that batches expired for. That&apos;s all I have right now. It&apos;s relatively rare, happens like 1 or 2 times a day for 32 application instances connecting to 64 kafka brokers.&lt;/p&gt;

&lt;p&gt;&#160;I am trying to narrow it down more by adding more info and waiting for it to happen again. Like one question I was wondering is if there is an outstanding in flight request when it&apos;s in this state or did that somehow get dropped in the shuffle somewhere.&lt;br/&gt;
 &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13035207/13035207_image-2021-10-21-13-42-06-528.png&quot; height=&quot;308&quot; width=&quot;664&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="17433826" author="dhofftgt" created="Mon, 25 Oct 2021 15:30:46 +0000"  >&lt;p&gt;looks like the connections are getting into CHECKING_API_VERSIONS without any outstanding in flight requests for that node. I think this would indicate a race condition somewhere. If I understand correctly the connection should never be in CHECKING_API_VERSIONS without an in flight request. I am going to trace through the code looking for how this could be possible.&#160; &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13035312/13035312_Screen+Shot+2021-10-25+at+10.28.48+AM.png&quot; height=&quot;164&quot; width=&quot;912&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="17433992" author="dhofftgt" created="Mon, 25 Oct 2021 21:31:51 +0000"  >&lt;p&gt;I&apos;m going to try enabling debug logging for NetworkClient to see if there is anything indicating what happened to the api versions request.&lt;/p&gt;</comment>
                            <comment id="17439526" author="david.mao" created="Fri, 5 Nov 2021 22:20:27 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dhofftgt&quot; class=&quot;user-hover&quot; rel=&quot;dhofftgt&quot;&gt;dhofftgt&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Why do we expect a connection in CHECKING_API_VERSIONS to have in-flight requests?&lt;/p&gt;

&lt;p&gt;I would expect the opposite:&#160;&lt;/p&gt;

&lt;p&gt;if a connection is in CHECKING_API_VERSIONS, it will&#160;&lt;b&gt;not&lt;/b&gt; be ready for requests (at this point, the client does not know what API versions the broker supports, so it can&apos;t serialize requests to the appropriate version), so it should not have any inflight requests.&lt;/p&gt;</comment>
                            <comment id="17440509" author="dhofftgt" created="Mon, 8 Nov 2021 14:33:41 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=david.mao&quot; class=&quot;user-hover&quot; rel=&quot;david.mao&quot;&gt;david.mao&lt;/a&gt; It&apos;s my understanding that there would be an internal request for the api versions check. This is how the call would be tracked for its timeout.&#160;&lt;/p&gt;</comment>
                            <comment id="17440513" author="dhofftgt" created="Mon, 8 Nov 2021 14:42:40 +0000"  >&lt;p&gt;I&apos;ve been trying to get more info. I enabled debug logging for NetworkClient but it hasn&apos;t occurred again in the past 2 weeks. Something must have changed in our environment, it doesn&apos;t seem to be happening anymore.&lt;/p&gt;</comment>
                            <comment id="17456854" author="david.mao" created="Fri, 10 Dec 2021 01:55:30 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dhofftgt&quot; class=&quot;user-hover&quot; rel=&quot;dhofftgt&quot;&gt;dhofftgt&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;Looking at where the NetworkClient enters the CHECKING_API_VERSIONS state, we see:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (discoverBrokerVersions) {
 &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.connectionStates.checkingApiVersions(node); 
 nodesNeedingApiVersionsFetch.put(node, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ApiVersionsRequest.Builder());
 &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;which is a separate queue for nodes needing to send the api versions request.&lt;/p&gt;

&lt;p&gt;Then in&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void handleInitiateApiVersionRequests(&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; now) {
    Iterator&amp;lt;Map.Entry&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, ApiVersionsRequest.Builder&amp;gt;&amp;gt; iter = nodesNeedingApiVersionsFetch.entrySet().iterator();
    &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (iter.hasNext()) {
        Map.Entry&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, ApiVersionsRequest.Builder&amp;gt; entry = iter.next();
        &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; node = entry.getKey();
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (selector.isChannelReady(node) &amp;amp;&amp;amp; inFlightRequests.canSendMore(node)) {
            log.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Initiating API versions fetch from node {}.&quot;&lt;/span&gt;, node);
            ApiVersionsRequest.Builder apiVersionRequestBuilder = entry.getValue();
            ClientRequest clientRequest = newClientRequest(node, apiVersionRequestBuilder, now, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
            doSend(clientRequest, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, now);
            iter.remove();
        }&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;we only send out the api versions request if the channel is ready (TLS handshake complete, SASL handshake complete).&lt;/p&gt;

&lt;p&gt;This is actually a pretty insidious bug because I think we end up in a state where we do not apply any request timeout to the channel if there is some delay in completing any of the handshaking/authentication steps, since the inflight requests are empty.&lt;/p&gt;</comment>
                            <comment id="17456888" author="lucasbradstreet" created="Fri, 10 Dec 2021 05:11:23 +0000"  >&lt;p&gt;I&apos;m pretty sure &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=david.mao&quot; class=&quot;user-hover&quot; rel=&quot;david.mao&quot;&gt;david.mao&lt;/a&gt; is correct. If we ever get into CHECKING_API_VERSIONS state we won&apos;t apply the connection timeouts or request timeouts. We really need to be applying a timeout to this state. I have a reproducer where we drop API_VERSIONS at random and can see that our normal timeouts don&apos;t apply. I think this is why the client gets all the way to expiring the batches without a corresponding disconnect.&lt;/p&gt;</comment>
                            <comment id="17457016" author="dajac" created="Fri, 10 Dec 2021 09:58:18 +0000"  >&lt;p&gt;I had a look at the code as well. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=david.mao&quot; class=&quot;user-hover&quot; rel=&quot;david.mao&quot;&gt;david.mao&lt;/a&gt; is right. My understanding is that we actually transition to the CHECKING_API_VERSIONS state but we only send out the ApiVersionsRequest if the channel is ready. If it never does, we don&apos;t have any timeout apply to it because the request timeout only kicks in when the request is sent out.&lt;/p&gt;</comment>
                            <comment id="17457216" author="david.mao" created="Fri, 10 Dec 2021 15:37:07 +0000"  >&lt;p&gt;We should probably bump up the priority of this Jira to Major or Critical since this prevents a producer from being able to recover its connection to a node until it restarts, or the connection gets idle-killed. I&apos;m not sure what the impact is on the consumer or admin client.&lt;/p&gt;</comment>
                            <comment id="17457274" author="dajac" created="Fri, 10 Dec 2021 17:03:59 +0000"  >&lt;p&gt;I can think of a few ways to fix this:&lt;/p&gt;

&lt;p&gt;1) We could decide to include the ApiVersions step as part of the connection time. This means that we would not reset the connection time while transitioning to the CHECKING_API_VERSIONS state but only when transitioning to the READY state.&lt;/p&gt;

&lt;p&gt;2) We could reset the connection time in `handleInitiateApiVersionRequests` only when the ApiVersions request is sent out.&lt;/p&gt;

&lt;p&gt;3) We might be able to just remove the `selector.isChannelReady(node) &amp;amp;&amp;amp; inFlightRequests.canSendMore(node)` condition in `handleInitiateApiVersionRequests`. I don&apos;t really understand what would prevent us from sending the request directly. This way the connection would time out based on the request timeout.&lt;/p&gt;</comment>
                            <comment id="17460852" author="lucasbradstreet" created="Thu, 16 Dec 2021 16:29:18 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dajac&quot; class=&quot;user-hover&quot; rel=&quot;dajac&quot;&gt;dajac&lt;/a&gt; I&apos;m not sure about which approach we should use, but I think we should ensure that whatever timeout is used is reasonable for delivery.timeout.ms e.g. with delivery.timeout.ms of 120s and request.timeout.ms of 30s you generally get 3+ shots at attempts before hitting the delivery timeout. At least unless you&apos;re stuck in this state.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13035312" name="Screen Shot 2021-10-25 at 10.28.48 AM.png" size="237964" author="dhofftgt" created="Mon, 25 Oct 2021 15:30:14 +0000"/>
                            <attachment id="13035207" name="image-2021-10-21-13-42-06-528.png" size="902821" author="dhofftgt" created="Thu, 21 Oct 2021 18:42:08 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 47 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0w11s:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>rajinisivaram@gmail.com</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>