<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:27:07 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-12462] Threads in PENDING_SHUTDOWN entering a rebalance can cause an illegal state exception </title>
                <link>https://issues.apache.org/jira/browse/KAFKA-12462</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;A thread was removed, sending it to the PENDING_SHUTDOWN state, but went through a rebalance before completing the shutdown.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// [2021-03-07 04:33:39,385] DEBUG [i-07430efc31ad166b7-StreamThread-6] stream-thread [i-07430efc31ad166b7-StreamThread-6] Ignoring request to transit from PENDING_SHUTDOWN to PARTITIONS_REVOKED: only DEAD state is a valid next state (org.apache.kafka.streams.processor.internals.StreamThread)&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Inside StreamsRebalanceListener#onPartitionsRevoked, we have&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// 
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (streamThread.setState(State.PARTITIONS_REVOKED) != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; !partitions.isEmpty())
    taskManager.handleRevocation(partitions);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Since PENDING_SHUTDOWN &#8594; PARTITIONS_REVOKED is a disallowed transition, we never invoke TaskManager#handleRevocation. Currently handleRevocation is responsible for preparing any active tasks for close, including committing offsets and writing the checkpoint as well as suspending the task. We can&#8217;t close the task in handleRevocation since we still support EAGER rebalancing, which invokes handleRevocation at the beginning of a rebalance on all tasks.&lt;/p&gt;

&lt;p&gt;The tasks that are actually revoked will be closed during TaskManager#handleAssignment . The IllegalStateException is specifically because we don&#8217;t suspend the task before attempting to close it, and the direct transition from RUNNING &#8594; CLOSED is forbidden.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13364737">KAFKA-12462</key>
            <summary>Threads in PENDING_SHUTDOWN entering a rebalance can cause an illegal state exception </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ableegoldman">A. Sophie Blee-Goldman</assignee>
                                    <reporter username="wcarlson5">Walker Carlson</reporter>
                        <labels>
                            <label>streams</label>
                    </labels>
                <created>Fri, 12 Mar 2021 23:32:33 +0000</created>
                <updated>Tue, 1 Mar 2022 21:09:03 +0000</updated>
                            <resolved>Sat, 13 Mar 2021 04:10:21 +0000</resolved>
                                    <version>2.6.0</version>
                    <version>2.7.0</version>
                    <version>2.8.0</version>
                                    <fixVersion>2.7.1</fixVersion>
                    <fixVersion>2.8.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17300650" author="ableegoldman" created="Fri, 12 Mar 2021 23:41:13 +0000"  >&lt;p&gt;Thanks Walker!&#160;This actually seems like a long-lurking bug that was just surfaced by the removeStreamThread() feature, not caused by it. Before we could remove threads this was only possible when shutting down the client, which we don&#8217;t test as frequently as we now do removeStreamThread(). It&#8217;s also hard to notice that a bug has caused thread(s) to die when the threads were supposed to shut down anyways. But now we might only be removing one thread, and thanks to the new exception handler we&#8217;ll shut down the whole application upon hitting this so the thread won&#8217;t just quietly die.&lt;/p&gt;

&lt;p&gt;We should consider backporting the fix to 2.7, even though the bug isn&apos;t going to be as frequent or as bad in earlier versions. I wouldn&apos;t cut a new RC for 2.6.2 over this, but we might as well backport to get the fix in 2.7.1 whenever that comes out&lt;/p&gt;</comment>
                            <comment id="17300652" author="wcarlson5" created="Fri, 12 Mar 2021 23:47:35 +0000"  >&lt;p&gt;If we were shutting down the whole client the thread would become dead either way. In 2.7 I think the only impact it would have is that the handler would get called after the close call when it shouldn&#8217;t. But otherwise it might not have an effect. I suppose there is no harm to back-porting though.&lt;/p&gt;

&lt;p&gt;I defiantly don&apos;t think it is worth cutting a new RC for anything that does not have removeThread in it&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17300654" author="ableegoldman" created="Sat, 13 Mar 2021 00:03:29 +0000"  >&lt;p&gt;The only real downside in 2.7 is that we won&apos;t properly clean up the task, ie we&apos;ll skip committing the offsets and writing the checkpoint. So we&apos;d lose any work we did since the last commit &#8211; for EOS this would be a perf hit since we&apos;d probably need to restore the state stores from scratch after starting back up, whereas for ALOS we could get some overcounting. Not the end of the world, but worth fixing if we can&lt;/p&gt;</comment>
                            <comment id="17499736" author="wcarlson5" created="Tue, 1 Mar 2022 20:18:22 +0000"  >&lt;p&gt;This also affects 2.6&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 36 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0opcw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>