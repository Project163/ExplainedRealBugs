<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:42:15 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-18641] AsyncKafkaConsumer could lose records with auto offset commit</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-18641</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;In the new AsyncKafkaConsumer, the application thread will keep updating the auto commit timer through PollEvent. In the consumer network thread, once the timer has expired, it generates an offset commit request with the current offset position in subscriptions. However, at this point, the records before that offset could just be polled from FetchBuffer, but not actually consumed by the application. If the application dies immediately, those records may never be consumed by the application since the offset could have been committed.&lt;/p&gt;

&lt;p&gt;The ClassicKafkaConsumer doesn&apos;t seem to have this problem. In each poll() call, before fetching new records, it first calls ConsumerCoordinator.poll(), which generates an OffsetCommitRequest with the current offset position in subscriptions. Since this is done in the same application thread, it guarantees that all records returned in the previous poll() have been processed. The problem exists in AsyncKafkaConsumer because the polling of new records and committing offsets are done in separate threads.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;This problem exists for async offset commit and auto offset commit during rebalance in AsyncKafkaConsumer too.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13606189">KAFKA-18641</key>
            <summary>AsyncKafkaConsumer could lose records with auto offset commit</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="frankvicky">TengYao Chi</assignee>
                                    <reporter username="junrao">Jun Rao</reporter>
                        <labels>
                            <label>consumer-threading-refactor</label>
                    </labels>
                <created>Fri, 24 Jan 2025 17:12:00 +0000</created>
                <updated>Thu, 20 Feb 2025 17:41:04 +0000</updated>
                            <resolved>Thu, 20 Feb 2025 17:41:04 +0000</resolved>
                                    <version>4.0.0</version>
                                    <fixVersion>4.0.0</fixVersion>
                                    <component>clients</component>
                    <component>consumer</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="17916869" author="JIRAUSER305181" created="Sat, 25 Jan 2025 00:32:20 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=junrao&quot; class=&quot;user-hover&quot; rel=&quot;junrao&quot;&gt;junrao&lt;/a&gt;&#160;&lt;br/&gt;
I will investigate this issue, feel free to reassign if you have another plan for this issue.&lt;/p&gt;

&lt;p&gt;Thank you &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="17916877" author="junrao" created="Sat, 25 Jan 2025 01:20:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=frankvicky&quot; class=&quot;user-hover&quot; rel=&quot;frankvicky&quot;&gt;frankvicky&lt;/a&gt; : Thanks for your interest. Feel free to take it.&lt;/p&gt;</comment>
                            <comment id="17921469" author="JIRAUSER300183" created="Mon, 27 Jan 2025 17:23:34 +0000"  >&lt;p&gt;Agree with this gap. The 3 commit operations performed in the CommitReqMgr retrieve subscriptions.allConsumed() freely as needed in the background, but the positions are advanced in the app thread before actually returning the records &lt;a href=&quot;https://github.com/apache/kafka/blob/40890faa1bed8296919a7e108937ec559d901348/clients/src/main/java/org/apache/kafka/clients/consumer/internals/FetchCollector.java#L186&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/40890faa1bed8296919a7e108937ec559d901348/clients/src/main/java/org/apache/kafka/clients/consumer/internals/FetchCollector.java#L186&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The classic consumer could trust that the allConsumed used to commit had been returned already (coordinator poll before fetching, single thread), but the async consumer cannot trust that in the same way. One simple approach that comes to mind is to piggyback on the existing PollEvent that updates the commit timer at the beginning of each poll iteration. Would it make sense if we take the allConsumed when processing that PollEvent (beginning of each poll iteration, before fetching, just like the classic does), and pass it into the CommitMgr? Those would be the positions that should be considered consumed until the next PollEvent, so those would be the ones committed if any commit of all positions happens before the next poll iteration. (Just a first thought in case it helps, but &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=frankvicky&quot; class=&quot;user-hover&quot; rel=&quot;frankvicky&quot;&gt;frankvicky&lt;/a&gt; keep us posted with your findings, happy to help when you need)&lt;/p&gt;</comment>
                            <comment id="17928874" author="JIRAUSER300183" created="Thu, 20 Feb 2025 17:41:04 +0000"  >&lt;p&gt;Merged to trunk and cherry-picked to 4.0 &lt;a href=&quot;https://github.com/apache/kafka/commit/35a372c71db1dbe793460e211e6897953cec97d4&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/commit/35a372c71db1dbe793460e211e6897953cec97d4&lt;/a&gt;&#160;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            37 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1ttl4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>