<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:40:36 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-17751] Contoller high CPU when formatted with --initial-controllers </title>
                <link>https://issues.apache.org/jira/browse/KAFKA-17751</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Hey,&lt;/p&gt;

&lt;p&gt;I&apos;m using 3.9.0 RC0.&lt;/p&gt;

&lt;p&gt;The issue only affects kraft.&lt;/p&gt;

&lt;p&gt;I noticed that formatting a simple three node controller cluster with --initial-controllers and starting the controller leads to a situation where the non-leader voters consume a lot of CPU.&lt;/p&gt;

&lt;p&gt;Here are the steps to reproduce. The needed configuration files are attached.&lt;/p&gt;

&lt;p&gt;Clean up and setup the environment.&lt;/p&gt;

&lt;p&gt;rm -rf /tmp/controllers &amp;amp;&amp;amp; \&lt;br/&gt;
mkdir -p /tmp/controllers/c1 &amp;amp;&amp;amp; \&lt;br/&gt;
mkdir -p /tmp/controllers/c2 &amp;amp;&amp;amp; \&lt;br/&gt;
mkdir -p /tmp/controllers/c3&lt;/p&gt;

&lt;p&gt;export KAFKA_HOME=&amp;lt;your_kafka_3_9_home&amp;gt;&lt;/p&gt;

&lt;p&gt;Format the controllers&lt;/p&gt;

&lt;p&gt;$KAFKA_HOME/bin/kafka-storage.sh format --cluster-id 00000000-0000-0000-0000-000000000001 --initial-controllers 1001@localhost:10001:AAAAAAAAAAEAAAAAAAAAAA,1002@localhost:10002:AAAAAAAAAAEAAAAAAAAAAA,1003@localhost:10003:AAAAAAAAAAEAAAAAAAAAAA --config c1.properties&lt;br/&gt;
$KAFKA_HOME/bin/kafka-storage.sh format --cluster-id 00000000-0000-0000-0000-000000000001 --initial-controllers 1001@localhost:10001:AAAAAAAAAAEAAAAAAAAAAA,1002@localhost:10002:AAAAAAAAAAEAAAAAAAAAAA,1003@localhost:10003:AAAAAAAAAAEAAAAAAAAAAA --config c2.properties&lt;br/&gt;
$KAFKA_HOME/bin/kafka-storage.sh format --cluster-id 00000000-0000-0000-0000-000000000001 --initial-controllers 1001@localhost:10001:AAAAAAAAAAEAAAAAAAAAAA,1002@localhost:10002:AAAAAAAAAAEAAAAAAAAAAA,1003@localhost:10003:AAAAAAAAAAEAAAAAAAAAAA --config c3.properties&lt;/p&gt;

&lt;p&gt;Start the controllers, in separate terminals&lt;/p&gt;

&lt;p&gt;$KAFKA_HOME/bin/kafka-run-class.sh -name kafkaService kafka.Kafka c1.properties&lt;br/&gt;
$KAFKA_HOME/bin/kafka-run-class.sh -name kafkaService kafka.Kafka c2.properties&lt;br/&gt;
$KAFKA_HOME/bin/kafka-run-class.sh -name kafkaService kafka.Kafka c3.properties&lt;/p&gt;

&lt;p&gt;Observe two of the controllers have CPU usage at 100%. If you check which PID is which, you can see that it&apos;s the two processes that are voters that have elevated CPU. The CPU usage of the leader is fine.&lt;/p&gt;

&lt;p&gt;I did in an slightly different environment some profiling. The screenshot is attached.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13594780">KAFKA-17751</key>
            <summary>Contoller high CPU when formatted with --initial-controllers </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gnarula">Gaurav Narula</assignee>
                                    <reporter username="juhamynttinen">Juha Mynttinen</reporter>
                        <labels>
                            <label>kraft</label>
                    </labels>
                <created>Wed, 9 Oct 2024 12:10:48 +0000</created>
                <updated>Thu, 10 Oct 2024 03:33:42 +0000</updated>
                            <resolved>Thu, 10 Oct 2024 03:33:42 +0000</resolved>
                                    <version>3.9.0</version>
                                    <fixVersion>3.9.0</fixVersion>
                    <fixVersion>4.0.0</fixVersion>
                                    <component>kraft</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17887957" author="gnarula" created="Wed, 9 Oct 2024 14:40:27 +0000"  >&lt;p&gt;I think this is a regression introduced by &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-16534&quot; title=&quot;Sending UpdateVoter request and response handling&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-16534&quot;&gt;&lt;del&gt;KAFKA-16534&lt;/del&gt;&lt;/a&gt;, in the changes to &lt;a href=&quot;https://github.com/apache/kafka/pull/16837/files#diff-1da15c51e641ea46ea5c86201ab8f21cfee9e7c575102a39c7bae0d5ffd7de39R3023&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;KafkaRaftClient::pollVoterAsFollower&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;In the scenario described above, the follower always hits the else block, and &lt;tt&gt;state.remainingUpdateVoterPeriodMs&lt;/tt&gt; eventually returns &lt;tt&gt;0&lt;/tt&gt;, thereby resulting in &lt;tt&gt;KafkaRaftClient::poll()&lt;/tt&gt; having a &lt;tt&gt;pollTimeoutMs&lt;/tt&gt; of &lt;tt&gt;0&lt;/tt&gt;. This causes the call to &lt;tt&gt;messageQueue.poll&lt;/tt&gt; to not block and thereby results in a busy-loop which causes high CPU load&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13072078" name="Screenshot 2024-10-09 at 9.15.06.png" size="256172" author="juhamynttinen" created="Wed, 9 Oct 2024 12:09:01 +0000"/>
                            <attachment id="13072081" name="c1.properties" size="354" author="juhamynttinen" created="Wed, 9 Oct 2024 12:07:43 +0000"/>
                            <attachment id="13072080" name="c2.properties" size="354" author="juhamynttinen" created="Wed, 9 Oct 2024 12:07:43 +0000"/>
                            <attachment id="13072079" name="c3.properties" size="354" author="juhamynttinen" created="Wed, 9 Oct 2024 12:07:43 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 4 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1rvk8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>