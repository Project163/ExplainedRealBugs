<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:43:31 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-18066] Misleading/mismatched StreamThread id in logging</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-18066</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;While debugging a test application I was confused to see a number of log lines where the StreamThread name appeared twice but had a different thread id/index in the same message. For example:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[INFO ] 2024-11-19 04:59:14.541 [e2e-963c5b74-0353-4253-bdf2-b71881d9d9f2-StreamThread-1] StreamThread - stream-thread [e2e-963c5b74-0353-4253-bdf2-b71881d9d9f2-StreamThread-3] Creating thread producer client&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Generally you would expect that the actual Logger prefix (the first thread name, in this case StreamThread-1) is the same as the LogContext prefix (the second thread name, ie the StreamThread-3 in this example). I dug into it and figured out that this happens for all of the messages logged during the StreamThread#create method, ie before the new thread is actually created. What happened was StreamThread-1 had actually died, and started up a new thread (StreamThread-3) to replace itself before shutting down. So we were logging things&#160;&lt;em&gt;about&lt;/em&gt; StreamThread-3, but&#160;&lt;em&gt;from&lt;/em&gt; StreamThread-1.&lt;/p&gt;

&lt;p&gt;While this doesn&apos;t necessarily harm anyone, it&apos;s quite confusing to see and requires extensive knowledge of Streams to understand (a) that it&apos;s not a bug, and (b) which thread the messages are actually referring to. It also makes things harder to parse and read &#8211; for example I often filter logs on the Logger prefix to gather everything related to a particular thread and eg the clients it owns. The name of the currently executing thread is more reliable and gathers everything whereas not every logger is configured with the LogContext prefix (eg `stream-thread &lt;span class=&quot;error&quot;&gt;&amp;#91;e2e-963c5b74-0353-4253-bdf2-b71881d9d9f2-StreamThread-3&amp;#93;&lt;/span&gt;`).&#160;&lt;/p&gt;

&lt;p&gt;We should move things out of the static StreamThread#create method and into the thread constructor to make the logging consistent and reliable.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13599646">KAFKA-18066</key>
            <summary>Misleading/mismatched StreamThread id in logging</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="bloku">Uladzislau Blok</assignee>
                                    <reporter username="ableegoldman">A. Sophie Blee-Goldman</reporter>
                        <labels>
                            <label>newbie</label>
                            <label>newbie++</label>
                    </labels>
                <created>Fri, 22 Nov 2024 06:14:01 +0000</created>
                <updated>Tue, 29 Jul 2025 00:01:22 +0000</updated>
                            <resolved>Tue, 29 Jul 2025 00:01:22 +0000</resolved>
                                                    <fixVersion>4.2.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="17900278" author="JIRAUSER306303" created="Fri, 22 Nov 2024 08:19:27 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ableegoldman&quot; class=&quot;user-hover&quot; rel=&quot;ableegoldman&quot;&gt;ableegoldman&lt;/a&gt;, may I take this ticket? Thanks!&lt;/p&gt;</comment>
                            <comment id="17900356" author="ableegoldman" created="Fri, 22 Nov 2024 12:14:07 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=peterxcli&quot; class=&quot;user-hover&quot; rel=&quot;peterxcli&quot;&gt;peterxcli&lt;/a&gt;&#160; Go for it!&lt;/p&gt;</comment>
                            <comment id="17900609" author="JIRAUSER306303" created="Sat, 23 Nov 2024 17:42:48 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ableegoldman&quot; class=&quot;user-hover&quot; rel=&quot;ableegoldman&quot;&gt;ableegoldman&lt;/a&gt;&#160;&lt;br/&gt;
I&#8217;m working on this and would like to hear your thoughts.&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/biggrin.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Currently, if we move the &lt;b&gt;creation&lt;/b&gt; logic directly into the &lt;tt&gt;StreamThread&lt;/tt&gt; constructor, it becomes harder to refactor tests that use mocks. For reference, see the &lt;a href=&quot;https://github.com/peterxcli/kafka/blob/2519e4af0c19d2540093c283f14dfe4111a5a21e/streams/src/test/java/org/apache/kafka/streams/processor/internals/StreamThreadTest.java#L1391-L1461&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;current test cases&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;To address this, I&#8217;m considering splitting the initialization process as follows:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Keep the &lt;tt&gt;StreamThread&lt;/tt&gt; constructor focused on mandatory, static dependencies:
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; StreamThread streamThread = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; StreamThread(
&#160; &#160; time,
&#160; &#160; config,
&#160; &#160; adminClient,
&#160; &#160; streamsMetrics,
&#160; &#160; topologyMetadata,
&#160; &#160; threadId,
&#160; &#160; logContext,
&#160; &#160; referenceContainer.assignmentErrorCode,
&#160; &#160; referenceContainer.nextScheduledRebalanceMs,
&#160; &#160; referenceContainer.nonFatalExceptionsToHandle,
&#160; &#160; shutdownErrorHook,
&#160; &#160; streamsUncaughtExceptionHandler,
&#160; &#160; cache::resize
); &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ol&gt;


&lt;ol&gt;
	&lt;li&gt;Add an &lt;tt&gt;initializeComponents&lt;/tt&gt; method for setting up additional components:
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
streamThread.initializeComponents(
&#160; &#160; mainConsumer,
&#160; &#160; restoreConsumer,
&#160; &#160; changelogReader,
&#160; &#160; originalReset,
&#160; &#160; taskManager,
&#160; &#160; stateUpdater
);&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;However, this approach requires removing the &lt;tt&gt;final&lt;/tt&gt; modifier from the properties set in &lt;tt&gt;initializeComponents&lt;/tt&gt;. While it simplifies testing with mocks, it might introduce potential mutability concerns.&lt;/p&gt;

&lt;p&gt;I&#8217;d appreciate any suggestions or insights! Thanks!&lt;/p&gt;</comment>
                            <comment id="17941531" author="JIRAUSER309258" created="Mon, 7 Apr 2025 10:42:03 +0000"  >&lt;p&gt;Hey &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=peterxcli&quot; class=&quot;user-hover&quot; rel=&quot;peterxcli&quot;&gt;peterxcli&lt;/a&gt;,&lt;br/&gt;
Are you still looking into that? If not I could pick this up&lt;/p&gt;</comment>
                            <comment id="17941532" author="JIRAUSER306303" created="Mon, 7 Apr 2025 10:42:44 +0000"  >&lt;p&gt;Sure&lt;/p&gt;</comment>
                            <comment id="17943817" author="JIRAUSER309258" created="Sat, 12 Apr 2025 14:03:23 +0000"  >&lt;p&gt;Hey &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ableegoldman&quot; class=&quot;user-hover&quot; rel=&quot;ableegoldman&quot;&gt;ableegoldman&lt;/a&gt; ,&lt;/p&gt;

&lt;p&gt;I&apos;ve taken a look at the problem and the proposed solution, and I&apos;m not sure how &lt;em&gt;moving things to the constructor&lt;/em&gt; would help&#8212;since the constructor code will still be executed by the current thread (StreamThread-1 in your example).&lt;/p&gt;

&lt;p&gt;My suggestion would be to use a logger without context in the &lt;tt&gt;create&lt;/tt&gt; method.&lt;/p&gt;

&lt;p&gt;Logs before the fix:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
egrep main.*StreamThread kafka-test.log
953 &#160;[main] INFO &#160;o.a.k.s.p.internals.StreamThread - stream-thread [streams-linesplit1-aa392bb8-ee8e-44af-9a85-41036d69b423-StreamThread-1] Creating restore consumer client
1096 [main] INFO &#160;o.a.k.c.producer.KafkaProducer - [Producer clientId=streams-linesplit1-aa392bb8-ee8e-44af-9a85-41036d69b423-StreamThread-1-producer] Instantiated an idempotent producer.
1151 [main] INFO &#160;o.a.k.s.p.internals.StreamThread - stream-thread [streams-linesplit1-aa392bb8-ee8e-44af-9a85-41036d69b423-StreamThread-1] Creating consumer client &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Logs after change:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
egrep main.*StreamThread kafka-test.log
973 &#160;[main] INFO &#160;o.a.k.s.p.internals.StreamThread - Creating restore consumer client
1094 [main] INFO &#160;o.a.k.c.producer.KafkaProducer - [Producer clientId=streams-linesplit1-f107dfdf-8786-46c3-97d4-16c6083e242a-StreamThread-1-producer] Instantiated an idempotent producer.
1149 [main] INFO &#160;o.a.k.s.p.internals.StreamThread - Creating consumer client &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17948213" author="JIRAUSER309258" created="Tue, 29 Apr 2025 16:27:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ableegoldman&quot; class=&quot;user-hover&quot; rel=&quot;ableegoldman&quot;&gt;ableegoldman&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mjsax&quot; class=&quot;user-hover&quot; rel=&quot;mjsax&quot;&gt;mjsax&lt;/a&gt; Hey. Sorry for bothering you. You were in the watchers list. There is a fix available, could you please take a look?&lt;br/&gt;
&#160;&lt;br/&gt;
&#160;&lt;br/&gt;
&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17948338" author="mjsax" created="Wed, 30 Apr 2025 02:38:32 +0000"  >&lt;p&gt;Thanks for the ping &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bloku&quot; class=&quot;user-hover&quot; rel=&quot;bloku&quot;&gt;bloku&lt;/a&gt; &#8211; I did miss that a PR was opened. Not sure when we would get to reviewing it, but noted.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            27 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1spgg:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>