<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:25:25 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-10395] TopologyTestDriver does not work with dynamic topic routing</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-10395</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;The TopologyTestDriver#read(topic) methods all call #getRecordsQueue which checks&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Queue&amp;lt;ProducerRecord&amp;lt;&lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[], &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[]&amp;gt;&amp;gt; outputRecords = outputRecordsByTopic.get(topicName);
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (outputRecords == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!processorTopology.sinkTopics().contains(topicName)) {
        &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IllegalArgumentException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Unknown topic: &quot;&lt;/span&gt; + topicName); 
    } 
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The&#160;outputRecordsByTopic map keeps track of all topics that are actually produced to, but obviously doesn&apos;t capture any topics that haven&apos;t yet received output. The `processorTopology#sinkTopics` is supposed to account for that by checking to make sure the topic is actually registered in the topology, and throw an exception if not in case the user supplied the wrong topic name to read from.&#160;&lt;/p&gt;

&lt;p&gt;Unfortunately the TopicNameExtractor allows for dynamic routing of records to any topic, so the topology isn&apos;t aware of all the possible output topics. If trying to read from one of these topics that happens to not have received any output yet, the test will throw the above misleading IllegalArgumentException.&lt;/p&gt;

&lt;p&gt;We could just relax this check, but warning users who may actually have accidentally passed in the wrong topic to read from seems quite useful. A better solution would be to require registering all possible output topics to the TTD up front. This would obviously require a KIP, but it would be a very small one and shouldn&apos;t be too much trouble&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13322421">KAFKA-10395</key>
            <summary>TopologyTestDriver does not work with dynamic topic routing</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ableegoldman">A. Sophie Blee-Goldman</assignee>
                                    <reporter username="ableegoldman">A. Sophie Blee-Goldman</reporter>
                        <labels>
                            <label>test-framework</label>
                    </labels>
                <created>Wed, 12 Aug 2020 23:57:37 +0000</created>
                <updated>Wed, 26 Aug 2020 21:39:35 +0000</updated>
                            <resolved>Tue, 18 Aug 2020 16:55:43 +0000</resolved>
                                                    <fixVersion>2.6.1</fixVersion>
                    <fixVersion>2.7.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17176665" author="ableegoldman" created="Thu, 13 Aug 2020 00:13:56 +0000"  >&lt;p&gt;I think we could just modify the TestOutputTopic constructor to automatically register the output topic with the TTD, which wouldn&apos;t need a KIP. This wouldn&apos;t help users who just read from the TTD directly instead of using the new TestOutputTopic class, but maybe that&apos;s sufficient. We can just tell people to always use TestOutputTopic if their topology has dynamic routing?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;edit: Actually it looks like the only public APIs that run into this issue are from TestOutputTopic, so we can avoid a KIP. That said, registering the topics for which a TestOutputTopic instance is created is not all that different from relaxing/removing the check altogether. So maybe we should just do that &#8211; we can at least log a warning still&lt;/p&gt;</comment>
                            <comment id="17176675" author="ableegoldman" created="Thu, 13 Aug 2020 00:49:30 +0000"  >&lt;p&gt;The only really holistic solution I can think of would be to add some API to register the possible output topics on the TopicNameExtractor itself. But that seems like overkill here and honestly just replacing the exception with a warning log sounds good enough&lt;/p&gt;</comment>
                            <comment id="17177139" author="vvcephei" created="Thu, 13 Aug 2020 16:37:41 +0000"  >&lt;p&gt;Thanks, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ableegoldman&quot; class=&quot;user-hover&quot; rel=&quot;ableegoldman&quot;&gt;ableegoldman&lt;/a&gt; , I agree with your analysis.&lt;/p&gt;

&lt;p&gt;I think TestOutputTopic is supposed to be the &quot;only&quot; way to read data from TopologyTestDriver, so it seems that having it auto-register its topic argument is not practically different than just skipping that check.&lt;/p&gt;

&lt;p&gt;Because TopicNameExtractor is only a one-way function from record to topic name, there&apos;s no way to check if a topic name &quot;matches&quot; a TopicNameExtractor. It seems like if we still really want to have some kind of check, we could add a `TopicNameExtractor#matches(String topicName)` method. But that interface may be unsatisfiable for some implementations.&lt;/p&gt;

&lt;p&gt;I did notice that the javadoc on TopicNameExtractor says, &quot;The topic name must already exist, since the Kafka Streams library will not try to automatically create the topic with the extracted name.&quot; So, maybe it makes more sense to make the TestOutputTopic register the output topics, and then throw an exception when the application produces to a topic that hasn&apos;t been &quot;registered&quot;.&lt;/p&gt;

&lt;p&gt;Even that might break some tests, since right now people can register the output topic after they produce data, so it would need a KIP.&lt;/p&gt;

&lt;p&gt;Realistically, I don&apos;t think it&apos;s too bad just to remove that check. We already guarantee that processing is synchronous, so if you use the wrong output topic name, it should be pretty obvious that something is wrong when you get no output. I guess we could split the difference by still enforcing that check when there are only StaticTopicNameExtractors in the topology.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 13 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0hq00:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>