<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:07:02 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-5624] Unsafe use of expired sensors</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-5624</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Seems a couple unhandled cases following sensor expiration:&lt;/p&gt;

&lt;p&gt;1. Static sensors (such as &lt;tt&gt;ClientQuotaManager.delayQueueSensor&lt;/tt&gt;) can be expired due to inactivity, but the references will remain valid and usable. Probably a good idea to either ensure we use a &quot;get or create&quot; pattern when accessing the sensor or add a new static registration option which makes the sensor ineligible for expiration.&lt;br/&gt;
2. It is possible to register metrics through the sensor even after it is expired. We should probably raise an exception instead.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13089099">KAFKA-5624</key>
            <summary>Unsafe use of expired sensors</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="omkreddy">Manikumar</assignee>
                                    <reporter username="hachikuji">Jason Gustafson</reporter>
                        <labels>
                    </labels>
                <created>Fri, 21 Jul 2017 16:49:44 +0000</created>
                <updated>Tue, 20 Feb 2018 16:57:43 +0000</updated>
                            <resolved>Tue, 20 Feb 2018 16:57:43 +0000</resolved>
                                                    <fixVersion>2.0.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="16318774" author="githubbot" created="Tue, 9 Jan 2018 17:26:37 +0000"  >&lt;p&gt;omkreddy opened a new pull request #4404: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5624&quot; title=&quot;Unsafe use of expired sensors&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-5624&quot;&gt;&lt;del&gt;KAFKA-5624&lt;/del&gt;&lt;/a&gt;: Add expiry check to sensor.add() methods&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/4404&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/4404&lt;/a&gt;&lt;/p&gt;




&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16370258" author="githubbot" created="Tue, 20 Feb 2018 16:57:24 +0000"  >&lt;p&gt;hachikuji closed pull request #4404: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5624&quot; title=&quot;Unsafe use of expired sensors&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-5624&quot;&gt;&lt;del&gt;KAFKA-5624&lt;/del&gt;&lt;/a&gt;: Add expiry check to sensor.add() methods&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/4404&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/4404&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/clients/src/main/java/org/apache/kafka/common/metrics/Sensor.java b/clients/src/main/java/org/apache/kafka/common/metrics/Sensor.java&lt;br/&gt;
index 837ac2e4b43..06c8c7f362b 100644&lt;br/&gt;
&amp;#8212; a/clients/src/main/java/org/apache/kafka/common/metrics/Sensor.java&lt;br/&gt;
+++ b/clients/src/main/java/org/apache/kafka/common/metrics/Sensor.java&lt;br/&gt;
@@ -207,9 +207,11 @@ public void checkQuotas(long timeMs) {&lt;/p&gt;

&lt;p&gt;     /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Register a compound statistic with this sensor with no config override&lt;br/&gt;
+     * @param stat The stat to register&lt;br/&gt;
+     * @return true if stat is added to sensor, false if sensor is expired&lt;br/&gt;
      */&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public void add(CompoundStat stat) {&lt;/li&gt;
	&lt;li&gt;add(stat, null);&lt;br/&gt;
+    public boolean add(CompoundStat stat) 
{
+        return add(stat, null);
     }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     /**&lt;br/&gt;
@@ -217,8 +219,12 @@ public void add(CompoundStat stat) {&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;@param stat The stat to register&lt;/li&gt;
	&lt;li&gt;@param config The configuration for this stat. If null then the stat will use the default configuration for this&lt;/li&gt;
	&lt;li&gt;sensor.&lt;br/&gt;
+     * @return true if stat is added to sensor, false if sensor is expired&lt;br/&gt;
      */&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public synchronized void add(CompoundStat stat, MetricConfig config) {&lt;br/&gt;
+    public synchronized boolean add(CompoundStat stat, MetricConfig config) {&lt;br/&gt;
+        if (hasExpired())&lt;br/&gt;
+            return false;&lt;br/&gt;
+&lt;br/&gt;
         this.stats.add(Utils.notNull(stat));&lt;br/&gt;
         Object lock = new Object();&lt;br/&gt;
         for (NamedMeasurable m : stat.stats()) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {@@ -226,15 +232,17 @@ public synchronized void add(CompoundStat stat, MetricConfig config) {
             this.registry.registerMetric(metric);
             this.metrics.add(metric);
         }+        return true;     }&lt;/span&gt; &lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Register a metric with this sensor&lt;/li&gt;
	&lt;li&gt;@param metricName The name of the metric&lt;/li&gt;
	&lt;li&gt;@param stat The statistic to keep&lt;br/&gt;
+     * @return true if metric is added to sensor, false if sensor is expired&lt;br/&gt;
      */&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public void add(MetricName metricName, MeasurableStat stat) {&lt;/li&gt;
	&lt;li&gt;add(metricName, stat, null);&lt;br/&gt;
+    public boolean add(MetricName metricName, MeasurableStat stat) 
{
+        return add(metricName, stat, null);
     }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     /**&lt;br/&gt;
@@ -242,8 +250,12 @@ public void add(MetricName metricName, MeasurableStat stat) {&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;@param metricName The name of the metric&lt;/li&gt;
	&lt;li&gt;@param stat The statistic to keep&lt;/li&gt;
	&lt;li&gt;@param config A special configuration for this metric. If null use the sensor default configuration.&lt;br/&gt;
+     * @return true if metric is added to sensor, false if sensor is expired&lt;br/&gt;
      */&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public synchronized void add(MetricName metricName, MeasurableStat stat, MetricConfig config) {&lt;br/&gt;
+    public synchronized boolean add(MetricName metricName, MeasurableStat stat, MetricConfig config) 
{
+        if (hasExpired())
+            return false;
+
         KafkaMetric metric = new KafkaMetric(new Object(),
                                              Utils.notNull(metricName),
                                              Utils.notNull(stat),
@@ -252,6 +264,7 @@ public synchronized void add(MetricName metricName, MeasurableStat stat, MetricC
         this.registry.registerMetric(metric);
         this.metrics.add(metric);
         this.stats.add(stat);
+        return true;
     }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     /**&lt;br/&gt;
diff --git a/clients/src/test/java/org/apache/kafka/clients/producer/internals/BufferPoolTest.java b/clients/src/test/java/org/apache/kafka/clients/producer/internals/BufferPoolTest.java&lt;br/&gt;
index 8bcc775df56..23fc5411b3c 100644&lt;br/&gt;
&amp;#8212; a/clients/src/test/java/org/apache/kafka/clients/producer/internals/BufferPoolTest.java&lt;br/&gt;
+++ b/clients/src/test/java/org/apache/kafka/clients/producer/internals/BufferPoolTest.java&lt;br/&gt;
@@ -256,7 +256,7 @@ public void testCleanupMemoryAvailabilityOnMetricsException() throws Exception {&lt;br/&gt;
         mockedSensor.record(anyDouble(), anyLong());&lt;br/&gt;
         expectLastCall().andThrow(new OutOfMemoryError());&lt;br/&gt;
         expect(mockedMetrics.metricName(anyString(), eq(metricGroup), anyString())).andReturn(metricName);&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;mockedSensor.add(new Meter(TimeUnit.NANOSECONDS, rateMetricName, totalMetricName));&lt;br/&gt;
+        expect(mockedSensor.add(new Meter(TimeUnit.NANOSECONDS, rateMetricName, totalMetricName))).andReturn(true);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         replay(mockedMetrics, mockedSensor, metricName);&lt;/p&gt;

&lt;p&gt;diff --git a/clients/src/test/java/org/apache/kafka/common/metrics/SensorTest.java b/clients/src/test/java/org/apache/kafka/common/metrics/SensorTest.java&lt;br/&gt;
index d22111e128e..3f7551ef985 100644&lt;br/&gt;
&amp;#8212; a/clients/src/test/java/org/apache/kafka/common/metrics/SensorTest.java&lt;br/&gt;
+++ b/clients/src/test/java/org/apache/kafka/common/metrics/SensorTest.java&lt;br/&gt;
@@ -20,7 +20,17 @@&lt;br/&gt;
 import static org.junit.Assert.assertFalse;&lt;br/&gt;
 import static org.junit.Assert.assertTrue;&lt;/p&gt;

&lt;p&gt;+import java.util.Arrays;&lt;br/&gt;
+import java.util.Collections;&lt;br/&gt;
+import java.util.Map;&lt;br/&gt;
+import java.util.concurrent.TimeUnit;&lt;br/&gt;
+&lt;br/&gt;
+import org.apache.kafka.common.MetricName;&lt;br/&gt;
+import org.apache.kafka.common.metrics.stats.Avg;&lt;br/&gt;
+import org.apache.kafka.common.metrics.stats.Meter;&lt;br/&gt;
+import org.apache.kafka.common.utils.MockTime;&lt;br/&gt;
 import org.apache.kafka.common.utils.SystemTime;&lt;br/&gt;
+import org.apache.kafka.common.utils.Time;&lt;br/&gt;
 import org.junit.Test;&lt;/p&gt;

&lt;p&gt; public class SensorTest {&lt;br/&gt;
@@ -59,4 +69,29 @@ public void testShouldRecord() &lt;/p&gt;
{
             0, Sensor.RecordingLevel.DEBUG);
         assertFalse(debugSensor.shouldRecord());
     }
&lt;p&gt;+&lt;br/&gt;
+    @Test&lt;br/&gt;
+    public void testExpiredSensor() &lt;/p&gt;
{
+        MetricConfig config = new MetricConfig();
+        Time mockTime = new MockTime();
+        Metrics metrics =  new Metrics(config, Arrays.asList((MetricsReporter) new JmxReporter()), mockTime, true);
+
+        long inactiveSensorExpirationTimeSeconds = 60L;
+        Sensor sensor = new Sensor(metrics, &quot;sensor&quot;, null, config, mockTime,
+            inactiveSensorExpirationTimeSeconds, Sensor.RecordingLevel.INFO);
+
+        assertTrue(sensor.add(metrics.metricName(&quot;test1&quot;, &quot;grp1&quot;), new Avg()));
+
+        Map&amp;lt;String, String&amp;gt; emptyTags = Collections.emptyMap();
+        MetricName rateMetricName = new MetricName(&quot;rate&quot;, &quot;test&quot;, &quot;&quot;, emptyTags);
+        MetricName totalMetricName = new MetricName(&quot;total&quot;, &quot;test&quot;, &quot;&quot;, emptyTags);
+        Meter meter = new Meter(rateMetricName, totalMetricName);
+        assertTrue(sensor.add(meter));
+
+        mockTime.sleep(TimeUnit.SECONDS.toMillis(inactiveSensorExpirationTimeSeconds + 1));
+        assertFalse(sensor.add(metrics.metricName(&quot;test3&quot;, &quot;grp1&quot;), new Avg()));
+        assertFalse(sensor.add(meter));
+
+        metrics.close();
+    }
&lt;p&gt; }&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 39 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3huwf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>