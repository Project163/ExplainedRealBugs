<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:27:04 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-12375] ReplaceStreamThread creates a new consumer with the same name as the one it&apos;s replacing</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-12375</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;I was debugging the kafka-streams soak cluster and noticed that replacing a stream thread was causing the streams application to fail. I have managed to find the following stacktrace:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
javax.management.InstanceAlreadyExistsException: kafka.consumer:type=app-info,id=i-0cdac8830ee1b8f01-StreamThread-1-restore-consumer at com.sun.jmx.mbeanserver.Repository.addMBean(Repository.java:437) at com.sun.jmx.interceptor.DefaultMBeanServerInterceptor.registerWithRepository(DefaultMBeanServerInterceptor.java:1898) at com.sun.jmx.interceptor.DefaultMBeanServerInterceptor.registerDynamicMBean(DefaultMBeanServerInterceptor.java:966) at com.sun.jmx.interceptor.DefaultMBeanServerInterceptor.registerObject(DefaultMBeanServerInterceptor.java:900) at com.sun.jmx.interceptor.DefaultMBeanServerInterceptor.registerMBean(DefaultMBeanServerInterceptor.java:324) at com.sun.jmx.mbeanserver.JmxMBeanServer.registerMBean(JmxMBeanServer.java:522) at org.apache.kafka.common.utils.AppInfoParser.registerAppInfo(AppInfoParser.java:64) at org.apache.kafka.clients.consumer.KafkaConsumer.&amp;lt;init&amp;gt;(KafkaConsumer.java:815) at org.apache.kafka.clients.consumer.KafkaConsumer.&amp;lt;init&amp;gt;(KafkaConsumer.java:666) at org.apache.kafka.streams.processor.internals.DefaultKafkaClientSupplier.getRestoreConsumer(DefaultKafkaClientSupplier.java:56) at org.apache.kafka.streams.processor.internals.StreamThread.create(StreamThread.java:338) at org.apache.kafka.streams.KafkaStreams.createAndAddStreamThread(KafkaStreams.java:896) at org.apache.kafka.streams.KafkaStreams.addStreamThread(KafkaStreams.java:977) at org.apache.kafka.streams.KafkaStreams.replaceStreamThread(KafkaStreams.java:467) at org.apache.kafka.streams.KafkaStreams.handleStreamsUncaughtException(KafkaStreams.java:487) at org.apache.kafka.streams.KafkaStreams.lambda$setUncaughtExceptionHandler$1(KafkaStreams.java:427) at org.apache.kafka.streams.processor.internals.StreamThread.runLoop(StreamThread.java:607) at org.apache.kafka.streams.processor.internals.StreamThread.run(StreamThread.java:555)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;followed by:&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Exception in thread &lt;span class=&quot;code-quote&quot;&gt;&quot;i-0e4d869ffd67ec825-StreamThread-1&quot;&lt;/span&gt; java.util.ConcurrentModificationException: KafkaConsumer is not safe &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; multi-threaded access	at org.apache.kafka.clients.consumer.KafkaConsumer.acquire(KafkaConsumer.java:2446)	at org.apache.kafka.clients.consumer.KafkaConsumer.acquireAndEnsureOpen(KafkaConsumer.java:2430)	at org.apache.kafka.clients.consumer.KafkaConsumer.enforceRebalance(KafkaConsumer.java:2261)	at org.apache.kafka.streams.processor.internals.StreamThread.sendShutdownRequest(StreamThread.java:666)	at org.apache.kafka.streams.KafkaStreams.lambda$handleStreamsUncaughtException$4(KafkaStreams.java:508)	at org.apache.kafka.streams.KafkaStreams.processStreamThread(KafkaStreams.java:1579)	at org.apache.kafka.streams.KafkaStreams.handleStreamsUncaughtException(KafkaStreams.java:508)	at org.apache.kafka.streams.KafkaStreams.lambda$setUncaughtExceptionHandler$1(KafkaStreams.java:427)	at org.apache.kafka.streams.processor.internals.StreamThread.runLoop(StreamThread.java:607)	at org.apache.kafka.streams.processor.internals.StreamThread.run(StreamThread.java:555)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;My understanding so far is that we re-use the consumer name across thread generations which can hit a few flavours of a race condition. My suggestion would be to add the generation-id to the consumer name.&lt;/p&gt;

&lt;p&gt;This could be done by adding a thread generation id here&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/kafka/blob/b35ca4349dabb199411cb6bc4c80ef89f19d9328/streams/src/main/java/org/apache/kafka/streams/processor/internals/ClientUtils.java#L66&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/b35ca4349dabb199411cb6bc4c80ef89f19d9328/streams/src/main/java/org/apache/kafka/streams/processor/internals/ClientUtils.java#L66&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;or by adding an overload here: &lt;a href=&quot;https://github.com/apache/kafka/blob/b35ca4349dabb199411cb6bc4c80ef89f19d9328/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamThread.java#L390&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/b35ca4349dabb199411cb6bc4c80ef89f19d9328/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamThread.java#L390&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// Some comments here
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;&amp;gt; consumerConfigs = config.getMainConsumerConfigs(applicationId, getConsumerClientId(threadId), threadIdx, generationId);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I have not yet checked if there are any implications to either of these solutions&lt;/p&gt;</description>
                <environment></environment>
        <key id="13361033">KAFKA-12375</key>
            <summary>ReplaceStreamThread creates a new consumer with the same name as the one it&apos;s replacing</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="swistak">Tomasz Nguyen</assignee>
                                    <reporter username="swistak">Tomasz Nguyen</reporter>
                        <labels>
                    </labels>
                <created>Thu, 25 Feb 2021 19:14:42 +0000</created>
                <updated>Wed, 3 Mar 2021 00:33:58 +0000</updated>
                            <resolved>Wed, 3 Mar 2021 00:33:53 +0000</resolved>
                                    <version>2.8.0</version>
                                    <fixVersion>2.8.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="17291178" author="ableegoldman" created="Thu, 25 Feb 2021 19:47:17 +0000"  >&lt;p&gt;Possible blocker for 2.8? cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vvcephei&quot; class=&quot;user-hover&quot; rel=&quot;vvcephei&quot;&gt;vvcephei&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17291209" author="vvcephei" created="Thu, 25 Feb 2021 20:46:33 +0000"  >&lt;p&gt;Thanks, all. The 2.8 branch is not yet stabilized, and it would be a bummer to release this new feature with this bug present, and it doesn&apos;t seem too risky to resolve, so I&apos;ve gone ahead and marked it as a blocker.&lt;/p&gt;

&lt;p&gt;A quick note on the proposed ideas: I think those are public APIs, so it might not be ideal to change them if it can be avoided. Just looking at that those stacktraces, I&apos;m not confident that changing the name is the proper solution here:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;The first one is an error that comes from trying to register the same metric twice. We could fix that by making sure that we properly close the old client and unregister its metrics before creating the new one.&lt;/li&gt;
	&lt;li&gt;The second error looks like we are actually invoking a method on the consumer from outside of the StreamThread that owns it, which is actually not ok. The name is not relevant here, but the actual object instance. We should re-evaluate the implementation to make sure that we won&apos;t attempt multi-threaded access to the Consumer.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Thanks for your diligence in tracking this down, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=swistak&quot; class=&quot;user-hover&quot; rel=&quot;swistak&quot;&gt;swistak&lt;/a&gt; !&lt;/p&gt;</comment>
                            <comment id="17291220" author="cadonna" created="Thu, 25 Feb 2021 21:04:56 +0000"  >&lt;p&gt;I do not think that the &lt;tt&gt;java.util.ConcurrentModificationException&lt;/tt&gt; has anything to do with the re-use of the consumer name. I think the issue is that when we shutdown the application, the stream thread that requests the shutdown calls &lt;tt&gt;mainConsumer.enforceRebalance()&lt;/tt&gt; on all stream threads on the same Streams client (&lt;a href=&quot;https://github.com/apache/kafka/blob/b35ca4349dabb199411cb6bc4c80ef89f19d9328/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamThread.java#L666&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/b35ca4349dabb199411cb6bc4c80ef89f19d9328/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamThread.java#L666&lt;/a&gt;). If the &lt;tt&gt;mainConsumer&lt;/tt&gt; is in the middle of something when this happens, the &lt;tt&gt;java.util.ConcurrentModificationException&lt;/tt&gt; is thrown.&lt;/p&gt;</comment>
                            <comment id="17291329" author="ableegoldman" created="Fri, 26 Feb 2021 01:20:24 +0000"  >&lt;p&gt;Ah, good catch Bruno. We definitely should not be invoking `enforceRebalance`, or any Consumer method, outside of the owning StreamThread. We can just set the error code and then inside the StreamThread&apos;s main poll loop, check the assignmentErrorCode and invoke `enforceRebalance` there. Note that this is exactly as efficient, since regardless of when you call `enforceRebalance` the StreamThread wouldn&apos;t have actually rejoined the group until it got around to invoking poll() anyways&lt;/p&gt;</comment>
                            <comment id="17291331" author="ableegoldman" created="Fri, 26 Feb 2021 01:25:35 +0000"  >&lt;p&gt;Regarding the&#160;javax.management.InstanceAlreadyExistsException, this is something I&apos;ve seen in user logs and tests before. It&apos;s definitely a bit confusing/potentially concerning to a user, but I don&apos;t think it&apos;s a new problem. Maybe the REPLACE_THREAD functionality will have made it slightly more common. Would be nice to fix, but I wouldn&apos;t press for that as a blocker of 2.8&lt;/p&gt;</comment>
                            <comment id="17291333" author="ableegoldman" created="Fri, 26 Feb 2021 01:31:56 +0000"  >&lt;p&gt;Of course, this still leaves open the question of why we were hitting&#160;SHUTDOWN_REQUESTED in the first place. That seems to indicate there was another unexpected exception that we hit first, and the ConcurrentModificationException is only a part of the overall problem. However I don&apos;t think the InstanceAlreadyExistsException should have been thrown all the way up to the exception handler. What was the original exception &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=swistak&quot; class=&quot;user-hover&quot; rel=&quot;swistak&quot;&gt;swistak&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="17291354" author="ableegoldman" created="Fri, 26 Feb 2021 02:45:39 +0000"  >&lt;p&gt;Just to keep everyone up-to-date, the root cause of the application shutting down was due to hitting a RocksDBException: No locks available&lt;/p&gt;

&lt;p&gt;This basically means we tried to open rocksdb twice. This can itself mean either that two threads both claimed to own the task directory at the same time, or that we didn&apos;t close the rocksdb before trying to re-open it again. In this case, I believe it&apos;s actually both: we hit a recoverable exception and fell back on the REPLACE_THREAD functionality. This gave the new thread the same thread.is as the one it&apos;s replacing, and therefore the same thread name. This resulted in the RocksDBException because (1) the old thread did not shut down before the new thread started up, and (2) our task directory locking mechanism tracks ownership via the thread name. The new thread&#160;&lt;em&gt;should&lt;/em&gt; have had to wait for the old thread to clean up and close rocksdb, but Streams can&apos;t tell the difference between two threads with the same name and just assumed that the new thread already owned the lock.&lt;/p&gt;

&lt;p&gt;There are a few approaches we could take here: ideally our locking mechanism would have been able to distinguish these two threads. But the thread name is really the only practical way to track ownership, and more importantly, the assumption that a thread has a unique id/name is baked into Kafka Streams. I&apos;m not confident that just fixing the locking layer would solve all of our problems here. I think the two realistic solutions here are&lt;/p&gt;

&lt;p&gt;1) Don&apos;t start up the new thread until the old thread has finished shutting down&lt;/p&gt;

&lt;p&gt;2) Give the new thread a different thread.id than the one it&apos;s replacing&lt;/p&gt;

&lt;p&gt;Imo option 2 makes the most sense, as it doesn&apos;t delay the startup of the replacement thread and we can still reuse the old thread id once it does finish shutting down. Also just anecdotally, giving the new thread a fresh id will make it easier to understand and get oriented in the logs across a REPLACE_THREAD event&lt;/p&gt;</comment>
                            <comment id="17291734" author="vvcephei" created="Fri, 26 Feb 2021 16:15:39 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ableegoldman&quot; class=&quot;user-hover&quot; rel=&quot;ableegoldman&quot;&gt;ableegoldman&lt;/a&gt; .&lt;/p&gt;

&lt;p&gt;I couldn&apos;t believe that the locking is really just based on the name of the thread, so I had to see for myself:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
org.apache.kafka.streams.processor.internals.StateDirectory#lock:

&lt;span class=&quot;code-comment&quot;&gt;// we already have the lock so bail out here
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; LockAndOwner lockAndOwner = locks.get(taskId);
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (lockAndOwner != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; lockAndOwner.owningThread.equals(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.currentThread().getName())) {
    log.trace(&lt;span class=&quot;code-quote&quot;&gt;&quot;{} Found cached state dir lock &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; task {}&quot;&lt;/span&gt;, logPrefix(), taskId);
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (lockAndOwner != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
    &lt;span class=&quot;code-comment&quot;&gt;// another thread owns the lock
&lt;/span&gt;    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This is bad, and we can fix it by simply using the Thread reference instead. Is there a reason to prefer working around this bug by being super careful with thread names instead?&lt;/p&gt;</comment>
                            <comment id="17291753" author="ableegoldman" created="Fri, 26 Feb 2021 16:44:01 +0000"  >&lt;p&gt;My primary motivation for fixing the thread names was that there are other things (eg the client ids) which are based on the thread.id, and are presumed to be unique. I&apos;m not even sure we could recognize all possible symptoms of temporarily overlapping client.ids.&lt;/p&gt;

&lt;p&gt;That said, I would be happy to fix the locking mechanism&#160;&lt;em&gt;in addition&lt;/em&gt; to ensuring a unique thread.id. I was planning a larger scale cleanup of the locking for sometime after 2.8, but we can take the first steps of tightening it up now. The only reason I didn&apos;t propose this initially was because I feel we still need to put in a fix to ensure a unique thread.id, which would happen to be sufficient to solve this particular problem as well. But I don&apos;t see any strong reason why we shouldn&apos;t do both&lt;/p&gt;</comment>
                            <comment id="17291777" author="cadonna" created="Fri, 26 Feb 2021 17:08:30 +0000"  >&lt;p&gt;I agree with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ableegoldman&quot; class=&quot;user-hover&quot; rel=&quot;ableegoldman&quot;&gt;ableegoldman&lt;/a&gt; that ensuring a unique thread ID solves also other issues like the metrics issue above. We cannot wait for the metrics to be removed from the metrics because that happens during the shutdown that means after the stream thread has been replaced. &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 37 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0o2mo:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>