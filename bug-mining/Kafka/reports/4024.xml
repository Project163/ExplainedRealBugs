<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:41:22 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-18194] Flaky test_broker_rolling_bounce due to metadata update</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-18194</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;This is introduced after KIP-1102 I believe this is a critical bug because bounced broker will caused rebalance.&lt;/p&gt;

&lt;p&gt;When examining the consumer log you will see:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;When we bounce a broker, sometimes it triggers rebootstrapping&lt;/li&gt;
	&lt;li&gt;Rebootstrapping forces metadata update&lt;/li&gt;
	&lt;li&gt;Request joining group due to: cached metadata has changed from (version20: {test_topic=&lt;span class=&quot;error&quot;&gt;&amp;#91;NO_RACKS&amp;#93;&lt;/span&gt;}) at the beginning of the rebalance to (ver &#160; &#160; sion21: {test_topic=[]}) (org.apache.kafka.clients.consumer.internals.ConsumerCoordinator)&lt;/li&gt;
	&lt;li&gt;Causing the consumer to rejoin every time the server is bounded&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Here&apos;s the snippet of the log&lt;br/&gt;
&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
8156 [2024-12-10 04:44:37,227] DEBUG [Consumer clientId=consumer-test_group_id-1, groupId=test_group_id] Sending API_VERSIONS request with header RequestHeader(apiKey=API_VERSIONS, apiVersion=4, clientId=consumer-test_group_id-1, correlationId=1 &#160; &#160; 22, headerVersion=2) and timeout 30000 to node 1: ApiVersionsRequestData(clientSoftwareName=&lt;span class=&quot;code-quote&quot;&gt;&apos;apache-kafka-java&apos;&lt;/span&gt;, clientSoftwareVersion=&lt;span class=&quot;code-quote&quot;&gt;&apos;---&apos;&lt;/span&gt;) (org.apache.kafka.clients.NetworkClient)
8157 [2024-12-10 04:44:37,227] TRACE [Consumer clientId=consumer-test_group_id-1, groupId=test_group_id] Polling &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; fetches with timeout 1600 (org.apache.kafka.clients.consumer.internals.ClassicKafkaConsumer)
8158 [2024-12-10 04:44:37,227] TRACE [Consumer clientId=consumer-test_group_id-1, groupId=test_group_id] Found least loaded connecting node ducker03:9092 (id: -1 rack: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) (org.apache.kafka.clients.NetworkClient)
8159 [2024-12-10 04:44:37,227] TRACE For telemetry state SUBSCRIPTION_NEEDED, returning the value 156047 ms; &#160;(org.apache.kafka.common.telemetry.internals.ClientTelemetryReporter)
8160 [2024-12-10 04:44:37,227] INFO [Consumer clientId=consumer-test_group_id-1, groupId=test_group_id] Request joining group due to: cached metadata has changed from (version20: {test_topic=[NO_RACKS]}
) at the beginning of the rebalance to (ver &#160; &#160; sion21:
{test_topic=[]}
) (org.apache.kafka.clients.consumer.internals.ConsumerCoordinator)
8161 [2024-12-10 04:44:37,227] DEBUG [Consumer clientId=consumer-test_group_id-1, groupId=test_group_id] Executing onJoinPrepare with generation 7 and memberId consumer-test_group_id-1-61dfefb9-acdd-4050-ba0a-56f5d5ed1c3d (org.apache.kafka.clien &#160; &#160; ts.consumer.internals.ConsumerCoordinator)
8162 [2024-12-10 04:44:37,227] INFO [Consumer clientId=consumer-test_group_id-1, groupId=test_group_id] Revoke previously assigned partitions &#160;(org.apache.kafka.clients.consumer.internals.ConsumerRebalanceListenerInvoker)
8163 [2024-12-10 04:44:37,228] INFO [Consumer clientId=consumer-test_group_id-1, groupId=test_group_id] (Re-)joining group (org.apache.kafka.clients.consumer.internals.ConsumerCoordinator)
8164 [2024-12-10 04:44:37,228] DEBUG [Consumer clientId=consumer-test_group_id-1, groupId=test_group_id] Joining group with current subscription: [test_topic] (org.apache.kafka.clients.consumer.internals.ConsumerCoordinator)
8165 [2024-12-10 04:44:37,228] DEBUG [Consumer clientId=consumer-test_group_id-1, groupId=test_group_id] Sending JoinGroup (JoinGroupRequestData(groupId=&lt;span class=&quot;code-quote&quot;&gt;&apos;test_group_id&apos;&lt;/span&gt;, sessionTimeoutMs=30000, rebalanceTimeoutMs=300000, memberId=&lt;span class=&quot;code-quote&quot;&gt;&apos;consumer-test_ &#160; &#160; group_id-1-61dfefb9-acdd-4050-ba0a-56f5d5ed1c3d&apos;&lt;/span&gt;, groupInstanceId=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, protocolType=&lt;span class=&quot;code-quote&quot;&gt;&apos;consumer&apos;&lt;/span&gt;, protocols=[JoinGroupRequestProtocol(name=&lt;span class=&quot;code-quote&quot;&gt;&apos;range&apos;&lt;/span&gt;, metadata=[0, 3, 0, 0, 0, 1, 0, 10, 116, 101, 115, 116, 95, 116, 111, 112, 105, 99, -1, -1, -1 &#160; &#160; , -1, 0, 0, 0, 0, 0, 0, 0, 7, -1, -1])], reason=&lt;span class=&quot;code-quote&quot;&gt;&apos;cached metadata has changed&apos;&lt;/span&gt;)) to coordinator ducker03:9092 (id: 2147483646 rack: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) (org.apache.kafka.clients.consumer.internals.ConsumerCoordinator)
8166 [2024-12-10 04:44:37,228] DEBUG [Consumer clientId=consumer-test_group_id-1, groupId=test_group_id] Sending JOIN_GROUP request with header RequestHeader(apiKey=JOIN_GROUP, apiVersion=9, clientId=consumer-test_group_id-1, correlationId=123, &#160; &#160; &#160;headerVersion=2) and timeout 305000 to node 2147483646: JoinGroupRequestData(groupId=&lt;span class=&quot;code-quote&quot;&gt;&apos;test_group_id&apos;&lt;/span&gt;, sessionTimeoutMs=30000, rebalanceTimeoutMs=300000, memberId=&lt;span class=&quot;code-quote&quot;&gt;&apos;consumer-test_group_id-1-61dfefb9-acdd-4050-ba0a-56f5d5ed1c3d&apos;&lt;/span&gt;, groupInstance &#160; &#160; Id=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, protocolType=&lt;span class=&quot;code-quote&quot;&gt;&apos;consumer&apos;&lt;/span&gt;, protocols=[JoinGroupRequestProtocol(name=&lt;span class=&quot;code-quote&quot;&gt;&apos;range&apos;&lt;/span&gt;, metadata=[0, 3, 0, 0, 0, 1, 0, 10, 116, 101, 115, 116, 95, 116, 111, 112, 105, 99, -1, -1, -1, -1, 0, 0, 0, 0, 0, 0, 0, 7, -1, -1])], reason=&lt;span class=&quot;code-quote&quot;&gt;&apos;cached metadat &#160; &#160; a has changed&apos;&lt;/span&gt;) (org.apache.kafka.clients.NetworkClient)

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;ol&gt;
	&lt;li&gt;&#160;Please reproduce this running&#160;&lt;/li&gt;
&lt;/ol&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
TC_PATHS=&lt;span class=&quot;code-quote&quot;&gt;&quot;tests/kafkatest/tests/client/consumer_test.py::OffsetValidationTest.test_broker_failure&quot;&lt;/span&gt; bash tests/docker/run_tests.sh &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13601485">KAFKA-18194</key>
            <summary>Flaky test_broker_rolling_bounce due to metadata update</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="m1a2st">&#40643;&#31459;&#38525;</assignee>
                                    <reporter username="pnee">Philip Nee</reporter>
                        <labels>
                            <label>system-test-failure</label>
                            <label>system-tests</label>
                    </labels>
                <created>Tue, 10 Dec 2024 06:01:57 +0000</created>
                <updated>Thu, 12 Dec 2024 23:33:11 +0000</updated>
                            <resolved>Thu, 12 Dec 2024 23:33:11 +0000</resolved>
                                                    <fixVersion>4.0.0</fixVersion>
                                    <component>clients</component>
                    <component>consumer</component>
                    <component>system tests</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="17904581" author="rsivaram" created="Tue, 10 Dec 2024 16:58:51 +0000"  >&lt;p&gt;Looked at the logs of a failed run. The test has a cluster with only two brokers. And the brokers are bounced one after another. When the first broker is bounced, consumer gets metadata that contains only the second broker. So when the second broker is bounced and the client cannot connect to it, rebootstrap is triggered. KIP-899 rebootstrap is performed when there are no available brokers in the current metadata. We made this the default in 4.0 under KIP-1102. The main reason we hit this in the test is because the test uses only two brokers and hence results in no available brokers (unlikely condition in a production cluster). It will be best to disable rebootstrapping in this test using `metadata.recovery.strategy=none` for the consumer, since the test specifically expects no metadata change.&lt;/p&gt;</comment>
                            <comment id="17904787" author="chia7712" created="Wed, 11 Dec 2024 12:53:34 +0000"  >&lt;p&gt;I did not notice this jira when creating &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-18212&quot; title=&quot;Rolling-upgrade broker causes unnecessary re-balance on classic consumer&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-18212&quot;&gt;&lt;del&gt;KAFKA-18212&lt;/del&gt;&lt;/a&gt;. &lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;It will be best to disable rebootstrapping in this test using `metadata.recovery.strategy=none` for the consumer, since the test specifically expects no metadata change.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rsivaram&quot; class=&quot;user-hover&quot; rel=&quot;rsivaram&quot;&gt;rsivaram&lt;/a&gt; I propose another solution in &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-18212&quot; title=&quot;Rolling-upgrade broker causes unnecessary re-balance on classic consumer&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-18212&quot;&gt;&lt;del&gt;KAFKA-18212&lt;/del&gt;&lt;/a&gt;. Do you have free cycle to take a look?&lt;/p&gt;</comment>
                            <comment id="17904912" author="chia7712" created="Wed, 11 Dec 2024 20:42:37 +0000"  >&lt;blockquote&gt;
&lt;p&gt;It will be best to disable rebootstrapping in this test using `metadata.recovery.strategy=none` for the consumer, since the test specifically expects no metadata change.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;+1 to this approach. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnee&quot; class=&quot;user-hover&quot; rel=&quot;pnee&quot;&gt;pnee&lt;/a&gt;, do you have the availability to file a PR? If not, I&apos;d like to take over to stabilize the end-to-end (e2e) tests as soon as possible.&lt;/p&gt;</comment>
                            <comment id="17904924" author="JIRAUSER283568" created="Wed, 11 Dec 2024 20:58:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chia7712&quot; class=&quot;user-hover&quot; rel=&quot;chia7712&quot;&gt;chia7712&lt;/a&gt; - this is a simple fix, so go ahead.&#160;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13601686">KAFKA-18212</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            47 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1t0lc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>