<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:58:11 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-4451] Recovering empty replica yields negative offsets in index of compact partitions</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-4451</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Bringing up an empty broker.  &lt;/p&gt;

&lt;p&gt;the partition for a compact topic is not split into multiple log files.  All data is written into a single log file, causing offsets to overflow.&lt;/p&gt;

&lt;p&gt;A dump of the affected broker shortly after it started replicating:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;michael.schiff@stats-kafka09:~$ sudo /opt/kafka/bin/kafka-run-&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;sh kafka.tools.DumpLogSegments --files /kafka/attainment_event-0/00000000000000000000.index | head -n 10
Dumping /kafka/attainment_event-0/00000000000000000000.index
offset: 1022071124 position: 1037612
offset: -1713432120 position: 1348740
offset: -886291423 position: 2397130
offset: -644750126 position: 3445630
offset: -57889876 position: 4493972
offset: 433950099 position: 5388461
offset: 1071769472 position: 6436837
offset: 1746859069 position: 7485367
offset: 2090359736 position: 8533822
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;and the dump of the same log file from the leader of this partition&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;michael.schiff@stats-kafka12:~$ sudo /opt/kafka/bin/kafka-run-&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;sh kafka.tools.DumpLogSegments --files /kafka/attainment_event-0/00000000000000000000.index
[sudo] password &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; michael.schiff:
Dumping /kafka/attainment_event-0/00000000000000000000.index
offset: 353690666 position: 262054
offset: 633140428 position: 523785
offset: 756537951 position: 785815
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13023614">KAFKA-4451</key>
            <summary>Recovering empty replica yields negative offsets in index of compact partitions</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="michael.schiff">Michael Schiff</reporter>
                        <labels>
                            <label>reliability</label>
                    </labels>
                <created>Mon, 28 Nov 2016 01:20:44 +0000</created>
                <updated>Thu, 15 Dec 2016 23:47:18 +0000</updated>
                            <resolved>Thu, 15 Dec 2016 23:46:46 +0000</resolved>
                                    <version>0.9.0.1</version>
                                    <fixVersion>0.10.2.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15700688" author="michael.schiff" created="Mon, 28 Nov 2016 02:07:21 +0000"  >&lt;p&gt;After some further exploration:&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;ReplicaFetcherThread.scala:131&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;      replica.log.get.append(messageSet, assignOffsets = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;Log.scala:405&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        &lt;span class=&quot;code-comment&quot;&gt;// maybe roll the log &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; segment is full
&lt;/span&gt;        val segment = maybeRoll(messagesSize = validMessages.sizeInBytes,
                                maxTimestampInMessages = appendInfo.maxTimestamp)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;maybeRoll depends on AbtractIndex.isFulll&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;AbstractIndex.scala:75&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  /**
   * The maximum number of entries &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; index can hold
   */
  @&lt;span class=&quot;code-keyword&quot;&gt;volatile&lt;/span&gt;
  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt;[&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;] &lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; _maxEntries = mmap.limit / entrySize

  &lt;span class=&quot;code-comment&quot;&gt;/** The number of entries in &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; index */&lt;/span&gt;
  @&lt;span class=&quot;code-keyword&quot;&gt;volatile&lt;/span&gt;
  &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; _entries = mmap.position / entrySize

  /**
   * True iff there are no more slots available in &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; index
   */
  def isFull: &lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt; = _entries &amp;gt;= _maxEntries
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It appears the logic for whether or not to roll the segment depends on the absolute number of messages in the index and not the range of offsets stored in the index.  This allows the index to be overflown in the case of a heavily compacted topic.&lt;/p&gt;

&lt;p&gt;Protective logic for the same issue is present in LogCleaner.groupSegmentsBySize&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;LogCleaner.scala:546&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  /**
   * Group the segments in a log into groups totaling less than a given size. the size is enforced separately &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the log data and the index data.
   * We collect a group of such segments together into a single
   * destination segment. This prevents segment sizes from shrinking too much.
   *
   * @param segments The log segments to group
   * @param maxSize the maximum size in bytes &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the total of all log data in a group
   * @param maxIndexSize the maximum size in bytes &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the total of all index data in a group
   *
   * @&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; A list of grouped segments
   */
  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt;[log] def groupSegmentsBySize(segments: Iterable[LogSegment], maxSize: Int, maxIndexSize: Int): List[Seq[LogSegment]] = {
    &lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; grouped = List[List[LogSegment]]()
    &lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; segs = segments.toList
    &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt;(segs.nonEmpty) {
      &lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; group = List(segs.head)
      &lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; logSize = segs.head.size
      &lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; indexSize = segs.head.index.sizeInBytes
      &lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; timeIndexSize = segs.head.timeIndex.sizeInBytes
      segs = segs.tail
      &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt;(segs.nonEmpty &amp;amp;&amp;amp;
            logSize + segs.head.size &amp;lt;= maxSize &amp;amp;&amp;amp;
            indexSize + segs.head.index.sizeInBytes &amp;lt;= maxIndexSize &amp;amp;&amp;amp;
            timeIndexSize + segs.head.timeIndex.sizeInBytes &amp;lt;= maxIndexSize &amp;amp;&amp;amp;
            segs.head.index.lastOffset - group.last.index.baseOffset &amp;lt;= Int.MaxValue) {
        group = segs.head :: group
        logSize += segs.head.size
        indexSize += segs.head.index.sizeInBytes
        timeIndexSize += segs.head.timeIndex.sizeInBytes
        segs = segs.tail
      }
      grouped ::= group.reverse
    }
    grouped.reverse
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;specifically:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;LogCleaner.scala:559&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;            segs.head.index.lastOffset - group.last.index.baseOffset &amp;lt;= Int.MaxValue) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15720715" author="githubbot" created="Sun, 4 Dec 2016 22:29:18 +0000"  >&lt;p&gt;GitHub user michaelschiff opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/2210&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2210&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-4451&quot; title=&quot;Recovering empty replica yields negative offsets in index of compact partitions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-4451&quot;&gt;&lt;del&gt;KAFKA-4451&lt;/del&gt;&lt;/a&gt; &lt;/p&gt;

&lt;p&gt;    Fix OffsetIndex overflow when replicating a highly compacted topic.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/michaelschiff/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/michaelschiff/kafka&lt;/a&gt; bug/4451&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/2210.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2210.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #2210&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit d31ae87e47be6c00aca898c05fa5cf993ff127cc&lt;br/&gt;
Author: Michael Schiff &amp;lt;schiff.michael@gmail.com&amp;gt;&lt;br/&gt;
Date:   2016-12-04T22:26:07Z&lt;/p&gt;

&lt;p&gt;    Adds a unit test case to LogTest that currently fails due to the&lt;br/&gt;
    presence of &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-4451&quot; title=&quot;Recovering empty replica yields negative offsets in index of compact partitions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-4451&quot;&gt;&lt;del&gt;KAFKA-4451&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15752876" author="junrao" created="Thu, 15 Dec 2016 23:46:46 +0000"  >&lt;p&gt;Issue resolved by pull request 2210&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/kafka/pull/2210&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2210&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15752877" author="githubbot" created="Thu, 15 Dec 2016 23:47:18 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/2210&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2210&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12946416">KAFKA-3323</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 48 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i36tnz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>