<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:40:56 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-17632] Custom `partitioner.class` with an even number of partitions always writes to even partitions if use RoundRobinPartitioner</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-17632</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Our project has some special logic that requires custom partitions.&lt;br/&gt;
With an odd number of Partitions, everything works fine and well.&lt;br/&gt;
However, with an even number of partitions. Data will only be written to even-numbered Partition IDs&lt;/p&gt;

&lt;p&gt;Info:&lt;br/&gt;
Lib Java: `kafka-clients:3.8.0`&lt;br/&gt;
Code demo:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;CustomLogicPartitionMain {
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void main(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] args) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
        &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.setProperty(&lt;span class=&quot;code-quote&quot;&gt;&quot;org.slf4j.simpleLogger.defaultLogLevel&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;ALL&quot;&lt;/span&gt;);
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; props = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Properties();
        props.setProperty(ProducerConfig.CLIENT_ID_CONFIG, &lt;span class=&quot;code-quote&quot;&gt;&quot;java-producer-producerRecordPartition-KeyNotNull&quot;&lt;/span&gt;);
        props.setProperty(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, &lt;span class=&quot;code-quote&quot;&gt;&quot;localhost:29091,localhost:29092,localhost:29093,localhost:29094&quot;&lt;/span&gt;);
        props.setProperty(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, StringSerializer.&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;getName());
        props.setProperty(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, StringSerializer.&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;getName());
        props.setProperty(ProducerConfig.BATCH_SIZE_CONFIG, &lt;span class=&quot;code-quote&quot;&gt;&quot;5000&quot;&lt;/span&gt;);
        props.setProperty(ProducerConfig.PARTITIONER_CLASS_CONFIG, &lt;span class=&quot;code-quote&quot;&gt;&quot;org.apache.kafka.clients.producer.RoundRobinPartitioner&quot;&lt;/span&gt;);

        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; producer = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; KafkaProducer&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt;(props)) {
            &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; messageProducerRecord = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ProducerRecord&amp;lt;&amp;gt;(
                    &lt;span class=&quot;code-quote&quot;&gt;&quot;topic-rep-1-partition-10&quot;&lt;/span&gt;,     &lt;span class=&quot;code-comment&quot;&gt;//topic name
&lt;/span&gt;                    &lt;span class=&quot;code-comment&quot;&gt;// 36 &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;
&lt;/span&gt;                    UUID.randomUUID().toString()        &lt;span class=&quot;code-comment&quot;&gt;// value
&lt;/span&gt;            );
            &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 1; i &amp;lt;= 5000; i++) {
                producer.send(messageProducerRecord);
            }
        }
    }
}
 &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13071831/13071831_image-2024-09-27-15-05-53-707.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;br/&gt;
&#160;&lt;br/&gt;
&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13593475">KAFKA-17632</key>
            <summary>Custom `partitioner.class` with an even number of partitions always writes to even partitions if use RoundRobinPartitioner</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="durban">Daniel Urban</assignee>
                                    <reporter username="thanhlv">thanhlv</reporter>
                        <labels>
                    </labels>
                <created>Fri, 27 Sep 2024 08:07:50 +0000</created>
                <updated>Mon, 18 Aug 2025 23:11:41 +0000</updated>
                            <resolved>Thu, 14 Nov 2024 08:24:08 +0000</resolved>
                                    <version>3.8.0</version>
                                    <fixVersion>3.9.2</fixVersion>
                    <fixVersion>4.0.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17893559" author="durban" created="Mon, 28 Oct 2024 17:54:52 +0000"  >&lt;p&gt;Thank you for the report and the repro code.&lt;/p&gt;

&lt;p&gt;I&apos;m unsure if this ever worked correctly, but in the current code, KafkaProducer calls partitioner.partition twice on new batches, this is the location of the 2nd call:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/kafka/blob/14a9130f6fa31c10cb65cc500c101148d0410306/clients/src/main/java/org/apache/kafka/clients/producer/KafkaProducer.java#L1079&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/14a9130f6fa31c10cb65cc500c101148d0410306/clients/src/main/java/org/apache/kafka/clients/producer/KafkaProducer.java#L1079&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Because of this, when you have an even number of partitions, you are basically &quot;locked out&quot; of half of your partitions when using RR.&lt;/p&gt;

&lt;p&gt;RoundRobinPartitioner was implemented without taking the semantics of the onNewBatch method into account. I&apos;ll try to submit a fix for this - basically the onNewBatch can be handled as a &quot;do not increment on the next call of partition&quot; notification.&lt;/p&gt;

&lt;p&gt;I think the only way to fix your custom partitioner implementation is to introduce similar logic in the onNewBatch callback. Since onNewBatch is deprecated, it will be removed in the future, and that will probably fix the logic in KafkaProducer. Due to backward compatibility, and other partitioner implementations relying on this double-call, I think we cannot really change the producer logic.&lt;/p&gt;</comment>
                            <comment id="17898182" author="durban" created="Thu, 14 Nov 2024 08:24:08 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thanhlv&quot; class=&quot;user-hover&quot; rel=&quot;thanhlv&quot;&gt;thanhlv&lt;/a&gt; The RR partitioner has been fixed, and the interface got a small doc update. The change might give a hint on how to fix your custom implementation.&lt;/p&gt;</comment>
                            <comment id="17898304" author="JIRAUSER307174" created="Thu, 14 Nov 2024 14:35:08 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=durban&quot; class=&quot;user-hover&quot; rel=&quot;durban&quot;&gt;durban&lt;/a&gt; , I will check it after release v4.0.0&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13071831" name="image-2024-09-27-15-05-53-707.png" size="44158" author="thanhlv" created="Fri, 27 Sep 2024 08:05:52 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            51 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1rniw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>