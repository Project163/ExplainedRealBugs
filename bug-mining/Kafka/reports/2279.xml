<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:18:43 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-7703] KafkaConsumer.position may return a wrong offset after &quot;seekToEnd&quot; is called</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-7703</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;After &quot;seekToEnd&quot; is called, &quot;KafkaConsumer.position&quot; may return a wrong offset set by another reset request.&lt;/p&gt;

&lt;p&gt;Here is a reproducer: &lt;a href=&quot;https://github.com/zsxwing/kafka/commit/4e1aa11bfa99a38ac1e2cb0872c055db56b33246&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/zsxwing/kafka/commit/4e1aa11bfa99a38ac1e2cb0872c055db56b33246&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;In this reproducer, &quot;poll(0)&quot; will send an &quot;earliest&quot; request in background. However, after &quot;seekToEnd&quot; is called, due to a race condition in &quot;Fetcher.resetOffsetIfNeeded&quot; (It&apos;s not atomic, &quot;seekToEnd&quot; could happen between the check &lt;a href=&quot;https://github.com/zsxwing/kafka/commit/4e1aa11bfa99a38ac1e2cb0872c055db56b33246#diff-b45245913eaae46aa847d2615d62cde0R585&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/zsxwing/kafka/commit/4e1aa11bfa99a38ac1e2cb0872c055db56b33246#diff-b45245913eaae46aa847d2615d62cde0R585&lt;/a&gt; and the seek &lt;a href=&quot;https://github.com/zsxwing/kafka/commit/4e1aa11bfa99a38ac1e2cb0872c055db56b33246#diff-b45245913eaae46aa847d2615d62cde0R605&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/zsxwing/kafka/commit/4e1aa11bfa99a38ac1e2cb0872c055db56b33246#diff-b45245913eaae46aa847d2615d62cde0R605&lt;/a&gt;), &quot;KafkaConsumer.position&quot; may return an &quot;earliest&quot; offset.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13202134">KAFKA-7703</key>
            <summary>KafkaConsumer.position may return a wrong offset after &quot;seekToEnd&quot; is called</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="viktorsomogyi">Viktor Somogyi-Vass</assignee>
                                    <reporter username="zsxwing">Shixiong Zhu</reporter>
                        <labels>
                    </labels>
                <created>Mon, 3 Dec 2018 23:44:05 +0000</created>
                <updated>Wed, 24 Jun 2020 06:15:29 +0000</updated>
                            <resolved>Thu, 30 May 2019 16:01:24 +0000</resolved>
                                    <version>2.3.0</version>
                                    <fixVersion>2.3.0</fixVersion>
                                    <component>clients</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="16708272" author="zsxwing" created="Tue, 4 Dec 2018 06:51:39 +0000"  >&lt;p&gt;This seems introduced by &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6397&quot; title=&quot;Consumer should not block setting initial positions of unavailable partitions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-6397&quot;&gt;&lt;del&gt;KAFKA-6397&lt;/del&gt;&lt;/a&gt; which moved the offset updating codes to a different thread.&lt;/p&gt;</comment>
                            <comment id="16708297" author="zsxwing" created="Tue, 4 Dec 2018 07:25:06 +0000"  >&lt;p&gt;I also noticed that TopicPartitionState is modified by multiple threads without any protection.&lt;/p&gt;</comment>
                            <comment id="16710012" author="viktorsomogyi" created="Wed, 5 Dec 2018 12:33:51 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zsxwing&quot; class=&quot;user-hover&quot; rel=&quot;zsxwing&quot;&gt;zsxwing&lt;/a&gt; I&apos;ll pick this up if you don&apos;t mind and look into it.&lt;/p&gt;</comment>
                            <comment id="16711191" author="zsxwing" created="Thu, 6 Dec 2018 09:27:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=viktorsomogyi&quot; class=&quot;user-hover&quot; rel=&quot;viktorsomogyi&quot;&gt;viktorsomogyi&lt;/a&gt; Cool! Thanks! Let me know if you need more information about the issue.&lt;/p&gt;</comment>
                            <comment id="16715004" author="viktorsomogyi" created="Mon, 10 Dec 2018 16:13:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zsxwing&quot; class=&quot;user-hover&quot; rel=&quot;zsxwing&quot;&gt;zsxwing&lt;/a&gt;,&#160;I just wanted to send a quick update that I have looked at the code and reproduced it based on your test and now I&apos;m trying to figure out what&apos;s the best solution for this. I&apos;ll write an update once again when I have some solution proposal.&lt;/p&gt;</comment>
                            <comment id="16722591" author="dongjoon" created="Sun, 16 Dec 2018 22:07:18 +0000"  >&lt;p&gt;Hi, All.&lt;br/&gt;
Is there any update for this issue?&lt;/p&gt;</comment>
                            <comment id="16723156" author="viktorsomogyi" created="Mon, 17 Dec 2018 16:53:10 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zsxwing&quot; class=&quot;user-hover&quot; rel=&quot;zsxwing&quot;&gt;zsxwing&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dongjoon&quot; class=&quot;user-hover&quot; rel=&quot;dongjoon&quot;&gt;dongjoon&lt;/a&gt;, I&apos;ve looked into the issue and it seems there is no easy fix for this in the code as it designed to be async, so it might take some time. Even if we make the method atomic the offset reset that arrives later will be discarded as the first reset nulls out the resetStrategy in SubscriptionState which triggers the &lt;tt&gt;else if (!subscriptions.isOffsetResetNeeded(partition)&lt;/tt&gt; &lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/clients/src/main/java/org/apache/kafka/clients/consumer/internals/Fetcher.java#L579&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;check&lt;/a&gt; to skip the offset reset.&lt;/p&gt;

&lt;p&gt;In the current situation as a workaround you could put a &lt;tt&gt;position&lt;/tt&gt; call between &lt;tt&gt;poll&lt;/tt&gt; and &lt;tt&gt;seekToEnd&lt;/tt&gt; as it blocks until &lt;tt&gt;poll&lt;/tt&gt; returns or some error happens.&lt;/p&gt;</comment>
                            <comment id="16723159" author="viktorsomogyi" created="Mon, 17 Dec 2018 16:55:11 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rsivaram&quot; class=&quot;user-hover&quot; rel=&quot;rsivaram&quot;&gt;rsivaram&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hachikuji&quot; class=&quot;user-hover&quot; rel=&quot;hachikuji&quot;&gt;hachikuji&lt;/a&gt; I see you modified that part of the code lately, what is your take on this?&lt;/p&gt;</comment>
                            <comment id="16784366" author="nikita.glashenko" created="Tue, 5 Mar 2019 12:19:53 +0000"  >&lt;p&gt;We stumbled upon this bug in production.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=viktorsomogyi&quot; class=&quot;user-hover&quot; rel=&quot;viktorsomogyi&quot;&gt;viktorsomogyi&lt;/a&gt;, are you still working on this issue?&lt;/p&gt;

&lt;p&gt;If not, I can try to continue working on it.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16785739" author="viktorsomogyi" created="Wed, 6 Mar 2019 15:22:48 +0000"  >&lt;p&gt;Hey &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nikita.glashenko&quot; class=&quot;user-hover&quot; rel=&quot;nikita.glashenko&quot;&gt;nikita.glashenko&lt;/a&gt;, thanks for bumping this issue. I have a solution just need a day or two to polish it and create a PR. I&apos;ll let you know so you and folks on this issue and you can join the code review. Does that work for you?&lt;/p&gt;</comment>
                            <comment id="16785784" author="nikita.glashenko" created="Wed, 6 Mar 2019 15:51:57 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=viktorsomogyi&quot; class=&quot;user-hover&quot; rel=&quot;viktorsomogyi&quot;&gt;viktorsomogyi&lt;/a&gt;, yes, thank you.&lt;/p&gt;</comment>
                            <comment id="16788096" author="githubbot" created="Fri, 8 Mar 2019 17:27:32 +0000"  >&lt;p&gt;viktorsomogyi commented on pull request #6407: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7703&quot; title=&quot;KafkaConsumer.position may return a wrong offset after &amp;quot;seekToEnd&amp;quot; is called&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7703&quot;&gt;&lt;del&gt;KAFKA-7703&lt;/del&gt;&lt;/a&gt;: position() may return a wrong offset after seekToEnd&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/6407&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/6407&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   When poll is called which resets the offsets to the beginning, followed by a seekToEnd and a position, it could happen that the &quot;reset to earliest&quot; call in poll overrides the &quot;reset to latest&quot; initiated by seekToEnd in a very delicate way: &lt;br/&gt;
   1. both request has been issued and returned to the client side (listOffsetResponse has happened)&lt;br/&gt;
   2. in Fetcher.resetOffsetIfNeeded(TopicPartition, Long, OffsetData) the thread scheduler could prefer the heartbeat thread with the &quot;reset to earliest&quot; call, overriding the offset to the earliest and setting the SubscriptionState with that position.&lt;br/&gt;
   3. The thread scheduler continues execution of the thread (application thread) with the &quot;reset to latest&quot; call and discards it as the &quot;reset to earliest&quot; already set the position - the wrong one.&lt;br/&gt;
   4. The blocking position call returns with the earliest offset instead of the latest, despite it wasn&apos;t expected.&lt;/p&gt;

&lt;p&gt;   The fix makes the TopicPartitionState in SubscriptionState synchronized and starts to track the requested reset timestamp. With this we can precisely decide if the incoming offset reset is really what we want. Therefore the latest initiated offset reset will happen only. Synchronization furthermore ensures that this is done in an atomic manner to avoid further similar bugs.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16851374" author="githubbot" created="Wed, 29 May 2019 22:59:16 +0000"  >&lt;p&gt;hachikuji commented on pull request #6407: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7703&quot; title=&quot;KafkaConsumer.position may return a wrong offset after &amp;quot;seekToEnd&amp;quot; is called&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7703&quot;&gt;&lt;del&gt;KAFKA-7703&lt;/del&gt;&lt;/a&gt;: position() may return a wrong offset after seekToEnd&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/6407&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/6407&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13202353">SPARK-26267</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13223976">SPARK-27281</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 24 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|s014nk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>