<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:26:10 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-10723] LogManager leaks internal thread pool activity during shutdown</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-10723</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;&lt;b&gt;TL;DR:&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;The asynchronous shutdown in &lt;tt&gt;LogManager&lt;/tt&gt; has the shortcoming that if during shutdown any of the internal futures fail, then we do not always ensure that all futures are completed before &lt;tt&gt;LogManager.shutdown&lt;/tt&gt; returns. As a result, despite the shut down completed message from KafkaServer&#160;is seen in the error logs, some futures continue to run from inside LogManager&#160;attempting to close the logs. This is misleading and it could possibly break the general rule of avoiding post-shutdown activity in the Broker.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Description:&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;When LogManager is shutting down, exceptions in log closure are handled &lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/core/src/main/scala/kafka/log/LogManager.scala#L497-L501&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. However, this &lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/core/src/main/scala/kafka/log/LogManager.scala#L502&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;line&lt;/a&gt;&#160;in the finally clause shuts down the thread pools&#160;&lt;b&gt;asynchronously&lt;/b&gt;. The code: &lt;em&gt;threadPools.foreach(.shutdown())&lt;/em&gt;&#160;initiates an orderly shutdown (for each thread pool) in which previously submitted tasks are executed, but no new tasks will be accepted (see javadoc link &lt;a href=&quot;https://docs.oracle.com/javase/7/docs/api/java/util/concurrent/ExecutorService.html#shutdown()&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;)&lt;em&gt;.&lt;/em&gt; As a result, if there is an exception during log closure,&#160;some of the thread pools which are closing logs could be leaked and continue to run in the background, after the control returns to the caller (i.e. &lt;tt&gt;KafkaServer&lt;/tt&gt;).&#160;As a result, even after the &quot;shut down completed&quot; message is seen in the error logs (originating from &lt;tt&gt;KafkaServer&lt;/tt&gt; shutdown sequence), log closures continue to happen in the background, which is misleading.&lt;br/&gt;
 &#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Proposed options for fixes:&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;It seems useful that we maintain the contract with &lt;tt&gt;KafkaServer&lt;/tt&gt; that after &lt;tt&gt;LogManager.shutdown&lt;/tt&gt; is called once, all tasks that close the logs are guaranteed to have completed before the call returns.&#160;There are probably couple different ways to fix this:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Replace &lt;tt&gt;&lt;em&gt;threadPools.foreach(.shutdown())&lt;/em&gt; with &lt;em&gt;threadPools.foreach(.awaitTermination())&lt;/em&gt;&lt;/tt&gt;&lt;tt&gt;.&lt;/tt&gt; This ensures that we wait for all threads to be shutdown before returning the &lt;tt&gt;&lt;em&gt;LogManager.shutdown&lt;/em&gt;&lt;/tt&gt;&#160;call.&lt;/li&gt;
	&lt;li&gt;Skip creating of checkpoint and clean shutdown file only for the affected directory if any of its futures throw an error. We continue to wait for all futures to complete for all directories. This can require some changes to &lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/core/src/main/scala/kafka/log/LogManager.scala#L481-L496&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this for loop&lt;/a&gt;, so that we wait for all futures to complete regardless of whether one of them threw an error.&lt;/li&gt;
&lt;/ol&gt;
</description>
                <environment></environment>
        <key id="13340608">KAFKA-10723</key>
            <summary>LogManager leaks internal thread pool activity during shutdown</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kprakasam">Kowshik Prakasam</assignee>
                                    <reporter username="kprakasam">Kowshik Prakasam</reporter>
                        <labels>
                    </labels>
                <created>Fri, 13 Nov 2020 23:53:20 +0000</created>
                <updated>Thu, 19 Nov 2020 18:55:00 +0000</updated>
                            <resolved>Thu, 19 Nov 2020 18:55:00 +0000</resolved>
                                                    <fixVersion>2.8.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17235660" author="junrao" created="Thu, 19 Nov 2020 18:55:00 +0000"  >&lt;p&gt;merged to trunk&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 51 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0kl60:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>