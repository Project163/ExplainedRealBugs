<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:52:55 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-3147] Memory records is not writable in MirrorMaker</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-3147</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Hi,&lt;br/&gt;
We are running a 3 node cluster (kafka version 0.9) and Node 0 also has a few mirror makers running. &lt;br/&gt;
When we do a rolling restart of the cluster, the mirror maker shuts down with the following errors.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;2016-01-11 20:16:00,348&amp;#93;&lt;/span&gt; WARN Got error produce response with correlation id 12491674 on topic-partition test-99, retrying (2147483646 attempts left). Error: NOT_LEADER_FOR_PARTITION (org.apache.kafka.clients.producer.internals.Sender)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2016-01-11 20:16:00,853&amp;#93;&lt;/span&gt; FATAL &lt;span class=&quot;error&quot;&gt;&amp;#91;mirrormaker-thread-0&amp;#93;&lt;/span&gt; Mirror maker thread failure due to  (kafka.tools.MirrorMaker$MirrorMakerThread)&lt;br/&gt;
java.lang.IllegalStateException: Memory records is not writable&lt;br/&gt;
        at org.apache.kafka.common.record.MemoryRecords.append(MemoryRecords.java:93)&lt;br/&gt;
        at org.apache.kafka.clients.producer.internals.RecordBatch.tryAppend(RecordBatch.java:69)&lt;br/&gt;
        at org.apache.kafka.clients.producer.internals.RecordAccumulator.append(RecordAccumulator.java:168)&lt;br/&gt;
        at org.apache.kafka.clients.producer.KafkaProducer.send(KafkaProducer.java:435)&lt;br/&gt;
        at kafka.tools.MirrorMaker$MirrorMakerProducer.send(MirrorMaker.scala:593)&lt;br/&gt;
        at kafka.tools.MirrorMaker$MirrorMakerThread$$anonfun$run$3.apply(MirrorMaker.scala:398)&lt;br/&gt;
        at kafka.tools.MirrorMaker$MirrorMakerThread$$anonfun$run$3.apply(MirrorMaker.scala:398)&lt;br/&gt;
        at scala.collection.Iterator$class.foreach(Iterator.scala:742)&lt;br/&gt;
        at scala.collection.AbstractIterator.foreach(Iterator.scala:1194)&lt;br/&gt;
        at scala.collection.IterableLike$class.foreach(IterableLike.scala:72)&lt;br/&gt;
        at scala.collection.AbstractIterable.foreach(Iterable.scala:54)&lt;br/&gt;
        at kafka.tools.MirrorMaker$MirrorMakerThread.run(MirrorMaker.scala:398)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2016-01-11 20:16:01,072&amp;#93;&lt;/span&gt; WARN Got error produce response with correlation id 12491679 on topic-partition test-75, retrying (2147483646 attempts left). Error: NETWORK_EXCEPTION (org.apache.kafka.clients.producer.internals.Sender)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2016-01-11 20:16:01,073&amp;#93;&lt;/span&gt; WARN Got error produce response with correlation id 12491679 on topic-partition test-93, retrying (2147483646 attempts left). Error: NETWORK_EXCEPTION (org.apache.kafka.clients.producer.internals.Sender)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2016-01-11 20:16:01,073&amp;#93;&lt;/span&gt; WARN Got error produce response with correlation id 12491679 on topic-partition test-24, retrying (2147483646 attempts left). Error: NETWORK_EXCEPTION (org.apache.kafka.clients.producer.internals.Sender)&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;2016-01-11 20:16:20,479&amp;#93;&lt;/span&gt; FATAL &lt;span class=&quot;error&quot;&gt;&amp;#91;mirrormaker-thread-0&amp;#93;&lt;/span&gt; Mirror maker thread exited abnormally, stopping the whole mirror maker. (kafka.tools.MirrorMaker$MirrorMakerThread)&lt;/p&gt;

&lt;p&gt;Curious if the NOT_LEADER_FOR_PARTITION is because of a potential bug hinted at in the thread , &lt;a href=&quot;http://mail-archives.apache.org/mod_mbox/kafka-users/201505.mbox/%3CCAJS3ho_u8s1Xou_kudNfjAMyPJtMrjLW10QVkNGn2YQkdan0+A@mail.gmail.com%3E&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://mail-archives.apache.org/mod_mbox/kafka-users/201505.mbox/%3CCAJS3ho_u8s1Xou_kudNfjAMyPJtMrjLW10QVkNGn2YQkdan0+A@mail.gmail.com%3E&lt;/a&gt;   &lt;/p&gt;

&lt;p&gt;And I think the mirror maker shuts down because of the &quot;abort.on.send.failure&quot; which is set to true in our case. &lt;/p&gt;</description>
                <environment></environment>
        <key id="12933930">KAFKA-3147</key>
            <summary>Memory records is not writable in MirrorMaker</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mgharat">Mayuresh Gharat</assignee>
                                    <reporter username="megnarasimhan">Meghana Narasimhan</reporter>
                        <labels>
                    </labels>
                <created>Mon, 25 Jan 2016 20:27:27 +0000</created>
                <updated>Wed, 4 May 2016 09:38:56 +0000</updated>
                            <resolved>Wed, 4 May 2016 09:38:56 +0000</resolved>
                                    <version>0.9.0.0</version>
                                    <fixVersion>0.10.0.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>12</watches>
                                                                                                                <comments>
                            <comment id="15118362" author="junrao" created="Wed, 27 Jan 2016 00:47:02 +0000"  >&lt;p&gt;I think the issue could be related to &quot;abort.on.send.failure&quot;. There is a code path where the above error can be hit.&lt;/p&gt;

&lt;p&gt;In MirrorMaker, if abortOnSendFailure is enabled, we will call producer.close(0) on send failure. This will call sender.forceClose(), which first sets this.forceClose = true, followed by accumulator.close(). Suppose that the sender wakes up after this.forceClose = true but before accumulator.close(). The sender will call this.accumulator.abortIncompleteBatches(), which eventually closes all batch records in the queue w/o actually dequeuing them. At this moment, if the client sends another record to the producer, it can hit the exception described in the jira.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mgharat&quot; class=&quot;user-hover&quot; rel=&quot;mgharat&quot;&gt;mgharat&lt;/a&gt;, this may be introduced in the request timeout patch. Could you take a look and see if the above scenario is possible? Thanks.&lt;/p&gt;
</comment>
                            <comment id="15118482" author="mgharat" created="Wed, 27 Jan 2016 02:20:39 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=junrao&quot; class=&quot;user-hover&quot; rel=&quot;junrao&quot;&gt;junrao&lt;/a&gt; I think abortIncompleteBatches was not a part of KIP-19 patch. I will surely like to look in to this though.  &lt;/p&gt;</comment>
                            <comment id="15120004" author="becket_qin" created="Wed, 27 Jan 2016 19:23:44 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=junrao&quot; class=&quot;user-hover&quot; rel=&quot;junrao&quot;&gt;junrao&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mgharat&quot; class=&quot;user-hover&quot; rel=&quot;mgharat&quot;&gt;mgharat&lt;/a&gt; I think the issue is what Jun pointed out. I think a simple solution is to put the first close status check in append() into the synchronized(dq) block. This will guarantee either the message append goes through first or it will see the producer is closed.&lt;/p&gt;</comment>
                            <comment id="15120014" author="mgharat" created="Wed, 27 Jan 2016 19:28:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=becket_qin&quot; class=&quot;user-hover&quot; rel=&quot;becket_qin&quot;&gt;becket_qin&lt;/a&gt; sure. I will take a look and upload a PR.&lt;/p&gt;</comment>
                            <comment id="15120591" author="junrao" created="Thu, 28 Jan 2016 01:49:27 +0000"  >&lt;p&gt;It also seems that in RecordAccumulator.abortBatches(), if we close a RecordBatch, we should always take it off DQ for consistency.&lt;/p&gt;</comment>
                            <comment id="15120613" author="becket_qin" created="Thu, 28 Jan 2016 02:16:32 +0000"  >&lt;p&gt;Yes, we should do that as well.&lt;/p&gt;</comment>
                            <comment id="15122084" author="githubbot" created="Thu, 28 Jan 2016 18:49:43 +0000"  >&lt;p&gt;GitHub user MayureshGharat opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/825&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/825&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3147&quot; title=&quot;Memory records is not writable in MirrorMaker&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3147&quot;&gt;&lt;del&gt;KAFKA-3147&lt;/del&gt;&lt;/a&gt; : Memory records is not writable in MirrorMaker&lt;/p&gt;

&lt;p&gt;    Remove the batch from the RecordAccumulator once its closed while aborting batches. Make sure we don&apos;t accept new batch appends to RecordAccumulator while the producer is being closed.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/MayureshGharat/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/MayureshGharat/kafka&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3147&quot; title=&quot;Memory records is not writable in MirrorMaker&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3147&quot;&gt;&lt;del&gt;KAFKA-3147&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/825.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/825.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #825&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 088c4666fcd5a5d67e038fef8a0b237c056fe98a&lt;br/&gt;
Author: Mayuresh Gharat &amp;lt;mgharat@mgharat-ld1.linkedin.biz&amp;gt;&lt;br/&gt;
Date:   2016-01-28T18:45:19Z&lt;/p&gt;

&lt;p&gt;    Remove the batch from the RecordAccumulator once its closed while aborting batches. Make sure we don&apos;t accept new batch appends to RecordAccumulator while the producer is being closed.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15144291" author="githubbot" created="Fri, 12 Feb 2016 09:16:27 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/825&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/825&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15144292" author="guozhang" created="Fri, 12 Feb 2016 09:16:41 +0000"  >&lt;p&gt;Issue resolved by pull request 825&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/kafka/pull/825&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/825&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15174374" author="kdkavanagh" created="Tue, 1 Mar 2016 20:37:20 +0000"  >&lt;p&gt;Any possibility this makes it into a 0.9.x build rather than 0.10?&lt;/p&gt;</comment>
                            <comment id="15174458" author="becket_qin" created="Tue, 1 Mar 2016 21:40:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kdkavanagh&quot; class=&quot;user-hover&quot; rel=&quot;kdkavanagh&quot;&gt;kdkavanagh&lt;/a&gt; The next Kafka release will be 0.10.0. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;  So this fix will be in the next release.&lt;/p&gt;</comment>
                            <comment id="15247835" author="m1racoli" created="Tue, 19 Apr 2016 14:24:35 +0000"  >&lt;p&gt;It would be very much appreciated to get fixes for those bugs without relying on a new major version. while 0.10.0.0 comes out there will be high interest in a 0.9.0.2 version for production systems.&lt;/p&gt;</comment>
                            <comment id="15270365" author="ijuma" created="Wed, 4 May 2016 09:20:33 +0000"  >&lt;p&gt;Not clear if this has been completely fixed given the following comment in the PR:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;We patched 0.9.0.0 branch with this pull request. And tested patched version in our load test environment, after ~7 hours we have got same error:&lt;/p&gt;

&lt;p&gt;java.lang.IllegalStateException: Memory records is not writable&lt;br/&gt;
at org.apache.kafka.common.record.MemoryRecords.append(MemoryRecords.java:93)&lt;br/&gt;
at org.apache.kafka.clients.producer.internals.RecordBatch.tryAppend(RecordBatch.java:69)&lt;br/&gt;
at org.apache.kafka.clients.producer.internals.RecordAccumulator.append(RecordAccumulator.java:168)&lt;/p&gt;

&lt;p&gt;This always happens after next exceptions:&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;kafka-producer-network-thread | audiLoadTest&amp;#93;&lt;/span&gt; WARN org.apache.kafka.clients.producer.internals.Sender - Got error produce response with correlation id 2274005 on topic-partition mct-3, retrying (1 attempts left). Error: NETWORK_EXCEPTION&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mgharat&quot; class=&quot;user-hover&quot; rel=&quot;mgharat&quot;&gt;mgharat&lt;/a&gt;, thoughts?&lt;/p&gt;</comment>
                            <comment id="15270385" author="omkreddy" created="Wed, 4 May 2016 09:34:59 +0000"  >&lt;p&gt;Similar exception scenario is fixed in &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3594&quot; title=&quot;Kafka new producer retries doesn&amp;#39;t work in 0.9.0.1&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3594&quot;&gt;&lt;del&gt;KAFKA-3594&lt;/del&gt;&lt;/a&gt;. Above logs indicates, this is due to &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3594&quot; title=&quot;Kafka new producer retries doesn&amp;#39;t work in 0.9.0.1&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3594&quot;&gt;&lt;del&gt;KAFKA-3594&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="15270387" author="ijuma" created="Wed, 4 May 2016 09:38:56 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=omkreddy&quot; class=&quot;user-hover&quot; rel=&quot;omkreddy&quot;&gt;omkreddy&lt;/a&gt;, closing again.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 28 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2ry0n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>