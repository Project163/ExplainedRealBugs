<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:52:47 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-3003] The fetch.wait.max.ms is not honored when new log segment rolled for low volume topics.</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-3003</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;The problem we saw can be explained by the example below:&lt;/p&gt;

&lt;p&gt;1. Message offset 100 is appended to partition p0, log segment 00000000.log. at time T. After that no message is appended. &lt;br/&gt;
2. This message is replicated, leader replica update its highWatermark.messageOffset=100, highWatermark.segmentBaseOffset=0.&lt;br/&gt;
3. At time T + retention.ms, because no message has been appended to current active log segment for retention.ms, the last modified time of the current log segment reaches retention time. &lt;br/&gt;
4. Broker rolls out a new log segment 00000001.log, and deletes the old log segment 00000000.log. The new log segment in this case is empty because there is no message appended. &lt;br/&gt;
5. In Log, the nextOffsetMetadata.segmentBaseOffset will be updated to the new log segment&apos;s base offset, but nextOffsetMetadata.messageOffset does not change. so nextOffsetMetadata.messageOffset=1, nextOffsetMetadata.segmentBaseOffset=1.&lt;br/&gt;
6. Now a FetchRequest comes and try to fetch from offset 1, fetch.wait.max.ms=1000.&lt;br/&gt;
7. In ReplicaManager, because there is no data to return, the fetch request will be put into purgatory. When delayedFetchPurgatory.tryCompleteElseWatch() is called, the DelayedFetch.tryComplete() compares replica.highWatermark and the fetchOffset returned by log.read(), it will see the replica.highWatermark.segmentBaseOffset=0 and fetchOffset.segmentBaseOffset=1. So it will assume the fetch occurs on a later segment and complete the delayed fetch immediately.&lt;/p&gt;

&lt;p&gt;In this case, the replica.highWatermark was not updated because the LogOffsetMetadata.preceds() only checks the messageOffset but ignored segmentBaseOffset. The fix is to let LogOffsetMetadata first check the messageOffset then check the segmentBaseOffset. So replica.highWatermark will get updated after the follower fetches from the leader.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12922607">KAFKA-3003</key>
            <summary>The fetch.wait.max.ms is not honored when new log segment rolled for low volume topics.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="becket_qin">Jiangjie Qin</assignee>
                                    <reporter username="becket_qin">Jiangjie Qin</reporter>
                        <labels>
                    </labels>
                <created>Thu, 17 Dec 2015 06:20:51 +0000</created>
                <updated>Wed, 23 Mar 2016 16:57:29 +0000</updated>
                            <resolved>Fri, 5 Feb 2016 17:07:28 +0000</resolved>
                                    <version>0.9.0.0</version>
                                    <fixVersion>0.9.0.1</fixVersion>
                                    <component>core</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="15061582" author="lindong" created="Thu, 17 Dec 2015 06:37:36 +0000"  >&lt;p&gt;Great catch!&lt;/p&gt;</comment>
                            <comment id="15061611" author="githubbot" created="Thu, 17 Dec 2015 06:53:23 +0000"  >&lt;p&gt;GitHub user becketqin opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/688&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/688&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3003&quot; title=&quot;The fetch.wait.max.ms is not honored when new log segment rolled for low volume topics.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3003&quot;&gt;&lt;del&gt;KAFKA-3003&lt;/del&gt;&lt;/a&gt; Update the replica.highWatermark correctly&lt;/p&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/becketqin/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/becketqin/kafka&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3003&quot; title=&quot;The fetch.wait.max.ms is not honored when new log segment rolled for low volume topics.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3003&quot;&gt;&lt;del&gt;KAFKA-3003&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/688.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/688.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #688&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit d3f9edf89ac32f44413edc3d58e227fa2d859ca2&lt;br/&gt;
Author: Jiangjie Qin &amp;lt;becket.qin@gmail.com&amp;gt;&lt;br/&gt;
Date:   2015-12-17T06:52:11Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3003&quot; title=&quot;The fetch.wait.max.ms is not honored when new log segment rolled for low volume topics.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3003&quot;&gt;&lt;del&gt;KAFKA-3003&lt;/del&gt;&lt;/a&gt; Update the replica.highWatermark correctly&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15134486" author="guozhang" created="Fri, 5 Feb 2016 17:07:28 +0000"  >&lt;p&gt;Issue resolved by pull request 688&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/kafka/pull/688&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/688&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15134488" author="githubbot" created="Fri, 5 Feb 2016 17:08:44 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/688&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/688&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15208059" author="wushujames" created="Wed, 23 Mar 2016 08:29:07 +0000"  >&lt;p&gt;Would this cause large amounts of interbroker traffic, as the broker&apos;s continually fetch from each other and the fetches get completed immediately?&lt;/p&gt;</comment>
                            <comment id="15208764" author="becket_qin" created="Wed, 23 Mar 2016 16:57:29 +0000"  >&lt;p&gt;In this particular case, the problem was due to high watermark was not updated correctly. Because high water mark is only used for consumer fetcher, it should not affect replica fetchers.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 34 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2q0ov:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>guozhang</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>