<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:28:18 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-12984] Cooperative sticky assignor can get stuck with invalid SubscriptionState input metadata</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-12984</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Some users have reported seeing their consumer group become stuck in the CompletingRebalance phase when using the cooperative-sticky assignor. Based on the request metadata we were able to deduce that multiple consumers were reporting the same partition(s) in their &quot;ownedPartitions&quot; field of the consumer protocol. Since this is an invalid state, the input causes the cooperative-sticky assignor to detect that something is wrong and throw an IllegalStateException. If the consumer application is set up to simply retry, this will cause the group to appear to hang in the rebalance state.&lt;/p&gt;

&lt;p&gt;The &quot;ownedPartitions&quot; field is encoded based on the ConsumerCoordinator&apos;s SubscriptionState, which was assumed to always be up to date. However there may be cases where the consumer has dropped out of the group but fails to clear the SubscriptionState, allowing it to report some partitions as owned that have since been reassigned to another member.&lt;/p&gt;

&lt;p&gt;We should (a) fix the sticky assignment algorithm to resolve cases of improper input conditions by invalidating the &quot;ownedPartitions&quot; in cases of double ownership, and (b) shore up the ConsumerCoordinator logic to better handle rejoining the group and keeping its internal state consistent. See &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-12983&quot; title=&quot;onJoinPrepare is not always invoked before joining the group&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-12983&quot;&gt;&lt;del&gt;KAFKA-12983&lt;/del&gt;&lt;/a&gt;&#160;for more details on (b)&lt;/p&gt;</description>
                <environment></environment>
        <key id="13385288">KAFKA-12984</key>
            <summary>Cooperative sticky assignor can get stuck with invalid SubscriptionState input metadata</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ableegoldman">A. Sophie Blee-Goldman</assignee>
                                    <reporter username="ableegoldman">A. Sophie Blee-Goldman</reporter>
                        <labels>
                    </labels>
                <created>Wed, 23 Jun 2021 01:57:50 +0000</created>
                <updated>Sat, 5 Feb 2022 00:44:07 +0000</updated>
                            <resolved>Wed, 14 Jul 2021 01:40:45 +0000</resolved>
                                                    <fixVersion>2.5.2</fixVersion>
                    <fixVersion>2.6.3</fixVersion>
                    <fixVersion>2.7.2</fixVersion>
                    <fixVersion>2.8.1</fixVersion>
                    <fixVersion>3.0.0</fixVersion>
                                    <component>consumer</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="17367967" author="showuon" created="Wed, 23 Jun 2021 08:42:33 +0000"  >&lt;p&gt;Good root cause analysis! And I agree the solution (a) that the sticky assignment algorithm should resolve cases of improper input conditions by invalidating the &quot;ownedPartitions&quot; in cases of double ownership.&lt;/p&gt;</comment>
                            <comment id="17368353" author="mjsax" created="Wed, 23 Jun 2021 17:18:11 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ableegoldman&quot; class=&quot;user-hover&quot; rel=&quot;ableegoldman&quot;&gt;ableegoldman&lt;/a&gt; &#8211; is KS affected by this issue? Even if we use our own assignor, it seems that the issue with regard to &quot;subscription state&quot; could also affect KS?&lt;/p&gt;</comment>
                            <comment id="17368542" author="ableegoldman" created="Thu, 24 Jun 2021 01:08:09 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mjsax&quot; class=&quot;user-hover&quot; rel=&quot;mjsax&quot;&gt;mjsax&lt;/a&gt;&#160;Technically yes, the issue with the SubscriptionState potentially providing invalid &quot;ownedPartitions&quot; input can affect Kafka Streams as well. However the impact for Streams is be considerably less severe, as the assignment algorithm it doesn&apos;t make any assumptions about the previous assignment being valid. The worst that should happen to a Streams application is that the assignment could be slightly sub-optimal, with a partition/active task being assigned to a member that had dropped out of the group since being assigned that partition, instead of its true current owner.&#160;&lt;/p&gt;</comment>
                            <comment id="17433029" author="andy_dufresne" created="Fri, 22 Oct 2021 14:56:10 +0000"  >&lt;p&gt;Hi, we faced the same issue described above with&#160; app running Kafka client 2.8.1. and broker 2.7.0.&lt;/p&gt;

&lt;p&gt;I manually pulled&#160;CooperativeStickyAssignor and&#160;AbstractStickyAssignor from v 3.0 and placed it in the consumer app as custom&#160;&lt;/p&gt;

&lt;p&gt;partition.assignment.strategy and the issue has gone.&lt;/p&gt;

&lt;p&gt;Is it possible that the fix wasn&apos;t completely backported from 3.0 to 2.8.1 kafka client?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17433181" author="ableegoldman" created="Fri, 22 Oct 2021 23:31:54 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Andy_Dufresne&quot; class=&quot;user-hover&quot; rel=&quot;Andy_Dufresne&quot;&gt;Andy_Dufresne&lt;/a&gt; Hm, well there&apos;s a separate commit for this due to merge conflicts, but it does appear to be in the 2.8.1 tag: see commit&#160;3d764ed38709aa0516e226afa8f4dac682bffb59&lt;/p&gt;

&lt;p&gt;I suppose it&apos;s possible we missed something in the cherrypick. Can you be more specific about what exactly you hit here? An exception message, or full logs would be great. Also can you confirm whether the entire group was on 2.8.1 at the time? For example did you do a rolling bounce up to 2.8.1 and encounter the problem during that? If there was even one member on an older version without this fix, then it would be possible to hit this bug.&#160;&lt;/p&gt;</comment>
                            <comment id="17433653" author="andy_dufresne" created="Mon, 25 Oct 2021 09:28:47 +0000"  >&lt;p&gt;The entire group used 2.8.1 Kafka-client&#160; and &apos;CooperativeStickyAssignor&apos;.&lt;/p&gt;


&lt;p&gt;Here are broker logs: we see that broker skipped assignment for generations 10-12 since ConsumerCoordinator was stucked on it&apos;s side&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13035302/13035302_image-2021-10-25-11-53-40-221.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;and here are logs from consumers for the same timeframe:&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2021-10-20 10:14:27.878 ERROR {spanId=, traceId=} [org.apa.kaf.cli.con.&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;.ConsumerCoordinator] (smallrye-kafka-consumer-thread-0) [Consumer clientId=qa-qa-cf-executor-transform, groupId=qa-qa-cf-executor-transform] With the COOPERATIVE protocol, owned partitions cannot be reassigned to other members; however the assignor has reassigned partitions [qa-qa-cf-events-32, qa-qa-cf-events-13, qa-qa-cf-events-30, qa-qa-cf-events-38, qa-qa-cf-events-11] which are still owned by some members
2021-10-20 10:14:30.566 ERROR {spanId=, traceId=} [org.apa.kaf.cli.con.&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;.ConsumerCoordinator] (smallrye-kafka-consumer-thread-0) [Consumer clientId=qa-qa-cf-executor-transform, groupId=qa-qa-cf-executor-transform] With the COOPERATIVE protocol, owned partitions cannot be reassigned to other members; however the assignor has reassigned partitions [qa-qa-cf-events-32, qa-qa-cf-events-13, qa-qa-cf-events-30, qa-qa-cf-events-38, qa-qa-cf-events-11] which are still owned by some members
2021-10-20 10:14:34.913 ERROR {spanId=, traceId=} [org.apa.kaf.cli.con.&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;.ConsumerCoordinator] (smallrye-kafka-consumer-thread-0) [Consumer clientId=qa-qa-cf-executor-transform, groupId=qa-qa-cf-executor-transform] With the COOPERATIVE protocol, owned partitions cannot be reassigned to other members; however the assignor has reassigned partitions [qa-qa-cf-events-32, qa-qa-cf-events-13, qa-qa-cf-events-30, qa-qa-cf-events-38, qa-qa-cf-events-11] which are still owned by some members
2021-10-20 10:14:34.920 ERROR {spanId=, traceId=} [io.sma.rea.mes.kafka] (smallrye-kafka-consumer-thread-0) SRMSG18217: Unable to read a record from Kafka topics &lt;span class=&quot;code-quote&quot;&gt;&apos;[qa-qa-cf-events]&apos;&lt;/span&gt;: java.lang.IllegalStateException: Retries exhausted: 3/3
2021-10-20T13:14:34.928+03:00	Caused by: java.lang.IllegalStateException: Assignor supporting the COOPERATIVE protocol violates its requirements
2021-10-20T13:14:34.928+03:00	at org.apache.kafka.clients.consumer.internals.ConsumerCoordinator.validateCooperativeAssignment(ConsumerCoordinator.java:668)
2021-10-20T13:14:34.928+03:00	at org.apache.kafka.clients.consumer.internals.ConsumerCoordinator.performAssignment(ConsumerCoordinator.java:592)
2021-10-20T13:14:34.928+03:00	at org.apache.kafka.clients.consumer.internals.AbstractCoordinator.onJoinLeader(AbstractCoordinator.java:693)
2021-10-20T13:14:34.928+03:00	at org.apache.kafka.clients.consumer.internals.AbstractCoordinator.access$1000(AbstractCoordinator.java:111)
2021-10-20T13:14:34.928+03:00	at org.apache.kafka.clients.consumer.internals.AbstractCoordinator$JoinGroupResponseHandler.handle(AbstractCoordinator.java:599)
2021-10-20T13:14:34.928+03:00	at org.apache.kafka.clients.consumer.internals.AbstractCoordinator$JoinGroupResponseHandler.handle(AbstractCoordinator.java:562)
2021-10-20T13:14:34.928+03:00	at org.apache.kafka.clients.consumer.internals.AbstractCoordinator$CoordinatorResponseHandler.onSuccess(AbstractCoordinator.java:1182)
2021-10-20T13:14:34.928+03:00	at org.apache.kafka.clients.consumer.internals.AbstractCoordinator$CoordinatorResponseHandler.onSuccess(AbstractCoordinator.java:1157)
2021-10-20T13:14:34.928+03:00	at org.apache.kafka.clients.consumer.internals.RequestFuture$1.onSuccess(RequestFuture.java:206)
2021-10-20T13:14:34.928+03:00	at org.apache.kafka.clients.consumer.internals.RequestFuture.fireSuccess(RequestFuture.java:169)
2021-10-20T13:14:34.928+03:00	at org.apache.kafka.clients.consumer.internals.RequestFuture.complete(RequestFuture.java:129)
2021-10-20T13:14:34.928+03:00	at org.apache.kafka.clients.consumer.internals.ConsumerNetworkClient$RequestFutureCompletionHandler.fireCompletion(ConsumerNetworkClient.java:602)
2021-10-20T13:14:34.928+03:00	at org.apache.kafka.clients.consumer.internals.ConsumerNetworkClient.firePendingCompletedRequests(ConsumerNetworkClient.java:412)
2021-10-20T13:14:34.928+03:00	at org.apache.kafka.clients.consumer.internals.ConsumerNetworkClient.poll(ConsumerNetworkClient.java:247)
2021-10-20T13:14:34.928+03:00	at org.apache.kafka.clients.consumer.internals.ConsumerNetworkClient.poll(ConsumerNetworkClient.java:236)
2021-10-20T13:14:34.928+03:00	at org.apache.kafka.clients.consumer.internals.ConsumerNetworkClient.poll(ConsumerNetworkClient.java:215)
2021-10-20T13:14:34.928+03:00	at org.apache.kafka.clients.consumer.internals.AbstractCoordinator.joinGroupIfNeeded(AbstractCoordinator.java:426)
2021-10-20T13:14:34.928+03:00	at org.apache.kafka.clients.consumer.internals.AbstractCoordinator.ensureActiveGroup(AbstractCoordinator.java:365)
2021-10-20T13:14:34.928+03:00	at org.apache.kafka.clients.consumer.internals.ConsumerCoordinator.poll(ConsumerCoordinator.java:508)
2021-10-20T13:14:34.928+03:00	at org.apache.kafka.clients.consumer.KafkaConsumer.updateAssignmentMetadataIfNeeded(KafkaConsumer.java:1261)
2021-10-20T13:14:34.928+03:00	at org.apache.kafka.clients.consumer.KafkaConsumer.poll(KafkaConsumer.java:1230)
2021-10-20T13:14:34.928+03:00	at org.apache.kafka.clients.consumer.KafkaConsumer.poll(KafkaConsumer.java:1210)
2021-10-20T13:14:34.928+03:00	at io.smallrye.reactive.messaging.kafka.impl.ReactiveKafkaConsumer.lambda$poll$4(ReactiveKafkaConsumer.java:131)
2021-10-20T13:14:34.928+03:00	at io.smallrye.reactive.messaging.kafka.impl.ReactiveKafkaConsumer.lambda$runOnPollingThread$0(ReactiveKafkaConsumer.java:101)
2021-10-20T13:14:34.928+03:00	at io.smallrye.context.impl.wrappers.SlowContextualSupplier.get(SlowContextualSupplier.java:21)
2021-10-20T13:14:34.928+03:00	at io.smallrye.mutiny.operators.uni.builders.UniCreateFromItemSupplier.subscribe(UniCreateFromItemSupplier.java:28)
2021-10-20 10:14:34.921 WARN  {spanId=, traceId=} [io.sma.rea.mes.kafka] (smallrye-kafka-consumer-thread-0) SRMSG18228: A failure has been reported &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; Kafka topics &lt;span class=&quot;code-quote&quot;&gt;&apos;[qa-qa-cf-events]&apos;&lt;/span&gt;: java.lang.IllegalStateException: Retries exhausted: 3/3
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;UPD:&lt;br/&gt;
We run another tests and despite manually pulling and using &apos;CooperativeStickyAssignor&apos; from Kafka 3.0 client in our application, now we see the same errors as well, so  it seems the issue still exists (maybe something in ConsumerCoordinator class)&lt;/p&gt;</comment>
                            <comment id="17433747" author="showuon" created="Mon, 25 Oct 2021 12:59:51 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Andy_Dufresne&quot; class=&quot;user-hover&quot; rel=&quot;Andy_Dufresne&quot;&gt;Andy_Dufresne&lt;/a&gt;, thanks for your response. It looks like there&apos;s something wrong in the cooperative sticky assignor. If possible, could you help turn on &quot;DEBUG&quot; log for consumer and reproduce the issue and collect the log again?&lt;/p&gt;

&lt;p&gt;That&apos;d be helpful if we can see the logs starts with:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Performing constrained assign with partitionsPerTopic: ...
After reassigning previously owned partitions, unfilled members: ...
Final assignment of partitions to consumers: ...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;or&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
performing general assign. partitionsPerTopic: ...
unassigned Partitions: ...
Final assignment of partitions to consumers: ..&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;Please run it in v3.0.0 since in not quite sure if there are such logs in 2.8.1. &lt;/p&gt;

&lt;p&gt;Thank you very much.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17434281" author="andy_dufresne" created="Tue, 26 Oct 2021 11:14:38 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=showuon&quot; class=&quot;user-hover&quot; rel=&quot;showuon&quot;&gt;showuon&lt;/a&gt; Here are debug logs.&lt;br/&gt;
The freeze happened at 15:48:23&lt;br/&gt;
we used CooperativeStickyAssignor from v 3.0.0 here&lt;/p&gt;

&lt;p&gt; &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13035362/13035362_logs-insights-results-kafka.csv&quot; title=&quot;logs-insights-results-kafka.csv attached to KAFKA-12984&quot;&gt;logs-insights-results-kafka.csv&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; &lt;/p&gt;</comment>
                            <comment id="17434389" author="showuon" created="Tue, 26 Oct 2021 14:10:45 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Andy_Dufresne&quot; class=&quot;user-hover&quot; rel=&quot;Andy_Dufresne&quot;&gt;Andy_Dufresne&lt;/a&gt;, thanks for the log. I have some clue from there now.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ableegoldman&quot; class=&quot;user-hover&quot; rel=&quot;ableegoldman&quot;&gt;ableegoldman&lt;/a&gt;, here&apos;s my observation from the log.&lt;/p&gt;

&lt;p&gt;At first, the rebalance (generation 24) completed successfully. Here&apos;s the final assignment:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
- qa-qa-cf-executor-transform-e96cc4a8-e2a4-447a-b033-eb5b244a329a=[qa-qa-cf-events-8, qa-qa-cf-events-9, qa-qa-cf-events-24, qa-qa-cf-events-35], 
- qa-qa-cf-executor-transform-6f9acbca-885e-435c-97f5-6c86f476bd8e=[qa-qa-cf-events-1, qa-qa-cf-events-3, qa-qa-cf-events-5, qa-qa-cf-events-7], 
- qa-qa-cf-executor-transform-84d0f50e-0c97-4bf7-b4cc-311c6d3fbdf9=[qa-qa-cf-events-10, qa-qa-cf-events-11, qa-qa-cf-events-25], 
- qa-qa-cf-executor-transform-199c5bfb-85c8-4ecc-9604-30eb7988b9fe=[qa-qa-cf-events-6, qa-qa-cf-events-30, qa-qa-cf-events-32], 
- qa-qa-cf-executor-transform-c7decca7-e9d1-4d0b-b78e-3dfa5d71ea29=[qa-qa-cf-events-26, qa-qa-cf-events-28, qa-qa-cf-events-29], 
- qa-qa-cf-executor-transform-ac907fc0-33c9-4dfc-8f4d-f0e10b39e8ab=[qa-qa-cf-events-31, qa-qa-cf-events-36, qa-qa-cf-events-37], 
- qa-qa-cf-executor-transform-4c3d7d78-c1de-4d2d-bd18-580a442bc719=[qa-qa-cf-events-34, qa-qa-cf-events-38, qa-qa-cf-events-39], 
- qa-qa-cf-executor-transform-0e14afde-0788-44ef-8b5e-af7182f6a762=[qa-qa-cf-events-14, qa-qa-cf-events-15, qa-qa-cf-events-33], 
- qa-qa-cf-executor-transform-41f4f5c4-da68-40f1-911d-d006ede5c464=[qa-qa-cf-events-16, qa-qa-cf-events-17, qa-qa-cf-events-18, qa-qa-cf-events-19], qa-- - qa-cf-executor-transform-b1777322-80ee-4f28-a224-bf97ee2b2a50=[qa-qa-cf-events-20, qa-qa-cf-events-21, qa-qa-cf-events-22, qa-qa-cf-events-23], qa-- - qa-cf-executor-transform-5a95d1d8-0a47-4d32-bb6b-03531bb92765=[qa-qa-cf-events-0, qa-qa-cf-events-2, qa-qa-cf-events-4], 
- qa-qa-cf-executor-transform-2b6f692a-b557-4cc3-b461-f55fa3e25000=[qa-qa-cf-events-12, qa-qa-cf-events-13, qa-qa-cf-events-27]&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Here, what I want to highlight is the the assignment for consumer: qa-cf-executor-transform-b1777322-80ee-4f28-a224-bf97ee2b2a50=&lt;span class=&quot;error&quot;&gt;&amp;#91;**qa-qa-cf-events-20, qa-qa-cf-events-21, qa-qa-cf-events-22, qa-qa-cf-events-23**&amp;#93;&lt;/span&gt;. This one causes the issue.&lt;/p&gt;

&lt;p&gt;Also, the other consumer: qa-qa-cf-executor-transform-199c5bfb-85c8-4ecc-9604-30eb7988b9fe=&lt;span class=&quot;error&quot;&gt;&amp;#91;**qa-qa-cf-events-6, qa-qa-cf-events-30, qa-qa-cf-events-32**&amp;#93;&lt;/span&gt;, it seems not get the final assignment in generation 24. So in the next round of rebalance, ownedPartition is empty (my guess)&lt;/p&gt;

&lt;p&gt;And, what will happen next (my guess), is that, in subscription&apos;s &quot;ownedPartition&quot; variable, we remember these 4 ownedPartition in subscription for the consumer ending with &quot;bf97ee2b2a50&quot; above. But somehow, we didn&apos;t find them in subscription data field after deserialization (maybe the generation is not the highest). So, in the following assignment, we&apos;ll just assign the 4 partitions to 2 consumers (1 is the consumer itself). And the error message in validateCooperativeAssignment proves my suspicion.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Next, generation 25 rebalance starts, with 3 retries. The all 3 final assignments are also logged, and here, I highlighted the difference:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;1st try*, with error:&lt;br/&gt;
 &lt;em&gt;With the COOPERATIVE protocol, owned partitions cannot be reassigned to other members; however the assignor has reassigned partitions &lt;span class=&quot;error&quot;&gt;&amp;#91;*qa-qa-cf-events-23, qa-qa-cf-events-21*&amp;#93;&lt;/span&gt; which are still owned by some members&lt;/em&gt;&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;...&lt;/p&gt;

&lt;p&gt;qa-qa-cf-executor-transform-199c5bfb-85c8-4ecc-9604-30eb7988b9fe=&lt;span class=&quot;error&quot;&gt;&amp;#91;qa-qa-cf-events-6, *qa-qa-cf-events-21*, *qa-qa-cf-events-23*&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;...&lt;/p&gt;

&lt;p&gt;qa-qa-cf-executor-transform-b1777322-80ee-4f28-a224-bf97ee2b2a50=&lt;span class=&quot;error&quot;&gt;&amp;#91;*qa-qa-cf-events-20, qa-qa-cf-events-22*, qa-qa-cf-events-30&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;2nd try*, with the same error as 1st try, because the assignment is the same.&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;...&lt;/p&gt;

&lt;p&gt;qa-qa-cf-executor-transform-199c5bfb-85c8-4ecc-9604-30eb7988b9fe=&lt;span class=&quot;error&quot;&gt;&amp;#91;qa-qa-cf-events-6, *qa-qa-cf-events-21, qa-qa-cf-events-23*&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;...&lt;/p&gt;

&lt;p&gt;qa-qa-cf-executor-transform-b1777322-80ee-4f28-a224-bf97ee2b2a50=&lt;span class=&quot;error&quot;&gt;&amp;#91;*qa-qa-cf-events-20, qa-qa-cf-events-22*, qa-qa-cf-events-30&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;3rd try*, with error:&lt;br/&gt;
 &lt;em&gt;With the COOPERATIVE protocol, owned partitions cannot be reassigned to other members; however the assignor has reassigned partitions &lt;span class=&quot;error&quot;&gt;&amp;#91;*qa-qa-cf-events-20, qa-qa-cf-events-23, qa-qa-cf-events-22*&amp;#93;&lt;/span&gt; which are still owned by some members&lt;/em&gt;&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;...&lt;/p&gt;

&lt;p&gt;qa-qa-cf-executor-transform-199c5bfb-85c8-4ecc-9604-30eb7988b9fe=&lt;span class=&quot;error&quot;&gt;&amp;#91;qa-qa-cf-events-6, *qa-qa-cf-events-20, qa-qa-cf-events-23*&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;...&lt;/p&gt;

&lt;p&gt;qa-qa-cf-executor-transform-d914fca8-dfe7-420c-98f7-ce7c44727fcd=&lt;span class=&quot;error&quot;&gt;&amp;#91;qa-qa-cf-events-19, *qa-qa-cf-events-22*, qa-qa-cf-events-32&amp;#93;&lt;/span&gt;&#160; &amp;lt;-- new consumer&lt;/p&gt;

&lt;p&gt;...&lt;/p&gt;

&lt;p&gt;qa-qa-cf-executor-transform-b1777322-80ee-4f28-a224-bf97ee2b2a50=&lt;span class=&quot;error&quot;&gt;&amp;#91;qa-qa-cf-events-7, *qa-qa-cf-events-21*, qa-qa-cf-events-30&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;====&lt;/p&gt;

&lt;p&gt;So, it looks like the out-of-date &quot;ownedPartition&quot; in subscription not only might cause the double assignment issue, but also failed the cooperation assignment validation.&#160;&lt;/p&gt;

&lt;p&gt;My suggestion:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;in validateCooperationAssignment, we should deserialize the subscription userData, instead of using the ownedPartition directly.&lt;/li&gt;
	&lt;li&gt;If the assignor is our built-in assignor (i.e. CooperativeStickyAssignor), we ignore the validation.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;What do you think?&lt;/p&gt;</comment>
                            <comment id="17434408" author="andy_dufresne" created="Tue, 26 Oct 2021 14:51:12 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=showuon&quot; class=&quot;user-hover&quot; rel=&quot;showuon&quot;&gt;showuon&lt;/a&gt; Thank you for the fast and complete analysis.&lt;br/&gt;
It&apos;d be great if I could cherrypick potential fix later and try the tests once more to prove the issue has finally gone.  &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/biggrin.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="17434579" author="ableegoldman" created="Tue, 26 Oct 2021 21:18:23 +0000"  >&lt;p&gt;Mm, yeah, I should&apos;ve remembered that the `ownedPartitions` field was used for this validation as well. I mean we did fix the &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-12983&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;onJoinPrepare issue&lt;/a&gt; which was the only specific known edge case at the time which could lead to the `ownedPartitions` set being incorrect/out of date like this. Not surprised there might be others out there though, in fact I originally wanted to expand the fix in &lt;a href=&quot;https://github.com/apache/kafka/pull/10986&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;#10986&lt;/a&gt;&#160;to reset the generation/ownedPartitions in some other cases to be safe but was talked out of it (not trying to shift the blame here, I still should&apos;ve caught this!)&lt;/p&gt;

&lt;p&gt;My point is, even if we do either 1/2, users won&apos;t be able to write a custom cooperative assignor without running into this. It&apos;s a huge bummer if we can&apos;t trust the `ownedPartitions` to be accurate &#8211; the whole point of adding it to the ConsumerProtocol was to use it for this verification and also to provide this info to users who may want to write a custom cooperative assignor :/&#160;&lt;/p&gt;

&lt;p&gt;I suppose for the time being we could/should consider putting in a hotfix for the CooperativeStickyAssignor while we work out a better long-term solution &#8211; for example a public interface/abstract class like CooperativeConsumerPartitionAssignor that users can implement/extend to for a custom cooperative assignor, which at the very least stores the generation like we do in the CooperativeStickyAssignor and makes it available for the user as well as to the ConsumerCoordinator for it to know when to invalidate a member&apos;s ownedPartitions during this validation step &#8211; does that make sense? WDYT?&lt;/p&gt;

&lt;p&gt;cc also &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hachikuji&quot; class=&quot;user-hover&quot; rel=&quot;hachikuji&quot;&gt;hachikuji&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;FWIW I&apos;d prefer either option (2), or possibly a modified version of (1) that only uses the generation rather than trying to get the partitions from the assignor&apos;s userdata. But again, all of these will only work for the CooperativeStickyAssignor, so we may need to start thinking about a KIP if we don&apos;t feel like we can trust the ownedPartitions to be accurate&lt;/p&gt;</comment>
                            <comment id="17434666" author="ableegoldman" created="Wed, 27 Oct 2021 05:20:36 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=showuon&quot; class=&quot;user-hover&quot; rel=&quot;showuon&quot;&gt;showuon&lt;/a&gt;&#160;want to prepare a quick fix for the time being? Either via option 2, or option 1/modified option 1 as described so that &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Andy_Dufresne&quot; class=&quot;user-hover&quot; rel=&quot;Andy_Dufresne&quot;&gt;Andy_Dufresne&lt;/a&gt;&#160;can test it out?&lt;/p&gt;</comment>
                            <comment id="17434669" author="showuon" created="Wed, 27 Oct 2021 05:40:18 +0000"  >&lt;p&gt;Yes, I&apos;m going to create another Jira issue for it. Will work on it soon!&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17434705" author="showuon" created="Wed, 27 Oct 2021 07:25:35 +0000"  >&lt;p&gt;&amp;gt; a public interface/abstract class like CooperativeConsumerPartitionAssignor that users can implement/extend to for a custom cooperative assignor, which at the very least stores the generation like we do in the CooperativeStickyAssignor and makes it available for the user as well as to the ConsumerCoordinator for it to know when to invalidate a member&apos;s ownedPartitions during this validation step &#8211; does that make sense? WDYT?&lt;/p&gt;

&lt;p&gt;&#160;--&amp;gt; Sounds good to me. Or maybe we can put onto the ConsumerProtocolSubscription protocol to add a &quot;generation&quot; field.&lt;/p&gt;</comment>
                            <comment id="17434755" author="showuon" created="Wed, 27 Oct 2021 09:26:39 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-13406&quot; title=&quot;Cooperative sticky assignor got stuck due to assignment validation failed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-13406&quot;&gt;&lt;del&gt;KAFKA-13406&lt;/del&gt;&lt;/a&gt; is created for this issue.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310660">
                    <name>Completes</name>
                                            <outwardlinks description="fixes">
                                        <issuelink>
            <issuekey id="13382160">KAFKA-12896</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13382160">KAFKA-12896</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13385287">KAFKA-12983</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13409116">KAFKA-13420</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13389502">KAFKA-13081</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13408621">KAFKA-13406</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13035302" name="image-2021-10-25-11-53-40-221.png" size="340691" author="Andy_Dufresne" created="Mon, 25 Oct 2021 08:53:40 +0000"/>
                            <attachment id="13035361" name="log-events-viewer-result-kafka.numbers" size="291250" author="Andy_Dufresne" created="Tue, 26 Oct 2021 11:13:46 +0000"/>
                            <attachment id="13035362" name="logs-insights-results-kafka.csv" size="259660" author="Andy_Dufresne" created="Tue, 26 Oct 2021 11:14:34 +0000"/>
                            <attachment id="13035360" name="logs-insights-results-kafka.numbers" size="521802" author="Andy_Dufresne" created="Tue, 26 Oct 2021 11:10:25 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 2 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0s7aw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>