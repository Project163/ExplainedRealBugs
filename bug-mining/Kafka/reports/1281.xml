<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:57:57 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-4492] java.lang.IllegalStateException: Attempting to put a clean entry for key... into NamedCache</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-4492</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;This follows on from &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-4311&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-4311&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The exception seems to be triggered by topologies with multiple joined tables. As a new record arrives in one table it triggers an eviction. The eviction causes a flush which will trigger a join processor. These in-turn does a cache lookup and if the value is not in the cache, then it will be retrieved from the store and put in the cache, triggering another eviction. And so on.&lt;/p&gt;

&lt;p&gt;Exception reported on mailing list&lt;br/&gt;
&lt;a href=&quot;https://gist.github.com/mfenniak/509fb82dfcfda79a21cfc1b07dafa89c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gist.github.com/mfenniak/509fb82dfcfda79a21cfc1b07dafa89c&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Further investigation into this also reveals that this same eviction process can send the cache eviction into an infinite loop. It seems that the LRU is broken.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13025933">KAFKA-4492</key>
            <summary>java.lang.IllegalStateException: Attempting to put a clean entry for key... into NamedCache</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="damianguy">Damian Guy</assignee>
                                    <reporter username="damianguy">Damian Guy</reporter>
                        <labels>
                    </labels>
                <created>Tue, 6 Dec 2016 11:07:36 +0000</created>
                <updated>Fri, 9 Dec 2016 16:46:41 +0000</updated>
                            <resolved>Fri, 9 Dec 2016 16:46:40 +0000</resolved>
                                    <version>0.10.1.0</version>
                                    <fixVersion>0.10.2.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15729341" author="githubbot" created="Wed, 7 Dec 2016 17:29:54 +0000"  >&lt;p&gt;GitHub user dguy opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/2226&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2226&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-4492&quot; title=&quot;java.lang.IllegalStateException: Attempting to put a clean entry for key... into NamedCache&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-4492&quot;&gt;&lt;del&gt;KAFKA-4492&lt;/del&gt;&lt;/a&gt;: java.lang.IllegalStateException: Attempting to put a clean entry for key... into NamedCache&lt;/p&gt;

&lt;p&gt;    The NamedCache wasn&apos;t correctly dealing with its re-entrant nature. This would result in the LRU becoming corrupted, and the above exception occurring during eviction. For example:&lt;br/&gt;
    Cache A: dirty key 1&lt;br/&gt;
    eviction runs on Cache A&lt;br/&gt;
    Node for key 1 gets marked as clean&lt;br/&gt;
    Entry for key 1 gets flushed downstream&lt;br/&gt;
    Downstream there is a processor that also refers to the table fronted by Cache A&lt;br/&gt;
    Downstream processor puts key 2 into Cache A&lt;br/&gt;
    This triggers an eviction of key 1 again ( it is still the oldest node as hasn&apos;t been removed from the LRU)&lt;br/&gt;
    As the Node for key 1 is clean flush doesn&apos;t run and it is immediately removed from the cache. &lt;br/&gt;
    So now we have dirtyKey set with key =1, but the value doesn&apos;t exist in the cache.&lt;br/&gt;
    Downstream processor tries to put key = 1 into the cache, it fails as key =1 is in the dirtyKeySet.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/dguy/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/dguy/kafka&lt;/a&gt; cache-bug&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/2226.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2226.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #2226&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 926ef4b1900c6870819948e12950f215ab3998ac&lt;br/&gt;
Author: Damian Guy &amp;lt;damian.guy@gmail.com&amp;gt;&lt;br/&gt;
Date:   2016-12-07T14:48:34Z&lt;/p&gt;

&lt;p&gt;    fix cache bug&lt;/p&gt;

&lt;p&gt;commit 6b6f3a57acacae1f0e4642ebc080ec9bc451e98c&lt;br/&gt;
Author: Damian Guy &amp;lt;damian.guy@gmail.com&amp;gt;&lt;br/&gt;
Date:   2016-12-07T17:12:47Z&lt;/p&gt;

&lt;p&gt;    add comment about cache eviction&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15729783" author="githubbot" created="Wed, 7 Dec 2016 20:09:23 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/2226&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2226&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 49 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i377zb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>