<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:36:14 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-541] Use metrics CSV reporter instead of jmx tool for system tests</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-541</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;The existing system test framework spawns off a bunch of jmxtool processes to collect metrics. This is rather heavy-weight and also, requires advance knowledge of all the beans (many of which are dynamically registered). E.g., per-topic stats pop-up only after the topics are produced to.&lt;/p&gt;

&lt;p&gt;Since we are using metrics-core, we can just turn on the CSV reporter to collect these stats. I had originally thought version 2.1.3 had various bugs that rendered it unusable for CSV reporter, but I gave it another try and it seems to be fine. Will post some output.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12610167">KAFKA-541</key>
            <summary>Use metrics CSV reporter instead of jmx tool for system tests</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="yeyangever">Yang Ye</assignee>
                                    <reporter username="jjkoshy">Joel Jacob Koshy</reporter>
                        <labels>
                    </labels>
                <created>Thu, 4 Oct 2012 00:09:30 +0000</created>
                <updated>Thu, 25 Oct 2012 01:21:49 +0000</updated>
                            <resolved>Tue, 23 Oct 2012 01:28:13 +0000</resolved>
                                    <version>0.8.0</version>
                                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="13469015" author="jjkoshy" created="Thu, 4 Oct 2012 00:14:11 +0000"  >&lt;p&gt;Some sample output:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://gist.github.com/3830723&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gist.github.com/3830723&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13469043" author="jjkoshy" created="Thu, 4 Oct 2012 00:50:38 +0000"  >&lt;p&gt;Actually, now I remember. metrics 3.0.0 fixes this issue: &lt;a href=&quot;https://github.com/codahale/metrics/pull/225&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/codahale/metrics/pull/225&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;It affects us because we have different scopes for similar metrics. e.g., NumDelayedRequests in both FetchRequestPurgatory and ProducerRequestPurgatory, so they collide.&lt;/p&gt;

&lt;p&gt;E.g., with metrics 2.1.3 we would just have NumDelayedRequests.csv but with 3.0.0 we would have kafka.server.ProducerRequestPurgatory.NumDelayedRequests.csv and kafka.server.FetchRequestPurgatory.NumDelayedRequests.csv&lt;/p&gt;

&lt;p&gt;I&apos;ll file a separate jira to upgrade to 3.* as this one is for getting our system test framework to consume the generated csv files.&lt;/p&gt;</comment>
                            <comment id="13469061" author="jjkoshy" created="Thu, 4 Oct 2012 01:29:45 +0000"  >&lt;p&gt;Also, FYI, here are the configs to add to a server to get csv reporting enabled on startup. It can also be started up through the JMX operation if not enabled at start-up.&lt;/p&gt;

&lt;p&gt;kafka.metrics.polling.interval.secs=5&lt;br/&gt;
kafka.metrics.reporters=kafka.metrics.KafkaCSVMetricsReporter&lt;br/&gt;
kafka.csv.metrics.dir=kafka_metrics&lt;br/&gt;
kafka.csv.metrics.reporter.enabled=true&lt;/p&gt;</comment>
                            <comment id="13469104" author="nehanarkhede" created="Thu, 4 Oct 2012 02:58:15 +0000"  >&lt;p&gt;+1, this will be great to have. Also, even with the upgrade, we still need a way to filter which attributes we want to plot per mbean for system tests and organize the graphs in dashboards per role. I think we can use the existing metrics.json to specify this, unless you are suggesting to change that ?&lt;/p&gt;</comment>
                            <comment id="13469527" author="jjkoshy" created="Thu, 4 Oct 2012 17:28:22 +0000"  >&lt;p&gt;That&apos;s right - we would just use metrics.json, although instead of a bean it would specify the name of the CSV file, and some of the column names may be different.&lt;/p&gt;</comment>
                            <comment id="13478754" author="yeyangever" created="Thu, 18 Oct 2012 07:24:48 +0000"  >
&lt;p&gt;1. Currently, only broker supports csv reporter, we added its support to producer and consumer &lt;/p&gt;

&lt;p&gt;2. In system test, disable the &lt;/p&gt;

&lt;p&gt;3. the output of the csvReporter is not quite the same as JMX metrics collection&apos;s, some lines of output file may be empty line (we tried to avoid them), the header of csv files are different, we added some mapping in kafka_system_test_utils.py to discern them.&lt;/p&gt;

&lt;p&gt;4. changed the &quot;generate_overriden_props_files&quot; to add csv supporting properties to the broker config&lt;/p&gt;


&lt;p&gt;NOT DONE YET:&lt;br/&gt;
the producer_performance and console_consumer don&apos;t support CSV reporter yet.. it&apos;s hard to do because they don&apos;t support properties file as input, instead they take the configuration directly from the command line. Will think about how to make they support&lt;/p&gt;</comment>
                            <comment id="13480089" author="junrao" created="Fri, 19 Oct 2012 15:53:52 +0000"  >&lt;p&gt;Thanks for the patch. Some comments:&lt;/p&gt;

&lt;p&gt;1. I see the following error while running run_sanity.sh in system test. &lt;br/&gt;
2012-10-19 07:52:05,210 - ERROR - ERROR while plotting graph /home/jrao/Intellij_workspace/kafka_0.8_203/system_test/replication_testsuite/testcase_1/dashboards/broker/kafka.server:type=BrokerTopicMetrics,name=AllTopicsBytesInPerSec:OneMinuteRate.svg: float division (metrics)&lt;/p&gt;

&lt;p&gt;2. kafka_system_test_utils.py: The following line doesn&apos;t look right and there are multiple instances of this.&lt;br/&gt;
+                    addedCSVConfig&lt;span class=&quot;error&quot;&gt;&amp;#91;&amp;quot;kfka.metrics.polling.interval.secsafka.csv.metrics.reporter.enabled&amp;quot;&amp;#93;&lt;/span&gt; = &quot;true&quot;&lt;/p&gt;

&lt;p&gt;3. We probably shouldn&apos;t register the metrics reporter in Producer and ZookeeperConsumerConnector since a single jvm can create multiple instances of each. Instead, we could make a util that registers the metrics reporter and invoke it in standalone tools like ProducerPerformance and ConsoleConsumer.&lt;/p&gt;</comment>
                            <comment id="13480914" author="yeyangever" created="Sun, 21 Oct 2012 07:18:03 +0000"  >
&lt;p&gt;Changes since first patch:&lt;/p&gt;

&lt;p&gt;1. make the kafka csv metrics reporter a singleton &amp;#8212; only one instance in one JVM&lt;/p&gt;

&lt;p&gt;2. adding csv metrics reporter support for producer / consumer /producer-performance / console-consumer&lt;/p&gt;

&lt;p&gt;3. fix a few places in the system test to make it actually working &amp;#8212; with producer_performance and console-consumer, and plotting graph correctly&lt;/p&gt;

&lt;p&gt;4. there&apos;s only one problem left : some of the metrics are of type &quot;time&quot;, according to the doc, timer reports data as  both a Meter and Histagram. (this is also verified in the JMX console)&lt;/p&gt;

&lt;p&gt;But for the exported CSV file, we only see the header like: &lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;time,min,max,mean,median,stddev,95%,99%,99.9%&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;That&apos;s to say, we cannot find the Meter / rate related metrics.&lt;/p&gt;

&lt;p&gt;For a fiew graphs requiring &quot;One minute rate&quot; from a timer metric (and only for them), the data are not reported and graphs are not plotted&lt;/p&gt;</comment>
                            <comment id="13481955" author="yeyangever" created="Mon, 22 Oct 2012 23:59:50 +0000"  >
&lt;p&gt;changes since v2:&lt;/p&gt;

&lt;p&gt;1. patch the coda hale metrics project and build new jars, which fixes the csvReporter not reporting meter attributes for timer metrics problem&lt;/p&gt;

&lt;p&gt;2. fix the metric.py by not passing non-existent files into inputCsvFiles of plot_graphs() function&lt;/p&gt;

&lt;p&gt;3. change the metrics in kafka RequestMetrics class from in unit of nano seconds to milli seconds&lt;/p&gt;

&lt;p&gt;4. build a getter for &quot;props&quot; attribute in ConsumerConfig, &lt;/p&gt;

&lt;p&gt;5. making the KafkaCSVMetricsReporter a singleton, only one instance can be started within each JVM&lt;/p&gt;</comment>
                            <comment id="13482019" author="nehanarkhede" created="Tue, 23 Oct 2012 01:28:13 +0000"  >&lt;p&gt;Committed v4 after making the following changes to v3 -&lt;/p&gt;

&lt;p&gt;1. Fixed a logging statement in metrics.py since the newly added statement threw a runtime error&lt;br/&gt;
2. Fixed KafkaProject.scala to point to the right metrics package version (3.0.1)&lt;br/&gt;
3. Fixed the ConsumerConfig constructor argument to be a val and removed the getter API added in v3&lt;/p&gt;</comment>
                            <comment id="13482493" author="jjkoshy" created="Tue, 23 Oct 2012 17:33:14 +0000"  >&lt;p&gt;Delayed review, but nevertheless:&lt;/p&gt;

&lt;p&gt;The KafkaCSVMetricsReporter object may be better named as KafkaMetricsReporter since startCSVMetricsReporter&lt;br/&gt;
potentially starts up other (non-CSV) reporters (if any) as well - in which case KafkaMetricsReporter.scala would be a&lt;br/&gt;
better place for it. Or, you can just filter out non-CSV reporters.&lt;/p&gt;

&lt;p&gt;Also, the top-level/config/server.properties need not enable the csv reporter. I thought the system test replication&lt;br/&gt;
suite&apos;s server.properties would need to be patched, but it isn&apos;t. Does this mean the test suite picks up the top-level&lt;br/&gt;
config as a template?&lt;/p&gt;

&lt;p&gt;I can take care of the above in some other (unrelated) jiras that I have on my plate. However:&lt;/p&gt;

&lt;p&gt;Can you please attach the metrics patch to fix the Timer CSV reporting? and ideally, submit a pull-request to the&lt;br/&gt;
metrics project? We should get off our patched version of metrics as soon as metrics-core@github is patched. (I had put&lt;br/&gt;
the metrics github hash in the previous jar so we know exactly which version of the code we are on.)&lt;/p&gt;</comment>
                            <comment id="13483799" author="jjkoshy" created="Thu, 25 Oct 2012 01:21:49 +0000"  >&lt;p&gt;Looks like your pull request is in. I&apos;ll file another jira to do the above.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                            <outwardlinks description="depends upon">
                                        <issuelink>
            <issuekey id="12610173">KAFKA-542</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12549652" name="kafka_541_v1.diff" size="13024" author="yeyangever" created="Thu, 18 Oct 2012 07:24:48 +0000"/>
                            <attachment id="12550171" name="kafka_541_v2.diff" size="23396" author="yeyangever" created="Sun, 21 Oct 2012 07:18:03 +0000"/>
                            <attachment id="12550377" name="kafka_541_v3.diff" size="37199" author="yeyangever" created="Mon, 22 Oct 2012 23:59:50 +0000"/>
                            <attachment id="12550376" name="metrics-annotation-3.0.1.jar" size="4762" author="yeyangever" created="Mon, 22 Oct 2012 23:59:50 +0000"/>
                            <attachment id="12550375" name="metrics-core-3.0.1.jar" size="81781" author="yeyangever" created="Mon, 22 Oct 2012 23:59:50 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>240553</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 4 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i013b3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4305</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>