<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:24:23 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-9840] Consumer should not use OffsetForLeaderEpoch without current epoch validation</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-9840</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;We have observed a case where the consumer attempted to detect truncation with the OffsetsForLeaderEpoch API against a broker which had become a zombie. In this case, the last epoch known to the consumer was higher than the last epoch known to the zombie broker, so the broker returned -1 as both the end offset and epoch in the response. The consumer did not check for this in the response, which resulted in the following message:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Truncation detected &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition topic-1 at offset FetchPosition{offset=11859, offsetEpoch=Optional[46], currentLeader=LeaderAndEpoch{leader=broker-host (id: 3 rack: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;), epoch=-1}}, resetting offset to the first offset known to diverge FetchPosition{offset=-1, offsetEpoch=Optional[-1], currentLeader=LeaderAndEpoch{broker-host (id: 3 rack: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;), epoch=-1}} (org.apache.kafka.clients.consumer.internals.SubscriptionState:414)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;There are a couple ways we the consumer can handle this situation better. First, the reason we did not detect the zombie broker is that we did not include the current leader epoch in the OffsetForLeaderEpoch request. This was likely because of &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-9212&quot; title=&quot;Keep receiving FENCED_LEADER_EPOCH while sending ListOffsetRequest&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-9212&quot;&gt;&lt;del&gt;KAFKA-9212&lt;/del&gt;&lt;/a&gt;. Following this patch, we would not initialize the current leader epoch from metadata responses because there are cases that we cannot rely on it. But if the client cannot rely on being able to detect zombies, then the epoch validation is less useful anyway. So the simple solution is to not bother with the validation unless we have a reliable current leader epoch.&lt;/p&gt;

&lt;p&gt;Second, the consumer needs to check for the case when the returned offset and epoch are not defined. In this case, we have to treat this as a normal OffsetOutOfRange case and invoke the reset policy. &lt;/p&gt;
</description>
                <environment></environment>
        <key id="13297261">KAFKA-9840</key>
            <summary>Consumer should not use OffsetForLeaderEpoch without current epoch validation</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="bchen225242">Boyang Chen</assignee>
                                    <reporter username="hachikuji">Jason Gustafson</reporter>
                        <labels>
                    </labels>
                <created>Thu, 9 Apr 2020 04:49:32 +0000</created>
                <updated>Fri, 5 Jun 2020 23:00:05 +0000</updated>
                            <resolved>Fri, 5 Jun 2020 23:00:05 +0000</resolved>
                                    <version>2.4.1</version>
                                    <fixVersion>2.6.0</fixVersion>
                                    <component>consumer</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17079583" author="guozhang" created="Thu, 9 Apr 2020 17:18:31 +0000"  >&lt;p&gt;For the second case, when the returned offset / epoch is not defined could the consumer tries to refresh its metadata trying to find the new leader?&lt;/p&gt;</comment>
                            <comment id="17082459" author="hachikuji" created="Mon, 13 Apr 2020 16:26:42 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; If we have the current epoch validation, it&apos;s a bit unclear whether this case should even be possible. There shouldn&apos;t be any situation where the epoch we&apos;re requesting is larger than the current leader epoch, so the leader should always be able to provide an end offset in the response. I guess we could even treat this as an unexpected error in the client. What do you think?&lt;/p&gt;</comment>
                            <comment id="17082472" author="guozhang" created="Mon, 13 Apr 2020 16:43:20 +0000"  >&lt;p&gt;What I&apos;m thinking is that, if we treat it as an unexpected error, either defaulting to reset policy or even throwing are not ideal &amp;#8211; since we are talking to a zombie broker, the consumer should not pay the price as either re-consuming or losing data or even crashing; on the other hand, suppose we do not remove the current validation from broker (since new client can always talk to old brokers), does returning -1 always means that the broker we are talking to is a zombie? If yes, instead of resetting or throwing the consumer can just try to find the current leader and retry.&lt;/p&gt;</comment>
                            <comment id="17082504" author="hachikuji" created="Mon, 13 Apr 2020 17:19:05 +0000"  >&lt;p&gt;Other than the zombie case, the only way I could see this happening is some kind of disaster scenario where the cluster had to revert to an older epoch. The current epoch validation in that case would also fail, which would cause the consumer to retry. So perhaps retrying on -1 without the current epoch validation is reasonable as well.&lt;/p&gt;</comment>
                            <comment id="17083444" author="githubbot" created="Tue, 14 Apr 2020 17:04:00 +0000"  >&lt;p&gt;abbccdda commented on pull request #8486: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-9840&quot; title=&quot;Consumer should not use OffsetForLeaderEpoch without current epoch validation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-9840&quot;&gt;&lt;del&gt;KAFKA-9840&lt;/del&gt;&lt;/a&gt;: Skip End Offset validation when the leader epoch is not reliable&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/8486&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/8486&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   As title suggests.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 31 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0dfw0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>