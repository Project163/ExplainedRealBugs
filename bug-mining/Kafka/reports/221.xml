<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:37:31 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-671] DelayedProduce requests should not hold full producer request data</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-671</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Per summary, this leads to unnecessary memory usage.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12623612">KAFKA-671</key>
            <summary>DelayedProduce requests should not hold full producer request data</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sriramsub">Sriram</assignee>
                                    <reporter username="jjkoshy">Joel Jacob Koshy</reporter>
                        <labels>
                            <label>bugs</label>
                            <label>p1</label>
                    </labels>
                <created>Wed, 12 Dec 2012 19:50:56 +0000</created>
                <updated>Wed, 27 Feb 2013 01:36:40 +0000</updated>
                            <resolved>Wed, 27 Feb 2013 01:36:36 +0000</resolved>
                                    <version>0.8.0</version>
                                    <fixVersion>0.8.1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="13538606" author="jkreps" created="Sat, 22 Dec 2012 01:01:05 +0000"  >&lt;p&gt;I am concerned this may be a blocker for production usage. If this adds 200k per request with 5000 outstanding requests that is 1G of memory. This is not too far out there for production usage with a high number of producers.&lt;/p&gt;</comment>
                            <comment id="13553415" author="sriramsub" created="Tue, 15 Jan 2013 02:09:42 +0000"  >&lt;p&gt;This is one possible fix. The fix would largely depend on the decision for Kafka 703 but I just wanted one possible fix to be available to make better decision on the other bug.&lt;/p&gt;

&lt;p&gt;1. We now create a map of topic partion -&amp;gt; messagesizes and DelayedProduce uses this instead of the entire data payload. &lt;br/&gt;
2. We reset the data payload at the end of HandleProduceRequest. &lt;/p&gt;

&lt;p&gt;The only way I have found to reset the immutable maps is to make them vars (Other option is to convert them to mutable maps but that involves a ton of code changes (all the place where the data objects are passed around need to be changed to mutable maps). Let me know of a better option in Scala.&lt;/p&gt;

&lt;p&gt;The expectation is that the data object will not be used after the reset method is called.&lt;/p&gt;</comment>
                            <comment id="13554142" author="nehanarkhede" created="Tue, 15 Jan 2013 18:53:13 +0000"  >&lt;p&gt;Overall, the changes look good. Minor suggestions -&lt;/p&gt;

&lt;p&gt;1. KafkaApis&lt;br/&gt;
1.1 Can we rename messageSizeInBytes to messageSetSize ?&lt;br/&gt;
1.2 Similarly rename messageSizes to messageSetSize&lt;/p&gt;

&lt;p&gt;2. ProducerRequest&lt;br/&gt;
I&apos;m guessing the resetData() API is added with the goal of helping with garbage collection ? I think this might not be required since once the produce request is handled, whether or not it entered the purgatory, it will be eligible for garbage collection&lt;/p&gt;</comment>
                            <comment id="13554158" author="sriramsub" created="Tue, 15 Jan 2013 18:59:48 +0000"  >&lt;p&gt;2. I don&apos;t think so since DelayedProduce is still holding on to the RequestChannel&apos;s Request object which is the produceRequest. Let me know if that is not the case.&lt;/p&gt;</comment>
                            <comment id="13554172" author="nehanarkhede" created="Tue, 15 Jan 2013 19:10:10 +0000"  >&lt;p&gt;2. You maybe right. However, given that you set a large enough young gen compared to the total heap size, I wonder what is the impact of nullifying the data. It will be worth doing a quick experiment to study GC patterns and confirm that it does help. The only downside of this approach is that it looks ugly.&lt;/p&gt;</comment>
                            <comment id="13554178" author="sriramsub" created="Tue, 15 Jan 2013 19:15:54 +0000"  >&lt;p&gt;2. I am not sure if it is an issue in the first place. Depends on how long these objects stay in the queue. If 5000 outstanding requests can be reached as suggested by Jay above then it does seem like an issue. Let me know what you find in your GC investigation. I agree it is ugly. Another option is to totally remove the request object dependency from DelayedItems but that would be a larger change.&lt;/p&gt;</comment>
                            <comment id="13558420" author="junrao" created="Sun, 20 Jan 2013 22:59:01 +0000"  >&lt;p&gt;Thanks for the patch. I agree with Neha that ProducerRequest.resetData() seems a bit hacky. Another thing is that currently, we log the request object in trace in RequestChannel.Request when processing the response. Resetting the data in the produce request may break the logic there.&lt;/p&gt;

&lt;p&gt;Maybe we should test it out and see if this is really a problem. It&apos;s true that there could be many producers. However, it may take some time for them to generate 1GB of data.&lt;/p&gt;</comment>
                            <comment id="13558448" author="junrao" created="Sun, 20 Jan 2013 23:59:03 +0000"  >&lt;p&gt;Thinking about this a bit more. There is another approach. In KafkaApis.handle(), after the request is handled, we set RequestChannel.Request.requestObj to null. At this point, the response is not sent yet. Currently, requestObj is needed when sending a response is in RequestChannel.Request.updateRequestMetrics() where we need to print requestObj (in trace). What we can do is that in RequestChannel.Request, after requestObj is constructed, get and cache the string value of request (set the string to null if not trace enabled). We also need to cache isFromFollower which is obtained from requestObj. This way, we don&apos;t need ProducerRequest.resetData() and we can guarantee that after KafkaApis.handle(), each requestObj can be GC-ed.&lt;/p&gt;</comment>
                            <comment id="13558462" author="sriramsub" created="Mon, 21 Jan 2013 00:36:34 +0000"  >&lt;p&gt;I think to do this right we should limit the change to produceRequest instead of getting rid of the requestobj completely. The reason is as you mention you would need to cache a bunch of fields from requestObj to be used in updateRequestMetrics while sending the response. This can be two fields today but going forward you may need more fields and this would need to be constantly maintained. I think if produceRequest handles data being null, the fix would be more robust and isolates the changes within produce request.&lt;/p&gt;</comment>
                            <comment id="13558946" author="nehanarkhede" created="Mon, 21 Jan 2013 18:09:33 +0000"  >&lt;p&gt;Nullifying the request object seems like a bigger change. I&apos;m wondering about the precise impact to GC that these changes will introduce. If the impact is just that the objects get garbage collected within 1 iteration of the young gen collector VS 2-3 iterations, I would say the performance upside of this change is not worth the risk. But if it significantly reduces garbage collected overhead, it might be worth looking further into. Even if we have to do this, I agree with Sriram that his earlier change is smaller impact than nullifying request object and caching a bunch of things to get around it. &lt;/p&gt;</comment>
                            <comment id="13558969" author="nehanarkhede" created="Mon, 21 Jan 2013 18:33:24 +0000"  >&lt;p&gt;Thinking about this a little more, the real problem seems to be that we hang onto the request object in DelayedProduce until we send out the response. There are 2 reasons for this -&lt;br/&gt;
1. The request latency metrics are part of the request object. These need to be updated when the response is created.&lt;br/&gt;
2. To send out the response, we need the selector key, which is inside the request object.&lt;/p&gt;

&lt;p&gt;To handle delayed produce requests without hanging onto the produce request data, we will need to -&lt;br/&gt;
1. Remove the request object from DelayedProduce &lt;br/&gt;
2. Pass in the selector key into DelayedProduce&lt;br/&gt;
3. Define the request metrics in a separate object and remove those from the Request object. Pass in the new RequestMetrics object into DelayedProduce&lt;/p&gt;

&lt;p&gt;Since this requires changing the DelayedRequest object as well, it will affect all requests. My guess is that this refactoring is not that big of a change, but I could be wrong.&lt;/p&gt;</comment>
                            <comment id="13564983" author="sriramsub" created="Tue, 29 Jan 2013 02:00:47 +0000"  >&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Ignore the changes in bin and system tests&lt;/li&gt;
	&lt;li&gt;this change is cleaner and a lot safer.&lt;/li&gt;
	&lt;li&gt;the data is now an mutable map&lt;/li&gt;
	&lt;li&gt;we just cache the topicpartition - message size in producer request&lt;/li&gt;
	&lt;li&gt;we clear the map after handling the request&lt;/li&gt;
	&lt;li&gt;the toString implementation of produceRequest uses the cached map instead of the data&lt;/li&gt;
	&lt;li&gt;the byteBuffer in RequestChannel.Request is now made private and is set to null after deserialization.&lt;/li&gt;
	&lt;li&gt;update test cases to work with these changes&lt;/li&gt;
	&lt;li&gt;I will be updating the thread with how the heap characteristics look before and after this change.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13565610" author="sriramsub" created="Tue, 29 Jan 2013 18:09:37 +0000"  >&lt;p&gt;rebased&lt;/p&gt;</comment>
                            <comment id="13565679" author="nehanarkhede" created="Tue, 29 Jan 2013 19:21:08 +0000"  >&lt;p&gt;Thanks for the v2 patch, few review comments -&lt;/p&gt;

&lt;p&gt;1. kafka-run-class&lt;br/&gt;
Revert these changes, the default heap size of 5g is too large. Also for the GC configs, there is another JIRA tracking it.&lt;br/&gt;
2. ProducerRequest&lt;br/&gt;
How about renaming emptyData() to clear() for consistency ?&lt;br/&gt;
3. What is the purpose of the mutable map changes in DefaultEventHandler ?&lt;/p&gt;</comment>
                            <comment id="13565980" author="sriramsub" created="Tue, 29 Jan 2013 23:51:43 +0000"  >&lt;p&gt;1. You can ignore the changes in system test and bin. I will update with a patch that does not have them.&lt;br/&gt;
2. emptyData seems more clear in what is happening in the produceRequest object Vs clear. Let me know if you think otherwise.&lt;br/&gt;
3. You need them since ProduceRequest data gets set from the methods in DefaultEventHandler. Is there any other way specific to Scala?&lt;/p&gt;</comment>
                            <comment id="13566188" author="jkreps" created="Wed, 30 Jan 2013 05:42:03 +0000"  >&lt;p&gt;Took a look at this. Looks reasonable.&lt;/p&gt;

&lt;p&gt;Other atrocities have occurred inside RequestQueue, but they aren&apos;t from this patch. Re-opened &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-683&quot; title=&quot;Fix correlation ids in all requests sent to kafka&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-683&quot;&gt;&lt;del&gt;KAFKA-683&lt;/del&gt;&lt;/a&gt;. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;For maps it is nicer to import scala.collection and then refer to mutable.Map rather than scala.mutable.Map.&lt;/p&gt;

&lt;p&gt;I think the question is why do we need to hang onto the ProduceRequest object at all? We are doing work to null it out, but why can&apos;t we just take the one or two fields we need from that in the delayed produce? If we do that then won&apos;t the producerequest be out of scope after handleProduce and get gc&apos;d? Is the root cause of this the fact that we moved deserialization into the network thread and shoved the api object into the request?&lt;/p&gt;</comment>
                            <comment id="13566222" author="sriramsub" created="Wed, 30 Jan 2013 06:40:52 +0000"  >&lt;p&gt;The issue is that even if we pass only the required fields from produceRequest to DelayedProduce, we also pass the actual Request itself to delayedProduce which is used in multiple places. Now that contains the requestObj and hence there is a non zero reference to it still. Further, when sending the response we depend on the requestObj at multiple places in updateRequestMetrics, one of them being the requirement to log the complete request. We would have to do some non trivial changes to be able to get rid of the request object completely which would probably need to wait till a later time.&lt;/p&gt;</comment>
                            <comment id="13566240" author="jkreps" created="Wed, 30 Jan 2013 07:05:22 +0000"  >&lt;p&gt;Okay let&apos;s sync up. I think requestObj is the devil. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13567933" author="sriramsub" created="Thu, 31 Jan 2013 18:48:52 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-745&quot; title=&quot;Remove getShutdownReceive() and other kafka specific code from the RequestChannel&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-745&quot;&gt;&lt;del&gt;KAFKA-745&lt;/del&gt;&lt;/a&gt; is tracking the cleanup of RequestChannel. &lt;/p&gt;</comment>
                            <comment id="13571088" author="sriramsub" created="Tue, 5 Feb 2013 06:32:09 +0000"  >&lt;p&gt;Jay - are you fine with checking this in? We would like to see the impact in shadow. We are using Kafka-745 for tracking the cleanup for RequestChannel.&lt;/p&gt;</comment>
                            <comment id="13571360" author="jkreps" created="Tue, 5 Feb 2013 14:52:57 +0000"  >&lt;p&gt;I think hacking requestObj is fine as an intermediate step but we need a plan to get rid of it in 0.8. Jun what&apos;s the plan? I am +1 when we have figured that out.&lt;/p&gt;

&lt;p&gt;One nit pick in the current code is:&lt;br/&gt;
     val requestObj: RequestOrResponse = RequestKeys.deserializerForKey(requestId)(buffer)&lt;br/&gt;
     buffer.rewind()&lt;br/&gt;
+    buffer = null&lt;/p&gt;

&lt;p&gt;Why are we keeping the buffer around at all if we immediately null it out (and we probably don&apos;t need to rewind it first)...?&lt;/p&gt;</comment>
                            <comment id="13584847" author="sriramsub" created="Fri, 22 Feb 2013 23:59:02 +0000"  >&lt;p&gt;rebased&lt;/p&gt;</comment>
                            <comment id="13585203" author="junrao" created="Sat, 23 Feb 2013 19:46:34 +0000"  >&lt;p&gt;Patch v4 doesn&apos;t apply. 0.8 has moved since the patch is uploaded. Could you rebase again?&lt;/p&gt;</comment>
                            <comment id="13586133" author="sriramsub" created="Mon, 25 Feb 2013 18:55:07 +0000"  >&lt;p&gt;rebased&lt;/p&gt;</comment>
                            <comment id="13586282" author="nehanarkhede" created="Mon, 25 Feb 2013 21:04:59 +0000"  >&lt;p&gt;Looks good overall. Just one comment -&lt;/p&gt;

&lt;p&gt;In the toString(), the map operation is not correct. If we just want to print a list of topic partitions, shouldn&apos;t it just be topicPartitionMessageSizeMap.keys.mkString(&quot;,&quot;)  ?&lt;/p&gt;

&lt;p&gt;Other than that, I&apos;m +1 on this. If others don&apos;t have any concerns, I can check this in after the above change is made&lt;/p&gt;</comment>
                            <comment id="13586289" author="sriramsub" created="Mon, 25 Feb 2013 21:13:27 +0000"  >&lt;p&gt;We want to print the topicPartition and the size.&lt;/p&gt;</comment>
                            <comment id="13586305" author="nehanarkhede" created="Mon, 25 Feb 2013 21:28:28 +0000"  >&lt;p&gt;I see, in that case, I still don&apos;t see the use of the map(). It is not transforming anything -&lt;br/&gt;
topicPartitionMessageSizeMap.map(r =&amp;gt; r._1 -&amp;gt; r._2).toMap.mkString(&quot;,&quot;)&lt;/p&gt;</comment>
                            <comment id="13586928" author="sriramsub" created="Tue, 26 Feb 2013 08:30:26 +0000"  >&lt;p&gt;Yes it can be simplified. &lt;/p&gt;</comment>
                            <comment id="13587545" author="nehanarkhede" created="Tue, 26 Feb 2013 21:02:07 +0000"  >&lt;p&gt;+1. If others don&apos;t have any other input, I will go ahead and check this in&lt;/p&gt;</comment>
                            <comment id="13587851" author="nehanarkhede" created="Wed, 27 Feb 2013 01:36:36 +0000"  >&lt;p&gt;Checked in patch v5&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12564849" name="outOfMemFix-v1.patch" size="7868" author="sriramsub" created="Tue, 15 Jan 2013 02:09:42 +0000"/>
                            <attachment id="12567017" name="outOfMemFix-v2-rebase.patch" size="19783" author="sriramsub" created="Tue, 29 Jan 2013 18:09:37 +0000"/>
                            <attachment id="12566885" name="outOfMemFix-v2.patch" size="19669" author="sriramsub" created="Tue, 29 Jan 2013 02:00:47 +0000"/>
                            <attachment id="12567082" name="outOfMemFix-v3.patch" size="13921" author="sriramsub" created="Wed, 30 Jan 2013 00:14:11 +0000"/>
                            <attachment id="12570837" name="outOfMemFix-v4-rebase.patch" size="17152" author="sriramsub" created="Mon, 25 Feb 2013 18:55:07 +0000"/>
                            <attachment id="12570559" name="outOfMemFix-v4.patch" size="14851" author="sriramsub" created="Fri, 22 Feb 2013 23:59:02 +0000"/>
                            <attachment id="12570949" name="outOfMemFix-v5.patch" size="18307" author="sriramsub" created="Tue, 26 Feb 2013 08:30:26 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>7.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>297330</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 38 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i14nxj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>235342</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>