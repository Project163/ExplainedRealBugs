<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:36:20 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-588] Index truncation doesn&apos;t seem to remove the last entry properly</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-588</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;2012-10-26 08:04:13,333&amp;#93;&lt;/span&gt; INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;Kafka Log on Broker 3&amp;#93;&lt;/span&gt;, Truncated log segment /tmp/kafka_server_3_logs/test_1-0/00000000000000130500.log to target offset 429050 (kafka.log.&lt;br/&gt;
Log)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2012-10-26 08:04:13,333&amp;#93;&lt;/span&gt; INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;ReplicaFetcherManager on broker 3&amp;#93;&lt;/span&gt; adding fetcher on topic test_1, partion 0, initOffset 429050 to broker 2 with fetcherId 0 (kafka.server.R&lt;br/&gt;
eplicaFetcherManager)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2012-10-26 08:04:13,335&amp;#93;&lt;/span&gt; INFO Replica Manager on Broker 3: Handling leader and isr request LeaderAndIsrRequest(1,,1000,Map((test_1,1) -&amp;gt; PartitionStateInfo(&lt;/p&gt;
{ &quot;ISR&quot;:&quot;2,3&quot;,&quot;leader&quot;:&quot;2&quot;,&quot;leaderEpoch&quot;:&quot;2&quot; }
&lt;p&gt;,3), (test_1,0) -&amp;gt; PartitionStateInfo(&lt;/p&gt;
{ &quot;ISR&quot;:&quot;2,3&quot;,&quot;leader&quot;:&quot;2&quot;,&quot;leaderEpoch&quot;:&quot;2&quot; }
&lt;p&gt;,3))) (kafka.server.ReplicaManager)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2012-10-26 08:04:13,335&amp;#93;&lt;/span&gt; INFO Replica Manager on Broker 3: Starting the follower state transition to follow leader 2 for topic test_1 partition 1 (kafka.server.ReplicaManager)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2012-10-26 08:04:13,335&amp;#93;&lt;/span&gt; INFO Partition &lt;span class=&quot;error&quot;&gt;&amp;#91;test_1, 1&amp;#93;&lt;/span&gt; on broker 3: Current leader epoch &lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt; is larger or equal to the requested leader epoch &lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;, discard the become follower request (kafka.cluster.Partition)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2012-10-26 08:04:13,336&amp;#93;&lt;/span&gt; INFO Replica Manager on Broker 3: Starting the follower state transition to follow leader 2 for topic test_1 partition 0 (kafka.server.ReplicaManager)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2012-10-26 08:04:13,336&amp;#93;&lt;/span&gt; INFO Partition &lt;span class=&quot;error&quot;&gt;&amp;#91;test_1, 0&amp;#93;&lt;/span&gt; on broker 3: Current leader epoch &lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt; is larger or equal to the requested leader epoch &lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;, discard the become follower request (kafka.cluster.Partition)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2012-10-26 08:04:13,588&amp;#93;&lt;/span&gt; ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;ReplicaFetcherThread-2-0-on-broker-3&amp;#93;&lt;/span&gt;, Error due to  (kafka.server.ReplicaFetcherThread)&lt;br/&gt;
java.lang.IllegalArgumentException: Attempt to append an offset (429050) no larger than the last offset appended (429050).&lt;br/&gt;
        at kafka.log.OffsetIndex.append(OffsetIndex.scala:180)&lt;br/&gt;
        at kafka.log.LogSegment.append(LogSegment.scala:56)&lt;br/&gt;
        at kafka.log.Log.append(Log.scala:273)&lt;br/&gt;
        at kafka.server.ReplicaFetcherThread.processPartitionData(ReplicaFetcherThread.scala:51)&lt;br/&gt;
        at kafka.server.AbstractFetcherThread$$anonfun$doWork$5.apply(AbstractFetcherThread.scala:116)&lt;br/&gt;
        at kafka.server.AbstractFetcherThread$$anonfun$doWork$5.apply(AbstractFetcherThread.scala:99)&lt;br/&gt;
        at scala.collection.immutable.Map$Map2.foreach(Map.scala:127)&lt;br/&gt;
        at kafka.server.AbstractFetcherThread.doWork(AbstractFetcherThread.scala:99)&lt;br/&gt;
        at kafka.utils.ShutdownableThread.run(ShutdownableThread.scala:50)&lt;/p&gt;</description>
                <environment></environment>
        <key id="12613674">KAFKA-588</key>
            <summary>Index truncation doesn&apos;t seem to remove the last entry properly</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jkreps">Jay Kreps</assignee>
                                    <reporter username="junrao">Jun Rao</reporter>
                        <labels>
                            <label>bugs</label>
                    </labels>
                <created>Fri, 26 Oct 2012 16:00:08 +0000</created>
                <updated>Tue, 4 Dec 2012 23:45:40 +0000</updated>
                            <resolved>Thu, 15 Nov 2012 03:56:12 +0000</resolved>
                                    <version>0.8.0</version>
                                                    <component>core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13485020" author="junrao" created="Fri, 26 Oct 2012 16:03:23 +0000"  >&lt;p&gt;From the log, the broker wants to truncate log to offset 429050. The last entry in the log is the following and looks correct.&lt;br/&gt;
offset: 429049 position: 155842578 isvalid: true payloadsize: 500 magic: 2 compresscodec: NoCompressionCodec crc: 3220325748&lt;/p&gt;

&lt;p&gt;However, the last index entry is the following, which is off by 1.&lt;br/&gt;
offset: 429050 position: 155843100&lt;/p&gt;</comment>
                            <comment id="13486293" author="jkreps" created="Mon, 29 Oct 2012 19:50:59 +0000"  >&lt;p&gt;Jun the OffsetIndex.truncateTo logic looks right to me and we have a number of tests on this so I am wondering if that is the problem. How was this broker shut down (or was it shutdown at all?). I ask because the DumpSegment tool just dumps what is on disk. In the case of the OffsetIndex the end of file pointer is just in memory and truncation just moves that pointer. I wonder if  the truncate wasn&apos;t correct but somehow the lastOffset wasn&apos;t set correctly and as a result we are giving the error incorrectly. If the broker wen through clean shutdown this should not be possible, but if not it is possible.&lt;/p&gt;

&lt;p&gt;One bug I think I see is that we initialize the lastOffset to be the baseOffset of the segment, but this means that if the first message is entered into the index with that same baseOffset (which is legitimate) it would produce an error. Normally I think we don&apos;t hit this just because our index interval isn&apos;t 1, however after a truncate we don&apos;t reset the bytesSinceLastIndexEntry so this becomes possible even with a larger index interval. Do you know how many entries were in that index file that you checked? I am pretty sure this is a bug, but am not sure if it caused this error (it could cause it though).&lt;/p&gt;</comment>
                            <comment id="13486459" author="jkreps" created="Mon, 29 Oct 2012 22:58:51 +0000"  >&lt;p&gt;I can&apos;t reproduce this issue, but this patch expands the tests and adds a little more logging. Specifically:&lt;br/&gt;
1. Expanded OffsetIndex to check we can still append after each truncate&lt;br/&gt;
2. Expanded LogSegmentTest to sequentially append 2 messages, truncate one of them off, and repeat this 30 times.&lt;br/&gt;
3. Removed obsolete references to &quot;logical offset&quot; (we changed terminology--now offsets are always logical and positions are always physical so this makes no sense.&lt;/p&gt;

&lt;p&gt;Here is my reasoning: this problem doesn&apos;t occur every time so it must be triggered by something non-deterministic. The possibilities I can think of:&lt;br/&gt;
1. The OffsetIndex is not properly synchronized&lt;br/&gt;
2. The truncate call is not properly setting the lastOffset and so the error is spurious.&lt;br/&gt;
3. The truncate call has an off-by-one error.&lt;br/&gt;
4. We are shutting down uncleanly and the recovery process is somehow not kicking in or not working correctly.&lt;/p&gt;

&lt;p&gt;Here is how I looked into these:&lt;br/&gt;
1. It does not look like a synchronization problem since both truncateTo and append are synchronized on the same lock.&lt;br/&gt;
2. I suspected a problem in setting the lastOffset, but actually I am handling this case--the check already special cases an empty index. So this is not it.&lt;br/&gt;
3. This does not appear to be the case, truncateTo(X) results in an index in which the last entry is &amp;lt;= X-1 which is what we want, we have  a number of tests on this.&lt;br/&gt;
4. I don&apos;t see this, we are going through the same append path in recovery we go through normally.&lt;/p&gt;</comment>
                            <comment id="13486567" author="junrao" created="Tue, 30 Oct 2012 00:56:33 +0000"  >&lt;p&gt;Thanks for the patch. In LogSegmentTest, could we set indexIntervalSize such that we force an index entry to be created for every message?&lt;/p&gt;</comment>
                            <comment id="13487086" author="jkreps" created="Tue, 30 Oct 2012 18:18:12 +0000"  >&lt;p&gt;Okay, I fooled around a little more and figured it out.&lt;/p&gt;

&lt;p&gt;Here is the issue. In OffsetIndex.truncateTo we have the following code:&lt;br/&gt;
      val newEntries = &lt;br/&gt;
        if(slot &amp;lt; 0)&lt;br/&gt;
          0&lt;br/&gt;
        else if(logical(idx, slot) == offset)&lt;br/&gt;
          slot&lt;br/&gt;
        else&lt;br/&gt;
          slot + 1&lt;/p&gt;

&lt;p&gt;This code looks right due to the bad naming. The arithmetic is actually correct, but the comparison is wrong as logical() returns the relative offset which we compare to the global offset. The fixed code looks like this:&lt;br/&gt;
      val newEntries = &lt;br/&gt;
        if(slot &amp;lt; 0)&lt;br/&gt;
          0&lt;br/&gt;
        else if(relativeOffset(idx, slot) == offset - baseOffset)&lt;br/&gt;
          slot&lt;br/&gt;
        else&lt;br/&gt;
          slot + 1&lt;/p&gt;</comment>
                            <comment id="13487109" author="jkreps" created="Tue, 30 Oct 2012 18:35:18 +0000"  >&lt;p&gt;Same as above patch, but actually has a fix for the issue plus tests that reproduce it.&lt;/p&gt;</comment>
                            <comment id="13487164" author="nehanarkhede" created="Tue, 30 Oct 2012 19:54:36 +0000"  >&lt;p&gt;+1 on v2, good catch !&lt;/p&gt;</comment>
                            <comment id="13497742" author="jkreps" created="Thu, 15 Nov 2012 03:56:12 +0000"  >&lt;p&gt;Fixed.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12551400" name="KAFKA-588-v2.patch" size="9253" author="jkreps" created="Tue, 30 Oct 2012 18:35:18 +0000"/>
                            <attachment id="12551267" name="KAFKA-588.patch" size="9150" author="jkreps" created="Mon, 29 Oct 2012 22:58:51 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>251276</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 1 week, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0bc8v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>64096</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>