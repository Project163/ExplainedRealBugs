<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:16:30 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-7712] Handle exceptions from immediately connected channels in Selector</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-7712</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;We try to handle all possible exceptions in Selector to ensure that channels are always closed and their states kept consistent. For immediately connected channels, we should ensure that any exception during connection results in the channel being closed properly and removed from all maps. This is a very unlikely scenario, but we do already handle the exception. We should clean up properly in the catch block.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13203027">KAFKA-7712</key>
            <summary>Handle exceptions from immediately connected channels in Selector</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rsivaram">Rajini Sivaram</assignee>
                                    <reporter username="rsivaram">Rajini Sivaram</reporter>
                        <labels>
                    </labels>
                <created>Fri, 7 Dec 2018 12:40:42 +0000</created>
                <updated>Wed, 12 Dec 2018 18:51:18 +0000</updated>
                            <resolved>Wed, 12 Dec 2018 18:51:18 +0000</resolved>
                                                    <fixVersion>2.2.0</fixVersion>
                                    <component>network</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="16717411" author="githubbot" created="Tue, 11 Dec 2018 15:44:37 +0000"  >&lt;p&gt;rajinisivaram opened a new pull request #6023: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7712&quot; title=&quot;Handle exceptions from immediately connected channels in Selector&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7712&quot;&gt;&lt;del&gt;KAFKA-7712&lt;/del&gt;&lt;/a&gt;: Remove channel from Selector before propagating exception&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/6023&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/6023&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Ensure that channel and selection keys are removed from `Selector` collections before propagating connect exceptions. They are currently cleared on the next `poll()`, but we can&apos;t ensure that callers (NetworkClient for example) wont try to connect again before the next `poll` and hence we should clear the collections before re-throwing exceptions from `connect()`.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16719303" author="githubbot" created="Wed, 12 Dec 2018 18:50:59 +0000"  >&lt;p&gt;hachikuji closed pull request #6023: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7712&quot; title=&quot;Handle exceptions from immediately connected channels in Selector&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7712&quot;&gt;&lt;del&gt;KAFKA-7712&lt;/del&gt;&lt;/a&gt;: Remove channel from Selector before propagating exception&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/6023&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/6023&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/clients/src/main/java/org/apache/kafka/common/network/Selector.java b/clients/src/main/java/org/apache/kafka/common/network/Selector.java&lt;br/&gt;
index 843d46dc736..8c46746d847 100644&lt;br/&gt;
&amp;#8212; a/clients/src/main/java/org/apache/kafka/common/network/Selector.java&lt;br/&gt;
+++ b/clients/src/main/java/org/apache/kafka/common/network/Selector.java&lt;br/&gt;
@@ -250,10 +250,11 @@ public Selector(long connectionMaxIdleMS, int failedAuthenticationDelayMs, Metri&lt;br/&gt;
     public void connect(String id, InetSocketAddress address, int sendBufferSize, int receiveBufferSize) throws IOException {&lt;br/&gt;
         ensureNotRegistered(id);&lt;br/&gt;
         SocketChannel socketChannel = SocketChannel.open();&lt;br/&gt;
+        SelectionKey key = null;&lt;br/&gt;
         try {&lt;br/&gt;
             configureSocketChannel(socketChannel, sendBufferSize, receiveBufferSize);&lt;br/&gt;
             boolean connected = doConnect(socketChannel, address);&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;SelectionKey key = registerChannel(id, socketChannel, SelectionKey.OP_CONNECT);&lt;br/&gt;
+            key = registerChannel(id, socketChannel, SelectionKey.OP_CONNECT);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;             if (connected) &lt;/p&gt;
{
                 // OP_CONNECT won&apos;t trigger for immediately connected channels
@@ -262,6 +263,9 @@ public void connect(String id, InetSocketAddress address, int sendBufferSize, in
                 key.interestOps(0);
             }
&lt;p&gt;         } catch (IOException | RuntimeException e) &lt;/p&gt;
{
+            if (key != null)
+                immediatelyConnectedKeys.remove(key);
+            channels.remove(id);
             socketChannel.close();
             throw e;
         }
&lt;p&gt;@@ -316,7 +320,7 @@ private void ensureNotRegistered(String id) &lt;/p&gt;
{
             throw new IllegalStateException(&quot;There is already a connection for id &quot; + id + &quot; that is still being closed&quot;);
     }

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private SelectionKey registerChannel(String id, SocketChannel socketChannel, int interestedOps) throws IOException {&lt;br/&gt;
+    protected SelectionKey registerChannel(String id, SocketChannel socketChannel, int interestedOps) throws IOException {&lt;br/&gt;
         SelectionKey key = socketChannel.register(nioSelector, interestedOps);&lt;br/&gt;
         KafkaChannel channel = buildAndAttachKafkaChannel(socketChannel, id, key);&lt;br/&gt;
         this.channels.put(id, channel);&lt;br/&gt;
diff --git a/clients/src/test/java/org/apache/kafka/common/network/SelectorTest.java b/clients/src/test/java/org/apache/kafka/common/network/SelectorTest.java&lt;br/&gt;
index 6cf75861122..2da1cc68198 100644
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/clients/src/test/java/org/apache/kafka/common/network/SelectorTest.java&lt;br/&gt;
+++ b/clients/src/test/java/org/apache/kafka/common/network/SelectorTest.java&lt;br/&gt;
@@ -51,6 +51,7 @@&lt;br/&gt;
 import java.util.Random;&lt;br/&gt;
 import java.util.Set;&lt;br/&gt;
 import java.util.Optional;&lt;br/&gt;
+import java.util.concurrent.atomic.AtomicBoolean;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; import static org.junit.Assert.assertEquals;&lt;br/&gt;
 import static org.junit.Assert.assertFalse;&lt;br/&gt;
@@ -380,16 +381,7 @@ public void testIdleExpiryWithoutReadyKeys() throws IOException {&lt;br/&gt;
     @Test&lt;br/&gt;
     public void testImmediatelyConnectedCleaned() throws Exception {&lt;br/&gt;
         Metrics metrics = new Metrics(); // new metrics object to avoid metric registration conflicts&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Selector selector = new Selector(5000, metrics, time, &quot;MetricGroup&quot;, channelBuilder, new LogContext()) {&lt;/li&gt;
	&lt;li&gt;@Override&lt;/li&gt;
	&lt;li&gt;protected boolean doConnect(SocketChannel channel, InetSocketAddress address) throws IOException 
{
-                // Use a blocking connect to trigger the immediately connected path
-                channel.configureBlocking(true);
-                boolean connected = super.doConnect(channel, address);
-                channel.configureBlocking(false);
-                return connected;
-            }&lt;/li&gt;
	&lt;li&gt;};&lt;br/&gt;
+        Selector selector = new ImmediatelyConnectingSelector(5000, metrics, time, &quot;MetricGroup&quot;, channelBuilder, new LogContext());&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         try &lt;/p&gt;
{
             testImmediatelyConnectedCleaned(selector, true);
@@ -400,6 +392,26 @@ protected boolean doConnect(SocketChannel channel, InetSocketAddress address) th
         }
&lt;p&gt;     }&lt;/p&gt;

&lt;p&gt;+    private static class ImmediatelyConnectingSelector extends Selector {&lt;br/&gt;
+        public ImmediatelyConnectingSelector(long connectionMaxIdleMS,&lt;br/&gt;
+                                             Metrics metrics,&lt;br/&gt;
+                                             Time time,&lt;br/&gt;
+                                             String metricGrpPrefix,&lt;br/&gt;
+                                             ChannelBuilder channelBuilder,&lt;br/&gt;
+                                             LogContext logContext) &lt;/p&gt;
{
+            super(connectionMaxIdleMS, metrics, time, metricGrpPrefix, channelBuilder, logContext);
+        }
&lt;p&gt;+&lt;br/&gt;
+        @Override&lt;br/&gt;
+        protected boolean doConnect(SocketChannel channel, InetSocketAddress address) throws IOException &lt;/p&gt;
{
+            // Use a blocking connect to trigger the immediately connected path
+            channel.configureBlocking(true);
+            boolean connected = super.doConnect(channel, address);
+            channel.configureBlocking(false);
+            return connected;
+        }
&lt;p&gt;+    }&lt;br/&gt;
+&lt;br/&gt;
     private void testImmediatelyConnectedCleaned(Selector selector, boolean closeAfterFirstPoll) throws Exception &lt;/p&gt;
{
         String id = &quot;0&quot;;
         selector.connect(id, new InetSocketAddress(&quot;localhost&quot;, server.port), BUFFER_SIZE, BUFFER_SIZE);
@@ -412,6 +424,46 @@ private void testImmediatelyConnectedCleaned(Selector selector, boolean closeAft
         verifySelectorEmpty(selector);
     }

&lt;p&gt;+    /**&lt;br/&gt;
+     * Verify that if Selector#connect fails and throws an Exception, all related objects&lt;br/&gt;
+     * are cleared immediately before the exception is propagated.&lt;br/&gt;
+     */&lt;br/&gt;
+    @Test&lt;br/&gt;
+    public void testConnectException() throws Exception {&lt;br/&gt;
+        Metrics metrics = new Metrics();&lt;br/&gt;
+        AtomicBoolean throwIOException = new AtomicBoolean();&lt;br/&gt;
+        Selector selector = new ImmediatelyConnectingSelector(5000, metrics, time, &quot;MetricGroup&quot;, channelBuilder, new LogContext()) {&lt;br/&gt;
+            @Override&lt;br/&gt;
+            protected SelectionKey registerChannel(String id, SocketChannel socketChannel, int interestedOps) throws IOException &lt;/p&gt;
{
+                SelectionKey key = super.registerChannel(id, socketChannel, interestedOps);
+                key.cancel();
+                if (throwIOException.get())
+                    throw new IOException(&quot;Test exception&quot;);
+                return key;
+            }
&lt;p&gt;+        };&lt;br/&gt;
+&lt;br/&gt;
+        try &lt;/p&gt;
{
+            verifyImmediatelyConnectedException(selector, &quot;0&quot;);
+            throwIOException.set(true);
+            verifyImmediatelyConnectedException(selector, &quot;1&quot;);
+        }
&lt;p&gt; finally &lt;/p&gt;
{
+            selector.close();
+            metrics.close();
+        }
&lt;p&gt;+    }&lt;br/&gt;
+&lt;br/&gt;
+    private void verifyImmediatelyConnectedException(Selector selector, String id) throws Exception {&lt;br/&gt;
+        try &lt;/p&gt;
{
+            selector.connect(id, new InetSocketAddress(&quot;localhost&quot;, server.port), BUFFER_SIZE, BUFFER_SIZE);
+            fail(&quot;Expected exception not thrown&quot;);
+        }
&lt;p&gt; catch (Exception e) &lt;/p&gt;
{
+            verifyEmptyImmediatelyConnectedKeys(selector);
+            assertNull(&quot;Channel not removed&quot;, selector.channel(id));
+            ensureEmptySelectorFields(selector);
+        }
&lt;p&gt;+    }&lt;br/&gt;
+&lt;br/&gt;
     @Test&lt;br/&gt;
     public void testCloseOldestConnectionWithOneStagedReceive() throws Exception {&lt;br/&gt;
         verifyCloseOldestConnectionWithStagedReceives(1);&lt;br/&gt;
@@ -715,6 +767,10 @@ private void verifySelectorEmpty(Selector selector) throws Exception {&lt;br/&gt;
         }&lt;br/&gt;
         selector.poll(0);&lt;br/&gt;
         selector.poll(0); // Poll a second time to clear everything&lt;br/&gt;
+        ensureEmptySelectorFields(selector);&lt;br/&gt;
+    }&lt;br/&gt;
+&lt;br/&gt;
+    private void ensureEmptySelectorFields(Selector selector) throws Exception {&lt;br/&gt;
         for (Field field : Selector.class.getDeclaredFields()) &lt;/p&gt;
{
             ensureEmptySelectorField(selector, field);
         }




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 48 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|s01a3k:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>