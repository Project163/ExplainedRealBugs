<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:57:41 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-4384] ReplicaFetcherThread stopped after ReplicaFetcherThread received a corrupted message</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-4384</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;We recently discovered an issue in Kafka 0.9.0.1 (), where ReplicaFetcherThread stopped after ReplicaFetcherThread received a corrupted message. As the same logic exists also in Kafka 0.10.0.0 and 0.10.0.1, they may have the similar issue.&lt;/p&gt;

&lt;p&gt;Here are system logs related to this issue.&lt;br/&gt;
2016-10-30 - 02:33:05,606 ERROR ReplicaFetcherThread-5-1590174474 ReplicaFetcherThread.apply - Found invalid messages during fetch for partition &lt;span class=&quot;error&quot;&gt;&amp;#91;logs,41&amp;#93;&lt;/span&gt; offset 39021512238 error Message is corrupt (stored crc = 2028421553, computed crc = 3577227678)&lt;br/&gt;
2016-10-30 - 02:33:06,582 ERROR ReplicaFetcherThread-5-1590174474 ReplicaFetcherThread.error - &lt;span class=&quot;error&quot;&gt;&amp;#91;ReplicaFetcherThread-5-1590174474&amp;#93;&lt;/span&gt;, Error due to kafka.common.KafkaException: - error processing data for partition &lt;span class=&quot;error&quot;&gt;&amp;#91;logs,41&amp;#93;&lt;/span&gt; offset 39021512301 Caused - by: java.lang.RuntimeException: Offset mismatch: fetched offset = 39021512301, log end offset = 39021512238.&lt;/p&gt;

&lt;p&gt;First, ReplicaFetcherThread got a corrupted message (offset 39021512238) due to some blip.&lt;/p&gt;

&lt;p&gt;Line &lt;a href=&quot;https://github.com/apache/kafka/blob/0.9.0.1/core/src/main/scala/kafka/server/AbstractFetcherThread.scala#L138&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/0.9.0.1/core/src/main/scala/kafka/server/AbstractFetcherThread.scala#L138&lt;/a&gt; threw exception&lt;/p&gt;

&lt;p&gt;Then, Line &lt;a href=&quot;https://github.com/apache/kafka/blob/0.9.0.1/core/src/main/scala/kafka/server/AbstractFetcherThread.scala#L145&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/0.9.0.1/core/src/main/scala/kafka/server/AbstractFetcherThread.scala#L145&lt;/a&gt; caught it and logged this error.&lt;/p&gt;

&lt;p&gt;Because &lt;a href=&quot;https://github.com/apache/kafka/blob/0.9.0.1/core/src/main/scala/kafka/server/AbstractFetcherThread.scala#L134&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/0.9.0.1/core/src/main/scala/kafka/server/AbstractFetcherThread.scala#L134&lt;/a&gt; updated the topic partition offset to the fetched latest one in partitionMap. So ReplicaFetcherThread skipped the batch with corrupted messages. &lt;/p&gt;

&lt;p&gt;Based on &lt;a href=&quot;https://github.com/apache/kafka/blob/0.9.0.1/core/src/main/scala/kafka/server/AbstractFetcherThread.scala#L84&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/0.9.0.1/core/src/main/scala/kafka/server/AbstractFetcherThread.scala#L84&lt;/a&gt;, the ReplicaFetcherThread then directly fetched the next batch of messages (with offset 39021512301)&lt;/p&gt;

&lt;p&gt;Next, ReplicaFetcherThread stopped because the log end offset (still 39021512238) didn&apos;t match the fetched message (offset 39021512301).&lt;/p&gt;

&lt;p&gt;A quick fix is to move line 134 to be after line 138.&lt;/p&gt;

&lt;p&gt;Would be great to have your comments and please let me know if a Jira issue is needed. Thanks.&lt;/p&gt;</description>
                <environment>Ubuntu 12.04, AWS D2 instance</environment>
        <key id="13018635">KAFKA-4384</key>
            <summary>ReplicaFetcherThread stopped after ReplicaFetcherThread received a corrupted message</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="junhe">Jun He</assignee>
                                    <reporter username="junhe">Jun He</reporter>
                        <labels>
                    </labels>
                <created>Sat, 5 Nov 2016 19:01:52 +0000</created>
                <updated>Thu, 24 Nov 2016 14:58:25 +0000</updated>
                            <resolved>Thu, 24 Nov 2016 14:55:36 +0000</resolved>
                                    <version>0.9.0.1</version>
                    <version>0.10.0.0</version>
                    <version>0.10.0.1</version>
                    <version>0.10.1.0</version>
                                    <fixVersion>0.10.1.1</fixVersion>
                    <fixVersion>0.10.2.0</fixVersion>
                                    <component>core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15641511" author="becket_qin" created="Sun, 6 Nov 2016 09:56:36 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=junhe&quot; class=&quot;user-hover&quot; rel=&quot;junhe&quot;&gt;junhe&lt;/a&gt; Thanks for reporting the issue. Yes, this looks a bug and the fix plan sounds good to me. Would you provide a patch?&lt;/p&gt;</comment>
                            <comment id="15643648" author="junhe" created="Mon, 7 Nov 2016 09:44:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=becket_qin&quot; class=&quot;user-hover&quot; rel=&quot;becket_qin&quot;&gt;becket_qin&lt;/a&gt; Thanks for reviewing this issue. Yes I will provide the patch soon.&lt;/p&gt;</comment>
                            <comment id="15653241" author="junhe" created="Thu, 10 Nov 2016 06:57:15 +0000"  >&lt;p&gt;Patch for &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-4384&quot; title=&quot;ReplicaFetcherThread stopped after ReplicaFetcherThread received a corrupted message&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-4384&quot;&gt;&lt;del&gt;KAFKA-4384&lt;/del&gt;&lt;/a&gt; (ReplicaFetcherThread stopped after ReplicaFetcherThread received a corrupted message)&lt;/p&gt;</comment>
                            <comment id="15653249" author="junhe" created="Thu, 10 Nov 2016 07:00:24 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=becket_qin&quot; class=&quot;user-hover&quot; rel=&quot;becket_qin&quot;&gt;becket_qin&lt;/a&gt;, I have attached my patch including an unit test, please let me know if there is anything else I should do. Thanks.&lt;/p&gt;</comment>
                            <comment id="15654659" author="becket_qin" created="Thu, 10 Nov 2016 17:45:05 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=junhe&quot; class=&quot;user-hover&quot; rel=&quot;junhe&quot;&gt;junhe&lt;/a&gt; Thanks for the patch. Kafka actually uses github pull request for patch reviews. Could you submit a pull request on github following this process?&lt;br/&gt;
&lt;a href=&quot;https://cwiki.apache.org/confluence/display/KAFKA/Contributing+Code+Changes#ContributingCodeChanges-PullRequest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://cwiki.apache.org/confluence/display/KAFKA/Contributing+Code+Changes#ContributingCodeChanges-PullRequest&lt;/a&gt;&lt;br/&gt;
Thanks.&lt;/p&gt;
</comment>
                            <comment id="15659171" author="githubbot" created="Sat, 12 Nov 2016 06:58:20 +0000"  >&lt;p&gt;GitHub user jun-he opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/2127&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2127&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-4384&quot; title=&quot;ReplicaFetcherThread stopped after ReplicaFetcherThread received a corrupted message&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-4384&quot;&gt;&lt;del&gt;KAFKA-4384&lt;/del&gt;&lt;/a&gt;: ReplicaFetcherThread stopped after ReplicaFetcherThread received a corrupted message&lt;/p&gt;

&lt;p&gt;    @becketqin &lt;/p&gt;

&lt;p&gt;    Here is the patch for &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-4384&quot; title=&quot;ReplicaFetcherThread stopped after ReplicaFetcherThread received a corrupted message&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-4384&quot;&gt;&lt;del&gt;KAFKA-4384&lt;/del&gt;&lt;/a&gt; (ReplicaFetcherThread stopped after ReplicaFetcherThread received a corrupted message).&lt;/p&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/jun-he/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/jun-he/kafka&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-4384&quot; title=&quot;ReplicaFetcherThread stopped after ReplicaFetcherThread received a corrupted message&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-4384&quot;&gt;&lt;del&gt;KAFKA-4384&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/2127.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2127.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #2127&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 5eabb29d9f8036a2bf3c2955d129e69d93633395&lt;br/&gt;
Author: Jun He &amp;lt;jun.he@airbnb.com&amp;gt;&lt;br/&gt;
Date:   2016-11-12T05:30:37Z&lt;/p&gt;

&lt;p&gt;    Patch for &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-4384&quot; title=&quot;ReplicaFetcherThread stopped after ReplicaFetcherThread received a corrupted message&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-4384&quot;&gt;&lt;del&gt;KAFKA-4384&lt;/del&gt;&lt;/a&gt; (ReplicaFetcherThread stopped after ReplicaFetcherThread received a corrupted message)&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15659173" author="junhe" created="Sat, 12 Nov 2016 06:59:26 +0000"  >&lt;p&gt;Sure, here is the PR (&lt;a href=&quot;https://github.com/apache/kafka/pull/2127&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2127&lt;/a&gt;). Thanks.&lt;/p&gt;</comment>
                            <comment id="15691093" author="guozhang" created="Wed, 23 Nov 2016 19:15:40 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=junrao&quot; class=&quot;user-hover&quot; rel=&quot;junrao&quot;&gt;junrao&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ijuma&quot; class=&quot;user-hover&quot; rel=&quot;ijuma&quot;&gt;ijuma&lt;/a&gt; Do you think it should be in 0.10.1.1?&lt;/p&gt;</comment>
                            <comment id="15691103" author="ijuma" created="Wed, 23 Nov 2016 19:20:26 +0000"  >&lt;p&gt;I think so, the PR is close.&lt;/p&gt;</comment>
                            <comment id="15693463" author="githubbot" created="Thu, 24 Nov 2016 14:52:33 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/2127&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2127&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15693473" author="ijuma" created="Thu, 24 Nov 2016 14:55:36 +0000"  >&lt;p&gt;Issue resolved by pull request 2127&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/kafka/pull/2127&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2127&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12838305" name="KAFKA-4384.patch" size="5958" author="junhe" created="Thu, 10 Nov 2016 06:56:05 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 51 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i35yxj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>becket_qin</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>