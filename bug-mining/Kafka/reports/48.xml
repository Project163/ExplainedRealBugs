<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:35:03 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-320] testZKSendWithDeadBroker fails intermittently due to ZKNodeExistsException</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-320</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;The testZKSendWithDeadBroker inside ProducerTest fails intermittently with the following exception -&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;error&amp;#93;&lt;/span&gt; Test Failed: testZKSendWithDeadBroker(kafka.producer.ProducerTest)&lt;br/&gt;
java.lang.RuntimeException: A broker is already registered on the path /brokers/ids/0. This probably indicates that you either have configured a brokerid that is already in use, or else you have shutdown this broker and restarted it faster than the zookeeper timeout so it appears to be re-registering.&lt;br/&gt;
        at kafka.utils.ZkUtils$.registerBrokerInZk(ZkUtils.scala:109)&lt;br/&gt;
        at kafka.server.KafkaZooKeeper.kafka$server$KafkaZooKeeper$$registerBrokerInZk(KafkaZooKeeper.scala:60)&lt;br/&gt;
        at kafka.server.KafkaZooKeeper.startup(KafkaZooKeeper.scala:52)&lt;br/&gt;
        at kafka.server.KafkaServer.startup(KafkaServer.scala:84)&lt;br/&gt;
        at kafka.producer.ProducerTest.testZKSendWithDeadBroker(ProducerTest.scala:174)&lt;br/&gt;
        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)&lt;br/&gt;
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)&lt;br/&gt;
        at java.lang.reflect.Method.invoke(Method.java:597)&lt;br/&gt;
        at junit.framework.TestCase.runTest(TestCase.java:164)&lt;br/&gt;
        at junit.framework.TestCase.runBare(TestCase.java:130)&lt;br/&gt;
        at junit.framework.TestResult$1.protect(TestResult.java:110)&lt;br/&gt;
        at junit.framework.TestResult.runProtected(TestResult.java:128)&lt;br/&gt;
        at junit.framework.TestResult.run(TestResult.java:113)&lt;br/&gt;
        at junit.framework.TestCase.run(TestCase.java:120)&lt;br/&gt;
        at junit.framework.TestSuite.runTest(TestSuite.java:228)&lt;br/&gt;
        at junit.framework.TestSuite.run(TestSuite.java:223)&lt;br/&gt;
        at junit.framework.TestSuite.runTest(TestSuite.java:228)&lt;br/&gt;
        at junit.framework.TestSuite.run(TestSuite.java:223)&lt;br/&gt;
        at org.scalatest.junit.JUnit3Suite.run(JUnit3Suite.scala:309)&lt;br/&gt;
        at org.scalatest.tools.ScalaTestFramework$ScalaTestRunner.run(ScalaTestFramework.scala:40)&lt;br/&gt;
        at sbt.TestRunner.run(TestFramework.scala:53)&lt;br/&gt;
        at sbt.TestRunner.runTest$1(TestFramework.scala:67)&lt;br/&gt;
        at sbt.TestRunner.run(TestFramework.scala:76)&lt;br/&gt;
        at sbt.TestFramework$$anonfun$10$$anonfun$apply$11.runTest$2(TestFramework.scala:194)&lt;br/&gt;
        at sbt.TestFramework$$anonfun$10$$anonfun$apply$11$$anonfun$apply$12.apply(TestFramework.scala:205)&lt;br/&gt;
        at sbt.TestFramework$$anonfun$10$$anonfun$apply$11$$anonfun$apply$12.apply(TestFramework.scala:205)&lt;br/&gt;
        at sbt.NamedTestTask.run(TestFramework.scala:92)&lt;br/&gt;
        at sbt.ScalaProject$$anonfun$sbt$ScalaProject$$toTask$1.apply(ScalaProject.scala:193)&lt;br/&gt;
        at sbt.ScalaProject$$anonfun$sbt$ScalaProject$$toTask$1.apply(ScalaProject.scala:193)&lt;br/&gt;
        at sbt.TaskManager$Task.invoke(TaskManager.scala:62)&lt;br/&gt;
        at sbt.impl.RunTask.doRun$1(RunTask.scala:77)&lt;br/&gt;
        at sbt.impl.RunTask.runTask(RunTask.scala:85)&lt;br/&gt;
        at sbt.impl.RunTask.sbt$impl$RunTask$$runIfNotRoot(RunTask.scala:60)&lt;br/&gt;
        at sbt.impl.RunTask$$anonfun$runTasksExceptRoot$2.apply(RunTask.scala:48)&lt;br/&gt;
        at sbt.impl.RunTask$$anonfun$runTasksExceptRoot$2.apply(RunTask.scala:48)&lt;br/&gt;
        at sbt.Distributor$Run$Worker$$anonfun$2.apply(ParallelRunner.scala:131)&lt;br/&gt;
        at sbt.Distributor$Run$Worker$$anonfun$2.apply(ParallelRunner.scala:131)&lt;br/&gt;
        at sbt.Control$.trapUnit(Control.scala:19)&lt;br/&gt;
        at sbt.Distributor$Run$Worker.run(ParallelRunner.scala:131)&lt;/p&gt;

&lt;p&gt;The test basically restarts a server and fails with this exception during the restart&lt;/p&gt;

&lt;p&gt;This is unexpected, since server1, after shutting down, should trigger the deletion of its registration of the broker id from ZK. But, here is the Kafka bug causing this problem -&lt;/p&gt;

&lt;p&gt;In the test during server1.shutdown(), we do close the zkClient associated with the broker and it successfully deletes the broker&apos;s registration info from Zookeeper. After this, server1 can be succesfully started. Then the test completes and in the teardown(), we call server1.shutdown(). During this, the server doesn&apos;t really shutdown, since it is protected with the isShuttingDown variable, which was never set to false in the startup() API. Now, this leads to an open zkclient connection for the current test run. &lt;/p&gt;

&lt;p&gt;If you try to re-run ProducerTest without exiting sbt, it will first bring up the zookeeper server. Then, since the kafka server during the previous run is still running, it can succesfully renew its session with zookeeper, and retain the /brokers/ids/0 ephemeral node. If it does this before server1.startup() is called in the test, the test will fail.&lt;/p&gt;

&lt;p&gt;The fix is to set the shutdown related variables correctly in the startup API of KafkaServer. Also, during debugging this, I found that we don&apos;t close zkclient in the Producer as well. Due to this, unit tests throw a whole bunch of WARN that look like - &lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;2012-03-26 14:14:27,703&amp;#93;&lt;/span&gt; INFO Opening socket connection to server nnarkhed-ld /127.0.0.1:2182 (org.apache.zookeeper.ClientCnxn:1061)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2012-03-26 14:14:27,703&amp;#93;&lt;/span&gt; WARN Session 0x13650dbf8dd0005 for server null, unexpected error, closing socket connection and attempting reconnect (org.apache.zookeeper.ClientCnxn:1188)&lt;br/&gt;
java.net.ConnectException: Connection refused&lt;br/&gt;
        at sun.nio.ch.SocketChannelImpl.checkConnect(Native Method)&lt;br/&gt;
        at sun.nio.ch.SocketChannelImpl.finishConnect(SocketChannelImpl.java:567)&lt;br/&gt;
        at org.apache.zookeeper.ClientCnxn$SendThread.run(ClientCnxn.java:1146)&lt;/p&gt;</description>
                <environment></environment>
        <key id="12548191">KAFKA-320</key>
            <summary>testZKSendWithDeadBroker fails intermittently due to ZKNodeExistsException</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="nehanarkhede">Neha Narkhede</assignee>
                                    <reporter username="nehanarkhede">Neha Narkhede</reporter>
                        <labels>
                    </labels>
                <created>Mon, 26 Mar 2012 21:27:57 +0000</created>
                <updated>Sun, 8 Apr 2012 02:00:49 +0000</updated>
                            <resolved>Sun, 8 Apr 2012 02:00:49 +0000</resolved>
                                    <version>0.7</version>
                    <version>0.8.0</version>
                                                    <component>core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="13238871" author="nehanarkhede" created="Mon, 26 Mar 2012 21:36:02 +0000"  >&lt;p&gt;This patch includes the following -&lt;/p&gt;

&lt;p&gt;1. Fixes the kafka server restart bug by resetting the shutdown state variables in the startup() API of the KafkaServer. &lt;/p&gt;

&lt;p&gt;2. Shuts down the zkclient in the Producer&lt;/p&gt;

&lt;p&gt;3. ZkClient and Zookeeper can be set to WARN since we fixed the real issue, causing several warnings during the unit tests.&lt;/p&gt;</comment>
                            <comment id="13241383" author="nehanarkhede" created="Thu, 29 Mar 2012 16:53:44 +0000"  >&lt;p&gt;Can someone review this ?&lt;/p&gt;</comment>
                            <comment id="13241396" author="junrao" created="Thu, 29 Mar 2012 17:14:56 +0000"  >&lt;p&gt;That&apos;s a good finding. We should probably patch it in both trunk and 0.8. Just one comment.&lt;/p&gt;

&lt;p&gt;We should only allow a KafkaServer to startup if it has been shutdown.&lt;/p&gt;</comment>
                            <comment id="13241409" author="prashanth.menon" created="Thu, 29 Mar 2012 17:29:01 +0000"  >&lt;p&gt;Great catch!  +1, looks good and works on my machine.&lt;/p&gt;</comment>
                            <comment id="13241824" author="nehanarkhede" created="Thu, 29 Mar 2012 21:43:44 +0000"  >&lt;p&gt;OK, I made some more changes -&lt;/p&gt;

&lt;p&gt;1. Cleaned up zkClient instance creations in unit tests. Now it is wrapped up inside ZookeeperTestHarness, so we ensure that it gets cleanup at an appropriate time. &lt;/p&gt;

&lt;p&gt;2. Changed Kafka server startup and shutdown behavior. Possibly made it more complex. Basically, &lt;/p&gt;

&lt;p&gt;2.1 A Kafka server can startup if it is not already starting up, if it is not currently being shutdown, or if it hasn&apos;t been already started&lt;/p&gt;

&lt;p&gt;2.2 A Kafka server can shutdown if it is not already shutting down, if it is not currently starting up, or if it hasn&apos;t been already shutdown. &lt;/p&gt;</comment>
                            <comment id="13244395" author="junrao" created="Mon, 2 Apr 2012 18:11:12 +0000"  >&lt;p&gt;The ZookeeperTestHarness change looks nice. a couple more comments:&lt;/p&gt;

&lt;p&gt;4. KafkaServer: It does look  a bit more complex now and some of the testing is not done atomically. How about the following? &lt;br/&gt;
4.1 add an AtomticBoolean isServerStartable and initialize to true;&lt;br/&gt;
4.2 in startup(), if we can atomically set isServerStartable from true to false, proceed with startup; otherwise throw an exception.&lt;br/&gt;
4.3 in shutdown(), if isServerStartable is false, proceed with shutdown, at the very end, set isServerStartable to true. &lt;br/&gt;
Startup() and shutdown() are expected to be called from the same thread. So we can expect a shutdown won&apos;t be called until a startup completes.&lt;/p&gt;

&lt;p&gt;5. SyncProducerTest: unused imports&lt;/p&gt;</comment>
                            <comment id="13244425" author="nehanarkhede" created="Mon, 2 Apr 2012 18:37:35 +0000"  >&lt;p&gt;Thanks for the review!&lt;/p&gt;

&lt;p&gt;4. Regarding this, what do people think about the conditions under which a Kafka server should be allowed to startup and shutdown (listed under 2.1 and 2.2 above) ?&lt;br/&gt;
5. Will fix this before checkin.&lt;br/&gt;
6. Also, looks like improving the kafka server startup and shutdown is orthogonal to this bug fix. Can this be fixed (cleanly) through another JIRA ? I&apos;d like to include just the fix for this issue as part of the checkin. &lt;/p&gt;</comment>
                            <comment id="13244965" author="junrao" created="Tue, 3 Apr 2012 04:30:26 +0000"  >&lt;p&gt;Yes, we can use another jira to see how we can improve kafka server startup and shutdown. For this jira, we can just make minimal changes in kafka server.&lt;/p&gt;</comment>
                            <comment id="13248660" author="nehanarkhede" created="Fri, 6 Apr 2012 19:54:58 +0000"  >&lt;p&gt;Filed &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-328&quot; title=&quot;Write unit test for kafka server startup and shutdown API &quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-328&quot;&gt;&lt;del&gt;KAFKA-328&lt;/del&gt;&lt;/a&gt; for improving startup and shutdown API of Kafka server.&lt;/p&gt;

&lt;p&gt;Kept everything in v2 minus the complexity of changes in Kafka server.&lt;/p&gt;</comment>
                            <comment id="13248921" author="junrao" created="Fri, 6 Apr 2012 22:04:56 +0000"  >&lt;p&gt;Overall, patch v3 looks good. I made a minor tweak of KafkaServer on top of v3. How does that look? You will need to:&lt;br/&gt;
1. apply patch v3&lt;br/&gt;
2. svn revert core/src/main/scala/kafka/server/KafkaServer.scala&lt;br/&gt;
3. apply patch kafka-320-v3-delta.patch&lt;/p&gt;</comment>
                            <comment id="13249098" author="nehanarkhede" created="Sat, 7 Apr 2012 00:39:33 +0000"  >&lt;p&gt;After applying the v3-delta patch, I see that some zkclient connections are not closed cleanly - &lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2012-04-06 17:34:12,805&amp;#93;&lt;/span&gt; WARN Exception causing close of session 0x0 due to java.io.IOException: ZooKeeperServer not running (org.apache.zookeeper&lt;br/&gt;
.server.NIOServerCnxn:639)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2012-04-06 17:34:12,809&amp;#93;&lt;/span&gt; WARN Exception causing close of session 0x0 due to java.io.IOException: ZooKeeperServer not running (org.apache.zookeeper&lt;br/&gt;
.server.NIOServerCnxn:639)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2012-04-06 17:34:13,201&amp;#93;&lt;/span&gt; WARN EndOfStreamException: Unable to read additional data from client sessionid 0x1368a38c37a0005, likely client has clos&lt;br/&gt;
ed socket (org.apache.zookeeper.server.NIOServerCnxn:634)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2012-04-06 17:34:13,264&amp;#93;&lt;/span&gt; WARN EndOfStreamException: Unable to read additional data from client sessionid 0x1368a38a86a0080, likely client has clos&lt;br/&gt;
ed socket (org.apache.zookeeper.server.NIOServerCnxn:634)&lt;/p&gt;

&lt;p&gt;Also, after you set the isShutdown variable and before you check canStart, there can be interleaving between startup and shutdown, that can lead to open zookeeper client connection.&lt;/p&gt;</comment>
                            <comment id="13249129" author="junrao" created="Sat, 7 Apr 2012 02:05:22 +0000"  >&lt;p&gt;Ok, we can take v3 for now and track the broker startup/shutdown in kafka-328.&lt;/p&gt;</comment>
                            <comment id="13249459" author="nehanarkhede" created="Sun, 8 Apr 2012 02:00:49 +0000"  >&lt;p&gt;Checked into trunk and 0.8 branch&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12520518" name="kafka-320-v2.patch" size="31989" author="nehanarkhede" created="Thu, 29 Mar 2012 21:43:44 +0000"/>
                            <attachment id="12521772" name="kafka-320-v3-delta.patch" size="2025" author="junrao" created="Fri, 6 Apr 2012 22:04:56 +0000"/>
                            <attachment id="12521721" name="kafka-320-v3.patch" size="25942" author="nehanarkhede" created="Fri, 6 Apr 2012 19:54:58 +0000"/>
                            <attachment id="12520016" name="kafka-320.patch" size="2568" author="nehanarkhede" created="Mon, 26 Mar 2012 21:36:02 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>233288</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 33 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i09m8v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>54037</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>