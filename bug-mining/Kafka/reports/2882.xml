<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:26:38 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-10793] Race condition in FindCoordinatorFuture permanently severs connection to group coordinator</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-10793</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Pretty much as soon as we started actively monitoring the &lt;em&gt;last-rebalance-seconds-ago&lt;/em&gt; metric in our Kafka Streams test environment, we started seeing something weird. Every so often one of the StreamThreads (ie a single Consumer instance) would appear to permanently fall out of the group, as evidenced by a monotonically increasing&#160;&lt;em&gt;last-rebalance-seconds-ago.&lt;/em&gt; We inject artificial network failures every few hours at most, so the group rebalances quite often. But the one consumer never rejoins, with no other symptoms (besides a slight drop in throughput since the remaining threads had to take over this member&apos;s work). We&apos;re confident that the problem exists in the client layer, since the logs confirmed that the unhealthy consumer was still calling poll. It was also calling Consumer#committed in its main poll loop, which was consistently failing with a TimeoutException.&lt;/p&gt;

&lt;p&gt;When I attached a remote debugger to an instance experiencing this issue, the network client&apos;s connection to the group coordinator (the one that uses MAX_VALUE - node.id as the coordinator id) was in the DISCONNECTED state. But for some reason it never tried to re-establish this connection, although it did successfully connect to that same broker through the &quot;normal&quot; connection (ie the one that juts uses node.id).&lt;/p&gt;

&lt;p&gt;The tl;dr is that the AbstractCoordinator&apos;s FindCoordinatorRequest&#160;has failed (presumably due to a disconnect), but the &lt;em&gt;findCoordinatorFuture&lt;/em&gt;&#160;is non-null so a new request is never sent. This shouldn&apos;t be possible since the&#160;FindCoordinatorResponseHandler is supposed to clear the&#160;&lt;em&gt;findCoordinatorFuture&lt;/em&gt;&#160;when the future is completed. But somehow that didn&apos;t happen, so the consumer continues to assume there&apos;s still a FindCoordinator request in flight and never even notices that it&apos;s dropped out of the group.&lt;/p&gt;

&lt;p&gt;These are the only confirmed findings so far, however we have some guesses which I&apos;ll leave in the comments. Note that we only noticed this due to the newly added&#160;&lt;em&gt;last-rebalance-seconds-ago&lt;/em&gt;&#160;__metric, and there&apos;s no reason to believe this bug hasn&apos;t been flying under the radar since the Consumer&apos;s inception&lt;/p&gt;</description>
                <environment></environment>
        <key id="13343668">KAFKA-10793</key>
            <summary>Race condition in FindCoordinatorFuture permanently severs connection to group coordinator</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ableegoldman">A. Sophie Blee-Goldman</assignee>
                                    <reporter username="ableegoldman">A. Sophie Blee-Goldman</reporter>
                        <labels>
                            <label>new-consumer-threading-should-fix</label>
                    </labels>
                <created>Wed, 2 Dec 2020 01:10:34 +0000</created>
                <updated>Fri, 11 Feb 2022 07:31:07 +0000</updated>
                            <resolved>Wed, 27 Jan 2021 03:08:45 +0000</resolved>
                                    <version>2.5.0</version>
                                    <fixVersion>2.6.2</fixVersion>
                    <fixVersion>2.7.1</fixVersion>
                    <fixVersion>2.8.0</fixVersion>
                                    <component>consumer</component>
                    <component>streams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="17241976" author="ableegoldman" created="Wed, 2 Dec 2020 01:36:53 +0000"  >&lt;p&gt;At this point we can only guess, but all signs point to a race condition between the main consumer thread and the heartbeat thread. One possibility is that when the future failed it just didn&apos;t trigger the `onFailure` callback, but&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt;&#160;&amp;amp; I have both looked through the source code and don&apos;t see any way for this to occur. Another possibility is that the `onFailure` callback was triggered, but it was invoked too soon. If the future was completed before we ever assigned it to the&#160;&lt;em&gt;findCoordinatorFuture&lt;/em&gt;&#160;field, then we would never actually clear the latest future (we would just set an already-null field to null again).&lt;/p&gt;

&lt;p&gt;Is this possible? Here&apos;s how the AbstractCoordinator builds the request and assigns the future:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; RequestFuture&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Void&lt;/span&gt;&amp;gt; lookupCoordinator() {
    ...
    findCoordinatorFuture = sendFindCoordinatorRequest(node);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; RequestFuture&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Void&lt;/span&gt;&amp;gt; sendFindCoordinatorRequest(Node node) {
    ...
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; client.send(node, requestBuilder)
       .compose(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; FindCoordinatorResponseHandler());&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Inside #compose we call #addListener, which contains this snippet:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (failed()) 
    fireFailure(); 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;If the request has already failed by the time we reach this, then we&apos;ll trigger the `onFailure` callback before #compose ever returns &#8211; ie before we&apos;ve assigned the future to&#160;&lt;em&gt;findCoordinatorFuture&lt;/em&gt;.&lt;/p&gt;

&lt;p&gt;The obvious question now is whether it&apos;s possible for the request to be failed in another thread while one thread is in the middle of the synchronized lookupCoordinator(). The request can be failed by the ConsumerNetworkClient when polled, during&#160;checkDisconnects(). The heartbeat thread actually synchronizes the entire run loop, so it doesn&apos;t seem possible for the hb thread to fail this request in the background of the main thread during a lookupCoordinator().&lt;/p&gt;

&lt;p&gt;But the inverse is not true: it&apos;s possible for the main consumer thread to fail the request while the hb thread is inside of lookupCoordinator(). The AbstractCoordinator will poll the network client inside of&#160;joinGroupIfNeeded(), which in not itself synchronized and may be invoked without any locking through a Consumer#poll.&#160;&lt;/p&gt;</comment>
                            <comment id="17241985" author="jack-lee" created="Wed, 2 Dec 2020 01:47:45 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ableegoldman&quot; class=&quot;user-hover&quot; rel=&quot;ableegoldman&quot;&gt;ableegoldman&lt;/a&gt; I want to check whether the heartbeat Thread will check the status , thanks. &lt;/p&gt;</comment>
                            <comment id="17241987" author="ableegoldman" created="Wed, 2 Dec 2020 01:50:35 +0000"  >&lt;p&gt;So that&apos;s our best guess. We should discuss the solution on the PR, but I&apos;ll lay out the two possibilities I see here in case anyone has any better ideas.&lt;/p&gt;

&lt;p&gt;1) synchronize joinGroupIfNeeded()&lt;br/&gt;
2) clear the&#160;&lt;em&gt;findCoordinatorFuture&lt;/em&gt;&#160;when handling the result, rather than in the listener callbacks. For example in the main loop of ensureCoordinatorReady()&lt;/p&gt;

&lt;p&gt;Personally I think option 2 is better, since it makes a lot more sense to me to begin with. By clearing the future in the listener callbacks, we might clear it before we ever even get to check on the result, eg the exception if failed. We actually seem to already anticipate this particular problem and recently implemented a workaround by adding an extra listener which saves the exception to a class&#160;&lt;em&gt;findCoordinatorException&lt;/em&gt; field. If we just wait to clear the future then presumably we could remove this workaround as well, and just save the exception when we check&#160;&quot;if (future.failed())&quot; inside of lookupCoordinator().&lt;/p&gt;

&lt;p&gt;All that said, I&apos;m not intimately familiar with the technical details of the ConsumerNetworkClient and how it handles its RequestFutures, so it&apos;s possible I&apos;m missing something important.&lt;/p&gt;</comment>
                            <comment id="17274187" author="guozhang" created="Fri, 29 Jan 2021 06:56:23 +0000"  >&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hachikuji&quot; class=&quot;user-hover&quot; rel=&quot;hachikuji&quot;&gt;hachikuji&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ijuma&quot; class=&quot;user-hover&quot; rel=&quot;ijuma&quot;&gt;ijuma&lt;/a&gt; Hopefully we nailed it this time! &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13419017">KAFKA-13563</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 41 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0l408:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>