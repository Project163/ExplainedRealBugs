<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:53:08 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-3310] fetch requests can trigger repeated NPE when quota is enabled</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-3310</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;We saw the following NPE when consumer quota is enabled. NPE is triggered on every fetch request from the client.&lt;/p&gt;

&lt;p&gt;java.lang.NullPointerException&lt;br/&gt;
        at kafka.server.ClientQuotaManager.recordAndMaybeThrottle(ClientQuotaManager.scala:122)&lt;br/&gt;
        at kafka.server.KafkaApis.kafka$server$KafkaApis$$sendResponseCallback$3(KafkaApis.scala:419)&lt;br/&gt;
        at kafka.server.KafkaApis$$anonfun$handleFetchRequest$1.apply(KafkaApis.scala:436)&lt;br/&gt;
        at kafka.server.KafkaApis$$anonfun$handleFetchRequest$1.apply(KafkaApis.scala:436)&lt;br/&gt;
        at kafka.server.ReplicaManager.fetchMessages(ReplicaManager.scala:481)&lt;br/&gt;
        at kafka.server.KafkaApis.handleFetchRequest(KafkaApis.scala:431)&lt;br/&gt;
        at kafka.server.KafkaApis.handle(KafkaApis.scala:69)&lt;br/&gt;
        at kafka.server.KafkaRequestHandler.run(KafkaRequestHandler.scala:60)&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:745)&lt;/p&gt;

&lt;p&gt;One possible cause of this is the logic of removing inactive sensors. Currently, in ClientQuotaManager, we create two sensors per clientId: a throttleTimeSensor and a quotaSensor. Each sensor expires if it&apos;s not actively updated for 1 hour. What can happen is that initially, the quota is not exceeded. So, quotaSensor is being updated actively, but throttleTimeSensor is not. At some point, throttleTimeSensor is removed by the expiring thread. Now, we are in a situation that quotaSensor is registered, but throttleTimeSensor is not. Later on, if the quota is exceeded, we will hit the above NPE when trying to update throttleTimeSensor.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12945687">KAFKA-3310</key>
            <summary>fetch requests can trigger repeated NPE when quota is enabled</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="aauradkar">Aditya Auradkar</assignee>
                                    <reporter username="junrao">Jun Rao</reporter>
                        <labels>
                    </labels>
                <created>Tue, 1 Mar 2016 00:10:03 +0000</created>
                <updated>Fri, 4 Mar 2016 00:17:28 +0000</updated>
                            <resolved>Fri, 4 Mar 2016 00:17:19 +0000</resolved>
                                    <version>0.9.0.0</version>
                    <version>0.9.0.1</version>
                                    <fixVersion>0.10.0.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="15172950" author="junrao" created="Tue, 1 Mar 2016 00:11:06 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aauradkar&quot; class=&quot;user-hover&quot; rel=&quot;aauradkar&quot;&gt;aauradkar&lt;/a&gt;, do you think this is a problem?&lt;/p&gt;</comment>
                            <comment id="15173204" author="aauradkar" created="Tue, 1 Mar 2016 04:09:55 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=junrao&quot; class=&quot;user-hover&quot; rel=&quot;junrao&quot;&gt;junrao&lt;/a&gt; - Let me investigate this. If this is a problem, it should be easy to fix by recording 0 on the throttle time sensor everytime. &lt;/p&gt;</comment>
                            <comment id="15173223" author="aauradkar" created="Tue, 1 Mar 2016 04:52:12 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=junrao&quot; class=&quot;user-hover&quot; rel=&quot;junrao&quot;&gt;junrao&lt;/a&gt; - Just making sure, you observe that the response is still delayed right? The throttle time sensor is the last thing that is recorded and the element has been added to the delay queue, so the fetchResponseCallback should fire after the throttle time. &lt;/p&gt;</comment>
                            <comment id="15173295" author="junrao" created="Tue, 1 Mar 2016 06:18:18 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aauradkar&quot; class=&quot;user-hover&quot; rel=&quot;aauradkar&quot;&gt;aauradkar&lt;/a&gt;, that depends. In this case, the NPE is triggered directly when handling the fetch request in KafkaApis. The throttle time sensor is actually recorded before we add the request to the delay queue. So, we will send an empty fetch response with an unexpected error. However, the same NPE could be triggered when we try to complete a fetch request from the fetch purgatory. In this case, we won&apos;t even be able to send a fetch response. So the fetch request will timeout. What&apos;s worse is that there could be other fetch requests (both consumer and follower) in the fetch purgatory off the same key. Since we hit the unexpected exception while evaluating the completeness of this particular fetch request, we will skip the checking of other fetch requests on the same chain and therefore may delay other fetch requests.&lt;/p&gt;

&lt;p&gt;It seems that this problem can show up pretty easily. Just upgrade the broker to 0.9.0, start a consumer, wait for more than an hour, then set the consumer quota. If the consumer fetch request is now throttled, we will hit the NPE.&lt;/p&gt;

&lt;p&gt;Recording 0 on the throttled time sensor probably fixes most of the problem, but I am not sure if it fixes this completely. Since these two sensors are not updated at exactly the same time, it seems that it&apos;s still possible for throttled time sensor to expire before quota sensor?&lt;/p&gt;</comment>
                            <comment id="15174365" author="githubbot" created="Tue, 1 Mar 2016 20:29:25 +0000"  >&lt;p&gt;GitHub user auradkar opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/989&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/989&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3310&quot; title=&quot;fetch requests can trigger repeated NPE when quota is enabled&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3310&quot;&gt;&lt;del&gt;KAFKA-3310&lt;/del&gt;&lt;/a&gt;: Fix for NPEs observed when throttling clients.&lt;/p&gt;

&lt;p&gt;    The fix basically ensures that the throttleTimeSensor is non-null before handing off to record the metric value. We also record the throttle time to 0 so that we don&apos;t recreate the sensor always.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/auradkar/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/auradkar/kafka&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3310&quot; title=&quot;fetch requests can trigger repeated NPE when quota is enabled&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3310&quot;&gt;&lt;del&gt;KAFKA-3310&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/989.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/989.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #989&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit cd5007eb3c94ae2d1983cc6a4b9a9fe4e96ff1b1&lt;br/&gt;
Author: Aditya Auradkar &amp;lt;aauradkar@linkedin.com&amp;gt;&lt;br/&gt;
Date:   2016-03-01T20:18:59Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3310&quot; title=&quot;fetch requests can trigger repeated NPE when quota is enabled&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3310&quot;&gt;&lt;del&gt;KAFKA-3310&lt;/del&gt;&lt;/a&gt;: Fix for NPEs observed when throttling clients.&lt;/p&gt;

&lt;p&gt;    The fix basically ensures that the throttleTimeSensor is non-null before handing off to record the metric value. We also record the throttle time to 0 so that we don&apos;t recreate the sensor always.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15174366" author="aauradkar" created="Tue, 1 Mar 2016 20:29:56 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=junrao&quot; class=&quot;user-hover&quot; rel=&quot;junrao&quot;&gt;junrao&lt;/a&gt; - can you take a look?&lt;/p&gt;</comment>
                            <comment id="15179000" author="junrao" created="Fri, 4 Mar 2016 00:17:19 +0000"  >&lt;p&gt;Issue resolved by pull request 989&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/kafka/pull/989&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/989&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15179001" author="githubbot" created="Fri, 4 Mar 2016 00:17:28 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/989&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/989&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 37 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2ty93:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>junrao</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>