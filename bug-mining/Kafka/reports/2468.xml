<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:21:42 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-9144] Early expiration of producer state can cause coordinator epoch to regress</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-9144</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Transaction markers are written by the transaction coordinator. In order to fence zombie coordinators, we use the leader epoch associated with the coordinator partition. Partition leaders verify the epoch in the WriteTxnMarker request and ensure that it can only increase. However, when producer state expires, we stop tracking the epoch and it is possible for monotonicity to be violated. Generally we expect expiration to be on the order of days, so it should be unlikely for this to be a problem.&lt;/p&gt;

&lt;p&gt;At least that is the theory. We observed a case where a coordinator epoch decreased between nearly consecutive writes within a couple minutes of each other. Upon investigation, we found that producer state had been incorrectly expired. We believe the sequence of events is the following:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Producer writes transactional data and fails before committing&lt;/li&gt;
	&lt;li&gt;Coordinator times out the transaction and writes ABORT markers&lt;/li&gt;
	&lt;li&gt;Upon seeing the ABORT and the bumped epoch, the partition leader deletes state from the last epoch, which effectively resets the last timestamp for the producer to -1.&lt;/li&gt;
	&lt;li&gt;The coordinator becomes a zombie before getting a successful response and continues trying to send&lt;/li&gt;
	&lt;li&gt;The new coordinator notices the incomplete transaction and also sends markers&lt;/li&gt;
	&lt;li&gt;The partition leader accepts the write from the new coordinator&lt;/li&gt;
	&lt;li&gt;The producer state is expired because the last timestamp was -1&lt;/li&gt;
	&lt;li&gt;The partition leader accepts the write from the old coordinator&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Basically it takes an alignment of planets to hit this bug, but it is possible. If you hit it, then the broker may be unable to start because we validate epoch monotonicity during log recovery. The problem is in 3 when the timestamp gets reset. We should use the timestamp from the marker instead.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13266382">KAFKA-9144</key>
            <summary>Early expiration of producer state can cause coordinator epoch to regress</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hachikuji">Jason Gustafson</assignee>
                                    <reporter username="hachikuji">Jason Gustafson</reporter>
                        <labels>
                    </labels>
                <created>Tue, 5 Nov 2019 17:17:06 +0000</created>
                <updated>Sat, 26 Aug 2023 11:54:39 +0000</updated>
                            <resolved>Thu, 9 Jan 2020 21:59:44 +0000</resolved>
                                    <version>2.0.1</version>
                    <version>2.1.1</version>
                    <version>2.2.2</version>
                    <version>2.3.1</version>
                    <version>2.4.0</version>
                                    <fixVersion>2.2.3</fixVersion>
                    <fixVersion>2.3.2</fixVersion>
                    <fixVersion>2.4.1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16968636" author="guozhang" created="Wed, 6 Nov 2019 19:26:44 +0000"  >&lt;p&gt;Looked through the code and I agree we should indeed not reset timestamp to -1 but to a more reasonable time like the marker&apos;s timestamp in step 3.&lt;/p&gt;</comment>
                            <comment id="16973046" author="githubbot" created="Wed, 13 Nov 2019 06:18:14 +0000"  >&lt;p&gt;hachikuji commented on pull request #7687: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-9144&quot; title=&quot;Early expiration of producer state can cause coordinator epoch to regress&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-9144&quot;&gt;&lt;del&gt;KAFKA-9144&lt;/del&gt;&lt;/a&gt;; Track timestamp from txn markers to prevent early producer expiration&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/7687&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/7687&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Existing producer state expiration uses timestamps from data records only and not from transaction markers. This can cause premature producer expiration when the coordinator times out a transaction because we drop the state from existing batches. This patch fixes the problem by also leveraging the timestamp from transaction markers. &lt;/p&gt;

&lt;p&gt;   We also change the validation logic so that coordinator epoch is verified only for new marker appends. When replicating from the leader and when recovering the log, we only log a warning if we notice that the coordinator epoch has gone backwards. This allows recovery from previous occurrences of this bug.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="17012247" author="githubbot" created="Thu, 9 Jan 2020 21:47:31 +0000"  >&lt;p&gt;hachikuji commented on pull request #7687: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-9144&quot; title=&quot;Early expiration of producer state can cause coordinator epoch to regress&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-9144&quot;&gt;&lt;del&gt;KAFKA-9144&lt;/del&gt;&lt;/a&gt;; Track timestamp from txn markers to prevent early producer expiration&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/7687&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/7687&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="17058443" author="hachikuji" created="Fri, 13 Mar 2020 05:53:42 +0000"  >&lt;p&gt;We found that this bug can also result in a hanging transaction. We had one instance of this and found the following in the log dump:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
baseOffset: 21830 lastOffset: 21830 count: 1 baseSequence: -1 lastSequence: -1 producerId: 15038 producerEpoch: 17 partitionLeaderEpoch: 7 isTransactional: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; isControl: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; position: 499861 CreateTime: 1566838946496 size: 78 magic: 2 compresscodec: NONE crc: 4211809197 isvalid: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
| offset: 21830 CreateTime: 1566838946496 keysize: 4 valuesize: 6 sequence: -1 headerKeys: [] endTxnMarker: COMMIT coordinatorEpoch: 7

baseOffset: 22401 lastOffset: 22401 count: 1 baseSequence: -1 lastSequence: -1 producerId: 15038 producerEpoch: 19 partitionLeaderEpoch: 7 isTransactional: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; isControl: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; position: 600640 CreateTime: 1566857918542 size: 78 magic: 2 compresscodec: NONE crc: 1432605016 isvalid: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
| offset: 22401 CreateTime: 1566857918542 keysize: 4 valuesize: 6 sequence: -1 headerKeys: [] endTxnMarker: ABORT coordinatorEpoch: 7

baseOffset: 22422 lastOffset: 22422 count: 1 baseSequence: 0 lastSequence: 0 producerId: 15038 producerEpoch: 18 partitionLeaderEpoch: 7 isTransactional: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; isControl: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt; position: 606629 CreateTime: 1566858389995 size: 187 magic: 2 compresscodec: LZ4 crc: 286798916 isvalid: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
| offset: 22422 CreateTime: 1566858389995 keysize: 83 valuesize: 24 sequence: 0 headerKeys: []
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The interesting thing to note is that the producer epoch went backwards. What we believe happened is the following:&lt;/p&gt;

&lt;p&gt;1. producer opens a transaction with epoch 18 but loses communication with the cluster&lt;br/&gt;
2. coordinator decides to abort the transaction, so bumps the epoch to 19 and writes markers&lt;br/&gt;
3. due to the bug in this JIRA, producer state is cleaned up before proper expiration&lt;br/&gt;
4. the producer who is now a zombie tries to write with epoch 18.&lt;br/&gt;
5. the broker accepts the write because the sequence is 0 and previous state has been expired&lt;/p&gt;

&lt;p&gt;Following this sequence, the transaction would be left open because it was appended to the log after it had been aborted. &lt;/p&gt;</comment>
                            <comment id="17210714" author="mbaluta" created="Fri, 9 Oct 2020 08:16:26 +0000"  >&lt;p&gt;We faced the same behavior on version 2.5.0 (from time to time), as a result it affects compaction on __consumer_offsets topic partitions&#160;&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-10501&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-10501&lt;/a&gt;&#160;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310660">
                    <name>Completes</name>
                                            <outwardlinks description="fixes">
                                        <issuelink>
            <issuekey id="13228394">KAFKA-8242</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13202062">KAFKA-7698</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13250832">KAFKA-8803</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13406494">KAFKA-13375</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 5 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z08a4w:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>