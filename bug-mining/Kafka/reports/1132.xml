<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:55:30 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-3924] Data loss due to halting when LEO is larger than leader&apos;s LEO</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-3924</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Currently the follower broker panics when its LEO is larger than its leader&apos;s LEO,  and assuming that this is an impossible state to reach, halts the process to prevent any further damage.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (leaderEndOffset &amp;lt; replica.logEndOffset.messageOffset) {
      &lt;span class=&quot;code-comment&quot;&gt;// Prior to truncating the follower&apos;s log, ensure that doing so is not disallowed by the configuration &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; unclean leader election.
&lt;/span&gt;      &lt;span class=&quot;code-comment&quot;&gt;// This situation could only happen &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; the unclean election configuration &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; a topic changes &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; a replica is down. Otherwise,
&lt;/span&gt;      &lt;span class=&quot;code-comment&quot;&gt;// we should never encounter &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; situation since a non-ISR leader cannot be elected &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; disallowed by the broker configuration.
&lt;/span&gt;      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!LogConfig.fromProps(brokerConfig.originals, AdminUtils.fetchEntityConfig(replicaMgr.zkUtils,
        ConfigType.Topic, topicAndPartition.topic)).uncleanLeaderElectionEnable) {
        &lt;span class=&quot;code-comment&quot;&gt;// Log a fatal error and shutdown the broker to ensure that data loss does not unexpectedly occur.
&lt;/span&gt;        fatal(&lt;span class=&quot;code-quote&quot;&gt;&quot;...&quot;&lt;/span&gt;)
        &lt;span class=&quot;code-object&quot;&gt;Runtime&lt;/span&gt;.getRuntime.halt(1)
      }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Firstly this assumption is invalid and there are legitimate cases (examples below) that this case could actually occur. Secondly halt results into the broker losing its un-flushed data, and if multiple brokers halt simultaneously there is a chance that both leader and followers of a partition are among the halted brokers, which would result into permanent data loss.&lt;/p&gt;

&lt;p&gt;Given that this is a legit case, we suggest to replace it with a graceful shutdown to avoid propagating data loss to the entire cluster.&lt;/p&gt;

&lt;p&gt;Details:&lt;br/&gt;
One legit case that this could actually occur is when a troubled broker shrinks its partitions right before crashing (&lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3410&quot; title=&quot;Unclean leader election and &amp;quot;Halting because log truncation is not allowed&amp;quot;&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3410&quot;&gt;&lt;del&gt;KAFKA-3410&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3861&quot; title=&quot;Shrunk ISR before leader crash makes the partition unavailable&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3861&quot;&gt;KAFKA-3861&lt;/a&gt;). In this case the broker has lost some data but the controller cannot still elects the others as the leader. If the crashed broker comes back up, the controller elects it as the leader, and as a result all other brokers who are now following it halt since they have LEOs larger than that of shrunk topics in the restarted broker.  We actually had a case that bringing up a crashed broker simultaneously took down the entire cluster and as explained above this could result into data loss.&lt;/p&gt;

&lt;p&gt;The other legit case is when multiple brokers ungracefully shutdown at the same time. In this case both of the leader and the followers lose their un-flushed data but one of them has HW larger than the other. Controller elects the one who comes back up sooner as the leader and if its LEO is less than its future follower, the follower will halt (and probably lose more data). Simultaneous ungrateful shutdown could happen due to hardware issue (e.g., rack power failure), operator errors, or software issue (e.g., the case above that is further explained in &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3410&quot; title=&quot;Unclean leader election and &amp;quot;Halting because log truncation is not allowed&amp;quot;&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3410&quot;&gt;&lt;del&gt;KAFKA-3410&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3861&quot; title=&quot;Shrunk ISR before leader crash makes the partition unavailable&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3861&quot;&gt;KAFKA-3861&lt;/a&gt; and causes simultaneous halts in multiple brokers)&lt;/p&gt;</description>
                <environment></environment>
        <key id="12986331">KAFKA-3924</key>
            <summary>Data loss due to halting when LEO is larger than leader&apos;s LEO</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="maysamyabandeh">Maysam Yabandeh</assignee>
                                    <reporter username="maysamyabandeh">Maysam Yabandeh</reporter>
                        <labels>
                            <label>reliability</label>
                    </labels>
                <created>Fri, 1 Jul 2016 21:23:52 +0000</created>
                <updated>Thu, 2 Feb 2017 23:24:48 +0000</updated>
                            <resolved>Wed, 27 Jul 2016 15:22:54 +0000</resolved>
                                    <version>0.10.0.0</version>
                                    <fixVersion>0.10.0.1</fixVersion>
                                    <component>core</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>13</watches>
                                                                                                                <comments>
                            <comment id="15383035" author="githubbot" created="Mon, 18 Jul 2016 20:52:16 +0000"  >&lt;p&gt;GitHub user maysamyabandeh opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/1634&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/1634&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3924&quot; title=&quot;Data loss due to halting when LEO is larger than leader&amp;#39;s LEO&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3924&quot;&gt;&lt;del&gt;KAFKA-3924&lt;/del&gt;&lt;/a&gt;: Replacing halt with exit upon LEO mismatch to trigger gra&#8230;&lt;/p&gt;

&lt;p&gt;    &#8230;ceful shutdown&lt;/p&gt;

&lt;p&gt;    The patch is pretty simple and the justification is explained in &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3924&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-3924&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I could not find Andrew Olson, who seems to be the contributor of this part of the code, in github so I am not sure whom I should ask to review the patch.&lt;/p&gt;

&lt;p&gt;     the contribution is my original work and that i license the work to the project under the project&apos;s open source license.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/maysamyabandeh/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/maysamyabandeh/kafka&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3924&quot; title=&quot;Data loss due to halting when LEO is larger than leader&amp;#39;s LEO&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3924&quot;&gt;&lt;del&gt;KAFKA-3924&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/1634.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/1634.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #1634&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit cc59b8845219e21f150fa584581d066d5db1d9c6&lt;br/&gt;
Author: Maysam Yabandeh &amp;lt;myabandeh@dropbox.com&amp;gt;&lt;br/&gt;
Date:   2016-07-18T20:41:00Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3924&quot; title=&quot;Data loss due to halting when LEO is larger than leader&amp;#39;s LEO&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3924&quot;&gt;&lt;del&gt;KAFKA-3924&lt;/del&gt;&lt;/a&gt;: Replacing halt with exit upon LEO mismatch to trigger graceful shutdown&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15383051" author="maysamyabandeh" created="Mon, 18 Jul 2016 20:58:57 +0000"  >&lt;p&gt;Submitting a simple patch that replaces halt with exit, which in turn will trigger the shutdown hook that gracefully shuts down the broker.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noslowerdna&quot; class=&quot;user-hover&quot; rel=&quot;noslowerdna&quot;&gt;noslowerdna&lt;/a&gt; You seem to be the most knowledgable about this part of the code but I did not manage to tag you on github pull request. Do you think you can review the patch? or perhaps redirect us to the some who could? Thanks.&lt;/p&gt;</comment>
                            <comment id="15383107" author="noslowerdna" created="Mon, 18 Jul 2016 21:27:06 +0000"  >&lt;p&gt;Reviewed, looks good to me.&lt;/p&gt;</comment>
                            <comment id="15395837" author="junrao" created="Wed, 27 Jul 2016 15:22:54 +0000"  >&lt;p&gt;Issue resolved by pull request 1634&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/kafka/pull/1634&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/1634&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15395838" author="githubbot" created="Wed, 27 Jul 2016 15:22:58 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/1634&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/1634&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15419873" author="aozeritsky" created="Sat, 13 Aug 2016 10:58:23 +0000"  >&lt;p&gt;I&apos;ve got the deadlock with that patch. Stack traces:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-quote&quot;&gt;&quot;ReplicaFetcherThread-3-2&quot;&lt;/span&gt; #112 prio=5 os_prio=0 tid=0x00007f0acc100000 nid=0xfd54f in &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait() [0x00007f0b141d7000]
   java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: WAITING (on object monitor)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait(Native Method)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.join(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:1245)
        - locked &amp;lt;0x00000003d8269bc8&amp;gt; (a kafka.Kafka$$anon$1)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.join(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:1319)
        at java.lang.ApplicationShutdownHooks.runHooks(ApplicationShutdownHooks.java:106)
        at java.lang.ApplicationShutdownHooks$1.run(ApplicationShutdownHooks.java:46)
        at java.lang.Shutdown.runHooks(Shutdown.java:123)
        at java.lang.Shutdown.sequence(Shutdown.java:167)
        at java.lang.Shutdown.exit(Shutdown.java:212)
        - locked &amp;lt;0x00000003d8106e88&amp;gt; (a java.lang.&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; java.lang.Shutdown)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Runtime&lt;/span&gt;.exit(&lt;span class=&quot;code-object&quot;&gt;Runtime&lt;/span&gt;.java:109)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.exit(&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.java:971)
        at kafka.server.ReplicaFetcherThread.handleOffsetOutOfRange(ReplicaFetcherThread.scala:179)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-2&quot;&lt;/span&gt; #29 prio=5 os_prio=0 tid=0x00007f0a70008000 nid=0xfecbf in &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait() [0x00007f0b166e5000]
   java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: WAITING (on object monitor)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait(Native Method)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.join(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:1245)
        - locked &amp;lt;0x00000003e5c46960&amp;gt; (a java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.join(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:1319)
        at kafka.server.KafkaRequestHandlerPool$$anonfun$shutdown$3.apply(KafkaRequestHandler.scala:92)
        at kafka.server.KafkaRequestHandlerPool$$anonfun$shutdown$3.apply(KafkaRequestHandler.scala:91)
        at scala.collection.IndexedSeqOptimized$&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;foreach(IndexedSeqOptimized.scala:33)
        at scala.collection.mutable.ArrayOps$ofRef.foreach(ArrayOps.scala:186)
        at kafka.server.KafkaRequestHandlerPool.shutdown(KafkaRequestHandler.scala:91)
        at kafka.server.KafkaServer$$anonfun$shutdown$3.apply$mcV$sp(KafkaServer.scala:559)
        at kafka.utils.CoreUtils$.swallow(CoreUtils.scala:79)
        at kafka.utils.Logging$&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;swallowWarn(Logging.scala:92)
        at kafka.utils.CoreUtils$.swallowWarn(CoreUtils.scala:51)
        at kafka.utils.Logging$&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;swallow(Logging.scala:94)
        at kafka.utils.CoreUtils$.swallow(CoreUtils.scala:51)
        at kafka.server.KafkaServer.shutdown(KafkaServer.scala:559)
        at kafka.server.KafkaServerStartable.shutdown(KafkaServerStartable.scala:49)
        at kafka.Kafka$$anon$1.run(Kafka.scala:63)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;System.exit executes hook in Thread 2 and joins it (first trace). Thread 2 joins ReplicaFetcherThread-3-2 (second trace). So they are waiting each other forever.&lt;/p&gt;</comment>
                            <comment id="15420004" author="maysamyabandeh" created="Sat, 13 Aug 2016 17:32:25 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aozeritsky&quot; class=&quot;user-hover&quot; rel=&quot;aozeritsky&quot;&gt;aozeritsky&lt;/a&gt;. I am not sure if I fully understand the nature of the deadlock. Thread-2 is stuck at KafkaRequestHandler.scala:92 which is running&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;(thread &amp;lt;- threads)
      thread.join
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;And these are KafakRequestHandler threads, which are different from ReplicaFetcherThread-3-2 for which 1st trace seems to be stuck:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    runnables(i) = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; KafkaRequestHandler(i, brokerId, aggregateIdleMeter, numThreads, requestChannel, apis)
    threads(i) = Utils.daemonThread(&lt;span class=&quot;code-quote&quot;&gt;&quot;kafka-request-handler-&quot;&lt;/span&gt; + i, runnables(i))
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;So I do not see the 2nd trace being locked on the 1st one. Perhaps if we could see a trace of shutdown hook  it would clarify that why it is not terminating.&lt;/p&gt;</comment>
                            <comment id="15420014" author="aozeritsky" created="Sat, 13 Aug 2016 17:52:06 +0000"  >&lt;p&gt;You are right. Shutdown hook is joining KafkaRequestHandler thread which is waiting for ReplicaFetcherThread-3-2:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-quote&quot;&gt;&quot;kafka-request-handler-0&quot;&lt;/span&gt; #67 daemon prio=5 os_prio=0 tid=0x00007f138ce35000 nid=0xfd4d7 waiting on condition [0x00007f0b8c758000]
   java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: WAITING (parking)
        at sun.misc.Unsafe.park(Native Method)
        - parking to wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;  &amp;lt;0x00000003e65c91c0&amp;gt; (a java.util.concurrent.locks.ReentrantLock$NonfairSync)
        at java.util.concurrent.locks.LockSupport.park(LockSupport.java:175)
        at java.util.concurrent.locks.AbstractQueuedSynchronizer.parkAndCheckInterrupt(AbstractQueuedSynchronizer.java:836)
        at java.util.concurrent.locks.AbstractQueuedSynchronizer.doAcquireInterruptibly(AbstractQueuedSynchronizer.java:897)
        at java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireInterruptibly(AbstractQueuedSynchronizer.java:1222)
        at java.util.concurrent.locks.ReentrantLock.lockInterruptibly(ReentrantLock.java:335)
        at kafka.server.AbstractFetcherThread.removePartitions(AbstractFetcherThread.scala:212)
        at kafka.server.AbstractFetcherManager$$anonfun$removeFetcherForPartitions$2.apply(AbstractFetcherManager.scala:101)
        at kafka.server.AbstractFetcherManager$$anonfun$removeFetcherForPartitions$2.apply(AbstractFetcherManager.scala:100)
        at scala.collection.TraversableLike$WithFilter$$anonfun$foreach$1.apply(TraversableLike.scala:778)
        at scala.collection.mutable.HashMap$$anonfun$foreach$1.apply(HashMap.scala:99)
        at scala.collection.mutable.HashMap$$anonfun$foreach$1.apply(HashMap.scala:99)
        at scala.collection.mutable.HashTable$&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;foreachEntry(HashTable.scala:230)
        at scala.collection.mutable.HashMap.foreachEntry(HashMap.scala:40)
        at scala.collection.mutable.HashMap.foreach(HashMap.scala:99)
        at scala.collection.TraversableLike$WithFilter.foreach(TraversableLike.scala:777)
        at kafka.server.AbstractFetcherManager.removeFetcherForPartitions(AbstractFetcherManager.scala:100)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;removePartitions is waiting for partitionMapLock&lt;/p&gt;</comment>
                            <comment id="15420026" author="maysamyabandeh" created="Sat, 13 Aug 2016 18:42:46 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aozeritsky&quot; class=&quot;user-hover&quot; rel=&quot;aozeritsky&quot;&gt;aozeritsky&lt;/a&gt; Let me run my understanding with you:&lt;/p&gt;

&lt;p&gt;KafakRequestHandler is processing stop replica request which attempts to invoke removePartition from the fetcher thread:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  def removePartitions(topicAndPartitions: Set[TopicAndPartition]) {
    partitionMapLock.lockInterruptibly()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;which then locks behind partitionMapLock.&lt;/p&gt;

&lt;p&gt;The fetcher thread that has run System.exit was holding the lock on partitionMapLock:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; def processFetchRequest(fetchRequest: REQ) {
...
      inLock(partitionMapLock) {
...
                    val newOffset = handleOffsetOutOfRange(topicAndPartition)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;So this gives us KafakRequestHandler being locked behind ReplicaFetcherThread-3-2 that has invoked the shutdown hook.&lt;/p&gt;

&lt;p&gt;If the above is correct, I still cannot see why ReplicaFetcherThread-3-2 is being locked behind the KafakRequestHandler. Perhaps the shutdown hook thread (to whose termination the ReplicaFetcherThread-3-2 is trying to join)&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; hook : threads) {
            &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                hook.join();
            } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (InterruptedException x) { }
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; is locked behind something else. If that is the case, I guess it would hep to see the part of the stack trace that shows what the shutdown hook is doing.&lt;/p&gt;</comment>
                            <comment id="15420038" author="aozeritsky" created="Sat, 13 Aug 2016 19:13:30 +0000"  >&lt;blockquote&gt;
&lt;p&gt;KafakRequestHandler is processing stop replica request which attempts to invoke removePartition from the fetcher thread:&lt;br/&gt;
which then locks behind partitionMapLock.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;correct&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;The fetcher thread that has run System.exit was holding the lock on partitionMapLock:&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;correct&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;If that is the case, I guess it would hep to see the part of the stack trace that shows what the shutdown hook is doing.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Shutdown hook is Thread 2 which is waiting for termination of KafkaRequestHandler.&lt;br/&gt;
I&apos;ve attached the full stack.&lt;/p&gt;</comment>
                            <comment id="15420049" author="maysamyabandeh" created="Sat, 13 Aug 2016 19:46:06 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aozeritsky&quot; class=&quot;user-hover&quot; rel=&quot;aozeritsky&quot;&gt;aozeritsky&lt;/a&gt;. That makes sense.&lt;/p&gt;

&lt;p&gt;So to summarize the shutdown hook would wait for all request handlers to terminate and we have a particular request handler that cannot finish until the fetcher thread (which has invoked the shutdown hook) releases a lock.&lt;/p&gt;

&lt;p&gt;How about we have the fetcher thread throwing an exit exception, catch it outside the synchronized block (which would have all the locks released) and then call System.exit(1) in the catch clause? This seems to be a good pattern for invoking System.exit(1) in the rest of the source code as well.&lt;/p&gt;</comment>
                            <comment id="15420251" author="aozeritsky" created="Sun, 14 Aug 2016 07:27:00 +0000"  >&lt;p&gt;IMHO the simplest way to solve the problem is to execute System.exit asyncroniously:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;diff --git a/core/src/main/scala/kafka/server/ReplicaFetcherThread.scala b/core/src/main/scala/kafka/server/ReplicaFetcherThread.scala
index ef602e4..ed00a73 100644
--- a/core/src/main/scala/kafka/server/ReplicaFetcherThread.scala
+++ b/core/src/main/scala/kafka/server/ReplicaFetcherThread.scala
@@ -175,10 +175,13 @@ &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;ReplicaFetcherThread(name: &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;,
       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!LogConfig.fromProps(brokerConfig.originals, AdminUtils.fetchEntityConfig(replicaMgr.zkUtils,
         ConfigType.Topic, topicAndPartition.topic)).uncleanLeaderElectionEnable) {
         &lt;span class=&quot;code-comment&quot;&gt;// Log a fatal error and shutdown the broker to ensure that data loss does not unexpectedly occur.
&lt;/span&gt;-        fatal(&lt;span class=&quot;code-quote&quot;&gt;&quot;Exiting because log truncation is not allowed &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition %s,&quot;&lt;/span&gt;.format(topicAndPartition) +
+        val msg = &lt;span class=&quot;code-quote&quot;&gt;&quot;Exiting because log truncation is not allowed &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition %s,&quot;&lt;/span&gt;.format(topicAndPartition) +
           &lt;span class=&quot;code-quote&quot;&gt;&quot; Current leader %d&lt;span class=&quot;code-quote&quot;&gt;&apos;s latest offset %d is less than replica %d&apos;&lt;/span&gt;s latest offset %d&quot;&lt;/span&gt;
-          .format(sourceBroker.id, leaderEndOffset, brokerConfig.brokerId, replica.logEndOffset.messageOffset))
-        &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.exit(1)
+          .format(sourceBroker.id, leaderEndOffset, brokerConfig.brokerId, replica.logEndOffset.messageOffset)
+        fatal(msg)
+
+        replicaMgr.scheduler.schedule(&lt;span class=&quot;code-quote&quot;&gt;&quot;exit&quot;&lt;/span&gt;, () =&amp;gt; &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.exit(1))
+        &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Exception(msg)
       }

       warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;Replica %d &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition %s reset its fetch offset from %d to current leader %d&apos;s latest offset %d&quot;&lt;/span&gt;
diff --git a/core/src/main/scala/kafka/server/ReplicaManager.scala b/core/src/main/scala/kafka/server/ReplicaManager.scala
index 2b97783..6e6539b 100644
--- a/core/src/main/scala/kafka/server/ReplicaManager.scala
+++ b/core/src/main/scala/kafka/server/ReplicaManager.scala
@@ -105,7 +105,7 @@ &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;ReplicaManager(val config: KafkaConfig,
                      time: Time,
                      jTime: JTime,
                      val zkUtils: ZkUtils,
-                     scheduler: Scheduler,
+                     val scheduler: Scheduler,
                      val logManager: LogManager,
                      val isShuttingDown: AtomicBoolean,
                      threadNamePrefix: Option[&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;] = None) &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; Logging with KafkaMetricsGroup {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15420269" author="ijuma" created="Sun, 14 Aug 2016 09:03:24 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=maysamyabandeh&quot; class=&quot;user-hover&quot; rel=&quot;maysamyabandeh&quot;&gt;maysamyabandeh&lt;/a&gt;, yes, it would be great to move away from executing `System.exit` inline in favour of throwing an exception (two examples, but maybe we can find better names: FatalExitException and FatalHaltException) that is caught by some central code that then does the `System.exit` or `Runtime.getRuntime.halt`. This helps in a couple of ways:&lt;/p&gt;

&lt;p&gt;(1) Avoids issues with locks being held as in this issue&lt;br/&gt;
(2) It makes it possible to abstract the action, which is very useful in tests. At the moment, we can&apos;t easily test for these conditions as they cause the whole test harness to exit. Worse, these conditions are sometimes triggered in the tests and it&apos;s unclear why.&lt;br/&gt;
(3) We can have more consistent logging around these actions and possibly extended logging for tests&lt;/p&gt;

&lt;p&gt;It&apos;s a longer-term plan, but it may make sense to start moving in that direction. Can you please file a separate JIRA for the deadlock and refer to this JIRA in that one?&lt;/p&gt;</comment>
                            <comment id="15420455" author="maysamyabandeh" created="Sun, 14 Aug 2016 19:26:33 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ijuma&quot; class=&quot;user-hover&quot; rel=&quot;ijuma&quot;&gt;ijuma&lt;/a&gt;. I created &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-4039&quot; title=&quot;Exit Strategy: using exceptions instead of inline invocation of exit/halt&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-4039&quot;&gt;&lt;del&gt;KAFKA-4039&lt;/del&gt;&lt;/a&gt; to follow up on this solution.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aozeritsky&quot; class=&quot;user-hover&quot; rel=&quot;aozeritsky&quot;&gt;aozeritsky&lt;/a&gt; running exit from another thread is actually a brilliant idea as it would guarantee that the new thread would not be holding any locks to cause a deadlock issue. As &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ijuma&quot; class=&quot;user-hover&quot; rel=&quot;ijuma&quot;&gt;ijuma&lt;/a&gt; pointed out however invoking exit in a central place after catching FatalExitException/FatalHaltException would also provide better control for testing and logging purposes.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12950746">KAFKA-3410</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12823591" name="deadlock-stack" size="56011" author="aozeritsky" created="Sat, 13 Aug 2016 19:06:35 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 14 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i30ge7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>