<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:23:14 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-9373] Improve shutdown performance via lazy accessing the offset and time indices.</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-9373</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7283&quot; title=&quot;mmap indexes lazily and skip sanity check for segments below recovery point&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7283&quot;&gt;&lt;del&gt;KAFKA-7283&lt;/del&gt;&lt;/a&gt; enabled lazy mmap on index files by initializing indices on-demand rather than performing costly disk/memory operations when creating all indices on broker startup. This helped reducing the startup time of brokers. However, segment indices are still created on closing segments, regardless of whether they need to be closed or not.&lt;/p&gt;

&lt;p&gt;Ideally we should:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Improve shutdown performance via lazy accessing the offset and time indices.&lt;/li&gt;
	&lt;li&gt;Eliminate redundant disk accesses and memory mapped operations while deleting or renaming files that back segment indices.&lt;/li&gt;
	&lt;li&gt;Prevent illegal accesses to underlying indices of a closed segment, which would lead to memory leaks due to recreation of the underlying memory mapped objects.&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="13277832">KAFKA-9373</key>
            <summary>Improve shutdown performance via lazy accessing the offset and time indices.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="agencer">Adem Efe Gencer</assignee>
                                    <reporter username="agencer">Adem Efe Gencer</reporter>
                        <labels>
                    </labels>
                <created>Tue, 7 Jan 2020 02:43:08 +0000</created>
                <updated>Thu, 26 Mar 2020 11:31:02 +0000</updated>
                            <resolved>Thu, 26 Mar 2020 11:31:02 +0000</resolved>
                                    <version>2.3.0</version>
                    <version>2.3.1</version>
                    <version>2.4.0</version>
                                    <fixVersion>2.6.0</fixVersion>
                                    <component>log</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17009314" author="githubbot" created="Tue, 7 Jan 2020 02:48:07 +0000"  >&lt;p&gt;efeg commented on pull request #7900: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-9373&quot; title=&quot;Improve shutdown performance via lazy accessing the offset and time indices.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-9373&quot;&gt;&lt;del&gt;KAFKA-9373&lt;/del&gt;&lt;/a&gt;: Improve shutdown performance via lazy accessing the offset and time indices&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/7900&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/7900&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7283&quot; title=&quot;mmap indexes lazily and skip sanity check for segments below recovery point&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7283&quot;&gt;&lt;del&gt;KAFKA-7283&lt;/del&gt;&lt;/a&gt; enabled lazy mmap on index files by initializing indices on-demand rather than performing costly disk/memory operations when creating all indices on broker startup. This helped reducing the startup time of brokers. However, segment indices are still created on closing segments, regardless of whether they need to be closed or not.&lt;/p&gt;

&lt;p&gt;   This patch:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Improves shutdown performance via lazy accessing the offset and time indices.&lt;/li&gt;
	&lt;li&gt;Eliminates redundant disk accesses and memory mapped operations while deleting or renaming files that back segment indices.&lt;/li&gt;
	&lt;li&gt;Prevents illegal accesses to underlying indices of a closed segment, which would lead to memory leaks due to recreation of the underlying memory mapped objects.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;   In our evaluations in a cluster with 31 brokers, where each broker has 13K to 20K segments, we observed up to 2 orders of magnitude faster LogManager shutdown times with this patch &amp;#8211; i.e. dropping the LogManager shutdown time of each broker from 10s of seconds to 100s of milliseconds.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="17066726" author="githubbot" created="Wed, 25 Mar 2020 14:48:52 +0000"  >&lt;p&gt;ijuma commented on pull request #8346: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-9373&quot; title=&quot;Improve shutdown performance via lazy accessing the offset and time indices.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-9373&quot;&gt;&lt;del&gt;KAFKA-9373&lt;/del&gt;&lt;/a&gt;: Reduce shutdown time by avoiding unnecessary loading of indexes&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/8346&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/8346&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7283&quot; title=&quot;mmap indexes lazily and skip sanity check for segments below recovery point&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7283&quot;&gt;&lt;del&gt;KAFKA-7283&lt;/del&gt;&lt;/a&gt; enabled lazy mmap on index files by initializing indices&lt;br/&gt;
   on-demand rather than performing costly disk/memory operations when&lt;br/&gt;
   creating all indices on broker startup. This helped reducing the startup&lt;br/&gt;
   time of brokers. However, segment indices are still created on closing&lt;br/&gt;
   segments, regardless of whether they need to be closed or not.&lt;/p&gt;

&lt;p&gt;   This is a cleaned up version of #7900, which was submitted by @efeg. It&lt;br/&gt;
   eliminates unnecessary disk accesses and memory map operations while&lt;br/&gt;
   deleting, renaming or closing offset and time indexes.&lt;/p&gt;

&lt;p&gt;   In a cluster with 31 brokers, where each broker has 13K to 20K segments,&lt;br/&gt;
   @efeg and team observed up to 2 orders of magnitude faster LogManager&lt;br/&gt;
   shutdown times - i.e. dropping the LogManager shutdown time of each&lt;br/&gt;
   broker from 10s of seconds to 100s of milliseconds.&lt;/p&gt;

&lt;p&gt;   To avoid confusion between `renameTo` and `setFile`, I replaced the&lt;br/&gt;
   latter with the more restricted updateParentDir` (it turns out that&apos;s&lt;br/&gt;
   all we need).&lt;/p&gt;

&lt;p&gt;   Co-authored-by: Adem Efe Gencer &amp;lt;agencer@linkedin.com&amp;gt;&lt;br/&gt;
   Co-authored-by: Ismael Juma &amp;lt;ismael@juma.me.uk&amp;gt;&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="17067605" author="githubbot" created="Thu, 26 Mar 2020 11:26:56 +0000"  >&lt;p&gt;ijuma commented on pull request #8346: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-9373&quot; title=&quot;Improve shutdown performance via lazy accessing the offset and time indices.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-9373&quot;&gt;&lt;del&gt;KAFKA-9373&lt;/del&gt;&lt;/a&gt;: Reduce shutdown time by avoiding unnecessary loading of indexes&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/8346&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/8346&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="17067608" author="githubbot" created="Thu, 26 Mar 2020 11:30:03 +0000"  >&lt;p&gt;ijuma commented on pull request #7900: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-9373&quot; title=&quot;Improve shutdown performance via lazy accessing the offset and time indices.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-9373&quot;&gt;&lt;del&gt;KAFKA-9373&lt;/del&gt;&lt;/a&gt;: Improve shutdown performance via lazy accessing the offset and time indices&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/7900&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/7900&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 33 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0a8s0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>