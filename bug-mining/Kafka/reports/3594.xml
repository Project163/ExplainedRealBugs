<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:35:35 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-15481] Concurrency bug in RemoteIndexCache leads to IOException</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-15481</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;RemoteIndexCache has a concurrency bug which leads to IOException while fetching data from remote tier.&lt;/p&gt;

&lt;p&gt;Below events in order of timeline -&lt;/p&gt;

&lt;p&gt;Thread 1 (cache thread): invalidates the entry, removalListener is invoked async, so the files have not been renamed to &quot;deleted&quot; suffix yet.&lt;/p&gt;

&lt;p&gt;Thread 2: (fetch thread): tries to find entry in cache, doesn&apos;t find it because it has been removed by 1, fetches the entry from S3, writes it to existing file (using replace existing)&lt;/p&gt;

&lt;p&gt;Thread 1: async removalListener is invoked, acquires a lock on old entry (which has been removed from cache), it renames the file to &quot;deleted&quot; and starts deleting it&lt;/p&gt;

&lt;p&gt;Thread 2: Tries to create in-memory/mmapped index, but doesn&apos;t find the file and hence, creates a new file of size 2GB in AbstractIndex constructor. JVM returns an error as it won&apos;t allow creation of 2GB random access file.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Potential Fix&lt;/b&gt;&lt;br/&gt;
Use EvictionListener instead of RemovalListener in Caffeine cache as per the documentation:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&#160;When the operation must be performed synchronously with eviction, use&#160;&lt;tt&gt;Caffeine.evictionListener(RemovalListener)&lt;/tt&gt;&#160;instead. This listener will only be notified when&#160;&lt;tt&gt;RemovalCause.wasEvicted()&lt;/tt&gt;&#160;is true. For an explicit removal,&#160;&lt;tt&gt;Cache.asMap()&lt;/tt&gt;&#160;offers compute methods that are performed atomically.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;This will ensure that removal from cache and marking the file with delete suffix is synchronously done, hence the above race condition will not occur.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13551413">KAFKA-15481</key>
            <summary>Concurrency bug in RemoteIndexCache leads to IOException</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jeel">Jeel Jotaniya</assignee>
                                    <reporter username="divijvaidya">Divij Vaidya</reporter>
                        <labels>
                    </labels>
                <created>Wed, 20 Sep 2023 12:58:23 +0000</created>
                <updated>Thu, 16 Nov 2023 21:06:42 +0000</updated>
                            <resolved>Thu, 16 Nov 2023 21:06:42 +0000</resolved>
                                    <version>3.6.0</version>
                                    <fixVersion>3.6.1</fixVersion>
                    <fixVersion>3.7.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="17767472" author="divijvaidya" created="Thu, 21 Sep 2023 08:57:04 +0000"  >&lt;p&gt;FYI &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=satishd&quot; class=&quot;user-hover&quot; rel=&quot;satishd&quot;&gt;satishd&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Kamal+C&quot; class=&quot;user-hover&quot; rel=&quot;Kamal C&quot;&gt;Kamal C&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=christo_lolov&quot; class=&quot;user-hover&quot; rel=&quot;christo_lolov&quot;&gt;christo_lolov&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=showuon&quot; class=&quot;user-hover&quot; rel=&quot;showuon&quot;&gt;showuon&lt;/a&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17767483" author="showuon" created="Thu, 21 Sep 2023 09:22:47 +0000"  >&lt;p&gt;Nice find, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=divijvaidya&quot; class=&quot;user-hover&quot; rel=&quot;divijvaidya&quot;&gt;divijvaidya&lt;/a&gt;! So, the issue is because we time gap between entry invalidation and the file renaming (i.e. removalListener got invoked). &lt;br/&gt;
One thing to confirm, this is not a blocker for v3.6.0, right? I don&apos;t think it is since tiered storage is just a tech preview feature.&lt;/p&gt;</comment>
                            <comment id="17767484" author="divijvaidya" created="Thu, 21 Sep 2023 09:40:19 +0000"  >&lt;p&gt;&amp;gt; the issue is because we time gap between entry invalidation and the file renaming&lt;/p&gt;

&lt;p&gt;Correct.&lt;/p&gt;

&lt;p&gt;&amp;gt; &#160;this is not a blocker for v3.6.0, right?&#160;&lt;/p&gt;

&lt;p&gt;Yes, I wouldn&apos;t consider this as a blocker since it&apos;s a race condition and shouldn&apos;t impact happy cases. I will add an entry to the early access document though mentioning the known bugs.&lt;/p&gt;</comment>
                            <comment id="17767485" author="showuon" created="Thu, 21 Sep 2023 09:43:42 +0000"  >&lt;p&gt;About the solution to change to sync way, I have a question:&lt;br/&gt;
Currently, we use readLock for both RemoteIndexCache#getIndexEntry and RemoteIndexCache#remove. That means, the original will still appear after using sync way:&lt;/p&gt;

&lt;p&gt;Thread 1 (cache thread): (readLock) invalidates the entry, removalListener is invoked &lt;b&gt;sync&lt;/b&gt;, the files is going to be renamed (not yet)&lt;/p&gt;

&lt;p&gt;Thread 2: (fetch thread): (readLock) tries to find entry in cache, doesn&apos;t find it because it has been removed by 1, fetches the entry from S3, writes it to existing file (using replace existing)&lt;/p&gt;

&lt;p&gt;Thread 1: removalListener acquires a lock on old entry (which has been removed from cache), it renames the file to &quot;deleted&quot; and starts deleting it&lt;/p&gt;

&lt;p&gt;Thread 2: Tries to create in-memory/mmapped index, but doesn&apos;t find the file and hence, creates a new file of size 2GB in AbstractIndex constructor. JVM returns an error as it won&apos;t allow creation of 2GB random access file.&lt;/p&gt;

&lt;p&gt;Is my understanding correct?&lt;/p&gt;</comment>
                            <comment id="17767486" author="showuon" created="Thu, 21 Sep 2023 09:55:54 +0000"  >&lt;p&gt;After re-reading the suggestion in Caffeine &lt;a href=&quot;https://github.com/ben-manes/caffeine/wiki/Removal&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;doc&lt;/a&gt;, the `evictionListener` only get invoked when &quot;object eviction&quot;, not removal explicitly. We should use `internalCache.asMap().computeIfPresent()` instead, which I think will fix the issue I mentioned above since the concurrentMap will help us protect multiple threads updating the value in the same key. So, my thought is:&lt;/p&gt;

&lt;p&gt;When in RemoteIndexCache#getIndexEntry, we use &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
internalCache.get(remoteLogSegmentMetadata.remoteLogSegmentId().id(),
                    uuid -&amp;gt; createCacheEntry(remoteLogSegmentMetadata));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;It internally use  `ConcurrentMap#computeIfAbsent` to update the entry.&lt;/p&gt;

&lt;p&gt;And in `RemoteIndexCache#remove`, we can now use:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
`internalCache.asMap().computeIfPresent(key, () -&amp;gt; {&lt;span class=&quot;code-comment&quot;&gt;// rename files and &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; to remove the key})` &lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;WDYT?&lt;/p&gt;</comment>
                            <comment id="17767487" author="divijvaidya" created="Thu, 21 Sep 2023 09:57:41 +0000"  >&lt;p&gt;You are right, but you are assuming that removing entry from cache and calling removalListener are not atomic (i.e. thread does not keep holding internal lock on entry key until both are complete).&lt;/p&gt;

&lt;p&gt;There are two possible solutions:&lt;br/&gt;
1\ we want to ensure here is that removing the entry from cache and renaming the file to add &quot;delete&quot; suffix should be atomic operations OR&lt;br/&gt;
2\ we can add a UUID at the end of each index file downloaded from remote for this cache so that each &quot;entry&quot; in the cache has a unique file associated with it.&lt;/p&gt;

&lt;p&gt;If we want to take the former approach, we need to check if Caffeine keeps on holding it&apos;s internal lock on the entry when it &quot;synchronously&quot; invokes `evictionListener`.&lt;/p&gt;

&lt;p&gt;The latter approach is an easy fix and we don&apos;t have to worry about concurrency problems since it would be guaranteed that each &quot;entry&quot; has it&apos;s own unique file. The cache anyways ensures that entries are re-used (if they are valid) based on UUID.&lt;/p&gt;</comment>
                            <comment id="17767489" author="divijvaidya" created="Thu, 21 Sep 2023 10:04:12 +0000"  >&lt;p&gt;&amp;gt; And in `RemoteIndexCache#remove`, we can now use:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
`internalCache.asMap().computeIfPresent(key, () -&amp;gt; {&lt;span class=&quot;code-comment&quot;&gt;// rename files and &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; to remove the key})` &lt;/span&gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;del&gt;But this doesn&apos;t handle the case of invalidation? Caffeine will not call &quot;RemoteIndexCache#remove()&quot; during invalidation and the race condition will still occur when invalidation and get is happening at same time.&lt;/del&gt;&lt;br/&gt;
Ah, you meant to say to use this in-addition to using evictionListener. Fair.&lt;/p&gt;</comment>
                            <comment id="17767490" author="divijvaidya" created="Thu, 21 Sep 2023 10:06:46 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ben.manes&quot; class=&quot;user-hover&quot; rel=&quot;ben.manes&quot;&gt;ben.manes&lt;/a&gt; your expert thoughts on best way to handle this with caffeine?&lt;/p&gt;</comment>
                            <comment id="17767645" author="ben.manes" created="Thu, 21 Sep 2023 16:55:46 +0000"  >&lt;p&gt;Excellent investigation! You are correct, using a computation for explicit removals and and an &lt;tt&gt;EvictionListener&lt;/tt&gt; for automatic ones is the right approach. These will perform the work under &lt;tt&gt;ConcurrentHashMap&lt;/tt&gt; entry lock, so it will be atomic with the map operation.&lt;/p&gt;

&lt;p&gt;The &lt;tt&gt;removalListener&lt;/tt&gt; option is asynchronous (non-atomic to removal) in Guava and therefore Caffeine. When adding a synchronous variant, we couldn&apos;t cover explicit removals because of `AsyncCache`, as a user could clear all of the in-flight mappings and would be very surprised if that blocked waiting for each to complete. An async cache&apos;s entry is eligible for eviction only when completed, so this fit very nicely as an eviction listener and using `asMap` computations for explicit calls.&lt;/p&gt;</comment>
                            <comment id="17767818" author="showuon" created="Fri, 22 Sep 2023 05:05:51 +0000"  >&lt;p&gt;Thanks for the suggestion! &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ben.manes&quot; class=&quot;user-hover&quot; rel=&quot;ben.manes&quot;&gt;ben.manes&lt;/a&gt;!&lt;/p&gt;</comment>
                            <comment id="17770830" author="JIRAUSER301926" created="Sun, 1 Oct 2023 07:30:09 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=divijvaidya&quot; class=&quot;user-hover&quot; rel=&quot;divijvaidya&quot;&gt;divijvaidya&lt;/a&gt;  &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=showuon&quot; class=&quot;user-hover&quot; rel=&quot;showuon&quot;&gt;showuon&lt;/a&gt; &lt;br/&gt;
1\ we want to ensure here is that removing the entry from cache and renaming the file to add &quot;delete&quot; suffix should be atomic operations OR&lt;br/&gt;
2\ we can add a UUID at the end of each index file downloaded from remote for this cache so that each &quot;entry&quot; in the cache has a unique file associated with it.&lt;br/&gt;
Should we go with the first or the 2nd approach , IMO 2nd would decouple the flow and we don&apos;t have to worry about any other concurrency issue and  would be simple to understand ?&lt;/p&gt;</comment>
                            <comment id="17777668" author="JIRAUSER302432" created="Fri, 20 Oct 2023 09:41:56 +0000"  >&lt;p&gt;PR: &lt;a href=&quot;https://github.com/apache/kafka/pull/14483&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/14483&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17778676" author="divijvaidya" created="Mon, 23 Oct 2023 13:46:04 +0000"  >&lt;p&gt;It&apos;s merged to 3.7/trunk and merge to 3.6 branch is pending&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17785578" author="mimaison" created="Mon, 13 Nov 2023 16:54:25 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=divijvaidya&quot; class=&quot;user-hover&quot; rel=&quot;divijvaidya&quot;&gt;divijvaidya&lt;/a&gt; Is there an issue that&apos;s preventing the backport to 3.6? &lt;/p&gt;</comment>
                            <comment id="17785597" author="divijvaidya" created="Mon, 13 Nov 2023 17:54:07 +0000"  >&lt;p&gt;Yes, it has lots of merge conflicts because of another functionality (dynamically change cache size) that was added to 3.7 and not to 3.6.1. I plan to manually resolve those merge conflicts in next 2 days and merge into 3.6&lt;/p&gt;</comment>
                            <comment id="17785806" author="mimaison" created="Tue, 14 Nov 2023 08:55:56 +0000"  >&lt;p&gt;Awesome, thanks&lt;/p&gt;</comment>
                            <comment id="17786449" author="divijvaidya" created="Wed, 15 Nov 2023 17:47:26 +0000"  >&lt;p&gt;update: I am currently on it. Will take another day to backport.&lt;/p&gt;</comment>
                            <comment id="17786942" author="divijvaidya" created="Thu, 16 Nov 2023 21:06:32 +0000"  >&lt;p&gt;Merged to 3.6&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310460">
                    <name>Child-Issue</name>
                                                                <inwardlinks description="is a child of">
                                        <issuelink>
            <issuekey id="13549279">KAFKA-15420</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 51 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1khh4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>