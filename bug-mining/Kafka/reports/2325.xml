<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:19:22 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-8526] Broker may select a failed dir for new replica even in the presence of other live dirs</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-8526</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Suppose a broker is configured with multiple log dirs. One of the log dirs fails, but there is no load on that dir, so the broker does not know about the failure yet, &lt;em&gt;i.e.&lt;/em&gt;, the failed dir is still in LogManager#_liveLogDirs. Suppose a new topic gets created, and the controller chooses the broker with failed log dir to host one of the replicas. The broker gets LeaderAndIsr request with isNew flag set. LogManager#getOrCreateLog() selects a log dir for the new replica from&#160;_liveLogDirs, then one two things can happen:&lt;br/&gt;
1)&#160;getAbsolutePath can fail, in which case getOrCreateLog will throw an IOException&lt;br/&gt;
2) Creating directory for new the replica log may fail (&lt;em&gt;e.g.&lt;/em&gt;, if directory becomes read-only, so getAbsolutePath worked).&#160;&lt;/p&gt;

&lt;p&gt;In both cases, the selected dir will be marked offline (which is correct). However, LeaderAndIsr will return an error and replica will be marked offline, even though the broker may have other live dirs.&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Proposed solution&lt;/b&gt;: Broker should retry selecting a dir for the new replica, if initially selected dir threw an IOException when trying to create a directory for the new replica. We should be able to do that in LogManager#getOrCreateLog() method, but keep in mind that&#160;logDirFailureChannel.maybeAddOfflineLogDir&#160;does not synchronously removes the dir from _liveLogDirs. So, it makes sense to select initial dir by calling LogManager#nextLogDir (current implementation), but if we fail to create log on that dir, one approach is to select next dir from&#160;_liveLogDirs in round-robin fashion (until we get to initial log dir &#8211; the case where all dirs failed).&lt;/p&gt;</description>
                <environment></environment>
        <key id="13238889">KAFKA-8526</key>
            <summary>Broker may select a failed dir for new replica even in the presence of other live dirs</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="soarez">Igor Soarez</assignee>
                                    <reporter username="apovzner">Anna Povzner</reporter>
                        <labels>
                    </labels>
                <created>Tue, 11 Jun 2019 22:36:33 +0000</created>
                <updated>Tue, 23 Jul 2019 15:58:25 +0000</updated>
                            <resolved>Tue, 23 Jul 2019 15:58:25 +0000</resolved>
                                    <version>1.1.1</version>
                    <version>2.0.1</version>
                    <version>2.1.1</version>
                    <version>2.2.1</version>
                    <version>2.3.0</version>
                                    <fixVersion>2.4.0</fixVersion>
                                        <due></due>
                            <votes>2</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16867710" author="githubbot" created="Wed, 19 Jun 2019 14:31:09 +0000"  >&lt;p&gt;soarez commented on pull request #6969: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-8526&quot; title=&quot;Broker may select a failed dir for new replica even in the presence of other live dirs&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-8526&quot;&gt;&lt;del&gt;KAFKA-8526&lt;/del&gt;&lt;/a&gt;: logdir fallback on getOrCreateLog&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/6969&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/6969&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;    LogManager#getOrCreateLog() selects a log dir for the new replica from&lt;br/&gt;
    _liveLogDirs, if disk failure is discovered at this point, before&lt;br/&gt;
    LogDirFailureHandler finds out, try using other log dirs before failing&lt;br/&gt;
    the operation.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16891170" author="githubbot" created="Tue, 23 Jul 2019 15:57:43 +0000"  >&lt;p&gt;hachikuji commented on pull request #6969: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-8526&quot; title=&quot;Broker may select a failed dir for new replica even in the presence of other live dirs&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-8526&quot;&gt;&lt;del&gt;KAFKA-8526&lt;/del&gt;&lt;/a&gt;: logdir fallback on getOrCreateLog&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/6969&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/6969&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 17 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z03n20:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>