<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:16:56 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-7902] SASL/OAUTHBEARER can become unable to connect: javax.security.sasl.SaslException: Unable to find OAuth Bearer token in Subject&apos;s private credentials (size=2) </title>
                <link>https://issues.apache.org/jira/browse/KAFKA-7902</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;It is possible for a Java SASL/OAUTHBEARER client (either a non-broker producer/consumer client or a broker when acting as an inter-broker client) to end up in a state where it cannot connect to a new broker (or, if re-authentication as implemented by KIP-368 and merged for v2.2.0 were to be deployed and enabled, to be unable to re-authenticate). The error message looks like this:&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;Connection to node 1 failed authentication due to: An error: (java.security.PrivilegedActionException: javax.security.sasl.SaslException: Unable to find OAuth Bearer token in Subject&apos;s private credentials (size=2) &lt;span class=&quot;error&quot;&gt;&amp;#91;Caused by java.io.IOException: Unable to find OAuth Bearer token in Subject&amp;#39;s private credentials (size=2)&amp;#93;&lt;/span&gt;) occurred when evaluating SASL token received from the Kafka Broker. Kafka Client will go to AUTHENTICATION_FAILED state.&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;The root cause of the problem begins at this point in the code:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/kafka/blob/2.0/clients/src/main/java/org/apache/kafka/common/security/oauthbearer/internals/expiring/ExpiringCredentialRefreshingLogin.java#L378&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/2.0/clients/src/main/java/org/apache/kafka/common/security/oauthbearer/internals/expiring/ExpiringCredentialRefreshingLogin.java#L378&lt;/a&gt;:&lt;/p&gt;

&lt;p&gt;The &lt;tt&gt;loginContext&lt;/tt&gt; field doesn&apos;t get replaced with the old version stored away in the &lt;tt&gt;optionalLoginContextToLogout&lt;/tt&gt; variable if/when the &lt;tt&gt;loginContext.login()&lt;/tt&gt; call on line 381 throws an exception. &lt;b&gt;This is an unusual event&lt;/b&gt; &#8211; the OAuth authorization server must be unavailable at the moment when the token refresh occurs &#8211; but when it does happen it puts the refresher thread instance in an invalid state because now its &lt;tt&gt;loginContext&lt;/tt&gt; field represents the one that failed instead of the original one, which is now lost.  The current &lt;tt&gt;loginContext&lt;/tt&gt; can&apos;t be logged out &#8211; it will throw an &lt;tt&gt;InvalidStateException&lt;/tt&gt; if that is attempted because there is no token associated with it &amp;#8211; and the token associated with the login context that was lost can never be logged out and removed from the Subject&apos;s private credentials (because we don&apos;t retain a reference to it).  The net effect is that we end up with an extra token on the Subject&apos;s private credentials, which eventually results in the exception mentioned above when the client tries to authenticate to a broker.&lt;/p&gt;

&lt;p&gt;So the chain of events is:&lt;/p&gt;

&lt;p&gt;1) login failure upon token refresh causes the refresher thread&apos;s login context field to be incorrect, and the existing token on the Subject&apos;s private credentials will never be logged out/removed&lt;br/&gt;
 2) retry occurs in 10 seconds, potentially repeatedly until the authorization server is back online&lt;br/&gt;
 3) login succeeds, adding a second token to the Subject&apos;s private credentials (logout is then called on the login context set incorrectly in the most recent failure &amp;#8211; e.g. in step 1 &amp;#8211; which results in an exception, but this is not the real issue &amp;#8211; it is the 2 tokens on the Subject&apos;s private credentials that is the issue)&lt;br/&gt;
 4) At this point we now have 2 tokens on the Subject, and then at some point in the future the client tries to make a new connection, it sees the 2 tokens and throws an exception &#8211; BOOM! The client is now unable to connect (or re-authenticate if applicable) going forward.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13214181">KAFKA-7902</key>
            <summary>SASL/OAUTHBEARER can become unable to connect: javax.security.sasl.SaslException: Unable to find OAuth Bearer token in Subject&apos;s private credentials (size=2) </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rndgstn">Ron Dagostino</assignee>
                                    <reporter username="rndgstn">Ron Dagostino</reporter>
                        <labels>
                    </labels>
                <created>Wed, 6 Feb 2019 15:30:02 +0000</created>
                <updated>Tue, 14 Sep 2021 17:05:11 +0000</updated>
                            <resolved>Thu, 7 Feb 2019 18:15:33 +0000</resolved>
                                    <version>2.0.0</version>
                    <version>2.0.1</version>
                    <version>2.1.0</version>
                                    <fixVersion>2.1.1</fixVersion>
                    <fixVersion>2.2.0</fixVersion>
                                    <component>clients</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="16761868" author="githubbot" created="Wed, 6 Feb 2019 15:41:35 +0000"  >&lt;p&gt;rondagostino commented on pull request #6233: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7902&quot; title=&quot;SASL/OAUTHBEARER can become unable to connect: javax.security.sasl.SaslException: Unable to find OAuth Bearer token in Subject&amp;#39;s private credentials (size=2) &quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7902&quot;&gt;&lt;del&gt;KAFKA-7902&lt;/del&gt;&lt;/a&gt;: Replace original loginContext if SASL/OAUTHBEARER refresh login fails&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/6233&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/6233&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Code fix included.  Will add a test case ASAP &amp;#8211; hopefully today.&lt;/p&gt;

&lt;p&gt;   It is possible for a Java SASL/OAUTHBEARER client (either a non-broker producer/consumer client or a broker when acting as an inter-broker client) to end up in a state where it cannot connect to a new broker (or, if re-authentication as implemented by KIP-368 and merged for v2.2.0 were to be deployed and enabled, to be unable to re-authenticate). The error message looks like this:&lt;/p&gt;

&lt;p&gt;   `Connection to node 1 failed authentication due to: An error: (java.security.PrivilegedActionException: javax.security.sasl.SaslException: Unable to find OAuth Bearer token in Subject&apos;s private credentials (size=2) &lt;span class=&quot;error&quot;&gt;&amp;#91;Caused by java.io.IOException: Unable to find OAuth Bearer token in Subject&amp;#39;s private credentials (size=2)&amp;#93;&lt;/span&gt;) occurred when evaluating SASL token received from the Kafka Broker. Kafka Client will go to AUTHENTICATION_FAILED state.`&lt;/p&gt;

&lt;p&gt;   The root cause of the problem begins at this point in the code:&lt;/p&gt;

&lt;p&gt;   &lt;a href=&quot;https://github.com/apache/kafka/blob/2.0/clients/src/main/java/org/apache/kafka/common/security/oauthbearer/internals/expiring/ExpiringCredentialRefreshingLogin.java#L378:&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/2.0/clients/src/main/java/org/apache/kafka/common/security/oauthbearer/internals/expiring/ExpiringCredentialRefreshingLogin.java#L378:&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;   The `loginContext` field doesn&apos;t get replaced with the old version stored away in the `optionalLoginContextToLogout` variable if/when the `loginContext.login()` call on line 381 throws an exception. This is an unusual event &#8211; the OAuth authorization server must be unavailable at the moment when the token refresh occurs &#8211; but when it does happen it puts the refresher thread instance in an invalid state because now its `loginContext` field represents the one that failed instead of the original one, which is now lost. The current `loginContext` can&apos;t be logged out &#8211; it will throw an `InvalidStateException` if that is attempted because there is no token associated with it &#8211; and the token associated with the login context that was lost can never be logged out and removed from the Subject&apos;s private credentials (because we don&apos;t retain a reference to it). The net effect is that we end up with an extra token on the Subject&apos;s private credentials, which eventually results in the exception mentioned above when the client tries to authenticate to a broker.&lt;/p&gt;

&lt;p&gt;   So the chain of events is:&lt;/p&gt;

&lt;p&gt;   1.  login failure upon token refresh causes the refresher thread&apos;s login context field to be incorrect, and the existing token on the Subject&apos;s private credentials will never be logged out/removed&lt;br/&gt;
   2. retry occurs in 10 seconds, potentially repeatedly until the authorization server is back online&lt;br/&gt;
   3. login succeeds, adding a second token to the Subject&apos;s private credentials (logout is then called on the login context set incorrectly in the most recent failure &#8211; e.g. in step 1 &#8211; which results in an exception, but this is not the real issue &#8211; it is the 2 tokens on the Subject&apos;s private credentials that is the issue)&lt;br/&gt;
   4. At this point we now have 2 tokens on the Subject, and then at some point in the future the client tries to make a new connection, it sees the 2 tokens and throws an exception &#8211; BOOM! The client is now unable to connect (or re-authenticate if applicable) going forward.&lt;/p&gt;


&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16762930" author="githubbot" created="Thu, 7 Feb 2019 18:06:04 +0000"  >&lt;p&gt;rajinisivaram commented on pull request #6233: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7902&quot; title=&quot;SASL/OAUTHBEARER can become unable to connect: javax.security.sasl.SaslException: Unable to find OAuth Bearer token in Subject&amp;#39;s private credentials (size=2) &quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7902&quot;&gt;&lt;del&gt;KAFKA-7902&lt;/del&gt;&lt;/a&gt;: Replace original loginContext if SASL/OAUTHBEARER refresh login fails&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/6233&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/6233&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 40 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|yi0psw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>