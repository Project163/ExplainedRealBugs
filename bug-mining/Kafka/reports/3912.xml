<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:40:17 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-15648] QuorumControllerTest#testBootstrapZkMigrationRecord is flaky</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-15648</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Noticed that this test failed on Jenkins with &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
org.apache.kafka.server.fault.FaultHandlerException: fatalFaultHandler: exception &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; completing controller activation: Should not have ZK migrations enabled on a cluster running metadata.version 3.0-IV1
	at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.kafka.controller.ActivationRecordsGenerator.recordsForNonEmptyLog(ActivationRecordsGenerator.java:154)
&lt;/span&gt;	at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.kafka.controller.ActivationRecordsGenerator.generate(ActivationRecordsGenerator.java:229)
&lt;/span&gt;	at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.kafka.controller.QuorumController$CompleteActivationEvent.generateRecordsAndResult(QuorumController.java:1237)
&lt;/span&gt;	at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.kafka.controller.QuorumController$ControllerWriteEvent.run(QuorumController.java:784)
&lt;/span&gt;	at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.kafka.queue.KafkaEventQueue$EventContext.run(KafkaEventQueue.java:127)
&lt;/span&gt;	at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.kafka.queue.KafkaEventQueue$EventHandler.handleEvents(KafkaEventQueue.java:210)
&lt;/span&gt;	at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.kafka.queue.KafkaEventQueue$EventHandler.run(KafkaEventQueue.java:181)
&lt;/span&gt;	at java.base@11.0.16.1/java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:829)
Caused by: java.lang.RuntimeException: Should not have ZK migrations enabled on a cluster running metadata.version 3.0-IV1
	... 8 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I think this exception is a red herring (it&apos;s expected from one of the negative test cases). When trying to reproduce this issue locally, I do occasionally see the following type of failure&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[2023-10-19 13:42:10,091] INFO Elected &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; leader: LeaderAndEpoch(leaderId=OptionalInt[0], epoch=1). (org.apache.kafka.metalog.LocalLogManager$SharedLogData:300)
[2023-10-19 13:42:10,091] DEBUG append(batch=LeaderChangeBatch(newLeader=LeaderAndEpoch(leaderId=OptionalInt[0], epoch=1)), nextEndOffset=0) (org.apache.kafka.metalog.LocalLogManager$SharedLogData:276)
[2023-10-19 13:42:10,091] DEBUG [LocalLogManager 0] Node 0: running log check. (org.apache.kafka.metalog.LocalLogManager:536)
[2023-10-19 13:42:10,091] DEBUG [LocalLogManager 0] initialized local log manager &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; node 0 (org.apache.kafka.metalog.LocalLogManager:685)
[2023-10-19 13:42:10,091] DEBUG [QuorumController id=0] Creating in-memory snapshot -1 (org.apache.kafka.timeline.SnapshotRegistry:203)
[2023-10-19 13:42:10,091] INFO [QuorumController id=0] Creating &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; QuorumController with clusterId 6xRUXZ_kQ1GfuaHK42AS9Q. ZK migration mode is enabled. (org.apache.kafka.controller.QuorumController:1912)
[2023-10-19 13:42:10,092] INFO [LocalLogManager 0] Node 0: registered MetaLogListener 1082153924 (org.apache.kafka.metalog.LocalLogManager:703)
[2023-10-19 13:42:10,092] DEBUG [LocalLogManager 0] Node 0: running log check. (org.apache.kafka.metalog.LocalLogManager:536)
[2023-10-19 13:42:10,092] DEBUG [LocalLogManager 0] Node 0: Executing handleLeaderChange LeaderAndEpoch(leaderId=OptionalInt[0], epoch=1) (org.apache.kafka.metalog.LocalLogManager:578)
[2023-10-19 13:42:10,092] DEBUG [QuorumController id=0] Executing handleLeaderChange[1]. (org.apache.kafka.controller.QuorumController:577)
[2023-10-19 13:42:10,092] INFO [QuorumController id=0] In the &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; epoch 1, the leader is (none). (org.apache.kafka.controller.QuorumController:1179)
[2023-10-19 13:42:10,092] DEBUG [QuorumController id=0] Processed handleLeaderChange[1] in 50 us (org.apache.kafka.controller.QuorumController:510)
[2023-10-19 13:42:10,092] DEBUG [QuorumController id=0] Executing handleLeaderChange[1]. (org.apache.kafka.controller.QuorumController:577)
[2023-10-19 13:42:10,092] INFO [QuorumController id=0] Becoming the active controller at epoch 1, next write offset 1. (org.apache.kafka.controller.QuorumController:1175)
[2023-10-19 13:42:10,092] DEBUG [QuorumController id=0] Processed handleLeaderChange[1] in 77 us (org.apache.kafka.controller.QuorumController:510)
[2023-10-19 13:42:10,092] WARN [QuorumController id=0] Performing controller activation. The metadata log appears to be empty. Appending 1 bootstrap record(s) at metadata.version 3.4-IV0 from bootstrap source &lt;span class=&quot;code-quote&quot;&gt;&apos;test&apos;&lt;/span&gt;. Putting the controller into pre-migration mode. No metadata updates will be allowed until the ZK metadata has been migrated. (org.apache.kafka.controller.QuorumController:108)
[2023-10-19 13:42:10,092] INFO [QuorumController id=0] Replayed a FeatureLevelRecord setting metadata version to 3.4-IV0 (org.apache.kafka.controller.FeatureControlManager:400)
[2023-10-19 13:42:10,092] INFO [QuorumController id=0] Replayed a ZkMigrationStateRecord changing the migration state from NONE to PRE_MIGRATION. (org.apache.kafka.controller.FeatureControlManager:421)
[2023-10-19 13:42:10,092] DEBUG [QuorumController id=0] Got exception &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; running completeActivation[1](342832465). Invoking handleException. (org.apache.kafka.queue.KafkaEventQueue:132)
org.apache.kafka.raft.errors.NotLeaderException: Append failed because the given epoch 0 is stale. Current leader epoch = 1
	at org.apache.kafka.metalog.LocalLogManager$SharedLogData.tryAppend(LocalLogManager.java:253)
	at org.apache.kafka.metalog.LocalLogManager$SharedLogData.tryAppend(LocalLogManager.java:233)
	at org.apache.kafka.metalog.LocalLogManager.scheduleAtomicAppend(LocalLogManager.java:795)
	at org.apache.kafka.controller.QuorumController$ControllerWriteEvent$1.apply(QuorumController.java:839)
	at org.apache.kafka.controller.QuorumController$ControllerWriteEvent$1.apply(QuorumController.java:816)
	at org.apache.kafka.controller.QuorumController.appendRecords(QuorumController.java:918)
	at org.apache.kafka.controller.QuorumController$ControllerWriteEvent.run(QuorumController.java:815)
	at org.apache.kafka.queue.KafkaEventQueue$EventContext.run(KafkaEventQueue.java:127)
	at org.apache.kafka.queue.KafkaEventQueue$EventHandler.handleEvents(KafkaEventQueue.java:210)
	at org.apache.kafka.queue.KafkaEventQueue$EventHandler.run(KafkaEventQueue.java:181)
	at java.base/java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:833)
[2023-10-19 13:42:10,092] INFO [QuorumController id=0] completeActivation[1]: event failed with NotLeaderException (treated as NotControllerException) at epoch 1 in 387 microseconds. Renouncing leadership and reverting to the last committed offset -1. (org.apache.kafka.controller.QuorumController:542)
[2023-10-19 13:42:10,092] ERROR Encountered fatalFaultHandler fault: exception &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; renouncing leadership (org.apache.kafka.server.fault.MockFaultHandler:44)
java.lang.IllegalArgumentException: Attempt to resign from epoch 1 which is larger than the current epoch 0
	at org.apache.kafka.metalog.LocalLogManager.resign(LocalLogManager.java:808)
	at org.apache.kafka.controller.QuorumController.renounce(QuorumController.java:1268)
	at org.apache.kafka.controller.QuorumController.handleEventException(QuorumController.java:545)
	at org.apache.kafka.controller.QuorumController.access$800(QuorumController.java:177)
	at org.apache.kafka.controller.QuorumController$ControllerWriteEvent.complete(QuorumController.java:879)
	at org.apache.kafka.controller.QuorumController$ControllerWriteEvent.handleException(QuorumController.java:869)
	at org.apache.kafka.queue.KafkaEventQueue$EventContext.completeWithException(KafkaEventQueue.java:148)
	at org.apache.kafka.queue.KafkaEventQueue$EventContext.run(KafkaEventQueue.java:137)
	at org.apache.kafka.queue.KafkaEventQueue$EventHandler.handleEvents(KafkaEventQueue.java:210)
	at org.apache.kafka.queue.KafkaEventQueue$EventHandler.run(KafkaEventQueue.java:181)
	at java.base/java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:833)
[2023-10-19 13:42:10,093] DEBUG [QuorumController id=0] Processed read migration state(176059074) in 4 us (org.apache.kafka.controller.QuorumController:510)
[2023-10-19 13:42:10,093] INFO [QuorumController id=0] QuorumController#beginShutdown: shutting down event queue. (org.apache.kafka.queue.KafkaEventQueue:492)
[2023-10-19 13:42:10,093] DEBUG [QuorumController id=0] KafkaEventQueue#close: Event queue is already shutting down. (org.apache.kafka.queue.KafkaEventQueue:489)
[2023-10-19 13:42:10,093] INFO [QuorumController id=0] closed event queue. (org.apache.kafka.queue.KafkaEventQueue:514)
[2023-10-19 13:42:10,093] INFO [LocalLogManager 0] beginShutdown: shutting down event queue. (org.apache.kafka.queue.KafkaEventQueue:492)
[2023-10-19 13:42:10,093] DEBUG [LocalLogManager 0] Node 0: closing. (org.apache.kafka.metalog.LocalLogManager:653)
[2023-10-19 13:42:10,094] DEBUG [LocalLogManager 0] beginShutdown: Event queue is already shutting down. (org.apache.kafka.queue.KafkaEventQueue:489)
[2023-10-19 13:42:10,094] DEBUG [LocalLogManager 0] KafkaEventQueue#close: Event queue is already shutting down. (org.apache.kafka.queue.KafkaEventQueue:489)
[2023-10-19 13:42:10,094] DEBUG [LocalLogManager 0] Node 0: beginning shutdown. (org.apache.kafka.metalog.LocalLogManager:637)
[2023-10-19 13:42:10,094] DEBUG append(batch=LeaderChangeBatch(newLeader=LeaderAndEpoch(leaderId=OptionalInt.empty, epoch=2)), nextEndOffset=1) (org.apache.kafka.metalog.LocalLogManager$SharedLogData:276)
[2023-10-19 13:42:10,094] INFO Elected &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; leader: LeaderAndEpoch(leaderId=OptionalInt[0], epoch=3). (org.apache.kafka.metalog.LocalLogManager$SharedLogData:300)
[2023-10-19 13:42:10,094] DEBUG append(batch=LeaderChangeBatch(newLeader=LeaderAndEpoch(leaderId=OptionalInt[0], epoch=3)), nextEndOffset=2) (org.apache.kafka.metalog.LocalLogManager$SharedLogData:276)
[2023-10-19 13:42:10,094] DEBUG [QuorumController id=0] MetaLogManager.Listener: Event queue is already shutting down. (org.apache.kafka.queue.KafkaEventQueue:489)
[2023-10-19 13:42:10,094] INFO [LocalLogManager 0] closed event queue. (org.apache.kafka.queue.KafkaEventQueue:514)

org.apache.kafka.server.fault.FaultHandlerException: fatalFaultHandler: exception &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; renouncing leadership: Attempt to resign from epoch 1 which is larger than the current epoch 0

	at org.apache.kafka.metalog.LocalLogManager.resign(LocalLogManager.java:808)
	at org.apache.kafka.controller.QuorumController.renounce(QuorumController.java:1268)
	at org.apache.kafka.controller.QuorumController.handleEventException(QuorumController.java:545)
	at org.apache.kafka.controller.QuorumController.access$800(QuorumController.java:177)
	at org.apache.kafka.controller.QuorumController$ControllerWriteEvent.complete(QuorumController.java:879)
	at org.apache.kafka.controller.QuorumController$ControllerWriteEvent.handleException(QuorumController.java:869)
	at org.apache.kafka.queue.KafkaEventQueue$EventContext.completeWithException(KafkaEventQueue.java:148)
	at org.apache.kafka.queue.KafkaEventQueue$EventContext.run(KafkaEventQueue.java:137)
	at org.apache.kafka.queue.KafkaEventQueue$EventHandler.handleEvents(KafkaEventQueue.java:210)
	at org.apache.kafka.queue.KafkaEventQueue$EventHandler.run(KafkaEventQueue.java:181)
	at java.base/java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:833)
Caused by: java.lang.IllegalArgumentException: Attempt to resign from epoch 1 which is larger than the current epoch 0
	... 11 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13554827">KAFKA-15648</key>
            <summary>QuorumControllerTest#testBootstrapZkMigrationRecord is flaky</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="10002" iconUrl="https://issues.apache.org/jira/images/icons/statuses/document.png" description="A patch for this issue has been uploaded to JIRA by a contributor.">Patch Available</status>
                    <statusCategory id="4" key="indeterminate" colorName="yellow"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="davidarthur">David Arthur</assignee>
                                    <reporter username="davidarthur">David Arthur</reporter>
                        <labels>
                            <label>flaky-test</label>
                            <label>good-first-issue</label>
                    </labels>
                <created>Thu, 19 Oct 2023 17:49:56 +0000</created>
                <updated>Fri, 6 Sep 2024 17:54:06 +0000</updated>
                                                                            <component>controller</component>
                    <component>unit tests</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17845658" author="JIRAUSER303328" created="Sun, 12 May 2024 01:59:32 +0000"  >&lt;p&gt;Hey, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davidarthur&quot; class=&quot;user-hover&quot; rel=&quot;davidarthur&quot;&gt;davidarthur&lt;/a&gt; !&#160;&lt;/p&gt;

&lt;p&gt;How did you test it locally?&lt;/p&gt;

&lt;p&gt;In my case, I execute test code repeatly, but the error which you encounter on your local never occurs.&#160;&lt;/p&gt;

&lt;p&gt;this is command lists which i executed.&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;gradle --parallel test&lt;/li&gt;
	&lt;li&gt;gradle --parallel metadata:test&lt;/li&gt;
	&lt;li&gt;gradle metadata:test&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17879924" author="davidarthur" created="Fri, 6 Sep 2024 16:54:36 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/apache/kafka/pull/17118&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/17118&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13576840">KAFKA-16602</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 9 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1l2ig:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>