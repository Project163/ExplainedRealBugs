<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:14:03 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-7240] -total metrics in Streams are incorrect</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-7240</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;I noticed the values of total metrics for streams were decreasing periodically when viewed in JMX, for example process-total for each processor-node-id under stream-processor-node-metrics.&#160;&lt;/p&gt;

&lt;p&gt;Edit: For processor node metrics, I should have been looking at&#160;ProcessorNode, not&#160;&#160;StreamsMetricsThreadImpl.&lt;/p&gt;

&lt;p&gt;&#160;&lt;del&gt;Looking at&#160;StreamsMetricsThreadImpl, I believe this behavior is due to using Count() as the Stat for the *-total metrics. Count() is a SampledStat, so the value it reports is the count in recent time windows, and the value decreases whenever a window is purged.&lt;/del&gt;&lt;/p&gt;
&lt;hr /&gt;
&lt;p&gt;&lt;del&gt;This explains the behavior I saw, but I think the issue is deeper. For example,&#160;processTimeSensor attempts to measure, process-latency-avg, process-latency-max, process-rate, and process-total.&#160;For that sensor, record is called like&lt;/del&gt;&lt;/p&gt;

&lt;p&gt;&lt;del&gt;streamsMetrics.processTimeSensor.record(computeLatency() / (double) processed, timerStartedMs);&lt;/del&gt;&lt;br/&gt;
 &lt;del&gt;so the value passed to record is average latency per processed message in this batch if I understand correctly. That gets pushed through to the call to Count#record, which increments it&apos;s count by 1, ignoring the value parameter. Whatever stat is recording the total would need to know is the number of messages processed. Because of that, I don&apos;t think it&apos;s possible for one Sensor to measure both latency and total.&lt;/del&gt;&lt;/p&gt;

&lt;p&gt;&lt;del&gt;That said, it&apos;s not clear to me how all the different Stats work and how exactly Sensors work, and I don&apos;t actually understand how the process-rate metric is working for similar reasons but that seems to be correct, so I may be missing something here.&lt;/del&gt;&lt;br/&gt;
 &#160;&lt;/p&gt;

&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13176563">KAFKA-7240</key>
            <summary>-total metrics in Streams are incorrect</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slendle">Sam Lendle</assignee>
                                    <reporter username="slendle">Sam Lendle</reporter>
                        <labels>
                    </labels>
                <created>Thu, 2 Aug 2018 20:35:27 +0000</created>
                <updated>Fri, 24 Aug 2018 18:22:32 +0000</updated>
                            <resolved>Fri, 24 Aug 2018 18:22:20 +0000</resolved>
                                    <version>2.0.0</version>
                                    <fixVersion>2.1.0</fixVersion>
                                    <component>metrics</component>
                    <component>streams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16567632" author="slendle" created="Fri, 3 Aug 2018 00:29:29 +0000"  >&lt;p&gt;I believe&#160;at least part of the&#160;issue is in &lt;a href=&quot;https://github.com/apache/kafka/blob/ee5cc974d2ef449444861d82e1793668184ca86f/streams/src/main/java/org/apache/kafka/streams/processor/internals/metrics/StreamsMetricsImpl.java#L352&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;StreamsMetricsImpl#addThroughputMetrics&lt;/a&gt;, which uses Count().&#160;Count() is a SampledStat, so the value it reports is the count in recent time windows, and the value decreases whenever a window is purged&lt;/p&gt;

&lt;p&gt;I think the fix there would be to use a non-SampledStat version of Count(), as Total() is to Rate.SampledTotal().&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16568382" author="vvcephei" created="Fri, 3 Aug 2018 15:51:03 +0000"  >&lt;p&gt;Thanks for the report &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slendle&quot; class=&quot;user-hover&quot; rel=&quot;slendle&quot;&gt;slendle&lt;/a&gt;. That does indeed sound like a mistake!&#160;&lt;/p&gt;

&lt;p&gt;Just a note, we&apos;d need a KIP to&#160;add a non-sampled Count metric in the `org.apache.kafka.common.metrics.stats` package.&lt;/p&gt;

&lt;p&gt;We could consider adding an internal implementation in Streams without a KIP, though...&lt;/p&gt;</comment>
                            <comment id="16568457" author="slendle" created="Fri, 3 Aug 2018 16:40:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vvcephei&quot; class=&quot;user-hover&quot; rel=&quot;vvcephei&quot;&gt;vvcephei&lt;/a&gt; I&apos;d like to work on it if I can avoid a KIP &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&#160;I&apos;ll take a stab at a PR.&lt;/p&gt;

&lt;p&gt;Edit: I see it&apos;s already assigned to you.&#160;Feel free to assign to me if you&apos;d like me to give it a try. Otherwise I&apos;ll hold off.&lt;/p&gt;</comment>
                            <comment id="16568557" author="vvcephei" created="Fri, 3 Aug 2018 18:12:27 +0000"  >&lt;p&gt;Oh, by all means, go ahead! I&apos;ll assign it to you.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;If you don&apos;t want to do a kip, just declare the non-metered count metric somewhere in a `streams...internals` package (thus, it wouldn&apos;t be a public interface change).&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;FYI, we&apos;re getting close to merging &lt;a href=&quot;https://github.com/apache/kafka/pull/5450,&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5450,&lt;/a&gt;&#160;which would affect your changeset, so you might want to either watch that PR and wait for the merge, or base your change on that branch.&lt;/p&gt;</comment>
                            <comment id="16568560" author="vvcephei" created="Fri, 3 Aug 2018 18:14:08 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slendle&quot; class=&quot;user-hover&quot; rel=&quot;slendle&quot;&gt;slendle&lt;/a&gt; For some reason, I can&apos;t assign this ticket to you... maybe you need some additional permission?&lt;/p&gt;</comment>
                            <comment id="16568581" author="mjsax" created="Fri, 3 Aug 2018 18:24:46 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slendle&quot; class=&quot;user-hover&quot; rel=&quot;slendle&quot;&gt;slendle&lt;/a&gt; I added you to the list of contributor and assigned the ticket. You can now also self-assign tickets. Thanks for reporting and picking this up!&lt;/p&gt;</comment>
                            <comment id="16572129" author="mjsax" created="Tue, 7 Aug 2018 18:35:00 +0000"  >&lt;p&gt;PR did not get auto-linked:&#160;&lt;a href=&quot;https://github.com/apache/kafka/pull/5467&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5467&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16592027" author="githubbot" created="Fri, 24 Aug 2018 18:21:00 +0000"  >&lt;p&gt;guozhangwang closed pull request #5467: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7240&quot; title=&quot;-total metrics in Streams are incorrect&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7240&quot;&gt;&lt;del&gt;KAFKA-7240&lt;/del&gt;&lt;/a&gt;: -total metrics in Streams are incorrect&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5467&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5467&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamTask.java b/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamTask.java&lt;br/&gt;
index 79df5d158a1..7f3d31fd776 100644&lt;br/&gt;
&amp;#8212; a/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamTask.java&lt;br/&gt;
+++ b/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamTask.java&lt;br/&gt;
@@ -41,6 +41,7 @@&lt;br/&gt;
 import org.apache.kafka.streams.processor.Punctuator;&lt;br/&gt;
 import org.apache.kafka.streams.processor.TaskId;&lt;br/&gt;
 import org.apache.kafka.streams.processor.TimestampExtractor;&lt;br/&gt;
+import org.apache.kafka.streams.processor.internals.metrics.CumulativeCount;&lt;br/&gt;
 import org.apache.kafka.streams.processor.internals.metrics.StreamsMetricsImpl;&lt;br/&gt;
 import org.apache.kafka.streams.state.internals.ThreadCache;&lt;/p&gt;

&lt;p&gt;@@ -109,7 +110,7 @@&lt;br/&gt;
             );&lt;br/&gt;
             parent.add(&lt;br/&gt;
                 new MetricName(&quot;commit-total&quot;, group, &quot;The total number of occurrence of commit operations.&quot;, allTagMap),&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;new Count()&lt;br/&gt;
+                new CumulativeCount()&lt;br/&gt;
             );&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;             // add the operation metrics with additional tags&lt;br/&gt;
@@ -129,7 +130,7 @@&lt;br/&gt;
             );&lt;br/&gt;
             taskCommitTimeSensor.add(&lt;br/&gt;
                 new MetricName(&quot;commit-total&quot;, group, &quot;The total number of occurrence of commit operations.&quot;, tagMap),&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;new Count()&lt;br/&gt;
+                new CumulativeCount()&lt;br/&gt;
             );&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;             // add the metrics for enforced processing&lt;br/&gt;
@@ -140,7 +141,7 @@&lt;br/&gt;
             );&lt;br/&gt;
             taskEnforcedProcessSensor.add(&lt;br/&gt;
                     new MetricName(&quot;enforced-process-total&quot;, group, &quot;The total number of occurrence of enforced-process operations.&quot;, tagMap),&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;new Count()&lt;br/&gt;
+                    new CumulativeCount()&lt;br/&gt;
             );&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         }&lt;br/&gt;
diff --git a/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamThread.java b/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamThread.java&lt;br/&gt;
index efd94eaf637..28cedbe4197 100644&lt;br/&gt;
&amp;#8212; a/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamThread.java&lt;br/&gt;
+++ b/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamThread.java&lt;br/&gt;
@@ -44,6 +44,7 @@&lt;br/&gt;
 import org.apache.kafka.streams.processor.TaskId;&lt;br/&gt;
 import org.apache.kafka.streams.processor.TaskMetadata;&lt;br/&gt;
 import org.apache.kafka.streams.processor.ThreadMetadata;&lt;br/&gt;
+import org.apache.kafka.streams.processor.internals.metrics.CumulativeCount;&lt;br/&gt;
 import org.apache.kafka.streams.processor.internals.metrics.StreamsMetricsImpl;&lt;br/&gt;
 import org.apache.kafka.streams.state.internals.ThreadCache;&lt;br/&gt;
 import org.slf4j.Logger;&lt;br/&gt;
@@ -437,7 +438,7 @@ StreamTask createTask(final Consumer&amp;lt;byte[], byte[]&amp;gt; consumer,&lt;br/&gt;
                 cache,&lt;br/&gt;
                 time,&lt;br/&gt;
                 () -&amp;gt; createProducer(taskId),&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;streamsMetrics.tasksClosedSensor);&lt;br/&gt;
+                streamsMetrics.taskClosedSensor);&lt;br/&gt;
         }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         private Producer&amp;lt;byte[], byte[]&amp;gt; createProducer(final TaskId id) {&lt;br/&gt;
@@ -518,7 +519,7 @@ StandbyTask createTask(final Consumer&amp;lt;byte[], byte[]&amp;gt; consumer,&lt;br/&gt;
         private final Sensor processTimeSensor;&lt;br/&gt;
         private final Sensor punctuateTimeSensor;&lt;br/&gt;
         private final Sensor taskCreatedSensor;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private final Sensor tasksClosedSensor;&lt;br/&gt;
+        private final Sensor taskClosedSensor;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         StreamsMetricsThreadImpl(final Metrics metrics, final String threadName) &lt;/p&gt;
{
             super(metrics, threadName);
@@ -532,7 +533,7 @@ StandbyTask createTask(final Consumer&amp;lt;byte[], byte[]&amp;gt; consumer,
             addAvgMaxLatency(pollTimeSensor, group, tagMap(), &quot;poll&quot;);
             // can&apos;t use addInvocationRateAndCount due to non-standard description string
             pollTimeSensor.add(metrics.metricName(&quot;poll-rate&quot;, group, &quot;The average per-second number of record-poll calls&quot;, tagMap()), new Rate(TimeUnit.SECONDS, new Count()));
-            pollTimeSensor.add(metrics.metricName(&quot;poll-total&quot;, group, &quot;The total number of record-poll calls&quot;, tagMap()), new Count());
+            pollTimeSensor.add(metrics.metricName(&quot;poll-total&quot;, group, &quot;The total number of record-poll calls&quot;, tagMap()), new CumulativeCount());
 
             processTimeSensor = threadLevelSensor(&quot;process-latency&quot;, Sensor.RecordingLevel.INFO);
             addAvgMaxLatency(processTimeSensor, group, tagMap(), &quot;process&quot;);
@@ -546,9 +547,9 @@ StandbyTask createTask(final Consumer&amp;lt;byte[], byte[]&amp;gt; consumer,
             taskCreatedSensor.add(metrics.metricName(&quot;task-created-rate&quot;, &quot;stream-metrics&quot;, &quot;The average per-second number of newly created tasks&quot;, tagMap()), new Rate(TimeUnit.SECONDS, new Count()));
             taskCreatedSensor.add(metrics.metricName(&quot;task-created-total&quot;, &quot;stream-metrics&quot;, &quot;The total number of newly created tasks&quot;, tagMap()), new Total());
 
-            tasksClosedSensor = threadLevelSensor(&quot;task-closed&quot;, Sensor.RecordingLevel.INFO);
-            tasksClosedSensor.add(metrics.metricName(&quot;task-closed-rate&quot;, group, &quot;The average per-second number of closed tasks&quot;, tagMap()), new Rate(TimeUnit.SECONDS, new Count()));
-            tasksClosedSensor.add(metrics.metricName(&quot;task-closed-total&quot;, group, &quot;The total number of closed tasks&quot;, tagMap()), new Total());
+            taskClosedSensor = threadLevelSensor(&quot;task-closed&quot;, Sensor.RecordingLevel.INFO);
+            taskClosedSensor.add(metrics.metricName(&quot;task-closed-rate&quot;, group, &quot;The average per-second number of closed tasks&quot;, tagMap()), new Rate(TimeUnit.SECONDS, new Count()));
+            taskClosedSensor.add(metrics.metricName(&quot;task-closed-total&quot;, group, &quot;The total number of closed tasks&quot;, tagMap()), new Total());
         }
&lt;p&gt;     }&lt;/p&gt;

&lt;p&gt;diff --git a/streams/src/main/java/org/apache/kafka/streams/processor/internals/metrics/CumulativeCount.java b/streams/src/main/java/org/apache/kafka/streams/processor/internals/metrics/CumulativeCount.java&lt;br/&gt;
new file mode 100644&lt;br/&gt;
index 00000000000..2c12c2b6e9d&lt;br/&gt;
&amp;#8212; /dev/null&lt;br/&gt;
+++ b/streams/src/main/java/org/apache/kafka/streams/processor/internals/metrics/CumulativeCount.java&lt;br/&gt;
@@ -0,0 +1,38 @@&lt;br/&gt;
+/*&lt;br/&gt;
+ * Licensed to the Apache Software Foundation (ASF) under one or more&lt;br/&gt;
+ * contributor license agreements. See the NOTICE file distributed with&lt;br/&gt;
+ * this work for additional information regarding copyright ownership.&lt;br/&gt;
+ * The ASF licenses this file to You under the Apache License, Version 2.0&lt;br/&gt;
+ * (the &quot;License&quot;); you may not use this file except in compliance with&lt;br/&gt;
+ * the License. You may obtain a copy of the License at&lt;br/&gt;
+ *&lt;br/&gt;
+ *    &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
+ *&lt;br/&gt;
+ * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
+ * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
+ * See the License for the specific language governing permissions and&lt;br/&gt;
+ * limitations under the License.&lt;br/&gt;
+ */&lt;br/&gt;
+package org.apache.kafka.streams.processor.internals.metrics;&lt;br/&gt;
+&lt;br/&gt;
+import org.apache.kafka.common.metrics.MeasurableStat;&lt;br/&gt;
+import org.apache.kafka.common.metrics.MetricConfig;&lt;br/&gt;
+&lt;br/&gt;
+/**&lt;br/&gt;
+ * A non-SampledStat version of Count for measuring -total metrics in streams&lt;br/&gt;
+ */&lt;br/&gt;
+public class CumulativeCount implements MeasurableStat {&lt;br/&gt;
+&lt;br/&gt;
+    private double count = 0.0;&lt;br/&gt;
+&lt;br/&gt;
+    @Override&lt;br/&gt;
+    public void record(final MetricConfig config, final double value, final long timeMs) &lt;/p&gt;
{
+        count += 1;
+    }
&lt;p&gt;+&lt;br/&gt;
+    @Override&lt;br/&gt;
+    public double measure(final MetricConfig config, final long now) &lt;/p&gt;
{
+        return count;
+    }
&lt;p&gt;+}&lt;br/&gt;
diff --git a/streams/src/main/java/org/apache/kafka/streams/processor/internals/metrics/StreamsMetricsImpl.java b/streams/src/main/java/org/apache/kafka/streams/processor/internals/metrics/StreamsMetricsImpl.java&lt;br/&gt;
index 56166a4d372..170311238ec 100644&lt;br/&gt;
&amp;#8212; a/streams/src/main/java/org/apache/kafka/streams/processor/internals/metrics/StreamsMetricsImpl.java&lt;br/&gt;
+++ b/streams/src/main/java/org/apache/kafka/streams/processor/internals/metrics/StreamsMetricsImpl.java&lt;br/&gt;
@@ -398,7 +398,7 @@ public static void addInvocationRateAndCount(final Sensor sensor,&lt;br/&gt;
                 &quot;The total number of occurrence of &quot; + operation + &quot; operations.&quot;,&lt;br/&gt;
                 tags&lt;br/&gt;
             ),&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;new Count()&lt;br/&gt;
+            new CumulativeCount()&lt;br/&gt;
         );&lt;br/&gt;
     }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;diff --git a/streams/src/test/java/org/apache/kafka/streams/processor/internals/StreamsMetricsImplTest.java b/streams/src/test/java/org/apache/kafka/streams/processor/internals/StreamsMetricsImplTest.java&lt;br/&gt;
index b065e2ca7b5..7ce27b4b6d6 100644&lt;br/&gt;
&amp;#8212; a/streams/src/test/java/org/apache/kafka/streams/processor/internals/StreamsMetricsImplTest.java&lt;br/&gt;
+++ b/streams/src/test/java/org/apache/kafka/streams/processor/internals/StreamsMetricsImplTest.java&lt;br/&gt;
@@ -17,11 +17,17 @@&lt;br/&gt;
 package org.apache.kafka.streams.processor.internals;&lt;/p&gt;


&lt;p&gt;+import org.apache.kafka.common.MetricName;&lt;br/&gt;
+import org.apache.kafka.common.metrics.KafkaMetric;&lt;br/&gt;
+import org.apache.kafka.common.metrics.MetricConfig;&lt;br/&gt;
 import org.apache.kafka.common.metrics.Metrics;&lt;br/&gt;
 import org.apache.kafka.common.metrics.Sensor;&lt;br/&gt;
+import org.apache.kafka.common.utils.MockTime;&lt;br/&gt;
 import org.apache.kafka.streams.processor.internals.metrics.StreamsMetricsImpl;&lt;br/&gt;
 import org.junit.Test;&lt;/p&gt;

&lt;p&gt;+import java.util.concurrent.TimeUnit;&lt;br/&gt;
+&lt;br/&gt;
 import static org.junit.Assert.assertEquals;&lt;/p&gt;

&lt;p&gt; public class StreamsMetricsImplTest {&lt;br/&gt;
@@ -96,4 +102,42 @@ public void testThroughputMetrics() &lt;/p&gt;
{
         streamsMetrics.removeSensor(sensor1);
         assertEquals(defaultMetrics, streamsMetrics.metrics().size());
     }
&lt;p&gt;+&lt;br/&gt;
+    @Test&lt;br/&gt;
+    public void testTotalMetricDoesntDecrease() {&lt;br/&gt;
+        final MockTime time = new MockTime(1);&lt;br/&gt;
+        final MetricConfig config = new MetricConfig().timeWindow(1, TimeUnit.MILLISECONDS);&lt;br/&gt;
+        final Metrics metrics = new Metrics(config, time);&lt;br/&gt;
+        final StreamsMetricsImpl streamsMetrics = new StreamsMetricsImpl(metrics, &quot;&quot;);&lt;br/&gt;
+&lt;br/&gt;
+        final String scope = &quot;scope&quot;;&lt;br/&gt;
+        final String entity = &quot;entity&quot;;&lt;br/&gt;
+        final String operation = &quot;op&quot;;&lt;br/&gt;
+&lt;br/&gt;
+        final Sensor sensor = streamsMetrics.addLatencyAndThroughputSensor(&lt;br/&gt;
+                scope,&lt;br/&gt;
+                entity,&lt;br/&gt;
+                operation,&lt;br/&gt;
+                Sensor.RecordingLevel.INFO&lt;br/&gt;
+        );&lt;br/&gt;
+&lt;br/&gt;
+        final double latency = 100.0;&lt;br/&gt;
+        final MetricName totalMetricName = metrics.metricName(&lt;br/&gt;
+                &quot;op-total&quot;,&lt;br/&gt;
+                &quot;stream-scope-metrics&quot;,&lt;br/&gt;
+                &quot;&quot;,&lt;br/&gt;
+                &quot;client-id&quot;,&lt;br/&gt;
+                &quot;&quot;,&lt;br/&gt;
+                &quot;scope-id&quot;,&lt;br/&gt;
+                &quot;entity&quot;&lt;br/&gt;
+        );&lt;br/&gt;
+&lt;br/&gt;
+        final KafkaMetric totalMetric = metrics.metric(totalMetricName);&lt;br/&gt;
+&lt;br/&gt;
+        for (int i = 0; i &amp;lt; 10; i++) &lt;/p&gt;
{
+            assertEquals(i, Math.round(totalMetric.measurable().measure(config, time.milliseconds())));
+            sensor.record(latency, time.milliseconds());
+        }
&lt;p&gt;+&lt;br/&gt;
+    }&lt;br/&gt;
 }&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16592030" author="guozhang" created="Fri, 24 Aug 2018 18:22:32 +0000"  >&lt;p&gt;Thanks for your contribution &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slendle&quot; class=&quot;user-hover&quot; rel=&quot;slendle&quot;&gt;slendle&lt;/a&gt;!!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 12 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3wmzj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>