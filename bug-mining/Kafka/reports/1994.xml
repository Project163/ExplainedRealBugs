<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:13:25 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-7144] Kafka Streams doesn&apos;t properly balance partition assignment</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-7144</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Kafka Streams doesn&apos;t always spread the tasks across all available instances/threads&lt;/p&gt;

&lt;p&gt;I have a topology which consumes a single partition topic and goes .through() a 12 partition topic. The makes 13 partitions.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I then started 2 instances of the application. I would have expected the&#160;13 partitions to be split across the 2 instances roughly evenly (7 partitions on one, 6 partitions on the other).&lt;/p&gt;

&lt;p&gt;Instead, one instance gets&#160;12 partitions, and the other instance gets 1 partition.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Repro case attached. I ran it a couple times, and it was fairly repeatable.&lt;/p&gt;

&lt;p&gt;Setup for the repro:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
$ ./bin/kafka-topics.sh --zookeeper localhost --create --topic one --partitions 1 --replication-factor 1 
$ ./bin/kafka-topics.sh --zookeeper localhost --create --topic twelve --partitions 12 --replication-factor 1
$ echo foo | kafkacat -P -b 127.0.0.1 -t one
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13171062">KAFKA-7144</key>
            <summary>Kafka Streams doesn&apos;t properly balance partition assignment</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="bbejeck">Bill Bejeck</assignee>
                                    <reporter username="wushujames">James Cheng</reporter>
                        <labels>
                    </labels>
                <created>Tue, 10 Jul 2018 05:12:32 +0000</created>
                <updated>Wed, 1 Aug 2018 16:49:27 +0000</updated>
                            <resolved>Wed, 25 Jul 2018 05:00:29 +0000</resolved>
                                    <version>1.1.0</version>
                                    <fixVersion>2.0.1</fixVersion>
                    <fixVersion>2.1.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="16539578" author="guozhang" created="Wed, 11 Jul 2018 05:20:27 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wushujames&quot; class=&quot;user-hover&quot; rel=&quot;wushujames&quot;&gt;wushujames&lt;/a&gt;, how many threads did you configure with these two instances?&lt;/p&gt;</comment>
                            <comment id="16539598" author="wushujames" created="Wed, 11 Jul 2018 06:00:03 +0000"  >&lt;p&gt;The attached repro java file has all the code. I didn&#8217;t specify any threads, so it was using the kafka streams default of 1 thread.&lt;/p&gt;

&lt;p&gt;Broker version was 1.1.0&lt;br/&gt;
Kafka stream version was 1.1.0&lt;/p&gt;</comment>
                            <comment id="16548341" author="githubbot" created="Wed, 18 Jul 2018 20:03:27 +0000"  >&lt;p&gt;bbejeck opened a new pull request #5390: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7144&quot; title=&quot;Kafka Streams doesn&amp;#39;t properly balance partition assignment&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7144&quot;&gt;&lt;del&gt;KAFKA-7144&lt;/del&gt;&lt;/a&gt;: Fix task assignment to be even&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5390&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5390&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   For this PR the following has been done:&lt;br/&gt;
   1. Sort all tasks before attempting to do an assignment.&lt;br/&gt;
   2. Remove the previous two loops (assign tasks to clients previously assigned as active and assign standby tasks to clients already assigned.&lt;br/&gt;
   3. Now all assignments occur in one loop checking first for reassigning previous active tasks, then previous standby tasks, then finally assign the task if the last two checks don&apos;t perform any assignment.&lt;/p&gt;

&lt;p&gt;   The net effect of this change is we are now favoring load balancing over stickiness from previously assigned tasks. &lt;/p&gt;

&lt;p&gt;   Updated current tests and ran locally&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16555137" author="githubbot" created="Wed, 25 Jul 2018 05:00:21 +0000"  >&lt;p&gt;guozhangwang closed pull request #5390: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7144&quot; title=&quot;Kafka Streams doesn&amp;#39;t properly balance partition assignment&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7144&quot;&gt;&lt;del&gt;KAFKA-7144&lt;/del&gt;&lt;/a&gt;: Fix task assignment to be even&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5390&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5390&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/streams/src/main/java/org/apache/kafka/streams/processor/internals/assignment/StickyTaskAssignor.java b/streams/src/main/java/org/apache/kafka/streams/processor/internals/assignment/StickyTaskAssignor.java&lt;br/&gt;
index 5b54d08c032..8767d0f6bea 100644&lt;br/&gt;
&amp;#8212; a/streams/src/main/java/org/apache/kafka/streams/processor/internals/assignment/StickyTaskAssignor.java&lt;br/&gt;
+++ b/streams/src/main/java/org/apache/kafka/streams/processor/internals/assignment/StickyTaskAssignor.java&lt;br/&gt;
@@ -270,7 +270,7 @@ boolean hasNewPair(final TaskId task1,&lt;br/&gt;
                 if (!active &amp;amp;&amp;amp; !pairs.contains(pair(task1, taskId))) &lt;/p&gt;
{
                     return true;
                 }&lt;br/&gt;
-                if (!pairs.contains(pair(task1, taskId)) &amp;amp;&amp;amp; task1.topicGroupId != taskId.topicGroupId) {&lt;br/&gt;
+                if (!pairs.contains(pair(task1, taskId))) {                     return true;                 }
&lt;p&gt;             }&lt;br/&gt;
diff --git a/streams/src/test/java/org/apache/kafka/streams/processor/internals/assignment/StickyTaskAssignorTest.java b/streams/src/test/java/org/apache/kafka/streams/processor/internals/assignment/StickyTaskAssignorTest.java&lt;br/&gt;
index ed22e3c30de..d431dbeae27 100644&lt;br/&gt;
&amp;#8212; a/streams/src/test/java/org/apache/kafka/streams/processor/internals/assignment/StickyTaskAssignorTest.java&lt;br/&gt;
+++ b/streams/src/test/java/org/apache/kafka/streams/processor/internals/assignment/StickyTaskAssignorTest.java&lt;br/&gt;
@@ -151,6 +151,25 @@ public void shouldAssignBasedOnCapacity() &lt;/p&gt;
{
         assertThat(clients.get(p2).activeTasks().size(), equalTo(2));
     }

&lt;p&gt;+    @Test&lt;br/&gt;
+    public void shouldAssignTasksEvenlyWithUnequalTopicGroupSizes() &lt;/p&gt;
{
+
+        createClientWithPreviousActiveTasks(p1, 1, task00, task01, task02, task03,
+                                                            task04, task05, task10);
+
+        createClient(p2, 1);
+
+        final StickyTaskAssignor taskAssignor = createTaskAssignor(task10, task00, task01, task02, task03, task04, task05);
+
+        final Set&amp;lt;TaskId&amp;gt; expectedClientITasks = new HashSet&amp;lt;&amp;gt;(Arrays.asList(task00, task01, task10, task05));
+        final Set&amp;lt;TaskId&amp;gt; expectedClientIITasks = new HashSet&amp;lt;&amp;gt;(Arrays.asList(task02, task03, task04));
+
+        taskAssignor.assign(0);
+
+        assertThat(clients.get(p1).activeTasks(), equalTo(expectedClientITasks));
+        assertThat(clients.get(p2).activeTasks(), equalTo(expectedClientIITasks));
+    }
&lt;p&gt;+&lt;br/&gt;
     @Test&lt;br/&gt;
     public void shouldKeepActiveTaskStickynessWhenMoreClientThanActiveTasks() {&lt;br/&gt;
         final int p5 = 5;&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12930950" name="OneThenTwelve.java" size="1432" author="wushujames" created="Tue, 10 Jul 2018 05:09:31 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 16 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3vpkn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>