<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:41:18 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-17696] New consumer background operations unaware of metadata errors</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-17696</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;When a metadata error happens (ie. Unauthorized topic), the network layer is the one to detect it and it just propagates it to the app thread via en ErrorEvent.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/kafka/blob/0edf5dbd204df9eb62bfea1b56993e95737df5a3/clients/src/main/java/org/apache/kafka/clients/consumer/internals/NetworkClientDelegate.java#L153&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/0edf5dbd204df9eb62bfea1b56993e95737df5a3/clients/src/main/java/org/apache/kafka/clients/consumer/internals/NetworkClientDelegate.java#L153&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;That allows api calls that processBackgroundEvents to throw the error in the app thread (ex. poll, unsubscribe and close, which are the only api calls that currently processBackgroundEvents).&lt;/p&gt;

&lt;p&gt;This means that all other api calls that do not processBackgroundEvent will never know about errors like Unauthorized topics. Moreover, it really means that the background operations are not notified/aborted when a metadata error happens (auth error). Ex. a call to position that blocks waiting for the updateFetchPositions (&lt;a href=&quot;https://github.com/apache/kafka/blob/0edf5dbd204df9eb62bfea1b56993e95737df5a3/clients/src/main/java/org/apache/kafka/clients/consumer/internals/AsyncKafkaConsumer.java#L1586&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;), will leave a&lt;br/&gt;
pendingOffsetFetchEvent waiting to complete, even when the background already got an Unauthorized exception (but it only passes it to the app thread via ErrorEvent)&lt;/p&gt;

&lt;p&gt;I wonder if we should ensure that metadata errors are not only propagated to the app thread via ErrorEvents, but also ensure that we notify all request managers in the background (so that they can decide if completeExceptionally their outstanding events). Ex. OffsetsRequestManager.onMetadataError should completeExceptionally the pendingOffsetFetchEvent (just first thought, there could be other approaches, but note that calling processBackgroundEvent in api calls like positions will not do because we would block first on the CheckAndUpdatePositions, then processBackgroundEvents that would only happen after the CheckAndUpdate)&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;This behaviour can be repro with the integration test AuthorizerIntegrationTest.testOffsetFetchWithNoAccess with the new consumer enabled (discovered with &lt;a href=&quot;https://github.com/apache/kafka/pull/17107&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/17107&lt;/a&gt; )&lt;br/&gt;
&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13594219">KAFKA-17696</key>
            <summary>New consumer background operations unaware of metadata errors</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="m1a2st">&#40643;&#31459;&#38525;</assignee>
                                    <reporter username="lianetm">Lianet Magrans</reporter>
                        <labels>
                            <label>consumer-threading-refactor</label>
                            <label>kip-848-client-support</label>
                    </labels>
                <created>Thu, 3 Oct 2024 18:16:19 +0000</created>
                <updated>Mon, 9 Dec 2024 14:40:37 +0000</updated>
                            <resolved>Mon, 9 Dec 2024 14:32:02 +0000</resolved>
                                                    <fixVersion>4.0.0</fixVersion>
                                    <component>clients</component>
                    <component>consumer</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="17886764" author="JIRAUSER305187" created="Thu, 3 Oct 2024 19:05:08 +0000"  >&lt;p&gt;Hello, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lianetm&quot; class=&quot;user-hover&quot; rel=&quot;lianetm&quot;&gt;lianetm&lt;/a&gt;, if you wont work on this, may I take the issue? Thank you.&lt;/p&gt;</comment>
                            <comment id="17886770" author="JIRAUSER300183" created="Thu, 3 Oct 2024 19:23:59 +0000"  >&lt;p&gt;Sure, thanks for your help! I haven&apos;t thought much about it yet but left an initial idea that comes to mind. Take a closer look and let me know if you have questions or think of other alternatives. Here to help! Once we sort this one out we should be closer to unblocking &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-17337&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-17337&lt;/a&gt; &#160;&lt;/p&gt;</comment>
                            <comment id="17887266" author="JIRAUSER305187" created="Mon, 7 Oct 2024 07:00:36 +0000"  >&lt;p&gt;Hello &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lianetm&quot; class=&quot;user-hover&quot; rel=&quot;lianetm&quot;&gt;lianetm&lt;/a&gt;, I want to confirm that my understanding is correct: Here are the two issues:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;The `&lt;tt&gt;ConsumerNetworkThread`&lt;/tt&gt; will not be able to send an `&lt;tt&gt;ErrorEvent`&lt;/tt&gt;, because in this case (Unauthorized topic), it does not fall within the scope of &lt;tt&gt;metadata. `maybeThrowAnyException()`&lt;/tt&gt; which handles `&lt;tt&gt;recoverableException()`&lt;/tt&gt;. Additionally, in the &lt;tt&gt;position&lt;/tt&gt; method of `&lt;tt&gt;AsyncKafkaConsumer`&lt;/tt&gt;, there is no mechanism to handle `&lt;tt&gt;ErrorEvent`&lt;/tt&gt;.&lt;/li&gt;
&lt;/ol&gt;


&lt;ol&gt;
	&lt;li&gt;The `&lt;tt&gt;ConsumerNetworkThread&lt;/tt&gt; `will keep polling until it times out. The issue here is how to interrupt this behavior when encountering such cases (e.g., Unauthorized topic).&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;In this cases if we send an ErrorEvent from &lt;tt&gt;ConsumerNetworkThread, it will be fail by `&lt;/tt&gt;&lt;br/&gt;
updateFetchPositions`due to&#160; it is blocking in `ConsumerUtils.getResult(event.future())`.&#160;&lt;br/&gt;
I don&apos;t have more idea about this way about OffsetsRequestManager.onMetadataError.&#160;&lt;br/&gt;
I will dig more in this issue&lt;/p&gt;</comment>
                            <comment id="17888330" author="JIRAUSER305187" created="Thu, 10 Oct 2024 15:50:22 +0000"  >&lt;p&gt;Hello &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lianetm&quot; class=&quot;user-hover&quot; rel=&quot;lianetm&quot;&gt;lianetm&lt;/a&gt; , I write a draft PR in &lt;span class=&quot;error&quot;&gt;&amp;#91;here&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://github.com/apache/kafka/pull/17440)&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/17440)&lt;/a&gt;&lt;br/&gt;
If you have time, please take a look. Thank you for your helping and suggestions.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="13593584">KAFKA-17648</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310040">
                    <name>Required</name>
                                                                <inwardlinks description="is required by">
                                        <issuelink>
            <issuekey id="13588764">KAFKA-17337</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 4 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1rs3s:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>