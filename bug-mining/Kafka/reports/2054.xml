<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:15:04 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-7403] Offset commit failure after upgrading brokers past KIP-211/KAFKA-4682</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-7403</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;I am currently trying broker upgrade from 0.11 to 2.0 with some patches including KIP-211/&lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-4682&quot; title=&quot;Committed offsets should not be deleted if a consumer is still active (KIP-211)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-4682&quot;&gt;&lt;del&gt;KAFKA-4682&lt;/del&gt;&lt;/a&gt;. After the upgrade, however, applications with 0.10.2 Kafka clients failed with the following error:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2018/09/11 19:34:52.814 ERROR Failed to commit offsets. Exiting. org.apache.kafka.common.KafkaException: Unexpected error in commit: The server experienced an unexpected error when processing the request at org.apache.kafka.clients.consumer.internals.ConsumerCoordinator$OffsetCommitResponseHandler.handle(ConsumerCoordinator.java:784) ~[kafka-clients-0.10.2.86.jar:?] at org.apache.kafka.clients.consumer.internals.ConsumerCoordinator$OffsetCommitResponseHandler.handle(ConsumerCoordinator.java:722) ~[kafka-clients-0.10.2.86.jar:?] at org.apache.kafka.clients.consumer.internals.AbstractCoordinator$CoordinatorResponseHandler.onSuccess(AbstractCoordinator.java:784) ~[kafka-clients-0.10.2.86.jar:?] at org.apache.kafka.clients.consumer.internals.AbstractCoordinator$CoordinatorResponseHandler.onSuccess(AbstractCoordinator.java:765) ~[kafka-clients-0.10.2.86.jar:?] at org.apache.kafka.clients.consumer.internals.RequestFuture$1.onSuccess(RequestFuture.java:186) ~[kafka-clients-0.10.2.86.jar:?] at org.apache.kafka.clients.consumer.internals.RequestFuture.fireSuccess(RequestFuture.java:149) ~[kafka-clients-0.10.2.86.jar:?] at org.apache.kafka.clients.consumer.internals.RequestFuture.complete(RequestFuture.java:116) ~[kafka-clients-0.10.2.86.jar:?] at org.apache.kafka.clients.consumer.internals.ConsumerNetworkClient$RequestFutureCompletionHandler.fireCompletion(ConsumerNetworkClient.java:493) ~[kafka-clients-0.10.2.86.jar:?] at org.apache.kafka.clients.consumer.internals.ConsumerNetworkClient.firePendingCompletedRequests(ConsumerNetworkClient.java:322) ~[kafka-clients-0.10.2.86.jar:?] at org.apache.kafka.clients.consumer.internals.ConsumerNetworkClient.poll(ConsumerNetworkClient.java:253) ~[kafka-clients-0.10.2.86.jar:?]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;From my reading of the code, it looks like the following happened:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;The 0.10.2 client sends a v2 OffsetCommitRequest to the broker. It sets the retentionTime field of the OffsetCommitRequest to DEFAULT_RETENTION_TIME.&lt;/li&gt;
	&lt;li&gt;In the 2.0 broker code, upon receiving an OffsetCommitRequest with DEFAULT_RETENTION_TIME, KafkaApis.handleOffsetCommitRequest() sets the &quot;expireTimestamp&quot; field of OffsetAndMetadata to None.&lt;/li&gt;
	&lt;li&gt;Later in the code path, GroupMetadataManager.offsetCommitValue() expects OffsetAndMetadata to have a non-empty &quot;expireTimestamp&quot; field if the inter.broker.protocol.version is &amp;lt; KAFKA_2_1_IV0.&lt;/li&gt;
	&lt;li&gt;However, the inter.broker.protocol.version was set to &quot;1.0&quot; prior to the upgrade, and as a result, the following code in offsetCommitValue() raises an error because expireTimestamp is None:
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
value.set(OFFSET_VALUE_EXPIRE_TIMESTAMP_FIELD_V1, offsetAndMetadata.expireTimestamp.get)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Here is the stack trace for the broker side error&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.util.NoSuchElementException: None.get
at scala.None$.get(Option.scala:347) ~[scala-library-2.11.12.jar:?]
at scala.None$.get(Option.scala:345) ~[scala-library-2.11.12.jar:?]
at kafka.coordinator.group.GroupMetadataManager$.offsetCommitValue(GroupMetadataManager.scala:1109) ~[kafka_2.11-2.0.0.10.jar:?]
at kafka.coordinator.group.GroupMetadataManager$$anonfun$7.apply(GroupMetadataManager.scala:326) ~[kafka_2.11-2.0.0.10.jar:?]
at kafka.coordinator.group.GroupMetadataManager$$anonfun$7.apply(GroupMetadataManager.scala:324) ~[kafka_2.11-2.0.0.10.jar:?]
at scala.collection.TraversableLike$$anonfun$map$1.apply(TraversableLike.scala:234) ~[scala-library-2.11.12.jar:?]
at scala.collection.TraversableLike$$anonfun$map$1.apply(TraversableLike.scala:234) ~[scala-library-2.11.12.jar:?]
at scala.collection.immutable.HashMap$HashMap1.foreach(HashMap.scala:221) ~[scala-library-2.11.12.jar:?]
at scala.collection.immutable.HashMap$HashTrieMap.foreach(HashMap.scala:428) ~[scala-library-2.11.12.jar:?]
at scala.collection.TraversableLike$&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;map(TraversableLike.scala:234) ~[scala-library-2.11.12.jar:?]
at scala.collection.AbstractTraversable.map(Traversable.scala:104) ~[scala-library-2.11.12.jar:?]
at kafka.coordinator.group.GroupMetadataManager.storeOffsets(GroupMetadataManager.scala:324) ~[kafka_2.11-2.0.0.10.jar:?]
at kafka.coordinator.group.GroupCoordinator$$anonfun$doCommitOffsets$1.apply$mcV$sp(GroupCoordinator.scala:521) ~[kafka_2.11-2.0.0.10.jar:?]
at kafka.coordinator.group.GroupCoordinator$$anonfun$doCommitOffsets$1.apply(GroupCoordinator.scala:506) ~[kafka_2.11-2.0.0.10.jar:?]
at kafka.coordinator.group.GroupCoordinator$$anonfun$doCommitOffsets$1.apply(GroupCoordinator.scala:506) ~[kafka_2.11-2.0.0.10.jar:?]
at kafka.utils.CoreUtils$.inLock(CoreUtils.scala:251) ~[kafka_2.11-2.0.0.10.jar:?]
at kafka.coordinator.group.GroupMetadata.inLock(GroupMetadata.scala:193) ~[kafka_2.11-2.0.0.10.jar:?]
at kafka.coordinator.group.GroupCoordinator.doCommitOffsets(GroupCoordinator.scala:505) ~[kafka_2.11-2.0.0.10.jar:?]
at kafka.coordinator.group.GroupCoordinator.handleCommitOffsets(GroupCoordinator.scala:484) ~[kafka_2.11-2.0.0.10.jar:?]
at kafka.server.KafkaApis.handleOffsetCommitRequest(KafkaApis.scala:359) ~[kafka_2.11-2.0.0.10.jar:?]
at kafka.server.KafkaApis.handle(KafkaApis.scala:114) ~[kafka_2.11-2.0.0.10.jar:?]
at kafka.server.KafkaRequestHandler.run(KafkaRequestHandler.scala:69) ~[kafka_2.11-2.0.0.10.jar:?]
at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)&#160;[?:1.8.0_121]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;And I was able to reproduce the error&#160;by passing KAFKA_0_11_0_IV2 as the ApiVersion (the second parameter) to the constructor of GroupMetadataManager in GroupMetadataManagerTest.scala.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vahid&quot; class=&quot;user-hover&quot; rel=&quot;vahid&quot;&gt;vahid&lt;/a&gt;, the error was from the code added for &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-4682&quot; title=&quot;Committed offsets should not be deleted if a consumer is still active (KIP-211)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-4682&quot;&gt;&lt;del&gt;KAFKA-4682&lt;/del&gt;&lt;/a&gt;. Can you take a look if this is indeed an issue?&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13184497">KAFKA-7403</key>
            <summary>Offset commit failure after upgrading brokers past KIP-211/KAFKA-4682</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="vahid">Vahid Hashemian</assignee>
                                    <reporter username="jonlee2">Jon Lee</reporter>
                        <labels>
                    </labels>
                <created>Tue, 11 Sep 2018 23:52:11 +0000</created>
                <updated>Tue, 30 Oct 2018 00:42:58 +0000</updated>
                            <resolved>Tue, 25 Sep 2018 16:08:18 +0000</resolved>
                                                    <fixVersion>2.1.0</fixVersion>
                                    <component>core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="16611393" author="hachikuji" created="Wed, 12 Sep 2018 00:09:26 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jonlee2&quot; class=&quot;user-hover&quot; rel=&quot;jonlee2&quot;&gt;jonlee2&lt;/a&gt; Thanks for the report. Would you mind changing the title to avoid confusion since KIP-211 was not actually in 2.0?&lt;/p&gt;</comment>
                            <comment id="16612461" author="jonlee2" created="Wed, 12 Sep 2018 16:57:44 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hachikuji&quot; class=&quot;user-hover&quot; rel=&quot;hachikuji&quot;&gt;hachikuji&lt;/a&gt; Thanks for the suggestion. Updated the title and also affected version.&lt;/p&gt;</comment>
                            <comment id="16616374" author="vahid" created="Sat, 15 Sep 2018 16:00:16 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jonlee2&quot; class=&quot;user-hover&quot; rel=&quot;jonlee2&quot;&gt;jonlee2&lt;/a&gt; could you please&#160;share more on how you reproduce the issue?&#160;When I run a v0.10.2 consumer (with the default &lt;tt&gt;consumer.properties&lt;/tt&gt;) against a v2 broker everything seems to be running smoothly.&#160;&lt;/p&gt;</comment>
                            <comment id="16618458" author="jonlee2" created="Tue, 18 Sep 2018 04:29:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vahid&quot; class=&quot;user-hover&quot; rel=&quot;vahid&quot;&gt;vahid&lt;/a&gt; Did you set inter.broker.protocol.version to something lower than 2.1 for your brokers and commit an offset from a consumer?&#160;&lt;/p&gt;

&lt;p&gt;BTW, it looks to me that the problem is not 0.10.2 consumer specific. Any consumer who would send out an OffsetCommitRequest with the&#160;retentionTime field set to DEFAULT_RETENTION_TIME will experience this error.&lt;/p&gt;

&lt;p&gt;I was able to reproduce the issue with the following setup:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;2.0 broker with &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-4682&quot; title=&quot;Committed offsets should not be deleted if a consumer is still active (KIP-211)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-4682&quot;&gt;&lt;del&gt;KAFKA-4682&lt;/del&gt;&lt;/a&gt; patch
	&lt;ul&gt;
		&lt;li&gt;inter.broker.protocol.version = 1.0&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;2.0 client
	&lt;ul&gt;
		&lt;li&gt;enable.auto.commit = true&lt;/li&gt;
		&lt;li&gt;auto.commit.interval.ms = 1000&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Then the client gets an error when it commits an offset:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
$ bin/kafka-console-consumer.sh --bootstrap-server localhost:9093 --consumer.config config/consumer.properties --topic t --from-beginning
:
&amp;lt;messages dumped&amp;gt;
:
[2018-09-17 21:17:30,828] ERROR [Consumer clientId=consumer-1, groupId=test-consumer-group] Offset commit failed on partition t-0 at offset 5: The server experienced an unexpected error when processing the request (org.apache.kafka.clients.consumer.internals.ConsumerCoordinator)
[2018-09-17 21:17:30,830] WARN [Consumer clientId=consumer-1, groupId=test-consumer-group] Asynchronous auto-commit of offsets {t-0=OffsetAndMetadata{offset=5, metadata=&apos;&apos;}} failed: Unexpected error in commit: The server experienced an unexpected error when processing the request (org.apache.kafka.clients.consumer.internals.ConsumerCoordinator)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;As mentioned above, to reproduce this in unit tests, pass KAFKA_0_11_0_IV2 instead of ApiVersion.latestVersion as the second parameter of the GroupMetadataManager constructor in GroupMetadataManagerTest.scala. Then, multiple tests including testCommitOffset fail.&lt;/p&gt;</comment>
                            <comment id="16622407" author="jonlee2" created="Thu, 20 Sep 2018 17:45:35 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vahid&quot; class=&quot;user-hover&quot; rel=&quot;vahid&quot;&gt;vahid&lt;/a&gt; Were you able to reproduce the issue with inter.broker.protocol.version set to &amp;lt; 2.1?&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I think KafkaApis.handleOffsetCommitRequest() should set expireTimestamp to None only if config.interBrokerProtocolVersion &amp;gt;= KAFKA_2_1_IV0 and offsetCommitRequest.retentionTime == OffsetCommitRequest.DEFAULT_RETENTON_TIME. Then, GroupMetadataManager.offsetCommitValue() can use V1 if expireTimestmp != None, V2 otherwise.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Also, questions about KafkaApis.handleOffsetCommitRequest(). The comments for commitTimestamp and expireTimestamp don&apos;t match with the code.&lt;/p&gt;

&lt;p&gt;For example,&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// commit timestamp is always set to now.&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;but&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
commitTimestamp = partitionData.timestamp match {
  &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; OffsetCommitRequest.DEFAULT_TIMESTAMP =&amp;gt; currentTimestamp
  &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; customTimestamp =&amp;gt; customTimestamp
},&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Also,&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// - If v1 and explicit commit timestamp is provided we calculate retention from that explicit commit timestamp&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;but&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
expireTimestamp = offsetCommitRequest.retentionTime match {
  &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; OffsetCommitRequest.DEFAULT_RETENTION_TIME =&amp;gt; None
  &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; retentionTime =&amp;gt; Some(currentTimestamp + retentionTime)
}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16622697" author="vahid" created="Thu, 20 Sep 2018 20:51:43 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jonlee2&quot; class=&quot;user-hover&quot; rel=&quot;jonlee2&quot;&gt;jonlee2&lt;/a&gt; Thanks for the additional info. I&apos;ll try to take a look over the weekend.&lt;/p&gt;</comment>
                            <comment id="16626228" author="hachikuji" created="Mon, 24 Sep 2018 18:36:18 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vahid&quot; class=&quot;user-hover&quot; rel=&quot;vahid&quot;&gt;vahid&lt;/a&gt; I was looking at this as part of &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7437&quot; title=&quot;Store leader epoch in offset commit metadata&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7437&quot;&gt;&lt;del&gt;KAFKA-7437&lt;/del&gt;&lt;/a&gt;. I think when setting the expiration timestamp for v1, we can use `getOrElse(OffsetCommitRequest.DEFAULT_TIMESTAMP)`. The code from old versions appears to already handle this value correctly by using the commit timestamp plus the retention time when loading the cache.&lt;/p&gt;</comment>
                            <comment id="16626774" author="vahid" created="Tue, 25 Sep 2018 05:03:56 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hachikuji&quot; class=&quot;user-hover&quot; rel=&quot;hachikuji&quot;&gt;hachikuji&lt;/a&gt; Thanks for the pointer. I will try to submit a PR with that fix, but please feel free to take over (since you proposed the solution).&lt;/p&gt;</comment>
                            <comment id="16626793" author="githubbot" created="Tue, 25 Sep 2018 05:27:23 +0000"  >&lt;p&gt;vahidhashemian opened a new pull request #5690: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7403&quot; title=&quot;Offset commit failure after upgrading brokers past KIP-211/KAFKA-4682&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7403&quot;&gt;&lt;del&gt;KAFKA-7403&lt;/del&gt;&lt;/a&gt;: Follow-up fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-4682&quot; title=&quot;Committed offsets should not be deleted if a consumer is still active (KIP-211)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-4682&quot;&gt;&lt;del&gt;KAFKA-4682&lt;/del&gt;&lt;/a&gt; (KIP-211) to correct some edge cases&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5690&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5690&lt;/a&gt;&lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16627571" author="githubbot" created="Tue, 25 Sep 2018 16:06:37 +0000"  >&lt;p&gt;hachikuji closed pull request #5690: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7403&quot; title=&quot;Offset commit failure after upgrading brokers past KIP-211/KAFKA-4682&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7403&quot;&gt;&lt;del&gt;KAFKA-7403&lt;/del&gt;&lt;/a&gt;: Follow-up fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-4682&quot; title=&quot;Committed offsets should not be deleted if a consumer is still active (KIP-211)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-4682&quot;&gt;&lt;del&gt;KAFKA-4682&lt;/del&gt;&lt;/a&gt; (KIP-211) to correct some edge cases&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5690&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5690&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/core/src/main/scala/kafka/coordinator/group/GroupMetadataManager.scala b/core/src/main/scala/kafka/coordinator/group/GroupMetadataManager.scala&lt;br/&gt;
index 8cf99fcc438..dba8b4e1810 100644&lt;br/&gt;
&amp;#8212; a/core/src/main/scala/kafka/coordinator/group/GroupMetadataManager.scala&lt;br/&gt;
+++ b/core/src/main/scala/kafka/coordinator/group/GroupMetadataManager.scala&lt;br/&gt;
@@ -40,7 +40,7 @@ import org.apache.kafka.common.protocol.Errors&lt;br/&gt;
 import org.apache.kafka.common.protocol.types.Type._&lt;br/&gt;
 import org.apache.kafka.common.protocol.types._&lt;br/&gt;
 import org.apache.kafka.common.record._&lt;br/&gt;
-import org.apache.kafka.common.requests.&lt;/p&gt;
{IsolationLevel, OffsetFetchResponse}
&lt;p&gt;+import org.apache.kafka.common.requests.&lt;/p&gt;
{IsolationLevel, OffsetCommitRequest, OffsetFetchResponse}
&lt;p&gt; import org.apache.kafka.common.requests.ProduceResponse.PartitionResponse&lt;br/&gt;
 import org.apache.kafka.common.utils.&lt;/p&gt;
{Time, Utils}

&lt;p&gt;@@ -1129,7 +1129,7 @@ object GroupMetadataManager &lt;/p&gt;
{
       value.set(OFFSET_VALUE_METADATA_FIELD_V1, offsetAndMetadata.metadata)
       value.set(OFFSET_VALUE_COMMIT_TIMESTAMP_FIELD_V1, offsetAndMetadata.commitTimestamp)
       // version 1 has a non empty expireTimestamp field
-      value.set(OFFSET_VALUE_EXPIRE_TIMESTAMP_FIELD_V1, offsetAndMetadata.expireTimestamp.get)
+      value.set(OFFSET_VALUE_EXPIRE_TIMESTAMP_FIELD_V1, offsetAndMetadata.expireTimestamp.getOrElse(OffsetCommitRequest.DEFAULT_TIMESTAMP))
     }

&lt;p&gt;     val byteBuffer = ByteBuffer.allocate(2 /* version */ + value.sizeOf)&lt;br/&gt;
diff --git a/core/src/main/scala/kafka/server/KafkaApis.scala b/core/src/main/scala/kafka/server/KafkaApis.scala&lt;br/&gt;
index afbe5b88204..10119c8d632 100644&lt;br/&gt;
&amp;#8212; a/core/src/main/scala/kafka/server/KafkaApis.scala&lt;br/&gt;
+++ b/core/src/main/scala/kafka/server/KafkaApis.scala&lt;br/&gt;
@@ -332,11 +332,10 @@ class KafkaApis(val requestChannel: RequestChannel,&lt;br/&gt;
       } else {&lt;br/&gt;
         // for version 1 and beyond store offsets in offset manager&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// commit timestamp is always set to now.&lt;br/&gt;
         // &quot;default&quot; expiration timestamp is now + retention (and retention may be overridden if v2)&lt;br/&gt;
         // expire timestamp is computed differently for v1 and v2.&lt;br/&gt;
         //   - If v1 and no explicit commit timestamp is provided we treat it the same as v5.&lt;/li&gt;
	&lt;li&gt;//   - If v1 and explicit commit timestamp is provided we calculate retention from that explicit commit timestamp&lt;br/&gt;
+        //   - If v1 and explicit retention time is provided we calculate expiration timestamp based on that&lt;br/&gt;
         //   - If v2/v3/v4 (no explicit commit timestamp) we treat it the same as v5.&lt;br/&gt;
         //   - For v5 and beyond there is no per partition expiration timestamp, so this field is no longer in effect&lt;br/&gt;
         val currentTimestamp = time.milliseconds&lt;/li&gt;
&lt;/ul&gt;





&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16632074" author="jonlee2" created="Fri, 28 Sep 2018 16:13:32 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vahid&quot; class=&quot;user-hover&quot; rel=&quot;vahid&quot;&gt;vahid&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hachikuji&quot; class=&quot;user-hover&quot; rel=&quot;hachikuji&quot;&gt;hachikuji&lt;/a&gt; Thank you very much for the patch.&#160;&lt;/p&gt;

&lt;p&gt;One question: Why is the expiration timestamp always based on current timestamp now? Previously, if there was custom commit timestamp provided, it was used to compute the expiration timestamp, instead of current timestamp.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16632659" author="vahid" created="Sat, 29 Sep 2018 00:03:34 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jonlee2&quot; class=&quot;user-hover&quot; rel=&quot;jonlee2&quot;&gt;jonlee2&lt;/a&gt; Thanks a lot for reporting it.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 7 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3xzmf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>