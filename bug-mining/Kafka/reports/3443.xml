<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:32:23 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-14729] The kafakConsumer pollForFetches(timer) method takes up a lot of cpu due to the abnormal exit of the heartbeat thread</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-14729</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;h2&gt;&lt;a name=&quot;casesituation%3A&quot;&gt;&lt;/a&gt;case situation:&lt;/h2&gt;

&lt;p&gt;1. The business program occupies a large amount of memory, causing the `run()` method of HeartbeatThread of kafkaConsumer to exit abnormally.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2023-02-14 06:55:57.771[][ERROR][AbstractCoordinator][kafka-coor][Consumer clientId=consumer-5, groupId=*****_dev_VA] Heartbeat thread failed due to unexpected error java.lang.OutOfMemoryError: Java heap space &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;2. The finally module of the heartbeat thread ` run()` method only prints the log, but does not update the value of `AbstractCoordinator.state`.&lt;br/&gt;
3. For kafkaConsumer with the groupRebalance mechanism enabled, in the `kafkaConsumer#pollForFetches(timer)` method, pollTimeout may eventually take the value `timeToNextHeartbeat(now)`.&lt;br/&gt;
4. Since the heartbeat thread has exited, `heartbeatTimer.deadlineMs` will never be updated again.&lt;br/&gt;
And the `AbstractCoordinator.state` field value will always be &lt;b&gt;STABLE&lt;/b&gt;,&lt;br/&gt;
So the `timeToNextHeartbeat(long now)` method will return &lt;font color=&quot;#ff0000&quot;&gt;0&lt;/font&gt;.&lt;br/&gt;
0 will be passed to the underlying `networkClient#poll` method.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;In the end, the user calls the `poll(duration)` method in an endless loop, and the `kafkaConsumer#pollForFetches(timer)` method will always return very quickly, taking up a lot of cpu.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;h2&gt;&lt;a name=&quot;solution%3A&quot;&gt;&lt;/a&gt;solution:&lt;/h2&gt;

&lt;p&gt;1. Refer to the note of `MemberState.STABLE` :&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
the client has joined and is sending heartbeats.&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;When the heartbeat thread exits, in `finally` module, we should add code:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
state = MemberState.UNJOINED;
closed = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;2. In the `AbstractCoordinator#timeToNextHeartbeat(now)` method, add a new judgment condition: `heartbeatThread.hasFailed()`&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (state.hasNotJoinedGroup() || heartbeatThread.hasFailed())
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;.MAX_VALUE;
&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; heartbeat.timeToNextHeartbeat(now);&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13525134">KAFKA-14729</key>
            <summary>The kafakConsumer pollForFetches(timer) method takes up a lot of cpu due to the abnormal exit of the heartbeat thread</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="RivenSun">RivenSun</assignee>
                                    <reporter username="RivenSun">RivenSun</reporter>
                        <labels>
                    </labels>
                <created>Fri, 17 Feb 2023 05:16:17 +0000</created>
                <updated>Thu, 2 Mar 2023 03:37:49 +0000</updated>
                            <resolved>Thu, 2 Mar 2023 03:37:49 +0000</resolved>
                                    <version>3.3.0</version>
                                    <fixVersion>3.5.0</fixVersion>
                                    <component>consumer</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="17690151" author="rivensun" created="Fri, 17 Feb 2023 05:29:10 +0000"  >&lt;p&gt;Hi&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt;&#160;&#160; ,&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=showuon&quot; class=&quot;user-hover&quot; rel=&quot;showuon&quot;&gt;showuon&lt;/a&gt;&lt;br/&gt;
Could you give some suggestions for this issue?&lt;br/&gt;
Thanks.&lt;/p&gt;</comment>
                            <comment id="17690166" author="rivensun" created="Fri, 17 Feb 2023 06:05:31 +0000"  >&lt;p&gt;1. After careful consideration, in the case of KafkaConsumer&apos;s normal close, in the `finally` module of heartbeatThread `run()` method:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
    log.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Heartbeat thread has closed&quot;&lt;/span&gt;);
    closed = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;2.The `AbstractCoordinator#timeToNextHeartbeat(now)` method is modified as follows:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; timeToNextHeartbeat(&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; now) {
    &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; we have not joined the group or we are preparing rebalance,
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// we don&apos;t need to send heartbeats
&lt;/span&gt;    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (state.hasNotJoinedGroup() ||
            (heartbeatThread != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; (heartbeatThread.hasFailed() || heartbeatThread.closed)))
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;.MAX_VALUE;
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; heartbeat.timeToNextHeartbeat(now);
}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The case of `heartbeatThread==null` is not considered. Because `heartbeatThread` will be updated to &lt;b&gt;null&lt;/b&gt; only after KafkaConsumer calls the `close()` method.&lt;/p&gt;</comment>
                            <comment id="17690218" author="showuon" created="Fri, 17 Feb 2023 07:56:44 +0000"  >&lt;p&gt;The change makes sense to me. But I&apos;m more interested in knowing why the heartbeat thread will be OOM? resource leak? Do you have any clue?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17690231" author="rivensun" created="Fri, 17 Feb 2023 08:08:24 +0000"  >&lt;p&gt;In fact, this is due to the abnormal code of the business side, which applied for a large amount of memory in a short period of time, reaching the maximum heap size requested by the java program.&lt;br/&gt;
In turn, it may cause the heartbeat thread to throw an OOM exception when creating HeartbeatRequest.&lt;/p&gt;

&lt;p&gt;And OOM is just one of the abnormal exit conditions of heartbeatThread.&lt;/p&gt;

&lt;p&gt;In short, when the heartbeat thread exits normally or abnormally, the closed field should be updated to true.&lt;/p&gt;


&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=showuon&quot; class=&quot;user-hover&quot; rel=&quot;showuon&quot;&gt;showuon&lt;/a&gt; Thanks for your reply.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13055540" name="image-2023-02-17-13-15-50-362.png" size="75754" author="RivenSun" created="Fri, 17 Feb 2023 05:15:52 +0000"/>
                            <attachment id="13055539" name="jstack_highCpu.txt" size="4303" author="RivenSun" created="Fri, 17 Feb 2023 05:16:10 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 38 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1g074:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>