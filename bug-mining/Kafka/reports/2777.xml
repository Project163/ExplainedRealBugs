<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:25:32 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-10134] High CPU issue during rebalance in Kafka consumer after upgrading to 2.5</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-10134</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;We want to utilize the new rebalance protocol to mitigate the stop-the-world effect during the rebalance as our tasks are long running task.&lt;/p&gt;

&lt;p&gt;But after the upgrade when we try to kill an instance to let rebalance happen when there is some load(some are long running tasks &amp;gt;30S) there, the CPU will go sky-high. It reads ~700% in our metrics so there should be several threads are in a tight loop. We have several consumer threads consuming from different partitions during the rebalance. This is reproducible in both the new&#160;CooperativeStickyAssignor and old eager rebalance rebalance protocol. The difference is that with old&#160;eager rebalance rebalance protocol used the high CPU usage will dropped after the rebalance done. But when using cooperative one, it seems the consumers threads are stuck on something and couldn&apos;t finish the rebalance so the high CPU usage won&apos;t drop until we stopped our load. Also a small load without long running task also won&apos;t cause continuous high CPU usage as the rebalance can finish in that case.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&quot;executor.kafka-consumer-executor-4&quot; #124 daemon prio=5 os_prio=0 cpu=76853.07ms elapsed=841.16s tid=0x00007fe11f044000 nid=0x1f4 runnable&#160; &lt;span class=&quot;error&quot;&gt;&amp;#91;0x00007fe119aab000&amp;#93;&lt;/span&gt;&quot;executor.kafka-consumer-executor-4&quot; #124 daemon prio=5 os_prio=0 cpu=76853.07ms elapsed=841.16s tid=0x00007fe11f044000 nid=0x1f4 runnable&#160; &lt;span class=&quot;error&quot;&gt;&amp;#91;0x00007fe119aab000&amp;#93;&lt;/span&gt;&#160; &#160;java.lang.Thread.State: RUNNABLE at org.apache.kafka.clients.consumer.internals.ConsumerCoordinator.poll(ConsumerCoordinator.java:467) at org.apache.kafka.clients.consumer.KafkaConsumer.updateAssignmentMetadataIfNeeded(KafkaConsumer.java:1275) at org.apache.kafka.clients.consumer.KafkaConsumer.poll(KafkaConsumer.java:1241) at org.apache.kafka.clients.consumer.KafkaConsumer.poll(KafkaConsumer.java:1216) at&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;By debugging into the code we found it looks like the clients are&#160; in a loop on finding the coordinator.&lt;/p&gt;

&lt;p&gt;I also tried the old rebalance protocol for the new version the issue still exists but the CPU will be back to normal when the rebalance is done.&lt;/p&gt;

&lt;p&gt;Also tried the same on the 2.4.1 which seems don&apos;t have this issue. So it seems related something changed between 2.4.1 and 2.5.0.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13310505">KAFKA-10134</key>
            <summary>High CPU issue during rebalance in Kafka consumer after upgrading to 2.5</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="guozhang">Guozhang Wang</assignee>
                                    <reporter username="seanguo">Sean Guo</reporter>
                        <labels>
                    </labels>
                <created>Wed, 10 Jun 2020 00:07:22 +0000</created>
                <updated>Thu, 15 Oct 2020 16:36:49 +0000</updated>
                            <resolved>Fri, 11 Sep 2020 01:05:03 +0000</resolved>
                                    <version>2.5.0</version>
                                    <fixVersion>2.6.1</fixVersion>
                    <fixVersion>2.7.0</fixVersion>
                                    <component>clients</component>
                        <due></due>
                            <votes>3</votes>
                                    <watches>19</watches>
                                                                                                                <comments>
                            <comment id="17134412" author="ijuma" created="Fri, 12 Jun 2020 17:25:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ableegoldman&quot; class=&quot;user-hover&quot; rel=&quot;ableegoldman&quot;&gt;ableegoldman&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt;&#160;Any idea?&lt;/p&gt;</comment>
                            <comment id="17136069" author="guozhang" created="Mon, 15 Jun 2020 17:50:59 +0000"  >&lt;p&gt;This is a bit weird to me &amp;#8211; discover of coordinator logic did not change from 2.4 -&amp;gt; 2.5 AFAIK.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=seanguo&quot; class=&quot;user-hover&quot; rel=&quot;seanguo&quot;&gt;seanguo&lt;/a&gt; could you list the configs of consumer when you used cooperative rebalance, v.s. eager rebalance?&lt;/p&gt;</comment>
                            <comment id="17136283" author="seanguo" created="Tue, 16 Jun 2020 04:24:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt;&#160;&lt;br/&gt;
Cooperative:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ConsumerConfig values: 
	allow.auto.create.topics = true
	auto.commit.interval.ms = 5000
	auto.offset.reset = latest
	bootstrap.servers = [xxx,xxx,xxx,xxx,xxx,xxx]
	check.crcs = true
	client.dns.lookup = default
	client.id = 
	client.rack = 
	connections.max.idle.ms = 540000
	default.api.timeout.ms = 60000
	enable.auto.commit = false
	exclude.internal.topics = true
	fetch.max.bytes = 52428800
	fetch.max.wait.ms = 500
	fetch.min.bytes = 1
	group.id = xxx-consumer-group
	group.instance.id = null
	heartbeat.interval.ms = 3000
	interceptor.classes = []
	internal.leave.group.on.close = true
	isolation.level = read_uncommitted
	key.deserializer = class com.cisco.wx2.kafka.serialization.SimpleKafkaDeserializer
	max.partition.fetch.bytes = 1048576
	max.poll.interval.ms = 1800000
	max.poll.records = 10
	metadata.max.age.ms = 300000
	metric.reporters = []
	metrics.num.samples = 2
	metrics.recording.level = INFO
	metrics.sample.window.ms = 30000
	partition.assignment.strategy = [org.apache.kafka.clients.consumer.CooperativeStickyAssignor]
	receive.buffer.bytes = 65536
	reconnect.backoff.max.ms = 1000
	reconnect.backoff.ms = 50
	request.timeout.ms = 30000
	retry.backoff.ms = 100
	sasl.client.callback.handler.class = null
	sasl.jaas.config = null
	sasl.kerberos.kinit.cmd = /usr/bin/kinit
	sasl.kerberos.min.time.before.relogin = 60000
	sasl.kerberos.service.name = null
	sasl.kerberos.ticket.renew.jitter = 0.05
	sasl.kerberos.ticket.renew.window.factor = 0.8
	sasl.login.callback.handler.class = null
	sasl.login.class = null
	sasl.login.refresh.buffer.seconds = 300
	sasl.login.refresh.min.period.seconds = 60
	sasl.login.refresh.window.factor = 0.8
	sasl.login.refresh.window.jitter = 0.05
	sasl.mechanism = GSSAPI
	security.protocol = SSL
	security.providers = null
	send.buffer.bytes = 131072
	session.timeout.ms = 30000
	ssl.cipher.suites = null
	ssl.enabled.protocols = [TLSv1.2, TLSv1.1, TLSv1]
	ssl.endpoint.identification.algorithm = https
	ssl.key.password = null
	ssl.keymanager.algorithm = SunX509
	ssl.keystore.location = null
	ssl.keystore.password = null
	ssl.keystore.type = JKS
	ssl.protocol = TLS
	ssl.provider = null
	ssl.secure.random.implementation = null
	ssl.trustmanager.algorithm = PKIX
	ssl.truststore.location = null
	ssl.truststore.password = null
	ssl.truststore.type = JKS
	value.deserializer = class com.cisco.wx2.kafka.serialization.SimpleKafkaDeserializer
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Eager:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ConsumerConfig values: 
	allow.auto.create.topics = true
	auto.commit.interval.ms = 5000
	auto.offset.reset = latest
	bootstrap.servers = [xxx,xxx,xxx,xxx,xxx,xxx]
	check.crcs = true
	client.dns.lookup = default
	client.id = 
	client.rack = 
	connections.max.idle.ms = 540000
	default.api.timeout.ms = 60000
	enable.auto.commit = false
	exclude.internal.topics = true
	fetch.max.bytes = 52428800
	fetch.max.wait.ms = 500
	fetch.min.bytes = 1
	group.id = xxx-consumer-group
	group.instance.id = null
	heartbeat.interval.ms = 3000
	interceptor.classes = []
	internal.leave.group.on.close = true
	isolation.level = read_uncommitted
	key.deserializer = class com.cisco.wx2.kafka.serialization.SimpleKafkaDeserializer
	max.partition.fetch.bytes = 1048576
	max.poll.interval.ms = 1800000
	max.poll.records = 10
	metadata.max.age.ms = 300000
	metric.reporters = []
	metrics.num.samples = 2
	metrics.recording.level = INFO
	metrics.sample.window.ms = 30000
	partition.assignment.strategy = [class org.apache.kafka.clients.consumer.RangeAssignor]
	receive.buffer.bytes = 65536
	reconnect.backoff.max.ms = 1000
	reconnect.backoff.ms = 50
	request.timeout.ms = 30000
	retry.backoff.ms = 100
	sasl.client.callback.handler.class = null
	sasl.jaas.config = null
	sasl.kerberos.kinit.cmd = /usr/bin/kinit
	sasl.kerberos.min.time.before.relogin = 60000
	sasl.kerberos.service.name = null
	sasl.kerberos.ticket.renew.jitter = 0.05
	sasl.kerberos.ticket.renew.window.factor = 0.8
	sasl.login.callback.handler.class = null
	sasl.login.class = null
	sasl.login.refresh.buffer.seconds = 300
	sasl.login.refresh.min.period.seconds = 60
	sasl.login.refresh.window.factor = 0.8
	sasl.login.refresh.window.jitter = 0.05
	sasl.mechanism = GSSAPI
	security.protocol = SSL
	security.providers = null
	send.buffer.bytes = 131072
	session.timeout.ms = 30000
	ssl.cipher.suites = null
	ssl.enabled.protocols = [TLSv1.2, TLSv1.1, TLSv1]
	ssl.endpoint.identification.algorithm = https
	ssl.key.password = null
	ssl.keymanager.algorithm = SunX509
	ssl.keystore.location = null
	ssl.keystore.password = null
	ssl.keystore.type = JKS
	ssl.protocol = TLS
	ssl.provider = null
	ssl.secure.random.implementation = null
	ssl.trustmanager.algorithm = PKIX
	ssl.truststore.location = null
	ssl.truststore.password = null
	ssl.truststore.type = JKS
	value.deserializer = class com.cisco.wx2.kafka.serialization.SimpleKafkaDeserializer
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;With 2.5.1 we can reproduce the high CPU issue with both eager and cooperative rebalancing protocol but not in 2.4.1. The difference between eager and cooperative with 2.5.1 is that for eager rebalance the CPU can go back to normal after the rebalance is done but for cooperative it seems it stuck on rebalancing and never ends.&lt;/p&gt;</comment>
                            <comment id="17143840" author="ijuma" created="Wed, 24 Jun 2020 13:27:39 +0000"  >&lt;p&gt;Any additional thoughts &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt;? &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=seanguo&quot; class=&quot;user-hover&quot; rel=&quot;seanguo&quot;&gt;seanguo&lt;/a&gt;&#160;would you be able to share a profile of the consumer while the high CPU usage is going on?&lt;/p&gt;</comment>
                            <comment id="17144355" author="rhauch" created="Wed, 24 Jun 2020 20:25:55 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ijuma&quot; class=&quot;user-hover&quot; rel=&quot;ijuma&quot;&gt;ijuma&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=seanguo&quot; class=&quot;user-hover&quot; rel=&quot;seanguo&quot;&gt;seanguo&lt;/a&gt;: what&apos;s the status of this? Do we want to continue treating this as a blocker for the 2.6.0 release? If so, what&apos;s the timeframe for fixing this?&lt;/p&gt;

&lt;p&gt;If this should not block the release, should we downgrade the priority and/or change the fix versions to 2.6.1 and/or 2.7.0?&lt;/p&gt;</comment>
                            <comment id="17146368" author="neowu0" created="Fri, 26 Jun 2020 14:42:04 +0000"  >&lt;p&gt;we have experienced same issue,&lt;/p&gt;

&lt;p&gt;one easy way to reproduce is: 1. start both kafka server and java consumer thread 2. stop kafka&lt;/p&gt;

&lt;p&gt;then you should observe consumer thread keeps busy cpu loop and cause very high cpu&lt;/p&gt;

&lt;p&gt;the reason is due to java consumer 2.5.0 code change&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// code placeholder
&lt;/span&gt;org.apache.kafka.clients.consumer.KafkaConsumer  line: 1235
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (includeMetadataInTimeout) {
    &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; to update assignment metadata BUT &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; not need to block on the timer,
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// since even &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; we are 1) in the middle of a rebalance or 2) have partitions
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// with unknown starting positions we may still want to &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; some data
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// as &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; as there are some partitions fetchable; NOTE we always use a timer with 0ms
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// to never block on completing the rebalance procedure &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; there&apos;s any
&lt;/span&gt;    updateAssignmentMetadataIfNeeded(time.timer(0L));
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;if it fails to fetch metadata, this line never blocks, and it run thru and keep cpu busy loop, due to&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// code placeholder
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (timer.notExpired());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;please help on this issue, this is blocker for us to upgrade to java client 2.5.0&lt;/p&gt;

&lt;p&gt;it&apos;s particular bad if we deploy both kafka/java consumer in same VM/(k8s node)&lt;br/&gt;
 if something wrong make kafka hiccup, all java consumers cause cpu high, and make kafka even slower to recover (like restart by k8s), and eventually make entire node/VM not be able to going forward.&#160;&lt;/p&gt;

&lt;p&gt;(java consumers keep busy loop to wait kafka ready, kafka has too little cpu to move on)&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17146391" author="neowu0" created="Fri, 26 Jun 2020 15:17:50 +0000"  >&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; {
    client.maybeTriggerWakeup();

    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (includeMetadataInTimeout) {
        &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; to update assignment metadata BUT &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; not need to block on the timer,
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// since even &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; we are 1) in the middle of a rebalance or 2) have partitions
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// with unknown starting positions we may still want to &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; some data
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// as &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; as there are some partitions fetchable; NOTE we always use a timer with 0ms
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// to never block on completing the rebalance procedure &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; there&apos;s any
&lt;/span&gt;        updateAssignmentMetadataIfNeeded(time.timer(0L));
    } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
        &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (!updateAssignmentMetadataIfNeeded(time.timer(&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;.MAX_VALUE))) {
            log.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;Still waiting &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; metadata&quot;&lt;/span&gt;);
        }
    }

    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Map&amp;lt;TopicPartition, List&amp;lt;ConsumerRecord&amp;lt;K, V&amp;gt;&amp;gt;&amp;gt; records = pollForFetches(timer);
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!records.isEmpty()) {
        &lt;span class=&quot;code-comment&quot;&gt;// before returning the fetched records, we can send off the next round of fetches
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// and avoid block waiting &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; their responses to enable pipelining &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; the user
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// is handling the fetched records.
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;//
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// NOTE: since the consumed position has already been updated, we must not allow
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// wakeups or any other errors to be triggered prior to returning the fetched records.
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (fetcher.sendFetches() &amp;gt; 0 || client.hasPendingRequests()) {
            client.transmitSends();
        }

        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.interceptors.onConsume(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ConsumerRecords&amp;lt;&amp;gt;(records));
    }
} &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (timer.notExpired());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;from the current design, i guess one possible fix is to add exponentially retry if metadata is not available and nothing returned by&#160;pollForFetches(timer), until timer expired.&lt;/p&gt;


&lt;p&gt;then let outside application code to call consumer.poll(timeout) again&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17146678" author="guozhang" created="Fri, 26 Jun 2020 22:25:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=seanguo&quot; class=&quot;user-hover&quot; rel=&quot;seanguo&quot;&gt;seanguo&lt;/a&gt; I think &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=neowu0&quot; class=&quot;user-hover&quot; rel=&quot;neowu0&quot;&gt;neowu0&lt;/a&gt;&apos;s brought up issue is a valid one to tackle, but I&apos;m not sure if it is the same root cause you&apos;ve seen: basically the consumer maybe tied in the metadata refresh loop if it cannot find the coordinator, but that is only the case if the coordinator broker is indeed not available during that time.&lt;/p&gt;

&lt;p&gt;In your observation though, there should be no broker unavailability since you&apos;re just bouncing the consumer instance and the coordinator should be quick to discover.&lt;/p&gt;</comment>
                            <comment id="17146706" author="guozhang" created="Sat, 27 Jun 2020 00:42:20 +0000"  >&lt;p&gt;I&apos;ve provided a PR for trunk, but it should apply cleanly to 2.5 as well (I will cherry-pick this when merging). &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=neowu0&quot; class=&quot;user-hover&quot; rel=&quot;neowu0&quot;&gt;neowu0&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=seanguo&quot; class=&quot;user-hover&quot; rel=&quot;seanguo&quot;&gt;seanguo&lt;/a&gt; please let me know if you could apply the patch and verify if it helps resolving the issue.&lt;/p&gt;</comment>
                            <comment id="17146721" author="neowu0" created="Sat, 27 Jun 2020 01:27:01 +0000"  >&lt;p&gt;Hi, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Thanks for quick update!&#160;&lt;/p&gt;

&lt;p&gt;I reviewed and tested your patch, and still found some issue&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (subscriptions.fetchablePartitions(tp -&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;).isEmpty()) {
    updateAssignmentMetadataIfNeeded(timer);
} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Timer updateMetadataTimer = time.timer(0L);
    updateAssignmentMetadataIfNeeded(updateMetadataTimer);
    timer.update(updateMetadataTimer.currentTimeMs());
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;there are 2&#160;scenarios&lt;br/&gt;
1) start java consumer with kafka stopped, the code work as expected, it flows to first branch, and wait with timer,&#160;&lt;br/&gt;
and will be able to connect to kafka when kafka is up (with low cpu usage due to timer)&lt;/p&gt;

&lt;p&gt;however in 2nd secnarios&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;2) start both java consumer and kafka, and let java consumer successfully subscribe some topics, then force stop kafka&lt;br/&gt;
then&#160;subscriptions.fetchablePartitions(tp -&amp;gt; true) will return non empty result, then it will go into second branch without blocking&lt;br/&gt;
and it will trigger busy cpu wait&lt;/p&gt;

&lt;p&gt;Thanks,&lt;/p&gt;</comment>
                            <comment id="17146723" author="neowu0" created="Sat, 27 Jun 2020 01:41:52 +0000"  >&lt;p&gt;maybe besides&#160;fetchablePartitions, it also should check&#160;records = pollForFetches(timer)?&lt;/p&gt;</comment>
                            <comment id="17146724" author="neowu0" created="Sat, 27 Jun 2020 01:48:51 +0000"  >&lt;p&gt;something like this fix my issues, but i am not sure whether this is right thing to do to fit bigger picture&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// poll &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; data until the timeout expires
&lt;/span&gt;Map&amp;lt;TopicPartition, List&amp;lt;ConsumerRecord&amp;lt;K, V&amp;gt;&amp;gt;&amp;gt; records = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
&lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; {
    client.maybeTriggerWakeup();
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (includeMetadataInTimeout) {
        &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; to update assignment metadata BUT &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; not need to block on the timer &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; we still have
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// some assigned partitions, since even &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; we are 1) in the middle of a rebalance
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// or 2) have partitions with unknown starting positions we may still want to &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; some data
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// as &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; as there are some partitions fetchable; NOTE we always use a timer with 0ms
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// to never block on completing the rebalance procedure &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; there&apos;s any
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (subscriptions.fetchablePartitions(tp -&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;).isEmpty() || records == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; || records.isEmpty()) {
            updateAssignmentMetadataIfNeeded(timer);
        } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
            &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Timer updateMetadataTimer = time.timer(0L);
            updateAssignmentMetadataIfNeeded(updateMetadataTimer);
            timer.update(updateMetadataTimer.currentTimeMs());
        }
    } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
        &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (!updateAssignmentMetadataIfNeeded(time.timer(&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;.MAX_VALUE))) {
            log.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;Still waiting &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; metadata&quot;&lt;/span&gt;);
        }
    }

    records = pollForFetches(timer);
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!records.isEmpty()) {
        &lt;span class=&quot;code-comment&quot;&gt;// before returning the fetched records, we can send off the next round of fetches
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// and avoid block waiting &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; their responses to enable pipelining &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; the user
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// is handling the fetched records.
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;//
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// NOTE: since the consumed position has already been updated, we must not allow
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// wakeups or any other errors to be triggered prior to returning the fetched records.
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (fetcher.sendFetches() &amp;gt; 0 || client.hasPendingRequests()) {
            client.transmitSends();
        }

        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.interceptors.onConsume(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ConsumerRecords&amp;lt;&amp;gt;(records));
    }
} &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (timer.notExpired());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17146776" author="seanguo" created="Sat, 27 Jun 2020 04:21:43 +0000"  >&lt;p&gt;We can try the patch next week to see whether this also addresses the issue we met as we had also seen a lots of operations on finding the coordinator when this issue happens.&lt;/p&gt;</comment>
                            <comment id="17148183" author="guozhang" created="Mon, 29 Jun 2020 22:50:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=neowu0&quot; class=&quot;user-hover&quot; rel=&quot;neowu0&quot;&gt;neowu0&lt;/a&gt; What&apos;s still puzzling me is that, even in the second branch, since we always keep calling `timer.update` then we should still eventually exit the while loop with `timer.expired`. So why would we observe that it blocks inside the while-loop forever is not clear to me.&lt;/p&gt;</comment>
                            <comment id="17148190" author="guozhang" created="Mon, 29 Jun 2020 23:00:18 +0000"  >&lt;p&gt;Here&apos;s my reasoning: if there are still some owned partitions that are fetchable even during a rebalance, then within the while-loop even if we exit the updateAssignmentMetadataIfNeeded we can still try to fetch from then and then break out of the while loop. However, if we do not have fetchable partitions then we may be blocked in the while-loop for a long time until the poll timeout expires. During this period of time we would then see high CPU usage indeed. I think &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=neowu0&quot; class=&quot;user-hover&quot; rel=&quot;neowu0&quot;&gt;neowu0&lt;/a&gt;&apos;s idea is better: we should also use long poll if there are fetchable partitions but not data fetched.&lt;/p&gt;

&lt;p&gt;What&apos;s puzzling me however, is that even in that case we should still be able to exit the busy while-loop eventually since the `timer.update` should still be called in pollForFetches within that while loop and hence advance the timer, why with cooperative rebalance we would block inside the while loop forever is not clear to me.&lt;/p&gt;</comment>
                            <comment id="17148244" author="neowu0" created="Tue, 30 Jun 2020 01:31:35 +0000"  >&lt;p&gt;Hi,&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;for &quot;What&apos;s still puzzling me is that, even in the second branch, since we always keep calling `timer.update` then we should still eventually exit the while loop with `timer.expired`. So why would we observe that it blocks inside the while-loop forever is not clear to me.&quot;&lt;/p&gt;

&lt;p&gt;yes, it will exit while loop eventually, but usually the app code is like following (at least in my case)&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (!shutdown) {
    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
        ConsumerRecords&amp;lt;&lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[], &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[]&amp;gt; records = consumer.poll(Duration.ofSeconds(30));
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (records.isEmpty()) &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;;
        processRecords(records);
    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Throwable e) {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (shutdown) &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
        logger.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;failed to pull message, retry in 10 seconds&quot;&lt;/span&gt;, e);
        Threads.sleepRoughly(Duration.ofSeconds(10));
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;so during 30s, if kafak is down in the middle, since&#160;fetchablePartitions return non-empty, the consumer.poll keeps busy loop,&lt;/p&gt;

&lt;p&gt;and as soon as it exists, the application usually will try to poll immediately.&lt;/p&gt;

&lt;p&gt;in application level, sure i can put delay if poll return empty, but still it will trigger high cpu time to time, and timeout passed into consumer.poll can&apos;t be high, say if i use 5 secs,&lt;/p&gt;

&lt;p&gt;in the second case, the thread acts&#160;like, high cpu 5sec, -&amp;gt; sleep 5s -&amp;gt; 100%cpu 5s, (which is still not considered as healthy behavior)&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17148261" author="guozhang" created="Tue, 30 Jun 2020 02:21:46 +0000"  >&lt;p&gt;Hey &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=neowu0&quot; class=&quot;user-hover&quot; rel=&quot;neowu0&quot;&gt;neowu0&lt;/a&gt; thanks a lot for your comments. Much appreciated!&lt;/p&gt;

&lt;p&gt;Just to clarify, what I was puzzling is the original observation that &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=seanguo&quot; class=&quot;user-hover&quot; rel=&quot;seanguo&quot;&gt;seanguo&lt;/a&gt; made, that is with eager rebalance we would eventually escape the while-loop / high CPU, whereas with the new cooperative rebalance protocol we are stuck in this loop. Do you observe the same pattern? If yes what&apos;s your take on it?&lt;/p&gt;</comment>
                            <comment id="17148269" author="neowu0" created="Tue, 30 Jun 2020 02:49:20 +0000"  >&lt;p&gt;What I observed is not exactly same as Sean, I only tested client 2.5.0 on test env, where all kafka/app pod are in one k8s node.&lt;/p&gt;

&lt;p&gt;and during k8s deployment, new pod joins and old pod fades out (this is similar as Sean&apos;s case),&lt;/p&gt;

&lt;p&gt;during the deployment, since the new pod (consumer) are not fully joined the kafka consumer group yet, it causes high cpu, and made kafka even slower to assign group, and eventually it goes to negative loop, make both new pod and kafka stuck.&lt;/p&gt;

&lt;p&gt;i suppose Sean&apos;s case is more or less similar, and the current fix should be able to resolve it.&#160;&lt;/p&gt;</comment>
                            <comment id="17148854" author="guozhang" created="Tue, 30 Jun 2020 17:35:00 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=neowu0&quot; class=&quot;user-hover&quot; rel=&quot;neowu0&quot;&gt;neowu0&lt;/a&gt; Thanks for your comments. I will incorporate them in my PR and ping you and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=seanguo&quot; class=&quot;user-hover&quot; rel=&quot;seanguo&quot;&gt;seanguo&lt;/a&gt; to test out before merging.&lt;/p&gt;</comment>
                            <comment id="17149122" author="guozhang" created="Wed, 1 Jul 2020 05:37:14 +0000"  >&lt;p&gt;I&apos;ve updated the PR.&lt;/p&gt;</comment>
                            <comment id="17149812" author="seanguo" created="Thu, 2 Jul 2020 04:20:45 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; Looks like this also resolves our issue. After applied this patch the high CPU issue is not reproduced in our local environment. Thank you for the quick fix. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=neowu0&quot; class=&quot;user-hover&quot; rel=&quot;neowu0&quot;&gt;neowu0&lt;/a&gt; Thank you for pointing out the cause of this issue.&lt;br/&gt;
One thing to note is the latest code in the PR has a small issue &quot;random.nextInt(2 &amp;lt;&amp;lt; retries)&quot; when retries is larger than 30 , this method will throw exception, we have modified to use timer.remainingMs() instead in that situation.&lt;/p&gt;</comment>
                            <comment id="17151465" author="guozhang" created="Sun, 5 Jul 2020 03:24:03 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=seanguo&quot; class=&quot;user-hover&quot; rel=&quot;seanguo&quot;&gt;seanguo&lt;/a&gt; thanks for confirming! As the root cause is known now I&apos;ve thought about an alternative solution to fix it: I think ideally we would split &lt;tt&gt;updateAssignmentMetadataIfNeeded&lt;/tt&gt; into three different logic: 1) discover coordinator if necessary, 2) join-group if necessary, 3) refresh metadata and fetch position if necessary. Then we can just make 2) to be best-effort if there are still some fetchable partitions.&lt;/p&gt;


&lt;p&gt;But that&#8217;s a rather big change to make as a last minute blocker fix for 2.6, so I made a smaller change to make updateAssignmentMetadataIfNeeded has an optional boolean flag to indicate if 2) above should wait until either expired or complete, otherwise do not wait on the join-group future and just try once with the timer which would return if there&#8217;s anything written on the socket. I&#8217;ve updated the PR for this, if people agree this would be a reasonable fix for 2.6 I can add the test coverage and merge it. LMK.&lt;/p&gt;</comment>
                            <comment id="17152199" author="rhauch" created="Mon, 6 Jul 2020 17:33:41 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; do you have an updated ETA to complete this issue?&lt;/p&gt;</comment>
                            <comment id="17153757" author="guozhang" created="Wed, 8 Jul 2020 16:54:28 +0000"  >&lt;p&gt;I&apos;ve merged the PR and would like &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=seanguo&quot; class=&quot;user-hover&quot; rel=&quot;seanguo&quot;&gt;seanguo&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=neowu0&quot; class=&quot;user-hover&quot; rel=&quot;neowu0&quot;&gt;neowu0&lt;/a&gt; to verify if it has fixed their observed issue.&lt;/p&gt;</comment>
                            <comment id="17153852" author="neowu0" created="Wed, 8 Jul 2020 18:49:46 +0000"  >&lt;p&gt;Hi, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Your latest change fixed all my issues,&#160;Thanks!&lt;/p&gt;</comment>
                            <comment id="17153861" author="guozhang" created="Wed, 8 Jul 2020 19:04:35 +0000"  >&lt;p&gt;Thanks for the confirmation! I&apos;m resolving this ticket then.&lt;/p&gt;</comment>
                            <comment id="17153862" author="guozhang" created="Wed, 8 Jul 2020 19:05:38 +0000"  >&lt;p&gt;cc 2.5.1 release manager &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vvcephei&quot; class=&quot;user-hover&quot; rel=&quot;vvcephei&quot;&gt;vvcephei&lt;/a&gt; I&apos;m merging it to 2.5 branch too.&lt;/p&gt;</comment>
                            <comment id="17155245" author="seanguo" created="Fri, 10 Jul 2020 07:50:26 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; Looks like the latest change bring back the high CPU issue based on our local tests.&lt;/p&gt;</comment>
                            <comment id="17155659" author="guozhang" created="Fri, 10 Jul 2020 18:18:27 +0000"  >&lt;p&gt;Hmm, interesting. What setup are you using with the local tests? I tried to setup a single consumer and a single broker, and then shutdown the broker; under this scenario the issue does not show up anymore.&lt;/p&gt;</comment>
                            <comment id="17156211" author="ijuma" created="Sun, 12 Jul 2020 05:13:17 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt;&#160;Should we reopen this issue given &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=seanguo&quot; class=&quot;user-hover&quot; rel=&quot;seanguo&quot;&gt;seanguo&lt;/a&gt;&apos;s comment?&lt;/p&gt;</comment>
                            <comment id="17156214" author="zhowei" created="Sun, 12 Jul 2020 06:28:24 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt;, I have three brokers and 10 consumers. When I restart one of consumers, some of other consumers will be with high CPU issue. &lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// from KafkaConsumer.java (a fine fix)
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; ConsumerRecords&amp;lt;K, V&amp;gt; poll(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Timer timer, &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; includeMetadataInTimeout);
&lt;/span&gt;                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (includeMetadataInTimeout) {
                    &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; to update assignment metadata BUT &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; not need to block on the timer &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; we still have
&lt;/span&gt;                    &lt;span class=&quot;code-comment&quot;&gt;// some assigned partitions, since even &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; we are 1) in the middle of a rebalance
&lt;/span&gt;                    &lt;span class=&quot;code-comment&quot;&gt;// or 2) have partitions with unknown starting positions we may still want to &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; some data
&lt;/span&gt;                    &lt;span class=&quot;code-comment&quot;&gt;// as &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; as there are some partitions fetchable; NOTE we always use a timer with 0ms
&lt;/span&gt;                    &lt;span class=&quot;code-comment&quot;&gt;// to never block on completing the rebalance procedure &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; there&apos;s any
&lt;/span&gt;                    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (subscriptions.fetchablePartitions(tp -&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;).isEmpty()) {
                        updateAssignmentMetadataIfNeeded(timer);
                    } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
                        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Timer updateMetadataTimer = time.timer(0L);
                        updateAssignmentMetadataIfNeeded(updateMetadataTimer);
                        timer.update(updateMetadataTimer.currentTimeMs());
                    }
                } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
                    &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (!updateAssignmentMetadataIfNeeded(time.timer(&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;.MAX_VALUE))) {
                        log.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;Still waiting &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; metadata&quot;&lt;/span&gt;);
                    }
                }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// from KafkaConsumer.java (last commit)
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; ConsumerRecords&amp;lt;K, V&amp;gt; poll(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Timer timer, &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; includeMetadataInTimeout);
&lt;/span&gt;
               &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (includeMetadataInTimeout) {
                    &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; to update assignment metadata BUT &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; not need to block on the timer &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; join group
&lt;/span&gt;                    updateAssignmentMetadataIfNeeded(timer, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
                } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
                    &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (!updateAssignmentMetadataIfNeeded(time.timer(&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;.MAX_VALUE), &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)) {
                        log.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;Still waiting &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; metadata&quot;&lt;/span&gt;);
                    }
                }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Per the above two commits I have one question about `updateAssignmentMetadataIfNeeded(timer, false);` why the second parameter is false? Per my understanding when it&apos;s false, actually it&apos;s same as before `updateAssignmentMetadataIfNeeded(time.timer(0L));` &lt;br/&gt;
I&apos;ve tested w/ true, it looks fine for us and I&apos;m thinking when it&apos;s w/ true, the behavior is similar to &lt;a href=&quot;https://github.com/apache/kafka/pull/8934/commits/333a967ec22ea22babf32b18349b76b6552a2fac&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;the commit&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17156368" author="guozhang" created="Sun, 12 Jul 2020 19:10:44 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zhowei&quot; class=&quot;user-hover&quot; rel=&quot;zhowei&quot;&gt;zhowei&lt;/a&gt; Just to clarify are you working with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=seanguo&quot; class=&quot;user-hover&quot; rel=&quot;seanguo&quot;&gt;seanguo&lt;/a&gt; on the same issue?&lt;/p&gt;

&lt;p&gt;The rationale for the final fix is that we only need `timer.timer(0L)` for join-group, but not for others, for example even if the flag is set to false we would still use the original timer trying to discover the coordinator etc, because our setting was based on the observation that when the coordinator is not available, we are spending busy loops looking for it.&lt;/p&gt;

&lt;p&gt;From your description, your case actually is not the same as my setup or &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=neowu0&quot; class=&quot;user-hover&quot; rel=&quot;neowu0&quot;&gt;neowu0&lt;/a&gt;&apos;s, i.e. the coordinator is fine, but all the partitions are revoked and hence you have none to fetch from while looping for the join-group request to complete. I&apos;ve prepared a new PR that adds the fetchable logic back in a more efficient way, LMK if it works for you: &lt;a href=&quot;https://github.com/apache/kafka/pull/9011&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/9011&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17157049" author="zhowei" created="Tue, 14 Jul 2020 00:20:55 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt;, yes, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=seanguo&quot; class=&quot;user-hover&quot; rel=&quot;seanguo&quot;&gt;seanguo&lt;/a&gt; and I are working on the same issue.&lt;br/&gt;
I&apos;ve verified PR:&lt;a href=&quot;https://github.com/apache/kafka/pull/9011&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/9011&lt;/a&gt;. looks like the CPU issue has gone away, but the new consumer spends much more long time joining group than before, it&apos;s about 2mins.&lt;/p&gt;</comment>
                            <comment id="17160146" author="guozhang" created="Fri, 17 Jul 2020 19:01:40 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zhowei&quot; class=&quot;user-hover&quot; rel=&quot;zhowei&quot;&gt;zhowei&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=seanguo&quot; class=&quot;user-hover&quot; rel=&quot;seanguo&quot;&gt;seanguo&lt;/a&gt; I tried to reproduce your high CPU with &lt;tt&gt;three brokers and 10 consumers, and restart one of consumers&lt;/tt&gt; but I failed to do that locally.&lt;/p&gt;

&lt;p&gt;I&apos;ve prepared a patch just improving on some log4j entries as we suspect your issue maybe related to heartbeats: &lt;a href=&quot;https://github.com/apache/kafka/pull/9038&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/9038&lt;/a&gt; Could you try it out while reproducing the issue, and share your logs (you&apos;d have to enable it to at least ERROR level) here so we can further understand the root cause?&lt;/p&gt;</comment>
                            <comment id="17162450" author="zhowei" created="Wed, 22 Jul 2020 03:08:59 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; refer to the attached file (consumer5.log.2020-07-22.log), the last re-join happened at &quot; 10:52:41.247 &lt;span class=&quot;error&quot;&gt;&amp;#91;pool-1-thread-1&amp;#93;&lt;/span&gt; INFO  o.a.k.c.consumer.internals.AbstractCoordinator - &lt;span class=&quot;error&quot;&gt;&amp;#91;Consumer clientId=consumer5, groupId=consumerGroupId&amp;#93;&lt;/span&gt; (Re-)joining group&quot; because there is one consumer trying to join. interesting, this time looks better than before, but still spend more than one min.&lt;/p&gt;</comment>
                            <comment id="17163116" author="aklochkov" created="Wed, 22 Jul 2020 22:44:00 +0000"  >&lt;p&gt;Can somebody please clarify if this defect affects consumers if we don&apos;t use the new cooperative protocol? We&apos;re considering whether to upgrade to 2.4.1 or 2.5.0 and it looks like this particular defect makes staying on 2.4.1 a better idea. Thanks!&lt;/p&gt;</comment>
                            <comment id="17163759" author="guozhang" created="Thu, 23 Jul 2020 16:45:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zhowei&quot; class=&quot;user-hover&quot; rel=&quot;zhowei&quot;&gt;zhowei&lt;/a&gt; Did your run include both the log4j improvement and the other PR depending on fetchable partitions to do long polling?&lt;/p&gt;</comment>
                            <comment id="17163761" author="guozhang" created="Thu, 23 Jul 2020 16:49:55 +0000"  >&lt;p&gt;BTW I found that the main latency during rebalance is on discovering the coordinator while we keep getting &quot;Join group failed with org.apache.kafka.common.errors.DisconnectException&quot; and it kept retrying for about a minute. But I think you did not shutdown the broker in your experiment, is there anything else happening that cause that broker node to be not reachable?&lt;/p&gt;</comment>
                            <comment id="17164290" author="zhowei" created="Fri, 24 Jul 2020 09:00:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; I&apos;m using logback and PR: &lt;a href=&quot;https://github.com/apache/kafka/pull/9011&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/9011&lt;/a&gt; included as well.  yeah, just to restart consumer w/o broker change, both brokers &amp;amp;consumers were running on my local laptop, not found any other issue.&lt;/p&gt;</comment>
                            <comment id="17165133" author="ijuma" created="Sat, 25 Jul 2020 23:27:50 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zhowei&quot; class=&quot;user-hover&quot; rel=&quot;zhowei&quot;&gt;zhowei&lt;/a&gt;&#160;So you&apos;re saying you see the issue when restarting the consumers, not when restarting the brokers?&lt;/p&gt;</comment>
                            <comment id="17165187" author="zhowei" created="Sun, 26 Jul 2020 08:38:00 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ijuma&quot; class=&quot;user-hover&quot; rel=&quot;ijuma&quot;&gt;ijuma&lt;/a&gt; correct, just while restarting consumer, not broker restart.&lt;/p&gt;</comment>
                            <comment id="17166038" author="guozhang" created="Tue, 28 Jul 2020 00:18:42 +0000"  >&lt;p&gt;What I did not see from my local run is the following:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Join group failed with org.apache.kafka.common.errors.DisconnectException
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Which indicates that the socket connecting to the brokers cannot be established, and the consumer has to retry discovering (the same) broker, and then re-connect to it, and somehow after one minute or two the issue goes away itself. If you did not restart the broker during that time, then I can only think of transient network issues..&lt;/p&gt;

&lt;p&gt;Actually, could you try only patching the logback PR but not the 9011 PR (i.e. let it to falls into busy loop) and upload the logs so I can also check what&apos;s causing the busy loops as well?&lt;/p&gt;</comment>
                            <comment id="17170601" author="zhowei" created="Tue, 4 Aug 2020 07:13:18 +0000"  >&lt;p&gt;The long time joining group is related to &lt;b&gt;max.poll.records&lt;/b&gt;, looks like rejoin is trigged in &lt;b&gt;poll()&lt;/b&gt;, it means only when processing complete and &lt;b&gt;poll()&lt;/b&gt; be called. And &lt;b&gt;DisconnectException&lt;/b&gt; should not be a real socket error, before leader consumer issues a rejoin request, looks like rejoin request from other consumers will be failed w/ &lt;b&gt;DisconnectException&lt;/b&gt;.&lt;/p&gt;</comment>
                            <comment id="17177031" author="zhowei" created="Thu, 13 Aug 2020 13:53:45 +0000"  >&lt;p&gt;Kafka clients v2.6.0 is already released, but high cpu issue doesn&apos;t go away for our scenario and find there is a significant difference between v2.6.0 and PR #9011:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/kafka/blob/fe0279026bd3d854a7291f5bf99503469e900038/clients/src/main/java/org/apache/kafka/clients/consumer/KafkaConsumer.java#L1230&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Kafka branch2.6&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (includeMetadataInTimeout) {
    &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; to update assignment metadata BUT &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; not need to block on the timer &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; join group
&lt;/span&gt;    updateAssignmentMetadataIfNeeded(timer, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
    ...
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/kafka/pull/9011&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;PR #9011&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (includeMetadataInTimeout) {
    &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; to update assignment metadata;
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; not need to block on the timer &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; join group &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; we have any fetchable partitions
&lt;/span&gt;    updateAssignmentMetadataIfNeeded(timer, !subscriptions.hasAnyFetchablePartitions());
} 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17177064" author="ijuma" created="Thu, 13 Aug 2020 14:41:25 +0000"  >&lt;p&gt;What&apos;s in PR #9011 was meant to help debug the remaining issue, we know it was not merged. I reopened the Jira to avoid confusion. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt;, thoughts on the remaining issue?&lt;/p&gt;</comment>
                            <comment id="17180775" author="guozhang" created="Wed, 19 Aug 2020 19:26:23 +0000"  >&lt;p&gt;I think I&apos;d need more information to further investigate this issue. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zhowei&quot; class=&quot;user-hover&quot; rel=&quot;zhowei&quot;&gt;zhowei&lt;/a&gt; could you apply &lt;a href=&quot;https://github.com/apache/kafka/pull/9038&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/9038&lt;/a&gt; only (this is for improved log4j entries) on top of 2.6 to reproduce this issue and then upload the enhanced log file?&lt;/p&gt;</comment>
                            <comment id="17180919" author="zhowei" created="Thu, 20 Aug 2020 01:52:57 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; sure, I&apos;ll porting PR #9038 on 2.6.0 and share log with u. thx.&lt;br/&gt;
please refer to the attached file: consumer3.log.2020-08-20.log&lt;/p&gt;</comment>
                            <comment id="17183654" author="guozhang" created="Tue, 25 Aug 2020 00:42:29 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zhowei&quot; class=&quot;user-hover&quot; rel=&quot;zhowei&quot;&gt;zhowei&lt;/a&gt; Thanks for the new log files, it has been very helpful for me to nail down the root causes and I will refine an existing WIP PR &lt;a href=&quot;https://github.com/apache/kafka/pull/8834&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/8834&lt;/a&gt; as a final fix for this. Please stay tuned.&lt;/p&gt;</comment>
                            <comment id="17184837" author="guozhang" created="Wed, 26 Aug 2020 01:36:17 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zhowei&quot; class=&quot;user-hover&quot; rel=&quot;zhowei&quot;&gt;zhowei&lt;/a&gt; could you try out &lt;a href=&quot;https://github.com/apache/kafka/pull/8834&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/8834&lt;/a&gt; and lmk if it works fixing the issue now.&lt;/p&gt;</comment>
                            <comment id="17185062" author="zhowei" created="Wed, 26 Aug 2020 09:38:53 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; cool, I&apos;ll try it later, thanks&lt;/p&gt;</comment>
                            <comment id="17187480" author="zhowei" created="Mon, 31 Aug 2020 06:39:20 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; I&apos;ve tested against PR #8834, it works fine for our scenario. appreciate.&lt;/p&gt;</comment>
                            <comment id="17188058" author="zhowei" created="Tue, 1 Sep 2020 00:17:28 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; one more question about PR #8834, whether or not &lt;b&gt;GroupCoordinator&lt;/b&gt; changes is mandatory. I mean Kafka server changes should be more expensive that clients.&lt;/p&gt;</comment>
                            <comment id="17188116" author="guozhang" created="Tue, 1 Sep 2020 03:35:15 +0000"  >&lt;p&gt;Hello &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zhowei&quot; class=&quot;user-hover&quot; rel=&quot;zhowei&quot;&gt;zhowei&lt;/a&gt; that broker-side change is not mandatory, I just included that part to make the whole PR complete, but it is not a necessary change for your situation.&lt;/p&gt;</comment>
                            <comment id="17188870" author="zhowei" created="Tue, 1 Sep 2020 23:57:50 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; thanks, I&apos;ve tested clients changes in PR #8834 against legacy Kafka server, it works fine as well. thanks for your response. &lt;/p&gt;</comment>
                            <comment id="17190802" author="davispw" created="Fri, 4 Sep 2020 16:03:45 +0000"  >&lt;p&gt;I&apos;d like to see the title of this bug clarified: It is worse than just &quot;High CPU usage&quot;.&#160; I have a couple of Kafka Streams apps with a high number of tasks/threads and this issue is causing infinite rebalance loops where the entire &lt;b&gt;cluster stops processing and cannot successfully rebalance&lt;/b&gt;.&#160; This causes hard downtime.&#160; I&apos;ve had to roll back to 2.4.1.&lt;/p&gt;

&lt;p&gt;Edit: clarification: tested with 2.6.0.&#160; Have not tested 2.5.&lt;/p&gt;

&lt;p&gt;I&apos;m currently working on building the patch, will test.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Late to the party since you&apos;ve already got the fix in progress, but in case it helps, I&apos;d like to share what I&apos;m seeing:&lt;/p&gt;

&lt;p&gt;The rebalance failures seems to be associated the TimeoutExceptions, DisconnectionExceptions and other side effects as noted in earlier comments.&#160; When many StreamThreads are all spinning, then each time a rebalance is attempted, when there are a large number of threads it is likely that &lt;em&gt;some&lt;/em&gt; thread will fail, and the rebalance never succeeds.&#160; The downward spiral begins as ConsumerThreads become &quot;fenced&quot; and it triggers a full (not incremental) rebalance, and eventually all data flow gets blocked.&#160; I&apos;ve tried different combinations of session.timeout.ms, rebalance.timeout.ms, max.poll.time.ms, default.api.timeout.ms (as recommended in the text of the timeout exceptions) to no avail.&lt;/p&gt;

&lt;p&gt;Of my applications, the ones that are affected include&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;one stateless app with num.stream.threads=24.&#160; With more than 1 instance (2-4x=48-96 threads), it will often never rebalance correctly, or only after multiple attempts (30+ minutes).&#160;&#160;&lt;/li&gt;
	&lt;li&gt;one stateful app with 36 partitions of large-ish (500MB-1GB each) state stores which can take a while to restore.&#160; This app successfully starts if I shut down all instances, delete state stores, set initial rebalance delay, and start all up simultaneously &#8211; but if any instance restarts or I attempt to scale up later, then rebalance will never succeed.&#160; Additionally, when state stores are reassigned, there are &quot;LockExceptions&quot; (DEBUG level logs) in a tight loop, and the state stores fail to be closed cleanly, which forces the restore process to begin all over again.&#160; The only way I can successfully do a rolling restart is if I use static membership and increase the session timeout.&#160; If there is only a single instance of the app, then it works with no problems (but this is not a solution as I need multiple instances for scale).&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Other side effects: the tight loop logs several DEBUG logs, which filled up log storage and caused pod evictions, which caused state stores to become invalid and restore (workaround: disable this logging).&lt;/p&gt;

&lt;p&gt;Additionally, have seen the following exceptions sporadically, not sure if these are separate bugs:&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;2020-08-31T00:40:47.786Z ERROR Uncaught stream processing error! KafkaStreamsConfiguration java.lang.IllegalStateException: There are insufficient bytes available to read assignment from the sync-group response (actual byte size 0) , this is not expected; it is possible that the leader&apos;s assign function is buggy and did not return any assignment for this member, or &lt;b&gt;because static member is configured and the protocol is buggy&lt;/b&gt; hence did not get the assignment for this member&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&#160; &#160; at org.apache.kafka.clients.consumer.internals.ConsumerCoordinator.onJoinComplete(ConsumerCoordinator.java:367)&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&#160; &#160; at org.apache.kafka.clients.consumer.internals.AbstractCoordinator.joinGroupIfNeeded(AbstractCoordinator.java:440)&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&#160; &#160; at org.apache.kafka.clients.consumer.internals.AbstractCoordinator.ensureActiveGroup(AbstractCoordinator.java:359)&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&#160; &#160; at org.apache.kafka.clients.consumer.internals.ConsumerCoordinator.poll(ConsumerCoordinator.java:513)&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&#160; &#160; at org.apache.kafka.clients.consumer.KafkaConsumer.updateAssignmentMetadataIfNeeded(KafkaConsumer.java:1268)&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&#160; &#160; at org.apache.kafka.clients.consumer.KafkaConsumer.poll(KafkaConsumer.java:1230)&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&#160; &#160; at org.apache.kafka.clients.consumer.KafkaConsumer.poll(KafkaConsumer.java:1210)&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&#160; &#160; at org.apache.kafka.streams.processor.internals.StreamThread.pollRequests(StreamThread.java:766)&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&#160; &#160; at org.apache.kafka.streams.processor.internals.StreamThread.runOnce(StreamThread.java:624)&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&#160; &#160; at org.apache.kafka.streams.processor.internals.StreamThread.runLoop(StreamThread.java:551)&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&#160; &#160; at org.apache.kafka.streams.processor.internals.StreamThread.run(StreamThread.java:510)&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;2020-09-03T15:53:17.524Z ERROR Uncaught stream processing error! KafkaStreamsConfiguration java.lang.IllegalStateException: Active task 3_0 should have been suspended&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&#160; &#160; at org.apache.kafka.streams.processor.internals.TaskManager.handleAssignment(TaskManager.java:281)&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&#160; &#160; ... 13 common frames omitted&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;Wrapped by: java.lang.RuntimeException: Unexpected failure to close 1 task(s) [&lt;span class=&quot;error&quot;&gt;&amp;#91;3_0&amp;#93;&lt;/span&gt;]. First unexpected exception (for task 3_0) follows.&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&#160; &#160; at org.apache.kafka.streams.processor.internals.TaskManager.handleAssignment(TaskManager.java:349)&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&#160; &#160; at org.apache.kafka.streams.processor.internals.StreamsPartitionAssignor.onAssignment(StreamsPartitionAssignor.java:1428)&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&#160; &#160; at org.apache.kafka.clients.consumer.internals.ConsumerCoordinator.invokeOnAssignment(ConsumerCoordinator.java:279)&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&#160; &#160; at org.apache.kafka.clients.consumer.internals.ConsumerCoordinator.onJoinComplete(ConsumerCoordinator.java:421)&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&#160; &#160; ... 10 common frames omitted&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;Wrapped by: org.apache.kafka.common.KafkaException: User rebalance callback throws an error&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&#160; &#160; at org.apache.kafka.clients.consumer.internals.ConsumerCoordinator.onJoinComplete(ConsumerCoordinator.java:436)&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&#160; &#160; at org.apache.kafka.clients.consumer.internals.AbstractCoordinator.joinGroupIfNeeded(AbstractCoordinator.java:440)&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&#160; &#160; at org.apache.kafka.clients.consumer.internals.AbstractCoordinator.ensureActiveGroup(AbstractCoordinator.java:359)&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&#160; &#160; at org.apache.kafka.clients.consumer.internals.ConsumerCoordinator.poll(ConsumerCoordinator.java:513)&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&#160; &#160; at org.apache.kafka.clients.consumer.KafkaConsumer.updateAssignmentMetadataIfNeeded(KafkaConsumer.java:1268)&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&#160; &#160; at org.apache.kafka.clients.consumer.KafkaConsumer.poll(KafkaConsumer.java:1230)&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&#160; &#160; at org.apache.kafka.clients.consumer.KafkaConsumer.poll(KafkaConsumer.java:1210)&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&#160; &#160; at org.apache.kafka.streams.processor.internals.StreamThread.pollRequests(StreamThread.java:766)&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&#160; &#160; at org.apache.kafka.streams.processor.internals.StreamThread.runOnce(StreamThread.java:628)&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&#160; &#160; at org.apache.kafka.streams.processor.internals.StreamThread.runLoop(StreamThread.java:551)&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&#160; &#160; at org.apache.kafka.streams.processor.internals.StreamThread.run(StreamThread.java:510)&lt;/tt&gt;&lt;/p&gt;</comment>
                            <comment id="17192513" author="ableegoldman" created="Tue, 8 Sep 2020 22:31:26 +0000"  >&lt;p&gt;Hey &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davispw&quot; class=&quot;user-hover&quot; rel=&quot;davispw&quot;&gt;davispw&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;It looks like you might have run into a few distinct issues: the rebalancing problems, the &quot;insufficient bytes available&quot; IllegalStateException, and the &quot;Active task 3_0 should have been suspended&quot; IllegalStateException.&lt;/p&gt;

&lt;p&gt;The rebalancing seems to point to this issue, as the full fix did not make it into 2.6.0 in time. It would be great if you could test out the patch and see if that helps (building from&#160;&lt;a href=&quot;https://github.com/apache/kafka/pull/8834&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;pull/8834&lt;/a&gt;&#160;specifically, which is not yet merged). The patch I linked also includes a fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-10122&quot; title=&quot;Consumer should allow heartbeat during rebalance as well&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-10122&quot;&gt;&lt;del&gt;KAFKA-10122&lt;/del&gt;&lt;/a&gt;, another cause of unnecessary rebalances.&lt;/p&gt;

&lt;p&gt;For the two IllegalStateException issues, could you open separate tickets? They seem unrelated to this, and to each other, but definitely merit a closer look. Any logs you have from the time of the exceptions would help a lot.&#160;&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                            <comment id="17193937" author="guozhang" created="Fri, 11 Sep 2020 01:04:55 +0000"  >&lt;p&gt;The PR has been merged to trunk and 2.6&lt;/p&gt;</comment>
                            <comment id="17201807" author="zhowei" created="Thu, 24 Sep 2020 23:09:43 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; looks the fix version is 2.7.0 &amp;amp;2.6.1, do u know when to release them? thanks.&lt;/p&gt;</comment>
                            <comment id="17202931" author="guozhang" created="Sun, 27 Sep 2020 22:04:04 +0000"  >&lt;p&gt;I don&apos;t think there&apos;s a concrete plan for 2.6.1 yet, for 2.7.0 it is planned for Nov.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13315870">KAFKA-10254</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13010141" name="consumer3.log.2020-08-20.log" size="11211044" author="zhowei" created="Thu, 20 Aug 2020 08:49:52 +0000"/>
                            <attachment id="13008127" name="consumer5.log.2020-07-22.log" size="741271" author="zhowei" created="Wed, 22 Jul 2020 03:03:58 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 7 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0fovk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>