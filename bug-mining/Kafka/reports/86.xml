<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:35:33 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-463] log.truncateTo needs to handle targetOffset smaller than the lowest offset in the log</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-463</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;When this happens, we should truncate all existing log segments.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12603598">KAFKA-463</key>
            <summary>log.truncateTo needs to handle targetOffset smaller than the lowest offset in the log</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="swapnilghike">Swapnil Ghike</assignee>
                                    <reporter username="junrao">Jun Rao</reporter>
                        <labels>
                            <label>bugs</label>
                    </labels>
                <created>Wed, 15 Aug 2012 15:15:18 +0000</created>
                <updated>Mon, 17 Sep 2012 14:55:21 +0000</updated>
                            <resolved>Mon, 17 Sep 2012 14:55:16 +0000</resolved>
                                                    <fixVersion>0.8.0</fixVersion>
                                    <component>core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                    <workratio workratioPercent="0"/>
                                    <progress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                    <timeoriginalestimate seconds="172800">48h</timeoriginalestimate>
                            <timeestimate seconds="172800">48h</timeestimate>
                                        <comments>
                            <comment id="13454379" author="swapnilghike" created="Wed, 12 Sep 2012 21:34:53 +0000"  >&lt;p&gt;Truncates all existing log segments if targetOffset is smaller than the lowest offset in the log, creates and appends a new log segment at targetOffset.&lt;/p&gt;</comment>
                            <comment id="13454947" author="junrao" created="Thu, 13 Sep 2012 15:20:10 +0000"  >&lt;p&gt;Thanks for the patch. A few comments:&lt;/p&gt;

&lt;p&gt;1. Log.truncateTo(): &lt;br/&gt;
1.1 Should synchronize on the lock since we are touching the segment files.&lt;br/&gt;
1.2 It doesn&apos;t seem that we need to call segments.truncLast(truncatedSegmentIndex) since we are deleting those segments whose start is larger than targetOffset later. If so, we can get rid of of SegmentList.truncLast and the associated unit test. Also, it seems that the current logic will fail to delete some segment files (only the in memory segment list is updated) if there the startOffset is in the middle of a list of segments. &lt;br/&gt;
1.3 The following piece of code is duplicated in 3 places: creating the first segment with offset 0, maybe roll and runcateTo(). Can we create a separate function (something like rollSegement(startOffset)) to share the code?&lt;br/&gt;
      val newFile = new File(dir, nameFromOffset(targetOffset))&lt;br/&gt;
      if (newFile.exists) &lt;/p&gt;
{
        warn(&quot;newly rolled logsegment &quot; + newFile.getName + &quot; already exists; deleting it first&quot;)
        newFile.delete()
      }
&lt;p&gt;      debug(&quot;Rolling log &apos;&quot; + name + &quot;&apos; to &quot; + newFile.getName())&lt;br/&gt;
      segments.append(new LogSegment(newFile, new FileMessageSet(newFile, true), targetOffset, time))&lt;br/&gt;
1.4 Can we add a unit test to verify that if targetOffset is smaller that the smallest offset in the log, after tuncateTo is called, log size is 0 and logEndOffset is targetOffset?&lt;br/&gt;
1.5 The following message should say this is failure during truncateTo.&lt;br/&gt;
      error(&quot;Failed to delete some segments during log recovery&quot;)&lt;/p&gt;

&lt;p&gt;2. FileMessageSet.truncateTo() : Condition     if(targetSize &amp;gt;= sizeInBytes())  should be changed to     if(targetSize &amp;gt; sizeInBytes())&lt;/p&gt;</comment>
                            <comment id="13455598" author="swapnilghike" created="Fri, 14 Sep 2012 06:17:12 +0000"  >&lt;p&gt;1. Made the changes 1.1, 1.3, 1.5, 2 as recommended. &lt;/p&gt;

&lt;p&gt;2. Made an appropriate change for 1.2. If all segments are deleted then truncate entire segments.view and roll a new segment from that targetOffset, otherwise check for appropriate segment to truncate and change the last segment of segments.view or throw error if targetOffset is out of range. &lt;/p&gt;

&lt;p&gt;3. A unit test that exercises all cases for truncateTo.&lt;/p&gt;

&lt;p&gt;Perhaps not super-crucial, but here it goes anyways:&lt;/p&gt;

&lt;p&gt;i. Added a check for contents.get().size &amp;gt; 0 in while loop in  trunc and truncLast, otherwise it can throw illegalArgumentException in Array.copy for certain cases even when the passed argument is ok. Eg in trunc when newStart == 0 and curr.length == 0. There is most probably no danger of changing the value of contents between the while condition check and curr = contents.get(), because any calls to trunc and truncLast are synchronized with the same lock, thus there should be no other thread executing between while() and curr = contents.get().&lt;/p&gt;

&lt;p&gt;ii. truncLast does not throw exception for argument==-1, but throws exception for anything less. Probably it should behave uniformly for all negative integers. Made a change so that truncLast(-ve no) will wipe out the entire segments.view. This is also similar to what trunc does when the argument is greater than (segments.view.length-1).&lt;/p&gt;

&lt;p&gt;iii. Changed the condition for throwing exception in truncLast to &amp;gt; because an index which is equal to (segments.view.length-1) should not throw exception.&lt;/p&gt;

&lt;p&gt;iv. Added max/min condition to avoid IllegalArgumentException in truncLast.&lt;/p&gt;

&lt;p&gt;v. The unit test for truncLast did not check for all cases properly, fixed it.&lt;/p&gt;

&lt;p&gt;vi. Combined the two different test cases for trunc by imitating the structure of unit test for truncLast.&lt;/p&gt;

&lt;p&gt;A question:&lt;/p&gt;

&lt;p&gt;Since all calls to SegmentList.trunc, truncLast and append (which are the only ways to modify contents) seem to be locked, so only one thread will be able to modify SegmentList.contents at any time. Do we really need a while(compareAndSet) for contents? I could be wrong, pls correct me whenever you have free time.&lt;/p&gt;</comment>
                            <comment id="13455942" author="junrao" created="Fri, 14 Sep 2012 17:02:01 +0000"  >&lt;p&gt;Thanks for patch v2. Some more comments:&lt;/p&gt;

&lt;p&gt;20. Log:&lt;br/&gt;
20.1 rollSegment can be used for rolling the very first segment with offset 0 in the constructor too. Also, add a new line after rollSegment()&lt;br/&gt;
20.2 The following log message is bit confusing since Log shouldn&apos;t understand hw. Let&apos;s changed it to something more generic.&lt;br/&gt;
              error(&quot;Last checkpointed hw %d cannot be greater than the latest message offset %d in the log %s&quot;.&lt;br/&gt;
                format(targetOffset, segments.view.last.absoluteEndOffset, segments.view.last.file.getAbsolutePath))&lt;/p&gt;

&lt;p&gt;21. SegmentList: &lt;br/&gt;
21.1 The comment of truncLast is wrong. It&apos;s truncating everything from newOffset+1 to the end.&lt;br/&gt;
21.2 truncLast(): It&apos;s better to make sure that newOffset is &amp;gt;=0. Then we don&apos;t need the code max(newEnd + 1, 0).&lt;br/&gt;
21.3 It is true that callers of trunc and truncLast are already sync-ed on log.lock. All we need is to create a memory boundary so that the updated reference of  contents are exposed to other threads. AtomicReference guarantees this. However, we could just use a volatile var. We can probably leave AtomicReference for now since the overhead shouldn&apos;t be too much. However, we probably don&apos;t need to use compareAndSet in trunc() and truncLast(). We can just use set and get rid of the loop.&lt;/p&gt;


</comment>
                            <comment id="13456163" author="swapnilghike" created="Fri, 14 Sep 2012 21:20:17 +0000"  >&lt;p&gt;20.1. Letting the constructor be as it is as discussed. &lt;br/&gt;
20.2. Made the changes.&lt;/p&gt;

&lt;p&gt;21.1 Oops, had forgotten to update it, thanks.&lt;br/&gt;
21.2 Changed.&lt;br/&gt;
21.3 Removed compareAndSet loops. AtomicReference is unchanged.&lt;/p&gt;</comment>
                            <comment id="13457065" author="junrao" created="Mon, 17 Sep 2012 14:55:16 +0000"  >&lt;p&gt;Thanks for patch v3. Committed to 0.8 with a minor fix: use contents.get().length instead of contents.get().size in SegmetList.truncLast to be consistent with the rest of the code.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12544874" name="kafka-463-v1.patch" size="2667" author="swapnilghike" created="Wed, 12 Sep 2012 21:34:53 +0000"/>
                            <attachment id="12545103" name="kafka-463-v2.patch" size="13114" author="swapnilghike" created="Fri, 14 Sep 2012 06:17:12 +0000"/>
                            <attachment id="12545219" name="kafka-463-v3.patch" size="15667" author="swapnilghike" created="Fri, 14 Sep 2012 21:20:17 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>299135</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 10 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i15ztb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>243102</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>