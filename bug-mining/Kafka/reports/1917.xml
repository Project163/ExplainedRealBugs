<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:10:34 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-6566] SourceTask#stop() not called after exception raised in poll()</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-6566</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Having discussed this with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rhauch&quot; class=&quot;user-hover&quot; rel=&quot;rhauch&quot;&gt;rhauch&lt;/a&gt;, it has been my assumption that &lt;tt&gt;SourceTask#stop()&lt;/tt&gt; will be called by the Kafka Connect framework in case an exception has been raised in &lt;tt&gt;poll()&lt;/tt&gt;. That&apos;s not the case, though. As an example see the connector and task below.&lt;/p&gt;

&lt;p&gt;Calling &lt;tt&gt;stop()&lt;/tt&gt; after an exception in &lt;tt&gt;poll()&lt;/tt&gt; seems like a very useful action to take, as it&apos;ll allow the task to clean up any resources such as releasing any database connections, right after that failure and not only once the connector is stopped.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;package&lt;/span&gt; com.example;

&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.util.Collections;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.util.List;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.util.Map;

&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.kafka.common.config.ConfigDef;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.kafka.connect.connector.Task;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.kafka.connect.source.SourceConnector;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.kafka.connect.source.SourceRecord;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.kafka.connect.source.SourceTask;

&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;TestConnector &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; SourceConnector {

    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; version() {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
    }

    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void start(Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; props) {
    }

    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;&amp;lt;? &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; Task&amp;gt; taskClass() {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; TestTask.class;
    }

    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; List&amp;lt;Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt;&amp;gt; taskConfigs(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; maxTasks) {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; Collections.singletonList(Collections.singletonMap(&lt;span class=&quot;code-quote&quot;&gt;&quot;foo&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;bar&quot;&lt;/span&gt;));
    }

    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void stop() {
    }

    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; ConfigDef config() {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ConfigDef();
    }

    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;TestTask &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; SourceTask {

        @Override
        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; version() {
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
        }

        @Override
        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void start(Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; props) {
        }

        @Override
        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; List&amp;lt;SourceRecord&amp;gt; poll() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; InterruptedException {
            &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RuntimeException();
        }

        @Override
        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void stop() {
            &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;stop() called&quot;&lt;/span&gt;);
        }
    }
}

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13138911">KAFKA-6566</key>
            <summary>SourceTask#stop() not called after exception raised in poll()</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mjsax">Matthias J. Sax</assignee>
                                    <reporter username="gunnar.morling">Gunnar Morling</reporter>
                        <labels>
                    </labels>
                <created>Thu, 15 Feb 2018 21:41:53 +0000</created>
                <updated>Fri, 8 Jan 2021 07:58:59 +0000</updated>
                            <resolved>Fri, 18 May 2018 17:43:21 +0000</resolved>
                                    <version>1.0.0</version>
                                    <fixVersion>0.10.2.2</fixVersion>
                    <fixVersion>0.11.0.3</fixVersion>
                    <fixVersion>1.0.2</fixVersion>
                    <fixVersion>1.1.1</fixVersion>
                    <fixVersion>2.0.0</fixVersion>
                                    <component>connect</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="16366341" author="yuzhihong@gmail.com" created="Thu, 15 Feb 2018 22:19:22 +0000"  >&lt;p&gt;How about the following change ?&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
diff --git a/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/WorkerSourceTask.java b/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/WorkerSourceTask.java
index 6ef5ae3..f90c0ac 100644
--- a/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/WorkerSourceTask.java
+++ b/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/WorkerSourceTask.java
@@ -196,6 +196,9 @@ &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;WorkerSourceTask &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; WorkerTask {
             }
         } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (InterruptedException e) {
             &lt;span class=&quot;code-comment&quot;&gt;// Ignore and allow to exit.
&lt;/span&gt;+        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (RuntimeException re) {
+          task.stop();
+          &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; re;
         } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
             &lt;span class=&quot;code-comment&quot;&gt;// It should still be safe to commit offsets since any exception would have
&lt;/span&gt;             &lt;span class=&quot;code-comment&quot;&gt;// simply resulted in not getting more records but all the existing records should be ok to flush&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16366357" author="githubbot" created="Thu, 15 Feb 2018 22:37:41 +0000"  >&lt;p&gt;tedyu opened a new pull request #4577: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6566&quot; title=&quot;SourceTask#stop() not called after exception raised in poll()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-6566&quot;&gt;&lt;del&gt;KAFKA-6566&lt;/del&gt;&lt;/a&gt; SourceTask#stop() not called after exception raised in poll()&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/4577&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/4577&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   *More detailed description of your change,&lt;br/&gt;
   if necessary. The PR title and PR message become&lt;br/&gt;
   the squashed commit message, so use a separate&lt;br/&gt;
   comment to ping reviewers.*&lt;/p&gt;

&lt;p&gt;   *Summary of testing strategy (including rationale)&lt;br/&gt;
   for the feature or bug fix. Unit and/or integration&lt;br/&gt;
   tests are expected for any behaviour change and&lt;br/&gt;
   system tests should be considered for larger changes.*&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16366382" author="rhauch" created="Thu, 15 Feb 2018 23:04:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tedyu%40apache.org&quot; class=&quot;user-hover&quot; rel=&quot;tedyu@apache.org&quot;&gt;tedyu@apache.org&lt;/a&gt;, maybe we should first understand what happens to the other tasks and the connector when the `WorkerSourceTask` throws an exception. For example, if &lt;tt&gt;task.stop()&lt;/tt&gt; should be called when the connector and all tasks are cleaned up, then we won&apos;t also want it in the suggested location.&lt;/p&gt;</comment>
                            <comment id="16366390" author="rhauch" created="Thu, 15 Feb 2018 23:06:16 +0000"  >&lt;p&gt;Also, if we&apos;re not calling &lt;tt&gt;stop()&lt;/tt&gt; on the task, we should find out if that was the original intension. If so, then there&apos;s nothing to fix here, or that if we want to change the behavior we&apos;ll need a KIP. However, if that was the intention and we&apos;re simply no longer doing it, then it&apos;s a bug that we can fix without a KIP.&lt;/p&gt;

&lt;p&gt;Regardless, it seems like there&apos;s quite a bit more investigation required before we know how the code should be changed.&lt;/p&gt;</comment>
                            <comment id="16366404" author="yuzhihong@gmail.com" created="Thu, 15 Feb 2018 23:15:22 +0000"  >&lt;p&gt;Thanks for the comment, Randall.&lt;/p&gt;

&lt;p&gt;I did a quick search but haven&apos;t found whether not calling &lt;tt&gt;stop()&lt;/tt&gt; was intentional.&lt;/p&gt;

&lt;p&gt;Will spend more time investigating related aspects.&lt;/p&gt;</comment>
                            <comment id="16366411" author="gunnar.morling" created="Thu, 15 Feb 2018 23:20:10 +0000"  >&lt;p&gt;+1 for more exploration whether calling stop() was the original intention. FWIW, several comments in Debezium indicate that this at least was the asumption on that side when the code was written (of course that assumption may have been right or wrong).&lt;/p&gt;

&lt;p&gt;Note that calling stop() would be the only chance for the task to clean up its resources after an exception on the KC side of the polling loop (while we could have our entire polling logic in a try/catch block, there&apos;s no chance to react to exceptions in WorkerSourceTask).&lt;/p&gt;</comment>
                            <comment id="16384159" author="yuzhihong@gmail.com" created="Fri, 2 Mar 2018 21:12:16 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rhauch&quot; class=&quot;user-hover&quot; rel=&quot;rhauch&quot;&gt;rhauch&lt;/a&gt;:&lt;br/&gt;
What would be the next step for this JIRA ?&lt;/p&gt;</comment>
                            <comment id="16448116" author="omarsmak" created="Mon, 23 Apr 2018 13:10:22 +0000"  >&lt;p&gt;Hey &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rhauch&quot; class=&quot;user-hover&quot; rel=&quot;rhauch&quot;&gt;rhauch&lt;/a&gt; any further details regarding the correct semantic of this issue? We will need to know the semantic in order to implement on our side or&#160;Debezium side in order to make sure whenever any exception occurred, we correctly call &lt;tt&gt;stop&lt;/tt&gt;()&lt;/p&gt;</comment>
                            <comment id="16472374" author="rayokota" created="Fri, 11 May 2018 18:02:13 +0000"  >&lt;p&gt;I&apos;ve just started looking at this, but it looks like the correct place to put the the &lt;tt&gt;task.stop()&lt;/tt&gt; is in &lt;tt&gt;WorkerSourceTask.close()&lt;/tt&gt;.  This would mirror the call to &lt;tt&gt;task.stop()&lt;/tt&gt; in &lt;tt&gt;WorkerSinkTask.close()&lt;/tt&gt;.   &lt;tt&gt;close()&lt;/tt&gt; is called in a finally block in &lt;tt&gt;WorkerTask.doRun()&lt;/tt&gt; here:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/WorkerTask.java#L176&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/trunk/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/WorkerTask.java#L176&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;There is another possible change I am looking at and that is to put a call to &lt;tt&gt;task.stop()&lt;/tt&gt; in &lt;tt&gt;WorkerSinkTask.stop()&lt;/tt&gt;.  This would mirror the call to &lt;tt&gt;task.stop()&lt;/tt&gt; in &lt;tt&gt;WorkerSourceTask.stop()&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Ideally the source and sink would be symmetrical in order to make it easier to reason about esp. for Connect developers.  The above changes assume that &lt;tt&gt;task.stop()&lt;/tt&gt; is idempotent for both the source and sink.&lt;/p&gt;


</comment>
                            <comment id="16472568" author="rhauch" created="Fri, 11 May 2018 20:03:07 +0000"  >&lt;p&gt;Raised to a blocker for 2.0 (next release), though we should probably backport any fix at least back to 3.3 or 3.2.&lt;/p&gt;</comment>
                            <comment id="16476251" author="githubbot" created="Tue, 15 May 2018 17:51:24 +0000"  >&lt;p&gt;rayokota opened a new pull request #5020: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6566&quot; title=&quot;SourceTask#stop() not called after exception raised in poll()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-6566&quot;&gt;&lt;del&gt;KAFKA-6566&lt;/del&gt;&lt;/a&gt;: Improve ConnectRresource Cleanup&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5020&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5020&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   This is a change to improve resource cleanup for sink tasks and source tasks.  Now `Task.stop()` may be called from both `WorkerSinkTask`/`WorkerSourceTask` `stop()` as well as `close()`.  However, if it has already been called in `close()` it is not called in `stop()`, and vice versa.&lt;/p&gt;

&lt;p&gt;   It is called from `WorkerXXXTask.close()` since this method is called in the `finally` block of `WorkerTask.run()`, and Connect developers use `stop()` to clean up resources.&lt;/p&gt;

&lt;p&gt;   It is called from `WorkerXXXTask.stop()` since it makes sense to attempt a stop on the Task in this call.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16480970" author="githubbot" created="Fri, 18 May 2018 17:41:54 +0000"  >&lt;p&gt;ewencp closed pull request #5020: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6566&quot; title=&quot;SourceTask#stop() not called after exception raised in poll()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-6566&quot;&gt;&lt;del&gt;KAFKA-6566&lt;/del&gt;&lt;/a&gt;: Improve Connect Resource Cleanup&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5020&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5020&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/WorkerSinkTask.java b/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/WorkerSinkTask.java&lt;br/&gt;
index 2ba785c4668..6edcfd41886 100644&lt;br/&gt;
&amp;#8212; a/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/WorkerSinkTask.java&lt;br/&gt;
+++ b/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/WorkerSinkTask.java&lt;br/&gt;
@@ -148,10 +148,23 @@ public void stop() {&lt;br/&gt;
     protected void close() {&lt;br/&gt;
         // FIXME Kafka needs to add a timeout parameter here for us to properly obey the timeout&lt;br/&gt;
         // passed in&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;task.stop();&lt;/li&gt;
	&lt;li&gt;if (consumer != null)&lt;/li&gt;
	&lt;li&gt;consumer.close();&lt;/li&gt;
	&lt;li&gt;transformationChain.close();&lt;br/&gt;
+        try 
{
+            task.stop();
+        }
&lt;p&gt; catch (Throwable t) &lt;/p&gt;
{
+            log.warn(&quot;Could not stop task&quot;, t);
+        }
&lt;p&gt;+        if (consumer != null) &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+            try {
+                consumer.close();
+            } catch (Throwable t) {
+                log.warn(&quot;Could not close consumer&quot;, t);
+            }+        }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;+        try &lt;/p&gt;
{
+            transformationChain.close();
+        } catch (Throwable t) {
+            log.warn(&quot;Could not close transformation chain&quot;, t);
+        }&lt;br/&gt;
     }&lt;br/&gt;
 &lt;br/&gt;
     @Override&lt;br/&gt;
diff --git a/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/WorkerSourceTask.java b/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/WorkerSourceTask.java&lt;br/&gt;
index f2cef5a63f7..f17475dacfc 100644&lt;br/&gt;
&amp;#8212; a/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/WorkerSourceTask.java&lt;br/&gt;
+++ b/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/WorkerSourceTask.java&lt;br/&gt;
@@ -87,6 +87,7 @@&lt;br/&gt;
     private Map&amp;lt;String, String&amp;gt; taskConfig;&lt;br/&gt;
     private boolean finishedStart = false;&lt;br/&gt;
     private boolean startedShutdownBeforeStartCompleted = false;&lt;br/&gt;
+    private boolean stopped = false;&lt;br/&gt;
 &lt;br/&gt;
     public WorkerSourceTask(ConnectorTaskId id,&lt;br/&gt;
                             SourceTask task,&lt;br/&gt;
@@ -137,8 +138,21 @@ public void initialize(TaskConfig taskConfig) {&lt;br/&gt;
 &lt;br/&gt;
     @Override&lt;br/&gt;
     protected void close() {&lt;br/&gt;
-        producer.close(30, TimeUnit.SECONDS);&lt;br/&gt;
-        transformationChain.close();&lt;br/&gt;
+        if (!shouldPause()) {
+            tryStop();
+        }&lt;br/&gt;
+        if (producer != null) {&lt;br/&gt;
+            try {
+                producer.close(30, TimeUnit.SECONDS);
+            } catch (Throwable t) {
+                log.warn(&quot;Could not close producer&quot;, t);
+            }&lt;br/&gt;
+        }&lt;br/&gt;
+        try {+            transformationChain.close();+        }
&lt;p&gt; catch (Throwable t) &lt;/p&gt;
{
+            log.warn(&quot;Could not close transformation chain&quot;, t);
+        }
&lt;p&gt;     }&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     @Override&lt;br/&gt;
@@ -152,12 +166,23 @@ public void stop() {&lt;br/&gt;
         stopRequestedLatch.countDown();&lt;br/&gt;
         synchronized (this) &lt;/p&gt;
{
             if (finishedStart)
-                task.stop();
+                tryStop();
             else
                 startedShutdownBeforeStartCompleted = true;
         }
&lt;p&gt;     }&lt;/p&gt;

&lt;p&gt;+    private synchronized void tryStop() {&lt;br/&gt;
+        if (!stopped) {&lt;br/&gt;
+            try &lt;/p&gt;
{
+                task.stop();
+                stopped = true;
+            }
&lt;p&gt; catch (Throwable t) &lt;/p&gt;
{
+                log.warn(&quot;Could not stop task&quot;, t);
+            }
&lt;p&gt;+        }&lt;br/&gt;
+    }&lt;br/&gt;
+&lt;br/&gt;
     @Override&lt;br/&gt;
     public void execute() {&lt;br/&gt;
         try {&lt;br/&gt;
@@ -166,7 +191,7 @@ public void execute() {&lt;br/&gt;
             log.info(&quot;{} Source task finished initialization and start&quot;, this);&lt;br/&gt;
             synchronized (this) {&lt;br/&gt;
                 if (startedShutdownBeforeStartCompleted) &lt;/p&gt;
{
-                    task.stop();
+                    tryStop();
                     return;
                 }
&lt;p&gt;                 finishedStart = true;&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16480973" author="ewencp" created="Fri, 18 May 2018 17:46:32 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rayokota&quot; class=&quot;user-hover&quot; rel=&quot;rayokota&quot;&gt;rayokota&lt;/a&gt; Merged back through 0.10.2, if we want it any earlier we&apos;ll need to file follow up PRs as it does not backport cleanly to those branches.&lt;/p&gt;</comment>
                            <comment id="17070184" author="githubbot" created="Sun, 29 Mar 2020 02:20:08 +0000"  >&lt;p&gt;kkonstantine commented on pull request #4577: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6566&quot; title=&quot;SourceTask#stop() not called after exception raised in poll()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-6566&quot;&gt;&lt;del&gt;KAFKA-6566&lt;/del&gt;&lt;/a&gt; SourceTask#stop() not called after exception raised in poll()&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/4577&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/4577&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13343642">KAFKA-10792</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 33 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3q91z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>ewencp</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>