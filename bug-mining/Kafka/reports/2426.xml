<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:21:07 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-9051] Source task source offset reads can block graceful shutdown</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-9051</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;When source tasks request source offsets from the framework, this results in a call to &lt;a href=&quot;https://github.com/apache/kafka/blob/8966d066bd2f80c6d8f270423e7e9982097f97b9/connect/runtime/src/main/java/org/apache/kafka/connect/storage/OffsetStorageReaderImpl.java#L79&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Future.get()&lt;/a&gt;&#160;with no timeout. In distributed workers, the future is blocked on a successful &lt;a href=&quot;https://github.com/apache/kafka/blob/8966d066bd2f80c6d8f270423e7e9982097f97b9/connect/runtime/src/main/java/org/apache/kafka/connect/storage/KafkaOffsetBackingStore.java#L136&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;read to the end&lt;/a&gt;&#160;of the source offsets topic, which in turn will &lt;a href=&quot;https://github.com/apache/kafka/blob/8966d066bd2f80c6d8f270423e7e9982097f97b9/connect/runtime/src/main/java/org/apache/kafka/connect/util/KafkaBasedLog.java#L287&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;poll that topic indefinitely&lt;/a&gt;&#160;until the latest messages for every partition of that topic have been consumed.&lt;/p&gt;

&lt;p&gt;This normally completes in a reasonable amount of time. However, if the connectivity between the Connect worker and the Kafka cluster is degraded or dropped in the middle of one of these reads, it will block until connectivity is restored and the request completes successfully.&lt;/p&gt;

&lt;p&gt;If a task is stopped (due to a manual restart via the REST API, a rebalance, worker shutdown, etc.) while blocked on a read of source offsets during its &lt;tt&gt;start&lt;/tt&gt; method, not only will it fail to gracefully stop, but the framework &lt;a href=&quot;https://github.com/apache/kafka/blob/8966d066bd2f80c6d8f270423e7e9982097f97b9/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/WorkerSourceTask.java#L183&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;will not even invoke its stop method&lt;/a&gt;&#160;until its &lt;tt&gt;start&lt;/tt&gt; method (and, as a result, the source offset read request) &lt;a href=&quot;https://github.com/apache/kafka/blob/8966d066bd2f80c6d8f270423e7e9982097f97b9/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/WorkerSourceTask.java#L202-L206&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;has completed&lt;/a&gt;. This prevents the task from being able to clean up any resources it has allocated and can lead to OOM errors, excessive thread creation, and other problems.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I&apos;ve confirmed that this affects every release of Connect back through 1.0 at least; I&apos;ve tagged the most recent bug fix release of every major/minor version from then on in the &lt;tt&gt;Affects Version/s&lt;/tt&gt; field to avoid just putting every version in that field.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13262685">KAFKA-9051</key>
            <summary>Source task source offset reads can block graceful shutdown</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ChrisEgerton">Chris Egerton</assignee>
                                    <reporter username="ChrisEgerton">Chris Egerton</reporter>
                        <labels>
                    </labels>
                <created>Wed, 16 Oct 2019 18:05:17 +0000</created>
                <updated>Thu, 24 Oct 2024 22:20:04 +0000</updated>
                            <resolved>Fri, 22 Nov 2019 23:38:27 +0000</resolved>
                                    <version>1.0.2</version>
                    <version>1.1.1</version>
                    <version>2.0.1</version>
                    <version>2.1.1</version>
                    <version>2.2.1</version>
                    <version>2.3.0</version>
                    <version>2.4.0</version>
                    <version>2.5.0</version>
                                    <fixVersion>2.0.2</fixVersion>
                    <fixVersion>2.1.2</fixVersion>
                    <fixVersion>2.2.3</fixVersion>
                    <fixVersion>2.3.2</fixVersion>
                    <fixVersion>2.4.1</fixVersion>
                    <fixVersion>2.5.0</fixVersion>
                                    <component>connect</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="16953068" author="githubbot" created="Wed, 16 Oct 2019 18:12:45 +0000"  >&lt;p&gt;C0urante commented on pull request #7532: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-9051&quot; title=&quot;Source task source offset reads can block graceful shutdown&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-9051&quot;&gt;&lt;del&gt;KAFKA-9051&lt;/del&gt;&lt;/a&gt;: Prematurely complete source offset read requests for stopped tasks&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/7532&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/7532&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   &lt;span class=&quot;error&quot;&gt;&amp;#91;Jira&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-9051&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-9051&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;   The changes here cause source tasks which are blocked on source offset read requests to become immediately unblocked when they are scheduled for shutdown, which should allow them to complete their `start` method (if they are blocked inside if), which in turn should allow the framework to safely invoke their `stop` method and allow them to clean up allocated resources.&lt;/p&gt;

&lt;p&gt;   The source offsets returned to the task in this case may be either stale or missing entirely; however, this seems preferable to throwing an exception and potentially corrupting the state of the task badly enough that its then unable to clean up resources in its `stop` method due to, e.g., NPEs.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16978074" author="githubbot" created="Wed, 20 Nov 2019 05:18:25 +0000"  >&lt;p&gt;rhauch commented on pull request #7532: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-9051&quot; title=&quot;Source task source offset reads can block graceful shutdown&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-9051&quot;&gt;&lt;del&gt;KAFKA-9051&lt;/del&gt;&lt;/a&gt;: Prematurely complete source offset read requests for stopped tasks&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/7532&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/7532&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16978087" author="rhauch" created="Wed, 20 Nov 2019 05:46:34 +0000"  >&lt;p&gt;Merged to the following branches:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;`trunk` for inclusion in 2.5.0&lt;/li&gt;
	&lt;li&gt;`2.3` for inclusion in 2.3.2&lt;/li&gt;
	&lt;li&gt;`2.2` for inclusion in 2.2.3&lt;/li&gt;
	&lt;li&gt;`2.1` for inclusion in 2.1.2&lt;/li&gt;
	&lt;li&gt;`2.0` for inclusion in 2.0.2&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;These versions are the next to be released from each of these branches.&lt;/p&gt;

&lt;p&gt;We are currently in code freeze on the `2.4` branch for the upcoming AK 2.4.0 release. &lt;b&gt;As this issue is not a blocker for the AK 2.4.0 release, this commit (da4337271) will be merged to the `2.4` branch once that code freeze has been lifted&lt;/b&gt; and AK 2.4.0 has been released, and will be included in the subsequent 2.4.1 release.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13596657">KAFKA-17871</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 51 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z07nsg:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>