<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:43:42 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-19259] Async consumer fetch intermittent delays on console consumer</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-19259</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;We noticed that fetching with the kafka-console-consumer.sh tool using the new consumer shows some intermittent delays, that are not seen when running the same with the classic consumer. Note that I disabled auto-commit to isolate the delay, and from a first look seems to come from the fetchBuffer.awaitNonEmpty logic, that alternatively takes almost the full poll timeout (runs &quot;fast&quot;, then &quot;slow&quot;, and continues to alternate)&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/kafka/blob/0b81d6c7802c1be55dc823ce51729f2c6a6071a7/clients/src/main/java/org/apache/kafka/clients/consumer/internals/AsyncKafkaConsumer.java#L1808&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/0b81d6c7802c1be55dc823ce51729f2c6a6071a7/clients/src/main/java/org/apache/kafka/clients/consumer/internals/AsyncKafkaConsumer.java#L1808&lt;/a&gt;&#160;&#160;&lt;/p&gt;

&lt;p&gt;The difference in behaviour between the 2 consumers can be seen with this setup:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;topic with 6 partitions (I tried with 1 partition first and didn&apos;t see the delay, then with 3 and 6 I could see it)&#160;&lt;/li&gt;
	&lt;li&gt;data populated in topic with producer sending generated uuids to the topic in while loop&#160;&lt;/li&gt;
	&lt;li&gt;run console consumer (asycn) no commit:&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;bin/kafka-console-consumer.sh --topic t1 --bootstrap-server localhost:9092 --consumer-property group.protocol=consumer --group cg1 --consumer-property enable.auto.commit=false&lt;br/&gt;
Here we can notice the pattern that looks like batches, and custom logs on the awaitNonEmpty show it take the full poll timeout on alternate poll iterations.&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;run same but for classic consumer (consumer-property group.protocol=classic) -&amp;gt; not such pattern of intermittent delays&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Produce continuously (I used this) &lt;br/&gt;
while sleep 1; do echo $(uuidgen); done | bin/kafka-console-producer.sh --bootstrap-server localhost:9092 --topic t1&lt;/p&gt;

&lt;p&gt;This needs more investigation to fully understand if it&apos;s indeed something in the fetch path or something else)&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13617707">KAFKA-19259</key>
            <summary>Async consumer fetch intermittent delays on console consumer</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kirktrue">Kirk True</assignee>
                                    <reporter username="lianetm">Lianet Magrans</reporter>
                        <labels>
                            <label>async-kafka-consumer-performance</label>
                            <label>consumer-threading-refactor</label>
                            <label>performance</label>
                    </labels>
                <created>Fri, 9 May 2025 20:25:34 +0000</created>
                <updated>Fri, 5 Sep 2025 16:03:39 +0000</updated>
                            <resolved>Fri, 5 Sep 2025 14:52:01 +0000</resolved>
                                    <version>4.0.0</version>
                                    <fixVersion>4.2.0</fixVersion>
                                    <component>clients</component>
                    <component>consumer</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="17950685" author="JIRAUSER301926" created="Sat, 10 May 2025 13:38:54 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lianetm&quot; class=&quot;user-hover&quot; rel=&quot;lianetm&quot;&gt;lianetm&lt;/a&gt; &lt;br/&gt;
Can i pick this up ?&lt;/p&gt;</comment>
                            <comment id="17950972" author="JIRAUSER300183" created="Mon, 12 May 2025 13:55:48 +0000"  >&lt;p&gt;Hey &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=goyarpit&quot; class=&quot;user-hover&quot; rel=&quot;goyarpit&quot;&gt;goyarpit&lt;/a&gt;, sure, go ahead. I don&apos;t have bandwidth at the moment but probably in ~2 weeks, so I can help then too if needed. Thanks!&lt;/p&gt;</comment>
                            <comment id="17952397" author="JIRAUSER301926" created="Sun, 18 May 2025 03:33:20 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bloku&quot; class=&quot;user-hover&quot; rel=&quot;bloku&quot;&gt;bloku&lt;/a&gt; I was already working on it.Can you reassigned to me  back &lt;/p&gt;</comment>
                            <comment id="17952424" author="JIRAUSER309258" created="Sun, 18 May 2025 09:46:59 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=goyarpit&quot; class=&quot;user-hover&quot; rel=&quot;goyarpit&quot;&gt;goyarpit&lt;/a&gt; Sure. FYI: ticket was assignee to no one&lt;/p&gt;</comment>
                            <comment id="17952690" author="JIRAUSER301926" created="Mon, 19 May 2025 16:54:42 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lianetm&quot; class=&quot;user-hover&quot; rel=&quot;lianetm&quot;&gt;lianetm&lt;/a&gt; I am unable to reproduce this issue. Can you help me the command for the producer set up you are running. Do I need to run the producer with continuous generation of  data  ?&lt;/p&gt;</comment>
                            <comment id="17953066" author="JIRAUSER300183" created="Wed, 21 May 2025 07:02:17 +0000"  >&lt;p&gt;Hey &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=goyarpit&quot; class=&quot;user-hover&quot; rel=&quot;goyarpit&quot;&gt;goyarpit&lt;/a&gt;, sure, added it to the description of the jira. Let me know. Thanks! &lt;/p&gt;</comment>
                            <comment id="17953748" author="JIRAUSER301926" created="Fri, 23 May 2025 17:13:17 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lianetm&quot; class=&quot;user-hover&quot; rel=&quot;lianetm&quot;&gt;lianetm&lt;/a&gt; I am still not able to reproduce the issue with the producer running similar to what you have. Any direction you want to suggest ?&lt;br/&gt;
I am running with 6 partitions and using kraft mode&lt;/p&gt;</comment>
                            <comment id="17953933" author="JIRAUSER301926" created="Sun, 25 May 2025 16:29:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lianetm&quot; class=&quot;user-hover&quot; rel=&quot;lianetm&quot;&gt;lianetm&lt;/a&gt; I was just going through the code and  I think this can be the issue  though I am not able to reproduce it.&lt;br/&gt;
1. Application thread   checks empty buffer and is about to wait&lt;br/&gt;
2. Consumer Network thread adds data and signals&lt;br/&gt;
3. Application thread misses the non-empty state check but hasn&apos;t started waiting yet&lt;br/&gt;
4. Application thread  then waits for the full timeout despite data being available. &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lianetm&quot; class=&quot;user-hover&quot; rel=&quot;lianetm&quot;&gt;lianetm&lt;/a&gt; My bad. This will not be possible as both share the same lock.&lt;/p&gt;

</comment>
                            <comment id="17954402" author="JIRAUSER300183" created="Tue, 27 May 2025 19:32:53 +0000"  >&lt;p&gt;Hey &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=goyarpit&quot; class=&quot;user-hover&quot; rel=&quot;goyarpit&quot;&gt;goyarpit&lt;/a&gt;, sorry I&apos;ve been away but checked again and these are the exact steps I follow and see the different pattern (repro now, on trunk):&lt;br/&gt;
1- ./bin/kafka-server-start.sh config/server.properties&lt;br/&gt;
2- bin/kafka-topics.sh --bootstrap-server localhost:9092 --create --topic t1 --partitions 6&lt;br/&gt;
3- while sleep 1; do echo $(uuidgen); done | bin/kafka-console-producer.sh --bootstrap-server localhost:9092 --topic t1&lt;br/&gt;
4- bin/kafka-console-consumer.sh --topic t1 --bootstrap-server localhost:9092 --consumer-property group.protocol=classic --group cg1 --consumer-property enable.auto.commit=false     ==&amp;gt; ( here I see records continuously)&lt;br/&gt;
5- bin/kafka-console-consumer.sh --topic t1 --bootstrap-server localhost:9092 --consumer-property group.protocol=consumer --group cg1 --consumer-property enable.auto.commit=false     ==&amp;gt; ( here I see records in kind of batches, with a delay in between. This is probably what leads to the spiky lag we also see with the new consumer only, when describing the group with the command line tool too)&lt;/p&gt;

&lt;p&gt;I recorded a video of the output so you can see the pattern I refer too that we need to understand.&lt;br/&gt;
&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13076717/13076717_console-consumer-classic-vs-consumer.mov&quot; title=&quot;console-consumer-classic-vs-consumer.mov attached to KAFKA-19259&quot;&gt;console-consumer-classic-vs-consumer.mov&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; &lt;/p&gt;

&lt;p&gt;I&apos;ll be looking into this in detail soon but hope this helps in the meantime.&lt;br/&gt;
Thanks for your help!&lt;/p&gt;</comment>
                            <comment id="17955031" author="JIRAUSER301926" created="Thu, 29 May 2025 18:56:09 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lianetm&quot; class=&quot;user-hover&quot; rel=&quot;lianetm&quot;&gt;lianetm&lt;/a&gt; for the videos. I will check and verify.&lt;/p&gt;</comment>
                            <comment id="17955389" author="JIRAUSER301926" created="Sat, 31 May 2025 09:30:00 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lianetm&quot; class=&quot;user-hover&quot; rel=&quot;lianetm&quot;&gt;lianetm&lt;/a&gt; I tried with the same set up and even enabled debug logs and added logs in awaitNotEmpty , I have not observed it has taken the full poll timeout though. &lt;br/&gt;
Check this log line Wait timed out after 1688 ms  approximately 1.5 second, is this could be the issue ?&lt;br/&gt;
I am attaching the logs for your reference.  &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13076784/13076784_debug5.log&quot; title=&quot;debug5.log attached to KAFKA-19259&quot;&gt;debug5.log&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; &lt;br/&gt;
The other logs where i see at very initial poll timeout of 5 sec. &lt;br/&gt;
 &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13076787/13076787_consumer_KAFKA-19259.log&quot; title=&quot;consumer_KAFKA-19259.log attached to KAFKA-19259&quot;&gt;consumer_KAFKA-19259.log&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; &lt;/p&gt;

</comment>
                            <comment id="17956545" author="JIRAUSER301926" created="Fri, 6 Jun 2025 09:36:08 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lianetm&quot; class=&quot;user-hover&quot; rel=&quot;lianetm&quot;&gt;lianetm&lt;/a&gt; &lt;br/&gt;
Update on the above issue:&lt;br/&gt;
It seems I figured out the issue. It seems we are not sending immediate fetches in the new consumer compared to the classic one. Check this logs , I added debug logs in awaitNotEmpty function. Ideally the consumer should be making multiple fetch requests during the 5-second poll period, especially since each fetch request has maxWaitMs=500ms. Instead, it seems to be waiting the full poll timeout after receiving just one empty response. &lt;br/&gt;
As a next step I will be checking  part of the code which is preventing fetches.&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[2025-06-06 13:07:26,720] DEBUG [Consumer clientId=console-consumer, groupId=cg2] Entering awaitNotEmpty with timer remaining: 4949ms (org.apache.kafka.clients.consumer.internals.FetchBuffer)
[2025-06-06 13:07:26,720] DEBUG [Consumer clientId=console-consumer, groupId=cg2] Buffer is empty, will wait. Timer remaining: 4949ms, wokenup: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt; (org.apache.kafka.clients.consumer.internals.FetchBuffer)
[2025-06-06 13:07:26,720] DEBUG [Consumer clientId=console-consumer, groupId=cg2] Starting wait at 1749195446720 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; 4949ms (org.apache.kafka.clients.consumer.internals.FetchBuffer)
[2025-06-06 13:07:27,230] DEBUG [Consumer clientId=console-consumer, groupId=cg2] Received FETCH response from node 1 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; request with header RequestHeader(apiKey=FETCH, apiVersion=17, clientId=console-consumer, correlationId=44, headerVersion=2): FetchResponseData(throttleTimeMs=0, errorCode=0, sessionId=963412284, responses=[], nodeEndpoints=[]) (org.apache.kafka.clients.NetworkClient)
[2025-06-06 13:07:27,325] DEBUG [Consumer clientId=console-consumer, groupId=cg2] Node 1 sent an incremental fetch response with throttleTimeMs = 0 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; session 963412284 with 0 response partition(s), 6 implied partition(s) (org.apache.kafka.clients.FetchSessionHandler)
[2025-06-06 13:07:27,325] DEBUG [Consumer clientId=console-consumer, groupId=cg2] Removing pending request &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; fetch session: 963412284 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; node: localhost:9092 (id: 1 rack: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; isFenced: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;) (org.apache.kafka.clients.consumer.internals.AbstractFetch)
[2025-06-06 13:07:31,678] DEBUG [Consumer clientId=console-consumer, groupId=cg2] Wait timed out after 4955ms (org.apache.kafka.clients.consumer.internals.FetchBuffer)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</comment>
                            <comment id="17956632" author="JIRAUSER300183" created="Fri, 6 Jun 2025 16:04:34 +0000"  >&lt;p&gt;Hey &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=goyarpit&quot; class=&quot;user-hover&quot; rel=&quot;goyarpit&quot;&gt;goyarpit&lt;/a&gt;, interesting! We had a kind of major change in this exact area (the pace at which we send fetch requests), so I wonder if this has always been the case or if this is a regression&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/kafka/commit/9e424755d4d236442847b13863580f44f27e22a6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/commit/9e424755d4d236442847b13863580f44f27e22a6&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I haven&apos;t had the time to try to repro without that commit, but maybe worth checking.&lt;/p&gt;

&lt;p&gt;For the record, I did try a while back excluding the other major change we had in fetch but still saw the same behaviour, so not related ( excluding this &lt;a href=&quot;https://github.com/apache/kafka/commit/057460e807a218b169c69ae0b849e0b3b4d27f42&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/commit/057460e807a218b169c69ae0b849e0b3b4d27f42&lt;/a&gt;, but same behviour so not related)&lt;/p&gt;

&lt;p&gt;Sharing in case it helps! Keep me posted. Thanks!&lt;/p&gt;</comment>
                            <comment id="17956788" author="JIRAUSER301926" created="Sun, 8 Jun 2025 18:15:30 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lianetm&quot; class=&quot;user-hover&quot; rel=&quot;lianetm&quot;&gt;lianetm&lt;/a&gt;&#160; I am able to figure out the root cause of the issue. As per my observation it is happening because of incorrect handling of pendingFetchRequestFuture flag which control&#160; fetch request need to be sent or not.&lt;/p&gt;

&lt;p&gt;Let&apos;s walk through the code&apos;s logic inside pollForFetches:&lt;br/&gt;
&lt;b&gt;Step 1: Check the Buffer&lt;/b&gt;&lt;br/&gt;
First, the application thread tries to get any records that might already be waiting in the FetchBuffer.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// Simplified from AsyncKafkaConsumer.pollForFetches()
&lt;/span&gt;Fetch&amp;lt;K, V&amp;gt; fetch = fetchCollector.collectFetch(fetchBuffer);
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!fetch.isEmpty()) {
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; fetch; &lt;span class=&quot;code-comment&quot;&gt;// Data was already there, &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; immediately
&lt;/span&gt;}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;On the first call, the buffer is empty, so this check fails.&lt;br/&gt;
&lt;b&gt;Step 2: Send the Fetch Request&lt;/b&gt;&lt;br/&gt;
Since the buffer was empty, the application thread asks the background thread to go get some data.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// Simplified from AsyncKafkaConsumer.pollForFetches()
&lt;/span&gt;sendFetches(timer);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;this is where the flawed logic happens:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;A CreateFetchRequestsEvent is sent.&lt;/li&gt;
	&lt;li&gt;The background thread creates the network request.&lt;/li&gt;
	&lt;li&gt;The background thread prematurely completes the future and nulls it out. What it means is request may not even yet received by broker , but pendingFetchRequestFuture has been marked completed.&lt;/li&gt;
&lt;/ol&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
      List&amp;lt;UnsentRequest&amp;gt; requests = fetchRequests.entrySet().stream().map(entry -&amp;gt; {
                &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Node fetchTarget = entry.getKey();
                &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; FetchSessionHandler.FetchRequestData data = entry.getValue();
                &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; FetchRequest.Builder request = createFetchRequest(fetchTarget, data);
                &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; BiConsumer&amp;lt;ClientResponse, Throwable&amp;gt; responseHandler = (clientResponse, error) -&amp;gt; {
                    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (error != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
                        errorHandler.handle(fetchTarget, data, error);
                    &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;
                        successHandler.handle(fetchTarget, data, clientResponse);
                };

                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; UnsentRequest(request, Optional.of(fetchTarget)).whenComplete(responseHandler);
            }).collect(Collectors.toList());

            pendingFetchRequestFuture.complete(&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PollResult(requests);
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Throwable t) {
            &lt;span class=&quot;code-comment&quot;&gt;// A &lt;span class=&quot;code-quote&quot;&gt;&quot;dummy&quot;&lt;/span&gt; poll result is returned here rather than rethrowing the error because any error
&lt;/span&gt;            &lt;span class=&quot;code-comment&quot;&gt;// that is thrown from any RequestManager.poll() method interrupts the polling of the other
&lt;/span&gt;            &lt;span class=&quot;code-comment&quot;&gt;// request managers.
&lt;/span&gt;            pendingFetchRequestFuture.completeExceptionally(t);
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; PollResult.EMPTY;
        } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
            pendingFetchRequestFuture = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160; &#160; 4. The sendFetches() call unblocks on the application thread.&lt;br/&gt;
&lt;b&gt;Step 3: Wait on awaitNotEmpty (The Crucial Step)&lt;/b&gt;&lt;br/&gt;
Now that the application thread has been told the request is &quot;sent,&quot; it doesn&apos;t return immediately. Instead, it waits on the buffer.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// Simplified from AsyncKafkaConsumer.pollForFetches()
&lt;/span&gt;fetchBuffer.awaitNotEmpty(timer); &lt;span class=&quot;code-comment&quot;&gt;// BLOCKING CALL
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; fetchCollector.collectFetch(fetchBuffer);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The fetchBuffer.awaitNotEmpty(timer) call does the following: &quot;Pause the application thread until one of two things happens:&lt;br/&gt;
1. The background thread puts new records into the fetchBuffer and notifies me.&lt;br/&gt;
2. The timer (which is controlled by your poll(timeout)) expires.&quot;&lt;br/&gt;
&lt;b&gt;Step 4: The Two Paths (The Bug&apos;s Impact)&lt;/b&gt;&lt;br/&gt;
This is where the outcome diverges and where delay comes from.&lt;br/&gt;
&lt;b&gt;&lt;em&gt;Scenario A: The Happy Path (Data Arrives)&lt;/em&gt;&lt;/b&gt;&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;The response for FetchRequest #1 arrives from the broker with records.&lt;/li&gt;
	&lt;li&gt;The background thread processes the response and calls fetchBuffer.add(records).&lt;/li&gt;
	&lt;li&gt;This add operation notifies the condition variable that awaitNotEmpty is waiting on.&lt;/li&gt;
	&lt;li&gt;The application thread in awaitNotEmpty wakes up instantly, collects the fetch, and returns the data to the user. This feels fast and responsive.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&lt;em&gt;&lt;b&gt;Scenario B: The Buggy Path (Empty Response)&lt;/b&gt;&lt;/em&gt;&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;The response for FetchRequest #1 arrives from the broker, but it&apos;s empty.&lt;/li&gt;
	&lt;li&gt;The background thread sees the empty response. It does not add anything to the fetchBuffer.&lt;/li&gt;
	&lt;li&gt;Because the pendingFetchRequestFuture was already cleared, the background thread does not know it should immediately send a new fetch request. It simply goes idle.&lt;/li&gt;
&lt;/ol&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; PollResult pollInternal(FetchRequestPreparer fetchRequestPreparer,
                                    ResponseHandler&amp;lt;ClientResponse&amp;gt; successHandler,
                                    ResponseHandler&amp;lt;Throwable&amp;gt; errorHandler) {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (pendingFetchRequestFuture == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
            log.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;HACK (Background &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;): pollInternal was called, but pendingFetchRequestFuture is &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;. No action will be taken.&quot;&lt;/span&gt;);
            &lt;span class=&quot;code-comment&quot;&gt;// If no explicit request &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; creating fetch requests was issued, just &lt;span class=&quot;code-object&quot;&gt;short&lt;/span&gt;-circuit.
&lt;/span&gt;            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; PollResult.EMPTY;
        }

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;font color=&quot;#FF0000&quot;&gt;Therefore, the awaitNotEmpty call on the application thread is never notified. It has no choice but to sit there and wait until the timer you provided in poll(timeout) expires&lt;/font&gt;.&lt;/p&gt;

&lt;p&gt;I have also added log statements which&#160; depict the above behaviour.Attaching the full logs.&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13076883/13076883_consumer11_KAFKA-19259.log&quot; title=&quot;consumer11_KAFKA-19259.log attached to KAFKA-19259&quot;&gt;consumer11_KAFKA-19259.log&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[2025-06-08 22:23:34,921] DEBUG [Consumer clientId=console-consumer, groupId=cg15] Entering awaitNotEmpty with timer remaining: 4065ms (org.apache.kafka.clients.consumer.internals.FetchBuffer)
[2025-06-08 22:23:34,921] DEBUG [Consumer clientId=console-consumer, groupId=cg15] Buffer is empty, will wait. Timer remaining: 4065ms, wokenup: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt; (org.apache.kafka.clients.consumer.internals.FetchBuffer)
[2025-06-08 22:23:34,921] DEBUG [Consumer clientId=console-consumer, groupId=cg15] Starting wait at 1749401614921 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; 4065ms (org.apache.kafka.clients.consumer.internals.FetchBuffer)
[2025-06-08 22:23:35,431] DEBUG [Consumer clientId=console-consumer, groupId=cg15] Received FETCH response from node 1 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; request with header RequestHeader(apiKey=FETCH, apiVersion=17, clientId=console-consumer, correlationId=79, headerVersion=2): FetchResponseData(throttleTimeMs=0, errorCode=0, sessionId=1018152883, responses=[], nodeEndpoints=[]) (org.apache.kafka.clients.NetworkClient)
[2025-06-08 22:23:35,433] DEBUG [Consumer clientId=console-consumer, groupId=cg15] Node 1 sent an incremental fetch response with throttleTimeMs = 0 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; session 1018152883 with 0 response partition(s), 6 implied partition(s) (org.apache.kafka.clients.FetchSessionHandler)
[2025-06-08 22:23:35,433] DEBUG [Consumer clientId=console-consumer, groupId=cg15] Removing pending request &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; fetch session: 1018152883 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; node: localhost:9092 (id: 1 rack: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; isFenced: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;) (org.apache.kafka.clients.consumer.internals.AbstractFetch)
[2025-06-08 22:23:35,434] INFO [Consumer clientId=console-consumer, groupId=cg15] HACK (Background &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;): pollInternal was called, but pendingFetchRequestFuture is &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;. No action will be taken. (org.apache.kafka.clients.consumer.internals.FetchRequestManager)
[2025-06-08 22:23:38,994] DEBUG [Consumer clientId=console-consumer, groupId=cg15] Wait timed out after 4071ms (org.apache.kafka.clients.consumer.internals.FetchBuffer)
[2025-06-08 22:23:39,004] INFO [Consumer clientId=console-consumer, groupId=cg15] HACK (Background &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;): pollInternal was called, but pendingFetchRequestFuture is &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;. No action will be taken. (org.apache.kafka.clients.consumer.internals.FetchRequestManager)
[2025-06-08 22:23:39,406] DEBUG [Consumer clientId=console-consumer, groupId=cg15] Exiting awaitNotEmpty. Buffer empty: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, wokenup: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, timer remaining: 4065ms (
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17959621" author="kirktrue" created="Wed, 11 Jun 2025 00:40:46 +0000"  >&lt;p&gt;tl;dr There&#8217;s a difference in the two consumers&#8217; &lt;tt&gt;pollForFetches()&lt;/tt&gt; methods in this case: &lt;tt&gt;ClassicKafkaConsumer&lt;/tt&gt; doesn&apos;t block for &lt;tt&gt;pollTimeout&lt;/tt&gt;, but AsyncKafkaConsumer does.&lt;/p&gt;

&lt;p&gt;At the beginning of &lt;tt&gt;ClassicKafkaConsumer&lt;/tt&gt;, &lt;tt&gt;pollForFetches()&lt;/tt&gt; calculates the value of &lt;tt&gt;pollTimeout&lt;/tt&gt;. When &lt;tt&gt;pollForFetches()&lt;/tt&gt; determines it needs to fetch more data, a &lt;tt&gt;FETCH&lt;/tt&gt; request is enqueued into the &lt;tt&gt;NetworkClient&lt;/tt&gt; within &lt;tt&gt;sendFetches()&lt;/tt&gt;. Then &lt;tt&gt;ClassicKafkaConsumer&lt;/tt&gt; calls &lt;tt&gt;ConsumerNetworkClient.poll()&lt;/tt&gt; which will call &lt;tt&gt;NetworkClient.poll()&lt;/tt&gt;. This will then send out the request over the network. Even though &lt;tt&gt;pollForFetches()&lt;/tt&gt; has a value of 3000 for &lt;tt&gt;pollTimeout&lt;/tt&gt;, the underlying call to &lt;tt&gt;NetworkClient.poll()&lt;/tt&gt; returns &lt;em&gt;almost instantaneously&lt;/em&gt; because it successfully sent the &lt;tt&gt;FETCH&lt;/tt&gt; request. So even though the &lt;tt&gt;pollTimeout&lt;/tt&gt; value is 3000, the call to &lt;tt&gt;ConsumerNetworkClient.poll()&lt;/tt&gt; doesn&apos;t block (in this case).&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;AsyncKafkaConsumer&lt;/tt&gt;, &lt;tt&gt;pollForFetches()&lt;/tt&gt; starts the same way as &lt;tt&gt;ClassicKafkaConsumer&lt;/tt&gt;, by calculating &lt;tt&gt;pollTimeout&lt;/tt&gt;. When &lt;tt&gt;pollForFetches()&lt;/tt&gt; determines it needs to fetch more data, a &lt;tt&gt;FETCH&lt;/tt&gt; request is created (but not necessarily immediately enqueued into the &lt;tt&gt;NetworkClient&lt;/tt&gt; within &lt;tt&gt;sendFetches()&lt;/tt&gt;). Because the &lt;tt&gt;FETCH&lt;/tt&gt; response is empty, there&apos;s no new data in &lt;tt&gt;FetchBuffer&lt;/tt&gt;. &#160;&lt;tt&gt;AsyncKafkaConsumer&lt;/tt&gt; then calls &lt;tt&gt;FetchBuffer.awaitNotEmpty()&lt;/tt&gt;&#160;and proceeds to block there for the full length of &lt;tt&gt;pollTimeout&lt;/tt&gt;. Because it&apos;s blocked, it&apos;s not sending out any more &lt;tt&gt;FETCH&lt;/tt&gt; requests, causing the long pauses in the console consumer.&lt;/p&gt;</comment>
                            <comment id="17959773" author="JIRAUSER301926" created="Wed, 11 Jun 2025 15:57:34 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kirktrue&quot; class=&quot;user-hover&quot; rel=&quot;kirktrue&quot;&gt;kirktrue&lt;/a&gt; &#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lianetm&quot; class=&quot;user-hover&quot; rel=&quot;lianetm&quot;&gt;lianetm&lt;/a&gt;&#160; I was trying to highlight the issue causing in AsyncKafkaConsumer and&#160; pendingRequestFuture is a flag which does not allow further fetches when fetchResponse is empty as it was completed and set to null even before the fetch response.&lt;/p&gt;

&lt;p&gt;Yes &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kirktrue&quot; class=&quot;user-hover&quot; rel=&quot;kirktrue&quot;&gt;kirktrue&lt;/a&gt;&#160; this is the reason the issue is not replicated in the classic consumer.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kirktrue&quot; class=&quot;user-hover&quot; rel=&quot;kirktrue&quot;&gt;kirktrue&lt;/a&gt; &#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lianetm&quot; class=&quot;user-hover&quot; rel=&quot;lianetm&quot;&gt;lianetm&lt;/a&gt;&#160; let me know if the above comment helps to understand the cause of the issue or not&#160; ?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17966291" author="kirktrue" created="Thu, 12 Jun 2025 19:01:14 +0000"  >&lt;blockquote&gt;&lt;p&gt;The background thread prematurely completes the future and nulls it out. What it means is request may not even yet received by broker , but pendingFetchRequestFuture has been marked completed.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;The &lt;tt&gt;Future&lt;/tt&gt; from &lt;tt&gt;CreateFetchRequestsEvent&lt;/tt&gt; is intentionally completed before the request is sent. I agree, it seems odd and it&apos;s not the cleanest solution. Unfortunately, if we simply delay completing the Future until the response is &lt;em&gt;received&lt;/em&gt;, we run into a different problem: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-17182&quot; title=&quot;Consumer fetch sessions are evicted too quickly with AsyncKafkaConsumer&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-17182&quot;&gt;&lt;del&gt;KAFKA-17182&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17966294" author="kirktrue" created="Thu, 12 Jun 2025 19:09:31 +0000"  >&lt;p&gt;Additionally, as highlighted in step 4, scenario B, point 3...&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Because the pendingFetchRequestFuture was already cleared, the background thread does not know it should immediately send a new fetch request. It simply goes idle.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I agree, it seems reasonable to have the consumer send another &lt;tt&gt;FETCH&lt;/tt&gt; request instead of waiting. However, the timing of &lt;tt&gt;FETCH&lt;/tt&gt; requests was deliberately changed to make the &lt;tt&gt;AsyncKafkaConsumer&lt;/tt&gt; act more like &lt;tt&gt;ClassicKafkaConsumer&lt;/tt&gt; in terms of when it sends &lt;tt&gt;FETCH&lt;/tt&gt; requests. See &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-17439&quot; title=&quot;Make polling for new records an explicit action/event in the new consumer&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-17439&quot;&gt;&lt;del&gt;KAFKA-17439&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17966756" author="kirktrue" created="Thu, 12 Jun 2025 19:42:31 +0000"  >&lt;p&gt;Toward the end of &lt;tt&gt;pollForFetches()&lt;/tt&gt;, the &lt;tt&gt;ClassicKafkaConsumer&lt;/tt&gt; has this code:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
client.poll(pollTimer, () -&amp;gt; {
    &lt;span class=&quot;code-comment&quot;&gt;// since a fetch might be completed by the background thread, we need &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; poll condition
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// to ensure that we &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; not block unnecessarily in poll()
&lt;/span&gt;    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; !fetcher.hasAvailableFetches();
});&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The call to &lt;tt&gt;client.poll()&lt;/tt&gt; will return before the timer in the following cases:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;An outgoing request is sent&lt;/li&gt;
	&lt;li&gt;An incoming response is received&lt;/li&gt;
	&lt;li&gt;Another thread calls &lt;tt&gt;wakeup()&lt;/tt&gt;&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;In other words, &lt;tt&gt;ClassicKafkaConsumer&lt;/tt&gt; blocks on &lt;em&gt;network activity&lt;/em&gt;&#160;while &lt;tt&gt;AsyncKafkaConsumer&lt;/tt&gt; blocks on data in the fetch buffer.&lt;/p&gt;</comment>
                            <comment id="17976507" author="JIRAUSER301926" created="Sun, 15 Jun 2025 06:55:38 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kirktrue&quot; class=&quot;user-hover&quot; rel=&quot;kirktrue&quot;&gt;kirktrue&lt;/a&gt;&#160; I still not understand how delaying pendingFetchFuture would impact &#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-17182&quot; title=&quot;Consumer fetch sessions are evicted too quickly with AsyncKafkaConsumer&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-17182&quot;&gt;&lt;del&gt;KAFKA-17182&lt;/del&gt;&lt;/a&gt;. Am i understanding correctly , will it delay or latent the fetch request more.&#160;&lt;/p&gt;</comment>
                            <comment id="17984959" author="JIRAUSER301926" created="Fri, 20 Jun 2025 12:25:12 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lianetm&quot; class=&quot;user-hover&quot; rel=&quot;lianetm&quot;&gt;lianetm&lt;/a&gt; &#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kirktrue&quot; class=&quot;user-hover&quot; rel=&quot;kirktrue&quot;&gt;kirktrue&lt;/a&gt;&#160; Any pointer where should I head for the fix ? I am still not convinced/understand how completing pendingRequestFuture would increase the eviction rate.&#160;&lt;/p&gt;</comment>
                            <comment id="17986156" author="mimaison" created="Wed, 25 Jun 2025 14:18:29 +0000"  >&lt;p&gt;Moving to the next release as we&apos;re now in code freeze for 4.1.0.&lt;/p&gt;</comment>
                            <comment id="17986566" author="JIRAUSER300183" created="Fri, 27 Jun 2025 14:45:36 +0000"  >&lt;p&gt;Hey &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=goyarpit&quot; class=&quot;user-hover&quot; rel=&quot;goyarpit&quot;&gt;goyarpit&lt;/a&gt;! &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kirktrue&quot; class=&quot;user-hover&quot; rel=&quot;kirktrue&quot;&gt;kirktrue&lt;/a&gt; was exploring a fix in a draft here &lt;a href=&quot;https://github.com/apache/kafka/pull/19980&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/19980&lt;/a&gt; , but my understanding is that is was still exploratory mainly due to some side effects it could have on performance in other areas. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kirktrue&quot; class=&quot;user-hover&quot; rel=&quot;kirktrue&quot;&gt;kirktrue&lt;/a&gt; can confirm better.&lt;/p&gt;</comment>
                            <comment id="17986571" author="JIRAUSER301926" created="Fri, 27 Jun 2025 15:49:41 +0000"  >&lt;p&gt;Ok &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lianetm&quot; class=&quot;user-hover&quot; rel=&quot;lianetm&quot;&gt;lianetm&lt;/a&gt;&#160; thanks for updating.if &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kirktrue&quot; class=&quot;user-hover&quot; rel=&quot;kirktrue&quot;&gt;kirktrue&lt;/a&gt;&#160; is already working on the fix , Let me know if I can help in any way , would love to contribute on the new consumer protocol.&lt;/p&gt;</comment>
                            <comment id="17988008" author="kirktrue" created="Wed, 2 Jul 2025 23:58:56 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=goyarpit&quot; class=&quot;user-hover&quot; rel=&quot;goyarpit&quot;&gt;goyarpit&lt;/a&gt;&#8212;thanks for your help on this so far! Please do continue to pursue this. There are a potentially a number of ways we can solve it, so there&apos;s no reason we can&apos;t both work on it in parallel.&lt;/p&gt;</comment>
                            <comment id="17993107" author="JIRAUSER301926" created="Thu, 3 Jul 2025 14:55:41 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kirktrue&quot; class=&quot;user-hover&quot; rel=&quot;kirktrue&quot;&gt;kirktrue&lt;/a&gt;&#160; Sure. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kirktrue&quot; class=&quot;user-hover&quot; rel=&quot;kirktrue&quot;&gt;kirktrue&lt;/a&gt;&#160; how you were testing fetch eviction rate . Is there a benchmark script already exist , which I can leverage for testing&#160;&lt;/p&gt;</comment>
                            <comment id="17999332" author="kirktrue" created="Sun, 6 Jul 2025 01:16:59 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=goyarpit&quot; class=&quot;user-hover&quot; rel=&quot;goyarpit&quot;&gt;goyarpit&lt;/a&gt; the fetch eviction rate issue was found using an internal testing environment, so it&apos;s not something that can be shared.&lt;/p&gt;

&lt;p&gt;For 4.2, I&apos;m taking on the ambitious task of solving the consumer performance issues we&apos;ve uncovered (including this one). A good chunk of that work is to build up some of our internal testing infrastructure so that we can run proposed fixes against a battery of performance workloads to ensure there aren&apos;t any regressions. From a logistical perspective, the tests require a lot of infrastructure that can&apos;t be replicated. So while I can&apos;t make those tests self-service, if you want to provide suggested fixes, we should be able to run those in our testing infrastructure and share the logs, metrics, etc.&lt;/p&gt;</comment>
                            <comment id="18016842" author="kirktrue" created="Thu, 28 Aug 2025 17:46:02 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=goyarpit&quot; class=&quot;user-hover&quot; rel=&quot;goyarpit&quot;&gt;goyarpit&lt;/a&gt;&#8212;I have a proposed fix linked to this Jira. Would you be willing to review it? Thanks!&lt;/p&gt;</comment>
                            <comment id="18016858" author="JIRAUSER301926" created="Thu, 28 Aug 2025 18:34:12 +0000"  >&lt;p&gt;Yes &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kirktrue&quot; class=&quot;user-hover&quot; rel=&quot;kirktrue&quot;&gt;kirktrue&lt;/a&gt;&#160; sure. Can you share me the proposed fix or PR for it&lt;/p&gt;</comment>
                            <comment id="18017567" author="kirktrue" created="Tue, 2 Sep 2025 00:36:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=goyarpit&quot; class=&quot;user-hover&quot; rel=&quot;goyarpit&quot;&gt;goyarpit&lt;/a&gt;&#8212;yes, the proposed fix is the PR linked above: &lt;a href=&quot;https://github.com/apache/kafka/pull/19980&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/19980&lt;/a&gt;. Thanks!&lt;/p&gt;</comment>
                            <comment id="18018420" author="JIRAUSER301926" created="Fri, 5 Sep 2025 15:09:14 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lianetm&quot; class=&quot;user-hover&quot; rel=&quot;lianetm&quot;&gt;lianetm&lt;/a&gt;&#160; is this resolved ? I will look the PR anyway to see the changes.&#160;&lt;/p&gt;</comment>
                            <comment id="18018432" author="JIRAUSER300183" created="Fri, 5 Sep 2025 15:58:19 +0000"  >&lt;p&gt;Hey &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=goyarpit&quot; class=&quot;user-hover&quot; rel=&quot;goyarpit&quot;&gt;goyarpit&lt;/a&gt; , the proposed fixed solved it cleanly, but please take a look and let us know if you catch anything. We&apos;re trying to move fast to make sure this and other consumer improvements still WIP land in the next release (there are some in review under component &quot;consumer&quot;, feel free to jump in). Thanks for you help!&lt;/p&gt;</comment>
                            <comment id="18018434" author="JIRAUSER301926" created="Fri, 5 Sep 2025 16:03:39 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lianetm&quot; class=&quot;user-hover&quot; rel=&quot;lianetm&quot;&gt;lianetm&lt;/a&gt; i will have a look . And let me know if there is something i can pick up and&#160; work on parallely which also help me to learn more about the new consumer flow.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13564776">KAFKA-16143</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13076788" name="Screenshot 2025-05-31 at 10.44.29&#8239;PM.png" size="392546" author="goyarpit" created="Sat, 31 May 2025 17:20:02 +0000"/>
                            <attachment id="13076717" name="console-consumer-classic-vs-consumer.mov" size="9955149" author="lianetm" created="Tue, 27 May 2025 19:28:00 +0000"/>
                            <attachment id="13076883" name="consumer11_KAFKA-19259.log" size="421710" author="goyarpit" created="Sun, 8 Jun 2025 18:12:46 +0000"/>
                            <attachment id="13076787" name="consumer_KAFKA-19259.log" size="967074" author="goyarpit" created="Sat, 31 May 2025 17:18:11 +0000"/>
                            <attachment id="13076784" name="debug5.log" size="1048575" author="goyarpit" created="Sat, 31 May 2025 09:29:59 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1vs5s:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>