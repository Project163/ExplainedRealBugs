<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:43:11 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-19356] AsyncConsumer should ensure consistency of assigned partitions and subscription</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-19356</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;With the new AsyncConsumer, the client reconciles partitions assigned by the coordinator, and does not perform any validation against the subscription (letting the coordinator drive, and expecting that subscription/assignments should become consistent on the next HB req/resp round). &lt;/p&gt;

&lt;p&gt;Still, this allows for a window of time where they would not be consistent on the client, and the main risk is related to fetching I would expect: a subscription change will clear the fetch buffer in the async consumer, but won&apos;t prevent processing fetch responses for previous requests or issuing new ones for an assigned partition that is not in the subscription anymore? (fetched records are only discarded &lt;a href=&quot;https://github.com/apache/kafka/blob/cc0f06554bacc9fe086c4f4c5ecee1b5dc75ae9b/clients/src/main/java/org/apache/kafka/clients/consumer/internals/FetchCollector.java#L153-L159&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; if the partition is not assigned or not fetchable, so that would prevent this risk from what I can see, could be missing something). &lt;/p&gt;

&lt;p&gt;The Classic consumer ensures it does not maintain/fetch assigned partitions that are not in the subscription in 2 ways:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;classicConsumer does not take assignments received from the coordinator that are not in the subscription (&quot;ignores&quot;/rejoins if it gets them) (&lt;a href=&quot;https://github.com/apache/kafka/blob/cc0f06554bacc9fe086c4f4c5ecee1b5dc75ae9b/clients/src/main/java/org/apache/kafka/clients/consumer/internals/ConsumerCoordinator.java#L410C28-L410C62&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;). For this case, we could consider doing it in the AsyncConsumer similarly, maybe not reconciling assignments received in HB response but not in the subscription.&lt;/li&gt;
	&lt;li&gt;classicConsumer pro-actively revokes assigned partitions not in the subscription on every onJoinPrepare (blocking, updating the assignment before fetching, &lt;a href=&quot;https://github.com/apache/kafka/blob/cc0f06554bacc9fe086c4f4c5ecee1b5dc75ae9b/clients/src/main/java/org/apache/kafka/clients/consumer/internals/ConsumerCoordinator.java#L838-L849&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;). For this case we need to consider a bit more. We surely want to keep the client away from driving assignment logic to keep it only on the coordinator, but if we say we&apos;re waiting for the coordinator to revoke that partition (on the next HB req/resp round), we still need to ensure on the client that we don&apos;t consider such partition &quot;fetchable&quot;, and that we discard fetch responses for it.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Note that these validations could be applied on the client for explicit subscription or client side regex only. In the case of broker-side regex the client cannot perform any validation given that it never computes the regex (and should not).&lt;/p&gt;</description>
                <environment></environment>
        <key id="13619716">KAFKA-19356</key>
            <summary>AsyncConsumer should ensure consistency of assigned partitions and subscription</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="lianetm">Lianet Magrans</assignee>
                                    <reporter username="lianetm">Lianet Magrans</reporter>
                        <labels>
                            <label>consumer-threading-refactor</label>
                            <label>kip-848-client-support</label>
                    </labels>
                <created>Fri, 30 May 2025 19:30:44 +0000</created>
                <updated>Thu, 19 Jun 2025 13:09:22 +0000</updated>
                            <resolved>Thu, 19 Jun 2025 13:09:22 +0000</resolved>
                                                    <fixVersion>4.1.0</fixVersion>
                                    <component>clients</component>
                    <component>consumer</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17955340" author="kirktrue" created="Fri, 30 May 2025 22:38:30 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lianetm&quot; class=&quot;user-hover&quot; rel=&quot;lianetm&quot;&gt;lianetm&lt;/a&gt;&#8212;The link to &lt;tt&gt;FetchCollector.fetchRecords()&lt;/tt&gt; you included is designed to catch the case where a topic/partition is unassigned between the fetch request and its response.&lt;/p&gt;

&lt;p&gt;My reading of the description is that the following is partially inaccurate:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;a subscription change will clear the fetch buffer in the async consumer, but won&apos;t prevent processing fetch responses for previous requests or issuing new ones for an assigned partition that is not in the subscription anymore?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;The check in &lt;tt&gt;fetchRecords()&lt;/tt&gt; should &#8220;prevent processing fetch responses for previous requests . . . that is not in the subscription anymore.&#8221; I could be misunderstanding the phrasing. If so, please correct my erroneous interpretation.&lt;/p&gt;

&lt;p&gt;Of course, that check doesn&apos;t in any way prevent the coordinator from assigning partitions that the consumer is not subscribed to, but it should prevent users from getting data for unassigned partitions.&lt;/p&gt;</comment>
                            <comment id="17955675" author="JIRAUSER300183" created="Mon, 2 Jun 2025 13:21:38 +0000"  >&lt;p&gt;Hey &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kirktrue&quot; class=&quot;user-hover&quot; rel=&quot;kirktrue&quot;&gt;kirktrue&lt;/a&gt;, the important distinction here is assigned partitions vs subscription.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;The link to&#160;&lt;tt&gt;FetchCollector.fetchRecords()&lt;/tt&gt;&#160;you included is designed to catch the case where a topic/partition is unassigned&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Exactly, but won&apos;t catch anything the case where the assigned partition is not in the subscription anymore (so I expect the description is accurate, correct? &quot;won&apos;t prevent processing fetch responses for previous requests or issuing new ones for an &lt;b&gt;assigned partition&lt;/b&gt; that is &lt;b&gt;not in the subscription&lt;/b&gt; anymore&quot;). &lt;/p&gt;

&lt;p&gt;Just to make sure we&apos;re on the same page about the having a gap. I expect we need to make things consistent on the assignment path on the client for new assignments, but still to define the best way to handle it when assignment does not change and it&apos;s subscription that changes (challenge of keeping the clients simple). &lt;/p&gt;</comment>
                            <comment id="17983689" author="JIRAUSER300183" created="Thu, 19 Jun 2025 13:09:22 +0000"  >&lt;p&gt;Merged to trunk and cherry-picked to 4.1https://github.com/apache/kafka/commit/38652f763dc29ca83756bde32b97afe111c9fef9&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            20 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1w4k8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>