<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:44:11 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-2300] Error in controller log when broker tries to rejoin cluster</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-2300</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Hello Kafka folks,&lt;/p&gt;

&lt;p&gt;We are having an issue where a broker attempts to join the cluster after being restarted, but is never added to the ISR for its assigned partitions. This is a three-node cluster, and the controller is broker 2.&lt;/p&gt;

&lt;p&gt;When broker 1 starts, we see the following message in broker 2&apos;s controller.log.&lt;/p&gt;

&lt;p&gt;{{&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2015-06-23 13:57:16,535&amp;#93;&lt;/span&gt; ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;BrokerChangeListener on Controller 2&amp;#93;&lt;/span&gt;: Error while handling broker changes (kafka.controller.ReplicaStateMachine$BrokerChangeListener)&lt;br/&gt;
java.lang.IllegalStateException: Controller to broker state change requests batch is not empty while creating a new one. Some UpdateMetadata state changes Map(2 -&amp;gt; Map(&lt;span class=&quot;error&quot;&gt;&amp;#91;prod-sver-end,1&amp;#93;&lt;/span&gt; -&amp;gt; (LeaderAndIsrInfo:(Leader:-2,ISR:1,LeaderEpoch:0,ControllerEpoch:165),ReplicationFactor:1),AllReplicas:1)), 1 -&amp;gt; Map(&lt;span class=&quot;error&quot;&gt;&amp;#91;prod-sver-end,1&amp;#93;&lt;/span&gt; -&amp;gt; (LeaderAndIsrInfo:(Leader:-2,ISR:1,LeaderEpoch:0,ControllerEpoch:165),ReplicationFactor:1),AllReplicas:1)), 3 -&amp;gt; Map(&lt;span class=&quot;error&quot;&gt;&amp;#91;prod-sver-end,1&amp;#93;&lt;/span&gt; -&amp;gt; (LeaderAndIsrInfo:(Leader:-2,ISR:1,LeaderEpoch:0,ControllerEpoch:165),ReplicationFactor:1),AllReplicas:1))) might be lost &lt;br/&gt;
  at kafka.controller.ControllerBrokerRequestBatch.newBatch(ControllerChannelManager.scala:202)&lt;br/&gt;
  at kafka.controller.KafkaController.sendUpdateMetadataRequest(KafkaController.scala:974)&lt;br/&gt;
  at kafka.controller.KafkaController.onBrokerStartup(KafkaController.scala:399)&lt;br/&gt;
  at kafka.controller.ReplicaStateMachine$BrokerChangeListener$$anonfun$handleChildChange$1$$anonfun$apply$mcV$sp$1.apply$mcV$sp(ReplicaStateMachine.scala:371)&lt;br/&gt;
  at kafka.controller.ReplicaStateMachine$BrokerChangeListener$$anonfun$handleChildChange$1$$anonfun$apply$mcV$sp$1.apply(ReplicaStateMachine.scala:359)&lt;br/&gt;
  at kafka.controller.ReplicaStateMachine$BrokerChangeListener$$anonfun$handleChildChange$1$$anonfun$apply$mcV$sp$1.apply(ReplicaStateMachine.scala:359)&lt;br/&gt;
  at kafka.metrics.KafkaTimer.time(KafkaTimer.scala:33)&lt;br/&gt;
  at kafka.controller.ReplicaStateMachine$BrokerChangeListener$$anonfun$handleChildChange$1.apply$mcV$sp(ReplicaStateMachine.scala:358)&lt;br/&gt;
  at kafka.controller.ReplicaStateMachine$BrokerChangeListener$$anonfun$handleChildChange$1.apply(ReplicaStateMachine.scala:357)&lt;br/&gt;
  at kafka.controller.ReplicaStateMachine$BrokerChangeListener$$anonfun$handleChildChange$1.apply(ReplicaStateMachine.scala:357)&lt;br/&gt;
  at kafka.utils.Utils$.inLock(Utils.scala:535)&lt;br/&gt;
  at kafka.controller.ReplicaStateMachine$BrokerChangeListener.handleChildChange(ReplicaStateMachine.scala:356)&lt;br/&gt;
  at org.I0Itec.zkclient.ZkClient$7.run(ZkClient.java:568)&lt;br/&gt;
  at org.I0Itec.zkclient.ZkEventThread.run(ZkEventThread.java:71)&lt;br/&gt;
}}&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;prod-sver-end&lt;/tt&gt; is a topic we previously deleted. It seems some remnant of it persists in the controller&apos;s memory, causing an exception which interrupts the state change triggered by the broker startup.&lt;/p&gt;

&lt;p&gt;Has anyone seen something like this? Any idea what&apos;s happening here? Any information would be greatly appreciated.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
Johnny&lt;/p&gt;</description>
                <environment></environment>
        <key id="12840252">KAFKA-2300</key>
            <summary>Error in controller log when broker tries to rejoin cluster</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="fpj">Flavio Paiva Junqueira</assignee>
                                    <reporter username="jbrownrally">Johnny Brown</reporter>
                        <labels>
                    </labels>
                <created>Wed, 24 Jun 2015 16:43:59 +0000</created>
                <updated>Sat, 30 Jan 2016 00:36:39 +0000</updated>
                            <resolved>Mon, 21 Sep 2015 18:58:26 +0000</resolved>
                                    <version>0.8.2.1</version>
                                    <fixVersion>0.9.0.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="14599926" author="kharriger" created="Wed, 24 Jun 2015 18:37:36 +0000"  >&lt;p&gt;Looking at the code it appears once the controller has this invalid state new brokers are unable to join the cluster and this state cannot be cleared until the current controller is restarted.  The only code path that is calls clear on the updateMetadataRequestMap follows a call to newBatch and thus is unreachable.  If newBatch fails it probably needs to clear the invalid state.  &lt;/p&gt;

&lt;p&gt;The only way it seems to clear the new invalid state is to restart the current controller node.  Its a bit scary to restart an otherwise working node when you have another node sitting idle and currently unable to join the cluster.&lt;/p&gt;</comment>
                            <comment id="14601431" author="kharriger" created="Thu, 25 Jun 2015 15:59:46 +0000"  >&lt;p&gt;We eventually resolved the problem after hours with much less success than desired. &lt;/p&gt;

&lt;p&gt;Reviewing the code it appeared that the controller would not be able to send state to any brokers and would need to be restarted.  &lt;/p&gt;

&lt;p&gt;We were hesitant to bring this node down entirely as it was the only ISR for many partitions and since the controller was unable to send messages to other brokers we were unable to reassign any partitions.  &lt;/p&gt;

&lt;p&gt;We determined it would be possible to force a controller re-election without fully shutting down the broker by deleting the /controller node in zookeeper.  Our hope was that once a new controller was elected broker 1 would be able to rejoin the cluster and we would then be able to restart broker 2 after replication was up to date.&lt;/p&gt;

&lt;p&gt;Once we deleted the /controller node from zookeeper, election did occur as expected and broker 3 became the new leader and broker 1 was able to join the cluster.  However we started lots of unknown errors in the logs from broker 2. &lt;br/&gt;
...&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2015-06-24 18:14:23,274&amp;#93;&lt;/span&gt; ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;ReplicaFetcherThread-0-2&amp;#93;&lt;/span&gt;, Error for partition &lt;span class=&quot;error&quot;&gt;&amp;#91;prod-eclipselinkchannel,5&amp;#93;&lt;/span&gt; to broker 2:class kafka.common.UnknownException (kafka.server.ReplicaFetcherThread)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2015-06-24 18:14:23,274&amp;#93;&lt;/span&gt; ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;ReplicaFetcherThread-0-2&amp;#93;&lt;/span&gt;, Error for partition &lt;span class=&quot;error&quot;&gt;&amp;#91;birdseed-metadata-stream,18&amp;#93;&lt;/span&gt; to broker 2:class kafka.common.UnknownException (kafka.server.ReplicaFetcherThread)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2015-06-24 18:14:23,274&amp;#93;&lt;/span&gt; ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;ReplicaFetcherThread-0-2&amp;#93;&lt;/span&gt;, Error for partition &lt;span class=&quot;error&quot;&gt;&amp;#91;trial-server-start,7&amp;#93;&lt;/span&gt; to broker 2:class kafka.common.UnknownException (kafka.server.ReplicaFetcherThread)&lt;br/&gt;
... &lt;br/&gt;
We looked through the code a bit but were not easily able to identify the root cause of this exception.  More logging may have been helpful here.  We knew that broker 2 was needed to be restarted so we did that now.  Once node 2 came back online the error messages changed and the logs seemed to indicate data was lost: &lt;br/&gt;
...&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2015-06-24 18:43:51,136&amp;#93;&lt;/span&gt; ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;Replica Manager on Broker 3&amp;#93;&lt;/span&gt;: Error when processing fetch request for partition &lt;span class=&quot;error&quot;&gt;&amp;#91;feedback-events,10&amp;#93;&lt;/span&gt; offset 1757 from follower with correlation id 10539. Possible cause: Request for offset 1757 but we only have log segments in the range 0 to 0. (kafka.server.ReplicaManager)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2015-06-24 18:43:51,136&amp;#93;&lt;/span&gt; ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;Replica Manager on Broker 3&amp;#93;&lt;/span&gt;: Error when processing fetch request for partition &lt;span class=&quot;error&quot;&gt;&amp;#91;prod-beacon,10&amp;#93;&lt;/span&gt; offset 70616524 from follower with correlation id 10539. Possible cause: Request for offset 70616524 but we only have log segments in the range 0 to 1246. (kafka.server.ReplicaManager)&lt;br/&gt;
...&lt;br/&gt;
The logs were still noisy and replication did not appear to be working so we decided to restart broker 3.  Following this we saw large number of files being deleted. &lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2015-06-24 19:34:11,237&amp;#93;&lt;/span&gt; INFO Deleting index /home/kafka/shared/logs/alm-start-spans-2/00000000000420766992.index.deleted (kafka.log.OffsetIndex)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2015-06-24 19:34:11,248&amp;#93;&lt;/span&gt; INFO Deleting index /home/kafka/shared/logs/alm-spans-2/00000000000420150674.index.deleted (kafka.log.OffsetIndex)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2015-06-24 19:34:11,269&amp;#93;&lt;/span&gt; INFO Deleting index /home/kafka/shared/logs/alm-start-spans-2/00000000000426783743.index.deleted (kafka.log.OffsetIndex)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2015-06-24 19:34:11,270&amp;#93;&lt;/span&gt; INFO Deleting index /home/kafka/shared/logs/beacon-spans-11/00000000000389662179.index.deleted (kafka.log.OffsetIndex)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2015-06-24 19:34:11,275&amp;#93;&lt;/span&gt; INFO Deleting index /home/kafka/shared/logs/prod-server-start-11/00000000000415746006.index.deleted (kafka.log.OffsetIndex)&lt;/p&gt;

&lt;p&gt;After this the logs settled down and the cluster began replicating and was otherwise healthy.  We know we lost some partitions that were on broker 1. I&apos;m not entirely sure if the above indicated errors indicated that topics were partitions were lost entirely or just replicas of said partitions, but we definitely lost some partitions.  &lt;/p&gt;

&lt;p&gt;We also mirror the data into another data center where we do the actual data analytics, so I was able to compare message counts by dumping all the data and grouping by date to see that about 2/3rds of the data on at least one topic was lost.  This topic had 2 of 12 located on broker 1 which went unavailable after broker 2 (the controller) entered a bad state since it was the only ISR.  We expected we would probably lose these partitions, but this ratio suggests that much more data was lost.  Given that we mirror the data we aren&apos;t particularly concerned with historical data loss, but I thought I would mention it.  &lt;/p&gt;
</comment>
                            <comment id="14620659" author="fpj" created="Thu, 9 Jul 2015 15:25:56 +0000"  >&lt;p&gt;My assessment so far focused on the original problem that has been reported in this issue, the one that the controller is stuck because of some spurious state. From the description and the comments, ControllerBrokerRequestBatch.updateMetadataRequestMap isn&apos;t empty at the time a broker tries to re-join, which causes the processing of KafkaController.onBrokerStartup to fail because a call to ControllerBrokerRequestBatch.newBatch   (verifies that three data structures are empty, including updateMetadataRequestMap) throws an exception.&lt;/p&gt;

&lt;p&gt;From the description, the update metadata requests have -2 for the leader, which is LeaderDuringDelete. Such requests are put in the update metadata map via a call from onTopicDeletion to controller.sendUpdateMetadataRequest. Interestingly, the call to sendUpdateMetadataRequest adds to the update metadata map by calling brokerRequestBatch.addUpdateMetadataRequestForBrokers and right after invokes brokerRequestBatch.sendRequestsToBrokers. The latter is supposed to clear the update metadata map, which makes me think that there could have been an exception that interrupted the flow, causing the updateMetadataRequestMap to not be cleared. &lt;/p&gt;

&lt;p&gt;I wanted to ask if anyone has anything to add or correct in the analysis so far, and I also if &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kharriger&quot; class=&quot;user-hover&quot; rel=&quot;kharriger&quot;&gt;kharriger&lt;/a&gt; would be able to post the whole log so that I can have a look. Ultimately, it&apos;d be great to avoid having the controller unable to make progress because of some bad state.&lt;/p&gt;</comment>
                            <comment id="14621336" author="bob.cotton@gmail.com" created="Thu, 9 Jul 2015 21:44:25 +0000"  >&lt;p&gt;Which logs would you like? server, controller, state-change?&lt;/p&gt;</comment>
                            <comment id="14621344" author="fpj" created="Thu, 9 Jul 2015 21:48:09 +0000"  >&lt;p&gt;controller logs, please.&lt;/p&gt;</comment>
                            <comment id="14626247" author="fpj" created="Tue, 14 Jul 2015 11:54:01 +0000"  >&lt;p&gt;Attaching a preliminary patch in the case anyone is willing to give a hand. As I described before, one problem is that calls like sendRequest can throw an exception and if one is thrown, then the state of the ControllerBrokerRequestBatch object can be left broken (requests are not sent and newBatch calls keep throwing exceptions).&lt;/p&gt;

&lt;p&gt;The attached patch catches exceptions that calls like sendRequest might throw, cleans the state, and throws an IllegalStateException. Cleaning the state can be problematic if we don&apos;t handle the IllegalStateException appropriately. For now, at least in the call path of the topic deletion, I&apos;m suggesting that we make the controller resign, but this could be overkill. If anyone is willing to chime in, I&apos;d appreciate suggestions around the best way of dealing with such a controller in an illegal state.&lt;/p&gt;</comment>
                            <comment id="14626930" author="bob.cotton@gmail.com" created="Tue, 14 Jul 2015 19:40:14 +0000"  >&lt;p&gt;Controller logs &lt;/p&gt;</comment>
                            <comment id="14627727" author="fpj" created="Wed, 15 Jul 2015 08:45:13 +0000"  >&lt;p&gt;thank you, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bob.cotton%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;bob.cotton@gmail.com&quot;&gt;bob.cotton@gmail.com&lt;/a&gt;. however, these log files do not seem to correspond to the period in the description of the jira. the error reported above isn&apos;t in the logs and the latest timestamp in the controller log of broker 2 is &lt;span class=&quot;error&quot;&gt;&amp;#91;2015-06-04 07:38:08,066&amp;#93;&lt;/span&gt;. &lt;/p&gt;</comment>
                            <comment id="14629910" author="fpj" created="Thu, 16 Jul 2015 15:47:23 +0000"  >&lt;p&gt;I&apos;m attaching a patch to trigger the problem as I described. It essentially throw an exception before clearing the update metadata when processing a topic delete. The sequence of steps I used to trigger the problem with the repro patch are:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;Start a broker&lt;/li&gt;
	&lt;li&gt;Create a topic&lt;/li&gt;
	&lt;li&gt;Delete topic (exception thrown)&lt;/li&gt;
	&lt;li&gt;Start another broker&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;When the second broker starts, I get an exception in the controller during the execution of newBatch. The controller isn&apos;t able to recover from the illegal state without the patch I proposed previously.&lt;/p&gt;</comment>
                            <comment id="14646514" author="githubbot" created="Wed, 29 Jul 2015 18:01:06 +0000"  >&lt;p&gt;GitHub user fpj opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/102&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/102&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-2300&quot; title=&quot;Error in controller log when broker tries to rejoin cluster&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-2300&quot;&gt;&lt;del&gt;KAFKA-2300&lt;/del&gt;&lt;/a&gt;: Error in controller log when broker tries to rejoin cluster&lt;/p&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/fpj/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/fpj/kafka&lt;/a&gt; 2300&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/102.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/102.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #102&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit dbd1bf3a91c3e15ed2d14bf941c41c87b8116608&lt;br/&gt;
Author: flavio junqueira &amp;lt;fpj@apache.org&amp;gt;&lt;br/&gt;
Date:   2015-07-29T17:07:51Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-2300&quot; title=&quot;Error in controller log when broker tries to rejoin cluster&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-2300&quot;&gt;&lt;del&gt;KAFKA-2300&lt;/del&gt;&lt;/a&gt;: Error in controller log when broker tries to rejoin cluster&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="14646517" author="fpj" created="Wed, 29 Jul 2015 18:01:52 +0000"  >&lt;p&gt;Uploading a patch for trunk.&lt;/p&gt;</comment>
                            <comment id="14646522" author="fpj" created="Wed, 29 Jul 2015 18:06:11 +0000"  >&lt;p&gt;It turns out that the scenario that the scenario the test case implements is less relevant after &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-2122&quot; title=&quot;Remove controller.message.queue.size Config&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-2122&quot;&gt;&lt;del&gt;KAFKA-2122&lt;/del&gt;&lt;/a&gt; got in because the message queues in the controller are large enough. The patch might still be relevant to make sure that exceptions won&#180;t bring the controller to a useless state. &lt;/p&gt;</comment>
                            <comment id="14646794" author="guozhang" created="Wed, 29 Jul 2015 21:34:34 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=junrao&quot; class=&quot;user-hover&quot; rel=&quot;junrao&quot;&gt;junrao&lt;/a&gt; would you like to take a look?&lt;/p&gt;</comment>
                            <comment id="14694208" author="githubbot" created="Wed, 12 Aug 2015 21:30:30 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/102&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/102&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14694209" author="guozhang" created="Wed, 12 Aug 2015 21:30:31 +0000"  >&lt;p&gt;Issue resolved by pull request 102&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/kafka/pull/102&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/102&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14741101" author="fpj" created="Fri, 11 Sep 2015 16:39:43 +0000"  >&lt;p&gt;I&apos;m observing sometimes that the same controller gets elected, but it is not restarting with a clean state, which causes the test case committed in this patch to fail. We need to make sure that the controller starts with a clean state for brokerRequestBatch to fix this problem.&lt;/p&gt;</comment>
                            <comment id="14743533" author="githubbot" created="Mon, 14 Sep 2015 13:52:00 +0000"  >&lt;p&gt;GitHub user fpj opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/212&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/212&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-2300&quot; title=&quot;Error in controller log when broker tries to rejoin cluster&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-2300&quot;&gt;&lt;del&gt;KAFKA-2300&lt;/del&gt;&lt;/a&gt;: Error in controller log when broker tries to rejoin cluster&lt;/p&gt;

&lt;p&gt;    I have reopened this issue because the controller isn&apos;t cleaning up the state upon an exception and the test case was legitimately failing for me every now and then. I&apos;m proposing a change to fix this.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/fpj/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/fpj/kafka&lt;/a&gt; 2300&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/212.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/212.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #212&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit dbd1bf3a91c3e15ed2d14bf941c41c87b8116608&lt;br/&gt;
Author: flavio junqueira &amp;lt;fpj@apache.org&amp;gt;&lt;br/&gt;
Date:   2015-07-29T17:07:51Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-2300&quot; title=&quot;Error in controller log when broker tries to rejoin cluster&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-2300&quot;&gt;&lt;del&gt;KAFKA-2300&lt;/del&gt;&lt;/a&gt;: Error in controller log when broker tries to rejoin cluster&lt;/p&gt;

&lt;p&gt;commit 9b6390ae1c474b90689ff53036120b4be44a3f8f&lt;br/&gt;
Author: flavio junqueira &amp;lt;fpj@apache.org&amp;gt;&lt;br/&gt;
Date:   2015-07-29T22:36:16Z&lt;/p&gt;

&lt;p&gt;    Updated package name and removed unnecessary imports.&lt;/p&gt;

&lt;p&gt;commit f1261b15b007d08e87d0ed56f7ec3fecbeddc276&lt;br/&gt;
Author: flavio junqueira &amp;lt;fpj@apache.org&amp;gt;&lt;br/&gt;
Date:   2015-07-30T09:57:34Z&lt;/p&gt;

&lt;p&gt;    Fixed some style issues.&lt;/p&gt;

&lt;p&gt;commit aa6ec90b15ac6d0e0f9e5a58d4fed7b1909d50c2&lt;br/&gt;
Author: flavio junqueira &amp;lt;fpj@apache.org&amp;gt;&lt;br/&gt;
Date:   2015-08-12T16:37:07Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-2300&quot; title=&quot;Error in controller log when broker tries to rejoin cluster&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-2300&quot;&gt;&lt;del&gt;KAFKA-2300&lt;/del&gt;&lt;/a&gt;: Wrapped all occurences of sendRequestToBrokers with try/catch&lt;br/&gt;
    and fixed string typo.&lt;/p&gt;

&lt;p&gt;commit 7bd2edb83054a9be72dda3425930a68ea3ad494b&lt;br/&gt;
Author: flavio junqueira &amp;lt;fpj@apache.org&amp;gt;&lt;br/&gt;
Date:   2015-08-12T16:40:13Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-2300&quot; title=&quot;Error in controller log when broker tries to rejoin cluster&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-2300&quot;&gt;&lt;del&gt;KAFKA-2300&lt;/del&gt;&lt;/a&gt;: Removed unnecessary s&quot; occurrences.&lt;/p&gt;

&lt;p&gt;commit d5cfba343dac5967733c9415d4574256efdd764a&lt;br/&gt;
Author: fpj &amp;lt;fpj@apache.org&amp;gt;&lt;br/&gt;
Date:   2015-09-14T13:00:15Z&lt;/p&gt;

&lt;p&gt;    Merge remote-tracking branch &apos;upstream/trunk&apos; into 2300&lt;/p&gt;

&lt;p&gt;commit 742519349463c879d8413aee2b3f12b2ae8888a8&lt;br/&gt;
Author: fpj &amp;lt;fpj@apache.org&amp;gt;&lt;br/&gt;
Date:   2015-09-14T13:47:50Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-2300&quot; title=&quot;Error in controller log when broker tries to rejoin cluster&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-2300&quot;&gt;&lt;del&gt;KAFKA-2300&lt;/del&gt;&lt;/a&gt;: Cleaning the state of broker request batch upon an exception.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="14901193" author="githubbot" created="Mon, 21 Sep 2015 18:56:47 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/212&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/212&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12935304">KAFKA-3173</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12745314" name="KAFKA-2300-controller-logs.tar.gz" size="7354598" author="bob.cotton@gmail.com" created="Tue, 14 Jul 2015 19:40:14 +0000"/>
                            <attachment id="12745642" name="KAFKA-2300-repro.patch" size="1970" author="fpj" created="Thu, 16 Jul 2015 15:47:23 +0000"/>
                            <attachment id="12747826" name="KAFKA-2300.patch" size="17903" author="fpj" created="Wed, 29 Jul 2015 18:01:52 +0000"/>
                            <attachment id="12745241" name="KAFKA-2300.patch" size="8482" author="fpj" created="Tue, 14 Jul 2015 11:54:01 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 9 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2gfyn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>junrao</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>