<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:16:15 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-7660] Stream Metrics - Memory Analysis</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-7660</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;During the analysis of JVM memory two possible issues were shown which I would like to bring to your attention:&lt;br/&gt;
1) Duplicate strings&lt;br/&gt;
Top findings:&#160;&lt;br/&gt;
string_content=&quot;stream-processor-node-metrics&quot; count=&quot;534,277&quot;&lt;br/&gt;
string_content=&quot;processor-node-id&quot; count=&quot;148,437&quot;&lt;br/&gt;
string_content=&quot;stream-rocksdb-state-metrics&quot; count=&quot;41,832&quot;&lt;br/&gt;
string_content=&quot;punctuate-latency-avg&quot; count=&quot;29,681&quot;&#160;&lt;br/&gt;
&#160;&lt;br/&gt;
&quot;stream-processor-node-metrics&quot;&#160; seems to be used in Sensors.java as a literal and not interned.&lt;br/&gt;
&#160;&lt;br/&gt;
2) The HashMap parentSensors from&#160;org.apache.kafka.streams.processor.internals.StreamThread$StreamsMetricsThreadImpl was reported multiple times as suspicious for potentially keeping alive a lot of objects. In our case the reported size was 40-50MB each.&lt;br/&gt;
I haven&apos;t looked too deep in the code but noticed that the class Sensor.java which is used as a key in the HashMap does not implement equals or hashCode method. Not sure this is a problem though.&lt;br/&gt;
&#160;&lt;br/&gt;
The analysis was done with Dynatrace 7.0&lt;br/&gt;
We are running Confluent 5.0/Kafka2.0-cp1 (Brokers as well as Clients)&lt;br/&gt;
&#160;&lt;br/&gt;
Screenshots are attached.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13199588">KAFKA-7660</key>
            <summary>Stream Metrics - Memory Analysis</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="vvcephei">John Roesler</assignee>
                                    <reporter username="pkleindl">Patrik Kleindl</reporter>
                        <labels>
                    </labels>
                <created>Tue, 20 Nov 2018 11:44:03 +0000</created>
                <updated>Thu, 6 Dec 2018 01:18:52 +0000</updated>
                            <resolved>Fri, 30 Nov 2018 19:32:41 +0000</resolved>
                                    <version>2.0.0</version>
                                    <fixVersion>0.10.0.2</fixVersion>
                    <fixVersion>0.11.0.4</fixVersion>
                    <fixVersion>1.0.3</fixVersion>
                    <fixVersion>1.1.2</fixVersion>
                    <fixVersion>2.0.2</fixVersion>
                    <fixVersion>2.1.1</fixVersion>
                    <fixVersion>2.2.0</fixVersion>
                                    <component>metrics</component>
                    <component>streams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16693398" author="vvcephei" created="Tue, 20 Nov 2018 15:53:30 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pkleindl&quot; class=&quot;user-hover&quot; rel=&quot;pkleindl&quot;&gt;pkleindl&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;Thanks for looking at this!&lt;/p&gt;

&lt;p&gt;I don&apos;t have any hard answers right now, but I&apos;ll share some context, which might help you make an argument for whether this can be improved or not...&lt;/p&gt;

&lt;p&gt;The basic structure of metering in Kafka is that you:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;create a sensor, which is essentially just a container for metrics&lt;/li&gt;
	&lt;li&gt;add metrics to the sensor. Each metric has a name, consisting of a &quot;name&quot;, a &quot;group&quot;, and a set of tags (and a description).&lt;/li&gt;
	&lt;li&gt;keep a reference to the sensor, and call &quot;sensor.record()&quot; to make a measurement. When you do this, the sensor updates each of its metrics.&lt;/li&gt;
	&lt;li&gt;sensors can have parents, which allows you to maintain aggregated metrics. When you record a measurement on a child sensor, it propagates to the parent.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;1)&lt;/p&gt;

&lt;p&gt;The strings you listed are part of our metric names, either tags or the &quot;type&quot; (aka &quot;group&quot; in the code). See &lt;a href=&quot;https://docs.confluent.io/current/streams/monitoring.html#processor-node-metrics&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://docs.confluent.io/current/streams/monitoring.html#processor-node-metrics&lt;/a&gt;&#160;for example.&lt;/p&gt;

&lt;p&gt;You noticed it in Sensors.java, but that&apos;s just one place that some metrics are defined. Most of the Processor Node Metrics are defined in &lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/streams/src/main/java/org/apache/kafka/streams/processor/internals/ProcessorNode.java#L165&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/trunk/streams/src/main/java/org/apache/kafka/streams/processor/internals/ProcessorNode.java#L165&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Most of the time, the group name and tags are produced by string concatenation, which might be why they didn&apos;t turn up in your search. Actually, that also might be why the string isn&apos;t interned.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;2)&lt;/p&gt;

&lt;p&gt;When you start Streams, we create a &quot;whole bunch&quot; of components with accompanying metrics. In many cases, we keep a pair of a more granular child sensor and a coarser parent sensor, with the child set to &quot;debug&quot; (silent by default).&lt;/p&gt;

&lt;p&gt;Also, when you stop (aka close) Streams, we unload all the metrics (as well, when a task migrates to another instance, it unloads all its metrics on the first machine).&lt;/p&gt;

&lt;p&gt;IIRC, we only keep the reference to the child sensor, so we need &quot;parentSensors&quot; to be able to remove the parent sensor once the last child is gone, or something like that. So it should only be keeping alive objects that we actually do need to be kept alive.&lt;/p&gt;

&lt;p&gt;That said, I think I fixed a memory leak bug where we weren&apos;t actually ever removing sensors from that map. I don&apos;t recall what version it was, so that might well be what you are seeing. Maybe take a look at trunk or the 2.1 branch for comparison. (2.1 is in process of getting released)&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Like I said at the start, this is just for context. I think it would take further analysis to decide whether these objects constitute a problem for GC or not. One thought I have is that for both the metric names and the parent/child sensors, these objects are very long-lived. They&apos;re essentially permanent, so they may not be causing GC pressure. 15MB worth of &quot;stream-processor-node-metrics&quot; seems a bit wasteful with heap, though...&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;If you&apos;re interested in attempting to improve the memory footprint, we could discuss some potential directions and some experiments to try. On the other hand, if you just wanted to let us know what you observed, that&apos;s fine, too!&lt;/p&gt;</comment>
                            <comment id="16697057" author="pkleindl" created="Fri, 23 Nov 2018 12:12:11 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vvcephei&quot; class=&quot;user-hover&quot; rel=&quot;vvcephei&quot;&gt;vvcephei&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Thanks for taking a look.&lt;/p&gt;

&lt;p&gt;I mainly reported it because it didn&apos;t match my expectations and thought it would be good if someone more knowledgeable could investigate if&#160;this could be some kind of leak.&lt;/p&gt;

&lt;p&gt;The memory impact is not a problem (yet), at least not compared to the buffer caches for streams etc.&lt;/p&gt;

&lt;p&gt;I did not really find the memory leak you mentioned unless you mean &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7304&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-7304&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;If you could point me to a certain class I can see if that matches, we are already using 2.0.0-cp1 and planning to switch to 2.0.1-cp1 at least.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Regarding String duplication: I did some reading and &lt;a href=&quot;https://stackoverflow.com/questions/34937046/why-is-that-a-concatenation-using-operator-of-a-java-reference-variable-and&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://stackoverflow.com/questions/34937046/why-is-that-a-concatenation-using-operator-of-a-java-reference-variable-and&lt;/a&gt;&#160;confirms that runtime concatenation does not get interned unless explicitely done with String.intern().&lt;/p&gt;

&lt;p&gt;Maybe&#160;org.apache.kafka.streams.kstream.internals.metrics.Sensors.java needs to use some final String variables here to fix that.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Regarding the sensors in general: Does this mean that Sensors/Metrics are only created at streams startup and should remain constant after that? Then at least I can check if the number of objects stays constant.&lt;/p&gt;

&lt;p&gt;Or can Sensors etc. change dynamically? Otherwise I wouldn&apos;t understand the massive number of Strings involved.&lt;/p&gt;

&lt;p&gt;I did a small test to see how many objects are created for a single KTable, do you have any reference how many are expected? I saw about 500 Sensor instances per KTable iirc.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16697511" author="pkleindl" created="Fri, 23 Nov 2018 21:17:38 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vvcephei&quot; class=&quot;user-hover&quot; rel=&quot;vvcephei&quot;&gt;vvcephei&lt;/a&gt; I can give you a small update: I managed to reproduce a possible leak even with 2.1.0 by running a very simple test with a single KTable (12 partitions) on 2 instances and kept restarting the second instance.&#160;&lt;/p&gt;

&lt;p&gt;On every rebalance of the first instance the number of KafkaMetric, MetricName and String instances increased.&lt;/p&gt;

&lt;p&gt;Even manually triggered GCs didnt&apos; reclaim those instances and I was able to reach 10K++ live objects.&lt;/p&gt;

&lt;p&gt;The memory impact was very small but would probably be more relevant with bigger streams topologies.&#160;&lt;/p&gt;</comment>
                            <comment id="16699793" author="vvcephei" created="Tue, 27 Nov 2018 01:19:06 +0000"  >&lt;p&gt;&amp;gt;&#160;I did not really find the memory leak you mentioned&lt;/p&gt;

&lt;p&gt;Huh. I&apos;m looking at the current trunk, and it looks still present. (we add to the parentSensors map, but never remove from it). I&apos;m not sure how it got lost... I guess I&apos;ll send a quick PR with the fix I had in mind.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&amp;gt;&#160;Maybe&#160;org.apache.kafka.streams.kstream.internals.metrics.Sensors.java needs to use some final String variables here to fix that&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mjsax&quot; class=&quot;user-hover&quot; rel=&quot;mjsax&quot;&gt;mjsax&lt;/a&gt; has suggested something similar, at least for the group name, in &lt;a href=&quot;https://github.com/apache/kafka/pull/5795#discussion_r235503158&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5795#discussion_r235503158&lt;/a&gt;&#160;. I&apos;m planning to update that PR to save the group name in a constant, but I don&apos;t want to pollute the PR with extra changes for the tags (it&apos;s been dragging on already), so we can add extra constants in a separate PR. (Feel free to send a PR if you want)&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&amp;gt;&#160;Does this mean that Sensors/Metrics are only created at streams startup and should remain constant after that?&lt;/p&gt;

&lt;p&gt;Not quite, the sensors that belong to tasks (and processor nodes, state stores, etc., which are inside tasks) are created when the task is created and should remain constant until the task is closed. Tasks get closed when the task gets migrated to another instance or thread. In this case we &lt;b&gt;should&lt;/b&gt; remove the sensors and reclaim the memory. But it sounds from your repro like this is not happening. Quite possibly, this is a result of the parentSensors map keeping references to them.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&amp;gt; The memory impact was very small but would probably be more relevant with bigger streams topologies.&#160;&lt;br/&gt;
&#160;&lt;br/&gt;
Yeah, these objects are small, but we&apos;d like people to be able to run Streams for an arbitrarily long time, over which many task reassignments could occur, so I still don&apos;t like it. Plus memory leaks are gross.&lt;/p&gt;</comment>
                            <comment id="16700100" author="pkleindl" created="Tue, 27 Nov 2018 09:11:03 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vvcephei&quot; class=&quot;user-hover&quot; rel=&quot;vvcephei&quot;&gt;vvcephei&lt;/a&gt; Thanks for confirming, glad I was able to help. It all pointed into that direction.&lt;/p&gt;

&lt;p&gt;I can try out any change locally once you submit it.&lt;/p&gt;

&lt;p&gt;Maybe I&apos;ll go for the constants, are&#160;patch-files ok too? I don&apos;t have committer rights etc yet.&lt;/p&gt;

&lt;p&gt;Should I create a separate Jira issue for that?&lt;/p&gt;</comment>
                            <comment id="16701043" author="vvcephei" created="Tue, 27 Nov 2018 21:10:56 +0000"  >&lt;p&gt;Hey &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pkleindl&quot; class=&quot;user-hover&quot; rel=&quot;pkleindl&quot;&gt;pkleindl&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;I&apos;ll get you a PR to test asap.&lt;/p&gt;

&lt;p&gt;No, we don&apos;t do patch files, but you should be able to fork the repo in github and send a PR from your fork. Let me know if you&apos;re not sure how to do this.&lt;/p&gt;

&lt;p&gt;Personally, I think it&apos;s easier and better to just reference this Jira. It has all the rationale and our discussion for context.&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;

&lt;p&gt;-John&lt;/p&gt;</comment>
                            <comment id="16701096" author="githubbot" created="Tue, 27 Nov 2018 21:58:12 +0000"  >&lt;p&gt;vvcephei opened a new pull request #5953: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7660&quot; title=&quot;Stream Metrics - Memory Analysis&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7660&quot;&gt;&lt;del&gt;KAFKA-7660&lt;/del&gt;&lt;/a&gt;: fix parentSensors memory leak&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5953&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5953&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   In StreamsMetricsImpl, the parentSensors map was keeping references to Sensors after the sensors themselves had been removed.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16701100" author="vvcephei" created="Tue, 27 Nov 2018 22:00:44 +0000"  >&lt;p&gt;ok &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pkleindl&quot; class=&quot;user-hover&quot; rel=&quot;pkleindl&quot;&gt;pkleindl&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;I think that &lt;a href=&quot;https://github.com/apache/kafka/pull/5953&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5953&lt;/a&gt;&#160;should fix the memory leak. I still need to write a test for it, but I&apos;m &quot;pretty sure it&apos;s right&quot;(tm)&lt;/p&gt;

&lt;p&gt;In case you wanted to check it out and re-run your experiment.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;-John&lt;/p&gt;</comment>
                            <comment id="16701743" author="pkleindl" created="Wed, 28 Nov 2018 11:25:50 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vvcephei&quot; class=&quot;user-hover&quot; rel=&quot;vvcephei&quot;&gt;vvcephei&lt;/a&gt; Hi John&lt;/p&gt;

&lt;p&gt;I tried applying the change to my local version but the problem persists.&lt;/p&gt;

&lt;p&gt;Unless I did something wrong this block in StreamsMetrics is never even called when I do the rebalancing which seems strange.&lt;/p&gt;</comment>
                            <comment id="16702387" author="vvcephei" created="Wed, 28 Nov 2018 21:14:27 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pkleindl&quot; class=&quot;user-hover&quot; rel=&quot;pkleindl&quot;&gt;pkleindl&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;Ah, yes, now I&apos;m remembering why I probably didn&apos;t wind up making this change before. I restructured the sensor tracking so that we don&apos;t use parentSensors for any of the Streams metrics.&#160;&lt;/p&gt;

&lt;p&gt;The parentSensors map should be non-empty only if your code calls one of:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;org.apache.kafka.streams.processor.internals.metrics.StreamsMetrics#addThroughputSensor&lt;/li&gt;
	&lt;li&gt;org.apache.kafka.streams.processor.internals.metrics.StreamsMetrics#addLatencyAndThroughputSensor&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Is this the case? If so, you would need to call&#160;org.apache.kafka.streams.StreamsMetrics#removeSensor in the relevant close() method of the object that created the metrics.&lt;/p&gt;

&lt;p&gt;If this is not the case, then I&apos;m curious what the references are. I don&apos;t suppose you can cause the apparent memory leak and then grab a heap dump? I&apos;m not sure if you&apos;d want to put the whole heap dump on this forum, but maybe you could take a look in it and see what objects are being referenced from the parentSensors map.&lt;/p&gt;

&lt;p&gt;Of course, it&apos;s possible (likely?) that the apparent memory leak has a different cause, but it would be nice to rule this out, since it&apos;s on our radar.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I&apos;ll still keep my PR open, since, even if it&apos;s not affecting you, it would still be a memory leak for anyone creating sensors via those methods.&lt;/p&gt;</comment>
                            <comment id="16702422" author="pkleindl" created="Wed, 28 Nov 2018 22:04:38 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vvcephei&quot; class=&quot;user-hover&quot; rel=&quot;vvcephei&quot;&gt;vvcephei&lt;/a&gt; Well, at least that answers my next question why I couldn&apos;t find any references &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/tongue.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;And no, my code does not call any of these methods.&lt;/p&gt;

&lt;p&gt;I&apos;m attaching a heapdump from the last test.&lt;/p&gt;

&lt;p&gt;The effect can mostly be seen on the KafkaMetric and MetricName, they start around 1900 right after the start.&lt;/p&gt;

&lt;p&gt;Code is:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;MemoryTest {
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void main(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] args) {


        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; bootstrapServers = &lt;span class=&quot;code-quote&quot;&gt;&quot;broker0:9092&quot;&lt;/span&gt;;

        Properties streamsConfiguration = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Properties();
        streamsConfiguration.put(StreamsConfig.APPLICATION_ID_CONFIG, &lt;span class=&quot;code-quote&quot;&gt;&quot;test&quot;&lt;/span&gt;);
        streamsConfiguration.put(StreamsConfig.BOOTSTRAP_SERVERS_CONFIG, bootstrapServers);

        StreamsBuilder builder = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; StreamsBuilder();

        KTable&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; table = builder.table(&lt;span class=&quot;code-quote&quot;&gt;&quot;test&quot;&lt;/span&gt;);

        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; KafkaStreams streams = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; KafkaStreams(builder.build(), streamsConfiguration);

        streams.cleanUp();
        streams.start();
        &lt;span class=&quot;code-object&quot;&gt;Runtime&lt;/span&gt;.getRuntime().addShutdownHook(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;(() -&amp;gt; {
            &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                streams.close();
            } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception e) {
                &lt;span class=&quot;code-comment&quot;&gt;// ignored
&lt;/span&gt;            }
        }));
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;and if I want to run it for some time with delays for the rebalances:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;) {
    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; KafkaStreams streams = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; KafkaStreams(builder.build(), streamsConfiguration);

    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
        &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(20000L);
        streams.start();
        &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(5000L);
    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (InterruptedException e) {
        e.printStackTrace();
    } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
        streams.close();

    }

}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Topic:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
./kafka-topics --zookeeper broker0:2181 --create --topic test --partitions 10 --replication-factor 3
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16703887" author="githubbot" created="Thu, 29 Nov 2018 22:07:54 +0000"  >&lt;p&gt;vvcephei opened a new pull request #5974: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7660&quot; title=&quot;Stream Metrics - Memory Analysis&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7660&quot;&gt;&lt;del&gt;KAFKA-7660&lt;/del&gt;&lt;/a&gt;: Fix child sensor memory leak&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5974&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5974&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   A heap dump provided by Patrik Kleindl in&lt;br/&gt;
   &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7660&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-7660&lt;/a&gt;&lt;br/&gt;
   identifies the childrenSensors map in Metrics as keeping&lt;br/&gt;
   references to sensors alive after they have been removed.&lt;/p&gt;

&lt;p&gt;   This PR fixes it and adds a test to be sure.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16703893" author="vvcephei" created="Thu, 29 Nov 2018 22:13:00 +0000"  >&lt;p&gt;Aha! Thanks for the heap dump, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pkleindl&quot; class=&quot;user-hover&quot; rel=&quot;pkleindl&quot;&gt;pkleindl&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;It turns out that there&apos;s a data structure in the Metrics class that keeps a mapping from parent to children. When a child sensor is removed, we failed to remove it from this data structure, keeping the references to every child the parent has ever had, until the parent is removed.&lt;/p&gt;

&lt;p&gt;I&apos;ve submitted &lt;a href=&quot;https://github.com/apache/kafka/pull/5974&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5974&lt;/a&gt;&#160;to fix it. Feel free to review it / comment if you have a github account.&lt;/p&gt;

&lt;p&gt;Thanks again in you help with this issue!&lt;/p&gt;

&lt;p&gt;-John&lt;/p&gt;</comment>
                            <comment id="16704001" author="githubbot" created="Thu, 29 Nov 2018 23:09:53 +0000"  >&lt;p&gt;guozhangwang closed pull request #5953: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7660&quot; title=&quot;Stream Metrics - Memory Analysis&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7660&quot;&gt;&lt;del&gt;KAFKA-7660&lt;/del&gt;&lt;/a&gt;: fix parentSensors memory leak&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5953&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5953&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/streams/src/main/java/org/apache/kafka/streams/processor/internals/ProcessorNode.java b/streams/src/main/java/org/apache/kafka/streams/processor/internals/ProcessorNode.java&lt;br/&gt;
index 8483791e2e7..ec4f8e5e5db 100644&lt;br/&gt;
&amp;#8212; a/streams/src/main/java/org/apache/kafka/streams/processor/internals/ProcessorNode.java&lt;br/&gt;
+++ b/streams/src/main/java/org/apache/kafka/streams/processor/internals/ProcessorNode.java&lt;br/&gt;
@@ -234,9 +234,11 @@ private static Sensor createTaskAndNodeLatencyAndThroughputSensors(final String&lt;br/&gt;
             final Sensor parent = metrics.taskLevelSensor(taskName, operation, Sensor.RecordingLevel.DEBUG);&lt;br/&gt;
             addAvgMaxLatency(parent, PROCESSOR_NODE_METRICS_GROUP, taskTags, operation);&lt;br/&gt;
             addInvocationRateAndCount(parent, PROCESSOR_NODE_METRICS_GROUP, taskTags, operation);&lt;br/&gt;
+&lt;br/&gt;
             final Sensor sensor = metrics.nodeLevelSensor(taskName, processorNodeName, operation, Sensor.RecordingLevel.DEBUG, parent);&lt;br/&gt;
             addAvgMaxLatency(sensor, PROCESSOR_NODE_METRICS_GROUP, nodeTags, operation);&lt;br/&gt;
             addInvocationRateAndCount(sensor, PROCESSOR_NODE_METRICS_GROUP, nodeTags, operation);&lt;br/&gt;
+&lt;br/&gt;
             return sensor;&lt;br/&gt;
         }&lt;br/&gt;
     }&lt;br/&gt;
diff --git a/streams/src/main/java/org/apache/kafka/streams/processor/internals/metrics/StreamsMetricsImpl.java b/streams/src/main/java/org/apache/kafka/streams/processor/internals/metrics/StreamsMetricsImpl.java&lt;br/&gt;
index 8ec2711e764..dd6cc4a2185 100644&lt;br/&gt;
&amp;#8212; a/streams/src/main/java/org/apache/kafka/streams/processor/internals/metrics/StreamsMetricsImpl.java&lt;br/&gt;
+++ b/streams/src/main/java/org/apache/kafka/streams/processor/internals/metrics/StreamsMetricsImpl.java&lt;br/&gt;
@@ -115,11 +115,9 @@ public final Sensor taskLevelSensor(final String taskName,&lt;br/&gt;
     public final void removeAllTaskLevelSensors(final String taskName) {&lt;br/&gt;
         final String key = taskSensorPrefix(taskName);&lt;br/&gt;
         synchronized (taskLevelSensors) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (taskLevelSensors.containsKey(key)) {&lt;/li&gt;
	&lt;li&gt;while (!taskLevelSensors.get(key).isEmpty()) 
{
-                    metrics.removeSensor(taskLevelSensors.get(key).pop());
-                }&lt;/li&gt;
	&lt;li&gt;taskLevelSensors.remove(key);&lt;br/&gt;
+            final Deque&amp;lt;String&amp;gt; sensors = taskLevelSensors.remove(key);&lt;br/&gt;
+            while (sensors != null &amp;amp;&amp;amp; !sensors.isEmpty()) 
{
+                metrics.removeSensor(sensors.pop());
             }&lt;br/&gt;
         }&lt;br/&gt;
     }&lt;br/&gt;
@@ -152,10 +150,9 @@ public Sensor nodeLevelSensor(final String taskName,&lt;br/&gt;
     public final void removeAllNodeLevelSensors(final String taskName, final String processorNodeName) {&lt;br/&gt;
         final String key = nodeSensorPrefix(taskName, processorNodeName);&lt;br/&gt;
         synchronized (nodeLevelSensors) {&lt;br/&gt;
-            if (nodeLevelSensors.containsKey(key)) {&lt;br/&gt;
-                while (!nodeLevelSensors.get(key).isEmpty()) {
-                    metrics.removeSensor(nodeLevelSensors.get(key).pop());
-                }&lt;br/&gt;
+            final Deque&amp;lt;String&amp;gt; sensors = nodeLevelSensors.remove(key);&lt;br/&gt;
+            while (sensors != null &amp;amp;&amp;amp; !sensors.isEmpty()) {+                metrics.removeSensor(sensors.pop());             }
&lt;p&gt;         }&lt;br/&gt;
     }&lt;br/&gt;
@@ -188,11 +185,9 @@ public final Sensor cacheLevelSensor(final String taskName,&lt;br/&gt;
     public final void removeAllCacheLevelSensors(final String taskName, final String cacheName) {&lt;br/&gt;
         final String key = cacheSensorPrefix(taskName, cacheName);&lt;br/&gt;
         synchronized (cacheLevelSensors) {&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;if (cacheLevelSensors.containsKey(key)) {&lt;/li&gt;
	&lt;li&gt;while (!cacheLevelSensors.get(key).isEmpty()) 
{
-                    metrics.removeSensor(cacheLevelSensors.get(key).pop());
-                }&lt;/li&gt;
	&lt;li&gt;cacheLevelSensors.remove(key);&lt;br/&gt;
+            final Deque&amp;lt;String&amp;gt; strings = cacheLevelSensors.remove(key);&lt;br/&gt;
+            while (strings != null &amp;amp;&amp;amp; !strings.isEmpty()) 
{
+                metrics.removeSensor(strings.pop());
             }
&lt;p&gt;         }&lt;br/&gt;
     }&lt;br/&gt;
@@ -225,11 +220,9 @@ public final Sensor storeLevelSensor(final String taskName,&lt;br/&gt;
     public final void removeAllStoreLevelSensors(final String taskName, final String storeName) {&lt;br/&gt;
         final String key = storeSensorPrefix(taskName, storeName);&lt;br/&gt;
         synchronized (storeLevelSensors) {&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;if (storeLevelSensors.containsKey(key)) {&lt;/li&gt;
	&lt;li&gt;while (!storeLevelSensors.get(key).isEmpty()) 
{
-                    metrics.removeSensor(storeLevelSensors.get(key).pop());
-                }&lt;/li&gt;
	&lt;li&gt;storeLevelSensors.remove(key);&lt;br/&gt;
+            final Deque&amp;lt;String&amp;gt; sensors = storeLevelSensors.remove(key);&lt;br/&gt;
+            while (sensors != null &amp;amp;&amp;amp; !sensors.isEmpty()) 
{
+                metrics.removeSensor(sensors.pop());
             }
&lt;p&gt;         }&lt;br/&gt;
     }&lt;br/&gt;
@@ -413,12 +406,19 @@ public void removeSensor(final Sensor sensor) {&lt;br/&gt;
         Objects.requireNonNull(sensor, &quot;Sensor is null&quot;);&lt;br/&gt;
         metrics.removeSensor(sensor.name());&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final Sensor parent = parentSensors.get(sensor);&lt;br/&gt;
+        final Sensor parent = parentSensors.remove(sensor);&lt;br/&gt;
         if (parent != null) 
{
             metrics.removeSensor(parent.name());
         }
&lt;p&gt;     }&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;+    /**&lt;br/&gt;
+     * Visible for testing&lt;br/&gt;
+     */&lt;br/&gt;
+    Map&amp;lt;Sensor, Sensor&amp;gt; parentSensors() &lt;/p&gt;
{
+        return Collections.unmodifiableMap(parentSensors);
+    }
&lt;p&gt;+&lt;br/&gt;
     private static String groupNameFromScope(final String scopeName) &lt;/p&gt;
{
         return &quot;stream-&quot; + scopeName + &quot;-metrics&quot;;
     }
&lt;p&gt;diff --git a/streams/src/test/java/org/apache/kafka/streams/processor/internals/StreamsMetricsImplTest.java b/streams/src/test/java/org/apache/kafka/streams/processor/internals/metrics/StreamsMetricsImplTest.java&lt;br/&gt;
similarity index 59%&lt;br/&gt;
rename from streams/src/test/java/org/apache/kafka/streams/processor/internals/StreamsMetricsImplTest.java&lt;br/&gt;
rename to streams/src/test/java/org/apache/kafka/streams/processor/internals/metrics/StreamsMetricsImplTest.java&lt;br/&gt;
index 7ce27b4b6d6..cadfdb0cef1 100644&lt;br/&gt;
&amp;#8212; a/streams/src/test/java/org/apache/kafka/streams/processor/internals/StreamsMetricsImplTest.java&lt;br/&gt;
+++ b/streams/src/test/java/org/apache/kafka/streams/processor/internals/metrics/StreamsMetricsImplTest.java&lt;br/&gt;
@@ -14,7 +14,7 @@&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;See the License for the specific language governing permissions and&lt;/li&gt;
	&lt;li&gt;limitations under the License.&lt;br/&gt;
  */&lt;br/&gt;
-package org.apache.kafka.streams.processor.internals;&lt;br/&gt;
+package org.apache.kafka.streams.processor.internals.metrics;&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt; import org.apache.kafka.common.MetricName;&lt;br/&gt;
@@ -23,12 +23,21 @@&lt;br/&gt;
 import org.apache.kafka.common.metrics.Metrics;&lt;br/&gt;
 import org.apache.kafka.common.metrics.Sensor;&lt;br/&gt;
 import org.apache.kafka.common.utils.MockTime;&lt;br/&gt;
-import org.apache.kafka.streams.processor.internals.metrics.StreamsMetricsImpl;&lt;br/&gt;
 import org.junit.Test;&lt;/p&gt;

&lt;p&gt;+import java.util.Collections;&lt;br/&gt;
+import java.util.Map;&lt;br/&gt;
 import java.util.concurrent.TimeUnit;&lt;/p&gt;

&lt;p&gt;+import static org.apache.kafka.common.utils.Utils.mkEntry;&lt;br/&gt;
+import static org.apache.kafka.common.utils.Utils.mkMap;&lt;br/&gt;
+import static org.apache.kafka.streams.processor.internals.metrics.StreamsMetricsImpl.PROCESSOR_NODE_METRICS_GROUP;&lt;br/&gt;
+import static org.apache.kafka.streams.processor.internals.metrics.StreamsMetricsImpl.addAvgMaxLatency;&lt;br/&gt;
+import static org.apache.kafka.streams.processor.internals.metrics.StreamsMetricsImpl.addInvocationRateAndCount;&lt;br/&gt;
+import static org.hamcrest.Matchers.equalTo;&lt;br/&gt;
+import static org.hamcrest.Matchers.greaterThan;&lt;br/&gt;
 import static org.junit.Assert.assertEquals;&lt;br/&gt;
+import static org.junit.Assert.assertThat;&lt;/p&gt;

&lt;p&gt; public class StreamsMetricsImplTest {&lt;/p&gt;

&lt;p&gt;@@ -62,6 +71,60 @@ public void testRemoveSensor() &lt;/p&gt;
{
 
         final Sensor sensor3 = streamsMetrics.addThroughputSensor(scope, entity, operation, Sensor.RecordingLevel.DEBUG);
         streamsMetrics.removeSensor(sensor3);
+
+        assertEquals(Collections.emptyMap(), streamsMetrics.parentSensors());
+    }
&lt;p&gt;+&lt;br/&gt;
+    @Test&lt;br/&gt;
+    public void testMutiLevelSensorRemoval() {&lt;br/&gt;
+        final Metrics registry = new Metrics();&lt;br/&gt;
+        final StreamsMetricsImpl metrics = new StreamsMetricsImpl(registry, &quot;&quot;);&lt;br/&gt;
+        for (final MetricName defaultMetric : registry.metrics().keySet()) &lt;/p&gt;
{
+            registry.removeMetric(defaultMetric);
+        }
&lt;p&gt;+&lt;br/&gt;
+        final String taskName = &quot;taskName&quot;;&lt;br/&gt;
+        final String operation = &quot;operation&quot;;&lt;br/&gt;
+        final Map&amp;lt;String, String&amp;gt; taskTags = mkMap(mkEntry(&quot;tkey&quot;, &quot;value&quot;));&lt;br/&gt;
+&lt;br/&gt;
+        final String processorNodeName = &quot;processorNodeName&quot;;&lt;br/&gt;
+        final Map&amp;lt;String, String&amp;gt; nodeTags = mkMap(mkEntry(&quot;nkey&quot;, &quot;value&quot;));&lt;br/&gt;
+&lt;br/&gt;
+        final Sensor parent1 = metrics.taskLevelSensor(taskName, operation, Sensor.RecordingLevel.DEBUG);&lt;br/&gt;
+        addAvgMaxLatency(parent1, PROCESSOR_NODE_METRICS_GROUP, taskTags, operation);&lt;br/&gt;
+        addInvocationRateAndCount(parent1, PROCESSOR_NODE_METRICS_GROUP, taskTags, operation);&lt;br/&gt;
+&lt;br/&gt;
+        final int numberOfTaskMetrics = registry.metrics().size();&lt;br/&gt;
+&lt;br/&gt;
+        final Sensor sensor1 = metrics.nodeLevelSensor(taskName, processorNodeName, operation, Sensor.RecordingLevel.DEBUG, parent1);&lt;br/&gt;
+        addAvgMaxLatency(sensor1, PROCESSOR_NODE_METRICS_GROUP, nodeTags, operation);&lt;br/&gt;
+        addInvocationRateAndCount(sensor1, PROCESSOR_NODE_METRICS_GROUP, nodeTags, operation);&lt;br/&gt;
+&lt;br/&gt;
+        assertThat(registry.metrics().size(), greaterThan(numberOfTaskMetrics));&lt;br/&gt;
+&lt;br/&gt;
+        metrics.removeAllNodeLevelSensors(taskName, processorNodeName);&lt;br/&gt;
+&lt;br/&gt;
+        assertThat(registry.metrics().size(), equalTo(numberOfTaskMetrics));&lt;br/&gt;
+&lt;br/&gt;
+        final Sensor parent2 = metrics.taskLevelSensor(taskName, operation, Sensor.RecordingLevel.DEBUG);&lt;br/&gt;
+        addAvgMaxLatency(parent2, PROCESSOR_NODE_METRICS_GROUP, taskTags, operation);&lt;br/&gt;
+        addInvocationRateAndCount(parent2, PROCESSOR_NODE_METRICS_GROUP, taskTags, operation);&lt;br/&gt;
+&lt;br/&gt;
+        assertThat(registry.metrics().size(), equalTo(numberOfTaskMetrics));&lt;br/&gt;
+&lt;br/&gt;
+        final Sensor sensor2 = metrics.nodeLevelSensor(taskName, processorNodeName, operation, Sensor.RecordingLevel.DEBUG, parent2);&lt;br/&gt;
+        addAvgMaxLatency(sensor2, PROCESSOR_NODE_METRICS_GROUP, nodeTags, operation);&lt;br/&gt;
+        addInvocationRateAndCount(sensor2, PROCESSOR_NODE_METRICS_GROUP, nodeTags, operation);&lt;br/&gt;
+&lt;br/&gt;
+        assertThat(registry.metrics().size(), greaterThan(numberOfTaskMetrics));&lt;br/&gt;
+&lt;br/&gt;
+        metrics.removeAllNodeLevelSensors(taskName, processorNodeName);&lt;br/&gt;
+&lt;br/&gt;
+        assertThat(registry.metrics().size(), equalTo(numberOfTaskMetrics));&lt;br/&gt;
+&lt;br/&gt;
+        metrics.removeAllTaskLevelSensors(taskName);&lt;br/&gt;
+&lt;br/&gt;
+        assertThat(registry.metrics().size(), equalTo(0));&lt;br/&gt;
     }&lt;/p&gt;

&lt;p&gt;     @Test&lt;br/&gt;
@@ -115,21 +178,21 @@ public void testTotalMetricDoesntDecrease() {&lt;br/&gt;
         final String operation = &quot;op&quot;;&lt;/p&gt;

&lt;p&gt;         final Sensor sensor = streamsMetrics.addLatencyAndThroughputSensor(&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;scope,&lt;/li&gt;
	&lt;li&gt;entity,&lt;/li&gt;
	&lt;li&gt;operation,&lt;/li&gt;
	&lt;li&gt;Sensor.RecordingLevel.INFO&lt;br/&gt;
+            scope,&lt;br/&gt;
+            entity,&lt;br/&gt;
+            operation,&lt;br/&gt;
+            Sensor.RecordingLevel.INFO&lt;br/&gt;
         );&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         final double latency = 100.0;&lt;br/&gt;
         final MetricName totalMetricName = metrics.metricName(&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&quot;op-total&quot;,&lt;/li&gt;
	&lt;li&gt;&quot;stream-scope-metrics&quot;,&lt;/li&gt;
	&lt;li&gt;&quot;&quot;,&lt;/li&gt;
	&lt;li&gt;&quot;client-id&quot;,&lt;/li&gt;
	&lt;li&gt;&quot;&quot;,&lt;/li&gt;
	&lt;li&gt;&quot;scope-id&quot;,&lt;/li&gt;
	&lt;li&gt;&quot;entity&quot;&lt;br/&gt;
+            &quot;op-total&quot;,&lt;br/&gt;
+            &quot;stream-scope-metrics&quot;,&lt;br/&gt;
+            &quot;&quot;,&lt;br/&gt;
+            &quot;client-id&quot;,&lt;br/&gt;
+            &quot;&quot;,&lt;br/&gt;
+            &quot;scope-id&quot;,&lt;br/&gt;
+            &quot;entity&quot;&lt;br/&gt;
         );&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         final KafkaMetric totalMetric = metrics.metric(totalMetricName);&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16704243" author="githubbot" created="Fri, 30 Nov 2018 04:10:26 +0000"  >&lt;p&gt;guozhangwang closed pull request #5974: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7660&quot; title=&quot;Stream Metrics - Memory Analysis&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7660&quot;&gt;&lt;del&gt;KAFKA-7660&lt;/del&gt;&lt;/a&gt;: Fix child sensor memory leak&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5974&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5974&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/clients/src/main/java/org/apache/kafka/common/metrics/Metrics.java b/clients/src/main/java/org/apache/kafka/common/metrics/Metrics.java&lt;br/&gt;
index a6da9f90397..9e2b6f18f0c 100644&lt;br/&gt;
&amp;#8212; a/clients/src/main/java/org/apache/kafka/common/metrics/Metrics.java&lt;br/&gt;
+++ b/clients/src/main/java/org/apache/kafka/common/metrics/Metrics.java&lt;br/&gt;
@@ -41,6 +41,8 @@&lt;br/&gt;
 import java.util.concurrent.ThreadFactory;&lt;br/&gt;
 import java.util.concurrent.TimeUnit;&lt;/p&gt;

&lt;p&gt;+import static java.util.Collections.emptyList;&lt;br/&gt;
+&lt;br/&gt;
 /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;A registry of sensors and metrics.&lt;/li&gt;
	&lt;li&gt;&amp;lt;p&amp;gt;&lt;br/&gt;
@@ -446,6 +448,9 @@ public void removeSensor(String name) {&lt;br/&gt;
                             removeMetric(metric.metricName());&lt;br/&gt;
                         log.debug(&quot;Removed sensor with name {}&quot;, name);&lt;br/&gt;
                         childSensors = childrenSensors.remove(sensor);&lt;br/&gt;
+                        for (final Sensor parent : sensor.parents()) 
{
+                            childrenSensors.getOrDefault(parent, emptyList()).remove(sensor);
+                        }
&lt;p&gt;                     }&lt;br/&gt;
                 }&lt;br/&gt;
             }&lt;br/&gt;
diff --git a/clients/src/main/java/org/apache/kafka/common/metrics/Sensor.java b/clients/src/main/java/org/apache/kafka/common/metrics/Sensor.java&lt;br/&gt;
index ccbe8aad9cd..1af9419bc75 100644&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/clients/src/main/java/org/apache/kafka/common/metrics/Sensor.java&lt;br/&gt;
+++ b/clients/src/main/java/org/apache/kafka/common/metrics/Sensor.java&lt;br/&gt;
@@ -22,7 +22,6 @@&lt;br/&gt;
 import org.apache.kafka.common.utils.Utils;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; import java.util.ArrayList;&lt;br/&gt;
-import java.util.Collections;&lt;br/&gt;
 import java.util.HashSet;&lt;br/&gt;
 import java.util.LinkedHashMap;&lt;br/&gt;
 import java.util.LinkedList;&lt;br/&gt;
@@ -32,6 +31,9 @@&lt;br/&gt;
 import java.util.Set;&lt;br/&gt;
 import java.util.concurrent.TimeUnit;&lt;/p&gt;

&lt;p&gt;+import static java.util.Arrays.asList;&lt;br/&gt;
+import static java.util.Collections.unmodifiableList;&lt;br/&gt;
+&lt;br/&gt;
 /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;A sensor applies a continuous sequence of numerical values to a set of associated metrics. For example a sensor on&lt;/li&gt;
	&lt;li&gt;message size would record a sequence of message sizes using the 
{@link #record(double)}
&lt;p&gt; api and would maintain a set&lt;br/&gt;
@@ -133,6 +135,10 @@ public String name() &lt;/p&gt;
{
         return this.name;
     }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;+    List&amp;lt;Sensor&amp;gt; parents() &lt;/p&gt;
{
+        return unmodifiableList(asList(parents));
+    }
&lt;p&gt;+&lt;br/&gt;
     /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Record an occurrence, this is just short-hand for 
{@link #record(double) record(1.0)}
&lt;p&gt;      */&lt;br/&gt;
@@ -291,7 +297,7 @@ public boolean hasExpired() {&lt;br/&gt;
     }&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     synchronized List&amp;lt;KafkaMetric&amp;gt; metrics() &lt;/p&gt;
{
-        return Collections.unmodifiableList(new LinkedList&amp;lt;&amp;gt;(this.metrics.values()));
+        return unmodifiableList(new LinkedList&amp;lt;&amp;gt;(this.metrics.values()));
     }

&lt;p&gt;     /**&lt;br/&gt;
diff --git a/clients/src/test/java/org/apache/kafka/common/metrics/MetricsTest.java b/clients/src/test/java/org/apache/kafka/common/metrics/MetricsTest.java&lt;br/&gt;
index 3184aeb8260..98b468afc3d 100644&lt;br/&gt;
&amp;#8212; a/clients/src/test/java/org/apache/kafka/common/metrics/MetricsTest.java&lt;br/&gt;
+++ b/clients/src/test/java/org/apache/kafka/common/metrics/MetricsTest.java&lt;br/&gt;
@@ -16,6 +16,8 @@&lt;br/&gt;
  */&lt;br/&gt;
 package org.apache.kafka.common.metrics;&lt;/p&gt;

&lt;p&gt;+import static java.util.Collections.emptyList;&lt;br/&gt;
+import static java.util.Collections.singletonList;&lt;br/&gt;
 import static org.junit.Assert.assertEquals;&lt;br/&gt;
 import static org.junit.Assert.assertFalse;&lt;br/&gt;
 import static org.junit.Assert.assertNotNull;&lt;br/&gt;
@@ -202,6 +204,20 @@ public void testBadSensorHierarchy() &lt;/p&gt;
{
         metrics.sensor(&quot;gc&quot;, c1, c2); // should fail
     }

&lt;p&gt;+    @Test&lt;br/&gt;
+    public void testRemoveChildSensor() &lt;/p&gt;
{
+        final Metrics metrics = new Metrics();
+
+        final Sensor parent = metrics.sensor(&quot;parent&quot;);
+        final Sensor child = metrics.sensor(&quot;child&quot;, parent);
+
+        assertEquals(singletonList(child), metrics.childrenSensors().get(parent));
+
+        metrics.removeSensor(&quot;child&quot;);
+
+        assertEquals(emptyList(), metrics.childrenSensors().get(parent));
+    }
&lt;p&gt;+&lt;br/&gt;
     @Test&lt;br/&gt;
     public void testRemoveSensor() {&lt;br/&gt;
         int size = metrics.metrics().size();&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16704255" author="guozhang" created="Fri, 30 Nov 2018 04:11:41 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pkleindl&quot; class=&quot;user-hover&quot; rel=&quot;pkleindl&quot;&gt;pkleindl&lt;/a&gt; I&apos;ve merged in both PRs from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vvcephei&quot; class=&quot;user-hover&quot; rel=&quot;vvcephei&quot;&gt;vvcephei&lt;/a&gt; to trunk, could you try it out and see if it resolves your issue.&lt;/p&gt;</comment>
                            <comment id="16704395" author="pkleindl" created="Fri, 30 Nov 2018 08:15:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vvcephei&quot; class=&quot;user-hover&quot; rel=&quot;vvcephei&quot;&gt;vvcephei&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; I almost reported that it didn&apos;t work before noticing that this had changed kafka-clients too.&lt;/p&gt;

&lt;p&gt;Just reran the test for 10 minutes and the number of Sensor, KafkaMetric and MetricName instances now seems stable (eg. GC cleans them up)&lt;/p&gt;

&lt;p&gt;Thumbs up &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16704399" author="pkleindl" created="Fri, 30 Nov 2018 08:17:55 +0000"  >&lt;p&gt;Last question, who should &quot;resolve&quot; the Jira issue? I guess that is done by the person who fixed it to supply fixVersion etc?&lt;/p&gt;</comment>
                            <comment id="16705199" author="guozhang" created="Fri, 30 Nov 2018 19:32:16 +0000"  >&lt;p&gt;Glad it works. I can help resolve the ticket, since the patch is merged into trunk the fix version would be 2.2.0.&lt;/p&gt;</comment>
                            <comment id="16705256" author="vvcephei" created="Fri, 30 Nov 2018 20:43:45 +0000"  >&lt;p&gt;Hey &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pkleindl&quot; class=&quot;user-hover&quot; rel=&quot;pkleindl&quot;&gt;pkleindl&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;If you have a chance to repeat the original memory analysis, I&apos;m wondering if the duplicate strings are still listed as an issue, or if they were a consequence somehow of the leaked references.&#160;&lt;/p&gt;

&lt;p&gt;Thanks again for identifying this, diagnosing it, and verifying it. It&apos;s really nice to get these fixes in.&lt;/p&gt;

&lt;p&gt;-John&lt;/p&gt;</comment>
                            <comment id="16705312" author="githubbot" created="Fri, 30 Nov 2018 21:49:57 +0000"  >&lt;p&gt;vvcephei opened a new pull request #5979: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7660&quot; title=&quot;Stream Metrics - Memory Analysis&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7660&quot;&gt;&lt;del&gt;KAFKA-7660&lt;/del&gt;&lt;/a&gt;: fix streams and Metrics memory leaks.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5979&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5979&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Backport two memory-leak fixes (#5974 and #5953)&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16705417" author="githubbot" created="Fri, 30 Nov 2018 23:26:28 +0000"  >&lt;p&gt;vvcephei opened a new pull request #5982: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7660&quot; title=&quot;Stream Metrics - Memory Analysis&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7660&quot;&gt;&lt;del&gt;KAFKA-7660&lt;/del&gt;&lt;/a&gt;: fix streams and Metrics memory leaks&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5982&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5982&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Backport two memory-leak fixes (#5974 and #5953) (see also 2.1: #5979, 2.0: #5980, 1.1: #5981  )&lt;/p&gt;

&lt;p&gt;   It looks like we already had the parentSensors fix in 1.0 and lost it in 2.0. The change in&lt;br/&gt;
   this PR just tidies it up a little for consistency with later branches.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16705422" author="githubbot" created="Fri, 30 Nov 2018 23:28:04 +0000"  >&lt;p&gt;vvcephei opened a new pull request #5983: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7660&quot; title=&quot;Stream Metrics - Memory Analysis&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7660&quot;&gt;&lt;del&gt;KAFKA-7660&lt;/del&gt;&lt;/a&gt;: fix streams and Metrics memory leaks&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5983&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5983&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Backport two memory-leak fixes (#5974 and #5953) (see also 2.1: #5979, 2.0: #5980, 1.1: #5981, 1.0: #5982  )&lt;/p&gt;

&lt;p&gt;   It looks like we already had the parentSensors fix in 1.0 and lost it in 2.0. The change in&lt;br/&gt;
   this PR just tidies it up a little for consistency with later branches.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16705436" author="githubbot" created="Fri, 30 Nov 2018 23:39:34 +0000"  >&lt;p&gt;vvcephei opened a new pull request #5984: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7660&quot; title=&quot;Stream Metrics - Memory Analysis&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7660&quot;&gt;&lt;del&gt;KAFKA-7660&lt;/del&gt;&lt;/a&gt;: fix streams and Metrics memory leaks&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5984&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5984&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Backport two memory-leak fixes (#5974 and #5953) (see also 2.1: #5979, 2.0: #5980, 1.1: #5981, 1.0: #5982, 0.11: #5983  )&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16708639" author="pkleindl" created="Tue, 4 Dec 2018 12:39:29 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vvcephei&quot; class=&quot;user-hover&quot; rel=&quot;vvcephei&quot;&gt;vvcephei&lt;/a&gt; Will do so when we do the next upgrade cycle, I will let the customer know to request this in a Confluent Platform version.&lt;/p&gt;</comment>
                            <comment id="16708953" author="vvcephei" created="Tue, 4 Dec 2018 16:25:21 +0000"  >&lt;p&gt;Sounds good! We&apos;ll go ahead and leave this ticket &quot;resolved&quot;, then, and possibly open a new one in response to a future analysis.&lt;/p&gt;

&lt;p&gt;I&apos;ve got PRs open to all the branches, so (once they&apos;re merged), they&apos;ll be included in the next AK release of whichever branch, and also in the corresponding CP release.&lt;/p&gt;

&lt;p&gt;Having them request a CP release would possibly speed up this process.&lt;/p&gt;</comment>
                            <comment id="16709296" author="githubbot" created="Tue, 4 Dec 2018 21:45:12 +0000"  >&lt;p&gt;mjsax closed pull request #5979: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7660&quot; title=&quot;Stream Metrics - Memory Analysis&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7660&quot;&gt;&lt;del&gt;KAFKA-7660&lt;/del&gt;&lt;/a&gt;: fix streams and Metrics memory leaks&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5979&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5979&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/clients/src/main/java/org/apache/kafka/common/metrics/Metrics.java b/clients/src/main/java/org/apache/kafka/common/metrics/Metrics.java&lt;br/&gt;
index a6da9f90397..9e2b6f18f0c 100644&lt;br/&gt;
&amp;#8212; a/clients/src/main/java/org/apache/kafka/common/metrics/Metrics.java&lt;br/&gt;
+++ b/clients/src/main/java/org/apache/kafka/common/metrics/Metrics.java&lt;br/&gt;
@@ -41,6 +41,8 @@&lt;br/&gt;
 import java.util.concurrent.ThreadFactory;&lt;br/&gt;
 import java.util.concurrent.TimeUnit;&lt;/p&gt;

&lt;p&gt;+import static java.util.Collections.emptyList;&lt;br/&gt;
+&lt;br/&gt;
 /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;A registry of sensors and metrics.&lt;/li&gt;
	&lt;li&gt;&amp;lt;p&amp;gt;&lt;br/&gt;
@@ -446,6 +448,9 @@ public void removeSensor(String name) {&lt;br/&gt;
                             removeMetric(metric.metricName());&lt;br/&gt;
                         log.debug(&quot;Removed sensor with name {}&quot;, name);&lt;br/&gt;
                         childSensors = childrenSensors.remove(sensor);&lt;br/&gt;
+                        for (final Sensor parent : sensor.parents()) 
{
+                            childrenSensors.getOrDefault(parent, emptyList()).remove(sensor);
+                        }
&lt;p&gt;                     }&lt;br/&gt;
                 }&lt;br/&gt;
             }&lt;br/&gt;
diff --git a/clients/src/main/java/org/apache/kafka/common/metrics/Sensor.java b/clients/src/main/java/org/apache/kafka/common/metrics/Sensor.java&lt;br/&gt;
index ccbe8aad9cd..1af9419bc75 100644&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/clients/src/main/java/org/apache/kafka/common/metrics/Sensor.java&lt;br/&gt;
+++ b/clients/src/main/java/org/apache/kafka/common/metrics/Sensor.java&lt;br/&gt;
@@ -22,7 +22,6 @@&lt;br/&gt;
 import org.apache.kafka.common.utils.Utils;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; import java.util.ArrayList;&lt;br/&gt;
-import java.util.Collections;&lt;br/&gt;
 import java.util.HashSet;&lt;br/&gt;
 import java.util.LinkedHashMap;&lt;br/&gt;
 import java.util.LinkedList;&lt;br/&gt;
@@ -32,6 +31,9 @@&lt;br/&gt;
 import java.util.Set;&lt;br/&gt;
 import java.util.concurrent.TimeUnit;&lt;/p&gt;

&lt;p&gt;+import static java.util.Arrays.asList;&lt;br/&gt;
+import static java.util.Collections.unmodifiableList;&lt;br/&gt;
+&lt;br/&gt;
 /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;A sensor applies a continuous sequence of numerical values to a set of associated metrics. For example a sensor on&lt;/li&gt;
	&lt;li&gt;message size would record a sequence of message sizes using the 
{@link #record(double)}
&lt;p&gt; api and would maintain a set&lt;br/&gt;
@@ -133,6 +135,10 @@ public String name() &lt;/p&gt;
{
         return this.name;
     }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;+    List&amp;lt;Sensor&amp;gt; parents() &lt;/p&gt;
{
+        return unmodifiableList(asList(parents));
+    }
&lt;p&gt;+&lt;br/&gt;
     /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Record an occurrence, this is just short-hand for 
{@link #record(double) record(1.0)}
&lt;p&gt;      */&lt;br/&gt;
@@ -291,7 +297,7 @@ public boolean hasExpired() {&lt;br/&gt;
     }&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     synchronized List&amp;lt;KafkaMetric&amp;gt; metrics() &lt;/p&gt;
{
-        return Collections.unmodifiableList(new LinkedList&amp;lt;&amp;gt;(this.metrics.values()));
+        return unmodifiableList(new LinkedList&amp;lt;&amp;gt;(this.metrics.values()));
     }

&lt;p&gt;     /**&lt;br/&gt;
diff --git a/clients/src/test/java/org/apache/kafka/common/metrics/MetricsTest.java b/clients/src/test/java/org/apache/kafka/common/metrics/MetricsTest.java&lt;br/&gt;
index eb3f7752a6c..992abcba7d6 100644&lt;br/&gt;
&amp;#8212; a/clients/src/test/java/org/apache/kafka/common/metrics/MetricsTest.java&lt;br/&gt;
+++ b/clients/src/test/java/org/apache/kafka/common/metrics/MetricsTest.java&lt;br/&gt;
@@ -16,6 +16,8 @@&lt;br/&gt;
  */&lt;br/&gt;
 package org.apache.kafka.common.metrics;&lt;/p&gt;

&lt;p&gt;+import static java.util.Collections.emptyList;&lt;br/&gt;
+import static java.util.Collections.singletonList;&lt;br/&gt;
 import static org.junit.Assert.assertEquals;&lt;br/&gt;
 import static org.junit.Assert.assertFalse;&lt;br/&gt;
 import static org.junit.Assert.assertNotNull;&lt;br/&gt;
@@ -202,6 +204,20 @@ public void testBadSensorHierarchy() &lt;/p&gt;
{
         metrics.sensor(&quot;gc&quot;, c1, c2); // should fail
     }

&lt;p&gt;+    @Test&lt;br/&gt;
+    public void testRemoveChildSensor() &lt;/p&gt;
{
+        final Metrics metrics = new Metrics();
+
+        final Sensor parent = metrics.sensor(&quot;parent&quot;);
+        final Sensor child = metrics.sensor(&quot;child&quot;, parent);
+
+        assertEquals(singletonList(child), metrics.childrenSensors().get(parent));
+
+        metrics.removeSensor(&quot;child&quot;);
+
+        assertEquals(emptyList(), metrics.childrenSensors().get(parent));
+    }
&lt;p&gt;+&lt;br/&gt;
     @Test&lt;br/&gt;
     public void testRemoveSensor() {&lt;br/&gt;
         int size = metrics.metrics().size();&lt;br/&gt;
diff --git a/streams/src/main/java/org/apache/kafka/streams/processor/internals/ProcessorNode.java b/streams/src/main/java/org/apache/kafka/streams/processor/internals/ProcessorNode.java&lt;br/&gt;
index 8dc64173379..ec4f8e5e5db 100644&lt;br/&gt;
&amp;#8212; a/streams/src/main/java/org/apache/kafka/streams/processor/internals/ProcessorNode.java&lt;br/&gt;
+++ b/streams/src/main/java/org/apache/kafka/streams/processor/internals/ProcessorNode.java&lt;br/&gt;
@@ -31,6 +31,8 @@&lt;br/&gt;
 import java.util.Map;&lt;br/&gt;
 import java.util.Set;&lt;/p&gt;

&lt;p&gt;+import static org.apache.kafka.streams.processor.internals.metrics.StreamsMetricsImpl.PROCESSOR_NODE_ID_TAG;&lt;br/&gt;
+import static org.apache.kafka.streams.processor.internals.metrics.StreamsMetricsImpl.PROCESSOR_NODE_METRICS_GROUP;&lt;br/&gt;
 import static org.apache.kafka.streams.processor.internals.metrics.StreamsMetricsImpl.addAvgMaxLatency;&lt;br/&gt;
 import static org.apache.kafka.streams.processor.internals.metrics.StreamsMetricsImpl.addInvocationRateAndCount;&lt;/p&gt;

&lt;p&gt;@@ -165,15 +167,13 @@ Sensor sourceNodeForwardSensor() {&lt;br/&gt;
         private NodeMetrics(final StreamsMetricsImpl metrics, final String processorNodeName, final ProcessorContext context) {&lt;br/&gt;
             this.metrics = metrics;&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final String group = &quot;stream-processor-node-metrics&quot;;&lt;br/&gt;
             final String taskName = context.taskId().toString();&lt;/li&gt;
	&lt;li&gt;final Map&amp;lt;String, String&amp;gt; tagMap = metrics.tagMap(&quot;task-id&quot;, context.taskId().toString(), &quot;processor-node-id&quot;, processorNodeName);&lt;/li&gt;
	&lt;li&gt;final Map&amp;lt;String, String&amp;gt; allTagMap = metrics.tagMap(&quot;task-id&quot;, context.taskId().toString(), &quot;processor-node-id&quot;, &quot;all&quot;);&lt;br/&gt;
+            final Map&amp;lt;String, String&amp;gt; tagMap = metrics.tagMap(&quot;task-id&quot;, context.taskId().toString(), PROCESSOR_NODE_ID_TAG, processorNodeName);&lt;br/&gt;
+            final Map&amp;lt;String, String&amp;gt; allTagMap = metrics.tagMap(&quot;task-id&quot;, context.taskId().toString(), PROCESSOR_NODE_ID_TAG, &quot;all&quot;);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;             nodeProcessTimeSensor = createTaskAndNodeLatencyAndThroughputSensors(&lt;br/&gt;
                 &quot;process&quot;,&lt;br/&gt;
                 metrics,&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;group,&lt;br/&gt;
                 taskName,&lt;br/&gt;
                 processorNodeName,&lt;br/&gt;
                 allTagMap,&lt;br/&gt;
@@ -183,7 +183,6 @@ private NodeMetrics(final StreamsMetricsImpl metrics, final String processorNode&lt;br/&gt;
             nodePunctuateTimeSensor = createTaskAndNodeLatencyAndThroughputSensors(&lt;br/&gt;
                 &quot;punctuate&quot;,&lt;br/&gt;
                 metrics,&lt;/li&gt;
	&lt;li&gt;group,&lt;br/&gt;
                 taskName,&lt;br/&gt;
                 processorNodeName,&lt;br/&gt;
                 allTagMap,&lt;br/&gt;
@@ -193,7 +192,6 @@ private NodeMetrics(final StreamsMetricsImpl metrics, final String processorNode&lt;br/&gt;
             nodeCreationSensor = createTaskAndNodeLatencyAndThroughputSensors(&lt;br/&gt;
                 &quot;create&quot;,&lt;br/&gt;
                 metrics,&lt;/li&gt;
	&lt;li&gt;group,&lt;br/&gt;
                 taskName,&lt;br/&gt;
                 processorNodeName,&lt;br/&gt;
                 allTagMap,&lt;br/&gt;
@@ -204,7 +202,6 @@ private NodeMetrics(final StreamsMetricsImpl metrics, final String processorNode&lt;br/&gt;
             nodeDestructionSensor = createTaskAndNodeLatencyAndThroughputSensors(&lt;br/&gt;
                 &quot;destroy&quot;,&lt;br/&gt;
                 metrics,&lt;/li&gt;
	&lt;li&gt;group,&lt;br/&gt;
                 taskName,&lt;br/&gt;
                 processorNodeName,&lt;br/&gt;
                 allTagMap,&lt;br/&gt;
@@ -214,7 +211,6 @@ private NodeMetrics(final StreamsMetricsImpl metrics, final String processorNode&lt;br/&gt;
             sourceNodeForwardSensor = createTaskAndNodeLatencyAndThroughputSensors(&lt;br/&gt;
                 &quot;forward&quot;,&lt;br/&gt;
                 metrics,&lt;/li&gt;
	&lt;li&gt;group,&lt;br/&gt;
                 taskName,&lt;br/&gt;
                 processorNodeName,&lt;br/&gt;
                 allTagMap,&lt;br/&gt;
@@ -231,17 +227,18 @@ private void removeAllSensors() {&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         private static Sensor createTaskAndNodeLatencyAndThroughputSensors(final String operation,&lt;br/&gt;
                                                                            final StreamsMetricsImpl metrics,&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final String group,&lt;br/&gt;
                                                                            final String taskName,&lt;br/&gt;
                                                                            final String processorNodeName,&lt;br/&gt;
                                                                            final Map&amp;lt;String, String&amp;gt; taskTags,&lt;br/&gt;
                                                                            final Map&amp;lt;String, String&amp;gt; nodeTags) 
{
             final Sensor parent = metrics.taskLevelSensor(taskName, operation, Sensor.RecordingLevel.DEBUG);
-            addAvgMaxLatency(parent, group, taskTags, operation);
-            addInvocationRateAndCount(parent, group, taskTags, operation);
+            addAvgMaxLatency(parent, PROCESSOR_NODE_METRICS_GROUP, taskTags, operation);
+            addInvocationRateAndCount(parent, PROCESSOR_NODE_METRICS_GROUP, taskTags, operation);
+
             final Sensor sensor = metrics.nodeLevelSensor(taskName, processorNodeName, operation, Sensor.RecordingLevel.DEBUG, parent);
-            addAvgMaxLatency(sensor, group, nodeTags, operation);
-            addInvocationRateAndCount(sensor, group, nodeTags, operation);
+            addAvgMaxLatency(sensor, PROCESSOR_NODE_METRICS_GROUP, nodeTags, operation);
+            addInvocationRateAndCount(sensor, PROCESSOR_NODE_METRICS_GROUP, nodeTags, operation);
+
             return sensor;
         }
&lt;p&gt;     }&lt;br/&gt;
diff --git a/streams/src/main/java/org/apache/kafka/streams/processor/internals/metrics/StreamsMetricsImpl.java b/streams/src/main/java/org/apache/kafka/streams/processor/internals/metrics/StreamsMetricsImpl.java&lt;br/&gt;
index 170311238ec..dd6cc4a2185 100644&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/streams/src/main/java/org/apache/kafka/streams/processor/internals/metrics/StreamsMetricsImpl.java&lt;br/&gt;
+++ b/streams/src/main/java/org/apache/kafka/streams/processor/internals/metrics/StreamsMetricsImpl.java&lt;br/&gt;
@@ -51,6 +51,9 @@&lt;br/&gt;
     private static final String SENSOR_PREFIX_DELIMITER = &quot;.&quot;;&lt;br/&gt;
     private static final String SENSOR_NAME_DELIMITER = &quot;.s.&quot;;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;+    public static final String PROCESSOR_NODE_METRICS_GROUP = &quot;stream-processor-node-metrics&quot;;&lt;br/&gt;
+    public static final String PROCESSOR_NODE_ID_TAG = &quot;processor-node-id&quot;;&lt;br/&gt;
+&lt;br/&gt;
     public StreamsMetricsImpl(final Metrics metrics, final String threadName) {&lt;br/&gt;
         Objects.requireNonNull(metrics, &quot;Metrics cannot be null&quot;);&lt;br/&gt;
         this.threadName = threadName;&lt;br/&gt;
@@ -112,11 +115,9 @@ public final Sensor taskLevelSensor(final String taskName,&lt;br/&gt;
     public final void removeAllTaskLevelSensors(final String taskName) {&lt;br/&gt;
         final String key = taskSensorPrefix(taskName);&lt;br/&gt;
         synchronized (taskLevelSensors) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (taskLevelSensors.containsKey(key)) {&lt;/li&gt;
	&lt;li&gt;while (!taskLevelSensors.get(key).isEmpty()) 
{
-                    metrics.removeSensor(taskLevelSensors.get(key).pop());
-                }&lt;/li&gt;
	&lt;li&gt;taskLevelSensors.remove(key);&lt;br/&gt;
+            final Deque&amp;lt;String&amp;gt; sensors = taskLevelSensors.remove(key);&lt;br/&gt;
+            while (sensors != null &amp;amp;&amp;amp; !sensors.isEmpty()) 
{
+                metrics.removeSensor(sensors.pop());
             }&lt;br/&gt;
         }&lt;br/&gt;
     }&lt;br/&gt;
@@ -149,10 +150,9 @@ public Sensor nodeLevelSensor(final String taskName,&lt;br/&gt;
     public final void removeAllNodeLevelSensors(final String taskName, final String processorNodeName) {&lt;br/&gt;
         final String key = nodeSensorPrefix(taskName, processorNodeName);&lt;br/&gt;
         synchronized (nodeLevelSensors) {&lt;br/&gt;
-            if (nodeLevelSensors.containsKey(key)) {&lt;br/&gt;
-                while (!nodeLevelSensors.get(key).isEmpty()) {
-                    metrics.removeSensor(nodeLevelSensors.get(key).pop());
-                }&lt;br/&gt;
+            final Deque&amp;lt;String&amp;gt; sensors = nodeLevelSensors.remove(key);&lt;br/&gt;
+            while (sensors != null &amp;amp;&amp;amp; !sensors.isEmpty()) {+                metrics.removeSensor(sensors.pop());             }
&lt;p&gt;         }&lt;br/&gt;
     }&lt;br/&gt;
@@ -185,11 +185,9 @@ public final Sensor cacheLevelSensor(final String taskName,&lt;br/&gt;
     public final void removeAllCacheLevelSensors(final String taskName, final String cacheName) {&lt;br/&gt;
         final String key = cacheSensorPrefix(taskName, cacheName);&lt;br/&gt;
         synchronized (cacheLevelSensors) {&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;if (cacheLevelSensors.containsKey(key)) {&lt;/li&gt;
	&lt;li&gt;while (!cacheLevelSensors.get(key).isEmpty()) 
{
-                    metrics.removeSensor(cacheLevelSensors.get(key).pop());
-                }&lt;/li&gt;
	&lt;li&gt;cacheLevelSensors.remove(key);&lt;br/&gt;
+            final Deque&amp;lt;String&amp;gt; strings = cacheLevelSensors.remove(key);&lt;br/&gt;
+            while (strings != null &amp;amp;&amp;amp; !strings.isEmpty()) 
{
+                metrics.removeSensor(strings.pop());
             }
&lt;p&gt;         }&lt;br/&gt;
     }&lt;br/&gt;
@@ -222,11 +220,9 @@ public final Sensor storeLevelSensor(final String taskName,&lt;br/&gt;
     public final void removeAllStoreLevelSensors(final String taskName, final String storeName) {&lt;br/&gt;
         final String key = storeSensorPrefix(taskName, storeName);&lt;br/&gt;
         synchronized (storeLevelSensors) {&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;if (storeLevelSensors.containsKey(key)) {&lt;/li&gt;
	&lt;li&gt;while (!storeLevelSensors.get(key).isEmpty()) 
{
-                    metrics.removeSensor(storeLevelSensors.get(key).pop());
-                }&lt;/li&gt;
	&lt;li&gt;storeLevelSensors.remove(key);&lt;br/&gt;
+            final Deque&amp;lt;String&amp;gt; sensors = storeLevelSensors.remove(key);&lt;br/&gt;
+            while (sensors != null &amp;amp;&amp;amp; !sensors.isEmpty()) 
{
+                metrics.removeSensor(sensors.pop());
             }
&lt;p&gt;         }&lt;br/&gt;
     }&lt;br/&gt;
@@ -410,12 +406,19 @@ public void removeSensor(final Sensor sensor) {&lt;br/&gt;
         Objects.requireNonNull(sensor, &quot;Sensor is null&quot;);&lt;br/&gt;
         metrics.removeSensor(sensor.name());&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final Sensor parent = parentSensors.get(sensor);&lt;br/&gt;
+        final Sensor parent = parentSensors.remove(sensor);&lt;br/&gt;
         if (parent != null) 
{
             metrics.removeSensor(parent.name());
         }
&lt;p&gt;     }&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;+    /**&lt;br/&gt;
+     * Visible for testing&lt;br/&gt;
+     */&lt;br/&gt;
+    Map&amp;lt;Sensor, Sensor&amp;gt; parentSensors() &lt;/p&gt;
{
+        return Collections.unmodifiableMap(parentSensors);
+    }
&lt;p&gt;+&lt;br/&gt;
     private static String groupNameFromScope(final String scopeName) &lt;/p&gt;
{
         return &quot;stream-&quot; + scopeName + &quot;-metrics&quot;;
     }
&lt;p&gt;diff --git a/streams/src/test/java/org/apache/kafka/streams/processor/internals/StreamsMetricsImplTest.java b/streams/src/test/java/org/apache/kafka/streams/processor/internals/metrics/StreamsMetricsImplTest.java&lt;br/&gt;
similarity index 62%&lt;br/&gt;
rename from streams/src/test/java/org/apache/kafka/streams/processor/internals/StreamsMetricsImplTest.java&lt;br/&gt;
rename to streams/src/test/java/org/apache/kafka/streams/processor/internals/metrics/StreamsMetricsImplTest.java&lt;br/&gt;
index 7ce27b4b6d6..38629c38d41 100644&lt;br/&gt;
&amp;#8212; a/streams/src/test/java/org/apache/kafka/streams/processor/internals/StreamsMetricsImplTest.java&lt;br/&gt;
+++ b/streams/src/test/java/org/apache/kafka/streams/processor/internals/metrics/StreamsMetricsImplTest.java&lt;br/&gt;
@@ -14,7 +14,7 @@&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;See the License for the specific language governing permissions and&lt;/li&gt;
	&lt;li&gt;limitations under the License.&lt;br/&gt;
  */&lt;br/&gt;
-package org.apache.kafka.streams.processor.internals;&lt;br/&gt;
+package org.apache.kafka.streams.processor.internals.metrics;&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt; import org.apache.kafka.common.MetricName;&lt;br/&gt;
@@ -23,12 +23,21 @@&lt;br/&gt;
 import org.apache.kafka.common.metrics.Metrics;&lt;br/&gt;
 import org.apache.kafka.common.metrics.Sensor;&lt;br/&gt;
 import org.apache.kafka.common.utils.MockTime;&lt;br/&gt;
-import org.apache.kafka.streams.processor.internals.metrics.StreamsMetricsImpl;&lt;br/&gt;
 import org.junit.Test;&lt;/p&gt;

&lt;p&gt;+import java.util.Collections;&lt;br/&gt;
+import java.util.Map;&lt;br/&gt;
 import java.util.concurrent.TimeUnit;&lt;/p&gt;

&lt;p&gt;+import static org.apache.kafka.common.utils.Utils.mkEntry;&lt;br/&gt;
+import static org.apache.kafka.common.utils.Utils.mkMap;&lt;br/&gt;
+import static org.apache.kafka.streams.processor.internals.metrics.StreamsMetricsImpl.PROCESSOR_NODE_METRICS_GROUP;&lt;br/&gt;
+import static org.apache.kafka.streams.processor.internals.metrics.StreamsMetricsImpl.addAvgMaxLatency;&lt;br/&gt;
+import static org.apache.kafka.streams.processor.internals.metrics.StreamsMetricsImpl.addInvocationRateAndCount;&lt;br/&gt;
+import static org.hamcrest.Matchers.equalTo;&lt;br/&gt;
+import static org.hamcrest.Matchers.greaterThan;&lt;br/&gt;
 import static org.junit.Assert.assertEquals;&lt;br/&gt;
+import static org.junit.Assert.assertThat;&lt;/p&gt;

&lt;p&gt; public class StreamsMetricsImplTest {&lt;/p&gt;

&lt;p&gt;@@ -62,6 +71,60 @@ public void testRemoveSensor() &lt;/p&gt;
{
 
         final Sensor sensor3 = streamsMetrics.addThroughputSensor(scope, entity, operation, Sensor.RecordingLevel.DEBUG);
         streamsMetrics.removeSensor(sensor3);
+
+        assertEquals(Collections.emptyMap(), streamsMetrics.parentSensors());
+    }
&lt;p&gt;+&lt;br/&gt;
+    @Test&lt;br/&gt;
+    public void testMutiLevelSensorRemoval() {&lt;br/&gt;
+        final Metrics registry = new Metrics();&lt;br/&gt;
+        final StreamsMetricsImpl metrics = new StreamsMetricsImpl(registry, &quot;&quot;);&lt;br/&gt;
+        for (final MetricName defaultMetric : registry.metrics().keySet()) &lt;/p&gt;
{
+            registry.removeMetric(defaultMetric);
+        }
&lt;p&gt;+&lt;br/&gt;
+        final String taskName = &quot;taskName&quot;;&lt;br/&gt;
+        final String operation = &quot;operation&quot;;&lt;br/&gt;
+        final Map&amp;lt;String, String&amp;gt; taskTags = mkMap(mkEntry(&quot;tkey&quot;, &quot;value&quot;));&lt;br/&gt;
+&lt;br/&gt;
+        final String processorNodeName = &quot;processorNodeName&quot;;&lt;br/&gt;
+        final Map&amp;lt;String, String&amp;gt; nodeTags = mkMap(mkEntry(&quot;nkey&quot;, &quot;value&quot;));&lt;br/&gt;
+&lt;br/&gt;
+        final Sensor parent1 = metrics.taskLevelSensor(taskName, operation, Sensor.RecordingLevel.DEBUG);&lt;br/&gt;
+        addAvgMaxLatency(parent1, PROCESSOR_NODE_METRICS_GROUP, taskTags, operation);&lt;br/&gt;
+        addInvocationRateAndCount(parent1, PROCESSOR_NODE_METRICS_GROUP, taskTags, operation);&lt;br/&gt;
+&lt;br/&gt;
+        final int numberOfTaskMetrics = registry.metrics().size();&lt;br/&gt;
+&lt;br/&gt;
+        final Sensor sensor1 = metrics.nodeLevelSensor(taskName, processorNodeName, operation, Sensor.RecordingLevel.DEBUG, parent1);&lt;br/&gt;
+        addAvgMaxLatency(sensor1, PROCESSOR_NODE_METRICS_GROUP, nodeTags, operation);&lt;br/&gt;
+        addInvocationRateAndCount(sensor1, PROCESSOR_NODE_METRICS_GROUP, nodeTags, operation);&lt;br/&gt;
+&lt;br/&gt;
+        assertThat(registry.metrics().size(), greaterThan(numberOfTaskMetrics));&lt;br/&gt;
+&lt;br/&gt;
+        metrics.removeAllNodeLevelSensors(taskName, processorNodeName);&lt;br/&gt;
+&lt;br/&gt;
+        assertThat(registry.metrics().size(), equalTo(numberOfTaskMetrics));&lt;br/&gt;
+&lt;br/&gt;
+        final Sensor parent2 = metrics.taskLevelSensor(taskName, operation, Sensor.RecordingLevel.DEBUG);&lt;br/&gt;
+        addAvgMaxLatency(parent2, PROCESSOR_NODE_METRICS_GROUP, taskTags, operation);&lt;br/&gt;
+        addInvocationRateAndCount(parent2, PROCESSOR_NODE_METRICS_GROUP, taskTags, operation);&lt;br/&gt;
+&lt;br/&gt;
+        assertThat(registry.metrics().size(), equalTo(numberOfTaskMetrics));&lt;br/&gt;
+&lt;br/&gt;
+        final Sensor sensor2 = metrics.nodeLevelSensor(taskName, processorNodeName, operation, Sensor.RecordingLevel.DEBUG, parent2);&lt;br/&gt;
+        addAvgMaxLatency(sensor2, PROCESSOR_NODE_METRICS_GROUP, nodeTags, operation);&lt;br/&gt;
+        addInvocationRateAndCount(sensor2, PROCESSOR_NODE_METRICS_GROUP, nodeTags, operation);&lt;br/&gt;
+&lt;br/&gt;
+        assertThat(registry.metrics().size(), greaterThan(numberOfTaskMetrics));&lt;br/&gt;
+&lt;br/&gt;
+        metrics.removeAllNodeLevelSensors(taskName, processorNodeName);&lt;br/&gt;
+&lt;br/&gt;
+        assertThat(registry.metrics().size(), equalTo(numberOfTaskMetrics));&lt;br/&gt;
+&lt;br/&gt;
+        metrics.removeAllTaskLevelSensors(taskName);&lt;br/&gt;
+&lt;br/&gt;
+        assertThat(registry.metrics().size(), equalTo(0));&lt;br/&gt;
     }&lt;/p&gt;

&lt;p&gt;     @Test&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16709302" author="githubbot" created="Tue, 4 Dec 2018 21:51:22 +0000"  >&lt;p&gt;mjsax closed pull request #5980: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7660&quot; title=&quot;Stream Metrics - Memory Analysis&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7660&quot;&gt;&lt;del&gt;KAFKA-7660&lt;/del&gt;&lt;/a&gt;: fix streams and Metrics memory leaks&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5980&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5980&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/clients/src/main/java/org/apache/kafka/common/metrics/Metrics.java b/clients/src/main/java/org/apache/kafka/common/metrics/Metrics.java&lt;br/&gt;
index a6da9f90397..9e2b6f18f0c 100644&lt;br/&gt;
&amp;#8212; a/clients/src/main/java/org/apache/kafka/common/metrics/Metrics.java&lt;br/&gt;
+++ b/clients/src/main/java/org/apache/kafka/common/metrics/Metrics.java&lt;br/&gt;
@@ -41,6 +41,8 @@&lt;br/&gt;
 import java.util.concurrent.ThreadFactory;&lt;br/&gt;
 import java.util.concurrent.TimeUnit;&lt;/p&gt;

&lt;p&gt;+import static java.util.Collections.emptyList;&lt;br/&gt;
+&lt;br/&gt;
 /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;A registry of sensors and metrics.&lt;/li&gt;
	&lt;li&gt;&amp;lt;p&amp;gt;&lt;br/&gt;
@@ -446,6 +448,9 @@ public void removeSensor(String name) {&lt;br/&gt;
                             removeMetric(metric.metricName());&lt;br/&gt;
                         log.debug(&quot;Removed sensor with name {}&quot;, name);&lt;br/&gt;
                         childSensors = childrenSensors.remove(sensor);&lt;br/&gt;
+                        for (final Sensor parent : sensor.parents()) 
{
+                            childrenSensors.getOrDefault(parent, emptyList()).remove(sensor);
+                        }
&lt;p&gt;                     }&lt;br/&gt;
                 }&lt;br/&gt;
             }&lt;br/&gt;
diff --git a/clients/src/main/java/org/apache/kafka/common/metrics/Sensor.java b/clients/src/main/java/org/apache/kafka/common/metrics/Sensor.java&lt;br/&gt;
index ccbe8aad9cd..1af9419bc75 100644&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/clients/src/main/java/org/apache/kafka/common/metrics/Sensor.java&lt;br/&gt;
+++ b/clients/src/main/java/org/apache/kafka/common/metrics/Sensor.java&lt;br/&gt;
@@ -22,7 +22,6 @@&lt;br/&gt;
 import org.apache.kafka.common.utils.Utils;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; import java.util.ArrayList;&lt;br/&gt;
-import java.util.Collections;&lt;br/&gt;
 import java.util.HashSet;&lt;br/&gt;
 import java.util.LinkedHashMap;&lt;br/&gt;
 import java.util.LinkedList;&lt;br/&gt;
@@ -32,6 +31,9 @@&lt;br/&gt;
 import java.util.Set;&lt;br/&gt;
 import java.util.concurrent.TimeUnit;&lt;/p&gt;

&lt;p&gt;+import static java.util.Arrays.asList;&lt;br/&gt;
+import static java.util.Collections.unmodifiableList;&lt;br/&gt;
+&lt;br/&gt;
 /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;A sensor applies a continuous sequence of numerical values to a set of associated metrics. For example a sensor on&lt;/li&gt;
	&lt;li&gt;message size would record a sequence of message sizes using the 
{@link #record(double)}
&lt;p&gt; api and would maintain a set&lt;br/&gt;
@@ -133,6 +135,10 @@ public String name() &lt;/p&gt;
{
         return this.name;
     }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;+    List&amp;lt;Sensor&amp;gt; parents() &lt;/p&gt;
{
+        return unmodifiableList(asList(parents));
+    }
&lt;p&gt;+&lt;br/&gt;
     /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Record an occurrence, this is just short-hand for 
{@link #record(double) record(1.0)}
&lt;p&gt;      */&lt;br/&gt;
@@ -291,7 +297,7 @@ public boolean hasExpired() {&lt;br/&gt;
     }&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     synchronized List&amp;lt;KafkaMetric&amp;gt; metrics() &lt;/p&gt;
{
-        return Collections.unmodifiableList(new LinkedList&amp;lt;&amp;gt;(this.metrics.values()));
+        return unmodifiableList(new LinkedList&amp;lt;&amp;gt;(this.metrics.values()));
     }

&lt;p&gt;     /**&lt;br/&gt;
diff --git a/clients/src/test/java/org/apache/kafka/common/metrics/MetricsTest.java b/clients/src/test/java/org/apache/kafka/common/metrics/MetricsTest.java&lt;br/&gt;
index 5c75d03b0e6..6ad48331fde 100644&lt;br/&gt;
&amp;#8212; a/clients/src/test/java/org/apache/kafka/common/metrics/MetricsTest.java&lt;br/&gt;
+++ b/clients/src/test/java/org/apache/kafka/common/metrics/MetricsTest.java&lt;br/&gt;
@@ -16,6 +16,8 @@&lt;br/&gt;
  */&lt;br/&gt;
 package org.apache.kafka.common.metrics;&lt;/p&gt;

&lt;p&gt;+import static java.util.Collections.emptyList;&lt;br/&gt;
+import static java.util.Collections.singletonList;&lt;br/&gt;
 import static org.junit.Assert.assertEquals;&lt;br/&gt;
 import static org.junit.Assert.assertFalse;&lt;br/&gt;
 import static org.junit.Assert.assertNotNull;&lt;br/&gt;
@@ -197,6 +199,20 @@ public void testBadSensorHierarchy() &lt;/p&gt;
{
         metrics.sensor(&quot;gc&quot;, c1, c2); // should fail
     }

&lt;p&gt;+    @Test&lt;br/&gt;
+    public void testRemoveChildSensor() &lt;/p&gt;
{
+        final Metrics metrics = new Metrics();
+
+        final Sensor parent = metrics.sensor(&quot;parent&quot;);
+        final Sensor child = metrics.sensor(&quot;child&quot;, parent);
+
+        assertEquals(singletonList(child), metrics.childrenSensors().get(parent));
+
+        metrics.removeSensor(&quot;child&quot;);
+
+        assertEquals(emptyList(), metrics.childrenSensors().get(parent));
+    }
&lt;p&gt;+&lt;br/&gt;
     @Test&lt;br/&gt;
     public void testRemoveSensor() {&lt;br/&gt;
         int size = metrics.metrics().size();&lt;br/&gt;
diff --git a/streams/src/main/java/org/apache/kafka/streams/processor/internals/metrics/StreamsMetricsImpl.java b/streams/src/main/java/org/apache/kafka/streams/processor/internals/metrics/StreamsMetricsImpl.java&lt;br/&gt;
index 51665e60d0b..ba0b58fe2f0 100644&lt;br/&gt;
&amp;#8212; a/streams/src/main/java/org/apache/kafka/streams/processor/internals/metrics/StreamsMetricsImpl.java&lt;br/&gt;
+++ b/streams/src/main/java/org/apache/kafka/streams/processor/internals/metrics/StreamsMetricsImpl.java&lt;br/&gt;
@@ -110,11 +110,9 @@ public final Sensor taskLevelSensor(final String taskName,&lt;br/&gt;
     public final void removeAllTaskLevelSensors(final String taskName) {&lt;br/&gt;
         final String key = threadName + &quot;.&quot; + taskName;&lt;br/&gt;
         synchronized (taskLevelSensors) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (taskLevelSensors.containsKey(key)) {&lt;/li&gt;
	&lt;li&gt;while (!taskLevelSensors.get(key).isEmpty()) 
{
-                    metrics.removeSensor(taskLevelSensors.get(key).pop());
-                }&lt;/li&gt;
	&lt;li&gt;taskLevelSensors.remove(key);&lt;br/&gt;
+            final Deque&amp;lt;String&amp;gt; sensors = taskLevelSensors.remove(key);&lt;br/&gt;
+            while (sensors != null &amp;amp;&amp;amp; !sensors.isEmpty()) 
{
+                metrics.removeSensor(sensors.pop());
             }
&lt;p&gt;         }&lt;br/&gt;
     }&lt;br/&gt;
@@ -143,11 +141,9 @@ public final Sensor cacheLevelSensor(final String taskName,&lt;br/&gt;
     public final void removeAllCacheLevelSensors(final String taskName, final String cacheName) {&lt;br/&gt;
         final String key = threadName + &quot;.&quot; + taskName + &quot;.&quot; + cacheName;&lt;br/&gt;
         synchronized (cacheLevelSensors) {&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;if (cacheLevelSensors.containsKey(key)) {&lt;/li&gt;
	&lt;li&gt;while (!cacheLevelSensors.get(key).isEmpty()) 
{
-                    metrics.removeSensor(cacheLevelSensors.get(key).pop());
-                }&lt;/li&gt;
	&lt;li&gt;cacheLevelSensors.remove(key);&lt;br/&gt;
+            final Deque&amp;lt;String&amp;gt; strings = cacheLevelSensors.remove(key);&lt;br/&gt;
+            while (strings != null &amp;amp;&amp;amp; !strings.isEmpty()) 
{
+                metrics.removeSensor(strings.pop());
             }
&lt;p&gt;         }&lt;br/&gt;
     }&lt;br/&gt;
@@ -361,10 +357,16 @@ public void removeSensor(final Sensor sensor) {&lt;br/&gt;
         Objects.requireNonNull(sensor, &quot;Sensor is null&quot;);&lt;br/&gt;
         metrics.removeSensor(sensor.name());&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final Sensor parent = parentSensors.get(sensor);&lt;br/&gt;
+        final Sensor parent = parentSensors.remove(sensor);&lt;br/&gt;
         if (parent != null) 
{
             metrics.removeSensor(parent.name());
         }
&lt;p&gt;     }&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;+    /**&lt;br/&gt;
+     * Visible for testing&lt;br/&gt;
+     */&lt;br/&gt;
+    Map&amp;lt;Sensor, Sensor&amp;gt; parentSensors() &lt;/p&gt;
{
+        return Collections.unmodifiableMap(parentSensors);
+    }
&lt;p&gt; }&lt;br/&gt;
diff --git a/streams/src/test/java/org/apache/kafka/streams/processor/internals/StreamsMetricsImplTest.java b/streams/src/test/java/org/apache/kafka/streams/processor/internals/metrics/StreamsMetricsImplTest.java&lt;br/&gt;
similarity index 64%&lt;br/&gt;
rename from streams/src/test/java/org/apache/kafka/streams/processor/internals/StreamsMetricsImplTest.java&lt;br/&gt;
rename to streams/src/test/java/org/apache/kafka/streams/processor/internals/metrics/StreamsMetricsImplTest.java&lt;br/&gt;
index a72dc7928d7..cccc4580644 100644&lt;br/&gt;
&amp;#8212; a/streams/src/test/java/org/apache/kafka/streams/processor/internals/StreamsMetricsImplTest.java&lt;br/&gt;
+++ b/streams/src/test/java/org/apache/kafka/streams/processor/internals/metrics/StreamsMetricsImplTest.java&lt;br/&gt;
@@ -14,14 +14,20 @@&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;See the License for the specific language governing permissions and&lt;/li&gt;
	&lt;li&gt;limitations under the License.&lt;br/&gt;
  */&lt;br/&gt;
-package org.apache.kafka.streams.processor.internals;&lt;br/&gt;
+package org.apache.kafka.streams.processor.internals.metrics;&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;+import org.apache.kafka.common.MetricName;&lt;br/&gt;
 import org.apache.kafka.common.metrics.Metrics;&lt;br/&gt;
 import org.apache.kafka.common.metrics.Sensor;&lt;br/&gt;
-import org.apache.kafka.streams.processor.internals.metrics.StreamsMetricsImpl;&lt;br/&gt;
+import org.apache.kafka.common.metrics.stats.Count;&lt;br/&gt;
 import org.junit.Test;&lt;/p&gt;

&lt;p&gt;+import java.util.Collections;&lt;br/&gt;
+import java.util.Map;&lt;br/&gt;
+&lt;br/&gt;
+import static org.apache.kafka.common.utils.Utils.mkEntry;&lt;br/&gt;
+import static org.apache.kafka.common.utils.Utils.mkMap;&lt;br/&gt;
 import static org.junit.Assert.assertEquals;&lt;/p&gt;

&lt;p&gt; public class StreamsMetricsImplTest {&lt;br/&gt;
@@ -57,6 +63,55 @@ public void testRemoveSensor() &lt;/p&gt;
{
 
         final Sensor sensor3 = streamsMetrics.addThroughputSensor(taskName, scope, entity, operation, Sensor.RecordingLevel.DEBUG);
         streamsMetrics.removeSensor(sensor3);
+
+        assertEquals(Collections.emptyMap(), streamsMetrics.parentSensors());
+    }
&lt;p&gt;+&lt;br/&gt;
+    @Test&lt;br/&gt;
+    public void testMutiLevelSensorRemoval() {&lt;br/&gt;
+        final Metrics registry = new Metrics();&lt;br/&gt;
+        final StreamsMetricsImpl metrics = new StreamsMetricsImpl(registry, &quot;&quot;);&lt;br/&gt;
+        for (final MetricName defaultMetric : registry.metrics().keySet()) &lt;/p&gt;
{
+            registry.removeMetric(defaultMetric);
+        }
&lt;p&gt;+&lt;br/&gt;
+        final String taskName = &quot;taskName&quot;;&lt;br/&gt;
+        final String operation = &quot;operation&quot;;&lt;br/&gt;
+        final Map&amp;lt;String, String&amp;gt; threadTags = mkMap(mkEntry(&quot;threadkey&quot;, &quot;value&quot;));&lt;br/&gt;
+&lt;br/&gt;
+        final Map&amp;lt;String, String&amp;gt; taskTags = mkMap(mkEntry(&quot;taskkey&quot;, &quot;value&quot;));&lt;br/&gt;
+&lt;br/&gt;
+        final Sensor parent1 = metrics.threadLevelSensor(operation, Sensor.RecordingLevel.DEBUG);&lt;br/&gt;
+        parent1.add(new MetricName(&quot;name&quot;, &quot;group&quot;, &quot;description&quot;, threadTags), new Count());&lt;br/&gt;
+&lt;br/&gt;
+        assertEquals(1, registry.metrics().size());&lt;br/&gt;
+&lt;br/&gt;
+        final Sensor sensor1 = metrics.taskLevelSensor(taskName, operation, Sensor.RecordingLevel.DEBUG, parent1);&lt;br/&gt;
+        sensor1.add(new MetricName(&quot;name&quot;, &quot;group&quot;, &quot;description&quot;, taskTags), new Count());&lt;br/&gt;
+&lt;br/&gt;
+        assertEquals(2, registry.metrics().size());&lt;br/&gt;
+&lt;br/&gt;
+        metrics.removeAllTaskLevelSensors(taskName);&lt;br/&gt;
+&lt;br/&gt;
+        assertEquals(1, registry.metrics().size());&lt;br/&gt;
+&lt;br/&gt;
+        final Sensor parent2 = metrics.threadLevelSensor(operation, Sensor.RecordingLevel.DEBUG);&lt;br/&gt;
+        parent2.add(new MetricName(&quot;name&quot;, &quot;group&quot;, &quot;description&quot;, threadTags), new Count());&lt;br/&gt;
+&lt;br/&gt;
+        assertEquals(1, registry.metrics().size());&lt;br/&gt;
+&lt;br/&gt;
+        final Sensor sensor2 = metrics.taskLevelSensor(taskName, operation, Sensor.RecordingLevel.DEBUG, parent2);&lt;br/&gt;
+        sensor2.add(new MetricName(&quot;name&quot;, &quot;group&quot;, &quot;description&quot;, taskTags), new Count());&lt;br/&gt;
+&lt;br/&gt;
+        assertEquals(2, registry.metrics().size());&lt;br/&gt;
+&lt;br/&gt;
+        metrics.removeAllTaskLevelSensors(taskName);&lt;br/&gt;
+&lt;br/&gt;
+        assertEquals(1, registry.metrics().size());&lt;br/&gt;
+&lt;br/&gt;
+        metrics.removeAllThreadLevelSensors();&lt;br/&gt;
+&lt;br/&gt;
+        assertEquals(0, registry.metrics().size());&lt;br/&gt;
     }&lt;/p&gt;

&lt;p&gt;     @Test&lt;br/&gt;
@@ -90,7 +145,7 @@ public void testThroughputMetrics() {&lt;br/&gt;
         final String entity = &quot;entity&quot;;&lt;br/&gt;
         final String operation = &quot;put&quot;;&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final Sensor sensor1 = streamsMetrics.addThroughputSensor(taskName,  scope, entity, operation, Sensor.RecordingLevel.DEBUG);&lt;br/&gt;
+        final Sensor sensor1 = streamsMetrics.addThroughputSensor(taskName, scope, entity, operation, Sensor.RecordingLevel.DEBUG);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         final int meterMetricsCount = 2; // Each Meter is a combination of a Rate and a Total&lt;br/&gt;
         // 2 meter metrics plus a common metric that keeps track of total registered metrics in Metrics() constructor&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16710810" author="githubbot" created="Thu, 6 Dec 2018 00:45:51 +0000"  >&lt;p&gt;mjsax closed pull request #5981: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7660&quot; title=&quot;Stream Metrics - Memory Analysis&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7660&quot;&gt;&lt;del&gt;KAFKA-7660&lt;/del&gt;&lt;/a&gt;: fix streams and Metrics memory leaks&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5981&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5981&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/clients/src/main/java/org/apache/kafka/common/metrics/Metrics.java b/clients/src/main/java/org/apache/kafka/common/metrics/Metrics.java&lt;br/&gt;
index e83085e7132..803fd7c9cca 100644&lt;br/&gt;
&amp;#8212; a/clients/src/main/java/org/apache/kafka/common/metrics/Metrics.java&lt;br/&gt;
+++ b/clients/src/main/java/org/apache/kafka/common/metrics/Metrics.java&lt;br/&gt;
@@ -446,6 +446,12 @@ public void removeSensor(String name) {&lt;br/&gt;
                             removeMetric(metric.metricName());&lt;br/&gt;
                         log.debug(&quot;Removed sensor with name {}&quot;, name);&lt;br/&gt;
                         childSensors = childrenSensors.remove(sensor);&lt;br/&gt;
+                        for (final Sensor parent : sensor.parents()) {&lt;br/&gt;
+                            final List&amp;lt;Sensor&amp;gt; peers = childrenSensors.get(parent);&lt;br/&gt;
+                            if (peers != null) &lt;/p&gt;
{
+                                peers.remove(sensor);
+                            }
&lt;p&gt;+                        }&lt;br/&gt;
                     }&lt;br/&gt;
                 }&lt;br/&gt;
             }&lt;br/&gt;
diff --git a/clients/src/main/java/org/apache/kafka/common/metrics/Sensor.java b/clients/src/main/java/org/apache/kafka/common/metrics/Sensor.java&lt;br/&gt;
index 7ee23d31f47..16f33c2d095 100644&lt;br/&gt;
&amp;#8212; a/clients/src/main/java/org/apache/kafka/common/metrics/Sensor.java&lt;br/&gt;
+++ b/clients/src/main/java/org/apache/kafka/common/metrics/Sensor.java&lt;br/&gt;
@@ -22,13 +22,15 @@&lt;br/&gt;
 import org.apache.kafka.common.utils.Utils;&lt;/p&gt;

&lt;p&gt; import java.util.ArrayList;&lt;br/&gt;
-import java.util.Collections;&lt;br/&gt;
 import java.util.HashSet;&lt;br/&gt;
 import java.util.List;&lt;br/&gt;
 import java.util.Locale;&lt;br/&gt;
 import java.util.Set;&lt;br/&gt;
 import java.util.concurrent.TimeUnit;&lt;/p&gt;

&lt;p&gt;+import static java.util.Arrays.asList;&lt;br/&gt;
+import static java.util.Collections.unmodifiableList;&lt;br/&gt;
+&lt;br/&gt;
 /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;A sensor applies a continuous sequence of numerical values to a set of associated metrics. For example a sensor on&lt;/li&gt;
	&lt;li&gt;message size would record a sequence of message sizes using the 
{@link #record(double)}
&lt;p&gt; api and would maintain a set&lt;br/&gt;
@@ -134,6 +136,10 @@ public String name() &lt;/p&gt;
{
         return this.name;
     }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;+    List&amp;lt;Sensor&amp;gt; parents() &lt;/p&gt;
{
+        return unmodifiableList(asList(parents));
+    }
&lt;p&gt;+&lt;br/&gt;
     /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Record an occurrence, this is just short-hand for 
{@link #record(double) record(1.0)}
&lt;p&gt;      */&lt;br/&gt;
@@ -271,7 +277,7 @@ public boolean hasExpired() {&lt;br/&gt;
     }&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     synchronized List&amp;lt;KafkaMetric&amp;gt; metrics() &lt;/p&gt;
{
-        return Collections.unmodifiableList(this.metrics);
+        return unmodifiableList(this.metrics);
     }

&lt;p&gt;     /**&lt;br/&gt;
diff --git a/clients/src/test/java/org/apache/kafka/common/metrics/MetricsTest.java b/clients/src/test/java/org/apache/kafka/common/metrics/MetricsTest.java&lt;br/&gt;
index 7a973daf043..7dd780d4497 100644&lt;br/&gt;
&amp;#8212; a/clients/src/test/java/org/apache/kafka/common/metrics/MetricsTest.java&lt;br/&gt;
+++ b/clients/src/test/java/org/apache/kafka/common/metrics/MetricsTest.java&lt;br/&gt;
@@ -16,6 +16,8 @@&lt;br/&gt;
  */&lt;br/&gt;
 package org.apache.kafka.common.metrics;&lt;/p&gt;

&lt;p&gt;+import static java.util.Collections.emptyList;&lt;br/&gt;
+import static java.util.Collections.singletonList;&lt;br/&gt;
 import static org.junit.Assert.assertEquals;&lt;br/&gt;
 import static org.junit.Assert.assertFalse;&lt;br/&gt;
 import static org.junit.Assert.assertNotNull;&lt;br/&gt;
@@ -197,6 +199,20 @@ public void testBadSensorHierarchy() &lt;/p&gt;
{
         metrics.sensor(&quot;gc&quot;, c1, c2); // should fail
     }

&lt;p&gt;+    @Test&lt;br/&gt;
+    public void testRemoveChildSensor() &lt;/p&gt;
{
+        final Metrics metrics = new Metrics();
+
+        final Sensor parent = metrics.sensor(&quot;parent&quot;);
+        final Sensor child = metrics.sensor(&quot;child&quot;, parent);
+
+        assertEquals(singletonList(child), metrics.childrenSensors().get(parent));
+
+        metrics.removeSensor(&quot;child&quot;);
+
+        assertEquals(emptyList(), metrics.childrenSensors().get(parent));
+    }
&lt;p&gt;+&lt;br/&gt;
     @Test&lt;br/&gt;
     public void testRemoveSensor() {&lt;br/&gt;
         int size = metrics.metrics().size();&lt;br/&gt;
diff --git a/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamsMetricsImpl.java b/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamsMetricsImpl.java&lt;br/&gt;
index 464beca5c5c..59a9d4f249f 100644&lt;br/&gt;
&amp;#8212; a/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamsMetricsImpl.java&lt;br/&gt;
+++ b/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamsMetricsImpl.java&lt;br/&gt;
@@ -222,10 +222,9 @@ public void removeSensor(Sensor sensor) {&lt;br/&gt;
         Objects.requireNonNull(sensor, &quot;Sensor is null&quot;);&lt;br/&gt;
         metrics.removeSensor(sensor.name());&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final Sensor parent = parentSensors.get(sensor);&lt;br/&gt;
+        final Sensor parent = parentSensors.remove(sensor);&lt;br/&gt;
         if (parent != null) 
{
             metrics.removeSensor(parent.name());
-            parentSensors.remove(sensor);
         }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     }&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16710811" author="githubbot" created="Thu, 6 Dec 2018 00:46:11 +0000"  >&lt;p&gt;mjsax closed pull request #5982: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7660&quot; title=&quot;Stream Metrics - Memory Analysis&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7660&quot;&gt;&lt;del&gt;KAFKA-7660&lt;/del&gt;&lt;/a&gt;: fix streams and Metrics memory leaks&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5982&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5982&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/clients/src/main/java/org/apache/kafka/common/metrics/Metrics.java b/clients/src/main/java/org/apache/kafka/common/metrics/Metrics.java&lt;br/&gt;
index a9d80f1dde3..ac1ffaf9418 100644&lt;br/&gt;
&amp;#8212; a/clients/src/main/java/org/apache/kafka/common/metrics/Metrics.java&lt;br/&gt;
+++ b/clients/src/main/java/org/apache/kafka/common/metrics/Metrics.java&lt;br/&gt;
@@ -446,6 +446,12 @@ public void removeSensor(String name) {&lt;br/&gt;
                             removeMetric(metric.metricName());&lt;br/&gt;
                         log.debug(&quot;Removed sensor with name {}&quot;, name);&lt;br/&gt;
                         childSensors = childrenSensors.remove(sensor);&lt;br/&gt;
+                        for (final Sensor parent : sensor.parents()) {&lt;br/&gt;
+                            final List&amp;lt;Sensor&amp;gt; peers = childrenSensors.get(parent);&lt;br/&gt;
+                            if (peers != null) &lt;/p&gt;
{
+                                peers.remove(sensor);
+                            }
&lt;p&gt;+                        }&lt;br/&gt;
                     }&lt;br/&gt;
                 }&lt;br/&gt;
             }&lt;br/&gt;
diff --git a/clients/src/main/java/org/apache/kafka/common/metrics/Sensor.java b/clients/src/main/java/org/apache/kafka/common/metrics/Sensor.java&lt;br/&gt;
index 321fab661cd..c845ff80895 100644&lt;br/&gt;
&amp;#8212; a/clients/src/main/java/org/apache/kafka/common/metrics/Sensor.java&lt;br/&gt;
+++ b/clients/src/main/java/org/apache/kafka/common/metrics/Sensor.java&lt;br/&gt;
@@ -22,13 +22,15 @@&lt;br/&gt;
 import org.apache.kafka.common.utils.Utils;&lt;/p&gt;

&lt;p&gt; import java.util.ArrayList;&lt;br/&gt;
-import java.util.Collections;&lt;br/&gt;
 import java.util.HashSet;&lt;br/&gt;
 import java.util.List;&lt;br/&gt;
 import java.util.Locale;&lt;br/&gt;
 import java.util.Set;&lt;br/&gt;
 import java.util.concurrent.TimeUnit;&lt;/p&gt;

&lt;p&gt;+import static java.util.Arrays.asList;&lt;br/&gt;
+import static java.util.Collections.unmodifiableList;&lt;br/&gt;
+&lt;br/&gt;
 /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;A sensor applies a continuous sequence of numerical values to a set of associated metrics. For example a sensor on&lt;/li&gt;
	&lt;li&gt;message size would record a sequence of message sizes using the 
{@link #record(double)}
&lt;p&gt; api and would maintain a set&lt;br/&gt;
@@ -132,6 +134,10 @@ public String name() &lt;/p&gt;
{
         return this.name;
     }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;+    List&amp;lt;Sensor&amp;gt; parents() &lt;/p&gt;
{
+        return unmodifiableList(asList(parents));
+    }
&lt;p&gt;+&lt;br/&gt;
     /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Record an occurrence, this is just short-hand for 
{@link #record(double) record(1.0)}
&lt;p&gt;      */&lt;br/&gt;
@@ -267,6 +273,6 @@ public boolean hasExpired() {&lt;br/&gt;
     }&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     synchronized List&amp;lt;KafkaMetric&amp;gt; metrics() &lt;/p&gt;
{
-        return Collections.unmodifiableList(this.metrics);
+        return unmodifiableList(this.metrics);
     }
&lt;p&gt; }&lt;br/&gt;
diff --git a/clients/src/test/java/org/apache/kafka/common/metrics/MetricsTest.java b/clients/src/test/java/org/apache/kafka/common/metrics/MetricsTest.java&lt;br/&gt;
index 216493f84a6..3db46e2fb72 100644&lt;br/&gt;
&amp;#8212; a/clients/src/test/java/org/apache/kafka/common/metrics/MetricsTest.java&lt;br/&gt;
+++ b/clients/src/test/java/org/apache/kafka/common/metrics/MetricsTest.java&lt;br/&gt;
@@ -16,6 +16,8 @@&lt;br/&gt;
  */&lt;br/&gt;
 package org.apache.kafka.common.metrics;&lt;/p&gt;

&lt;p&gt;+import static java.util.Collections.emptyList;&lt;br/&gt;
+import static java.util.Collections.singletonList;&lt;br/&gt;
 import static org.junit.Assert.assertEquals;&lt;br/&gt;
 import static org.junit.Assert.assertFalse;&lt;br/&gt;
 import static org.junit.Assert.assertNotNull;&lt;br/&gt;
@@ -177,6 +179,20 @@ public void testBadSensorHierarchy() &lt;/p&gt;
{
         metrics.sensor(&quot;gc&quot;, c1, c2); // should fail
     }

&lt;p&gt;+    @Test&lt;br/&gt;
+    public void testRemoveChildSensor() &lt;/p&gt;
{
+        final Metrics metrics = new Metrics();
+
+        final Sensor parent = metrics.sensor(&quot;parent&quot;);
+        final Sensor child = metrics.sensor(&quot;child&quot;, parent);
+
+        assertEquals(singletonList(child), metrics.childrenSensors().get(parent));
+
+        metrics.removeSensor(&quot;child&quot;);
+
+        assertEquals(emptyList(), metrics.childrenSensors().get(parent));
+    }
&lt;p&gt;+&lt;br/&gt;
     @Test&lt;br/&gt;
     public void testRemoveSensor() {&lt;br/&gt;
         int size = metrics.metrics().size();&lt;br/&gt;
diff --git a/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamsMetricsImpl.java b/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamsMetricsImpl.java&lt;br/&gt;
index cf25dd10fda..7b50feeaf8d 100644&lt;br/&gt;
&amp;#8212; a/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamsMetricsImpl.java&lt;br/&gt;
+++ b/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamsMetricsImpl.java&lt;br/&gt;
@@ -222,10 +222,9 @@ public void removeSensor(Sensor sensor) {&lt;br/&gt;
         Objects.requireNonNull(sensor, &quot;Sensor is null&quot;);&lt;br/&gt;
         metrics.removeSensor(sensor.name());&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final Sensor parent = parentSensors.get(sensor);&lt;br/&gt;
+        final Sensor parent = parentSensors.remove(sensor);&lt;br/&gt;
         if (parent != null) 
{
             metrics.removeSensor(parent.name());
-            parentSensors.remove(sensor);
         }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     }&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16710841" author="githubbot" created="Thu, 6 Dec 2018 01:17:47 +0000"  >&lt;p&gt;mjsax closed pull request #5983: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7660&quot; title=&quot;Stream Metrics - Memory Analysis&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7660&quot;&gt;&lt;del&gt;KAFKA-7660&lt;/del&gt;&lt;/a&gt;: fix streams and Metrics memory leaks&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5983&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5983&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/clients/src/main/java/org/apache/kafka/common/metrics/Metrics.java b/clients/src/main/java/org/apache/kafka/common/metrics/Metrics.java&lt;br/&gt;
index c4cd6765263..f6b6a4faf1a 100644&lt;br/&gt;
&amp;#8212; a/clients/src/main/java/org/apache/kafka/common/metrics/Metrics.java&lt;br/&gt;
+++ b/clients/src/main/java/org/apache/kafka/common/metrics/Metrics.java&lt;br/&gt;
@@ -435,6 +435,12 @@ public void removeSensor(String name) {&lt;br/&gt;
                             removeMetric(metric.metricName());&lt;br/&gt;
                         log.debug(&quot;Removed sensor with name {}&quot;, name);&lt;br/&gt;
                         childSensors = childrenSensors.remove(sensor);&lt;br/&gt;
+                        for (final Sensor parent : sensor.parents()) {&lt;br/&gt;
+                            final List&amp;lt;Sensor&amp;gt; peers = childrenSensors.get(parent);&lt;br/&gt;
+                            if (peers != null) &lt;/p&gt;
{
+                                peers.remove(sensor);
+                            }
&lt;p&gt;+                        }&lt;br/&gt;
                     }&lt;br/&gt;
                 }&lt;br/&gt;
             }&lt;br/&gt;
diff --git a/clients/src/main/java/org/apache/kafka/common/metrics/Sensor.java b/clients/src/main/java/org/apache/kafka/common/metrics/Sensor.java&lt;br/&gt;
index ae331e7b40e..47f3fbaa019 100644&lt;br/&gt;
&amp;#8212; a/clients/src/main/java/org/apache/kafka/common/metrics/Sensor.java&lt;br/&gt;
+++ b/clients/src/main/java/org/apache/kafka/common/metrics/Sensor.java&lt;br/&gt;
@@ -22,13 +22,15 @@&lt;br/&gt;
 import org.apache.kafka.common.utils.Utils;&lt;/p&gt;

&lt;p&gt; import java.util.ArrayList;&lt;br/&gt;
-import java.util.Collections;&lt;br/&gt;
 import java.util.HashSet;&lt;br/&gt;
 import java.util.List;&lt;br/&gt;
 import java.util.Locale;&lt;br/&gt;
 import java.util.Set;&lt;br/&gt;
 import java.util.concurrent.TimeUnit;&lt;/p&gt;

&lt;p&gt;+import static java.util.Arrays.asList;&lt;br/&gt;
+import static java.util.Collections.unmodifiableList;&lt;br/&gt;
+&lt;br/&gt;
 /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;A sensor applies a continuous sequence of numerical values to a set of associated metrics. For example a sensor on&lt;/li&gt;
	&lt;li&gt;message size would record a sequence of message sizes using the 
{@link #record(double)}
&lt;p&gt; api and would maintain a set&lt;br/&gt;
@@ -132,6 +134,10 @@ public String name() &lt;/p&gt;
{
         return this.name;
     }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;+    List&amp;lt;Sensor&amp;gt; parents() &lt;/p&gt;
{
+        return unmodifiableList(asList(parents));
+    }
&lt;p&gt;+&lt;br/&gt;
     /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Record an occurrence, this is just short-hand for 
{@link #record(double) record(1.0)}
&lt;p&gt;      */&lt;br/&gt;
@@ -266,6 +272,6 @@ public boolean hasExpired() {&lt;br/&gt;
     }&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     synchronized List&amp;lt;KafkaMetric&amp;gt; metrics() &lt;/p&gt;
{
-        return Collections.unmodifiableList(this.metrics);
+        return unmodifiableList(this.metrics);
     }
&lt;p&gt; }&lt;br/&gt;
diff --git a/clients/src/test/java/org/apache/kafka/common/metrics/MetricsTest.java b/clients/src/test/java/org/apache/kafka/common/metrics/MetricsTest.java&lt;br/&gt;
index 0904a414dbe..1a0efa396bf 100644&lt;br/&gt;
&amp;#8212; a/clients/src/test/java/org/apache/kafka/common/metrics/MetricsTest.java&lt;br/&gt;
+++ b/clients/src/test/java/org/apache/kafka/common/metrics/MetricsTest.java&lt;br/&gt;
@@ -16,6 +16,8 @@&lt;br/&gt;
  */&lt;br/&gt;
 package org.apache.kafka.common.metrics;&lt;/p&gt;

&lt;p&gt;+import static java.util.Collections.emptyList;&lt;br/&gt;
+import static java.util.Collections.singletonList;&lt;br/&gt;
 import static org.junit.Assert.assertEquals;&lt;br/&gt;
 import static org.junit.Assert.assertFalse;&lt;br/&gt;
 import static org.junit.Assert.assertNotNull;&lt;br/&gt;
@@ -173,6 +175,20 @@ public void testBadSensorHierarchy() &lt;/p&gt;
{
         metrics.sensor(&quot;gc&quot;, c1, c2); // should fail
     }

&lt;p&gt;+    @Test&lt;br/&gt;
+    public void testRemoveChildSensor() &lt;/p&gt;
{
+        final Metrics metrics = new Metrics();
+
+        final Sensor parent = metrics.sensor(&quot;parent&quot;);
+        final Sensor child = metrics.sensor(&quot;child&quot;, parent);
+
+        assertEquals(singletonList(child), metrics.childrenSensors().get(parent));
+
+        metrics.removeSensor(&quot;child&quot;);
+
+        assertEquals(emptyList(), metrics.childrenSensors().get(parent));
+    }
&lt;p&gt;+&lt;br/&gt;
     @Test&lt;br/&gt;
     public void testRemoveSensor() {&lt;br/&gt;
         int size = metrics.metrics().size();&lt;br/&gt;
diff --git a/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamsMetricsImpl.java b/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamsMetricsImpl.java&lt;br/&gt;
index 7f269e04c4c..7871ec4b3a8 100644&lt;br/&gt;
&amp;#8212; a/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamsMetricsImpl.java&lt;br/&gt;
+++ b/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamsMetricsImpl.java&lt;br/&gt;
@@ -209,14 +209,13 @@ public void measureLatencyNs(final Time time, final Runnable action, final Senso&lt;br/&gt;
      */&lt;br/&gt;
     @Override&lt;br/&gt;
     public void removeSensor(Sensor sensor) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Sensor parent = null;&lt;br/&gt;
         Objects.requireNonNull(sensor, &quot;Sensor is null&quot;);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         metrics.removeSensor(sensor.name());&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;parent = parentSensors.get(sensor);&lt;br/&gt;
+&lt;br/&gt;
+        final Sensor parent = parentSensors.remove(sensor);&lt;br/&gt;
         if (parent != null) 
{
             metrics.removeSensor(parent.name());
-            parentSensors.remove(sensor);
         }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     }&lt;br/&gt;
diff --git a/streams/src/test/java/org/apache/kafka/streams/processor/internals/StreamsMetricsImplTest.java b/streams/src/test/java/org/apache/kafka/streams/processor/internals/StreamsMetricsImplTest.java&lt;br/&gt;
index 0f91ae15529..7f1684104d9 100644&lt;br/&gt;
&amp;#8212; a/streams/src/test/java/org/apache/kafka/streams/processor/internals/StreamsMetricsImplTest.java&lt;br/&gt;
+++ b/streams/src/test/java/org/apache/kafka/streams/processor/internals/StreamsMetricsImplTest.java&lt;br/&gt;
@@ -22,7 +22,6 @@&lt;br/&gt;
 import org.apache.kafka.common.metrics.KafkaMetric;&lt;br/&gt;
 import org.apache.kafka.common.metrics.Metrics;&lt;br/&gt;
 import org.apache.kafka.common.metrics.Sensor;&lt;br/&gt;
-import org.junit.Assert;&lt;br/&gt;
 import org.junit.Test;&lt;/p&gt;

&lt;p&gt; import java.util.Collections;&lt;br/&gt;
@@ -30,6 +29,7 @@&lt;br/&gt;
 import java.util.LinkedHashMap;&lt;br/&gt;
 import java.util.Map;&lt;/p&gt;

&lt;p&gt;+import static java.util.Collections.unmodifiableMap;&lt;br/&gt;
 import static org.junit.Assert.assertEquals;&lt;/p&gt;

&lt;p&gt; public class StreamsMetricsImplTest {&lt;br/&gt;
@@ -58,26 +58,26 @@ public void testRemoveSensor() &lt;/p&gt;
{
         String operation = &quot;put&quot;;
         Map&amp;lt;String, String&amp;gt; tags = new HashMap&amp;lt;&amp;gt;();
         final Metrics metrics = new Metrics();
-        final Map&amp;lt;MetricName, KafkaMetric&amp;gt; initialMetrics = Collections.unmodifiableMap(new LinkedHashMap&amp;lt;&amp;gt;(metrics.metrics()));
+        final Map&amp;lt;MetricName, KafkaMetric&amp;gt; initialMetrics = unmodifiableMap(new LinkedHashMap&amp;lt;&amp;gt;(metrics.metrics()));
         StreamsMetricsImpl streamsMetrics = new StreamsMetricsImpl(metrics, groupName, tags);
 
         Sensor sensor1 = streamsMetrics.addSensor(sensorName, Sensor.RecordingLevel.DEBUG);
         streamsMetrics.removeSensor(sensor1);
-        Assert.assertEquals(initialMetrics, metrics.metrics());
+        assertEquals(initialMetrics, metrics.metrics());
 
         Sensor sensor1a = streamsMetrics.addSensor(sensorName, Sensor.RecordingLevel.DEBUG, sensor1);
         streamsMetrics.removeSensor(sensor1a);
-        Assert.assertEquals(initialMetrics, metrics.metrics());
+        assertEquals(initialMetrics, metrics.metrics());
 
         Sensor sensor2 = streamsMetrics.addLatencyAndThroughputSensor(scope, entity, operation, Sensor.RecordingLevel.DEBUG);
         streamsMetrics.removeSensor(sensor2);
-        Assert.assertEquals(initialMetrics, metrics.metrics());
+        assertEquals(initialMetrics, metrics.metrics());
 
         Sensor sensor3 = streamsMetrics.addThroughputSensor(scope, entity, operation, Sensor.RecordingLevel.DEBUG);
         streamsMetrics.removeSensor(sensor3);
-        Assert.assertEquals(initialMetrics, metrics.metrics());
+        assertEquals(initialMetrics, metrics.metrics());
 
-        Assert.assertEquals(Collections.emptyMap(), streamsMetrics.parentSensors);
+        assertEquals(Collections.emptyMap(), streamsMetrics.parentSensors);
     }

&lt;p&gt;     @Test&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16710843" author="githubbot" created="Thu, 6 Dec 2018 01:18:11 +0000"  >&lt;p&gt;mjsax closed pull request #5984: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7660&quot; title=&quot;Stream Metrics - Memory Analysis&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7660&quot;&gt;&lt;del&gt;KAFKA-7660&lt;/del&gt;&lt;/a&gt;: fix streams and Metrics memory leaks&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5984&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5984&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/clients/src/main/java/org/apache/kafka/common/metrics/Metrics.java b/clients/src/main/java/org/apache/kafka/common/metrics/Metrics.java&lt;br/&gt;
index 512c18e74ac..874c172acf5 100644&lt;br/&gt;
&amp;#8212; a/clients/src/main/java/org/apache/kafka/common/metrics/Metrics.java&lt;br/&gt;
+++ b/clients/src/main/java/org/apache/kafka/common/metrics/Metrics.java&lt;br/&gt;
@@ -367,6 +367,12 @@ public void removeSensor(String name) {&lt;br/&gt;
                             removeMetric(metric.metricName());&lt;br/&gt;
                         log.debug(&quot;Removed sensor with name {}&quot;, name);&lt;br/&gt;
                         childSensors = childrenSensors.remove(sensor);&lt;br/&gt;
+                        for (final Sensor parent : sensor.parents()) {&lt;br/&gt;
+                            final List&amp;lt;Sensor&amp;gt; peers = childrenSensors.get(parent);&lt;br/&gt;
+                            if (peers != null) &lt;/p&gt;
{
+                                peers.remove(sensor);
+                            }
&lt;p&gt;+                        }&lt;br/&gt;
                     }&lt;br/&gt;
                 }&lt;br/&gt;
             }&lt;br/&gt;
diff --git a/clients/src/main/java/org/apache/kafka/common/metrics/Sensor.java b/clients/src/main/java/org/apache/kafka/common/metrics/Sensor.java&lt;br/&gt;
index 4a9b488d1c5..33829f9f5a0 100644&lt;br/&gt;
&amp;#8212; a/clients/src/main/java/org/apache/kafka/common/metrics/Sensor.java&lt;br/&gt;
+++ b/clients/src/main/java/org/apache/kafka/common/metrics/Sensor.java&lt;br/&gt;
@@ -18,13 +18,15 @@&lt;br/&gt;
 import org.apache.kafka.common.utils.Utils;&lt;/p&gt;

&lt;p&gt; import java.util.ArrayList;&lt;br/&gt;
-import java.util.Collections;&lt;br/&gt;
 import java.util.HashSet;&lt;br/&gt;
 import java.util.List;&lt;br/&gt;
 import java.util.Locale;&lt;br/&gt;
 import java.util.Set;&lt;br/&gt;
 import java.util.concurrent.TimeUnit;&lt;/p&gt;

&lt;p&gt;+import static java.util.Arrays.asList;&lt;br/&gt;
+import static java.util.Collections.unmodifiableList;&lt;br/&gt;
+&lt;br/&gt;
 /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;A sensor applies a continuous sequence of numerical values to a set of associated metrics. For example a sensor on&lt;/li&gt;
	&lt;li&gt;message size would record a sequence of message sizes using the 
{@link #record(double)}
&lt;p&gt; api and would maintain a set&lt;br/&gt;
@@ -128,6 +130,10 @@ public String name() &lt;/p&gt;
{
         return this.name;
     }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;+    List&amp;lt;Sensor&amp;gt; parents() &lt;/p&gt;
{
+        return unmodifiableList(asList(parents));
+    }
&lt;p&gt;+&lt;br/&gt;
     /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Record an occurrence, this is just short-hand for 
{@link #record(double) record(1.0)}
&lt;p&gt;      */&lt;br/&gt;
@@ -260,6 +266,6 @@ public boolean hasExpired() {&lt;br/&gt;
     }&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     synchronized List&amp;lt;KafkaMetric&amp;gt; metrics() &lt;/p&gt;
{
-        return Collections.unmodifiableList(this.metrics);
+        return unmodifiableList(this.metrics);
     }
&lt;p&gt; }&lt;br/&gt;
diff --git a/clients/src/test/java/org/apache/kafka/common/metrics/MetricsTest.java b/clients/src/test/java/org/apache/kafka/common/metrics/MetricsTest.java&lt;br/&gt;
index 5797b369758..5ee79de81f2 100644&lt;br/&gt;
&amp;#8212; a/clients/src/test/java/org/apache/kafka/common/metrics/MetricsTest.java&lt;br/&gt;
+++ b/clients/src/test/java/org/apache/kafka/common/metrics/MetricsTest.java&lt;br/&gt;
@@ -12,6 +12,8 @@&lt;br/&gt;
  */&lt;br/&gt;
 package org.apache.kafka.common.metrics;&lt;/p&gt;

&lt;p&gt;+import static java.util.Collections.emptyList;&lt;br/&gt;
+import static java.util.Collections.singletonList;&lt;br/&gt;
 import static org.junit.Assert.assertEquals;&lt;br/&gt;
 import static org.junit.Assert.assertFalse;&lt;br/&gt;
 import static org.junit.Assert.assertNotNull;&lt;br/&gt;
@@ -169,6 +171,20 @@ public void testBadSensorHierarchy() &lt;/p&gt;
{
         metrics.sensor(&quot;gc&quot;, c1, c2); // should fail
     }

&lt;p&gt;+    @Test&lt;br/&gt;
+    public void testRemoveChildSensor() &lt;/p&gt;
{
+        final Metrics metrics = new Metrics();
+
+        final Sensor parent = metrics.sensor(&quot;parent&quot;);
+        final Sensor child = metrics.sensor(&quot;child&quot;, parent);
+
+        assertEquals(singletonList(child), metrics.childrenSensors().get(parent));
+
+        metrics.removeSensor(&quot;child&quot;);
+
+        assertEquals(emptyList(), metrics.childrenSensors().get(parent));
+    }
&lt;p&gt;+&lt;br/&gt;
     @Test&lt;br/&gt;
     public void testRemoveSensor() {&lt;br/&gt;
         int size = metrics.metrics().size();&lt;br/&gt;
diff --git a/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamsMetricsImpl.java b/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamsMetricsImpl.java&lt;br/&gt;
index bccf736d0a8..93748826720 100644&lt;br/&gt;
&amp;#8212; a/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamsMetricsImpl.java&lt;br/&gt;
+++ b/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamsMetricsImpl.java&lt;br/&gt;
@@ -196,11 +196,11 @@ public void measureLatencyNs(final Time time, final Runnable action, final Senso&lt;br/&gt;
      */&lt;br/&gt;
     @Override&lt;br/&gt;
     public void removeSensor(Sensor sensor) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Sensor parent = null;&lt;br/&gt;
         Objects.requireNonNull(sensor, &quot;Sensor is null&quot;);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         metrics.removeSensor(sensor.name());&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;parent = parentSensors.get(sensor);&lt;br/&gt;
+&lt;br/&gt;
+        final Sensor parent = parentSensors.remove(sensor);&lt;br/&gt;
         if (parent != null) 
{
             metrics.removeSensor(parent.name());
         }
&lt;p&gt;diff --git a/streams/src/test/java/org/apache/kafka/streams/processor/internals/StreamsMetricsImplTest.java b/streams/src/test/java/org/apache/kafka/streams/processor/internals/StreamsMetricsImplTest.java&lt;br/&gt;
index c6bc2508f2d..42b48ecc87a 100644&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/streams/src/test/java/org/apache/kafka/streams/processor/internals/StreamsMetricsImplTest.java&lt;br/&gt;
+++ b/streams/src/test/java/org/apache/kafka/streams/processor/internals/StreamsMetricsImplTest.java&lt;br/&gt;
@@ -19,13 +19,17 @@&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; import org.apache.kafka.common.Metric;&lt;br/&gt;
 import org.apache.kafka.common.MetricName;&lt;br/&gt;
+import org.apache.kafka.common.metrics.KafkaMetric;&lt;br/&gt;
 import org.apache.kafka.common.metrics.Metrics;&lt;br/&gt;
 import org.apache.kafka.common.metrics.Sensor;&lt;br/&gt;
 import org.junit.Test;&lt;/p&gt;

&lt;p&gt; import java.util.HashMap;&lt;br/&gt;
+import java.util.LinkedHashMap;&lt;br/&gt;
 import java.util.Map;&lt;/p&gt;

&lt;p&gt;+import static java.util.Collections.emptyMap;&lt;br/&gt;
+import static java.util.Collections.unmodifiableMap;&lt;br/&gt;
 import static org.junit.Assert.assertEquals;&lt;/p&gt;

&lt;p&gt; public class StreamsMetricsImplTest {&lt;br/&gt;
@@ -53,19 +57,27 @@ public void testRemoveSensor() &lt;/p&gt;
{
         String entity = &quot;entity&quot;;
         String operation = &quot;put&quot;;
         Map&amp;lt;String, String&amp;gt; tags = new HashMap&amp;lt;&amp;gt;();
-        StreamsMetricsImpl streamsMetrics = new StreamsMetricsImpl(new Metrics(), groupName, tags);
+        final Metrics metrics = new Metrics();
+        final Map&amp;lt;MetricName, KafkaMetric&amp;gt; initialMetrics = unmodifiableMap(new LinkedHashMap&amp;lt;&amp;gt;(metrics.metrics()));
+        StreamsMetricsImpl streamsMetrics = new StreamsMetricsImpl(metrics, groupName, tags);
 
         Sensor sensor1 = streamsMetrics.addSensor(sensorName, Sensor.RecordingLevel.DEBUG);
         streamsMetrics.removeSensor(sensor1);
+        assertEquals(initialMetrics, metrics.metrics());
 
         Sensor sensor1a = streamsMetrics.addSensor(sensorName, Sensor.RecordingLevel.DEBUG, sensor1);
         streamsMetrics.removeSensor(sensor1a);
+        assertEquals(initialMetrics, metrics.metrics());
 
         Sensor sensor2 = streamsMetrics.addLatencyAndThroughputSensor(scope, entity, operation, Sensor.RecordingLevel.DEBUG);
         streamsMetrics.removeSensor(sensor2);
+        assertEquals(initialMetrics, metrics.metrics());
 
         Sensor sensor3 = streamsMetrics.addThroughputSensor(scope, entity, operation, Sensor.RecordingLevel.DEBUG);
         streamsMetrics.removeSensor(sensor3);
+        assertEquals(initialMetrics, metrics.metrics());
+
+        assertEquals(emptyMap(), streamsMetrics.parentSensors);
     }

&lt;p&gt;     @Test&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12948860" name="Mem_Collections.jpeg" size="226859" author="pkleindl" created="Tue, 20 Nov 2018 11:42:27 +0000"/>
                            <attachment id="12948859" name="Mem_DuplicateStrings.jpeg" size="331421" author="pkleindl" created="Tue, 20 Nov 2018 11:42:27 +0000"/>
                            <attachment id="12948858" name="Mem_DuplicateStrings2.jpeg" size="918810" author="pkleindl" created="Tue, 20 Nov 2018 11:42:27 +0000"/>
                            <attachment id="12948857" name="Mem_Hotspots.jpeg" size="260390" author="pkleindl" created="Tue, 20 Nov 2018 11:42:27 +0000"/>
                            <attachment id="12948856" name="Mem_KeepAliveSet.jpeg" size="502918" author="pkleindl" created="Tue, 20 Nov 2018 11:42:27 +0000"/>
                            <attachment id="12948855" name="Mem_References.jpeg" size="1264526" author="pkleindl" created="Tue, 20 Nov 2018 11:42:28 +0000"/>
                            <attachment id="12949897" name="heapdump-1543441898901.hprof" size="15744802" author="pkleindl" created="Wed, 28 Nov 2018 21:58:59 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>7.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 49 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|s00p34:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>