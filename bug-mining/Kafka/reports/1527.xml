<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:01:46 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-5236] Regression in on-disk log size when using Snappy compression with 0.8.2 log message format</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-5236</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;We recently upgraded our brokers in our production environments from 0.10.1.1 to 0.10.2.1 and we&apos;ve noticed a sizable regression in the on-disk .log file size. For some deployments the increase was as much as 50%.&lt;/p&gt;

&lt;p&gt;We run our brokers with the 0.8.2 log message format version. The majority of our message volume comes from 0.10.x Java clients sending messages encoded with the Snappy codec.&lt;/p&gt;

&lt;p&gt;Some initial testing only shows a regression between the two versions when using Snappy compression with a log message format of 0.8.2.&lt;/p&gt;

&lt;p&gt;I also tested 0.10.x log message formats as well as Gzip compression. The log sizes do not differ in this case, so the issue seems confined to 0.8.2 message format and Snappy compression.&lt;/p&gt;

&lt;p&gt;A git-bisect lead me to this commit, which modified the server-side implementation of `Record`:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/kafka/commit/67f1e5b91bf073151ff57d5d656693e385726697&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/commit/67f1e5b91bf073151ff57d5d656693e385726697&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Here&apos;s the PR, which has more context:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/kafka/pull/2140&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2140&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Here is a link to the test I used to re-producer this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/nicktrav/kafka/commit/68e8db4fa525e173651ac740edb270b0d90b8818&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/nicktrav/kafka/commit/68e8db4fa525e173651ac740edb270b0d90b8818&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;cc: &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hachikuji&quot; class=&quot;user-hover&quot; rel=&quot;hachikuji&quot;&gt;hachikuji&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=junrao&quot; class=&quot;user-hover&quot; rel=&quot;junrao&quot;&gt;junrao&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ijuma&quot; class=&quot;user-hover&quot; rel=&quot;ijuma&quot;&gt;ijuma&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; (tagged on original PR)&lt;/p&gt;</description>
                <environment></environment>
        <key id="13071849">KAFKA-5236</key>
            <summary>Regression in on-disk log size when using Snappy compression with 0.8.2 log message format</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ijuma">Ismael Juma</assignee>
                                    <reporter username="nickt">Nick Travers</reporter>
                        <labels>
                            <label>regression</label>
                    </labels>
                <created>Sun, 14 May 2017 21:21:07 +0000</created>
                <updated>Fri, 2 Jun 2017 21:15:55 +0000</updated>
                            <resolved>Fri, 2 Jun 2017 21:15:55 +0000</resolved>
                                    <version>0.10.2.1</version>
                                    <fixVersion>0.11.0.0</fixVersion>
                                    <component>core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16009863" author="ijuma" created="Sun, 14 May 2017 21:47:19 +0000"  >&lt;p&gt;Thanks for the report. The root cause is that the block size for Snappy was changed from 32 KB to 1 KB in the broker:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/kafka/pull/2140#discussion_r90383989&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2140#discussion_r90383989&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This is the same block size used by the producer and with the 0.10.x format, the broker won&apos;t recompress the messages in the common case.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5148&quot; title=&quot;Add configurable compression block size to the broker&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-5148&quot;&gt;KAFKA-5148&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3704&quot; title=&quot;Improve mechanism for compression stream block size selection in KafkaProducer&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3704&quot;&gt;KAFKA-3704&lt;/a&gt; are related. We should probably use the default block size by default (32 KB) in both broker and producer and allow the block size to be configurable as per those JIRAs.&lt;/p&gt;</comment>
                            <comment id="16034453" author="githubbot" created="Fri, 2 Jun 2017 10:17:50 +0000"  >&lt;p&gt;GitHub user ijuma opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/3205&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3205&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5236&quot; title=&quot;Regression in on-disk log size when using Snappy compression with 0.8.2 log message format&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-5236&quot;&gt;&lt;del&gt;KAFKA-5236&lt;/del&gt;&lt;/a&gt;; Increase the block/buffer size when compressing with Snappy and Gzip&lt;/p&gt;

&lt;p&gt;    We had originally increased Snappy&#8217;s block size as part of &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3704&quot; title=&quot;Improve mechanism for compression stream block size selection in KafkaProducer&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3704&quot;&gt;KAFKA-3704&lt;/a&gt;. However,&lt;br/&gt;
    we had some issues with excessive memory usage in the producer and we reverted&lt;br/&gt;
    it in 7c6ee8d5e.&lt;/p&gt;

&lt;p&gt;    After more investigation, we fixed the underlying reason why memory usage seemed&lt;br/&gt;
    to grow much more than expected in &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3747&quot; title=&quot;Close `RecordBatch.records` when append to batch fails&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3747&quot;&gt;&lt;del&gt;KAFKA-3747&lt;/del&gt;&lt;/a&gt; (included in 0.10.0.1).&lt;/p&gt;

&lt;p&gt;    In 0.10.2, we changed the broker to use the same classes as the producer and the&lt;br/&gt;
    broker&#8217;s block size for Snappy was changed from 32 KB to 1KB. As reported in&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5236&quot; title=&quot;Regression in on-disk log size when using Snappy compression with 0.8.2 log message format&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-5236&quot;&gt;&lt;del&gt;KAFKA-5236&lt;/del&gt;&lt;/a&gt;, the on disk size is, in some cases, 50% larger when the data is compressed&lt;br/&gt;
    with 1 KB instead of 32 KB as the block size.&lt;/p&gt;

&lt;p&gt;    As discussed in &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3704&quot; title=&quot;Improve mechanism for compression stream block size selection in KafkaProducer&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3704&quot;&gt;KAFKA-3704&lt;/a&gt;, it may be worth making this configurable and/or allocate&lt;br/&gt;
    the compression buffers from the producer pool. However, for 0.11.0.0, I think the&lt;br/&gt;
    simplest thing to do is to default to 32 KB for Snappy (the default if no block size&lt;br/&gt;
    is provided).&lt;/p&gt;

&lt;p&gt;    I also increased the Gzip buffer size. 1 KB is too small and the default is smaller&lt;br/&gt;
    still (512 bytes). 8 KB (which is the default buffer size for BufferedOutputStream)&lt;br/&gt;
    seemed like a reasonable default.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/ijuma/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/ijuma/kafka&lt;/a&gt; kafka-5236-snappy-block-size&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/3205.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3205.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #3205&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit ef4af6757575e694c109074b67e59704ff437b56&lt;br/&gt;
Author: Ismael Juma &amp;lt;ismael@juma.me.uk&amp;gt;&lt;br/&gt;
Date:   2017-06-02T10:17:23Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5236&quot; title=&quot;Regression in on-disk log size when using Snappy compression with 0.8.2 log message format&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-5236&quot;&gt;&lt;del&gt;KAFKA-5236&lt;/del&gt;&lt;/a&gt;; Increase the block/buffer size when compressing with Snappy and Gzip&lt;/p&gt;

&lt;p&gt;    We had originally increased Snappy&#8217;s block size as part of &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3704&quot; title=&quot;Improve mechanism for compression stream block size selection in KafkaProducer&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3704&quot;&gt;KAFKA-3704&lt;/a&gt;. However,&lt;br/&gt;
    we had some issues with excessive memory usage in the producer and we reverted&lt;br/&gt;
    it in 7c6ee8d5e.&lt;/p&gt;

&lt;p&gt;    After more investigation, we fixed the underlying reason why memory usage seemed&lt;br/&gt;
    to grow much more than expected in &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3747&quot; title=&quot;Close `RecordBatch.records` when append to batch fails&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3747&quot;&gt;&lt;del&gt;KAFKA-3747&lt;/del&gt;&lt;/a&gt; (included in 0.10.0.1).&lt;/p&gt;

&lt;p&gt;    In 0.10.2, we changed the broker to use the same classes as the producer and the&lt;br/&gt;
    broker&#8217;s block size for Snappy was changed from 32 KB to 1KB. As reported in&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5236&quot; title=&quot;Regression in on-disk log size when using Snappy compression with 0.8.2 log message format&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-5236&quot;&gt;&lt;del&gt;KAFKA-5236&lt;/del&gt;&lt;/a&gt;, the on disk size is, in some cases, 50% larger when the data is compressed&lt;br/&gt;
    with 1 KB instead of 32 KB as the block size.&lt;/p&gt;

&lt;p&gt;    As discussed in &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3704&quot; title=&quot;Improve mechanism for compression stream block size selection in KafkaProducer&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3704&quot;&gt;KAFKA-3704&lt;/a&gt;, it may be worth making this configurable and/or allocate&lt;br/&gt;
    the compression buffers from the producer pool. However, for 0.11.0.0, I think the&lt;br/&gt;
    simplest thing to do is to default to 32 KB for Snappy (the default if no block size&lt;br/&gt;
    is provided).&lt;/p&gt;

&lt;p&gt;    I also increased the Gzip buffer size. 1 KB is too small and the default is smaller&lt;br/&gt;
    still (512 bytes). 8 KB (which is the default buffer size for BufferedOutputStream)&lt;br/&gt;
    seemed like a reasonable default.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16035353" author="githubbot" created="Fri, 2 Jun 2017 20:21:15 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/3205&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3205&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16035404" author="nickt" created="Fri, 2 Jun 2017 20:51:05 +0000"  >&lt;p&gt;Thanks for the patch &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ijuma&quot; class=&quot;user-hover&quot; rel=&quot;ijuma&quot;&gt;ijuma&lt;/a&gt;! I ran the same tests I used originally and confirmed that there was no regression in the on-disk size.&lt;/p&gt;</comment>
                            <comment id="16035417" author="ijuma" created="Fri, 2 Jun 2017 21:03:24 +0000"  >&lt;p&gt;Thanks for verifying &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nickt&quot; class=&quot;user-hover&quot; rel=&quot;nickt&quot;&gt;nickt&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="16035434" author="ijuma" created="Fri, 2 Jun 2017 21:15:55 +0000"  >&lt;p&gt;Issue resolved by pull request 3205&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/kafka/pull/3205&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3205&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12959296">KAFKA-3565</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13068176">KAFKA-5148</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 24 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3eyav:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>