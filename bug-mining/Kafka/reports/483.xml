<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:40:54 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-1503] all partitions are using same broker as their leader after broker is down</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-1503</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;The current leader selection always pick the first live broker in ISR when the current leader broker is down. Since the list of liveBrokerInIsr is not evenly distributed. As time goes on, all the partitions will use only one broker as its leader. &lt;/p&gt;

&lt;p&gt;I figured out a fix which is to use the first live broker in replica list which is also in ISR list. Since the liveAssignedReplicas is evenly distributed across brokers, all the partitions will be evenly distributed in the live brokers in ISR.&lt;br/&gt;
The fix is:&lt;br/&gt;
kafka-0.8.1.1-src/core/src/main/scala/kafka/controller/PartitionLeaderSelector.scala&lt;/p&gt;


&lt;p&gt;71	71&lt;br/&gt;
           case false =&amp;gt;&lt;br/&gt;
72	 &lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;val newLeader = liveBrokersInIsr.head&lt;br/&gt;
 	72&lt;br/&gt;
+            val liveReplicasInIsr = liveAssignedReplicas.filter(r =&amp;gt; liveBrokersInIsr.contains(r))&lt;br/&gt;
 	73&lt;br/&gt;
+            val newLeader = liveReplicasInIsr.head&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment>0.8.1.1 </environment>
        <key id="12722850">KAFKA-1503</key>
            <summary>all partitions are using same broker as their leader after broker is down</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jackiewang518">Jianwen Wang</assignee>
                                    <reporter username="jackiewang518">Jianwen Wang</reporter>
                        <labels>
                            <label>patch</label>
                    </labels>
                <created>Fri, 20 Jun 2014 19:02:55 +0000</created>
                <updated>Thu, 3 Jul 2014 04:56:59 +0000</updated>
                            <resolved>Thu, 3 Jul 2014 04:56:59 +0000</resolved>
                                    <version>0.8.0</version>
                    <version>0.8.1.1</version>
                                    <fixVersion>0.8.2.0</fixVersion>
                                    <component>controller</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14039394" author="guozhang" created="Fri, 20 Jun 2014 21:34:52 +0000"  >&lt;p&gt;Hello Jianwen,&lt;/p&gt;

&lt;p&gt;Controller does always pick the first alive broker in the ISR list to be the leader, but since our partition assignment logic is round robin, such that if you have three partitions, three brokers, and a replication factor of three, then you should see the ISR lists are&lt;/p&gt;

&lt;p&gt;partition1:   ISR &lt;/p&gt;
{broker-1, broker-2, broker-3}
&lt;p&gt;partition1:   ISR &lt;/p&gt;
{broker-2, broker-3, broker-1}
&lt;p&gt;partition1:   ISR &lt;/p&gt;
{broker-3, broker-1, broker-2}

&lt;p&gt;So the leader should still be distributed evenly.&lt;/p&gt;</comment>
                            <comment id="14039417" author="jackiewang518" created="Fri, 20 Jun 2014 21:49:52 +0000"  >&lt;p&gt;Hi Guozhang,&lt;br/&gt;
   That is not what I experienced in my real cluster environment:&lt;br/&gt;
   Given a cluster contains three brokers, when all brokers are live and running, and there is a topic with 10 partitions:&lt;br/&gt;
   I just made a query on my cluster and got the topic info as below right now:&lt;/p&gt;

&lt;p&gt;   root@kafka-1:~/kafka-0.8.1.1-src# bin/kafka-topics.sh --zookeeper localhost:2181 --topic ruby-p10 --describe&lt;br/&gt;
Topic:ruby-p10	PartitionCount:10	ReplicationFactor:3	Configs:&lt;br/&gt;
	Topic: ruby-p10	Partition: 0	Leader: 2	Replicas: 1,2,3	Isr: 2,1,3&lt;br/&gt;
	Topic: ruby-p10	Partition: 1	Leader: 2	Replicas: 2,3,1	Isr: 2,1,3&lt;br/&gt;
	Topic: ruby-p10	Partition: 2	Leader: 3	Replicas: 3,1,2	Isr: 2,1,3&lt;br/&gt;
	Topic: ruby-p10	Partition: 3	Leader: 1	Replicas: 1,3,2	Isr: 2,1,3&lt;br/&gt;
	Topic: ruby-p10	Partition: 4	Leader: 2	Replicas: 2,1,3	Isr: 2,1,3&lt;br/&gt;
	Topic: ruby-p10	Partition: 5	Leader: 3	Replicas: 3,2,1	Isr: 2,1,3&lt;br/&gt;
	Topic: ruby-p10	Partition: 6	Leader: 2	Replicas: 1,2,3	Isr: 2,1,3&lt;br/&gt;
	Topic: ruby-p10	Partition: 7	Leader: 2	Replicas: 2,3,1	Isr: 2,1,3&lt;br/&gt;
	Topic: ruby-p10	Partition: 8	Leader: 3	Replicas: 3,1,2	Isr: 2,1,3&lt;br/&gt;
	Topic: ruby-p10	Partition: 9	Leader: 1	Replicas: 1,3,2	Isr: 2,1,3&lt;/p&gt;


&lt;p&gt;As you can see the ISR is not evenly distributed, and since current codes always pick the first one. So if broker 1 is down, partition hosted by broker 1 will be changed to be broker 2 instead of evenly distributed to broker 2 and broker 3.&lt;/p&gt;

&lt;p&gt;As times goes on, all the partition will be only hosted on one broker.&lt;/p&gt;</comment>
                            <comment id="14039422" author="jackiewang518" created="Fri, 20 Jun 2014 21:53:28 +0000"  >&lt;p&gt;One way to break this loop is to turn on &quot;auto.leader.rebalance.enable=true&quot;. But the cluster still will be imbalance between two auto rebalances(I used 60 seconds as the interval).&lt;br/&gt;
The fix I provided is to make sure the partitions are even distributed within the live brokers between two auto rebalances.&lt;/p&gt;</comment>
                            <comment id="14039424" author="jackiewang518" created="Fri, 20 Jun 2014 21:55:01 +0000"  >&lt;p&gt;Also, I experienced another issue is that auto rebalance sometime does not work for very long time and leave the imbalance (all partition on one broker) for hours. I will file a separate ticket for that.&lt;/p&gt;</comment>
                            <comment id="14039460" author="guozhang" created="Fri, 20 Jun 2014 22:23:11 +0000"  >&lt;p&gt;Hi Jianwen,&lt;/p&gt;

&lt;p&gt;When the topic is firstly created, the leaders should be balanced. Then when there is, say a soft failure on some brokers, its leading partitions will be migrated to others, and even when this broker resumes these partitions will not be migrated back, causing imbalance. And this is probably what you saw before.&lt;/p&gt;

&lt;p&gt;Previously we do rebalance using the partition-reassignment-tool from time to time, then we created the auto-rebalance tool to ease this problem. Unfortunately there is an issue with this tool and we are currently fixing it:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-1305&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-1305&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The fix should be released soon with 0.8.2, will that fully-working tool solve your issue then?&lt;/p&gt;</comment>
                            <comment id="14039487" author="jackiewang518" created="Fri, 20 Jun 2014 22:42:35 +0000"  >&lt;p&gt;Hi Guozhang,&lt;br/&gt;
   The fully working auto rebalance will surely break that imbalance loop. But I like to have a fix to make sure the leader is evenly distributed within live brokers between two rebalances after one broker is down. As you can see, if the auto rebalance interval is set to 5 minutes, the imbalance case (all partitions on one broker) will stay for &amp;lt;= 5 minutes.&lt;/p&gt;

&lt;p&gt;   The fix I provided is to solve that particular case.&lt;/p&gt;

&lt;p&gt;   Thanks.&lt;/p&gt;

&lt;p&gt;-jianwen&lt;/p&gt;</comment>
                            <comment id="14039502" author="guozhang" created="Fri, 20 Jun 2014 22:55:43 +0000"  >&lt;p&gt;Cool, could you upload your patch as a file that is appliable to trunk?&lt;/p&gt;</comment>
                            <comment id="14040960" author="jackiewang518" created="Mon, 23 Jun 2014 16:56:26 +0000"  >&lt;p&gt;The first live broker in ISR was used as new leader. Since&lt;br/&gt;
 the order of liveBrokersInIsr list is not event distributed within live&lt;br/&gt;
 brokers, all partitions will be hosted on one broker as time goes on.&lt;/p&gt;

&lt;p&gt;Now use the first live replica broker in ISR (liveAssignedReplicas filtered by liveBrokersInIsr) as the replica order is strictly evenly distributed.&lt;/p&gt;</comment>
                            <comment id="14044879" author="guozhang" created="Thu, 26 Jun 2014 17:12:48 +0000"  >&lt;p&gt;Looks good to me. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=junrao&quot; class=&quot;user-hover&quot; rel=&quot;junrao&quot;&gt;junrao&lt;/a&gt; Could you take a look at this?&lt;/p&gt;</comment>
                            <comment id="14051064" author="junrao" created="Thu, 3 Jul 2014 04:56:59 +0000"  >&lt;p&gt;Thanks for the patch. It&apos;s a nice fix! +1 and committed to trunk.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12651996" name="kafka1503.patch" size="2253" author="jackiewang518" created="Mon, 23 Jun 2014 16:57:40 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>401037</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 20 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1x167:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>401121</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>