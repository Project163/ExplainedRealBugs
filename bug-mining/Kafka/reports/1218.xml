<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:56:43 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-4253] Fix Kafka Stream thread shutting down process ordering</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-4253</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Currently we close the stream thread in the following way:&lt;/p&gt;

&lt;p&gt;0. Commit all tasks.&lt;br/&gt;
1. Close producer.&lt;br/&gt;
2. Close consumer.&lt;br/&gt;
3. Close restore consumer.&lt;br/&gt;
4. For each task, close its topology processors one-by-one following the topology order by calling &lt;tt&gt;processor.close()&lt;/tt&gt;.&lt;br/&gt;
5. For each task, close its state manager as well as flushing and closing all its associated state stores.&lt;/p&gt;

&lt;p&gt;We choose to close the producer / consumer clients before shutting down the tasks because we need to make sure all sent records has been acked so that we have the right log-end-offset when closing the store and checkpointing the offset of the changelog. However there is also an issue with this ordering, in which users choose to write more records in their &lt;tt&gt;processor.close()&lt;/tt&gt; calls, this will cause RTE since the producers has already been closed, and no changelog records will be able to write.&lt;/p&gt;

&lt;p&gt;Thinking about this issue, a more appropriate ordering will be:&lt;/p&gt;

&lt;p&gt;1. For each task, close their topology processors following the topology order by calling &lt;tt&gt;processor.close()&lt;/tt&gt;.&lt;br/&gt;
2. For each task, commit its state by calling &lt;tt&gt;task.commit()&lt;/tt&gt;. At this time all sent records should be acked since &lt;tt&gt;producer.flush()&lt;/tt&gt; is called.&lt;br/&gt;
3. For each task, close their &lt;tt&gt;ProcessorStateManager&lt;/tt&gt;.&lt;br/&gt;
4. Close all embedded clients, i.e. producer / consumer / restore consumer.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13009715">KAFKA-4253</key>
            <summary>Fix Kafka Stream thread shutting down process ordering</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="damianguy">Damian Guy</assignee>
                                    <reporter username="guozhang">Guozhang Wang</reporter>
                        <labels>
                    </labels>
                <created>Tue, 4 Oct 2016 22:18:06 +0000</created>
                <updated>Sat, 8 Oct 2016 15:18:29 +0000</updated>
                            <resolved>Thu, 6 Oct 2016 16:44:12 +0000</resolved>
                                    <version>0.10.1.0</version>
                                    <fixVersion>0.10.1.0</fixVersion>
                    <fixVersion>0.10.2.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15548284" author="githubbot" created="Wed, 5 Oct 2016 10:08:27 +0000"  >&lt;p&gt;GitHub user dguy opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/1970&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/1970&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-4253&quot; title=&quot;Fix Kafka Stream thread shutting down process ordering&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-4253&quot;&gt;&lt;del&gt;KAFKA-4253&lt;/del&gt;&lt;/a&gt;: Fix Kafka Stream thread shutting down process ordering&lt;/p&gt;

&lt;p&gt;    Changed the ordering in `StreamThread.shutdown`&lt;br/&gt;
    1. commitAll (we need to commit so that any cached data is flushed through the topology)&lt;br/&gt;
    2. close all tasks&lt;br/&gt;
    3. producer.flush() - so any records produced during close are flushed and we have offsets for them&lt;br/&gt;
    4. close all state managers&lt;br/&gt;
    5. close producers/consumers&lt;br/&gt;
    6. remove the tasks&lt;/p&gt;

&lt;p&gt;    Also in `onPartitionsRevoked`&lt;br/&gt;
    1. commitAll&lt;br/&gt;
    2. close all tasks&lt;br/&gt;
    3. producer.flush&lt;br/&gt;
    4. close all state managers&lt;/p&gt;


&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/dguy/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/dguy/kafka&lt;/a&gt; kafka-4253&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/1970.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/1970.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #1970&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit d52e8de5fefac51c9eb59a9c965bc17dcd3aa3bc&lt;br/&gt;
Author: Damian Guy &amp;lt;damian.guy@gmail.com&amp;gt;&lt;br/&gt;
Date:   2016-10-05T10:03:21Z&lt;/p&gt;

&lt;p&gt;    change shutdown order&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15552444" author="guozhang" created="Thu, 6 Oct 2016 16:44:12 +0000"  >&lt;p&gt;Issue resolved by pull request 1970&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/kafka/pull/1970&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/1970&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15552447" author="githubbot" created="Thu, 6 Oct 2016 16:44:24 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/1970&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/1970&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 6 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i34g1r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>