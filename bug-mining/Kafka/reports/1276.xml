<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:57:53 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-4205] NullPointerException in fetchOffsetsBefore</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-4205</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;We recently observed the following error in brokers running 0.9.0.1:&lt;/p&gt;

&lt;p&gt;A client saw an Unkown error code in response to an offset request for TOPICX, partition 0&lt;/p&gt;

&lt;p&gt;The server logs look like:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;[2016-09-21 21:26:07,143] INFO Scheduling log segment 527235760 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; log TOPICX-0 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; deletion. (kafka.log.Log)
[2016-09-21 21:26:07,144] ERROR [KafkaApi-13] Error &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; responding to offset request (kafka.server.KafkaApis)
java.lang.NullPointerException
        at kafka.server.KafkaApis.fetchOffsetsBefore(KafkaApis.scala:513)
        at kafka.server.KafkaApis.fetchOffsets(KafkaApis.scala:501)
        at kafka.server.KafkaApis$$anonfun$18.apply(KafkaApis.scala:461)
        at kafka.server.KafkaApis$$anonfun$18.apply(KafkaApis.scala:452)
        at scala.collection.TraversableLike$$anonfun$map$1.apply(TraversableLike.scala:244)
        at scala.collection.TraversableLike$$anonfun$map$1.apply(TraversableLike.scala:244)
        at scala.collection.immutable.Map$Map1.foreach(Map.scala:109)
        at scala.collection.TraversableLike$&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;map(TraversableLike.scala:244)
        at scala.collection.AbstractTraversable.map(Traversable.scala:105)
        at kafka.server.KafkaApis.handleOffsetRequest(KafkaApis.scala:452)
        at kafka.server.KafkaApis.handle(KafkaApis.scala:70)
        at kafka.server.KafkaRequestHandler.run(KafkaRequestHandler.scala:60)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
[2016-09-21 21:27:07,143] INFO Deleting segment 527235760 from log TOPICX-0. (kafka.log.Log)
[2016-09-21 21:27:07,263] INFO Deleting index /path/to/kafka/data/TOPICX-0/00000000000527235760.index.deleted (kafka.log.OffsetIndex)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I suspect a race condition between &lt;tt&gt;Log.deleteSegment&lt;/tt&gt; (which takes a lock on the log) and &lt;tt&gt;KafkaApis.fetchOffsetsBefore&lt;/tt&gt;, which does not take any lock. In particular, line 513 in KafkaApis looks like:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;KafkaApis.scala&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;510  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; def fetchOffsetsBefore(log: Log, timestamp: &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;, maxNumOffsets: Int): Seq[&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;] = {
511    val segsArray = log.logSegments.toArray
512    &lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; offsetTimeArray: Array[(&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;)] = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
513    val lastSegmentHasSize = segsArray.last.size &amp;gt; 0;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13006866">KAFKA-4205</key>
            <summary>NullPointerException in fetchOffsetsBefore</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ataraxer">Anton Karamanov</assignee>
                                    <reporter username="agrasso">Andrew Grasso</reporter>
                        <labels>
                            <label>reliability</label>
                    </labels>
                <created>Thu, 22 Sep 2016 15:44:29 +0000</created>
                <updated>Sun, 4 Dec 2016 19:35:17 +0000</updated>
                            <resolved>Sun, 4 Dec 2016 19:35:17 +0000</resolved>
                                    <version>0.9.0.1</version>
                                    <fixVersion>0.10.1.1</fixVersion>
                                    <component>core</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="15715179" author="aozeritsky" created="Fri, 2 Dec 2016 13:52:42 +0000"  >&lt;p&gt;We see this on 0.10.1. ~20-30 errors per day on every broker&lt;/p&gt;</comment>
                            <comment id="15715235" author="ijuma" created="Fri, 2 Dec 2016 14:16:41 +0000"  >&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=becket_qin&quot; class=&quot;user-hover&quot; rel=&quot;becket_qin&quot;&gt;becket_qin&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hachikuji&quot; class=&quot;user-hover&quot; rel=&quot;hachikuji&quot;&gt;hachikuji&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15715331" author="githubbot" created="Fri, 2 Dec 2016 14:55:35 +0000"  >&lt;p&gt;GitHub user ataraxer opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/2204&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2204&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-4205&quot; title=&quot;NullPointerException in fetchOffsetsBefore&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-4205&quot;&gt;&lt;del&gt;KAFKA-4205&lt;/del&gt;&lt;/a&gt;; KafkaApis: fix NPE caused by conversion to array&lt;/p&gt;

&lt;p&gt;    NPE was caused by `log.logSegments.toArray` resulting in array containing `null` values. The exact reason still remains somewhat a mystery to me, but it seems that the culprit is `JavaConverters` in combination with concurrent data structure access.&lt;/p&gt;

&lt;p&gt;    Here&apos;s a simple code example to prove that:&lt;br/&gt;
    ```scala&lt;br/&gt;
    import java.util.concurrent.ConcurrentSkipListMap&lt;br/&gt;
    // Same as `JavaConversions`, but allows explicit conversions via `asScala`/`asJava` methods.&lt;br/&gt;
    import scala.collection.JavaConverters._&lt;/p&gt;

&lt;p&gt;    case object Value&lt;br/&gt;
    val m = new ConcurrentSkipListMap&lt;span class=&quot;error&quot;&gt;&amp;#91;Int, Value.type&amp;#93;&lt;/span&gt;&lt;br/&gt;
    new Thread { override def run() = &lt;/p&gt;
{ while (true) m.put(9000, Value) }
&lt;p&gt; }.start()&lt;br/&gt;
    new Thread { override def run() = &lt;/p&gt;
{ while (true) m.remove(9000) }
&lt;p&gt; }.start()&lt;br/&gt;
    new Thread { override def run() = { while (true) &lt;/p&gt;
{ println(m.values.asScala.toArray.headOption) }
&lt;p&gt; } }.start()&lt;br/&gt;
    ```&lt;/p&gt;

&lt;p&gt;    Running the example will occasionally print `Some(null)` indicating that there&apos;s something shady going on during `toArray` conversion.&lt;/p&gt;

&lt;p&gt;    `null`s magically disappear by making the following change:&lt;br/&gt;
    ```diff&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;println(m.values.asScala.toArray.headOption)&lt;br/&gt;
    + println(m.values.asScala.toSeq.headOption)&lt;br/&gt;
    ```&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/ataraxer/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/ataraxer/kafka&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-4205&quot; title=&quot;NullPointerException in fetchOffsetsBefore&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-4205&quot;&gt;&lt;del&gt;KAFKA-4205&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/2204.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2204.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #2204&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit bcd32760015e9dfd564813076a07dbe1612eab00&lt;br/&gt;
Author: Anton Karamanov &amp;lt;ataraxer@yandex-team.ru&amp;gt;&lt;br/&gt;
Date:   2016-12-02T14:37:42Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-4205&quot; title=&quot;NullPointerException in fetchOffsetsBefore&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-4205&quot;&gt;&lt;del&gt;KAFKA-4205&lt;/del&gt;&lt;/a&gt;; KafkaApis: fix NPE caused by conversion to array&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15720401" author="githubbot" created="Sun, 4 Dec 2016 18:52:03 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/2204&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2204&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 50 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i33yhj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>