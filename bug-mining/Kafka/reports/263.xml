<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:38:01 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-861] IndexOutOfBoundsException while fetching data from leader</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-861</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;2013-04-09 16:36:50,051] ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;ReplicaFetcherThread-0-261&amp;#93;&lt;/span&gt;, Error due to  (kafka.server.ReplicaFetcherThread)&lt;br/&gt;
kafka.common.KafkaException: error processing data for topic firehoseUpdates partititon 14 offset 53531364&lt;br/&gt;
        at kafka.server.AbstractFetcherThread$$anonfun$processFetchRequest$4.apply(AbstractFetcherThread.scala:136)&lt;br/&gt;
        at kafka.server.AbstractFetcherThread$$anonfun$processFetchRequest$4.apply(AbstractFetcherThread.scala:113)&lt;br/&gt;
        at scala.collection.immutable.HashMap$HashMap1.foreach(HashMap.scala:125)&lt;br/&gt;
        at scala.collection.immutable.HashMap$HashTrieMap.foreach(HashMap.scala:344)&lt;br/&gt;
        at scala.collection.immutable.HashMap$HashTrieMap.foreach(HashMap.scala:344)&lt;br/&gt;
        at kafka.server.AbstractFetcherThread.processFetchRequest(AbstractFetcherThread.scala:113)&lt;br/&gt;
        at kafka.server.AbstractFetcherThread.doWork(AbstractFetcherThread.scala:89)&lt;br/&gt;
        at kafka.utils.ShutdownableThread.run(ShutdownableThread.scala:51)&lt;br/&gt;
Caused by: java.lang.IndexOutOfBoundsException&lt;br/&gt;
        at java.nio.Buffer.checkIndex(Buffer.java:512)&lt;br/&gt;
        at java.nio.HeapByteBuffer.get(HeapByteBuffer.java:121)&lt;br/&gt;
        at kafka.message.Message.compressionCodec(Message.scala:202)&lt;br/&gt;
        at kafka.message.ByteBufferMessageSet$$anon$1.makeNextOuter(ByteBufferMessageSet.scala:174)&lt;br/&gt;
        at kafka.message.ByteBufferMessageSet$$anon$1.makeNext(ByteBufferMessageSet.scala:197)&lt;br/&gt;
        at kafka.message.ByteBufferMessageSet$$anon$1.makeNext(ByteBufferMessageSet.scala:145)&lt;br/&gt;
        at kafka.utils.IteratorTemplate.maybeComputeNext(IteratorTemplate.scala:61)&lt;br/&gt;
        at kafka.utils.IteratorTemplate.hasNext(IteratorTemplate.scala:53)&lt;br/&gt;
        at scala.collection.IterableLike$class.isEmpty(IterableLike.scala:92)&lt;br/&gt;
        at kafka.message.MessageSet.isEmpty(MessageSet.scala:67)&lt;br/&gt;
        at scala.collection.TraversableLike$class.lastOption(TraversableLike.scala:512)&lt;br/&gt;
        at kafka.message.MessageSet.lastOption(MessageSet.scala:67)&lt;/p&gt;</description>
                <environment></environment>
        <key id="12641925">KAFKA-861</key>
            <summary>IndexOutOfBoundsException while fetching data from leader</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sriramsub">Sriram</assignee>
                                    <reporter username="sriramsub">Sriram</reporter>
                        <labels>
                    </labels>
                <created>Wed, 10 Apr 2013 21:20:12 +0000</created>
                <updated>Tue, 16 Apr 2013 01:12:55 +0000</updated>
                            <resolved>Tue, 16 Apr 2013 01:12:55 +0000</resolved>
                                    <version>0.8.0</version>
                                    <fixVersion>0.8.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13629410" author="sriramsub" created="Thu, 11 Apr 2013 21:23:42 +0000"  >&lt;p&gt;This happens when an existing follower becomes the new leader and the current leader starts following the new leader. &lt;/p&gt;

&lt;p&gt;The existing follower closes the fetcher thread and transitions to become a leader&lt;br/&gt;
The current leader truncates its log to high water mark and starts following the new leader&lt;/p&gt;

&lt;p&gt;The messageset that is received by the old follower during this transition contains only zero bytes. When we try to iterate through this messageset, we fail and throw the above exception.&lt;/p&gt;

&lt;p&gt;What causes these zero bytes to be present in the messageset? It looks like when the old leader truncated its log, it was also trying to send bytes to the follower. These bytes were outside the truncated region. Somehow, the bytes after the highwatermark all became zeros. &lt;/p&gt;

&lt;p&gt;It turns out that in jdk 1.6 there is a bug in truncateTo that truncates the file but does not update the postion of the file. This is fixed in kafka by explicitly setting the position after the truncate call. However, a simple program below verifies that reading the file channel after the truncated region (without setting the position) is totally fine and does not return any bytes&lt;/p&gt;

&lt;p&gt;1.&lt;br/&gt;
    // create a channel for a file&lt;br/&gt;
    val path = &quot;/home/myid/outfile1&quot;&lt;br/&gt;
    val fileAccess = new RandomAccessFile(path, &quot;rw&quot;)&lt;br/&gt;
    val fc = fileAccess.getChannel&lt;/p&gt;

&lt;p&gt;2. &lt;br/&gt;
    // create random buffer&lt;br/&gt;
    val b = ByteBuffer.allocate(100)&lt;br/&gt;
    new Random().nextBytes(b.array())&lt;/p&gt;

&lt;p&gt;    // write the buffer to the channel&lt;br/&gt;
    fc.write(b)&lt;br/&gt;
    var pos = fc.position() // position is 100&lt;br/&gt;
    var size = fc.size() // size is 100&lt;/p&gt;

&lt;p&gt;3.&lt;br/&gt;
    // truncate the channel&lt;br/&gt;
    fc.truncate(50)&lt;br/&gt;
    size = fc.size() // size is 50&lt;br/&gt;
    pos = fc.position() // position is 100&lt;/p&gt;

&lt;p&gt;4. &lt;br/&gt;
    // transfer the truncated portition to a channel&lt;br/&gt;
    val path1 = &quot;/home/myid/outfile2&quot;&lt;br/&gt;
    val f2 = new RandomAccessFile(path1, &quot;rw&quot;)&lt;br/&gt;
    val fc1 = f2.getChannel&lt;br/&gt;
    val transferred = fc.transferTo(50, 50, fc1) // transferred is 0&lt;/p&gt;

&lt;p&gt;Further, if we add the 3&quot; step below after step 3 above, it can be seen that step 4 does return non zero bytes and they all contain 0 bytes.&lt;/p&gt;

&lt;p&gt;3&quot;&lt;/p&gt;

&lt;p&gt;   // write more bytes&lt;br/&gt;
    b.rewind()&lt;br/&gt;
    fc.write(b)&lt;br/&gt;
    pos = fc.position() // position is 200&lt;br/&gt;
    size = fc.size() // size is 200&lt;/p&gt;

&lt;p&gt;The code above shows that appending to a file without setting the position after truncate does expose the zero bytes to the reader. But in kafka, truncate/set position and append are all synchronized. This means we should not hit the issue above. &lt;/p&gt;

&lt;p&gt;This could mean there is a race condition in FileChannelImpl that could somehow cause this. The code snippet below from transferTo method from FileChannelImpl might explain what we see. &lt;/p&gt;

&lt;p&gt;        long sz = size();   &amp;#8211; &amp;gt; checks size. size() is synchronized with other FileChannelImpl methods&lt;br/&gt;
        if (position &amp;gt; sz)&lt;br/&gt;
            return 0; --&amp;gt; This is what is returned in step 4 above in the first case. The size is smaller than the position requested. However, truncate can happen after this line.&lt;br/&gt;
        int icount = (int)Math.min(count, Integer.MAX_VALUE);&lt;br/&gt;
        if ((sz - position) &amp;lt; icount)&lt;br/&gt;
            icount = (int)(sz - position);&lt;/p&gt;

&lt;p&gt;        long n;&lt;/p&gt;

&lt;p&gt;        // Attempt a direct transfer, if the kernel supports it&lt;br/&gt;
        if ((n = transferToDirectly(position, icount, target)) &amp;gt;= 0) // the size check above could have been good above but at this point the size is smaller than the requested &lt;br/&gt;
            return n;                                                                 // position. transferToDirectly calls transferTo0 which could just read the zero bytes written by truncate.&lt;/p&gt;


&lt;p&gt;Few open questions&lt;br/&gt;
1. Does truncate zero out the bytes synchronously or lazily? If it is lazy, we could also get junk bytes instead of zeros&lt;br/&gt;
2. How to fix it in kafka. One possible fix is to ensure that the MessageSet iterator throws invalid message when it encounters 0 byte size or if crc does not match the message. The follower can then try to refetch the offset for that topic partition or just fail (atleast we know the cause). &lt;/p&gt;



</comment>
                            <comment id="13632168" author="sriramsub" created="Mon, 15 Apr 2013 20:48:45 +0000"  >&lt;p&gt;Fixes the size = 0 in the iterator.The fetcher thread logs and does not update the offset and retries again in the next loop for that topic partition.&lt;/p&gt;</comment>
                            <comment id="13632390" author="junrao" created="Mon, 15 Apr 2013 23:56:06 +0000"  >&lt;p&gt;Thanks for the patch. A couple of comments:&lt;/p&gt;

&lt;p&gt;1. ByteBufferMessageSet: Instead of check for size &amp;lt;= 0, it&apos;s probably better to check for size &amp;lt; Message.MinHeaderSize.&lt;/p&gt;

&lt;p&gt;2. AbstractFetcher: Could we add a comment when we catch InvalidMessageException to explain the particular problem that we have seen and why refetching the data will likely solve the issue?&lt;/p&gt;</comment>
                            <comment id="13632409" author="nehanarkhede" created="Tue, 16 Apr 2013 00:17:55 +0000"  >&lt;p&gt;Thanks for the patch. Good catch!&lt;/p&gt;

&lt;p&gt;1. AbstractFetcherThread -&lt;br/&gt;
1.1 Let&apos;s change the logging to &quot;&lt;span class=&quot;error&quot;&gt;&amp;#91;%s,%d&amp;#93;&lt;/span&gt;&quot; for printing the topic partition. This is what most of the code is standardized upon right now. It will make it easier to grep through the logs.&lt;br/&gt;
1.2 While you&apos;re in there, do you mind fixing this typo - &quot;partititon&quot;&lt;/p&gt;

&lt;p&gt;2 ByteBufferMessageSet: +1 on Jun&apos;s suggestion above.&lt;/p&gt;
</comment>
                            <comment id="13632444" author="nehanarkhede" created="Tue, 16 Apr 2013 00:41:47 +0000"  >&lt;p&gt;+1 on v2&lt;/p&gt;</comment>
                            <comment id="13632461" author="junrao" created="Tue, 16 Apr 2013 01:12:55 +0000"  >&lt;p&gt;Thanks for patch v2. We should do &quot;size &amp;lt; Message.MinHeaderSize&quot; instead of &quot;size &amp;lt;= Message.MinHeaderSize&quot; in ByteBufferMessagesSet since it&apos;s possible to have a valid message whose size is exactly Message.MinHeaderSize. Committed to 0.8 with the change.&lt;/p&gt;

&lt;p&gt;Great investigation.&lt;/p&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12578846" name="KAFKA-861-v2.patch" size="5614" author="sriramsub" created="Tue, 16 Apr 2013 00:33:02 +0000"/>
                            <attachment id="12578813" name="KAFKA-861.patch" size="2628" author="sriramsub" created="Mon, 15 Apr 2013 20:48:45 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>322340</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 32 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1jm5r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>322685</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>