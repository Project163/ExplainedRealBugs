<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:40:49 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-17116] New consumer may not send effective leave group if member ID received after close </title>
                <link>https://issues.apache.org/jira/browse/KAFKA-17116</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;If the new consumer is closed after sending a HB to join, but before receiving the response to it, it will send a leave group request but without member ID (will simply fail with UNKNOWN_MEMBER_ID). This will make that the broker will have a registered new member, for which it will never receive a leave request for it.&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;consumer.subscribe -&amp;gt; sends HB to join, transitions to JOINING&lt;/li&gt;
	&lt;li&gt;consumer.close -&amp;gt; will transition to LEAVING and send HB with epoch -1 (without waiting for in-flight requests)&lt;/li&gt;
	&lt;li&gt;consumer receives response to initial HB, containing the assigned member ID. It will simply ignore it because it&apos;s not in the group anymore (UNSUBSCRIBED)&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Note that the expectation, with the current logic, and main downsides of this are:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;If the case was that the member received partitions on the first HB, those partitions won&apos;t be re-assigned (broker waiting for the closed consumer to reconcile them), until the rebalance timeout expires.&#160;&lt;/li&gt;
	&lt;li&gt;Even if no partitions were assigned to it, the member will remain in the group from the broker point of view (but not from the client POV). The member will be eventually kicked out for not sending HBs, but only when it&apos;s session timeout expires.&lt;/li&gt;
&lt;/ol&gt;
</description>
                <environment></environment>
        <key id="13585363">KAFKA-17116</key>
            <summary>New consumer may not send effective leave group if member ID received after close </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="frankvicky">TengYao Chi</assignee>
                                    <reporter username="lianetm">Lianet Magrans</reporter>
                        <labels>
                            <label>kip</label>
                            <label>kip-848-client-support</label>
                    </labels>
                <created>Wed, 10 Jul 2024 21:05:45 +0000</created>
                <updated>Thu, 12 Dec 2024 17:51:10 +0000</updated>
                            <resolved>Thu, 31 Oct 2024 19:03:21 +0000</resolved>
                                    <version>3.8.0</version>
                                    <fixVersion>4.0.0</fixVersion>
                                    <component>clients</component>
                    <component>consumer</component>
                    <component>group-coordinator</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>11</watches>
                                                                                                                <comments>
                            <comment id="17864841" author="JIRAUSER305181" created="Thu, 11 Jul 2024 00:01:05 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lianetm&quot; class=&quot;user-hover&quot; rel=&quot;lianetm&quot;&gt;lianetm&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;I would like to investigate this issue, may i have this one?&lt;/p&gt;

&lt;p&gt;Many thanks!&lt;/p&gt;</comment>
                            <comment id="17865543" author="JIRAUSER300183" created="Fri, 12 Jul 2024 16:57:35 +0000"  >&lt;p&gt;Sure, assigned to you &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=frankvicky&quot; class=&quot;user-hover&quot; rel=&quot;frankvicky&quot;&gt;frankvicky&lt;/a&gt;. Thanks for helping out! This is a tricky case I would say, let me know if you have any questions once you get into it (I&apos;ll think more about it and share whatever comes to mind).&#160;&lt;/p&gt;</comment>
                            <comment id="17866468" author="JIRAUSER305181" created="Tue, 16 Jul 2024 16:32:43 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lianetm&quot; class=&quot;user-hover&quot; rel=&quot;lianetm&quot;&gt;lianetm&lt;/a&gt;&#160;&lt;br/&gt;
I have do some research, here is my understanding:&lt;/p&gt;

&lt;p&gt;The root cause is that the broker receives the subscribe heartbeat and assigns a memberId to the consumer. However, the consumer sends a close heartbeat before receiving the assigned memberId. Consequently, the broker receives a close heartbeat with an invalid memberId (an empty string), making it unable to identify which consumer wants to leave. As a result, the broker has to wait until the heartbeat timeout to rebalance the group.&lt;/p&gt;
&lt;hr /&gt;
&lt;p&gt;I have simple idea which is to add a check at the &lt;tt&gt;heartbeatNow&lt;/tt&gt; stage to see if a memberId has already been assigned. Only if a memberId is present should a close heartbeat be sent.&lt;/p&gt;

&lt;p&gt;What do you think about this approach?&lt;/p&gt;

&lt;p&gt;Btw, &#160;I wonder if I could reproduce the issue on my machine. It doesn&apos;t seem that easy to do. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/tongue.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="17866563" author="JIRAUSER305181" created="Wed, 17 Jul 2024 00:00:03 +0000"  >&lt;p&gt;Oh, I forget that close heartbeat only send once &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/warning.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17867763" author="JIRAUSER300183" created="Mon, 22 Jul 2024 14:07:14 +0000"  >&lt;p&gt;Hey &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=frankvicky&quot; class=&quot;user-hover&quot; rel=&quot;frankvicky&quot;&gt;frankvicky&lt;/a&gt; , sorry I missed this comment.&lt;/p&gt;

&lt;p&gt;Your suggestion of the simple approach sounds good to me, to be explored. Given that the issue is that we don&apos;t want to send the leave request if we don&apos;t have a member id yet, we could consider:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;skip HB if leaving but no member ID (note the skip concept, I refer to getting the same behaviour as when shouldSkipHeartbeat=true but in the the case of state ==LEAVING and memberId==null. With the skip we ensure that it won&apos;t wait the full HB interval to check again)&lt;/li&gt;
	&lt;li&gt;this means that it may stay LEAVING for several poll cycles, until it gets a member ID. But still, the leave request will only be sent out once, as usual.&#160;&lt;/li&gt;
	&lt;li&gt;we should review the potential interactions (ex. consumer tries to join again, while on this LEAVING that it&apos;s lingering for a bit waiting for a member ID). I expect they will be fine, just because we already consider all that may happen while LEAVING&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Just from the top of the my head, but if it works, it would be a simple approach so interesting.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17867801" author="chia7712" created="Mon, 22 Jul 2024 16:52:16 +0000"  >&lt;p&gt;The close is invoked by users and the close needs to honor the timeout, so what if consumer can&apos;t get response to see memberId in time? &lt;/p&gt;

&lt;p&gt;1) &lt;br/&gt;
If we decide to wait for the response to send LEAVE request in closing, we need to update the docs of close(Duration) to explain this behavior: this close could get blocked until we get the response of member id.&lt;/p&gt;

&lt;p&gt;2) &lt;br/&gt;
If we decide to skip the LEAVE request due to user-defined timeout, then broker will have a registered new member&lt;/p&gt;

&lt;p&gt;It seems to me that is a trade-off. Either way will have side effect.  Maybe we should have a way to remove the registered member according to other fields. For example:&lt;/p&gt;

&lt;p&gt;1. consumer can add a tagged specific id to HB request and then consumer can use the specific id to remove registered member. the specific id is optional so it can keep compatibility. Also, the specific id is used only if consumer is closing and it can&apos;t wait for response of member id.&lt;br/&gt;
2. use other fields to generate &quot;unique&quot; id and broker can remove registered member when member id is -1. This does not change the protocol data, but not sure how to create a unique id by the other fields&lt;/p&gt;



</comment>
                            <comment id="17867928" author="JIRAUSER305181" created="Tue, 23 Jul 2024 02:39:01 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lianetm&quot; class=&quot;user-hover&quot; rel=&quot;lianetm&quot;&gt;lianetm&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;Currently, we use the ConsumerHeartbeat API to manage the join and leave processes of AsyncKafkaConsumer. I propose that we let the consumer generate a &lt;b&gt;unique&lt;/b&gt; temporary ID to be used for identification by the broker before member ID allocation.&lt;/p&gt;

&lt;p&gt;To achieve this, we need to add a new field in ConsumerHeartbeatRequestData to attach this ID.&lt;/p&gt;

&lt;p&gt;Once the broker receives the initial join heartbeat request, it can generate the member ID and put the temporary ID : member ID pair into a map that maintains the relationship between temporary IDs and member IDs.&lt;/p&gt;

&lt;p&gt;With this map, we can identify the leaving heartbeat request by temporary ID if we encounter the scenario described in the issue.&lt;/p&gt;

&lt;p&gt;If the consumer receives the allocated member ID normally, we can remove the temporary ID : member ID entry from the map to avoid memory leaks.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;This is still a very rough idea, what do you think ?&#160; &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="17867934" author="chia7712" created="Tue, 23 Jul 2024 03:04:36 +0000"  >&lt;blockquote&gt;
&lt;p&gt;Currently, we use the ConsumerHeartbeat API to manage the join and leave processes of AsyncKafkaConsumer. I propose that we let the consumer generate a unique temporary ID to be used for identification by the broker before member ID allocation.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;yes, we are on the same page. Let&apos;s extend this idea:&lt;/p&gt;

&lt;p&gt;1. this solution will be applied to `ConsumerGroupHeartbeatRequest` only to avoid large changes&lt;br/&gt;
2. the unique temporary ID is generated by (async) consumer&lt;br/&gt;
3. the unique temporary ID is &quot;tagged&quot; field so we don&apos;t need to bump version &lt;br/&gt;
4. the unique temporary ID is stored in `ModernGroupMember` as a optional field.&lt;br/&gt;
5. coordinator use the unique temporary ID to search member only if &quot;member id = unknown&quot; and &quot;group leave&quot; and &quot;temporary ID is defined&quot;. That ensures we don&apos;t run it regularly, and  we don&apos;t need to store a map for &amp;lt;temporaryId&amp;gt; -&amp;gt; &amp;lt;memberId&amp;gt;. Instead, we iterate all members of group to filter it out. That is OK because this scenario is rare (due to above conditions)&lt;/p&gt;

&lt;p&gt;With this new unique ID, consumer can send HB to leave group even if the response carrying member id is not returned. It can send HB with temporary ID to acknowledge the &quot;leave&quot;.&lt;/p&gt;</comment>
                            <comment id="17868077" author="JIRAUSER300183" created="Tue, 23 Jul 2024 13:52:52 +0000"  >&lt;p&gt;Hey all, very interesting conversation. The whole story of the member ID generation is indeed tricky and we have a gap while the member does not have it&apos;s member ID yet. We have discussed improvements like this temporary unique ID generated by clients, not only because of this leave case, but also the case where the response to an initial HB to join does not make it to the client (the client would keep sending HB to join and the broker would keep generating and registering new members).&lt;/p&gt;

&lt;p&gt;I remember that, while implementing the protocol, we considered this approach of a client-side temporary ID to be able to identify the member while it does not have a memberId assigned by the broker yet. Not sure if I&apos;m forgetting some downsides or other alternatives though. Do you &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dajac&quot; class=&quot;user-hover&quot; rel=&quot;dajac&quot;&gt;dajac&lt;/a&gt; have some other thoughts on this maybe? Thanks!&lt;/p&gt;</comment>
                            <comment id="17869371" author="dajac" created="Mon, 29 Jul 2024 14:34:33 +0000"  >&lt;p&gt;Hi all, I was thinking about two options to resolve this issue:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;We could actually generate the member id on the client side. This is already supported by the protocol. Back then, we rejected this option because it was considered too difficult for non java clients such as librdkafka as some languages do not have built-in uuid support. This may be better now. We can check this. We also need to convince ourselves that letting the client generate it is good enough.&lt;/li&gt;
	&lt;li&gt;We could use the first HB send out by the client to generate the uuid without adding the member to the group yet. So, the first HB would send back the new member id, zero as the member epoch as, zero as the heartbeat interval so the client HB immediately. This is basically a way to do 1. but without relying on the client to generate it. Note that this does not require any changes to the protocol too. An alternative to this would be to return a new error code to make it explicit but I am not sure if it is worth it.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;I am not a fan of the idea of passing a temporary ID on the client that we would store on the server. If we believe that we could generate an id on the client, we should just do 1.&lt;/p&gt;

&lt;p&gt;I think that we could also improve the client state machine to better handle those cases.&lt;/p&gt;</comment>
                            <comment id="17869396" author="chia7712" created="Mon, 29 Jul 2024 16:21:27 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dajac&quot; class=&quot;user-hover&quot; rel=&quot;dajac&quot;&gt;dajac&lt;/a&gt; thanks for sharing the idea and details.&lt;/p&gt;

&lt;p&gt;The basic idea is &quot;client needs to know/have the uuid before member is added to group&quot;. IMHO both solutions have pros and cons. However, the option_2: using the first HB to get UUID from server needs to deal with the compatibility, as the old server still add the member to the group when handling the first HB. that is to say, the client needs to distinguish whether this member id is added to group or not. otherwise, it may produces some weird log messages. By contrast, the option_1 is non-invasive since our server can handle HB with/without client-defined member id now. Also, the non-java client does not need to change any code if they don&apos;t care for this edge case. If they does care that edge case, python, golang, .net, and rust have built-in uuid support, and there are many UUID impl for c++ (uuid_v4, boost&apos;s uuid, and uuid_v4). Hence, I assume UUID support is not a big issue.&lt;/p&gt;
</comment>
                            <comment id="17869467" author="kirktrue" created="Mon, 29 Jul 2024 22:55:58 +0000"  >&lt;p&gt;My understanding is:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;This is an edge case&lt;/li&gt;
	&lt;li&gt;The broker contains logic to remove stale members&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;If the above two statements are true, what&apos;s the downside of letting the broker handle the member as it does today, namely removing it after some configured amount of time?&lt;/p&gt;

&lt;p&gt;I agree that it makes sense to augment the client logic to only send the &apos;leave group&apos; request if we have a member ID. At this point, I&apos;m -1 on the idea of introducing temporary IDs to handle edge cases like this.&lt;/p&gt;</comment>
                            <comment id="17869536" author="JIRAUSER305181" created="Tue, 30 Jul 2024 06:10:26 +0000"  >&lt;p&gt;Hello folks,&lt;/p&gt;

&lt;p&gt;This is a very interesting discussion, and I have learned a lot from it. The diverse perspectives shared here have been incredibly enlightening.&lt;/p&gt;

&lt;p&gt;In my opinion, I think option_1 is the easier solution for this issue. As &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chia7712&quot; class=&quot;user-hover&quot; rel=&quot;chia7712&quot;&gt;chia7712&lt;/a&gt; mentioned, it would be a challenge to deal with compatibility if we select option_2, and it also needs additional logic to distinguish the member state.&lt;br/&gt;
I&#8217;m also wondering if it is possible to achieve this without changing the protocol. I think an additional field might be necessary.&lt;/p&gt;

&lt;p&gt;The reason I support option_1 is that I have tried to implement a similar solution in the current &lt;a href=&quot;https://github.com/apache/kafka/pull/16649/commits/9ee0e4e747fc1e851d736b173fdf881f844ba888#diff-0986b8c04dc1682e67717eb5e4a513e36d5fb9a3ab5ff4b90dd7efcd9b105712&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;PR&lt;/a&gt;. Compared to option_2, the solution is quite simple, and it could be even simpler if we leverage `taggedFields` to send the temporary ID. In this way, we also don&#8217;t need to change the protocol. We only need to add some simple logic to handle the leave heartbeat without a correct memberId. The only concern will be the UUID generation from the client side (according to &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chia7712&quot; class=&quot;user-hover&quot; rel=&quot;chia7712&quot;&gt;chia7712&lt;/a&gt; , maybe this is not the case now).&lt;/p&gt;</comment>
                            <comment id="17869739" author="chia7712" created="Tue, 30 Jul 2024 19:21:32 +0000"  >&lt;blockquote&gt;
&lt;p&gt;If the above two statements are true, what&apos;s the downside of letting the broker handle the member as it does today, namely removing it after some configured amount of time?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;yes, tow statements are true! I quote &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lianetm&quot; class=&quot;user-hover&quot; rel=&quot;lianetm&quot;&gt;lianetm&lt;/a&gt;&apos;s comments &quot;those partitions won&apos;t be re-assigned (broker waiting for the closed consumer to reconcile them), until the rebalance timeout expires. &quot;&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;I agree that it makes sense to augment the client logic to only send the &apos;leave group&apos; request if we have a member ID. At this point, I&apos;m -1 on the idea of introducing temporary IDs to handle edge cases like this.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I also hate temporary ID after see the suggestions from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dajac&quot; class=&quot;user-hover&quot; rel=&quot;dajac&quot;&gt;dajac&lt;/a&gt; :smile&lt;/p&gt;

&lt;p&gt;Also, I don&apos;t want to introduce large changes to just fix the edge case. That is why I prefer the approach of letting `AsyncConsumer` generate UUID for member Id&lt;/p&gt;</comment>
                            <comment id="17869982" author="kirktrue" created="Wed, 31 Jul 2024 16:55:45 +0000"  >&lt;p&gt;&lt;font color=&quot;#172b4d&quot;&gt;For the sake of discussion, if we were to consciously ignore this case for now (and let the broker reassign the partitions after the timeout), do we have a sense of the actual impact to the user? I&apos;m wondering if this is an optimization that we can save for when we have empirical evidence to justify a specialized fix?&lt;/font&gt;&lt;/p&gt;</comment>
                            <comment id="17870006" author="chia7712" created="Wed, 31 Jul 2024 17:54:34 +0000"  >&lt;blockquote&gt;
&lt;p&gt;For the sake of discussion, if we were to consciously ignore this case for now (and let the broker reassign the partitions after the timeout), do we have a sense of the actual impact to the user? I&apos;m wondering if this is an optimization that we can save for when we have empirical evidence to justify a specialized fix?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;yep, that is a kind of optimization as it will be released after the timeout.  As it can block the re-balance, the main impact will be the throughput regression of read. Maybe we need more time to reach the consensus, but noted that there is already a PR for &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-17115&quot; title=&quot;Closing newly-created legacy consumers during rebalance can cause rebalances to hang&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-17115&quot;&gt;KAFKA-17115&lt;/a&gt;. IMHO, AsyncConsumer needs to have similar fix once &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-17115&quot; title=&quot;Closing newly-created legacy consumers during rebalance can cause rebalances to hang&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-17115&quot;&gt;KAFKA-17115&lt;/a&gt; gets resolved.&lt;/p&gt;</comment>
                            <comment id="17870581" author="dajac" created="Fri, 2 Aug 2024 16:07:39 +0000"  >&lt;p&gt;Thanks for the discussion and sorry for my late reply. I have had a busy week.&lt;/p&gt;

&lt;p&gt;I agree with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chia7712&quot; class=&quot;user-hover&quot; rel=&quot;chia7712&quot;&gt;chia7712&lt;/a&gt; that it is something worth fixing/improving.&lt;/p&gt;

&lt;p&gt;Overall, I think that it is clear for everyone that using temporary id is the least desired option. We can probably discard it.&lt;/p&gt;

&lt;p&gt;If we want to do the option 1 that I proposed, I think that we need to do a KIP for it in order to make it choice clear for all the folks implementing clients. I would also require a member id from version 2 of the request, etc, etc. We also need to discuss with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=emasab&quot; class=&quot;user-hover&quot; rel=&quot;emasab&quot;&gt;emasab&lt;/a&gt;. For this option, we basically need to convince ourselves that generating the member id on the client is safe from a collision point of view. There is actually another motivation to this change which is ever more important than this bug. At the moment, the first HB is not idempotent. If the member is created on the first request but the response is lost for some reasons, the client will retry the HB request and a new member will be created. If it happens multiple times, multiple &quot;ghosts&quot; members will be created and expired when their session timeout will expire. However, they will own partitions until they are expired. Generating the member id on the client would resolve this bigger issue.&lt;/p&gt;

&lt;p&gt;I also wanted to point out that the option 2 does not require any changes to the protocol. This option would also solve the issue that I just described.&lt;/p&gt;

&lt;p&gt;That being said, I wonder if we should keep this Jira focused on improving the state machine of the client. For instance, we could consider not sending the leave group if we are still in join group. This would ensure that we only send a leave group once the client has joined the group. What do you think?&lt;/p&gt;</comment>
                            <comment id="17870655" author="chia7712" created="Sat, 3 Aug 2024 01:52:00 +0000"  >&lt;p&gt;Sorry that I am on traveling. It is a little hard to have good format in jira by mobile &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;


&lt;p&gt;Yes, the &#8220;idempotent&#8221; is the cure to this issue. However, making first HB be idempotent (i.e generate member id only) is a kind of behavior changes. That means clients can&#8217;t assume the first HB will do the both &#8220;create member id&#8221; and &#8220;added to group&#8221;. I guess AsyncConsumer has to change some log message. Also, we have to update KIP-848. Not sure whether it needs to bump version as it is in preview.&lt;/p&gt;



&lt;p&gt;I agree that improvement. In order to make sure I don&#8217;t misunderstand the point: this improvement can&#8217;t fix the never-leave-member, right?&lt;/p&gt;</comment>
                            <comment id="17871997" author="dajac" created="Thu, 8 Aug 2024 13:15:06 +0000"  >&lt;p&gt;&amp;gt; I agree that improvement. In order to make sure I don&#8217;t misunderstand the point: this improvement can&#8217;t fix the never-leave-member, right?&lt;br/&gt;
&#160;&lt;br/&gt;
Correct. It does not entirely fix the issue.&lt;/p&gt;</comment>
                            <comment id="17872001" author="dajac" created="Thu, 8 Aug 2024 13:19:56 +0000"  >&lt;p&gt;At the moment, I lean towards option #1 &#8211; generating the member id on the client. I think that we should do a small KIP to make this choice explicit. KIP-848 is already to big and has been dragging for too long. I would also bump the version of the ConsumerGroupHeartbeat RPC to 1 (or whatever is next) to actually require the member id in all requests from this version. We would basically not support generating the member id on the server side anymore. This seems better than continuing to accept both if we believe that generating the member id on the server is not good in the end. Does it make sense? &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lianetm&quot; class=&quot;user-hover&quot; rel=&quot;lianetm&quot;&gt;lianetm&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chia7712&quot; class=&quot;user-hover&quot; rel=&quot;chia7712&quot;&gt;chia7712&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=emasab&quot; class=&quot;user-hover&quot; rel=&quot;emasab&quot;&gt;emasab&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=frankvicky&quot; class=&quot;user-hover&quot; rel=&quot;frankvicky&quot;&gt;frankvicky&lt;/a&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17872015" author="emasab" created="Thu, 8 Aug 2024 14:03:08 +0000"  >&lt;p&gt;What librdkafka is doing in this case is not sending the leave group HB if member id isn&apos;t set.&lt;br/&gt;
I&apos;m in favor of generating the member id as a UUIDv4 on the client given it makes joining the group an idempotent operation and allows to leave the group correctly and more easily. We have a function for generating a random UUIDv4, it&apos;s not a secure random UUID and the seed is &lt;em&gt;current_thread_id ^ current_milliseconds&lt;/em&gt;, but being a secure random isn&apos;t a requirement for this usage. We can change it to &lt;em&gt;current_thread_id ^ current_microseconds&lt;/em&gt; for a more random one&lt;/p&gt;</comment>
                            <comment id="17872030" author="chia7712" created="Thu, 8 Aug 2024 14:40:25 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=emasab&quot; class=&quot;user-hover&quot; rel=&quot;emasab&quot;&gt;emasab&lt;/a&gt; thanks for the sharing. That make us have confidence in client-side solution &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;We would basically not support generating the member id on the server side anymore. This seems better than continuing to accept both if we believe that generating the member id on the server is not good in the end. Does it make sense?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;agree to &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dajac&quot; class=&quot;user-hover&quot; rel=&quot;dajac&quot;&gt;dajac&lt;/a&gt;&apos;s conclusion. If there is no objections, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=frankvicky&quot; class=&quot;user-hover&quot; rel=&quot;frankvicky&quot;&gt;frankvicky&lt;/a&gt; and I will prepare the KIP to summarize all discussions.&lt;/p&gt;</comment>
                            <comment id="17872031" author="chia7712" created="Thu, 8 Aug 2024 14:41:29 +0000"  >&lt;p&gt;I bump the fix version to 4.0 in order to not block 3.9.0&lt;/p&gt;</comment>
                            <comment id="17872045" author="JIRAUSER305181" created="Thu, 8 Aug 2024 14:53:45 +0000"  >&lt;p&gt;Hello everyone,&lt;/p&gt;

&lt;p&gt;Thanks for the diverse perspectives during the discussion. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;I agree with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dajac&quot; class=&quot;user-hover&quot; rel=&quot;dajac&quot;&gt;dajac&lt;/a&gt; &apos;s conclusion. If there are no objections, I will start preparing the KIP.&lt;/p&gt;</comment>
                            <comment id="17890489" author="dajac" created="Thu, 17 Oct 2024 15:26:44 +0000"  >&lt;p&gt;Hey &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=frankvicky&quot; class=&quot;user-hover&quot; rel=&quot;frankvicky&quot;&gt;frankvicky&lt;/a&gt;. Do you plan to get KIP-1082 in AK 4.0? It would be great to have it. I can help with reviews, especially on the server side.&lt;/p&gt;</comment>
                            <comment id="17890502" author="JIRAUSER305181" created="Thu, 17 Oct 2024 16:07:23 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dajac&quot; class=&quot;user-hover&quot; rel=&quot;dajac&quot;&gt;dajac&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;Yes, I plan to get KIP-1082 into AK 4.0.&lt;br/&gt;
I&apos;m currently working on it and will file a PR soon.&lt;/p&gt;

&lt;p&gt;I really appreciate your help, and I&#8217;ll be sure to tag you once the PR is ready for review. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/biggrin.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/thumbs_up.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13585357">KAFKA-17115</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 3 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1q9iw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>