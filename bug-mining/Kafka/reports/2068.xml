<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:15:31 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-7462] Kafka brokers cannot provide OAuth without a token</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-7462</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Like with all other SASL mechanisms, OAUTHBEARER uses the same LoginModule class on both&#160; server-side and the client-side. But unlike PLAIN or SCRAM where client credentials are optional, OAUTHBEARER requires always requires a token. So while with PLAIN/SCRAM, broker only needs to specify client credentials if the mechanism is used for inter-broker communication, with OAuth, broker requires client credentials even if OAuth is not used for inter-broker communication. This is an issue with the default `OAuthBearerUnsecuredLoginCallbackHandler` used on both client-side and server-side. But more critically, it is an issue with `OAuthBearerLoginModule` which doesn&apos;t commit if token == null (commit() returns false).&lt;/p&gt;</description>
                <environment></environment>
        <key id="13188464">KAFKA-7462</key>
            <summary>Kafka brokers cannot provide OAuth without a token</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rsivaram">Rajini Sivaram</assignee>
                                    <reporter username="rsivaram">Rajini Sivaram</reporter>
                        <labels>
                    </labels>
                <created>Mon, 1 Oct 2018 08:24:13 +0000</created>
                <updated>Fri, 8 Sep 2023 18:34:53 +0000</updated>
                            <resolved>Mon, 8 Oct 2018 09:54:19 +0000</resolved>
                                    <version>2.0.0</version>
                                    <fixVersion>2.1.0</fixVersion>
                                    <component>security</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="16636936" author="githubbot" created="Wed, 3 Oct 2018 13:19:12 +0000"  >&lt;p&gt;rajinisivaram opened a new pull request #5733: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7462&quot; title=&quot;Kafka brokers cannot provide OAuth without a token&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7462&quot;&gt;&lt;del&gt;KAFKA-7462&lt;/del&gt;&lt;/a&gt;: Make token optional for OAuthBearerLoginModule&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5733&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5733&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   OAuthBearerLoginModule is used both on the server-side and client-side (similar to login modules for other mechanisms). OAUTHBEARER tokens are client credentials used only on the client-side to authenticate with servers, but the current implementation requires tokens to be provided on the server-side even if OAUTHBEARER is not used for inter-broker communication. Tokens should be optional for server-side login context to allow brokers to be configured without a token when OAUTHBEARER is not used for inter-broker communication.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16641568" author="githubbot" created="Mon, 8 Oct 2018 09:14:28 +0000"  >&lt;p&gt;rajinisivaram closed pull request #5733: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7462&quot; title=&quot;Kafka brokers cannot provide OAuth without a token&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7462&quot;&gt;&lt;del&gt;KAFKA-7462&lt;/del&gt;&lt;/a&gt;: Make token optional for OAuthBearerLoginModule&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5733&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5733&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/clients/src/main/java/org/apache/kafka/common/security/oauthbearer/OAuthBearerLoginModule.java b/clients/src/main/java/org/apache/kafka/common/security/oauthbearer/OAuthBearerLoginModule.java&lt;br/&gt;
index 1dcd1991aed..e3a78103560 100644&lt;br/&gt;
&amp;#8212; a/clients/src/main/java/org/apache/kafka/common/security/oauthbearer/OAuthBearerLoginModule.java&lt;br/&gt;
+++ b/clients/src/main/java/org/apache/kafka/common/security/oauthbearer/OAuthBearerLoginModule.java&lt;br/&gt;
@@ -236,6 +236,21 @@&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;@see SaslConfigs#SASL_LOGIN_REFRESH_BUFFER_SECONDS_DOC&lt;br/&gt;
  */&lt;br/&gt;
 public class OAuthBearerLoginModule implements LoginModule {&lt;br/&gt;
+&lt;br/&gt;
+    /**&lt;br/&gt;
+     * Login state transitions:&lt;br/&gt;
+     *   Initial state: NOT_LOGGED_IN&lt;br/&gt;
+     *   login()      : NOT_LOGGED_IN =&amp;gt; LOGGED_IN_NOT_COMMITTED&lt;br/&gt;
+     *   commit()     : LOGGED_IN_NOT_COMMITTED =&amp;gt; COMMITTED&lt;br/&gt;
+     *   abort()      : LOGGED_IN_NOT_COMMITTED =&amp;gt; NOT_LOGGED_IN&lt;br/&gt;
+     *   logout()     : Any state =&amp;gt; NOT_LOGGED_IN&lt;br/&gt;
+     */&lt;br/&gt;
+    private enum LoginState 
{
+        NOT_LOGGED_IN,
+        LOGGED_IN_NOT_COMMITTED,
+        COMMITTED
+    }
&lt;p&gt;+&lt;br/&gt;
     /**&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;The SASL Mechanism name for OAuth 2: 
{@code OAUTHBEARER}
&lt;p&gt;      */&lt;br/&gt;
@@ -248,6 +263,7 @@&lt;br/&gt;
     private OAuthBearerToken myCommittedToken = null;&lt;br/&gt;
     private SaslExtensions extensionsRequiringCommit = null;&lt;br/&gt;
     private SaslExtensions myCommittedExtensions = null;&lt;br/&gt;
+    private LoginState loginState;&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     static {&lt;br/&gt;
         OAuthBearerSaslClientProvider.initialize(); // not part of public API&lt;br/&gt;
@@ -266,17 +282,29 @@ public void initialize(Subject subject, CallbackHandler callbackHandler, Map&amp;lt;Str&lt;/p&gt;

&lt;p&gt;     @Override&lt;br/&gt;
     public boolean login() throws LoginException {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (tokenRequiringCommit != null)&lt;/li&gt;
	&lt;li&gt;throw new IllegalStateException(String.format(&lt;br/&gt;
+        if (loginState == LoginState.LOGGED_IN_NOT_COMMITTED) 
{
+            if (tokenRequiringCommit != null)
+                throw new IllegalStateException(String.format(
                     &quot;Already have an uncommitted token with private credential token count=%d&quot;, committedTokenCount()));
-        if (myCommittedToken != null)
-            throw new IllegalStateException(String.format(
+            else
+                throw new IllegalStateException(&quot;Already logged in without a token&quot;);
+        }
&lt;p&gt;+        if (loginState == LoginState.COMMITTED) &lt;/p&gt;
{
+            if (myCommittedToken != null)
+                throw new IllegalStateException(String.format(
                     &quot;Already have a committed token with private credential token count=%d; must login on another login context or logout here first before reusing the same login context&quot;,
                     committedTokenCount()));
+            else
+                throw new IllegalStateException(&quot;Login has already been committed without a token&quot;);
+        }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         identifyToken();&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;identifyExtensions();&lt;br/&gt;
+        if (tokenRequiringCommit != null)&lt;br/&gt;
+            identifyExtensions();&lt;br/&gt;
+        else&lt;br/&gt;
+            log.debug(&quot;Logged in without a token, this login cannot be used to establish client connections&quot;);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;+        loginState = LoginState.LOGGED_IN_NOT_COMMITTED;&lt;br/&gt;
         log.info(&quot;Login succeeded; invoke commit() to commit it; current committed token count={}&quot;,&lt;br/&gt;
                 committedTokenCount());&lt;br/&gt;
         return true;&lt;br/&gt;
@@ -292,7 +320,7 @@ private void identifyToken() throws LoginException {&lt;br/&gt;
         }&lt;/p&gt;

&lt;p&gt;         tokenRequiringCommit = tokenCallback.token();&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (tokenRequiringCommit == null) {&lt;br/&gt;
+        if (tokenCallback.errorCode() != null) {&lt;br/&gt;
             log.info(&quot;Login failed: {} : {} (URI={})&quot;, tokenCallback.errorCode(), tokenCallback.errorDescription(),&lt;br/&gt;
                     tokenCallback.errorUri());&lt;br/&gt;
             throw new LoginException(tokenCallback.errorDescription());&lt;br/&gt;
@@ -322,64 +350,77 @@ private void identifyExtensions() throws LoginException {&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     @Override&lt;br/&gt;
     public boolean logout() {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (tokenRequiringCommit != null)&lt;br/&gt;
+        if (loginState == LoginState.LOGGED_IN_NOT_COMMITTED)&lt;br/&gt;
             throw new IllegalStateException(&lt;br/&gt;
                     &quot;Cannot call logout() immediately after login(); need to first invoke commit() or abort()&quot;);&lt;/li&gt;
	&lt;li&gt;if (myCommittedToken == null) {&lt;br/&gt;
+        if (loginState != LoginState.COMMITTED) 
{
             if (log.isDebugEnabled())
                 log.debug(&quot;Nothing here to log out&quot;);
             return false;
         }&lt;/li&gt;
	&lt;li&gt;log.info(&quot;Logging out my token; current committed token count = {}&quot;, committedTokenCount());&lt;/li&gt;
	&lt;li&gt;for (Iterator&amp;lt;Object&amp;gt; iterator = subject.getPrivateCredentials().iterator(); iterator.hasNext()&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; {&lt;/li&gt;
	&lt;li&gt;Object privateCredential = iterator.next();&lt;/li&gt;
	&lt;li&gt;if (privateCredential == myCommittedToken) {&lt;/li&gt;
	&lt;li&gt;iterator.remove();&lt;/li&gt;
	&lt;li&gt;myCommittedToken = null;&lt;/li&gt;
	&lt;li&gt;break;&lt;br/&gt;
+        if (myCommittedToken != null) {&lt;br/&gt;
+            log.info(&quot;Logging out my token; current committed token count = {}&quot;, committedTokenCount());&lt;br/&gt;
+            for (Iterator&amp;lt;Object&amp;gt; iterator = subject.getPrivateCredentials().iterator(); iterator.hasNext(); ) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+                Object privateCredential = iterator.next();+                if (privateCredential == myCommittedToken) {
+                    iterator.remove();
+                    myCommittedToken = null;
+                    break;
+                }             }&lt;/span&gt; &lt;/div&gt;&lt;/li&gt;
	&lt;li&gt;}&lt;/li&gt;
	&lt;li&gt;log.info(&quot;Done logging out my token; committed token count is now {}&quot;, committedTokenCount());&lt;br/&gt;
+            log.info(&quot;Done logging out my token; committed token count is now {}&quot;, committedTokenCount());&lt;br/&gt;
+        } else&lt;br/&gt;
+            log.debug(&quot;No tokens to logout for this login&quot;);&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;log.info(&quot;Logging out my extensions&quot;);&lt;/li&gt;
	&lt;li&gt;if (subject.getPublicCredentials().removeIf(e -&amp;gt; myCommittedExtensions == e))&lt;/li&gt;
	&lt;li&gt;myCommittedExtensions = null;&lt;/li&gt;
	&lt;li&gt;log.info(&quot;Done logging out my extensions&quot;);&lt;br/&gt;
+        if (myCommittedExtensions != null) 
{
+            log.info(&quot;Logging out my extensions&quot;);
+            if (subject.getPublicCredentials().removeIf(e -&amp;gt; myCommittedExtensions == e))
+                myCommittedExtensions = null;
+            log.info(&quot;Done logging out my extensions&quot;);
+        }
&lt;p&gt; else&lt;br/&gt;
+            log.debug(&quot;No extensions to logout for this login&quot;);&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;+        loginState = LoginState.NOT_LOGGED_IN;&lt;br/&gt;
         return true;&lt;br/&gt;
     }&lt;/p&gt;

&lt;p&gt;     @Override&lt;br/&gt;
     public boolean commit() {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (tokenRequiringCommit == null) {&lt;br/&gt;
+        if (loginState != LoginState.LOGGED_IN_NOT_COMMITTED) 
{
             if (log.isDebugEnabled())
                 log.debug(&quot;Nothing here to commit&quot;);
             return false;
         }&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;log.info(&quot;Committing my token; current committed token count = {}&quot;, committedTokenCount());&lt;/li&gt;
	&lt;li&gt;subject.getPrivateCredentials().add(tokenRequiringCommit);&lt;/li&gt;
	&lt;li&gt;myCommittedToken = tokenRequiringCommit;&lt;/li&gt;
	&lt;li&gt;tokenRequiringCommit = null;&lt;/li&gt;
	&lt;li&gt;log.info(&quot;Done committing my token; committed token count is now {}&quot;, committedTokenCount());&lt;br/&gt;
+        if (tokenRequiringCommit != null) {&lt;br/&gt;
+            log.info(&quot;Committing my token; current committed token count = {}&quot;, committedTokenCount());&lt;br/&gt;
+            subject.getPrivateCredentials().add(tokenRequiringCommit);&lt;br/&gt;
+            myCommittedToken = tokenRequiringCommit;&lt;br/&gt;
+            tokenRequiringCommit = null;&lt;br/&gt;
+            log.info(&quot;Done committing my token; committed token count is now {}&quot;, committedTokenCount());&lt;br/&gt;
+        } else&lt;br/&gt;
+            log.debug(&quot;No tokens to commit, this login cannot be used to establish client connections&quot;);&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;subject.getPublicCredentials().add(extensionsRequiringCommit);&lt;/li&gt;
	&lt;li&gt;myCommittedExtensions = extensionsRequiringCommit;&lt;/li&gt;
	&lt;li&gt;extensionsRequiringCommit = null;&lt;br/&gt;
+        if (extensionsRequiringCommit != null) 
{
+            subject.getPublicCredentials().add(extensionsRequiringCommit);
+            myCommittedExtensions = extensionsRequiringCommit;
+            extensionsRequiringCommit = null;
+        }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;+        loginState = LoginState.COMMITTED;&lt;br/&gt;
         return true;&lt;br/&gt;
     }&lt;/p&gt;

&lt;p&gt;     @Override&lt;br/&gt;
     public boolean abort() {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (tokenRequiringCommit != null) {&lt;br/&gt;
+        if (loginState == LoginState.LOGGED_IN_NOT_COMMITTED) 
{
             log.info(&quot;Login aborted&quot;);
             tokenRequiringCommit = null;
             extensionsRequiringCommit = null;
+            loginState = LoginState.NOT_LOGGED_IN;
             return true;
         }&lt;/li&gt;
	&lt;li&gt;if (log.isDebugEnabled())&lt;/li&gt;
	&lt;li&gt;log.debug(&quot;Nothing here to abort&quot;);&lt;br/&gt;
+        log.debug(&quot;Nothing here to abort&quot;);&lt;br/&gt;
         return false;&lt;br/&gt;
     }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;diff --git a/clients/src/main/java/org/apache/kafka/common/security/oauthbearer/OAuthBearerTokenCallback.java b/clients/src/main/java/org/apache/kafka/common/security/oauthbearer/OAuthBearerTokenCallback.java&lt;br/&gt;
index 62ce492eb91..3f4f269606a 100644&lt;br/&gt;
&amp;#8212; a/clients/src/main/java/org/apache/kafka/common/security/oauthbearer/OAuthBearerTokenCallback.java&lt;br/&gt;
+++ b/clients/src/main/java/org/apache/kafka/common/security/oauthbearer/OAuthBearerTokenCallback.java&lt;br/&gt;
@@ -90,10 +90,10 @@ public String errorUri() {&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Set the token. All error-related values are cleared.&lt;/li&gt;
	&lt;li&gt;&lt;/li&gt;
	&lt;li&gt;@param token&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;*            the mandatory token to set&lt;br/&gt;
+     *            the optional token to set&lt;br/&gt;
      */&lt;br/&gt;
     public void token(OAuthBearerToken token) {&lt;/li&gt;
	&lt;li&gt;this.token = Objects.requireNonNull(token);&lt;br/&gt;
+        this.token = token;&lt;br/&gt;
         this.errorCode = null;&lt;br/&gt;
         this.errorDescription = null;&lt;br/&gt;
         this.errorUri = null;&lt;br/&gt;
diff --git a/clients/src/main/java/org/apache/kafka/common/security/oauthbearer/internals/unsecured/OAuthBearerUnsecuredLoginCallbackHandler.java b/clients/src/main/java/org/apache/kafka/common/security/oauthbearer/internals/unsecured/OAuthBearerUnsecuredLoginCallbackHandler.java&lt;br/&gt;
index 8d259e30895..e7a4f2cc798 100644
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/clients/src/main/java/org/apache/kafka/common/security/oauthbearer/internals/unsecured/OAuthBearerUnsecuredLoginCallbackHandler.java&lt;br/&gt;
+++ b/clients/src/main/java/org/apache/kafka/common/security/oauthbearer/internals/unsecured/OAuthBearerUnsecuredLoginCallbackHandler.java&lt;br/&gt;
@@ -182,6 +182,14 @@ public void close() {&lt;br/&gt;
     private void handleTokenCallback(OAuthBearerTokenCallback callback) {&lt;br/&gt;
         if (callback.token() != null)&lt;br/&gt;
             throw new IllegalArgumentException(&quot;Callback had a token already&quot;);&lt;br/&gt;
+        if (moduleOptions.isEmpty()) 
{
+            log.debug(&quot;Token not provided, this login cannot be used to establish client connections&quot;);
+            callback.token(null);
+            return;
+        }
&lt;p&gt;+        if (moduleOptions.keySet().stream().noneMatch(name -&amp;gt; !name.startsWith(EXTENSION_PREFIX))) &lt;/p&gt;
{
+            throw new OAuthBearerConfigException(&quot;Extensions provided in login context without a token&quot;);
+        }
&lt;p&gt;         String principalClaimNameValue = optionValue(PRINCIPAL_CLAIM_NAME_OPTION);&lt;br/&gt;
         String principalClaimName = principalClaimNameValue != null &amp;amp;&amp;amp; !principalClaimNameValue.trim().isEmpty()&lt;br/&gt;
                 ? principalClaimNameValue.trim()&lt;br/&gt;
diff --git a/clients/src/test/java/org/apache/kafka/common/security/authenticator/SaslAuthenticatorTest.java b/clients/src/test/java/org/apache/kafka/common/security/authenticator/SaslAuthenticatorTest.java&lt;br/&gt;
index dfefabbd5ec..297cba5d2a5 100644&lt;/p&gt;&lt;/li&gt;
			&lt;li&gt;a/clients/src/test/java/org/apache/kafka/common/security/authenticator/SaslAuthenticatorTest.java&lt;br/&gt;
+++ b/clients/src/test/java/org/apache/kafka/common/security/authenticator/SaslAuthenticatorTest.java&lt;br/&gt;
@@ -93,6 +93,7 @@&lt;br/&gt;
 import org.apache.kafka.common.security.plain.internals.PlainServerCallbackHandler;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; import org.apache.kafka.common.utils.Time;&lt;br/&gt;
+import org.apache.kafka.common.utils.Utils;&lt;br/&gt;
 import org.junit.After;&lt;br/&gt;
 import org.junit.Before;&lt;br/&gt;
 import org.junit.Test;&lt;br/&gt;
@@ -1207,6 +1208,40 @@ public void testValidSaslOauthBearerMechanism() throws Exception &lt;/p&gt;
{
         createAndCheckClientConnection(securityProtocol, node);
     }

&lt;p&gt;+    /**&lt;br/&gt;
+     * Tests OAUTHBEARER client channels without tokens for the server.&lt;br/&gt;
+     */&lt;br/&gt;
+    @Test&lt;br/&gt;
+    public void testValidSaslOauthBearerMechanismWithoutServerTokens() throws Exception {&lt;br/&gt;
+        String node = &quot;0&quot;;&lt;br/&gt;
+        SecurityProtocol securityProtocol = SecurityProtocol.SASL_SSL;&lt;br/&gt;
+        saslClientConfigs.put(SaslConfigs.SASL_MECHANISM, &quot;OAUTHBEARER&quot;);&lt;br/&gt;
+        saslServerConfigs.put(BrokerSecurityConfigs.SASL_ENABLED_MECHANISMS_CONFIG, Arrays.asList(&quot;OAUTHBEARER&quot;));&lt;br/&gt;
+        saslClientConfigs.put(SaslConfigs.SASL_JAAS_CONFIG,&lt;br/&gt;
+                TestJaasConfig.jaasConfigProperty(&quot;OAUTHBEARER&quot;, Collections.singletonMap(&quot;unsecuredLoginStringClaim_sub&quot;, TestJaasConfig.USERNAME)));&lt;br/&gt;
+        saslServerConfigs.put(&quot;listener.name.sasl_ssl.oauthbearer.&quot; + SaslConfigs.SASL_JAAS_CONFIG,&lt;br/&gt;
+                TestJaasConfig.jaasConfigProperty(&quot;OAUTHBEARER&quot;, Collections.emptyMap()));&lt;br/&gt;
+&lt;br/&gt;
+        // Server without a token should start up successfully and authenticate clients.&lt;br/&gt;
+        server = createEchoServer(securityProtocol);&lt;br/&gt;
+        createAndCheckClientConnection(securityProtocol, node);&lt;br/&gt;
+&lt;br/&gt;
+        // Client without a token should fail to connect&lt;br/&gt;
+        saslClientConfigs.put(SaslConfigs.SASL_JAAS_CONFIG,&lt;br/&gt;
+                TestJaasConfig.jaasConfigProperty(&quot;OAUTHBEARER&quot;, Collections.emptyMap()));&lt;br/&gt;
+        createAndCheckClientConnectionFailure(securityProtocol, node);&lt;br/&gt;
+&lt;br/&gt;
+        // Server with extensions, but without a token should fail to start up since it could indicate a configuration error&lt;br/&gt;
+        saslServerConfigs.put(&quot;listener.name.sasl_ssl.oauthbearer.&quot; + SaslConfigs.SASL_JAAS_CONFIG,&lt;br/&gt;
+                TestJaasConfig.jaasConfigProperty(&quot;OAUTHBEARER&quot;, Collections.singletonMap(&quot;unsecuredLoginExtension_test&quot;, &quot;something&quot;)));&lt;br/&gt;
+        try &lt;/p&gt;
{
+            createEchoServer(securityProtocol);
+            fail(&quot;Server created with invalid login config containing extensions without a token&quot;);
+        }
&lt;p&gt; catch (Throwable e) &lt;/p&gt;
{
+            assertTrue(&quot;Unexpected exception &quot; + Utils.stackTrace(e), e.getCause() instanceof LoginException);
+        }
&lt;p&gt;+    }&lt;br/&gt;
+&lt;br/&gt;
     /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Tests OAUTHBEARER fails the connection when the client presents a token with&lt;/li&gt;
	&lt;li&gt;insufficient scope .&lt;/li&gt;
&lt;/ul&gt;





&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 6 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3ynzr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>