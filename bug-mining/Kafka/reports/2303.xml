<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:19:02 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-8448] Too many kafka.log.Log instances (Memory Leak)</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-8448</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;We have a custom Kafka health check which creates a topic,&#160;add some ACLs (read/write topic and group), produce &amp;amp; consume a single message and then quickly remove it and all the related ACLs created. We close the consumer involved, but no the producer.&lt;/p&gt;

&lt;p&gt;We have observed that # of instances of&#160;&lt;tt&gt;kafka.log.Log&lt;/tt&gt; keep growing, while there&apos;s no evidence of topics being leaked, neither running &lt;tt&gt;/opt/kafka/bin/kafka-topics.sh --zookeeper localhost:2181 --describe&lt;/tt&gt; , nor looking at the disk directory where topics are stored.&lt;/p&gt;

&lt;p&gt;After looking at the heapdump we&apos;ve observed the following&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;None of the &lt;tt&gt;kafka.log.Log&lt;/tt&gt; references (&lt;tt&gt;currentLogs&lt;/tt&gt;,&#160;&lt;tt&gt;logsToBeDeleted&#160;&lt;/tt&gt; and&#160;&lt;tt&gt;logsToBeDeleted&lt;/tt&gt;) in&#160;&lt;tt&gt;kafka.log.LogManager&lt;/tt&gt; is holding the big amount of&#160;&lt;tt&gt;kafka.log.Log&lt;/tt&gt; instances.&lt;/li&gt;
	&lt;li&gt;The only reference preventing &lt;tt&gt;kafka.log.Log&lt;/tt&gt; to be Garbage collected seems to be &lt;tt&gt;java.util.concurrent.ScheduledThreadPoolExecutor$DelayedWorkQueue&lt;/tt&gt; which contains schedule tasks created with the name &lt;tt&gt;PeriodicProducerExpirationCheck&lt;/tt&gt;.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I can see in the code that for every &lt;tt&gt;kafka.log.Log&lt;/tt&gt; a task with this name is scheduled.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  scheduler.schedule(name = &lt;span class=&quot;code-quote&quot;&gt;&quot;PeriodicProducerExpirationCheck&quot;&lt;/span&gt;, fun = () =&amp;gt; {
    lock &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; {
      producerStateManager.removeExpiredProducers(time.milliseconds)
    }
  }, period = producerIdExpirationCheckIntervalMs, delay = producerIdExpirationCheckIntervalMs, unit = TimeUnit.MILLISECONDS)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;However it seems those tasks are never unscheduled/cancelled&lt;/p&gt;</description>
                <environment>Red Hat 4.4.7-16, java version &amp;quot;1.8.0_152&amp;quot;, kafka_2.12-2.2.0</environment>
        <key id="13236509">KAFKA-8448</key>
            <summary>Too many kafka.log.Log instances (Memory Leak)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jolshan">Justine Olshan</assignee>
                                    <reporter username="juan.olivares">Juan Olivares</reporter>
                        <labels>
                    </labels>
                <created>Thu, 30 May 2019 14:25:33 +0000</created>
                <updated>Tue, 18 Jun 2019 19:50:27 +0000</updated>
                            <resolved>Tue, 18 Jun 2019 17:59:58 +0000</resolved>
                                    <version>2.2.0</version>
                                    <fixVersion>2.4.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16852041" author="ijuma" created="Thu, 30 May 2019 16:22:58 +0000"  >&lt;p&gt;Nice find, thanks for the report.&lt;/p&gt;</comment>
                            <comment id="16852473" author="githubbot" created="Fri, 31 May 2019 00:01:08 +0000"  >&lt;p&gt;jolshan commented on pull request #6847: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-8448&quot; title=&quot;Too many kafka.log.Log instances (Memory Leak)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-8448&quot;&gt;&lt;del&gt;KAFKA-8448&lt;/del&gt;&lt;/a&gt;: Too many kafka.log.Log instances (Memory Leak)&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/6847&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/6847&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Added a method to delete the PeriodicProducerExpirationCheck task that kept adding to the log.&lt;br/&gt;
   Includes a test to show that the task exists and then is removed when the log is closed.&lt;/p&gt;


&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16857011" author="githubbot" created="Wed, 5 Jun 2019 20:31:08 +0000"  >&lt;p&gt;cmccabe commented on pull request #6892: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-8448&quot; title=&quot;Too many kafka.log.Log instances (Memory Leak)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-8448&quot;&gt;&lt;del&gt;KAFKA-8448&lt;/del&gt;&lt;/a&gt;: Fix &quot;too many kafka.log.Log instances&quot;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/6892&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/6892&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16866889" author="githubbot" created="Tue, 18 Jun 2019 17:53:02 +0000"  >&lt;p&gt;cmccabe commented on pull request #6847: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-8448&quot; title=&quot;Too many kafka.log.Log instances (Memory Leak)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-8448&quot;&gt;&lt;del&gt;KAFKA-8448&lt;/del&gt;&lt;/a&gt;: Too many kafka.log.Log instances (Memory Leak)&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/6847&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/6847&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16866994" author="githubbot" created="Tue, 18 Jun 2019 19:50:27 +0000"  >&lt;p&gt;cmccabe commented on pull request #6892: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-8448&quot; title=&quot;Too many kafka.log.Log instances (Memory Leak)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-8448&quot;&gt;&lt;del&gt;KAFKA-8448&lt;/del&gt;&lt;/a&gt;: Fix &quot;too many kafka.log.Log instances&quot;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/6892&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/6892&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 21 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z038g8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>