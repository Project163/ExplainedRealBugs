<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:41:44 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-18401] Transaction version 2 does not support commit transaction without records</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-18401</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;This issue was observed when implementing &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-18206&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-18206&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;In short, under transaction version 2, it doesn&apos;t support commit transaction without sending any records while transaction version 0 &amp;amp; 1 do support this kind of scenario.&lt;/p&gt;

&lt;p&gt;Commit transactions without sending any records is fine when using transaction versions 0 or 1 because the producer won&apos;t send EndTxnRequest to the broker &lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt;. However, with transaction version 2, the producer still sends an EndTxnRequest to the broker while in transaction coordinator, the txn state is still in EMPTY, resulting in an error from the broker.&lt;/p&gt;

&lt;p&gt;This issue can be reproduced with the test in below. I&apos;m unsure if this behavior is expected. If it&apos;s not, one potential fix could be to follow the approach used in TV_0 and TV_1, where the EndTxnRequest is not sent if no partitions or offsets have been successfully added to the transaction. If this behavior is expected, we should document it and let user know this change.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    @ClusterTests({
        @ClusterTest(brokers = 3, features = {
            @ClusterFeature(feature = Feature.TRANSACTION_VERSION, version = 0)}),
        @ClusterTest(brokers = 3, features = {
            @ClusterFeature(feature = Feature.TRANSACTION_VERSION, version = 1)}),
        @ClusterTest(brokers = 3, features = {
            @ClusterFeature(feature = Feature.TRANSACTION_VERSION, version = 2)})
    })
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testProducerEndTransaction2(ClusterInstance cluster) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; InterruptedException {
        Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;&amp;gt; properties = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HashMap&amp;lt;&amp;gt;();
        properties.put(ProducerConfig.TRANSACTIONAL_ID_CONFIG, &lt;span class=&quot;code-quote&quot;&gt;&quot;foobar&quot;&lt;/span&gt;);
        properties.put(ProducerConfig.CLIENT_ID_CONFIG, &lt;span class=&quot;code-quote&quot;&gt;&quot;test&quot;&lt;/span&gt;);
        properties.put(ProducerConfig.ENABLE_IDEMPOTENCE_CONFIG, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; (Producer&amp;lt;&lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[], &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[]&amp;gt; producer1 = cluster.producer(properties)) {

            producer1.initTransactions();
            producer1.beginTransaction();
            producer1.commitTransaction(); &lt;span class=&quot;code-comment&quot;&gt;// In TV_2, we&apos;ll get InvalidTxnStateException
&lt;/span&gt;        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Another test case, which is essentially the same as the previous one, starts with a transaction that includes records, and then proceeds to start the next transaction. When using transaction version 2, we encounter an error, but this time it&apos;s a different error from the one seen in the previous case.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    @ClusterTests({
        @ClusterTest(brokers = 3, features = {
            @ClusterFeature(feature = Feature.TRANSACTION_VERSION, version = 0)}),
        @ClusterTest(brokers = 3, features = {
            @ClusterFeature(feature = Feature.TRANSACTION_VERSION, version = 1)}),
        @ClusterTest(brokers = 3, features = {
            @ClusterFeature(feature = Feature.TRANSACTION_VERSION, version = 2)})
    })
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testProducerEndTransaction(ClusterInstance cluster) {
        Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;&amp;gt; properties = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HashMap&amp;lt;&amp;gt;();
        properties.put(ProducerConfig.TRANSACTIONAL_ID_CONFIG, &lt;span class=&quot;code-quote&quot;&gt;&quot;foobar&quot;&lt;/span&gt;);
        properties.put(ProducerConfig.CLIENT_ID_CONFIG, &lt;span class=&quot;code-quote&quot;&gt;&quot;test&quot;&lt;/span&gt;);
        properties.put(ProducerConfig.ENABLE_IDEMPOTENCE_CONFIG, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; (Producer&amp;lt;&lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[], &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[]&amp;gt; producer1 = cluster.producer(properties)) {

            producer1.initTransactions();
            producer1.beginTransaction();
            producer1.send(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ProducerRecord&amp;lt;&amp;gt;(&lt;span class=&quot;code-quote&quot;&gt;&quot;test&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;key&quot;&lt;/span&gt;.getBytes(), &lt;span class=&quot;code-quote&quot;&gt;&quot;value&quot;&lt;/span&gt;.getBytes()));
            producer1.commitTransaction();

            producer1.beginTransaction();
            producer1.commitTransaction(); &lt;span class=&quot;code-comment&quot;&gt;// In TV_2, we&apos;ll get ProducerFencedException
&lt;/span&gt;        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt;: &lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/clients/src/main/java/org/apache/kafka/clients/producer/internals/TransactionManager.java#L857-L865&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/trunk/clients/src/main/java/org/apache/kafka/clients/producer/internals/TransactionManager.java#L857-L865&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13603784">KAFKA-18401</key>
            <summary>Transaction version 2 does not support commit transaction without records</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="brandboat">Kuan Po Tseng</assignee>
                                    <reporter username="brandboat">Kuan Po Tseng</reporter>
                        <labels>
                    </labels>
                <created>Sat, 4 Jan 2025 10:10:09 +0000</created>
                <updated>Fri, 17 Jan 2025 18:31:35 +0000</updated>
                            <resolved>Wed, 15 Jan 2025 18:44:55 +0000</resolved>
                                                    <fixVersion>4.0.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="17910742" author="jolshan" created="Tue, 7 Jan 2025 18:12:31 +0000"  >&lt;p&gt;Hmm. This should not be an issue as we should have fixed the state machine. I can take a closer look.&lt;/p&gt;</comment>
                            <comment id="17910745" author="jolshan" created="Tue, 7 Jan 2025 18:17:31 +0000"  >&lt;blockquote&gt;&lt;p&gt;where the EndTxnRequest is not sent if no partitions or offsets have been successfully added to the transaction. If this behavior is expected, we should document it and let user know this change.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;We can not do this because we don&apos;t know for certain that the transaction actually added the partitions on the coordinator side due to the 2 hop process. We should always be able to send an EndTransaction abort regardless of whether partitions were added or not (in the case of failures)&lt;/p&gt;

&lt;p&gt;I guess under this we don&apos;t allow an EndTxn commit because we can&apos;t say for certain if a partition has been added. I&apos;m trying to understand the use case for committing a transaction with no content.&#160;&lt;/p&gt;</comment>
                            <comment id="17910766" author="chia7712" created="Tue, 7 Jan 2025 19:01:12 +0000"  >&lt;blockquote&gt;
&lt;p&gt;I guess under this we don&apos;t allow an EndTxn commit because we can&apos;t say for certain if a partition has been added. I&apos;m trying to understand the use case for committing a transaction with no content. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I believe the core issue stems from a change in behavior that previously allowed users to call commitTransaction without having sent any records. If this behavioral change is indeed necessary, the documentation for commitTransaction should be updated to explicitly reflect this modification. Furthermore, I&apos;m currently considering how to refactor the following code:&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
producer.beginTransaction();
sendRecords(producer);
producer.commitTransaction();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;it seems users have to check the count of sent records. for example:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
producer.beginTransaction();
&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; count = sendRecords(producer);
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (count &amp;gt; 0) producer.commitTransaction();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;However, I think `beginTransaction` can&apos;t be executed repeatedly, so we need extra check for beginTransaction&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; needBegin = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;

&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (needBegin) {
  producer.beginTransaction();
  needBegin = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
}
&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; count = sendRecords(producer);
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (count &amp;gt; 0) {
  producer.commitTransaction();
  needBegin = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Please correct me if I have misunderstood anything. If the above example is valid, we should also document this behavior for users.&lt;/p&gt;</comment>
                            <comment id="17910771" author="jolshan" created="Tue, 7 Jan 2025 19:10:33 +0000"  >&lt;p&gt;I&apos;m interested in the method sendRecords that sometimes doesn&apos;t send records. It appears in streams for example, we don&apos;t start a transaction until we have data to send. So I&apos;m wondering if there is a case where we need to start a transaction without having any records/offsets to contribute to it.&#160;&lt;/p&gt;</comment>
                            <comment id="17910773" author="jolshan" created="Tue, 7 Jan 2025 19:11:50 +0000"  >&lt;p&gt;I do understand the concern about a regression in the sense that this was previously supported and now it is not. So I will think on how that can be improved. One option is to allow commits if we never attempted a send on the producer. The only question for me on that is how it will be implemented server side.&lt;/p&gt;</comment>
                            <comment id="17910858" author="jolshan" created="Wed, 8 Jan 2025 00:33:35 +0000"  >&lt;p&gt;Discussed this with a teammate and we have a way for this to work without changing the server. In the case where we call commitTransaction and the producer never called send, we can return successfully without sending the EndTxn request to the server. This should require minimal changes and allow for the backwards compatibilty.&lt;/p&gt;</comment>
                            <comment id="17910859" author="jolshan" created="Wed, 8 Jan 2025 00:34:52 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=brandboat&quot; class=&quot;user-hover&quot; rel=&quot;brandboat&quot;&gt;brandboat&lt;/a&gt; I see you assigned yourself here. Do you think you can implement the above? I can also take it. Just let me know in the next day or so as we are approaching the code freeze. Thanks!&lt;/p&gt;</comment>
                            <comment id="17910864" author="brandboat" created="Wed, 8 Jan 2025 00:50:15 +0000"  >&lt;blockquote&gt;&lt;p&gt;Discussed this with a teammate and we have a way for this to work without changing the server. In the case where we call commitTransaction and the producer never called send, we can return successfully without sending the EndTxn request to the server. This should require minimal changes and allow for the backwards compatibilty.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Thanks, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jolshan&quot; class=&quot;user-hover&quot; rel=&quot;jolshan&quot;&gt;jolshan&lt;/a&gt;. This is exactly what I&apos;m trying to implement. Over the past few days, I&#8217;ve been struggling with whether &quot;calling commitTransaction without calling send&quot; is the right way to address this issue. There&#8217;s a corner case where if the acknowledgment (ack) is 0, the send might fail, but the producer wouldn&#8217;t be able to detect that failure. I&apos;m not sure how to handle this case... Alternatively, perhaps we could ignore this side effect and simply detect whether &lt;tt&gt;send&lt;/tt&gt; was called within a transaction and do not check if response is ok or not and then check if we can call &lt;tt&gt;commitTransaction&lt;/tt&gt;?&lt;/p&gt;</comment>
                            <comment id="17910924" author="jolshan" created="Wed, 8 Jan 2025 04:36:26 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=brandboat&quot; class=&quot;user-hover&quot; rel=&quot;brandboat&quot;&gt;brandboat&lt;/a&gt;&#160;&lt;br/&gt;
We can&apos;t use transactions without acks=all. Does that clear up some confusion?&lt;/p&gt;

&lt;p&gt;I do agree though that it would be best to only return a success on commitTransaction and not send the EndTxn request if the producer never called send during the transaction. If it called send at least once, we are left in a weird state where we don&apos;t know if the transaction was added or not in some cases when send fails. In that case, we shouldn&apos;t try to commit and should fail if the producer attempts to.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17910925" author="brandboat" created="Wed, 8 Jan 2025 04:37:58 +0000"  >&lt;p&gt;Yes... I just realized that, thanks for the explanation. I&apos;ll file a PR ASAP.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            43 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1tes0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>