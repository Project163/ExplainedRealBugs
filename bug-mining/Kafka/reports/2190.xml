<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:17:29 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-8069] Committed offsets get cleaned up right after the coordinator loading them back from __consumer_offsets in broker with old inter-broker protocol version (&lt; 2.2)</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-8069</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;After the 2.1 release, if the broker hasn&apos;t been upgrade to the latest inter-broker protocol version, &lt;br/&gt;
the committed offsets stored in the __consumer_offset topic will get cleaned up way earlier than it should be when the offsets are loaded back from the __consumer_offset topic in GroupCoordinator, which will happen during leadership transition or after broker bounce.&lt;/p&gt;

&lt;p&gt;TL;DR&lt;br/&gt;
For V1 on-disk format for __consumer_offsets, we have the &lt;b&gt;expireTimestamp&lt;/b&gt; field and if the inter-broker protocol (IBP) version is prior to 2.1 (prior to &lt;a href=&quot;https://cwiki.apache.org/confluence/display/KAFKA/KIP-211%3A+Revise+Expiration+Semantics+of+Consumer+Group+Offsets&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;KIP-211&lt;/a&gt;) for a kafka 2.1 broker, the logic of getting the expired offsets looks like:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
def getExpiredOffsets(baseTimestamp: CommitRecordMetadataAndOffset =&amp;gt; &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;): Map[TopicPartition, OffsetAndMetadata] = {
 offsets.filter {
 &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; (topicPartition, commitRecordMetadataAndOffset) =&amp;gt;
 ... &amp;amp;&amp;amp; {
 commitRecordMetadataAndOffset.offsetAndMetadata.expireTimestamp match {
 &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; None =&amp;gt;
 &lt;span class=&quot;code-comment&quot;&gt;// current version with no per partition retention
&lt;/span&gt; currentTimestamp - baseTimestamp(commitRecordMetadataAndOffset) &amp;gt;= offsetRetentionMs
 &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; Some(expireTimestamp) =&amp;gt;
 &lt;span class=&quot;code-comment&quot;&gt;// older versions with explicit expire_timestamp field =&amp;gt; old expiration semantics is used
&lt;/span&gt; currentTimestamp &amp;gt;= expireTimestamp
 }
 }
 }....
 }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The expireTimestamp in the on-disk offset record can only be set when storing the committed offset in the __consumer_offset topic. But the GroupCoordinator also has keep a in-memory representation for the expireTimestamp (see the codes above), which can be set in the following two cases:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Upon the GroupCoordinator receiving OffsetCommitRequest, the expireTimestamp is set using the following logic:
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
expireTimestamp = offsetCommitRequest.retentionTime match {
 &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; OffsetCommitRequest.DEFAULT_RETENTION_TIME =&amp;gt; None
 &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; retentionTime =&amp;gt; Some(currentTimestamp + retentionTime)
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;In all the latest client versions, the consumer will set out OffsetCommitRequest with DEFAULT_RETENTION_TIME so the expireTimestamp will always be None in this case. &lt;b&gt;This means any committed offset set in this case will always hit the &quot;case None&quot; in the &quot;getExpiredOffsets(...)&quot; when coordinator is doing the cleanup, which is correct.&lt;/b&gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;


&lt;ol&gt;
	&lt;li&gt;Upon the GroupCoordinatorReceiving loading the committed offset stored in the __consumer_offsets topic from disk, the expireTimestamp is set using the following logic if IBP&amp;lt;2.1:
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
val expireTimestamp = value.get(OFFSET_VALUE_EXPIRE_TIMESTAMP_FIELD_V1).asInstanceOf[&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;and the logic to persist the expireTimestamp is:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// OffsetCommitRequest.DEFAULT_TIMESTAMP = -1
&lt;/span&gt;value.set(OFFSET_VALUE_EXPIRE_TIMESTAMP_FIELD_V1, offsetAndMetadata.expireTimestamp.getOrElse(OffsetCommitRequest.DEFAULT_TIMESTAMP))
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Since the in-memory expireTimestamp will always be None in our case as mentioned in 1), we will always store -1 on-disk. Therefore, when the offset is loaded from the __consumer_offsets topic, the in-memory expireTimestamp will always be set to -1. &lt;b&gt;This means any committed offset set in this case will always hit &quot;case Some(expireTimestamp)&quot; in the &quot;getExpiredOffsets(...)&quot; when coordinator is doing the cleanup, which basically indicates we will always expire the committed offset on the first expiration check (which is shortly after they are loaded from __consumer_offsets topic)&lt;/b&gt;.&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;I am able to reproduce this bug on my local box with one broker using 2.&lt;b&gt;,1.&lt;/b&gt; and 0.11.* consumer. The consumer will see null committed offset after the broker is bounced.&lt;/p&gt;

&lt;p&gt;This bug is introduced by &lt;a href=&quot;https://github.com/apache/kafka/pull/5690&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;PR-5690&lt;/a&gt; in the kafka 2.1 release and the fix is very straight-forward, which is basically set the expireTimestamp to None if it is -1 in the on-disk format.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13220377">KAFKA-8069</key>
            <summary>Committed offsets get cleaned up right after the coordinator loading them back from __consumer_offsets in broker with old inter-broker protocol version (&lt; 2.2)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hzxa21">Zhanxiang (Patrick) Huang</assignee>
                                    <reporter username="hzxa21">Zhanxiang (Patrick) Huang</reporter>
                        <labels>
                    </labels>
                <created>Fri, 8 Mar 2019 05:08:09 +0000</created>
                <updated>Fri, 8 Mar 2019 17:41:20 +0000</updated>
                            <resolved>Fri, 8 Mar 2019 17:22:02 +0000</resolved>
                                    <version>2.1.0</version>
                    <version>2.1.1</version>
                    <version>2.1.2</version>
                    <version>2.2.0</version>
                    <version>2.2.1</version>
                                    <fixVersion>2.0.2</fixVersion>
                    <fixVersion>2.1.2</fixVersion>
                    <fixVersion>2.2.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="16787544" author="ijuma" created="Fri, 8 Mar 2019 05:41:01 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hzxa21&quot; class=&quot;user-hover&quot; rel=&quot;hzxa21&quot;&gt;hzxa21&lt;/a&gt; are you planning to submit a PR?&lt;/p&gt;</comment>
                            <comment id="16787546" author="ijuma" created="Fri, 8 Mar 2019 05:42:26 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mjsax&quot; class=&quot;user-hover&quot; rel=&quot;mjsax&quot;&gt;mjsax&lt;/a&gt; I think this is a blocker for 2.2.0. What do you think?&lt;/p&gt;</comment>
                            <comment id="16787593" author="githubbot" created="Fri, 8 Mar 2019 06:39:21 +0000"  >&lt;p&gt;hzxa21 commented on pull request #6401: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-8069&quot; title=&quot;Committed offsets get cleaned up right after the coordinator loading them back from __consumer_offsets in broker with old inter-broker protocol version (&amp;lt; 2.2)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-8069&quot;&gt;&lt;del&gt;KAFKA-8069&lt;/del&gt;&lt;/a&gt;: Setting expireTimestamp to None if it is the default value after loading v1 offset records from __consumer_offsets&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/6401&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/6401&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   After the 2.1 release, if the broker hasn&apos;t been upgrade to the latest inter-broker protocol version, the committed offsets stored in the __consumer_offset topic will get cleaned up way earlier than it should be when the offsets are loaded back from the __consumer_offset topic in GroupCoordinator, which will happen during leadership transition or after broker bounce. This patch fixes the bug by setting expireTimestamp to None if it is the default value after loading v1 offset records from __consumer_offsets.&lt;/p&gt;

&lt;p&gt;   Details for the bug can be found in &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-8069&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-8069&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;   The bug can be reproduced by starting a broker with inter-broker protocol version = 1.0 and a 2.&lt;b&gt;/1.&lt;/b&gt;/0.11.* consumer.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16787609" author="hachikuji" created="Fri, 8 Mar 2019 07:00:13 +0000"  >&lt;p&gt;Great find and thanks for the detailed summary. I was able to confirm this on trunk. The only requirement is a 2.1+ broker with IBP set to an old version. I did the following:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Start up the broker with IBP set to 2.0&lt;/li&gt;
	&lt;li&gt;Start up a console consumer (on trunk) and verify it commits offsets&lt;/li&gt;
	&lt;li&gt;Stop the consumer&lt;/li&gt;
	&lt;li&gt;Restart the broker&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;We see the following in the logs:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[2019-03-07 22:49:25,774] DEBUG [GroupMetadataManager brokerId=0] Loaded group metadata GroupMetadata(groupId=blah, generation=4, protocolType=Some(consumer), currentState=Empty, members=Map()) with offsets Map(foo-0 -&amp;gt; CommitRecordMetadataAndOffset(Some(12),OffsetAndMetadata(offset=1, leaderEpoch=Optional.empty, metadata=, commitTimestamp=1552027741320, expireTimestamp=Some(-1)))) and pending offsets Map() (kafka.coordinator.group.GroupMetadataManager) &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The key is `&lt;b&gt;expireTimestamp=Some(-1)&lt;/b&gt;`. Shortly after I see the coordinator expiring the offset.&lt;/p&gt;</comment>
                            <comment id="16788063" author="githubbot" created="Fri, 8 Mar 2019 17:04:07 +0000"  >&lt;p&gt;hachikuji commented on pull request #6401: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-8069&quot; title=&quot;Committed offsets get cleaned up right after the coordinator loading them back from __consumer_offsets in broker with old inter-broker protocol version (&amp;lt; 2.2)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-8069&quot;&gt;&lt;del&gt;KAFKA-8069&lt;/del&gt;&lt;/a&gt;: Setting expireTimestamp to None if it is the default value after loading v1 offset records from __consumer_offsets&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/6401&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/6401&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16788101" author="wushujames" created="Fri, 8 Mar 2019 17:32:52 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mjsax&quot; class=&quot;user-hover&quot; rel=&quot;mjsax&quot;&gt;mjsax&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hachikuji&quot; class=&quot;user-hover&quot; rel=&quot;hachikuji&quot;&gt;hachikuji&lt;/a&gt;, is this critical enough that we will spin a new RC for 2.2.0?&lt;/p&gt;</comment>
                            <comment id="16788106" author="mjsax" created="Fri, 8 Mar 2019 17:41:20 +0000"  >&lt;p&gt;Yes. I just marked it as a blocker. Will do a new RC.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 36 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z00hhc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>