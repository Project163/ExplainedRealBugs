<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:13:32 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-7180] In testHWCheckpointWithFailuresSingleLogSegment, wait until server1 has joined the ISR before shutting down server2</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-7180</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;In the testHWCheckpointWithFailuresSingleLogSegment method, the test logic is &lt;br/&gt;
1. shutdown server1 and then capture the leadership of a partition in the variable &quot;leader&quot;, which should be server2&lt;br/&gt;
2. shutdown server2 and wait until the leadership has changed to a broker other than server2&lt;br/&gt;
through the line &lt;br/&gt;
waitUntilLeaderIsElectedOrChanged(zkClient, topic, partitionId, oldLeaderOpt = Some(leader))&lt;/p&gt;

&lt;p&gt;However when we execute step 2 and shutdown server2, it&apos;s possible that server1 has not caught up with the partition, and has not joined the ISR. With unclean leader election turned off, the leadership cannot be transferred to server1, causing the waited condition in step 2 to be never met. &lt;/p&gt;

&lt;p&gt;The obvious fix is to wait until server1 has joined the ISR before shutting down server2.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13172975">KAFKA-7180</key>
            <summary>In testHWCheckpointWithFailuresSingleLogSegment, wait until server1 has joined the ISR before shutting down server2</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="luwang">Lucas Wang</assignee>
                                    <reporter username="luwang">Lucas Wang</reporter>
                        <labels>
                    </labels>
                <created>Wed, 18 Jul 2018 17:12:18 +0000</created>
                <updated>Mon, 30 Jul 2018 04:21:15 +0000</updated>
                            <resolved>Mon, 30 Jul 2018 04:08:09 +0000</resolved>
                                                    <fixVersion>2.0.1</fixVersion>
                    <fixVersion>2.1.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="16548106" author="githubbot" created="Wed, 18 Jul 2018 17:15:21 +0000"  >&lt;p&gt;gitlw opened a new pull request #5387: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7180&quot; title=&quot;In testHWCheckpointWithFailuresSingleLogSegment, wait until server1 has joined the ISR before shutting down server2&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7180&quot;&gt;&lt;del&gt;KAFKA-7180&lt;/del&gt;&lt;/a&gt;: Fixing the flaky test testHWCheckpointWithFailuresSingleLogSegment&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5387&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5387&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   By waiting until server1 has joined the ISR before shutting down server2&lt;/p&gt;

&lt;p&gt;   Rerun the test method many times after the code change, and there is no flakiness any more.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16561406" author="githubbot" created="Mon, 30 Jul 2018 04:08:41 +0000"  >&lt;p&gt;lindong28 closed pull request #5387: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7180&quot; title=&quot;In testHWCheckpointWithFailuresSingleLogSegment, wait until server1 has joined the ISR before shutting down server2&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7180&quot;&gt;&lt;del&gt;KAFKA-7180&lt;/del&gt;&lt;/a&gt;: Fixing the flaky test testHWCheckpointWithFailuresSingleLogSegment&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5387&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5387&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/core/src/test/scala/unit/kafka/server/LogRecoveryTest.scala b/core/src/test/scala/unit/kafka/server/LogRecoveryTest.scala&lt;br/&gt;
index 880950ae02c..1bd15f7b537 100755&lt;br/&gt;
&amp;#8212; a/core/src/test/scala/unit/kafka/server/LogRecoveryTest.scala&lt;br/&gt;
+++ b/core/src/test/scala/unit/kafka/server/LogRecoveryTest.scala&lt;br/&gt;
@@ -143,6 +143,15 @@ class LogRecoveryTest extends ZooKeeperTestHarness {&lt;br/&gt;
       leader == 0 || leader == 1)&lt;/p&gt;

&lt;p&gt;     assertEquals(hw, hwFile1.read.getOrElse(topicPartition, 0L))&lt;br/&gt;
+    /** We plan to shutdown server2 and transfer the leadership to server1.&lt;br/&gt;
+      * With unclean leader election turned off, a prerequisite for the successful leadership transition&lt;br/&gt;
+      * is that server1 has caught up on the topicPartition, and has joined the ISR.&lt;br/&gt;
+      * In the line below, we wait until the condition is met before shutting down server2&lt;br/&gt;
+      */&lt;br/&gt;
+    waitUntilTrue(() =&amp;gt; server2.replicaManager.getPartition(topicPartition).get.inSyncReplicas.size == 2,&lt;br/&gt;
+      &quot;Server 1 is not able to join the ISR after restart&quot;)&lt;br/&gt;
+&lt;br/&gt;
+&lt;br/&gt;
     // since server 2 was never shut down, the hw value of 30 is probably not checkpointed to disk yet&lt;br/&gt;
     server2.shutdown()&lt;br/&gt;
     assertEquals(hw, hwFile2.read.getOrElse(topicPartition, 0L))&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 16 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3w15z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>