<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:26:26 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-9566] ProcessorContextImpl#forward throws NullPointerException if invoked from DeserializationExceptionHandler</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-9566</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Hi, I am trying to implement custom&#160;DeserializationExceptionHandler which would forward an exception to downstream processor(s), but&#160;ProcessorContextImpl#forward throws a NullPointerException if invoked from this custom handler.&lt;/p&gt;

&lt;p&gt;Handler implementation:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;MyDeserializationExceptionHandler.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;

&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;MyDeserializationExceptionHandler &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; DeserializationExceptionHandler {

    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void configure(Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, ?&amp;gt; configs) {
    }

    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; DeserializationHandlerResponse handle(ProcessorContext context, ConsumerRecord&amp;lt;&lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[], &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[]&amp;gt; record, Exception exception) {
        context.forward(&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, exception, To.child(&lt;span class=&quot;code-quote&quot;&gt;&quot;error-processor&quot;&lt;/span&gt;));
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; DeserializationHandlerResponse.CONTINUE;
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Handler is wired as default deserialization exception handler:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; TopologyTestDriver initializeTestDriver(StreamsBuilder streamBuilder) {
        Topology topology = streamBuilder.build();
        Properties props = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Properties();
        props.setProperty(StreamsConfig.APPLICATION_ID_CONFIG, &lt;span class=&quot;code-quote&quot;&gt;&quot;my-test-application&quot;&lt;/span&gt;);
        props.setProperty(StreamsConfig.BOOTSTRAP_SERVERS_CONFIG, &lt;span class=&quot;code-quote&quot;&gt;&quot;dummy:1234&quot;&lt;/span&gt;);
        props.setProperty(StreamsConfig.PROCESSING_GUARANTEE_CONFIG, StreamsConfig.EXACTLY_ONCE);
        props.setProperty(StreamsConfig.DEFAULT_DESERIALIZATION_EXCEPTION_HANDLER_CLASS_CONFIG, MyDeserializationExceptionHandler.&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;getName());
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TopologyTestDriver(topology, props);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;br/&gt;
Exception stacktrace:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.kafka.streams.errors.StreamsException: Fatal user code error in deserialization error callback
    at org.apache.kafka.streams.processor.internals.RecordDeserializer.deserialize(RecordDeserializer.java:76)
    at org.apache.kafka.streams.processor.internals.RecordQueue.maybeUpdateTimestamp(RecordQueue.java:160)
    at org.apache.kafka.streams.processor.internals.RecordQueue.addRawRecords(RecordQueue.java:101)
    at org.apache.kafka.streams.processor.internals.PartitionGroup.addRawRecords(PartitionGroup.java:136)
    at org.apache.kafka.streams.processor.internals.StreamTask.addRecords(StreamTask.java:742)
    at org.apache.kafka.streams.TopologyTestDriver.pipeInput(TopologyTestDriver.java:392)
    ...

Caused by: java.lang.NullPointerException
    at org.apache.kafka.streams.processor.internals.ProcessorContextImpl.forward(ProcessorContextImpl.java:165)
    at MyDeserializationExceptionHandler.handle(NewExceptionHandlerTest.java:204)
    at org.apache.kafka.streams.processor.internals.RecordDeserializer.deserialize(RecordDeserializer.java:70) ... 33 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Neither DeserializationExceptionHandler, nor ProcessorContext javadocs mention that ProcessorContext#forward(...) must not be invoked from DeserializationExceptionHandler, so I assume that this is a defect.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13286007">KAFKA-9566</key>
            <summary>ProcessorContextImpl#forward throws NullPointerException if invoked from DeserializationExceptionHandler</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="TomasMi">Tomas Mi</reporter>
                        <labels>
                            <label>needs-kip</label>
                    </labels>
                <created>Tue, 18 Feb 2020 14:43:59 +0000</created>
                <updated>Tue, 17 Dec 2024 23:28:25 +0000</updated>
                            <resolved>Tue, 17 Dec 2024 23:28:25 +0000</resolved>
                                    <version>1.0.0</version>
                                    <fixVersion>3.9.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="17039283" author="mjsax" created="Tue, 18 Feb 2020 17:47:23 +0000"  >&lt;p&gt;Thanks for reporting this issue. We should update the JavaDocs accordingly. The ides to pass in the context is to provide context information like topic name, partitions, offset, timestamp of the record etc.&lt;/p&gt;

&lt;p&gt;We should also throw a better exception, like &quot;UnsupportedOperationException&quot;.&lt;/p&gt;</comment>
                            <comment id="17039444" author="tomasmi" created="Tue, 18 Feb 2020 20:41:37 +0000"  >&lt;p&gt;Wouldn&apos;t it be possible to support such use case instead of throwing UnsupportedOperationException? Per my understanding the issue relates to missing child processors (or only partly initialized ProcessorContext), but durring message deserialization phaze I think child processors should be known, since that should happen in source processor. I am trying to implement exception handling while maintaining exactly once delivery guaratee and it looks like that this would be an ideal way. Otherwise do you know if there is another way to achieve the same?&lt;/p&gt;</comment>
                            <comment id="17039474" author="mjsax" created="Tue, 18 Feb 2020 21:23:18 +0000"  >&lt;p&gt;In general it might be possible, but currently the assumption is that if a deserialization error occurs, it&apos;s not possible to fix the issue and that the message can only be dropped. Changing this would be a new feature and would require a new Jira and a KIP to add this capabilities.&lt;/p&gt;

&lt;p&gt;What you could do atm is, to use a custom deserializer that wraps the original deserializer and catch any exception from the original deserializer and than fix the issue and return the data you want to return.&lt;/p&gt;</comment>
                            <comment id="17039478" author="tomasmi" created="Tue, 18 Feb 2020 21:33:21 +0000"  >&lt;p&gt;Thank you Matthias &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; Re this issue, if it is just the matter of JavaDocs and changing to some nicer exception, I think its priority can be decreased.&lt;/p&gt;</comment>
                            <comment id="17259358" author="mjsax" created="Wed, 6 Jan 2021 02:20:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vvcephei&quot; class=&quot;user-hover&quot; rel=&quot;vvcephei&quot;&gt;vvcephei&lt;/a&gt; &#8211; given that we have introduced `RecordContext` interface, should we do a KIP to change the API from passing in the new interface instead of the ProcessorContext?&lt;/p&gt;

&lt;p&gt;Would be a simple/quick KIP.&lt;/p&gt;</comment>
                            <comment id="17259416" author="vvcephei" created="Wed, 6 Jan 2021 04:55:20 +0000"  >&lt;p&gt;Hi all,&lt;/p&gt;

&lt;p&gt;Thanks, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mjsax&quot; class=&quot;user-hover&quot; rel=&quot;mjsax&quot;&gt;mjsax&lt;/a&gt; , that&apos;s a good thought.&lt;/p&gt;

&lt;p&gt;I just took a look at the relevant interfaces, and unfortunately, I don&apos;t think the new Context interface improves the situation much. The DeserializationExceptionHandler already has all the &quot;record context&quot; information from the raw ConsumerRecord it gets, so we must have provided the ProcessorContext to inject other information, like the application and task id, maybe the default serdes or metrics, etc.&lt;/p&gt;

&lt;p&gt;Unfortunately, the new interfaces don&apos;t have a nice &quot;slice&quot; of these informational methods that we could pass to the DeserializationExceptionHandler without also exposing forward().&lt;/p&gt;

&lt;p&gt;It seems like a JavaDoc improvement is the best way forward for this right now, unless we want to want to propose a completely new DeserializationExceptionHandler that just provides the pieces of information we think it needs.&lt;/p&gt;</comment>
                            <comment id="17260050" author="mjsax" created="Wed, 6 Jan 2021 20:31:12 +0000"  >&lt;p&gt;Good point. I was just reading up on the original KIP-161 dicussion:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;4. Could we consider adding the processor context in the handle() function as well? This context will be wrapping as the source node that is about to process the record. This could expose more info like which task / source node sees this error, which timestamp of the message, etc, and also can allow users to implement their handlers by exposing some metrics, by calling context.forward() to implement the &quot;send to bad queue&quot; behavior etc.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;So maybe we would need to define a completely new interface to provide only the metadata we want, without duplicating stuff like record metadata, and not exposing methods that should not be used.&lt;/p&gt;

&lt;p&gt;I&apos;ll do a JavaDoc PR for now to at least inform users. And this really fix the issue, we can keep this ticket open and eventually do a KIP.&lt;/p&gt;</comment>
                            <comment id="17906558" author="mjsax" created="Tue, 17 Dec 2024 23:28:25 +0000"  >&lt;p&gt;Since 3.9 release, the method taking `ProcessorContext` is deprecated in favor of a new overload with has a `ErrorHandlerContext` parameter instead.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310060">
                    <name>Container</name>
                                                                <inwardlinks description="Is contained by">
                                        <issuelink>
            <issuekey id="13573861">KAFKA-16448</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            46 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0bm80:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>