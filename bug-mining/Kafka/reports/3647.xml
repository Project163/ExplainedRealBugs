<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:37:13 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-16025] Streams StateDirectory has orphaned locks after rebalancing, blocking future rebalancing</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-16025</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Hello,&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;We are encountering an issue where during rebalancing, we see streams threads on one client get stuck in rebalancing. Upon enabling debug logs, we saw that some tasks were having issues initializing due to failure to grab a lock in the StateDirectory:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;2023-12-14 22:51:57.352000Z stream-thread &lt;span class=&quot;error&quot;&gt;&amp;#91;i-0f1a5e7a42158e04b-StreamThread-14&amp;#93;&lt;/span&gt; Could not initialize task 0_51 since: stream-thread &lt;span class=&quot;error&quot;&gt;&amp;#91;i-0f1a5e7a42158e04b-StreamThread-14&amp;#93;&lt;/span&gt; standby-task &lt;span class=&quot;error&quot;&gt;&amp;#91;0_51&amp;#93;&lt;/span&gt; Failed to lock the state directory for task 0_51; will retry&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;We were able to reproduce this behavior reliably on 3.4.0. This is the sequence that triggers the bug.&lt;/p&gt;

&lt;p&gt;Assume in a streams consumer group, there are 5 instances (A, B, C, D, E), each with 5 threads (1-5), and the consumer is using stateful tasks which have state stores on disk. There are 10 active tasks and 10 standby tasks.&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Instance A is deactivated&lt;/li&gt;
	&lt;li&gt;As an example, lets say task 0_1, previously on instance B, moves to instance C&lt;/li&gt;
	&lt;li&gt;Task 0_1 leaves behind it&apos;s state directory on Instance B&apos;s disk, currently unused, and no lock for it exists in Instance B&apos;s StateDirectory in-memory lock tracker&lt;/li&gt;
	&lt;li&gt;Instance A is re-activated&lt;/li&gt;
	&lt;li&gt;Streams thread 1 on Instance B is asked to re-join the consumer group due to a new member being added&lt;/li&gt;
	&lt;li&gt;As part of re-joining, thread 1 lists non-empty state directories in order to report the offset&apos;s it has in it&apos;s state stores as part of it&apos;s metadata. Thread 1 sees that the directory for 0_1 is not empty.&lt;/li&gt;
	&lt;li&gt;The cleanup thread on instance B runs. The cleanup thread locks state store 0_1, sees the directory for 0_1 was last modified more than `state.cleanup.delay.ms` ago, deletes it, and unlocks it successfully&lt;/li&gt;
	&lt;li&gt;Thread 1 takes a lock on directory 0_1 due to it being found not-empty before, unaware that the cleanup has run between the time of the check and the lock. It tracks this lock in it&apos;s own in-memory store, in addition to StateDirectory&apos;s in-memory lock store&lt;/li&gt;
	&lt;li&gt;Thread 1 successfully joins the consumer group&lt;/li&gt;
	&lt;li&gt;After every consumer in the group joins the group, assignments are calculated, and then every consumer calls sync group to receive the new assignments&lt;/li&gt;
	&lt;li&gt;Thread 1 on Instance B calls sync group but gets an error - the group coordinator has triggered a new rebalance and all members must rejoin the group&lt;/li&gt;
	&lt;li&gt;Thread 1 again lists non-empty state directories in order to report the offset&apos;s it has in it&apos;s state stores as part of it&apos;s metadata. Prior to doing so, it clears it&apos;s in-memory store tracking the locks it has taken for the purpose of gathering rebalance metadata&lt;/li&gt;
	&lt;li&gt;Thread 1 no longer takes a lock on 0_1 as it is empty&lt;/li&gt;
	&lt;li&gt;However, that lock on 0_1 owned by Thread 1 remains in StateDirectory&lt;/li&gt;
	&lt;li&gt;All consumers re-join and sync successfully, receiving their new assignments&lt;/li&gt;
	&lt;li&gt;Thread 2 on Instance B is assigned task 0_1&lt;/li&gt;
	&lt;li&gt;Thread 2 cannot take a lock on 0_1 in the StateDirectory because it is still being held by Thread 1&lt;/li&gt;
	&lt;li&gt;Thread 2 remains in rebalancing state, and cannot make progress on task 0_1, or any other tasks it has assigned.&lt;/li&gt;
&lt;/ol&gt;
</description>
                <environment>Linux</environment>
        <key id="13562131">KAFKA-16025</key>
            <summary>Streams StateDirectory has orphaned locks after rebalancing, blocking future rebalancing</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sabitn">Sabit</assignee>
                                    <reporter username="sabitn">Sabit</reporter>
                        <labels>
                    </labels>
                <created>Mon, 18 Dec 2023 00:08:07 +0000</created>
                <updated>Thu, 7 Mar 2024 20:41:07 +0000</updated>
                            <resolved>Mon, 8 Jan 2024 22:51:45 +0000</resolved>
                                    <version>3.4.0</version>
                                    <fixVersion>3.7.1</fixVersion>
                    <fixVersion>3.8.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17801223" author="JIRAUSER303392" created="Fri, 29 Dec 2023 16:53:46 +0000"  >&lt;p&gt;Submitted PR: &lt;a href=&quot;https://github.com/apache/kafka/pull/15088&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/15088&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17801927" author="ableegoldman" created="Tue, 2 Jan 2024 21:10:24 +0000"  >&lt;p&gt;Nice find and writeup of the race condition &#8211; I&apos;ll take a look at the fix&lt;/p&gt;</comment>
                            <comment id="17804498" author="ableegoldman" created="Mon, 8 Jan 2024 22:52:39 +0000"  >&lt;p&gt;FYI &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sabitn&quot; class=&quot;user-hover&quot; rel=&quot;sabitn&quot;&gt;sabitn&lt;/a&gt; I added you as a Jira contributor so you should now be able to self-assign any tickets you are working on. Thanks again for the fix!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 44 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1mb8g:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>