<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:13:16 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-7182] SASL/OAUTHBEARER client response is missing %x01 separators</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-7182</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;The format of the SASL/OAUTHBEARER client response is defined in &lt;a href=&quot;https://tools.ietf.org/html/rfc7628#section-3.1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;RFC 7628 Section 3.1&lt;/a&gt; as follows:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;     kvsep          = %x01
     key            = 1*(ALPHA)
     value          = *(VCHAR / SP / HTAB / CR / LF )
     kvpair         = key &quot;=&quot; value kvsep
     client-resp    = (gs2-header kvsep *kvpair kvsep) / kvsep
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;;;gs2-header = See &lt;a href=&quot;https://tools.ietf.org/html/rfc5801#section-4&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;RFC 5801 (Section 4)&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The SASL/OAUTHBEARER client response as currently implemented in OAuthBearerSaslClient sends the valid gs2-header &quot;n,,&quot; but then sends the &quot;auth&quot; key and value immediately after it, like this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.format(&lt;span class=&quot;code-quote&quot;&gt;&quot;n,,auth=Bearer %s&quot;&lt;/span&gt;, callback.token().value())
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This does not conform to the specification because there is no %x01 after the gs2-header, no %x01 after the auth value, and no terminating %x01.  The code should instead be as follows:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.format(&lt;span class=&quot;code-quote&quot;&gt;&quot;n,,\u0001auth=Bearer %s\u0001\u0001&quot;&lt;/span&gt;, callback.token().value())
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Similarly, the parsing of the client response in OAuthBearerSaslServer, which currently allows the malformed text, must also change.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;This should be fixed prior to the initial release of the SASL/OAUTHBEARER code in 2.0.0 to prevent compatibility problems.&lt;/b&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13173026">KAFKA-7182</key>
            <summary>SASL/OAUTHBEARER client response is missing %x01 separators</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rndgstn">Ron Dagostino</assignee>
                                    <reporter username="rndgstn">Ron Dagostino</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Wed, 18 Jul 2018 20:28:05 +0000</created>
                <updated>Thu, 19 Jul 2018 16:58:25 +0000</updated>
                            <resolved>Thu, 19 Jul 2018 16:58:25 +0000</resolved>
                                    <version>2.0.0</version>
                                    <fixVersion>2.0.0</fixVersion>
                                    <component>clients</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="16548399" author="githubbot" created="Wed, 18 Jul 2018 21:03:10 +0000"  >&lt;p&gt;rondagostino opened a new pull request #5391: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7182&quot; title=&quot;SASL/OAUTHBEARER client response is missing %x01 separators&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7182&quot;&gt;&lt;del&gt;KAFKA-7182&lt;/del&gt;&lt;/a&gt;: SASL/OAUTHBEARER client response missing %x01 seps&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5391&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5391&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   The format of the SASL/OAUTHBEARER client response is defined in&lt;br/&gt;
   RFC 7628 Section 3.1 as follows:&lt;/p&gt;

&lt;p&gt;        kvsep          = %x01&lt;br/&gt;
        key            = 1*(ALPHA)&lt;br/&gt;
        value          = *(VCHAR / SP / HTAB / CR / LF )&lt;br/&gt;
        kvpair         = key &quot;=&quot; value kvsep&lt;br/&gt;
        client-resp    = (gs2-header kvsep *kvpair kvsep) / kvsep&lt;/p&gt;

&lt;p&gt;   ;;gs2-header = See RFC 5801 (Section 4)&lt;/p&gt;

&lt;p&gt;   The SASL/OAUTHBEARER client response as currently implemented in&lt;br/&gt;
   OAuthBearerSaslClient sends the valid gs2-header &quot;n,,&quot; but then&lt;br/&gt;
   sends the &quot;auth&quot; key and value immediately after it, like this:&lt;/p&gt;

&lt;p&gt;   String.format(&quot;n,,auth=Bearer %s&quot;, callback.token().value())&lt;/p&gt;

&lt;p&gt;   This does not conform to the specification because there is no&lt;br/&gt;
   %x01 after the gs2-header, no %x01 after the auth value, and no&lt;br/&gt;
   terminating %x01. The code should instead be as follows:&lt;/p&gt;

&lt;p&gt;   String.format(&quot;n,,\u0001auth=Bearer %s\u0001\u0001&quot;,&lt;br/&gt;
   callback.token().value())&lt;/p&gt;

&lt;p&gt;   Similarly, the parsing of the client response in&lt;br/&gt;
   OAuthBearerSaslServer, which currently allows the malformed text,&lt;br/&gt;
   must also change.&lt;/p&gt;

&lt;p&gt;   This should be fixed prior to the initial release of the&lt;br/&gt;
   SASL/OAUTHBEARER code in 2.0.0 to prevent compatibility problems.&lt;/p&gt;

&lt;p&gt;   Signed-off-by: Ron Dagostino &amp;lt;rndgstn@gmail.com&amp;gt;&lt;/p&gt;

&lt;p&gt;   *More detailed description of your change,&lt;br/&gt;
   if necessary. The PR title and PR message become&lt;br/&gt;
   the squashed commit message, so use a separate&lt;br/&gt;
   comment to ping reviewers.*&lt;/p&gt;

&lt;p&gt;   *Summary of testing strategy (including rationale)&lt;br/&gt;
   for the feature or bug fix. Unit and/or integration&lt;br/&gt;
   tests are expected for any behaviour change and&lt;br/&gt;
   system tests should be considered for larger changes.*&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16549542" author="githubbot" created="Thu, 19 Jul 2018 16:53:50 +0000"  >&lt;p&gt;rajinisivaram closed pull request #5391: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7182&quot; title=&quot;SASL/OAUTHBEARER client response is missing %x01 separators&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7182&quot;&gt;&lt;del&gt;KAFKA-7182&lt;/del&gt;&lt;/a&gt;: SASL/OAUTHBEARER client response missing %x01 seps&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5391&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5391&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/clients/src/main/java/org/apache/kafka/common/security/oauthbearer/internals/OAuthBearerClientInitialResponse.java b/clients/src/main/java/org/apache/kafka/common/security/oauthbearer/internals/OAuthBearerClientInitialResponse.java&lt;br/&gt;
new file mode 100644&lt;br/&gt;
index 00000000000..8d4b18aede6&lt;br/&gt;
&amp;#8212; /dev/null&lt;br/&gt;
+++ b/clients/src/main/java/org/apache/kafka/common/security/oauthbearer/internals/OAuthBearerClientInitialResponse.java&lt;br/&gt;
@@ -0,0 +1,96 @@&lt;br/&gt;
+/*&lt;br/&gt;
+ * Licensed to the Apache Software Foundation (ASF) under one or more&lt;br/&gt;
+ * contributor license agreements. See the NOTICE file distributed with&lt;br/&gt;
+ * this work for additional information regarding copyright ownership.&lt;br/&gt;
+ * The ASF licenses this file to You under the Apache License, Version 2.0&lt;br/&gt;
+ * (the &quot;License&quot;); you may not use this file except in compliance with&lt;br/&gt;
+ * the License. You may obtain a copy of the License at&lt;br/&gt;
+ *&lt;br/&gt;
+ *    &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
+ *&lt;br/&gt;
+ * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
+ * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
+ * See the License for the specific language governing permissions and&lt;br/&gt;
+ * limitations under the License.&lt;br/&gt;
+ */&lt;br/&gt;
+package org.apache.kafka.common.security.oauthbearer.internals;&lt;br/&gt;
+&lt;br/&gt;
+import org.apache.kafka.common.utils.Utils;&lt;br/&gt;
+&lt;br/&gt;
+import javax.security.sasl.SaslException;&lt;br/&gt;
+import java.nio.charset.StandardCharsets;&lt;br/&gt;
+import java.util.HashMap;&lt;br/&gt;
+import java.util.Map;&lt;br/&gt;
+import java.util.regex.Matcher;&lt;br/&gt;
+import java.util.regex.Pattern;&lt;br/&gt;
+&lt;br/&gt;
+public class OAuthBearerClientInitialResponse {&lt;br/&gt;
+    static final String SEPARATOR = &quot;\u0001&quot;;&lt;br/&gt;
+&lt;br/&gt;
+    private static final String SASLNAME = &quot;(?:&lt;a href=&quot;file://x01-//x7F&amp;amp;&amp;amp;[^=,]&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;\\x01-\\x7F&amp;amp;&amp;amp;[^=,]&lt;/a&gt;|=2C|=3D)+&quot;;&lt;br/&gt;
+    private static final String KEY = &quot;&lt;span class=&quot;error&quot;&gt;&amp;#91;A-Za-z&amp;#93;&lt;/span&gt;+&quot;;&lt;br/&gt;
+    private static final String VALUE = &quot;&lt;a href=&quot;file://x21-//x7E /t/r/n&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;\\x21-\\x7E \t\r\n&lt;/a&gt;+&quot;;&lt;br/&gt;
+    private static final String KVPAIRS = String.format(&quot;(%s=%s%s)*&quot;, KEY, VALUE, SEPARATOR);&lt;br/&gt;
+    private static final Pattern AUTH_PATTERN = Pattern.compile(&quot;(?&amp;lt;scheme&amp;gt;&lt;a href=&quot;file://w&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;\\w&lt;/a&gt;&lt;ins&gt;)[ ]&lt;/ins&gt;(?&amp;lt;token&amp;gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;-_\\.a-zA-Z0-9&amp;#93;&lt;/span&gt;+)&quot;);&lt;br/&gt;
+    private static final Pattern CLIENT_INITIAL_RESPONSE_PATTERN = Pattern.compile(&lt;br/&gt;
+            String.format(&quot;n,(a=(?&amp;lt;authzid&amp;gt;%s))?,%s(?&amp;lt;kvpairs&amp;gt;%s)%s&quot;, SASLNAME, SEPARATOR, KVPAIRS, SEPARATOR));&lt;br/&gt;
+    private static final String AUTH_KEY = &quot;auth&quot;;&lt;br/&gt;
+&lt;br/&gt;
+    private final String tokenValue;&lt;br/&gt;
+    private final String authorizationId;&lt;br/&gt;
+    private final Map&amp;lt;String, String&amp;gt; properties;&lt;br/&gt;
+&lt;br/&gt;
+    public OAuthBearerClientInitialResponse(byte[] response) throws SaslException {&lt;br/&gt;
+        String responseMsg = new String(response, StandardCharsets.UTF_8);&lt;br/&gt;
+        Matcher matcher = CLIENT_INITIAL_RESPONSE_PATTERN.matcher(responseMsg);&lt;br/&gt;
+        if (!matcher.matches())&lt;br/&gt;
+            throw new SaslException(&quot;Invalid OAUTHBEARER client first message&quot;);&lt;br/&gt;
+        String authzid = matcher.group(&quot;authzid&quot;);&lt;br/&gt;
+        this.authorizationId = authzid == null ? &quot;&quot; : authzid;&lt;br/&gt;
+        String kvPairs = matcher.group(&quot;kvpairs&quot;);&lt;br/&gt;
+        this.properties = Utils.parseMap(kvPairs, &quot;=&quot;, SEPARATOR);&lt;br/&gt;
+        String auth = properties.get(AUTH_KEY);&lt;br/&gt;
+        if (auth == null)&lt;br/&gt;
+            throw new SaslException(&quot;Invalid OAUTHBEARER client first message: &apos;auth&apos; not specified&quot;);&lt;br/&gt;
+&lt;br/&gt;
+        Matcher authMatcher = AUTH_PATTERN.matcher(auth);&lt;br/&gt;
+        if (!authMatcher.matches())&lt;br/&gt;
+            throw new SaslException(&quot;Invalid OAUTHBEARER client first message: invalid &apos;auth&apos; format&quot;);&lt;br/&gt;
+        if (!&quot;bearer&quot;.equalsIgnoreCase(authMatcher.group(&quot;scheme&quot;))) &lt;/p&gt;
{
+            String msg = String.format(&quot;Invalid scheme in OAUTHBEARER client first message: %s&quot;,
+                    matcher.group(&quot;scheme&quot;));
+            throw new SaslException(msg);
+        }
&lt;p&gt;+        this.tokenValue = authMatcher.group(&quot;token&quot;);&lt;br/&gt;
+    }&lt;br/&gt;
+&lt;br/&gt;
+    public OAuthBearerClientInitialResponse(String tokenValue) &lt;/p&gt;
{
+        this(tokenValue, &quot;&quot;, new HashMap&amp;lt;&amp;gt;());
+    }
&lt;p&gt;+&lt;br/&gt;
+    public OAuthBearerClientInitialResponse(String tokenValue, String authorizationId, Map&amp;lt;String, String&amp;gt; props) &lt;/p&gt;
{
+        this.tokenValue = tokenValue;
+        this.authorizationId = authorizationId == null ? &quot;&quot; : authorizationId;
+        this.properties = new HashMap&amp;lt;&amp;gt;(props);
+    }
&lt;p&gt;+&lt;br/&gt;
+    public byte[] toBytes() &lt;/p&gt;
{
+        String authzid = authorizationId.isEmpty() ? &quot;&quot; : &quot;a=&quot; + authorizationId;
+        String message = String.format(&quot;n,%s,%sauth=Bearer %s%s%s&quot;, authzid,
+                SEPARATOR, tokenValue, SEPARATOR, SEPARATOR);
+        return message.getBytes(StandardCharsets.UTF_8);
+    }
&lt;p&gt;+&lt;br/&gt;
+    public String tokenValue() &lt;/p&gt;
{
+        return tokenValue;
+    }
&lt;p&gt;+&lt;br/&gt;
+    public String authorizationId() &lt;/p&gt;
{
+        return authorizationId;
+    }
&lt;p&gt;+&lt;br/&gt;
+    public String propertyValue(String name) &lt;/p&gt;
{
+        return properties.get(name);
+    }
&lt;p&gt;+}&lt;br/&gt;
diff --git a/clients/src/main/java/org/apache/kafka/common/security/oauthbearer/internals/OAuthBearerSaslClient.java b/clients/src/main/java/org/apache/kafka/common/security/oauthbearer/internals/OAuthBearerSaslClient.java&lt;br/&gt;
index 66942ba96bd..4d4ee57b3a8 100644&lt;br/&gt;
&amp;#8212; a/clients/src/main/java/org/apache/kafka/common/security/oauthbearer/internals/OAuthBearerSaslClient.java&lt;br/&gt;
+++ b/clients/src/main/java/org/apache/kafka/common/security/oauthbearer/internals/OAuthBearerSaslClient.java&lt;br/&gt;
@@ -88,8 +88,7 @@ public boolean hasInitialResponse() {&lt;br/&gt;
                         throw new SaslException(&quot;Expected empty challenge&quot;);&lt;br/&gt;
                     callbackHandler().handle(new Callback[] &lt;/p&gt;
{callback});&lt;br/&gt;
                     setState(State.RECEIVE_SERVER_FIRST_MESSAGE);&lt;br/&gt;
-                    return String.format(&quot;n,,auth=Bearer %s&quot;, callback.token().value())&lt;br/&gt;
-                            .getBytes(StandardCharsets.UTF_8);&lt;br/&gt;
+                    return new OAuthBearerClientInitialResponse(callback.token().value()).toBytes();&lt;br/&gt;
                 case RECEIVE_SERVER_FIRST_MESSAGE:&lt;br/&gt;
                     if (challenge != null &amp;amp;&amp;amp; challenge.length != 0) {&lt;br/&gt;
                         String jsonErrorResponse = new String(challenge, StandardCharsets.UTF_8);&lt;br/&gt;
diff --git a/clients/src/main/java/org/apache/kafka/common/security/oauthbearer/internals/OAuthBearerSaslServer.java b/clients/src/main/java/org/apache/kafka/common/security/oauthbearer/internals/OAuthBearerSaslServer.java&lt;br/&gt;
index 5d1f224883b..aacc8fa3cbb 100644&lt;br/&gt;
&amp;#8212; a/clients/src/main/java/org/apache/kafka/common/security/oauthbearer/internals/OAuthBearerSaslServer.java&lt;br/&gt;
+++ b/clients/src/main/java/org/apache/kafka/common/security/oauthbearer/internals/OAuthBearerSaslServer.java&lt;br/&gt;
@@ -21,8 +21,6 @@&lt;br/&gt;
 import java.util.Arrays;&lt;br/&gt;
 import java.util.Map;&lt;br/&gt;
 import java.util.Objects;&lt;br/&gt;
-import java.util.regex.Matcher;&lt;br/&gt;
-import java.util.regex.Pattern;&lt;br/&gt;
 &lt;br/&gt;
 import javax.security.auth.callback.Callback;&lt;br/&gt;
 import javax.security.auth.callback.CallbackHandler;&lt;br/&gt;
@@ -48,13 +46,9 @@&lt;br/&gt;
  * for example).&lt;br/&gt;
  */&lt;br/&gt;
 public class OAuthBearerSaslServer implements SaslServer {&lt;br/&gt;
-    private static final String INVALID_OAUTHBEARER_CLIENT_FIRST_MESSAGE = &quot;Invalid OAUTHBEARER client first message&quot;;&lt;br/&gt;
     private static final Logger log = LoggerFactory.getLogger(OAuthBearerSaslServer.class);&lt;br/&gt;
     private static final String NEGOTIATED_PROPERTY_KEY_TOKEN = OAuthBearerLoginModule.OAUTHBEARER_MECHANISM + &quot;.token&quot;;&lt;br/&gt;
     private static final String INTERNAL_ERROR_ON_SERVER = &quot;Authentication could not be performed due to an internal error on the server&quot;;&lt;br/&gt;
-    private static final String SASLNAME = &quot;(?:&lt;a href=&quot;file://x01-//x7F&amp;amp;&amp;amp;[^=,]&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;\\x01-\\x7F&amp;amp;&amp;amp;[^=,]&lt;/a&gt;|=2C|=3D)+&quot;;&lt;br/&gt;
-    private static final Pattern CLIENT_INITIAL_RESPONSE_PATTERN = Pattern.compile(&lt;br/&gt;
-            String.format(&quot;n,(a=(?&amp;lt;authzid&amp;gt;%s))?,auth=(?&amp;lt;scheme&amp;gt;&lt;a href=&quot;file://w&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;\\w&lt;/a&gt;&lt;ins&gt;)[ ]&lt;/ins&gt;(?&amp;lt;token&amp;gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;-_\\.a-zA-Z0-9&amp;#93;&lt;/span&gt;+)&quot;, SASLNAME));&lt;br/&gt;
 &lt;br/&gt;
     private final AuthenticateCallbackHandler callbackHandler;&lt;br/&gt;
 &lt;br/&gt;
@@ -90,24 +84,14 @@ public OAuthBearerSaslServer(CallbackHandler callbackHandler) {
             throw new SaslAuthenticationException(errorMessage);
         }&lt;br/&gt;
         errorMessage = null;&lt;br/&gt;
-        String responseMsg = new String(response, StandardCharsets.UTF_8);&lt;br/&gt;
-        Matcher matcher = CLIENT_INITIAL_RESPONSE_PATTERN.matcher(responseMsg);&lt;br/&gt;
-        if (!matcher.matches()) {
-            if (log.isDebugEnabled())
-                log.debug(INVALID_OAUTHBEARER_CLIENT_FIRST_MESSAGE);
-            throw new SaslException(INVALID_OAUTHBEARER_CLIENT_FIRST_MESSAGE);
-        }&lt;br/&gt;
-        String authzid = matcher.group(&quot;authzid&quot;);&lt;br/&gt;
-        String authorizationId = authzid != null ? authzid : &quot;&quot;;&lt;br/&gt;
-        if (!&quot;bearer&quot;.equalsIgnoreCase(matcher.group(&quot;scheme&quot;))) {&lt;br/&gt;
-            String msg = String.format(&quot;Invalid scheme in OAUTHBEARER client first message: %s&quot;,&lt;br/&gt;
-                    matcher.group(&quot;scheme&quot;));&lt;br/&gt;
-            if (log.isDebugEnabled())&lt;br/&gt;
-                log.debug(msg);&lt;br/&gt;
-            throw new SaslException(msg);&lt;br/&gt;
+        OAuthBearerClientInitialResponse clientResponse;&lt;br/&gt;
+        try {
+            clientResponse = new OAuthBearerClientInitialResponse(response);
+        } catch (SaslException e) {
+            log.debug(e.getMessage());
+            throw e;
         }&lt;br/&gt;
-        String tokenValue = matcher.group(&quot;token&quot;);&lt;br/&gt;
-        return process(tokenValue, authorizationId);&lt;br/&gt;
+        return process(clientResponse.tokenValue(), clientResponse.authorizationId());&lt;br/&gt;
     }&lt;br/&gt;
 &lt;br/&gt;
     @Override&lt;br/&gt;
diff --git a/clients/src/main/java/org/apache/kafka/common/security/scram/internals/ScramExtensions.java b/clients/src/main/java/org/apache/kafka/common/security/scram/internals/ScramExtensions.java&lt;br/&gt;
index cbfca13dbf2..5028329feb1 100644&lt;br/&gt;
&amp;#8212; a/clients/src/main/java/org/apache/kafka/common/security/scram/internals/ScramExtensions.java&lt;br/&gt;
+++ b/clients/src/main/java/org/apache/kafka/common/security/scram/internals/ScramExtensions.java&lt;br/&gt;
@@ -17,9 +17,9 @@&lt;br/&gt;
 package org.apache.kafka.common.security.scram.internals;&lt;br/&gt;
 &lt;br/&gt;
 import org.apache.kafka.common.security.scram.ScramLoginModule;&lt;br/&gt;
+import org.apache.kafka.common.utils.Utils;&lt;br/&gt;
 &lt;br/&gt;
 import java.util.Collections;&lt;br/&gt;
-import java.util.HashMap;&lt;br/&gt;
 import java.util.Map;&lt;br/&gt;
 import java.util.Set;&lt;br/&gt;
 &lt;br/&gt;
@@ -31,7 +31,7 @@ public ScramExtensions() {&lt;br/&gt;
     }&lt;br/&gt;
 &lt;br/&gt;
     public ScramExtensions(String extensions) {
-        this(stringToMap(extensions));
+        this(Utils.parseMap(extensions, &quot;=&quot;, &quot;,&quot;));
     }&lt;br/&gt;
 &lt;br/&gt;
     public ScramExtensions(Map&amp;lt;String, String&amp;gt; extensionMap) {&lt;br/&gt;
@@ -52,29 +52,6 @@ public boolean tokenAuthenticated() {&lt;br/&gt;
 &lt;br/&gt;
     @Override&lt;br/&gt;
     public String toString() {
-        return mapToString(extensionMap);
-    }&lt;br/&gt;
-&lt;br/&gt;
-    private static Map&amp;lt;String, String&amp;gt; stringToMap(String extensions) {&lt;br/&gt;
-        Map&amp;lt;String, String&amp;gt; extensionMap = new HashMap&amp;lt;&amp;gt;();&lt;br/&gt;
-&lt;br/&gt;
-        if (!extensions.isEmpty()) {&lt;br/&gt;
-            String[] attrvals = extensions.split(&quot;,&quot;);&lt;br/&gt;
-            for (String attrval : attrvals) {
-                String[] array = attrval.split(&quot;=&quot;, 2);
-                extensionMap.put(array[0], array[1]);
-            }&lt;br/&gt;
-        }&lt;br/&gt;
-        return extensionMap;&lt;br/&gt;
-    }&lt;br/&gt;
-&lt;br/&gt;
-    private static String mapToString(Map&amp;lt;String, String&amp;gt; extensionMap) {&lt;br/&gt;
-        StringBuilder builder = new StringBuilder();&lt;br/&gt;
-        for (Map.Entry&amp;lt;String, String&amp;gt; entry : extensionMap.entrySet()) {
-            builder.append(entry.getKey());
-            builder.append(&apos;=&apos;);
-            builder.append(entry.getValue());
-        }&lt;br/&gt;
-        return builder.toString();&lt;br/&gt;
+        return Utils.mkString(extensionMap, &quot;&quot;, &quot;&quot;, &quot;=&quot;, &quot;,&quot;);&lt;br/&gt;
     }&lt;br/&gt;
 }&lt;br/&gt;
\ No newline at end of file&lt;br/&gt;
diff --git a/clients/src/main/java/org/apache/kafka/common/utils/Utils.java b/clients/src/main/java/org/apache/kafka/common/utils/Utils.java&lt;br/&gt;
index 31fa01cfc8f..330f968e409 100755&lt;br/&gt;
&amp;#8212; a/clients/src/main/java/org/apache/kafka/common/utils/Utils.java&lt;br/&gt;
+++ b/clients/src/main/java/org/apache/kafka/common/utils/Utils.java&lt;br/&gt;
@@ -512,6 +512,19 @@ public static String formatBytes(long bytes) {
         return bld.toString();
     }&lt;br/&gt;
 &lt;br/&gt;
+    public static Map&amp;lt;String, String&amp;gt; parseMap(String mapStr, String keyValueSeparator, String elementSeparator) {&lt;br/&gt;
+        Map&amp;lt;String, String&amp;gt; map = new HashMap&amp;lt;&amp;gt;();&lt;br/&gt;
+&lt;br/&gt;
+        if (!mapStr.isEmpty()) {&lt;br/&gt;
+            String[] attrvals = mapStr.split(elementSeparator);&lt;br/&gt;
+            for (String attrval : attrvals) {
+                String[] array = attrval.split(keyValueSeparator, 2);
+                map.put(array[0], array[1]);
+            }&lt;br/&gt;
+        }&lt;br/&gt;
+        return map;&lt;br/&gt;
+    }&lt;br/&gt;
+&lt;br/&gt;
     /**&lt;br/&gt;
      * Read a properties file from the given path&lt;br/&gt;
      * @param filename The path of the file to read&lt;br/&gt;
diff --git a/clients/src/test/java/org/apache/kafka/common/security/oauthbearer/internals/OAuthBearerClientInitialResponseTest.java b/clients/src/test/java/org/apache/kafka/common/security/oauthbearer/internals/OAuthBearerClientInitialResponseTest.java&lt;br/&gt;
new file mode 100644&lt;br/&gt;
index 00000000000..eccf2dd2ed4&lt;br/&gt;
&amp;#8212; /dev/null&lt;br/&gt;
+++ b/clients/src/test/java/org/apache/kafka/common/security/oauthbearer/internals/OAuthBearerClientInitialResponseTest.java&lt;br/&gt;
@@ -0,0 +1,65 @@&lt;br/&gt;
+/*&lt;br/&gt;
+ * Licensed to the Apache Software Foundation (ASF) under one or more&lt;br/&gt;
+ * contributor license agreements. See the NOTICE file distributed with&lt;br/&gt;
+ * this work for additional information regarding copyright ownership.&lt;br/&gt;
+ * The ASF licenses this file to You under the Apache License, Version 2.0&lt;br/&gt;
+ * (the &quot;License&quot;); you may not use this file except in compliance with&lt;br/&gt;
+ * the License. You may obtain a copy of the License at&lt;br/&gt;
+ *&lt;br/&gt;
+ *    &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
+ *&lt;br/&gt;
+ * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
+ * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
+ * See the License for the specific language governing permissions and&lt;br/&gt;
+ * limitations under the License.&lt;br/&gt;
+ */&lt;br/&gt;
+package org.apache.kafka.common.security.oauthbearer.internals;&lt;br/&gt;
+&lt;br/&gt;
+import static org.junit.Assert.assertEquals;&lt;br/&gt;
+&lt;br/&gt;
+import org.junit.Test;&lt;br/&gt;
+&lt;br/&gt;
+import java.nio.charset.StandardCharsets;&lt;br/&gt;
+&lt;br/&gt;
+public class OAuthBearerClientInitialResponseTest {&lt;br/&gt;
+&lt;br/&gt;
+    @Test&lt;br/&gt;
+    public void testToken() throws Exception {
+        String message = &quot;n,,\u0001auth=Bearer 123.345.567\u0001\u0001&quot;;
+        OAuthBearerClientInitialResponse response = new OAuthBearerClientInitialResponse(message.getBytes(StandardCharsets.UTF_8));
+        assertEquals(&quot;123.345.567&quot;, response.tokenValue());
+        assertEquals(&quot;&quot;, response.authorizationId());
+    }&lt;br/&gt;
+&lt;br/&gt;
+    @Test&lt;br/&gt;
+    public void testAuthorizationId() throws Exception {
+        String message = &quot;n,a=myuser,\u0001auth=Bearer 345\u0001\u0001&quot;;
+        OAuthBearerClientInitialResponse response = new OAuthBearerClientInitialResponse(message.getBytes(StandardCharsets.UTF_8));
+        assertEquals(&quot;345&quot;, response.tokenValue());
+        assertEquals(&quot;myuser&quot;, response.authorizationId());
+    }&lt;br/&gt;
+&lt;br/&gt;
+    @Test&lt;br/&gt;
+    public void testProperties() throws Exception {
+        String message = &quot;n,,\u0001propA=valueA1, valueA2\u0001auth=Bearer 567\u0001propB=valueB\u0001\u0001&quot;;
+        OAuthBearerClientInitialResponse response = new OAuthBearerClientInitialResponse(message.getBytes(StandardCharsets.UTF_8));
+        assertEquals(&quot;567&quot;, response.tokenValue());
+        assertEquals(&quot;&quot;, response.authorizationId());
+        assertEquals(&quot;valueA1, valueA2&quot;, response.propertyValue(&quot;propA&quot;));
+        assertEquals(&quot;valueB&quot;, response.propertyValue(&quot;propB&quot;));
+    }&lt;br/&gt;
+&lt;br/&gt;
+    // The example in the RFC uses `vF9dft4qmTc2Nvb3RlckBhbHRhdmlzdGEuY29tCg==` as the token&lt;br/&gt;
+    // But since we use Base64Url encoding, padding is omitted. Hence this test verifies without &apos;=&apos;.&lt;br/&gt;
+    @Test&lt;br/&gt;
+    public void testRfc7688Example() throws Exception {
+        String message = &quot;n,a=user@example.com,\u0001host=server.example.com\u0001port=143\u0001&quot; +
+                &quot;auth=Bearer vF9dft4qmTc2Nvb3RlckBhbHRhdmlzdGEuY29tCg\u0001\u0001&quot;;
+        OAuthBearerClientInitialResponse response = new OAuthBearerClientInitialResponse(message.getBytes(StandardCharsets.UTF_8));
+        assertEquals(&quot;vF9dft4qmTc2Nvb3RlckBhbHRhdmlzdGEuY29tCg&quot;, response.tokenValue());
+        assertEquals(&quot;user@example.com&quot;, response.authorizationId());
+        assertEquals(&quot;server.example.com&quot;, response.propertyValue(&quot;host&quot;));
+        assertEquals(&quot;143&quot;, response.propertyValue(&quot;port&quot;));
+    }&lt;br/&gt;
+}&lt;br/&gt;
diff --git a/clients/src/test/java/org/apache/kafka/common/security/oauthbearer/internals/OAuthBearerSaslServerTest.java b/clients/src/test/java/org/apache/kafka/common/security/oauthbearer/internals/OAuthBearerSaslServerTest.java&lt;br/&gt;
index bf21f2b3430..6b53e963af7 100644&lt;br/&gt;
&amp;#8212; a/clients/src/test/java/org/apache/kafka/common/security/oauthbearer/internals/OAuthBearerSaslServerTest.java&lt;br/&gt;
+++ b/clients/src/test/java/org/apache/kafka/common/security/oauthbearer/internals/OAuthBearerSaslServerTest.java&lt;br/&gt;
@@ -75,39 +75,41 @@ public void setUp() throws Exception {&lt;br/&gt;
     @Test&lt;br/&gt;
     public void noAuthorizationIdSpecified() throws Exception {
         byte[] nextChallenge = saslServer
-                .evaluateResponse(clientInitialResponseText(null).getBytes(StandardCharsets.UTF_8));
+                .evaluateResponse(clientInitialResponse(null));
         assertTrue(&quot;Next challenge is not empty&quot;, nextChallenge.length == 0);
     }&lt;br/&gt;
 &lt;br/&gt;
     @Test&lt;br/&gt;
     public void authorizatonIdEqualsAuthenticationId() throws Exception {
         byte[] nextChallenge = saslServer
-                .evaluateResponse(clientInitialResponseText(USER).getBytes(StandardCharsets.UTF_8));
+                .evaluateResponse(clientInitialResponse(USER));
         assertTrue(&quot;Next challenge is not empty&quot;, nextChallenge.length == 0);
     }&lt;br/&gt;
 &lt;br/&gt;
     @Test(expected = SaslAuthenticationException.class)&lt;br/&gt;
     public void authorizatonIdNotEqualsAuthenticationId() throws Exception {
-        saslServer.evaluateResponse(clientInitialResponseText(USER + &quot;x&quot;).getBytes(StandardCharsets.UTF_8));
+        saslServer.evaluateResponse(clientInitialResponse(USER + &quot;x&quot;));
     }&lt;br/&gt;
 &lt;br/&gt;
     @Test&lt;br/&gt;
     public void illegalToken() throws Exception {&lt;br/&gt;
-        byte[] bytes = saslServer&lt;br/&gt;
-                .evaluateResponse((clientInitialResponseText(null) + &quot;AB&quot;).getBytes(StandardCharsets.UTF_8));&lt;br/&gt;
+        byte[] bytes = saslServer.evaluateResponse(clientInitialResponse(null, true));&lt;br/&gt;
         String challenge = new String(bytes, StandardCharsets.UTF_8);&lt;br/&gt;
         assertEquals(&quot;{\&quot;status\&quot;:\&quot;invalid_token\&quot;}&quot;, challenge);&lt;br/&gt;
     }&lt;br/&gt;
 &lt;br/&gt;
-    private String clientInitialResponseText(String authorizationId)&lt;br/&gt;
+    private byte[] clientInitialResponse(String authorizationId)&lt;br/&gt;
+            throws OAuthBearerConfigException, IOException, UnsupportedCallbackException, LoginException {
+        return clientInitialResponse(authorizationId, false);
+    }&lt;br/&gt;
+&lt;br/&gt;
+    private byte[] clientInitialResponse(String authorizationId, boolean illegalToken)&lt;br/&gt;
             throws OAuthBearerConfigException, IOException, UnsupportedCallbackException, LoginException {&lt;br/&gt;
         OAuthBearerTokenCallback callback = new OAuthBearerTokenCallback();&lt;br/&gt;
         LOGIN_CALLBACK_HANDLER.handle(new Callback[] {callback}
&lt;p&gt;);&lt;br/&gt;
         OAuthBearerToken token = callback.token();&lt;br/&gt;
         String compactSerialization = token.value();&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;String clientInitialResponseText = &quot;n,&quot;&lt;/li&gt;
	&lt;li&gt;+ (authorizationId == null || authorizationId.isEmpty() ? &quot;&quot; : &quot;a=&quot; + authorizationId) + &quot;,auth=Bearer &quot;&lt;/li&gt;
	&lt;li&gt;+ compactSerialization;&lt;/li&gt;
	&lt;li&gt;return clientInitialResponseText;&lt;br/&gt;
+        String tokenValue = compactSerialization + (illegalToken ? &quot;AB&quot; : &quot;&quot;);&lt;br/&gt;
+        return new OAuthBearerClientInitialResponse(tokenValue, authorizationId, Collections.emptyMap()).toBytes();&lt;br/&gt;
     }&lt;br/&gt;
 }&lt;/li&gt;
&lt;/ul&gt;





&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10431"><![CDATA[Important]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 17 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3w1h3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>rsivaram</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>