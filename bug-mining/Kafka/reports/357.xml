<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:39:15 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-1098] Unit test failure in 0.8.1 related to LogCleaner</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-1098</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Floor = 0, To = -1&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2013-10-22 09:39:25,001&amp;#93;&lt;/span&gt; ERROR Error in cleaner thread 0: (kafka.log.LogCleaner:103)&lt;br/&gt;
java.lang.IllegalArgumentException: inconsistent range&lt;br/&gt;
	at java.util.concurrent.ConcurrentSkipListMap$SubMap.&amp;lt;init&amp;gt;(ConcurrentSkipListMap.java:2506)&lt;br/&gt;
	at java.util.concurrent.ConcurrentSkipListMap.subMap(ConcurrentSkipListMap.java:1984)&lt;br/&gt;
	at kafka.log.Log.logSegments(Log.scala:605)&lt;br/&gt;
	at kafka.log.LogToClean.&amp;lt;init&amp;gt;(LogCleaner.scala:596)&lt;br/&gt;
	at kafka.log.LogCleaner$$anonfun$5.apply(LogCleaner.scala:137)&lt;br/&gt;
	at kafka.log.LogCleaner$$anonfun$5.apply(LogCleaner.scala:137)&lt;br/&gt;
	at scala.collection.TraversableLike$$anonfun$map$1.apply(TraversableLike.scala:206)&lt;br/&gt;
	at scala.collection.TraversableLike$$anonfun$map$1.apply(TraversableLike.scala:206)&lt;br/&gt;
	at scala.collection.LinearSeqOptimized$class.foreach(LinearSeqOptimized.scala:61)&lt;br/&gt;
	at scala.collection.immutable.List.foreach(List.scala:45)&lt;br/&gt;
	at scala.collection.TraversableLike$class.map(TraversableLike.scala:206)&lt;br/&gt;
	at scala.collection.immutable.List.map(List.scala:45)&lt;br/&gt;
	at kafka.log.LogCleaner.kafka$log$LogCleaner$$grabFilthiestLog(LogCleaner.scala:137)&lt;br/&gt;
	at kafka.log.LogCleaner$CleanerThread.cleanOrSleep(LogCleaner.scala:203)&lt;br/&gt;
	at kafka.log.LogCleaner$CleanerThread.run(LogCleaner.scala:189)&lt;/p&gt;</description>
                <environment></environment>
        <key id="12675058">KAFKA-1098</key>
            <summary>Unit test failure in 0.8.1 related to LogCleaner</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jkreps">Jay Kreps</assignee>
                                    <reporter username="nehanarkhede">Neha Narkhede</reporter>
                        <labels>
                    </labels>
                <created>Tue, 22 Oct 2013 16:43:05 +0000</created>
                <updated>Fri, 25 Oct 2013 04:35:04 +0000</updated>
                            <resolved>Fri, 25 Oct 2013 04:35:04 +0000</resolved>
                                    <version>0.8.1</version>
                                                    <component>log</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="13802119" author="jvanremoortere" created="Tue, 22 Oct 2013 18:46:56 +0000"  >&lt;p&gt;logSegments can currently be called with to = -1. This can trigger submap to be called with invalid arguments (i.e. from &amp;gt; to). We catch this case and return an empty iterable of logSegments.&lt;/p&gt;</comment>
                            <comment id="13802477" author="jjkoshy" created="Wed, 23 Oct 2013 00:53:23 +0000"  >&lt;p&gt;Thanks for the patch - this is interesting/weird.&lt;/p&gt;

&lt;p&gt;The real issue seems to be that since the map is defined as &lt;tt&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Long, LogSegment&amp;#93;&lt;/span&gt;&lt;/tt&gt; the null return of floorKey is getting converted to a 0 Long value and failing the eq null check.&lt;/p&gt;

&lt;p&gt;i.e., the actual from value is also -1. floorKey should return null (and it does) but it is implicitly converted to 0, so it does not enter the &lt;tt&gt;floor eq null&lt;/tt&gt; block but we want it to.&lt;/p&gt;

&lt;p&gt;I&apos;m wondering if we should just switch the map to use java.lang.Long instead of scala Long to avoid these implicit conversions.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;scala&amp;gt; val m = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ConcurrentSkipListMap[&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;, Any]
m: java.util.concurrent.ConcurrentSkipListMap[&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;,Any] = {}

scala&amp;gt; m.floorKey(0)
res10: &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt; = 0

scala&amp;gt; val m = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ConcurrentSkipListMap[java.lang.&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;, Any]
m: java.util.concurrent.ConcurrentSkipListMap[java.lang.&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;,Any] = {}

scala&amp;gt; m.floorKey(0)
res11: java.lang.&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt; = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13802481" author="jvanremoortere" created="Wed, 23 Oct 2013 01:03:05 +0000"  >&lt;p&gt;I think the behavior is dependent on the version of Scala used. When I first wrote the patch for Kafka-1042 I was using 2.9.2. This error seems to arise when using 2.8.0.&lt;br/&gt;
Your suggestion makes sense, I&apos;m not sure what the plan is for supporting older versions of Scala.&lt;/p&gt;</comment>
                            <comment id="13802572" author="nehanarkhede" created="Wed, 23 Oct 2013 04:01:56 +0000"  >&lt;p&gt;+1 on &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jjkoshy&quot; class=&quot;user-hover&quot; rel=&quot;jjkoshy&quot;&gt;jjkoshy&lt;/a&gt;&apos;s suggestion. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jvanremoortere&quot; class=&quot;user-hover&quot; rel=&quot;jvanremoortere&quot;&gt;jvanremoortere&lt;/a&gt; Would you like to take a stab at that?&lt;/p&gt;</comment>
                            <comment id="13802585" author="jkreps" created="Wed, 23 Oct 2013 04:20:19 +0000"  >&lt;p&gt;Joel, I think you&apos;re right. I can grab this.&lt;/p&gt;</comment>
                            <comment id="13802605" author="jkreps" created="Wed, 23 Oct 2013 04:52:37 +0000"  >&lt;p&gt;Here is a patch that seems to fix the issue. &lt;/p&gt;</comment>
                            <comment id="13802606" author="jkreps" created="Wed, 23 Oct 2013 04:53:22 +0000"  >&lt;p&gt;Sorry about the churn btw I was only compiling for 2.9 which obviously isn&apos;t enough.&lt;/p&gt;</comment>
                            <comment id="13802950" author="junrao" created="Wed, 23 Oct 2013 15:30:05 +0000"  >&lt;p&gt;Thanks for the patch. It doesn&apos;t compile with scala 2.10.1 though since asIterable no longer exists there. I guess we have to import all JavaConversions._ to get around the cross compilation issue.&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;error&amp;#93;&lt;/span&gt; /Users/jrao/Intellij/kafka_git/core/src/main/scala/kafka/log/Log.scala:589: value asIterable is not a member of object scala.collection.JavaConversions&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;error&amp;#93;&lt;/span&gt;     import JavaConversions.asIterable&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;error&amp;#93;&lt;/span&gt;            ^&lt;/p&gt;

&lt;p&gt;Also, in the following places, should we use eq to test null for the returned entry from the skipListMap?&lt;/p&gt;

&lt;p&gt;In read(),&lt;br/&gt;
    if(startOffset &amp;gt; next || entry == null)&lt;/p&gt;

&lt;p&gt;In roll(),&lt;br/&gt;
      segments.lastEntry() match &lt;/p&gt;
{
        case null =&amp;gt; 
        case entry =&amp;gt; entry.getValue.index.trimToValidSize()
      }</comment>
                            <comment id="13803005" author="jvanremoortere" created="Wed, 23 Oct 2013 16:36:26 +0000"  >&lt;p&gt;Is the list of Scala versions in the README file (2.8.0, 2.8.2, 2.9.1, 2.9.2 or 2.10.1) a full and  accurate representation of the versions we intend to support? I can be more thorough in running the test suite under each one, but am not sure which versions I need to test.&lt;/p&gt;</comment>
                            <comment id="13804881" author="nehanarkhede" created="Fri, 25 Oct 2013 00:59:27 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jvanremoortere&quot; class=&quot;user-hover&quot; rel=&quot;jvanremoortere&quot;&gt;jvanremoortere&lt;/a&gt; That list of Scala versions is correct.&lt;/p&gt;</comment>
                            <comment id="13804984" author="jkreps" created="Fri, 25 Oct 2013 03:44:52 +0000"  >&lt;p&gt;Ack, fixed 2.10 issue. Frustrating. Do we have a single sbt command that can compile for all?&lt;/p&gt;

&lt;p&gt;Jun--the other two null comparisons are for entries not offsets so == should be valid there.&lt;/p&gt;</comment>
                            <comment id="13805013" author="junrao" created="Fri, 25 Oct 2013 04:29:09 +0000"  >&lt;p&gt;+1 for v3. &lt;/p&gt;

&lt;p&gt;To compile in all versions of scala, do the following. It&apos;s included in README.md&lt;br/&gt;
 ./sbt +package&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12609802" name="KAFKA-1098-v2.patch" size="2069" author="jkreps" created="Wed, 23 Oct 2013 04:52:37 +0000"/>
                            <attachment id="12610260" name="KAFKA-1098-v3.patch" size="1665" author="jkreps" created="Fri, 25 Oct 2013 03:44:52 +0000"/>
                            <attachment id="12609702" name="kafka_1098-v1.patch" size="1190" author="jvanremoortere" created="Tue, 22 Oct 2013 18:46:56 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>354680</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 4 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1p5an:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>354969</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>