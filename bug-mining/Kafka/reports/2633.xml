<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:23:52 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-9972] Corrupted standby task could be committed</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-9972</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;A corrupted standby task could revive and transit to the CREATED state, which will then trigger by `taskManager.commitAll` in next runOnce, causing an illegal state:&lt;/p&gt;

&lt;p&gt;```&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;2020-05-07T20:57:23-07:00&amp;#93;&lt;/span&gt; (streams-soak-trunk-eos-beta_soak_i-0f819f0a58017b05b_streamslog) &lt;span class=&quot;error&quot;&gt;&amp;#91;2020-05-08 03:57:22,646&amp;#93;&lt;/span&gt; WARN &lt;span class=&quot;error&quot;&gt;&amp;#91;stream-soak-test-5ab3951c-2ca8-40a8-9096-0957e70a21b7-StreamThread-1&amp;#93;&lt;/span&gt; stream-thread &lt;span class=&quot;error&quot;&gt;&amp;#91;stream-soak-test-5ab3951c-2ca8-40a8-9096-0957e70a21b7-StreamThread-1&amp;#93;&lt;/span&gt; Encountered org.apache.kafka.clients.consumer.OffsetOutOfRangeException fetching records from restore consumer for partitions &lt;span class=&quot;error&quot;&gt;&amp;#91;stream-soak-test-KSTREAM-AGGREGATE-STATE-STORE-0000000019-changelog-1&amp;#93;&lt;/span&gt;, it is likely that the consumer&apos;s position has fallen out of the topic partition offset range because the topic was truncated or compacted on the broker, marking the corresponding tasks as corrupted and re-initializing it later. (org.apache.kafka.streams.processor.internals.StoreChangelogReader)&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;2020-05-07T20:57:23-07:00&amp;#93;&lt;/span&gt; (streams-soak-trunk-eos-beta_soak_i-0f819f0a58017b05b_streamslog) &lt;span class=&quot;error&quot;&gt;&amp;#91;2020-05-08 03:57:22,646&amp;#93;&lt;/span&gt; WARN &lt;span class=&quot;error&quot;&gt;&amp;#91;stream-soak-test-5ab3951c-2ca8-40a8-9096-0957e70a21b7-StreamThread-1&amp;#93;&lt;/span&gt; stream-thread &lt;span class=&quot;error&quot;&gt;&amp;#91;stream-soak-test-5ab3951c-2ca8-40a8-9096-0957e70a21b7-StreamThread-1&amp;#93;&lt;/span&gt; Detected the states of tasks {1_1=&lt;span class=&quot;error&quot;&gt;&amp;#91;stream-soak-test-KSTREAM-AGGREGATE-STATE-STORE-0000000019-changelog-1&amp;#93;&lt;/span&gt;} are corrupted. Will close the task as dirty and re-create and bootstrap from scratch. (org.apache.kafka.streams.processor.internals.StreamThread)&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;2020-05-07T20:57:23-07:00&amp;#93;&lt;/span&gt; (streams-soak-trunk-eos-beta_soak_i-0f819f0a58017b05b_streamslog) org.apache.kafka.streams.errors.TaskCorruptedException: Tasks with changelogs {1_1=&lt;span class=&quot;error&quot;&gt;&amp;#91;stream-soak-test-KSTREAM-AGGREGATE-STATE-STORE-0000000019-changelog-1&amp;#93;&lt;/span&gt;} are corrupted and hence needs to be re-initialized&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; at org.apache.kafka.streams.processor.internals.StoreChangelogReader.restore(StoreChangelogReader.java:428)&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; at org.apache.kafka.streams.processor.internals.StreamThread.runOnce(StreamThread.java:680)&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; at org.apache.kafka.streams.processor.internals.StreamThread.runLoop(StreamThread.java:558)&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; at org.apache.kafka.streams.processor.internals.StreamThread.run(StreamThread.java:517)&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;2020-05-07T20:57:23-07:00&amp;#93;&lt;/span&gt; (streams-soak-trunk-eos-beta_soak_i-0f819f0a58017b05b_streamslog) &lt;span class=&quot;error&quot;&gt;&amp;#91;2020-05-08 03:57:22,652&amp;#93;&lt;/span&gt; INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;stream-soak-test-5ab3951c-2ca8-40a8-9096-0957e70a21b7-StreamThread-1&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;Consumer clientId=stream-soak-test-5ab3951c-2ca8-40a8-9096-0957e70a21b7-StreamThread-1-restore-consumer, groupId=null&amp;#93;&lt;/span&gt; Unsubscribed all topics or patterns and assigned partitions (org.apache.kafka.clients.consumer.KafkaConsumer)&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;2020-05-07T20:57:23-07:00&amp;#93;&lt;/span&gt; (streams-soak-trunk-eos-beta_soak_i-0f819f0a58017b05b_streamslog) &lt;span class=&quot;error&quot;&gt;&amp;#91;2020-05-08 03:57:22,652&amp;#93;&lt;/span&gt; INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;stream-soak-test-5ab3951c-2ca8-40a8-9096-0957e70a21b7-StreamThread-1&amp;#93;&lt;/span&gt; stream-thread &lt;span class=&quot;error&quot;&gt;&amp;#91;stream-soak-test-5ab3951c-2ca8-40a8-9096-0957e70a21b7-StreamThread-1&amp;#93;&lt;/span&gt; standby-task &lt;span class=&quot;error&quot;&gt;&amp;#91;1_1&amp;#93;&lt;/span&gt; Prepared dirty close (org.apache.kafka.streams.processor.internals.StandbyTask)&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;2020-05-07T20:57:23-07:00&amp;#93;&lt;/span&gt; (streams-soak-trunk-eos-beta_soak_i-0f819f0a58017b05b_streamslog) &lt;span class=&quot;error&quot;&gt;&amp;#91;2020-05-08 03:57:22,679&amp;#93;&lt;/span&gt; INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;stream-soak-test-5ab3951c-2ca8-40a8-9096-0957e70a21b7-StreamThread-1&amp;#93;&lt;/span&gt; stream-thread &lt;span class=&quot;error&quot;&gt;&amp;#91;stream-soak-test-5ab3951c-2ca8-40a8-9096-0957e70a21b7-StreamThread-1&amp;#93;&lt;/span&gt; standby-task &lt;span class=&quot;error&quot;&gt;&amp;#91;1_1&amp;#93;&lt;/span&gt; Closed dirty (org.apache.kafka.streams.processor.internals.StandbyTask)&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;2020-05-07T20:57:23-07:00&amp;#93;&lt;/span&gt; (streams-soak-trunk-eos-beta_soak_i-0f819f0a58017b05b_streamslog) &lt;span class=&quot;error&quot;&gt;&amp;#91;2020-05-08 03:57:22,751&amp;#93;&lt;/span&gt; ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;stream-soak-test-5ab3951c-2ca8-40a8-9096-0957e70a21b7-StreamThread-1&amp;#93;&lt;/span&gt; stream-thread &lt;span class=&quot;error&quot;&gt;&amp;#91;stream-soak-test-5ab3951c-2ca8-40a8-9096-0957e70a21b7-StreamThread-1&amp;#93;&lt;/span&gt; Encountered the following exception during processing and the thread is going to shut down:&#160; (org.apache.kafka.streams.processor.internals.StreamThread)&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;2020-05-07T20:57:23-07:00&amp;#93;&lt;/span&gt; (streams-soak-trunk-eos-beta_soak_i-0f819f0a58017b05b_streamslog) java.lang.IllegalStateException: Illegal state CREATED while preparing standby task 1_1 for committing&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; at org.apache.kafka.streams.processor.internals.StandbyTask.prepareCommit(StandbyTask.java:134)&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; at org.apache.kafka.streams.processor.internals.TaskManager.commit(TaskManager.java:752)&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; at org.apache.kafka.streams.processor.internals.TaskManager.commitAll(TaskManager.java:741)&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; at org.apache.kafka.streams.processor.internals.StreamThread.maybeCommit(StreamThread.java:863)&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; at org.apache.kafka.streams.processor.internals.StreamThread.runOnce(StreamThread.java:725)&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; at org.apache.kafka.streams.processor.internals.StreamThread.runLoop(StreamThread.java:558)&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; at org.apache.kafka.streams.processor.internals.StreamThread.run(StreamThread.java:517)&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;2020-05-07T20:57:23-07:00&amp;#93;&lt;/span&gt; (streams-soak-trunk-eos-beta_soak_i-0f819f0a58017b05b_streamslog) &lt;span class=&quot;error&quot;&gt;&amp;#91;2020-05-08 03:57:22,751&amp;#93;&lt;/span&gt; INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;stream-soak-test-5ab3951c-2ca8-40a8-9096-0957e70a21b7-StreamThread-1&amp;#93;&lt;/span&gt; stream-thread &lt;span class=&quot;error&quot;&gt;&amp;#91;stream-soak-test-5ab3951c-2ca8-40a8-9096-0957e70a21b7-StreamThread-1&amp;#93;&lt;/span&gt; State transition from RUNNING to PENDING_SHUTDOWN (org.apache.kafka.streams.processor.internals.StreamThread)&lt;/p&gt;

&lt;p&gt;```&lt;/p&gt;

&lt;p&gt;Two solutions here: either we deprecate `commitAll` and always enforce state check to selectively commit tasks, or we enforce a state check inside standby task commitNeeded call to reference its state. Added a fix for option one here.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13303550">KAFKA-9972</key>
            <summary>Corrupted standby task could be committed</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="bchen225242">Boyang Chen</assignee>
                                    <reporter username="bchen225242">Boyang Chen</reporter>
                        <labels>
                    </labels>
                <created>Fri, 8 May 2020 05:57:37 +0000</created>
                <updated>Thu, 23 Jan 2025 20:09:54 +0000</updated>
                            <resolved>Mon, 11 May 2020 23:48:45 +0000</resolved>
                                                    <fixVersion>2.6.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="17102926" author="ableegoldman" created="Fri, 8 May 2020 20:45:49 +0000"  >&lt;p&gt;I see that we already committed a fix for this, but I&apos;m a little concerned that we&apos;re only covering this one specific use case rather than the general problem of illegally attempting to commit a task in CREATED. AFAIK the corrupted standby case is just the one we happened to catch in soak, not the only possible case. WDYT? cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vvcephei&quot; class=&quot;user-hover&quot; rel=&quot;vvcephei&quot;&gt;vvcephei&lt;/a&gt; &#8211; see comment on&#160;&lt;a href=&quot;https://github.com/apache/kafka/commit/7907b5a6e921cec3b5fad2a4f84a78a851140755#r39046991&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/commit/7907b5a6e921cec3b5fad2a4f84a78a851140755#r39046991&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17103400" author="vvcephei" created="Sat, 9 May 2020 18:12:35 +0000"  >&lt;p&gt;Hi Sophie,&lt;/p&gt;

&lt;p&gt;You hinted at a general solution, but I&#8217;m not sure exactly what you would propose. If I have to guess, maybe you mean we should push the filter inside of commitAll, so then all callers would just call commitAll() with the understanding it would skip over any tasks not in a commit-friendly state?&lt;/p&gt;</comment>
                            <comment id="17103577" author="ableegoldman" created="Sun, 10 May 2020 01:05:48 +0000"  >&lt;p&gt;Not exactly, I was proposing to remove the filter entirely and just handle each state inside Task#commit.&#160;That is, instead of throwing an exception inside Task#commit if the task is anything other than RUNNING or RESTORING, we just don&apos;t do anything. Like we do in Task#suspend, for example: the TaskManager shouldn&apos;t have to keep track of which task API&apos;s it&apos;s allowed to call on a task of a given state, it should just call the API and have the Task implementation choose the appropriate action based on its state.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;We&apos;ve pushed most of the task state handling into the Task implementation already, but some of it still bleeds into the TaskManager. It would be nice to be consistent and establish reasonable expectations for the TaskManager: to take another example, Task#initializeIfNeeded allows all task states but only takes any action if the state is CREATED. But Task#completeRestoration will throw an exception if the task is not in RESTORING.&#160;&lt;/p&gt;</comment>
                            <comment id="17103949" author="mjsax" created="Sun, 10 May 2020 21:06:06 +0000"  >&lt;blockquote&gt;&lt;p&gt;the TaskManager shouldn&apos;t have to keep track of which task API&apos;s it&apos;s allowed to call on a task of a given state&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I am not sure about this. For example, is state is not initialized and the TM tries to process data on that task, it indicates a bug and the task should not just do a no-op.&lt;/p&gt;

&lt;p&gt;I guess the original refactoring might not have been totally strict and I agree that we should define some contract who we want to handle it. \cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17104536" author="vvcephei" created="Mon, 11 May 2020 15:06:33 +0000"  >&lt;p&gt;Thanks for the clarification. The reason I didn&#8217;t choose to do that in the original fix is that committing is not encapsulated inside the task. The algorithm looks like:&lt;br/&gt;
1. prepareCommit&lt;br/&gt;
2. Do other stuff for the commit&lt;br/&gt;
3. Commit&lt;/p&gt;

&lt;p&gt;If all three parts have to reason about the state of the task, which could even change in the middle, we wind up with a significantly more complicated algorithm. Much better if we just assert that we never even try to commit unless the task is in a legal state for committing. &lt;/p&gt;</comment>
                            <comment id="17104732" author="ableegoldman" created="Mon, 11 May 2020 18:08:32 +0000"  >&lt;p&gt;Fair enough. Then would you propose that the contract should be: Task implementation validates and enforces the state for any multi-phase API (eg preCommit + postCommit) but accepts and internally handles any fully encapsulated API (eg initializeIfNeeded). I don&apos;t think we need to drop everything to get all the existing APIs in line, but it would be nice to have something informing future changes in the TaskManager-Task interactions.&lt;/p&gt;

&lt;p&gt;Anyways, in that case then I&apos;ll amend my proposal for this specific topic and instead suggest we go through the same TaskManager code path for all committing. We&apos;re still vulnerable to calling Task#commit on a CREATED task in #handleAssignment at least.&#160;&lt;/p&gt;

&lt;p&gt;I&apos;d also prefer to do the task filtration in TaskManager rather than in StreamThread. If we can&apos;t keep this logic encapsulated inside Task, we should at least aim to keep it encapsulated inside TaskManager. Compare with TaskManager#tryToCompleteRestoration for example, which filters out the non-RESTORING tasks inside the TaskManager (of course, whether we have to do this filtering at all for Task#completeRestoration is a question for the above contract..)&lt;/p&gt;</comment>
                            <comment id="17104766" author="guozhang" created="Mon, 11 May 2020 19:11:18 +0000"  >&lt;p&gt;Since at least for now the task-manager (and then its included tasks) are processed single-threaded, the task state should not be changed in 1/2/3 steps above, so I think just checking the state of the task is fine. This is also because today we have three steps as John listed above.&lt;/p&gt;

&lt;p&gt;If we can actually merge them in one call as part of the cleanup (which I think may be possible as we discussed in the other PR), then I&apos;m more inclined to Sophie&apos;s proposal as to let the task itself decide whether it should commit or not and not exposing the state out of it to the task-manager (I know today even without this we already have other places where task-manager checks the state of individual tasks, but personally I think it&apos;s better if we can make them all captured inside task itself... just my preference).&lt;/p&gt;</comment>
                            <comment id="17104990" author="vvcephei" created="Tue, 12 May 2020 00:57:37 +0000"  >&lt;p&gt;Thanks, all. To be clear, I also prefer Sophie&#8217;s suggestion to keep the state check internal in a world where &#8220;commit&#8221; is just a single call and we can safely encapsulate the state check as &#8220;task has not been running, therefore nothing to commit, so we can safely ignore&#8221;.&lt;/p&gt;</comment>
                            <comment id="17104991" author="vvcephei" created="Tue, 12 May 2020 00:58:28 +0000"  >&lt;p&gt;Oh, and I would also be in favor of at least encapsulating the state check into the TaskManager.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 27 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0ei1s:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>