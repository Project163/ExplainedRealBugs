<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:39:08 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-16570] FenceProducers API returns &quot;unexpected error&quot; when successful</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-16570</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;When we want to fence a producer using the admin client, we send an InitProducerId request.&lt;/p&gt;

&lt;p&gt;There is logic in that API to fence (and abort) any ongoing transactions and that is what the API relies on to fence the producer. However, this handling also returns CONCURRENT_TRANSACTIONS. In normal usage, this is good because we want to actually get a new producer ID and want to retry until the the ID is supplied or we time out. &#160;&lt;a href=&quot;https://github.com/apache/kafka/blob/5193eb93237ba9093ae444d73a1eaa2d6abcc9c1/core/src/main/scala/kafka/coordinator/transaction/TransactionCoordinator.scala#L170&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/5193eb93237ba9093ae444d73a1eaa2d6abcc9c1/core/src/main/scala/kafka/coordinator/transaction/TransactionCoordinator.scala#L170&lt;/a&gt;&#160;&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/kafka/blob/a3dcbd4e28a35f79f75ec1bf316ef0b39c0df164/clients/src/main/java/org/apache/kafka/clients/producer/internals/TransactionManager.java#L1322&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/a3dcbd4e28a35f79f75ec1bf316ef0b39c0df164/clients/src/main/java/org/apache/kafka/clients/producer/internals/TransactionManager.java#L1322&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;In the case of fence producer, we don&apos;t retry and instead we have no handling for concurrent transactions and log a message about an unexpected error.&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/kafka/blob/a3dcbd4e28a35f79f75ec1bf316ef0b39c0df164/clients/src/main/java/org/apache/kafka/clients/admin/internals/FenceProducersHandler.java#L112&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/a3dcbd4e28a35f79f75ec1bf316ef0b39c0df164/clients/src/main/java/org/apache/kafka/clients/admin/internals/FenceProducersHandler.java#L112&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;This is not unexpected though and the operation was successful. We should just swallow this error and treat this as a successful run of the command.&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13576119">KAFKA-16570</key>
            <summary>FenceProducers API returns &quot;unexpected error&quot; when successful</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ecomar">Edoardo Comar</assignee>
                                    <reporter username="jolshan">Justine Olshan</reporter>
                        <labels>
                    </labels>
                <created>Tue, 16 Apr 2024 21:49:50 +0000</created>
                <updated>Fri, 14 Jun 2024 15:12:41 +0000</updated>
                            <resolved>Thu, 13 Jun 2024 13:04:54 +0000</resolved>
                                                    <fixVersion>3.7.1</fixVersion>
                    <fixVersion>3.8.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="17837902" author="jolshan" created="Tue, 16 Apr 2024 21:52:50 +0000"  >&lt;p&gt;cc: &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ChrisEgerton&quot; class=&quot;user-hover&quot; rel=&quot;ChrisEgerton&quot;&gt;ChrisEgerton&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=showuon&quot; class=&quot;user-hover&quot; rel=&quot;showuon&quot;&gt;showuon&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tombentley&quot; class=&quot;user-hover&quot; rel=&quot;tombentley&quot;&gt;tombentley&lt;/a&gt; as author and reviewers of the original change.&lt;/p&gt;</comment>
                            <comment id="17838786" author="alivshits" created="Thu, 18 Apr 2024 20:12:54 +0000"  >&lt;p&gt;&amp;gt; We should just swallow this error and treat this as a successful run of the command.&#160;&lt;/p&gt;

&lt;p&gt;I think we should instead implement retries and fail if we cannot succeed within the command timeout.&lt;/p&gt;</comment>
                            <comment id="17838796" author="jolshan" created="Thu, 18 Apr 2024 21:00:42 +0000"  >&lt;p&gt;Hmmm &#8211; retries here are a bit strange since the command was successful, we will just return this error until we can allocate the new producer ID. I suppose this &quot;guarantees&quot; the markers were written, but it is not consistent with how end txn usually works.&lt;/p&gt;

&lt;p&gt;See how the error is return on success of the EndTxn api call? &lt;a href=&quot;https://github.com/apache/kafka/blob/53ff1a5a589eb0e30a302724fcf5d0c72c823682/core/src/main/scala/kafka/coordinator/transaction/TransactionCoordinator.scala#L175&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/53ff1a5a589eb0e30a302724fcf5d0c72c823682/core/src/main/scala/kafka/coordinator/transaction/TransactionCoordinator.scala#L175&lt;/a&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17851101" author="ecomar" created="Fri, 31 May 2024 13:43:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jolshan&quot; class=&quot;user-hover&quot; rel=&quot;jolshan&quot;&gt;jolshan&lt;/a&gt; I agree I too think that&lt;br/&gt;
FenceProducersHandler.handleError&lt;br/&gt;
should handle the CONCURRENT_TRANSACTIONS as a success and maybe log.debug or log.info it&lt;/p&gt;

&lt;p&gt;I used a simple test like&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
producer.initTransactions();
producer.beginTransaction();
producer.send(record).get();
producer.commitTransaction();

admin.fenceProducers(Collections.singleton(txId)).all().get();

producer.beginTransaction();
producer.send(record).get(); &lt;span class=&quot;code-comment&quot;&gt;//&lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; ProducerFenced&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;while&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
producer.initTransactions();
producer.beginTransaction();
producer.send(record).get();

admin.fenceProducers(Collections.singleton(txId)).all().get(); &lt;span class=&quot;code-comment&quot;&gt;//&lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; ConcurrentTransactionsException
&lt;/span&gt;
producer.commitTransaction(); &lt;span class=&quot;code-comment&quot;&gt;//2&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;however if the ConcurrentTransactionsException is swallowed, &lt;br/&gt;
then //2 throws ProducerFencedException as expected&lt;/p&gt;

&lt;p&gt;btw, just for the ... record, another &lt;br/&gt;
producer.send().get() &lt;br/&gt;
before commit would instead throw an InvalidProducerEpochException&lt;/p&gt;</comment>
                            <comment id="17851117" author="ecomar" created="Fri, 31 May 2024 14:13:43 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jolshan&quot; class=&quot;user-hover&quot; rel=&quot;jolshan&quot;&gt;jolshan&lt;/a&gt; I&apos;m happy to be a reviewer if you wan to make a PR, or if you want I can take this jira&lt;/p&gt;</comment>
                            <comment id="17851171" author="jolshan" created="Fri, 31 May 2024 18:18:49 +0000"  >&lt;p&gt;Hey &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ecomar&quot; class=&quot;user-hover&quot; rel=&quot;ecomar&quot;&gt;ecomar&lt;/a&gt;, thanks. If you don&apos;t mind assigning yourself to the JIRA, I can review it &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/thumbs_up.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; I&apos;ve been busy with other 3.8 stuff.&#160;&lt;/p&gt;</comment>
                            <comment id="17852018" author="ecomar" created="Tue, 4 Jun 2024 11:41:44 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-14657&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-14657&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17853610" author="ecomar" created="Mon, 10 Jun 2024 10:45:18 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/apache/kafka/pull/16229&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/16229&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17854748" author="ecomar" created="Thu, 13 Jun 2024 13:04:54 +0000"  >&lt;p&gt;fixed in trunk, 3.8.0 and 3.7.1&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13521793">KAFKA-14657</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 21 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1oomw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>