<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:02:07 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-5416] TransactionCoordinator doesn&apos;t complete transition to CompleteCommit</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-5416</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;In regard to this system test: &lt;a href=&quot;http://confluent-kafka-branch-builder-system-test-results.s3-us-west-2.amazonaws.com/2017-06-09--001.1496974430--apurvam--MINOR-add-logging-to-transaction-coordinator-in-all-failure-cases--02b3816/TransactionsTest/test_transactions/failure_mode=clean_bounce.bounce_target=brokers/4.tgz&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://confluent-kafka-branch-builder-system-test-results.s3-us-west-2.amazonaws.com/2017-06-09--001.1496974430--apurvam--MINOR-add-logging-to-transaction-coordinator-in-all-failure-cases--02b3816/TransactionsTest/test_transactions/failure_mode=clean_bounce.bounce_target=brokers/4.tgz&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Here are the ownership changes for __transaction_state-37: &lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;./worker1/debug/server.log:3623:[2017-06-09 01:16:36,551] INFO [Transaction Log Manager 2]: Trying to remove cached transaction metadata for __transaction_state-37 on follower transition but there is no entries remaining; it is likely that another process for removing the cached entries has just executed earlier before (kafka.coordinator.transaction.TransactionStateManager)
./worker1/debug/server.log:16174:[2017-06-09 01:16:39,963] INFO [Transaction Log Manager 2]: Loading transaction metadata from __transaction_state-37 (kafka.coordinator.transaction.TransactionStateManager)
./worker1/debug/server.log:16194:[2017-06-09 01:16:39,978] INFO [Transaction Log Manager 2]: Finished loading 1 transaction metadata from __transaction_state-37 in 15 milliseconds (kafka.coordinator.transaction.TransactionStateManager)
./worker1/debug/server.log:35633:[2017-06-09 01:16:45,308] INFO [Transaction Log Manager 2]: Removed 1 cached transaction metadata for __transaction_state-37 on follower transition (kafka.coordinator.transaction.TransactionStateManager)
./worker1/debug/server.log:40353:[2017-06-09 01:16:52,218] INFO [Transaction Log Manager 2]: Trying to remove cached transaction metadata for __transaction_state-37 on follower transition but there is no entries remaining; it is likelythat another process for removing the cached entries has just executed earlier before (kafka.coordinator.transaction.TransactionStateManager)
./worker1/debug/server.log:40664:[2017-06-09 01:16:52,683] INFO [Transaction Log Manager 2]: Trying to remove cached transaction metadata for __transaction_state-37 on follower transition but there is no entries remaining; it is likelythat another process for removing the cached entries has just executed earlier before (kafka.coordinator.transaction.TransactionStateManager)
./worker1/debug/server.log:146044:[2017-06-09 01:19:08,844] INFO [Transaction Log Manager 2]: Loading transaction metadata from __transaction_state-37 (kafka.coordinator.transaction.TransactionStateManager)
./worker1/debug/server.log:146048:[2017-06-09 01:19:08,850] INFO [Transaction Log Manager 2]: Finished loading 1 transaction metadata from __transaction_state-37 in 6 milliseconds (kafka.coordinator.transaction.TransactionStateManager)
./worker1/debug/server.log:150147:[2017-06-09 01:19:10,995] INFO [Transaction Log Manager 2]: Removed 1 cached transaction metadata for __transaction_state-37 on follower transition (kafka.coordinator.transaction.TransactionStateManager)
./worker2/debug/server.log:3413:[2017-06-09 01:16:36,109] INFO [Transaction Log Manager 1]: Loading transaction metadata from __transaction_state-37 (kafka.coordinator.transaction.TransactionStateManager)
./worker2/debug/server.log:20889:[2017-06-09 01:16:39,991] INFO [Transaction Log Manager 1]: Removed 1 cached transaction metadata for __transaction_state-37 on follower transition (kafka.coordinator.transaction.TransactionStateManager)
./worker2/debug/server.log:26084:[2017-06-09 01:16:46,682] INFO [Transaction Log Manager 1]: Trying to remove cached transaction metadata for __transaction_state-37 on follower transition but there is no entries remaining; it is likelythat another process for removing the cached entries has just executed earlier before (kafka.coordinator.transaction.TransactionStateManager)
./worker2/debug/server.log:26322:[2017-06-09 01:16:47,153] INFO [Transaction Log Manager 1]: Trying to remove cached transaction metadata for __transaction_state-37 on follower transition but there is no entries remaining; it is likelythat another process for removing the cached entries has just executed earlier before (kafka.coordinator.transaction.TransactionStateManager)
./worker2/debug/server.log:27320:[2017-06-09 01:16:50,748] INFO [Transaction Log Manager 1]: Loading transaction metadata from __transaction_state-37 (kafka.coordinator.transaction.TransactionStateManager)
./worker2/debug/server.log:27331:[2017-06-09 01:16:50,775] INFO [Transaction Log Manager 1]: Finished loading 1 transaction metadata from __transaction_state-37 in 27 milliseconds (kafka.coordinator.transaction.TransactionStateManager)
./worker2/debug/server.log:167429:[2017-06-09 01:19:08,857] INFO [Transaction Log Manager 1]: Removed 1 cached transaction metadata for __transaction_state-37 on follower transition (kafka.coordinator.transaction.TransactionStateManager)
./worker7/debug/server.log:2456:[2017-06-09 01:16:36,631] INFO [Transaction Log Manager 3]: Trying to remove cached transaction metadata for __transaction_state-37 on follower transition but there is no entries remaining; it is likely that another process for removing the cached entries has just executed earlier before (kafka.coordinator.transaction.TransactionStateManager)
./worker7/debug/server.log:8650:[2017-06-09 01:16:39,976] INFO [Transaction Log Manager 3]: Trying to remove cached transaction metadata for __transaction_state-37 on follower transition but there is no entries remaining; it is likely that another process for removing the cached entries has just executed earlier before (kafka.coordinator.transaction.TransactionStateManager)
./worker7/debug/server.log:13865:[2017-06-09 01:16:45,311] INFO [Transaction Log Manager 3]: Loading transaction metadata from __transaction_state-37 (kafka.coordinator.transaction.TransactionStateManager)
./worker7/debug/server.log:13879:[2017-06-09 01:16:45,336] INFO [Transaction Log Manager 3]: Finished loading 1 transaction metadata from __transaction_state-37 in 25 milliseconds (kafka.coordinator.transaction.TransactionStateManager)
./worker7/debug/server.log:44921:[2017-06-09 01:16:50,751] INFO [Transaction Log Manager 3]: Removed 1 cached transaction metadata for __transaction_state-37 on follower transition (kafka.coordinator.transaction.TransactionStateManager)
./worker7/debug/server.log:54228:[2017-06-09 01:16:58,681] INFO [Transaction Log Manager 3]: Trying to remove cached transaction metadata for __transaction_state-37 on follower transition but there is no entries remaining; it is likely that another process for removing the cached entries has just executed earlier before (kafka.coordinator.transaction.TransactionStateManager)
./worker7/debug/server.log:122047:[2017-06-09 01:19:08,855] INFO [Transaction Log Manager 3]: Trying to remove cached transaction metadata for __transaction_state-37 on follower transition but there is no entries remaining; it is likely that another process for removing the cached entries has just executed earlier before (kafka.coordinator.transaction.TransactionStateManager)
./worker7/debug/server.log:123425:[2017-06-09 01:19:11,014] INFO [Transaction Log Manager 3]: Loading transaction metadata from __transaction_state-37 (kafka.coordinator.transaction.TransactionStateManager)
./worker7/debug/server.log:123440:[2017-06-09 01:19:11,038] INFO [Transaction Log Manager 3]: Finished loading 1 transaction metadata from __transaction_state-37 in 24 milliseconds (kafka.coordinator.transaction.TransactionStateManager)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;At 01:16:50, worker2 gains ownership of this partition and retains it till 01:19:08.&lt;/p&gt;

&lt;p&gt;On, the client, the &apos;AddPartitions&apos; request constantly gets a CONCURRENT_TRANSACTIONS response from worker2 for 01:16:50 to 01:19:09 (when it finally gets a NOT_COORIDNATOR response due to brokers being shut down after test failure).&lt;/p&gt;

&lt;p&gt;The reason seems to be that the write of &apos;CompleteCommit&apos; to the log by the TransactionMarkerChannelManager is not being retried after failure. Here is the tail of the log for the transactionalId in question &apos;my-second-transactional-id&apos;&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[2017-06-09 01:16:50,782] DEBUG TransactionalId my-second-transactional-id prepare transition from PrepareCommit to TxnTransitMetadata(producerId=1, producerEpoch=0, txnTimeoutMs=60000, txnState=CompleteCommit, topicPartitions=Set(), txnStartTimestamp=1496971010483, txnLastUpdateTimestamp=1496971010776) (kafka.coordinator.transaction.TransactionMetadata)
[2017-06-09 01:16:50,844] DEBUG Updating my-second-transactional-id&apos;s transaction state to TransactionMetadata(transactionalId=my-second-transactional-id, producerId=1, producerEpoch=0, txnTimeoutMs=60000, state=PrepareCommit, pendingState=Some(CompleteCommit), topicPartitions=Set(), txnStartTimestamp=1496971010483, txnLastUpdateTimestamp=1496971010664) with coordinator epoch 3 for my-second-transactional-id succeeded (kafka.coordinator.transaction.TransactionMarkerChannelManager)
[2017-06-09 01:16:50,866] DEBUG [Transaction Log Manager 1]: Transaction state update TxnTransitMetadata(producerId=1, producerEpoch=0, txnTimeoutMs=60000, txnState=CompleteCommit, topicPartitions=Set(), txnStartTimestamp=1496971010483, txnLastUpdateTimestamp=1496971010776) for my-second-transactional-id failed when appending to log due to org.apache.kafka.common.errors.NotEnoughReplicasException (kafka.coordinator.transaction.TransactionStateManager)
[2017-06-09 01:16:50,866] INFO [Transaction Log Manager 1]: Appending transaction message TxnTransitMetadata(producerId=1, producerEpoch=0, txnTimeoutMs=60000, txnState=CompleteCommit, topicPartitions=Set(), txnStartTimestamp=1496971010483, txnLastUpdateTimestamp=1496971010776) for my-second-transactional-id failed due to org.apache.kafka.common.errors.NotEnoughReplicasException, returning COORDINATOR_NOT_AVAILABLE to the client (kafka.coordinator.transaction.TransactionStateManager)
[2017-06-09 01:16:50,867] DEBUG [Transaction Log Manager 1]: TransactionalId my-second-transactional-id, resetting pending state since we are returning error COORDINATOR_NOT_AVAILABLE (kafka.coordinator.transaction.TransactionStateManager)
[2017-06-09 01:16:50,868] WARN Failed updating transaction state for my-second-transactional-id when appending to transaction log due to org.apache.kafka.common.errors.CoordinatorNotAvailableException. retrying (kafka.coordinator.transaction.TransactionMarkerChannelManager)
[2017-06-09 01:16:50,870] DEBUG [Transaction Log Manager 1]: Transaction state update TxnTransitMetadata(producerId=1, producerEpoch=0, txnTimeoutMs=60000, txnState=CompleteCommit, topicPartitions=Set(), txnStartTimestamp=1496971010483, txnLastUpdateTimestamp=1496971010776) for my-second-transactional-id failed when appending to log due to org.apache.kafka.common.errors.NotEnoughReplicasException (kafka.coordinator.transaction.TransactionStateManager)
[2017-06-09 01:16:50,870] INFO [Transaction Log Manager 1]: Appending transaction message TxnTransitMetadata(producerId=1, producerEpoch=0, txnTimeoutMs=60000, txnState=CompleteCommit, topicPartitions=Set(), txnStartTimestamp=1496971010483, txnLastUpdateTimestamp=1496971010776) for my-second-transactional-id failed due to org.apache.kafka.common.errors.NotEnoughReplicasException, returning COORDINATOR_NOT_AVAILABLE to the client (kafka.coordinator.transaction.TransactionStateManager)
[2017-06-09 01:16:50,871] DEBUG [Transaction Log Manager 1]: TransactionalId my-second-transactional-id, resetting pending state since we are returning error COORDINATOR_NOT_AVAILABLE (kafka.coordinator.transaction.TransactionStateManager)
[2017-06-09 01:16:50,871] WARN Failed updating transaction state for my-second-transactional-id when appending to transaction log due to org.apache.kafka.common.errors.CoordinatorNotAvailableException. retrying (kafka.coordinator.transaction.TransactionMarkerChannelManager)
[2017-06-09 01:16:51,495] DEBUG [Transaction Log Manager 1]: Transaction state update TxnTransitMetadata(producerId=1, producerEpoch=0, txnTimeoutMs=60000, txnState=CompleteCommit, topicPartitions=Set(), txnStartTimestamp=1496971010483, txnLastUpdateTimestamp=1496971010776) for my-second-transactional-id failed when appending to log due to org.apache.kafka.common.errors.NotEnoughReplicasException (kafka.coordinator.transaction.TransactionStateManager)
[2017-06-09 01:16:51,496] INFO [Transaction Log Manager 1]: Appending transaction message TxnTransitMetadata(producerId=1, producerEpoch=0, txnTimeoutMs=60000, txnState=CompleteCommit, topicPartitions=Set(), txnStartTimestamp=1496971010483, txnLastUpdateTimestamp=1496971010776) for my-second-transactional-id failed due to org.apache.kafka.common.errors.NotEnoughReplicasException, returning COORDINATOR_NOT_AVAILABLE to the client (kafka.coordinator.transaction.TransactionStateManager)
[2017-06-09 01:16:51,496] DEBUG [Transaction Log Manager 1]: TransactionalId my-second-transactional-id, resetting pending state since we are returning error COORDINATOR_NOT_AVAILABLE (kafka.coordinator.transaction.TransactionStateManager)
[2017-06-09 01:16:51,496] WARN Failed updating transaction state for my-second-transactional-id when appending to transaction log due to org.apache.kafka.common.errors.CoordinatorNotAvailableException. retrying (kafka.coordinator.transaction.TransactionMarkerChannelManager)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It seems that the `TransactionManagerChannelManager` fails to retry the write of `CompleteCommit` when it fails initially. the `retryLogAppends` method has a debug log when messages are being retried, but this message is absent from the log. Could it be that the InterbrokerSendThread is in an inifinte poll? that certainly looks possible from the code. &lt;/p&gt;

&lt;p&gt;Further, since we return &apos;success&apos; to the client after the `PrepareCommit` is written to the log, and return a `CONCURRENT_TRANSACTIONS` error on a future `AddPartitions` request, we never move out of the `CompleteCommit` state, resulting in a hung transaction.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13078518">KAFKA-5416</key>
            <summary>TransactionCoordinator doesn&apos;t complete transition to CompleteCommit</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="guozhang">Guozhang Wang</assignee>
                                    <reporter username="apurva">Apurva Mehta</reporter>
                        <labels>
                            <label>exactly-once</label>
                    </labels>
                <created>Fri, 9 Jun 2017 06:41:29 +0000</created>
                <updated>Mon, 12 Jun 2017 19:51:36 +0000</updated>
                            <resolved>Mon, 12 Jun 2017 19:50:31 +0000</resolved>
                                                    <fixVersion>0.11.0.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16044045" author="apurva" created="Fri, 9 Jun 2017 06:48:10 +0000"  >&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=damianguy&quot; class=&quot;user-hover&quot; rel=&quot;damianguy&quot;&gt;damianguy&lt;/a&gt; &lt;/p&gt;

&lt;p&gt;A second pair of eyes making sense of these logs would help a lot.&lt;/p&gt;</comment>
                            <comment id="16044073" author="apurva" created="Fri, 9 Jun 2017 07:14:53 +0000"  >&lt;p&gt;Actually, my grep was bad. the &apos;retrying:&apos; message was printed, but I didn&apos;t capture it in my grep. Here is the relevant portion. We do retry, and do call `replicaManager.appendToLog` (we print the &apos;Appended new metadata ... &apos; message after calling the append.)&lt;/p&gt;

&lt;p&gt;But then we get no message in the cacheCallback, which is the mystery. &lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[2017-06-09 01:16:54,081] DEBUG retrying: 1 transaction log appends (kafka.coordinator.transaction.TransactionMarkerChannelManager)
[2017-06-09 01:16:54,089] DEBUG [Transaction Log Manager 1]: Appended new metadata TxnTransitMetadata(producerId=1, producerEpoch=0, txnTimeoutMs=60000, txnState=CompleteCommit, topicPartitions=Set(), txnStartTimestamp=1496971010483, txnLastUpdateTimestamp=1496971010776) for transaction id my-second-transactional-id with coordinator epoch 3 to the local transaction log (kafka.coordinator.transaction.TransactionStateManager)
[2017-06-09 01:16:54,091] DEBUG retrying: 0 transaction log appends (kafka.coordinator.transaction.TransactionMarkerChannelManager)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16044081" author="apurva" created="Fri, 9 Jun 2017 07:21:58 +0000"  >&lt;p&gt;It appears the &apos;CompleteCommit&apos; was written to the log:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;offset: 85 position: 14531 CreateTime: 1496971014082 isvalid: true keysize: 30 valuesize: 37 magic: 2 compresscodec: NONE producerId: -1 sequence: -1 isTransactional: false headerKeys: [] key: transactionalId=my-second-transactional-id payload: producerId:1,producerEpoch:0,state=CompleteCommit,partitions=Set(),lastUpdateTimestamp=1496971010776
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And the higwatermark was updated: &lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[2017-06-09 01:16:54,132] DEBUG Partition [__transaction_state,37] on broker 1: High watermark for partition [__transaction_state,37] updated to 86 [0 : 14667] (kafka.cluster.Partition)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So, very similar to &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5415&quot; title=&quot;TransactionCoordinator doesn&amp;#39;t complete transition to PrepareCommit state&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-5415&quot;&gt;&lt;del&gt;KAFKA-5415&lt;/del&gt;&lt;/a&gt;, the cache callback didn&apos;t seem to complete the state transition.&lt;/p&gt;</comment>
                            <comment id="16044082" author="apurva" created="Fri, 9 Jun 2017 07:23:54 +0000"  >&lt;p&gt;After more digging, this appears to be a duplicate of &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5415&quot; title=&quot;TransactionCoordinator doesn&amp;#39;t complete transition to PrepareCommit state&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-5415&quot;&gt;&lt;del&gt;KAFKA-5415&lt;/del&gt;&lt;/a&gt;, but the extra logging from &lt;a href=&quot;https://github.com/apache/kafka/pull/3278/files&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3278/files&lt;/a&gt; didn&apos;t help identify the root cause. &lt;/p&gt;</comment>
                            <comment id="16045044" author="apurva" created="Fri, 9 Jun 2017 21:19:59 +0000"  >&lt;p&gt;This is not a dup of &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5415&quot; title=&quot;TransactionCoordinator doesn&amp;#39;t complete transition to PrepareCommit state&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-5415&quot;&gt;&lt;del&gt;KAFKA-5415&lt;/del&gt;&lt;/a&gt;. Instead the cause for &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5415&quot; title=&quot;TransactionCoordinator doesn&amp;#39;t complete transition to PrepareCommit state&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-5415&quot;&gt;&lt;del&gt;KAFKA-5415&lt;/del&gt;&lt;/a&gt; explained by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; in &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5415?focusedCommentId=16044885&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-16044885&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-5415?focusedCommentId=16044885&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-16044885&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;actually applies to this ticket. &lt;/p&gt;</comment>
                            <comment id="16045195" author="githubbot" created="Fri, 9 Jun 2017 23:08:35 +0000"  >&lt;p&gt;GitHub user guozhangwang opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/3287&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3287&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5416&quot; title=&quot;TransactionCoordinator doesn&amp;#39;t complete transition to CompleteCommit&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-5416&quot;&gt;&lt;del&gt;KAFKA-5416&lt;/del&gt;&lt;/a&gt;: Re-prepare transition to CompleteCommit/Abort upon retrying append to log&lt;/p&gt;

&lt;p&gt;    In `TransationStateManager`, we reset the pending state if an error occurred while appending to log; this is correct except that for the `TransactionMarkerChannelManager`, as it will retry appending to log and if eventually it succeeded, the transaction metadata&apos;s completing transition will throw an IllegalStateException since pending state is None, this will be thrown all the way to the `KafkaApis` and be swallowed.&lt;/p&gt;

&lt;p&gt;    1. When re-enqueueing to the retry append queue, re-prepare transition to set its pending state.&lt;br/&gt;
    2. A bunch of log4j improvements based the debugging experience. The main principle is to make sure all error codes that is about to sent to the client will be logged, and unnecessary log4j entries to be removed.&lt;br/&gt;
    3. Also moved some log entries in ReplicationUtils.scala to `trace`: this is rather orthogonal to this PR but I found it rather annoying while debugging the logs.&lt;br/&gt;
    4. A couple of unrelated bug fixes as pointed by @hachikuji and @apurvam .&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/guozhangwang/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/guozhangwang/kafka&lt;/a&gt; KHotfix-transaction-coordinator-append-callback&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/3287.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3287.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #3287&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 755f01201774f6fb5ddcdff87caaa78634847ebe&lt;br/&gt;
Author: Guozhang Wang &amp;lt;wangguoz@gmail.com&amp;gt;&lt;br/&gt;
Date:   2017-06-09T23:02:44Z&lt;/p&gt;

&lt;p&gt;    re-prepare transition to completeXX upon retrying append to log&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16046985" author="hachikuji" created="Mon, 12 Jun 2017 19:50:31 +0000"  >&lt;p&gt;Issue resolved by pull request 3287&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/kafka/pull/3287&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3287&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16046986" author="githubbot" created="Mon, 12 Jun 2017 19:51:36 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/3287&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3287&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 23 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3g2mv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>