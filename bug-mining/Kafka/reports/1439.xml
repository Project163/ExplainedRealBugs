<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:00:33 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-5038] running multiple kafka streams instances causes one or more instance to get into file contention</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-5038</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Having multiple kafka streams application instances causes one or more instances to get get into file lock contention and the instance(s) become unresponsive with uncaught exception.&lt;br/&gt;
The exception is below:&lt;br/&gt;
22:14:37.621 &lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread-7&amp;#93;&lt;/span&gt; WARN  o.a.k.s.p.internals.StreamThread - Unexpected state transition from RUNNING to NOT_RUNNING&lt;br/&gt;
22:14:37.621 &lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread-13&amp;#93;&lt;/span&gt; WARN  o.a.k.s.p.internals.StreamThread - Unexpected state transition from RUNNING to NOT_RUNNING&lt;br/&gt;
22:14:37.623 &lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread-18&amp;#93;&lt;/span&gt; WARN  o.a.k.s.p.internals.StreamThread - Unexpected state transition from RUNNING to NOT_RUNNING&lt;br/&gt;
22:14:37.625 &lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread-7&amp;#93;&lt;/span&gt; ERROR n.a.a.k.t.KStreamTopologyBase - Uncaught Exception:org.apache.kafka.streams.errors.ProcessorStateException: task directory &lt;span class=&quot;error&quot;&gt;&amp;#91;/data/kafka-streams/rtp-kstreams-metrics/0_119&amp;#93;&lt;/span&gt; doesn&apos;t exist and couldn&apos;t be created&lt;br/&gt;
	at org.apache.kafka.streams.processor.internals.StateDirectory.directoryForTask(StateDirectory.java:75)&lt;br/&gt;
	at org.apache.kafka.streams.processor.internals.StateDirectory.lock(StateDirectory.java:102)&lt;br/&gt;
	at org.apache.kafka.streams.processor.internals.StateDirectory.cleanRemovedTasks(StateDirectory.java:205)&lt;br/&gt;
	at org.apache.kafka.streams.processor.internals.StreamThread.maybeClean(StreamThread.java:753)&lt;br/&gt;
	at org.apache.kafka.streams.processor.internals.StreamThread.runLoop(StreamThread.java:664)&lt;br/&gt;
	at org.apache.kafka.streams.processor.internals.StreamThread.run(StreamThread.java:368)&lt;/p&gt;

&lt;p&gt;This happens within couple of minutes after the instances are up and there is NO data being sent to the broker yet and the streams app is started with auto.offset.reset set to &quot;latest&quot;.&lt;/p&gt;

&lt;p&gt;Please note that there are no permissions or capacity issues. This may have nothing to do with number of instances, but I could easily reproduce it when I&apos;ve 3 stream instances running. This is similar to the (and may be the same) bug as &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3758&quot; title=&quot;KStream job fails to recover after Kafka broker stopped&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3758&quot;&gt;&lt;del&gt;KAFKA-3758&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Here are some relevant configuration info:&lt;br/&gt;
3 kafka brokers have one topic with 128 partitions and 1 replication&lt;br/&gt;
3 kafka streams applications (running on 3 machines) have a single processor topology and this processor is not doing anything (the process() method just returns and the punctuate method just commits)&lt;br/&gt;
There is no data flowing yet, so the process() and puctuate() methods are not even called yet.&lt;br/&gt;
The 3 kafka stream instances have 43, 43 and 42 threads each respectively (totally making up to 128 threads, so one task per thread distributed across three streams instances on 3 machines).&lt;/p&gt;

&lt;p&gt;Here are the configurations that I&apos;d played around with:&lt;br/&gt;
session.timeout.ms=300000&lt;br/&gt;
heartbeat.interval.ms=60000&lt;br/&gt;
max.poll.records=100&lt;br/&gt;
num.standby.replicas=1&lt;br/&gt;
commit.interval.ms=10000&lt;br/&gt;
poll.ms=100&lt;/p&gt;

&lt;p&gt;When punctuate is scheduled to be called every 1000ms or 3000ms, the problem happens every time. If punctuate is scheduled for 5000ms, I didn&apos;t see the problem in my test scenario (described above), but it happened in my real application. But this may have nothing to do with the issue, since punctuate is not even called as there are no messages streaming through yet.&lt;/p&gt;</description>
                <environment>3 Kafka broker machines and 3 kafka streams machines.&lt;br/&gt;
Each machine is Linux 64 bit, CentOS 6.5 with 64GB memory, 8 vCPUs running in AWS&lt;br/&gt;
31GB java heap space allocated to each KafkaStreams instance and 4GB allocated to each Kafka broker.&lt;br/&gt;
</environment>
        <key id="13062303">KAFKA-5038</key>
            <summary>running multiple kafka streams instances causes one or more instance to get into file contention</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="enothereska">Eno Thereska</assignee>
                                    <reporter username="btirumala">Bharad Tirumala</reporter>
                        <labels>
                    </labels>
                <created>Thu, 6 Apr 2017 23:59:48 +0000</created>
                <updated>Wed, 12 Apr 2017 17:02:50 +0000</updated>
                            <resolved>Wed, 12 Apr 2017 15:34:43 +0000</resolved>
                                    <version>0.10.2.0</version>
                                    <fixVersion>0.10.2.1</fixVersion>
                    <fixVersion>0.11.0.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="15960123" author="btirumala" created="Fri, 7 Apr 2017 01:14:19 +0000"  >&lt;p&gt;Tried it with 0.10.2.1 build with PR #2793 from enothereska/&lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-4916&quot; title=&quot;Add streams tests with brokers failing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-4916&quot;&gt;&lt;del&gt;KAFKA-4916&lt;/del&gt;&lt;/a&gt;-0.10.2&lt;br/&gt;
and the issue happened again.......&lt;/p&gt;</comment>
                            <comment id="15960306" author="ewencp" created="Fri, 7 Apr 2017 05:50:58 +0000"  >&lt;p&gt;Removing invalid fix version since the tagged version has already been released.&lt;/p&gt;</comment>
                            <comment id="15960352" author="btirumala" created="Fri, 7 Apr 2017 06:27:22 +0000"  >&lt;p&gt;btw, this happens with as few as 5 threads per streams instance. The tasks get distributed across all the 15 threads in the 3 instances before this file lock contention (mkdir in directoryForTask() failing).&lt;/p&gt;

&lt;p&gt;I&apos;ve upload the test program with the relevant properties file and also the logs on the instance when the issue happened.&lt;br/&gt;
(I&apos;ve masked the actual server urls in the logs and in the properties file....)&lt;/p&gt;

&lt;p&gt;test code and properties file at:&lt;br/&gt;
&lt;a href=&quot;https://gist.github.com/btirumala/e996b2d09415f3ba42ad58dac4a64507&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gist.github.com/btirumala/e996b2d09415f3ba42ad58dac4a64507&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The debug logs of a failed instance at:&lt;br/&gt;
&lt;a href=&quot;https://gist.github.com/btirumala/4516b3cd31271fab3eaf390a483f07fb&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gist.github.com/btirumala/4516b3cd31271fab3eaf390a483f07fb&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15964881" author="githubbot" created="Tue, 11 Apr 2017 19:51:27 +0000"  >&lt;p&gt;GitHub user enothereska opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/2841&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2841&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5038&quot; title=&quot;running multiple kafka streams instances causes one or more instance to get into file contention&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-5038&quot;&gt;&lt;del&gt;KAFKA-5038&lt;/del&gt;&lt;/a&gt;: Catch exception&lt;/p&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/enothereska/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/enothereska/kafka&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5038&quot; title=&quot;running multiple kafka streams instances causes one or more instance to get into file contention&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-5038&quot;&gt;&lt;del&gt;KAFKA-5038&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/2841.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2841.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #2841&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit b484904a74458dd20d3b7b0deb26f822feca9140&lt;br/&gt;
Author: Eno Thereska &amp;lt;eno.thereska@gmail.com&amp;gt;&lt;br/&gt;
Date:   2017-04-11T19:49:28Z&lt;/p&gt;

&lt;p&gt;    Catch exception&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15964883" author="enothereska" created="Tue, 11 Apr 2017 19:52:11 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=btirumala&quot; class=&quot;user-hover&quot; rel=&quot;btirumala&quot;&gt;btirumala&lt;/a&gt; thank you for posting. Looks like it could be a bug. I&apos;ve opened at PR: &lt;a href=&quot;https://github.com/apache/kafka/pull/2841&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2841&lt;/a&gt;. Would you mind trying to see if it fixes the problem? Thanks.&lt;/p&gt;</comment>
                            <comment id="15965448" author="btirumala" created="Wed, 12 Apr 2017 06:27:40 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=enothereska&quot; class=&quot;user-hover&quot; rel=&quot;enothereska&quot;&gt;enothereska&lt;/a&gt;, I tried the fix and it seems to be working. Appreciate the quick help.&lt;/p&gt;</comment>
                            <comment id="15965958" author="githubbot" created="Wed, 12 Apr 2017 14:29:28 +0000"  >&lt;p&gt;Github user enothereska closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/2841&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2841&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15965971" author="githubbot" created="Wed, 12 Apr 2017 14:37:32 +0000"  >&lt;p&gt;GitHub user enothereska opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/2848&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2848&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5038&quot; title=&quot;running multiple kafka streams instances causes one or more instance to get into file contention&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-5038&quot;&gt;&lt;del&gt;KAFKA-5038&lt;/del&gt;&lt;/a&gt;: Catch exception&lt;/p&gt;

&lt;p&gt;    Porting from 0.10.2 PR &lt;a href=&quot;https://github.com/apache/kafka/pull/2841&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2841&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/enothereska/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/enothereska/kafka&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5038&quot; title=&quot;running multiple kafka streams instances causes one or more instance to get into file contention&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-5038&quot;&gt;&lt;del&gt;KAFKA-5038&lt;/del&gt;&lt;/a&gt;-trunk&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/2848.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2848.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #2848&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 2f2be04147d2bc844cdfa56a4fe6a5235733f07b&lt;br/&gt;
Author: Eno Thereska &amp;lt;eno.thereska@gmail.com&amp;gt;&lt;br/&gt;
Date:   2017-04-12T14:36:16Z&lt;/p&gt;

&lt;p&gt;    Porting from 0.10.2&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15966066" author="ijuma" created="Wed, 12 Apr 2017 15:34:43 +0000"  >&lt;p&gt;Issue resolved by pull request 2848&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/kafka/pull/2848&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2848&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15966069" author="githubbot" created="Wed, 12 Apr 2017 15:35:30 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/2848&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2848&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 31 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3dc1j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>