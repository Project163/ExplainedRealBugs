<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:00:14 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-4919] Document that stores must not be closed when Processors are closed</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-4919</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;I have a streams job, that previously worked, that consumes and writes to a large number of topics with many partitions and that uses many threads.  I upgraded the job to 0.10.2.0.  The job now fails after a short time running, seemingly after a rebalance.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;WARN  2017-03-19 18:03:20,432 &lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread-10&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread.java:160&amp;#93;&lt;/span&gt; : Unexpected state transition from RUNNING to NOT_RUNNING&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The first observation is that Streams is no longer outputting exceptions and backtraces.  I had to add code to get this information.&lt;/p&gt;

&lt;p&gt;The exception:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Exception: org.apache.kafka.streams.errors.StreamsException: Exception caught in process. taskId=1_225, processor=KSTREAM-SOURCE-0000000003, topic=some_topic, partition=225, offset=266411&lt;br/&gt;
org.apache.kafka.streams.errors.StreamsException: Exception caught in process. taskId=1_225, processor=KSTREAM-SOURCE-0000000003, topic=some_topic, partition=225, offset=266411&lt;br/&gt;
	at org.apache.kafka.streams.processor.internals.StreamTask.process(StreamTask.java:216)&lt;br/&gt;
	at org.apache.kafka.streams.processor.internals.StreamThread.runLoop(StreamThread.java:641)&lt;br/&gt;
	at org.apache.kafka.streams.processor.internals.StreamThread.run(StreamThread.java:368)&lt;br/&gt;
Caused by: org.apache.kafka.streams.errors.InvalidStateStoreException: Store someStore-201701060400 is currently closed&lt;br/&gt;
	at org.apache.kafka.streams.state.internals.RocksDBStore.validateStoreOpen(RocksDBStore.java:205)&lt;br/&gt;
	at org.apache.kafka.streams.state.internals.RocksDBStore.put(RocksDBStore.java:221)&lt;br/&gt;
	at org.apache.kafka.streams.state.internals.RocksDBSegmentedBytesStore.put(RocksDBSegmentedBytesStore.java:74)&lt;br/&gt;
	at org.apache.kafka.streams.state.internals.ChangeLoggingSegmentedBytesStore.put(ChangeLoggingSegmentedBytesStore.java:54)&lt;br/&gt;
	at org.apache.kafka.streams.state.internals.MeteredSegmentedBytesStore.put(MeteredSegmentedBytesStore.java:101)&lt;br/&gt;
	at org.apache.kafka.streams.state.internals.RocksDBWindowStore.put(RocksDBWindowStore.java:109)&lt;br/&gt;
	... X more&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The error occurs for many partitions.&lt;/p&gt;

&lt;p&gt;This was preceded by (for this partition):&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;INFO  2017-03-19 18:03:16,403 &lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread-10&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;ConsumerCoordinator.java:393&amp;#93;&lt;/span&gt; : Revoking previously assigned partitions &lt;span class=&quot;error&quot;&gt;&amp;#91;some_topic-225&amp;#93;&lt;/span&gt; for group some_job&lt;br/&gt;
INFO  2017-03-19 18:03:16,403 &lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread-10&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread.java:254&amp;#93;&lt;/span&gt; : stream-thread &lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread-10&amp;#93;&lt;/span&gt; partitions [&lt;span class=&quot;error&quot;&gt;&amp;#91;some_topic-225&amp;#93;&lt;/span&gt;] revoked at the beginning of consumer rebalance.&lt;br/&gt;
INFO  2017-03-19 18:03:16,403 &lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread-10&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread.java:1056&amp;#93;&lt;/span&gt; : stream-thread &lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread-10&amp;#93;&lt;/span&gt; Closing a task&apos;s topology 1_225&lt;br/&gt;
INFO  2017-03-19 18:03:17,887 &lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread-10&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread.java:544&amp;#93;&lt;/span&gt; : stream-thread &lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread-10&amp;#93;&lt;/span&gt; Flushing state stores of task 1_225&lt;br/&gt;
INFO  2017-03-19 18:03:17,887 &lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread-10&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread.java:534&amp;#93;&lt;/span&gt; : stream-thread &lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread-10&amp;#93;&lt;/span&gt; Committing consumer offsets of task 1_225&lt;br/&gt;
INFO  2017-03-19 18:03:17,891 &lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread-10&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread.java:1012&amp;#93;&lt;/span&gt; : stream-thread &lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread-10&amp;#93;&lt;/span&gt; Updating suspended tasks to contain active tasks [&lt;span class=&quot;error&quot;&gt;&amp;#91;1_225, 0_445, 0_30&amp;#93;&lt;/span&gt;]&lt;br/&gt;
INFO  2017-03-19 18:03:17,891 &lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread-10&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread.java:1019&amp;#93;&lt;/span&gt; : stream-thread &lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread-10&amp;#93;&lt;/span&gt; Removing all active tasks [&lt;span class=&quot;error&quot;&gt;&amp;#91;1_225, 0_445, 0_30&amp;#93;&lt;/span&gt;]&lt;/p&gt;

&lt;p&gt;INFO  2017-03-19 18:03:19,925 &lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread-10&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;ConsumerCoordinator.java:252&amp;#93;&lt;/span&gt; : Setting newly assigned partitions &lt;span class=&quot;error&quot;&gt;&amp;#91;some_tpoic-225&amp;#93;&lt;/span&gt; for group some_job&lt;br/&gt;
INFO  2017-03-19 18:03:19,927 &lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread-10&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread.java:228&amp;#93;&lt;/span&gt; : stream-thread &lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread-10&amp;#93;&lt;/span&gt; New partitions [&lt;span class=&quot;error&quot;&gt;&amp;#91;some_topic-225&amp;#93;&lt;/span&gt;] assigned at the end of consumer rebalance.&lt;br/&gt;
INFO  2017-03-19 18:03:19,929 &lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread-10&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;StreamTask.java:333&amp;#93;&lt;/span&gt; : task &lt;span class=&quot;error&quot;&gt;&amp;#91;1_225&amp;#93;&lt;/span&gt; Initializing processor nodes of the topology&lt;/p&gt;

&lt;p&gt;Something happens.  What ???&lt;/p&gt;

&lt;p&gt;INFO  2017-03-19 18:03:20,135 &lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread-10&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread.java:1045&amp;#93;&lt;/span&gt; : stream-thread &lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread-10&amp;#93;&lt;/span&gt; Closing a task 1_225&lt;br/&gt;
INFO  2017-03-19 18:03:20,355 &lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread-10&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread.java:544&amp;#93;&lt;/span&gt; : stream-thread &lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread-10&amp;#93;&lt;/span&gt; Flushing state stores of task 1_225&lt;br/&gt;
INFO  2017-03-19 18:03:20,355 &lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread-10&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread.java:523&amp;#93;&lt;/span&gt; : stream-thread &lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread-10&amp;#93;&lt;/span&gt; Closing the state manager of task 1_225&lt;br/&gt;
INFO  2017-03-19 18:03:20,432 &lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread-10&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread.java:1019&amp;#93;&lt;/span&gt; : stream-thread &lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread-10&amp;#93;&lt;/span&gt; Removing all active tasks [&lt;span class=&quot;error&quot;&gt;&amp;#91;1_225, 0_445, 0_30&amp;#93;&lt;/span&gt;]&lt;br/&gt;
INFO  2017-03-19 18:03:20,432 &lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread-10&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread.java:1034&amp;#93;&lt;/span&gt; : stream-thread &lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread-10&amp;#93;&lt;/span&gt; Removing all standby tasks [[]]&lt;br/&gt;
INFO  2017-03-19 18:03:20,432 &lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread-10&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread.java:427&amp;#93;&lt;/span&gt; : stream-thread &lt;span class=&quot;error&quot;&gt;&amp;#91;StreamThread-10&amp;#93;&lt;/span&gt; Stream thread shutdown complete&lt;/p&gt;&lt;/blockquote&gt;</description>
                <environment></environment>
        <key id="13057377">KAFKA-4919</key>
            <summary>Document that stores must not be closed when Processors are closed</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="damianguy">Damian Guy</assignee>
                                    <reporter username="elevy">Elias Levy</reporter>
                        <labels>
                    </labels>
                <created>Sun, 19 Mar 2017 19:03:20 +0000</created>
                <updated>Thu, 23 Mar 2017 16:50:07 +0000</updated>
                            <resolved>Thu, 23 Mar 2017 16:50:07 +0000</resolved>
                                    <version>0.10.2.0</version>
                                    <fixVersion>0.10.2.1</fixVersion>
                    <fixVersion>0.11.0.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15935252" author="elevy" created="Tue, 21 Mar 2017 20:23:17 +0000"  >&lt;p&gt;The issue appears to be that a &lt;tt&gt;RocksDBStore&lt;/tt&gt; segment of a &lt;tt&gt;RocksDBSegmentedBytesStore&lt;/tt&gt; is closed during a call to &lt;tt&gt;put&lt;/tt&gt; when the store is reused after a consumer rebalance.  I&apos;ve reviewed the code, but I can&apos;t see how the segment could be closed after the rebalance.  If it is a newly crated segment, it will be open.  If it is closed, then it should have been destroyed and removed from the segments list in &lt;tt&gt;Segments.cleanup&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Thoughts?&lt;/p&gt;</comment>
                            <comment id="15935663" author="guozhang" created="Wed, 22 Mar 2017 02:10:10 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=damianguy&quot; class=&quot;user-hover&quot; rel=&quot;damianguy&quot;&gt;damianguy&lt;/a&gt; Could you take a look?&lt;/p&gt;</comment>
                            <comment id="15935711" author="elevy" created="Wed, 22 Mar 2017 03:13:40 +0000"  >&lt;p&gt;I believe I found the issue.  I am closing the store when my &lt;tt&gt;Processor&lt;/tt&gt; is closed.  The &lt;tt&gt;Processor&lt;/tt&gt; is closed during rebalance via &lt;tt&gt;onPartitionsRevoked&lt;/tt&gt; -&amp;gt; &lt;tt&gt;suspendTasksAndStat&lt;/tt&gt; -&amp;gt; &lt;tt&gt;closeAllTasksTopologies&lt;/tt&gt; -&amp;gt; &lt;tt&gt;performOnAllTasks&lt;/tt&gt; -&amp;gt; &lt;tt&gt;closeTopology&lt;/tt&gt; -&amp;gt; &lt;tt&gt;ProcessorNode.close&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;It was my understanding that it was proper to close state stores used by a &lt;tt&gt;Processor&lt;/tt&gt; when the &lt;tt&gt;Processor&lt;/tt&gt; is closed. The examples in the low-level API documentation follow this pattern (See &lt;a href=&quot;https://kafka.apache.org/0102/documentation/streams#streams_processor&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://kafka.apache.org/0102/documentation/streams#streams_processor&lt;/a&gt; and &lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/streams/examples/src/main/java/org/apache/kafka/streams/examples/wordcount/WordCountProcessorDemo.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/trunk/streams/examples/src/main/java/org/apache/kafka/streams/examples/wordcount/WordCountProcessorDemo.java&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;Has this changed in 0.10.2.0?  Or is this a new issue only affecting the refactored segmented stores?&lt;/p&gt;</comment>
                            <comment id="15936328" author="damianguy" created="Wed, 22 Mar 2017 13:38:57 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=elevy&quot; class=&quot;user-hover&quot; rel=&quot;elevy&quot;&gt;elevy&lt;/a&gt; Yes that would be the issue. Because we now re-use the stores if we can when there is a rebalance, they should not be closed by the Processor. We need to update the docs and examples.&lt;br/&gt;
Thanks,&lt;br/&gt;
Damian&lt;/p&gt;</comment>
                            <comment id="15936714" author="elevy" created="Wed, 22 Mar 2017 17:17:47 +0000"  >&lt;p&gt;Thanks for the information.  It is something that should probably be mentioned in the release notes.&lt;/p&gt;</comment>
                            <comment id="15936891" author="guozhang" created="Wed, 22 Mar 2017 18:39:49 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=elevy&quot; class=&quot;user-hover&quot; rel=&quot;elevy&quot;&gt;elevy&lt;/a&gt; There is a PR open for this ticket but not yet linked to it automatically: &lt;a href=&quot;https://github.com/apache/kafka/pull/2725&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2725&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Please feel free to share your opinions on that PR if you want.&lt;/p&gt;</comment>
                            <comment id="15938749" author="githubbot" created="Thu, 23 Mar 2017 16:48:38 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/2725&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2725&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 34 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3chnr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>