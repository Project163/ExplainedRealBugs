<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:37:25 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-16087] Tasks dropping incorrect records when errors.tolerance=all and errors reported asynchronously due to data race</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-16087</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;The ErrantRecordReporter introduced in KIP-610 (2.6.0) allows sink connectors to push records to the connector DLQ topic. The implementation of this reporter interacts with the ProcessingContext within the per-task RetryWithToleranceOperator. The ProcessingContext stores mutable state about the current operation, such as what error has occurred or what record is being operated on.&lt;/p&gt;

&lt;p&gt;The ProcessingContext and RetryWithToleranceOperator is also used by the converter and transformation pipeline of the connector for similar reasons. When the ErrantRecordReporter#report function is called from SinkTask#put, there is no contention over the mutable state, as the thread used for SinkTask#put is also responsible for converting and transforming the record. However, if ErrantRecordReporter#report is called by an extra thread within the SinkTask, there is thread contention on the single mutable ProcessingContext.&lt;/p&gt;

&lt;p&gt;This was noticed in &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-10602&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-10602&lt;/a&gt; and the synchronized keyword was added to all methods of RetryWithToleranceOperator which interact with the ProcessingContext. However, this solution still allows the RWTO methods to interleave, and produce unintended data races. Consider the following interleaving:&lt;/p&gt;

&lt;p&gt;1. Thread 1 converts and transforms record A successfully.&lt;br/&gt;
2. Thread 1 calls SinkTask#put(A) and delivers the message to the task.&lt;br/&gt;
3. Thread 1 queues some other thread 2 with some delay to call ErrantRecordReporter#report(A).&lt;br/&gt;
4. Thread 1 returns from SinkTask#put and polls record B from the consumer.&lt;br/&gt;
5. Thread 1 calls RWTO#execute for a converter or transformation operation. For example, &lt;a href=&quot;https://github.com/apache/kafka/blob/c0b649345580e4dfb2ebb88d3aaace71afe70d75/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/WorkerSinkTask.java#L539&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;converting headers&lt;/a&gt;&lt;br/&gt;
6. The operation succeeds, and the ProcessingContext is left with error == null, or equivalently failed() == false.&lt;br/&gt;
7. Thread 2 has it&apos;s delay expire, and it calls ErrantRecordReporter#report.&lt;br/&gt;
8. Thread 2 uses the WorkerErrantRecordReporter implementation, which calls &lt;a href=&quot;https://github.com/apache/kafka/blob/c0b649345580e4dfb2ebb88d3aaace71afe70d75/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/errors/WorkerErrantRecordReporter.java#L109&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;RWTO executeFailed&lt;/a&gt; and returns.&lt;br/&gt;
9. The operation leaves ProcessingContext with error != null, or equivalently failed() == true.&lt;br/&gt;
10. Thread 1 then resumes execution, and calls &lt;a href=&quot;https://github.com/apache/kafka/blob/c0b649345580e4dfb2ebb88d3aaace71afe70d75/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/WorkerSinkTask.java#L541&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;RWTO failed&lt;/a&gt; which evaluates to true.&lt;br/&gt;
11. Thread 1 then drops Record B, even though the header conversion succeeded without error.&lt;br/&gt;
12. Record B is never delivered to the Sink Task, and never delivered to the error reporter for processing, despite having produced no error during processing.&lt;/p&gt;

&lt;p&gt;This per-method synchronization for returning nulls and errors separately is insufficient, and either the data sharing should be avoided or a different locking mechanism should be used.&lt;/p&gt;

&lt;p&gt;A similar flaw exists in source connectors and asynchronous errors reported by the producer, and was introduced in KIP-779 (3.2.0)&lt;/p&gt;</description>
                <environment></environment>
        <key id="13563746">KAFKA-16087</key>
            <summary>Tasks dropping incorrect records when errors.tolerance=all and errors reported asynchronously due to data race</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gharris1727">Greg Harris</assignee>
                                    <reporter username="gharris1727">Greg Harris</reporter>
                        <labels>
                    </labels>
                <created>Fri, 5 Jan 2024 21:55:47 +0000</created>
                <updated>Mon, 5 Feb 2024 19:04:46 +0000</updated>
                            <resolved>Thu, 18 Jan 2024 21:27:10 +0000</resolved>
                                    <version>2.6.0</version>
                    <version>3.2.0</version>
                    <version>3.7.0</version>
                                    <fixVersion>3.8.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                    <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13335082">KAFKA-10602</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 44 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1ml6w:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>