<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:52:06 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-2937] Topics marked for delete in Zookeeper may become undeletable</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-2937</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;In our clusters, we occasionally see topics marked for delete, but never actually deleted. It may be due to brokers being restarted while tests were running, but further restarts of Kafka dont fix the problem. The topics remain marked for delete in Zookeeper.&lt;/p&gt;

&lt;p&gt;Topic describe shows:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Topic:testtopic	PartitionCount:1	ReplicationFactor:3	Configs:&lt;br/&gt;
	Topic: testtopic	Partition: 0	Leader: none	Replicas: 3,4,0	Isr: &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Kafka logs show:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;2015-12-02 15:53:30,152] ERROR Controller 2 epoch 213 initiated state change of replica 3 for partition &lt;span class=&quot;error&quot;&gt;&amp;#91;testtopic,0&amp;#93;&lt;/span&gt; from OnlineReplica to OfflineReplica failed (state.change.logger)&lt;br/&gt;
kafka.common.StateChangeFailedException: Failed to change state of replica 3 for partition &lt;span class=&quot;error&quot;&gt;&amp;#91;testtopic,0&amp;#93;&lt;/span&gt; since the leader and isr path in zookeeper is empty&lt;br/&gt;
        at kafka.controller.ReplicaStateMachine.handleStateChange(ReplicaStateMachine.scala:269)&lt;br/&gt;
        at kafka.controller.ReplicaStateMachine$$anonfun$handleStateChanges$2.apply(ReplicaStateMachine.scala:114)&lt;br/&gt;
        at kafka.controller.ReplicaStateMachine$$anonfun$handleStateChanges$2.apply(ReplicaStateMachine.scala:114)&lt;br/&gt;
        at scala.collection.immutable.HashSet$HashSet1.foreach(HashSet.scala:322)&lt;br/&gt;
        at scala.collection.immutable.HashSet$HashTrieSet.foreach(HashSet.scala:978)&lt;br/&gt;
        at kafka.controller.ReplicaStateMachine.handleStateChanges(ReplicaStateMachine.scala:114)&lt;br/&gt;
        at kafka.controller.TopicDeletionManager$$anonfun$startReplicaDeletion$2.apply(TopicDeletionManager.scala:342)&lt;br/&gt;
        at kafka.controller.TopicDeletionManager$$anonfun$startReplicaDeletion$2.apply(TopicDeletionManager.scala:334)&lt;br/&gt;
        at scala.collection.immutable.Map$Map1.foreach(Map.scala:116)&lt;br/&gt;
        at kafka.controller.TopicDeletionManager.startReplicaDeletion(TopicDeletionManager.scala:334)&lt;br/&gt;
        at kafka.controller.TopicDeletionManager.kafka$controller$TopicDeletionManager$$onPartitionDeletion(TopicDeletionManager.scala:367)&lt;br/&gt;
        at kafka.controller.TopicDeletionManager$$anonfun$kafka$controller$TopicDeletionManager$$onTopicDeletion$2.apply(TopicDeletionManager.scala:313)&lt;br/&gt;
        at kafka.controller.TopicDeletionManager$$anonfun$kafka$controller$TopicDeletionManager$$onTopicDeletion$2.apply(TopicDeletionManager.scala:312)&lt;br/&gt;
        at scala.collection.immutable.Set$Set1.foreach(Set.scala:79)&lt;br/&gt;
        at kafka.controller.TopicDeletionManager.kafka$controller$TopicDeletionManager$$onTopicDeletion(TopicDeletionManager.scala:312)&lt;br/&gt;
        at kafka.controller.TopicDeletionManager$DeleteTopicsThread$$anonfun$doWork$1$$anonfun$apply$mcV$sp$4.apply(TopicDeletionManager.scala:431)&lt;br/&gt;
        at kafka.controller.TopicDeletionManager$DeleteTopicsThread$$anonfun$doWork$1$$anonfun$apply$mcV$sp$4.apply(TopicDeletionManager.scala:403)&lt;br/&gt;
        at scala.collection.immutable.Set$Set2.foreach(Set.scala:111)&lt;br/&gt;
        at kafka.controller.TopicDeletionManager$DeleteTopicsThread$$anonfun$doWork$1.apply$mcV$sp(TopicDeletionManager.scala:403)&lt;br/&gt;
        at kafka.controller.TopicDeletionManager$DeleteTopicsThread$$anonfun$doWork$1.apply(TopicDeletionManager.scala:397)&lt;br/&gt;
        at kafka.controller.TopicDeletionManager$DeleteTopicsThread$$anonfun$doWork$1.apply(TopicDeletionManager.scala:397)&lt;br/&gt;
        at kafka.utils.CoreUtils$.inLock(CoreUtils.scala:262)&lt;br/&gt;
        at kafka.controller.TopicDeletionManager$DeleteTopicsThread.doWork(TopicDeletionManager.scala:397)&lt;br/&gt;
        at kafka.utils.ShutdownableThread.run(ShutdownableThread.scala:63)&lt;/p&gt;&lt;/blockquote&gt;                      
</description>
                <environment></environment>
        <key id="12917797">KAFKA-2937</key>
            <summary>Topics marked for delete in Zookeeper may become undeletable</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mgharat">Mayuresh Gharat</assignee>
                                    <reporter username="rsivaram">Rajini Sivaram</reporter>
                        <labels>
                    </labels>
                <created>Wed, 2 Dec 2015 23:46:54 +0000</created>
                <updated>Wed, 6 Jan 2016 22:17:30 +0000</updated>
                            <resolved>Wed, 6 Jan 2016 22:17:30 +0000</resolved>
                                    <version>0.9.0.0</version>
                                    <fixVersion>0.9.0.1</fixVersion>
                                    <component>core</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="15064365" author="mgharat" created="Fri, 18 Dec 2015 18:06:36 +0000"  >&lt;p&gt;I ran a test with few commits behind trunk HEAD : &lt;/p&gt;

&lt;p&gt;1) Started the kafka cluster.&lt;br/&gt;
2) Produced data to topic T for quite some time so that enough data is accumulated on kafka brokers.&lt;br/&gt;
3) Delete a topic and immediately shutdown the cluster.&lt;br/&gt;
4) I could see the topic T under /admin/delete_topics.&lt;br/&gt;
5) After I restarted the cluster, the topic T was deleted.&lt;/p&gt;


&lt;p&gt;There might be a race condition here, were controller might have gone down after it wrote to zookeeper but under removed the topic under /admin/deleted_topics. I will have to investigate more on this.&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rsivaram&quot; class=&quot;user-hover&quot; rel=&quot;rsivaram&quot;&gt;rsivaram&lt;/a&gt;What is the version of kafka that you are running?&lt;/p&gt;</comment>
                            <comment id="15066499" author="rsivaram" created="Mon, 21 Dec 2015 14:34:05 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mgharat&quot; class=&quot;user-hover&quot; rel=&quot;mgharat&quot;&gt;mgharat&lt;/a&gt; We are running kafka 0.9.0.0.&lt;/p&gt;</comment>
                            <comment id="15070294" author="mgharat" created="Wed, 23 Dec 2015 23:04:02 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rsivaram&quot; class=&quot;user-hover&quot; rel=&quot;rsivaram&quot;&gt;rsivaram&lt;/a&gt; This can occur if during delete topic, the controller writes the updated LeaderISR to zookeeper and dies and a new controller is elected and since the  /admin/delete_topics/ path contains the topic, the deleteTopic is retried and when the controller tries to send the stopReplicaRequest with deletePartition = false when it tries to remove ReplicafromISR and since there is no LeaderISR, the above exception is thrown. &lt;/p&gt;

&lt;p&gt;I am thinking if while deleting a topic, is it necessary for the check :&lt;br/&gt;
if (leaderAndIsrIsEmpty)&lt;br/&gt;
            throw new StateChangeFailedException(&lt;br/&gt;
              &quot;Failed to change state of replica %d for partition %s since the leader and isr path in zookeeper is empty&quot;&lt;br/&gt;
              .format(replicaId, topicAndPartition))&lt;/p&gt;

&lt;p&gt;I am planning to check if the topic is being deleted and if YES, we do not throw the exception if the LeaderISR info in zookeeper is empty.&lt;/p&gt;

&lt;p&gt;On a side note did you see a log line &quot;Retrying delete topic for topic ....since replicas....were not successfully deleted&quot;.&lt;/p&gt;
</comment>
                            <comment id="15074083" author="hpihkala" created="Tue, 29 Dec 2015 17:19:22 +0000"  >&lt;p&gt;I ran into this issue as well on 0.9.0.0. I had a bunch of topics in this state, all related to an integration test I had, which tests topic creation and topic deletion immediately after that. Could it be that a newly-created topic has a higher chance of ending up in this state? (For example, if the deletion process starts before a leader is elected for the new topic, etc)&lt;/p&gt;</comment>
                            <comment id="15081352" author="mgharat" created="Mon, 4 Jan 2016 16:53:18 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=djh&quot; class=&quot;user-hover&quot; rel=&quot;djh&quot;&gt;djh&lt;/a&gt; does your integration test check if the topic is created successfully before attempting a delete?&lt;/p&gt;</comment>
                            <comment id="15081401" author="hpihkala" created="Mon, 4 Jan 2016 17:20:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mgharat&quot; class=&quot;user-hover&quot; rel=&quot;mgharat&quot;&gt;mgharat&lt;/a&gt; Yes, like this:&lt;/p&gt;

&lt;p&gt;AdminUtils.createTopic(...)&lt;br/&gt;
assert AdminUtils.topicExists(...)&lt;br/&gt;
AdminUtils.deleteTopic(...)&lt;br/&gt;
Thread.sleep(...)&lt;br/&gt;
assert !AdminUtils.topicExists(...)&lt;/p&gt;

&lt;p&gt;When this test one day suddenly started failing (on the last line), I first suspected that my sleep wasn&apos;t long enough anymore. However, digging deeper showed that topics created by my test were ending up in the undeleteable state described in this JIRA.&lt;/p&gt;</comment>
                            <comment id="15081910" author="mgharat" created="Mon, 4 Jan 2016 22:16:51 +0000"  >&lt;p&gt;Yes, that might be possible but it should be rare. The AdminUtils.topicExists(topicName) call checks only if the the entry /brokers/topics/topicName exist in the zookeeper. The createTopic() should write to the path : /brokers/topic/topicName and also update the replicaAssignment for the topic in Zookeeper.&lt;/p&gt;

&lt;p&gt;If somehow the second part got messed up, the above error can occur. &lt;/p&gt;</comment>
                            <comment id="15081958" author="githubbot" created="Mon, 4 Jan 2016 23:05:51 +0000"  >&lt;p&gt;GitHub user MayureshGharat opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/729&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/729&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-2937&quot; title=&quot;Topics marked for delete in Zookeeper may become undeletable&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-2937&quot;&gt;&lt;del&gt;KAFKA-2937&lt;/del&gt;&lt;/a&gt; : Disable the leaderIsr check if the topic is to be deleted.&lt;/p&gt;

&lt;p&gt;    The check was implemented in &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-340&quot; title=&quot;Implement clean shutdown in 0.8&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-340&quot;&gt;&lt;del&gt;KAFKA-340&lt;/del&gt;&lt;/a&gt; : If we are shutting down a broker when the ISR of a partition includes only that broker, we could lose some messages that have been previously committed. For clean shutdown, we need to guarantee that there is at least 1 other broker in ISR after the broker is shut down.&lt;/p&gt;

&lt;p&gt;    When we are deleting the topic, this check can be avoided.&lt;/p&gt;


&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/MayureshGharat/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/MayureshGharat/kafka&lt;/a&gt; kafka-2937&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/729.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/729.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #729&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 9d5afd0f29f2f4311e534eb375e1c9ddb23b33dd&lt;br/&gt;
Author: Mayuresh Gharat &amp;lt;mgharat@mgharat-ld1.linkedin.biz&amp;gt;&lt;br/&gt;
Date:   2016-01-04T22:56:01Z&lt;/p&gt;

&lt;p&gt;    Disable the leaderIsr check if the topic is to be deleted.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15083751" author="ijuma" created="Tue, 5 Jan 2016 20:45:55 +0000"  >&lt;p&gt;There&apos;s a PR so updating the status.&lt;/p&gt;</comment>
                            <comment id="15086375" author="junrao" created="Wed, 6 Jan 2016 22:14:13 +0000"  >&lt;p&gt;The situation that &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mgharat&quot; class=&quot;user-hover&quot; rel=&quot;mgharat&quot;&gt;mgharat&lt;/a&gt; described can indeed happen. In that case, the isr in ZK would be empty. It would be great to verify that if we see the same issue again.&lt;/p&gt;</comment>
                            <comment id="15086378" author="githubbot" created="Wed, 6 Jan 2016 22:17:18 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/729&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/729&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15086380" author="junrao" created="Wed, 6 Jan 2016 22:17:30 +0000"  >&lt;p&gt;Issue resolved by pull request 729&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/kafka/pull/729&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/729&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 45 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2p7kf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>