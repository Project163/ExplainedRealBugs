<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:36:44 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-636] Make log segment delete asynchronous</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-636</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;We have a few corner-case bugs around delete of segment files:&lt;br/&gt;
1. It is possible for delete and truncate to kind of cross streams and end up with a case where you have no segments.&lt;br/&gt;
2. Reads on the log have no locking (which is good) but as a result deleting a segment that is being read will result in some kind of I/O exception.&lt;br/&gt;
3. We can&apos;t easily fix the synchronization problems without deleting files inside the log&apos;s write lock. This can be a problem as deleting a 2GB segment can take a couple of seconds even on an unloaded system.&lt;/p&gt;

&lt;p&gt;The proposed fix for these problems is to make file removal asynchronous using the following scheme as the new delete scheme:&lt;br/&gt;
1. Immediately remove the file from segment map and rename the~ file from X to X.deleted (e.g. 0000000.log to 000000.log.deleted. We think renaming a file will not impact reads since the file is already open and hence the name is irrelevant. This will always be O(1) and can be done inside the write lock.&lt;br/&gt;
2. Schedule a future operation to delete the file. The time to wait would be configurable but we would just default it to 60 seconds and probably no one would ever change it.&lt;br/&gt;
3. On startup we would delete any files with the .deleted suffix as they would have been pending deletes that didn&apos;t take place.&lt;/p&gt;

&lt;p&gt;I plan to do this soon working against the refactored log (&lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-521&quot; title=&quot;Refactor Log subsystem&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-521&quot;&gt;&lt;del&gt;KAFKA-521&lt;/del&gt;&lt;/a&gt;). We can opt to back port the patch for 0.8 if we are feeling daring.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12617922">KAFKA-636</key>
            <summary>Make log segment delete asynchronous</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jkreps">Jay Kreps</assignee>
                                    <reporter username="jkreps">Jay Kreps</reporter>
                        <labels>
                    </labels>
                <created>Wed, 28 Nov 2012 03:51:42 +0000</created>
                <updated>Tue, 11 Dec 2012 19:47:41 +0000</updated>
                            <resolved>Tue, 11 Dec 2012 19:47:41 +0000</resolved>
                                                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13526878" author="jkreps" created="Fri, 7 Dec 2012 23:32:53 +0000"  >&lt;p&gt;This patch implements asynchronous delete in the log.&lt;/p&gt;

&lt;p&gt;To do this Log.scala now requires a scheduler to be used for scheduling the deletions.&lt;/p&gt;

&lt;p&gt;The deletion works as described above.&lt;/p&gt;

&lt;p&gt;The locking for segment deletion can now be more aggressive since the file renames are assumed to be fast they can be inside the lock.&lt;/p&gt;

&lt;p&gt;As part of testing this I also found a problem with MockScheduler, namely that it does not reentrant. That is, if scheduled tasks themselves create scheduled tasks it misbehaves. To fix this I rewrote MockScheduler to use a priority queue. The code is simpler and more correct since it now performs all executions in the correct order too.&lt;/p&gt;</comment>
                            <comment id="13529142" author="junrao" created="Tue, 11 Dec 2012 17:25:32 +0000"  >&lt;p&gt;Thanks for the patch. +1. Just one minor comment:&lt;/p&gt;

&lt;p&gt;1. Log.deleteSegment(): In asyncDeleteFiles(), is it better to log the deleting of a log segment in info instead of debug?&lt;/p&gt;</comment>
                            <comment id="13529222" author="nehanarkhede" created="Tue, 11 Dec 2012 19:03:41 +0000"  >&lt;p&gt;+1. Minor comments -&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Typos in the description of the deleteSegment API in Log.scala.&lt;/li&gt;
	&lt;li&gt;I agree with Jun on the info log level for the delete messages.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13529265" author="jkreps" created="Tue, 11 Dec 2012 19:47:41 +0000"  >&lt;p&gt;Checked in with the suggested changes.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12559981" name="KAFKA-636-v1.patch" size="34760" author="jkreps" created="Fri, 7 Dec 2012 23:32:53 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>292502</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 49 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0s39z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>162007</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>