<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:36:10 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-43] Rebalance to preferred broke with intra-cluster replication support</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-43</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;We need to allow the leader to be moved to the preferred broker, for better load balancing.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12514680">KAFKA-43</key>
            <summary>Rebalance to preferred broke with intra-cluster replication support</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="nehanarkhede">Neha Narkhede</assignee>
                                    <reporter username="junrao">Jun Rao</reporter>
                        <labels>
                            <label>features</label>
                    </labels>
                <created>Tue, 19 Jul 2011 21:32:20 +0000</created>
                <updated>Sat, 13 Oct 2012 00:45:13 +0000</updated>
                            <resolved>Sat, 13 Oct 2012 00:40:45 +0000</resolved>
                                                    <fixVersion>0.8.0</fixVersion>
                                    <component>core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                    <workratio workratioPercent="0"/>
                                    <progress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                    <timeoriginalestimate seconds="604800">168h</timeoriginalestimate>
                            <timeestimate seconds="604800">168h</timeestimate>
                                        <comments>
                            <comment id="13474603" author="nehanarkhede" created="Thu, 11 Oct 2012 23:05:23 +0000"  >&lt;p&gt;Added the ability to move the leader to the preferred replica for a partition. This patch contains the following changes -&lt;/p&gt;

&lt;p&gt;1. A new admin command PreferredReplicaLeaderElectionCommand and corresponding bin script&lt;/p&gt;

&lt;p&gt;2. The admin command takes list of partitions as an input json file and writes it to the zookeeper persistent path /admin/preferred_replica_election&lt;/p&gt;

&lt;p&gt;3. The controller registers a data change listener on the admin path. For each such partition, it triggers the OnlinePartition -&amp;gt; OnlinePartition state change with the preferred replica election leader selector. It batches the state changes for all partitions to be able to batch the leader and isr requests sent to the brokers. This is done since there is a very high chance that the admin might use this feature to move some leaders to a particular broker. The controller deletes the admin path once it has finished processing all partitions&lt;/p&gt;

&lt;p&gt;4. Added 2 new unit tests to AdminTest&lt;/p&gt;</comment>
                            <comment id="13474638" author="nehanarkhede" created="Thu, 11 Oct 2012 23:46:27 +0000"  >&lt;p&gt;In addition to the above, I realized there was another bug while using the (String, Int) tuple for topic and partition. So I changed all such usages in controller with TopicAndPartition. Didn&apos;t change other places in code to keep this patch contained.&lt;/p&gt;</comment>
                            <comment id="13475318" author="jjkoshy" created="Fri, 12 Oct 2012 20:25:57 +0000"  >&lt;p&gt;Patch doesn&apos;t apply to 0.8 head so you will need to rebase. Here are some additional comments:&lt;/p&gt;

&lt;p&gt;PreferredReplicaLeaderElectionCommand:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;There&apos;s a Utils.checkRequiredArgs helper that you can use.&lt;/li&gt;
	&lt;li&gt;Shutdown hook should close zkClient.&lt;/li&gt;
	&lt;li&gt;updatePreferredReplicaElectionData is unused - or is this meant to support concurrent invocations of the tool in the&lt;br/&gt;
  future?&lt;/li&gt;
	&lt;li&gt;Would be good to have a short --help string for all the admin tools.&lt;/li&gt;
	&lt;li&gt;Spacing conventions: some places have no space between the last character and opening brace, else should be on new&lt;br/&gt;
  line, etc.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;KafkaController:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Instead of nulls in the controller context, can we switch to Set.empty? I can try that in &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-340&quot; title=&quot;Implement clean shutdown in 0.8&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-340&quot;&gt;&lt;del&gt;KAFKA-340&lt;/del&gt;&lt;/a&gt; as well.&lt;/li&gt;
	&lt;li&gt;Would be clearer to rename removePartitionsFromPreferredReplicaElection to maybeRemove...&lt;/li&gt;
	&lt;li&gt;Also, the name removePartitionsFromPreferredReplicationElection does not document the side-effect of deleting the&lt;br/&gt;
  PreferredReplicaLeaderElectionPath. The delete can be moved to a finally block of handleDataChange. In fact,&lt;br/&gt;
  it seems removePartitionsFromPreferredReplicaElection can also be moved (from onPreferredReplicaElection) to the&lt;br/&gt;
  finally block.&lt;/li&gt;
	&lt;li&gt;Likewise, the initialize(ReassignedPartitions|PreferredElection)Context have the additional side-effect of actually&lt;br/&gt;
  triggering the operation so can we rename accordingly? e.g., triggerPreferredReplicaLeaderElection would be a&lt;br/&gt;
  sufficient name since these two &quot;contexts&quot; really live in ControllerContext.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Revert test log4j.properties&lt;/p&gt;

&lt;p&gt;TestUtils.readFileIntoString can be removed.&lt;/p&gt;</comment>
                            <comment id="13475429" author="junrao" created="Fri, 12 Oct 2012 23:22:16 +0000"  >&lt;p&gt;Overall, patch looks good. It would useful to add an option so that the controller will try to move all partitions to the preferred replica.&lt;/p&gt;</comment>
                            <comment id="13475435" author="nehanarkhede" created="Fri, 12 Oct 2012 23:27:54 +0000"  >&lt;p&gt;Thanks for the review, Jun and Joel ! Here is a follow up patch to address your review suggestions - &lt;/p&gt;

&lt;p&gt;Joel&apos;s review&lt;/p&gt;

&lt;p&gt;&amp;gt;&amp;gt; - Would be good to have a short --help string for all the admin tools.&lt;br/&gt;
That is provided by the joptparser when you invoke it without any parameters&lt;/p&gt;

&lt;p&gt;KafkaController:&lt;br/&gt;
&amp;gt;&amp;gt; - Instead of nulls in the controller context, can we switch to Set.empty? I can try that in &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-340&quot; title=&quot;Implement clean shutdown in 0.8&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-340&quot;&gt;&lt;del&gt;KAFKA-340&lt;/del&gt;&lt;/a&gt; as well.&lt;br/&gt;
Would like to do that in a follow up cleanup patch. If you get to it before, that&apos;s fine as well.&lt;/p&gt;

&lt;p&gt;&amp;gt;&amp;gt; - Would be clearer to rename removePartitionsFromPreferredReplicaElection to maybeRemove...&lt;br/&gt;
Didn&apos;t rename this since it &lt;b&gt;always&lt;/b&gt; removes the partitions&lt;/p&gt;

&lt;p&gt;Rest of the comments are addressed&lt;/p&gt;

&lt;p&gt;Jun&apos;s review&lt;/p&gt;

&lt;p&gt;That&apos;s a great point. Changed the tool to default to all partitions. &lt;/p&gt;

&lt;p&gt;Also, found a bug in the PreferredReplicaPartitionLeaderSelector where it didn&apos;t check if the preferred replica was in the isr or not. Fixed that.&lt;/p&gt;</comment>
                            <comment id="13475461" author="junrao" created="Sat, 13 Oct 2012 00:25:43 +0000"  >&lt;p&gt;Thanks for patch v2.&lt;br/&gt;
Thanks for patch v2. Just some minor comments. Once addressed, the patch can be checked in without another review.&lt;/p&gt;

&lt;p&gt;20. AdminTest:&lt;br/&gt;
20.1 testBasicPreferredReplicaElection(): remove the println statement&lt;br/&gt;
20.2 remove unused imports&lt;/p&gt;

&lt;p&gt;21. KafkaController.removePartitionsFromPreferredReplicaElection(): If we can&apos;t move the leader, we should probably log it as warning instead of error.&lt;/p&gt;

&lt;p&gt;22. PartitionLeaderSelector.PreferredReplicaPartitionLeaderSelector(): Instead of using match/case, it seems it&apos;s simpler if we write it as if/else. If the preferred replica is in isr and is live, then we move the leader to the preferred replica. Otherwise, we just throw an exception.&lt;/p&gt;

&lt;p&gt;23. TestUtils.readFileIntoString(): not used.&lt;/p&gt;


</comment>
                            <comment id="13475468" author="nehanarkhede" created="Sat, 13 Oct 2012 00:40:45 +0000"  >&lt;p&gt;Addressed v2 review comments and checked in.&lt;/p&gt;</comment>
                            <comment id="13475473" author="jjkoshy" created="Sat, 13 Oct 2012 00:45:13 +0000"  >&lt;p&gt;re: removePartitionsFromPreferredREplicaElection - yes I misread that.&lt;/p&gt;

&lt;p&gt;For --help I was referring to a description of what the tool does. On second thoughts, a well-named script + good docs on the arguments is better.&lt;/p&gt;

&lt;p&gt;I&apos;ll address getting rid of the nulls in &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-340&quot; title=&quot;Implement clean shutdown in 0.8&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-340&quot;&gt;&lt;del&gt;KAFKA-340&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="12514687">KAFKA-50</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is blocked by">
                                        <issuelink>
            <issuekey id="12606438">KAFKA-499</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12548818" name="kafka-43-v1.patch" size="113771" author="nehanarkhede" created="Thu, 11 Oct 2012 23:05:23 +0000"/>
                            <attachment id="12548985" name="kafka-43-v2.patch" size="101154" author="nehanarkhede" created="Fri, 12 Oct 2012 23:27:54 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>67072</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 6 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i029d3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>11118</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>