<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:14:08 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-7134] KafkaLog4jAppender - Appender exceptions are propagated to caller</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-7134</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;KafkaLog4jAppender exceptions are propagated to caller when Kafka is down/slow/other, it may cause the application crash. Ideally appender should&#160;print and ignore the exception&lt;br/&gt;
 or should provide option to ignore/throw the exceptions like &apos;ignoreExceptions&apos; property&#160;of &lt;a href=&quot;https://logging.apache.org/log4j/2.x/manual/appenders.html#KafkaAppender&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://logging.apache.org/log4j/2.x/manual/appenders.html#KafkaAppender&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13170196">KAFKA-7134</key>
            <summary>KafkaLog4jAppender - Appender exceptions are propagated to caller</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="akatona">Andras Katona</assignee>
                                    <reporter username="venkatpotru">venkata praveen</reporter>
                        <labels>
                    </labels>
                <created>Thu, 5 Jul 2018 08:22:13 +0000</created>
                <updated>Thu, 30 Aug 2018 14:17:17 +0000</updated>
                            <resolved>Thu, 30 Aug 2018 14:17:17 +0000</resolved>
                                                    <fixVersion>2.1.0</fixVersion>
                                    <component>clients</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16552946" author="githubbot" created="Mon, 23 Jul 2018 14:45:32 +0000"  >&lt;p&gt;akatona84 opened a new pull request #5415: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7134&quot; title=&quot;KafkaLog4jAppender - Appender exceptions are propagated to caller&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7134&quot;&gt;&lt;del&gt;KAFKA-7134&lt;/del&gt;&lt;/a&gt;: KafkaLog4jAppender - Appender exceptions are propagated t&#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5415&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5415&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   &#8230;o caller&lt;/p&gt;

&lt;p&gt;   Handling ignoreExceptions property in KafkaLog4jAppender&lt;/p&gt;

&lt;p&gt;   *More detailed description of your change,&lt;br/&gt;
   if necessary. The PR title and PR message become&lt;br/&gt;
   the squashed commit message, so use a separate&lt;br/&gt;
   comment to ping reviewers.*&lt;/p&gt;

&lt;p&gt;   *Summary of testing strategy (including rationale)&lt;br/&gt;
   for the feature or bug fix. Unit and/or integration&lt;br/&gt;
   tests are expected for any behaviour change and&lt;br/&gt;
   system tests should be considered for larger changes.*&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16558028" author="akatona" created="Thu, 26 Jul 2018 07:49:12 +0000"  >&lt;p&gt;I just realized, there are two&#160;KafkaLog4jAppender classes:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;org.apache.kafka.log4jappender.KafkaLog4jAppender - this is in kafka repository&lt;/li&gt;
	&lt;li&gt;org.apache.logging.log4j.core.appender.mom.kafka.KafkaAppender - in log4j repository&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;The documentation is about #2. And in my opinion that one should be used instead of #1. The appender in log4j repository is far more sophisticated.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=venkatpotru&quot; class=&quot;user-hover&quot; rel=&quot;venkatpotru&quot;&gt;venkatpotru&lt;/a&gt;, which appender is this issue about?&lt;/p&gt;</comment>
                            <comment id="16558077" author="venkatpotru" created="Thu, 26 Jul 2018 08:56:19 +0000"  >&lt;p&gt;This issue is about 1st one i.e :&#160;org.apache.kafka.log4jappender.KafkaLog4jAppender.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16558325" author="asasvari" created="Thu, 26 Jul 2018 13:47:12 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=venkatpotru&quot; class=&quot;user-hover&quot; rel=&quot;venkatpotru&quot;&gt;venkatpotru&lt;/a&gt; please note if the underlying producer cannot connect to a Kafka broker (because the broker is not running), &lt;tt&gt;send()&lt;/tt&gt; will fail and throw a &lt;tt&gt;TimeoutException&lt;/tt&gt;. The producer will notice it and tries to log it:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/kafka/blob/1d9a427225c64e7629a4eb2e2d129d5551185049/clients/src/main/java/org/apache/kafka/clients/producer/KafkaProducer.java#L876&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/1d9a427225c64e7629a4eb2e2d129d5551185049/clients/src/main/java/org/apache/kafka/clients/producer/KafkaProducer.java#L876&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;However, if the &lt;tt&gt;rootLogger&lt;/tt&gt; in &lt;tt&gt;log4j.properties&lt;/tt&gt; is set to the &lt;tt&gt;KafkaLog4jAppender&lt;/tt&gt;, it will try to log this message and send it to Kafka, and it creates an infinite loop. &lt;/p&gt;</comment>
                            <comment id="16559353" author="akatona" created="Fri, 27 Jul 2018 07:07:33 +0000"  >&lt;p&gt;When using kafka appender, logging from org.apache.kafka.* packages should be disabled.&lt;/p&gt;</comment>
                            <comment id="16561600" author="venkatpotru" created="Mon, 30 Jul 2018 08:04:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=asasvari&quot; class=&quot;user-hover&quot; rel=&quot;asasvari&quot;&gt;asasvari&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=akatona&quot; class=&quot;user-hover&quot; rel=&quot;akatona&quot;&gt;akatona&lt;/a&gt; -&#160;Got&#160;the point and its valid. And thanks for&#160;mentioning it. \&lt;/p&gt;

&lt;p&gt;By the way how the appender behaves when kafka is down&#160;while&#160;its being initialized?&#160; And what happens if the&#160;application ignores the appender initialization&#160;exception and&#160;continues with application startup? there could be a chance of NullPointer on producer?&lt;/p&gt;</comment>
                            <comment id="16574622" author="akatona" created="Thu, 9 Aug 2018 10:02:00 +0000"  >&lt;p&gt;My pull request&apos;s review/acceptance is a bit stuck, let me summarise it here as well.&lt;/p&gt;

&lt;p&gt;I&apos;ve introduced two new config parameters to the log appender:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;b&gt;ignoreExceptions&lt;/b&gt; - by default it is not ignoring exceptions thrown by the producer, has to be true in order to ignore them&lt;/li&gt;
	&lt;li&gt;&lt;b&gt;maxBlockMs&lt;/b&gt; - it is introduced basically just to be able to test the ignoreExceptions&#160;parameter more efficiently with real log appender, without a producer behind it. By default it is 60 sec (that would be too much to wait in tests)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Regarding reviews, after a few iterations, the change is fine, although there is a question in this conversation, which is not answered yet.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/kafka/pull/5415#discussion_r207178978&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5415#discussion_r207178978&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Asked by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rsivaram&quot; class=&quot;user-hover&quot; rel=&quot;rsivaram&quot;&gt;rsivaram&lt;/a&gt; from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ijuma&quot; class=&quot;user-hover&quot; rel=&quot;ijuma&quot;&gt;ijuma&lt;/a&gt;&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://github.com/ijuma&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;@ijuma&lt;/a&gt;&#160;Do we use KIPs for adding configs to&#160;&lt;tt&gt;KafkaLog4jAppender&lt;/tt&gt;&#160;(&lt;tt&gt;ignoreExceptions&lt;/tt&gt; and&#160;&lt;tt&gt;timeout&lt;/tt&gt;&#160;here)?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;&lt;b&gt;Note:&lt;/b&gt; &lt;tt&gt;timeout&lt;/tt&gt; is renamed to &lt;tt&gt;maxBlockMs&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ijuma&quot; class=&quot;user-hover&quot; rel=&quot;ijuma&quot;&gt;ijuma&lt;/a&gt;, could you check whether we need a KIP for these changes? I hope not, since this is a minor enhancement, but I&apos;m looking forward to your answer. Thanks!&lt;/p&gt;</comment>
                            <comment id="16596214" author="githubbot" created="Wed, 29 Aug 2018 11:30:42 +0000"  >&lt;p&gt;rajinisivaram closed pull request #5415: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7134&quot; title=&quot;KafkaLog4jAppender - Appender exceptions are propagated to caller&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7134&quot;&gt;&lt;del&gt;KAFKA-7134&lt;/del&gt;&lt;/a&gt;: KafkaLog4jAppender - Appender exceptions are propagated t&#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5415&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5415&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/build.gradle b/build.gradle&lt;br/&gt;
index 9b4610d0b22..b13e94856df 100644&lt;br/&gt;
&amp;#8212; a/build.gradle&lt;br/&gt;
+++ b/build.gradle&lt;br/&gt;
@@ -1235,6 +1235,7 @@ project(&apos;:log4j-appender&apos;) &lt;/p&gt;
{
 
     testCompile project(&apos;:clients&apos;).sourceSets.test.output
     testCompile libs.junit
+    testCompile libs.easymock
   }

&lt;p&gt;   javadoc {&lt;br/&gt;
diff --git a/log4j-appender/src/main/java/org/apache/kafka/log4jappender/KafkaLog4jAppender.java b/log4j-appender/src/main/java/org/apache/kafka/log4jappender/KafkaLog4jAppender.java&lt;br/&gt;
index 6ddaf929a6d..0ae7dcada93 100644&lt;br/&gt;
&amp;#8212; a/log4j-appender/src/main/java/org/apache/kafka/log4jappender/KafkaLog4jAppender.java&lt;br/&gt;
+++ b/log4j-appender/src/main/java/org/apache/kafka/log4jappender/KafkaLog4jAppender.java&lt;br/&gt;
@@ -35,6 +35,7 @@&lt;br/&gt;
 import static org.apache.kafka.clients.producer.ProducerConfig.COMPRESSION_TYPE_CONFIG;&lt;br/&gt;
 import static org.apache.kafka.clients.producer.ProducerConfig.ACKS_CONFIG;&lt;br/&gt;
 import static org.apache.kafka.clients.producer.ProducerConfig.DELIVERY_TIMEOUT_MS_CONFIG;&lt;br/&gt;
+import static org.apache.kafka.clients.producer.ProducerConfig.MAX_BLOCK_MS_CONFIG;&lt;br/&gt;
 import static org.apache.kafka.clients.producer.ProducerConfig.RETRIES_CONFIG;&lt;br/&gt;
 import static org.apache.kafka.clients.producer.ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG;&lt;br/&gt;
 import static org.apache.kafka.clients.producer.ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG;&lt;br/&gt;
@@ -64,10 +65,12 @@&lt;br/&gt;
     private String saslKerberosServiceName;&lt;br/&gt;
     private String clientJaasConfPath;&lt;br/&gt;
     private String kerb5ConfPath;&lt;br/&gt;
+    private Integer maxBlockMs;&lt;/p&gt;

&lt;p&gt;     private int retries = Integer.MAX_VALUE;&lt;br/&gt;
     private int requiredNumAcks = 1;&lt;br/&gt;
     private int deliveryTimeoutMs = 120000;&lt;br/&gt;
+    private boolean ignoreExceptions = true;&lt;br/&gt;
     private boolean syncSend;&lt;br/&gt;
     private Producer&amp;lt;byte[], byte[]&amp;gt; producer;&lt;/p&gt;

&lt;p&gt;@@ -123,6 +126,14 @@ public void setTopic(String topic) &lt;/p&gt;
{
         this.topic = topic;
     }

&lt;p&gt;+    public boolean getIgnoreExceptions() &lt;/p&gt;
{
+        return ignoreExceptions;
+    }
&lt;p&gt;+&lt;br/&gt;
+    public void setIgnoreExceptions(boolean ignoreExceptions) &lt;/p&gt;
{
+        this.ignoreExceptions = ignoreExceptions;
+    }
&lt;p&gt;+&lt;br/&gt;
     public boolean getSyncSend() &lt;/p&gt;
{
         return syncSend;
     }
&lt;p&gt;@@ -203,6 +214,14 @@ public String getKerb5ConfPath() &lt;/p&gt;
{
         return kerb5ConfPath;
     }

&lt;p&gt;+    public int getMaxBlockMs() &lt;/p&gt;
{
+        return maxBlockMs;
+    }
&lt;p&gt;+&lt;br/&gt;
+    public void setMaxBlockMs(int maxBlockMs) &lt;/p&gt;
{
+        this.maxBlockMs = maxBlockMs;
+    }
&lt;p&gt;+&lt;br/&gt;
     @Override&lt;br/&gt;
     public void activateOptions() {&lt;br/&gt;
         // check for config parameter validity&lt;br/&gt;
@@ -242,6 +261,9 @@ public void activateOptions() &lt;/p&gt;
{
                 System.setProperty(&quot;java.security.krb5.conf&quot;, kerb5ConfPath);
             }
&lt;p&gt;         }&lt;br/&gt;
+        if (maxBlockMs != null) &lt;/p&gt;
{
+            props.put(MAX_BLOCK_MS_CONFIG, maxBlockMs);
+        }

&lt;p&gt;         props.put(KEY_SERIALIZER_CLASS_CONFIG, ByteArraySerializer.class.getName());&lt;br/&gt;
         props.put(VALUE_SERIALIZER_CLASS_CONFIG, ByteArraySerializer.class.getName());&lt;br/&gt;
@@ -259,12 +281,14 @@ protected void append(LoggingEvent event) {&lt;br/&gt;
         String message = subAppend(event);&lt;br/&gt;
         LogLog.debug(&quot;&lt;span class=&quot;error&quot;&gt;&amp;#91;&amp;quot; + new Date(event.getTimeStamp()) + &amp;quot;&amp;#93;&lt;/span&gt;&quot; + message);&lt;br/&gt;
         Future&amp;lt;RecordMetadata&amp;gt; response = producer.send(&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;new ProducerRecord&amp;lt;byte[], byte[]&amp;gt;(topic, message.getBytes(StandardCharsets.UTF_8)));&lt;br/&gt;
+            new ProducerRecord&amp;lt;&amp;gt;(topic, message.getBytes(StandardCharsets.UTF_8)));&lt;br/&gt;
         if (syncSend) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {             try {
                 response.get();
             } catch (InterruptedException | ExecutionException ex) {
-                throw new RuntimeException(ex);
+                if (!ignoreExceptions)
+                    throw new RuntimeException(ex);
+                LogLog.debug(&quot;Exception while getting response&quot;, ex);
             }         }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;     }&lt;br/&gt;
diff --git a/log4j-appender/src/test/java/org/apache/kafka/log4jappender/KafkaLog4jAppenderTest.java b/log4j-appender/src/test/java/org/apache/kafka/log4jappender/KafkaLog4jAppenderTest.java&lt;br/&gt;
index 34be2e93c88..d5342e8f9e3 100644&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/log4j-appender/src/test/java/org/apache/kafka/log4jappender/KafkaLog4jAppenderTest.java&lt;br/&gt;
+++ b/log4j-appender/src/test/java/org/apache/kafka/log4jappender/KafkaLog4jAppenderTest.java&lt;br/&gt;
@@ -16,18 +16,31 @@&lt;br/&gt;
  */&lt;br/&gt;
 package org.apache.kafka.log4jappender;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;+import org.apache.kafka.clients.producer.MockProducer;&lt;br/&gt;
+import org.apache.kafka.clients.producer.RecordMetadata;&lt;br/&gt;
 import org.apache.kafka.common.config.ConfigException;&lt;br/&gt;
 import org.apache.log4j.Logger;&lt;br/&gt;
 import org.apache.log4j.PropertyConfigurator;&lt;br/&gt;
+import org.apache.log4j.helpers.LogLog;&lt;br/&gt;
+import org.easymock.EasyMock;&lt;br/&gt;
 import org.junit.Assert;&lt;br/&gt;
+import org.junit.Before;&lt;br/&gt;
 import org.junit.Test;&lt;/p&gt;

&lt;p&gt;-import java.io.UnsupportedEncodingException;&lt;br/&gt;
+import java.nio.charset.StandardCharsets;&lt;br/&gt;
 import java.util.Properties;&lt;br/&gt;
+import java.util.concurrent.ExecutionException;&lt;br/&gt;
+import java.util.concurrent.Future;&lt;br/&gt;
+import java.util.concurrent.TimeoutException;&lt;/p&gt;

&lt;p&gt; public class KafkaLog4jAppenderTest {&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Logger logger = Logger.getLogger(KafkaLog4jAppenderTest.class);&lt;br/&gt;
+    private Logger logger = Logger.getLogger(KafkaLog4jAppenderTest.class);&lt;br/&gt;
+&lt;br/&gt;
+    @Before&lt;br/&gt;
+    public void setup() 
{
+        LogLog.setInternalDebugging(true);
+    }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     @Test&lt;br/&gt;
     public void testKafkaLog4jConfigs() {&lt;br/&gt;
@@ -66,22 +79,103 @@ public void testKafkaLog4jConfigs() {&lt;/p&gt;


&lt;p&gt;     @Test&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public void testLog4jAppends() throws UnsupportedEncodingException {&lt;/li&gt;
	&lt;li&gt;PropertyConfigurator.configure(getLog4jConfig());&lt;br/&gt;
+    public void testLog4jAppends() {&lt;br/&gt;
+        PropertyConfigurator.configure(getLog4jConfig(false));&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         for (int i = 1; i &amp;lt;= 5; ++i) &lt;/p&gt;
{
             logger.error(getMessage(i));
         }

&lt;p&gt;         Assert.assertEquals(&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;5, ((MockKafkaLog4jAppender) (logger.getRootLogger().getAppender(&quot;KAFKA&quot;))).getHistory().size());&lt;br/&gt;
+            5, (getMockKafkaLog4jAppender()).getHistory().size());&lt;br/&gt;
+    }&lt;br/&gt;
+&lt;br/&gt;
+    @Test(expected = RuntimeException.class)&lt;br/&gt;
+    public void testLog4jAppendsWithSyncSendAndSimulateProducerFailShouldThrowException() 
{
+        Properties props = getLog4jConfig(true);
+        props.put(&quot;log4j.appender.KAFKA.IgnoreExceptions&quot;, &quot;false&quot;);
+        PropertyConfigurator.configure(props);
+
+        MockKafkaLog4jAppender mockKafkaLog4jAppender = getMockKafkaLog4jAppender();
+        replaceProducerWithMocked(mockKafkaLog4jAppender, false);
+
+        logger.error(getMessage(0));
+    }
&lt;p&gt;+&lt;br/&gt;
+    @Test&lt;br/&gt;
+    public void testLog4jAppendsWithSyncSendWithoutIgnoringExceptionsShouldNotThrowException() &lt;/p&gt;
{
+        Properties props = getLog4jConfig(true);
+        props.put(&quot;log4j.appender.KAFKA.IgnoreExceptions&quot;, &quot;false&quot;);
+        PropertyConfigurator.configure(props);
+
+        MockKafkaLog4jAppender mockKafkaLog4jAppender = getMockKafkaLog4jAppender();
+        replaceProducerWithMocked(mockKafkaLog4jAppender, true);
+
+        logger.error(getMessage(0));
+    }
&lt;p&gt;+&lt;br/&gt;
+    @Test&lt;br/&gt;
+    public void testLog4jAppendsWithRealProducerConfigWithSyncSendShouldNotThrowException() &lt;/p&gt;
{
+        Properties props = getLog4jConfigWithRealProducer(true);
+        PropertyConfigurator.configure(props);
+
+        logger.error(getMessage(0));
+    }
&lt;p&gt;+&lt;br/&gt;
+    @Test(expected = RuntimeException.class)&lt;br/&gt;
+    public void testLog4jAppendsWithRealProducerConfigWithSyncSendAndNotIgnoringExceptionsShouldThrowException() &lt;/p&gt;
{
+        Properties props = getLog4jConfigWithRealProducer(false);
+        PropertyConfigurator.configure(props);
+
+        logger.error(getMessage(0));
     }&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private byte[] getMessage(int i) throws UnsupportedEncodingException {&lt;/li&gt;
	&lt;li&gt;return (&quot;test_&quot; + i).getBytes(&quot;UTF-8&quot;);&lt;br/&gt;
+    private void replaceProducerWithMocked(MockKafkaLog4jAppender mockKafkaLog4jAppender, boolean success) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+        @SuppressWarnings(&amp;quot;unchecked&amp;quot;)+        MockProducer&amp;lt;byte[], byte[]&amp;gt; producer = EasyMock.niceMock(MockProducer.class);+        @SuppressWarnings(&amp;quot;unchecked&amp;quot;)+        Future&amp;lt;RecordMetadata&amp;gt; futureMock = EasyMock.niceMock(Future.class);+        try {
+            if (!success)
+                EasyMock.expect(futureMock.get())
+                    .andThrow(new ExecutionException(&quot;simulated timeout&quot;, new TimeoutException()));
+        } catch (InterruptedException | ExecutionException e) {
+            // just mocking
+        }+        EasyMock.expect(producer.send(EasyMock.anyObject())).andReturn(futureMock);+        EasyMock.replay(producer, futureMock);+        // reconfiguring mock appender+        mockKafkaLog4jAppender.setKafkaProducer(producer);+        mockKafkaLog4jAppender.activateOptions();+    }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;+&lt;br/&gt;
+    private MockKafkaLog4jAppender getMockKafkaLog4jAppender() &lt;/p&gt;
{
+        return (MockKafkaLog4jAppender) Logger.getRootLogger().getAppender(&quot;KAFKA&quot;);
+    }
&lt;p&gt;+&lt;br/&gt;
+    private byte[] getMessage(int i) &lt;/p&gt;
{
+        return (&quot;test_&quot; + i).getBytes(StandardCharsets.UTF_8);
+    }
&lt;p&gt;+&lt;br/&gt;
+    private Properties getLog4jConfigWithRealProducer(boolean ignoreExceptions) &lt;/p&gt;
{
+        Properties props = new Properties();
+        props.put(&quot;log4j.rootLogger&quot;, &quot;INFO, KAFKA&quot;);
+        props.put(&quot;log4j.appender.KAFKA&quot;, &quot;org.apache.kafka.log4jappender.KafkaLog4jAppender&quot;);
+        props.put(&quot;log4j.appender.KAFKA.layout&quot;, &quot;org.apache.log4j.PatternLayout&quot;);
+        props.put(&quot;log4j.appender.KAFKA.layout.ConversionPattern&quot;, &quot;%-5p: %c - %m%n&quot;);
+        props.put(&quot;log4j.appender.KAFKA.BrokerList&quot;, &quot;127.0.0.2:9093&quot;);
+        props.put(&quot;log4j.appender.KAFKA.Topic&quot;, &quot;test-topic&quot;);
+        props.put(&quot;log4j.appender.KAFKA.RequiredNumAcks&quot;, &quot;1&quot;);
+        props.put(&quot;log4j.appender.KAFKA.SyncSend&quot;, &quot;true&quot;);
+        // setting producer timeout (max.block.ms) to be low
+        props.put(&quot;log4j.appender.KAFKA.maxBlockMs&quot;, &quot;10&quot;);
+        // ignoring exceptions
+        props.put(&quot;log4j.appender.KAFKA.IgnoreExceptions&quot;, Boolean.toString(ignoreExceptions));
+        props.put(&quot;log4j.logger.kafka.log4j&quot;, &quot;INFO, KAFKA&quot;);
+        return props;
     }&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private Properties getLog4jConfig() {&lt;br/&gt;
+    private Properties getLog4jConfig(boolean syncSend) {&lt;br/&gt;
         Properties props = new Properties();&lt;br/&gt;
         props.put(&quot;log4j.rootLogger&quot;, &quot;INFO, KAFKA&quot;);&lt;br/&gt;
         props.put(&quot;log4j.appender.KAFKA&quot;, &quot;org.apache.kafka.log4jappender.MockKafkaLog4jAppender&quot;);&lt;br/&gt;
@@ -90,7 +184,7 @@ private Properties getLog4jConfig() 
{
         props.put(&quot;log4j.appender.KAFKA.BrokerList&quot;, &quot;127.0.0.1:9093&quot;);
         props.put(&quot;log4j.appender.KAFKA.Topic&quot;, &quot;test-topic&quot;);
         props.put(&quot;log4j.appender.KAFKA.RequiredNumAcks&quot;, &quot;1&quot;);
-        props.put(&quot;log4j.appender.KAFKA.SyncSend&quot;, &quot;false&quot;);
+        props.put(&quot;log4j.appender.KAFKA.SyncSend&quot;, Boolean.toString(syncSend));
         props.put(&quot;log4j.logger.kafka.log4j&quot;, &quot;INFO, KAFKA&quot;);
         return props;
     }
&lt;p&gt;diff --git a/log4j-appender/src/test/java/org/apache/kafka/log4jappender/MockKafkaLog4jAppender.java b/log4j-appender/src/test/java/org/apache/kafka/log4jappender/MockKafkaLog4jAppender.java&lt;br/&gt;
index 8040be4ccc6..a9eb5fb0721 100644&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/log4j-appender/src/test/java/org/apache/kafka/log4jappender/MockKafkaLog4jAppender.java&lt;br/&gt;
+++ b/log4j-appender/src/test/java/org/apache/kafka/log4jappender/MockKafkaLog4jAppender.java&lt;br/&gt;
@@ -34,6 +34,10 @@&lt;br/&gt;
         return mockProducer;&lt;br/&gt;
     }&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;+    void setKafkaProducer(MockProducer&amp;lt;byte[], byte[]&amp;gt; producer) &lt;/p&gt;
{
+        this.mockProducer = producer;
+    }
&lt;p&gt;+&lt;br/&gt;
     @Override&lt;br/&gt;
     protected void append(LoggingEvent event) {&lt;br/&gt;
         if (super.getProducer() == null) {&lt;br/&gt;
@@ -42,7 +46,7 @@ protected void append(LoggingEvent event) &lt;/p&gt;
{
         super.append(event);
     }

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;protected List&amp;lt;ProducerRecord&amp;lt;byte[], byte[]&amp;gt;&amp;gt; getHistory() 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+    List&amp;lt;ProducerRecord&amp;lt;byte[], byte[]&amp;gt;&amp;gt; getHistory() {
         return mockProducer.history();
     } }&lt;/span&gt; &lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;





&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16597229" author="akatona" created="Thu, 30 Aug 2018 09:22:07 +0000"  >&lt;p&gt;Pull request is merged to trunk, yet this ticket is not closed automatically. I&apos;m not sure what to do in this case&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 11 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3vkb3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>