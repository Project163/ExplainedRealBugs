<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:54:11 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-3627] New consumer doesn&apos;t run delayed tasks while under load</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-3627</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;If the new consumer receives a steady flow of fetch responses it will not run delayed tasks, which means it will not heartbeat or perform automatic offset commits.&lt;/p&gt;

&lt;p&gt;The main cause is the code that attempts to pipeline fetch responses and keep the consumer fed.  Specifically, in KafkaConsumer::pollOnce() there is a check that skips calling client.poll() if there are fetched records ready (line 903 in the 0.9.0 branch of this writing).  Then in KafkaConsumer::poll(), if records are returned it will initiate another fetch and perform a quick poll, which will send/receive fetch requests/responses but will not run delayed tasks.&lt;/p&gt;

&lt;p&gt;If the timing works out, and the consumer is consistently receiving fetched records, it won&apos;t run delayed tasks until it doesn&apos;t receive a fetch response during its quick poll.  That leads to a rebalance since the consumer isn&apos;t heartbeating, and typically means all the consumed records will be re-delivered since the automatic offset commit wasn&apos;t able to run either.&lt;/p&gt;

&lt;h5&gt;&lt;a name=&quot;Stepstoreproduce&quot;&gt;&lt;/a&gt;Steps to reproduce&lt;/h5&gt;
&lt;ol&gt;
	&lt;li&gt;Start up a cluster with &lt;b&gt;at least 2 brokers&lt;/b&gt;.  This seems to be required to reproduce the issue, I&apos;m guessing because the fetch responses all arrive together when using a single broker.&lt;/li&gt;
	&lt;li&gt;Create a topic with a good number of partitions
	&lt;ul&gt;
		&lt;li&gt;&lt;blockquote&gt;&lt;p&gt;bin/kafka-topics.sh --zookeeper localhost:2181 --create --topic delayed-task-bug --partitions 10 --replication-factor 1&lt;/p&gt;&lt;/blockquote&gt;&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;Generate some test data so the consumer has plenty to consume.  In this case I&apos;m just using uuids
	&lt;ul&gt;
		&lt;li&gt;&lt;blockquote&gt;&lt;p&gt;for ((i=0;i&amp;lt;100;++i)) do; cat /proc/sys/kernel/random/uuid &amp;gt;&amp;gt;  /tmp/test-messages; done&lt;/p&gt;&lt;/blockquote&gt;&lt;/li&gt;
		&lt;li&gt;&lt;blockquote&gt;&lt;p&gt;bin/kafka-console-producer.sh --broker-list localhost:9092 --topic delayed-task-bug &amp;lt; /tmp/test-messages&lt;/p&gt;&lt;/blockquote&gt;&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;Start up a consumer with a small max fetch size to ensure it only pulls a few records at a time.  The consumer can simply sleep for a moment when it receives a record.
	&lt;ul&gt;
		&lt;li&gt;I&apos;ll attach an example in Java&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;There&apos;s a timing aspect to this issue so it may take a few attempts to reproduce&lt;/li&gt;
&lt;/ol&gt;
</description>
                <environment></environment>
        <key id="12962748">KAFKA-3627</key>
            <summary>New consumer doesn&apos;t run delayed tasks while under load</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hachikuji">Jason Gustafson</assignee>
                                    <reporter username="robu">Rob Underwood</reporter>
                        <labels>
                    </labels>
                <created>Tue, 26 Apr 2016 21:19:18 +0000</created>
                <updated>Tue, 17 May 2016 13:54:05 +0000</updated>
                            <resolved>Fri, 6 May 2016 05:24:32 +0000</resolved>
                                    <version>0.9.0.1</version>
                                    <fixVersion>0.10.0.0</fixVersion>
                                    <component>consumer</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="15258963" author="robu" created="Tue, 26 Apr 2016 21:28:27 +0000"  >&lt;p&gt;I&apos;ve attached an example consumer in Java that often reproduces the issue, as well as the output from one such reproduction.&lt;/p&gt;</comment>
                            <comment id="15258986" author="hachikuji" created="Tue, 26 Apr 2016 21:42:36 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=robu&quot; class=&quot;user-hover&quot; rel=&quot;robu&quot;&gt;robu&lt;/a&gt; Good catch and thanks for the investigation. The obvious solution is to allow that call to execute delayed tasks, but I think we have to be a little careful that we don&apos;t call anything which can lead to a wakeup before we&apos;ve returned data to the user. I feel maybe the solution is to avoid updating the offset until we are ready to return, but I&apos;ll check whether there are any simpler options.&lt;/p&gt;</comment>
                            <comment id="15264870" author="githubbot" created="Fri, 29 Apr 2016 22:17:58 +0000"  >&lt;p&gt;GitHub user hachikuji opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/1295&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/1295&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3627&quot; title=&quot;New consumer doesn&amp;#39;t run delayed tasks while under load&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3627&quot;&gt;&lt;del&gt;KAFKA-3627&lt;/del&gt;&lt;/a&gt;: consumer fails to execute delayed tasks in poll when records are available&lt;/p&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/hachikuji/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/hachikuji/kafka&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3627&quot; title=&quot;New consumer doesn&amp;#39;t run delayed tasks while under load&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3627&quot;&gt;&lt;del&gt;KAFKA-3627&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/1295.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/1295.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #1295&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 04116c65369926955d79084851f6dfda313b5fee&lt;br/&gt;
Author: Jason Gustafson &amp;lt;jason@confluent.io&amp;gt;&lt;br/&gt;
Date:   2016-04-29T21:58:35Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3627&quot; title=&quot;New consumer doesn&amp;#39;t run delayed tasks while under load&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3627&quot;&gt;&lt;del&gt;KAFKA-3627&lt;/del&gt;&lt;/a&gt;: consumer fails to execute delayed tasks in poll when records are available&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15272615" author="davispw" created="Thu, 5 May 2016 16:51:58 +0000"  >&lt;p&gt;I believe this problem is aggravated by max.poll.messages, but since there are timing issues I haven&apos;t confirmed.  I can confirm that this is affecting us and that any failure to heartbeat or commit is an extremely serious problem as it can result in a &quot;rebalance storm&quot; where no consumers ever make progress.  Unfortunately, we are banking on max.poll.messages to address other rebalance storm problems.&lt;/p&gt;</comment>
                            <comment id="15273186" author="hachikuji" created="Thu, 5 May 2016 22:02:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davispw&quot; class=&quot;user-hover&quot; rel=&quot;davispw&quot;&gt;davispw&lt;/a&gt; Yes, you are right. No heartbeats are sent while data has been buffered, which is why I upgraded to blocker. I think the patch is mostly ready to go, but we&apos;re looking at some system test failures to see if they could be related. I expect a fix to go into 0.10 in any case.&lt;/p&gt;</comment>
                            <comment id="15273644" author="ewencp" created="Fri, 6 May 2016 05:24:32 +0000"  >&lt;p&gt;Issue resolved by pull request 1295&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/kafka/pull/1295&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/1295&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15273645" author="githubbot" created="Fri, 6 May 2016 05:24:39 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/1295&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/1295&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12800882" name="DelayedTaskBugConsumer.java" size="4271" author="robu" created="Tue, 26 Apr 2016 21:25:03 +0000"/>
                            <attachment id="12800883" name="kafka-3627-output.log" size="61015" author="robu" created="Tue, 26 Apr 2016 21:27:04 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 28 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2wrzb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>