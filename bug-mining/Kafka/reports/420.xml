<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:40:06 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-1350] Fix excessive state change logging</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-1350</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;I can provide steps to reproduce this issue.  The state change logger needs&lt;br/&gt;
to be guarded (to check if trace logging is turned on or not).&lt;/p&gt;

&lt;p&gt;The delete topic patch significantly increased the amount of logging that we&lt;br/&gt;
do both on the controller. This results in higher latencies in state&lt;br/&gt;
transitions and can slow down the controller (as well as the broker).  This&lt;br/&gt;
slow-down was how we ran into &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-1342&quot; title=&quot;Slow controlled shutdowns can result in stale shutdown requests&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-1342&quot;&gt;&lt;del&gt;KAFKA-1342&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12704394">KAFKA-1350</key>
            <summary>Fix excessive state change logging</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="nehanarkhede">Neha Narkhede</assignee>
                                    <reporter username="jjkoshy">Joel Jacob Koshy</reporter>
                        <labels>
                    </labels>
                <created>Fri, 28 Mar 2014 23:47:04 +0000</created>
                <updated>Wed, 9 Apr 2014 22:32:22 +0000</updated>
                            <resolved>Tue, 1 Apr 2014 05:29:41 +0000</resolved>
                                    <version>0.8.1</version>
                                    <fixVersion>0.8.1.1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="13954436" author="guozhang" created="Sat, 29 Mar 2014 20:43:02 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jjkoshy&quot; class=&quot;user-hover&quot; rel=&quot;jjkoshy&quot;&gt;jjkoshy&lt;/a&gt; Could you provide some more context? I thought the state change logging is guarded by log4j?&lt;/p&gt;</comment>
                            <comment id="13954594" author="nehanarkhede" created="Sun, 30 Mar 2014 06:22:10 +0000"  >&lt;p&gt;Created reviewboard &lt;a href=&quot;https://reviews.apache.org/r/19828/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/19828/&lt;/a&gt;&lt;br/&gt;
 against branch 0.8.1&lt;/p&gt;</comment>
                            <comment id="13954595" author="nehanarkhede" created="Sun, 30 Mar 2014 06:28:13 +0000"  >&lt;p&gt;Updated reviewboard &lt;a href=&quot;https://reviews.apache.org/r/19828/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/19828/&lt;/a&gt;&lt;br/&gt;
 against branch 0.8.1&lt;/p&gt;</comment>
                            <comment id="13954596" author="nehanarkhede" created="Sun, 30 Mar 2014 06:29:35 +0000"  >&lt;p&gt;Uploaded a patch against the 0.8.1 branch. Once it is reviewed, will upload a patch against trunk&lt;/p&gt;</comment>
                            <comment id="13954854" author="tnachen" created="Sun, 30 Mar 2014 22:17:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; the state change logger log call itself isn&apos;t guarded, and although it might not output once it goes into the method, the most expensive call was actually the string.format that forms the log message overall takes a long time to process.&lt;/p&gt;</comment>
                            <comment id="13954869" author="nehanarkhede" created="Sun, 30 Mar 2014 23:41:42 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tnachen&quot; class=&quot;user-hover&quot; rel=&quot;tnachen&quot;&gt;tnachen&lt;/a&gt; Filed &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-1351&quot; title=&quot;String.format is very expensive in Scala&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-1351&quot;&gt;KAFKA-1351&lt;/a&gt; to convert the String.format uses in our logging.&lt;/p&gt;</comment>
                            <comment id="13955520" author="guozhang" created="Mon, 31 Mar 2014 18:49:31 +0000"  >&lt;p&gt;I think if the corresponding level is not triggered, it should not invoke the string.format function. But if we use the getLogger() and use that instance function, then the string.format call will be triggered no matter what. This is a small test I did:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;TestMisc.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;object TestMisc &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; Logging {
  def main(args: Array[&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;]) {

    &lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; count = 0

    info(&lt;span class=&quot;code-quote&quot;&gt;&quot;INFO Printed %d&quot;&lt;/span&gt;.format( {count+=1;count} ) )
    debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;DEBUG Printed %d&quot;&lt;/span&gt;.format( {count+=1;count} ) )

    println(&lt;span class=&quot;code-quote&quot;&gt;&quot;Final Count %d&quot;&lt;/span&gt;.format(count))

    val dummyLogger = Logger.getLogger(KafkaController.stateChangeLogger)
    count = 0

    dummyLogger.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;INFO Printed %d&quot;&lt;/span&gt;.format( {count+=1;count} ) )
    dummyLogger.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;DEBUG Printed %d&quot;&lt;/span&gt;.format( {count+=1;count} ) )

    println(&lt;span class=&quot;code-quote&quot;&gt;&quot;Final Count %d&quot;&lt;/span&gt;.format(count))
  }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;with log4j at INFO the output:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;2014-03-31 12:47:34,207&amp;#93;&lt;/span&gt; INFO INFO Printed 1 (kafka.TestMisc$)&lt;br/&gt;
Final Count 1&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2014-03-31 12:47:34,213&amp;#93;&lt;/span&gt; INFO INFO Printed 1 (state.change.logger)&lt;br/&gt;
Final Count 2&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;with log4j at DEBUG the output:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;2014-03-31 12:50:54,211&amp;#93;&lt;/span&gt; INFO INFO Printed 1 (kafka.TestMisc$)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2014-03-31 12:50:54,213&amp;#93;&lt;/span&gt; DEBUG DEBUG Printed 2 (kafka.TestMisc$)&lt;br/&gt;
Final Count 2&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2014-03-31 12:50:54,219&amp;#93;&lt;/span&gt; INFO INFO Printed 1 (state.change.logger)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2014-03-31 12:50:54,219&amp;#93;&lt;/span&gt; DEBUG DEBUG Printed 2 (state.change.logger)&lt;br/&gt;
Final Count 2&lt;/p&gt;&lt;/blockquote&gt;</comment>
                            <comment id="13955694" author="tnachen" created="Mon, 31 Mar 2014 20:45:41 +0000"  >&lt;p&gt;Ah got it, just learned that Scala has a call-by-name / call-by-value difference, and our logging uses call-by-name. &lt;br/&gt;
You&apos;re right the format won&apos;t be evaluated with our trait.&lt;/p&gt;</comment>
                            <comment id="13955744" author="jjkoshy" created="Mon, 31 Mar 2014 21:33:32 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; I&apos;m not sure I follow your question. I meant that since we use the logger API directly for state-change.log, we need to check if (stateChangeLogger.is*Enabled).&lt;/p&gt;

&lt;p&gt;Also, are you sure you recompiled your test - the final count at the INFO level should be 3. (I tried that locally as well.)&lt;/p&gt;</comment>
                            <comment id="13955761" author="guozhang" created="Mon, 31 Mar 2014 21:47:36 +0000"  >&lt;p&gt;Hi Joel,&lt;/p&gt;

&lt;p&gt;I think we are on the same page as for your first question, if we use getLogger(), the logger API itself will always evaluate the string.format; but as long as we use the Logging as Neha&apos;s patch did, it will call-by-name and hence effectively do lazy evaluation.&lt;/p&gt;

&lt;p&gt;For the second question, since my test code reset count to 0, it would either be 1 or 2 for any cases, right?&lt;/p&gt;</comment>
                            <comment id="13955815" author="jjkoshy" created="Mon, 31 Mar 2014 22:27:31 +0000"  >&lt;p&gt;Ack yes - I missed the reset.&lt;/p&gt;</comment>
                            <comment id="13956125" author="nehanarkhede" created="Tue, 1 Apr 2014 05:29:41 +0000"  >&lt;p&gt;Thanks for the reviews. Committed to 0.8.1 and trunk&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                                                <inwardlinks description="is depended upon by">
                                        <issuelink>
            <issuekey id="12707583">KAFKA-1380</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12637693" name="KAFKA-1350.patch" size="9042" author="nehanarkhede" created="Sun, 30 Mar 2014 06:22:10 +0000"/>
                            <attachment id="12637694" name="KAFKA-1350_2014-03-29_23:28:07.patch" size="11213" author="nehanarkhede" created="Sun, 30 Mar 2014 06:28:13 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>382728</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 34 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1txr3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>382996</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>