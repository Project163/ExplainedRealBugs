<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:41:34 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-1670] Corrupt log files for segment.bytes values close to Int.MaxInt</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-1670</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;The maximum value for the topic-level config &lt;tt&gt;segment.bytes&lt;/tt&gt; is &lt;tt&gt;Int.MaxInt&lt;/tt&gt; (2147483647). &lt;b&gt;Using this value causes brokers to corrupt their log files, leaving them unreadable.&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;We set &lt;tt&gt;segment.bytes&lt;/tt&gt; to &lt;tt&gt;2122317824&lt;/tt&gt; which is well below the maximum. One by one, the ISR of all partitions shrunk to 1. Brokers would crash when restarted, attempting to read from a negative offset in a log file. After discovering that many segment files had grown to 4GB or more, we were forced to shut down our &lt;b&gt;entire production Kafka cluster&lt;/b&gt; for several hours while we split all segment files into 1GB chunks.&lt;/p&gt;

&lt;p&gt;Looking into the &lt;tt&gt;kafka.log&lt;/tt&gt; code, the &lt;tt&gt;segment.bytes&lt;/tt&gt; parameter is used inconsistently. It is treated as a &lt;b&gt;soft&lt;/b&gt; maximum for the size of the segment file (&lt;a href=&quot;https://github.com/apache/kafka/blob/0.8.1.1/core/src/main/scala/kafka/log/LogConfig.scala#L26&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/0.8.1.1/core/src/main/scala/kafka/log/LogConfig.scala#L26&lt;/a&gt;) with logs rolled only after (&lt;a href=&quot;https://github.com/apache/kafka/blob/0.8.1.1/core/src/main/scala/kafka/log/Log.scala#L246&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/0.8.1.1/core/src/main/scala/kafka/log/Log.scala#L246&lt;/a&gt;) they exceed this value. However, much of the code that deals with log files uses &lt;b&gt;ints&lt;/b&gt; to store the size of the file and the position in the file. Overflow of these ints leads the broker to append to the segments indefinitely, and to fail to read these segments for consuming or recovery.&lt;/p&gt;

&lt;p&gt;This is trivial to reproduce:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;$ bin/kafka-topics.sh --topic segment-bytes-test --create --replication-factor 2 --partitions 1 --zookeeper zkhost:2181
$ bin/kafka-topics.sh --topic segment-bytes-test --alter --config segment.bytes=2147483647 --zookeeper zkhost:2181
$ yes &lt;span class=&quot;code-quote&quot;&gt;&quot;Int.MaxValue is a ridiculous bound on file size in 2014&quot;&lt;/span&gt; | bin/kafka-console-producer.sh --broker-list localhost:6667 zkhost:2181 --topic segment-bytes-test
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;After running for a few minutes, the log file is corrupt:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;$ ls -lh data/segment-bytes-test-0/
total 9.7G
-rw-r--r-- 1 root root  10M Oct  3 19:39 00000000000000000000.index
-rw-r--r-- 1 root root 9.7G Oct  3 19:39 00000000000000000000.log
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We recovered the data from the log files using a simple Python script: &lt;a href=&quot;https://gist.github.com/also/9f823d9eb9dc0a410796&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gist.github.com/also/9f823d9eb9dc0a410796&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12745831">KAFKA-1670</key>
            <summary>Corrupt log files for segment.bytes values close to Int.MaxInt</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sriharsha">Harsha</assignee>
                                    <reporter username="rberdeen">Ryan Berdeen</reporter>
                        <labels>
                    </labels>
                <created>Fri, 3 Oct 2014 21:06:35 +0000</created>
                <updated>Mon, 13 Oct 2014 16:37:24 +0000</updated>
                            <resolved>Sun, 12 Oct 2014 15:54:06 +0000</resolved>
                                    <version>0.8.1.1</version>
                                    <fixVersion>0.8.2.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="14159309" author="sriharsha" created="Sat, 4 Oct 2014 22:28:06 +0000"  >&lt;p&gt;Created reviewboard &lt;a href=&quot;https://reviews.apache.org/r/26346/diff/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/26346/diff/&lt;/a&gt;&lt;br/&gt;
 against branch origin/trunk&lt;/p&gt;</comment>
                            <comment id="14159312" author="sriharsha" created="Sat, 4 Oct 2014 22:32:52 +0000"  >&lt;p&gt;This is caused by maybeRoll  not checking for any boundary conditions for Int overflow. &lt;/p&gt;</comment>
                            <comment id="14159407" author="sriharsha" created="Sun, 5 Oct 2014 03:17:59 +0000"  >&lt;p&gt;Updated reviewboard &lt;a href=&quot;https://reviews.apache.org/r/26346/diff/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/26346/diff/&lt;/a&gt;&lt;br/&gt;
 against branch origin/trunk&lt;/p&gt;</comment>
                            <comment id="14159411" author="sriharsha" created="Sun, 5 Oct 2014 03:23:45 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nehanarkhede&quot; class=&quot;user-hover&quot; rel=&quot;nehanarkhede&quot;&gt;nehanarkhede&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=junrao&quot; class=&quot;user-hover&quot; rel=&quot;junrao&quot;&gt;junrao&lt;/a&gt; LogConfig default values doesn&apos;t match broker configuration defaults here &lt;a href=&quot;https://kafka.apache.org/08/configuration.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://kafka.apache.org/08/configuration.html&lt;/a&gt;&lt;br/&gt;
example&lt;br/&gt;
  SegmentSize = 1024 * 1024 (LogConfig)  and in broker log.segment.bytes	1024 * 1024 * 1024&lt;br/&gt;
and also MaxIndexSize&lt;br/&gt;
any reason for them not to be same ?&lt;/p&gt;</comment>
                            <comment id="14159749" author="junrao" created="Sun, 5 Oct 2014 23:37:46 +0000"  >&lt;p&gt;The default value in LogConfig is just for unit test (so some smaller values may make sense). In the full logic, we always pick the broker level value as the default.&lt;/p&gt;</comment>
                            <comment id="14160484" author="sriharsha" created="Mon, 6 Oct 2014 16:48:32 +0000"  >&lt;p&gt;Updated reviewboard &lt;a href=&quot;https://reviews.apache.org/r/26346/diff/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/26346/diff/&lt;/a&gt;&lt;br/&gt;
 against branch origin/trunk&lt;/p&gt;</comment>
                            <comment id="14161167" author="gwenshap" created="Mon, 6 Oct 2014 22:55:33 +0000"  >&lt;p&gt;I think we&apos;ll want to change the segment size variable to &quot;long&quot; and remove the 4GB limit (which seems rather low for modern systems).&lt;br/&gt;
This may make sense as a separate Jira since &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=harsha_ch&quot; class=&quot;user-hover&quot; rel=&quot;harsha_ch&quot;&gt;harsha_ch&lt;/a&gt; patch is necessary in any case.&lt;/p&gt;</comment>
                            <comment id="14161185" author="jkreps" created="Mon, 6 Oct 2014 23:11:14 +0000"  >&lt;p&gt;Actually the reason for limiting the segments to 4GB (or possibly 2GB since we are using java ints) is to keep the index pointers into the file limited to 4 bytes which keeps the index files small (4 byte relative offset and 4 byte file position). Index file size and density is important since we hope to keep those cached to make lookups cheap. We should fix the variable to avoid overflow and even extend to unsigned ints but we probably can&apos;t allow arbitrarily large segment files very easily.&lt;/p&gt;

&lt;p&gt;The reasoning at the time was basically that there is no particular reason to want very large segment files, and since we always do recovery from the beginning of the file having 10GB segments would cause other problems when you crashed and had to do recovery on hundreds of 10GB files.&lt;/p&gt;</comment>
                            <comment id="14161207" author="gwenshap" created="Mon, 6 Oct 2014 23:26:57 +0000"  >&lt;p&gt;Makes sense. Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jkreps&quot; class=&quot;user-hover&quot; rel=&quot;jkreps&quot;&gt;jkreps&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14162486" author="sriharsha" created="Tue, 7 Oct 2014 20:39:22 +0000"  >&lt;p&gt;Updated reviewboard &lt;a href=&quot;https://reviews.apache.org/r/26346/diff/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/26346/diff/&lt;/a&gt;&lt;br/&gt;
 against branch origin/trunk&lt;/p&gt;</comment>
                            <comment id="14162507" author="sriharsha" created="Tue, 7 Oct 2014 20:49:19 +0000"  >&lt;p&gt;Updated reviewboard &lt;a href=&quot;https://reviews.apache.org/r/26346/diff/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/26346/diff/&lt;/a&gt;&lt;br/&gt;
 against branch origin/trunk&lt;/p&gt;</comment>
                            <comment id="14162918" author="sriharsha" created="Wed, 8 Oct 2014 01:39:43 +0000"  >&lt;p&gt;Updated reviewboard &lt;a href=&quot;https://reviews.apache.org/r/26346/diff/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/26346/diff/&lt;/a&gt;&lt;br/&gt;
 against branch origin/trunk&lt;/p&gt;</comment>
                            <comment id="14165189" author="sriharsha" created="Thu, 9 Oct 2014 14:44:24 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=junrao&quot; class=&quot;user-hover&quot; rel=&quot;junrao&quot;&gt;junrao&lt;/a&gt; I updated the patch with ErrorMapping and client errors change. Can you please take a look when you get a chance. Thanks.&lt;/p&gt;</comment>
                            <comment id="14165228" author="junrao" created="Thu, 9 Oct 2014 15:09:06 +0000"  >&lt;p&gt;Thanks for the latest patch. +1. Committed to both 0.8.2 and trunk.&lt;/p&gt;</comment>
                            <comment id="14167219" author="guozhang" created="Fri, 10 Oct 2014 18:02:04 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sriharsha&quot; class=&quot;user-hover&quot; rel=&quot;sriharsha&quot;&gt;sriharsha&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=junrao&quot; class=&quot;user-hover&quot; rel=&quot;junrao&quot;&gt;junrao&lt;/a&gt; this patch causes some regression errors on system tests, including replication / mirror maker test suites (you can try reproduce it with 5001/2/3 easily).&lt;/p&gt;

&lt;p&gt;The log entries I saw from the producer:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;[2014-10-10 05:32:46,714] ERROR Error when sending message to topic test_1 with key: 1 bytes, value: 500 bytes with error: The request included message batch larger than the configured segment size on the server. (org.apache.kafka.client
s.producer.internals.ErrorLoggingCallback)
[2014-10-10 05:32:46,714] ERROR Error when sending message to topic test_1 with key: 1 bytes, value: 500 bytes with error: The request included message batch larger than the configured segment size on the server. (org.apache.kafka.client
s.producer.internals.ErrorLoggingCallback)
[2014-10-10 05:32:46,714] ERROR Error when sending message to topic test_1 with key: 1 bytes, value: 500 bytes with error: The request included message batch larger than the configured segment size on the server. (org.apache.kafka.client
s.producer.internals.ErrorLoggingCallback)
[2014-10-10 05:32:46,714] ERROR Error when sending message to topic test_1 with key: 1 bytes, value: 500 bytes with error: The request included message batch larger than the configured segment size on the server. (org.apache.kafka.client
s.producer.internals.ErrorLoggingCallback)
[2014-10-10 05:32:46,714] ERROR Error when sending message to topic test_1 with key: 1 bytes, value: 500 bytes with error: The request included message batch larger than the configured segment size on the server. (org.apache.kafka.client
s.producer.internals.ErrorLoggingCallback)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14167223" author="sriharsha" created="Fri, 10 Oct 2014 18:04:01 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; Sorry will fix those.&lt;/p&gt;</comment>
                            <comment id="14167422" author="guozhang" created="Fri, 10 Oct 2014 20:05:54 +0000"  >&lt;p&gt;No worries &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; Let me know if you need more information from me.&lt;/p&gt;</comment>
                            <comment id="14168305" author="sriharsha" created="Sat, 11 Oct 2014 19:20:47 +0000"  >&lt;p&gt;Created reviewboard &lt;a href=&quot;https://reviews.apache.org/r/26606/diff/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/26606/diff/&lt;/a&gt;&lt;br/&gt;
 against branch origin/trunk&lt;/p&gt;</comment>
                            <comment id="14168308" author="sriharsha" created="Sat, 11 Oct 2014 19:29:32 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; log.segment.bytes on systems is set to 10240 and producer&apos;s message batch size bigger than that causing the failures.&lt;br/&gt;
changed the configs to 20580. ran systems tests&lt;br/&gt;
========================================================&lt;br/&gt;
Total failures count : 0&lt;br/&gt;
========================================================&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=junrao&quot; class=&quot;user-hover&quot; rel=&quot;junrao&quot;&gt;junrao&lt;/a&gt; rethinking a bit , should we enforce producer&apos;s message batch size  less than config segment.size? &lt;br/&gt;
instead on Log side if the current message batch size is greater than config segment.size broker should push as many messages  can fit into the current segment and roll the log for the rest of messages in the batch. &lt;/p&gt;</comment>
                            <comment id="14168689" author="junrao" created="Sun, 12 Oct 2014 15:54:06 +0000"  >&lt;p&gt;Thanks for the followup patch for system tests. +1 and committed to trunk and 0.8.2.&lt;/p&gt;

&lt;p&gt;Yes, it&apos;s possible for the broker to break the message set into smaller chunks that fit in the configured log segment size. However, there may be some benefit to keep the original message set as a whole. For example, if the message set is compressed, this guarantees that either all or none of the messages in the set are replicated to the followers.&lt;/p&gt;</comment>
                            <comment id="14169493" author="guozhang" created="Mon, 13 Oct 2014 16:37:24 +0000"  >&lt;p&gt;Verified that system test has recovered, thanks!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12674372" name="KAFKA-1670.patch" size="81638" author="sriharsha" created="Sat, 11 Oct 2014 19:20:47 +0000"/>
                            <attachment id="12672956" name="KAFKA-1670.patch" size="1637" author="sriharsha" created="Sat, 4 Oct 2014 22:28:06 +0000"/>
                            <attachment id="12672966" name="KAFKA-1670_2014-10-04_20:17:46.patch" size="3997" author="sriharsha" created="Sun, 5 Oct 2014 03:17:58 +0000"/>
                            <attachment id="12673118" name="KAFKA-1670_2014-10-06_09:48:25.patch" size="3567" author="sriharsha" created="Mon, 6 Oct 2014 16:48:32 +0000"/>
                            <attachment id="12673417" name="KAFKA-1670_2014-10-07_13:39:13.patch" size="15887" author="sriharsha" created="Tue, 7 Oct 2014 20:39:22 +0000"/>
                            <attachment id="12673423" name="KAFKA-1670_2014-10-07_13:49:10.patch" size="17807" author="sriharsha" created="Tue, 7 Oct 2014 20:49:19 +0000"/>
                            <attachment id="12673501" name="KAFKA-1670_2014-10-07_18:39:31.patch" size="22941" author="sriharsha" created="Wed, 8 Oct 2014 01:39:43 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>7.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 6 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i20sc7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>junrao</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>