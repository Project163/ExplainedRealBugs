<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:29:38 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-13636] Committed offsets could be deleted during a rebalance if a group did not commit for a while</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-13636</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;The group coordinator might delete invalid offsets during a group rebalance. During a rebalance, the coordinator is relying on the last commit timestamp (&lt;em&gt;offsetAndMetadata.commitTimestamp&lt;/em&gt;) instead of the last state modification &lt;em&gt;timestamp (currentStateTimestamp&lt;/em&gt;) to detect expired offsets.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;This is relatively easy to reproduce by playing with group.initial.rebalance.delay.ms, offset.retention.minutes and offset.check.retention.interval, I uploaded an example on: &lt;a href=&quot;https://github.com/Dabz/kafka-example/tree/master/docker/offsets-retention&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/Dabz/kafka-example/tree/master/docker/offsets-retention&lt;/a&gt; .&lt;/p&gt;

&lt;p&gt;This script does:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Start a broker with: offset.retention.minute=2, o&lt;a href=&quot;http://offset.check.retention.interval.ms/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;ffset.check.retention.interval.ms=&lt;/a&gt;1000,&#160; group.initial.rebalance.delay=20000&lt;/li&gt;
	&lt;li&gt;Produced 10 messages&lt;/li&gt;
	&lt;li&gt;Create a consumer group to consume 10 messages, and disable auto.commit to only commit a few times&lt;/li&gt;
	&lt;li&gt;Wait 3 minutes, then the Consumer get a &lt;tt&gt;kill -9&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;Restart the consumer after a few seconds&lt;/li&gt;
	&lt;li&gt;The consumer restart from&#160;&lt;tt&gt;auto.offset.reset&lt;/tt&gt;&#160;, the offset got removed&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The cause is due to the GroupMetadata.scala:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;When the group get emptied, the&#160;&lt;tt&gt;subscribedTopics&lt;/tt&gt;&#160;is set to&#160;&lt;tt&gt;Set.empty&lt;/tt&gt;&#160;(&lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/core/src/main/scala/kafka/coordinator/group/GroupMetadata.scala#L520-L521&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/trunk/core/src/main/scala/kafka/coordinator/group/GroupMetadata.scala#L520-L521&lt;/a&gt;)&lt;/li&gt;
	&lt;li&gt;When the new member joins, we add the new member right away in the group ; BUT the&#160;&lt;tt&gt;subscribedTopics&lt;/tt&gt;&#160;is only updated once the migration is over (in the initNewGeneration) (which could take a while due to the &lt;tt&gt;group.initial.rebalance.delay&lt;/tt&gt;)&lt;/li&gt;
	&lt;li&gt;When the log cleaner got executed,&#160;&#160;&lt;tt&gt;subscribedTopics.isDefined&lt;/tt&gt;&#160;returns true as&#160;&lt;tt&gt;Set.empty != None&lt;/tt&gt;&#160;(the underlying condition)&lt;/li&gt;
	&lt;li&gt;Thus we enter&#160;&lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/core/src/main/scala/kafka/coordinator/group/GroupMetadata.scala#L782-L785&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/trunk/core/src/main/scala/kafka/coordinator/group/GroupMetadata.scala#L782-L785&lt;/a&gt;&#160;with an empty&#160;&lt;tt&gt;subscribedTopics&lt;/tt&gt;&#160;list and we are relying on the&#160;&lt;tt&gt;commitTimestamp&lt;/tt&gt;&#160;regardless of the&#160;&lt;tt&gt;currentStateTimestamp&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;This seem to be a regression generated by KIP-496 &lt;a href=&quot;https://cwiki.apache.org/confluence/display/KAFKA/KIP-496%3A+Administrative+API+to+delete+consumer+offsets#KIP496:AdministrativeAPItodeleteconsumeroffsets-ProposedChanges&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://cwiki.apache.org/confluence/display/KAFKA/KIP-496%3A+Administrative+API+to+delete+consumer+offsets#KIP496:AdministrativeAPItodeleteconsumeroffsets-ProposedChanges&lt;/a&gt; (&lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-8338&quot; title=&quot;Improve consumer offset expiration logic to take subscription into account&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-8338&quot;&gt;&lt;del&gt;KAFKA-8338&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-8370&quot; title=&quot;Kafka Connect should check for existence of internal topics before attempting to create them&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-8370&quot;&gt;&lt;del&gt;KAFKA-8370&lt;/del&gt;&lt;/a&gt;)&lt;/p&gt;</description>
                <environment></environment>
        <key id="13426047">KAFKA-13636</key>
            <summary>Committed offsets could be deleted during a rebalance if a group did not commit for a while</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="princem">Prince Mahajan</assignee>
                                    <reporter username="Dabz">Damien Gasparina</reporter>
                        <labels>
                    </labels>
                <created>Tue, 1 Feb 2022 19:36:05 +0000</created>
                <updated>Fri, 12 Apr 2024 08:00:58 +0000</updated>
                            <resolved>Thu, 10 Feb 2022 16:38:21 +0000</resolved>
                                    <version>2.4.0</version>
                    <version>2.5.1</version>
                    <version>2.6.2</version>
                    <version>2.7.2</version>
                    <version>2.8.1</version>
                    <version>3.0.0</version>
                                    <fixVersion>2.8.2</fixVersion>
                    <fixVersion>3.0.1</fixVersion>
                    <fixVersion>3.1.1</fixVersion>
                    <fixVersion>3.2.0</fixVersion>
                                    <component>core</component>
                    <component>offset manager</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="17836455" author="zhangzs" created="Fri, 12 Apr 2024 08:00:58 +0000"  >&lt;p&gt;Kafka broker version is 2.7.2&lt;br/&gt;
Client version is 2.5.2.&lt;br/&gt;
auto.offset.reset&#160; is earliest&lt;/p&gt;

&lt;p&gt;there have been instances where offset messages were deleted on the consumer side.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// code placeholder
&lt;/span&gt;org.apache.kafka.clients.consumer.internals.SubscriptionState SubscriptionState.java:397 [trace=,span=] - [Consumer clientId=app1_a2acc55fc0bbac81, groupId=gid-app1] Resetting offset &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition topic-4 to offset 3577938321.
 &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13232307">KAFKA-8338</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13247753">KAFKA-8730</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 30 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0z5ug:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>dajac</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>