<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:18:20 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-8304] Connect susceptible to deadlock while registering REST extensions</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-8304</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;As part of &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7503&quot; title=&quot;Integration Test Framework for Connect&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7503&quot;&gt;&lt;del&gt;KAFKA-7503&lt;/del&gt;&lt;/a&gt;, the &lt;tt&gt;ConnectClusterStateImpl&lt;/tt&gt; class was altered to use a &lt;tt&gt;HerderProvider&lt;/tt&gt; instance instead of a &lt;tt&gt;Herder&lt;/tt&gt;. However, the&#160;Connect&#160;&lt;tt&gt;RestServer&lt;/tt&gt; registers REST extensions before a herder is given to that &lt;tt&gt;HerderProvider&lt;/tt&gt;, so any extensions that invoke, e.g., &lt;tt&gt;ConnectClusterState.connector()&lt;/tt&gt; in their &lt;tt&gt;register(...)&lt;/tt&gt; method end up in a deadlock that eventually causes Connect startup to fail with the error message &quot;Timed out waiting for herder to be initialized.&quot;&lt;/p&gt;

&lt;p&gt;If possible, the &lt;tt&gt;HerderProvider&lt;/tt&gt; used for &lt;tt&gt;ConnectClusterStateImpl&lt;/tt&gt; instances given to REST extensions should be supplied with a &lt;tt&gt;Herder&lt;/tt&gt; before those extensions are registered. If that isn&apos;t feasible, another option could be to install Connect REST extensions on a separate thread so that they don&apos;t block the Connect startup process and eventual call of &lt;tt&gt;HerderProvider.setHerder(...)&lt;/tt&gt;.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13230738">KAFKA-8304</key>
            <summary>Connect susceptible to deadlock while registering REST extensions</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ChrisEgerton">Chris Egerton</assignee>
                                    <reporter username="ChrisEgerton">Chris Egerton</reporter>
                        <labels>
                    </labels>
                <created>Mon, 29 Apr 2019 17:18:11 +0000</created>
                <updated>Tue, 7 May 2019 22:53:41 +0000</updated>
                            <resolved>Tue, 7 May 2019 22:53:41 +0000</resolved>
                                    <version>2.0.2</version>
                    <version>2.1.1</version>
                    <version>2.1.2</version>
                    <version>2.2.0</version>
                    <version>2.2.1</version>
                    <version>2.3.0</version>
                                    <fixVersion>2.0.2</fixVersion>
                    <fixVersion>2.1.2</fixVersion>
                    <fixVersion>2.2.1</fixVersion>
                    <fixVersion>2.3.0</fixVersion>
                                    <component>connect</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="16829648" author="chrisegerton" created="Mon, 29 Apr 2019 19:33:14 +0000"  >&lt;p&gt;Looks like performing REST extension initialization in a separate thread is not the right approach. If an extension aims to restrict the REST API for security reasons, it&apos;s possible that a blocking call to &lt;tt&gt;ConnectClusterState.connectors()&lt;/tt&gt; would prevent the extension from registering any relevant filters between the time that the REST server starts and when the CLI (standalone or distributed) invokes &lt;tt&gt;HerderProvider.setHerder(...)&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;It also appears that, due to the nature of the code changes to support the new integration testing harness, providing a &lt;tt&gt;Herder&lt;/tt&gt; instance to &lt;tt&gt;ConnectClusterStateImpl&lt;/tt&gt; instances before they&apos;re passed to REST may not be possible at all, or at least not without considerable refactoring.&lt;/p&gt;</comment>
                            <comment id="16829849" author="githubbot" created="Tue, 30 Apr 2019 00:17:17 +0000"  >&lt;p&gt;C0urante commented on pull request #6651: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-8304&quot; title=&quot;Connect susceptible to deadlock while registering REST extensions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-8304&quot;&gt;&lt;del&gt;KAFKA-8304&lt;/del&gt;&lt;/a&gt;: Fix registration of Connect REST extensions&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/6651&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/6651&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   &lt;span class=&quot;error&quot;&gt;&amp;#91;Jira&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-8304&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-8304&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;   Currently, a REST extension can cause deadlock if it requests the list of connectors from its `ConnectRestExtensionContext.clusterState()` in its `ConnectRestExtension.register(...)` method. This is because the `ConnectClusterState` implementation is backed by a `HerderProvider` that, at that time, has no associated `Herder` instance, and since that `Herder` is given to the `HerderProvider` later by the same thread, deadlock occurs until the call to `HerderProvider.get()` made by the `ConnectClusterStateImpl` times out. At this point, startup fails and the Connect worker dies.&lt;/p&gt;

&lt;p&gt;   The changes here separate `RestServer.start(...)` into two separate methods. The first, `RestServer.initializeServer()`, starts the Jetty server and binds to a port, which ensure the accuracy of the `RestServer.advertisedUrl()` method that is used later on by both the `ConnectStandalone` and `ConnectDistributed` classes to determine the worker ID. The second, `RestServer.start(Herder herder, Plugins plugins)` actually creates the Connect REST resources (`RootResource`, `ConnectorsResource`, etc.) and registers all REST extensions.&lt;/p&gt;

&lt;p&gt;   Since these changes make `HerderProvider` obsolete and it is not part of any public API, that interface is also removed.&lt;/p&gt;

&lt;p&gt;   This approach ensures that the Connect REST interface is started only when all of its REST extensions have been successfully registered, which is important for security use cases where request filters are installed and parts of the Connect REST API are subject to authentication/authorization.&lt;/p&gt;

&lt;p&gt;   Between the call to `RestServer.intializeServer()` and `RestServer.start(...)`, any requests made to the worker will result in a 404 response. This is slightly less desirable than the current behavior, which is to block on requests until the herder is up and running, but shouldn&apos;t be too much of an issue.&lt;/p&gt;

&lt;p&gt;   A new integration test is added that verifies that a call to `ConnectRestExtensionContext.clusterState().connectors()` succeeds. This test fails on the current `trunk` branch, and succeeds with the changes involved in this PR.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16835159" author="githubbot" created="Tue, 7 May 2019 22:20:58 +0000"  >&lt;p&gt;rhauch commented on pull request #6651: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-8304&quot; title=&quot;Connect susceptible to deadlock while registering REST extensions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-8304&quot;&gt;&lt;del&gt;KAFKA-8304&lt;/del&gt;&lt;/a&gt;: Fix registration of Connect REST extensions&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/6651&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/6651&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16835178" author="rhauch" created="Tue, 7 May 2019 22:53:41 +0000"  >&lt;p&gt;Merged onto `trunk`, and backported to `2.2`, `2.1`, and `2.0`.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 27 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z028vc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>