<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:39:46 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-1238] New producer hangs in a loop detecting metadata for auto created topics</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-1238</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;New producer hangs in a loop detecting metadata for auto created topics -&lt;/p&gt;

&lt;p&gt;java.lang.IllegalStateException: No known nodes.&lt;br/&gt;
	at kafka.common.Cluster.nextNode(Cluster.java:97)&lt;br/&gt;
	at kafka.clients.producer.internals.Sender.maybeMetadataRequest(Sender.java:154)&lt;br/&gt;
	at kafka.clients.producer.internals.Sender.run(Sender.java:120)&lt;br/&gt;
	at kafka.clients.producer.internals.Sender.run(Sender.java:84)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:695)&lt;br/&gt;
java.lang.IllegalStateException: No known nodes.&lt;br/&gt;
	at kafka.common.Cluster.nextNode(Cluster.java:97)&lt;br/&gt;
	at kafka.clients.producer.internals.Sender.maybeMetadataRequest(Sender.java:154)&lt;br/&gt;
	at kafka.clients.producer.internals.Sender.run(Sender.java:120)&lt;br/&gt;
	at kafka.clients.producer.internals.Sender.run(Sender.java:84)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:695)&lt;br/&gt;
java.lang.IllegalStateException: No known nodes.&lt;br/&gt;
	at kafka.common.Cluster.nextNode(Cluster.java:97)&lt;br/&gt;
	at kafka.clients.producer.internals.Sender.maybeMetadataRequest(Sender.java:154)&lt;br/&gt;
	at kafka.clients.producer.internals.Sender.run(Sender.java:120)&lt;br/&gt;
	at kafka.clients.producer.internals.Sender.run(Sender.java:84)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:695)&lt;br/&gt;
java.lang.IllegalStateException: No known nodes.&lt;br/&gt;
	at kafka.common.Cluster.nextNode(Cluster.java:97)&lt;br/&gt;
	at kafka.clients.producer.internals.Sender.maybeMetadataRequest(Sender.java:154)&lt;br/&gt;
	at kafka.clients.producer.internals.Sender.run(Sender.java:120)&lt;br/&gt;
	at kafka.clients.producer.internals.Sender.run(Sender.java:84)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:695)&lt;br/&gt;
java.lang.IllegalStateException: No known nodes.&lt;br/&gt;
	at kafka.common.Cluster.nextNode(Cluster.java:97)&lt;br/&gt;
	at kafka.clients.producer.internals.Sender.maybeMetadataRequest(Sender.java:154)&lt;br/&gt;
	at kafka.clients.producer.internals.Sender.run(Sender.java:120)&lt;br/&gt;
	at kafka.clients.producer.internals.Sender.run(Sender.java:84)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:695)&lt;br/&gt;
java.lang.IllegalStateException: No known nodes.&lt;br/&gt;
	at kafka.common.Cluster.nextNode(Cluster.java:97)&lt;br/&gt;
	at kafka.clients.producer.internals.Sender.maybeMetadataRequest(Sender.java:154)&lt;br/&gt;
	at kafka.clients.producer.internals.Sender.run(Sender.java:120)&lt;br/&gt;
	at kafka.clients.producer.internals.Sender.run(Sender.java:84)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:695)&lt;/p&gt;

&lt;p&gt;The producer needs to be restarted to start sending data to the auto created topic&lt;/p&gt;</description>
                <environment></environment>
        <key id="12692756">KAFKA-1238</key>
            <summary>New producer hangs in a loop detecting metadata for auto created topics</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jkreps">Jay Kreps</assignee>
                                    <reporter username="nehanarkhede">Neha Narkhede</reporter>
                        <labels>
                    </labels>
                <created>Mon, 3 Feb 2014 00:10:05 +0000</created>
                <updated>Tue, 22 Jul 2014 14:38:39 +0000</updated>
                            <resolved>Tue, 11 Feb 2014 05:01:28 +0000</resolved>
                                                    <fixVersion>0.8.2.0</fixVersion>
                                    <component>producer </component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="13889717" author="jkreps" created="Mon, 3 Feb 2014 18:28:46 +0000"  >&lt;p&gt;Fix attached.&lt;/p&gt;</comment>
                            <comment id="13889759" author="nehanarkhede" created="Mon, 3 Feb 2014 19:05:31 +0000"  >&lt;p&gt;Thanks for the patch, Jay! &lt;/p&gt;

&lt;p&gt;Review comments-&lt;/p&gt;

&lt;p&gt;        // the server can give back an empty metadata response &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/warning.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; if the topic doesn&apos;t exist and that is our only&lt;br/&gt;
        // topic, don&apos;t use that&lt;/p&gt;

&lt;p&gt;The comment is a bit misleading. The server returns the LeaderNotAvailable error code in the response. The handleMetadataResponse doesn&apos;t seem to check for error codes and retry based on that. But retries based on cluster.nodes().size() &amp;gt; 0? &lt;/p&gt;</comment>
                            <comment id="13890274" author="jkreps" created="Tue, 4 Feb 2014 01:54:05 +0000"  >&lt;p&gt;Ack, this is clearly the wrong fix, I was misinterpreting the response. Right one is to check the error code as you say. That will require some refactoring.&lt;/p&gt;</comment>
                            <comment id="13894750" author="jkreps" created="Fri, 7 Feb 2014 17:24:52 +0000"  >&lt;p&gt;Here is an updated patch that has the safety check but also breaks the metadata parsing into a separate class to retain errors. This refactoring didn&apos;t end up being strictly necessary but is still good.&lt;/p&gt;</comment>
                            <comment id="13894766" author="nehanarkhede" created="Fri, 7 Feb 2014 17:48:51 +0000"  >&lt;p&gt;Thanks for the patch. Few review comments&lt;/p&gt;

&lt;p&gt;1. Using review board saves review time. Please can we use it &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
2. Sender.handleMetadataResponse&lt;br/&gt;
I&apos;m not sure if I understand how the metadata retry happens based on error codes in the metadata response. Also, the comment here is confusing. We do return the list of all brokers even if the topic is being auto created. During auto creation, we create the topic and return the LeaderNotAvailable error code back. In this case, we should retry getting topic metadata, similar to when any error code is received in the response&lt;br/&gt;
3. MetadataResponse&lt;br/&gt;
Is there a way to define the fields in a central place instead of hardcoding it in 2 places - one where the fields are defined (Protocol) and the other where those will be parsed?&lt;/p&gt;</comment>
                            <comment id="13894858" author="jkreps" created="Fri, 7 Feb 2014 18:59:23 +0000"  >&lt;p&gt;1. Yeah I have been but due to git accident this ended up on the wrong branch so the tool doesn&apos;t work. I figured this was a pretty trivial one.&lt;br/&gt;
2. Actually after considering it I think the error code is irrelevant. The logic is &quot;always update the cluster metadata unless doing so would remove all known nodes&quot;. For any topic we don&apos;t get metadata retry will occur automatically after the backoff. This makes sense as the set of topics may contain multiple new topics, some of these may have metadata and some may not (because creation is in process). So the correct logic is to update with whatever you get, but in the special case where there are no brokers don&apos;t update.&lt;br/&gt;
3. I would rather have the name be the contract rather than a variable. My rationale is that if we define 300 static variables in the protocol definition it becomes very hard to read (and obviously the protocol can&apos;t refer to the request object).&lt;/p&gt;</comment>
                            <comment id="13896113" author="jkreps" created="Sun, 9 Feb 2014 23:52:18 +0000"  >&lt;p&gt;Hey Neha, can you let me know if you agree with my rationale on these?&lt;/p&gt;</comment>
                            <comment id="13896252" author="nehanarkhede" created="Mon, 10 Feb 2014 06:06:42 +0000"  >&lt;p&gt;Regarding #2, I&apos;m not so sure I understood the logic behind updating metadata only where there are no brokers. When do you expect topic metadata to return no brokers? Also, if the metadata request doesn&apos;t have an error code (which means it succeeded for all topics it asked for), then why would we retry? Also, if it failed only for a subset of topics, why not just retry with the subset of topics that failed instead of all topics. And, the bug is still not fixed with the latest patch, still hangs in an infinite loop for a new topic that is auto created. Will go through the code in more detail, as I may be missing something obvious here.&lt;/p&gt;</comment>
                            <comment id="13896775" author="jkreps" created="Mon, 10 Feb 2014 17:22:38 +0000"  >&lt;p&gt;The way metadata works is the following:&lt;br/&gt;
1. When someone requests metadata using Metadata.java that we don&apos;t have we we flag that we need to update metadata.&lt;br/&gt;
2. Once that flag is set the sender will update metadata until the flag is unset. The flag is unset whenever the cluster is updated. There is a metadata fetch backoff to prevent polling too quickly.&lt;br/&gt;
3. The metadata update described in (1) and (2) will repeat until we get metadata for the topic we requested or we time out.&lt;/p&gt;

&lt;p&gt;So if we don&apos;t update the cluster metadata then the metadata request just repeats as soon as the backoff expires.&lt;/p&gt;

&lt;p&gt;So that is why it works. But why is this the right logic? Why don&apos;t we check the error code? The reason is simple, if we ever remove ALL the nodes from the cluster metadata then we lose the ability to continue to update metadata because we update metadata using a random node in our metadata. So if we update our metadata to have no nodes, then we have no one to update metadata with.&lt;/p&gt;

&lt;p&gt;The server&apos;s behavior is that it will always include whatever brokers are referenced by the metadata in the response. So if you give a single topic and that topic doesn&apos;t exist you will get no brokers back and an error code for that topic. But regardless of the reason if the cluster metadata comes back with no brokers we should not use it (the only reason I know this can happen is an error, but it basically doesn&apos;t matter what error and perhaps there are other conditions).&lt;/p&gt;</comment>
                            <comment id="13897346" author="guozhang" created="Tue, 11 Feb 2014 00:40:10 +0000"  >&lt;p&gt;Added a testcase in integration test for auto-created topic and it passed. I think the patch works.&lt;/p&gt;

&lt;p&gt;My understanding is that without the patch we can ran into the deadend where the cluster is updated to have zero brokers, and hence loop indefinitely there. I think longer-term we should probably return all the brokers in the cluster no matter of the TopicMetadataRequest content.&lt;/p&gt;

&lt;p&gt;A few comments besides my non-committer +1 :&lt;/p&gt;

&lt;p&gt;1. The &quot;throw new IllegalStateException(&quot;No known nodes.&quot;);&quot; in nextNode should be fatal since once we got here there would be not way out. Shall we make this exception a special one and force producer to stop?&lt;/p&gt;

&lt;p&gt;2. The re-factoring seems much like the Request Object, if we are going to live with it shall we have a RequestOrResponse interface with toStruct and fromStruct APIs?&lt;/p&gt;

&lt;p&gt;Guozhang&lt;/p&gt;</comment>
                            <comment id="13897361" author="jkreps" created="Tue, 11 Feb 2014 00:46:49 +0000"  >&lt;p&gt;Yeah arguably the server should just return all the brokers. I think the only argument against that was supporting very very large clusters.&lt;/p&gt;

&lt;p&gt;1. I guess I meant that more as a &quot;this should not happen&quot; exception, rather than handle it I kind of just want to proceed with the testing and fix these cases.&lt;/p&gt;

&lt;p&gt;2. Yeah I was going to wait on the outcome of the discussion on request protocol serialization to establish a pattern there. Not many people chimed in on that one.&lt;/p&gt;</comment>
                            <comment id="13897407" author="nehanarkhede" created="Tue, 11 Feb 2014 01:23:27 +0000"  >&lt;p&gt;Got it. Thanks for the explanation. +1&lt;/p&gt;</comment>
                            <comment id="14006392" author="tcollinsworth" created="Thu, 22 May 2014 20:05:10 +0000"  >&lt;p&gt;What release is this expected to be included in? The patch is not applied to 0.8.1.1. Don&apos;t see where any release info is stated on the bug for what it applies to or which it is scheduled.&lt;/p&gt;

&lt;p&gt;I&apos;m trying out 0.8.1.1 and when I try to publish to a new non-existent partition the publisher ends up in a loop logging exceptions. If the test/publisher is stopped and restarted it works fine since it successfully created the partition, but couldn&apos;t detect it until restarted.&lt;/p&gt;

&lt;p&gt;java.lang.IllegalStateException: No known nodes.&lt;br/&gt;
	at org.apache.kafka.common.Cluster.nextNode(Cluster.java:135)&lt;br/&gt;
	at org.apache.kafka.clients.producer.internals.Sender.maybeMetadataRequest(Sender.java:171)&lt;br/&gt;
	at org.apache.kafka.clients.producer.internals.Sender.run(Sender.java:137)&lt;br/&gt;
	at org.apache.kafka.clients.producer.internals.Sender.run(Sender.java:101)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:745)&lt;/p&gt;</comment>
                            <comment id="14006768" author="junrao" created="Fri, 23 May 2014 04:00:28 +0000"  >&lt;p&gt;The new producer is only stable in trunk and we expect to release in the next release 0.8.2.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12627654" name="KAFKA-1238-v1.patch" size="11545" author="jkreps" created="Fri, 7 Feb 2014 17:24:52 +0000"/>
                            <attachment id="12626705" name="KAFKA-1238.patch" size="904" author="jkreps" created="Mon, 3 Feb 2014 18:28:46 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>371351</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 26 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1s007:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>371654</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>