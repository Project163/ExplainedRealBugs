<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:40:28 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-17076] logEndOffset could be lost due to log cleaning</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-17076</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;It&apos;s possible for the log cleaner to remove all records in the suffix of the log. If the partition is then reassigned, the new replica won&apos;t be able to see the true logEndOffset since there is no record batch associated with it. If this replica becomes the leader, it will assign an already used offset to a newly produced record, which is incorrect.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;It&apos;s relatively rare to trigger this issue since the active segment is never cleaned and typically is not empty. However, the following is one possibility.&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;records with offset 100-110 are produced and fully replicated to all ISR. All those records are delete records for certain keys.&lt;/li&gt;
	&lt;li&gt;record with offset 111 is produced. It forces the roll of a new segment in broker b1 and is added to the log. The record is not committed and is later truncated from the log, leaving an empty active segment in this log. b1 at some point becomes the leader.&lt;/li&gt;
	&lt;li&gt;log cleaner kicks in and removes records 100-110.&lt;/li&gt;
	&lt;li&gt;The partition is reassigned to another broker b2. b2 replicates all records from b1 up to offset 100 and marks its logEndOffset at 100. Since there is no record to replicate after offset 100 in b1, b2&apos;s logEndOffset stays at 100 and b2 can join the ISR.&lt;/li&gt;
	&lt;li&gt;b2 becomes the leader and assign offset 100 to a new record.&lt;/li&gt;
&lt;/ol&gt;
</description>
                <environment></environment>
        <key id="13584659">KAFKA-17076</key>
            <summary>logEndOffset could be lost due to log cleaning</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="vincent81jiang">Vincent Jiang</assignee>
                                    <reporter username="junrao">Jun Rao</reporter>
                        <labels>
                    </labels>
                <created>Wed, 3 Jul 2024 18:22:25 +0000</created>
                <updated>Mon, 10 Nov 2025 08:04:08 +0000</updated>
                            <resolved>Wed, 25 Sep 2024 04:21:08 +0000</resolved>
                                                    <fixVersion>3.9.2</fixVersion>
                    <fixVersion>4.0.0</fixVersion>
                                    <component>core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17862868" author="junrao" created="Wed, 3 Jul 2024 18:23:35 +0000"  >&lt;p&gt;One potential solution is to adjust the log cleaning logic such that it always preserves the last batch during each round of cleaning. If all records in the last batch are removed, we can just retain the empty batch to preserve the last offset. The empty batch will then be replicated to all replicas to preserve the true logEndOffset.&lt;/p&gt;</comment>
                            <comment id="17865823" author="ocadaruma" created="Mon, 15 Jul 2024 00:44:57 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=junrao&quot; class=&quot;user-hover&quot; rel=&quot;junrao&quot;&gt;junrao&lt;/a&gt; Is that possible?&lt;/p&gt;

&lt;p&gt;At the step 2 in your scenario, I guess truncation doesn&apos;t happen unless at least one record is returned from Fetch response because of (&lt;a href=&quot;https://github.com/apache/kafka/pull/9382&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/9382&lt;/a&gt;), so empty active segment is not possible in my understanding.&lt;br/&gt;
refs: &lt;a href=&quot;https://cwiki.apache.org/confluence/display/KAFKA/KIP-595%3A+A+Raft+Protocol+for+the+Metadata+Quorum#KIP595:ARaftProtocolfortheMetadataQuorum-Fetch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://cwiki.apache.org/confluence/display/KAFKA/KIP-595%3A+A+Raft+Protocol+for+the+Metadata+Quorum#KIP595:ARaftProtocolfortheMetadataQuorum-Fetch&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17866105" author="ocadaruma" created="Mon, 15 Jul 2024 15:42:49 +0000"  >&lt;p&gt;Also, since lastOffset() always returns original last offset even after the compaction, log end offset of compacted log will not rewind&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/kafka/blob/3.7.1/clients/src/main/java/org/apache/kafka/common/record/RecordBatch.java#L118-L120&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/3.7.1/clients/src/main/java/org/apache/kafka/common/record/RecordBatch.java#L118-L120&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17866122" author="junrao" created="Mon, 15 Jul 2024 16:37:11 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ocadaruma&quot; class=&quot;user-hover&quot; rel=&quot;ocadaruma&quot;&gt;ocadaruma&lt;/a&gt;, thanks for the comment.&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;At the step 2 in your scenario, I guess truncation doesn&apos;t happen unless at least one record is returned from Fetch response because of (https://github.com/apache/kafka/pull/9382), so empty active segment is not possible in my understanding.&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Here is what I am thinking. Suppose that ISR includes b1, b2, b3, and HWM is at 110. b1 is the current leader and takes a new record at offset 111. Record 111 is replicated to b2, but not b3. At this point, leader is changed to b3. After b2 detects the new leader, it needs to remove record 111 since b3&apos;s last record is at 110. If the active segment contains only 111, it will become empty.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Also, since lastOffset() always returns original last offset even after the compaction, log end offset of compacted log will not rewind
https://github.com/apache/kafka/blob/3.7.1/clients/src/main/java/org/apache/kafka/common/record/RecordBatch.java#L118-L120&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;That&apos;s true if the last batch is retained during log cleaning. However, during cleaning, when all records in a batch are removed, the batch could be deleted if the corresponding producer ID is no longer active or there is no producer ID. See &lt;a href=&quot;https://github.com/apache/kafka/blob/3.8/core/src/main/scala/kafka/log/LogCleaner.scala#L758&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/3.8/core/src/main/scala/kafka/log/LogCleaner.scala#L758&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17884496" author="junrao" created="Wed, 25 Sep 2024 04:21:08 +0000"  >&lt;p&gt;Merged the PR to trunk.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 6 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1q56o:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>