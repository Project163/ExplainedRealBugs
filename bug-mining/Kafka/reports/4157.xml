<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:42:41 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-17184] Remote index cache noisy logging</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-17184</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;We have a tiered storage cluster where some consumers are constantly lagging behind. &lt;/p&gt;

&lt;p&gt;On this cluster, we get a ton of error logs and fail fetches with the following symptom: &lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.IllegalStateException: This entry is marked &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; cleanup
	at org.apache.kafka.storage.internals.log.RemoteIndexCache$Entry.lookupOffset(RemoteIndexCache.java:569)
	at org.apache.kafka.storage.internals.log.RemoteIndexCache.lookupOffset(RemoteIndexCache.java:446)
	at kafka.log.remote.RemoteLogManager.lookupPositionForOffset(RemoteLogManager.java:1445)
	at kafka.log.remote.RemoteLogManager.read(RemoteLogManager.java:1391)
	at kafka.log.remote.RemoteLogReader.call(RemoteLogReader.java:62)
	at kafka.log.remote.RemoteLogReader.call(RemoteLogReader.java:31)
	at java.base/java.util.concurrent.FutureTask.run(FutureTask.java:264)
	at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1136)
	at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:635)
	at java.base/java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:840)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I believe this should be handled differently by either&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Set log level to warn or info&lt;/li&gt;
	&lt;li&gt;reload the index entry synchronously when an offset is requested and the entry is marked for cleanup.&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;We do use the default setting for &lt;tt&gt;remote.log.index.file.cache.total.size.bytes&lt;/tt&gt; (1GiB).&lt;/p&gt;


</description>
                <environment></environment>
        <key id="13586628">KAFKA-17184</key>
            <summary>Remote index cache noisy logging</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ckamal">Kamal Chandraprakash</assignee>
                                    <reporter username="fvisconte">Francois Visconte</reporter>
                        <labels>
                    </labels>
                <created>Tue, 23 Jul 2024 08:08:23 +0000</created>
                <updated>Mon, 21 Apr 2025 17:28:18 +0000</updated>
                            <resolved>Fri, 18 Apr 2025 14:49:19 +0000</resolved>
                                                    <fixVersion>4.1.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17926014" author="jeqo" created="Tue, 11 Feb 2025 14:25:09 +0000"  >&lt;p&gt;Interesting edge case. The entry seems to change state between `getIndexEntry` and `lookupPosition` causing this exception.&lt;/p&gt;

&lt;p&gt;I see a couple of options here:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Use a writeLock when deleting: this would ensure the deletion and fetching will happen at separate times. I guess this would be the cleaner option, but writeLock was changed to readLock some time back: &lt;a href=&quot;https://github.com/apache/kafka/pull/14283&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/14283&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;Re-fetch on the `lookupPosition` when entry is marked for cleanup: if marked, then cleanup and fetch again from remote.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=divijvaidya&quot; class=&quot;user-hover&quot; rel=&quot;divijvaidya&quot;&gt;divijvaidya&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kamalcph&quot; class=&quot;user-hover&quot; rel=&quot;kamalcph&quot;&gt;kamalcph&lt;/a&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17933490" author="JIRAUSER307738" created="Sat, 8 Mar 2025 02:02:48 +0000"  >&lt;p&gt;I am assigning this to myself to work on a potential fix if its still an issue.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310460">
                    <name>Child-Issue</name>
                                                                <inwardlinks description="is a child of">
                                        <issuelink>
            <issuekey id="13582462">KAFKA-16947</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13612455">KAFKA-19014</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            35 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1qhbs:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>