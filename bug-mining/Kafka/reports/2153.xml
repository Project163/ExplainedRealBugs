<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:16:57 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-7897] Invalid use of epoch cache with old message format versions</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-7897</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Message format downgrades are not supported, but they generally work as long as broker/clients at least can continue to parse both message formats. After a downgrade, the truncation logic should revert to using the high watermark, but currently we use the existence of any cached epoch as the sole prerequisite in order to leverage OffsetsForLeaderEpoch. This has the effect of causing a massive truncation after startup which causes re-replication.&lt;/p&gt;

&lt;p&gt;I think our options to fix this are to either 1) clear the cache when we notice a downgrade, or 2) forbid downgrades and raise an error.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13213819">KAFKA-7897</key>
            <summary>Invalid use of epoch cache with old message format versions</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hachikuji">Jason Gustafson</assignee>
                                    <reporter username="hachikuji">Jason Gustafson</reporter>
                        <labels>
                    </labels>
                <created>Tue, 5 Feb 2019 01:19:20 +0000</created>
                <updated>Tue, 9 Apr 2019 22:40:20 +0000</updated>
                            <resolved>Tue, 12 Feb 2019 19:22:58 +0000</resolved>
                                    <version>2.0.1</version>
                    <version>2.1.0</version>
                                    <fixVersion>1.1.2</fixVersion>
                    <fixVersion>2.0.2</fixVersion>
                    <fixVersion>2.1.1</fixVersion>
                    <fixVersion>2.2.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="16760382" author="githubbot" created="Tue, 5 Feb 2019 01:47:54 +0000"  >&lt;p&gt;hachikuji commented on pull request #6232: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7897&quot; title=&quot;Invalid use of epoch cache with old message format versions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7897&quot;&gt;&lt;del&gt;KAFKA-7897&lt;/del&gt;&lt;/a&gt;; Clear leader epoch cache after message format downgrade&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/6232&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/6232&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   If the message format is downgraded, we should clear the leader epoch cache so that it is not mistakenly used for truncation. We want to revert to truncation by high watermark.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16761049" author="hachikuji" created="Tue, 5 Feb 2019 17:37:57 +0000"  >&lt;p&gt;There is a bit more to this bug than just dealing with message format downgrades. There was a regression in &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7415&quot; title=&quot;OffsetsForLeaderEpoch may incorrectly respond with undefined epoch causing truncation to HW&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7415&quot;&gt;&lt;del&gt;KAFKA-7415&lt;/del&gt;&lt;/a&gt; which caused the leader epoch cache to be populated upon becoming a leader even if the message format was older. This could cause unexpected truncation of data following a leader change.&lt;/p&gt;</comment>
                            <comment id="16763766" author="githubbot" created="Fri, 8 Feb 2019 17:22:17 +0000"  >&lt;p&gt;hachikuji commented on pull request #6232: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7897&quot; title=&quot;Invalid use of epoch cache with old message format versions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7897&quot;&gt;&lt;del&gt;KAFKA-7897&lt;/del&gt;&lt;/a&gt;; Disable leader epoch cache when older message formats are used&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/6232&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/6232&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16765215" author="githubbot" created="Mon, 11 Feb 2019 17:57:24 +0000"  >&lt;p&gt;hachikuji commented on pull request #6253: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7897&quot; title=&quot;Invalid use of epoch cache with old message format versions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7897&quot;&gt;&lt;del&gt;KAFKA-7897&lt;/del&gt;&lt;/a&gt;; Do not write epoch start offset for older message format versions&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/6253&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/6253&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   When an older message format is in use, we should disable the leader epoch cache so that we resort to truncation by high watermark. Previously we updated the cache for all versions when a broker became leader for a partition. This can cause large and unnecessary truncations after leader changes because we relied on the presence of &lt;em&gt;any&lt;/em&gt; cached epoch in order to tell whether to use the improved truncation logic possible with the OffsetsForLeaderEpoch API.&lt;/p&gt;

&lt;p&gt;   Note this is a simplified fix than what was merged to trunk in #6232 since the branches have diverged significantly. Rather than removing the epoch cache file, we guard usage of the cache with the record version.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16765462" author="mjsax" created="Mon, 11 Feb 2019 22:41:01 +0000"  >&lt;p&gt;Updating status. This Jira seems to be on-track for 2.2 release.&lt;/p&gt;</comment>
                            <comment id="16766215" author="githubbot" created="Tue, 12 Feb 2019 16:32:36 +0000"  >&lt;p&gt;hachikuji commented on pull request #6253: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7897&quot; title=&quot;Invalid use of epoch cache with old message format versions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7897&quot;&gt;&lt;del&gt;KAFKA-7897&lt;/del&gt;&lt;/a&gt;; Do not write epoch start offset for older message format versions&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/6253&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/6253&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13213097">KAFKA-7886</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13218403">KAFKA-8012</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13219321">KAFKA-8036</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 40 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|yi0nko:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>