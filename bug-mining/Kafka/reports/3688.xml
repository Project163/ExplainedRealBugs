<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:37:39 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-16157] Topic recreation with offline disk doesn&apos;t update leadership/shrink ISR correctly</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-16157</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;In a cluster with 4 brokers, `broker-1..broker-4` with 2 disks `d1` and `d2` in each broker, we perform the following operations:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Create a topic `foo.test` with 10 partitions and RF 4. Let&apos;s assume the topic was created with id `rAujIqcjRbu_-E4UxgQT8Q`.&lt;/li&gt;
	&lt;li&gt;Start a producer in the background to produce to `foo.test`.&lt;/li&gt;
	&lt;li&gt;Break disk `d1` in `broker-1`. We simulate this by marking the log dir read-only.&lt;/li&gt;
	&lt;li&gt;Delete topic `foo.test`&lt;/li&gt;
	&lt;li&gt;Recreate topic `foo.test`. Let&apos;s assume the topic was created with id `bgdrsv-1QjCLFEqLOzVCHg`.&lt;/li&gt;
	&lt;li&gt;Wait for 5 minutes&lt;/li&gt;
	&lt;li&gt;Describe the recreated topic `foo.test`.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;We observe that `broker-1` is the leader and in-sync for few partitions&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&#160;
Topic: foo.test TopicId: bgdrsv-1QjCLFEqLOzVCHg PartitionCount: 10 &#160; &#160; &#160;ReplicationFactor: 4 &#160; &#160;Configs: min.insync.replicas=1,unclean.leader.election.enable=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
&#160; &#160; &#160; &#160; Topic: foo.test Partition: 0 &#160; &#160;Leader: 101 &#160; &#160; Replicas: 101,102,103,104 &#160; &#160; &#160; Isr: 101,102,103,104
&#160; &#160; &#160; &#160; Topic: foo.test Partition: 1 &#160; &#160;Leader: 102 &#160; &#160; Replicas: 102,103,104,101 &#160; &#160; &#160; Isr: 102,103,104
&#160; &#160; &#160; &#160; Topic: foo.test Partition: 2 &#160; &#160;Leader: 103 &#160; &#160; Replicas: 103,104,101,102 &#160; &#160; &#160; Isr: 103,104,102
&#160; &#160; &#160; &#160; Topic: foo.test Partition: 3 &#160; &#160;Leader: 104 &#160; &#160; Replicas: 104,101,102,103 &#160; &#160; &#160; Isr: 104,102,103
&#160; &#160; &#160; &#160; Topic: foo.test Partition: 4 &#160; &#160;Leader: 104 &#160; &#160; Replicas: 104,102,101,103 &#160; &#160; &#160; Isr: 104,102,103
&#160; &#160; &#160; &#160; Topic: foo.test Partition: 5 &#160; &#160;Leader: 102 &#160; &#160; Replicas: 102,101,103,104 &#160; &#160; &#160; Isr: 102,103,104
&#160; &#160; &#160; &#160; Topic: foo.test Partition: 6 &#160; &#160;Leader: 101 &#160; &#160; Replicas: 101,103,104,102 &#160; &#160; &#160; Isr: 101,103,104,102
&#160; &#160; &#160; &#160; Topic: foo.test Partition: 7 &#160; &#160;Leader: 103 &#160; &#160; Replicas: 103,104,102,101 &#160; &#160; &#160; Isr: 103,104,102
&#160; &#160; &#160; &#160; Topic: foo.test Partition: 8 &#160; &#160;Leader: 101 &#160; &#160; Replicas: 101,102,104,103 &#160; &#160; &#160; Isr: 101,102,104,103
&#160; &#160; &#160; &#160; Topic: foo.test Partition: 9 &#160; &#160;Leader: 102 &#160; &#160; Replicas: 102,104,103,101 &#160; &#160; &#160; Isr: 102,104,103
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;In this example, it is the leader of partitions `0, 6 and 8`.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Consider `foo.test-8`. It is present in the following brokers/disks:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
$ fd foo.test-8
broker-1/d1/foo.test-8/
broker-2/d2/foo.test-8/
broker-3/d2/foo.test-8/
broker-4/d1/foo.test-8/&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;`broker-1/d1` still refers to the topic id which is pending deletion because the log dir is marked offline.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
$ cat broker-1/d1/foo.test-8/partition.metadata
version: 0
topic_id: rAujIqcjRbu_-E4UxgQT8Q&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;However, other brokers have the correct topic-id&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
$ cat broker-2/d2/foo.test-8/partition.metadata
version: 0
topic_id: bgdrsv-1QjCLFEqLOzVCHg%&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Now, let&apos;s consider `foo.test-0`. We observe that the replica isn&apos;t present in `broker-1`:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
$ fd foo.test-0
broker-2/d1/foo.test-0/
broker-3/d1/foo.test-0/
broker-4/d2/foo.test-0/&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;In both cases, `broker-1` shouldn&apos;t be the leader or in-sync replica for the partitions.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13565118">KAFKA-16157</key>
            <summary>Topic recreation with offline disk doesn&apos;t update leadership/shrink ISR correctly</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gnarula">Gaurav Narula</assignee>
                                    <reporter username="gnarula">Gaurav Narula</reporter>
                        <labels>
                    </labels>
                <created>Wed, 17 Jan 2024 16:35:21 +0000</created>
                <updated>Wed, 14 Feb 2024 15:13:45 +0000</updated>
                            <resolved>Sat, 3 Feb 2024 07:04:44 +0000</resolved>
                                    <version>3.7.0</version>
                                    <fixVersion>3.7.0</fixVersion>
                                    <component>jbod</component>
                    <component>kraft</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17807814" author="mimaison" created="Wed, 17 Jan 2024 17:06:20 +0000"  >&lt;p&gt;Did you hit this issue while testing 3.7.0 RC2 or with trunk?&lt;/p&gt;</comment>
                            <comment id="17807927" author="gnarula" created="Wed, 17 Jan 2024 23:10:38 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mimaison&quot; class=&quot;user-hover&quot; rel=&quot;mimaison&quot;&gt;mimaison&lt;/a&gt; I raised the bug while testing against trunk but I can confirm a reproduction against git tag `3.7.0-rc2` (commit 40d9698ba4)&lt;/p&gt;</comment>
                            <comment id="17808114" author="gnarula" created="Thu, 18 Jan 2024 10:02:45 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pprovenzano&quot; class=&quot;user-hover&quot; rel=&quot;pprovenzano&quot;&gt;pprovenzano&lt;/a&gt; I was also able to reproduce this in a cluster with 1 broker.&lt;/p&gt;</comment>
                            <comment id="17808140" author="mimaison" created="Thu, 18 Jan 2024 10:44:29 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=enether&quot; class=&quot;user-hover&quot; rel=&quot;enether&quot;&gt;enether&lt;/a&gt; I marked this as a blocker for 3.7. Feel free to reassign if you don&apos;t agree.&lt;/p&gt;</comment>
                            <comment id="17810583" author="gnarula" created="Wed, 24 Jan 2024 22:35:50 +0000"  >&lt;p&gt;Here are some notes from my troubleshooting:&lt;/p&gt;

&lt;p&gt;When &lt;tt&gt;d1&lt;/tt&gt; fails in &lt;tt&gt;broker-1&lt;/tt&gt;, the controller updates the &lt;tt&gt;BrokerRegistration&lt;/tt&gt; such that it only contains one log directory &lt;tt&gt;d2&lt;/tt&gt;. On handling topic recreation, the controller makes use of an optimisation to assign the replica to the only existing log directory &lt;tt&gt;d2&lt;/tt&gt; &lt;a href=&quot;https://github.com/apache/kafka/blob/f1924353126fdf6aad2ba1f8d0c22dade59360b1/metadata/src/main/java/org/apache/kafka/controller/ClusterControlManager.java#L721&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;[0]&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;In &lt;tt&gt;broker-1&lt;/tt&gt;, &lt;tt&gt;ReplicaManager::getOrCreatePartition&lt;/tt&gt; is invoked when the topic is recreated. We branch into the case handling &lt;tt&gt;HostedPartition.Offline&lt;/tt&gt;&#160;&lt;a href=&quot;https://github.com/apache/kafka/blob/f1924353126fdf6aad2ba1f8d0c22dade59360b1/core/src/main/scala/kafka/server/ReplicaManager.scala#L2774&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;[1]&lt;/a&gt;. Since &lt;tt&gt;ReplicaManager::allPartitions&lt;/tt&gt; is keyed by &lt;tt&gt;TopicPartition&lt;/tt&gt;, it doesn&apos;t track the &lt;tt&gt;TopicId&lt;/tt&gt; which is in the offline log directory. We therefore return &lt;tt&gt;None&lt;/tt&gt; and not handle the topic delta correctly. First part of the fix would therefore be to modify &lt;tt&gt;HostedPartition.Offline&lt;/tt&gt; and track the topic id with it.&lt;/p&gt;

&lt;p&gt;Next part is to handle the log creation correctly. The broker eventually invokes &lt;tt&gt;Partition::createLogIfNotExists&lt;/tt&gt; &lt;a href=&quot;https://github.com/apache/kafka/blob/f1924353126fdf6aad2ba1f8d0c22dade59360b1/core/src/main/scala/kafka/cluster/Partition.scala#L877&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;[2]&lt;/a&gt;, with &lt;tt&gt;isNew = directoryId == DirectoryId.UNASSIGNED&lt;/tt&gt;. Recall from the optimisation in the controller, the directory id will &lt;b&gt;not&lt;/b&gt; be &lt;tt&gt;UNASSIGNED&lt;/tt&gt;, but point to the UUID for &lt;tt&gt;d2&lt;/tt&gt; and therefore, &lt;tt&gt;isNew = false&lt;/tt&gt;. Eventually, &lt;tt&gt;LogManager::getOrCreateLog&lt;/tt&gt; fails when &lt;tt&gt;isNew = false &amp;amp;&amp;amp; offlineLogDirs.nonEmpty&lt;/tt&gt; &lt;a href=&quot;https://github.com/apache/kafka/blob/f1924353126fdf6aad2ba1f8d0c22dade59360b1/core/src/main/scala/kafka/log/LogManager.scala#L1009&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;[3]&lt;/a&gt;. Second part of the the fix is therefore to update &lt;tt&gt;Partition::createLogInAssignedDirectoryId&lt;/tt&gt; to invoke &lt;tt&gt;Partition::createLogIfNotExists&lt;/tt&gt; correctly.&lt;/p&gt;

&lt;p&gt;CC: &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=omnia_h_ibrahim&quot; class=&quot;user-hover&quot; rel=&quot;omnia_h_ibrahim&quot;&gt;omnia_h_ibrahim&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=soarez&quot; class=&quot;user-hover&quot; rel=&quot;soarez&quot;&gt;soarez&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cmccabe&quot; class=&quot;user-hover&quot; rel=&quot;cmccabe&quot;&gt;cmccabe&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pprovenzano&quot; class=&quot;user-hover&quot; rel=&quot;pprovenzano&quot;&gt;pprovenzano&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17812267" author="mimaison" created="Tue, 30 Jan 2024 11:04:12 +0000"  >&lt;p&gt;I assigned the ticket to you since you opened a PR&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13066098" name="broker.log" size="26148" author="gnarula" created="Wed, 17 Jan 2024 16:40:56 +0000"/>
                            <attachment id="13066099" name="broker.log.1" size="1048593" author="gnarula" created="Wed, 17 Jan 2024 16:40:56 +0000"/>
                            <attachment id="13066108" name="broker.log.10" size="1048671" author="gnarula" created="Wed, 17 Jan 2024 16:40:56 +0000"/>
                            <attachment id="13066100" name="broker.log.2" size="1048652" author="gnarula" created="Wed, 17 Jan 2024 16:40:56 +0000"/>
                            <attachment id="13066101" name="broker.log.3" size="1048641" author="gnarula" created="Wed, 17 Jan 2024 16:40:56 +0000"/>
                            <attachment id="13066102" name="broker.log.4" size="1048684" author="gnarula" created="Wed, 17 Jan 2024 16:40:56 +0000"/>
                            <attachment id="13066103" name="broker.log.5" size="1048667" author="gnarula" created="Wed, 17 Jan 2024 16:40:56 +0000"/>
                            <attachment id="13066104" name="broker.log.6" size="1048601" author="gnarula" created="Wed, 17 Jan 2024 16:40:56 +0000"/>
                            <attachment id="13066105" name="broker.log.7" size="1048642" author="gnarula" created="Wed, 17 Jan 2024 16:40:56 +0000"/>
                            <attachment id="13066106" name="broker.log.8" size="1048626" author="gnarula" created="Wed, 17 Jan 2024 16:40:56 +0000"/>
                            <attachment id="13066107" name="broker.log.9" size="1048764" author="gnarula" created="Wed, 17 Jan 2024 16:40:56 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>11.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 41 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1mtnk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>