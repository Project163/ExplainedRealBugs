<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:16:04 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-7518] FutureRecordMetadata.get deadline calculation from timeout is not using timeunit</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-7518</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Code below assumes that timeout is in milliseconds when calculating deadline.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; RecordMetadata get(&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; timeout, TimeUnit unit) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; InterruptedException, ExecutionException, TimeoutException {
        &lt;span class=&quot;code-comment&quot;&gt;// Handle overflow.
&lt;/span&gt;        &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; now = &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.currentTimeMillis();
        &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; deadline = &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;.MAX_VALUE - timeout &amp;lt; now ? &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;.MAX_VALUE : now + timeout;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;tt&gt;kafka.server.DynamicBrokerReconfigurationTest#testAdvertisedListenerUpdate&lt;/tt&gt; failed sometimes for me and it took me to this code segment.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13192501">KAFKA-7518</key>
            <summary>FutureRecordMetadata.get deadline calculation from timeout is not using timeunit</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="akatona">Andras Katona</assignee>
                                    <reporter username="akatona">Andras Katona</reporter>
                        <labels>
                    </labels>
                <created>Thu, 18 Oct 2018 10:42:30 +0000</created>
                <updated>Mon, 12 Nov 2018 19:19:13 +0000</updated>
                            <resolved>Mon, 12 Nov 2018 19:19:13 +0000</resolved>
                                                    <fixVersion>2.1.1</fixVersion>
                    <fixVersion>2.2.0</fixVersion>
                                    <component>clients</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="16655039" author="githubbot" created="Thu, 18 Oct 2018 10:46:08 +0000"  >&lt;p&gt;akatona84 opened a new pull request #5815: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7518&quot; title=&quot;FutureRecordMetadata.get deadline calculation from timeout is not using timeunit&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7518&quot;&gt;&lt;del&gt;KAFKA-7518&lt;/del&gt;&lt;/a&gt;: FutureRecordMetadata.get deadline calculation fix&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5815&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5815&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;   *More detailed description of your change,&lt;br/&gt;
   if necessary. The PR title and PR message become&lt;br/&gt;
   the squashed commit message, so use a separate&lt;br/&gt;
   comment to ping reviewers.*&lt;/p&gt;

&lt;p&gt;   *Summary of testing strategy (including rationale)&lt;br/&gt;
   for the feature or bug fix. Unit and/or integration&lt;br/&gt;
   tests are expected for any behaviour change and&lt;br/&gt;
   system tests should be considered for larger changes.*&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16684267" author="githubbot" created="Mon, 12 Nov 2018 19:17:58 +0000"  >&lt;p&gt;ijuma closed pull request #5815: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7518&quot; title=&quot;FutureRecordMetadata.get deadline calculation from timeout is not using timeunit&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7518&quot;&gt;&lt;del&gt;KAFKA-7518&lt;/del&gt;&lt;/a&gt;: FutureRecordMetadata.get deadline calculation fix&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5815&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5815&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/clients/src/main/java/org/apache/kafka/clients/producer/MockProducer.java b/clients/src/main/java/org/apache/kafka/clients/producer/MockProducer.java&lt;br/&gt;
index a38bd04f906..e448d6ebdc3 100644&lt;br/&gt;
&amp;#8212; a/clients/src/main/java/org/apache/kafka/clients/producer/MockProducer.java&lt;br/&gt;
+++ b/clients/src/main/java/org/apache/kafka/clients/producer/MockProducer.java&lt;br/&gt;
@@ -29,6 +29,7 @@&lt;br/&gt;
 import org.apache.kafka.common.errors.ProducerFencedException;&lt;br/&gt;
 import org.apache.kafka.common.record.RecordBatch;&lt;br/&gt;
 import org.apache.kafka.common.serialization.Serializer;&lt;br/&gt;
+import org.apache.kafka.common.utils.Time;&lt;/p&gt;

&lt;p&gt; import java.util.ArrayDeque;&lt;br/&gt;
 import java.util.ArrayList;&lt;br/&gt;
@@ -254,7 +255,8 @@ private void verifyNoTransactionInFlight() {&lt;br/&gt;
             partition = partition(record, this.cluster);&lt;br/&gt;
         TopicPartition topicPartition = new TopicPartition(record.topic(), partition);&lt;br/&gt;
         ProduceRequestResult result = new ProduceRequestResult(topicPartition);&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;FutureRecordMetadata future = new FutureRecordMetadata(result, 0, RecordBatch.NO_TIMESTAMP, 0L, 0, 0);&lt;br/&gt;
+        FutureRecordMetadata future = new FutureRecordMetadata(result, 0, RecordBatch.NO_TIMESTAMP,&lt;br/&gt;
+                0L, 0, 0, Time.SYSTEM);&lt;br/&gt;
         long offset = nextOffset(topicPartition);&lt;br/&gt;
         Completion completion = new Completion(offset, new RecordMetadata(topicPartition, 0, offset,&lt;br/&gt;
                 RecordBatch.NO_TIMESTAMP, Long.valueOf(0L), 0, 0), result, callback);&lt;br/&gt;
diff --git a/clients/src/main/java/org/apache/kafka/clients/producer/internals/FutureRecordMetadata.java b/clients/src/main/java/org/apache/kafka/clients/producer/internals/FutureRecordMetadata.java&lt;br/&gt;
index 8fcc46ff3ff..d1a643b3196 100644
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/clients/src/main/java/org/apache/kafka/clients/producer/internals/FutureRecordMetadata.java&lt;br/&gt;
+++ b/clients/src/main/java/org/apache/kafka/clients/producer/internals/FutureRecordMetadata.java&lt;br/&gt;
@@ -16,13 +16,14 @@&lt;br/&gt;
  */&lt;br/&gt;
 package org.apache.kafka.clients.producer.internals;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;+import org.apache.kafka.clients.producer.RecordMetadata;&lt;br/&gt;
+import org.apache.kafka.common.utils.Time;&lt;br/&gt;
+&lt;br/&gt;
 import java.util.concurrent.ExecutionException;&lt;br/&gt;
 import java.util.concurrent.Future;&lt;br/&gt;
 import java.util.concurrent.TimeUnit;&lt;br/&gt;
 import java.util.concurrent.TimeoutException;&lt;/p&gt;

&lt;p&gt;-import org.apache.kafka.clients.producer.RecordMetadata;&lt;br/&gt;
-&lt;br/&gt;
 /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;The future result of a record send&lt;br/&gt;
  */&lt;br/&gt;
@@ -34,16 +35,18 @@&lt;br/&gt;
     private final Long checksum;&lt;br/&gt;
     private final int serializedKeySize;&lt;br/&gt;
     private final int serializedValueSize;&lt;br/&gt;
+    private final Time time;&lt;br/&gt;
     private volatile FutureRecordMetadata nextRecordMetadata = null;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     public FutureRecordMetadata(ProduceRequestResult result, long relativeOffset, long createTimestamp,&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Long checksum, int serializedKeySize, int serializedValueSize) {&lt;br/&gt;
+                                Long checksum, int serializedKeySize, int serializedValueSize, Time time) 
{
         this.result = result;
         this.relativeOffset = relativeOffset;
         this.createTimestamp = createTimestamp;
         this.checksum = checksum;
         this.serializedKeySize = serializedKeySize;
         this.serializedValueSize = serializedValueSize;
+        this.time = time;
     }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     @Override&lt;br/&gt;
@@ -67,13 +70,14 @@ public RecordMetadata get() throws InterruptedException, ExecutionException {&lt;br/&gt;
     @Override&lt;br/&gt;
     public RecordMetadata get(long timeout, TimeUnit unit) throws InterruptedException, ExecutionException, TimeoutException &lt;/p&gt;
{
         // Handle overflow.
-        long now = System.currentTimeMillis();
-        long deadline = Long.MAX_VALUE - timeout &amp;lt; now ? Long.MAX_VALUE : now + timeout;
+        long now = time.milliseconds();
+        long timeoutMillis = unit.toMillis(timeout);
+        long deadline = Long.MAX_VALUE - timeoutMillis &amp;lt; now ? Long.MAX_VALUE : now + timeoutMillis;
         boolean occurred = this.result.await(timeout, unit);
-        if (nextRecordMetadata != null)
-            return nextRecordMetadata.get(deadline - System.currentTimeMillis(), TimeUnit.MILLISECONDS);
         if (!occurred)
-            throw new TimeoutException(&quot;Timeout after waiting for &quot; + TimeUnit.MILLISECONDS.convert(timeout, unit) + &quot; ms.&quot;);
+            throw new TimeoutException(&quot;Timeout after waiting for &quot; + timeoutMillis + &quot; ms.&quot;);
+        if (nextRecordMetadata != null)
+            return nextRecordMetadata.get(deadline - time.milliseconds(), TimeUnit.MILLISECONDS);
         return valueOrError();
     }

&lt;p&gt;diff --git a/clients/src/main/java/org/apache/kafka/clients/producer/internals/ProduceRequestResult.java b/clients/src/main/java/org/apache/kafka/clients/producer/internals/ProduceRequestResult.java&lt;br/&gt;
index fbfef6171ed..1e8c7879632 100644&lt;br/&gt;
&amp;#8212; a/clients/src/main/java/org/apache/kafka/clients/producer/internals/ProduceRequestResult.java&lt;br/&gt;
+++ b/clients/src/main/java/org/apache/kafka/clients/producer/internals/ProduceRequestResult.java&lt;br/&gt;
@@ -29,7 +29,7 @@&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;partition in a produce request and it is shared by all the 
{@link RecordMetadata}
&lt;p&gt; instances that are batched together&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;for the same partition in the request.&lt;br/&gt;
  */&lt;br/&gt;
-public final class ProduceRequestResult {&lt;br/&gt;
+public class ProduceRequestResult {&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     private final CountDownLatch latch = new CountDownLatch(1);&lt;br/&gt;
     private final TopicPartition topicPartition;&lt;br/&gt;
diff --git a/clients/src/main/java/org/apache/kafka/clients/producer/internals/ProducerBatch.java b/clients/src/main/java/org/apache/kafka/clients/producer/internals/ProducerBatch.java&lt;br/&gt;
index 0adbbf962cd..80372cbc7cf 100644&lt;br/&gt;
&amp;#8212; a/clients/src/main/java/org/apache/kafka/clients/producer/internals/ProducerBatch.java&lt;br/&gt;
+++ b/clients/src/main/java/org/apache/kafka/clients/producer/internals/ProducerBatch.java&lt;br/&gt;
@@ -31,6 +31,7 @@&lt;br/&gt;
 import org.apache.kafka.common.record.RecordBatch;&lt;br/&gt;
 import org.apache.kafka.common.record.TimestampType;&lt;br/&gt;
 import org.apache.kafka.common.requests.ProduceResponse;&lt;br/&gt;
+import org.apache.kafka.common.utils.Time;&lt;br/&gt;
 import org.slf4j.Logger;&lt;br/&gt;
 import org.slf4j.LoggerFactory;&lt;/p&gt;

&lt;p&gt;@@ -109,7 +110,8 @@ public FutureRecordMetadata tryAppend(long timestamp, byte[] key, byte[] value,&lt;br/&gt;
             FutureRecordMetadata future = new FutureRecordMetadata(this.produceFuture, this.recordCount,&lt;br/&gt;
                                                                    timestamp, checksum,&lt;br/&gt;
                                                                    key == null ? -1 : key.length,&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;value == null ? -1 : value.length);&lt;br/&gt;
+                                                                   value == null ? -1 : value.length,&lt;br/&gt;
+                                                                   Time.SYSTEM);&lt;br/&gt;
             // we have to keep every future returned to the users in case the batch needs to be&lt;br/&gt;
             // split to several new batches and resent.&lt;br/&gt;
             thunks.add(new Thunk(callback, future));&lt;br/&gt;
@@ -133,7 +135,8 @@ private boolean tryAppendForSplit(long timestamp, ByteBuffer key, ByteBuffer val&lt;br/&gt;
             FutureRecordMetadata future = new FutureRecordMetadata(this.produceFuture, this.recordCount,&lt;br/&gt;
                                                                    timestamp, thunk.future.checksumOrNull(),&lt;br/&gt;
                                                                    key == null ? -1 : key.remaining(),&lt;/li&gt;
	&lt;li&gt;value == null ? -1 : value.remaining());&lt;br/&gt;
+                                                                   value == null ? -1 : value.remaining(),&lt;br/&gt;
+                                                                   Time.SYSTEM);&lt;br/&gt;
             // Chain the future to the original thunk.&lt;br/&gt;
             thunk.future.chain(future);&lt;br/&gt;
             this.thunks.add(thunk);&lt;br/&gt;
diff --git a/clients/src/test/java/org/apache/kafka/clients/producer/RecordSendTest.java b/clients/src/test/java/org/apache/kafka/clients/producer/RecordSendTest.java&lt;br/&gt;
index c083db3f291..45be1171c8f 100644
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/clients/src/test/java/org/apache/kafka/clients/producer/RecordSendTest.java&lt;br/&gt;
+++ b/clients/src/test/java/org/apache/kafka/clients/producer/RecordSendTest.java&lt;br/&gt;
@@ -31,6 +31,7 @@&lt;br/&gt;
 import org.apache.kafka.common.TopicPartition;&lt;br/&gt;
 import org.apache.kafka.common.errors.CorruptRecordException;&lt;br/&gt;
 import org.apache.kafka.common.record.RecordBatch;&lt;br/&gt;
+import org.apache.kafka.common.utils.Time;&lt;br/&gt;
 import org.junit.Test;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; public class RecordSendTest {&lt;br/&gt;
@@ -46,7 +47,7 @@&lt;br/&gt;
     public void testTimeout() throws Exception {&lt;br/&gt;
         ProduceRequestResult request = new ProduceRequestResult(topicPartition);&lt;br/&gt;
         FutureRecordMetadata future = new FutureRecordMetadata(request, relOffset,&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;RecordBatch.NO_TIMESTAMP, 0L, 0, 0);&lt;br/&gt;
+                RecordBatch.NO_TIMESTAMP, 0L, 0, 0, Time.SYSTEM);&lt;br/&gt;
         assertFalse(&quot;Request is not completed&quot;, future.isDone());&lt;br/&gt;
         try {&lt;br/&gt;
             future.get(5, TimeUnit.MILLISECONDS);&lt;br/&gt;
@@ -66,7 +67,7 @@ public void testTimeout() throws Exception {&lt;br/&gt;
     @Test(expected = ExecutionException.class)&lt;br/&gt;
     public void testError() throws Exception 
{
         FutureRecordMetadata future = new FutureRecordMetadata(asyncRequest(baseOffset, new CorruptRecordException(), 50L),
-                relOffset, RecordBatch.NO_TIMESTAMP, 0L, 0, 0);
+                relOffset, RecordBatch.NO_TIMESTAMP, 0L, 0, 0, Time.SYSTEM);
         future.get();
     }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;@@ -76,7 +77,7 @@ public void testError() throws Exception {&lt;br/&gt;
     @Test&lt;br/&gt;
     public void testBlocking() throws Exception &lt;/p&gt;
{
         FutureRecordMetadata future = new FutureRecordMetadata(asyncRequest(baseOffset, null, 50L),
-                relOffset, RecordBatch.NO_TIMESTAMP, 0L, 0, 0);
+                relOffset, RecordBatch.NO_TIMESTAMP, 0L, 0, 0, Time.SYSTEM);
         assertEquals(baseOffset + relOffset, future.get().offset());
     }

&lt;p&gt;diff --git a/clients/src/test/java/org/apache/kafka/clients/producer/internals/FutureRecordMetadataTest.java b/clients/src/test/java/org/apache/kafka/clients/producer/internals/FutureRecordMetadataTest.java&lt;br/&gt;
new file mode 100644&lt;br/&gt;
index 00000000000..aee24e8fc64&lt;br/&gt;
&amp;#8212; /dev/null&lt;br/&gt;
+++ b/clients/src/test/java/org/apache/kafka/clients/producer/internals/FutureRecordMetadataTest.java&lt;br/&gt;
@@ -0,0 +1,82 @@&lt;br/&gt;
+/*&lt;br/&gt;
+ * Licensed to the Apache Software Foundation (ASF) under one or more&lt;br/&gt;
+ * contributor license agreements. See the NOTICE file distributed with&lt;br/&gt;
+ * this work for additional information regarding copyright ownership.&lt;br/&gt;
+ * The ASF licenses this file to You under the Apache License, Version 2.0&lt;br/&gt;
+ * (the &quot;License&quot;); you may not use this file except in compliance with&lt;br/&gt;
+ * the License. You may obtain a copy of the License at&lt;br/&gt;
+ *&lt;br/&gt;
+ *    &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
+ *&lt;br/&gt;
+ * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
+ * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
+ * See the License for the specific language governing permissions and&lt;br/&gt;
+ * limitations under the License.&lt;br/&gt;
+ */&lt;br/&gt;
+package org.apache.kafka.clients.producer.internals;&lt;br/&gt;
+&lt;br/&gt;
+import org.apache.kafka.common.record.RecordBatch;&lt;br/&gt;
+import org.apache.kafka.common.utils.MockTime;&lt;br/&gt;
+import org.junit.Test;&lt;br/&gt;
+&lt;br/&gt;
+import java.util.concurrent.ExecutionException;&lt;br/&gt;
+import java.util.concurrent.TimeUnit;&lt;br/&gt;
+import java.util.concurrent.TimeoutException;&lt;br/&gt;
+&lt;br/&gt;
+import static org.mockito.ArgumentMatchers.any;&lt;br/&gt;
+import static org.mockito.ArgumentMatchers.anyLong;&lt;br/&gt;
+import static org.mockito.Mockito.mock;&lt;br/&gt;
+import static org.mockito.Mockito.verify;&lt;br/&gt;
+import static org.mockito.Mockito.when;&lt;br/&gt;
+&lt;br/&gt;
+public class FutureRecordMetadataTest {&lt;br/&gt;
+&lt;br/&gt;
+    private final MockTime time = new MockTime();&lt;br/&gt;
+&lt;br/&gt;
+    @Test&lt;br/&gt;
+    public void testFutureGetWithSeconds() throws ExecutionException, InterruptedException, TimeoutException &lt;/p&gt;
{
+        ProduceRequestResult produceRequestResult = mockProduceRequestResult();
+        FutureRecordMetadata future = futureRecordMetadata(produceRequestResult);
+
+        ProduceRequestResult chainedProduceRequestResult = mockProduceRequestResult();
+        future.chain(futureRecordMetadata(chainedProduceRequestResult));
+
+        future.get(1L, TimeUnit.SECONDS);
+
+        verify(produceRequestResult).await(1L, TimeUnit.SECONDS);
+        verify(chainedProduceRequestResult).await(1000L, TimeUnit.MILLISECONDS);
+    }
&lt;p&gt;+&lt;br/&gt;
+    @Test&lt;br/&gt;
+    public void testFutureGetWithMilliSeconds() throws ExecutionException, InterruptedException, TimeoutException &lt;/p&gt;
{
+        ProduceRequestResult produceRequestResult = mockProduceRequestResult();
+        FutureRecordMetadata future = futureRecordMetadata(produceRequestResult);
+
+        ProduceRequestResult chainedProduceRequestResult = mockProduceRequestResult();
+        future.chain(futureRecordMetadata(chainedProduceRequestResult));
+
+        future.get(1000L, TimeUnit.MILLISECONDS);
+
+        verify(produceRequestResult).await(1000L, TimeUnit.MILLISECONDS);
+        verify(chainedProduceRequestResult).await(1000L, TimeUnit.MILLISECONDS);
+    }
&lt;p&gt;+&lt;br/&gt;
+    private FutureRecordMetadata futureRecordMetadata(ProduceRequestResult produceRequestResult) &lt;/p&gt;
{
+        return new FutureRecordMetadata(
+                produceRequestResult,
+                0,
+                RecordBatch.NO_TIMESTAMP,
+                0L,
+                0,
+                0,
+                time
+        );
+    }
&lt;p&gt;+&lt;br/&gt;
+    private ProduceRequestResult mockProduceRequestResult() throws InterruptedException &lt;/p&gt;
{
+        ProduceRequestResult mockProduceRequestResult = mock(ProduceRequestResult.class);
+        when(mockProduceRequestResult.await(anyLong(), any(TimeUnit.class))).thenReturn(true);
+        return mockProduceRequestResult;
+    }
&lt;p&gt;+}&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 1 week ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3zcr3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>