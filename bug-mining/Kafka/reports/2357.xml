<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:19:49 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-8724] log cleaner thread dies when attempting to clean a __consumer_offsets partition after upgrade from 2.0-&gt;2.3</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-8724</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;We are attempting an upgrade from Kafka 2.0 to 2.3 on a single cluster setup.&#160; We have a mixture of Java/C++ and Python clients (Python clients are using kafka-python libraries).&lt;/p&gt;

&lt;p&gt;After the upgrade, the log cleaner occasionally dies with the attached stack trace.&#160; Using timestamp correlation, we pinned it down to the cleaning of a __consumer_offsets partition.&#160; The config logged at initialization shows that&#160;&lt;/p&gt;

&lt;p&gt;inter.broker.protocol.version = 2.3-IV1&lt;/p&gt;

&lt;p&gt;log.message.format.version = 2.3-IV1&lt;/p&gt;

&lt;p&gt;We initially thought this was to do with unclean upgrade from 2.0 to 2.3, but after resetting the consumer offsets topic (via&#160;&lt;a href=&quot;https://medium.com/@nblaye/reset-consumer-offsets-topic-in-kafka-with-zookeeper-5910213284a2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://medium.com/@nblaye/reset-consumer-offsets-topic-in-kafka-with-zookeeper-5910213284a2&lt;/a&gt;)&#160; this still recurs on initially empty consumer offset partitions.&lt;/p&gt;

&lt;p&gt;At the moment we are working around by toggling log.cleaner.threads option using dynamic broker configuration to restore the log cleaner threads&lt;/p&gt;</description>
                <environment>Linux 3.10.0-862.2.3.el7.x86_64 #1 SMP Wed May 9 18:05:47 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux</environment>
        <key id="13247559">KAFKA-8724</key>
            <summary>log cleaner thread dies when attempting to clean a __consumer_offsets partition after upgrade from 2.0-&gt;2.3</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hachikuji">Jason Gustafson</assignee>
                                    <reporter username="keithks">Keith So</reporter>
                        <labels>
                    </labels>
                <created>Mon, 29 Jul 2019 02:59:23 +0000</created>
                <updated>Thu, 5 Sep 2019 16:38:57 +0000</updated>
                            <resolved>Thu, 5 Sep 2019 16:38:57 +0000</resolved>
                                    <version>2.3.0</version>
                                    <fixVersion>2.3.1</fixVersion>
                                    <component>log cleaner</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="16895679" author="keithks" created="Tue, 30 Jul 2019 00:51:30 +0000"  >&lt;p&gt;This is the config we have for __consumer_offsets, if there is a quick workaround via config we&apos;d much appreciate it.&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;$ kafka-topics --bootstrap-server localhost:9091 --describe --topic __consumer_offsets&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;Topic:__consumer_offsets PartitionCount:50 ReplicationFactor:1 Configs:compression.type=producer,cleanup.policy=compact,segment.bytes=104857600,retention.ms=1000,message.timestamp.type=LogAppendTime,delete.retention.ms=1000,segment.ms=60000&lt;/tt&gt;&lt;/p&gt;</comment>
                            <comment id="16896827" author="ijuma" created="Wed, 31 Jul 2019 06:58:50 +0000"  >&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hachikuji&quot; class=&quot;user-hover&quot; rel=&quot;hachikuji&quot;&gt;hachikuji&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mumrah&quot; class=&quot;user-hover&quot; rel=&quot;mumrah&quot;&gt;mumrah&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16899151" author="enether" created="Fri, 2 Aug 2019 19:13:04 +0000"  >&lt;p&gt;I&apos;ve got a separate Jira/PR for improving the log cleaner&apos;s behavior on such an error -&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-8725&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-8725&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16917085" author="hachikuji" created="Tue, 27 Aug 2019 20:32:38 +0000"  >&lt;p&gt;There is a race condition here, but I&apos;m not sure I can explain how it could be regularly hit. When the log cleaner attempts to collect the non-active segments, it calls `&lt;tt&gt;log.logSegments(firstDirtyOffset, log.activeSegment.baseOffset)&lt;/tt&gt;`. Since it&apos;s not holding the log lock, a log roll might invalidate the expectation that the active segment base offset is larger than the dirty offset. I&apos;m guessing the fact that the log directory was wiped is also playing a factor here breaking normal offset assumptions. For example, the checkpointed dirty offset may have gotten well ahead of an empty log. It wouldn&apos;t surprise me to find some unprotected cases when that happens. I will submit a patch to fix the known race condition and improve error logging a little bit so we&apos;ll have more to go on if we miss a case.&lt;/p&gt;</comment>
                            <comment id="16917940" author="githubbot" created="Wed, 28 Aug 2019 17:12:05 +0000"  >&lt;p&gt;hachikuji commented on pull request #7264: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-8724&quot; title=&quot;log cleaner thread dies when attempting to clean a __consumer_offsets partition after upgrade from 2.0-&amp;gt;2.3&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-8724&quot;&gt;&lt;del&gt;KAFKA-8724&lt;/del&gt;&lt;/a&gt;; Improve range checking when computing cleanable partitions&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/7264&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/7264&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   This patch contains a few improvements on the offset range handling when computing the cleanable range of offsets.&lt;/p&gt;

&lt;p&gt;   1. It adds bounds checking to ensure the dirty offset cannot be larger than the log end offset. If it is, we reset to the log start offset.&lt;br/&gt;
   2. It adds a method to get the non-active segments in the log while holding the lock. This ensures that a truncation cannot lead to an invalid segment range.&lt;br/&gt;
   3. It improves exception messages in the case that an inconsistent segment range is provided so that we have more information to find the root cause.&lt;/p&gt;

&lt;p&gt;   The patch also fixes a few problems in `LogCleanerManagerTest` due to unintended reuse of the underlying log directory.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16923578" author="githubbot" created="Thu, 5 Sep 2019 16:10:59 +0000"  >&lt;p&gt;hachikuji commented on pull request #7264: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-8724&quot; title=&quot;log cleaner thread dies when attempting to clean a __consumer_offsets partition after upgrade from 2.0-&amp;gt;2.3&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-8724&quot;&gt;&lt;del&gt;KAFKA-8724&lt;/del&gt;&lt;/a&gt;; Improve range checking when computing cleanable partitions&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/7264&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/7264&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12976086" name="KAFKA-308-stack-trace.txt" size="2019" author="keithks" created="Mon, 29 Jul 2019 02:55:50 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 10 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z053w8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>