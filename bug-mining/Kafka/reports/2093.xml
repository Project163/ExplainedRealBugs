<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:15:58 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-7165] Error while creating ephemeral at /brokers/ids/BROKER_ID</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-7165</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Kafka version: 1.1.0&lt;/p&gt;

&lt;p&gt;Zookeeper version: 3.4.12&lt;/p&gt;

&lt;p&gt;4 Kafka Brokers&lt;/p&gt;

&lt;p&gt;4 Zookeeper servers&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;In one of the 4 brokers of the cluster, we detect the following error:&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;2018-07-14 04:38:23,784&amp;#93;&lt;/span&gt; INFO Unable to read additional data from server sessionid 0x3000c2420cb458d, likely server has closed socket, closing socket connection and attempting reconnect (org.apache.zookeeper.ClientCnxn)&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;2018-07-14 04:38:24,509&amp;#93;&lt;/span&gt; INFO Opening socket connection to server &lt;b&gt;ZOOKEEPER_SERVER_1:PORT&lt;/b&gt;. Will not attempt to authenticate using SASL (unknown error) (org.apache.zookeeper.ClientCnxn)&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;2018-07-14 04:38:24,510&amp;#93;&lt;/span&gt; INFO Socket connection established to &lt;b&gt;ZOOKEEPER_SERVER_1:PORT&lt;/b&gt;, initiating session (org.apache.zookeeper.ClientCnxn)&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;2018-07-14 04:38:24,513&amp;#93;&lt;/span&gt; INFO Unable to read additional data from server sessionid 0x3000c2420cb458d, likely server has closed socket, closing socket connection and attempting reconnect (org.apache.zookeeper.ClientCnxn)&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;2018-07-14 04:38:25,287&amp;#93;&lt;/span&gt; INFO Opening socket connection to server &lt;b&gt;ZOOKEEPER_SERVER_2:PORT&lt;/b&gt;. Will not attempt to authenticate using SASL (unknown error) (org.apache.zookeeper.ClientCnxn)&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;2018-07-14 04:38:25,287&amp;#93;&lt;/span&gt; INFO Socket connection established to &lt;b&gt;ZOOKEEPER_SERVER_2:PORT&lt;/b&gt;, initiating session (org.apache.zookeeper.ClientCnxn)&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;2018-07-14 04:38:25,954&amp;#93;&lt;/span&gt; INFO &lt;a href=&quot;#* broker=1&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Partition TOPIC_NAME-PARTITION-# broker=1&lt;/a&gt; Shrinking ISR from 1,3,4,2 to 1,4,2 (kafka.cluster.Partition)&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;2018-07-14 04:38:26,444&amp;#93;&lt;/span&gt; WARN Unable to reconnect to ZooKeeper service, session 0x3000c2420cb458d has expired (org.apache.zookeeper.ClientCnxn)&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;2018-07-14 04:38:26,444&amp;#93;&lt;/span&gt; INFO Unable to reconnect to ZooKeeper service, session 0x3000c2420cb458d has expired, closing socket connection (org.apache.zookeeper.ClientCnxn)&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;2018-07-14 04:38:26,445&amp;#93;&lt;/span&gt; INFO EventThread shut down for session: 0x3000c2420cb458d (org.apache.zookeeper.ClientCnxn)&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;2018-07-14 04:38:26,446&amp;#93;&lt;/span&gt; INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;ZooKeeperClient&amp;#93;&lt;/span&gt; Session expired. (kafka.zookeeper.ZooKeeperClient)&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;2018-07-14 04:38:26,459&amp;#93;&lt;/span&gt; INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;ZooKeeperClient&amp;#93;&lt;/span&gt; Initializing a new session to &lt;b&gt;ZOOKEEPER_SERVER_1:PORT&lt;/b&gt;,&lt;b&gt;ZOOKEEPER_SERVER_2:PORT&lt;/b&gt;,&lt;b&gt;ZOOKEEPER_SERVER_3:PORT&lt;/b&gt;,&lt;b&gt;ZOOKEEPER_SERVER_4:PORT&lt;/b&gt;. (kafka.zookeeper.ZooKeeperClient)&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;2018-07-14 04:38:26,459&amp;#93;&lt;/span&gt; INFO Initiating client connection, connectString=&lt;b&gt;ZOOKEEPER_SERVER_1:PORT&lt;/b&gt;,&lt;b&gt;ZOOKEEPER_SERVER_2:PORT&lt;/b&gt;,&lt;b&gt;ZOOKEEPER_SERVER_3:PORT&lt;/b&gt;,&lt;b&gt;ZOOKEEPER_SERVER_4:PORT&lt;/b&gt; sessionTimeout=6000 watcher=kafka.zookeeper.ZooKeeperClient$ZooKeeperClientWatcher$@44821a96 (org.apache.zookeeper.ZooKeeper)&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;2018-07-14 04:38:26,465&amp;#93;&lt;/span&gt; INFO Opening socket connection to server &lt;b&gt;ZOOKEEPER_SERVER_1:PORT&lt;/b&gt;. Will not attempt to authenticate using SASL (unknown error) (org.apache.zookeeper.ClientCnxn)&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;2018-07-14 04:38:26,477&amp;#93;&lt;/span&gt; INFO Socket connection established to &lt;b&gt;ZOOKEEPER_SERVER_1:PORT&lt;/b&gt;, initiating session (org.apache.zookeeper.ClientCnxn)&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;2018-07-14 04:38:26,484&amp;#93;&lt;/span&gt; INFO Session establishment complete on server &lt;b&gt;ZOOKEEPER_SERVER_1:PORT&lt;/b&gt;, sessionid = 0x4005b59eb6a0000, negotiated timeout = 6000 (org.apache.zookeeper.ClientCnxn)&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;2018-07-14 04:38:26,496&amp;#93;&lt;/span&gt; &lt;b&gt;INFO Creating /brokers/ids/1&lt;/b&gt; (is it secure? false) (kafka.zk.KafkaZkClient)&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;2018-07-14 04:38:26,500&amp;#93;&lt;/span&gt; INFO Processing notification(s) to /config/changes (kafka.common.ZkNodeChangeNotificationListener)&lt;br/&gt;
 &lt;b&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;2018-07-14 04:38:26,547&amp;#93;&lt;/span&gt; ERROR Error while creating ephemeral at /brokers/ids/1, node already exists and owner &apos;216186131422332301&apos; does not match current session &apos;288330817911521280&apos; (kafka.zk.KafkaZkClient$CheckedEphemeral)&lt;/b&gt;&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;2018-07-14 04:38:26,547&amp;#93;&lt;/span&gt; &lt;b&gt;INFO Result of znode creation at /brokers/ids/1 is: NODEEXISTS&lt;/b&gt; (kafka.zk.KafkaZkClient)&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;2018-07-14 04:38:26,559&amp;#93;&lt;/span&gt; ERROR Uncaught exception in scheduled task &apos;isr-expiration&apos; (kafka.utils.KafkaScheduler)&lt;/p&gt;

&lt;p&gt;org.apache.zookeeper.KeeperException$SessionExpiredException: KeeperErrorCode = Session expired for /brokers/topics/&lt;b&gt;TOPIC_NAME&lt;/b&gt;/partitions/&lt;b&gt;PARTITION-#&lt;/b&gt;/state&lt;br/&gt;
 at org.apache.zookeeper.KeeperException.create(KeeperException.java:127)&lt;br/&gt;
 at org.apache.zookeeper.KeeperException.create(KeeperException.java:51)&lt;br/&gt;
 at kafka.zookeeper.AsyncResponse.resultException(ZooKeeperClient.scala:465)&lt;br/&gt;
 at kafka.zk.KafkaZkClient.conditionalUpdatePath(KafkaZkClient.scala:621)&lt;br/&gt;
 at kafka.utils.ReplicationUtils$.updateLeaderAndIsr(ReplicationUtils.scala:33)&lt;br/&gt;
 at kafka.cluster.Partition.kafka$cluster$Partition$$updateIsr(Partition.scala:669)&lt;br/&gt;
 at kafka.cluster.Partition$$anonfun$4.apply$mcZ$sp(Partition.scala:513)&lt;br/&gt;
 at kafka.cluster.Partition$$anonfun$4.apply(Partition.scala:504)&lt;br/&gt;
 at kafka.cluster.Partition$$anonfun$4.apply(Partition.scala:504)&lt;br/&gt;
 at kafka.utils.CoreUtils$.inLock(CoreUtils.scala:250)&lt;br/&gt;
 at kafka.utils.CoreUtils$.inWriteLock(CoreUtils.scala:258)&lt;br/&gt;
 at kafka.cluster.Partition.maybeShrinkIsr(Partition.scala:503)&lt;br/&gt;
 at kafka.server.ReplicaManager$$anonfun$kafka$server$ReplicaManager$$maybeShrinkIsr$2.apply(ReplicaManager.scala:1335)&lt;br/&gt;
 at kafka.server.ReplicaManager$$anonfun$kafka$server$ReplicaManager$$maybeShrinkIsr$2.apply(ReplicaManager.scala:1335)&lt;br/&gt;
 at scala.collection.Iterator$class.foreach(Iterator.scala:891)&lt;br/&gt;
 at scala.collection.AbstractIterator.foreach(Iterator.scala:1334)&lt;br/&gt;
 at kafka.server.ReplicaManager.kafka$server$ReplicaManager$$maybeShrinkIsr(ReplicaManager.scala:1335)&lt;br/&gt;
 at kafka.server.ReplicaManager$$anonfun$2.apply$mcV$sp(ReplicaManager.scala:322)&lt;br/&gt;
 at kafka.utils.KafkaScheduler$$anonfun$1.apply$mcV$sp(KafkaScheduler.scala:110)&lt;br/&gt;
 at kafka.utils.CoreUtils$$anon$1.run(CoreUtils.scala:62)&lt;br/&gt;
 at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)&lt;br/&gt;
 at java.util.concurrent.FutureTask.runAndReset(FutureTask.java:308)&lt;br/&gt;
 at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$301(ScheduledThreadPoolExecutor.java:180)&lt;br/&gt;
 at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:294)&lt;br/&gt;
 at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)&lt;br/&gt;
 at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)&lt;br/&gt;
 at java.lang.Thread.run(Thread.java:748)&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;2018-07-14 04:38:45,938&amp;#93;&lt;/span&gt; INFO &lt;a href=&quot;#* broker=1&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Partition TOPIC_NAME-PARTITION-# broker=1&lt;/a&gt; Shrinking ISR from 1,3,4,2 to 1 (kafka.cluster.Partition)&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;2018-07-14 04:38:45,952&amp;#93;&lt;/span&gt; INFO &lt;a href=&quot;#* broker=1&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Partition TOPIC_NAME-PARTITION-# broker=1&lt;/a&gt; Cached zkVersion &lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt; not equal to that in zookeeper, skip updating ISR (kafka.cluster.Partition)&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;2018-07-14 04:38:45,952&amp;#93;&lt;/span&gt; INFO &lt;a href=&quot;#* broker=1&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Partition __consumer_offsets-# broker=1&lt;/a&gt; Shrinking ISR from 1,2,3,4 to 1 (kafka.cluster.Partition)&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;2018-07-14 04:38:45,992&amp;#93;&lt;/span&gt; INFO &lt;a href=&quot;#* broker=1&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Partition __consumer_offsets-# broker=1&lt;/a&gt; Cached zkVersion &lt;span class=&quot;error&quot;&gt;&amp;#91;139&amp;#93;&lt;/span&gt; not equal to that in zookeeper, skip updating ISR (kafka.cluster.Partition)&lt;/p&gt;

&lt;p&gt;...&lt;/p&gt;

&lt;p&gt;...&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The previous exception continues showing constantly without stopping. Since the cluster was still up, I have left the error showing up for about 6 hours to check if the broker recovers itself.&lt;/p&gt;

&lt;p&gt;The only solution, to put back the broker into the cluster, was restarting.&lt;/p&gt;

&lt;p&gt;After the restart, the replicas sync each other and the broker was able to serve again.&lt;/p&gt;

&lt;p&gt;I imagine this is not a normal behavior.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13172275">KAFKA-7165</key>
            <summary>Error while creating ephemeral at /brokers/ids/BROKER_ID</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="pachilo">Jonathan Santilli</assignee>
                                    <reporter username="pachilo">Jonathan Santilli</reporter>
                        <labels>
                    </labels>
                <created>Sun, 15 Jul 2018 19:45:06 +0000</created>
                <updated>Mon, 19 Nov 2018 18:47:54 +0000</updated>
                            <resolved>Thu, 8 Nov 2018 21:30:23 +0000</resolved>
                                    <version>1.1.0</version>
                                    <fixVersion>2.2.0</fixVersion>
                                    <component>core</component>
                    <component>zkclient</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>13</watches>
                                                                                                                <comments>
                            <comment id="16551591" author="omkreddy" created="Sat, 21 Jul 2018 09:12:21 +0000"  >&lt;p&gt;Looks like related to&#160;&lt;b&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6584&quot; title=&quot;Session expiration concurrent with ZooKeeper leadership failover may lead to broker registration failure&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-6584&quot;&gt;&lt;del&gt;KAFKA-6584&lt;/del&gt;&lt;/a&gt;&lt;/b&gt;&lt;/p&gt;</comment>
                            <comment id="16552070" author="pachilo" created="Sun, 22 Jul 2018 16:39:21 +0000"  >&lt;p&gt;Yes, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=omkreddy&quot; class=&quot;user-hover&quot; rel=&quot;omkreddy&quot;&gt;omkreddy&lt;/a&gt; seems to be related, do you know what&apos;s the status of this? I mean, is somebody working on it? if not, I would like to collaborate, if feasible.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Cheers!&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16552098" author="omkreddy" created="Sun, 22 Jul 2018 17:35:36 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pachilo&quot; class=&quot;user-hover&quot; rel=&quot;pachilo&quot;&gt;pachilo&lt;/a&gt;&#160; I&#160;think we are waiting for&#160;&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2985&quot; title=&quot;Expired session may unexpired after leader failover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2985&quot;&gt;ZOOKEEPER-2985&lt;/a&gt;&#160; fix.&#160; If you are interested, you can work on handling&#160;the edge case&#160;on Kafka side.&lt;/p&gt;</comment>
                            <comment id="16552101" author="ijuma" created="Sun, 22 Jul 2018 17:40:56 +0000"  >&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=junrao&quot; class=&quot;user-hover&quot; rel=&quot;junrao&quot;&gt;junrao&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cmccabe&quot; class=&quot;user-hover&quot; rel=&quot;cmccabe&quot;&gt;cmccabe&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16552161" author="pachilo" created="Sun, 22 Jul 2018 21:22:21 +0000"  >&lt;p&gt;Ok &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=omkreddy&quot; class=&quot;user-hover&quot; rel=&quot;omkreddy&quot;&gt;omkreddy&lt;/a&gt;, I will get myself familiarized with the code to understand the edge case you are mentioning.&lt;/p&gt;</comment>
                            <comment id="16561206" author="pachilo" created="Sun, 29 Jul 2018 17:42:25 +0000"  >&lt;p&gt;Hello &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=omkreddy&quot; class=&quot;user-hover&quot; rel=&quot;omkreddy&quot;&gt;omkreddy&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Before doing any code, I would like to share with you all, what I have verified.&lt;/p&gt;

&lt;p&gt;At the&#160;&lt;b&gt;kafka.zk.KafkaZkClient&lt;/b&gt; class, when the broker needs to be registered:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
def registerBroker(brokerInfo: BrokerInfo): Unit = {
 val path = brokerInfo.path
 checkedEphemeralCreate(path, brokerInfo.toJsonBytes)
 info(s&lt;span class=&quot;code-quote&quot;&gt;&quot;Registered broker ${brokerInfo.broker.id} at path $path with addresses: ${brokerInfo.broker.endPoints}&quot;&lt;/span&gt;)
}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;The method:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; def checkedEphemeralCreate(path: &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, data: Array[&lt;span class=&quot;code-object&quot;&gt;Byte&lt;/span&gt;]): Unit = {
 val checkedEphemeral = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CheckedEphemeral(path, data)
 info(s&lt;span class=&quot;code-quote&quot;&gt;&quot;Creating $path (is it secure? $isSecure)&quot;&lt;/span&gt;)
 val code = checkedEphemeral.create()
 info(s&lt;span class=&quot;code-quote&quot;&gt;&quot;Result of znode creation at $path is: $code&quot;&lt;/span&gt;)
 &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (code != Code.OK)
 &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; KeeperException.create(code)
}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Is already checking if the node creation code was successful:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (code != Code.OK)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;What you all think about first checking if the code&#160;is equal to NODEEXISTS:&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (code == Code.NODEEXISTS)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;If that the case, delete that ephemeral node (&lt;em&gt;/brokers/ids/BROKER_ID&lt;/em&gt;) in Zookeeper, and then trying to register the broker again.&lt;/p&gt;

&lt;p&gt;The&#160;ephemeral node (&lt;em&gt;/brokers/ids/BROKER_ID&lt;/em&gt;) is associated with the expired/previous session, that&apos;s what I do not know if that makes sense/or possible to do.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The method will look like:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; def checkedEphemeralCreate(path: &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, data: Array[&lt;span class=&quot;code-object&quot;&gt;Byte&lt;/span&gt;]): Unit = {
 val checkedEphemeral = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CheckedEphemeral(path, data)
 info(s&lt;span class=&quot;code-quote&quot;&gt;&quot;Creating $path (is it secure? $isSecure)&quot;&lt;/span&gt;)
 val code = checkedEphemeral.create()
 info(s&lt;span class=&quot;code-quote&quot;&gt;&quot;Result of znode creation at $path is: $code&quot;&lt;/span&gt;)

 &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (code == Code.NODEEXISTS) {
   checkedEphemeral.delete() &lt;span class=&quot;code-comment&quot;&gt;// Not yet created method
&lt;/span&gt;   code = checkedEphemeral.create()
   info(s&lt;span class=&quot;code-quote&quot;&gt;&quot;Result of znode re-creation at $path is: $code&quot;&lt;/span&gt;)
 }

 &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (code != Code.OK)
   &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; KeeperException.create(code)
}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;How that looks like?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16563458" author="omkreddy" created="Tue, 31 Jul 2018 10:45:36 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pachilo&quot; class=&quot;user-hover&quot; rel=&quot;pachilo&quot;&gt;pachilo&lt;/a&gt;&#160; &#160;your solution may work, but we should be careful not to remove the ephemeral nodes created by another broker. if someone starts a broker with same brokerId, then the registration should fail.&#160;&lt;/p&gt;

&lt;p&gt;Another option is to maintain previous zk session id and do a check &lt;a href=&quot;https://github.com/apache/kafka/blob/90e0bbec94dd85e1c5b1af0b6426df0a02e5da3f/core/src/main/scala/kafka/zk/KafkaZkClient.scala#L1512&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;br/&gt;
 If the owner matches with previous sessionID, we can delete and recreate the node.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cthunes&quot; class=&quot;user-hover&quot; rel=&quot;cthunes&quot;&gt;cthunes&lt;/a&gt;&#160; Since you have analyzed the &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2985&quot; title=&quot;Expired session may unexpired after leader failover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2985&quot;&gt;ZOOKEEPER-2985&lt;/a&gt;, any thoughts on handling this on Kafka side. also can you share the code to reproduce this this issue?&lt;/p&gt;</comment>
                            <comment id="16564932" author="pachilo" created="Wed, 1 Aug 2018 08:13:34 +0000"  >&lt;p&gt;Sure &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=omkreddy&quot; class=&quot;user-hover&quot; rel=&quot;omkreddy&quot;&gt;omkreddy&lt;/a&gt; , it makes sense, some misconfiguration could lead having two or more brokers with the same id (not ideal situation).&lt;/p&gt;

&lt;p&gt;I will wait for &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cthunes&quot; class=&quot;user-hover&quot; rel=&quot;cthunes&quot;&gt;cthunes&lt;/a&gt; opinion and considerations.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Cheers!&lt;/p&gt;</comment>
                            <comment id="16570381" author="cthunes" created="Mon, 6 Aug 2018 15:45:06 +0000"  >&lt;p&gt;One option would be to put a retry mechanism around the broker registration. When this bug is triggered, the existing (conflicting) node will be an ephemeral node associated with the old session. This session will eventually re-expire (since the client has established a new session to replace it) at which time the old broker ID node will be deleted.&lt;/p&gt;

&lt;p&gt;This expiration should take at most a bit longer than the configured session timeout.&lt;/p&gt;

&lt;p&gt;If two brokers have been misconfigured with the same broker ID than the first server will be registered and the second will be stuck retrying indefinitely (or until the first server stops).&lt;/p&gt;</comment>
                            <comment id="16571905" author="pachilo" created="Tue, 7 Aug 2018 16:12:13 +0000"  >&lt;p&gt;Hello &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=omkreddy&quot; class=&quot;user-hover&quot; rel=&quot;omkreddy&quot;&gt;omkreddy&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cthunes&quot; class=&quot;user-hover&quot; rel=&quot;cthunes&quot;&gt;cthunes&lt;/a&gt; , thanks a lot for the feedback.&lt;/p&gt;

&lt;p&gt;According to the opinions, what could be the next step?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Cheers!&lt;/p&gt;</comment>
                            <comment id="16587940" author="pachilo" created="Tue, 21 Aug 2018 20:02:47 +0000"  >&lt;p&gt;Hi, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=omkreddy&quot; class=&quot;user-hover&quot; rel=&quot;omkreddy&quot;&gt;omkreddy&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ijuma&quot; class=&quot;user-hover&quot; rel=&quot;ijuma&quot;&gt;ijuma&lt;/a&gt;, am working on a PR, who can help me and assign this Jira to me? I can not do it by myself.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Cheers!&lt;/p&gt;</comment>
                            <comment id="16588600" author="omkreddy" created="Wed, 22 Aug 2018 09:14:11 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pachilo&quot; class=&quot;user-hover&quot; rel=&quot;pachilo&quot;&gt;pachilo&lt;/a&gt; Please send a mail to dev mailing list for Jira access.&lt;/p&gt;</comment>
                            <comment id="16591643" author="pachilo" created="Fri, 24 Aug 2018 13:21:59 +0000"  >&lt;p&gt;Done &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=omkreddy&quot; class=&quot;user-hover&quot; rel=&quot;omkreddy&quot;&gt;omkreddy&lt;/a&gt;, let&apos;s wait, thanks!&lt;/p&gt;</comment>
                            <comment id="16593009" author="githubbot" created="Sun, 26 Aug 2018 19:46:52 +0000"  >&lt;p&gt;jonathansantilli opened a new pull request #5575: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7165&quot; title=&quot;Error while creating ephemeral at /brokers/ids/BROKER_ID&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7165&quot;&gt;&lt;del&gt;KAFKA-7165&lt;/del&gt;&lt;/a&gt;: Retry the BrokerInfo registration into ZooKeeper&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5575&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5575&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   The following is a proposal when the ZooKeeper session has changed and the Broker tries to register himself into ZooKeeper.&lt;/p&gt;

&lt;p&gt;   Currently, this throws a `NodeExistsException` since a Broker with the same id got registered previously into Zookeeper.&lt;/p&gt;

&lt;p&gt;   *&lt;b&gt;Assuming Broker id = 1&lt;/b&gt;*&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;If a Broker using this patch retries to register himself into ZooKeeper and the previous ZooKeeper session was not the one that registers the Broker (another Broker with the same id did), the Broker won&apos;t be allowed to register and a `NodeExistsException` will be generated.&lt;/li&gt;
	&lt;li&gt;If a Broker using this patch retries to register himself into ZooKeeper and the previous ZooKeeper session was the one that registers the Broker, the ephemeral node will be deleted from ZooKeeper and re-created by the Broker.&lt;/li&gt;
	&lt;li&gt;If a Broker *&lt;b&gt;not&lt;/b&gt;* using this patch retries to register himself into ZooKeeper and the previous ZooKeeper session was not the one that registers the Broker (another Broker with the same id did), the Broker won&apos;t be allowed to register and a `NodeExistsException` will be generated.&lt;/li&gt;
&lt;/ul&gt;



&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16661931" author="pachilo" created="Wed, 24 Oct 2018 08:30:36 +0000"  >&lt;p&gt;Hello Jun Rao, I would like to continue working on this bug, hope you can have some time to elaborate a little bit&#160;more your proposal from &lt;a href=&quot;https://github.com/apache/kafka/pull/5575#issuecomment-416419017:&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5575#issuecomment-416419017:&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;An alternative approach is to retry the creation of the ephemeral node up to sth like twice the session timeout. It may take a bit long for the broker to be re-registered. However, it seems it&apos;s a bit safer and simpler, until ZOOKEEPER-2985 is fixed.&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Cheers,&lt;/p&gt;

&lt;p&gt;&#8211;&lt;/p&gt;

&lt;p&gt;Jonathan&lt;/p&gt;</comment>
                            <comment id="16667914" author="junrao" created="Tue, 30 Oct 2018 00:00:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pachilo&quot; class=&quot;user-hover&quot; rel=&quot;pachilo&quot;&gt;pachilo&lt;/a&gt;, your PR actually looks reasonable for addressing the issue of creating the ephemeral node. I am not sure if it addresses the&#160;org.apache.zookeeper.KeeperException$SessionExpiredException in the isr expiration thread. The failure of the creation of the&#160;ephemeral node shouldn&apos;t prevent the new ZK session being created. So, I am wondering why the SessionExpiredException continued for 6 hours. Were there extended network issue with the ZK cluster?&lt;/p&gt;</comment>
                            <comment id="16668672" author="pachilo" created="Tue, 30 Oct 2018 12:58:54 +0000"  >&lt;p&gt;Thanks for your reply &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=junrao&quot; class=&quot;user-hover&quot; rel=&quot;junrao&quot;&gt;junrao&lt;/a&gt; ,&#160;that was the only time we had that issue of the&#160;&lt;em&gt;org.apache.zookeeper.KeeperException$SessionExpiredException&lt;/em&gt; so far.&lt;/p&gt;

&lt;p&gt;Now we are in version 2.0 of Kafka and from time to time suffering the&#160;&lt;b&gt;NODEEXISTS&lt;/b&gt; issue.&lt;/p&gt;

&lt;p&gt;Maybe the errors were related but difficult to ensure that, hopefully with the fix, we can get rid of the&#160;&lt;b&gt;NODEEXISTS&lt;/b&gt; error.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Cheers!&lt;/p&gt;</comment>
                            <comment id="16680420" author="githubbot" created="Thu, 8 Nov 2018 21:28:40 +0000"  >&lt;p&gt;junrao closed pull request #5575: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7165&quot; title=&quot;Error while creating ephemeral at /brokers/ids/BROKER_ID&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7165&quot;&gt;&lt;del&gt;KAFKA-7165&lt;/del&gt;&lt;/a&gt;: Retry the BrokerInfo registration into ZooKeeper&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5575&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5575&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/core/src/main/scala/kafka/zk/KafkaZkClient.scala b/core/src/main/scala/kafka/zk/KafkaZkClient.scala&lt;br/&gt;
index a12abb43963..4ad40ef6dad 100644&lt;br/&gt;
&amp;#8212; a/core/src/main/scala/kafka/zk/KafkaZkClient.scala&lt;br/&gt;
+++ b/core/src/main/scala/kafka/zk/KafkaZkClient.scala&lt;br/&gt;
@@ -53,7 +53,7 @@ import scala.collection.JavaConverters._&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;easier to quickly migrate away from `ZkUtils`. We should revisit this once the migration is completed and tests are&lt;/li&gt;
	&lt;li&gt;in place. We should also consider whether a monolithic [&lt;span class=&quot;error&quot;&gt;&amp;#91;kafka.zk.ZkData&amp;#93;&lt;/span&gt;] is the way to go.&lt;br/&gt;
  */&lt;br/&gt;
-class KafkaZkClient private (zooKeeperClient: ZooKeeperClient, isSecure: Boolean, time: Time) extends AutoCloseable with&lt;br/&gt;
+class KafkaZkClient private&lt;span class=&quot;error&quot;&gt;&amp;#91;zk&amp;#93;&lt;/span&gt; (zooKeeperClient: ZooKeeperClient, isSecure: Boolean, time: Time) extends AutoCloseable with&lt;br/&gt;
   Logging with KafkaMetricsGroup {&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;   override def metricName(name: String, metricTags: scala.collection.Map&lt;span class=&quot;error&quot;&gt;&amp;#91;String, String&amp;#93;&lt;/span&gt;): MetricName = {&lt;br/&gt;
@@ -67,6 +67,12 @@ class KafkaZkClient private (zooKeeperClient: ZooKeeperClient, isSecure: Boolean&lt;br/&gt;
   // Only for testing&lt;br/&gt;
   private&lt;span class=&quot;error&quot;&gt;&amp;#91;kafka&amp;#93;&lt;/span&gt; def currentZooKeeper: ZooKeeper = zooKeeperClient.currentZooKeeper&lt;/p&gt;

&lt;p&gt;+  // This variable holds the Zookeeper session id at the moment a Broker gets registered in Zookeeper and the subsequent&lt;br/&gt;
+  // updates of the session id. It is possible that the session id changes over the time for &apos;Session expired&apos;.&lt;br/&gt;
+  // This code is part of the work around done in the &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7165&quot; title=&quot;Error while creating ephemeral at /brokers/ids/BROKER_ID&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7165&quot;&gt;&lt;del&gt;KAFKA-7165&lt;/del&gt;&lt;/a&gt;, once &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2985&quot; title=&quot;Expired session may unexpired after leader failover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2985&quot;&gt;ZOOKEEPER-2985&lt;/a&gt; is complete, this code must&lt;br/&gt;
+  // be deleted.&lt;br/&gt;
+  private var currentZooKeeperSessionId: Long = -1&lt;br/&gt;
+&lt;br/&gt;
   /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Create a sequential persistent path. That is, the znode will not be automatically deleted upon client&apos;s disconnect&lt;/li&gt;
	&lt;li&gt;and a monotonically increasing number will be appended to its name.&lt;br/&gt;
@@ -1585,7 +1591,7 @@ class KafkaZkClient private (zooKeeperClient: ZooKeeperClient, isSecure: Boolean&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;   private def acls(path: String): Seq&lt;span class=&quot;error&quot;&gt;&amp;#91;ACL&amp;#93;&lt;/span&gt; = ZkData.defaultAcls(isSecure, path)&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private def retryRequestUntilConnected&lt;span class=&quot;error&quot;&gt;&amp;#91;Req &amp;lt;: AsyncRequest&amp;#93;&lt;/span&gt;(request: Req): Req#Response = {&lt;br/&gt;
+  private&lt;span class=&quot;error&quot;&gt;&amp;#91;zk&amp;#93;&lt;/span&gt; def retryRequestUntilConnected&lt;span class=&quot;error&quot;&gt;&amp;#91;Req &amp;lt;: AsyncRequest&amp;#93;&lt;/span&gt;(request: Req): Req#Response = 
{
     retryRequestsUntilConnected(Seq(request)).head
   }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;@@ -1631,26 +1637,94 @@ class KafkaZkClient private (zooKeeperClient: ZooKeeperClient, isSecure: Boolean&lt;br/&gt;
       throw KeeperException.create(code)&lt;br/&gt;
   }&lt;/p&gt;

&lt;p&gt;+  private def isZKSessionIdDiffFromCurrentZKSessionId(): Boolean = &lt;/p&gt;
{
+    zooKeeperClient.sessionId != currentZooKeeperSessionId
+  }
&lt;p&gt;+&lt;br/&gt;
+  private def isZKSessionTheEphemeralOwner(ephemeralOwnerId: Long): Boolean = &lt;/p&gt;
{
+    ephemeralOwnerId == currentZooKeeperSessionId
+  }
&lt;p&gt;+&lt;br/&gt;
+  private&lt;span class=&quot;error&quot;&gt;&amp;#91;zk&amp;#93;&lt;/span&gt; def shouldReCreateEphemeralZNode(ephemeralOwnerId: Long): Boolean = &lt;/p&gt;
{
+    isZKSessionTheEphemeralOwner(ephemeralOwnerId) &amp;amp;&amp;amp; isZKSessionIdDiffFromCurrentZKSessionId()
+  }
&lt;p&gt;+&lt;br/&gt;
+  private def updateCurrentZKSessionId(newSessionId: Long): Unit = &lt;/p&gt;
{
+    currentZooKeeperSessionId = newSessionId
+  }
&lt;p&gt;+&lt;br/&gt;
   private class CheckedEphemeral(path: String, data: Array&lt;span class=&quot;error&quot;&gt;&amp;#91;Byte&amp;#93;&lt;/span&gt;) extends Logging {&lt;br/&gt;
     def create(): Code = {&lt;br/&gt;
       val createRequest = CreateRequest(path, data, acls(path), CreateMode.EPHEMERAL)&lt;br/&gt;
       val createResponse = retryRequestUntilConnected(createRequest)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;createResponse.resultCode match {&lt;/li&gt;
	&lt;li&gt;case code@ Code.OK =&amp;gt; code&lt;/li&gt;
	&lt;li&gt;case Code.NODEEXISTS =&amp;gt; getAfterNodeExists()&lt;br/&gt;
+      val createResultCode = createResponse.resultCode match 
{
+        case code@ Code.OK =&amp;gt;
+          code
+        case Code.NODEEXISTS =&amp;gt;
+          getAfterNodeExists()
         case code =&amp;gt;
           error(s&quot;Error while creating ephemeral at $path with return code: $code&quot;)
           code
       }
&lt;p&gt;+&lt;br/&gt;
+      if (createResultCode == Code.OK) &lt;/p&gt;
{
+        // At this point, we need to save a reference to the zookeeper session id.
+        // This is done here since the Zookeeper session id may not be available at the Object creation time.
+        // This is assuming the &apos;retryRequestUntilConnected&apos; method got connected and a valid session id is present.
+        // This code is part of the workaround done in the KAFKA-7165, once ZOOKEEPER-2985 is complete, this code
+        // must be deleted.
+        updateCurrentZKSessionId(zooKeeperClient.sessionId)
+      }
&lt;p&gt;+&lt;br/&gt;
+      createResultCode&lt;br/&gt;
+    }&lt;br/&gt;
+&lt;br/&gt;
+    // This method is part of the work around done in the &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7165&quot; title=&quot;Error while creating ephemeral at /brokers/ids/BROKER_ID&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7165&quot;&gt;&lt;del&gt;KAFKA-7165&lt;/del&gt;&lt;/a&gt;, once &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2985&quot; title=&quot;Expired session may unexpired after leader failover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2985&quot;&gt;ZOOKEEPER-2985&lt;/a&gt; is complete, this code must&lt;br/&gt;
+    // be deleted.&lt;br/&gt;
+    private def delete(): Code = &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+      val deleteRequest = DeleteRequest(path, ZkVersion.MatchAnyVersion)+      val deleteResponse = retryRequestUntilConnected(deleteRequest)+      deleteResponse.resultCode match {
+        case code@ Code.OK =&amp;gt; code
+        case code@ Code.NONODE =&amp;gt; code
+        case code =&amp;gt;
+          error(s&quot;Error while deleting ephemeral node at $path with return code: $code&quot;)
+          code
+      }+    }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;+&lt;br/&gt;
+    private def reCreate(): Code = &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+      val codeAfterDelete = delete()+      var codeAfterReCreate = codeAfterDelete+      debug(s&amp;quot;Result of znode ephemeral deletion at $path is}&lt;/span&gt; &lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     private def getAfterNodeExists(): Code = {&lt;br/&gt;
       val getDataRequest = GetDataRequest(path)&lt;br/&gt;
       val getDataResponse = retryRequestUntilConnected(getDataRequest)&lt;br/&gt;
+      val ephemeralOwnerId = getDataResponse.stat.getEphemeralOwner&lt;br/&gt;
       getDataResponse.resultCode match {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;case Code.OK if getDataResponse.stat.getEphemeralOwner != zooKeeperClient.sessionId =&amp;gt;&lt;br/&gt;
+        // At this point, the Zookeeper session could be different (due a &apos;Session expired&apos;) from the one that initially&lt;br/&gt;
+        // registered the Broker into the Zookeeper ephemeral node, but the znode is still present in ZooKeeper.&lt;br/&gt;
+        // The expected behaviour is that Zookeeper server removes the ephemeral node associated with the expired session&lt;br/&gt;
+        // but due an already reported bug in Zookeeper (&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2985&quot; title=&quot;Expired session may unexpired after leader failover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2985&quot;&gt;ZOOKEEPER-2985&lt;/a&gt;) this is not happening, so, the following check&lt;br/&gt;
+        // will validate if this Broker got registered with the previous (expired) session and try to register again,&lt;br/&gt;
+        // deleting the ephemeral node and creating it again.&lt;br/&gt;
+        // This code is part of the work around done in the &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7165&quot; title=&quot;Error while creating ephemeral at /brokers/ids/BROKER_ID&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7165&quot;&gt;&lt;del&gt;KAFKA-7165&lt;/del&gt;&lt;/a&gt;, once &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2985&quot; title=&quot;Expired session may unexpired after leader failover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2985&quot;&gt;ZOOKEEPER-2985&lt;/a&gt; is complete, this code must&lt;br/&gt;
+        // be deleted.&lt;br/&gt;
+        case Code.OK if shouldReCreateEphemeralZNode(ephemeralOwnerId) =&amp;gt;&lt;br/&gt;
+          info(s&quot;Was not possible to create the ephemeral at $path, node already exists and owner &quot; +&lt;br/&gt;
+            s&quot;&apos;$ephemeralOwnerId&apos; does not match current session &apos;${zooKeeperClient.sessionId}&apos;&quot; +&lt;br/&gt;
+            s&quot;, trying to delete and re-create it with the newest Zookeeper session&quot;)&lt;br/&gt;
+          reCreate()&lt;br/&gt;
+        case Code.OK if ephemeralOwnerId != zooKeeperClient.sessionId =&amp;gt;&lt;br/&gt;
           error(s&quot;Error while creating ephemeral at $path, node already exists and owner &quot; +&lt;/li&gt;
	&lt;li&gt;s&quot;&apos;${getDataResponse.stat.getEphemeralOwner}&apos; does not match current session &apos;${zooKeeperClient.sessionId}&apos;&quot;)&lt;br/&gt;
+            s&quot;&apos;$ephemeralOwnerId&apos; does not match current session &apos;${zooKeeperClient.sessionId}&apos;&quot;)&lt;br/&gt;
           Code.NODEEXISTS&lt;br/&gt;
         case code@ Code.OK =&amp;gt; code&lt;br/&gt;
         case Code.NONODE =&amp;gt;&lt;br/&gt;
diff --git a/core/src/test/scala/unit/kafka/zk/KafkaZkClientTest.scala b/core/src/test/scala/unit/kafka/zk/KafkaZkClientTest.scala&lt;br/&gt;
index 61ca3bbb6f8..6de91597df9 100644
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/core/src/test/scala/unit/kafka/zk/KafkaZkClientTest.scala&lt;br/&gt;
+++ b/core/src/test/scala/unit/kafka/zk/KafkaZkClientTest.scala&lt;br/&gt;
@@ -59,6 +59,7 @@ class KafkaZkClientTest extends ZooKeeperTestHarness {&lt;br/&gt;
   val controllerEpochZkVersion = 0&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;   var otherZkClient: KafkaZkClient = _&lt;br/&gt;
+  var expiredSessionZkClient: ExpiredKafkaZkClient = _&lt;/p&gt;

&lt;p&gt;   @Before&lt;br/&gt;
   override def setUp(): Unit = {&lt;br/&gt;
@@ -66,6 +67,8 @@ class KafkaZkClientTest extends ZooKeeperTestHarness &lt;/p&gt;
{
     zkClient.createControllerEpochRaw(1)
     otherZkClient = KafkaZkClient(zkConnect, zkAclsEnabled.getOrElse(JaasUtils.isZkSecurityEnabled), zkSessionTimeout,
       zkConnectionTimeout, zkMaxInFlightRequests, Time.SYSTEM)
+    expiredSessionZkClient = ExpiredKafkaZkClient(zkConnect, zkAclsEnabled.getOrElse(JaasUtils.isZkSecurityEnabled),
+      zkSessionTimeout, zkConnectionTimeout, zkMaxInFlightRequests, Time.SYSTEM)
   }

&lt;p&gt;   @After&lt;br/&gt;
@@ -73,6 +76,8 @@ class KafkaZkClientTest extends ZooKeeperTestHarness &lt;/p&gt;
{
     if (otherZkClient != null)
       otherZkClient.close()
     zkClient.deletePath(ControllerEpochZNode.path)
+    if (expiredSessionZkClient != null)
+      expiredSessionZkClient.close()
     super.tearDown()
   }

&lt;p&gt;@@ -683,6 +688,31 @@ class KafkaZkClientTest extends ZooKeeperTestHarness &lt;/p&gt;
{
     assertEquals(Some(brokerInfo.broker), zkClient.getBroker(1))
   }

&lt;p&gt;+  @Test&lt;br/&gt;
+  def testRetryRegisterBrokerInfo(): Unit = &lt;/p&gt;
{
+    val brokerId = 5
+    val brokerPort = 9999
+    val brokerHost = &quot;test.host&quot;
+    val expiredBrokerInfo = createBrokerInfo(brokerId, brokerHost, brokerPort, SecurityProtocol.PLAINTEXT)
+    expiredSessionZkClient.createTopLevelPaths()
+
+    // Register the broker, for the first time
+    expiredSessionZkClient.registerBroker(expiredBrokerInfo)
+    assertEquals(Some(expiredBrokerInfo.broker), expiredSessionZkClient.getBroker(brokerId))
+    val originalCzxid = expiredSessionZkClient.getPathCzxid(BrokerIdZNode.path(brokerId))
+
+    // Here, the node exists already, when trying to register under a different session id,
+    // the node will be deleted and created again using the new session id.
+    expiredSessionZkClient.registerBroker(expiredBrokerInfo)
+
+    // The broker info should be the same, no error should be raised
+    assertEquals(Some(expiredBrokerInfo.broker), expiredSessionZkClient.getBroker(brokerId))
+    val newCzxid = expiredSessionZkClient.getPathCzxid(BrokerIdZNode.path(brokerId))
+
+    assertNotEquals(&quot;The Czxid of original ephemeral znode should be different &quot; +
+      &quot;from the new ephemeral znode Czxid&quot;, originalCzxid, newCzxid)
+  }
&lt;p&gt;+&lt;br/&gt;
   @Test&lt;br/&gt;
   def testGetBrokerMethods(): Unit = {&lt;br/&gt;
     zkClient.createTopLevelPaths()&lt;br/&gt;
@@ -1112,4 +1142,34 @@ class KafkaZkClientTest extends ZooKeeperTestHarness &lt;/p&gt;
{
 
     assertEquals(expectedConsumerGroupOffsetsPath, actualConsumerGroupOffsetsPath)
   }
&lt;p&gt;+&lt;br/&gt;
+  class ExpiredKafkaZkClient private (zooKeeperClient: ZooKeeperClient, isSecure: Boolean, time: Time)&lt;br/&gt;
+    extends KafkaZkClient(zooKeeperClient, isSecure, time) {&lt;br/&gt;
+    // Overwriting this method from the parent class to force the client to re-register the Broker.&lt;br/&gt;
+    override def shouldReCreateEphemeralZNode(ephemeralOwnerId: Long): Boolean = &lt;/p&gt;
{
+      true
+    }
&lt;p&gt;+&lt;br/&gt;
+    def getPathCzxid(path: String): Long = &lt;/p&gt;
{
+      val getDataRequest = GetDataRequest(path)
+      val getDataResponse = retryRequestUntilConnected(getDataRequest)
+
+      getDataResponse.stat.getCzxid
+    }
&lt;p&gt;+  }&lt;br/&gt;
+&lt;br/&gt;
+  private object ExpiredKafkaZkClient {&lt;br/&gt;
+    def apply(connectString: String,&lt;br/&gt;
+              isSecure: Boolean,&lt;br/&gt;
+              sessionTimeoutMs: Int,&lt;br/&gt;
+              connectionTimeoutMs: Int,&lt;br/&gt;
+              maxInFlightRequests: Int,&lt;br/&gt;
+              time: Time,&lt;br/&gt;
+              metricGroup: String = &quot;kafka.server&quot;,&lt;br/&gt;
+              metricType: String = &quot;SessionExpireListener&quot;) = &lt;/p&gt;
{
+      val zooKeeperClient = new ZooKeeperClient(connectString, sessionTimeoutMs, connectionTimeoutMs, maxInFlightRequests,
+        time, metricGroup, metricType)
+      new ExpiredKafkaZkClient(zooKeeperClient, isSecure, time)
+    }
&lt;p&gt;+  }&lt;br/&gt;
 }&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16680424" author="junrao" created="Thu, 8 Nov 2018 21:30:23 +0000"  >&lt;p&gt;Merged to trunk.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="12633074">KAFKA-764</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13010703">KAFKA-4277</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13104860">KAFKA-5971</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13140261">KAFKA-6584</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 1 week, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3vwuf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>