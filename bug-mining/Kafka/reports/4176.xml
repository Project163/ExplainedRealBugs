<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:42:51 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-19233] Members cannot rejoin with epoch=0 for KIP-848</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-19233</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;If a group is on generation &amp;gt; 1 and a member is fenced, the member cannot rejoin until the broker expires the member from the group.&lt;/p&gt;

&lt;p&gt;KIP-848 says &quot;Upon receiving the UNKNOWN_MEMBER_ID or FENCED_MEMBER_EPOCH error, the consumer abandon all its partitions and rejoins with the same member id and the epoch 0.&quot;.&lt;/p&gt;

&lt;p&gt;However, the current implementation on the broker throws FENCED_MEMBER_EPOCH if the client provided epoch, when not equal to the current epoch, is anything other than the current epoch - 1.&lt;/p&gt;

&lt;p&gt;Specifically this line: &lt;a href=&quot;https://github.com/apache/kafka/blob/e68781414e9bcbc1d7cd5c247433a13f8d0e2e6e/group-coordinator/src/main/java/org/apache/kafka/coordinator/group/GroupMetadataManager.java#L1535&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/e68781414e9bcbc1d7cd5c247433a13f8d0e2e6e/group-coordinator/src/main/java/org/apache/kafka/coordinator/group/GroupMetadataManager.java#L1535&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;If the current epoch is 13, and I reset to epoch 0, the conditional always throws FENCED_MEMBER_EPOCH.&lt;/p&gt;

&lt;p&gt;Attached are logs of this case, here is a sample of a single log line demonstrating the problem:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2025-05-02 15:23:09,304 [data-plane-kafka-network-thread-3-ListenerName(PLAINTEXT)-PLAINTEXT-0] DEBUG kafka.request.logger - Completed request:{&lt;span class=&quot;code-quote&quot;&gt;&quot;isForwarded&quot;&lt;/span&gt;:&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;requestHeader&quot;&lt;/span&gt;:{&lt;span class=&quot;code-quote&quot;&gt;&quot;requestApiKey&quot;&lt;/span&gt;:68,&lt;span class=&quot;code-quote&quot;&gt;&quot;requestApiVersion&quot;&lt;/span&gt;:1,&lt;span class=&quot;code-quote&quot;&gt;&quot;correlationId&quot;&lt;/span&gt;:46,&lt;span class=&quot;code-quote&quot;&gt;&quot;clientId&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;kgo&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;requestApiKeyName&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;CONSUMER_GROUP_HEARTBEAT&quot;&lt;/span&gt;},&lt;span class=&quot;code-quote&quot;&gt;&quot;request&quot;&lt;/span&gt;:{&lt;span class=&quot;code-quote&quot;&gt;&quot;groupId&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;67660d2bfc7b197c91ff86623614522285c05c14b9f817fa99e6c105a2f54d7f&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;memberId&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;uxNPFKnjF3OrkZIAghLN1Q==&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;memberEpoch&quot;&lt;/span&gt;:0,&lt;span class=&quot;code-quote&quot;&gt;&quot;instanceId&quot;&lt;/span&gt;:&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;rackId&quot;&lt;/span&gt;:&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;rebalanceTimeoutMs&quot;&lt;/span&gt;:60000,&lt;span class=&quot;code-quote&quot;&gt;&quot;subscribedTopicNames&quot;&lt;/span&gt;:[&lt;span class=&quot;code-quote&quot;&gt;&quot;aed98f76851080d77b6098a03ea5ef088dabc21331462e44ed7ae5be463e2655&quot;&lt;/span&gt;],&lt;span class=&quot;code-quote&quot;&gt;&quot;subscribedTopicRegex&quot;&lt;/span&gt;:&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;serverAssignor&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;range&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;topicPartitions&quot;&lt;/span&gt;:[]},&lt;span class=&quot;code-quote&quot;&gt;&quot;response&quot;&lt;/span&gt;:{&lt;span class=&quot;code-quote&quot;&gt;&quot;throttleTimeMs&quot;&lt;/span&gt;:0,&lt;span class=&quot;code-quote&quot;&gt;&quot;errorCode&quot;&lt;/span&gt;:110,&lt;span class=&quot;code-quote&quot;&gt;&quot;errorMessage&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;The consumer group member has a smaller member epoch (0) than the one known by the group coordinator (11). The member must abandon all its partitions and rejoin.&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;memberId&quot;&lt;/span&gt;:&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;memberEpoch&quot;&lt;/span&gt;:0,&lt;span class=&quot;code-quote&quot;&gt;&quot;heartbeatIntervalMs&quot;&lt;/span&gt;:0,&lt;span class=&quot;code-quote&quot;&gt;&quot;assignment&quot;&lt;/span&gt;:&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;},&lt;span class=&quot;code-quote&quot;&gt;&quot;connection&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;127.0.0.1:9096-127.0.0.1:56686-0-292&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;totalTimeMs&quot;&lt;/span&gt;:0.801,&lt;span class=&quot;code-quote&quot;&gt;&quot;requestQueueTimeMs&quot;&lt;/span&gt;:0.159,&lt;span class=&quot;code-quote&quot;&gt;&quot;localTimeMs&quot;&lt;/span&gt;:0.106,&lt;span class=&quot;code-quote&quot;&gt;&quot;remoteTimeMs&quot;&lt;/span&gt;:0.315,&lt;span class=&quot;code-quote&quot;&gt;&quot;throttleTimeMs&quot;&lt;/span&gt;:0,&lt;span class=&quot;code-quote&quot;&gt;&quot;responseQueueTimeMs&quot;&lt;/span&gt;:0.066,&lt;span class=&quot;code-quote&quot;&gt;&quot;sendTimeMs&quot;&lt;/span&gt;:0.153,&lt;span class=&quot;code-quote&quot;&gt;&quot;securityProtocol&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;PLAINTEXT&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;principal&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;User:ANONYMOUS&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;listener&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;PLAINTEXT&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;clientInformation&quot;&lt;/span&gt;:{&lt;span class=&quot;code-quote&quot;&gt;&quot;softwareName&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;kgo&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;softwareVersion&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;unknown&quot;&lt;/span&gt;}}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The logs show the broker continuously responding errcode 110 for 50s until, I&apos;m assuming, some condition boots the member from the group, such that the next time the broker receives the request, the member is considered new and the request is successful.&lt;/p&gt;

&lt;p&gt;The first heartbeat is duplicated; I noticed that Kafka replies with FENCED_MEMBER_EPOCH &lt;em&gt;way too often&lt;/em&gt; if a heartbeat is duplicated, and I&apos;m trying to see if it&apos;s possible to work around that. As an aside, between the fenced error happening &lt;em&gt;a lot&lt;/em&gt;, this issue, and &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-19222&quot; title=&quot;Invalid FENCED_MEMBER_EPOCH error to ConsumerGroupHeartbeat&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-19222&quot;&gt;KAFKA-19222&lt;/a&gt;, I&apos;m leaning to not opt into KIP-848 by default until the broker implementation improves.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13616989">KAFKA-19233</key>
            <summary>Members cannot rejoin with epoch=0 for KIP-848</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="twmb">Travis Bischel</reporter>
                        <labels>
                    </labels>
                <created>Fri, 2 May 2025 16:11:29 +0000</created>
                <updated>Tue, 14 Oct 2025 23:22:22 +0000</updated>
                                                                            <component>clients</component>
                    <component>consumer</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17948964" author="JIRAUSER300183" created="Fri, 2 May 2025 19:07:30 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=twmb&quot; class=&quot;user-hover&quot; rel=&quot;twmb&quot;&gt;twmb&lt;/a&gt; ! When a member is fenced, it should be allowed to rejoin with epoch 0. This is how the flow goes:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;member fenced: coordinator removes it from the group (&lt;a href=&quot;https://github.com/apache/kafka/blob/e68781414e9bcbc1d7cd5c247433a13f8d0e2e6e/group-coordinator/src/main/java/org/apache/kafka/coordinator/group/GroupMetadataManager.java#L3987&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/e68781414e9bcbc1d7cd5c247433a13f8d0e2e6e/group-coordinator/src/main/java/org/apache/kafka/coordinator/group/GroupMetadataManager.java#L3987&lt;/a&gt; and client receives FencedMemberEpochException)&lt;/li&gt;
	&lt;li&gt;member rejoins with epoch 0 when it receives the FencedMemberEpochException&lt;/li&gt;
	&lt;li&gt;coordinator gets HB request from member that is not in the group (removed in step 1), so creates new member (epoch 0) (&lt;a href=&quot;https://github.com/apache/kafka/blob/e68781414e9bcbc1d7cd5c247433a13f8d0e2e6e/group-coordinator/src/main/java/org/apache/kafka/coordinator/group/GroupMetadataManager.java#L2824)&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/e68781414e9bcbc1d7cd5c247433a13f8d0e2e6e/group-coordinator/src/main/java/org/apache/kafka/coordinator/group/GroupMetadataManager.java#L2824)&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;validation of epoch OK on&#160;throwIfConsumerGroupMemberEpochIsInvalid (&quot;receivedMemberEpoch&quot; will be 0, equals to &quot;member.memberEpoch()&quot; 0).&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;From the logs you shared, doesn&apos;t look that 1 happened, so if it wasn&apos;t fenced it is expected that it cannot rejoin with epoch 0 (I see a client rejoining with epoch 0 when it&apos;s still in the group with epoch 11)&lt;br/&gt;
&quot;The consumer group member has a smaller member epoch (0) than the one known by the group coordinator (11). The member must abandon all its partitions and rejoin.&quot;&lt;br/&gt;
So, when you say:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;If the current epoch is 13, and I reset to epoch 0, the conditional always throws FENCED_LEADER_EPOCH.&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;That&apos;s expected, a member that it&apos;s in a group (with epoch 13) cannot rejoin (epoch 0) without leaving the group first or being removed/fenced.&lt;/p&gt;

&lt;p&gt;I guess you&apos;re working on a client implementation of the protocol, so maybe it helps to take a look at the java-client implementation? Specifically check out the calls to &lt;a href=&quot;#L533],&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;transitionToJoining&lt;/a&gt; it can only happen:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;after being fenced (it&apos;s not in the group at this point, removed by the coord)&lt;/li&gt;
	&lt;li&gt;after calling consumer.subscribe if it&apos;s not in the group&lt;/li&gt;
	&lt;li&gt;after pro-actively leaving the group because of time between consumer.poll too long&#160;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Hope it helps! Best!&lt;/p&gt;

&lt;p&gt;Lianet&lt;/p&gt;</comment>
                            <comment id="17949009" author="twmb" created="Fri, 2 May 2025 20:21:22 +0000"  >&lt;p&gt;What has you thinking (1) did not happen? In the broker logs, line 2 shows the broker replying to the client with FENCED_MEMBER_EPOCH (errorCode 110).&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Line 1: CONSUMER_GROUP_HEARTBEAT, member uxNP... epoch 10. The broker replies a successful response. This is a full request (all fields present).&lt;/li&gt;
	&lt;li&gt;Line 2, simulating the client disconnected and lost the response: CONSUMER_GROUP_HEARTBEAT for member uxNP epoch 10. The broker replies errorCode 110, FENCED_MEMBER_EPOCH. This is a full request (all fields present).&lt;/li&gt;
	&lt;li&gt;Line 3, repeated full request again: CONSUMER_GROUP_HEARTBEAT uxNP e10. The broker replies FENCED_MEMBER_EPOCH&lt;/li&gt;
	&lt;li&gt;Line 4, Client resets the epoch to 0 and sends a full request &#8211; all owned topics are lost. CONSUMER_GROUP_HEARTBEAT uxNP e0. The broker replies FENCED_MEMBER_EPOCH.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The client then repeatedly retries epoch 0 with full requests.&lt;/p&gt;</comment>
                            <comment id="17949021" author="twmb" created="Fri, 2 May 2025 20:50:24 +0000"  >&lt;p&gt;Sorry, I wrote FENCED_LEADER_EPOCH above a few times when I meant to write FENCED_MEMBER_EPOCH. That&apos;s been corrected. All errors are fenced member epochs, not leader.&lt;/p&gt;</comment>
                            <comment id="17951059" author="twmb" created="Mon, 12 May 2025 21:49:18 +0000"  >&lt;p&gt;I&apos;ve released franz-go v1.19 opting out of enabling the next gen rebalancer by default.&lt;/p&gt;

&lt;p&gt;I did not see any Java tests exercising what happens when heartbeat requests are repeated. My client works &lt;em&gt;fine&lt;/em&gt; when requests are repeated, but it is effectively degraded. I don&apos;t believe the broker is behaving appropriately: fences happen far too often.&lt;/p&gt;

&lt;p&gt;Please let me know what you think for this and &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-19235&quot; title=&quot;STALE_MEMBER_EPOCH is mostly non-recoverable and forces lost commits when leaving a group (KIP-848)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-19235&quot;&gt;KAFKA-19235&lt;/a&gt;. I&apos;ll leave the group disabled until these are resolved.&lt;/p&gt;</comment>
                            <comment id="17951065" author="JIRAUSER300183" created="Mon, 12 May 2025 23:05:31 +0000"  >&lt;p&gt;Hey &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=twmb&quot; class=&quot;user-hover&quot; rel=&quot;twmb&quot;&gt;twmb&lt;/a&gt; , sorry busy lately but catching up here to help, some answers and questions too. On the flow you describe:&lt;/p&gt;

&lt;p&gt;Line 1 : OK&lt;/p&gt;

&lt;p&gt;Line 2 : OK, but why a full HB after a successful response from the broker on Line 1?&lt;/p&gt;

&lt;p&gt;Line 3: Why is the client repeating &quot;CONSUMER_GROUP_HEARTBEAT uxNP e10.&quot;? If it got FENCED_MEMBER_EPOCH on Line 2 from the broker, the client should release its assignment, reset the epoch to 0, and only then HB again to rejoin (so HB with 0, not 10)&lt;/p&gt;

&lt;p&gt;Line 4: This one is unexpected. Could you double check in this case, why is the fence error set on the broker? maybe point me to the logs (member epoch is 0, I expect it doesn&apos;t exist on the broker because you have it fenced/removed) . Related to this, on the initial description you shared there was a case where I didn&apos;t see fencing hapening because of this log you shared:&lt;br/&gt;
&amp;gt; &quot;The consumer group member has a smaller member epoch (0) than the one known by the group coordinator (11). The member must abandon all its partitions and rejoin.&quot;&lt;/p&gt;

&lt;p&gt;If the member is &quot;known by the group coordinator (11)&quot; I expect it&apos;s because it is still in the group with epoch 0 (so not fenced). Are this logs mixing several clients maybe?&lt;/p&gt;

&lt;p&gt;This test in the java client covers this area of what a fenced member should do &lt;a href=&quot;https://github.com/apache/kafka/blob/c28f46459ac26693b3639fca26c0961283c2ee65/clients/src/test/java/org/apache/kafka/clients/consumer/internals/ConsumerHeartbeatRequestManagerTest.java#L839&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/c28f46459ac26693b3639fca26c0961283c2ee65/clients/src/test/java/org/apache/kafka/clients/consumer/internals/ConsumerHeartbeatRequestManagerTest.java#L839&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;Please let me know the setup you are running (how many consumers?), and with that and the answers to the questions above we can probably sort this out.&lt;/p&gt;

&lt;p&gt;Best!&lt;/p&gt;</comment>
                            <comment id="17951069" author="twmb" created="Mon, 12 May 2025 23:25:52 +0000"  >&lt;p&gt;I rewired the guts of the client to deliberately trigger the case where responses are lost due to connections being cut. If needed, I can change the client to kill the connection rather than just repeated the request. Thus,&lt;/p&gt;

&lt;p&gt;&amp;gt; Line 2 : OK, but why a full HB after a successful response from the broker on Line 1?&lt;/p&gt;

&lt;p&gt;The client never &quot;received&quot; the response. The response is lost. The client is re-issuing a full heartbeat. My immediate question is: why is the client already fenced?&lt;/p&gt;

&lt;p&gt;&amp;gt; Line 3: Why is the client repeating &quot;CONSUMER_GROUP_HEARTBEAT uxNP e10.&quot;? If it got FENCED_MEMBER_EPOCH on Line 2 from the broker, the client should release its assignment, reset the epoch to 0, and only then HB again to rejoin (so HB with 0, not 10)&lt;/p&gt;

&lt;p&gt;Loss simulation.&lt;/p&gt;

&lt;p&gt;&amp;gt;&#160; Could you double check in this case, why is the fence error set on the broker?&lt;/p&gt;

&lt;p&gt;I can&apos;t. I enabled every logger on the broker with &lt;tt&gt;log4j.logger.kafka=DEBUG&lt;/tt&gt;. There is no log related to decisions the broker is making with adding or removing members from the group. I&apos;d be quite happy to have a problem in my properties file, but I saw nothing.&lt;/p&gt;

&lt;p&gt;&amp;gt; Are this logs mixing several clients maybe?&lt;/p&gt;

&lt;p&gt;The logs1 file attached in this issue are all logs for the member ID in the cluster &lt;tt&gt;uxNPFKnjF3OrkZIAghLN1Q==&lt;/tt&gt;. I deleted all logs for other clients. The fourth line in that file shows the client joining with epoch 0 and receiving a fenced response:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2025-05-02 15:22:32,739 [data-plane-kafka-network-thread-3-ListenerName(PLAINTEXT)-PLAINTEXT-0] DEBUG kafka.request.logger - Completed request:{&quot;isForwarded&quot;:false,&quot;requestHeader&quot;:{&quot;requestApiKey&quot;:68,&quot;requestApiVersion&quot;:1,&quot;correlationId&quot;:25,&quot;clientId&quot;:&quot;kgo&quot;,&quot;requestApiKeyName&quot;:&quot;CONSUMER_GROUP_HEARTBEAT&quot;},&quot;request&quot;:{&quot;groupId&quot;:&quot;67660d2bfc7b197c91ff86623614522285c05c14b9f817fa99e6c105a2f54d7f&quot;,&quot;memberId&quot;:&quot;uxNPFKnjF3OrkZIAghLN1Q==&quot;,&quot;memberEpoch&quot;:0,&quot;instanceId&quot;:null,&quot;rackId&quot;:null,&quot;rebalanceTimeoutMs&quot;:60000,&quot;subscribedTopicNames&quot;:[&quot;aed98f76851080d77b6098a03ea5ef088dabc21331462e44ed7ae5be463e2655&quot;],&quot;subscribedTopicRegex&quot;:null,&quot;serverAssignor&quot;:&quot;range&quot;,&quot;topicPartitions&quot;:[]},&quot;response&quot;:{&quot;throttleTimeMs&quot;:0,&quot;errorCode&quot;:110,&quot;errorMessage&quot;:&quot;The consumer group member has a smaller member epoch (0) than the one known by the group coordinator (11). The member must abandon all its partitions and rejoin.&quot;,&quot;memberId&quot;:null,&quot;memberEpoch&quot;:0,&quot;heartbeatIntervalMs&quot;:0,&quot;assignment&quot;:null},&quot;connection&quot;:&quot;127.0.0.1:9096-127.0.0.1:56686-0-292&quot;,&quot;totalTimeMs&quot;:0.143,&quot;requestQueueTimeMs&quot;:0.022,&quot;localTimeMs&quot;:0.023,&quot;remoteTimeMs&quot;:0.056,&quot;throttleTimeMs&quot;:0,&quot;responseQueueTimeMs&quot;:0.013,&quot;sendTimeMs&quot;:0.027,&quot;securityProtocol&quot;:&quot;PLAINTEXT&quot;,&quot;principal&quot;:&quot;User:ANONYMOUS&quot;,&quot;listener&quot;:&quot;PLAINTEXT&quot;,&quot;clientInformation&quot;:{&quot;softwareName&quot;:&quot;kgo&quot;,&quot;softwareVersion&quot;:&quot;unknown&quot;}} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The prior line, you can see the client is fenced with epoch 11.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;That test demonstrates that the client releases its subscription and rejoins with epoch 0 once it receives member fenced. There is no test that specifically simulates what happens in the case that the first heartbeat response is lost. I &lt;em&gt;suspect&lt;/em&gt;&#160;(I&apos;m not positive) that if Confluent simulated some lost responses in an integration test, there would be a&#160;&lt;em&gt;lot&lt;/em&gt; more fenced errors encountered than expected.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;If you&apos;re curious, this is the test I am running:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/twmb/franz-go/blob/master/pkg/kgo/helpers_test.go#L460-L557&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/twmb/franz-go/blob/master/pkg/kgo/helpers_test.go#L460-L557&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This is the code where I was ignoring the first response and reissuing the request (i.e., response lost): &lt;a href=&quot;https://github.com/twmb/franz-go/blob/master/pkg/kgo/consumer_group_848.go#L161-L172&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/twmb/franz-go/blob/master/pkg/kgo/consumer_group_848.go#L161-L172&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Some modifications will need to be made to trigger this issue &#8211; I have commented out the loss simulation and plan to re-run it on future releases to decide whether to opt into the next gen balancer or not.&lt;/p&gt;</comment>
                            <comment id="17953199" author="JIRAUSER300183" created="Wed, 21 May 2025 16:26:57 +0000"  >&lt;p&gt;Hey Travis, could you double check if you&apos;re sending the assigned partitions when you&apos;re re-issuing the HB request? and if the client had no assignment yet you should be sending a empty list of partitions as a full HB (not null), please check and let me know. &lt;/p&gt;

&lt;p&gt;This is required so that the coordinator can let a member back in after a fencing it epoch (ex. on lost HB response). This coordinator check you were sharing:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/kafka/blob/e68781414e9bcbc1d7cd5c247433a13f8d0e2e6e/group-coordinator/src/main/java/org/apache/kafka/coordinator/group/GroupMetadataManager.java#L1535&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/e68781414e9bcbc1d7cd5c247433a13f8d0e2e6e/group-coordinator/src/main/java/org/apache/kafka/coordinator/group/GroupMetadataManager.java#L1535&lt;/a&gt; &lt;br/&gt;
Also note that it checks that the member comes with the previous epoch it had (expecting that the client may loose one HB response with a bumped epoch, then rejoin with the previous epoch).&lt;/p&gt;

&lt;p&gt;The java client deals with this situation by ensuring :&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;sends only 1 HB at a time (until response from broker or timeout/error on request)&lt;/li&gt;
	&lt;li&gt;on retriable errors (ex. timeout on no reponse) it resends a full HB (including the assigned partitions, ex. empty list if first request got no response), so the check on the coordinator allows it back it&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Let me know if this helps, and I will definitely clarify on the KIP Fencing section (we were also mixing on this jira 2 fencing scenarios: fenced member vs fenced epoch). This issue is about fenced epoch, will clarify it all on the doc.  &lt;/p&gt;</comment>
                            <comment id="17955792" author="twmb" created="Tue, 3 Jun 2025 00:56:04 +0000"  >&lt;p&gt;Yes, the client is sending the assigned partitions when re-issuing the heartbeat request. You can see in my comment just above &#8211; the broker log &#8211; that the client is sending an empty topicPartitions. `&quot;topicPartitions&quot;:[]`. The line you sent is actually the line I included in the issue description.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I&apos;m not sure what more incontrovertible proof I could attach &lt;em&gt;besides&lt;/em&gt; the broker logs that show the full request flow from the client that I attached at the start of this issue. I understand that the Java client is giving up all partitions and rejoining; I&apos;m doing exactly the same thing. I&apos;m pointing out two things in my series of issues:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;There is a bug on the broker somewhere. I am rejoining with epoch 0 and a non-null empty list of partitions. The broker keeps rejecting the rejoin request.&lt;/li&gt;
	&lt;li&gt;If you repeat heartbeat requests, &lt;em&gt;simulating faulty connections&lt;/em&gt;, the broker will fence the member way too much. This is recoverable (sometimes, minus the bug in the prior point), but it is undesirable behavior.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="18029914" author="twmb" created="Tue, 14 Oct 2025 23:22:22 +0000"  >&lt;p&gt;This is still a problem on Kafka 4.1.&lt;/p&gt;

&lt;p&gt;Again, I am joining with epoch 0, and I am receiving FENCED_MEMBER_EPOCH.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13076350" name="logs1" size="36127" author="twmb" created="Fri, 2 May 2025 16:11:25 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1vnq8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>