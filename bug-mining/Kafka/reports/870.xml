<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:50:12 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-2867] Missing synchronization and improperly handled InterruptException in WorkerSourceTask</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-2867</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;In WorkerSourceTask, finishSuccessfulFlush() is not synchronized. In one case (if the flush didn&apos;t even have to be started), this is ok because we are already in a synchronized block. However, the other case is outside the synchronized block.&lt;/p&gt;

&lt;p&gt;The result of this was transient failures of the system test for clean bouncing copycat nodes. The bug doesn&apos;t cause exceptions because finishSuccessfulFlush() only does a swap of two maps and sets a flag to false. However, because of the swapping of the two maps that maintain outstanding messages, we could by chance also be starting to send a message. If the message accidentally gets added to the backlog queue, then the flushing flag is toggled, we can &quot;lose&quot; that message temporarily into the backlog queue. Then we&apos;ll get a callback that will log an error because it can&apos;t find a record of the acked message (which, if it ever appears, should be considered a critical issue since it shouldn&apos;t be possible), and then on the next commit, it&apos;ll be swapped &lt;b&gt;back into place&lt;/b&gt;. On the subsequent commit, the flush will never be able to complete because the message will be in the outstanding list, but will already have been acked. This, in turn, makes it impossible to commit offsets, and results in duplicate messages even under clean bounces where we should be able to get exactly once delivery assuming no network delays or other issues.&lt;/p&gt;

&lt;p&gt;As a result of seeing this error, it became apparent that handling of WorkerSourceTaskThreads that do not complete quickly enough was not working properly. The ShutdownableThread should get interrupted if it does not complete quickly enough, but logs like this would happen:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;2015-11-18 01:02:13,897&amp;#93;&lt;/span&gt; INFO Stopping task verifiable-source-0 (org.apache.kafka.connect.runtime.Worker)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2015-11-18 01:02:13,897&amp;#93;&lt;/span&gt; INFO Starting graceful shutdown of thread WorkerSourceTask-verifiable-source-0 (org.apache.kafka.connect.util.ShutdownableThread)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2015-11-18 01:02:13,897&amp;#93;&lt;/span&gt; DEBUG WorkerSourceTask&lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {id=verifiable-source-0}&lt;/span&gt; &lt;p&gt; Committing offsets (org.apache.kafka.connect.runtime.WorkerSourceTask)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2015-11-18 01:02:17,901&amp;#93;&lt;/span&gt; DEBUG Submitting 1 entries to backing store (org.apache.kafka.connect.storage.OffsetStorageWriter)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2015-11-18 01:02:18,897&amp;#93;&lt;/span&gt; INFO Forcing shutdown of thread WorkerSourceTask-verifiable-source-0 (org.apache.kafka.connect.util.ShutdownableThread)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2015-11-18 01:02:18,897&amp;#93;&lt;/span&gt; ERROR Graceful stop of task WorkerSourceTask&lt;/p&gt;&lt;/div&gt;
&lt;p&gt; failed. (org.apache.kafka.connect.runtime.Worker)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2015-11-18 01:02:18,897&amp;#93;&lt;/span&gt; ERROR Failed to flush WorkerSourceTask&lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {id=verifiable-source-0}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;, timed out while waiting for producer to flush outstanding messages (org.apache.kafka.connect.runtime.WorkerSourceTask)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2015-11-18 01:02:18,898&amp;#93;&lt;/span&gt; DEBUG Submitting 1 entries to backing store (org.apache.kafka.connect.storage.OffsetStorageWriter)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2015-11-18 01:02:18,898&amp;#93;&lt;/span&gt; INFO Finished stopping tasks in preparation for rebalance (org.apache.kafka.connect.runtime.distributed.DistributedHerder)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Actions in the background thread performing the commit continue to occur after it is supposedly interrupted. This is because InterruptedExceptions during the flush were being ignored (some time ago they were not even possible). Instead, any interruption by the main thread trying to shut down the thread in preparation for a rebalance should be handled by failing the commit operation and returning so the thread can exit cleanly.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12914737">KAFKA-2867</key>
            <summary>Missing synchronization and improperly handled InterruptException in WorkerSourceTask</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ewencp">Ewen Cheslack-Postava</assignee>
                                    <reporter username="ewencp">Ewen Cheslack-Postava</reporter>
                        <labels>
                    </labels>
                <created>Fri, 20 Nov 2015 05:17:24 +0000</created>
                <updated>Fri, 20 Nov 2015 18:05:04 +0000</updated>
                            <resolved>Fri, 20 Nov 2015 18:05:04 +0000</resolved>
                                                    <fixVersion>0.9.0.0</fixVersion>
                                    <component>connect</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15015243" author="githubbot" created="Fri, 20 Nov 2015 05:20:04 +0000"  >&lt;p&gt;GitHub user ewencp opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/566&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/566&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-2867&quot; title=&quot;Missing synchronization and improperly handled InterruptException in WorkerSourceTask&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-2867&quot;&gt;&lt;del&gt;KAFKA-2867&lt;/del&gt;&lt;/a&gt;: Fix missing WorkerSourceTask synchronization and handling of InterruptException.&lt;/p&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/ewencp/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/ewencp/kafka&lt;/a&gt; kafka-2867-fix-source-sync-and-interrupt&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/566.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/566.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #566&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 3a610d4f24f9e102458f335d98c420a563c08aad&lt;br/&gt;
Author: Ewen Cheslack-Postava &amp;lt;me@ewencp.org&amp;gt;&lt;br/&gt;
Date:   2015-11-19T21:37:17Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-2867&quot; title=&quot;Missing synchronization and improperly handled InterruptException in WorkerSourceTask&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-2867&quot;&gt;&lt;del&gt;KAFKA-2867&lt;/del&gt;&lt;/a&gt;: Fix missing WorkerSourceTask synchronization and handling of InterruptException.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15018434" author="githubbot" created="Fri, 20 Nov 2015 18:05:01 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/566&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/566&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15018435" author="junrao" created="Fri, 20 Nov 2015 18:05:04 +0000"  >&lt;p&gt;Issue resolved by pull request 566&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/kafka/pull/566&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/566&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2ooov:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>gwenshap</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>