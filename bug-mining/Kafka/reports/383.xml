<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:39:37 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-1134] onControllerFailover function should be synchronized with other functions</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-1134</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Otherwise race conditions could happen. For example, handleNewSession will close all sockets with brokers while the handleStateChange in onControllerFailover tries to send requests to them.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12679585">KAFKA-1134</key>
            <summary>onControllerFailover function should be synchronized with other functions</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="guozhang">Guozhang Wang</assignee>
                                    <reporter username="guozhang">Guozhang Wang</reporter>
                        <labels>
                    </labels>
                <created>Sat, 16 Nov 2013 20:14:11 +0000</created>
                <updated>Thu, 12 Dec 2013 00:35:17 +0000</updated>
                            <resolved>Thu, 12 Dec 2013 00:35:08 +0000</resolved>
                                    <version>0.8.0</version>
                    <version>0.8.1</version>
                                                        <due></due>
                            <votes>1</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13837172" author="guozhang" created="Tue, 3 Dec 2013 00:58:07 +0000"  >&lt;p&gt;Created reviewboard &lt;a href=&quot;https://reviews.apache.org/r/15953/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/15953/&lt;/a&gt;&lt;br/&gt;
 against branch origin/trunk&lt;/p&gt;</comment>
                            <comment id="13837912" author="nehanarkhede" created="Tue, 3 Dec 2013 17:20:49 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; Do you happen to have a stack trace of the problem you have described?&lt;/p&gt;</comment>
                            <comment id="13840439" author="guozhang" created="Thu, 5 Dec 2013 19:13:49 +0000"  >&lt;p&gt;Updated reviewboard &lt;a href=&quot;https://reviews.apache.org/r/15953/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/15953/&lt;/a&gt;&lt;br/&gt;
 against branch origin/trunk&lt;/p&gt;</comment>
                            <comment id="13840449" author="guozhang" created="Thu, 5 Dec 2013 19:23:09 +0000"  >&lt;p&gt;After checking the stack trace again, now I think the problem is that&lt;/p&gt;

&lt;p&gt;1) In KafkaController.handleNewSession&lt;/p&gt;

&lt;p&gt;controllerContext.controllerLock synchronized {&lt;br/&gt;
        Utils.unregisterMBean(KafkaController.MBeanName)&lt;br/&gt;
        partitionStateMachine.shutdown()&lt;br/&gt;
        replicaStateMachine.shutdown()&lt;br/&gt;
        if(controllerContext.controllerChannelManager != null) &lt;/p&gt;
{
          controllerContext.controllerChannelManager.shutdown()
          controllerContext.controllerChannelManager = null
        }
&lt;p&gt;        controllerElector.elect&lt;br/&gt;
      }&lt;/p&gt;

&lt;p&gt;elect function is called directly after controllerChannelManager.shutdown and is lock covered by controllerContext.controllerLock, however from the logs. elect is not immediately called since addpartition listener gets triggered due to ZK expiration (known issue similar as &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-1143&quot; title=&quot;Consumer should cache topic partition info&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-1143&quot;&gt;&lt;del&gt;KAFKA-1143&lt;/del&gt;&lt;/a&gt;) and which are covered by the same lock:&lt;/p&gt;

&lt;p&gt;2013/11/14 00:00:24.596 &lt;span class=&quot;error&quot;&gt;&amp;#91;RequestSendThread&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;Controller-583-to-broker-587-send-thread&amp;#93;&lt;/span&gt;, Stopped &lt;br/&gt;
2013/11/14 00:00:24.596 &lt;span class=&quot;error&quot;&gt;&amp;#91;RequestSendThread&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;Controller-583-to-broker-587-send-thread&amp;#93;&lt;/span&gt;, Shutdown completed&lt;br/&gt;
2013/11/14 00:00:24.596 &lt;span class=&quot;error&quot;&gt;&amp;#91;RequestSendThread&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;Controller-583-to-broker-579-send-thread&amp;#93;&lt;/span&gt;, Shutting down&lt;br/&gt;
2013/11/14 00:00:24.596 &lt;span class=&quot;error&quot;&gt;&amp;#91;RequestSendThread&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;Controller-583-to-broker-579-send-thread&amp;#93;&lt;/span&gt;, Stopped &lt;br/&gt;
2013/11/14 00:00:24.596 &lt;span class=&quot;error&quot;&gt;&amp;#91;RequestSendThread&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;Controller-583-to-broker-579-send-thread&amp;#93;&lt;/span&gt;, Shutdown completed&lt;br/&gt;
2013/11/14 00:00:24.603 &lt;span class=&quot;error&quot;&gt;&amp;#91;ReplicaStateMachine$BrokerChangeListener&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;BrokerChangeListener on Controller 583&amp;#93;&lt;/span&gt;: Broker change listener fired for path /brokers/ids with children 583,575,585,587,579,589&lt;br/&gt;
2013/11/14 00:00:24.605 &lt;span class=&quot;error&quot;&gt;&amp;#91;ReplicaStateMachine$BrokerChangeListener&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;BrokerChangeListener on Controller 583&amp;#93;&lt;/span&gt;: Broker change listener fired for path /brokers/ids with children 583,575,585,587,579,589&lt;br/&gt;
2013/11/14 00:00:24.614 &lt;span class=&quot;error&quot;&gt;&amp;#91;PartitionStateMachine$AddPartitionsListener&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;AddPartitionsListener on 583&amp;#93;&lt;/span&gt;: Add Partition triggered { &quot;partitions&quot;:&lt;/p&gt;
{ &quot;0&quot;:[ 577, 589 ], &quot;1&quot;:[ 579, 575 ], &quot;2&quot;:[ 581, 577 ], &quot;3&quot;:[ 583, 579 ] }
&lt;p&gt;, &quot;version&quot;:1 } for path /brokers/topics/databus2-relay-log_event&lt;br/&gt;
2013/11/14 00:00:24.616 &lt;span class=&quot;error&quot;&gt;&amp;#91;PartitionStateMachine$AddPartitionsListener&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;AddPartitionsListener on 583&amp;#93;&lt;/span&gt;: New partitions to be added &lt;span class=&quot;error&quot;&gt;&amp;#91;Map()&amp;#93;&lt;/span&gt;&lt;br/&gt;
2013/11/14 00:00:24.616 &lt;span class=&quot;error&quot;&gt;&amp;#91;KafkaController&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;Controller 583&amp;#93;&lt;/span&gt;: New partition creation callback for &lt;br/&gt;
2013/11/14 00:00:24.618 &lt;span class=&quot;error&quot;&gt;&amp;#91;PartitionStateMachine$AddPartitionsListener&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;AddPartitionsListener on 583&amp;#93;&lt;/span&gt;: Add Partition triggered { &quot;partitions&quot;:&lt;/p&gt;
{ &quot;0&quot;:[ 577, 589 ], &quot;1&quot;:[ 579, 575 ], &quot;2&quot;:[ 581, 577 ], &quot;3&quot;:[ 583, 579 ] }
&lt;p&gt;, &quot;version&quot;:1 } for path /brokers/topics/databus2-relay-log_event&lt;/p&gt;

&lt;p&gt;----------------&lt;/p&gt;

&lt;p&gt;Without other logging info I cannot deduce any further, so I propose in this jira we just improve the logging info for better debugging if this issue comes up in the future.&lt;/p&gt;</comment>
                            <comment id="13845921" author="nehanarkhede" created="Thu, 12 Dec 2013 00:35:08 +0000"  >&lt;p&gt;Thanks for the patch. Committed to trunk&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12616662" name="KAFKA-1134.patch" size="3097" author="guozhang" created="Tue, 3 Dec 2013 00:58:07 +0000"/>
                            <attachment id="12617215" name="KAFKA-1134_2013-12-05_11:13:33.patch" size="3134" author="guozhang" created="Thu, 5 Dec 2013 19:13:49 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>358945</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 49 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1pvkv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>359235</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>