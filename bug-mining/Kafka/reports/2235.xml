<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:18:12 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-8204] Streams may flush state stores in the incorrect order</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-8204</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Cached state stores may forward records during a flush call, so Streams should flush the stores in topological order. Otherwise, Streams may flush a downstream store before an upstream one, resulting in sink results being committed without the corresponding state changelog updates being committed.&lt;/p&gt;

&lt;p&gt;This behavior is partly responsible for the bug reported in &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7895&quot; title=&quot;Ktable supress operator emitting more than one record for the same key per window&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7895&quot;&gt;&lt;del&gt;KAFKA-7895&lt;/del&gt;&lt;/a&gt; .&lt;/p&gt;

&lt;p&gt;The fix is simply to flush the stores in topological order, then when the upstream store forwards records to a downstream stateful processor, the corresponding state changes will be correctly flushed as well.&lt;/p&gt;

&lt;p&gt;An alternative would be to repeatedly call flush on all state stores until they report there is nothing left to flush, but this requires a public API change to enable state stores to report whether they need a flush or not.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13226999">KAFKA-8204</key>
            <summary>Streams may flush state stores in the incorrect order</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="vvcephei">John Roesler</assignee>
                                    <reporter username="vvcephei">John Roesler</reporter>
                        <labels>
                    </labels>
                <created>Tue, 9 Apr 2019 17:06:49 +0000</created>
                <updated>Fri, 10 May 2019 15:08:22 +0000</updated>
                            <resolved>Mon, 22 Apr 2019 22:11:30 +0000</resolved>
                                    <version>1.1.0</version>
                    <version>1.1.1</version>
                    <version>2.0.0</version>
                    <version>2.0.1</version>
                    <version>2.1.0</version>
                    <version>2.1.1</version>
                    <version>2.2.0</version>
                                    <fixVersion>2.2.1</fixVersion>
                    <fixVersion>2.3.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16813748" author="githubbot" created="Tue, 9 Apr 2019 19:29:48 +0000"  >&lt;p&gt;vvcephei commented on pull request #6555: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-8204&quot; title=&quot;Streams may flush state stores in the incorrect order&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-8204&quot;&gt;&lt;del&gt;KAFKA-8204&lt;/del&gt;&lt;/a&gt;: fix Streams store flush order&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/6555&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/6555&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Streams previously flushed stores in the order of their registration,&lt;br/&gt;
   which is arbitrary. Because stores may forward values upon flush&lt;br/&gt;
   (as in cached state stores), we must flush stores in topological order.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16815516" author="vvcephei" created="Thu, 11 Apr 2019 15:47:14 +0000"  >&lt;p&gt;How far back should we backport the fix for this?&lt;/p&gt;

&lt;p&gt;The bug seems to affect cached state stores in every version of Streams since 0.10.2,&#160;and it&apos;s quite a subtle effect. You have to have multiple cached state stores in a row in the same subtopology, and Streams has to flush them in the wrong order (which is not guaranteed). In this case,&#160;Streams will mark a record as consumed even though it&apos;s still buffered in memory in the downstream store. If you stop (or crash) the app at this point, the record won&apos;t be added to the downstream store&apos;s changelog or emitted, constituting data loss.&lt;/p&gt;

&lt;p&gt;With the introduction of Suppress, the scenario is basically the same, but the effect is that we &lt;b&gt;do&lt;/b&gt; emit the output record, but we &lt;b&gt;do not&lt;/b&gt;&#160;mark the record as emitted in the suppression buffer changelog. When we restore, we forget that we previously emitted the record, leading to a duplicate result (or possibly disordered earlier result being emitted).&lt;/p&gt;</comment>
                            <comment id="16815605" author="mjsax" created="Thu, 11 Apr 2019 16:55:32 +0000"  >&lt;p&gt;I would recommend to back port as far as `1.0`.&lt;/p&gt;</comment>
                            <comment id="16816561" author="vvcephei" created="Fri, 12 Apr 2019 18:23:37 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mjsax&quot; class=&quot;user-hover&quot; rel=&quot;mjsax&quot;&gt;mjsax&lt;/a&gt;. Actually, in the code review, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; asked some awkward questions that made me re-evaluate the nature of the bug. Upon review, I think it was introduced in&#160;&lt;a href=&quot;https://github.com/apache/kafka/pull/4215/files&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/4215&lt;/a&gt;&#160;and therefore was introduced in 1.1 .&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The details are here: &lt;a href=&quot;https://github.com/apache/kafka/pull/6555#discussion_r274997288&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/6555#discussion_r274997288&lt;/a&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16817128" author="mjsax" created="Sat, 13 Apr 2019 22:54:28 +0000"  >&lt;p&gt;Nice find! Thanks for the details!&lt;/p&gt;</comment>
                            <comment id="16823502" author="githubbot" created="Mon, 22 Apr 2019 21:53:53 +0000"  >&lt;p&gt;guozhangwang commented on pull request #6555: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-8204&quot; title=&quot;Streams may flush state stores in the incorrect order&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-8204&quot;&gt;&lt;del&gt;KAFKA-8204&lt;/del&gt;&lt;/a&gt;: fix Streams store flush order&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/6555&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/6555&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16823509" author="guozhang" created="Mon, 22 Apr 2019 22:11:30 +0000"  >&lt;p&gt;The latest PR has been merged to 2.2 / trunk, we will add more to fixed versions as we cherry-pick it to older branches via different PRs.&lt;/p&gt;</comment>
                            <comment id="16824371" author="githubbot" created="Tue, 23 Apr 2019 17:33:31 +0000"  >&lt;p&gt;vvcephei commented on pull request #6623: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-8204&quot; title=&quot;Streams may flush state stores in the incorrect order&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-8204&quot;&gt;&lt;del&gt;KAFKA-8204&lt;/del&gt;&lt;/a&gt;: fix Streams store flush order (#6555)&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/6623&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/6623&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Streams previously flushed stores in the order of their registration, which is arbitrary. Because stores may forward values upon flush (as in cached state stores), we must flush stores in topological order.&lt;/p&gt;

&lt;p&gt;   Cherry-picked from #6555 / 467dbca&lt;/p&gt;

&lt;p&gt;   Reviewers: Bill Bejeck &amp;lt;bbejeck@gmail.com&amp;gt;, Guozhang Wang &amp;lt;wangguoz@gmail.com&amp;gt;&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16824707" author="githubbot" created="Wed, 24 Apr 2019 01:14:52 +0000"  >&lt;p&gt;guozhangwang commented on pull request #6623: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-8204&quot; title=&quot;Streams may flush state stores in the incorrect order&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-8204&quot;&gt;&lt;del&gt;KAFKA-8204&lt;/del&gt;&lt;/a&gt;: fix Streams store flush order (#6555)&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/6623&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/6623&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16825233" author="vvcephei" created="Wed, 24 Apr 2019 14:41:38 +0000"  >&lt;p&gt;Ok! this is merged to trunk (2.3), 2.2, and 2.1 . I&apos;m waiting on &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-8254&quot; title=&quot;Suppress incorrectly passes a null topic to the serdes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-8254&quot;&gt;&lt;del&gt;KAFKA-8254&lt;/del&gt;&lt;/a&gt; before requesting patch releases.&lt;/p&gt;</comment>
                            <comment id="16832592" author="vvcephei" created="Fri, 3 May 2019 15:41:30 +0000"  >&lt;p&gt;2.2.1 has been proposed: &lt;a href=&quot;https://cwiki.apache.org/confluence/display/KAFKA/Release+Plan+2.2.1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://cwiki.apache.org/confluence/display/KAFKA/Release+Plan+2.2.1&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16837349" author="vvcephei" created="Fri, 10 May 2019 15:08:22 +0000"  >&lt;p&gt;FYI, 2.2.1 RC0 vote is in progress. (&lt;a href=&quot;https://lists.apache.org/thread.html/3486798e63ae666fc336ce9009f07c7fdf66a96badc1fed63bcbd2ed@%3Cdev.kafka.apache.org%3E&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://lists.apache.org/thread.html/3486798e63ae666fc336ce9009f07c7fdf66a96badc1fed63bcbd2ed@%3Cdev.kafka.apache.org%3E&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;Please feel free to test it out, and reply on the vote thread if you have some trouble with it.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13213510">KAFKA-7895</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 27 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z01lwo:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>