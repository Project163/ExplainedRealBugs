<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:23:12 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-9700] Negative estimatedCompressionRatio leads to misjudgment about if there is no room</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-9700</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;ul&gt;
	&lt;li&gt;When I run the following command&lt;br/&gt;
bin/kafka-producer-perf-test.sh --topic test --num-records 50000000 --throughput -1 --record-size 5000 --producer-props bootstrap.servers=server04:9092 acks=1 buffer.memory=67108864 batch.size 65536 compression.type=zstd&lt;br/&gt;
There was a warning:&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2020-03-06 17:36:50,216&amp;#93;&lt;/span&gt; WARN &lt;span class=&quot;error&quot;&gt;&amp;#91;Producer clientId=producer-1&amp;#93;&lt;/span&gt; Got error produce response in correlation id 3261 on topic-partition test-1, splitting and retrying (2147483647 attempts left). Error: MESSAGE_TOO_LARGE (org.apache.kafka.clients.producer.internals.Sender)&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;The batch size(65536) is smaller than max.message.bytes (1048588) .  So it&apos;s not the root cause.&lt;/li&gt;
&lt;/ul&gt;



&lt;ul&gt;
	&lt;li&gt;I added some logs in CompressionRatioEstimator.updateEstimation and found there were negative currentEstimation values.  The following were logs I added&lt;br/&gt;
public static float updateEstimation(String topic, CompressionType type, float observedRatio) {&lt;br/&gt;
    float[] compressionRatioForTopic = getAndCreateEstimationIfAbsent(topic);&lt;br/&gt;
    float currentEstimation = compressionRatioForTopic&lt;span class=&quot;error&quot;&gt;&amp;#91;type.id&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    synchronized (compressionRatioForTopic) {&lt;br/&gt;
        if (observedRatio &amp;gt; currentEstimation)
        {
                compressionRatioForTopic[type.id] = Math.max(currentEstimation + COMPRESSION_RATIO_DETERIORATE_STEP, observedRatio);
        }
&lt;p&gt;        else if (observedRatio &amp;lt; currentEstimation) {&lt;br/&gt;
                  compressionRatioForTopic&lt;span class=&quot;error&quot;&gt;&amp;#91;type.id&amp;#93;&lt;/span&gt; = currentEstimation - COMPRESSION_RATIO_IMPROVING_STEP;&lt;br/&gt;
                  log.warn(&quot;####currentEstimation is {} , COMPRESSION_RATIO_IMPROVING_STEP is {} , compressionRatioForTopic&lt;span class=&quot;error&quot;&gt;&amp;#91;type.id&amp;#93;&lt;/span&gt; is {}, type.id is {}&quot;, currentEstimation, COMPRESSION_RATIO_IMPROVING_STEP,compressionRatioForTopic&lt;span class=&quot;error&quot;&gt;&amp;#91;type.id&amp;#93;&lt;/span&gt;, type.id);&lt;br/&gt;
        }&lt;br/&gt;
    }&lt;br/&gt;
     return compressionRatioForTopic&lt;span class=&quot;error&quot;&gt;&amp;#91;type.id&amp;#93;&lt;/span&gt;;&lt;br/&gt;
}&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;The observedRatio is smaller than COMPRESSION_RATIO_IMPROVING_STEP in some cases.  Some I think the else if block should be changed into &lt;/p&gt;

&lt;p&gt;else if (observedRatio &amp;lt; currentEstimation) &lt;/p&gt;
{
                  compressionRatioForTopic[type.id] = Math.max(currentEstimation - COMPRESSION_RATIO_IMPROVING_STEP, observedRatio);
              }
</description>
                <environment></environment>
        <key id="13290956">KAFKA-9700</key>
            <summary>Negative estimatedCompressionRatio leads to misjudgment about if there is no room</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="adally">jiamei xie</reporter>
                        <labels>
                    </labels>
                <created>Wed, 11 Mar 2020 02:00:49 +0000</created>
                <updated>Wed, 25 Mar 2020 03:53:35 +0000</updated>
                            <resolved>Wed, 25 Mar 2020 03:53:35 +0000</resolved>
                                                    <fixVersion>2.5.0</fixVersion>
                    <fixVersion>2.6.0</fixVersion>
                                    <component>clients</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17057651" author="githubbot" created="Thu, 12 Mar 2020 07:12:12 +0000"  >&lt;p&gt;jiameixie commented on pull request #8285: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-9700&quot; title=&quot;Negative estimatedCompressionRatio leads to misjudgment about if there is no room&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-9700&quot;&gt;&lt;del&gt;KAFKA-9700&lt;/del&gt;&lt;/a&gt;:Fix negative estimatedCompressionRatio issue&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/8285&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/8285&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   There are cases that currentEstimation is smaller than&lt;br/&gt;
   COMPRESSION_RATIO_IMPROVING_STEP and it will get negative&lt;br/&gt;
   estimatedCompressionRatio,which leads to misjudgment&lt;br/&gt;
   about if there is no room and MESSAGE_TOO_LARGE might occur.&lt;/p&gt;

&lt;p&gt;   Change-Id: I0932a2a6ca669f673ab5d862d3fe7b2bb6d96ff6&lt;br/&gt;
   Signed-off-by: Jiamei Xie &amp;lt;jiamei.xie@arm.com&amp;gt;&lt;/p&gt;

&lt;p&gt;   *More detailed description of your change,&lt;br/&gt;
   if necessary. The PR title and PR message become&lt;br/&gt;
   the squashed commit message, so use a separate&lt;br/&gt;
   comment to ping reviewers.*&lt;/p&gt;

&lt;p&gt;   *Summary of testing strategy (including rationale)&lt;br/&gt;
   for the feature or bug fix. Unit and/or integration&lt;br/&gt;
   tests are expected for any behaviour change and&lt;br/&gt;
   system tests should be considered for larger changes.*&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="17057660" author="adally" created="Thu, 12 Mar 2020 07:22:20 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/apache/kafka/pull/8285&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/8285&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17066361" author="githubbot" created="Wed, 25 Mar 2020 03:48:56 +0000"  >&lt;p&gt;ijuma commented on pull request #8285: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-9700&quot; title=&quot;Negative estimatedCompressionRatio leads to misjudgment about if there is no room&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-9700&quot;&gt;&lt;del&gt;KAFKA-9700&lt;/del&gt;&lt;/a&gt;:Fix negative estimatedCompressionRatio issue&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/8285&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/8285&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10430"><![CDATA[Patch]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 33 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0cefk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>