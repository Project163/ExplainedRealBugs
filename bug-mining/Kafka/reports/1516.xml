<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:01:33 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-5226] NullPointerException (NPE) in SourceNodeRecordDeserializer.deserialize</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-5226</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;I saw the following NPE in our Kafka Streams app, which has 3 nodes running on 3 separate machines.. Out of hundreds of messages processed, the NPE only occurred twice. I are not sure of the cause, so I am unable to reproduce it. I&apos;m hoping the Kafka Streams team can guess the cause based on the stack trace. If I can provide any additional details about our app, please let me know.&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;INFO  2017-05-10 02:58:26,021 org.apache.kafka.common.utils.AppInfoParser  Kafka version : 0.10.2.1
INFO  2017-05-10 02:58:26,021 org.apache.kafka.common.utils.AppInfoParser  Kafka commitId : e89bffd6b2eff799
INFO  2017-05-10 02:58:26,031 o.s.context.support.DefaultLifecycleProcessor  Starting beans in phase 0
INFO  2017-05-10 02:58:26,075 org.apache.kafka.streams.KafkaStreams  stream-client [evergage-app-bd9c9868-4b9b-4d2e-850f-9b5bec1fc0a9] State transition from CREATED to RUNNING.
INFO  2017-05-10 02:58:26,075 org.apache.kafka.streams.KafkaStreams  stream-client [evergage-app-bd9c9868-4b9b-4d2e-850f-9b5bec1fc0a9] Started Kafka Stream process
INFO  2017-05-10 02:58:26,086 o.a.k.c.consumer.internals.AbstractCoordinator  Discovered coordinator p1kaf1.prod.apptegic.com:9092 (id: 2147482646 rack: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; group evergage-app.
INFO  2017-05-10 02:58:26,126 o.a.k.c.consumer.internals.ConsumerCoordinator  Revoking previously assigned partitions [] &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; group evergage-app
INFO  2017-05-10 02:58:26,126 org.apache.kafka.streams.KafkaStreams  stream-client [evergage-app-bd9c9868-4b9b-4d2e-850f-9b5bec1fc0a9] State transition from RUNNING to REBALANCING.
INFO  2017-05-10 02:58:26,127 o.a.k.c.consumer.internals.AbstractCoordinator  (Re-)joining group evergage-app
INFO  2017-05-10 02:58:27,712 o.a.k.c.consumer.internals.AbstractCoordinator  Successfully joined group evergage-app with generation 18
INFO  2017-05-10 02:58:27,716 o.a.k.c.consumer.internals.ConsumerCoordinator  Setting newly assigned partitions [us.app.Trigger-0] &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; group evergage-app
INFO  2017-05-10 02:58:27,716 org.apache.kafka.streams.KafkaStreams  stream-client [evergage-app-bd9c9868-4b9b-4d2e-850f-9b5bec1fc0a9] State transition from REBALANCING to REBALANCING.
INFO  2017-05-10 02:58:27,729 o.a.kafka.streams.processor.internals.StreamTask  task [0_0] Initializing state stores
INFO  2017-05-10 02:58:27,731 o.a.kafka.streams.processor.internals.StreamTask  task [0_0] Initializing processor nodes of the topology
INFO  2017-05-10 02:58:27,742 org.apache.kafka.streams.KafkaStreams  stream-client [evergage-app-bd9c9868-4b9b-4d2e-850f-9b5bec1fc0a9] State transition from REBALANCING to RUNNING.

[14 hours pass...]

INFO  2017-05-10 16:21:27,476 o.a.k.c.consumer.internals.ConsumerCoordinator  Revoking previously assigned partitions [us.app.Trigger-0] &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; group evergage-app
INFO  2017-05-10 16:21:27,477 org.apache.kafka.streams.KafkaStreams  stream-client [evergage-app-bd9c9868-4b9b-4d2e-850f-9b5bec1fc0a9] State transition from RUNNING to REBALANCING.
INFO  2017-05-10 16:21:27,482 o.a.k.c.consumer.internals.AbstractCoordinator  (Re-)joining group evergage-app
INFO  2017-05-10 16:21:27,489 o.a.k.c.consumer.internals.AbstractCoordinator  Successfully joined group evergage-app with generation 19
INFO  2017-05-10 16:21:27,489 o.a.k.c.consumer.internals.ConsumerCoordinator  Setting newly assigned partitions [us.app.Trigger-0] &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; group evergage-app
INFO  2017-05-10 16:21:27,489 org.apache.kafka.streams.KafkaStreams  stream-client [evergage-app-bd9c9868-4b9b-4d2e-850f-9b5bec1fc0a9] State transition from REBALANCING to REBALANCING.
INFO  2017-05-10 16:21:27,489 o.a.kafka.streams.processor.internals.StreamTask  task [0_0] Initializing processor nodes of the topology
INFO  2017-05-10 16:21:27,493 org.apache.kafka.streams.KafkaStreams  stream-client [evergage-app-bd9c9868-4b9b-4d2e-850f-9b5bec1fc0a9] State transition from REBALANCING to RUNNING.
INFO  2017-05-10 16:21:30,584 o.a.k.c.consumer.internals.ConsumerCoordinator  Revoking previously assigned partitions [us.app.Trigger-0] &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; group evergage-app
INFO  2017-05-10 16:21:30,584 org.apache.kafka.streams.KafkaStreams  stream-client [evergage-app-bd9c9868-4b9b-4d2e-850f-9b5bec1fc0a9] State transition from RUNNING to REBALANCING.
INFO  2017-05-10 16:21:30,588 o.a.k.c.consumer.internals.AbstractCoordinator  (Re-)joining group evergage-app
INFO  2017-05-10 16:21:30,593 o.a.k.c.consumer.internals.AbstractCoordinator  Successfully joined group evergage-app with generation 20
INFO  2017-05-10 16:21:30,594 o.a.k.c.consumer.internals.ConsumerCoordinator  Setting newly assigned partitions [demo.retail.Trigger-0, us.app.Trigger-0] &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; group evergage-app
INFO  2017-05-10 16:21:30,594 org.apache.kafka.streams.KafkaStreams  stream-client [evergage-app-bd9c9868-4b9b-4d2e-850f-9b5bec1fc0a9] State transition from REBALANCING to REBALANCING.
INFO  2017-05-10 16:21:30,595 o.a.kafka.streams.processor.internals.StreamTask  task [0_0] Initializing state stores
INFO  2017-05-10 16:21:30,596 o.a.kafka.streams.processor.internals.StreamTask  task [0_0] Initializing processor nodes of the topology
INFO  2017-05-10 16:21:30,602 org.apache.kafka.streams.KafkaStreams  stream-client [evergage-app-bd9c9868-4b9b-4d2e-850f-9b5bec1fc0a9] State transition from REBALANCING to RUNNING.
INFO  2017-05-10 16:21:30,698 org.apache.kafka.clients.producer.KafkaProducer  Closing the Kafka producer with timeoutMillis = 9223372036854775807 ms.
WARN  2017-05-10 16:21:30,703 o.a.kafka.streams.processor.internals.StreamThread  stream-thread [StreamThread-1] Unexpected state transition from RUNNING to NOT_RUNNING.
ERROR 2017-05-10 16:21:30,704 c.a.a.web.server.UncaughtExceptionLoggingListener  Uncaught exception in thread [StreamThread-1]
org.apache.kafka.streams.errors.StreamsException: Failed to deserialize key &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; record. topic=demo.retail.Trigger, partition=0, offset=0
	at org.apache.kafka.streams.processor.internals.SourceNodeRecordDeserializer.deserialize(SourceNodeRecordDeserializer.java:38)
	at org.apache.kafka.streams.processor.internals.RecordQueue.addRawRecords(RecordQueue.java:85)
	at org.apache.kafka.streams.processor.internals.PartitionGroup.addRawRecords(PartitionGroup.java:117)
	at org.apache.kafka.streams.processor.internals.StreamTask.addRecords(StreamTask.java:158)
	at org.apache.kafka.streams.processor.internals.StreamThread.runLoop(StreamThread.java:605)
	at org.apache.kafka.streams.processor.internals.StreamThread.run(StreamThread.java:361)
Caused by: java.lang.NullPointerException: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
	at org.apache.kafka.streams.processor.internals.SourceNodeRecordDeserializer.deserialize(SourceNodeRecordDeserializer.java:36)
	... 5 common frames omitted
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>64-bit Amazon Linux, JDK8</environment>
        <key id="13071588">KAFKA-5226</key>
            <summary>NullPointerException (NPE) in SourceNodeRecordDeserializer.deserialize</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="bbejeck">Bill Bejeck</assignee>
                                    <reporter username="ian.springer">Ian Springer</reporter>
                        <labels>
                    </labels>
                <created>Fri, 12 May 2017 16:29:24 +0000</created>
                <updated>Thu, 1 Jun 2017 02:38:16 +0000</updated>
                            <resolved>Thu, 1 Jun 2017 02:36:30 +0000</resolved>
                                    <version>0.10.2.1</version>
                                    <fixVersion>0.11.0.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16008427" author="mjsax" created="Fri, 12 May 2017 17:27:24 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ian.springer&quot; class=&quot;user-hover&quot; rel=&quot;ian.springer&quot;&gt;ian.springer&lt;/a&gt; Thanks for reporting this. It&apos;s hard to say from the stacktrace. What is your data type for key and value and what serdes do you use?&lt;/p&gt;</comment>
                            <comment id="16008543" author="ian.springer" created="Fri, 12 May 2017 18:41:14 +0000"  >&lt;p&gt;The key data type is a String (UUID), and the value data type is a POJO serialized to SMILE via Jackson. Here&apos;s how we configure the serdes for the streams:&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Serde&amp;lt;MyPojo&amp;gt; myPojoSerde = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SmileSerializer&amp;lt;&amp;gt;(MyPojo.class).toSerde();
KStreamBuilder builder = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; KStreamBuilder();
KStream&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, MyPojo&amp;gt; myPojoStream = builder.stream(Serdes.&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;(), myPojoSerde, TOPIC_NAME_PATTERN);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And here is the SmileSerializer class:&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;package&lt;/span&gt; foo.serialization;

&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; foo.util.ObjectMapperHolder;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; com.fasterxml.jackson.core.JsonProcessingException;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; com.fasterxml.jackson.databind.ObjectMapper;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.kafka.common.serialization.Deserializer;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.kafka.common.serialization.Serde;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.kafka.common.serialization.Serdes;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.kafka.common.serialization.Serializer;

&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.io.Closeable;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.io.IOException;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.util.Map;

&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;SmileSerializer&amp;lt;T&amp;gt;
        &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; Closeable, Serializer&amp;lt;T&amp;gt;, Deserializer&amp;lt;T&amp;gt; {

    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ObjectMapper MAPPER = ObjectMapperHolder.getInstance().getSmileObjectMapper();

    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;&amp;lt;T&amp;gt; type;

    @SuppressWarnings(&lt;span class=&quot;code-quote&quot;&gt;&quot;unused&quot;&lt;/span&gt;)
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; SmileSerializer() {
    }

    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; SmileSerializer(&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;&amp;lt;T&amp;gt; type) {
        &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.type = type;
    }

    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void configure(Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, ?&amp;gt; config, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isKey) {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
    }

    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] serialize(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; topicId, T data) {
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; MAPPER.writeValueAsBytes(data);
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (JsonProcessingException e) {
            &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IllegalArgumentException(e);
        }
    }

    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; T deserialize(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; s, &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] bytes) {
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; MAPPER.readValue(bytes, type);
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException e) {
            &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IllegalArgumentException(e);
        }
    }

    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void close() {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
    }

    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; Serde&amp;lt;T&amp;gt; toSerde() {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; Serdes.serdeFrom(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;);
    }

}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16008704" author="mjsax" created="Fri, 12 May 2017 21:15:20 +0000"  >&lt;p&gt;Thanks for sharing. The loc raising the exception is as follows:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;        try {
            key = sourceNode.deserializeKey(rawRecord.topic(), rawRecord.key());
        } catch (Exception e) {
            throw new StreamsException(format(&quot;Failed to deserialize key for record. topic=%s, partition=%d, offset=%d&quot;,
                                              rawRecord.topic(), rawRecord.partition(), rawRecord.offset()), e);
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;As we see a proper exception message, we know that &lt;tt&gt;rawRecord&lt;/tt&gt; is not &lt;tt&gt;null&lt;/tt&gt;, thus, the NPE could only occur if &lt;tt&gt;sourceNode&lt;/tt&gt; would be &lt;tt&gt;null&lt;/tt&gt; or the call to &lt;tt&gt;deserializeKey()&lt;/tt&gt; throws. If &lt;tt&gt;sourceNode&lt;/tt&gt; would be &lt;tt&gt;null&lt;/tt&gt; it would fail for each input record, that I want to rule this out. Furthermore, &lt;tt&gt;deserializeKey()&lt;/tt&gt; is a  single liner: &lt;tt&gt;return keyDeserializer.deserialize(topic, data);&lt;/tt&gt; Thus, I assume that the NPE come from your code within &lt;tt&gt;deserialize&lt;/tt&gt;. I am not familiar with how your code works in detail, but can it handle &lt;tt&gt;null&lt;/tt&gt; properly? Do you have &lt;tt&gt;null&lt;/tt&gt; keys in your input topic for some (very rare message) that could trigger a NPE?&lt;/p&gt;</comment>
                            <comment id="16008885" author="ian.springer" created="Fri, 12 May 2017 23:09:00 +0000"  >&lt;p&gt;That&apos;s not how I read the stack trace. If my code was causing the NPE, the line immediately after &quot;Caused by: java.lang.NullPointerException: null&quot;  (i.e. the first line of the root cause stack trace) would be a line from one of my classes. I read it as either sourceNode or rawRecord being null. I suppose it&apos;s also possible something is truncating the stack trace. My uncaught exception handler is simply logging the error using Logback.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void uncaughtException(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; t, Throwable e) {
        log.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Uncaught exception in thread [{}]&quot;&lt;/span&gt;, t.getName(), e);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I don&apos;t think the JDK is trimming the stack trace at all, since the exception only occurred twice.&lt;/p&gt;</comment>
                            <comment id="16009080" author="mjsax" created="Sat, 13 May 2017 03:08:45 +0000"  >&lt;p&gt;I see your point, however, it&apos;s unclear to me how &lt;tt&gt;rawRecord&lt;/tt&gt; could be &lt;tt&gt;null&lt;/tt&gt; as we access &lt;tt&gt;rawRecord&lt;/tt&gt; successfully to generate the exception message that show up complete in the stack trace. And &lt;tt&gt;sourceNode&lt;/tt&gt; is only set once at startup &amp;#8211; thus, the error would occur for all records as all record go through this code path to get de-serialized.&lt;/p&gt;

&lt;p&gt;The only scenario I can think of atm that would explain this would be if the error occurs directly after a rebalance, fails for the first record, and another rebalance happens (and after the second rebalance we do initialize everything correctly). Can you see from the logs if this scenario could be the case? Can you maybe call &lt;tt&gt;e.printStrackTrace&lt;/tt&gt; so we can get the complete stacktrace in case it happens again.&lt;/p&gt;

&lt;p&gt;Just to be sure, can you also double check that your serde does handle &lt;tt&gt;null&lt;/tt&gt; without problems? Do you know if you have records with &lt;tt&gt;null&lt;/tt&gt; key and confirm if those could cause the problem or not? That would help a lot to limit the number of possible root causes. Thanks a lot.&lt;/p&gt;</comment>
                            <comment id="16009418" author="ian.springer" created="Sat, 13 May 2017 16:47:33 +0000"  >&lt;p&gt;The key serde is not a custom serde. It&apos;s org.apache.kafka.common.serialization.Serdes.StringSerde, which wraps org.apache.kafka.common.serialization.StringDeserializer. And org.apache.kafka.common.serialization.StringDeserializer#deserialize does check for a null data param. &lt;/p&gt;

&lt;p&gt;I can add an e.printStackTrace, but I suspect we are already seeing the full stack trace, aside from the &quot;5 common frames omitted&quot;. With the 5 omitted frames included, it would just look like this:&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;org.apache.kafka.streams.errors.StreamsException: Failed to deserialize key &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; record. topic=demo.retail.Trigger, partition=0, offset=0
	at org.apache.kafka.streams.processor.internals.SourceNodeRecordDeserializer.deserialize(SourceNodeRecordDeserializer.java:38)
	at org.apache.kafka.streams.processor.internals.RecordQueue.addRawRecords(RecordQueue.java:85)
	at org.apache.kafka.streams.processor.internals.PartitionGroup.addRawRecords(PartitionGroup.java:117)
	at org.apache.kafka.streams.processor.internals.StreamTask.addRecords(StreamTask.java:158)
	at org.apache.kafka.streams.processor.internals.StreamThread.runLoop(StreamThread.java:605)
	at org.apache.kafka.streams.processor.internals.StreamThread.run(StreamThread.java:361)
Caused by: java.lang.NullPointerException: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
	at org.apache.kafka.streams.processor.internals.SourceNodeRecordDeserializer.deserialize(SourceNodeRecordDeserializer.java:36)
	at org.apache.kafka.streams.processor.internals.RecordQueue.addRawRecords(RecordQueue.java:85)
	at org.apache.kafka.streams.processor.internals.PartitionGroup.addRawRecords(PartitionGroup.java:117)
	at org.apache.kafka.streams.processor.internals.StreamTask.addRecords(StreamTask.java:158)
	at org.apache.kafka.streams.processor.internals.StreamThread.runLoop(StreamThread.java:605)
	at org.apache.kafka.streams.processor.internals.StreamThread.run(StreamThread.java:361)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We&apos;re not sending any records with null keys. Here&apos;s the code we use to send records:&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; recordKey = UUID.randomUUID().toString();
ProducerRecord&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, MyPojo&amp;gt; record = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ProducerRecord&amp;lt;&amp;gt;(topic, recordKey, myPojo);
producer.send(record, &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;::processSendResult));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16009462" author="mjsax" created="Sat, 13 May 2017 18:50:00 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ian.springer&quot; class=&quot;user-hover&quot; rel=&quot;ian.springer&quot;&gt;ian.springer&lt;/a&gt; You are right &amp;#8211; I mixed up key and value. We have a similar report in &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5154&quot; title=&quot;Kafka Streams throws NPE during rebalance&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-5154&quot;&gt;&lt;del&gt;KAFKA-5154&lt;/del&gt;&lt;/a&gt; that also gets a NPE after rebalance (but a different one). Maybe it&apos;s the same root cause, ie, I suspect there is some race condition during rebalance, we compute the tasks (base on partition assignment) incorrectly.&lt;/p&gt;

&lt;p&gt;Can you share some the whole log? You can attach it to this Jira as a file. We need to dig deeper into that... &lt;/p&gt;</comment>
                            <comment id="16010502" author="ian.springer" created="Mon, 15 May 2017 13:22:37 +0000"  >&lt;p&gt;Here&apos;s the full log file.&lt;/p&gt;</comment>
                            <comment id="16011452" author="mjsax" created="Mon, 15 May 2017 22:42:38 +0000"  >&lt;p&gt;Thanks for the logs. It seems you subscribe via pattern. I guess there is some issue there. What is your pattern expression? Are the input topics created before you start your Streams application? What are the topic names you want to consume from?&lt;/p&gt;</comment>
                            <comment id="16011590" author="ian.springer" created="Tue, 16 May 2017 01:24:33 +0000"  >&lt;p&gt;The pattern expression we&apos;re using is &quot;&lt;span class=&quot;error&quot;&gt;&amp;#91;a-z&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;a-z0-9&amp;#93;&lt;/span&gt;{0,19}.&lt;span class=&quot;error&quot;&gt;&amp;#91;a-z&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;a-z_0-9&amp;#93;&lt;/span&gt;{2,31}.Trigger&quot;. An example topic name would be &quot;foo.bar.Trigger&quot;. We don&apos;t pre-create the topics. We let Kafka lazily auto-create topics that don&apos;t already exist.&lt;/p&gt;</comment>
                            <comment id="16025404" author="bbejeck" created="Thu, 25 May 2017 21:11:17 +0000"  >&lt;p&gt;I&apos;ve been able to reproduce the problem.  The issue is not with the `SourceNodeRecordDeserializer`, that&apos;s just the symptom.  &lt;/p&gt;

&lt;p&gt;My steps to reproduce:&lt;br/&gt;
   1. Start 3 instances of a simple streams application with regex subscription.&lt;br/&gt;
   2. Add topics with names matching the pattern.&lt;/p&gt;

&lt;p&gt;It doesn&apos;t always happen, so I needed to make a few attempts.&lt;/p&gt;

&lt;p&gt;The issue is sometimes when a topic is added (while a streams app with regex subscription is running) the new topic does not get passed into the `StreamPartitionAssignor.subscribe` method, but it will show up during a rebalance.    In the `StreamPartitionAssignor.subscribe` method we update the topology with any topics matching the subscription regex.  When we go to create the stream task for the new assignment we don&apos;t have corresponding source node for the topic, causing the error.   &lt;/p&gt;

&lt;p&gt;Here&apos;s the relevant log lines (logs from all 3 applications attached) from me reproducing the error by adding a topic named `foo.Trigger`.  The `StreamPartitionAssignor` only gets passed the topics `us.Trigger` and `demo.Trigger`.  But during the rebalance the following are assignments are passed to the `ConsumerRebalanceListener.onPartitionsAssigned` method `us.Trigger`, `demo.Trigger` and `foo.Trigger`&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;2017-05-24 15:30:14,367&amp;#93;&lt;/span&gt; DEBUG stream-thread &lt;span class=&quot;error&quot;&gt;&amp;#91;reballancing-test-df1e3cfa-5620-4a81-89bf-88ed14115321-StreamThread-1&amp;#93;&lt;/span&gt; found &lt;span class=&quot;error&quot;&gt;&amp;#91;us.Trigger, demo.Trigger&amp;#93;&lt;/span&gt; topics possibly matching regex (org.apache.kafka.streams.processor.internals.StreamPartitionAssignor:258)&lt;br/&gt;
....&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2017-05-24 15:30:14,474&amp;#93;&lt;/span&gt; INFO stream-thread &lt;span class=&quot;error&quot;&gt;&amp;#91;reballancing-test-df1e3cfa-5620-4a81-89bf-88ed14115321-StreamThread-1&amp;#93;&lt;/span&gt; at state PARTITIONS_REVOKED: new partitions &lt;span class=&quot;error&quot;&gt;&amp;#91;foo.Trigger-1, us.Trigger-1, demo.Trigger-1&amp;#93;&lt;/span&gt; assigned at the end of consumer rebalance.&lt;br/&gt;
.....&lt;br/&gt;
2017-05-24 15:30:14,478] INFO stream-thread &lt;span class=&quot;error&quot;&gt;&amp;#91;reballancing-test-df1e3cfa-5620-4a81-89bf-88ed14115321-StreamThread-1&amp;#93;&lt;/span&gt; Created active task 0_1 with assigned partitions &lt;span class=&quot;error&quot;&gt;&amp;#91;foo.Trigger-1, us.Trigger-1, demo.Trigger-1&amp;#93;&lt;/span&gt; (org.apache.kafka.streams.processor.internals.StreamThread:1240)&lt;/p&gt;
</comment>
                            <comment id="16025688" author="ian.springer" created="Fri, 26 May 2017 02:05:02 +0000"  >&lt;p&gt;Thanks for the update, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bbejeck&quot; class=&quot;user-hover&quot; rel=&quot;bbejeck&quot;&gt;bbejeck&lt;/a&gt;. That&apos;s great news.&lt;/p&gt;</comment>
                            <comment id="16026899" author="githubbot" created="Fri, 26 May 2017 21:48:01 +0000"  >&lt;p&gt;GitHub user bbejeck opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/3157&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3157&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5226&quot; title=&quot;NullPointerException (NPE) in SourceNodeRecordDeserializer.deserialize&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-5226&quot;&gt;&lt;del&gt;KAFKA-5226&lt;/del&gt;&lt;/a&gt;: Fixes issue where adding topics matching a regex&lt;/p&gt;

&lt;p&gt;    subscribed stream may not be detected by all followers until&lt;br/&gt;
    onJoinComplete returns.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/bbejeck/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/bbejeck/kafka&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5226&quot; title=&quot;NullPointerException (NPE) in SourceNodeRecordDeserializer.deserialize&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-5226&quot;&gt;&lt;del&gt;KAFKA-5226&lt;/del&gt;&lt;/a&gt;_null_pointer_source_node_deserialize&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/3157.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3157.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #3157&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit ed3c3602f7ac794c29686e95ade822dd22d7be97&lt;br/&gt;
Author: Bill Bejeck &amp;lt;bill@confluent.io&amp;gt;&lt;br/&gt;
Date:   2017-05-26T21:42:14Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5226&quot; title=&quot;NullPointerException (NPE) in SourceNodeRecordDeserializer.deserialize&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-5226&quot;&gt;&lt;del&gt;KAFKA-5226&lt;/del&gt;&lt;/a&gt;: Fixes issue where adding topics matching a regex&lt;br/&gt;
    subscribed stream may not be detected by all followers until&lt;br/&gt;
    onJoinComplete returns.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16032343" author="guozhang" created="Thu, 1 Jun 2017 02:36:30 +0000"  >&lt;p&gt;Issue resolved by pull request 3157&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/kafka/pull/3157&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3157&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16032344" author="githubbot" created="Thu, 1 Jun 2017 02:37:16 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/3157&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3157&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16032345" author="guozhang" created="Thu, 1 Jun 2017 02:38:16 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ian.springer&quot; class=&quot;user-hover&quot; rel=&quot;ian.springer&quot;&gt;ian.springer&lt;/a&gt; The fix has just been merged into trunk and will be released in this week&apos;s 0.11.0.0 RC0. Please feel free to also apply the patch to your built app locally if you have seen it happen multiple times in your production environment.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12868072" name="kafka.log" size="29957" author="ian.springer" created="Mon, 15 May 2017 13:22:37 +0000"/>
                            <attachment id="12869934" name="streamsAppOne.log" size="94477" author="bbejeck" created="Thu, 25 May 2017 21:11:56 +0000"/>
                            <attachment id="12869935" name="streamsAppThree.log" size="38933" author="bbejeck" created="Thu, 25 May 2017 21:11:56 +0000"/>
                            <attachment id="12869936" name="streamsAppTwo.log" size="44424" author="bbejeck" created="Thu, 25 May 2017 21:11:56 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 24 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3ewov:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>