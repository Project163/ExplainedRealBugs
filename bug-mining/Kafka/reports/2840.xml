<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:26:12 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-10758] Kafka Streams consuming from a pattern goes to PENDING_SHUTDOWN when adding a new topic</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-10758</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;I have a simple Kafka Stream app that consumes from multiple input&#160;topics using the&#160;&lt;em&gt;stream&lt;/em&gt;&#160;function that accepts a Pattern (&lt;a href=&quot;https://kafka.apache.org/26/javadoc/org/apache/kafka/streams/StreamsBuilder.html#stream-java.util.regex.Pattern-&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;link&lt;/a&gt;).&lt;br/&gt;
&#160;&lt;br/&gt;
Whenever I add a new topic that matches the pattern the kafka stream state goes to REBALANCING -&amp;gt; ERROR -&amp;gt; PENDING_SHUTDOWN .&lt;br/&gt;
If I restart the app it correctly starts reading again without problems.&lt;br/&gt;
It is by design? Should I handle this and simply restart the app?&lt;br/&gt;
&#160;&lt;br/&gt;
Kafka Stream version is 2.6.0.&lt;br/&gt;
The error is the following:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ERROR o.a.k.s.p.i.ProcessorTopology - Set of source nodes &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; not match:
sourceNodesByName = [KSTREAM-SOURCE-0000000003, KSTREAM-SOURCE-0000000002]
sourceTopicsByName = [KSTREAM-SOURCE-0000000000, KSTREAM-SOURCE-0000000014, KSTREAM-SOURCE-0000000003, KSTREAM-SOURCE-0000000002]
org.apache.kafka.common.KafkaException: User rebalance callback &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; an error
&#160; at org.apache.kafka.clients.consumer.internals.ConsumerCoordinator.onJoinComplete(ConsumerCoordinator.java:436)
&#160; at org.apache.kafka.clients.consumer.internals.AbstractCoordinator.joinGroupIfNeeded(AbstractCoordinator.java:440)
&#160; at org.apache.kafka.clients.consumer.internals.AbstractCoordinator.ensureActiveGroup(AbstractCoordinator.java:359)
&#160; at org.apache.kafka.clients.consumer.internals.ConsumerCoordinator.poll(ConsumerCoordinator.java:513)
&#160; at org.apache.kafka.clients.consumer.KafkaConsumer.updateAssignmentMetadataIfNeeded(KafkaConsumer.java:1268)
&#160; at org.apache.kafka.clients.consumer.KafkaConsumer.poll(KafkaConsumer.java:1230)
&#160; at org.apache.kafka.clients.consumer.KafkaConsumer.poll(KafkaConsumer.java:1210)
&#160; at org.apache.kafka.streams.processor.internals.StreamThread.pollRequests(StreamThread.java:766)
&#160; at org.apache.kafka.streams.processor.internals.StreamThread.runOnce(StreamThread.java:624)
&#160; at org.apache.kafka.streams.processor.internals.StreamThread.runLoop(StreamThread.java:551)
&#160; at org.apache.kafka.streams.processor.internals.StreamThread.run(StreamThread.java:510)
&#160;Caused by: java.lang.IllegalStateException: Tried to update source topics but source nodes did not match
&#160; at org.apache.kafka.streams.processor.internals.ProcessorTopology.updateSourceTopics(ProcessorTopology.java:151)
&#160; at org.apache.kafka.streams.processor.internals.AbstractTask.update(AbstractTask.java:109)
&#160; at org.apache.kafka.streams.processor.internals.StreamTask.update(StreamTask.java:514)
&#160; at org.apache.kafka.streams.processor.internals.TaskManager.updateInputPartitionsAndResume(TaskManager.java:397)
&#160; at org.apache.kafka.streams.processor.internals.TaskManager.handleAssignment(TaskManager.java:261)
&#160; at org.apache.kafka.streams.processor.internals.StreamsPartitionAssignor.onAssignment(StreamsPartitionAssignor.java:1428)
&#160; at org.apache.kafka.clients.consumer.internals.ConsumerCoordinator.invokeOnAssignment(ConsumerCoordinator.java:279)
&#160; at org.apache.kafka.clients.consumer.internals.ConsumerCoordinator.onJoinComplete(ConsumerCoordinator.java:421)
&#160; ... 10 common frames omitted
&#160;KafkaStream state is ERROR
&#160;17:28:53.200 [datalake-StreamThread-1] ERROR o.apache.kafka.streams.KafkaStreams - stream-client [datalake] All stream threads have died. The instance will be in error state and should be closed.
&#160;============&amp;gt; User rebalance callback &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; an error
&#160;KafkaStream state is PENDING_SHUTDOWN
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;br/&gt;
&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13341941">KAFKA-10758</key>
            <summary>Kafka Streams consuming from a pattern goes to PENDING_SHUTDOWN when adding a new topic</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ableegoldman">A. Sophie Blee-Goldman</assignee>
                                    <reporter username="davideicardi">Davide Icardi</reporter>
                        <labels>
                    </labels>
                <created>Sat, 21 Nov 2020 21:36:20 +0000</created>
                <updated>Mon, 30 Nov 2020 19:13:24 +0000</updated>
                            <resolved>Wed, 25 Nov 2020 02:25:05 +0000</resolved>
                                    <version>2.6.0</version>
                                    <fixVersion>2.6.1</fixVersion>
                    <fixVersion>2.7.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17237270" author="cadonna" created="Mon, 23 Nov 2020 10:21:57 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davideicardi&quot; class=&quot;user-hover&quot; rel=&quot;davideicardi&quot;&gt;davideicardi&lt;/a&gt; Thank you for the report!&lt;/p&gt;

&lt;p&gt;Could you please also post your call to&#160;&lt;tt&gt;StreamsBuilder#stream(Pattern)&lt;/tt&gt; and your topology description that you can get with&#160;&lt;tt&gt;topology.describe().toString()&lt;/tt&gt;?&lt;/p&gt;</comment>
                            <comment id="17237407" author="davideicardi" created="Mon, 23 Nov 2020 14:34:28 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cadonna&quot; class=&quot;user-hover&quot; rel=&quot;cadonna&quot;&gt;cadonna&lt;/a&gt;&#160;here the details requested:&lt;/p&gt;

&lt;p&gt;I have this code:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; val inputCommandsStream =
    streamsBuilder.stream[Key, Envelop[RawDataCommand]](Pattern.compile(&lt;span class=&quot;code-quote&quot;&gt;&quot;^ingestion\\.datalake\\..+\\..+\\.commands$&quot;&lt;/span&gt;))
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; val inputEventStream =
    streamsBuilder.stream[Key, Envelop[RawDataEvent]](Pattern.compile(&lt;span class=&quot;code-quote&quot;&gt;&quot;^ingestion\\.datalake\\..+\\..+\\.events&quot;&lt;/span&gt;))
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;And here the topology:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Topologies:
   Sub-topology: 0
    Source: KSTREAM-SOURCE-0000000000 (topics: [ingestion.datasources.events])
      --&amp;gt; KSTREAM-PROCESSOR-0000000001
    Processor: KSTREAM-PROCESSOR-0000000001 (stores: [])
      --&amp;gt; none
      &amp;lt;-- KSTREAM-SOURCE-0000000000  Sub-topology: 1
    Source: KSTREAM-SOURCE-0000000002 (topics: ^ingestion\.datalake\..+\..+\.commands$)
      --&amp;gt; KSTREAM-LEFTJOIN-0000000006
    Processor: KSTREAM-LEFTJOIN-0000000006 (stores: [ingestion.datalake.store.snapshots])
      --&amp;gt; KSTREAM-MAP-0000000010, KSTREAM-SINK-0000000007
      &amp;lt;-- KSTREAM-SOURCE-0000000002
    Source: KSTREAM-SOURCE-0000000003 (topics: ^ingestion\.datalake\..+\..+\.events)
      --&amp;gt; KSTREAM-FILTER-0000000004
    Processor: KSTREAM-FILTER-0000000004 (stores: [])
      --&amp;gt; KSTREAM-AGGREGATE-0000000005
      &amp;lt;-- KSTREAM-SOURCE-0000000003
    Processor: KSTREAM-AGGREGATE-0000000005 (stores: [ingestion.datalake.store.snapshots])
      --&amp;gt; KTABLE-TOSTREAM-0000000008
      &amp;lt;-- KSTREAM-FILTER-0000000004
    Processor: KSTREAM-MAP-0000000010 (stores: [])
      --&amp;gt; KSTREAM-FILTER-0000000013
      &amp;lt;-- KSTREAM-LEFTJOIN-0000000006
    Processor: KSTREAM-FILTER-0000000013 (stores: [])
      --&amp;gt; KSTREAM-SINK-0000000012
      &amp;lt;-- KSTREAM-MAP-0000000010
    Processor: KTABLE-TOSTREAM-0000000008 (stores: [])
      --&amp;gt; KSTREAM-SINK-0000000009
      &amp;lt;-- KSTREAM-AGGREGATE-0000000005
    Sink: KSTREAM-SINK-0000000007 (extractor class: service.streaming.EventStreamTopicNameExtractor@20801cbb)
      &amp;lt;-- KSTREAM-LEFTJOIN-0000000006
    Sink: KSTREAM-SINK-0000000009 (extractor class: service.streaming.SnapshotStreamTopicNameExtractor@1c240cf2)
      &amp;lt;-- KTABLE-TOSTREAM-0000000008
    Sink: KSTREAM-SINK-0000000012 (topic: KSTREAM-TOTABLE-0000000011-repartition)
      &amp;lt;-- KSTREAM-FILTER-0000000013  Sub-topology: 2
    Source: KSTREAM-SOURCE-0000000014 (topics: [KSTREAM-TOTABLE-0000000011-repartition])
      --&amp;gt; KSTREAM-TOTABLE-0000000011
    Processor: KSTREAM-TOTABLE-0000000011 (stores: [ingestion.datalake.store.eventsByMsgId])
      --&amp;gt; none
      &amp;lt;-- KSTREAM-SOURCE-0000000014

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;It is a work in progress, for sure to be optimized, but I don&apos;t understand the reason for the error.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;thanks!&lt;/p&gt;</comment>
                            <comment id="17237410" author="davideicardi" created="Mon, 23 Nov 2020 14:36:26 +0000"  >&lt;p&gt;Also, to be more precise, the error doesn&apos;t happen exactly when I add the topic. But I think it happens when the app try to refresh the topics information. I think every 5 mins by default. Right?&lt;/p&gt;</comment>
                            <comment id="17237778" author="ableegoldman" created="Tue, 24 Nov 2020 01:33:26 +0000"  >&lt;p&gt;Hey &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davideicardi&quot; class=&quot;user-hover&quot; rel=&quot;davideicardi&quot;&gt;davideicardi&lt;/a&gt;, thanks for submitting this ticket. Looks like there&apos;s a bug in the topic update logic. I&apos;ve opened a PR which we should be able to get into the 2.6.1 and 2.7.0 releases.&lt;/p&gt;

&lt;p&gt;Just to answer some of your other questions: yes, this error wouldn&apos;t appear right after the topic was created but only once the Streams app refreshed its topic metadata (5min default as you said). Yes, it should be safe to just restart the application after hitting this error as a workaround. And no, this was not by design &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&#160;&lt;/p&gt;

&lt;p&gt;Sorry for the trouble. Obviously I&apos;d recommend upgrading to 2.6.1 to get the fix once it&apos;s been released, but for now you should be ok to just ignore it and start up the application again. You&apos;ll only hit this error once, since after the restart there&apos;s no need to update anything&lt;/p&gt;</comment>
                            <comment id="17238300" author="davideicardi" created="Tue, 24 Nov 2020 18:16:46 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ableegoldman&quot; class=&quot;user-hover&quot; rel=&quot;ableegoldman&quot;&gt;ableegoldman&lt;/a&gt;&#160;Thank you very much!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 50 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0kte0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>