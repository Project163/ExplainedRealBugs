<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:38:14 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-16352] Transaction may get get stuck in PrepareCommit or PrepareAbort state</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-16352</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;A transaction took a long time to complete, trying to restart a producer would lead to CONCURRENT_TRANSACTION errors.&#160; Investigation has shown that the transaction was stuck in PrepareCommit for a few days:&lt;/p&gt;

&lt;p&gt;(current time when the investigation happened: Feb 27 2024), transaction state:&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;Type &#160; |Name &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;|Value&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;-----------------------------------------------------------------------------------------&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;ref &#160; &#160;|transactionalId &#160; &#160; &#160; |xxx-yyy&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;long &#160; |producerId &#160; &#160; &#160; &#160; &#160; &#160;|299364&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;ref &#160; &#160;|state &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; |kafka.coordinator.transaction.PrepareCommit$ @ 0x44fe22760&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;long &#160; |txnStartTimestamp &#160; &#160; |1708619624810 &#160;Thu Feb 22 2024 16:33:44.810 GMT+0000&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;long &#160; |txnLastUpdateTimestamp|1708619625335 &#160;Thu Feb 22 2024 16:33:45.335 GMT+0000&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;-----------------------------------------------------------------------------------------&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;The partition list was empty and transactionsWithPendingMarkers didn&apos;t contain the reference to the transactional state.&#160; In the log there were the following relevant messages:&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;22 Feb 2024 @ 16:33:45.623 UTC &lt;span class=&quot;error&quot;&gt;&amp;#91;Transaction State Manager 1&amp;#93;&lt;/span&gt;: Completed loading transaction metadata from __transaction_state-3 for coordinator epoch 611&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;(this is the partition that contains the transactional id).&#160; After the data is loaded, it sends out markers and etc.&lt;/p&gt;

&lt;p&gt;Then there is this message:&lt;/p&gt;

&lt;p&gt;{{22 Feb 2024 @ 16:33:45.696 UTC &lt;span class=&quot;error&quot;&gt;&amp;#91;Transaction Marker Request Completion Handler 4&amp;#93;&lt;/span&gt;: Transaction coordinator epoch for xxx-yyy has changed from 610 to 611; cancel sending transaction markers TxnMarkerEntry&lt;/p&gt;
{producerId=299364, producerEpoch=1005, coordinatorEpoch=610, result=COMMIT, partitions=[foo-bar]}
&lt;p&gt; to the brokers}}&lt;/p&gt;

&lt;p&gt;this message is logged just before the state is removed transactionsWithPendingMarkers, but the state apparently contained the entry that was created by the load operation.&#160; So the sequence of events probably looked like the following:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;partition load completed&lt;/li&gt;
	&lt;li&gt;commit markers were sent for transactional id xxx-yyy; entry in transactionsWithPendingMarkers was created&lt;/li&gt;
	&lt;li&gt;zombie reply from the previous epoch completed, removed entry from transactionsWithPendingMarkers&lt;/li&gt;
	&lt;li&gt;commit markers properly completed, but couldn&apos;t transition to CommitComplete state because transactionsWithPendingMarkers didn&apos;t have the proper entry, so it got stuck there until the broker was restarted&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Looking at the code there are a few cases that could lead to similar race conditions.&#160; The fix is to keep track of the PendingCompleteTxn value that was used when sending the marker, so that we can only remove the state that was created when the marker was sent and not accidentally remove the state someone else created.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13571193">KAFKA-16352</key>
            <summary>Transaction may get get stuck in PrepareCommit or PrepareAbort state</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="alivshits">Artem Livshits</assignee>
                                    <reporter username="alivshits">Artem Livshits</reporter>
                        <labels>
                    </labels>
                <created>Thu, 7 Mar 2024 19:04:38 +0000</created>
                <updated>Wed, 20 Mar 2024 18:03:25 +0000</updated>
                            <resolved>Wed, 20 Mar 2024 18:03:25 +0000</resolved>
                                                    <fixVersion>3.8.0</fixVersion>
                                    <component>core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17824512" author="jolshan" created="Thu, 7 Mar 2024 19:13:19 +0000"  >&lt;p&gt;Thanks for filing &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=alivshits&quot; class=&quot;user-hover&quot; rel=&quot;alivshits&quot;&gt;alivshits&lt;/a&gt;. If I understand correctly, the transaction is completed on the data partition side (in terms of writing the marker, lso, etc) but the coordinator is not able to complete the final book-keeping so we are unable to continue using the transactional id.&lt;/p&gt;</comment>
                            <comment id="17825766" author="alivshits" created="Tue, 12 Mar 2024 18:51:29 +0000"  >&lt;p&gt;that&apos;s correct: the transaction is fully completed, but just cannot transition into complete state because internal state is broken by a race condition&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 34 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1nunk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jolshan</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>