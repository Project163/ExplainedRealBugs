<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:38:48 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-16511] Leaking tiered segments</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-16511</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;I have some topics there were not written since a few days (having 12h retention) where some data remains on tiered storage (in our case S3) and they are never deleted.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Looking at the log history, it appears that we never even tried to delete these segments:&lt;/p&gt;

&lt;p&gt;When looking at one of the non-leaking segment, I get the following interesting messages:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-quote&quot;&gt;&quot;2024-04-02T10:30:45.265Z&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;&quot;&quot;kafka&quot;&lt;/span&gt;&lt;span class=&quot;code-quote&quot;&gt;&quot;&quot;,&quot;&lt;/span&gt;&lt;span class=&quot;code-quote&quot;&gt;&quot;&quot;10039&quot;&lt;/span&gt;&lt;span class=&quot;code-quote&quot;&gt;&quot;&quot;,&quot;&lt;/span&gt;[RemoteLogManager=10039 partition=5G8Ai8kBSwmQ3Ln4QRY5rA:topic1_3543-764] Deleted remote log segment RemoteLogSegmentId{topicIdPartition=5G8Ai8kBSwmQ3Ln4QRY5rA:topic1_3543-764, id=fqGng3UURCG3-v4lETeLKQ} due to leader-epoch-cache truncation. Current earliest-epoch-entry: EpochEntry(epoch=8, startOffset=2980106), segment-end-offset: 2976819 and segment-epochs: [5]&quot;
&lt;span class=&quot;code-quote&quot;&gt;&quot;2024-04-02T10:30:45.242Z&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;&quot;&quot;kafka&quot;&lt;/span&gt;&lt;span class=&quot;code-quote&quot;&gt;&quot;&quot;,&quot;&lt;/span&gt;&lt;span class=&quot;code-quote&quot;&gt;&quot;&quot;10039&quot;&lt;/span&gt;&lt;span class=&quot;code-quote&quot;&gt;&quot;&quot;,&quot;&lt;/span&gt;Deleting log segment data &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; completed successfully RemoteLogSegmentMetadata{remoteLogSegmentId=RemoteLogSegmentId
{topicIdPartition=5G8Ai8kBSwmQ3Ln4QRY5rA:topic1_3543-764, id=fqGng3UURCG3-v4lETeLKQ}
, startOffset=2968418, endOffset=2976819, brokerId=10029, maxTimestampMs=1712009754536, eventTimestampMs=1712013411147, segmentLeaderEpochs={5=2968418}, segmentSizeInBytes=536351075, customMetadata=Optional.empty, state=COPY_SEGMENT_FINISHED}&quot;
&lt;span class=&quot;code-quote&quot;&gt;&quot;2024-04-02T10:30:45.144Z&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;&quot;&quot;kafka&quot;&lt;/span&gt;&lt;span class=&quot;code-quote&quot;&gt;&quot;&quot;,&quot;&lt;/span&gt;&lt;span class=&quot;code-quote&quot;&gt;&quot;&quot;10039&quot;&lt;/span&gt;&lt;span class=&quot;code-quote&quot;&gt;&quot;&quot;,&quot;&lt;/span&gt;Deleting log segment data &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; RemoteLogSegmentMetadata{remoteLogSegmentId=RemoteLogSegmentId
{topicIdPartition=5G8Ai8kBSwmQ3Ln4QRY5rA:topic1_3543-764, id=fqGng3UURCG3-v4lETeLKQ}
, startOffset=2968418, endOffset=2976819, brokerId=10029, maxTimestampMs=1712009754536, eventTimestampMs=1712013411147, segmentLeaderEpochs={5=2968418}, segmentSizeInBytes=536351075, customMetadata=Optional.empty, state=COPY_SEGMENT_FINISHED}&quot;
&lt;span class=&quot;code-quote&quot;&gt;&quot;2024-04-01T23:16:51.157Z&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;&quot;&quot;kafka&quot;&lt;/span&gt;&lt;span class=&quot;code-quote&quot;&gt;&quot;&quot;,&quot;&lt;/span&gt;&lt;span class=&quot;code-quote&quot;&gt;&quot;&quot;10029&quot;&lt;/span&gt;&lt;span class=&quot;code-quote&quot;&gt;&quot;&quot;,&quot;&lt;/span&gt;[RemoteLogManager=10029 partition=5G8Ai8kBSwmQ3Ln4QRY5rA:topic1_3543-764] Copied 00000000000002968418.log to remote storage with segment-id: RemoteLogSegmentId{topicIdPartition=5G8Ai8kBSwmQ3Ln4QRY5rA:topic1_3543-764, id=fqGng3UURCG3-v4lETeLKQ}&quot;
&lt;span class=&quot;code-quote&quot;&gt;&quot;2024-04-01T23:16:51.147Z&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;&quot;&quot;kafka&quot;&lt;/span&gt;&lt;span class=&quot;code-quote&quot;&gt;&quot;&quot;,&quot;&lt;/span&gt;&lt;span class=&quot;code-quote&quot;&gt;&quot;&quot;10029&quot;&lt;/span&gt;&lt;span class=&quot;code-quote&quot;&gt;&quot;&quot;,&quot;&lt;/span&gt;Copying log segment data completed successfully, metadata: RemoteLogSegmentMetadata{remoteLogSegmentId=RemoteLogSegmentId
{topicIdPartition=5G8Ai8kBSwmQ3Ln4QRY5rA:topic1_3543-764, id=fqGng3UURCG3-v4lETeLKQ}
, startOffset=2968418, endOffset=2976819, brokerId=10029, maxTimestampMs=1712009754536, eventTimestampMs=1712013397319, segmentLeaderEpochs={5=2968418}, segmentSizeInBytes=536351075, customMetadata=Optional.empty, state=COPY_SEGMENT_STARTED}&quot;
&lt;span class=&quot;code-quote&quot;&gt;&quot;2024-04-01T23:16:37.328Z&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;&quot;&quot;kafka&quot;&lt;/span&gt;&lt;span class=&quot;code-quote&quot;&gt;&quot;&quot;,&quot;&lt;/span&gt;&lt;span class=&quot;code-quote&quot;&gt;&quot;&quot;10029&quot;&lt;/span&gt;&lt;span class=&quot;code-quote&quot;&gt;&quot;&quot;,&quot;&lt;/span&gt;Copying log segment data, metadata: RemoteLogSegmentMetadata{remoteLogSegmentId=RemoteLogSegmentId
{topicIdPartition=5G8Ai8kBSwmQ3Ln4QRY5rA:topic1_3543-764, id=fqGng3UURCG3-v4lETeLKQ}
, startOffset=2968418, endOffset=2976819, brokerId=10029, maxTimestampMs=1712009754536, eventTimestampMs=1712013397319, segmentLeaderEpochs={5=2968418}, segmentSizeInBytes=536351075, customMetadata=Optional.empty, state=COPY_SEGMENT_STARTED}&quot;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Which looks right because we can see logs from both the plugin and remote log manager indicating that the remote log segment was removed.&lt;/p&gt;

&lt;p&gt;Now if I look on one of the leaked segment, here is what I see&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-quote&quot;&gt;&quot;2024-04-02T00:43:33.834Z&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;&quot;&quot;kafka&quot;&lt;/span&gt;&lt;span class=&quot;code-quote&quot;&gt;&quot;&quot;,&quot;&lt;/span&gt;&lt;span class=&quot;code-quote&quot;&gt;&quot;&quot;10001&quot;&lt;/span&gt;&lt;span class=&quot;code-quote&quot;&gt;&quot;&quot;,&quot;&lt;/span&gt;[RemoteLogManager=10001 partition=5G8Ai8kBSwmQ3Ln4QRY5rA:topic1_3543-765] Copied 00000000000002971163.log to remote storage with segment-id: RemoteLogSegmentId{topicIdPartition=5G8Ai8kBSwmQ3Ln4QRY5rA:topic1_3543-765, id=8dP13VDYSaiFlubl9SNBTQ}&quot;
&lt;span class=&quot;code-quote&quot;&gt;&quot;2024-04-02T00:43:33.822Z&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;&quot;&quot;kafka&quot;&lt;/span&gt;&lt;span class=&quot;code-quote&quot;&gt;&quot;&quot;,&quot;&lt;/span&gt;&lt;span class=&quot;code-quote&quot;&gt;&quot;&quot;10001&quot;&lt;/span&gt;&lt;span class=&quot;code-quote&quot;&gt;&quot;&quot;,&quot;&lt;/span&gt;Copying log segment data completed successfully, metadata: RemoteLogSegmentMetadata{remoteLogSegmentId=RemoteLogSegmentId
{topicIdPartition=5G8Ai8kBSwmQ3Ln4QRY5rA:topic1_3543-765, id=8dP13VDYSaiFlubl9SNBTQ}
, startOffset=2971163, endOffset=2978396, brokerId=10001, maxTimestampMs=1712010648756, eventTimestampMs=1712018599981, segmentLeaderEpochs={7=2971163}, segmentSizeInBytes=459778940, customMetadata=Optional.empty, state=COPY_SEGMENT_STARTED}&quot;
&lt;span class=&quot;code-quote&quot;&gt;&quot;2024-04-02T00:43:20.003Z&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;&quot;&quot;kafka&quot;&lt;/span&gt;&lt;span class=&quot;code-quote&quot;&gt;&quot;&quot;,&quot;&lt;/span&gt;&lt;span class=&quot;code-quote&quot;&gt;&quot;&quot;10001&quot;&lt;/span&gt;&lt;span class=&quot;code-quote&quot;&gt;&quot;&quot;,&quot;&lt;/span&gt;Copying log segment data, metadata: RemoteLogSegmentMetadata{remoteLogSegmentId=RemoteLogSegmentId
{topicIdPartition=5G8Ai8kBSwmQ3Ln4QRY5rA:topic1_3543-765, id=8dP13VDYSaiFlubl9SNBTQ}
, startOffset=2971163, endOffset=2978396, brokerId=10001, maxTimestampMs=1712010648756, eventTimestampMs=1712018599981, segmentLeaderEpochs={7=2971163}, segmentSizeInBytes=459778940, customMetadata=Optional.empty, state=COPY_SEGMENT_STARTED}&quot;
 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I have no errors whatsoever indicating that the remote log deletion was actually triggered and failed.&#160;&lt;/p&gt;

&lt;p&gt;I tried rolling restarting my cluster to see if refreshing remote log metadata from fresh state would help but that did not help. Removing segments in tiered storage and restarting brokers after did not help either.&lt;/p&gt;

&lt;p&gt;Now if I use offset shell to get earliest and latest offsets for both partitions&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
$ /opt/kafka-3.7.0/bin/kafka-get-offsets.sh&#160; --bootstrap-server $KAFKA_CONNECT_STR --topic topic1 --partitions 764,765 -
-time -2&#160;
raw_spans_datadog_3543:764:2980106
raw_spans_datadog_3543:765:2976337
$ $ /opt/kafka-3.7.0/bin/kafka-get-offsets.sh&#160; --bootstrap-server $KAFKA_CONNECT_STR --topic topic1 --partitions 764,765 --time -1
raw_spans_datadog_3543:764:2980106
raw_spans_datadog_3543:765:2978397
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;We can see that despite the retention period being largely exceeded, there are 2060 offsets that are never expiring.&lt;/p&gt;

&lt;p&gt;One thing that might have triggered this bug was the fact that some nodes were replaced with fresh disk in between the segment creation and their expiration.&lt;/p&gt;

&lt;p&gt;The issue happened on 418 partitions out of 4513, ~9% of partitions.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13575483">KAFKA-16511</key>
            <summary>Leaking tiered segments</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ckamal">Kamal Chandraprakash</assignee>
                                    <reporter username="fvisconte">Francois Visconte</reporter>
                        <labels>
                            <label>tiered-storage</label>
                    </labels>
                <created>Thu, 11 Apr 2024 12:57:57 +0000</created>
                <updated>Wed, 8 May 2024 07:32:16 +0000</updated>
                            <resolved>Wed, 8 May 2024 07:22:02 +0000</resolved>
                                    <version>3.7.0</version>
                                    <fixVersion>3.7.1</fixVersion>
                    <fixVersion>3.8.0</fixVersion>
                                    <component>Tiered-Storage</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="17836277" author="ckamal" created="Thu, 11 Apr 2024 16:51:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fvisconte&quot; class=&quot;user-hover&quot; rel=&quot;fvisconte&quot;&gt;fvisconte&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&amp;gt; We can see that despite the retention period being largely exceeded, there are 2060 offsets that are never expiring.&lt;/p&gt;

&lt;p&gt;Can you check the local log segments of the current leader for partition 765? &lt;/p&gt;</comment>
                            <comment id="17836286" author="JIRAUSER288982" created="Thu, 11 Apr 2024 17:22:33 +0000"  >&lt;p&gt;here is what I have on the leader of partition 765&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
$ ls -l&#160;
total 12
00000000000002978397.index
00000000000002978397.log
00000000000002978397.snapshot
00000000000002978397.timeindex
leader-epoch-checkpoint
partition.metadata
remote_log_snapshot&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;And remote store still contains&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
00000000000002971163-8dP13VDYSaiFlubl9SNBTQ.indexes
00000000000002971163-8dP13VDYSaiFlubl9SNBTQ.log
00000000000002971163-8dP13VDYSaiFlubl9SNBTQ.rsm-manifest&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ckamal&quot; class=&quot;user-hover&quot; rel=&quot;ckamal&quot;&gt;ckamal&lt;/a&gt; is there a way to unblock the situation while we find the root cause? &lt;/p&gt;</comment>
                            <comment id="17836289" author="ckamal" created="Thu, 11 Apr 2024 17:42:27 +0000"  >&lt;p&gt;Can you also paste the contents of leader-epoch-checkpoint file to see the leader transitions?&lt;/p&gt;</comment>
                            <comment id="17836339" author="JIRAUSER288982" created="Thu, 11 Apr 2024 19:53:13 +0000"  >&lt;p&gt;The content of the leader-epoch-checkpoint&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
$ cat leader-epoch-checkpoint 
0
2
7 2976337
21 2978397
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;



&lt;p&gt;summarising here the investigation we did with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ckamal&quot; class=&quot;user-hover&quot; rel=&quot;ckamal&quot;&gt;ckamal&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;Looking at &lt;tt&gt;__remote_log_metadata&lt;/tt&gt;&#160;(infinite retention) partition that contains metadata for the affected partition 765 the only thing we have is:&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
partition: 27, offset: 396276, value: RemoteLogSegmentMetadata{remoteLogSegmentId=RemoteLogSegmentId{topicIdPartition=5G8Ai8kBSwmQ3Ln4QRY5rA:topic1-765, id=8dP13VDYSaiFlubl9SNBTQ}, startOffset=2971163, endOffset=2978396, brokerId=10001, maxTimestampMs=1712010648756, eventTimestampMs=1712018599981, segmentLeaderEpochs={7=2971163}, segmentSizeInBytes=459778940, customMetadata=Optional.empty, state=COPY_SEGMENT_STARTED} partition: 27, offset: 396279, value: RemoteLogSegmentMetadataUpdate{remoteLogSegmentId=RemoteLogSegmentId{topicIdPartition=5G8Ai8kBSwmQ3Ln4QRY5rA:topic1-765, id=8dP13VDYSaiFlubl9SNBTQ}, customMetadata=Optional.empty, state=COPY_SEGMENT_FINISHED, eventTimestampMs=1712018613822, brokerId=10001}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So it seems we never pushed any &lt;tt&gt;DELETE_SEGMENT_STARTED.&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;(Note we already have this &lt;a href=&quot;https://github.com/apache/kafka/pull/14766&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/14766&lt;/a&gt; on our branch)&lt;/p&gt;</comment>
                            <comment id="17836444" author="ckamal" created="Fri, 12 Apr 2024 07:35:08 +0000"  >&lt;p&gt;The segment deletion might be stuck due to &lt;a href=&quot;https://sourcegraph.com/github.com/apache/kafka@trunk/-/blob/core/src/main/java/kafka/log/remote/RemoteLogManager.java?L1241&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;RemoteLogManager#isRemoteSegmentWithinLeaderEpochs&lt;/a&gt; check. The &lt;tt&gt;log-start-offset&lt;/tt&gt; for this partition 765 might be moved using the &lt;tt&gt;kafka-delete-records.sh&lt;/tt&gt; script so the check fails to mark it as valid segment.&lt;/p&gt;</comment>
                            <comment id="17836472" author="JIRAUSER288982" created="Fri, 12 Apr 2024 08:24:02 +0000"  >&lt;p&gt;I ran kafka-delete-records.sh and it did the trick&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[RemoteLogManager=10015 partition=5G8Ai8kBSwmQ3Ln4QRY5rA:raw_spans_datadog_3543-765] Deleted remote log segment RemoteLogSegmentId{topicIdPartition=5G8Ai8kBSwmQ3Ln4QRY5rA:topic1-765, id=8dP13VDYSaiFlubl9SNBTQ} due to leader-epoch-cache truncation. Current earliest-epoch-entry: EpochEntry(epoch=21, startOffset=2978397), segment-end-offset: 2978396 and segment-epochs: [7]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Do you happen to know what triggers the issue?&lt;/p&gt;</comment>
                            <comment id="17836762" author="ckamal" created="Sat, 13 Apr 2024 03:24:52 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fvisconte&quot; class=&quot;user-hover&quot; rel=&quot;fvisconte&quot;&gt;fvisconte&lt;/a&gt;&#160;&lt;br/&gt;
The issue might be due to the overlapping remote log segments after a new leader gets elected during rolling restart. Would you please upload the past 10 segments remote-log-segment metadata events for 5G8Ai8kBSwmQ3Ln4QRY5rA:topic1_3543-765 partition? Thanks!&lt;/p&gt;</comment>
                            <comment id="17837892" author="JIRAUSER288982" created="Tue, 16 Apr 2024 21:27:54 +0000"  >&lt;p&gt;Here is for example one of the segments and partitions where I had the issue. &lt;/p&gt;

&lt;p&gt;Remaining segment leaked on tiered storage that was never deleted&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
partition: 12, offset: 429045, value: RemoteLogSegmentMetadata{remoteLogSegmentId=RemoteLogSegmentId{topicIdPartition=5G8Ai8kBSwmQ3Ln4QRY5rA:topic2-774, id=9481FsNMTqiXLLzIBY03lA}, startOffset=2965469, endOffset=2968297, brokerId=10045, maxTimestampMs=1712010650848, eventTimestampMs=1712018260978, segmentLeaderEpochs={7=2965469}, segmentSizeInBytes=179013013, customMetadata=Optional.empty, state=COPY_SEGMENT_STARTED}
partition: 12, offset: 429049, value: RemoteLogSegmentMetadataUpdate{remoteLogSegmentId=RemoteLogSegmentId{topicIdPartition=5G8Ai8kBSwmQ3Ln4QRY5rA:topic2-774, id=9481FsNMTqiXLLzIBY03lA}, customMetadata=Optional.empty, state=COPY_SEGMENT_FINISHED, eventTimestampMs=1712018266033, brokerId=10045}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Last events in the remote log metadata for this partition:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
partition: 12, offset: 427434, value: RemoteLogSegmentMetadataUpdate{remoteLogSegmentId=RemoteLogSegmentId{topicIdPartition=5G8Ai8kBSwmQ3Ln4QRY5rA:topic2-774, id=5_3z-dusQEeSDqNC_E5ifQ}, customMetadata=Optional.empty, state=COPY_SEGMENT_FINISHED, eventTimestampMs=1712010391903, brokerId=10041}
partition: 12, offset: 427680, value: RemoteLogSegmentMetadataUpdate{remoteLogSegmentId=RemoteLogSegmentId{topicIdPartition=5G8Ai8kBSwmQ3Ln4QRY5rA:topic2-774, id=58Ht5YJ8SaW3JaI_lDEpsA}, customMetadata=Optional.empty, state=DELETE_SEGMENT_STARTED, eventTimestampMs=1712012524972, brokerId=10041}
partition: 12, offset: 427681, value: RemoteLogSegmentMetadataUpdate{remoteLogSegmentId=RemoteLogSegmentId{topicIdPartition=5G8Ai8kBSwmQ3Ln4QRY5rA:topic2-774, id=58Ht5YJ8SaW3JaI_lDEpsA}, customMetadata=Optional.empty, state=DELETE_SEGMENT_FINISHED, eventTimestampMs=1712012525109, brokerId=10041}
partition: 12, offset: 428017, value: RemoteLogSegmentMetadataUpdate{remoteLogSegmentId=RemoteLogSegmentId{topicIdPartition=5G8Ai8kBSwmQ3Ln4QRY5rA:topic2-774, id=s4RCtworR-2Na8PGY6h2nQ}, customMetadata=Optional.empty, state=DELETE_SEGMENT_STARTED, eventTimestampMs=1712014486037, brokerId=10045}
partition: 12, offset: 428018, value: RemoteLogSegmentMetadataUpdate{remoteLogSegmentId=RemoteLogSegmentId{topicIdPartition=5G8Ai8kBSwmQ3Ln4QRY5rA:topic2-774, id=s4RCtworR-2Na8PGY6h2nQ}, customMetadata=Optional.empty, state=DELETE_SEGMENT_FINISHED, eventTimestampMs=1712014486168, brokerId=10045}
partition: 12, offset: 428399, value: RemoteLogSegmentMetadataUpdate{remoteLogSegmentId=RemoteLogSegmentId{topicIdPartition=5G8Ai8kBSwmQ3Ln4QRY5rA:topic2-774, id=UWhaLz-GTjqPcVKL8uZOQQ}, customMetadata=Optional.empty, state=DELETE_SEGMENT_STARTED, eventTimestampMs=1712016766308, brokerId=10045}
partition: 12, offset: 428400, value: RemoteLogSegmentMetadataUpdate{remoteLogSegmentId=RemoteLogSegmentId{topicIdPartition=5G8Ai8kBSwmQ3Ln4QRY5rA:topic2-774, id=UWhaLz-GTjqPcVKL8uZOQQ}, customMetadata=Optional.empty, state=DELETE_SEGMENT_FINISHED, eventTimestampMs=1712016766397, brokerId=10045}
partition: 12, offset: 429045, value: RemoteLogSegmentMetadata{remoteLogSegmentId=RemoteLogSegmentId{topicIdPartition=5G8Ai8kBSwmQ3Ln4QRY5rA:topic2-774, id=9481FsNMTqiXLLzIBY03lA}, startOffset=2965469, endOffset=2968297, brokerId=10045, maxTimestampMs=1712010650848, eventTimestampMs=1712018260978, segmentLeaderEpochs={7=2965469}, segmentSizeInBytes=179013013, customMetadata=Optional.empty, state=COPY_SEGMENT_STARTED}
partition: 12, offset: 429049, value: RemoteLogSegmentMetadataUpdate{remoteLogSegmentId=RemoteLogSegmentId{topicIdPartition=5G8Ai8kBSwmQ3Ln4QRY5rA:topic2-774, id=9481FsNMTqiXLLzIBY03lA}, customMetadata=Optional.empty, state=COPY_SEGMENT_FINISHED, eventTimestampMs=1712018266033, brokerId=10045}
partition: 12, offset: 429265, value: RemoteLogSegmentMetadataUpdate{remoteLogSegmentId=RemoteLogSegmentId{topicIdPartition=5G8Ai8kBSwmQ3Ln4QRY5rA:topic2-774, id=TM44MmIqSKSBPmXMzjAvxA}, customMetadata=Optional.empty, state=DELETE_SEGMENT_STARTED, eventTimestampMs=1712018873277, brokerId=10045}
partition: 12, offset: 429266, value: RemoteLogSegmentMetadataUpdate{remoteLogSegmentId=RemoteLogSegmentId{topicIdPartition=5G8Ai8kBSwmQ3Ln4QRY5rA:topic2-774, id=TM44MmIqSKSBPmXMzjAvxA}, customMetadata=Optional.empty, state=DELETE_SEGMENT_FINISHED, eventTimestampMs=1712018873411, brokerId=10045}
partition: 12, offset: 429602, value: RemoteLogSegmentMetadataUpdate{remoteLogSegmentId=RemoteLogSegmentId{topicIdPartition=5G8Ai8kBSwmQ3Ln4QRY5rA:topic2-774, id=djqwO5JeS9y2vRua-FBO3A}, customMetadata=Optional.empty, state=DELETE_SEGMENT_STARTED, eventTimestampMs=1712020973535, brokerId=10045}
partition: 12, offset: 429603, value: RemoteLogSegmentMetadataUpdate{remoteLogSegmentId=RemoteLogSegmentId{topicIdPartition=5G8Ai8kBSwmQ3Ln4QRY5rA:topic2-774, id=djqwO5JeS9y2vRua-FBO3A}, customMetadata=Optional.empty, state=DELETE_SEGMENT_FINISHED, eventTimestampMs=1712020973696, brokerId=10045}
partition: 12, offset: 429939, value: RemoteLogSegmentMetadataUpdate{remoteLogSegmentId=RemoteLogSegmentId{topicIdPartition=5G8Ai8kBSwmQ3Ln4QRY5rA:topic2-774, id=BHdClvdKQxOKjmQFyrCX7w}, customMetadata=Optional.empty, state=DELETE_SEGMENT_STARTED, eventTimestampMs=1712023133754, brokerId=10045}
partition: 12, offset: 429940, value: RemoteLogSegmentMetadataUpdate{remoteLogSegmentId=RemoteLogSegmentId{topicIdPartition=5G8Ai8kBSwmQ3Ln4QRY5rA:topic2-774, id=BHdClvdKQxOKjmQFyrCX7w}, customMetadata=Optional.empty, state=DELETE_SEGMENT_FINISHED, eventTimestampMs=1712023133883, brokerId=10045}
partition: 12, offset: 430274, value: RemoteLogSegmentMetadataUpdate{remoteLogSegmentId=RemoteLogSegmentId{topicIdPartition=5G8Ai8kBSwmQ3Ln4QRY5rA:topic2-774, id=rxwXB2sKS3qjhrSvEeOZeg}, customMetadata=Optional.empty, state=DELETE_SEGMENT_STARTED, eventTimestampMs=1712025261310, brokerId=10041}
partition: 12, offset: 430275, value: RemoteLogSegmentMetadataUpdate{remoteLogSegmentId=RemoteLogSegmentId{topicIdPartition=5G8Ai8kBSwmQ3Ln4QRY5rA:topic2-774, id=rxwXB2sKS3qjhrSvEeOZeg}, customMetadata=Optional.empty, state=DELETE_SEGMENT_FINISHED, eventTimestampMs=1712025261419, brokerId=10041}
partition: 12, offset: 430541, value: RemoteLogSegmentMetadataUpdate{remoteLogSegmentId=RemoteLogSegmentId{topicIdPartition=5G8Ai8kBSwmQ3Ln4QRY5rA:topic2-774, id=KSUfXF8cS8OprECoyFUAFA}, customMetadata=Optional.empty, state=DELETE_SEGMENT_STARTED, eventTimestampMs=1712027044323, brokerId=10041}
partition: 12, offset: 430542, value: RemoteLogSegmentMetadataUpdate{remoteLogSegmentId=RemoteLogSegmentId{topicIdPartition=5G8Ai8kBSwmQ3Ln4QRY5rA:topic2-774, id=KSUfXF8cS8OprECoyFUAFA}, customMetadata=Optional.empty, state=DELETE_SEGMENT_FINISHED, eventTimestampMs=1712027044428, brokerId=10041}
partition: 12, offset: 430894, value: RemoteLogSegmentMetadataUpdate{remoteLogSegmentId=RemoteLogSegmentId{topicIdPartition=5G8Ai8kBSwmQ3Ln4QRY5rA:topic2-774, id=pgWWukrLRfee0F7U_1YIlA}, customMetadata=Optional.empty, state=DELETE_SEGMENT_STARTED, eventTimestampMs=1712029090400, brokerId=10041}
partition: 12, offset: 430895, value: RemoteLogSegmentMetadataUpdate{remoteLogSegmentId=RemoteLogSegmentId{topicIdPartition=5G8Ai8kBSwmQ3Ln4QRY5rA:topic2-774, id=pgWWukrLRfee0F7U_1YIlA}, customMetadata=Optional.empty, state=DELETE_SEGMENT_FINISHED, eventTimestampMs=1712029090512, brokerId=10041}
partition: 12, offset: 431200, value: RemoteLogSegmentMetadataUpdate{remoteLogSegmentId=RemoteLogSegmentId{topicIdPartition=5G8Ai8kBSwmQ3Ln4QRY5rA:topic2-774, id=R13VBA-gTBaUmi4vrymA0Q}, customMetadata=Optional.empty, state=DELETE_SEGMENT_STARTED, eventTimestampMs=1712031070668, brokerId=10041}
partition: 12, offset: 431201, value: RemoteLogSegmentMetadataUpdate{remoteLogSegmentId=RemoteLogSegmentId{topicIdPartition=5G8Ai8kBSwmQ3Ln4QRY5rA:topic2-774, id=R13VBA-gTBaUmi4vrymA0Q}, customMetadata=Optional.empty, state=DELETE_SEGMENT_FINISHED, eventTimestampMs=1712031070803, brokerId=10041}
partition: 12, offset: 431463, value: RemoteLogSegmentMetadataUpdate{remoteLogSegmentId=RemoteLogSegmentId{topicIdPartition=5G8Ai8kBSwmQ3Ln4QRY5rA:topic2-774, id=aJz2hkGMT9aZ1U_nzRc2AA}, customMetadata=Optional.empty, state=DELETE_SEGMENT_STARTED, eventTimestampMs=1712032789122, brokerId=10041}
partition: 12, offset: 431464, value: RemoteLogSegmentMetadataUpdate{remoteLogSegmentId=RemoteLogSegmentId{topicIdPartition=5G8Ai8kBSwmQ3Ln4QRY5rA:topic2-774, id=aJz2hkGMT9aZ1U_nzRc2AA}, customMetadata=Optional.empty, state=DELETE_SEGMENT_FINISHED, eventTimestampMs=1712032789247, brokerId=10041}
partition: 12, offset: 431754, value: RemoteLogSegmentMetadataUpdate{remoteLogSegmentId=RemoteLogSegmentId{topicIdPartition=5G8Ai8kBSwmQ3Ln4QRY5rA:topic2-774, id=n3O9sE15T0-uspS-EfZn7Q}, customMetadata=Optional.empty, state=DELETE_SEGMENT_STARTED, eventTimestampMs=1712034665089, brokerId=10041}
partition: 12, offset: 431755, value: RemoteLogSegmentMetadataUpdate{remoteLogSegmentId=RemoteLogSegmentId{topicIdPartition=5G8Ai8kBSwmQ3Ln4QRY5rA:topic2-774, id=n3O9sE15T0-uspS-EfZn7Q}, customMetadata=Optional.empty, state=DELETE_SEGMENT_FINISHED, eventTimestampMs=1712034665262, brokerId=10041}
partition: 12, offset: 432065, value: RemoteLogSegmentMetadataUpdate{remoteLogSegmentId=RemoteLogSegmentId{topicIdPartition=5G8Ai8kBSwmQ3Ln4QRY5rA:topic2-774, id=YTIk_zIcSPWGzlqLjUTFfw}, customMetadata=Optional.empty, state=DELETE_SEGMENT_STARTED, eventTimestampMs=1712036488994, brokerId=10041}
partition: 12, offset: 432066, value: RemoteLogSegmentMetadataUpdate{remoteLogSegmentId=RemoteLogSegmentId{topicIdPartition=5G8Ai8kBSwmQ3Ln4QRY5rA:topic2-774, id=YTIk_zIcSPWGzlqLjUTFfw}, customMetadata=Optional.empty, state=DELETE_SEGMENT_FINISHED, eventTimestampMs=1712036489094, brokerId=10041}
partition: 12, offset: 432319, value: RemoteLogSegmentMetadataUpdate{remoteLogSegmentId=RemoteLogSegmentId{topicIdPartition=5G8Ai8kBSwmQ3Ln4QRY5rA:topic2-774, id=8mQ_JJLfTQmkP80MYcN6Ig}, customMetadata=Optional.empty, state=DELETE_SEGMENT_STARTED, eventTimestampMs=1712038114012, brokerId=10041}
partition: 12, offset: 432320, value: RemoteLogSegmentMetadataUpdate{remoteLogSegmentId=RemoteLogSegmentId{topicIdPartition=5G8Ai8kBSwmQ3Ln4QRY5rA:topic2-774, id=8mQ_JJLfTQmkP80MYcN6Ig}, customMetadata=Optional.empty, state=DELETE_SEGMENT_FINISHED, eventTimestampMs=1712038114110, brokerId=10041}
partition: 12, offset: 432593, value: RemoteLogSegmentMetadataUpdate{remoteLogSegmentId=RemoteLogSegmentId{topicIdPartition=5G8Ai8kBSwmQ3Ln4QRY5rA:topic2-774, id=oqr_-KDrSIGiGrcLQZhzvA}, customMetadata=Optional.empty, state=DELETE_SEGMENT_STARTED, eventTimestampMs=1712039805803, brokerId=10041}
partition: 12, offset: 432594, value: RemoteLogSegmentMetadataUpdate{remoteLogSegmentId=RemoteLogSegmentId{topicIdPartition=5G8Ai8kBSwmQ3Ln4QRY5rA:topic2-774, id=oqr_-KDrSIGiGrcLQZhzvA}, customMetadata=Optional.empty, state=DELETE_SEGMENT_FINISHED, eventTimestampMs=1712039805901, brokerId=10041}
partition: 12, offset: 432914, value: RemoteLogSegmentMetadataUpdate{remoteLogSegmentId=RemoteLogSegmentId{topicIdPartition=5G8Ai8kBSwmQ3Ln4QRY5rA:topic2-774, id=OSou-FH9S4ioH5LHYUxPMg}, customMetadata=Optional.empty, state=DELETE_SEGMENT_STARTED, eventTimestampMs=1712041682856, brokerId=10041}
partition: 12, offset: 432915, value: RemoteLogSegmentMetadataUpdate{remoteLogSegmentId=RemoteLogSegmentId{topicIdPartition=5G8Ai8kBSwmQ3Ln4QRY5rA:topic2-774, id=OSou-FH9S4ioH5LHYUxPMg}, customMetadata=Optional.empty, state=DELETE_SEGMENT_FINISHED, eventTimestampMs=1712041683023, brokerId=10041}
partition: 12, offset: 433251, value: RemoteLogSegmentMetadataUpdate{remoteLogSegmentId=RemoteLogSegmentId{topicIdPartition=5G8Ai8kBSwmQ3Ln4QRY5rA:topic2-774, id=uSPj4yS5RIO1LuBHecl7iQ}, customMetadata=Optional.empty, state=DELETE_SEGMENT_STARTED, eventTimestampMs=1712043678337, brokerId=10041}
partition: 12, offset: 433252, value: RemoteLogSegmentMetadataUpdate{remoteLogSegmentId=RemoteLogSegmentId{topicIdPartition=5G8Ai8kBSwmQ3Ln4QRY5rA:topic2-774, id=uSPj4yS5RIO1LuBHecl7iQ}, customMetadata=Optional.empty, state=DELETE_SEGMENT_FINISHED, eventTimestampMs=1712043678474, brokerId=10041}
partition: 12, offset: 433577, value: RemoteLogSegmentMetadataUpdate{remoteLogSegmentId=RemoteLogSegmentId{topicIdPartition=5G8Ai8kBSwmQ3Ln4QRY5rA:topic2-774, id=pcCt8vc-TUyRhHOGUJBHXg}, customMetadata=Optional.empty, state=DELETE_SEGMENT_STARTED, eventTimestampMs=1712045569214, brokerId=10041}
partition: 12, offset: 433578, value: RemoteLogSegmentMetadataUpdate{remoteLogSegmentId=RemoteLogSegmentId{topicIdPartition=5G8Ai8kBSwmQ3Ln4QRY5rA:topic2-774, id=pcCt8vc-TUyRhHOGUJBHXg}, customMetadata=Optional.empty, state=DELETE_SEGMENT_FINISHED, eventTimestampMs=1712045569333, brokerId=10041}
partition: 12, offset: 433904, value: RemoteLogSegmentMetadataUpdate{remoteLogSegmentId=RemoteLogSegmentId{topicIdPartition=5G8Ai8kBSwmQ3Ln4QRY5rA:topic2-774, id=LFqoPyg0SOiHbscnV3Ahtw}, customMetadata=Optional.empty, state=DELETE_SEGMENT_STARTED, eventTimestampMs=1712047491475, brokerId=10041}
partition: 12, offset: 433905, value: RemoteLogSegmentMetadataUpdate{remoteLogSegmentId=RemoteLogSegmentId{topicIdPartition=5G8Ai8kBSwmQ3Ln4QRY5rA:topic2-774, id=LFqoPyg0SOiHbscnV3Ahtw}, customMetadata=Optional.empty, state=DELETE_SEGMENT_FINISHED, eventTimestampMs=1712047491576, brokerId=10041}
partition: 12, offset: 434229, value: RemoteLogSegmentMetadataUpdate{remoteLogSegmentId=RemoteLogSegmentId{topicIdPartition=5G8Ai8kBSwmQ3Ln4QRY5rA:topic2-774, id=SSyS_hbXSEKD5rgbu1S8ug}, customMetadata=Optional.empty, state=DELETE_SEGMENT_STARTED, eventTimestampMs=1712049443915, brokerId=10041}
partition: 12, offset: 434230, value: RemoteLogSegmentMetadataUpdate{remoteLogSegmentId=RemoteLogSegmentId{topicIdPartition=5G8Ai8kBSwmQ3Ln4QRY5rA:topic2-774, id=SSyS_hbXSEKD5rgbu1S8ug}, customMetadata=Optional.empty, state=DELETE_SEGMENT_FINISHED, eventTimestampMs=1712049444048, brokerId=10041}
partition: 12, offset: 434584, value: RemoteLogSegmentMetadataUpdate{remoteLogSegmentId=RemoteLogSegmentId{topicIdPartition=5G8Ai8kBSwmQ3Ln4QRY5rA:topic2-774, id=ywQr_XFJSMiUnC4jZcQcxw}, customMetadata=Optional.empty, state=DELETE_SEGMENT_STARTED, eventTimestampMs=1712051556351, brokerId=10041}
partition: 12, offset: 434585, value: RemoteLogSegmentMetadataUpdate{remoteLogSegmentId=RemoteLogSegmentId{topicIdPartition=5G8Ai8kBSwmQ3Ln4QRY5rA:topic2-774, id=ywQr_XFJSMiUnC4jZcQcxw}, customMetadata=Optional.empty, state=DELETE_SEGMENT_FINISHED, eventTimestampMs=1712051556465, brokerId=10041}
partition: 12, offset: 434901, value: RemoteLogSegmentMetadataUpdate{remoteLogSegmentId=RemoteLogSegmentId{topicIdPartition=5G8Ai8kBSwmQ3Ln4QRY5rA:topic2-774, id=5_3z-dusQEeSDqNC_E5ifQ}, customMetadata=Optional.empty, state=DELETE_SEGMENT_STARTED, eventTimestampMs=1712053602489, brokerId=10041}
partition: 12, offset: 434902, value: RemoteLogSegmentMetadataUpdate{remoteLogSegmentId=RemoteLogSegmentId{topicIdPartition=5G8Ai8kBSwmQ3Ln4QRY5rA:topic2-774, id=5_3z-dusQEeSDqNC_E5ifQ}, customMetadata=Optional.empty, state=DELETE_SEGMENT_FINISHED, eventTimestampMs=1712053602602, brokerId=10041}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17843174" author="showuon" created="Fri, 3 May 2024 10:01:57 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ckamal&quot; class=&quot;user-hover&quot; rel=&quot;ckamal&quot;&gt;ckamal&lt;/a&gt; , I was reading the tickets and your PR, and I still think this issue is because the log start offset has incremented in the local leader-epoch-checkpoint, but the remote storage is stored the old one. What I can see is:&lt;/p&gt;

&lt;p&gt;The log segment in the remote storage:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
startOffset=2971163, endOffset=2978396, segmentLeaderEpochs={7=2971163}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Current local leader-epoch-checkpoint&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
$ cat leader-epoch-checkpoint 
0
2
7 2976337
21 2978397&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So, the start offset for epoch 7 is now 2976337 ( &amp;gt; 2971163 in remote storage).&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;And we expected the segment can be deleted in `isSegmentBreachByLogStartOffset`&#160; &lt;a href=&quot;https://github.com/apache/kafka/blob/240243b91d69c2b65b5e456065fdcce90c121b04/core/src/main/java/kafka/log/remote/RemoteLogManager.java#L903&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here &lt;/a&gt;, but it won&apos;t:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt; firstEpoch = leaderEpochEntries.firstKey();
shouldDeleteSegment = metadata.segmentLeaderEpochs().keySet().stream().allMatch(epoch -&amp;gt; epoch &amp;lt;= firstEpoch) &amp;amp;&amp;amp; metadata.endOffset() &amp;lt; logStartOffset;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The firstEpoch is 7, and the `metadata.segmentLeaderEpochs().keySet().stream().allMatch(epoch -&amp;gt; epoch &amp;lt;= firstEpoch)` will be true, but `metadata.endOffset() &amp;lt; logStartOffset` will be false (metadata.endOffset(): 2978396 , logStartOffset: 2976337 )&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;That is, this segment is not deleted in isSegmentBreachByLogStartOffset, and the latter `isRemoteSegmentWithinLeaderEpochs` will also return false for this segment. So, this segment is kept in the remote storage.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I think this segment should not be deleted by isSegmentBreachByLogStartOffset because the logEndOffset of that segment is still greater than logStartOffset. So, we should be able to let this segment be deleted (or first accepted) in the following `isRemoteSegmentWithinLeaderEpochs`.&lt;/p&gt;

&lt;p&gt;Does that make sense?&lt;/p&gt;</comment>
                            <comment id="17843185" author="ckamal" created="Fri, 3 May 2024 10:43:12 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=showuon&quot; class=&quot;user-hover&quot; rel=&quot;showuon&quot;&gt;showuon&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;Your analysis is correct. I tried handling this case in the PR.&#160;&lt;/p&gt;</comment>
                            <comment id="17843204" author="showuon" created="Fri, 3 May 2024 12:25:05 +0000"  >&lt;p&gt;OK, I&apos;ll review it again. Thanks.&lt;/p&gt;</comment>
                            <comment id="17843253" author="JIRAUSER288982" created="Fri, 3 May 2024 15:39:07 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ckamal&quot; class=&quot;user-hover&quot; rel=&quot;ckamal&quot;&gt;ckamal&lt;/a&gt; / &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=showuon&quot; class=&quot;user-hover&quot; rel=&quot;showuon&quot;&gt;showuon&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I pulled the fix on one of my test cluster and I confirm it fixed the issue I had on some partitions. The old segments were cleaned up from remote storage too.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310460">
                    <name>Child-Issue</name>
                                                                <inwardlinks description="is a child of">
                                        <issuelink>
            <issuekey id="13549279">KAFKA-15420</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 27 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1okps:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>