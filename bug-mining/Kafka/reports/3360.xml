<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:31:37 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-14292] KRaft broker controlled shutdown can be delayed indefinitely</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-14292</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;We noticed when rolling a kraft cluster that it took an unexpectedly long time for one of the brokers to shutdown. In the logs, we saw the following:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Oct 11, 2022 @ 17:53:38.277	[Controller 1] The request from broker 8 to shut down can not yet be granted because the lowest active offset 2283357 is not greater than the broker&apos;s shutdown offset 2283358.	org.apache.kafka.controller.BrokerHeartbeatManager	DEBUG	
2Oct 11, 2022 @ 17:53:38.277	[Controller 1] Updated the controlled shutdown offset &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; broker 8 to 2283362.	org.apache.kafka.controller.BrokerHeartbeatManager	DEBUG	
3Oct 11, 2022 @ 17:53:40.278	[Controller 1] Updated the controlled shutdown offset &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; broker 8 to 2283366.	org.apache.kafka.controller.BrokerHeartbeatManager	DEBUG	
4Oct 11, 2022 @ 17:53:40.278	[Controller 1] The request from broker 8 to shut down can not yet be granted because the lowest active offset 2283361 is not greater than the broker&apos;s shutdown offset 2283362.	org.apache.kafka.controller.BrokerHeartbeatManager	DEBUG	
5Oct 11, 2022 @ 17:53:42.279	[Controller 1] The request from broker 8 to shut down can not yet be granted because the lowest active offset 2283365 is not greater than the broker&apos;s shutdown offset 2283366.	org.apache.kafka.controller.BrokerHeartbeatManager	DEBUG	
6Oct 11, 2022 @ 17:53:42.279	[Controller 1] Updated the controlled shutdown offset &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; broker 8 to 2283370.	org.apache.kafka.controller.BrokerHeartbeatManager	DEBUG	
7Oct 11, 2022 @ 17:53:44.280	[Controller 1] The request from broker 8 to shut down can not yet be granted because the lowest active offset 2283369 is not greater than the broker&apos;s shutdown offset 2283370.	org.apache.kafka.controller.BrokerHeartbeatManager	DEBUG	
8Oct 11, 2022 @ 17:53:44.281	[Controller 1] Updated the controlled shutdown offset &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; broker 8 to 2283374.	org.apache.kafka.controller.BrokerHeartbeatManager	DEBUG	 &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;From what I can tell, it looks like the controller waits until all brokers have caught up to the &lt;tt&gt;controlledShutdownOffset&lt;/tt&gt; of the broker that is shutting down before allowing it to proceed. Probably the intent is to make sure they have all the leader and ISR state.&lt;/p&gt;

&lt;p&gt;The problem is that the &lt;tt&gt;controlledShutdownOffset&lt;/tt&gt; seems to be updated after every heartbeat that the controller receives: &lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/metadata/src/main/java/org/apache/kafka/controller/QuorumController.java#L1996&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/trunk/metadata/src/main/java/org/apache/kafka/controller/QuorumController.java#L1996&lt;/a&gt;. Unless all other brokers can catch up to that offset before the next heartbeat from the shutting down broker is received, then the broker remains in the shutting down state indefinitely.&lt;/p&gt;

&lt;p&gt;In this case, it took more than 40 minutes before the broker completed shutdown:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
1Oct 11, 2022 @ 18:36:36.105	[Controller 1] The request from broker 8 to shut down has been granted since the lowest active offset 2288510 is now greater than the broker&apos;s controlled shutdown offset 2288510.	org.apache.kafka.controller.BrokerHeartbeatManager	INFO	
2Oct 11, 2022 @ 18:40:35.197	[Controller 1] The request from broker 8 to unfence has been granted because it has caught up with the offset of it&apos;s register broker record 2288906.	org.apache.kafka.controller.BrokerHeartbeatManager	INFO&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;It seems like the bug here is that we should not keep updating &lt;tt&gt;controlledShutdownOffset&lt;/tt&gt; if it has already been set.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13485766">KAFKA-14292</key>
            <summary>KRaft broker controlled shutdown can be delayed indefinitely</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="alyssahuang">Alyssa Huang</assignee>
                                    <reporter username="hachikuji">Jason Gustafson</reporter>
                        <labels>
                    </labels>
                <created>Wed, 12 Oct 2022 00:16:04 +0000</created>
                <updated>Thu, 13 Oct 2022 20:33:02 +0000</updated>
                            <resolved>Thu, 13 Oct 2022 20:33:02 +0000</resolved>
                                                    <fixVersion>3.3.2</fixVersion>
                    <fixVersion>3.4.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                        <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 4 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z19a08:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>