<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:12:54 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-7028] super.users doesn&apos;t work with custom principals</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-7028</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;SimpleAclAuthorizer creates a KafkaPrincipal for the users defined in the super.users broker config. However, it should use the configured KafkaPrincipalBuilder so that it works with a custom defined one.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13165070">KAFKA-7028</key>
            <summary>super.users doesn&apos;t work with custom principals</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="enether">Stanislav Kozlovski</assignee>
                                    <reporter username="ijuma">Ismael Juma</reporter>
                        <labels>
                    </labels>
                <created>Sat, 9 Jun 2018 03:54:54 +0000</created>
                <updated>Fri, 29 Jun 2018 13:25:21 +0000</updated>
                            <resolved>Fri, 29 Jun 2018 13:25:21 +0000</resolved>
                                                    <fixVersion>2.0.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="16506984" author="yuzhihong@gmail.com" created="Sat, 9 Jun 2018 13:25:55 +0000"  >&lt;p&gt;This means retrieving principalBuilder thru KafkaConfig#PrincipalBuilderClassProp , right ?&lt;/p&gt;</comment>
                            <comment id="16507179" author="ijuma" created="Sat, 9 Jun 2018 22:44:55 +0000"  >&lt;p&gt;Yes, but on second thought, it&apos;s unclear how to build the principal from a string. Maybe we need to change how we check if the principal is a super user. One option is to compare the string representation in the following code:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (superUsers.contains(principal)) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hachikuji&quot; class=&quot;user-hover&quot; rel=&quot;hachikuji&quot;&gt;hachikuji&lt;/a&gt;, what do you think?&lt;/p&gt;</comment>
                            <comment id="16512131" author="rsivaram" created="Thu, 14 Jun 2018 08:05:46 +0000"  >&lt;p&gt;Moving this out to 2.1.0 since there is no PR yet.&lt;/p&gt;</comment>
                            <comment id="16523839" author="enether" created="Tue, 26 Jun 2018 14:59:37 +0000"  >&lt;p&gt;After investigation, me and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rsivaram&quot; class=&quot;user-hover&quot; rel=&quot;rsivaram&quot;&gt;rsivaram&lt;/a&gt; found out that apart from&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (superUsers.contains(principal)) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;the ACL checking logic&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
(acl.principal == principal || acl.principal == Acl.WildCardPrincipal) &amp;amp;&amp;amp;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;under `SimpleAclAuthorizer#aclMatch` also calls the `equals()` method of the `KafkaPrincipal` class, which always returns `false` when given a subclass of `KafkaPrincipal`, because it checks if the classes are equal.&lt;/p&gt;

&lt;p&gt;This currently means that no custom principals can authorize at all.&lt;/p&gt;

&lt;p&gt;Changing the `equals()` method on the base `KafkaPrincipal` to check for subclasses would not work, as `subClass.equals(baseClass)` would return true but `baseClass.equals(subClass)` would return false.&lt;br/&gt;
An alternative that could work but does not sound good to me is checking strings.&lt;/p&gt;

&lt;p&gt;Either way, I assume a fix would require a breaking change and therefore a KIP.&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ijuma&quot; class=&quot;user-hover&quot; rel=&quot;ijuma&quot;&gt;ijuma&lt;/a&gt;, what do you think?&lt;/p&gt;</comment>
                            <comment id="16526922" author="hachikuji" created="Thu, 28 Jun 2018 23:41:23 +0000"  >&lt;p&gt;From KIP-189, the intention was to always make the principal uniquely identifiable with a type and a name. Specifically what I wrote is this:&lt;/p&gt;

&lt;p&gt;1. A principal is always identifiable by a principal type and a name. Nothing else should ever be required.&lt;br/&gt;
2. Principal enrichment during authentication is merely a way to represent relations between the authenticated principal and other principals (possibly of a different type).&lt;br/&gt;
3. An authorizer may or may not take these relations into account when enforcing ACLs. It is valid to ignore them and treat the principal only as a user. &lt;/p&gt;

&lt;p&gt;From the perspective of the simple authorizer (or any authorizer), it should always be valid to use just the principal type and name to check whether an ACL applies. Looks like we failed to follow through with this when that KIP was implemented, so I guess the question is whether it still makes sense? If it does, then we can just fix these checks to reconstruct a raw &lt;tt&gt;KafkaPrincipal&lt;/tt&gt; objects using only the principal type and name.&lt;/p&gt;</comment>
                            <comment id="16527280" author="enether" created="Fri, 29 Jun 2018 07:14:33 +0000"  >&lt;p&gt;As far as I can tell, checking the type and name would be the easiest and quickest fix to this problem. Since the comparison with the type and a name was made explicit in the KIP and approved, I assume it makes sense.&lt;/p&gt;

&lt;p&gt;Otherwise another option would be to let users override `equals()` on their custom class and use that, but that would require us to instantiate the custom principal on the broker as well. Seeing as this problem hasn&apos;t been reported for almost a year, I assume the demand for that is low&lt;/p&gt;</comment>
                            <comment id="16527322" author="rsivaram" created="Fri, 29 Jun 2018 08:43:18 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=enether&quot; class=&quot;user-hover&quot; rel=&quot;enether&quot;&gt;enether&lt;/a&gt; Let&apos;s not depend on &lt;tt&gt;equals()&lt;/tt&gt; from custom classes since we need to be able to instantiate custom principal objects from Strings to make that work. And that needs a KIP. &lt;/p&gt;

&lt;p&gt;We could either instantiate a &lt;tt&gt;KafkaPrincipal&lt;/tt&gt; from the (type, name) of the custom principal as &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hachikuji&quot; class=&quot;user-hover&quot; rel=&quot;hachikuji&quot;&gt;hachikuji&lt;/a&gt; has suggested or directly check the type and name instead of calling &lt;tt&gt;equals()&lt;/tt&gt;. It is probably easiest to instantiate a &lt;tt&gt;KafkaPrincipal&lt;/tt&gt; at the start of &lt;tt&gt;authorize()&lt;/tt&gt; and use that everywhere so that &lt;tt&gt;superUsers.contains()&lt;/tt&gt;&#160; as well as the ACL checks work. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=enether&quot; class=&quot;user-hover&quot; rel=&quot;enether&quot;&gt;enether&lt;/a&gt; What do you think?&lt;/p&gt;</comment>
                            <comment id="16527329" author="enether" created="Fri, 29 Jun 2018 08:48:08 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rsivaram&quot; class=&quot;user-hover&quot; rel=&quot;rsivaram&quot;&gt;rsivaram&lt;/a&gt;&lt;br/&gt;
Agreed, instantiating might be a tad bit slower but makes code more maintainable&lt;/p&gt;</comment>
                            <comment id="16527365" author="githubbot" created="Fri, 29 Jun 2018 09:48:14 +0000"  >&lt;p&gt;stanislavkozlovski opened a new pull request #5311: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7028&quot; title=&quot;super.users doesn&amp;#39;t work with custom principals&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7028&quot;&gt;&lt;del&gt;KAFKA-7028&lt;/del&gt;&lt;/a&gt;: Properly authorize custom principal objects&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5311&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5311&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Previously, it would compare two different classes `KafkaPrincipal` and the custom class, which would always return false because of the implementation of `KafkaPrincipal#equals`&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16527612" author="githubbot" created="Fri, 29 Jun 2018 13:13:48 +0000"  >&lt;p&gt;rajinisivaram closed pull request #5311: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7028&quot; title=&quot;super.users doesn&amp;#39;t work with custom principals&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7028&quot;&gt;&lt;del&gt;KAFKA-7028&lt;/del&gt;&lt;/a&gt;: Properly authorize custom principal objects&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5311&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5311&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/core/src/main/scala/kafka/security/auth/SimpleAclAuthorizer.scala b/core/src/main/scala/kafka/security/auth/SimpleAclAuthorizer.scala&lt;br/&gt;
index 1dc3a1fb412..c5bbfdf41a9 100644&lt;br/&gt;
&amp;#8212; a/core/src/main/scala/kafka/security/auth/SimpleAclAuthorizer.scala&lt;br/&gt;
+++ b/core/src/main/scala/kafka/security/auth/SimpleAclAuthorizer.scala&lt;br/&gt;
@@ -110,7 +110,13 @@ class SimpleAclAuthorizer extends Authorizer with Logging &lt;/p&gt;
{
       throw new IllegalArgumentException(&quot;Only literal resources are supported. Got: &quot; + resource.patternType)
     }

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;val principal = session.principal&lt;br/&gt;
+    // ensure we compare identical classes&lt;br/&gt;
+    val sessionPrincipal = session.principal&lt;br/&gt;
+    val principal = if (classOf&lt;span class=&quot;error&quot;&gt;&amp;#91;KafkaPrincipal&amp;#93;&lt;/span&gt; != sessionPrincipal.getClass)&lt;br/&gt;
+      new KafkaPrincipal(sessionPrincipal.getPrincipalType, sessionPrincipal.getName)&lt;br/&gt;
+    else&lt;br/&gt;
+      sessionPrincipal&lt;br/&gt;
+&lt;br/&gt;
     val host = session.clientAddress.getHostAddress&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     def isEmptyAclAndAuthorized(acls: Set&lt;span class=&quot;error&quot;&gt;&amp;#91;Acl&amp;#93;&lt;/span&gt;): Boolean = {&lt;br/&gt;
diff --git a/core/src/test/scala/unit/kafka/security/auth/SimpleAclAuthorizerTest.scala b/core/src/test/scala/unit/kafka/security/auth/SimpleAclAuthorizerTest.scala&lt;br/&gt;
index 7ab3c0ad71a..3d1ceb6ddd3 100644&lt;br/&gt;
&amp;#8212; a/core/src/test/scala/unit/kafka/security/auth/SimpleAclAuthorizerTest.scala&lt;br/&gt;
+++ b/core/src/test/scala/unit/kafka/security/auth/SimpleAclAuthorizerTest.scala&lt;br/&gt;
@@ -54,6 +54,10 @@ class SimpleAclAuthorizerTest extends ZooKeeperTestHarness {&lt;br/&gt;
   private var config: KafkaConfig = _&lt;br/&gt;
   private var zooKeeperClient: ZooKeeperClient = _&lt;/p&gt;

&lt;p&gt;+  class CustomPrincipal(principalType: String, name: String) extends KafkaPrincipal(principalType, name) &lt;/p&gt;
{
+    override def equals(o: scala.Any): Boolean = false
+  }
&lt;p&gt;+&lt;br/&gt;
   @Before&lt;br/&gt;
   override def setUp() {&lt;br/&gt;
     super.setUp()&lt;br/&gt;
@@ -139,6 +143,29 @@ class SimpleAclAuthorizerTest extends ZooKeeperTestHarness &lt;/p&gt;
{
     assertTrue(&quot;User3 should have WRITE access from host2&quot;, simpleAclAuthorizer.authorize(user3Session, Write, resource))
   }

&lt;p&gt;+  /**&lt;br/&gt;
+    CustomPrincipals should be compared with their principal type and name&lt;br/&gt;
+   */&lt;br/&gt;
+  @Test&lt;br/&gt;
+  def testAllowAccessWithCustomPrincipal() &lt;/p&gt;
{
+    val user = new KafkaPrincipal(KafkaPrincipal.USER_TYPE, username)
+    val customUserPrincipal = new CustomPrincipal(KafkaPrincipal.USER_TYPE, username)
+    val host1 = InetAddress.getByName(&quot;192.168.1.1&quot;)
+    val host2 = InetAddress.getByName(&quot;192.168.1.2&quot;)
+
+    // user has READ access from host2 but not from host1
+    val acl1 = new Acl(user, Deny, host1.getHostAddress, Read)
+    val acl2 = new Acl(user, Allow, host2.getHostAddress, Read)
+    val acls = Set[Acl](acl1, acl2)
+    changeAclAndVerify(Set.empty[Acl], acls, Set.empty[Acl])
+
+    val host1Session = Session(customUserPrincipal, host1)
+    val host2Session = Session(customUserPrincipal, host2)
+
+    assertTrue(&quot;User1 should have READ access from host2&quot;, simpleAclAuthorizer.authorize(host2Session, Read, resource))
+    assertFalse(&quot;User1 should not have READ access from host1 due to denyAcl&quot;, simpleAclAuthorizer.authorize(host1Session, Read, resource))
+  }
&lt;p&gt;+&lt;br/&gt;
   @Test&lt;br/&gt;
   def testDenyTakesPrecedence() {&lt;br/&gt;
     val user = new KafkaPrincipal(KafkaPrincipal.USER_TYPE, username)&lt;br/&gt;
@@ -177,6 +204,19 @@ class SimpleAclAuthorizerTest extends ZooKeeperTestHarness &lt;/p&gt;
{
     assertTrue(&quot;superuser always has access, no matter what acls.&quot;, simpleAclAuthorizer.authorize(session2, Read, resource))
   }

&lt;p&gt;+  /**&lt;br/&gt;
+    CustomPrincipals should be compared with their principal type and name&lt;br/&gt;
+   */&lt;br/&gt;
+  @Test&lt;br/&gt;
+  def testSuperUserWithCustomPrincipalHasAccess(): Unit = &lt;/p&gt;
{
+    val denyAllAcl = new Acl(Acl.WildCardPrincipal, Deny, WildCardHost, All)
+    changeAclAndVerify(Set.empty[Acl], Set[Acl](denyAllAcl), Set.empty[Acl])
+
+    val session = Session(new CustomPrincipal(KafkaPrincipal.USER_TYPE, &quot;superuser1&quot;), InetAddress.getByName(&quot;192.0.4.4&quot;))
+
+    assertTrue(&quot;superuser with custom principal always has access, no matter what acls.&quot;, simpleAclAuthorizer.authorize(session, Read, resource))
+  }
&lt;p&gt;+&lt;br/&gt;
   @Test&lt;br/&gt;
   def testWildCardAcls(): Unit = {&lt;br/&gt;
     assertFalse(&quot;when acls = [],  authorizer should fail close.&quot;, simpleAclAuthorizer.authorize(session, Read, resource))&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 20 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3uoof:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>rsivaram</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>