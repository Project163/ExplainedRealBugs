<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:36:55 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-15489] Stale KRaft metadata reported during network partition</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-15489</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;I found in the current KRaft implementation, when network partition happened between the current controller leader and the other controller nodes, brokers may see stale metadata and be unable to update the metadata through the controller. It causes 2 leaders will exist in the controller cluster at two different epochs, and 2 stale metadata to be return to the clients.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Root cause&lt;/b&gt;&lt;br/&gt;
In &lt;a href=&quot;https://cwiki.apache.org/confluence/display/KAFKA/KIP-595%3A+A+Raft+Protocol+for+the+Metadata+Quorum#KIP595:ARaftProtocolfortheMetadataQuorum-Vote&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;KIP-595&lt;/a&gt;, we said A voter will begin a new election under three conditions:&lt;/p&gt;

&lt;p&gt;1. If it fails to receive a FetchResponse from the current leader before expiration of quorum.fetch.timeout.ms&lt;br/&gt;
2. If it receives a EndQuorumEpoch request from the current leader&lt;br/&gt;
3. If it fails to receive a majority of votes before expiration of quorum.election.timeout.ms after declaring itself a candidate.&lt;/p&gt;

&lt;p&gt;And that&apos;s exactly what the current KRaft&apos;s implementation.&lt;/p&gt;

&lt;p&gt;However, when the leader is isolated from the network partition, there&apos;s no way for it to resign from the leadership and start a new election. So the leader will always be the leader even though all other nodes are down. And this makes it issue possible for the stale leader to report stale metadata and for the RPC against to timeout.&lt;/p&gt;

&lt;p&gt;When reading further in the KIP-595, I found we indeed considered this situation and have solution for that. in &lt;a href=&quot;https://cwiki.apache.org/confluence/display/KAFKA/KIP-595%3A+A+Raft+Protocol+for+the+Metadata+Quorum#KIP595:ARaftProtocolfortheMetadataQuorum-LeaderProgressTimeout&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this section&lt;/a&gt;, it said:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;In the pull-based model, however, say a new leader has been elected with a new epoch and everyone has learned about it except the old leader (e.g. that leader was not in the voters anymore and hence not receiving the BeginQuorumEpoch as well), then that old leader would not be notified by anyone about the new leader / epoch and become a pure &quot;zombie leader&quot;, as there is no regular heartbeats being pushed from leader to the follower. This could lead to stale information being served to the observers and clients inside the cluster.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;To resolve this issue, we will piggy-back on the &quot;quorum.fetch.timeout.ms&quot; config, such that if the leader did not receive Fetch requests from a majority of the quorum for that amount of time, it would begin a new election and start sending VoteRequest to voter nodes in the cluster to understand the latest quorum. If it couldn&apos;t connect to any known voter, the old leader shall keep starting new elections and bump the epoch.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;But we missed this implementation in current KRaft.&lt;/p&gt;

&lt;p&gt;&#160;&lt;br/&gt;
&lt;b&gt;The flow is like this:&lt;/b&gt;&lt;br/&gt;
1. 3 controller nodes, A(leader), B(follower), C(follower)&lt;br/&gt;
2. network partition happened between &lt;span class=&quot;error&quot;&gt;&amp;#91;A&amp;#93;&lt;/span&gt; and &lt;span class=&quot;error&quot;&gt;&amp;#91;B, C&amp;#93;&lt;/span&gt;.&lt;br/&gt;
3. B and C starts new election since fetch timeout expired before receiving fetch response from leader A.&lt;br/&gt;
4. B (or C) is elected as a leader in new epoch, while A is still the leader in old epoch.&lt;br/&gt;
5. broker D creates a topic &quot;new&quot;, and updates to leader B.&lt;br/&gt;
6. broker E describe topic &quot;new&quot;, but got nothing because it is connecting to the old leader A.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13551728">KAFKA-15489</key>
            <summary>Stale KRaft metadata reported during network partition</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="showuon">Luke Chen</assignee>
                                    <reporter username="showuon">Luke Chen</reporter>
                        <labels>
                    </labels>
                <created>Sat, 23 Sep 2023 07:50:22 +0000</created>
                <updated>Tue, 28 Jan 2025 18:30:13 +0000</updated>
                            <resolved>Thu, 30 Nov 2023 19:37:37 +0000</resolved>
                                    <version>3.5.1</version>
                                    <fixVersion>3.7.0</fixVersion>
                                    <component>kraft</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                    <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13425022">KAFKA-13621</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 7 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1kjf4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>