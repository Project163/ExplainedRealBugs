<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:36:24 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-574] KafkaController unnecessarily reads leaderAndIsr info from ZK</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-574</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;KafkaController calls updateLeaderAndIsrCache() in onBrokerFailure(). This is unnecessary since in onBrokerFailure(), we will make leader and isr change anyway so there is no need to first read that information from ZK. Latency is critical in onBrokerFailure() since it determines how quickly a leader can be made online.&lt;/p&gt;

&lt;p&gt;Similarly, updateLeaderAndIsrCache() is called in onBrokerStartup() unnecessarily. In this case, the controller does not change the leader or the isr. It just needs to send the current leader and the isr info to the newly started broker. We already cache leader in the controller. Isr in theory could change any time by the leader. So, reading from ZK doesn&apos;t guarantee that we can get the latest isr anyway. Instead, we just need to get the isr last selected by the controller (which can be cached together with the leader in the controller). If the leader epoc in a broker is at or larger than the epoc in the leaderAndIsr request, the broker can just ignore it. Otherwise, the leader and the isr selected by the controller should be used. &lt;/p&gt;</description>
                <environment></environment>
        <key id="12612061">KAFKA-574</key>
            <summary>KafkaController unnecessarily reads leaderAndIsr info from ZK</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="prashanth.menon">Prashanth Menon</assignee>
                                    <reporter username="junrao">Jun Rao</reporter>
                        <labels>
                            <label>bugs</label>
                    </labels>
                <created>Tue, 16 Oct 2012 16:09:55 +0000</created>
                <updated>Thu, 15 Nov 2012 00:29:47 +0000</updated>
                            <resolved>Thu, 15 Nov 2012 00:29:33 +0000</resolved>
                                    <version>0.8.0</version>
                                                    <component>core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                    <workratio workratioPercent="0"/>
                                    <progress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                    <timeoriginalestimate seconds="172800">48h</timeoriginalestimate>
                            <timeestimate seconds="172800">48h</timeestimate>
                                        <comments>
                            <comment id="13481048" author="prashanth.menon" created="Sun, 21 Oct 2012 20:06:44 +0000"  >&lt;p&gt;Hey Jun, mind if I take this on?  Some big changes have been made to replication/controller and this seems like a compact enough issue to re-familiarize myself with those areas (in preparation for &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-513&quot; title=&quot;Add state change log to Kafka brokers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-513&quot;&gt;&lt;del&gt;KAFKA-513&lt;/del&gt;&lt;/a&gt;) while getting back into the swing of things.&lt;/p&gt;</comment>
                            <comment id="13481068" author="junrao" created="Sun, 21 Oct 2012 21:02:31 +0000"  >&lt;p&gt;Sure, Prashanth. Do you think that you can provide a patch in the next week or so? We start to looking into performance related issues and this one is on the critical path of leader elections.&lt;/p&gt;</comment>
                            <comment id="13481088" author="prashanth.menon" created="Sun, 21 Oct 2012 22:16:37 +0000"  >&lt;p&gt;I should be able to provide a patch in the next week, more specifically towards the end of next week &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13484653" author="prashanth.menon" created="Fri, 26 Oct 2012 02:24:26 +0000"  >&lt;p&gt;Just an update on this.  I&apos;m effectively dev complete.  I&apos;ll continue testing tomorrow, hoping to get a patch in soon.&lt;/p&gt;</comment>
                            <comment id="13485655" author="prashanth.menon" created="Sun, 28 Oct 2012 15:45:41 +0000"  >&lt;p&gt;I&apos;ve attached a v1 patch for this guy - it&apos;s a relatively small change.&lt;/p&gt;

&lt;p&gt;KafkaController:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Removed updateLeaderAndIsrCache from onBrokerStartup because the partition state machine will read ZK when issuing leader and isr requests.  It&apos;s also unncessary as there&apos;s no guarantee that the leader won&apos;t change between issuing the request and all brokers receiving it.  Since each broker&apos;s local partition checks leaderEpoch when following/leading, reading ZK in onBrokerStartup isn&apos;t necessary.&lt;/li&gt;
	&lt;li&gt;Removed updateLeaderAndIsrCache from onBrokerFailure.  After bringing all partitions with dead leaders offline, triggering online partitions change will read ZK for each partition and therefore isn&apos;t necessary for all partitions here.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;No tests were added as this was effectively removing duplicate code.  Ensuring tests pass should be good enough.  Otherwise, there is some generic cleanup and small optimizations here and there.  Let me know what you think.  &lt;/p&gt;</comment>
                            <comment id="13486091" author="junrao" created="Mon, 29 Oct 2012 15:48:59 +0000"  >&lt;p&gt;Thanks for the patch. Some comments:&lt;/p&gt;

&lt;p&gt;1. ReplicaStateMachine.handleStateChange():  There is one more optimization to consider. When handling the OnlineReplica case, we don&apos;t really need to read Isr from ZK and can read it from in-memory cache. To do that, we can extend ControllerContext.allLeaders to store LeaderAndIsr, instead of just the broker Id of the leader. This leaderAndIsr cache will be updated every time the controller makes a leader change.&lt;/p&gt;

&lt;p&gt;2. 0.8 has moved since you uploaded the patch. Could you rebase?&lt;/p&gt;
</comment>
                            <comment id="13488419" author="prashanth.menon" created="Thu, 1 Nov 2012 02:01:11 +0000"  >&lt;p&gt;I&apos;ve attached a new patched rebased against 0.8 head which addressed Jun&apos;s points.&lt;/p&gt;

&lt;p&gt;KafkaController:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The allLeaders field in the controller context now maps TopicAndPartition to LeaderAndISR objects.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;ReplicaSatemachine:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The OnlineReplica state now reads the leader and ISR from cache.&lt;/li&gt;
	&lt;li&gt;The OfflineReplica state also reads the leader and ISR from the controller cache when determining whether to shrink ISR.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13488810" author="junrao" created="Thu, 1 Nov 2012 16:38:44 +0000"  >&lt;p&gt;Thanks for patch v2. Just one more comment:&lt;/p&gt;

&lt;p&gt;20. ReplicaSatemachine.handleStateChange(): In the OfflineReplica state, after the isr is updated, we need to update the leaderAndIsr cache in controller context. Also, is leaderAndIsrIsEmpty better than leaderAndIsrOpt?&lt;/p&gt;

&lt;p&gt;Could you run the basic system tests and make sure that they pass?&lt;/p&gt;

&lt;p&gt;&amp;lt;kafka_home&amp;gt;/system_test/ $ python &#8211;u &#8211;B system_test_runner.py 2&amp;gt;&amp;amp;1 | tee system_test_output_`date +%s`.log&lt;/p&gt;</comment>
                            <comment id="13489179" author="prashanth.menon" created="Fri, 2 Nov 2012 00:47:43 +0000"  >&lt;p&gt;Thanks for the review, Jun.  I&apos;ve attached a new patch.&lt;/p&gt;

&lt;p&gt;20. Wow, I&apos;m not sure how this slipped by me.  I&apos;ve modified KafkaController.removeReplicaFromIsr to refresh the leader cache if it can successfully write back the leader and isr into zookeeper.  As for the second point, I&apos;m not sure I understand?  Would you like to change the name of the variable?&lt;/p&gt;

&lt;p&gt;Regarding the system tests, I&apos;m unfortunately running a Mac which isn&apos;t supported by the system test suite.  I&apos;ve got a Ubuntu VM sitting somewhere that I can use to run the system tests, but I&apos;ll need a little time to set it up (probably tomorrow).&lt;/p&gt;</comment>
                            <comment id="13490835" author="prashanth.menon" created="Mon, 5 Nov 2012 19:08:26 +0000"  >&lt;p&gt;So I ran the system test an a Ubuntu box and two of the test cases fail consistently for me, both with and without the patch:&lt;/p&gt;

&lt;p&gt;_test_case_name: test_case_0001&lt;br/&gt;
_test_clss_name: ReplicaBasicTest&lt;br/&gt;
arg : bounce_broker : false&lt;br/&gt;
arg : broker_type : leader&lt;br/&gt;
arg : message_producing_free_time_sec : 15&lt;br/&gt;
arg : num_iteration : 1&lt;br/&gt;
arg : num_messages_to_produce_per_product_call : 50&lt;br/&gt;
arg : num_partition : 1&lt;br/&gt;
arg : replica_factor : 3&lt;br/&gt;
arg: sleep_sseconds_between_producer_calls : 1&lt;br/&gt;
validation_status:&lt;br/&gt;
  Leader Election latency MAX : None&lt;br/&gt;
  Leader Election latency MIN : None&lt;br/&gt;
  Validate leader election successful : FAILED&lt;/p&gt;

&lt;p&gt;_test_case_name: test_case_1&lt;br/&gt;
_test_clss_name: ReplicaBasicTest&lt;br/&gt;
arg : bounce_broker : true&lt;br/&gt;
arg : broker_type : leader&lt;br/&gt;
arg : message_producing_free_time_sec : 15&lt;br/&gt;
arg : num_iteration : 2&lt;br/&gt;
arg : num_messages_to_produce_per_product_call : 50&lt;br/&gt;
arg : num_partition : 2&lt;br/&gt;
arg : replica_factor : 3&lt;br/&gt;
arg: sleep_sseconds_between_producer_calls : 1&lt;br/&gt;
validation_status:&lt;br/&gt;
  Validate leader election successful : FAILED&lt;/p&gt;

&lt;p&gt;Any idea if this is happening for everyone else?  I&apos;ll investigate on my end to see what&apos;s causing it.&lt;/p&gt;</comment>
                            <comment id="13491642" author="junrao" created="Tue, 6 Nov 2012 17:39:14 +0000"  >&lt;p&gt;Thanks for patch v3. Just one more comment:&lt;/p&gt;

&lt;p&gt;30. KafkaController.removeReplicaFromIsr(): Shouldn&apos;t we only update newLeaderAndIsr in the cache if updateSucceeded is true?&lt;/p&gt;

&lt;p&gt;20. Ignore my comment on leaderAndIsrIsEmpty. It is fine.&lt;/p&gt;

&lt;p&gt;I ran system tests with your patch and they seem to pass. Did you build the Kafka jar before running the test?&lt;/p&gt;

</comment>
                            <comment id="13491657" author="nehanarkhede" created="Tue, 6 Nov 2012 17:56:30 +0000"  >&lt;p&gt;I ran system tests but they failed and all the kafka server logs were empty. &lt;/p&gt;</comment>
                            <comment id="13492877" author="prashanth.menon" created="Thu, 8 Nov 2012 01:23:54 +0000"  >&lt;p&gt;New patched to address points.&lt;/p&gt;

&lt;p&gt;30. Very correct, fixed in this patch.&lt;/p&gt;

&lt;p&gt;Yes, I&apos;ve been updating/building the package before every run, but I&apos;m still consistently getting two failures.  It&apos;s the same tests every time.  I can try on another machine too.&lt;/p&gt;</comment>
                            <comment id="13492975" author="junrao" created="Thu, 8 Nov 2012 05:56:35 +0000"  >&lt;p&gt;Thanks for patch v4. Patch looks good and system tests pass for me. Can&apos;t see the failures that you and Neha are seeing. So, +1 from me.&lt;/p&gt;</comment>
                            <comment id="13496293" author="jfung" created="Tue, 13 Nov 2012 16:15:35 +0000"  >&lt;p&gt;The following cases (base case from each functional test group) were executed with patch v4 and all passing:&lt;br/&gt;
0001, 0021, 0101, 0111, 0121, 0131, 0151, 0201&lt;/p&gt;

&lt;p&gt;So +1 from me.&lt;/p&gt;</comment>
                            <comment id="13496299" author="prashanth.menon" created="Tue, 13 Nov 2012 16:22:45 +0000"  >&lt;p&gt;Awesome, thanks John.  I can commit this later today.&lt;/p&gt;

&lt;p&gt;Any idea why two of my tests are failling consistently (or why Neha wasn&apos;t able to get any of the tests to pass) ?&lt;/p&gt;</comment>
                            <comment id="13496314" author="jfung" created="Tue, 13 Nov 2012 16:43:10 +0000"  >&lt;p&gt;Hi Prashanth,&lt;/p&gt;

&lt;p&gt;Please kindly check that if there are any previous running instances of brokers / zookeeper in the local host. That may be the reason that the brokers logs are empty.&lt;/p&gt;

&lt;p&gt;Thanks&lt;br/&gt;
John&lt;/p&gt;</comment>
                            <comment id="13497642" author="nehanarkhede" created="Thu, 15 Nov 2012 00:29:10 +0000"  >&lt;p&gt;+1. Looks good and tests pass !&lt;/p&gt;</comment>
                            <comment id="13497643" author="nehanarkhede" created="Thu, 15 Nov 2012 00:29:33 +0000"  >&lt;p&gt;Checked it in since it blocks work on &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-532&quot; title=&quot;Multiple controllers can co-exist during soft failures&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-532&quot;&gt;&lt;del&gt;KAFKA-532&lt;/del&gt;&lt;/a&gt;. &lt;/p&gt;</comment>
                            <comment id="13497644" author="nehanarkhede" created="Thu, 15 Nov 2012 00:29:47 +0000"  >&lt;p&gt;Thanks for the patch, Prashanth!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12551119" name="KAFKA-574-v1.patch" size="12412" author="prashanth.menon" created="Sun, 28 Oct 2012 15:45:41 +0000"/>
                            <attachment id="12551661" name="KAFKA-574-v2.patch" size="31135" author="prashanth.menon" created="Thu, 1 Nov 2012 02:01:11 +0000"/>
                            <attachment id="12551800" name="KAFKA-574-v3.patch" size="32539" author="prashanth.menon" created="Fri, 2 Nov 2012 00:47:43 +0000"/>
                            <attachment id="12552585" name="KAFKA-574-v4.patch" size="32756" author="prashanth.menon" created="Thu, 8 Nov 2012 01:23:54 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>249027</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 1 week, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0a3lr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>56857</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>