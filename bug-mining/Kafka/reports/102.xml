<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:35:47 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-551] Log.truncateTo() may need to trucate immutable log segment</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-551</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;In makeFollower, we need to first truncate the local log to high watermark. It&apos;s possible that we need to truncate into segments before the last one. The problem is that all segments except the last one are immutable. So the truncation will fail which prevents the replica fetcher from being started.&lt;/p&gt;

&lt;p&gt;One solution is to reopen the segment as mutable during truncation, if it&apos;s not mutable already.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12610678">KAFKA-551</key>
            <summary>Log.truncateTo() may need to trucate immutable log segment</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jkreps">Jay Kreps</assignee>
                                    <reporter username="junrao">Jun Rao</reporter>
                        <labels>
                            <label>bugs</label>
                    </labels>
                <created>Sat, 6 Oct 2012 01:53:18 +0000</created>
                <updated>Tue, 9 Oct 2012 16:42:52 +0000</updated>
                            <resolved>Tue, 9 Oct 2012 16:41:45 +0000</resolved>
                                    <version>0.8.0</version>
                                                    <component>core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                    <workratio workratioPercent="0"/>
                                    <progress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                    <timeoriginalestimate seconds="86400">24h</timeoriginalestimate>
                            <timeestimate seconds="86400">24h</timeestimate>
                                        <comments>
                            <comment id="13470879" author="jkreps" created="Sat, 6 Oct 2012 02:37:09 +0000"  >&lt;p&gt;I think the simplest solution would just be to open all segments as r/w since that is effectively what they are now.&lt;/p&gt;

&lt;p&gt;I can take this if you like since I was just mucking around on that stuff and it is possible we have the same bug in the OffsetIndex.&lt;/p&gt;</comment>
                            <comment id="13470900" author="junrao" created="Sat, 6 Oct 2012 04:05:07 +0000"  >&lt;p&gt;Currently, we mark the first n-1 segments as read-only channels on broker startup. It doesn&apos;t seem to hurt to open them as r/w. Yes, it would great if you can fix it in your patch to take care of the index part too.&lt;/p&gt;</comment>
                            <comment id="13471944" author="jkreps" created="Mon, 8 Oct 2012 22:58:48 +0000"  >&lt;p&gt;Attached patch removes mutable flag from offset index and log file. I think this actually turns out to simplify the code a bit since there was lots of casewise logic.&lt;/p&gt;

&lt;p&gt;The downside is that it is now possible to append to the wrong  log segment which would have previously thrown a helpful exception and now would silently succeed.&lt;/p&gt;

&lt;p&gt;It would be possible to improve this situation in the future by (1) completing the refactor of log to only reference index and file message set through the LogSegment class, and (2) adding a mutable flag in the log segment and checking that on all mutations.&lt;/p&gt;</comment>
                            <comment id="13472133" author="junrao" created="Tue, 9 Oct 2012 05:06:03 +0000"  >&lt;p&gt;Thanks for the patch. Looks good. Just one comment.&lt;/p&gt;

&lt;p&gt;1. OffsetIndex.truncateTo(): If there is an index entry that equals to the target offset, shouldn&apos;t we delete that index entry too? TruncateTo will make target offset the offset for the next append and there shouldn&apos;t be an index entry for offset no available yet.&lt;/p&gt;</comment>
                            <comment id="13472460" author="jkreps" created="Tue, 9 Oct 2012 15:24:18 +0000"  >&lt;p&gt;I think (hope) that is what we are doing. Here is the logic in OffsetIndex.truncateTo:&lt;br/&gt;
      /* There are 3 cases for choosing the new size&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;1) if there is no entry in the index &amp;lt;= the offset, delete everything&lt;/li&gt;
	&lt;li&gt;2) if there is an entry for this exact offset, delete it and everything larger than it&lt;/li&gt;
	&lt;li&gt;3) if there is no entry for this offset, delete everything larger than the next smallest&lt;br/&gt;
       */&lt;br/&gt;
      val newEntries = &lt;br/&gt;
        if(slot &amp;lt; 0)&lt;br/&gt;
          0&lt;br/&gt;
        else if(logical(idx, slot) == offset)&lt;br/&gt;
          slot&lt;br/&gt;
        else&lt;br/&gt;
          slot + 1&lt;br/&gt;
The value of newEntries is the number of remaining entries after the truncation. If we truncate to an offset lower than what is contained in the index (say because there is no entry) we truncate to 0 entries. If we are given an offset which is in the index, we delete that entry and all greater entries. Otherwise if we find an entry smaller than the given entry we should not delete that but instead delete all entries larger than it.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;For example in OffsetIndexTest.truncate:&lt;br/&gt;
    idx.truncateTo(9)&lt;br/&gt;
    assertEquals(&quot;Index should truncate off last entry&quot;, OffsetPosition(8, 8), idx.lookup(10))&lt;br/&gt;
This is asserting that in an index with an entry for every offset, if we truncate to 9, then the largest entry that remains will be 8.&lt;/p&gt;

&lt;p&gt;I think this is right, what was the problem you saw?&lt;/p&gt;</comment>
                            <comment id="13472470" author="junrao" created="Tue, 9 Oct 2012 15:38:15 +0000"  >&lt;p&gt;Yes, you are right. The code looks good. The confusion for me was that slot is an index based off 0 and when using it to set entry size, it actually truncates the entry at slot. +1 on the patch.&lt;/p&gt;</comment>
                            <comment id="13472480" author="nehanarkhede" created="Tue, 9 Oct 2012 15:43:53 +0000"  >&lt;p&gt;+1. LGTM&lt;/p&gt;</comment>
                            <comment id="13472528" author="jkreps" created="Tue, 9 Oct 2012 16:41:45 +0000"  >&lt;p&gt;Committed.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12548326" name="KAFKA-551.patch" size="24945" author="jkreps" created="Mon, 8 Oct 2012 22:58:48 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>244154</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 6 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i05irb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>30136</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>