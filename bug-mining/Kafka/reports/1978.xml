<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:12:57 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-7136] PushHttpMetricsReporter may deadlock when processing metrics changes</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-7136</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;We noticed a deadlock in &lt;tt&gt;PushHttpMetricsReporter&lt;/tt&gt;. Locking for metrics was changed under &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6765&quot; title=&quot;Intermittent test failure in CustomQuotaCallbackTest&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-6765&quot;&gt;&lt;del&gt;KAFKA-6765&lt;/del&gt;&lt;/a&gt; to avoid &lt;tt&gt;NullPointerException&lt;/tt&gt; in metrics reporters due to concurrent read and updates. &lt;tt&gt;PushHttpMetricsReporter&lt;/tt&gt; requires a lock to process metrics registration that is invoked while holding the sensor lock. It also reads metrics attempting to acquire sensor lock while holding its lock (inverse order). This resulted in the deadlock below.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Found one Java-level deadlock:&lt;br/&gt;
 Java stack information for the threads listed above:&lt;br/&gt;
 ===================================================&lt;br/&gt;
 &quot;StreamThread-7&quot;:&lt;br/&gt;
 at org.apache.kafka.tools.PushHttpMetricsReporter.metricChange(PushHttpMetricsReporter.java:144)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;waiting to lock &amp;lt;0x0000000655a54310&amp;gt; (a java.lang.Object)&lt;br/&gt;
 at org.apache.kafka.common.metrics.Metrics.registerMetric(Metrics.java:563)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;0x0000000655a44a28&amp;gt; (a org.apache.kafka.common.metrics.Metrics)&lt;br/&gt;
 at org.apache.kafka.common.metrics.Sensor.add(Sensor.java:236)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;0x000000065629c170&amp;gt; (a org.apache.kafka.common.metrics.Sensor)&lt;br/&gt;
 at org.apache.kafka.common.metrics.Sensor.add(Sensor.java:217)&lt;br/&gt;
 at org.apache.kafka.common.network.Selector$SelectorMetrics.maybeRegisterConnectionMetrics(Selector.java:1016)&lt;br/&gt;
 at org.apache.kafka.common.network.Selector.pollSelectionKeys(Selector.java:462)&lt;br/&gt;
 at org.apache.kafka.common.network.Selector.poll(Selector.java:425)&lt;br/&gt;
 at org.apache.kafka.clients.NetworkClient.poll(NetworkClient.java:510)&lt;br/&gt;
 at org.apache.kafka.clients.consumer.internals.ConsumerNetworkClient.poll(ConsumerNetworkClient.java:271)&lt;br/&gt;
 at org.apache.kafka.clients.consumer.internals.ConsumerNetworkClient.poll(ConsumerNetworkClient.java:242)&lt;br/&gt;
 at org.apache.kafka.clients.consumer.internals.ConsumerNetworkClient.poll(ConsumerNetworkClient.java:218)&lt;br/&gt;
 at org.apache.kafka.clients.consumer.internals.Fetcher.getTopicMetadata(Fetcher.java:274)&lt;br/&gt;
 at org.apache.kafka.clients.consumer.internals.Fetcher.getAllTopicMetadata(Fetcher.java:254)&lt;br/&gt;
 at org.apache.kafka.clients.consumer.KafkaConsumer.listTopics(KafkaConsumer.java:1820)&lt;br/&gt;
 at org.apache.kafka.clients.consumer.KafkaConsumer.listTopics(KafkaConsumer.java:1798)&lt;br/&gt;
 at org.apache.kafka.streams.processor.internals.StoreChangelogReader.refreshChangelogInfo(StoreChangelogReader.java:224)&lt;br/&gt;
 at org.apache.kafka.streams.processor.internals.StoreChangelogReader.initialize(StoreChangelogReader.java:121)&lt;br/&gt;
 at org.apache.kafka.streams.processor.internals.StoreChangelogReader.restore(StoreChangelogReader.java:74)&lt;br/&gt;
 at org.apache.kafka.streams.processor.internals.TaskManager.updateNewAndRestoringTasks(TaskManager.java:317)&lt;br/&gt;
 at org.apache.kafka.streams.processor.internals.StreamThread.runOnce(StreamThread.java:824)&lt;br/&gt;
 at org.apache.kafka.streams.processor.internals.StreamThread.runLoop(StreamThread.java:767)&lt;br/&gt;
 at org.apache.kafka.streams.processor.internals.StreamThread.run(StreamThread.java:736)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt; &quot;pool-17-thread-1&quot;:&lt;br/&gt;
 at org.apache.kafka.common.metrics.KafkaMetric.measurableValue(KafkaMetric.java:82)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;waiting to lock &amp;lt;0x000000065629c170&amp;gt; (a org.apache.kafka.common.metrics.Sensor)&lt;br/&gt;
 at org.apache.kafka.common.metrics.KafkaMetric.value(KafkaMetric.java:58)&lt;br/&gt;
 at org.apache.kafka.tools.PushHttpMetricsReporter$HttpReporter.run(PushHttpMetricsReporter.java:177)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;0x0000000655a54310&amp;gt; (a java.lang.Object)&lt;br/&gt;
 at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)&lt;br/&gt;
 at java.util.concurrent.FutureTask.runAndReset(FutureTask.java:308)&lt;br/&gt;
 at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$301(ScheduledThreadPoolExecutor.java:180)&lt;br/&gt;
 at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:294)&lt;br/&gt;
 at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)&lt;br/&gt;
 at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)&lt;br/&gt;
 at java.lang.Thread.run(Thread.java:748)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Found 1 deadlock.&lt;/p&gt;&lt;/blockquote&gt;</description>
                <environment></environment>
        <key id="13170353">KAFKA-7136</key>
            <summary>PushHttpMetricsReporter may deadlock when processing metrics changes</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rsivaram">Rajini Sivaram</assignee>
                                    <reporter username="rsivaram">Rajini Sivaram</reporter>
                        <labels>
                    </labels>
                <created>Thu, 5 Jul 2018 20:29:59 +0000</created>
                <updated>Sun, 8 Jul 2018 22:34:39 +0000</updated>
                            <resolved>Sat, 7 Jul 2018 01:39:09 +0000</resolved>
                                    <version>1.1.0</version>
                    <version>2.0.0</version>
                                    <fixVersion>1.1.1</fixVersion>
                    <fixVersion>2.0.0</fixVersion>
                                    <component>metrics</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="16534118" author="rsivaram" created="Thu, 5 Jul 2018 20:36:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lindong&quot; class=&quot;user-hover&quot; rel=&quot;lindong&quot;&gt;lindong&lt;/a&gt; I have marked this as a blocker for 2.0.0. It affects 1.1.1 as well, do you think we should fix it for 1.1.1?&lt;/p&gt;</comment>
                            <comment id="16534130" author="ijuma" created="Thu, 5 Jul 2018 20:46:04 +0000"  >&lt;p&gt;Was this introduced between 1.1.0 and 1.1.1? If so, does it affect normal users, not just our system test infrastructure?&lt;/p&gt;</comment>
                            <comment id="16534162" author="rsivaram" created="Thu, 5 Jul 2018 21:10:51 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ijuma&quot; class=&quot;user-hover&quot; rel=&quot;ijuma&quot;&gt;ijuma&lt;/a&gt; The deadlock was introduced between 1.1.0 and 1.1.1. The javadoc for &lt;tt&gt;PushHttpMetricsReporter&lt;/tt&gt; says:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;This is an internal class used for system tests and does not provide any compatibility guarantees.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;So I suppose we dont need the fix for&#160;&lt;tt&gt;PushHttpMetricsReporter&lt;/tt&gt; to be a blocker for 1.1.1 or 2.0.0. We can fix &lt;tt&gt;PushHttpMetricsReporter&lt;/tt&gt; quite easily by avoiding locking while reading metrics values. But we shouldn&apos;t require another RC for that.&lt;/p&gt;

&lt;p&gt;We don&apos;t document anything regarding locking in the MetricsReporter interface. I wonder if we should consider fixing this properly by changing locking in metrics to avoid other custom metrics reporters deadlocking. That is a much riskier change. Should we consider doing that for 2.0.0? Or is it sufficient to document thread-safety restrictions for metrics reporters (without an RC)? The change that caused the deadlock was fixing &lt;tt&gt;NullPointerException&lt;/tt&gt;, so don&apos;t think we want to revert that. &lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16534191" author="lindong" created="Thu, 5 Jul 2018 21:44:27 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rsivaram&quot; class=&quot;user-hover&quot; rel=&quot;rsivaram&quot;&gt;rsivaram&lt;/a&gt;&#160;Yes, this probably does not need to be blocker since it is an internal class used for system tests.&#160;&lt;/p&gt;</comment>
                            <comment id="16534201" author="ijuma" created="Thu, 5 Jul 2018 21:52:15 +0000"  >&lt;p&gt;I think the important question is whether custom metrics reporters are likely to do the same as PushHttpMetricsReporter. If so, that could be very bad. We have to be very careful about not introducing regressions in bug fix releases so it&apos;s a tough one.&lt;/p&gt;</comment>
                            <comment id="16534668" author="githubbot" created="Fri, 6 Jul 2018 10:34:45 +0000"  >&lt;p&gt;rajinisivaram opened a new pull request #5341: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7136&quot; title=&quot;PushHttpMetricsReporter may deadlock when processing metrics changes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7136&quot;&gt;&lt;del&gt;KAFKA-7136&lt;/del&gt;&lt;/a&gt;: Avoid deadlocks in synchronized metrics reporters&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5341&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5341&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   We need to use the same lock for metric update and read to avoid NPE and concurrent modification exceptions.  Sensor add/remove/update are synchronized on `Sensor` since they access lists and maps that are not thread-safe. Reporters are notified of metrics add/remove while holding (`Sensor`, `Metrics`) locks and reporters may synchronize on the reporter lock. Metric read may be invoked by metrics reporters while holding a reporter lock. So read/update cannot be synchronized using `Sensor` since that could lead to deadlock. This PR introduces a new lock in Sensor for update/read. &lt;br/&gt;
   Locking order:&lt;br/&gt;
   ```&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Sensor#add: Sensor -&amp;gt; Metrics -&amp;gt; MetricsReporter&lt;/li&gt;
	&lt;li&gt;Metrics#removeSensor: Sensor -&amp;gt; Metrics -&amp;gt; MetricsReporter&lt;/li&gt;
	&lt;li&gt;KafkaMetric#metricValue: MetricsReporter -&amp;gt; Sensor#metricLock&lt;/li&gt;
	&lt;li&gt;Sensor#record: Sensor -&amp;gt; Sensor#metricLock&lt;br/&gt;
   ```&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16534949" author="rsivaram" created="Fri, 6 Jul 2018 15:04:12 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lindong&quot; class=&quot;user-hover&quot; rel=&quot;lindong&quot;&gt;lindong&lt;/a&gt; Even though only &lt;tt&gt;PushHttpMetricsReporter&lt;/tt&gt; used by system tests hit the deadlock, we are thinking of including a fix in 2.0.0 since the synchronization in &lt;tt&gt;PushHttpMetricsReporter&lt;/tt&gt; is not unreasonable and the same pattern may be used in other custom metrics reporters. Since this is a regression, it may be good to include a fix in 1.1.1 as well. What do you think?&lt;/p&gt;</comment>
                            <comment id="16535187" author="githubbot" created="Fri, 6 Jul 2018 17:54:31 +0000"  >&lt;p&gt;guozhangwang closed pull request #5341: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7136&quot; title=&quot;PushHttpMetricsReporter may deadlock when processing metrics changes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7136&quot;&gt;&lt;del&gt;KAFKA-7136&lt;/del&gt;&lt;/a&gt;: Avoid deadlocks in synchronized metrics reporters&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5341&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5341&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/checkstyle/suppressions.xml b/checkstyle/suppressions.xml&lt;br/&gt;
index 5bf69b6b65f..e80d5bf24c1 100644&lt;br/&gt;
&amp;#8212; a/checkstyle/suppressions.xml&lt;br/&gt;
+++ b/checkstyle/suppressions.xml&lt;br/&gt;
@@ -73,7 +73,7 @@&lt;br/&gt;
               files=&quot;RequestResponseTest.java&quot;/&amp;gt;&lt;/p&gt;

&lt;p&gt;     &amp;lt;suppress checks=&quot;NPathComplexity&quot;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;files=&quot;MemoryRecordsTest.java&quot;/&amp;gt;&lt;br/&gt;
+              files=&quot;MemoryRecordsTest|MetricsTest&quot;/&amp;gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     &amp;lt;!-- Connect --&amp;gt;&lt;br/&gt;
     &amp;lt;suppress checks=&quot;ClassFanOutComplexity&quot;&lt;br/&gt;
diff --git a/clients/src/main/java/org/apache/kafka/common/metrics/Sensor.java b/clients/src/main/java/org/apache/kafka/common/metrics/Sensor.java&lt;br/&gt;
index e4bf1aeee69..ccbe8aad9cd 100644&lt;br/&gt;
&amp;#8212; a/clients/src/main/java/org/apache/kafka/common/metrics/Sensor.java&lt;br/&gt;
+++ b/clients/src/main/java/org/apache/kafka/common/metrics/Sensor.java&lt;br/&gt;
@@ -48,6 +48,7 @@&lt;br/&gt;
     private final Time time;&lt;br/&gt;
     private volatile long lastRecordTime;&lt;br/&gt;
     private final long inactiveSensorExpirationTimeMs;&lt;br/&gt;
+    private final Object metricLock;&lt;/p&gt;

&lt;p&gt;     public enum RecordingLevel {&lt;br/&gt;
         INFO(0, &quot;INFO&quot;), DEBUG(1, &quot;DEBUG&quot;);&lt;br/&gt;
@@ -113,6 +114,7 @@ public boolean shouldRecord(final int configId) &lt;/p&gt;
{
         this.inactiveSensorExpirationTimeMs = TimeUnit.MILLISECONDS.convert(inactiveSensorExpirationTimeSeconds, TimeUnit.SECONDS);
         this.lastRecordTime = time.milliseconds();
         this.recordingLevel = recordingLevel;
+        this.metricLock = new Object();
         checkForest(new HashSet&amp;lt;Sensor&amp;gt;());
     }

&lt;p&gt;@@ -174,9 +176,11 @@ public void record(double value, long timeMs, boolean checkQuotas) {&lt;br/&gt;
         if (shouldRecord()) {&lt;br/&gt;
             this.lastRecordTime = timeMs;&lt;br/&gt;
             synchronized (this) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// increment all the stats&lt;/li&gt;
	&lt;li&gt;for (Stat stat : this.stats)&lt;/li&gt;
	&lt;li&gt;stat.record(config, value, timeMs);&lt;br/&gt;
+                synchronized (metricLock()) 
{
+                    // increment all the stats
+                    for (Stat stat : this.stats)
+                        stat.record(config, value, timeMs);
+                }
&lt;p&gt;                 if (checkQuotas)&lt;br/&gt;
                     checkQuotas(timeMs);&lt;br/&gt;
             }&lt;br/&gt;
@@ -229,7 +233,7 @@ public synchronized boolean add(CompoundStat stat, MetricConfig config) {&lt;br/&gt;
             return false;&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         this.stats.add(Utils.notNull(stat));&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Object lock = metricLock(stat);&lt;br/&gt;
+        Object lock = metricLock();&lt;br/&gt;
         for (NamedMeasurable m : stat.stats()) {&lt;br/&gt;
             final KafkaMetric metric = new KafkaMetric(lock, m.name(), m.stat(), config == null ? this.config : config, time);&lt;br/&gt;
             if (!metrics.containsKey(metric.metricName())) 
{
@@ -265,7 +269,7 @@ public synchronized boolean add(final MetricName metricName, final MeasurableSta
             return true;
         }
&lt;p&gt; else {&lt;br/&gt;
             final KafkaMetric metric = new KafkaMetric(&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;metricLock(stat),&lt;br/&gt;
+                metricLock(),&lt;br/&gt;
                 Utils.notNull(metricName),&lt;br/&gt;
                 Utils.notNull(stat),&lt;br/&gt;
                 config == null ? this.config : config,&lt;br/&gt;
@@ -291,10 +295,26 @@ public boolean hasExpired() {&lt;br/&gt;
     }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     /**&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;* KafkaMetrics of sensors which use SampledStat should be synchronized on the Sensor object&lt;/li&gt;
	&lt;li&gt;* to allow concurrent reads and updates. For simplicity, all sensors are synchronized on Sensor.&lt;br/&gt;
+     * KafkaMetrics of sensors which use SampledStat should be synchronized on the same lock&lt;br/&gt;
+     * for sensor record and metric value read to allow concurrent reads and updates. For simplicity,&lt;br/&gt;
+     * all sensors are synchronized on this object.&lt;br/&gt;
+     * &amp;lt;p&amp;gt;&lt;br/&gt;
+     * Sensor object is not used as a lock for reading metric value since metrics reporter is&lt;br/&gt;
+     * invoked while holding Sensor and Metrics locks to report addition and removal of metrics&lt;br/&gt;
+     * and synchronized reporters may deadlock if Sensor lock is used for reading metrics values.&lt;br/&gt;
+     * Note that Sensor object itself is used as a lock to protect the access to stats and metrics&lt;br/&gt;
+     * while recording metric values, adding and deleting sensors.&lt;br/&gt;
+     * &amp;lt;/p&amp;gt;&amp;lt;p&amp;gt;&lt;br/&gt;
+     * Locking order (assume all MetricsReporter methods may be synchronized):&lt;br/&gt;
+     * &amp;lt;ul&amp;gt;&lt;br/&gt;
+     *   &amp;lt;li&amp;gt;Sensor#add: Sensor -&amp;gt; Metrics -&amp;gt; MetricsReporter&amp;lt;/li&amp;gt;&lt;br/&gt;
+     *   &amp;lt;li&amp;gt;Metrics#removeSensor: Sensor -&amp;gt; Metrics -&amp;gt; MetricsReporter&amp;lt;/li&amp;gt;&lt;br/&gt;
+     *   &amp;lt;li&amp;gt;KafkaMetric#metricValue: MetricsReporter -&amp;gt; Sensor#metricLock&amp;lt;/li&amp;gt;&lt;br/&gt;
+     *   &amp;lt;li&amp;gt;Sensor#record: Sensor -&amp;gt; Sensor#metricLock&amp;lt;/li&amp;gt;&lt;br/&gt;
+     * &amp;lt;/ul&amp;gt;&lt;br/&gt;
+     * &amp;lt;/p&amp;gt;&lt;br/&gt;
      */&lt;/li&gt;
	&lt;li&gt;private Object metricLock(Stat stat) {&lt;/li&gt;
	&lt;li&gt;return this;&lt;br/&gt;
+    private Object metricLock() 
{
+        return metricLock;
     }
&lt;p&gt; }&lt;br/&gt;
diff --git a/clients/src/test/java/org/apache/kafka/common/metrics/MetricsTest.java b/clients/src/test/java/org/apache/kafka/common/metrics/MetricsTest.java&lt;br/&gt;
index 6acc39d35a6..59bc84e40de 100644&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/clients/src/test/java/org/apache/kafka/common/metrics/MetricsTest.java&lt;br/&gt;
+++ b/clients/src/test/java/org/apache/kafka/common/metrics/MetricsTest.java&lt;br/&gt;
@@ -26,13 +26,16 @@&lt;br/&gt;
 import java.util.Arrays;&lt;br/&gt;
 import java.util.Collections;&lt;br/&gt;
 import java.util.Deque;&lt;br/&gt;
+import java.util.List;&lt;br/&gt;
 import java.util.HashMap;&lt;br/&gt;
 import java.util.Map;&lt;br/&gt;
 import java.util.Random;&lt;br/&gt;
 import java.util.concurrent.ConcurrentLinkedDeque;&lt;br/&gt;
 import java.util.concurrent.ExecutorService;&lt;br/&gt;
 import java.util.concurrent.Executors;&lt;br/&gt;
+import java.util.concurrent.Future;&lt;br/&gt;
 import java.util.concurrent.TimeUnit;&lt;br/&gt;
+&lt;br/&gt;
 import java.util.concurrent.atomic.AtomicBoolean;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; import org.apache.kafka.common.Metric;&lt;br/&gt;
@@ -54,9 +57,12 @@&lt;br/&gt;
 import org.junit.After;&lt;br/&gt;
 import org.junit.Before;&lt;br/&gt;
 import org.junit.Test;&lt;br/&gt;
+import org.slf4j.Logger;&lt;br/&gt;
+import org.slf4j.LoggerFactory;&lt;/p&gt;

&lt;p&gt; @SuppressWarnings(&quot;deprecation&quot;)&lt;br/&gt;
 public class MetricsTest {&lt;br/&gt;
+    private static final Logger log = LoggerFactory.getLogger(MetricsTest.class);&lt;/p&gt;

&lt;p&gt;     private static final double EPS = 0.000001;&lt;br/&gt;
     private MockTime time = new MockTime();&lt;br/&gt;
@@ -604,8 +610,12 @@ public void testMetricInstances() {&lt;br/&gt;
         }&lt;br/&gt;
     }&lt;/p&gt;

&lt;p&gt;+    /**&lt;br/&gt;
+     * Verifies that concurrent sensor add, remove, updates and read don&apos;t result&lt;br/&gt;
+     * in errors or deadlock.&lt;br/&gt;
+     */&lt;br/&gt;
     @Test&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public void testConcurrentAccess() throws Exception {&lt;br/&gt;
+    public void testConcurrentReadUpdate() throws Exception {&lt;br/&gt;
         final Random random = new Random();&lt;br/&gt;
         final Deque&amp;lt;Sensor&amp;gt; sensors = new ConcurrentLinkedDeque&amp;lt;&amp;gt;();&lt;br/&gt;
         metrics = new Metrics(new MockTime(10));&lt;br/&gt;
@@ -613,16 +623,8 @@ public void testConcurrentAccess() throws Exception {&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         final AtomicBoolean alive = new AtomicBoolean(true);&lt;br/&gt;
         executorService = Executors.newSingleThreadExecutor();&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;executorService.submit(new Runnable() {&lt;/li&gt;
	&lt;li&gt;@Override&lt;/li&gt;
	&lt;li&gt;public void run() {&lt;/li&gt;
	&lt;li&gt;while (alive.get()) {&lt;/li&gt;
	&lt;li&gt;for (Sensor sensor : sensors) 
{
-                        sensor.record(random.nextInt(10000));
-                    }&lt;/li&gt;
	&lt;li&gt;}&lt;/li&gt;
	&lt;li&gt;}&lt;/li&gt;
	&lt;li&gt;});&lt;br/&gt;
+        executorService.submit(new ConcurrentMetricOperation(alive, &quot;record&quot;,&lt;br/&gt;
+            () -&amp;gt; sensors.forEach(sensor -&amp;gt; sensor.record(random.nextInt(10000)))));&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         for (int i = 0; i &amp;lt; 10000; i++) {&lt;br/&gt;
             if (sensors.size() &amp;gt; 5) {&lt;br/&gt;
@@ -640,6 +642,97 @@ public void run() &lt;/p&gt;
{
         alive.set(false);
     }

&lt;p&gt;+    /**&lt;br/&gt;
+     * Verifies that concurrent sensor add, remove, updates and read with a metrics reporter&lt;br/&gt;
+     * that synchronizes on every reporter method doesn&apos;t result in errors or deadlock.&lt;br/&gt;
+     */&lt;br/&gt;
+    @Test&lt;br/&gt;
+    public void testConcurrentReadUpdateReport() throws Exception {&lt;br/&gt;
+&lt;br/&gt;
+        class LockingReporter implements MetricsReporter {&lt;br/&gt;
+            Map&amp;lt;MetricName, KafkaMetric&amp;gt; activeMetrics = new HashMap&amp;lt;&amp;gt;();&lt;br/&gt;
+            @Override&lt;br/&gt;
+            public synchronized void init(List&amp;lt;KafkaMetric&amp;gt; metrics) &lt;/p&gt;
{
+            }&lt;br/&gt;
+&lt;br/&gt;
+            @Override&lt;br/&gt;
+            public synchronized void metricChange(KafkaMetric metric) {
+                activeMetrics.put(metric.metricName(), metric);
+            }&lt;br/&gt;
+&lt;br/&gt;
+            @Override&lt;br/&gt;
+            public synchronized void metricRemoval(KafkaMetric metric) {
+                activeMetrics.remove(metric.metricName(), metric);
+            }&lt;br/&gt;
+&lt;br/&gt;
+            @Override&lt;br/&gt;
+            public synchronized void close() {+            }
&lt;p&gt;+&lt;br/&gt;
+            @Override&lt;br/&gt;
+            public void configure(Map&amp;lt;String, ?&amp;gt; configs) &lt;/p&gt;
{
+            }
&lt;p&gt;+&lt;br/&gt;
+            synchronized void processMetrics() {&lt;br/&gt;
+                for (KafkaMetric metric : activeMetrics.values()) &lt;/p&gt;
{
+                    assertNotNull(&quot;Invalid metric value&quot;, metric.metricValue());
+                }
&lt;p&gt;+            }&lt;br/&gt;
+        }&lt;br/&gt;
+&lt;br/&gt;
+        final LockingReporter reporter = new LockingReporter();&lt;br/&gt;
+        this.metrics.close();&lt;br/&gt;
+        this.metrics = new Metrics(config, Arrays.asList((MetricsReporter) reporter), new MockTime(10), true);&lt;br/&gt;
+        final Deque&amp;lt;Sensor&amp;gt; sensors = new ConcurrentLinkedDeque&amp;lt;&amp;gt;();&lt;br/&gt;
+        SensorCreator sensorCreator = new SensorCreator(metrics);&lt;br/&gt;
+&lt;br/&gt;
+        final Random random = new Random();&lt;br/&gt;
+        final AtomicBoolean alive = new AtomicBoolean(true);&lt;br/&gt;
+        executorService = Executors.newFixedThreadPool(3);&lt;br/&gt;
+&lt;br/&gt;
+        Future&amp;lt;?&amp;gt; writeFuture = executorService.submit(new ConcurrentMetricOperation(alive, &quot;record&quot;,&lt;br/&gt;
+            () -&amp;gt; sensors.forEach(sensor -&amp;gt; sensor.record(random.nextInt(10000)))));&lt;br/&gt;
+        Future&amp;lt;?&amp;gt; readFuture = executorService.submit(new ConcurrentMetricOperation(alive, &quot;read&quot;,&lt;br/&gt;
+            () -&amp;gt; sensors.forEach(sensor -&amp;gt; sensor.metrics().forEach(metric -&amp;gt;&lt;br/&gt;
+                assertNotNull(&quot;Invalid metric value&quot;, metric.metricValue())))));&lt;br/&gt;
+        Future&amp;lt;?&amp;gt; reportFuture = executorService.submit(new ConcurrentMetricOperation(alive, &quot;report&quot;,&lt;br/&gt;
+            () -&amp;gt; reporter.processMetrics()));&lt;br/&gt;
+&lt;br/&gt;
+        for (int i = 0; i &amp;lt; 10000; i++) {&lt;br/&gt;
+            if (sensors.size() &amp;gt; 10) &lt;/p&gt;
{
+                Sensor sensor = random.nextBoolean() ? sensors.removeFirst() : sensors.removeLast();
+                metrics.removeSensor(sensor.name());
+            }
&lt;p&gt;+            StatType statType = StatType.forId(random.nextInt(StatType.values().length));&lt;br/&gt;
+            sensors.add(sensorCreator.createSensor(statType, i));&lt;br/&gt;
+        }&lt;br/&gt;
+        assertFalse(&quot;Read failed&quot;, readFuture.isDone());&lt;br/&gt;
+        assertFalse(&quot;Write failed&quot;, writeFuture.isDone());&lt;br/&gt;
+        assertFalse(&quot;Report failed&quot;, reportFuture.isDone());&lt;br/&gt;
+&lt;br/&gt;
+        alive.set(false);&lt;br/&gt;
+    }&lt;br/&gt;
+&lt;br/&gt;
+    private class ConcurrentMetricOperation implements Runnable {&lt;br/&gt;
+        private final AtomicBoolean alive;&lt;br/&gt;
+        private final String opName;&lt;br/&gt;
+        private final Runnable op;&lt;br/&gt;
+        ConcurrentMetricOperation(AtomicBoolean alive, String opName, Runnable op) &lt;/p&gt;
{
+            this.alive = alive;
+            this.opName = opName;
+            this.op = op;
+        }
&lt;p&gt;+        public void run() {&lt;br/&gt;
+            try {&lt;br/&gt;
+                while (alive.get()) &lt;/p&gt;
{
+                    op.run();
+                }
&lt;p&gt;+            } catch (Throwable t) {&lt;br/&gt;
+                log.error(&quot;Metric {} failed with exception&quot;, opName, t);&lt;br/&gt;
+            }&lt;br/&gt;
+        }&lt;br/&gt;
+    }&lt;br/&gt;
+&lt;br/&gt;
     enum StatType {&lt;br/&gt;
         AVG(0),&lt;br/&gt;
         TOTAL(1),&lt;br/&gt;
@@ -676,7 +769,7 @@ static StatType forId(int id) {&lt;br/&gt;
         }&lt;/p&gt;

&lt;p&gt;         private Sensor createSensor(StatType statType, int index) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Sensor sensor = metrics.sensor(&quot;kafka.requests&quot;);&lt;br/&gt;
+            Sensor sensor = metrics.sensor(&quot;kafka.requests.&quot; + index);&lt;br/&gt;
             Map&amp;lt;String, String&amp;gt; tags = Collections.singletonMap(&quot;tag&quot;, &quot;tag&quot; + index);&lt;br/&gt;
             switch (statType) {&lt;br/&gt;
                 case AVG:&lt;/li&gt;
&lt;/ul&gt;





&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16535542" author="lindong" created="Sat, 7 Jul 2018 01:36:38 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rsivaram&quot; class=&quot;user-hover&quot; rel=&quot;rsivaram&quot;&gt;rsivaram&lt;/a&gt; I see. Yeah we should include this fix in 1.1.1 release since it affects users rather than just system tests. I will prepare the new release candidate.&lt;/p&gt;</comment>
                            <comment id="16535545" author="guozhang" created="Sat, 7 Jul 2018 01:39:26 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lindong&quot; class=&quot;user-hover&quot; rel=&quot;lindong&quot;&gt;lindong&lt;/a&gt; I&apos;ve cherry-picked the commit fix to 1.1, 2.0 and trunk.&lt;/p&gt;</comment>
                            <comment id="16535674" author="lindong" created="Sat, 7 Jul 2018 08:05:34 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; Thank you! Could you please help start system tests for &lt;a href=&quot;https://github.com/apache/kafka/tree/1.1.1-rc3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/tree/1.1.1-rc3?&lt;/a&gt;&#160;I have finished all release certification tests for Kafka 1.1.1 RC3 except system tests.&lt;/p&gt;</comment>
                            <comment id="16535907" author="lindong" created="Sat, 7 Jul 2018 21:23:34 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ijuma&quot; class=&quot;user-hover&quot; rel=&quot;ijuma&quot;&gt;ijuma&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rsivaram&quot; class=&quot;user-hover&quot; rel=&quot;rsivaram&quot;&gt;rsivaram&lt;/a&gt; Not sure if it is required to re-run system tests for every new RC. If so, could you please help re-run system tests using&#160;&lt;a href=&quot;https://github.com/apache/kafka/tree/1.1.1-rc3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/tree/1.1.1-rc3&lt;/a&gt;&#160;? Thanks!&lt;/p&gt;</comment>
                            <comment id="16536428" author="ijuma" created="Sun, 8 Jul 2018 22:31:27 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lindong&quot; class=&quot;user-hover&quot; rel=&quot;lindong&quot;&gt;lindong&lt;/a&gt;, there&apos;s a successful nightly build for that branch:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://jenkins.confluent.io/job/system-test-kafka/job/1.1/156/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://jenkins.confluent.io/job/system-test-kafka/job/1.1/156/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16536430" author="lindong" created="Sun, 8 Jul 2018 22:34:39 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ijuma&quot; class=&quot;user-hover&quot; rel=&quot;ijuma&quot;&gt;ijuma&lt;/a&gt; Excellent. I didn&apos;t realize we have periodic system tests for each branch. Thanks much for letting me know.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 19 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3vl9z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>