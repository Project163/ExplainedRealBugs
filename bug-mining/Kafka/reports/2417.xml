<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:21:02 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-9169] Standby Tasks point ask for incorrect offsets on resuming post suspension</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-9169</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;In versions(check 2.0) where standby tasks are suspended on each rebalance the checkpoint file is updated post the flush and the expected behaviour is that post assignment the same standby task gets assigned back on the machine it will start reading data from changelog from the same offset from it left off.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;But there looks like a bug in the code, every time post rebalance it starts reading from the offset from where it read the first time the task was assigned on this machine. This has 2 repercussions:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;After every rebalance the standby tasks start restoring huge amount of data which they have already restored earlier(Verified this via 300x increase Network IO on all streams instances post rebalance even when no change in assignment) .&lt;/li&gt;
	&lt;li&gt;If changelog has time retention those offsets will not be available in the changelog, which leads to offsetOutOfRange exceptions and the stores get deleted and recreated again.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I have gone through the code and I think I know the issue.&lt;/p&gt;

&lt;p&gt;In TaskManager# updateNewAndRestoringTasks(), the function&#160;assignStandbyPartitions() gets called for all the running standby tasks where it populates the Map: checkpointedOffsets from the standbyTask.checkpointedOffsets() which is only updated at the time of initialization of a StandbyTask(i.e. in it&apos;s constructor).&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;This has an easy fix.&lt;/p&gt;

&lt;p&gt;Post resumption we are reading&#160;standbyTask.checkpointedOffsets() to know the offset&#160;from where the standby task should start running&#160;and not from stateMgr.checkpointed() which gets updated on every commit to the checkpoint file. In the former case it&apos;s always reading from the same offset, even those which it had already read earlier and in cases where changelog topic has a retention time, it gives offsetOutOfRange exception. So,&#160;standbyTask.checkpointedOffsets() is quite useless and we should use&#160;stateMgr.checkpointed() instead to return offsets to task manager.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13267384">KAFKA-9169</key>
            <summary>Standby Tasks point ask for incorrect offsets on resuming post suspension</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="vvcephei">John Roesler</assignee>
                                    <reporter username="NaviBrar">Navinder Brar</reporter>
                        <labels>
                    </labels>
                <created>Mon, 11 Nov 2019 02:09:50 +0000</created>
                <updated>Sat, 16 Nov 2019 15:24:20 +0000</updated>
                            <resolved>Thu, 14 Nov 2019 04:14:12 +0000</resolved>
                                    <version>1.1.0</version>
                                    <fixVersion>2.5.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16971890" author="githubbot" created="Mon, 11 Nov 2019 22:50:25 +0000"  >&lt;p&gt;vvcephei commented on pull request #7681: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-9169&quot; title=&quot;Standby Tasks point ask for incorrect offsets on resuming post suspension&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-9169&quot;&gt;&lt;del&gt;KAFKA-9169&lt;/del&gt;&lt;/a&gt;: fix standby checkpoint initialization&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/7681&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/7681&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Instead of caching the checkpoint map during StandbyTask initialization, use the latest checkpoints (which would have been updated during suspend).&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16972911" author="vvcephei" created="Wed, 13 Nov 2019 00:13:49 +0000"  >&lt;p&gt;After testing, I&apos;ve determined that the bug is pre-existing in the 2.3 branch at least.&lt;/p&gt;

&lt;p&gt;Since it&apos;s not a regression, I&apos;m downgrading it to critical.&lt;/p&gt;</comment>
                            <comment id="16973918" author="githubbot" created="Thu, 14 Nov 2019 04:03:49 +0000"  >&lt;p&gt;vvcephei commented on pull request #7681: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-9169&quot; title=&quot;Standby Tasks point ask for incorrect offsets on resuming post suspension&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-9169&quot;&gt;&lt;del&gt;KAFKA-9169&lt;/del&gt;&lt;/a&gt;: fix standby checkpoint initialization&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/7681&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/7681&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16973919" author="vvcephei" created="Thu, 14 Nov 2019 04:14:12 +0000"  >&lt;p&gt;This was fixed in &lt;a href=&quot;https://github.com/apache/kafka/pull/7681/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/7681/&lt;/a&gt; and merged to trunk (currently 2.5.0-SNAPSHOT)&lt;/p&gt;</comment>
                            <comment id="16973922" author="mjsax" created="Thu, 14 Nov 2019 04:20:21 +0000"  >&lt;p&gt;Update &quot;Affects Version&quot; to first affected version what is sufficient for tracking.&lt;/p&gt;</comment>
                            <comment id="16974430" author="vvcephei" created="Thu, 14 Nov 2019 16:53:04 +0000"  >&lt;p&gt;Aha, that makes more sense... Thanks, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mjsax&quot; class=&quot;user-hover&quot; rel=&quot;mjsax&quot;&gt;mjsax&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;n.b., 2.3.0 is probably not truly the first affected version, but it&apos;s the first &lt;b&gt;confirmed&lt;/b&gt; affected version. For this issue, we can only determine an affected version empirically, so we would have to port the system test from the PR to each old version we want to consider.&lt;/p&gt;

&lt;p&gt;Just wanted to make that clear in case someone wants to know later on if a specific older version &amp;lt; 2.3.0 is affected. The answer is, &quot;unknown, but we can find out&quot;.&lt;/p&gt;</comment>
                            <comment id="16974852" author="mjsax" created="Fri, 15 Nov 2019 06:31:59 +0000"  >&lt;p&gt;Yeah. If we confirm for older version, we can just update the ticket.&lt;/p&gt;</comment>
                            <comment id="16975693" author="navibrar" created="Sat, 16 Nov 2019 13:03:39 +0000"  >&lt;p&gt;I can confirm that this has been there since 1.1 version.&lt;/p&gt;</comment>
                            <comment id="16975723" author="vvcephei" created="Sat, 16 Nov 2019 15:24:20 +0000"  >&lt;p&gt;Thanks, Navinder. I&#8217;ve set the affected version field to 1.1.0&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z08gbk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>