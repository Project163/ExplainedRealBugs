<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:37:05 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-705] Controlled shutdown doesn&apos;t seem to work on more than one broker in a cluster</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-705</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;I wrote a script (attached here) to basically round robin through the brokers in a cluster doing the following 2 operations on each of them -&lt;/p&gt;

&lt;p&gt;1. Send the controlled shutdown admin command. If it succeeds&lt;br/&gt;
2. Restart the broker&lt;/p&gt;

&lt;p&gt;What I&apos;ve observed is that only one broker is able to finish the above successfully the first time around. For the rest of the iterations, no broker is able to shutdown using the admin command and every single time it fails with the error message stating the same number of leaders on every broker. &lt;/p&gt;
</description>
                <environment></environment>
        <key id="12627749">KAFKA-705</key>
            <summary>Controlled shutdown doesn&apos;t seem to work on more than one broker in a cluster</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jjkoshy">Joel Jacob Koshy</assignee>
                                    <reporter username="nehanarkhede">Neha Narkhede</reporter>
                        <labels>
                            <label>bugs</label>
                    </labels>
                <created>Tue, 15 Jan 2013 22:57:50 +0000</created>
                <updated>Tue, 16 Jul 2013 06:43:45 +0000</updated>
                            <resolved>Tue, 16 Jul 2013 06:43:40 +0000</resolved>
                                    <version>0.8.0</version>
                                                    <component>core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13554485" author="nehanarkhede" created="Tue, 15 Jan 2013 22:59:43 +0000"  >&lt;p&gt;Run it with the --help option to list the description of the command line options. &lt;/p&gt;</comment>
                            <comment id="13555352" author="jjkoshy" created="Wed, 16 Jan 2013 19:15:33 +0000"  >&lt;p&gt;I set up a local cluster of three brokers and created a bunch of topics, replication factor = 2. I was able to do multiple iterations of rolling bounces without&lt;br/&gt;
issue. Since this was local, I did not use your py script as it kills pid&apos;s returned by ps.&lt;/p&gt;

&lt;p&gt;Would you by any chance be able to provide a scenario to reproduce this locally? That said, I believe John Fung also tried to reproduce this in a&lt;br/&gt;
distributed environment but was unable to do so; so I&apos;ll probably need to take a look at logs in your environment.&lt;/p&gt;</comment>
                            <comment id="13555359" author="nehanarkhede" created="Wed, 16 Jan 2013 19:17:39 +0000"  >&lt;p&gt;&amp;gt;&amp;gt; Would you by any chance be able to provide a scenario to reproduce this locally?&lt;/p&gt;

&lt;p&gt;I would suggest you try out on a distributed environment that is setup on a large amount of partitions and traffic. Since it is internal, I can pass on the connection url to you.&lt;/p&gt;</comment>
                            <comment id="13557481" author="jjkoshy" created="Fri, 18 Jan 2013 19:00:32 +0000"  >&lt;p&gt;I think this is why it happens:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/kafka/blob/03eb903ce223ab55c5acbcf4243ce805aaaf4fad/core/src/main/scala/kafka/controller/ReplicaStateMachine.scala#L150&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/03eb903ce223ab55c5acbcf4243ce805aaaf4fad/core/src/main/scala/kafka/controller/ReplicaStateMachine.scala#L150&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;It could occur as follows. Suppose there&apos;s a partition &apos;P&apos; assigned to brokers x and y; leaderAndIsr = y, &lt;/p&gt;
{x, y}
&lt;p&gt;1. Controlled shutdown of broker x; leaderAndIsr -&amp;gt; y, &lt;/p&gt;
{y}
&lt;p&gt;2. After above completes, kill -15 and then restart broker x&lt;br/&gt;
3. Immediately do a controlled shutdown of broker y; so now y is in the list of shutting down brokers.&lt;/p&gt;

&lt;p&gt;Due to the above, x will not start its follower to &apos;P&apos; on broker y.&lt;/p&gt;

&lt;p&gt;Adding sufficient wait time between (2) and (3) seems to address the issue (in your script there&apos;s no sleep), but we should handle it properly in the shutdown code.&lt;br/&gt;
Will think about a fix for that.&lt;/p&gt;</comment>
                            <comment id="13557632" author="jjkoshy" created="Fri, 18 Jan 2013 21:37:56 +0000"  >&lt;p&gt;Here&apos;s a simple fix.&lt;/p&gt;

&lt;p&gt;I don&apos;t really see any good reason why we shouldn&apos;t allow starting&lt;br/&gt;
a fetcher to a broker that is shutting down but not completely&lt;br/&gt;
shut down yet if a leader still exists on that broker.&lt;/p&gt;</comment>
                            <comment id="13558341" author="nehanarkhede" created="Sun, 20 Jan 2013 18:45:46 +0000"  >&lt;p&gt;+1 on the fix. And there is a problem with the script I wrote. This fix is correct, but the script will fail because it uses the shutdown command in a way that is not recommended or intended. It shuts down one broker, restarts it, doesn&apos;t wait until the restart is completed and the first broker re-registers itself in zookeeper and proceeds to shutting down the next broker. Since the replication factor is 2, if both these brokers were the replicas for some partitions, they go into the under replicated state and the script is never able to shut any other broker down after that.&lt;/p&gt;

&lt;p&gt;I think we should include this fix.&lt;/p&gt;</comment>
                            <comment id="13559121" author="jjkoshy" created="Mon, 21 Jan 2013 21:37:29 +0000"  >&lt;p&gt;I committed the fix to 0.8 with a small edit: used the liveOrShuttingDownBrokers field.&lt;/p&gt;

&lt;p&gt;Another small issue is that we send a stop replica fetchers to the shutting down broker even if&lt;br/&gt;
controlled shutdown did not complete. This &quot;prematurely&quot; forces the broker out of the ISR of those&lt;br/&gt;
partitions. I think it should be safe to avoid sending the stop replica request if controlled shutdown&lt;br/&gt;
has not completely moved leadership of partitions off the shutting down broker.&lt;/p&gt;</comment>
                            <comment id="13559125" author="jjkoshy" created="Mon, 21 Jan 2013 21:43:36 +0000"  >&lt;p&gt;Here is what I meant in my last comment.&lt;/p&gt;</comment>
                            <comment id="13559793" author="nehanarkhede" created="Tue, 22 Jan 2013 17:34:49 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13559968" author="jjkoshy" created="Tue, 22 Jan 2013 20:14:18 +0000"  >&lt;p&gt;Thanks for reviewing. I checked-in the incremental patch as well. Will leave this jira open for now until it can be verified.&lt;/p&gt;</comment>
                            <comment id="13706330" author="jkreps" created="Thu, 11 Jul 2013 22:13:57 +0000"  >&lt;p&gt;Joel, this is done, no?&lt;/p&gt;</comment>
                            <comment id="13709525" author="jjkoshy" created="Tue, 16 Jul 2013 06:43:28 +0000"  >&lt;p&gt;Yes we can close this.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12565853" name="kafka-705-incremental-v2.patch" size="3093" author="jjkoshy" created="Mon, 21 Jan 2013 21:43:36 +0000"/>
                            <attachment id="12565560" name="kafka-705-v1.patch" size="2307" author="jjkoshy" created="Fri, 18 Jan 2013 21:37:56 +0000"/>
                            <attachment id="12565029" name="shutdown-command" size="255" author="nehanarkhede" created="Tue, 15 Jan 2013 22:59:43 +0000"/>
                            <attachment id="12565028" name="shutdown_brokers_eat.py" size="2974" author="nehanarkhede" created="Tue, 15 Jan 2013 22:59:43 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>304537</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 19 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i17n7z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>252731</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>