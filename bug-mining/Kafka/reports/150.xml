<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:36:30 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-612] move shutting down of fetcher thread out of critical path</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-612</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Shutting down a fetch thread seems to take more than 200ms since we need to interrupt the thread. Currently, we shutdown fetcher threads while processing a leaderAndIsr request. This can delay some of the partitions to become a leader.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12616127">KAFKA-612</key>
            <summary>move shutting down of fetcher thread out of critical path</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="junrao">Jun Rao</assignee>
                                    <reporter username="junrao">Jun Rao</reporter>
                        <labels>
                    </labels>
                <created>Wed, 14 Nov 2012 21:35:51 +0000</created>
                <updated>Mon, 19 Nov 2012 05:52:54 +0000</updated>
                            <resolved>Mon, 19 Nov 2012 05:52:48 +0000</resolved>
                                    <version>0.8.0</version>
                                    <fixVersion>0.8.0</fixVersion>
                                    <component>core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13497491" author="junrao" created="Wed, 14 Nov 2012 21:42:36 +0000"  >&lt;p&gt;Attach a patch. It introduces a separate method for shutting down empty fetcher threads and that method will be called at the end of processing a leaderAndIsr request. Because of this change, a fetcher thread could have an empty fetch map. To avoid sending empty fetch requests to the broker, the patch uses a condition to coordinate the fetch. Also fixed a bug when removing items from a scala map (can&apos;t do the removal while iterating the map since the behaviour is not deterministic).&lt;/p&gt;</comment>
                            <comment id="13499572" author="nehanarkhede" created="Sun, 18 Nov 2012 01:02:44 +0000"  >&lt;p&gt;Overall, the fix looks good, here are a few review comments -&lt;/p&gt;

&lt;p&gt;1. AbstractFetcherThread&lt;br/&gt;
1.1 I&apos;m trying to understand what can cause a particular topic partition from the response object to have no offset in the fetchMap. Right now, we ignore this case altogether. I&apos;m guessing if the leader changes after the broker sends the fetch response, this could happen, which is ok. Wondering if this is what was intended or if we should log and handle the error case ?&lt;br/&gt;
1.2 hasPartition and partCount could use a refactor. You can return a value from a try catch block, the finally block will still execute and unlock the fetch map lock.&lt;/p&gt;

&lt;p&gt;2. ReplicaManager&lt;br/&gt;
The right way to measure leader election latency is at the controller by measuring the time after it sent a leader/isr request to the time it received the corresponding ACK fro&lt;br/&gt;
m the broker. Given that, we should probably move the following lines at the end of handleLeaderAndIsrRequest in KafkaApis.&lt;br/&gt;
    info(&quot;Completed leader and isr request %s&quot;.format(leaderAndISRRequest))&lt;br/&gt;
    replicaFetcherManager.shutdownEmptyFetcherThread()&lt;/p&gt;

&lt;p&gt;3. AbstractFetcherThread &lt;br/&gt;
3.1 fetchMap is a confusing name, this map is keeping track of fetch offsets per topic partition. I haven&apos;t looked at this code in much detail before, but when I read it while &lt;br/&gt;
reviewing this patch, I thought the names of the maps could be improved. For example, the map in AbstractFetcherManager is called fetcherThreadMap and the map in this class is &lt;br/&gt;
called fetcherMap.&lt;br/&gt;
3.2 How about renaming shutdownEmptyFetcherThread to shutdownIdleFetcherThreads ?&lt;/p&gt;</comment>
                            <comment id="13499954" author="junrao" created="Sun, 18 Nov 2012 23:44:02 +0000"  >&lt;p&gt;Thanks for the review. Attach patch v2.&lt;/p&gt;

&lt;p&gt;1.1 This is to handle the case that a partition is removed from the fetchMap while a fetch request is issued to the broker (since we don&apos;t hold the lock when making fetch requests). When this happens, we just need to ignore this partition.&lt;br/&gt;
1.2 Good suggestion. Fixed.&lt;/p&gt;

&lt;p&gt;2. That info message is really used to track how long it takes a broker to complete the leaderAndIsr request. From the broker&apos;s perspective, once the leader is set in a partition, the partition can serve read/write requests.&lt;/p&gt;

&lt;p&gt;3.1 Agreed that the naming is confusing. Changed it to partitionMap.&lt;br/&gt;
3.2 Done.&lt;/p&gt;</comment>
                            <comment id="13499956" author="nehanarkhede" created="Sun, 18 Nov 2012 23:52:46 +0000"  >&lt;p&gt;Minor nitpick before you checkin v2 - Please could you rename shutdownIdleFetcherThread to shutdownIdlFetcherThreads since typically there are multiple fetcher threads &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;+1 on v2&lt;/p&gt;</comment>
                            <comment id="13500030" author="junrao" created="Mon, 19 Nov 2012 05:52:48 +0000"  >&lt;p&gt;Thanks for the review. Changed the method name and committed to 0.8.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12554099" name="kafka-612-v2.patch" size="10866" author="junrao" created="Sun, 18 Nov 2012 23:44:02 +0000"/>
                            <attachment id="12553566" name="kafka-612.patch" size="9103" author="junrao" created="Wed, 14 Nov 2012 21:42:36 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>257873</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 1 week, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0kkkn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>118150</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>