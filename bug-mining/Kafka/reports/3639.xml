<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:37:09 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-16052] OOM in Kafka test suite</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-16052</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;&lt;b&gt;Problem&lt;/b&gt;&lt;br/&gt;
Our test suite is failing with frequent OOM. Discussion in the mailing list is here: &lt;a href=&quot;https://lists.apache.org/thread/d5js0xpsrsvhgjb10mbzo9cwsy8087x4&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://lists.apache.org/thread/d5js0xpsrsvhgjb10mbzo9cwsy8087x4&lt;/a&gt;&#160;&lt;/p&gt;


&lt;p&gt;&lt;b&gt;Setup&lt;/b&gt;&lt;br/&gt;
To find the source of leaks, I ran the :core:test build target with a single thread (see below on how to do it) and attached a profiler to it. This Jira tracks the list of action items identified from the analysis.&lt;/p&gt;

&lt;p&gt;How to run tests using a single thread:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
diff --git a/build.gradle b/build.gradle
index f7abbf4f0b..81df03f1ee 100644
--- a/build.gradle
+++ b/build.gradle
@@ -74,9 +74,8 @@ ext {
&#160; &#160; &#160; &#160;&lt;span class=&quot;code-quote&quot;&gt;&quot;--add-opens=java.security.jgss/sun.security.krb5=ALL-UNNAMED&quot;&lt;/span&gt;
&#160; &#160; &#160;)- &#160;maxTestForks = project.hasProperty(&lt;span class=&quot;code-quote&quot;&gt;&apos;maxParallelForks&apos;&lt;/span&gt;) ? maxParallelForks.toInteger() : &lt;span class=&quot;code-object&quot;&gt;Runtime&lt;/span&gt;.runtime.availableProcessors()
- &#160;maxScalacThreads = project.hasProperty(&lt;span class=&quot;code-quote&quot;&gt;&apos;maxScalacThreads&apos;&lt;/span&gt;) ? maxScalacThreads.toInteger() :
- &#160; &#160; &#160;&lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.min(&lt;span class=&quot;code-object&quot;&gt;Runtime&lt;/span&gt;.runtime.availableProcessors(), 8)
+ &#160;maxTestForks = 1
+ &#160;maxScalacThreads = 1
&#160; &#160;userIgnoreFailures = project.hasProperty(&lt;span class=&quot;code-quote&quot;&gt;&apos;ignoreFailures&apos;&lt;/span&gt;) ? ignoreFailures : &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&#160; &#160;userMaxTestRetries = project.hasProperty(&lt;span class=&quot;code-quote&quot;&gt;&apos;maxTestRetries&apos;&lt;/span&gt;) ? maxTestRetries.toInteger() : 0
diff --git a/gradle.properties b/gradle.properties
index 4880248cac..ee4b6e3bc1 100644
--- a/gradle.properties
+++ b/gradle.properties
@@ -30,4 +30,4 @@ scalaVersion=2.13.12
&#160;swaggerVersion=2.2.8
&#160;task=build
&#160;org.gradle.jvmargs=-Xmx2g -Xss4m -XX:+UseParallelGC
-org.gradle.parallel=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
+org.gradle.parallel=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt; &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;b&gt;Result of experiment&lt;/b&gt;&lt;br/&gt;
This is how the heap memory utilized looks like, starting from tens of MB to ending with 1.5GB (with spikes of 2GB) of heap being used as the test executes. Note that the total number of threads also increases but it does not correlate with sharp increase in heap memory usage. The heap dump is available at &lt;a href=&quot;https://www.dropbox.com/scl/fi/nwtgc6ir6830xlfy9z9cu/GradleWorkerMain_10311_27_12_2023_13_37_08.hprof.zip?rlkey=ozbdgh5vih4rcynnxbatzk7ln&amp;amp;dl=0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://www.dropbox.com/scl/fi/nwtgc6ir6830xlfy9z9cu/GradleWorkerMain_10311_27_12_2023_13_37_08.hprof.zip?rlkey=ozbdgh5vih4rcynnxbatzk7ln&amp;amp;dl=0&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13065623/13065623_Screenshot+2023-12-27+at+14.22.21.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13563023">KAFKA-16052</key>
            <summary>OOM in Kafka test suite</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="divijvaidya">Divij Vaidya</assignee>
                                    <reporter username="divijvaidya">Divij Vaidya</reporter>
                        <labels>
                    </labels>
                <created>Wed, 27 Dec 2023 12:42:58 +0000</created>
                <updated>Wed, 16 Oct 2024 17:25:17 +0000</updated>
                            <resolved>Mon, 17 Jun 2024 00:16:52 +0000</resolved>
                                    <version>3.7.0</version>
                                    <fixVersion>3.8.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                                                            <comments>
                            <comment id="17800764" author="divijvaidya" created="Wed, 27 Dec 2023 13:06:12 +0000"  >&lt;p&gt;The tests are still running but as of now the root cause looks like a leak caused by mockito since it occupies ~950MB of heap.&lt;/p&gt;



&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13065622/13065622_Screenshot+2023-12-27+at+14.04.52.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="17800770" author="divijvaidya" created="Wed, 27 Dec 2023 13:46:01 +0000"  >&lt;p&gt;We have a org.mockito.internal.verification.DefaultRegisteredInvocations class using 590MB of heap. This class maintains a map of all mocks with their associated invocations. If we have a mock that is called many many times, the map will be very large to track all invocations and hence, cause this heap utilizations.&#160;&lt;/p&gt;

&lt;p&gt;Now we need to find which test has this mock that has around 767K invocations on a mock and that is our culprit.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13065625/13065625_Screenshot+2023-12-27+at+14.45.20.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="17800772" author="divijvaidya" created="Wed, 27 Dec 2023 13:50:35 +0000"  >&lt;p&gt;&lt;del&gt;Let&apos;s try to find the test which was running at the time of this heap dump capture by analysing the rest of the objects reachable by GC at this time.&lt;/del&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Scratch that. It wouldn&apos;t work since the leaks could have occurred in previous tests and not necessarily in the ones that are running at the time of heap dump.&#160;&lt;/p&gt;

&lt;p&gt;I need to open the heap dump with a better tool than Intellij&apos;s profiler and see if I can explore the mocks to see what the mock is and what invocations is it storing.&lt;/p&gt;</comment>
                            <comment id="17800788" author="divijvaidya" created="Wed, 27 Dec 2023 14:31:31 +0000"  >&lt;p&gt;ok, I might have found the offending test. It is probably&#160;GroupCoordinatorConcurrencyTest.&lt;/p&gt;

&lt;p&gt;This test alone uses 400MB of heap and the heap dump has a pattern consistent with the leaked objects we found above.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13065626/13065626_Screenshot+2023-12-27+at+15.31.09.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="17800797" author="divijvaidya" created="Wed, 27 Dec 2023 14:53:17 +0000"  >&lt;p&gt;I am now running a single threaded test execution after disabling&#160;GroupCoordinatorConcurrencyTest. Once we have verified that this is the culprit test, we can try to find a fix.&lt;/p&gt;</comment>
                            <comment id="17800828" author="divijvaidya" created="Wed, 27 Dec 2023 16:45:47 +0000"  >&lt;p&gt;Digging into the new heap dump after disabling GroupCoordinatorConcurrencyTest, I found another culprit. The sister test of GroupCoordinatorConcurrencyTest i.e.&#160;&lt;br/&gt;
TransactionCoordinatorConcurrencyTest.&#160;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13065627/13065627_Screenshot+2023-12-27+at+17.44.09.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="17800851" author="jolshan" created="Wed, 27 Dec 2023 18:55:18 +0000"  >&lt;p&gt;Thanks Divij for the digging. These tests share the common AbstractCoordinatorCouncurrencyTest. I wonder if the mock in question is there.&lt;/p&gt;

&lt;p&gt;We do mock replica manager, but in an interesting way&lt;/p&gt;


&lt;p&gt;replicaManager = mock(classOf&lt;span class=&quot;error&quot;&gt;&amp;#91;TestReplicaManager&amp;#93;&lt;/span&gt;, withSettings().defaultAnswer(CALLS_REAL_METHODS))&lt;/p&gt;</comment>
                            <comment id="17800852" author="jolshan" created="Wed, 27 Dec 2023 18:56:06 +0000"  >&lt;p&gt;I can also take a look at the heap dump if that is helpful.&lt;/p&gt;</comment>
                            <comment id="17800853" author="divijvaidya" created="Wed, 27 Dec 2023 19:08:17 +0000"  >&lt;p&gt;Yes Justine, that is my current line of thought as well. The mock of TestReplicaManager is having many invocations. I am now trying to directly use TestReplicaManager instead of the mock in the test. I think that we are mocking it just to avoid calling the constructor of replicamanager (so that we can use our default purgatory). If you can get that working, it would be awesome!&lt;/p&gt;</comment>
                            <comment id="17800855" author="jolshan" created="Wed, 27 Dec 2023 19:14:53 +0000"  >&lt;p&gt;Doing a quick scan at the InterceptedInvocations, I see many with the method numDelayedDelete which is a method on DelayedOperations. I will look into that avenue for a bit.&lt;/p&gt;</comment>
                            <comment id="17800865" author="jolshan" created="Wed, 27 Dec 2023 19:56:19 +0000"  >&lt;p&gt;Taking a look at removing the mock as well. There are quite a few parts of the initialization that we don&apos;t need to do for the tests.&#160;&lt;/p&gt;

&lt;p&gt;For example:&lt;/p&gt;


&lt;p&gt;val replicaFetcherManager = createReplicaFetcherManager(metrics, time, threadNamePrefix, quotaManagers.follower)&lt;br/&gt;
private&lt;span class=&quot;error&quot;&gt;&amp;#91;server&amp;#93;&lt;/span&gt; val replicaAlterLogDirsManager = createReplicaAlterLogDirsManager(quotaManagers.alterLogDirs, brokerTopicStats)&lt;/p&gt;

&lt;p&gt;We can do these if necessary, but it also starts other threads that we probably don&apos;t want running for the test.&lt;/p&gt;</comment>
                            <comment id="17800874" author="ijuma" created="Wed, 27 Dec 2023 20:36:32 +0000"  >&lt;p&gt;Have you tried clearing the mocks during tearDown?&lt;/p&gt;</comment>
                            <comment id="17800875" author="ijuma" created="Wed, 27 Dec 2023 20:37:55 +0000"  >&lt;p&gt;It can be done via Mockito.framework().clearInlineMocks().&lt;/p&gt;</comment>
                            <comment id="17800877" author="jolshan" created="Wed, 27 Dec 2023 20:42:36 +0000"  >&lt;p&gt;Ah &#8211; good point &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ijuma&quot; class=&quot;user-hover&quot; rel=&quot;ijuma&quot;&gt;ijuma&lt;/a&gt;. I will look into that as well.&lt;/p&gt;</comment>
                            <comment id="17800880" author="jolshan" created="Wed, 27 Dec 2023 20:49:13 +0000"  >&lt;p&gt;There are only four tests in the group coordinator suite, so it is surprising to hit OOM on those. But trying the clearInlineMocks should be a low hanging fruit that could help a bit while we figure out why the mocks are causing so many issues in the first place.&lt;/p&gt;

&lt;p&gt;I have a draft PR with the change and we can look at how the builds do: &lt;a href=&quot;https://github.com/apache/kafka/pull/15081&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/15081&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17800892" author="divijvaidya" created="Wed, 27 Dec 2023 23:17:26 +0000"  >&lt;p&gt;I don&apos;t think that clearing the mocks is helping here. I ran &quot;./gradlew :core:test --tests GroupCoordinatorConcurrencyTest --rerun&quot; and took a heap dump. The test spikes to take 778MB heap at peak. Here&apos;s the heap dump &lt;a href=&quot;https://www.dropbox.com/scl/fi/dttxe7e8mzifaaw57er1d/GradleWorkerMain_79331_28_12_2023_00_10_47.hprof.zip?rlkey=cg6w2e26vzprbrz92gcdhwfkd&amp;amp;dl=0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://www.dropbox.com/scl/fi/dttxe7e8mzifaaw57er1d/GradleWorkerMain_79331_28_12_2023_00_10_47.hprof.zip?rlkey=cg6w2e26vzprbrz92gcdhwfkd&amp;amp;dl=0&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;For reference, this is how I was clearing the mocks&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@@ -89,11 +91,12 @@ &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;GroupCoordinatorConcurrencyTest &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; AbstractCoordinatorConcurrencyTest
&#160; &#160;@AfterEach
&#160; &#160;override def tearDown(): Unit = {
&#160; &#160; &#160;&lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
- &#160; &#160; &#160;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (groupCoordinator != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
- &#160; &#160; &#160; &#160;groupCoordinator.shutdown()
+ &#160; &#160; &#160;CoreUtils.swallow(groupCoordinator.shutdown(), &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;)
+ &#160; &#160; &#160;CoreUtils.swallow(metrics.close(), &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;)
&#160; &#160; &#160;} &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
&#160; &#160; &#160; &#160;&lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;.tearDown()
&#160; &#160; &#160;}
+ &#160; &#160;Mockito.framework().clearInlineMocks()
&#160; &#160;} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13065633/13065633_Screenshot+2023-12-28+at+00.13.06.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="17800893" author="divijvaidya" created="Wed, 27 Dec 2023 23:22:12 +0000"  >&lt;p&gt;Also, when we look at what is inside the InterceptedInvocation objects, it hints at &quot;&lt;br/&gt;
groupCoordinator.handleTxnCommitOffsets(member.group.groupId, &quot;dummy-txn-id&quot;, producerId, producerEpoch,&lt;br/&gt;
JoinGroupRequest.UNKNOWN_MEMBER_ID, Option.empty, JoinGroupRequest.UNKNOWN_GENERATION_ID,&lt;br/&gt;
offsets, callbackWithTxnCompletion)&quot; line. Note that there are ~700L invocations in mockito for this.&lt;/p&gt;

&lt;p&gt;(You can also play with the heap dump I linked above to find this information)&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13065634/13065634_Screenshot+2023-12-28+at+00.18.56.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="17800902" author="jolshan" created="Thu, 28 Dec 2023 01:56:05 +0000"  >&lt;p&gt;Thanks Divij. This might be a few things then since the handleTxnCommitOffsets is not in the TransactionCoordinator test.&#160;&lt;br/&gt;
I will look into this though.&#160;&lt;/p&gt;

&lt;p&gt;I believe the OOMs started before I changed the transactional offset commit flow, but perhaps it is still related to something else I changed.&lt;/p&gt;</comment>
                            <comment id="17800903" author="jolshan" created="Thu, 28 Dec 2023 02:05:28 +0000"  >&lt;p&gt;It looks like the method that is actually being called is &#8211;&#160;&lt;br/&gt;
replicaManager.maybeStartTransactionVerificationForPartition.&lt;/p&gt;

&lt;p&gt;This is overridden in TestReplicaManager to just do the callback. I&apos;m not sure why it is storing all of these though. I will look into that next.&lt;/p&gt;</comment>
                            <comment id="17800909" author="jolshan" created="Thu, 28 Dec 2023 02:28:47 +0000"  >&lt;p&gt;So I realized that every test runs thousands of operations that call not only replicaManager.maybeStartTransactionVerificationForPartition but also other replicaManager methods like replicaManager appendForGroup thousands of times.&#160;&lt;/p&gt;

&lt;p&gt;I&apos;m trying to figure out why this is causing regressions now.&#160;&lt;/p&gt;

&lt;p&gt;For the&#160;testConcurrentRandomSequence test, we call these methods approximately 35,000 times.&lt;/p&gt;

&lt;p&gt;We do 10 random sequences and 10 ordered sequences. Each sequence consists of 7 operations for the 250 group members (nthreads(5) * 5 * 10).&#160;&lt;br/&gt;
So 20 * 7 * 250 is 35,000. Not sure if we need this many operations!&lt;/p&gt;</comment>
                            <comment id="17800911" author="jolshan" created="Thu, 28 Dec 2023 02:48:24 +0000"  >&lt;p&gt;What do we think about lowering the number of sequences we test (say from 10 to 3 or 4) and the number of groups from 10 to 5 or so.&#160;&lt;br/&gt;
That would lower the number of operations from 35,000 to 7,000. This is used in both the GroupCoordinator and the TransactionCoordinator test too. (The transaction coordinator doesn&apos;t have groups, but transactions). We could also look at some of the other tests in the suite. (To be honest, I never really understood how this suite was actually testing concurrency with all the mocks and redefined operations)&lt;/p&gt;

&lt;p&gt;We probably need to figure out why we store all of these mock invocations since we are just executing the methods anyway. But I think lowering the number of operations should give us some breathing room for the OOMs.&#160;&lt;/p&gt;

&lt;p&gt;What do you think &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=divijvaidya&quot; class=&quot;user-hover&quot; rel=&quot;divijvaidya&quot;&gt;divijvaidya&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ijuma&quot; class=&quot;user-hover&quot; rel=&quot;ijuma&quot;&gt;ijuma&lt;/a&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17800942" author="showuon" created="Thu, 28 Dec 2023 08:45:04 +0000"  >&lt;p&gt;I&apos;m trying to fix it by creating a &quot;real&quot; replicaManager, instead of a mock one. And I can see the heap size reduce a lot. Here&apos;s the patch: &lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13065644/newRM.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/13065644/newRM.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The only problem is because this is a real dummy replicaManager, it&apos;ll output many error while testing. I&apos;m checking on it.&lt;/p&gt;</comment>
                            <comment id="17800948" author="showuon" created="Thu, 28 Dec 2023 09:00:50 +0000"  >&lt;p&gt;OK, I&apos;ve checked the output before my change, there are also many errors output. So it looks expected. I&apos;ve created a PR for it: &lt;a href=&quot;https://github.com/apache/kafka/pull/15083&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/15083&lt;/a&gt;. &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=divijvaidya&quot; class=&quot;user-hover&quot; rel=&quot;divijvaidya&quot;&gt;divijvaidya&lt;/a&gt;, please verify in your env again when available (after holidays). Thanks.&lt;/p&gt;</comment>
                            <comment id="17800960" author="divijvaidya" created="Thu, 28 Dec 2023 10:26:54 +0000"  >&lt;p&gt;I have verified &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=showuon&quot; class=&quot;user-hover&quot; rel=&quot;showuon&quot;&gt;showuon&lt;/a&gt; that using actual ReplicaManager as in your PR fixes the heap utilization of this test. Here&apos;s a before/after picture of heap utilization with this test. I am now running a full test suite to validate the overall impact.&lt;/p&gt;

&lt;p&gt;Before:&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13065649/13065649_Screenshot+2023-12-28+at+11.26.03.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;After:&lt;br/&gt;
&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13065648/13065648_Screenshot+2023-12-28+at+11.26.09.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="17800967" author="showuon" created="Thu, 28 Dec 2023 11:27:04 +0000"  >&lt;p&gt;Great! Thanks!&lt;/p&gt;</comment>
                            <comment id="17800978" author="showuon" created="Thu, 28 Dec 2023 12:11:30 +0000"  >&lt;p&gt;Sharing my way to detect the leaking threads: &lt;a href=&quot;https://github.com/apache/kafka/pull/15052/files#diff-b8f9f9d1b191457cbdb332a3429f0ad65b50fa4cef5af8562abcfd1f177a2cfeR2441&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/15052/files#diff-b8f9f9d1b191457cbdb332a3429f0ad65b50fa4cef5af8562abcfd1f177a2cfeR2441&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;In this drafted PR, I added some &quot;expected thread names&quot; list (white list), and try to find threads that are not expected. The verification will be checked on each time `QuorumTestHarness` run (beforeAll/afterAll). The CI result &lt;a href=&quot;https://ci-builds.apache.org/job/Kafka/job/kafka-pr/job/PR-15052/5&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; shows the unexpected threads detected. Usually, I have to trace back to earlier test cases to find out which one leaked the thread. But that, at least, give us some clue.&lt;/p&gt;</comment>
                            <comment id="17801029" author="jolshan" created="Thu, 28 Dec 2023 16:54:11 +0000"  >&lt;p&gt;Hey Luke &#8211; thanks for your help with the non-mocked replica manager. Did you mean to leave this comment about detecting leaking thread on a different jira? I think it is unrelated to the mock replica manager right?&lt;/p&gt;

&lt;p&gt;I will take a look at your and Divij&apos;s PRs to fix the replica manager.&lt;/p&gt;</comment>
                            <comment id="17801034" author="divijvaidya" created="Thu, 28 Dec 2023 17:57:47 +0000"  >&lt;p&gt;The fix in the PR for these improved but did not completely fix the OOM.&lt;/p&gt;

&lt;p&gt;Here&apos;s the status now. The heap dump shows Mockito invocations of different types such a place where we are mocking FileRrcords with each invocation consuming 5MB of heap. We will end up fixing many tests to fix this. But I am curious as to why Mockito is not cleaning up it&apos;s invocations? Why is it a &quot;leak&quot; after the test has finished executing? Should we try to upgrade mockito version and see if that fixes things?&lt;/p&gt;

&lt;p&gt;Another second source of leak is ApplicationShutdownHooks which starts when running EndToEndAuthorization tests. It has something to do with KDC server since we also have DefaultDirectoryService retained objects on the heap. I will start a child Jira to look into this.&lt;/p&gt;

&lt;p&gt;The other part is leaked threads. You will notice on the picture below that leaked suddenly spike (not correlated to heap memory increase) by hundreds. A thread dump suggests large number of ExpirationReaper-AlterACL threads. I am tracking that here: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-16059&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-16059&lt;/a&gt;&lt;br/&gt;
&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13065657/13065657_Screenshot+2023-12-28+at+18.44.19.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="17801153" author="divijvaidya" created="Fri, 29 Dec 2023 11:59:35 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jolshan&quot; class=&quot;user-hover&quot; rel=&quot;jolshan&quot;&gt;jolshan&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=showuon&quot; class=&quot;user-hover&quot; rel=&quot;showuon&quot;&gt;showuon&lt;/a&gt; - I found another culprit - &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-16063&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-16063&lt;/a&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17805163" author="divijvaidya" created="Wed, 10 Jan 2024 14:27:27 +0000"  >&lt;p&gt;On current trunk, the heap &quot;at max&quot; goes to 1200MB compared to 1800MB provided in the description. I have also not seen any OOM for CI for quite a while now based on &lt;a href=&quot;https://ge.apache.org/scans/failures?failures.failureClassification=all_failures&amp;amp;failures.failureMessage=Execution%20failed%20for%20task%20%27:tools:test%27.%0A%3E%20Process%20%27Gradle%20Test%20Executor%2096%27%20finished%20with%20non-zero%20exit%20value%201%0A%20%20This%20problem%20might%20be%20caused%20by%20incorrect%20test%20process%20configuration.%0A%20%20For%20more%20on%20test%20execution%2C%20please%20refer%20to%20https:%2F%2Fdocs.gradle.org%2F8.5%2Fuserguide%2Fjava_testing.html%23sec:test_execution%20in%20the%20Gradle%20documentation.&amp;amp;search.rootProjectNames=kafka&amp;amp;search.tags=trunk&amp;amp;search.timeZoneId=Europe%2FBerlin&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ge.apache.org/scans/failures?failures.failureClassification=all_failures&amp;amp;failures.failureMessage=Execution%20failed%20for%20task%20%27:tools:test%27.%0A%3E%20Process%20%27Gradle%20Test%20Executor%2096%27%20finished%20with%20non-zero%20exit%20value%201%0A%20%20This%20problem%20might%20be%20caused%20by%20incorrect%20test%20process%20configuration.%0A%20%20For%20more%20on%20test%20execution%2C%20please%20refer%20to%20https:%2F%2Fdocs.gradle.org%2F8.5%2Fuserguide%2Fjava_testing.html%23sec:test_execution%20in%20the%20Gradle%20documentation.&amp;amp;search.rootProjectNames=kafka&amp;amp;search.tags=trunk&amp;amp;search.timeZoneId=Europe%2FBerlin&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;Also, notice the drastic decrease in number of threads in the test (right graph) due to fixes made here.&lt;/p&gt;

&lt;p&gt;At this stage, I am resolving this Jira based on the above. We have some future looking tasks at &lt;a href=&quot;https://github.com/apache/kafka/pull/15101&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/15101&lt;/a&gt; to fix this permanently.&#160;&lt;/p&gt;


&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13065874/13065874_Screenshot+2024-01-10+at+14.59.47.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310460">
                    <name>Child-Issue</name>
                                            <outwardlinks description="is a parent of">
                                        <issuelink>
            <issuekey id="13563158">KAFKA-16064</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13065622" name="Screenshot 2023-12-27 at 14.04.52.png" size="368329" author="divijvaidya" created="Wed, 27 Dec 2023 13:06:07 +0000"/>
                            <attachment id="13065623" name="Screenshot 2023-12-27 at 14.22.21.png" size="563744" author="divijvaidya" created="Wed, 27 Dec 2023 13:23:22 +0000"/>
                            <attachment id="13065625" name="Screenshot 2023-12-27 at 14.45.20.png" size="172886" author="divijvaidya" created="Wed, 27 Dec 2023 13:45:42 +0000"/>
                            <attachment id="13065626" name="Screenshot 2023-12-27 at 15.31.09.png" size="406727" author="divijvaidya" created="Wed, 27 Dec 2023 14:31:28 +0000"/>
                            <attachment id="13065627" name="Screenshot 2023-12-27 at 17.44.09.png" size="327697" author="divijvaidya" created="Wed, 27 Dec 2023 16:45:19 +0000"/>
                            <attachment id="13065633" name="Screenshot 2023-12-28 at 00.13.06.png" size="60126" author="divijvaidya" created="Wed, 27 Dec 2023 23:13:27 +0000"/>
                            <attachment id="13065634" name="Screenshot 2023-12-28 at 00.18.56.png" size="148461" author="divijvaidya" created="Wed, 27 Dec 2023 23:20:06 +0000"/>
                            <attachment id="13065649" name="Screenshot 2023-12-28 at 11.26.03.png" size="58028" author="divijvaidya" created="Thu, 28 Dec 2023 10:26:43 +0000"/>
                            <attachment id="13065648" name="Screenshot 2023-12-28 at 11.26.09.png" size="56669" author="divijvaidya" created="Thu, 28 Dec 2023 10:26:25 +0000"/>
                            <attachment id="13065657" name="Screenshot 2023-12-28 at 18.44.19.png" size="137764" author="divijvaidya" created="Thu, 28 Dec 2023 17:45:35 +0000"/>
                            <attachment id="13065874" name="Screenshot 2024-01-10 at 14.59.47.png" size="469525" author="divijvaidya" created="Wed, 10 Jan 2024 14:20:26 +0000"/>
                            <attachment id="13065644" name="newRM.patch" size="2695" author="showuon" created="Thu, 28 Dec 2023 08:43:15 +0000"/>
                    </attachments>
                <subtasks>
                            <subtask id="13563024">KAFKA-16053</subtask>
                            <subtask id="13563102">KAFKA-16058</subtask>
                            <subtask id="13563122">KAFKA-16059</subtask>
                            <subtask id="13563154">KAFKA-16062</subtask>
                            <subtask id="13563155">KAFKA-16063</subtask>
                            <subtask id="13563159">KAFKA-16065</subtask>
                            <subtask id="13563348">KAFKA-16074</subtask>
                            <subtask id="13563543">KAFKA-16079</subtask>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>12.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 43 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1mgqg:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>