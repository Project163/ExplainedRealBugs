<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:53:26 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-3378] Client blocks forever if SocketChannel connects instantly</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-3378</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Observed that some consumers were blocked in Fetcher.listOffset() when starting many dozens of consumer threads at the same time.&lt;/p&gt;

&lt;p&gt;Selector.connect(...) calls SocketChannel.connect() in non-blocking mode and assumes that false is always returned and that the channel will be in the Selector&apos;s readyKeys once the connection is ready for connect completion due to the OP_CONNECT interest op.&lt;/p&gt;

&lt;p&gt;When connect() returns true the channel is fully connected connected and will not be included in readyKeys since only OP_CONNECT is set.&lt;/p&gt;

&lt;p&gt;I implemented a fix which handles the case when connect(...) returns true and verified that I no longer see stuck consumers. A git pull request will be forthcoming.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12948893">KAFKA-3378</key>
            <summary>Client blocks forever if SocketChannel connects instantly</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="llowrey@gmail.com">Larkin Lowrey</assignee>
                                    <reporter username="llowrey@gmail.com">Larkin Lowrey</reporter>
                        <labels>
                    </labels>
                <created>Thu, 10 Mar 2016 19:27:02 +0000</created>
                <updated>Fri, 22 Dec 2017 01:36:02 +0000</updated>
                            <resolved>Mon, 21 Mar 2016 05:47:23 +0000</resolved>
                                    <version>0.9.0.1</version>
                                    <fixVersion>0.10.0.0</fixVersion>
                                    <component>clients</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15189815" author="githubbot" created="Thu, 10 Mar 2016 19:31:41 +0000"  >&lt;p&gt;GitHub user llowrey opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/1044&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/1044&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3378&quot; title=&quot;Client blocks forever if SocketChannel connects instantly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3378&quot;&gt;&lt;del&gt;KAFKA-3378&lt;/del&gt;&lt;/a&gt; Fix for instantly connecting SocketChannels.&lt;/p&gt;

&lt;p&gt;    Added OP_WRITE interestOp when channel connects instantly (socketChannel.connect(address) returns true... even in non-blocking mode). This allows the SocketChannel to be ready on the next call to select(). The poll method was modified to detect this case (OP_CONNECT &amp;amp;&amp;amp; OP_WRITE while not key.isConnectable()) to complete the connection setup as if the channel had not connected instantly.&lt;/p&gt;


&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/llowrey/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/llowrey/kafka&lt;/a&gt; 0.9.0&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/1044.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/1044.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #1044&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 79f96114e0cc8a2fdadfa6738cf4c666a8c42e96&lt;br/&gt;
Author: Larkin Lowrey &amp;lt;llowrey@gmail.com&amp;gt;&lt;br/&gt;
Date:   2016-03-10T18:16:06Z&lt;/p&gt;

&lt;p&gt;    Fix for instantly connecting SocketChannels.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15196543" author="junrao" created="Wed, 16 Mar 2016 00:29:08 +0000"  >&lt;p&gt;Thanks for reporting this. Marking this as a blocker for 0.10.0 since it can have a big impact to the client.&lt;/p&gt;</comment>
                            <comment id="15198132" author="githubbot" created="Wed, 16 Mar 2016 20:52:28 +0000"  >&lt;p&gt;GitHub user llowrey opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/1083&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/1083&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3378&quot; title=&quot;Client blocks forever if SocketChannel connects instantly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3378&quot;&gt;&lt;del&gt;KAFKA-3378&lt;/del&gt;&lt;/a&gt; Fix for instantly connecting SocketChannels (v2)&lt;/p&gt;

&lt;p&gt;    Alternative implementation&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/llowrey/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/llowrey/kafka&lt;/a&gt; 0.9.0&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/1083.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/1083.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #1083&lt;/p&gt;

&lt;hr /&gt;

&lt;hr /&gt;</comment>
                            <comment id="15198364" author="githubbot" created="Wed, 16 Mar 2016 22:54:31 +0000"  >&lt;p&gt;GitHub user llowrey opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/1085&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/1085&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3378&quot; title=&quot;Client blocks forever if SocketChannel connects instantly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3378&quot;&gt;&lt;del&gt;KAFKA-3378&lt;/del&gt;&lt;/a&gt; Fix for instantly connecting SocketChannels (v3)&lt;/p&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/llowrey/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/llowrey/kafka&lt;/a&gt; trunk&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/1085.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/1085.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #1085&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 7ebb78556118a01ce6ef35542e4cf287871b32bf&lt;br/&gt;
Author: Larkin Lowrey &amp;lt;llowrey@gmail.com&amp;gt;&lt;br/&gt;
Date:   2016-03-16T22:53:14Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3378&quot; title=&quot;Client blocks forever if SocketChannel connects instantly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3378&quot;&gt;&lt;del&gt;KAFKA-3378&lt;/del&gt;&lt;/a&gt; Fix for instantly connecting SocketChannels (v3)&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15201560" author="githubbot" created="Fri, 18 Mar 2016 14:41:34 +0000"  >&lt;p&gt;GitHub user ijuma opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/1094&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/1094&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3378&quot; title=&quot;Client blocks forever if SocketChannel connects instantly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3378&quot;&gt;&lt;del&gt;KAFKA-3378&lt;/del&gt;&lt;/a&gt;; Client blocks forever if SocketChannel connects instantly&lt;/p&gt;

&lt;p&gt;    This is a different implementation to the one in #1085 by Larkin Lowrey (@llowrey). The hard part here was actually finding the problem and all credit goes to @llowrey.&lt;/p&gt;

&lt;p&gt;    This PR also changes fixes our handling of `finishConnect` (we now check the return value).&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/ijuma/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/ijuma/kafka&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3378&quot; title=&quot;Client blocks forever if SocketChannel connects instantly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3378&quot;&gt;&lt;del&gt;KAFKA-3378&lt;/del&gt;&lt;/a&gt;-instantly-connecting-socket-channels&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/1094.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/1094.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #1094&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 4071dc454413d74309e01368924951b5530c83e3&lt;br/&gt;
Author: Ismael Juma &amp;lt;ismael@juma.me.uk&amp;gt;&lt;br/&gt;
Date:   2016-03-18T13:08:08Z&lt;/p&gt;

&lt;p&gt;    Use diamond operator&lt;/p&gt;

&lt;p&gt;commit 7783c609342e3e71a50a972d7c797e6d12fe9fd4&lt;br/&gt;
Author: Ismael Juma &amp;lt;ismael@juma.me.uk&amp;gt;&lt;br/&gt;
Date:   2016-03-18T13:15:32Z&lt;/p&gt;

&lt;p&gt;    Use `time` instead of `SystemTime`, multi-catch and javadoc clean-ups&lt;/p&gt;

&lt;p&gt;    Also removed unnecessary `if`.&lt;/p&gt;

&lt;p&gt;commit ae806c559ee68ba696cc7e7885b5569dc233a279&lt;br/&gt;
Author: Ismael Juma &amp;lt;ismael@juma.me.uk&amp;gt;&lt;br/&gt;
Date:   2016-03-18T13:35:28Z&lt;/p&gt;

&lt;p&gt;    Check the return value of `finishConnect`&lt;/p&gt;

&lt;p&gt;commit 377bc79379403770e33048cb7ee15bc8ef55ed26&lt;br/&gt;
Author: Ismael Juma &amp;lt;ismael@juma.me.uk&amp;gt;&lt;br/&gt;
Date:   2016-03-18T14:32:06Z&lt;/p&gt;

&lt;p&gt;    Handle immediately connected channels and use `finishConnect` return value&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15202342" author="gwenshap" created="Fri, 18 Mar 2016 23:13:48 +0000"  >&lt;p&gt;Issue resolved by pull request 1094&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/kafka/pull/1094&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/1094&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15202343" author="githubbot" created="Fri, 18 Mar 2016 23:14:04 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/1094&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/1094&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15203570" author="githubbot" created="Sun, 20 Mar 2016 23:43:09 +0000"  >&lt;p&gt;GitHub user ijuma opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/1103&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/1103&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3378&quot; title=&quot;Client blocks forever if SocketChannel connects instantly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3378&quot;&gt;&lt;del&gt;KAFKA-3378&lt;/del&gt;&lt;/a&gt;; Follow-up to ensure we `finishConnect` for immediately connected keys&lt;/p&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/ijuma/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/ijuma/kafka&lt;/a&gt; kafka-3378-follow-up&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/1103.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/1103.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #1103&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 91858d74752f72675a662c6c869b44e8e443b0e1&lt;br/&gt;
Author: Ismael Juma &amp;lt;ismael@juma.me.uk&amp;gt;&lt;br/&gt;
Date:   2016-03-20T23:42:32Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3378&quot; title=&quot;Client blocks forever if SocketChannel connects instantly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3378&quot;&gt;&lt;del&gt;KAFKA-3378&lt;/del&gt;&lt;/a&gt;; Follow-up to ensure we `finishConnect` for immediately connected&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15203660" author="githubbot" created="Mon, 21 Mar 2016 02:59:04 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/1103&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/1103&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15779105" author="githubbot" created="Mon, 26 Dec 2016 22:37:57 +0000"  >&lt;p&gt;Github user pono closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/1083&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/1083&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16300823" author="githubbot" created="Fri, 22 Dec 2017 01:35:57 +0000"  >&lt;p&gt;ijuma closed pull request #1044: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3378&quot; title=&quot;Client blocks forever if SocketChannel connects instantly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3378&quot;&gt;&lt;del&gt;KAFKA-3378&lt;/del&gt;&lt;/a&gt; Fix for instantly connecting SocketChannels.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/1044&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/1044&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16300824" author="githubbot" created="Fri, 22 Dec 2017 01:36:02 +0000"  >&lt;p&gt;ijuma closed pull request #1085: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3378&quot; title=&quot;Client blocks forever if SocketChannel connects instantly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3378&quot;&gt;&lt;del&gt;KAFKA-3378&lt;/del&gt;&lt;/a&gt; Fix for instantly connecting SocketChannels (v3)&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/1085&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/1085&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/clients/src/main/java/org/apache/kafka/common/network/Selector.java b/clients/src/main/java/org/apache/kafka/common/network/Selector.java&lt;br/&gt;
index 8bb33488cb2..accfa40ecd5 100644&lt;br/&gt;
&amp;#8212; a/clients/src/main/java/org/apache/kafka/common/network/Selector.java&lt;br/&gt;
+++ b/clients/src/main/java/org/apache/kafka/common/network/Selector.java&lt;br/&gt;
@@ -24,6 +24,7 @@&lt;br/&gt;
 import java.util.ArrayList;&lt;br/&gt;
 import java.util.Deque;&lt;br/&gt;
 import java.util.HashMap;&lt;br/&gt;
+import java.util.HashSet;&lt;br/&gt;
 import java.util.Iterator;&lt;br/&gt;
 import java.util.LinkedHashMap;&lt;br/&gt;
 import java.util.List;&lt;br/&gt;
@@ -84,6 +85,7 @@&lt;br/&gt;
     private final List&amp;lt;Send&amp;gt; completedSends;&lt;br/&gt;
     private final List&amp;lt;NetworkReceive&amp;gt; completedReceives;&lt;br/&gt;
     private final Map&amp;lt;KafkaChannel, Deque&amp;lt;NetworkReceive&amp;gt;&amp;gt; stagedReceives;&lt;br/&gt;
+    private final Set&amp;lt;KafkaChannel&amp;gt; connectableChannels;&lt;br/&gt;
     private final List&amp;lt;String&amp;gt; disconnected;&lt;br/&gt;
     private final List&amp;lt;String&amp;gt; connected;&lt;br/&gt;
     private final List&amp;lt;String&amp;gt; failedSends;&lt;br/&gt;
@@ -118,6 +120,7 @@ public Selector(int maxReceiveSize, long connectionMaxIdleMs, Metrics metrics, T&lt;br/&gt;
         this.completedSends = new ArrayList&amp;lt;Send&amp;gt;();&lt;br/&gt;
         this.completedReceives = new ArrayList&amp;lt;NetworkReceive&amp;gt;();&lt;br/&gt;
         this.stagedReceives = new HashMap&amp;lt;KafkaChannel, Deque&amp;lt;NetworkReceive&amp;gt;&amp;gt;();&lt;br/&gt;
+        this.connectableChannels = new HashSet&amp;lt;&amp;gt;();&lt;br/&gt;
         this.connected = new ArrayList&amp;lt;String&amp;gt;();&lt;br/&gt;
         this.disconnected = new ArrayList&amp;lt;String&amp;gt;();&lt;br/&gt;
         this.failedSends = new ArrayList&amp;lt;String&amp;gt;();&lt;br/&gt;
@@ -161,8 +164,9 @@ public void connect(String id, InetSocketAddress address, int sendBufferSize, in&lt;br/&gt;
         if (receiveBufferSize != Selectable.USE_DEFAULT_BUFFER_SIZE)&lt;br/&gt;
             socket.setReceiveBufferSize(receiveBufferSize);&lt;br/&gt;
         socket.setTcpNoDelay(true);&lt;br/&gt;
+        boolean connected;&lt;br/&gt;
         try &lt;/p&gt;
{
-            socketChannel.connect(address);
+            connected = socketChannel.connect(address);
         }
&lt;p&gt; catch (UnresolvedAddressException e) {&lt;br/&gt;
             socketChannel.close();&lt;br/&gt;
             throw new IOException(&quot;Can&apos;t resolve address: &quot; + address, e);&lt;br/&gt;
@@ -174,6 +178,14 @@ public void connect(String id, InetSocketAddress address, int sendBufferSize, in&lt;br/&gt;
         KafkaChannel channel = channelBuilder.buildChannel(id, key, maxReceiveSize);&lt;br/&gt;
         key.attach(channel);&lt;br/&gt;
         this.channels.put(id, channel);&lt;br/&gt;
+        &lt;br/&gt;
+        if (connected) {&lt;br/&gt;
+            // Since the channel is already connected OP_CONNECT won&apos;t trigger&lt;br/&gt;
+            // Add to connectableChannels so poll() will be able to handle this case&lt;br/&gt;
+            log.debug(&quot;Instantly connected to node {}&quot;, channel.id());&lt;br/&gt;
+            connectableChannels.add(channel);&lt;br/&gt;
+            key.interestOps(0);&lt;br/&gt;
+        }&lt;br/&gt;
     }&lt;/p&gt;

&lt;p&gt;     /**&lt;br/&gt;
@@ -259,7 +271,7 @@ public void poll(long timeout) throws IOException {&lt;br/&gt;
         if (timeout &amp;lt; 0)&lt;br/&gt;
             throw new IllegalArgumentException(&quot;timeout should be &amp;gt;= 0&quot;);&lt;br/&gt;
         clear();&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (hasStagedReceives())&lt;br/&gt;
+        if (hasStagedReceives() || connectableChannels.size() &amp;gt; 0)&lt;br/&gt;
             timeout = 0;&lt;br/&gt;
         /* check ready keys */&lt;br/&gt;
         long startSelect = time.nanoseconds();&lt;br/&gt;
@@ -268,6 +280,13 @@ public void poll(long timeout) throws IOException {&lt;br/&gt;
         currentTimeNanos = endSelect;&lt;br/&gt;
         this.sensors.selectTime.record(endSelect - startSelect, time.milliseconds());&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;+        // Perform setup for instantly connected channels since they won&apos;t be included in selectedKeys()&lt;br/&gt;
+        if (connectableChannels.size() &amp;gt; 0)&lt;br/&gt;
+            for (KafkaChannel channel : connectableChannels) &lt;/p&gt;
{
+                sensors.maybeRegisterConnectionMetrics(channel.id());
+                lruConnections.put(channel.id(), currentTimeNanos);
+            }
&lt;p&gt;+        &lt;br/&gt;
         if (readyKeys &amp;gt; 0) {&lt;br/&gt;
             Set&amp;lt;SelectionKey&amp;gt; keys = this.nioSelector.selectedKeys();&lt;br/&gt;
             Iterator&amp;lt;SelectionKey&amp;gt; iter = keys.iterator();&lt;br/&gt;
@@ -281,11 +300,10 @@ public void poll(long timeout) throws IOException {&lt;br/&gt;
                 lruConnections.put(channel.id(), currentTimeNanos);&lt;/p&gt;

&lt;p&gt;                 try {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;/* complete any connections that have finished their handshake */&lt;br/&gt;
+                    /* queue for completion any connections that have finished their handshake */&lt;br/&gt;
                     if (key.isConnectable()) 
{
-                        channel.finishConnect();
-                        this.connected.add(channel.id());
-                        this.sensors.connectionCreated.record();
+                        connectableChannels.add(channel);
+                        continue;
                     }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;                     /* if channel is not ready finish prepare */&lt;br/&gt;
@@ -327,6 +345,17 @@ public void poll(long timeout) throws IOException {&lt;/p&gt;

&lt;p&gt;         addToCompletedReceives();&lt;/p&gt;

&lt;p&gt;+        // finish connection setup&lt;br/&gt;
+        if (connectableChannels.size() &amp;gt; 0) {&lt;br/&gt;
+            for (KafkaChannel channel : connectableChannels) &lt;/p&gt;
{
+                channel.finishConnect();
+                this.connected.add(channel.id());
+                this.sensors.connectionCreated.record();
+                channel.prepare();
+            }
&lt;p&gt;+            connectableChannels.clear();&lt;br/&gt;
+        }&lt;br/&gt;
+        &lt;br/&gt;
         long endIo = time.nanoseconds();&lt;br/&gt;
         this.sensors.ioTime.record(endIo - endSelect, time.milliseconds());&lt;br/&gt;
         maybeCloseOldestConnection();&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 47 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2uhhr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>junrao</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>