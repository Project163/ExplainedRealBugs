<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:01:39 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-5154] Kafka Streams throws NPE during rebalance</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-5154</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;please see attached log, Kafka streams throws NullPointerException during rebalance, which is caught by our custom exception handler&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2017-04-30T17:44:17,675 INFO  kafka-coordinator-heartbeat-thread | hades org.apache.kafka.clients.consumer.internals.AbstractCoordinator.coordinatorDead() @618 - Marking the coordinator 10.210.200.144:9092 (id: 2147483644 rack: null) dead for group hades
2017-04-30T17:44:27,395 INFO  StreamThread-1 org.apache.kafka.clients.consumer.internals.AbstractCoordinator.onSuccess() @573 - Discovered coordinator 10.210.200.144:9092 (id: 2147483644 rack: null) for group hades.
2017-04-30T17:44:27,941 INFO  StreamThread-1 org.apache.kafka.clients.consumer.internals.ConsumerCoordinator.onJoinPrepare() @393 - Revoking previously assigned partitions [poseidonIncidentFeed-27, poseidonIncidentFeed-29, poseidonIncidentFeed-30, poseidonIncidentFeed-18] for group hades
2017-04-30T17:44:27,947 INFO  StreamThread-1 org.apache.kafka.clients.consumer.internals.AbstractCoordinator.sendJoinGroupRequest() @407 - (Re-)joining group hades
2017-04-30T17:44:48,468 INFO  StreamThread-1 org.apache.kafka.clients.consumer.internals.AbstractCoordinator.sendJoinGroupRequest() @407 - (Re-)joining group hades
2017-04-30T17:44:53,628 INFO  StreamThread-1 org.apache.kafka.clients.consumer.internals.AbstractCoordinator.sendJoinGroupRequest() @407 - (Re-)joining group hades
2017-04-30T17:45:09,587 INFO  StreamThread-1 org.apache.kafka.clients.consumer.internals.AbstractCoordinator.sendJoinGroupRequest() @407 - (Re-)joining group hades
2017-04-30T17:45:11,961 INFO  StreamThread-1 org.apache.kafka.clients.consumer.internals.AbstractCoordinator.onSuccess() @375 - Successfully joined group hades with generation 99
2017-04-30T17:45:13,126 INFO  StreamThread-1 org.apache.kafka.clients.consumer.internals.ConsumerCoordinator.onJoinComplete() @252 - Setting newly assigned partitions [poseidonIncidentFeed-11, poseidonIncidentFeed-27, poseidonIncidentFeed-25, poseidonIncidentFeed-29, poseidonIncidentFeed-19, poseidonIncidentFeed-18] for group hades
2017-04-30T17:46:37,254 INFO  kafka-coordinator-heartbeat-thread | hades org.apache.kafka.clients.consumer.internals.AbstractCoordinator.coordinatorDead() @618 - Marking the coordinator 10.210.200.144:9092 (id: 2147483644 rack: null) dead for group hades
2017-04-30T18:04:25,993 INFO  StreamThread-1 org.apache.kafka.clients.consumer.internals.AbstractCoordinator.onSuccess() @573 - Discovered coordinator 10.210.200.144:9092 (id: 2147483644 rack: null) for group hades.
2017-04-30T18:04:29,401 INFO  StreamThread-1 org.apache.kafka.clients.consumer.internals.ConsumerCoordinator.onJoinPrepare() @393 - Revoking previously assigned partitions [poseidonIncidentFeed-11, poseidonIncidentFeed-27, poseidonIncidentFeed-25, poseidonIncidentFeed-29, poseidonIncidentFeed-19, poseidonIncidentFeed-18] for group hades
2017-04-30T18:05:10,877 INFO  StreamThread-1 org.apache.kafka.clients.consumer.internals.AbstractCoordinator.sendJoinGroupRequest() @407 - (Re-)joining group hades
2017-05-01T00:01:55,707 INFO  StreamThread-1 org.apache.kafka.clients.consumer.internals.AbstractCoordinator.coordinatorDead() @618 - Marking the coordinator 10.210.200.144:9092 (id: 2147483644 rack: null) dead for group hades
2017-05-01T00:01:59,027 INFO  StreamThread-1 org.apache.kafka.clients.consumer.internals.AbstractCoordinator.onSuccess() @573 - Discovered coordinator 10.210.200.144:9092 (id: 2147483644 rack: null) for group hades.
2017-05-01T00:01:59,031 ERROR StreamThread-1 org.apache.kafka.streams.processor.internals.StreamThread.run() @376 - stream-thread [StreamThread-1] Streams application error during processing:
 java.lang.NullPointerException
	at org.apache.kafka.streams.processor.internals.StreamThread.runLoop(StreamThread.java:619) ~[kafka-streams-0.10.2.0.jar!/:?]
	at org.apache.kafka.streams.processor.internals.StreamThread.run(StreamThread.java:368) [kafka-streams-0.10.2.0.jar!/:?]
2017-05-01T00:02:00,038 INFO  StreamThread-1 org.apache.kafka.clients.producer.KafkaProducer.close() @689 - Closing the Kafka producer with timeoutMillis = 9223372036854775807 ms.
2017-05-01T00:02:00,949 WARN  StreamThread-1 org.apache.kafka.streams.processor.internals.StreamThread.setState() @160 - Unexpected state transition from PARTITIONS_REVOKED to NOT_RUNNING
2017-05-01T00:02:00,951 ERROR StreamThread-1 com.williamhill.trading.platform.hades.kafka.KafkaStreamManager.uncaughtException() @104 - UncaughtException in thread StreamThread-1, stopping kafka streams
 java.lang.NullPointerException
	at org.apache.kafka.streams.processor.internals.StreamThread.runLoop(StreamThread.java:619) ~[kafka-streams-0.10.2.0.jar!/:?]
	at org.apache.kafka.streams.processor.internals.StreamThread.run(StreamThread.java:368) ~[kafka-streams-0.10.2.0.jar!/:?]
2017-05-01T00:02:01,076 WARN  kafka-streams-close-thread org.apache.kafka.streams.processor.internals.StreamThread.setState() @160 - Unexpected state transition from NOT_RUNNING to PENDING_SHUTDOWN

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13068343">KAFKA-5154</key>
            <summary>Kafka Streams throws NPE during rebalance</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="damianguy">Damian Guy</assignee>
                                    <reporter username="Lukas Gemela">Lukas Gemela</reporter>
                        <labels>
                    </labels>
                <created>Tue, 2 May 2017 07:57:16 +0000</created>
                <updated>Fri, 16 Feb 2018 20:39:58 +0000</updated>
                            <resolved>Tue, 1 Aug 2017 16:03:34 +0000</resolved>
                                    <version>0.10.2.0</version>
                                    <fixVersion>0.11.0.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="15993408" author="mjsax" created="Tue, 2 May 2017 17:59:08 +0000"  >&lt;p&gt;Thanks for reporting this &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Lukas+Gemela&quot; class=&quot;user-hover&quot; rel=&quot;Lukas Gemela&quot;&gt;Lukas Gemela&lt;/a&gt;. I just double checked the code: &lt;a href=&quot;https://github.com/apache/kafka/blob/0.10.2.0/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamThread.java#L618-L619&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/0.10.2.0/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamThread.java#L618-L619&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;A &lt;tt&gt;NullPointerException&lt;/tt&gt; can only occur if &lt;tt&gt;task&lt;/tt&gt; is &lt;tt&gt;null&lt;/tt&gt; (if &lt;tt&gt;records&lt;/tt&gt; would be &lt;tt&gt;null&lt;/tt&gt; this would have happened in line 617 already). Thus, it seems, that there is no active task for a record. Not sure how this could happen atm. What triggers your rebalance? How many topics do you process and what it the number of partitions per topic?&lt;/p&gt;</comment>
                            <comment id="15993594" author="guozhang" created="Tue, 2 May 2017 19:46:28 +0000"  >&lt;p&gt;I think I saw a similar issue a days ago and was trying to dig more info with this PR but cannot reproduce it since then, just FYI: &lt;a href=&quot;https://github.com/apache/kafka/pull/2928&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2928&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15993902" author="lukas gemela" created="Tue, 2 May 2017 22:25:50 +0000"  >&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;we have a kafka streams app consuming from one topic, aggregating data on another internal topic (by using in-memory logged store) and then outputting messages to out topic.  &lt;br/&gt;
Input topic has I believe 40 partitions and therefore internal topic has 40 partitions as well.&lt;br/&gt;
We are running 8 parallel nodes of this app all the time.&lt;br/&gt;
We are using low level kafka streams API.&lt;br/&gt;
None of our code is blocking nor asynchronous.&lt;/p&gt;

&lt;p&gt;I&apos;m not really sure what caused the rebalance as all logs from all nodes are lost now, I&apos;ve just seen couple of illegalStateExceptions on another nodes, coming from kafka streams stack, but I&apos;m not even sure if they were thrown around the same time as NPE happened on this node.&lt;/p&gt;


&lt;p&gt;_______________________&lt;br/&gt;
Probably not important but might be related to the issue:&lt;br/&gt;
Please also note that in our exception handler we try to stop kafka streams app with our custom timeout and schedule a spring task to start it again. As far I can tell calling &lt;/p&gt;

&lt;p&gt;boolean isClosed = streams.close(10, TimeUnit.SECONDS)&lt;/p&gt;

&lt;p&gt;never actually succeed and we always get isClosed = false.&lt;/p&gt;

&lt;p&gt;Hope it helps!&lt;/p&gt;

&lt;p&gt;Lukas&lt;/p&gt;</comment>
                            <comment id="15993933" author="mjsax" created="Tue, 2 May 2017 22:48:51 +0000"  >&lt;p&gt;Thanks for the details. We will investigate. If would help us, if you could apply Guozhang&apos;s patch and build Streams library by yourself. So next time this happens, we get some more information. Would this work for you?&lt;/p&gt;</comment>
                            <comment id="15994475" author="lukas gemela" created="Wed, 3 May 2017 08:37:09 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mjsax&quot; class=&quot;user-hover&quot; rel=&quot;mjsax&quot;&gt;mjsax&lt;/a&gt; should not be a problem, I can make it running on one of our boxes. Not sure if it helps though, we were not able to reproduce the issue since&lt;/p&gt;</comment>
                            <comment id="15994646" author="lukas gemela" created="Wed, 3 May 2017 10:39:50 +0000"  >&lt;p&gt;Ok I&apos;ve made it running with kafka streams tag 0.10.2.0 plus Guozhang&apos;s patch, I let you know if the problem occurs again&lt;/p&gt;</comment>
                            <comment id="15995380" author="mjsax" created="Wed, 3 May 2017 18:23:55 +0000"  >&lt;p&gt;Thanks. We tried to reproduce, too. But no success yet... Let&apos;s see how quickly we can track it down.&lt;/p&gt;</comment>
                            <comment id="15996995" author="lukas gemela" created="Thu, 4 May 2017 16:10:12 +0000"  >&lt;p&gt;I wasnt able to reproduce the issue yet, but I just found in the source code the exception which we were getting on the other nodes when that NPE occured:&lt;/p&gt;

&lt;p&gt;                    throw new IllegalStateException(String.format(&quot;%s Log end offset of %s should not change while restoring: old end offset %d, current offset %d&quot;,&lt;br/&gt;
                            logPrefix, storePartition, endOffset, restoreConsumer.position(storePartition)));&lt;/p&gt;


&lt;p&gt;from ProcessorStateManager.&lt;/p&gt;

&lt;p&gt;Hope it helps!&lt;/p&gt;

&lt;p&gt;Lukas&lt;/p&gt;</comment>
                            <comment id="15997141" author="lukas gemela" created="Thu, 4 May 2017 17:53:52 +0000"  >&lt;p&gt;I just found the exception from my previous comment in one of our other apps,  looks like kafka got disconnected just before that. Logs attached (clio.txt). Not sure if this is related to NPE though&lt;/p&gt;</comment>
                            <comment id="15997655" author="mjsax" created="Fri, 5 May 2017 00:34:30 +0000"  >&lt;p&gt;With regard to the exception you mentioned, there is one known bug: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-4593&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-4593&lt;/a&gt; &amp;#8211; The exception itself occurs, if during restore process, the changelog end-offset changes. This indicates, that another task writes to the changelog topic, and thus, the task got migrated during restoration. Thus, we can stop restoration process and kill the task (as it is a zombie and does not own the partitions anymore). This could happen if restore takes long and a thread misses a rebalance. Just mentions this for clarification. As you say it&apos;s from a different application, it should not be related to the NPE. Btw: you can&apos;t attach any logs (there is just a file name but nothing more).&lt;/p&gt;</comment>
                            <comment id="16001376" author="guozhang" created="Mon, 8 May 2017 19:19:56 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mjsax&quot; class=&quot;user-hover&quot; rel=&quot;mjsax&quot;&gt;mjsax&lt;/a&gt; Not sure I understand your last sentence? I do see the `clio.txt` file attached on the JIRA?&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Lukas+Gemela&quot; class=&quot;user-hover&quot; rel=&quot;Lukas Gemela&quot;&gt;Lukas Gemela&lt;/a&gt; The logs you attached does not contain the NPE mentioned in the description, and as Matthias said, the `IllegalStateException` would likely be a different thing.&lt;/p&gt;</comment>
                            <comment id="16001459" author="mjsax" created="Mon, 8 May 2017 20:18:36 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; Ah thanks. I was confused as the comment itself only contains &lt;tt&gt;(clio.txt)&lt;/tt&gt; &amp;#8211; I was expecting a link there and did miss the link above.&lt;/p&gt;</comment>
                            <comment id="16001501" author="lukas gemela" created="Mon, 8 May 2017 20:49:51 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; Yes I know log does not contain NPE, I just wanted to point out we&apos;ve seen IllegalStateExceptions on the other nodes around that time when we saw the NPE. Thanks for the jira for IllegalStateExceptions thing that we can trace it internally. &lt;/p&gt;</comment>
                            <comment id="16002457" author="lukas gemela" created="Tue, 9 May 2017 10:35:36 +0000"  >&lt;p&gt;today we reproduced the issue on two of our nodes, hope it helps. &lt;br/&gt;
Please shout if you need more logs:&lt;/p&gt;

&lt;p&gt;Node1:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ESC[mESC[36m2017-05-09T01:58:29,608 DEBUG StreamThread-1 org.apache.kafka.clients.consumer.internals.Fetcher.sendFetches() @180 - Sending fetch for partitions [poseidonIncidentFeed-38] to broker 10.210.200.144:9092 (id: 3 rack: null)
ESC[mESC[31m2017-05-09T01:58:29,608 ERROR StreamThread-1 org.apache.kafka.streams.processor.internals.StreamThread.runLoop() @620 - Unexpected error: fetched partition poseidonIncidentFeed-38 does not belong to the active task partitions.
         tasksByPartition: {}
         assignedPartitions: [poseidonIncidentFeed-21, poseidonIncidentFeed-6, poseidonIncidentFeed-38, poseidonIncidentFeed-12]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Node2:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2017-05-08T11:06:35,339 DEBUG StreamThread-1 org.apache.kafka.clients.consumer.internals.Fetcher.sendFetches() @180 - Sending fetch for partitions [poseidonIncidentFeed-7, poseidonIncidentFeed-19] to broker 10.210.201.129:9092 (id: 2 rack: null)
2017-05-08T11:06:35,339 ERROR StreamThread-1 org.apache.kafka.streams.processor.internals.StreamThread.runLoop() @620 - Unexpected error: fetched partition poseidonIncidentFeed-19 does not belong to the active task partitions.
	 tasksByPartition: {}
	 assignedPartitions: [poseidonIncidentFeed-7, poseidonIncidentFeed-19, poseidonIncidentFeed-17, poseidonIncidentFeed-33]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16009460" author="mjsax" created="Sat, 13 May 2017 18:41:39 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Lukas+Gemela&quot; class=&quot;user-hover&quot; rel=&quot;Lukas Gemela&quot;&gt;Lukas Gemela&lt;/a&gt; Thanks. This helps already. Before the error occurs. we do log the assignment:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;log.info(&quot;{} Updating suspended tasks to contain active tasks {}&quot;, logPrefix, activeTasks.keySet());
....
log.info(&quot;{} at state {}: new partitions {} assigned at the end of consumer rebalance.&quot;, logPrefix, state, assignment);
...
log.info(&quot;{} Creating active task {} with assigned partitions {}&quot;, logPrefix, id, partitions);
...
log.info(&quot;{} Creating new standby task {} with assigned partitions {}&quot;, logPrefix, id, partitions);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;and similar. Can you share those logs, too? Maybe you can just dump the whole log and attach the file to this Jira?&lt;/p&gt;</comment>
                            <comment id="16010143" author="lukas gemela" created="Mon, 15 May 2017 08:18:10 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mjsax&quot; class=&quot;user-hover&quot; rel=&quot;mjsax&quot;&gt;mjsax&lt;/a&gt; logs attached (clio_reduced)&lt;/p&gt;

&lt;p&gt;It&apos;s just log from two days when the exception occured, if you need to go further to history just ask (complete log has 1.5GB in total)&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;

&lt;p&gt;L.&lt;/p&gt;</comment>
                            <comment id="16011331" author="mjsax" created="Mon, 15 May 2017 21:10:26 +0000"  >&lt;p&gt;Thanks for sharing the logs. We cycle back if we need more input. We see &quot;Ignoring fetched records&quot; before the error. Seems to be related but we don&apos;t know yet.&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[m�[36m2017-05-08T22:45:40,224 DEBUG StreamThread-1 org.apache.kafka.clients.consumer.internals.Fetcher.drainRecords() @526 - Ignoring fetched records for poseidonIncidentFeed-38 at offset 21353 since the current position is 21354
�[m�[36m2017-05-08T22:45:40,224 DEBUG StreamThread-1 org.apache.kafka.clients.consumer.internals.Fetcher.sendFetches() @180 - Sending fetch for partitions [poseidonIncidentFeed-38] to broker 10.210.200.144:9092 (id: 3 rack: null)
�[m�[31m2017-05-08T22:45:40,227&#402;&#8730; ERROR StreamThread-1 org.apache.kafka.streams.processor.internals.StreamThread.runLoop() @620 - Unexpected error: fetched partition poseidonIncidentFeed-38 does not belong to the active task partitions.
	 tasksByPartition: {}
	 assignedPartitions: [poseidonIncidentFeed-21, poseidonIncidentFeed-6, poseidonIncidentFeed-38, poseidonIncidentFeed-12]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;To reason about the logs better, one more question: can it be, that partition 38 from topic &lt;tt&gt;poseidonIncidentFeed&lt;/tt&gt; does not get any data to process for some time? It seems, that there is not data, when new data is written to the partition the error hits, and after Streams somehow &quot;progresses&quot; over the burst of data, the error disappears again (as not data is fetched anymore). Could this be the case? Or do you constantly write new data to partition 38 and thus Stream constantly processes data but suddenly fails?&lt;/p&gt;

&lt;p&gt;Another follow up question: in &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5242&quot; title=&quot;add max_number _of_retries to exponential backoff strategy&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-5242&quot;&gt;&lt;del&gt;KAFKA-5242&lt;/del&gt;&lt;/a&gt; you mention that you run with a single thread. Does this imply that your whole Streams application is single threaded (ie, you use only one JVM), or do you start up multiple JVMs and scale your app like this?&lt;/p&gt;

&lt;p&gt;Last question: do you use pattern subscription by any change?&lt;/p&gt;</comment>
                            <comment id="16011562" author="guozhang" created="Tue, 16 May 2017 00:50:53 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Lukas+Gemela&quot; class=&quot;user-hover&quot; rel=&quot;Lukas Gemela&quot;&gt;Lukas Gemela&lt;/a&gt; Could you upload the full log as well? We have some clues but may need to validate that and the full log could help.&lt;/p&gt;</comment>
                            <comment id="16011594" author="guozhang" created="Tue, 16 May 2017 01:27:55 +0000"  >&lt;p&gt;Also if it is possible could you apply the latest patch from &lt;a href=&quot;https://github.com/apache/kafka/pull/2928?&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2928?&lt;/a&gt; I added a bit more logging in it.&lt;/p&gt;</comment>
                            <comment id="16011966" author="lukas gemela" created="Tue, 16 May 2017 08:20:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mjsax&quot; class=&quot;user-hover&quot; rel=&quot;mjsax&quot;&gt;mjsax&lt;/a&gt; &lt;/p&gt;

&lt;p&gt;I really can&apos;t give you any ultimate answer for question one as I don&apos;t have logs from other nodes and therefore I can&apos;t check this particular scenario, but the nature of our stream is that it indeed might happen that we don&apos;t receive a single message for particular key or partition for some time. I think the log which I shared with you is actually from test system where we might not be getting any messages for several hours.&lt;/p&gt;

&lt;p&gt;I already gave you the answer for your second question - we are running 8 parallel nodes of this app all the time, and we run single kafka streams instance on each node.&lt;/p&gt;

&lt;p&gt;We don&apos;t use  pattern subscription.&lt;/p&gt;

&lt;p&gt;Hope it helps!&lt;/p&gt;


</comment>
                            <comment id="16011982" author="lukas gemela" created="Tue, 16 May 2017 08:31:29 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; full logs attached. (clio_afa596e9b809.gz)&lt;/p&gt;

&lt;p&gt;I&apos;ll apply the patch and come back to you if the issue occur again.&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;

&lt;p&gt;L.&lt;/p&gt;</comment>
                            <comment id="16015615" author="damianguy" created="Thu, 18 May 2017 11:32:51 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Lukas+Gemela&quot; class=&quot;user-hover&quot; rel=&quot;Lukas Gemela&quot;&gt;Lukas Gemela&lt;/a&gt; Thanks for attaching the full logs.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mjsax&quot; class=&quot;user-hover&quot; rel=&quot;mjsax&quot;&gt;mjsax&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; i&apos;ve been through the logs and extracted the relevant section. It is attached as 5154_error.log for reference.&lt;br/&gt;
What it looks like is happening is the heartbeat fails as the group is rebalancing. &lt;tt&gt;StreamThread.onPartitionsRevoked&lt;/tt&gt; is called and the tasks are cleared. The thread is trying to rejoin the group, but it looks like it is the only member. There are some issues communicating with the cluster. This member becomes the Leader for the group and starts doing partition assignment. Eventually we can see that &lt;tt&gt;StreamPartitionAssignor&lt;/tt&gt; assigns all partitions to the single client:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Assigned tasks to clients as {8d510649-ddf3-41f1-86c9-c5b3c2c7a1b5=[activeTasks: ([0_0, 0_1, 0_2, 0_3, 0_4, 0_5, 0_6, 0_7, 0_8, 0_9, 0_10, 0_11, 0_12, 0_13, 0_14, 0_15, 0_16, 0_17, 0_18, 0_19, 0_20, 0_21, 0_22, 0_23, 0_24, 0_25, 0_26, 0_27, 0_28, 0_29, 0_30, 0_31, 0_32, 0_33, 0_34, 0_35, 0_36, 0_37, 0_38, 0_39]) assignedTasks: ([0_0, 0_1, 0_2, 0_3, 0_4, 0_5, 0_6, 0_7, 0_8, 0_9, 0_10, 0_11, 0_12, 0_13, 0_14, 0_15, 0_16, 0_17, 0_18, 0_19, 0_20, 0_21, 0_22, 0_23, 0_24, 0_25, 0_26, 0_27, 0_28, 0_29, 0_30, 0_31, 0_32, 0_33, 0_34, 0_35, 0_36, 0_37, 0_38, 0_39])
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The SYNC_GROUP request gets cancelled and the coordinator marked as dead, but.. we are still sending fetch requests for the partitions that were previously revoked.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[[36m2017-05-07T00:02:03,402 DEBUG StreamThread-1 org.apache.kafka.clients.consumer.internals.Fetcher.sendFetches() @180 - Sending fetch for partitions [poseidonIncidentFeed-12, poseidonIncidentFeed-21, poseidonIncidentFeed-6] to broker 10.210.200.171:9092 (id: 1 rack: null)
[[36m2017-05-07T00:02:03,402 DEBUG StreamThread-1 org.apache.kafka.clients.consumer.internals.Fetcher.sendFetches() @180 - Sending fetch for partitions [poseidonIncidentFeed-38] to broker 10.210.200.144:9092 (id: 3 rack: null)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So the &lt;tt&gt;StreamThread&lt;/tt&gt; is still running with partitions that have been revoked, hence the &lt;tt&gt;activeTasksByPartition&lt;/tt&gt; is empty causing the NPE.&lt;/p&gt;

&lt;p&gt;Now to try and figure out how this can happen. &lt;/p&gt;</comment>
                            <comment id="16024889" author="damianguy" created="Thu, 25 May 2017 15:46:03 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Lukas+Gemela&quot; class=&quot;user-hover&quot; rel=&quot;Lukas Gemela&quot;&gt;Lukas Gemela&lt;/a&gt; if it happens again can you please provide logs from the brokers and from the other Kafka Streams instances so we can get a better picture of what is happening?&lt;br/&gt;
Thanks,&lt;br/&gt;
Damian&lt;/p&gt;</comment>
                            <comment id="16031499" author="githubbot" created="Wed, 31 May 2017 16:50:12 +0000"  >&lt;p&gt;GitHub user dguy opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/3181&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3181&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5154&quot; title=&quot;Kafka Streams throws NPE during rebalance&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-5154&quot;&gt;&lt;del&gt;KAFKA-5154&lt;/del&gt;&lt;/a&gt;: Consumer fetches from revoked partitions when SyncGroup fails with disconnection &lt;span class=&quot;error&quot;&gt;&amp;#91;WIP&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;    Scenario is as follows:&lt;br/&gt;
    1. Consumer subscribes to topic t1 and begins consuming&lt;br/&gt;
    2. heartbeat fails as the group is rebalancing&lt;br/&gt;
    3. ConsumerCoordinator.onJoinGroupPrepare is called&lt;br/&gt;
       3.1 onPartitionsRevoked is called&lt;br/&gt;
    4. consumer becomes the group leader&lt;br/&gt;
    5. sends sync group request&lt;br/&gt;
    6. sync group is cancelled due to disconnection&lt;br/&gt;
    7. fetch request is sent for partitions that have previously been revoked&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/dguy/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/dguy/kafka&lt;/a&gt; kafka-5154&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/3181.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3181.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #3181&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit f84737d30acdb8b49e8e0d4e3da8720083e88354&lt;br/&gt;
Author: Damian Guy &amp;lt;damian.guy@gmail.com&amp;gt;&lt;br/&gt;
Date:   2017-05-31T16:40:50Z&lt;/p&gt;

&lt;p&gt;    just a test for discussion&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16033633" author="githubbot" created="Thu, 1 Jun 2017 20:32:56 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/3181&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3181&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16033636" author="guozhang" created="Thu, 1 Jun 2017 20:35:54 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Lukas+Gemela&quot; class=&quot;user-hover&quot; rel=&quot;Lukas Gemela&quot;&gt;Lukas Gemela&lt;/a&gt; We have found the root cause, which is is a bug in the consumer client but streams client exposed it. It has been fixed in trunk and will be included in the 0.11.0.0 RC0 releasing this week. You can also apply the patch above and try it out. Thanks again for reporting this!&lt;/p&gt;</comment>
                            <comment id="16034356" author="lukas gemela" created="Fri, 2 Jun 2017 09:12:11 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; no worries, thank you for the fix, we will update ASAP once a new version gets released&lt;/p&gt;</comment>
                            <comment id="16065124" author="miguno" created="Tue, 27 Jun 2017 16:54:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt;: I suggest we should also update this ticket if the root cause is indeed fixed (via a separate JIRA ticket) in 0.11.0.0.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310010">
                    <name>Incorporates</name>
                                            <outwardlinks description="incorporates">
                                        <issuelink>
            <issuekey id="13078950">KAFKA-5430</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13122515">KAFKA-6306</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12868734" name="5154_problem.log" size="74444" author="damianguy" created="Thu, 18 May 2017 11:20:29 +0000"/>
                            <attachment id="12866451" name="clio.txt.gz" size="129813" author="Lukas Gemela" created="Thu, 4 May 2017 17:54:21 +0000"/>
                            <attachment id="12868254" name="clio_afa596e9b809.gz" size="36252556" author="Lukas Gemela" created="Tue, 16 May 2017 08:31:29 +0000"/>
                            <attachment id="12868027" name="clio_reduced.gz" size="4527291" author="Lukas Gemela" created="Mon, 15 May 2017 08:18:40 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 21 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3ecov:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>