<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:43:22 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-19390] AbstractIndex#resize() does not release old mmap on Linux</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-19390</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Our kafka broker crashed with the following error:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[2025-03-29 09:37:03,218] ERROR Error &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; appending records to &amp;lt;topic&amp;gt;-&amp;lt;partition&amp;gt; in dir /kafka-logs/data ...
java.io.IOException: Map failed
at java.base/sun.nio.ch.FileChannelImpl.mapInternal(FileChannelImpl.java:1127)
at java.base/sun.nio.ch.FileChannelImpl.map(FileChannelImpl.java:1032)
at org.apache.kafka.storage.internals.log.AbstractIndex.createMappedBuffer(AbstractIndex.java:467)
at org.apache.kafka.storage.internals.log.AbstractIndex.createAndAssignMmap(AbstractIndex.java:105)
at org.apache.kafka.storage.internals.log.AbstractIndex.&amp;lt;init&amp;gt;(AbstractIndex.java:83)
at org.apache.kafka.storage.internals.log.TimeIndex.&amp;lt;init&amp;gt;(TimeIndex.java:65)
at org.apache.kafka.storage.internals.log.LazyIndex.loadIndex(LazyIndex.java:242)
at org.apache.kafka.storage.internals.log.LazyIndex.get(LazyIndex.java:179)
at org.apache.kafka.storage.internals.log.LogSegment.timeIndex(LogSegment.java:146)
at org.apache.kafka.storage.internals.log.LogSegment.readMaxTimestampAndOffsetSoFar(LogSegment.java:201)
at org.apache.kafka.storage.internals.log.LogSegment.maxTimestampSoFar(LogSegment.java:211)
at org.apache.kafka.storage.internals.log.LogSegment.append(LogSegment.java:262)
at kafka.log.LocalLog.append(LocalLog.scala:417)
...
Caused by: java.lang.OutOfMemoryError: Map failed
at java.base/sun.nio.ch.FileChannelImpl.map0(Native Method)
at java.base/sun.nio.ch.FileChannelImpl.mapInternal(FileChannelImpl.java:1124)
... 33 more&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;We found that kafka process hit the vm.max_map_count limit (which was set to 262144) and most of the mapped entries correspond to deleted index files.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&amp;gt; sudo cat /proc/${KAFKA_PID}/maps | grep deleted
7d8c5cc00000-7d8c5d600000 rw-s 00000000 08:11 202854769 /kafka-logs/data/topic1-22/00000000332910579773.timeindex.deleted (deleted)
7d8c5d800000-7d8c5e200000 rw-s 00000000 08:11 202854768 /kafka-logs/data/topic1-22/00000000332910579773.index.deleted (deleted)
7d8c67400000-7d8c67e00000 rw-s 00000000 08:11 202562514 /kafka-logs/data/topic2-116/00000000165968090794.timeindex.deleted (deleted)
7d8c68000000-7d8c68a00000 rw-s 00000000 08:11 202562513 /kafka-logs/data/topic2-116/00000000165968090794.index.deleted (deleted)
7d8c6d400000-7d8c6de00000 rw-s 00000000 08:11 202596518 /kafka-logs/data/topic2-356/00000000168702579081.timeindex.deleted (deleted)
7d8c6e000000-7d8c6ea00000 rw-s 00000000 08:11 202596517 /kafka-logs/data/topic2-356/00000000168702579081.index.deleted (deleted)
7d8c71c00000-7d8c72600000 rw-s 00000000 08:11 202798981 /kafka-logs/data/topic3-433/00000000116740630582.timeindex.deleted (deleted)
7d8c72800000-7d8c73200000 rw-s 00000000 08:11 202798980 /kafka-logs/data/topic3-433/00000000116740630582.index.deleted (deleted)
7d8c77c00000-7d8c78600000 rw-s 00000000 08:11 202754947 /kafka-logs/data/topic3-74/00000000118067749684.timeindex.deleted (deleted)
7d8c78800000-7d8c79200000 rw-s 00000000 08:11 202754946 /kafka-logs/data/topic3-74/00000000118067749684.index.deleted (deleted)
7d8c79400000-7d8c79e00000 rw-s 00000000 08:11 202813710 /kafka-logs/data/topic2-82/00000000162756700035.timeindex.deleted (deleted)
7d8c7a000000-7d8c7aa00000 rw-s 00000000 08:11 202813709 /kafka-logs/data/topic2-82/00000000162756700035.index.deleted (deleted)
7d8c7ac00000-7d8c7b600000 rw-s 00000000 08:11 202596526 /kafka-logs/data/topic2-355/00000000169939763750.timeindex.deleted (deleted)
7d8c7b800000-7d8c7c200000 rw-s 00000000 08:11 202596525 /kafka-logs/data/topic2-355/00000000169939763750.index.deleted (deleted)
7d8c7c400000-7d8c7ce00000 rw-s 00000000 08:11 202562498 /kafka-logs/data/topic2-295/00000000168913981903.timeindex.deleted (deleted)
7d8c7d000000-7d8c7da00000 rw-s 00000000 08:11 202562497 /kafka-logs/data/topic2-295/00000000168913981903.index.deleted (deleted)
7d8c80c00000-7d8c81600000 rw-s 00000000 08:11 202754939 /kafka-logs/data/topic3-13/00000000115588098896.timeindex.deleted (deleted)
7d8c81800000-7d8c82200000 rw-s 00000000 08:11 202754938 /kafka-logs/data/topic3-13/00000000115588098896.index.deleted (deleted)
7d8c83c00000-7d8c84600000 rw-s 00000000 08:11 202798989 /kafka-logs/data/topic3-314/00000000118254254601.timeindex.deleted (deleted)
7d8c84800000-7d8c85200000 rw-s 00000000 08:11 202798988 /kafka-logs/data/topic3-314/00000000118254254601.index.deleted (deleted)
...&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;In AbstractIndex.resize(), the old memory mapping is explicitly unmapped on windows or z/OS using safeForceUnmap(), but on Linux the unmapping step is skipped.&lt;br/&gt;
The same issue was originally reported in &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7442&quot; title=&quot;forceUnmap mmap on linux when index resize&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7442&quot;&gt;&lt;del&gt;KAFKA-7442&lt;/del&gt;&lt;/a&gt;, but the corresponding pull request was never merged.&lt;br/&gt;
We propose that resize() should call safeForceUnmap() on all platforms to prevent stale mappings from lingering.&lt;/p&gt;

&lt;p&gt;ref: &lt;a href=&quot;https://speakerdeck.com/lycorptech_jp/20250609b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://speakerdeck.com/lycorptech_jp/20250609b&lt;/a&gt;&lt;/p&gt;
&lt;h2&gt;&lt;a name=&quot;Test&quot;&gt;&lt;/a&gt;Test&lt;/h2&gt;

&lt;p&gt;We tested our patch on the following system environment and found no measurable performance regression.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Environment&lt;/b&gt;&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Kafka: 3.8.1&lt;/li&gt;
	&lt;li&gt;Java: OpenJDK 17&lt;/li&gt;
	&lt;li&gt;OS: Rocky Linux 9&lt;/li&gt;
	&lt;li&gt;Broker: 10 brokers for original, 10 brokers for patched
	&lt;ul&gt;
		&lt;li&gt;CPU: Intel Xeon Silver 4310 (2 sockets)&lt;/li&gt;
		&lt;li&gt;Memory: 250 GB&lt;/li&gt;
		&lt;li&gt;Disk: HDD&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&lt;b&gt;Workloads&lt;/b&gt;&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Peak throughput per broker:
	&lt;ul&gt;
		&lt;li&gt;6K req/s&lt;/li&gt;
		&lt;li&gt;85.2 MB/s&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;h3&gt;&lt;a name=&quot;Idlepercentageofrequesthandlerandnetworkprocessorthreads&quot;&gt;&lt;/a&gt;Idle percentage of request handler and network processor threads&lt;/h3&gt;

&lt;p&gt;original:&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13076982/13076982_orig_request_handler.png&quot; height=&quot;222&quot; width=&quot;1000&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13076981/13076981_orig_network_processor.png&quot; height=&quot;163&quot; width=&quot;999&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;patched:&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13076986/13076986_patched_request_handler.png&quot; height=&quot;228&quot; width=&quot;997&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13076985/13076985_patched_network_processor.png&quot; height=&quot;160&quot; width=&quot;1004&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;
&lt;h3&gt;&lt;a name=&quot;Resourceload&quot;&gt;&lt;/a&gt;Resource load&lt;/h3&gt;

&lt;p&gt;original:&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13076987/13076987_orig_cpu.png&quot; height=&quot;227&quot; width=&quot;1000&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13076988/13076988_orig_disk_io.png&quot; height=&quot;168&quot; width=&quot;997&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;patched:&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13076983/13076983_patched_cpu.png&quot; height=&quot;227&quot; width=&quot;999&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13076984/13076984_patched_disk_io.png&quot; height=&quot;160&quot; width=&quot;1002&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13620394">KAFKA-19390</key>
            <summary>AbstractIndex#resize() does not release old mmap on Linux</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="masahiromori">Masahiro Mori</assignee>
                                    <reporter username="masahiromori">Masahiro Mori</reporter>
                        <labels>
                            <label>Linux</label>
                    </labels>
                <created>Mon, 9 Jun 2025 05:47:05 +0000</created>
                <updated>Mon, 6 Oct 2025 14:28:23 +0000</updated>
                            <resolved>Mon, 6 Oct 2025 14:28:23 +0000</resolved>
                                    <version>3.8.1</version>
                                    <fixVersion>3.9.2</fixVersion>
                    <fixVersion>4.2.0</fixVersion>
                    <fixVersion>4.0.2</fixVersion>
                    <fixVersion>4.1.1</fixVersion>
                                    <component>core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="18003851" author="junrao" created="Tue, 8 Jul 2025 16:16:09 +0000"  >&lt;p&gt;merged the PR to trunk&lt;/p&gt;</comment>
                            <comment id="18022020" author="chia7712" created="Tue, 23 Sep 2025 03:15:13 +0000"  >&lt;p&gt;reopen for the backport to 3.9&lt;/p&gt;</comment>
                            <comment id="18023820" author="chia7712" created="Tue, 30 Sep 2025 13:44:11 +0000"  >&lt;p&gt;trunk: &lt;a href=&quot;https://github.com/apache/kafka/commit/ea7b145860e17f9d90dd06cd983597f1c564b435&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/commit/ea7b145860e17f9d90dd06cd983597f1c564b435&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/kafka/commit/daece61a5054191cd652e502d06756e258cc2e94&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/commit/daece61a5054191cd652e502d06756e258cc2e94&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;4.1: &lt;a href=&quot;https://github.com/apache/kafka/commit/807866ca6d563892579bb93efd3e64061824c4fe&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/commit/807866ca6d563892579bb93efd3e64061824c4fe&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/kafka/commit/7f8c2a5fc948700b67879788c118d234aa5a66d8&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/commit/7f8c2a5fc948700b67879788c118d234aa5a66d8&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;4.0:&lt;/p&gt;

&lt;p&gt;3.9: &lt;a href=&quot;https://github.com/apache/kafka/commit/e37f31e8b2dcf64df63a86411f1b3e4be4d93171&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/commit/e37f31e8b2dcf64df63a86411f1b3e4be4d93171&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="18027568" author="chia7712" created="Mon, 6 Oct 2025 14:28:14 +0000"  >&lt;p&gt;4.0: &lt;a href=&quot;https://github.com/apache/kafka/commit/7e27a78f491c9df0bf41538e20e1254bd0c3dfe8&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/commit/7e27a78f491c9df0bf41538e20e1254bd0c3dfe8&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13187518">KAFKA-7442</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13076987" name="orig_cpu.png" size="88159" author="masahiromori" created="Fri, 13 Jun 2025 06:08:07 +0000"/>
                            <attachment id="13076988" name="orig_disk_io.png" size="179562" author="masahiromori" created="Fri, 13 Jun 2025 06:08:07 +0000"/>
                            <attachment id="13076981" name="orig_network_processor.png" size="70869" author="masahiromori" created="Fri, 13 Jun 2025 06:03:48 +0000"/>
                            <attachment id="13076982" name="orig_request_handler.png" size="87188" author="masahiromori" created="Fri, 13 Jun 2025 06:03:48 +0000"/>
                            <attachment id="13076983" name="patched_cpu.png" size="84248" author="masahiromori" created="Fri, 13 Jun 2025 06:06:01 +0000"/>
                            <attachment id="13076984" name="patched_disk_io.png" size="169802" author="masahiromori" created="Fri, 13 Jun 2025 06:06:02 +0000"/>
                            <attachment id="13076985" name="patched_network_processor.png" size="71745" author="masahiromori" created="Fri, 13 Jun 2025 06:06:01 +0000"/>
                            <attachment id="13076986" name="patched_request_handler.png" size="87467" author="masahiromori" created="Fri, 13 Jun 2025 06:06:01 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>8.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1w8qw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>