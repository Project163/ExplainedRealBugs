<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:21:13 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-9156] LazyTimeIndex &amp; LazyOffsetIndex may cause niobufferoverflow in concurrent state</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-9156</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/12985181/12985181_image-2019-11-07-17-42-13-852.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;this timeindex get function is not thread safe ,may cause create some timeindex.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/12985180/12985180_image-2019-11-07-17-44-05-357.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;When create timeindex not exactly one ,may cause mappedbytebuffer position to end. Then write index entry to this mmap file will cause java.nio.BufferOverflowException.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/12985179/12985179_image-2019-11-07-17-46-53-650.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13266781">KAFKA-9156</key>
            <summary>LazyTimeIndex &amp; LazyOffsetIndex may cause niobufferoverflow in concurrent state</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="amironov">Alex Mironov</assignee>
                                    <reporter username="lushilin">shilin Lu</reporter>
                        <labels>
                            <label>regression</label>
                    </labels>
                <created>Thu, 7 Nov 2019 09:48:04 +0000</created>
                <updated>Thu, 17 Nov 2022 14:02:59 +0000</updated>
                            <resolved>Mon, 2 Dec 2019 20:23:40 +0000</resolved>
                                    <version>2.3.0</version>
                    <version>2.3.1</version>
                                    <fixVersion>2.3.2</fixVersion>
                    <fixVersion>2.4.0</fixVersion>
                                    <component>core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="16969107" author="lushilin" created="Thu, 7 Nov 2019 09:50:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ijuma&quot; class=&quot;user-hover&quot; rel=&quot;ijuma&quot;&gt;ijuma&lt;/a&gt;&#160;please take a look at this issue ,thanks. our company encounter this problem in product env.&lt;/p&gt;</comment>
                            <comment id="16969720" author="guozhang" created="Fri, 8 Nov 2019 01:38:30 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lushilin&quot; class=&quot;user-hover&quot; rel=&quot;lushilin&quot;&gt;lushilin&lt;/a&gt; Thanks for reporting this ticket, and I think it is indeed an issue: although Option is immutable we are trying to reassign the var. I think we can fix it by replacing the `var Option` with a `val AtomicReference` in which we can rely on `compareAndSet` to set the values atomically.&lt;/p&gt;

&lt;p&gt;Would you like to provide a patch for it?&lt;/p&gt;</comment>
                            <comment id="16969747" author="lushilin" created="Fri, 8 Nov 2019 02:07:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt;&#160;thanks for reply. i will fix it and provide a patch for this issue at this weekend.before this, i need to learn the process of submitting a patch.&lt;/p&gt;</comment>
                            <comment id="16969820" author="lushilin" created="Fri, 8 Nov 2019 04:13:29 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt;&#160;i think only use&#160;val AtomicReference can&apos;t perform as well.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// code placeholder
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;LazyTimeIndex(@&lt;span class=&quot;code-keyword&quot;&gt;volatile&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; _file: File, baseOffset: &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;, maxIndexSize: Int = -1, writable: &lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt; = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;) {
  @&lt;span class=&quot;code-keyword&quot;&gt;volatile&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; timeIndex: Option[TimeIndex] = None

  def file: File = {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (timeIndex.isDefined)
      timeIndex.get.file
    &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;
      _file
  }

  def file_=(f: File) {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (timeIndex.isDefined)
      timeIndex.get.file = f
    &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;
      _file = f
  }

  def get: TimeIndex = {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (timeIndex.isEmpty) {
      &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (timeIndex.isEmpty) {
          timeIndex = Some(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TimeIndex(_file, baseOffset, maxIndexSize, writable))
        }
      }
    }
    timeIndex.get
  }
}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;the file will rename by&#160;def file_=(f: File) this function. so _file and timeIndex param are unsafe in multi-thread. we should keep it&#160;Multi-thread safe. i think this code can work.i use&#160;synchronized because i think this function is&#160;lightweight. if you think has some problem, i will modify it. thanks&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// code placeholder
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;LazyTimeIndex(@&lt;span class=&quot;code-keyword&quot;&gt;volatile&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; _file: File, baseOffset: &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;, maxIndexSize: Int = -1, writable: &lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt; = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;) {
  @&lt;span class=&quot;code-keyword&quot;&gt;volatile&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; timeIndex: Option[TimeIndex] = None

  def file: File = {
    &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; {
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (timeIndex.isDefined)
        timeIndex.get.file
      &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;
        _file
    }
  }

  def file_=(f: File) {
    &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; {
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (timeIndex.isDefined)
        timeIndex.get.file = f
      &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;
        _file = f
    }
  }

  def get: TimeIndex = {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (timeIndex.isEmpty) {
      &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (timeIndex.isEmpty) {
          timeIndex = Some(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TimeIndex(_file, baseOffset, maxIndexSize, writable))
        }
      }
    }
    timeIndex.get
  }
}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16984217" author="amironov" created="Thu, 28 Nov 2019 08:07:32 +0000"  >&lt;p&gt;Hey &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lushilin&quot; class=&quot;user-hover&quot; rel=&quot;lushilin&quot;&gt;lushilin&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;Thanks for identifying the issue, I believe your reasoning and research is correct, as well as the proposed solution. I agree that AtomicReference might not be enough to protect this code due to &quot;file_=&quot; setter: there could be a situation when two threads will enter &quot;if (timeIndex.isEmpty)&quot; and &quot;if (timeIndex.isDefined) else&quot; blocks, thus leading to discrepancy between &quot;_file&quot; and &quot;timeIndex.get.file&quot; references.&lt;/p&gt;

&lt;p&gt;We are running a patch for this in production for a few days now. If confirmed that it indeed fixes the issue I&apos;ll create an MR (ETA: Monday).&lt;/p&gt;</comment>
                            <comment id="16984230" author="lushilin" created="Thu, 28 Nov 2019 08:32:42 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=amironov&quot; class=&quot;user-hover&quot; rel=&quot;amironov&quot;&gt;amironov&lt;/a&gt; &lt;br/&gt;
Thanks for comment.this days i am upgrading our kafka cluster from 0.10.1 to 2.3.1,so i hava fix this issue some days ago.but this days i am busy, so i can&apos;t push a MR to kafka github.i can review your MR, if it works well,i will use it.Thank you!&lt;/p&gt;</comment>
                            <comment id="16984316" author="ijuma" created="Thu, 28 Nov 2019 10:49:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=amironov&quot; class=&quot;user-hover&quot; rel=&quot;amironov&quot;&gt;amironov&lt;/a&gt;&#160;Can you please submit the PR you have when you have the chance? We can review it in parallel to your prod testing.&lt;/p&gt;</comment>
                            <comment id="16984377" author="githubbot" created="Thu, 28 Nov 2019 12:32:29 +0000"  >&lt;p&gt;alexandrfox commented on pull request #7760: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-9156&quot; title=&quot;LazyTimeIndex &amp;amp; LazyOffsetIndex may cause niobufferoverflow in concurrent state&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-9156&quot;&gt;&lt;del&gt;KAFKA-9156&lt;/del&gt;&lt;/a&gt;: fix LazyTimeIndex &amp;amp; LazyOffsetIndex concurrency&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/7760&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/7760&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Fix of &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-9156&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-9156&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;   Race condition in `get` method of `LazyTimeIndex` and `LazyOffsetIndex` can lead to multiple OffsetIndex/TimeIndex objects being concurrently created. When that happens position of `MappedByteBuffer` in `AbstractIndex` is advanced to the last entry which in turn leads to a critical `BufferOverflowException` being thrown whenever leader or replica tries to append a record to the segment.&lt;/p&gt;

&lt;p&gt;   Moreover, `file_=` setter is seemingly also vulnerable to the race, since multiple threads can attempt to set a new file reference as well as create new Time/OffsetIndex objects at the same time. This might lead to the discrepant File references being held by e.g. LazyTimeIndex and its TimeIndex counterpart.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16984379" author="amironov" created="Thu, 28 Nov 2019 12:34:04 +0000"  >&lt;p&gt;Hey &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ijuma&quot; class=&quot;user-hover&quot; rel=&quot;ijuma&quot;&gt;ijuma&lt;/a&gt;, sure, here&apos;s the MR on top of trunk (internally we currently run a fork of 2.3.1):&#160;&lt;a href=&quot;https://github.com/apache/kafka/pull/7760&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/7760&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16986321" author="githubbot" created="Mon, 2 Dec 2019 20:05:18 +0000"  >&lt;p&gt;ijuma commented on pull request #7760: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-9156&quot; title=&quot;LazyTimeIndex &amp;amp; LazyOffsetIndex may cause niobufferoverflow in concurrent state&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-9156&quot;&gt;&lt;del&gt;KAFKA-9156&lt;/del&gt;&lt;/a&gt;: fix LazyTimeIndex &amp;amp; LazyOffsetIndex concurrency&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/7760&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/7760&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="17302197" author="iblackeyes" created="Tue, 16 Mar 2021 03:33:53 +0000"  >&lt;p&gt;This issue seem not been completed fixed. Because after we patched this MR, the issue has occured for many times in our product env. Error log like this&#160;&lt;/p&gt;

&lt;p&gt;```&lt;br/&gt;
2021-03-16 09:50:29,626 | ERROR | &lt;span class=&quot;error&quot;&gt;&amp;#91;data-plane-kafka-request-handler-4&amp;#93;&lt;/span&gt; | &lt;span class=&quot;error&quot;&gt;&amp;#91;ReplicaManager broker=1&amp;#93;&lt;/span&gt; Error processing append operation on partition topic_xxxxxx_50680-4 | kafka.server.ReplicaManager (Logging.scala:76) &lt;br/&gt;
java.nio.BufferOverflowException&lt;br/&gt;
	at java.nio.Buffer.nextPutIndex(Buffer.java:527)&lt;br/&gt;
	at java.nio.DirectByteBuffer.putLong(DirectByteBuffer.java:797)&lt;br/&gt;
	at kafka.log.TimeIndex$$anonfun$maybeAppend$1.apply$mcV$sp(TimeIndex.scala:131)&lt;br/&gt;
	at kafka.log.TimeIndex$$anonfun$maybeAppend$1.apply(TimeIndex.scala:110)&lt;br/&gt;
	at kafka.log.TimeIndex$$anonfun$maybeAppend$1.apply(TimeIndex.scala:110)&lt;br/&gt;
	at kafka.utils.CoreUtils$.inLock(CoreUtils.scala:250)&lt;br/&gt;
	at kafka.log.TimeIndex.maybeAppend(TimeIndex.scala:110)&lt;br/&gt;
	at kafka.log.LogSegment.onBecomeInactiveSegment(LogSegment.scala:445)&lt;br/&gt;
	at kafka.log.Log$$anonfun$roll$2$$anonfun$apply$27.apply(Log.scala:1363)&lt;br/&gt;
	at kafka.log.Log$$anonfun$roll$2$$anonfun$apply$27.apply(Log.scala:1363)&lt;br/&gt;
	at scala.Option.foreach(Option.scala:257)&lt;br/&gt;
	at kafka.log.Log$$anonfun$roll$2.apply(Log.scala:1363)&lt;br/&gt;
	at kafka.log.Log$$anonfun$roll$2.apply(Log.scala:1349)&lt;br/&gt;
	at kafka.log.Log.maybeHandleIOException(Log.scala:1711)&lt;br/&gt;
	at kafka.log.Log.roll(Log.scala:1349)&lt;br/&gt;
	at kafka.log.Log.kafka$log$Log$$maybeRoll(Log.scala:1336)&lt;br/&gt;
	at kafka.log.Log$$anonfun$append$2.apply(Log.scala:754)&lt;br/&gt;
	at kafka.log.Log$$anonfun$append$2.apply(Log.scala:653)&lt;br/&gt;
	at kafka.log.Log.maybeHandleIOException(Log.scala:1711)&lt;br/&gt;
	at kafka.log.Log.append(Log.scala:653)&lt;br/&gt;
	at kafka.log.Log.appendAsLeader(Log.scala:623)&lt;br/&gt;
	at kafka.cluster.Partition$$anonfun$13.apply(Partition.scala:614)&lt;br/&gt;
	at kafka.cluster.Partition$$anonfun$13.apply(Partition.scala:602)&lt;br/&gt;
	at kafka.utils.CoreUtils$.inLock(CoreUtils.scala:250)&lt;br/&gt;
	at kafka.utils.CoreUtils$.inReadLock(CoreUtils.scala:256)&lt;br/&gt;
	at kafka.cluster.Partition.appendRecordsToLeader(Partition.scala:601)&lt;br/&gt;
	at kafka.server.ReplicaManager$$anonfun$appendToLocalLog$2.apply(ReplicaManager.scala:739)&lt;br/&gt;
	at kafka.server.ReplicaManager$$anonfun$appendToLocalLog$2.apply(ReplicaManager.scala:723)&lt;br/&gt;
	at scala.collection.TraversableLike$$anonfun$map$1.apply(TraversableLike.scala:234)&lt;br/&gt;
	at scala.collection.TraversableLike$$anonfun$map$1.apply(TraversableLike.scala:234)&lt;br/&gt;
	at scala.collection.mutable.HashMap$$anonfun$foreach$1.apply(HashMap.scala:130)&lt;br/&gt;
	at scala.collection.mutable.HashMap$$anonfun$foreach$1.apply(HashMap.scala:130)&lt;br/&gt;
	at scala.collection.mutable.HashTable$class.foreachEntry(HashTable.scala:236)&lt;br/&gt;
	at scala.collection.mutable.HashMap.foreachEntry(HashMap.scala:40)&lt;br/&gt;
	at scala.collection.mutable.HashMap.foreach(HashMap.scala:130)&lt;br/&gt;
	at scala.collection.TraversableLike$class.map(TraversableLike.scala:234)&lt;br/&gt;
	at scala.collection.AbstractTraversable.map(Traversable.scala:104)&lt;br/&gt;
	at kafka.server.ReplicaManager.appendToLocalLog(ReplicaManager.scala:723)&lt;br/&gt;
	at kafka.server.ReplicaManager.appendRecords(ReplicaManager.scala:464)&lt;br/&gt;
	at kafka.server.KafkaApis.handleProduceRequest(KafkaApis.scala:471)&lt;br/&gt;
	at kafka.server.KafkaApis.handle(KafkaApis.scala:104)&lt;br/&gt;
	at kafka.server.KafkaRequestHandler.run(KafkaRequestHandler.scala:69)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:748)&lt;/p&gt;

&lt;p&gt;```&lt;/p&gt;</comment>
                            <comment id="17312207" author="wenbing.shen" created="Wed, 31 Mar 2021 09:03:55 +0000"  >&lt;p&gt;Hi,&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=amironov&quot; class=&quot;user-hover&quot; rel=&quot;amironov&quot;&gt;amironov&lt;/a&gt;&#160; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ijuma&quot; class=&quot;user-hover&quot; rel=&quot;ijuma&quot;&gt;ijuma&lt;/a&gt;&#160;,&#160;I applied kafka-7283 and kafka-9156 in our version of kafka-2.0.0 to apply the benefits of LazyIndex when starting the&#160;broker.&#160;When I applied this feature to a small Kafka cluster, there was no problem, but when I first applied it to a cluster with high traffic, some brokers with small traffic seemed to be no exception, but after the brokers with large traffic started, a large number of replica fetcher threads throw java.nio.BufferOverflowException.&#160;&lt;/p&gt;

&lt;p&gt;&#160;Same as the problem encountered by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iBlackeyes&quot; class=&quot;user-hover&quot; rel=&quot;iBlackeyes&quot;&gt;iBlackeyes&lt;/a&gt;&#160;, the current patch still does not fix this problem.&lt;/p&gt;

&lt;p&gt;Its stack information is as follows:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;2021-03-31 15:23:54,935&amp;#93;&lt;/span&gt; ERROR (ReplicaFetcherThread-1-1001 kafka.server.ReplicaFetcherThread 76) &lt;span class=&quot;error&quot;&gt;&amp;#91;ReplicaFetcher replicaId=1006, leaderId=1001, fetcherId=1&amp;#93;&lt;/span&gt; Error due to&lt;br/&gt;
 org.apache.kafka.common.KafkaException: Error processing data for partition sinan_assets_tagged_default-9 offset 38543576&lt;br/&gt;
 at kafka.server.AbstractFetcherThread$$anonfun$processFetchRequest$2$$anonfun$apply$mcV$sp$1$$anonfun$apply$2.apply(AbstractFetcherThread.scala:214)&lt;br/&gt;
 at kafka.server.AbstractFetcherThread$$anonfun$processFetchRequest$2$$anonfun$apply$mcV$sp$1$$anonfun$apply$2.apply(AbstractFetcherThread.scala:175)&lt;br/&gt;
 at scala.Option.foreach(Option.scala:257)&lt;br/&gt;
 at kafka.server.AbstractFetcherThread$$anonfun$processFetchRequest$2$$anonfun$apply$mcV$sp$1.apply(AbstractFetcherThread.scala:175)&lt;br/&gt;
 at kafka.server.AbstractFetcherThread$$anonfun$processFetchRequest$2$$anonfun$apply$mcV$sp$1.apply(AbstractFetcherThread.scala:172)&lt;br/&gt;
 at scala.collection.mutable.ResizableArray$class.foreach(ResizableArray.scala:59)&lt;br/&gt;
 at scala.collection.mutable.ArrayBuffer.foreach(ArrayBuffer.scala:48)&lt;br/&gt;
 at kafka.server.AbstractFetcherThread$$anonfun$processFetchRequest$2.apply$mcV$sp(AbstractFetcherThread.scala:172)&lt;br/&gt;
 at kafka.server.AbstractFetcherThread$$anonfun$processFetchRequest$2.apply(AbstractFetcherThread.scala:172)&lt;br/&gt;
 at kafka.server.AbstractFetcherThread$$anonfun$processFetchRequest$2.apply(AbstractFetcherThread.scala:172)&lt;br/&gt;
 at kafka.utils.CoreUtils$.inLock(CoreUtils.scala:255)&lt;br/&gt;
 at kafka.server.AbstractFetcherThread.processFetchRequest(AbstractFetcherThread.scala:170)&lt;br/&gt;
 at kafka.server.AbstractFetcherThread.doWork(AbstractFetcherThread.scala:114)&lt;br/&gt;
 at kafka.utils.ShutdownableThread.run(ShutdownableThread.scala:82)&lt;br/&gt;
 Caused by: java.nio.BufferOverflowException&lt;br/&gt;
 at java.nio.Buffer.nextPutIndex(Buffer.java:527)&lt;br/&gt;
 at java.nio.DirectByteBuffer.putLong(DirectByteBuffer.java:793)&lt;br/&gt;
 at kafka.log.TimeIndex$$anonfun$maybeAppend$1.apply$mcV$sp(TimeIndex.scala:131)&lt;br/&gt;
 at kafka.log.TimeIndex$$anonfun$maybeAppend$1.apply(TimeIndex.scala:111)&lt;br/&gt;
 at kafka.log.TimeIndex$$anonfun$maybeAppend$1.apply(TimeIndex.scala:111)&lt;br/&gt;
 at kafka.utils.CoreUtils$.inLock(CoreUtils.scala:255)&lt;br/&gt;
 at kafka.log.TimeIndex.maybeAppend(TimeIndex.scala:111)&lt;br/&gt;
 at kafka.log.LogSegment.onBecomeInactiveSegment(LogSegment.scala:578)&lt;br/&gt;
 at kafka.log.Log$$anonfun$roll$2$$anonfun$apply$32.apply(Log.scala:1582)&lt;br/&gt;
 at kafka.log.Log$$anonfun$roll$2$$anonfun$apply$32.apply(Log.scala:1582)&lt;br/&gt;
 at scala.Option.foreach(Option.scala:257)&lt;br/&gt;
 at kafka.log.Log$$anonfun$roll$2.apply(Log.scala:1582)&lt;br/&gt;
 at kafka.log.Log$$anonfun$roll$2.apply(Log.scala:1568)&lt;br/&gt;
 at kafka.log.Log.maybeHandleIOException(Log.scala:1943)&lt;br/&gt;
 at kafka.log.Log.roll(Log.scala:1568)&lt;br/&gt;
 at kafka.log.Log.kafka$log$Log$$maybeRoll(Log.scala:1553)&lt;br/&gt;
 at kafka.log.Log$$anonfun$append$2.apply(Log.scala:956)&lt;br/&gt;
 at kafka.log.Log$$anonfun$append$2.apply(Log.scala:850)&lt;br/&gt;
 at kafka.log.Log.maybeHandleIOException(Log.scala:1943)&lt;br/&gt;
 at kafka.log.Log.append(Log.scala:850)&lt;br/&gt;
 at kafka.log.Log.appendAsFollower(Log.scala:831)&lt;br/&gt;
 at kafka.cluster.Partition$$anonfun$doAppendRecordsToFollowerOrFutureReplica$1.apply(Partition.scala:589)&lt;br/&gt;
 at kafka.utils.CoreUtils$.inLock(CoreUtils.scala:255)&lt;br/&gt;
 at kafka.utils.CoreUtils$.inReadLock(CoreUtils.scala:261)&lt;br/&gt;
 at kafka.cluster.Partition.doAppendRecordsToFollowerOrFutureReplica(Partition.scala:576)&lt;br/&gt;
 at kafka.cluster.Partition.appendRecordsToFollowerOrFutureReplica(Partition.scala:596)&lt;br/&gt;
 at kafka.server.ReplicaFetcherThread.processPartitionData(ReplicaFetcherThread.scala:129)&lt;br/&gt;
 at kafka.server.ReplicaFetcherThread.processPartitionData(ReplicaFetcherThread.scala:43)&lt;br/&gt;
 at kafka.server.AbstractFetcherThread$$anonfun$processFetchRequest$2$$anonfun$apply$mcV$sp$1$$anonfun$apply$2.apply(AbstractFetcherThread.scala:189)&lt;br/&gt;
 ... 13 more&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;2021-03-31 15:23:54,936&amp;#93;&lt;/span&gt; INFO (ReplicaFetcherThread-1-1001 kafka.server.ReplicaFetcherThread 66) &lt;span class=&quot;error&quot;&gt;&amp;#91;ReplicaFetcher replicaId=1006, leaderId=1001, fetcherId=1&amp;#93;&lt;/span&gt; Stopped&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17312216" author="iblackeyes" created="Wed, 31 Mar 2021 09:20:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=amironov&quot; class=&quot;user-hover&quot; rel=&quot;amironov&quot;&gt;amironov&lt;/a&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lushilin&quot; class=&quot;user-hover&quot; rel=&quot;lushilin&quot;&gt;lushilin&lt;/a&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wenbing.shen&quot; class=&quot;user-hover&quot; rel=&quot;wenbing.shen&quot;&gt;wenbing.shen&lt;/a&gt; yes, after the brokers with large traffic started ,this case will re-produce. please take a view.&lt;/p&gt;</comment>
                            <comment id="17635367" author="btiernay" created="Thu, 17 Nov 2022 14:02:59 +0000"  >&lt;p&gt;We too are hitting this on AWS MSK Kafka version 2.8.1:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ERROR Uncaught exception in scheduled task &lt;span class=&quot;code-quote&quot;&gt;&apos;kafka-log-retention&apos;&lt;/span&gt; (kafka.utils.KafkaScheduler)
java.nio.BufferOverflowException
    at java.base/java.nio.Buffer.nextPutIndex(Buffer.java:674)
    at java.base/java.nio.DirectByteBuffer.putLong(DirectByteBuffer.java:882)
    at kafka.log.TimeIndex.$anonfun$maybeAppend$1(TimeIndex.scala:134)
    at kafka.log.TimeIndex.maybeAppend(TimeIndex.scala:114)
    at kafka.log.LogSegment.onBecomeInactiveSegment(LogSegment.scala:506)
    at kafka.log.Log.$anonfun$roll$8(Log.scala:2066)
    at kafka.log.Log.$anonfun$roll$8$adapted(Log.scala:2066)
    at scala.Option.foreach(Option.scala:437)
    at kafka.log.Log.$anonfun$roll$2(Log.scala:2066)
    at kafka.log.Log.roll(Log.scala:2482)
    at kafka.log.Log.$anonfun$deleteSegments$2(Log.scala:1859)
    at kafka.log.Log.deleteSegments(Log.scala:2482)
    at kafka.log.Log.deleteRetentionMsBreachedSegments(Log.scala:1847)
    at kafka.log.Log.deleteOldSegments(Log.scala:1916)
    at kafka.log.LogManager.$anonfun$cleanupLogs$3(LogManager.scala:1092)
    at kafka.log.LogManager.$anonfun$cleanupLogs$3$adapted(LogManager.scala:1089)
    at scala.collection.immutable.List.foreach(List.scala:333)
    at kafka.log.LogManager.cleanupLogs(LogManager.scala:1089)
    at kafka.log.LogManager.$anonfun$startupWithConfigOverrides$2(LogManager.scala:429)
    at kafka.utils.KafkaScheduler.$anonfun$schedule$2(KafkaScheduler.scala:114)
    at java.base/java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:515)
    at java.base/java.util.concurrent.FutureTask.runAndReset(FutureTask.java:305)
    at java.base/java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:305)
    at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128)
    at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)
    at java.base/java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:829) &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;when this happens, disk starts to fill up and exhaust until a restart:&lt;br/&gt;
&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13052329/13052329_image-2022-11-17-09-02-20-774.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13269442">KAFKA-9213</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12985181" name="image-2019-11-07-17-42-13-852.png" size="99668" author="lushilin" created="Thu, 7 Nov 2019 09:42:15 +0000"/>
                            <attachment id="12985180" name="image-2019-11-07-17-44-05-357.png" size="145817" author="lushilin" created="Thu, 7 Nov 2019 09:44:07 +0000"/>
                            <attachment id="12985179" name="image-2019-11-07-17-46-53-650.png" size="2147263" author="lushilin" created="Thu, 7 Nov 2019 09:46:57 +0000"/>
                            <attachment id="13052329" name="image-2022-11-17-09-02-20-774.png" size="53587" author="btiernay" created="Thu, 17 Nov 2022 14:02:21 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10431"><![CDATA[Important]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 51 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z08clk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>ijuma</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>