<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:23:18 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-9777] Purgatory locking bug can lead to hanging transaction</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-9777</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Once a transaction reaches the `PrepareCommit` or `PrepareAbort` state, the transaction coordinator must send markers to all partitions included in the transaction. After all markers have been sent, then the transaction transitions to the corresponding completed state. Until this transition occurs, no additional progress can be made by the producer.&lt;/p&gt;

&lt;p&gt;The transaction coordinator uses a purgatory to track completion of the markers that need to be sent. Once all markers have been written, then the `DelayedTxnMarker` task becomes completable. We depend on its completion in order to transition to the completed state.&lt;/p&gt;

&lt;p&gt;Related to &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-8334&quot; title=&quot;Occasional OffsetCommit Timeout&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-8334&quot;&gt;&lt;del&gt;KAFKA-8334&lt;/del&gt;&lt;/a&gt;, there is a bug in the locking protocol which is used to check completion of the `DelayedTxnMarker` task. The purgatory attempts to provide a &quot;happens before&quot; contract for task completion with `checkAndComplete`. Basically if a task is completed before calling `checkAndComplete`, then it should be given an opportunity to complete as long as there is sufficient time remaining before expiration. &lt;/p&gt;

&lt;p&gt;The bug in the locking protocol is that it expects that the operation lock is exclusive to the operation. See here: &lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/core/src/main/scala/kafka/server/DelayedOperation.scala#L114&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/trunk/core/src/main/scala/kafka/server/DelayedOperation.scala#L114&lt;/a&gt;. The logic assumes that if the lock cannot be acquired, then the other holder of the lock must be attempting completion of the same delayed operation. If that is not the case, then the &quot;happens before&quot; contract is broken and a task may not get completed until expiration even if it has been satisfied.&lt;/p&gt;

&lt;p&gt;In the case of `DelayedTxnMarker`, the lock in use is the read side of a read-write lock which is used for partition loading: &lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/core/src/main/scala/kafka/coordinator/transaction/TransactionMarkerChannelManager.scala#L264&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/trunk/core/src/main/scala/kafka/coordinator/transaction/TransactionMarkerChannelManager.scala#L264&lt;/a&gt;. In fact, if the lock cannot be acquired, it means that it is being held in order to complete some loading operation, in which case it will definitely not attempt completion of the delayed operation. If this happens to occur on the last call to `checkAndComplete` after all markers have been written, then the transition to the completing state will never occur.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13294537">KAFKA-9777</key>
            <summary>Purgatory locking bug can lead to hanging transaction</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hachikuji">Jason Gustafson</assignee>
                                    <reporter username="hachikuji">Jason Gustafson</reporter>
                        <labels>
                    </labels>
                <created>Fri, 27 Mar 2020 18:50:50 +0000</created>
                <updated>Wed, 3 Jun 2020 18:00:29 +0000</updated>
                            <resolved>Wed, 3 Jun 2020 18:00:29 +0000</resolved>
                                    <version>1.1.1</version>
                    <version>2.0.1</version>
                    <version>2.1.1</version>
                    <version>2.2.2</version>
                    <version>2.3.1</version>
                    <version>2.4.1</version>
                                    <fixVersion>2.6.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17069075" author="githubbot" created="Fri, 27 Mar 2020 22:07:36 +0000"  >&lt;p&gt;hachikuji commented on pull request #8377: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-9777&quot; title=&quot;Purgatory locking bug can lead to hanging transaction&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-9777&quot;&gt;&lt;del&gt;KAFKA-9777&lt;/del&gt;&lt;/a&gt;; Use asynchronous write to log after txn marker completion&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/8377&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/8377&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   This patch addresses a locking issue with `DelayTxnMarker` completion. Because of the reliance on the read lock in `TransactionStateManager`, we cannot guarantee that a call to `checkAndComplete` will offer an opportunity to complete the job. This patch removes the reliance on this lock. Instead when the operation is completed, we write the completion message to the log asynchronously.&lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="17071171" author="githubbot" created="Mon, 30 Mar 2020 17:44:24 +0000"  >&lt;p&gt;hachikuji commented on pull request #8377: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-9777&quot; title=&quot;Purgatory locking bug can lead to hanging transaction&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-9777&quot;&gt;&lt;del&gt;KAFKA-9777&lt;/del&gt;&lt;/a&gt;; Use asynchronous write to log after txn marker completion&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/8377&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/8377&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="17071172" author="githubbot" created="Mon, 30 Mar 2020 17:45:29 +0000"  >&lt;p&gt;hachikuji commented on pull request #8389: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-9777&quot; title=&quot;Purgatory locking bug can lead to hanging transaction&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-9777&quot;&gt;&lt;del&gt;KAFKA-9777&lt;/del&gt;&lt;/a&gt;; Remove txn purgatory to fix race condition on txn completion&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/8389&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/8389&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   This patch addresses a locking issue with DelayTxnMarker completion. Because of the reliance on the shared read lock in TransactionStateManager and the deadlock avoidance algorithm in `DelayedOperation`, we cannot guarantee that a call to checkAndComplete will offer an opportunity to complete the job. This patch removes the reliance on this lock in two ways:&lt;/p&gt;

&lt;p&gt;   1. We replace the transaction marker purgatory with a map of transaction with pending markers. We were not using purgatory expiration anyway, so this avoids the locking issue and simplifies usage.&lt;br/&gt;
   2. We were also relying on the read lock when calling `ReplicaManager.appendRecords`. As far as I can tell, this was not necessary. The lock order is always 1) state read/write lock, 2) txn metadata locks. Since we only call `appendRecords` while holding the read lock, a deadlock does not seem possible. &lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="17071363" author="githubbot" created="Tue, 31 Mar 2020 00:47:11 +0000"  >&lt;p&gt;hachikuji commented on pull request #8389: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-9777&quot; title=&quot;Purgatory locking bug can lead to hanging transaction&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-9777&quot;&gt;&lt;del&gt;KAFKA-9777&lt;/del&gt;&lt;/a&gt;; Remove txn purgatory to fix race condition on txn completion&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/8389&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/8389&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13232161">KAFKA-8334</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 33 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0czvk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>