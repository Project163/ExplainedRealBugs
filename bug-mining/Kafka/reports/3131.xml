<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:29:15 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-13457] SocketChannel in Acceptor#accept is not closed upon IOException</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-13457</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;When the kafka.network.Acceptor in SocketServer.scala accepts a new connection in the `accept` function, it handles the `TooManyConnectionsException` and `ConnectionThrottledException`. However, the socketChannel operations (line 720 or 721 or 722) within the try block may potentially throw an IOException as well, which is not handled.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;//core/src/main/scala/kafka/network/SocketServer.scala
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// Acceptor class
&lt;/span&gt;  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; def accept(key: SelectionKey): Option[SocketChannel] = {
&#160; &#160; val serverSocketChannel = key.channel().asInstanceOf[ServerSocketChannel]
&#160; &#160; val socketChannel = serverSocketChannel.accept() &#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// line 717
&lt;/span&gt;&#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
&#160; &#160; &#160; connectionQuotas.inc(endPoint.listenerName, socketChannel.socket.getInetAddress, blockedPercentMeter)
&#160; &#160; &#160; socketChannel.configureBlocking(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;) &#160; &#160; &#160; &#160; &#160; &#160;&#160;&lt;span class=&quot;code-comment&quot;&gt;// line 720
&lt;/span&gt;&#160; &#160; &#160; socketChannel.socket().setTcpNoDelay(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;) &#160; &#160; &#160; &#160;&#160;&lt;span class=&quot;code-comment&quot;&gt;// line 721
&lt;/span&gt;&#160; &#160; &#160; socketChannel.socket().setKeepAlive(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;) &#160; &#160; &#160; &#160; &#160;&lt;span class=&quot;code-comment&quot;&gt;// line 722
&lt;/span&gt;&#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (sendBufferSize != Selectable.USE_DEFAULT_BUFFER_SIZE)
&#160; &#160; &#160; &#160; socketChannel.socket().setSendBufferSize(sendBufferSize)
&#160; &#160; &#160; Some(socketChannel)
&#160; &#160; } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; {
&#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; e: TooManyConnectionsException =&amp;gt; &#160; &#160; &#160;&#160;
&#160; &#160; &#160; &#160; info(s&lt;span class=&quot;code-quote&quot;&gt;&quot;Rejected connection from ${e.ip}, address already has the configured maximum of ${e.count} connections.&quot;&lt;/span&gt;)
&#160; &#160; &#160; &#160; close(endPoint.listenerName, socketChannel)
&#160; &#160; &#160; &#160; None
&#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; e: ConnectionThrottledException =&amp;gt;&#160;
&#160; &#160; &#160; &#160; val ip = socketChannel.socket.getInetAddress
&#160; &#160; &#160; &#160; debug(s&lt;span class=&quot;code-quote&quot;&gt;&quot;Delaying closing of connection from $ip &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; ${e.throttleTimeMs} ms&quot;&lt;/span&gt;)
&#160; &#160; &#160; &#160; val endThrottleTimeMs = e.startThrottleTimeMs + e.throttleTimeMs
&#160; &#160; &#160; &#160; throttledSockets += DelayedCloseSocket(socketChannel, endThrottleTimeMs)
&#160; &#160; &#160; &#160; None
&#160; &#160; }
&#160; }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This thrown IOException is caught in the caller `acceptNewConnections` in line 706, which only prints an error message. The socketChannel that throws this IOException is not closed.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;//core/src/main/scala/kafka/network/SocketServer.scala
&lt;/span&gt;  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; def acceptNewConnections(): Unit = {
&#160; &#160; val ready = nioSelector.select(500)
&#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (ready &amp;gt; 0) {
&#160; &#160; &#160; val keys = nioSelector.selectedKeys()
&#160; &#160; &#160; val iter = keys.iterator()
&#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (iter.hasNext &amp;amp;&amp;amp; isRunning) {
&#160; &#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
&#160; &#160; &#160; &#160; &#160; val key = iter.next
&#160; &#160; &#160; &#160; &#160; iter.remove()&#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (key.isAcceptable) {
&#160; &#160; &#160; &#160; &#160; &#160; accept(key).foreach { socketChannel =&amp;gt;&#160;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; ...
&#160; &#160; &#160; &#160; &#160; &#160; &#160; } &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (!assignNewConnection(socketChannel, processor, retriesLeft == 0))
&#160; &#160; &#160; &#160; &#160; &#160; }
&#160; &#160; &#160; &#160; &#160; } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;
&#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IllegalStateException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Unrecognized key state &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; acceptor thread.&quot;&lt;/span&gt;)
&#160; &#160; &#160; &#160; } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; {
&#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; e: Throwable =&amp;gt; error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Error &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; accepting connection&quot;&lt;/span&gt;, e) &#160; &lt;span class=&quot;code-comment&quot;&gt;// line 706
&lt;/span&gt;&#160; &#160; &#160; &#160; }
&#160; &#160; &#160; }
&#160; &#160; }
&#160; }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;We found during testing this would cause our Kafka clients to experience errors (InvalidReplicationFactorException) for 40+ seconds when creating new topics. After 40 seconds, the clients would be able to create new topics successfully.&lt;/p&gt;

&lt;p&gt;We check that after adding the socketChannel.close() upon IOException, the symptoms will disappear, so the clients do not need to wait for 40s to be working again.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13411927">KAFKA-13457</key>
            <summary>SocketChannel in Acceptor#accept is not closed upon IOException</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="functioner">Haoze Wu</reporter>
                        <labels>
                    </labels>
                <created>Tue, 16 Nov 2021 01:14:33 +0000</created>
                <updated>Tue, 22 Mar 2022 12:47:34 +0000</updated>
                            <resolved>Wed, 24 Nov 2021 08:31:16 +0000</resolved>
                                    <version>2.8.0</version>
                                    <fixVersion>3.2.0</fixVersion>
                                    <component>network</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17510436" author="mimaison" created="Tue, 22 Mar 2022 11:54:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dajac&quot; class=&quot;user-hover&quot; rel=&quot;dajac&quot;&gt;dajac&lt;/a&gt; I see you merged &lt;a href=&quot;https://github.com/apache/kafka/pull/11504&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/11504&lt;/a&gt; a while back. Can we now close this issue? or is there more work to do?&lt;/p&gt;</comment>
                            <comment id="17510466" author="dajac" created="Tue, 22 Mar 2022 12:34:38 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mimaison&quot; class=&quot;user-hover&quot; rel=&quot;mimaison&quot;&gt;mimaison&lt;/a&gt; Done.&lt;/p&gt;</comment>
                            <comment id="17510472" author="mimaison" created="Tue, 22 Mar 2022 12:47:34 +0000"  >&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13413758">HADOOP-18024</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 34 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0wrew:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>dajac</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>