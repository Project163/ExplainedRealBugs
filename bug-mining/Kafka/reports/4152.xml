<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:42:39 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-18569] New consumer close may wait on unneeded FindCoordinator</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-18569</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;A flaky test revealed that the new consumer close may wait for a FindCoordinator unsent request to go out when closing the consumer, even after the commit/leaveGroup stages of close are done.&lt;/p&gt;

&lt;p&gt;This could happen because the CoordinatorRequestManager poll continues to attempt FindCoordinator if the coordinator is unknown , even if this happens during consumer close, after the consumer has completed the commit/leave attempts (which are the only steps in close that require a coordinator), and before the network shutdown that stops polling managers here&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/kafka/blob/5c20aa187aa8f51af4270d7d1b0db4963b0cd10b/clients/src/main/java/org/apache/kafka/clients/consumer/internals/AsyncKafkaConsumer.java#L1343&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/5c20aa187aa8f51af4270d7d1b0db4963b0cd10b/clients/src/main/java/org/apache/kafka/clients/consumer/internals/AsyncKafkaConsumer.java#L1343&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;If the unneeded FindCoordinator is generated and the brokers are down (like could happen in the flaky test), the consumer would wait for that request unnecessarily here&#160; &lt;a href=&quot;https://github.com/apache/kafka/blob/5c20aa187aa8f51af4270d7d1b0db4963b0cd10b/clients/src/main/java/org/apache/kafka/clients/consumer/internals/ConsumerNetworkThread.java#L327&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/5c20aa187aa8f51af4270d7d1b0db4963b0cd10b/clients/src/main/java/org/apache/kafka/clients/consumer/internals/ConsumerNetworkThread.java#L327&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I expect we shouldn&apos;t block the close on a FindCoordinator request if the consumer already completed the commit/leave attempts.&lt;/p&gt;

&lt;p&gt;An option could be to consider &quot;signal close&quot; to the CoordinatorRequestManager after the consumer.close completes commit/leave, so that it does not generate any more requests on poll (similar to what is already done for the CommitRequestManager with the&#160;CommitOnCloseEvent&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/kafka/blob/5c20aa187aa8f51af4270d7d1b0db4963b0cd10b/clients/src/main/java/org/apache/kafka/clients/consumer/internals/AsyncKafkaConsumer.java#L1335&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/5c20aa187aa8f51af4270d7d1b0db4963b0cd10b/clients/src/main/java/org/apache/kafka/clients/consumer/internals/AsyncKafkaConsumer.java#L1335&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;This fix should allow to enable this test for the new consumer reliably.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/kafka/blob/5c20aa187aa8f51af4270d7d1b0db4963b0cd10b/core/src/test/scala/integration/kafka/api/ConsumerBounceTest.scala#L404&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/5c20aa187aa8f51af4270d7d1b0db4963b0cd10b/core/src/test/scala/integration/kafka/api/ConsumerBounceTest.scala#L404&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Without the fix, the test is flaky (fails locally after a few repeated runs, fails in CI).&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13605266">KAFKA-18569</key>
            <summary>New consumer close may wait on unneeded FindCoordinator</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="frankvicky">TengYao Chi</assignee>
                                    <reporter username="lianetm">Lianet Magrans</reporter>
                        <labels>
                            <label>kip-848-client-support</label>
                    </labels>
                <created>Thu, 16 Jan 2025 16:31:04 +0000</created>
                <updated>Tue, 15 Apr 2025 15:04:25 +0000</updated>
                            <resolved>Wed, 29 Jan 2025 19:17:37 +0000</resolved>
                                                    <fixVersion>4.0.0</fixVersion>
                                    <component>clients</component>
                    <component>consumer</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                                                            <comments>
                            <comment id="17913792" author="JIRAUSER300183" created="Thu, 16 Jan 2025 16:33:52 +0000"  >&lt;p&gt;Hey &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chia7712&quot; class=&quot;user-hover&quot; rel=&quot;chia7712&quot;&gt;chia7712&lt;/a&gt; , we&apos;ve worked together in this area before, wonder if you have any input? I wrote down my findings and a first idea from the top of my head but let me know if you have any thoughts. Thanks!&lt;/p&gt;</comment>
                            <comment id="17913794" author="JIRAUSER305181" created="Thu, 16 Jan 2025 16:37:50 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lianetm&quot; class=&quot;user-hover&quot; rel=&quot;lianetm&quot;&gt;lianetm&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;May I take over this issue ?&lt;/p&gt;</comment>
                            <comment id="17913795" author="JIRAUSER300183" created="Thu, 16 Jan 2025 16:42:45 +0000"  >&lt;p&gt;Sure, thanks! Reach out to help when you need. Note that I marked this as a blocker for 4.0 as I believe the impact (close taking up to the timeout needlessly) is very sensitive for client apps (we recently had a similar issue with KIP-714). cc. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dajac&quot; class=&quot;user-hover&quot; rel=&quot;dajac&quot;&gt;dajac&lt;/a&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17913867" author="kirktrue" created="Thu, 16 Jan 2025 22:02:01 +0000"  >&lt;blockquote&gt;&lt;p&gt;An option could be to consider &quot;signal close&quot; to the CoordinatorRequestManager after the consumer.close completes commit/leave, so that it does not generate any more requests on poll (similar to what is already done for the CommitRequestManager with the CommitOnCloseEvent&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I noticed that &lt;tt&gt;CoordinatorRequestManager&lt;/tt&gt; uses the default, no-op implementation of &lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/clients/src/main/java/org/apache/kafka/clients/consumer/internals/RequestManager.java#L48-L66&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;RequestManager.pollOnClose()&lt;/tt&gt;&lt;/a&gt;. Since &lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/clients/src/main/java/org/apache/kafka/clients/consumer/internals/ConsumerNetworkThread.java#L336-L351&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;ConsumerNetworkThread.cleanup()&lt;/tt&gt;&lt;/a&gt; calls &lt;tt&gt;runAtClose()&lt;/tt&gt; before &lt;tt&gt;sendUnsentRequests()&lt;/tt&gt;, adding an implementation of &lt;tt&gt;CoordinatorRequestManager.pollOnClose()&lt;/tt&gt; that halts further &lt;tt&gt;FindCoordinator&lt;/tt&gt; requests from being generated would then prevent &lt;tt&gt;sendUnsentRequests()&lt;/tt&gt; from having any &lt;tt&gt;FindCoordinator&lt;/tt&gt; requests to send.&lt;/p&gt;

&lt;p&gt;I don&apos;t know for sure if that would work, but it could be worth a try.&lt;/p&gt;</comment>
                            <comment id="17913868" author="kirktrue" created="Thu, 16 Jan 2025 22:08:52 +0000"  >&lt;p&gt;I also noticed that the loop in &lt;tt&gt;sendUnsentRequests()&lt;/tt&gt; will continue as long as any &lt;em&gt;inflight&lt;/em&gt; requests are present. If a &lt;tt&gt;FindCoordinator&lt;/tt&gt; request was already &quot;sent&quot; (but not &quot;completed&quot;) when &lt;tt&gt;sendUnsentRequests()&lt;/tt&gt; is called, it will loop until the timeout is hit. It seems like there needs to be some way to tell the &lt;tt&gt;NetworkClientDelegate&lt;/tt&gt; to ignore that request.&lt;/p&gt;</comment>
                            <comment id="17916116" author="JIRAUSER300183" created="Wed, 22 Jan 2025 16:57:56 +0000"  >&lt;p&gt;Hey &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=frankvicky&quot; class=&quot;user-hover&quot; rel=&quot;frankvicky&quot;&gt;frankvicky&lt;/a&gt; , I added 2 subtasks here just to point out the tests that we should be able to enable with the fix. Let&apos;s have it all in the same PR if possible I would say, it will be a good validation of the fix. Thanks!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13604876">KAFKA-18517</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                            <subtask id="13605930">KAFKA-18623</subtask>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            41 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1tnwg:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>