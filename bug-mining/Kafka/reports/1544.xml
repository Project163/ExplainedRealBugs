<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:02:05 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-5415] TransactionCoordinator doesn&apos;t complete transition to PrepareCommit state</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-5415</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;This has been revealed by the system test failures on jenkins. &lt;/p&gt;

&lt;p&gt;The transaction coordinator seems to get into a path during the handling of the EndTxnRequest where it returns an error (possibly a NOT_COORDINATOR or COORDINATOR_NOT_AVAILABLE error, to be revealed by &lt;a href=&quot;https://github.com/apache/kafka/pull/3278&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3278&lt;/a&gt;) to the client. However, due to network instability, the producer is disconnected before it receives this error.&lt;/p&gt;

&lt;p&gt;As a result, the transaction remains in a `PrepareXX` state, and future `EndTxn` requests sent by the client after reconnecting result in a `CONCURRENT_TRANSACTION` error code. Hence the client gets stuck and the transaction never finishes, as expiration isn&apos;t done from a PrepareXX state.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13078479">KAFKA-5415</key>
            <summary>TransactionCoordinator doesn&apos;t complete transition to PrepareCommit state</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="apurva">Apurva Mehta</assignee>
                                    <reporter username="apurva">Apurva Mehta</reporter>
                        <labels>
                            <label>exactly-once</label>
                    </labels>
                <created>Fri, 9 Jun 2017 00:34:42 +0000</created>
                <updated>Sat, 10 Jun 2017 00:09:40 +0000</updated>
                            <resolved>Sat, 10 Jun 2017 00:09:05 +0000</resolved>
                                                    <fixVersion>0.11.0.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16043731" author="apurva" created="Fri, 9 Jun 2017 00:36:21 +0000"  >&lt;p&gt;Logs from one such incident: &lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12872179/6.tgz&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12872179/6.tgz&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16043741" author="apurva" created="Fri, 9 Jun 2017 00:50:17 +0000"  >&lt;p&gt;Incriminating evidence from the logs.&lt;/p&gt;

&lt;p&gt;1. Tail of the transaction log is PrepareCommit at offset 277&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;offset: 276 position: 46886 CreateTime: 1496957141444 isvalid: true keysize: 29 valuesize: 95 magic: 2 compresscodec: NONE producerId: -1 sequence: -1 isTransactional: false headerKeys: [] key: transactionalId=my-first-transactional-id payload: producerId:2000,producerEpoch:0,state=Ongoing,partitions=Set(output-topic-2, __consumer_offsets-47, output-topic-0, output-topic-1),lastUpdateTimestamp=1496957141444
offset: 277 position: 47080 CreateTime: 1496957141285 isvalid: true keysize: 29 valuesize: 95 magic: 2 compresscodec: NONE producerId: -1 sequence: -1 isTransactional: false headerKeys: [] key: transactionalId=my-first-transactional-id payload: producerId:2000,producerEpoch:0,state=PrepareCommit,partitions=Set(output-topic-2, __consumer_offsets-47, output-topic-0, output-topic-1),lastUpdateTimestamp=1496957141285
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;2. The client disconnected from the coordinator after sending the EndTxn request, and got &apos;CONCURRENT_TRANSACTIONS&apos; on retry.&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[2017-06-08 21:25:41,474] TRACE Produced messages to topic-partition output-topic-2 with base offset offset 28618 and error: null. (org.apache.kafka.clients.producer.internals.ProducerBatch)
[2017-06-08 21:25:41,474] TRACE [TransactionalId my-first-transactional-id] Request (type=EndTxnRequest, transactionalId=my-first-transactional-id, producerId=2000, producerEpoch=0, result=COMMIT) dequeued for sending (org.apache.kafka.clients.producer.internals.TransactionManager)
[2017-06-08 21:25:41,474] DEBUG [TransactionalId my-first-transactional-id] Sending transactional request (type=EndTxnRequest, transactionalId=my-first-transactional-id, producerId=2000, producerEpoch=0, result=COMMIT) to node worker12:9092 (id: 3 rack: null) (org.apache.kafka.clients.producer.internals.Sender)
[2017-06-08 21:26:11,533] DEBUG [TransactionalId my-first-transactional-id] Disconnected from 3. Will retry. (org.apache.kafka.clients.producer.internals.TransactionManager)
[2017-06-08 21:26:11,533] DEBUG [TransactionalId my-first-transactional-id] Enqueuing transactional request (type=FindCoordinatorRequest, coordinatorKey=my-first-transactional-id, coordinatorType=TRANSACTION) (org.apache.kafka.clients.producer.internals.TransactionManager)
[2017-06-08 21:26:11,533] DEBUG [TransactionalId my-first-transactional-id] Enqueuing transactional request (type=EndTxnRequest, transactionalId=my-first-transactional-id, producerId=2000, producerEpoch=0, result=COMMIT) (org.apache.kafka.clients.producer.internals.TransactionManager)
[2017-06-08 21:26:11,533] TRACE [TransactionalId my-first-transactional-id] Request (type=FindCoordinatorRequest, coordinatorKey=my-first-transactional-id, coordinatorType=TRANSACTION) dequeued for sending (org.apache.kafka.clients.producer.internals.TransactionManager)
[2017-06-08 21:26:11,534] DEBUG [TransactionalId my-first-transactional-id] Sending transactional request (type=FindCoordinatorRequest, coordinatorKey=my-first-transactional-id, coordinatorType=TRANSACTION) to node worker5:9092 (id: 2 rack: null) (org.apache.kafka.clients.producer.internals.Sender)
[2017-06-08 21:26:11,535] TRACE [TransactionalId my-first-transactional-id] Received transactional response FindCoordinatorResponse(throttleTimeMs=0, errorMessage=&apos;null&apos;, error=NONE, node=worker12:9092 (id: 3 rack: null)) for request (type=FindCoordinatorRequest, coordinatorKey=my-first-transactional-id, coordinatorType=TRANSACTION) (org.apache.kafka.clients.producer.internals.TransactionManager)
[2017-06-08 21:26:11,535] TRACE [TransactionalId my-first-transactional-id] Request (type=EndTxnRequest, transactionalId=my-first-transactional-id, producerId=2000, producerEpoch=0, result=COMMIT) dequeued for sending (org.apache.kafka.clients.producer.internals.TransactionManager)
[2017-06-08 21:26:11,535] DEBUG [TransactionalId my-first-transactional-id] Disconnect from worker12:9092 (id: 3 rack: null) while trying to send request (type=EndTxnRequest, transactionalId=my-first-transactional-id, producerId=2000, producerEpoch=0, result=COMMIT). Going to back off and retry (org.apache.kafka.clients.producer.internals.Sender)
[2017-06-08 21:26:11,535] DEBUG [TransactionalId my-first-transactional-id] Enqueuing transactional request (type=FindCoordinatorRequest, coordinatorKey=my-first-transactional-id, coordinatorType=TRANSACTION) (org.apache.kafka.clients.producer.internals.TransactionManager)
[2017-06-08 21:26:11,535] DEBUG [TransactionalId my-first-transactional-id] Enqueuing transactional request (type=EndTxnRequest, transactionalId=my-first-transactional-id, producerId=2000, producerEpoch=0, result=COMMIT) (org.apache.kafka.clients.producer.internals.TransactionManager)
[2017-06-08 21:26:11,636] TRACE [TransactionalId my-first-transactional-id] Request (type=FindCoordinatorRequest, coordinatorKey=my-first-transactional-id, coordinatorType=TRANSACTION) dequeued for sending (org.apache.kafka.clients.producer.internals.TransactionManager)
[2017-06-08 21:26:11,636] DEBUG [TransactionalId my-first-transactional-id] Sending transactional request (type=FindCoordinatorRequest, coordinatorKey=my-first-transactional-id, coordinatorType=TRANSACTION) to node worker1:9092 (id: 1 rack: null) (org.apache.kafka.clients.producer.internals.Sender)
[2017-06-08 21:26:11,637] TRACE [TransactionalId my-first-transactional-id] Received transactional response FindCoordinatorResponse(throttleTimeMs=0, errorMessage=&apos;null&apos;, error=NONE, node=worker12:9092 (id: 3 rack: null)) for request (type=FindCoordinatorRequest, coordinatorKey=my-first-transactional-id, coordinatorType=TRANSACTION) (org.apache.kafka.clients.producer.internals.TransactionManager)
[2017-06-08 21:26:11,637] TRACE [TransactionalId my-first-transactional-id] Request (type=EndTxnRequest, transactionalId=my-first-transactional-id, producerId=2000, producerEpoch=0, result=COMMIT) dequeued for sending (org.apache.kafka.clients.producer.internals.TransactionManager)
[2017-06-08 21:26:11,739] DEBUG [TransactionalId my-first-transactional-id] Sending transactional request (type=EndTxnRequest, transactionalId=my-first-transactional-id, producerId=2000, producerEpoch=0, result=COMMIT) to node worker12:9092 (id: 3 rack: null) (org.apache.kafka.clients.producer.internals.Sender)
[2017-06-08 21:26:11,739] TRACE [TransactionalId my-first-transactional-id] Received transactional response EndTxnResponse(error=CONCURRENT_TRANSACTIONS, throttleTimeMs=0) for request (type=EndTxnRequest, transactionalId=my-first-transactional-id, producerId=2000, producerEpoch=0, result=COMMIT) (org.apache.kafka.clients.producer.internals.TransactionManager)
[2017-06-08 21:26:11,739] DEBUG [TransactionalId my-first-transactional-id] Enqueuing transactional request (type=EndTxnRequest, transactionalId=my-first-transactional-id, producerId=2000, producerEpoch=0, result=COMMIT) (org.apache.kafka.clients.producer.internals.TransactionManager)
[2017-06-08 21:26:11,739] TRACE [TransactionalId my-first-transactional-id] Request (type=EndTxnRequest, transactionalId=my-first-transactional-id, producerId=2000, producerEpoch=0, result=COMMIT) dequeued for sending (org.apache.kafka.clients.producer.internals.TransactionManager)
[2017-06-08 21:26:11,840] DEBUG [TransactionalId my-first-transactional-id] Sending transactional request (type=EndTxnRequest, transactionalId=my-first-transactional-id, producerId=2000, producerEpoch=0, result=COMMIT) to node worker12:9092 (id: 3 rack: null) (org.apache.kafka.clients.producer.internals.Sender)
[2017-06-08 21:26:11,840] TRACE [TransactionalId my-first-transactional-id] Received transactional response EndTxnResponse(error=CONCURRENT_TRANSACTIONS, throttleTimeMs=0) for request (type=EndTxnRequest, transactionalId=my-first-transactional-id, producerId=2000, producerEpoch=0, result=COMMIT) (org.apache.kafka.clients.producer.internals.TransactionManager)
[2017-06-08 21:26:11,840] DEBUG [TransactionalId my-first-transactional-id] Enqueuing transactional request (type=EndTxnRequest, transactionalId=my-first-transactional-id, producerId=2000, producerEpoch=0, result=COMMIT) (org.apache.kafka.clients.producer.internals.TransactionManager)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;3. Last message in the coordinator for the transactional id in question indicates a transition to PrepareCommit&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[2017-06-08 21:25:41,449] DEBUG [Transaction Log Manager 3]: Updating my-first-transactional-id&apos;s transaction state to TxnTransitMetadata(producerId=2000, producerEpoch=0, txnTimeoutMs=60000, txnState=Ongoing, topicPartitions=Set(output-topic-2, __consumer_offsets-47, output-topic-0, output-topic-1), txnStartTimestamp=1496957141430, txnLastUpdateTimestamp=1496957141444) with coordinator epoch 3 for my-first-transactional-id succeeded (kafka.coordinator.transaction.TransactionStateManager)
[2017-06-08 21:25:41,285] DEBUG TransactionalId my-first-transactional-id prepare transition from Ongoing to TxnTransitMetadata(producerId=2000, producerEpoch=0, txnTimeoutMs=60000, txnState=PrepareCommit, topicPartitions=Set(output-topic-2, __consumer_offsets-47, output-topic-0, output-topic-1), txnStartTimestamp=1496957141430, txnLastUpdateTimestamp=1496957141285) (kafka.coordinator.transaction.TransactionMetadata)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;4. The high water mark for the transaction log partition was updated to 278, indicating that the append callback must have been invoked.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[2017-06-08 21:25:41,291] DEBUG Partition [__transaction_state,41] on broker 3: Recorded replica 2 log end offset (LEO) position 278 for partition __transaction_state-41. (kafka.cluster.Partition)
[2017-06-08 21:25:41,291] DEBUG Partition [__transaction_state,41] on broker 3: High watermark for partition [__transaction_state,41] updated to 278 [0 : 47274] (kafka.cluster.Partition)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16043758" author="apurva" created="Fri, 9 Jun 2017 01:12:25 +0000"  >&lt;p&gt;The interesting thing is that it reproduces consistently on jenkins only when it is part of a multi test run. Running this test in isolation makes it look stable.&lt;/p&gt;</comment>
                            <comment id="16044861" author="apurva" created="Fri, 9 Jun 2017 19:01:01 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; has found the bug and will file the PR. Assigning to him.&lt;/p&gt;</comment>
                            <comment id="16044885" author="guozhang" created="Fri, 9 Jun 2017 19:32:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=apurva&quot; class=&quot;user-hover&quot; rel=&quot;apurva&quot;&gt;apurva&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hachikuji&quot; class=&quot;user-hover&quot; rel=&quot;hachikuji&quot;&gt;hachikuji&lt;/a&gt; The root cause for &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5416&quot; title=&quot;TransactionCoordinator doesn&amp;#39;t complete transition to CompleteCommit&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-5416&quot;&gt;&lt;del&gt;KAFKA-5416&lt;/del&gt;&lt;/a&gt; (not this JIRA, but I&apos;d still just keep it here for the record) is in a couple folds:&lt;/p&gt;

&lt;p&gt;1) First in &lt;tt&gt;TransactionStateManager#appendTransactionToLog&lt;/tt&gt;, when we received an error while trying to append to log (in our case it is `NotEnoughReplicas`), we will reset the pending state: &lt;tt&gt;metadata.pendingState = None&lt;/tt&gt;. This behavior is correct for all its callers EXCEPT the one from &lt;tt&gt;TransactionMarkerChannelManager#tryAppendToLog&lt;/tt&gt;, in which &lt;tt&gt;appendCallback&lt;/tt&gt; will retry appending again but this time the pending state has been reset.&lt;/p&gt;

&lt;p&gt;So when the retry finally succeed, it will call &lt;tt&gt;TransactionMetadata#completeTransitionTo&lt;/tt&gt; we will throw an exception since the pending state is `None`.&lt;/p&gt;

&lt;p&gt;2) This exception is thrown all the way to &lt;tt&gt;KafkaApi#handleFetchRequest&lt;/tt&gt;, because it is the thread that handles the follower fetch request, and then increment the HW, and then call &lt;tt&gt;tryCompleteDelayedRequests&lt;/tt&gt; which will throw the exception. This exception will be handled in &lt;tt&gt;handleError&lt;/tt&gt;, in which we print an error logging but this is usually not shown since in &lt;tt&gt;log4j.properties&lt;/tt&gt; we commented out &lt;tt&gt;KafkaApis&lt;/tt&gt; class, and simply returns an UNKNOWN error to the follower fetcher. And hence from the logs it is a mystery that it seems the callback was not called; in fact it did get called by throw an exception that get silently swallowed.&lt;/p&gt;

&lt;p&gt;The key log entries the disclose this is in worker7: &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;[2017-06-09 01:16:54,132] DEBUG Partition [__transaction_state,37] on broker 1: High watermark &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition [__transaction_state,37] updated to 86 [0 : 14667] (kafka.cluster.Partition)
[2017-06-09 01:16:54,132] DEBUG [Replica Manager on Broker 1]: Request key __transaction_state-37 unblocked 0 fetch requests. (kafka.server.ReplicaManager)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Note it does not have any &quot;unblocked x produce requests&quot; after &quot;unblocked 0 fetch requests&quot;, while in &lt;tt&gt;tryCompleteDelayedRequests&lt;/tt&gt; we always try to complete fetch, then produce, then delete requests; and in worker2:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;[2017-06-09 01:16:54,136] ERROR [ReplicaFetcherThread-0-1]: Error &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition [__consumer_offsets,22] to broker 1:org.apache.kafka.common.errors.UnknownServerException: The server experienced an unexpected error when processing the request (kafka.server.ReplicaFetcherThread)
[2017-06-09 01:16:54,136] ERROR [ReplicaFetcherThread-0-1]: Error &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition [__consumer_offsets,8] to broker 1:org.apache.kafka.common.errors.UnknownServerException: The server experienced an unexpected error when processing the request (kafka.server.ReplicaFetcherThread)
[2017-06-09 01:16:54,137] ERROR [ReplicaFetcherThread-0-1]: Error &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition [__consumer_offsets,21] to broker 1:org.apache.kafka.common.errors.UnknownServerException: The server experienced an unexpected error when processing the request (kafka.server.ReplicaFetcherThread)
[2017-06-09 01:16:54,137] ERROR [ReplicaFetcherThread-0-1]: Error &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition [__consumer_offsets,4] to broker 1:org.apache.kafka.common.errors.UnknownServerException: The server experienced an unexpected error when processing the request (kafka.server.ReplicaFetcherThread)
[2017-06-09 01:16:54,137] ERROR [ReplicaFetcherThread-0-1]: Error &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition [__consumer_offsets,7] to broker 1:org.apache.kafka.common.errors.UnknownServerException: The server experienced an unexpected error when processing the request (kafka.server.ReplicaFetcherThread)
[2017-06-09 01:16:54,137] ERROR [ReplicaFetcherThread-0-1]: Error &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition [__consumer_offsets,9] to broker 1:org.apache.kafka.common.errors.UnknownServerException: The server experienced an unexpected error when processing the request (kafka.server.ReplicaFetcherThread)
[2017-06-09 01:16:54,137] ERROR [ReplicaFetcherThread-0-1]: Error &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition [__consumer_offsets,46] to broker 1:org.apache.kafka.common.errors.UnknownServerException: The server experienced an unexpected error when processing the request (kafka.server.ReplicaFetcherThread)
[2017-06-09 01:16:54,137] ERROR [ReplicaFetcherThread-0-1]: Error &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition [__consumer_offsets,25] to broker 1:org.apache.kafka.common.errors.UnknownServerException: The server experienced an unexpected error when processing the request (kafka.server.ReplicaFetcherThread)
[2017-06-09 01:16:54,137] ERROR [ReplicaFetcherThread-0-1]: Error &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition [__consumer_offsets,35] to broker 1:org.apache.kafka.common.errors.UnknownServerException: The server experienced an unexpected error when processing the request (kafka.server.ReplicaFetcherThread)
[2017-06-09 01:16:54,137] ERROR [ReplicaFetcherThread-0-1]: Error &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition [__consumer_offsets,41] to broker 1:org.apache.kafka.common.errors.UnknownServerException: The server experienced an unexpected error when processing the request (kafka.server.ReplicaFetcherThread)
[2017-06-09 01:16:54,137] ERROR [ReplicaFetcherThread-0-1]: Error &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition [__consumer_offsets,33] to broker 1:org.apache.kafka.common.errors.UnknownServerException: The server experienced an unexpected error when processing the request (kafka.server.ReplicaFetcherThread)
[2017-06-09 01:16:54,137] ERROR [ReplicaFetcherThread-0-1]: Error &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition [__consumer_offsets,23] to broker 1:org.apache.kafka.common.errors.UnknownServerException: The server experienced an unexpected error when processing the request (kafka.server.ReplicaFetcherThread)
[2017-06-09 01:16:54,138] ERROR [ReplicaFetcherThread-0-1]: Error &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition [__consumer_offsets,49] to broker 1:org.apache.kafka.common.errors.UnknownServerException: The server experienced an unexpected error when processing the request (kafka.server.ReplicaFetcherThread)
......
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It is the error code that &lt;tt&gt;handleError&lt;/tt&gt; decided to sent back while silently swallowed the exception.&lt;/p&gt;</comment>
                            <comment id="16045051" author="apurva" created="Fri, 9 Jun 2017 21:21:28 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt;&apos;s explanation above actually applies to &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5416&quot; title=&quot;TransactionCoordinator doesn&amp;#39;t complete transition to CompleteCommit&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-5416&quot;&gt;&lt;del&gt;KAFKA-5416&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="16045151" author="apurva" created="Fri, 9 Jun 2017 22:39:46 +0000"  >&lt;p&gt;The problem here seem to be this check: &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/core/src/main/scala/kafka/coordinator/transaction/TransactionMetadata.scala#L288&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/trunk/core/src/main/scala/kafka/coordinator/transaction/TransactionMetadata.scala#L288&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I noticed that the system clock time rolled back slightly during the processing of this transaction, and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hachikuji&quot; class=&quot;user-hover&quot; rel=&quot;hachikuji&quot;&gt;hachikuji&lt;/a&gt; noticed this check.&lt;/p&gt;

&lt;p&gt;What this amounts to is that the operation to complete the state transition will fail in the DelayedFetch operation, and the exception would be swallowed. The Pending state would not be cleared, and future EndTxnRequests would fail with a CONCURRENT_TRANSACTIONS exception.&lt;/p&gt;</comment>
                            <comment id="16045162" author="apurva" created="Fri, 9 Jun 2017 22:47:15 +0000"  >&lt;p&gt;The last successful metadata update was the following. The update timestamp was 1496957141444.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[2017-06-08 21:25:41,449] DEBUG TransactionalId my-first-transactional-id complete transition from Ongoing to TxnTransitMetadata(producerId=2000, producerEpoch=0, txnTimeoutMs=60000, txnState=Ongoing, topicPartitions=Set(output-topic-2, __consumer_offsets-47, output-topic-0, output-topic-1), txnStartTimestamp=1496957141430, txnLastUpdateTimestamp=1496957141444) (kafka.coordinator.transaction.TransactionMetadata)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;then the system clock rolled back by a couple of hundred milliseconds, and the &apos;prepare transition&apos; to &apos;PrepareCommit&apos; had this transition metadata, with an update time of 1496957141285&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[2017-06-08 21:25:41,285] DEBUG TransactionalId my-first-transactional-id prepare transition from Ongoing to TxnTransitMetadata(producerId=2000, producerEpoch=0, txnTimeoutMs=60000, txnState=PrepareCommit, topicPartitions=Set(output-topic-2, __consumer_offsets-47, output-topic-0, output-topic-1), txnStartTimestamp=1496957141430, txnLastUpdateTimestamp=1496957141285) (kafka.coordinator.transaction.TransactionMetadata)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So when it came time to complete the transition, the timestamp check would fail because the new update timestamp was older than the previous one. We wolud throw an illegalStateException, which would be caught and swallowed in the delayed fetch operation, hence leving the transaction hanging with a pendingState of PrepareCommit.&lt;/p&gt;
</comment>
                            <comment id="16045170" author="githubbot" created="Fri, 9 Jun 2017 22:53:55 +0000"  >&lt;p&gt;GitHub user apurvam opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/3286&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3286&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5415&quot; title=&quot;TransactionCoordinator doesn&amp;#39;t complete transition to PrepareCommit state&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-5415&quot;&gt;&lt;del&gt;KAFKA-5415&lt;/del&gt;&lt;/a&gt;: Remove timestamp check in completeTransitionTo&lt;/p&gt;

&lt;p&gt;    This assertion is hard to get right because the system time can roll backward on a host due to NTP (as shown in the ticket), and also because a transaction can start on one host and complete on another. Getting precise clock times across hosts is virtually impossible, and this check makes things fragile.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/apurvam/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apurvam/kafka&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5415&quot; title=&quot;TransactionCoordinator doesn&amp;#39;t complete transition to PrepareCommit state&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-5415&quot;&gt;&lt;del&gt;KAFKA-5415&lt;/del&gt;&lt;/a&gt;-avoid-timestamp-check-in-completeTransition&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/3286.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3286.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #3286&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit ccf5217d5a5985e7e88b2794c5fe43ff5b1d8a58&lt;br/&gt;
Author: Apurva Mehta &amp;lt;apurva@confluent.io&amp;gt;&lt;br/&gt;
Date:   2017-06-09T22:51:31Z&lt;/p&gt;

&lt;p&gt;    Remove timestamp check in completeTransitionTo&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16045251" author="hachikuji" created="Sat, 10 Jun 2017 00:09:05 +0000"  >&lt;p&gt;Issue resolved by pull request 3286&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/kafka/pull/3286&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3286&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16045252" author="githubbot" created="Sat, 10 Jun 2017 00:09:40 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/3286&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3286&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12872179" name="6.tgz" size="12004600" author="apurva" created="Fri, 9 Jun 2017 00:36:07 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 23 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3g2e7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>