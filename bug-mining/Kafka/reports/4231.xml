<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:43:21 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-19397] TransactionManager.handleCompletedBatch throws NPE</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-19397</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Sometimes, current trunk throws the following NPE:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[2025-05-29 04:06:05,855] ERROR [kafka-producer-network-thread | i-07bbab180f6062ba3-StreamThread-3-producer] [Producer clientId=i-07bbab180f6062ba3-StreamThread-3-producer] Uncaught error in request completion: (org.apache.kafka.clients.NetworkClient)
java.lang.NullPointerException: Cannot read field &lt;span class=&quot;code-quote&quot;&gt;&quot;topicPartition&quot;&lt;/span&gt; because &lt;span class=&quot;code-quote&quot;&gt;&quot;batch&quot;&lt;/span&gt; is &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
at org.apache.kafka.clients.producer.internals.TransactionManager.handleCompletedBatch(TransactionManager.java:748)
at org.apache.kafka.clients.producer.internals.Sender.completeBatch(Sender.java:736)
at org.apache.kafka.clients.producer.internals.Sender.completeBatch(Sender.java:710)
at org.apache.kafka.clients.producer.internals.Sender.lambda$handleProduceResponse$2(Sender.java:613)
at java.base/java.util.ArrayList.forEach(ArrayList.java:1511)
at org.apache.kafka.clients.producer.internals.Sender.lambda$handleProduceResponse$3(Sender.java:597)
at java.base/java.lang.Iterable.forEach(Iterable.java:75)
at org.apache.kafka.clients.producer.internals.Sender.handleProduceResponse(Sender.java:597)
at org.apache.kafka.clients.producer.internals.Sender.lambda$sendProduceRequest$9(Sender.java:895)
at org.apache.kafka.clients.ClientResponse.onComplete(ClientResponse.java:154)
at org.apache.kafka.clients.NetworkClient.completeResponses(NetworkClient.java:669)
at org.apache.kafka.clients.NetworkClient.poll(NetworkClient.java:661)
at org.apache.kafka.clients.producer.internals.Sender.runOnce(Sender.java:340)
at org.apache.kafka.clients.producer.internals.Sender.run(Sender.java:242)
at java.base/java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:840)
&#160;
&#160;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;This was discovered in a long-running test, so we do not have a directly reproducible test case. However, DEBUG logs are included below, which show the sequence of METADATA and PRODUCE requests / responses that seem to cause this.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Likely cause is the change here: &lt;a href=&quot;https://github.com/apache/kafka/pull/15968&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/15968&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13620540">KAFKA-19397</key>
            <summary>TransactionManager.handleCompletedBatch throws NPE</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="omnia_h_ibrahim">Omnia Ibrahim</assignee>
                                    <reporter username="lucasbru">Lucas Brutschy</reporter>
                        <labels>
                    </labels>
                <created>Tue, 10 Jun 2025 11:56:44 +0000</created>
                <updated>Mon, 7 Jul 2025 11:56:19 +0000</updated>
                            <resolved>Mon, 7 Jul 2025 11:56:19 +0000</resolved>
                                    <version>4.1.0</version>
                                    <fixVersion>4.1.0</fixVersion>
                                    <component>clients</component>
                    <component>producer </component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="17973501" author="JIRAUSER302322" created="Fri, 13 Jun 2025 13:41:21 +0000"  >&lt;p&gt;Note that there is some further analysis in the comments of &lt;a href=&quot;https://github.com/apache/kafka/pull/15968&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/15968&lt;/a&gt; - This problem seems to occur if topics are deleted and recreated, or during rebootstrap of the client.&lt;/p&gt;

&lt;p&gt;For Kafka Streams, this NPE is fatal, since it will cause the producer to get stuck here:&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&#160; &#160; at java.util.concurrent.locks.LockSupport.park(java.base@17.0.12/LockSupport.java:211)
&#160; &#160; at java.util.concurrent.locks.AbstractQueuedSynchronizer.acquire(java.base@17.0.12/AbstractQueuedSynchronizer.java:715)
&#160; &#160; at java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireSharedInterruptibly(java.base@17.0.12/AbstractQueuedSynchronizer.java:1047)
&#160; &#160; at java.util.concurrent.CountDownLatch.await(java.base@17.0.12/CountDownLatch.java:230)
&#160; &#160; at org.apache.kafka.clients.producer.internals.ProduceRequestResult.await(ProduceRequestResult.java:76)
&#160; &#160; at org.apache.kafka.clients.producer.internals.RecordAccumulator.awaitFlushCompletion(RecordAccumulator.java:1075)
&#160; &#160; at org.apache.kafka.clients.producer.KafkaProducer.flush(KafkaProducer.java:1325)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;So one after the other, all stream instances come get stuck during flush until no progress is being made anymore.&lt;/p&gt;</comment>
                            <comment id="17986425" author="mimaison" created="Thu, 26 Jun 2025 17:19:21 +0000"  >&lt;p&gt;This is marked as a blocker for 4.1.0. Is that really the case? If so how close are we from a fix?&lt;/p&gt;</comment>
                            <comment id="17986430" author="chia7712" created="Thu, 26 Jun 2025 17:32:41 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mimaison&quot; class=&quot;user-hover&quot; rel=&quot;mimaison&quot;&gt;mimaison&lt;/a&gt; this error could be reproduced if we delete and then create a topic with the same name. Hence, it should be a blocker. The patch is almost ready. &lt;/p&gt;</comment>
                            <comment id="17986432" author="mimaison" created="Thu, 26 Jun 2025 17:35:37 +0000"  >&lt;p&gt;Great, thanks!&lt;/p&gt;</comment>
                            <comment id="18001349" author="JIRAUSER310223" created="Sun, 6 Jul 2025 23:55:36 +0000"  >&lt;p&gt;Hi ,&lt;/p&gt;

&lt;p&gt;I&apos;d like to work on this, but might need some pointers and more details to work on this.&lt;/p&gt;

&lt;p&gt;Shall I assign this to me then?&lt;/p&gt;</comment>
                            <comment id="18001398" author="JIRAUSER302322" created="Mon, 7 Jul 2025 07:24:19 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=johnedu&quot; class=&quot;user-hover&quot; rel=&quot;johnedu&quot;&gt;johnedu&lt;/a&gt;&#160; Thanks for the offer, but this was fixed on Friday&lt;/p&gt;

&lt;p&gt;The ticket is still open since it needs to be cherry-picked to 4.1&lt;/p&gt;</comment>
                            <comment id="18001726" author="chia7712" created="Mon, 7 Jul 2025 08:19:47 +0000"  >&lt;p&gt;I will complete the backport today. That was a bit delayed since branch 4.1 is excluded by our CI. Therefore, we&apos;ll merge the &lt;a href=&quot;https://github.com/apache/kafka/pull/20112&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/20112&lt;/a&gt; first and then run the CI for backport :_&lt;/p&gt;</comment>
                            <comment id="18003493" author="chia7712" created="Mon, 7 Jul 2025 11:56:19 +0000"  >&lt;p&gt;trunk:&lt;a href=&quot;https://github.com/apache/kafka/commit/9df616da76b3db01fdd2fbe0ba8df45d73d9b969&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/commit/9df616da76b3db01fdd2fbe0ba8df45d73d9b969&lt;/a&gt;&lt;br/&gt;
4.1: &lt;a href=&quot;https://github.com/apache/kafka/commit/e6b78ae9e5b31e9ffb8ceadab413f68137f9287c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/commit/e6b78ae9e5b31e9ffb8ceadab413f68137f9287c&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13076917" name="streams.log" size="164177" author="lucasbru" created="Tue, 10 Jun 2025 11:57:43 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            18 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1w9nc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>