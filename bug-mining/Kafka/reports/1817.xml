<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:06:39 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-4750] KeyValueIterator returns null values</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-4750</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;The API for ReadOnlyKeyValueStore.range method promises the returned iterator will not return null values. However, after upgrading from 0.10.0.0 to 0.10.1.1 we found null values are returned causing NPEs on our side.&lt;/p&gt;

&lt;p&gt;I found this happens after removing entries from the store and I found resemblance to &lt;a href=&quot;https://issues.apache.org/jira/browse/SAMZA-94&quot; title=&quot;State management kv-store delete() does not remove key&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SAMZA-94&quot;&gt;&lt;del&gt;SAMZA-94&lt;/del&gt;&lt;/a&gt; defect. The problem seems to be as it was there, when deleting entries and having a serializer that does not return null when null is passed in, the state store doesn&apos;t actually delete that key/value pair but the iterator will return null value for that key.&lt;/p&gt;

&lt;p&gt;When I modified our serilizer to return null when null is passed in, the problem went away. However, I believe this should be fixed in kafka streams, perhaps with a similar approach as &lt;a href=&quot;https://issues.apache.org/jira/browse/SAMZA-94&quot; title=&quot;State management kv-store delete() does not remove key&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SAMZA-94&quot;&gt;&lt;del&gt;SAMZA-94&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13041677">KAFKA-4750</key>
            <summary>KeyValueIterator returns null values</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="evis">Evgeny Veretennikov</assignee>
                                    <reporter username="mihbor">Michal Borowiecki</reporter>
                        <labels>
                            <label>newbie</label>
                    </labels>
                <created>Thu, 9 Feb 2017 11:58:10 +0000</created>
                <updated>Tue, 6 Feb 2018 21:21:25 +0000</updated>
                            <resolved>Tue, 6 Feb 2018 21:21:25 +0000</resolved>
                                    <version>0.10.1.1</version>
                    <version>0.10.2.1</version>
                    <version>0.11.0.0</version>
                                    <fixVersion>1.1.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="15930379" author="dminkovsky" created="Fri, 17 Mar 2017 17:53:25 +0000"  >&lt;p&gt;Can confirm I experienced this on 0.10.1 as well. &lt;/p&gt;</comment>
                            <comment id="16006486" author="dminkovsky" created="Thu, 11 May 2017 14:16:35 +0000"  >&lt;p&gt;Affects 0.10.2.1 also&lt;/p&gt;</comment>
                            <comment id="16061243" author="evis" created="Fri, 23 Jun 2017 17:16:01 +0000"  >&lt;p&gt;I guess, problem lies in &lt;tt&gt;KeyValueStore.delete()&lt;/tt&gt; implementations, which invoke &lt;tt&gt;put(key, null)&lt;/tt&gt; instead of actual deleting key-value pair. &lt;tt&gt;RocksDBStore&lt;/tt&gt; and &lt;tt&gt;ChangeLoggingKeyValueBytesStore&lt;/tt&gt; are implemented such way. So, I suggest just to fix these two &lt;tt&gt;delete()&lt;/tt&gt; implementations.&lt;/p&gt;

&lt;p&gt;Though, I don&apos;t quite understand, why did this scenario worked in 0.10.0.0... These &lt;tt&gt;delete()&lt;/tt&gt; methods didn&apos;t change in past.&lt;/p&gt;</comment>
                            <comment id="16061866" author="mjsax" created="Sat, 24 Jun 2017 08:55:49 +0000"  >&lt;p&gt;I just double check &lt;tt&gt;RocksDBStore&lt;/tt&gt; and the call chain is &lt;tt&gt;delete(key) -&amp;gt; put(key, null) -&amp;gt; putInternal(key, null)&lt;/tt&gt; with:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;private void putInternal(byte[] rawKey, byte[] rawValue) {
        if (rawValue == null) {
            try {
                db.delete(wOptions, rawKey);
            } catch (RocksDBException e) {
                throw new ProcessorStateException(&quot;Error while removing key &quot; + serdes.keyFrom(rawKey) +
                        &quot; from store &quot; + this.name, e);
            }
        } else {
 // ...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Also not, that &lt;tt&gt;ChangeLoggingKeyValueBytesStore&lt;/tt&gt; has similar behavior: &lt;tt&gt;delete(key) -&amp;gt; put(key, null) -&amp;gt; inner.put(key, null) / changeLogger.put(key,null)&lt;/tt&gt; &amp;#8211; as &lt;tt&gt;ChangeLoggingKeyValueBytesStore&lt;/tt&gt; wraps the actual store to just make sure the update is written to the changelog, the inner implementation &lt;tt&gt;inner.put(key,null)&lt;/tt&gt; should handle the &lt;tt&gt;null&lt;/tt&gt; value as a delete. Thus I am not sure what the actual root cause for this problem is.&lt;/p&gt;

&lt;p&gt;As you mentioned that it worked in 0.10.0, it might be related to the KTable cache. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mihbor&quot; class=&quot;user-hover&quot; rel=&quot;mihbor&quot;&gt;mihbor&lt;/a&gt; Can you try to disable caching to see if the issues goes away? This would support my theory and explain why it broke in 0.10.1. Was is the actual operation you are doing? Do you change any store default configs?&lt;/p&gt;</comment>
                            <comment id="16061898" author="evis" created="Sat, 24 Jun 2017 10:20:22 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mjsax&quot; class=&quot;user-hover&quot; rel=&quot;mjsax&quot;&gt;mjsax&lt;/a&gt;, are you sure about call chain in &lt;tt&gt;RocksDBStore&lt;/tt&gt;? Actually it is &lt;tt&gt;delete(key) -&amp;gt; put(key, null) -&amp;gt; putInternal(serdes.rawKey(key), serdes.rawValue(value)&lt;/tt&gt;. Check &lt;tt&gt;RocksDBStore.put()&lt;/tt&gt; method:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; void put(K key, V value) {
    Objects.requireNonNull(key, &lt;span class=&quot;code-quote&quot;&gt;&quot;key cannot be &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;&quot;&lt;/span&gt;);
    validateStoreOpen();
    &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] rawKey = serdes.rawKey(key);
    &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] rawValue = serdes.rawValue(value);
    putInternal(rawKey, rawValue);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So, &lt;tt&gt;delete()&lt;/tt&gt; doesn&apos;t actually delete key-value pair if &lt;tt&gt;serdes.rawValue(null)&lt;/tt&gt; doesn&apos;t return &lt;tt&gt;null&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;For example, look at attached test. Here store uses custom serde, which serializes null into not-null value &lt;tt&gt;&quot;123&quot;.getBytes()&lt;/tt&gt;. Test fails with current &lt;tt&gt;RocksDBStore.delete()&lt;/tt&gt; implementation and succeeds with such change:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;--- a/streams/src/main/java/org/apache/kafka/streams/state/internals/RocksDBStore.java
+++ b/streams/src/main/java/org/apache/kafka/streams/state/internals/RocksDBStore.java
@@ -301,7 +301,9 @@ public class RocksDBStore&amp;lt;K, V&amp;gt; implements KeyValueStore&amp;lt;K, V&amp;gt; {
     public synchronized V delete(K key) {
         Objects.requireNonNull(key, &quot;key cannot be null&quot;);
         V value = get(key);
-        put(key, null);
+        validateStoreOpen();
+        byte[] rawKey = serdes.rawKey(key);
+        putInternal(rawKey, null);
         return value;
     }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Though, in &lt;tt&gt;ChangeLoggingKeyValueBytesStore&lt;/tt&gt; this problem really doesn&apos;t appear, that was my mistake.&lt;/p&gt;</comment>
                            <comment id="16062112" author="mjsax" created="Sat, 24 Jun 2017 20:29:09 +0000"  >&lt;p&gt;Your observation is correct. I simplified the call chain. The question than is, it is a bug in the &lt;tt&gt;Serde&lt;/tt&gt; that it does not return &lt;tt&gt;null&lt;/tt&gt; if value is &lt;tt&gt;null&lt;/tt&gt;? Or should we just make Streams itself more robust and change &lt;tt&gt;byte[] rawValue = serdes.rawValue(value);&lt;/tt&gt; to &lt;tt&gt;byte[] rawValue = value == null ? null : serdes.rawValue(value);&lt;/tt&gt; ?&lt;/p&gt;</comment>
                            <comment id="16062384" author="guozhang" created="Sun, 25 Jun 2017 17:28:23 +0000"  >&lt;p&gt;I think the Streams library should not assume that either 1) the serde will always return &lt;tt&gt;null&lt;/tt&gt; if the input is &lt;tt&gt;null&lt;/tt&gt;, or 2) the serde will never return &lt;tt&gt;null&lt;/tt&gt; if the input is not &lt;tt&gt;null&lt;/tt&gt;. On the other hand, since we are treating &lt;tt&gt;null&lt;/tt&gt; to indicate deletion specifically, checking null values before calling the serde makes sense to me.&lt;/p&gt;
</comment>
                            <comment id="16062423" author="mjsax" created="Sun, 25 Jun 2017 21:12:39 +0000"  >&lt;p&gt;Sounds good to me.&lt;/p&gt;</comment>
                            <comment id="16062575" author="evis" created="Mon, 26 Jun 2017 06:29:43 +0000"  >&lt;p&gt;If we invoke &lt;tt&gt;store.put(key, value)&lt;/tt&gt;, and serdes returns null for value, shouldn&apos;t we throw NPE instead of deleting key from store? It seems counter-intuitive, that value here can be null, since null indicates, that no value found:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; value = ???; &lt;span class=&quot;code-comment&quot;&gt;// some value serialized to &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; by serde
&lt;/span&gt;store.put(key, value);
&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; value = store.get(key); &lt;span class=&quot;code-comment&quot;&gt;// returns &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, that seems like no value found&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Throwing exception inside &lt;tt&gt;put()&lt;/tt&gt; prevents from potential data loss.&lt;/p&gt;

&lt;p&gt;By the way, why does &lt;tt&gt;KeyValueStore.put()&lt;/tt&gt; method allows value to be null?&lt;/p&gt;</comment>
                            <comment id="16062770" author="mihbor" created="Mon, 26 Jun 2017 08:32:46 +0000"  >&lt;p&gt;Deserialiser.deserialize javadoc says:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;@param data serialized bytes; may be null; implementations are recommended to handle null by &lt;ins&gt;returning a value&lt;/ins&gt; or null rather than throwing an exception.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;If it&apos;s fair for deserializer to return a value when a null byte array is provided, by symmetry, the serializer should be able to return null when such an object is provided and achieve correct round-tripping.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=evis&quot; class=&quot;user-hover&quot; rel=&quot;evis&quot;&gt;evis&lt;/a&gt; In your example, whether its intuitive or not I guess it depends on peoples&apos; intuition. To me it is intuitive, since null on a changelog topic is a tombstone marker. If I serialize a value to null then to me it&apos;s intuitive that it&apos;s equivalent to deletion, so should not be found in the following get.&lt;/p&gt;

&lt;p&gt;An example use case would be if the value types are collections. In order to avoid dealing with nulls in the application layer, one might want to deserialize null into an empty collection and vice-versa. Would that be a valid use-case? I can&apos;t see why not, but I may be wrong.&lt;/p&gt;</comment>
                            <comment id="16062837" author="githubbot" created="Mon, 26 Jun 2017 09:26:53 +0000"  >&lt;p&gt;GitHub user evis opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/3430&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3430&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-4750&quot; title=&quot;KeyValueIterator returns null values&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-4750&quot;&gt;&lt;del&gt;KAFKA-4750&lt;/del&gt;&lt;/a&gt;: RocksDBStore always deletes null values&lt;/p&gt;

&lt;p&gt;    @guozhangwang @mjsax &lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/evis/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/evis/kafka&lt;/a&gt; rocksdbstore_null_values&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/3430.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3430.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #3430&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 47b4b2b2a5fe8af4ca4a60c2cae97dcab4e7eec3&lt;br/&gt;
Author: Evgeny Veretennikov &amp;lt;evg.veretennikov@gmail.com&amp;gt;&lt;br/&gt;
Date:   2017-06-26T09:21:35Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-4750&quot; title=&quot;KeyValueIterator returns null values&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-4750&quot;&gt;&lt;del&gt;KAFKA-4750&lt;/del&gt;&lt;/a&gt;: RocksDBStore always deletes null values&lt;/p&gt;

&lt;p&gt;    Deletion occurs even if serde serializes null value&lt;br/&gt;
    to non-null byte array.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16063945" author="guozhang" created="Mon, 26 Jun 2017 23:06:49 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mjsax&quot; class=&quot;user-hover&quot; rel=&quot;mjsax&quot;&gt;mjsax&lt;/a&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=evis&quot; class=&quot;user-hover&quot; rel=&quot;evis&quot;&gt;evis&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mihbor&quot; class=&quot;user-hover&quot; rel=&quot;mihbor&quot;&gt;mihbor&lt;/a&gt; Thanks for your comments. I would like to think a bit more on the general resolution for this case though before reviewing &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=evis&quot; class=&quot;user-hover&quot; rel=&quot;evis&quot;&gt;evis&lt;/a&gt;&apos;s patch:&lt;/p&gt;

&lt;p&gt;1. In Kafka messages, &quot;null&quot; byte arrays indicate tombstones, note that this means that if user&apos;s serde decide to serialize any objects into null for a log compacted topic (e.g. a changelog topic of a state store), it meant to delete the record from the store.&lt;/p&gt;

&lt;p&gt;2. In Kafka Streams state stores, we did NOT enforcing if &quot;null&quot; indicates deletion from the javadoc:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    /**
     * Update the value associated with &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; key
     *
     * @param key The key to associate the value to
     * @param value The value, it can be &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;.
     * @&lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; NullPointerException If &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; is used &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; key.
     */
    void put(K key, V value);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;However our implementation did treat value-typed &quot;null&quot; (note it is not &quot;null&quot; byte arrays as in serialized messages) as deletions, since we implement &lt;tt&gt;delete(key)&lt;/tt&gt; as &lt;tt&gt;put(key, null)&lt;/tt&gt;. As Evgeny / Michal mentioned, it is intuitive if our &lt;tt&gt;put&lt;/tt&gt; semantics aligned with Java&apos;s map operations:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;...  &lt;span class=&quot;code-comment&quot;&gt;// store initialized as empty
&lt;/span&gt;
store.get(key); &lt;span class=&quot;code-comment&quot;&gt;// returns &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
&lt;/span&gt;
store.put(key, value);
store.delete(key);
store.get(key);  &lt;span class=&quot;code-comment&quot;&gt;// returns &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
&lt;/span&gt;
store.put(key, value);
store.put(key, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);  &lt;span class=&quot;code-comment&quot;&gt;// we can interpret it as &lt;span class=&quot;code-quote&quot;&gt;&quot;associate the key with &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;&quot;&lt;/span&gt; or simply delete &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; key
&lt;/span&gt;store.get(key);  &lt;span class=&quot;code-comment&quot;&gt;// returns &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, though generally speaking it could indicate either the key is associated with value or the key does not exist&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Now assuming you have a customized serde that maps &quot;null&quot; object to &quot;not-null&quot; byte arrays, in this case the above would still hold:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;store.put(key, value);
store.put(key, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);  &lt;span class=&quot;code-comment&quot;&gt;// now &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;&quot;&lt;/span&gt; object is just a special value that &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; not indicate deletion
&lt;/span&gt;store.get(key);  &lt;span class=&quot;code-comment&quot;&gt;// returns &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, but &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; should be interpreted as &lt;span class=&quot;code-quote&quot;&gt;&quot;the key is associated with &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;&quot;&lt;/span&gt;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Now assuming you have a customized serde that maps &quot;not null&quot; object to &quot;null&quot; byte arrays, in this case the &quot;not-null&quot; object is really interpreted as a dummy value that the above still holds&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;store.put(key, value);
store.put(key, MY_DUMMY);  &lt;span class=&quot;code-comment&quot;&gt;// serialized into &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;&quot;&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt; arrays
&lt;/span&gt;store.get(key);  &lt;span class=&quot;code-comment&quot;&gt;// returns MY_DUMMY as &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;&quot;&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt; arrays is deserialized symmetrically&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So I think if we want to allow the above customized interpretation then we should not implement &lt;tt&gt;delete()&lt;/tt&gt; as &lt;tt&gt;put(key, null)&lt;/tt&gt; since &quot;null&quot; objects may not indicate deletions; if we want to be more restrict then we should emphasize that in the javadoc above that &quot;@param value The value, it can be null which indicates deletion of the key&quot;.&lt;/p&gt;

&lt;p&gt;WDYT?&lt;/p&gt;</comment>
                            <comment id="16063956" author="mjsax" created="Mon, 26 Jun 2017 23:16:31 +0000"  >&lt;p&gt;I think &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=damianguy&quot; class=&quot;user-hover&quot; rel=&quot;damianguy&quot;&gt;damianguy&lt;/a&gt; or &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=enothereska&quot; class=&quot;user-hover&quot; rel=&quot;enothereska&quot;&gt;enothereska&lt;/a&gt; can comment best in this. AFAIK, we use &lt;tt&gt;put(key,null)&lt;/tt&gt; with delete-semantics all over the place. Also for &lt;tt&gt;KTable&lt;/tt&gt; caches. As it align with changelog delete semantics I also think it does make sense to keep it this way. I would rather educate user that plug in Serde to not return &lt;tt&gt;null&lt;/tt&gt; if input is not &lt;tt&gt;null&lt;/tt&gt;. We can also add checks to all &lt;tt&gt;Serde&lt;/tt&gt; calls: (1) never call Serde for &lt;tt&gt;null&lt;/tt&gt; as we know it must be &lt;tt&gt;null&lt;/tt&gt; anyway (2) if we call Serde with not-null, make sure it does not return &lt;tt&gt;null&lt;/tt&gt; &amp;#8211; otherwise throw exception.&lt;/p&gt;</comment>
                            <comment id="16064473" author="evis" created="Tue, 27 Jun 2017 08:38:24 +0000"  >&lt;p&gt;If we don&apos;t implement &lt;tt&gt;delete()&lt;/tt&gt; as &lt;tt&gt;put(key, null)&lt;/tt&gt;, then how do we implement &lt;tt&gt;put(key, null)&lt;/tt&gt;? We can&apos;t save &lt;tt&gt;null&lt;/tt&gt; values in RocksDB. That&apos;s why yesterday I suggested to throw exception, if one invokes &lt;tt&gt;put(key, null)&lt;/tt&gt;. If we throw it, than for sure, we shouldn&apos;t call &lt;tt&gt;put(key, null)&lt;/tt&gt; inside &lt;tt&gt;delete()&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="16065155" author="guozhang" created="Tue, 27 Jun 2017 17:18:11 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=evis&quot; class=&quot;user-hover&quot; rel=&quot;evis&quot;&gt;evis&lt;/a&gt; Inside RocksDB store, after the serialization, if we get &quot;null&quot; byte arrays (NOTE it is not &quot;null&quot; object that gets passed into the API) then we should always treat it as a delete call; i.e. the current implementation inside RocksDB is ok:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void putInternal(&lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] rawKey, &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] rawValue) {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (rawValue == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
            &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                db.delete(wOptions, rawKey);
            } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (RocksDBException e) {
               ...
            }
        } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
            &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                db.put(wOptions, rawKey, rawValue);
            } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (RocksDBException e) {
                ...
            }
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The question is, on the API layer do we want to enforce &quot;null&quot; object to indicate deletion as well. Currently we are a bit vague in this, I was proposing two options and make it clear:&lt;/p&gt;

&lt;p&gt;1) Clarify in javadoc that null value in &lt;tt&gt;put(key, value)&lt;/tt&gt; indicates deletion; if it is &quot;null&quot; object by-pass the serde and send &quot;null&quot; bytes directly into inner functions and vice verse for deserialization; do not enforce user customized serdes how to handle null values since we are not going to call them with null values any more.&lt;/p&gt;

&lt;p&gt;2) Do NOT enforce in java doc that null value in &lt;tt&gt;put(key, value)&lt;/tt&gt; indicates deletion; implement all &lt;tt&gt;delete(key)&lt;/tt&gt; call directly throughout all the layers of stores instead of calling &lt;tt&gt;put(key, null)&lt;/tt&gt;; recommend user customized serdes to handle null values themselves.&lt;/p&gt;

&lt;p&gt;I am a bit inclined to the second option, and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mjsax&quot; class=&quot;user-hover&quot; rel=&quot;mjsax&quot;&gt;mjsax&lt;/a&gt; seem to be favoring the first option. And I&apos;d like to hear see how others think.&lt;/p&gt;</comment>
                            <comment id="16073360" author="evis" created="Tue, 4 Jul 2017 09:04:46 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=damianguy&quot; class=&quot;user-hover&quot; rel=&quot;damianguy&quot;&gt;damianguy&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=enothereska&quot; class=&quot;user-hover&quot; rel=&quot;enothereska&quot;&gt;enothereska&lt;/a&gt; what do you think about options offered by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="16093595" author="bbejeck" created="Wed, 19 Jul 2017 18:46:37 +0000"  >&lt;p&gt;Thanks for the clarification &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt;, my inclination is to go with the second option, as that seem more intuitive.&lt;/p&gt;</comment>
                            <comment id="16094308" author="damianguy" created="Thu, 20 Jul 2017 07:38:25 +0000"  >&lt;p&gt;I&apos;d go with the first option as i believe that was the original intention&lt;/p&gt;</comment>
                            <comment id="16094568" author="mjsax" created="Thu, 20 Jul 2017 11:45:29 +0000"  >&lt;p&gt;As mentioned above. I would go with option (1) as null delete semantics also align with changelog delete semantics. Also, if we would allow to put &lt;tt&gt;null&lt;/tt&gt; as regular value, we have the same issue as Java has in general: if a &lt;tt&gt;get&lt;/tt&gt; returns &lt;tt&gt;null&lt;/tt&gt; it&apos;s unclear if &lt;tt&gt;null&lt;/tt&gt; is a regular value or the key is just not there. Within Java (eg. &lt;tt&gt;HashMap&lt;/tt&gt;) you still can check with &lt;tt&gt;containsKey&lt;/tt&gt; but we don&apos;t have an API for this on the stores.&lt;/p&gt;</comment>
                            <comment id="16095052" author="guozhang" created="Thu, 20 Jul 2017 17:39:44 +0000"  >&lt;p&gt;I think technically I&apos;m convinced that option (1) should be a better approach, the only reason that I&apos;m a bit hesitant in that is as &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mihbor&quot; class=&quot;user-hover&quot; rel=&quot;mihbor&quot;&gt;mihbor&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=evis&quot; class=&quot;user-hover&quot; rel=&quot;evis&quot;&gt;evis&lt;/a&gt; discussed previously on this ticket that, for example:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;An example use &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; would be &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; the value types are collections. In order to avoid dealing with nulls in the application layer, one might want to deserialize &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; into an empty collection and vice-versa. Would that be a valid use-&lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt;? I can&apos;t see why not, but I may be wrong.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Or more generally are there any common and valid use cases where users do want to de-serde a not-null object into null bytes, or vice versa. Thinking about it a bit more, maybe enforcing &lt;tt&gt;null objects &amp;lt;---&amp;gt; null bytes (meaning deletion)&lt;/tt&gt; is not too bad since for such use cases above users can still use some other non-null sentinel byte values.&lt;/p&gt;</comment>
                            <comment id="16095776" author="mjsax" created="Fri, 21 Jul 2017 04:53:25 +0000"  >&lt;p&gt;I understand what you are saying, but encoding an empty collection into &lt;tt&gt;null&lt;/tt&gt; would not work after all, as if we write this to the changelog, it might get delete during compaction resulting in potential data loss. Thus, Streams is limited by the underlying broker semantics and thus, users need to encode empty collections as not-null value anyway.&lt;/p&gt;</comment>
                            <comment id="16097357" author="evis" created="Sat, 22 Jul 2017 15:01:50 +0000"  >&lt;p&gt;So, to sum up discussion. I should close current PR and create new PR with javadoc change, as &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; suggested. Am I right?&lt;/p&gt;</comment>
                            <comment id="16097368" author="mjsax" created="Sat, 22 Jul 2017 15:40:30 +0000"  >&lt;p&gt;IMHO, we can also improve the code by not calling the serializer in the first place if we get a &lt;tt&gt;put(key, null)&lt;/tt&gt;. Thus, we can insure that &lt;tt&gt;rawValue&lt;/tt&gt; will be &lt;tt&gt;null&lt;/tt&gt; even if the serializer might not return &lt;tt&gt;null&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="16098929" author="guozhang" created="Mon, 24 Jul 2017 18:14:28 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=evis&quot; class=&quot;user-hover&quot; rel=&quot;evis&quot;&gt;evis&lt;/a&gt; That is right, we can go with the first option above. Also as &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mjsax&quot; class=&quot;user-hover&quot; rel=&quot;mjsax&quot;&gt;mjsax&lt;/a&gt; mentioned we can enforce in the code that if the passed in value is `null` object for ser / bytes for deser, skip calling the serde and return the corresponding `null` bytes / object directly, besides stating it clearly in the javadoc.&lt;/p&gt;</comment>
                            <comment id="16349235" author="githubbot" created="Thu, 1 Feb 2018 20:44:53 +0000"  >&lt;p&gt;guozhangwang opened a new pull request #4508: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-4750&quot; title=&quot;KeyValueIterator returns null values&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-4750&quot;&gt;&lt;del&gt;KAFKA-4750&lt;/del&gt;&lt;/a&gt;: Bypass null value and treat it as deletes&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/4508&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/4508&lt;/a&gt;&lt;/p&gt;


&lt;ul&gt;
	&lt;li&gt;If the value is null, bypass the serde and treat it as deletes in the inner-most underlying store.&lt;/li&gt;
	&lt;li&gt;Update javadocs, add unit tests accordingly&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;   This is originally contributed by @evis.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16349240" author="githubbot" created="Thu, 1 Feb 2018 20:47:10 +0000"  >&lt;p&gt;guozhangwang closed pull request #3430: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-4750&quot; title=&quot;KeyValueIterator returns null values&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-4750&quot;&gt;&lt;del&gt;KAFKA-4750&lt;/del&gt;&lt;/a&gt;: RocksDBStore always deletes null values&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/3430&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3430&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/streams/src/main/java/org/apache/kafka/streams/state/internals/RocksDBStore.java b/streams/src/main/java/org/apache/kafka/streams/state/internals/RocksDBStore.java&lt;br/&gt;
index 70345927f24..528da666e6e 100644&lt;br/&gt;
&amp;#8212; a/streams/src/main/java/org/apache/kafka/streams/state/internals/RocksDBStore.java&lt;br/&gt;
+++ b/streams/src/main/java/org/apache/kafka/streams/state/internals/RocksDBStore.java&lt;br/&gt;
@@ -245,7 +245,7 @@ public synchronized void put(K key, V value) &lt;/p&gt;
{
         Objects.requireNonNull(key, &quot;key cannot be null&quot;);
         validateStoreOpen();
         byte[] rawKey = serdes.rawKey(key);
-        byte[] rawValue = serdes.rawValue(value);
+        byte[] rawValue = value == null ? null : serdes.rawValue(value);
         putInternal(rawKey, rawValue);
     }

&lt;p&gt;diff --git a/streams/src/test/java/org/apache/kafka/streams/state/internals/RocksDBStoreCustomNullSerdeTest.java b/streams/src/test/java/org/apache/kafka/streams/state/internals/RocksDBStoreCustomNullSerdeTest.java&lt;br/&gt;
new file mode 100644&lt;br/&gt;
index 00000000000..776747af211&lt;br/&gt;
&amp;#8212; /dev/null&lt;br/&gt;
+++ b/streams/src/test/java/org/apache/kafka/streams/state/internals/RocksDBStoreCustomNullSerdeTest.java&lt;br/&gt;
@@ -0,0 +1,84 @@&lt;br/&gt;
+/*&lt;br/&gt;
+ * Licensed to the Apache Software Foundation (ASF) under one or more&lt;br/&gt;
+ * contributor license agreements. See the NOTICE file distributed with&lt;br/&gt;
+ * this work for additional information regarding copyright ownership.&lt;br/&gt;
+ * The ASF licenses this file to You under the Apache License, Version 2.0&lt;br/&gt;
+ * (the &quot;License&quot;); you may not use this file except in compliance with&lt;br/&gt;
+ * the License. You may obtain a copy of the License at&lt;br/&gt;
+ *&lt;br/&gt;
+ *    &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
+ *&lt;br/&gt;
+ * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
+ * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
+ * See the License for the specific language governing permissions and&lt;br/&gt;
+ * limitations under the License.&lt;br/&gt;
+ */&lt;br/&gt;
+package org.apache.kafka.streams.state.internals;&lt;br/&gt;
+&lt;br/&gt;
+import org.apache.kafka.common.metrics.Metrics;&lt;br/&gt;
+import org.apache.kafka.common.serialization.Serde;&lt;br/&gt;
+import org.apache.kafka.common.serialization.Serdes;&lt;br/&gt;
+import org.apache.kafka.common.serialization.Serializer;&lt;br/&gt;
+import org.apache.kafka.common.serialization.StringSerializer;&lt;br/&gt;
+import org.apache.kafka.common.serialization.StringDeserializer;&lt;br/&gt;
+import org.apache.kafka.streams.KeyValue;&lt;br/&gt;
+import org.apache.kafka.streams.processor.internals.MockStreamsMetrics;&lt;br/&gt;
+import org.apache.kafka.streams.state.KeyValueIterator;&lt;br/&gt;
+import org.apache.kafka.test.MockProcessorContext;&lt;br/&gt;
+import org.apache.kafka.test.NoOpRecordCollector;&lt;br/&gt;
+import org.apache.kafka.test.TestUtils;&lt;br/&gt;
+import org.junit.After;&lt;br/&gt;
+import org.junit.Assert;&lt;br/&gt;
+import org.junit.Before;&lt;br/&gt;
+import org.junit.Test;&lt;br/&gt;
+&lt;br/&gt;
+/**&lt;br/&gt;
+ * Test checks RocksDBStore behaviour with serializer, which&lt;br/&gt;
+ * serializes null value into non-null byte array.&lt;br/&gt;
+ */&lt;br/&gt;
+public class RocksDBStoreCustomNullSerdeTest {&lt;br/&gt;
+    private RocksDBStore&amp;lt;String, String&amp;gt; subject;&lt;br/&gt;
+    private MockProcessorContext context;&lt;br/&gt;
+&lt;br/&gt;
+    @Before&lt;br/&gt;
+    public void setUp() throws Exception {&lt;br/&gt;
+        final Serializer&amp;lt;String&amp;gt; serializer = new StringSerializer() {&lt;br/&gt;
+            @Override&lt;br/&gt;
+            public byte[] serialize(final String topic, final String data) {&lt;br/&gt;
+                if (data == null) &lt;/p&gt;
{
+                    return &quot;null-encoding-that-is-not-just-&apos;null&apos;&quot;.getBytes();
+                }
&lt;p&gt;+                return super.serialize(topic, data);&lt;br/&gt;
+            }&lt;br/&gt;
+        };&lt;br/&gt;
+        final Serde&amp;lt;String&amp;gt; serde = Serdes.serdeFrom(serializer, new StringDeserializer());&lt;br/&gt;
+        subject = new RocksDBStore&amp;lt;&amp;gt;(&quot;test&quot;, serde, serde);&lt;br/&gt;
+        context = new MockProcessorContext(&lt;br/&gt;
+                TestUtils.tempDirectory(),&lt;br/&gt;
+                serde,&lt;br/&gt;
+                serde,&lt;br/&gt;
+                new NoOpRecordCollector(),&lt;br/&gt;
+                new ThreadCache(&quot;testCache&quot;, 0, new MockStreamsMetrics(new Metrics())));&lt;br/&gt;
+    }&lt;br/&gt;
+&lt;br/&gt;
+    @After&lt;br/&gt;
+    public void tearDown() throws Exception &lt;/p&gt;
{
+        subject.close();
+    }
&lt;p&gt;+&lt;br/&gt;
+    @Test&lt;br/&gt;
+    public void shouldNotReturnDeletedInIterator() {&lt;br/&gt;
+        subject.init(context, subject);&lt;br/&gt;
+        subject.put(&quot;a&quot;, &quot;1&quot;);&lt;br/&gt;
+        subject.put(&quot;b&quot;, &quot;2&quot;);&lt;br/&gt;
+        subject.delete(&quot;a&quot;);&lt;br/&gt;
+        final KeyValueIterator&amp;lt;String, String&amp;gt; it = subject.all();&lt;br/&gt;
+        while (it.hasNext()) {&lt;br/&gt;
+            final KeyValue&amp;lt;String, String&amp;gt; next = it.next();&lt;br/&gt;
+            if (next.key.equals(&quot;a&quot;)) &lt;/p&gt;
{
+                Assert.fail(&quot;Got deleted key from iterator&quot;);
+            }
&lt;p&gt;+        }&lt;br/&gt;
+    }&lt;br/&gt;
+}&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16354546" author="guozhang" created="Tue, 6 Feb 2018 21:21:08 +0000"  >&lt;p&gt;As a summary of this resolution:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Here is the &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; rule &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; handling nulls:
* in the &lt;span class=&quot;code-keyword&quot;&gt;interface&lt;/span&gt; store, put(key, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) are handled normally and value serde applied to &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;.
* in the &lt;span class=&quot;code-keyword&quot;&gt;inner&lt;/span&gt; most store, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; bytes after serialization will always be treated as deletes.
* in the &lt;span class=&quot;code-keyword&quot;&gt;inner&lt;/span&gt; most store, range queries returning iterators should never &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; bytes.
* in the &lt;span class=&quot;code-keyword&quot;&gt;interface&lt;/span&gt; store, &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; bytes get returned in get(key), serde will be avoided and &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; object will be returned.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12874363" name="DeleteTest.java" size="3476" author="evis" created="Sat, 24 Jun 2017 10:23:59 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 40 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i39ucf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>