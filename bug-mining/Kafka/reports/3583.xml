<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:34:40 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-15552] Duplicate Producer ID blocks during ZK migration</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-15552</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;When migrating producer ID blocks from ZK to KRaft, we are taking the current producer ID block from ZK and writing it&apos;s &quot;firstProducerId&quot; into the&#160;producer IDs KRaft record. However, in KRaft we store the &lt;em&gt;next&lt;/em&gt; producer ID block in the log rather than storing the current block like ZK does. The end result is that the first block given to a caller of AllocateProducerIds is a duplicate of the last block allocated in ZK mode.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;This can result in duplicate producer IDs being given to transactional or idempotent producers. In the case of transactional producers, this can cause long term problems since the producer IDs are persisted and reused for a long time.&lt;/p&gt;


&lt;p&gt;The time between the last producer ID block being allocated by the ZK controller and all the brokers being restarted following the metadata migration is when this bug is possible.&lt;br/&gt;
&#160;&lt;/p&gt;

&lt;p&gt;Symptoms of this bug will include ReplicaManager OutOfOrderSequenceException and possibly some producer epoch validation errors. To see if a cluster is affected by this bug, search for the offending producer ID and see if it is being used by more than one producer.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;For example, the following error was observed&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Out of order sequence number &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; producer 376000 at offset 381338 in partition REDACTED: 0 (incoming seq. number), 21 (current end sequence number) 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Then searching for &quot;376000&quot; on org.apache.kafka.clients.producer.internals.TransactionManager logs, two brokers both show the same producer ID being provisioned&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Broker 0 [Producer clientId=REDACTED-0] ProducerId set to 376000 with epoch 1
Broker 5 [Producer clientId=REDACTED-1] ProducerId set to 376000 with epoch 1
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</description>
                <environment></environment>
        <key id="13553051">KAFKA-15552</key>
            <summary>Duplicate Producer ID blocks during ZK migration</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davidarthur">David Arthur</assignee>
                                    <reporter username="davidarthur">David Arthur</reporter>
                        <labels>
                    </labels>
                <created>Thu, 5 Oct 2023 19:19:18 +0000</created>
                <updated>Mon, 17 Jun 2024 15:42:07 +0000</updated>
                            <resolved>Thu, 16 Nov 2023 10:15:41 +0000</resolved>
                                    <version>3.4.0</version>
                    <version>3.4.1</version>
                    <version>3.5.0</version>
                    <version>3.5.1</version>
                    <version>3.6.0</version>
                                    <fixVersion>3.5.2</fixVersion>
                    <fixVersion>3.6.1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="17772375" author="jolshan" created="Thu, 5 Oct 2023 20:34:51 +0000"  >&lt;p&gt;Recovering when this happens on idempotent producers isn&apos;t too bad. We can restart the producer that had the duplicate producer ID.&#160;&lt;/p&gt;

&lt;p&gt;As for the transactional case, I would need to think a bit on how to recover that. We would need to force a new producer id via a tombstone for the old or some other mechanism. (Think like epoch overflow on startup)&lt;/p&gt;</comment>
                            <comment id="17775029" author="githubbot" created="Fri, 13 Oct 2023 18:57:47 +0000"  >&lt;p&gt;mumrah opened a new pull request, #560:&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka-site/pull/560&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka-site/pull/560&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;   (no comment)&lt;/p&gt;

</comment>
                            <comment id="17775032" author="githubbot" created="Fri, 13 Oct 2023 19:04:47 +0000"  >&lt;p&gt;jolshan commented on code in PR #560:&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka-site/pull/560#discussion_r1358710418&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka-site/pull/560#discussion_r1358710418&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;##########&lt;br/&gt;
36/upgrade.html:&lt;br/&gt;
##########&lt;br/&gt;
@@ -84,7 +84,9 @@ &amp;lt;h5&amp;gt;&amp;lt;a id=&quot;upgrade_360_kraft&quot; href=&quot;#upgrade_360_kraft&quot;&amp;gt;Upgrading KRaft-based cl&lt;/p&gt;

&lt;p&gt;     &amp;lt;h5&amp;gt;&amp;lt;a id=&quot;upgrade_360_notable&quot; href=&quot;#upgrade_360_notable&quot;&amp;gt;Notable changes in 3.6.0&amp;lt;/a&amp;gt;&amp;lt;/h5&amp;gt;&lt;br/&gt;
     &amp;lt;ul&amp;gt;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&amp;lt;li&amp;gt;Apache Kafka now supports having both an IPv4 and an IPv6 listener on the same port. This change only applies to&lt;br/&gt;
+        &amp;lt;li&amp;gt;ZooKeeper to KRaft migrations are now recommended for production usage. One significant issue was found in the&lt;br/&gt;
+	  3.6.0 release which affects transactional producers &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-15552&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-15552&lt;/a&gt;.&amp;lt;/li&amp;gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Review Comment:&lt;br/&gt;
   we should clarify this is idempotent producers as well.&lt;/p&gt;


</comment>
                            <comment id="17775034" author="githubbot" created="Fri, 13 Oct 2023 19:24:24 +0000"  >&lt;p&gt;ijuma commented on code in PR #560:&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka-site/pull/560#discussion_r1358724223&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka-site/pull/560#discussion_r1358724223&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;##########&lt;br/&gt;
36/upgrade.html:&lt;br/&gt;
##########&lt;br/&gt;
@@ -84,7 +84,9 @@ &amp;lt;h5&amp;gt;&amp;lt;a id=&quot;upgrade_360_kraft&quot; href=&quot;#upgrade_360_kraft&quot;&amp;gt;Upgrading KRaft-based cl&lt;/p&gt;

&lt;p&gt;     &amp;lt;h5&amp;gt;&amp;lt;a id=&quot;upgrade_360_notable&quot; href=&quot;#upgrade_360_notable&quot;&amp;gt;Notable changes in 3.6.0&amp;lt;/a&amp;gt;&amp;lt;/h5&amp;gt;&lt;br/&gt;
     &amp;lt;ul&amp;gt;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&amp;lt;li&amp;gt;Apache Kafka now supports having both an IPv4 and an IPv6 listener on the same port. This change only applies to&lt;br/&gt;
+        &amp;lt;li&amp;gt;ZooKeeper to KRaft migrations are now recommended for production usage. One significant issue was found in the&lt;br/&gt;
+	  3.6.0 release which affects transactional producers &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-15552&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-15552&lt;/a&gt;.&amp;lt;/li&amp;gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Review Comment:&lt;br/&gt;
   And can we be clearer about what we&apos;re recommending? Are we saying that they should wait for 3.6.1 if they use idempotent producers (the default since 3.0) or transactions?&lt;/p&gt;


</comment>
                            <comment id="17784346" author="showuon" created="Thu, 9 Nov 2023 10:02:12 +0000"  >&lt;p&gt;Backported to 3.5 and 3.6 branch. For 3.4 fix, since there are some conflicts needed to be resolved, skipping it now and added it when needed.&lt;/p&gt;</comment>
                            <comment id="17785522" author="ijuma" created="Mon, 13 Nov 2023 15:13:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=showuon&quot; class=&quot;user-hover&quot; rel=&quot;showuon&quot;&gt;showuon&lt;/a&gt; Can this be closed then?&lt;/p&gt;</comment>
                            <comment id="17786694" author="showuon" created="Thu, 16 Nov 2023 10:15:59 +0000"  >&lt;p&gt;Closing this ticket since the PR is merged.&lt;/p&gt;</comment>
                            <comment id="17790511" author="githubbot" created="Tue, 28 Nov 2023 11:36:32 +0000"  >&lt;p&gt;mimaison commented on code in PR #560:&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka-site/pull/560#discussion_r1407624587&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka-site/pull/560#discussion_r1407624587&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;##########&lt;br/&gt;
36/upgrade.html:&lt;br/&gt;
##########&lt;br/&gt;
@@ -84,7 +84,9 @@ &amp;lt;h5&amp;gt;&amp;lt;a id=&quot;upgrade_360_kraft&quot; href=&quot;#upgrade_360_kraft&quot;&amp;gt;Upgrading KRaft-based cl&lt;/p&gt;

&lt;p&gt;     &amp;lt;h5&amp;gt;&amp;lt;a id=&quot;upgrade_360_notable&quot; href=&quot;#upgrade_360_notable&quot;&amp;gt;Notable changes in 3.6.0&amp;lt;/a&amp;gt;&amp;lt;/h5&amp;gt;&lt;br/&gt;
     &amp;lt;ul&amp;gt;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&amp;lt;li&amp;gt;Apache Kafka now supports having both an IPv4 and an IPv6 listener on the same port. This change only applies to&lt;br/&gt;
+        &amp;lt;li&amp;gt;ZooKeeper to KRaft migrations are now recommended for production usage. One significant issue was found in the&lt;br/&gt;
+	  3.6.0 release which affects transactional producers &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-15552&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-15552&lt;/a&gt;.&amp;lt;/li&amp;gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Review Comment:&lt;br/&gt;
   This information is very important to communicate to our users. Today users that don&apos;t follow closely the mailing list or Jira (which is most users), all they know is that migration is now production ready and unfortunately they are likely to run into issues if they run it.&lt;br/&gt;
   Can we rephrase slightly the sentence to address the comments from Justine and Ismael and push that to the website soon?&lt;/p&gt;


</comment>
                            <comment id="17855659" author="githubbot" created="Mon, 17 Jun 2024 15:42:07 +0000"  >&lt;p&gt;mjsax commented on PR #560:&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka-site/pull/560#issuecomment-2173746761&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka-site/pull/560#issuecomment-2173746761&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;   @mumrah &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 21 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1krk0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>