<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:10:18 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-6878] NPE when querying global state store not in READY state</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-6878</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Info: using kafka 1.1.0 - confluent 4.1.0&lt;/p&gt;


&lt;p&gt;We&apos;re trying to query a global state store, but if we query too quickly after the application is started we get a NullPointerException(CachingKeyValueStore.java:166).&lt;/p&gt;

&lt;p&gt;We have verified the key is nonNull.&lt;/p&gt;

&lt;p&gt;If we wait long enough (with our current amount of data 5 minutes after start) we get an answer but before then we get NPEs.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Looks like there isn&apos;t a check to ensure `initInternal` actually sets the cache before you&apos;re allowed to use it in the get method&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;stacktrace:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.NullPointerException: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
at org.apache.kafka.streams.state.internals.CachingKeyValueStore.getInternal(CachingKeyValueStore.java:166)
at org.apache.kafka.streams.state.internals.CachingKeyValueStore.get(CachingKeyValueStore.java:159)
at org.apache.kafka.streams.state.internals.CachingKeyValueStore.get(CachingKeyValueStore.java:38)
at org.apache.kafka.streams.state.internals.InnerMeteredKeyValueStore.get(InnerMeteredKeyValueStore.java:183)
at org.apache.kafka.streams.state.internals.MeteredKeyValueBytesStore.get(MeteredKeyValueBytesStore.java:112)
at org.apache.kafka.streams.state.internals.CompositeReadOnlyKeyValueStore.get(CompositeReadOnlyKeyValueStore.java:55)
at io.repository.VisitRepositoryKafka.findByVisitTrackingId(VisitRepositoryKafka.java:76)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13157743">KAFKA-6878</key>
            <summary>NPE when querying global state store not in READY state</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="Slytherin">Salazar</reporter>
                        <labels>
                    </labels>
                <created>Mon, 7 May 2018 23:48:38 +0000</created>
                <updated>Thu, 10 May 2018 00:08:03 +0000</updated>
                            <resolved>Thu, 10 May 2018 00:08:03 +0000</resolved>
                                    <version>1.1.0</version>
                                    <fixVersion>1.1.1</fixVersion>
                    <fixVersion>2.0.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16467676" author="slytherin" created="Tue, 8 May 2018 16:49:29 +0000"  >&lt;p&gt;Hi Ted,&lt;/p&gt;

&lt;p&gt;We did verify that the key is not null and the top layer class CompositeReadOnlyKeyValueStore already has an Objects.nonNull assertion in it that appropriately throws an NPE (as documented).&#160; In this scenario the cache is actually null b/c the initInternal has not completed/been called before the getInternal was called.&lt;/p&gt;</comment>
                            <comment id="16467689" author="yuzhihong@gmail.com" created="Tue, 8 May 2018 16:56:54 +0000"  >&lt;p&gt;How about this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
diff --git a/streams/src/main/java/org/apache/kafka/streams/state/internals/CachingKeyValueStore.java b/streams/src/main/java/org/apache/kafka/streams/state/internals/CachingKeyValueSto
index 45f606f..d1080f8 100644
--- a/streams/src/main/java/org/apache/kafka/streams/state/internals/CachingKeyValueStore.java
+++ b/streams/src/main/java/org/apache/kafka/streams/state/internals/CachingKeyValueStore.java
@@ -163,6 +163,9 @@ &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;CachingKeyValueStore&amp;lt;K, V&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; WrappedStateStore.AbstractStateStore im
     }

     &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] getInternal(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Bytes key) {
+        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (cache == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
+            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
+        }
         &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; LRUCacheEntry entry = cache.get(cacheName, key);
         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (entry == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
             &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] rawValue = underlying.get(key);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16467700" author="mjsax" created="Tue, 8 May 2018 17:10:51 +0000"  >&lt;p&gt;Feel free to assign the Jira to yourself and open a PR &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yuzhihong%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;yuzhihong@gmail.com&quot;&gt;yuzhihong@gmail.com&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16467708" author="githubbot" created="Tue, 8 May 2018 17:17:11 +0000"  >&lt;p&gt;tedyu opened a new pull request #4978: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6878&quot; title=&quot;NPE when querying global state store not in READY state&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-6878&quot;&gt;&lt;del&gt;KAFKA-6878&lt;/del&gt;&lt;/a&gt; NPE when querying global state store not in READY state&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/4978&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/4978&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Check whether cache is null before retrieving from cache.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16469182" author="githubbot" created="Wed, 9 May 2018 17:42:13 +0000"  >&lt;p&gt;guozhangwang closed pull request #4978: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6878&quot; title=&quot;NPE when querying global state store not in READY state&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-6878&quot;&gt;&lt;del&gt;KAFKA-6878&lt;/del&gt;&lt;/a&gt; NPE when querying global state store not in READY state&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/4978&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/4978&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/streams/src/main/java/org/apache/kafka/streams/state/internals/CachingKeyValueStore.java b/streams/src/main/java/org/apache/kafka/streams/state/internals/CachingKeyValueStore.java&lt;br/&gt;
index 45f606f375e..16684e39c1a 100644&lt;br/&gt;
&amp;#8212; a/streams/src/main/java/org/apache/kafka/streams/state/internals/CachingKeyValueStore.java&lt;br/&gt;
+++ b/streams/src/main/java/org/apache/kafka/streams/state/internals/CachingKeyValueStore.java&lt;br/&gt;
@@ -163,7 +163,10 @@ public boolean isOpen() {&lt;br/&gt;
     }&lt;/p&gt;

&lt;p&gt;     private byte[] getInternal(final Bytes key) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final LRUCacheEntry entry = cache.get(cacheName, key);&lt;br/&gt;
+        LRUCacheEntry entry = null;&lt;br/&gt;
+        if (cache != null) 
{
+            entry = cache.get(cacheName, key);
+        }
&lt;p&gt;         if (entry == null) {&lt;br/&gt;
             final byte[] rawValue = underlying.get(key);&lt;br/&gt;
             if (rawValue == null) {&lt;br/&gt;
diff --git a/streams/src/main/java/org/apache/kafka/streams/state/internals/CachingWindowStore.java b/streams/src/main/java/org/apache/kafka/streams/state/internals/CachingWindowStore.java&lt;br/&gt;
index 58111a670d6..1d0455b2b6f 100644&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/streams/src/main/java/org/apache/kafka/streams/state/internals/CachingWindowStore.java&lt;br/&gt;
+++ b/streams/src/main/java/org/apache/kafka/streams/state/internals/CachingWindowStore.java&lt;br/&gt;
@@ -160,6 +160,9 @@ public synchronized void put(final Bytes key, final byte[] value, final long tim&lt;br/&gt;
         validateStoreOpen();&lt;br/&gt;
         final Bytes bytesKey = WindowKeySchema.toStoreKeyBinary(key, timestamp, 0);&lt;br/&gt;
         final Bytes cacheKey = cacheFunction.cacheKey(bytesKey);&lt;br/&gt;
+        if (cache == null) 
{
+            return underlying.fetch(key, timestamp);
+        }
&lt;p&gt;         final LRUCacheEntry entry = cache.get(name, cacheKey);&lt;br/&gt;
         if (entry == null) {&lt;br/&gt;
             return underlying.fetch(key, timestamp);&lt;/p&gt;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;





&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16469731" author="githubbot" created="Thu, 10 May 2018 00:06:50 +0000"  >&lt;p&gt;guozhangwang closed pull request #4988: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6878&quot; title=&quot;NPE when querying global state store not in READY state&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-6878&quot;&gt;&lt;del&gt;KAFKA-6878&lt;/del&gt;&lt;/a&gt; Switch the order of underlying.init and initInternal&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/4988&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/4988&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/streams/src/main/java/org/apache/kafka/streams/state/internals/CachingKeyValueStore.java b/streams/src/main/java/org/apache/kafka/streams/state/internals/CachingKeyValueStore.java&lt;br/&gt;
index 16684e39c1a..525e92df22f 100644&lt;br/&gt;
&amp;#8212; a/streams/src/main/java/org/apache/kafka/streams/state/internals/CachingKeyValueStore.java&lt;br/&gt;
+++ b/streams/src/main/java/org/apache/kafka/streams/state/internals/CachingKeyValueStore.java&lt;br/&gt;
@@ -60,8 +60,8 @@&lt;/p&gt;

&lt;p&gt;     @Override&lt;br/&gt;
     public void init(final ProcessorContext context, final StateStore root) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;underlying.init(context, root);&lt;br/&gt;
         initInternal(context);&lt;br/&gt;
+        underlying.init(context, root);&lt;br/&gt;
         // save the stream thread as we only ever want to trigger a flush&lt;br/&gt;
         // when the stream thread is the current thread.&lt;br/&gt;
         streamThread = Thread.currentThread();&lt;br/&gt;
diff --git a/streams/src/main/java/org/apache/kafka/streams/state/internals/CachingSessionStore.java b/streams/src/main/java/org/apache/kafka/streams/state/internals/CachingSessionStore.java&lt;br/&gt;
index 068ac88ffba..1bb2ea750c5 100644
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/streams/src/main/java/org/apache/kafka/streams/state/internals/CachingSessionStore.java&lt;br/&gt;
+++ b/streams/src/main/java/org/apache/kafka/streams/state/internals/CachingSessionStore.java&lt;br/&gt;
@@ -63,8 +63,8 @@&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     public void init(final ProcessorContext context, final StateStore root) &lt;/p&gt;
{
         topic = ProcessorStateManager.storeChangelogTopic(context.applicationId(), root.name());
-        bytesStore.init(context, root);
         initInternal((InternalProcessorContext) context);
+        bytesStore.init(context, root);
     }

&lt;p&gt;     @SuppressWarnings(&quot;unchecked&quot;)&lt;br/&gt;
diff --git a/streams/src/main/java/org/apache/kafka/streams/state/internals/CachingWindowStore.java b/streams/src/main/java/org/apache/kafka/streams/state/internals/CachingWindowStore.java&lt;br/&gt;
index 1d0455b2b6f..7e58b684f23 100644&lt;br/&gt;
&amp;#8212; a/streams/src/main/java/org/apache/kafka/streams/state/internals/CachingWindowStore.java&lt;br/&gt;
+++ b/streams/src/main/java/org/apache/kafka/streams/state/internals/CachingWindowStore.java&lt;br/&gt;
@@ -67,8 +67,8 @@&lt;/p&gt;

&lt;p&gt;     @Override&lt;br/&gt;
     public void init(final ProcessorContext context, final StateStore root) &lt;/p&gt;
{
-        underlying.init(context, root);
         initInternal(context);
+        underlying.init(context, root);
         keySchema.init(context.applicationId());
     }

&lt;p&gt;@@ -178,7 +178,9 @@ public synchronized void put(final Bytes key, final byte[] value, final long tim&lt;br/&gt;
         validateStoreOpen();&lt;/p&gt;

&lt;p&gt;         final WindowStoreIterator&amp;lt;byte[]&amp;gt; underlyingIterator = underlying.fetch(key, timeFrom, timeTo);&lt;br/&gt;
-&lt;br/&gt;
+        if (cache == null) &lt;/p&gt;
{
+            return underlyingIterator;
+        }&lt;br/&gt;
         final Bytes cacheKeyFrom = cacheFunction.cacheKey(keySchema.lowerRangeFixedSize(key, timeFrom));&lt;br/&gt;
         final Bytes cacheKeyTo = cacheFunction.cacheKey(keySchema.upperRangeFixedSize(key, timeTo));&lt;br/&gt;
         final ThreadCache.MemoryLRUCacheBytesIterator cacheIterator = cache.range(name, cacheKeyFrom, cacheKeyTo);&lt;br/&gt;
@@ -201,7 +203,9 @@ public synchronized void put(final Bytes key, final byte[] value, final long tim&lt;br/&gt;
         validateStoreOpen();&lt;br/&gt;
 &lt;br/&gt;
         final KeyValueIterator&amp;lt;Windowed&amp;lt;Bytes&amp;gt;, byte[]&amp;gt; underlyingIterator = underlying.fetch(from, to, timeFrom, timeTo);&lt;br/&gt;
-&lt;br/&gt;
+        if (cache == null) {+            return underlyingIterator;+        }
&lt;p&gt;         final Bytes cacheKeyFrom = cacheFunction.cacheKey(keySchema.lowerRange(from, timeFrom));&lt;br/&gt;
         final Bytes cacheKeyTo = cacheFunction.cacheKey(keySchema.upperRange(to, timeTo));&lt;br/&gt;
         final ThreadCache.MemoryLRUCacheBytesIterator cacheIterator = cache.range(name, cacheKeyFrom, cacheKeyTo);&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 27 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3tfzr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>