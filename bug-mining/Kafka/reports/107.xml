<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:35:51 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-543] Metadata request from DefaultEventHandler.handle repeats same topic over and over</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-543</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;It looks like we are calling BrokerPartitionInfo.updateInfo() with a list of the same topic repeated many times:&lt;/p&gt;

&lt;p&gt;Here is the line:&lt;br/&gt;
Utils.swallowError(brokerPartitionInfo.updateInfo(outstandingProduceRequests.map(_.getTopic)))&lt;/p&gt;

&lt;p&gt;The outstandingProduceRequests can (and generally would) have many entries for the same topic.&lt;/p&gt;

&lt;p&gt;For example if I use the producer performance test with the default batch size on a topic &quot;test&quot; my metadata request will have the topic &quot;test&quot; repeated 200 times. On the server side we do several zk reads for each of these repetitions.&lt;/p&gt;

&lt;p&gt;This is causing the metadata api to timeout in my perf test periodically.&lt;/p&gt;

&lt;p&gt;I think the fix is simply to de-duplicate prior to the call (and perhaps again on the server in case of a misbehaving client).&lt;/p&gt;</description>
                <environment></environment>
        <key id="12610179">KAFKA-543</key>
            <summary>Metadata request from DefaultEventHandler.handle repeats same topic over and over</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jkreps">Jay Kreps</assignee>
                                    <reporter username="jkreps">Jay Kreps</reporter>
                        <labels>
                            <label>bugs</label>
                    </labels>
                <created>Thu, 4 Oct 2012 03:16:45 +0000</created>
                <updated>Tue, 16 Oct 2012 04:29:09 +0000</updated>
                            <resolved>Wed, 10 Oct 2012 04:25:31 +0000</resolved>
                                    <version>0.8.0</version>
                                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13469580" author="jkreps" created="Thu, 4 Oct 2012 18:35:21 +0000"  >&lt;p&gt;This patch dedupes in DefaultEventHandler which fixes the issue. It also proactively dedupes in KafkaApis to ensure the server is defensive.&lt;/p&gt;

&lt;p&gt;I could semi-reliably reproduce SocketTimeoutExceptions during  perf tests on my local machine always on the get metadata request. This patch seems to fix these (since it was sporadic it is hard to be sure, but it hasn&apos;t happened with the change).&lt;/p&gt;</comment>
                            <comment id="13469604" author="junrao" created="Thu, 4 Oct 2012 19:01:28 +0000"  >&lt;p&gt;Thanks for the patch. Good catch. +1&lt;/p&gt;</comment>
                            <comment id="13472506" author="nehanarkhede" created="Tue, 9 Oct 2012 16:15:34 +0000"  >&lt;p&gt;Good catch. It seems like it is useful that updateInfo takes in a Set instead of a Seq. This will avoid any future accidental duplicate topics bug and also avoids the conversion from Seq -&amp;gt; Set -&amp;gt; Seq.&lt;/p&gt;</comment>
                            <comment id="13472517" author="jkreps" created="Tue, 9 Oct 2012 16:25:04 +0000"  >&lt;p&gt;That was what I originally started to do. I ended up going this route because: (1) It was a more surgical change and (2) I feel we should avoid logic like deduplication in the RPC format objects, these should stupidly turn objects into bytes with processing done elsewhere. I thought the double copy was okay since this is functionality off the main data path. Let me know what you think, I can try it the other way if you like and we can compare.&lt;/p&gt;</comment>
                            <comment id="13472523" author="nehanarkhede" created="Tue, 9 Oct 2012 16:34:51 +0000"  >&lt;p&gt;Could you explain (1) a little more ?  What I think is that if any correct usage of this API needs the input to be deduped, there are two choices - (1) Have this API do the de-duping (2) Have it input a Set so that callers will definitely dedup. Right now, it still ends up taking a Seq as input and every caller has to remember to dedup the sequence, which is dangerous. &lt;/p&gt;</comment>
                            <comment id="13472591" author="jkreps" created="Tue, 9 Oct 2012 18:04:45 +0000"  >&lt;p&gt;Hey Neha, I actually kind of agree with you. We need to dedupe on the server since we can&apos;t trust the client. There are three ways to do the client side dedupe: in the request object, in the call, or in AdminUtils. I don&apos;t like changing the request object because I think the list should map directly to the serialized data (i.e same order). I agree that fixing AdminUtils is preferable to doing it at the call site.&lt;/p&gt;

&lt;p&gt;Here is a second patch. It does the following:&lt;br/&gt;
1. Make AdminUtils.getTopicMetaDataFromZK() and BrokerPartitionInfo.updateInfo take a set instead of a list. Also dedupe on the server side just in case.&lt;br/&gt;
2. Cleanup: Rename AdminUtils.getTopicMetaDataFromZK to AdminUtils.fetchTopicMetadataFromZk. This is consistent with our capitalization of TopicMetadata. I also dislike the naming of methods as getX since it sounds like they are a getter when in fact they do remote requests.&lt;br/&gt;
3. Cleanup: add a single topic version of the API since the vast majority of uses were fetching only a single topic. Reimplement the mutli-topic api in terms of the single topic api.&lt;/p&gt;</comment>
                            <comment id="13472761" author="nehanarkhede" created="Tue, 9 Oct 2012 21:21:29 +0000"  >&lt;p&gt;Looks good. +1&lt;/p&gt;</comment>
                            <comment id="13472980" author="jkreps" created="Wed, 10 Oct 2012 04:25:31 +0000"  >&lt;p&gt;Committed v2.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12548434" name="KAFKA-543-v2.patch" size="21667" author="jkreps" created="Tue, 9 Oct 2012 18:04:45 +0000"/>
                            <attachment id="12547795" name="KAFKA-543.patch" size="1806" author="jkreps" created="Thu, 4 Oct 2012 18:35:21 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>240612</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 6 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i013wf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4401</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>