<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:13:17 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-3702] SslTransportLayer.close() does not shutdown gracefully</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-3702</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;The warning &quot;Failed to send SSL Close message&quot; occurs very frequently when SSL connections are closed. Close should write outbound data and shutdown gracefully.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12967473">KAFKA-3702</key>
            <summary>SslTransportLayer.close() does not shutdown gracefully</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="4" iconUrl="https://issues.apache.org/jira/images/icons/statuses/reopened.png" description="This issue was once resolved, but the resolution was deemed incorrect. From here issues are either marked assigned or resolved.">Reopened</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="rsivaram">Rajini Sivaram</assignee>
                                    <reporter username="rsivaram">Rajini Sivaram</reporter>
                        <labels>
                    </labels>
                <created>Wed, 11 May 2016 16:01:45 +0000</created>
                <updated>Tue, 16 Feb 2021 14:11:52 +0000</updated>
                                            <version>0.10.0.0</version>
                                                        <due></due>
                            <votes>10</votes>
                                    <watches>34</watches>
                                                                                                                <comments>
                            <comment id="16260482" author="lionel.cons" created="Tue, 21 Nov 2017 09:45:31 +0000"  >&lt;p&gt;FWIW, this has been discussed at &lt;a href=&quot;https://www.mail-archive.com/users@kafka.apache.org/msg26753.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://www.mail-archive.com/users@kafka.apache.org/msg26753.html&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Either the current behavior is normal and Kafka should not log this as a warning (maybe debug is enough?) or it is not normal so the code/logic should be changed.&lt;/p&gt;

&lt;p&gt;Any hope to get this fixed?&lt;/p&gt;</comment>
                            <comment id="16348894" author="tudoumantou1" created="Thu, 1 Feb 2018 16:53:16 +0000"  >&lt;p&gt;Anybody have ever encountered this one?&#160;WARN: Failed to send SSL Close message java.io.IOException: Unexpected status returned by SSLEngine.wrap, expected CLOSED, received OK.&lt;/p&gt;

&lt;p&gt;Seems similar but message is a little bit different.&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6510&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-6510&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16458786" author="kjinxin" created="Mon, 30 Apr 2018 17:28:00 +0000"  >&lt;p&gt;I also got this issue. The frequent log is annoying.&lt;/p&gt;</comment>
                            <comment id="16547961" author="niob" created="Wed, 18 Jul 2018 15:18:34 +0000"  >&lt;p&gt;Same. Blows up the system log.&lt;/p&gt;</comment>
                            <comment id="16549829" author="githubbot" created="Thu, 19 Jul 2018 20:39:53 +0000"  >&lt;p&gt;rajinisivaram opened a new pull request #5397: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3702&quot; title=&quot;SslTransportLayer.close() does not shutdown gracefully&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3702&quot;&gt;KAFKA-3702&lt;/a&gt;: Change log level of SSL close_notify failure&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5397&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5397&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   SslTransportLayer currently closes the SSL engine and logs a warning if `close_notify` message canot be sent because the remote end closed its connection. This tends to fill up broker logs, especially when using clients which close connections immediately. Since this log entry is not very useful anyway, it would be better to log at debug level.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16550484" author="githubbot" created="Fri, 20 Jul 2018 08:23:04 +0000"  >&lt;p&gt;rajinisivaram closed pull request #5397: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3702&quot; title=&quot;SslTransportLayer.close() does not shutdown gracefully&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3702&quot;&gt;KAFKA-3702&lt;/a&gt;: Change log level of SSL close_notify failure&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5397&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5397&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/clients/src/main/java/org/apache/kafka/common/network/SslTransportLayer.java b/clients/src/main/java/org/apache/kafka/common/network/SslTransportLayer.java&lt;br/&gt;
index 838a6a75af3..08a39e71d50 100644&lt;br/&gt;
&amp;#8212; a/clients/src/main/java/org/apache/kafka/common/network/SslTransportLayer.java&lt;br/&gt;
+++ b/clients/src/main/java/org/apache/kafka/common/network/SslTransportLayer.java&lt;br/&gt;
@@ -177,7 +177,7 @@ public void close() throws IOException &lt;/p&gt;
{
                 flush(netWriteBuffer);
             }
&lt;p&gt;         } catch (IOException ie) &lt;/p&gt;
{
-            log.warn(&quot;Failed to send SSL Close message&quot;, ie);
+            log.debug(&quot;Failed to send SSL Close message&quot;, ie);
         }
&lt;p&gt; finally {&lt;br/&gt;
             socketChannel.socket().close();&lt;br/&gt;
             socketChannel.close();&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="17060982" author="rsivaram" created="Tue, 17 Mar 2020 15:05:04 +0000"  >&lt;p&gt;We changed the log level of the entry `Failed to send SSL Close message` from WARN to DEBUG, but we haven&apos;t yet fixed the underlying issue. At the moment, we attempt to flush all outgoing data and close gracefully, but disconnect if we can&apos;t do so immediately. Reopening the JIRA to track the underlying issue.&lt;/p&gt;</comment>
                            <comment id="17074332" author="xiaotao183" created="Fri, 3 Apr 2020 07:09:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rsivaram&quot; class=&quot;user-hover&quot; rel=&quot;rsivaram&quot;&gt;rsivaram&lt;/a&gt;&#160;Does this issue relate to&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6510&quot; title=&quot;WARN: Failed to send SSL Close message java.io.IOException: Unexpected status returned by SSLEngine.wrap, expected CLOSED, received OK. &quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-6510&quot;&gt;KAFKA-6510&lt;/a&gt;?&#160; I have seen&#160;Failed to send SSL Close message as well as&#160;Unexpected status returned by SSLEngine.wrap, expected CLOSED, received OK happening at the same in Kafka 1.1.1&lt;/p&gt;</comment>
                            <comment id="17284740" author="purplefox" created="Mon, 15 Feb 2021 13:52:54 +0000"  >&lt;p&gt;Just looking at the code and it seems SSLEngine.closeOutbound is called &lt;em&gt;before&lt;/em&gt; the connection is flushed. Is this deliberate?&lt;/p&gt;

&lt;p&gt;According to the javadoc for closeOutBound:&lt;/p&gt;



&lt;p&gt;&quot;Signals that no more outbound application data will be sent on this&#160;&lt;tt&gt;SSLEngine&lt;/tt&gt;.&quot;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://docs.oracle.com/javase/7/docs/api/javax/net/ssl/SSLEngine.html#closeOutbound(&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://docs.oracle.com/javase/7/docs/api/javax/net/ssl/SSLEngine.html#closeOutbound(&lt;/a&gt;)&lt;/p&gt;</comment>
                            <comment id="17285172" author="julescs0" created="Tue, 16 Feb 2021 12:41:55 +0000"  >&lt;p&gt;Hi, I came across this issue while searching in relation to the other two jiras I have been commenting for which this same error is also cropping up. I think these may all be related... Regardless, it all points to kafka 0.10 versions.. this issue has been in our clusters for near 2 years now...&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5649&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-5649&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-21453&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/SPARK-21453&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17285199" author="ijuma" created="Tue, 16 Feb 2021 13:35:43 +0000"  >&lt;p&gt;A possible issue (identified by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=david.mao&quot; class=&quot;user-hover&quot; rel=&quot;david.mao&quot;&gt;david.mao&lt;/a&gt;) is that we don&apos;t check if `isOutboundDone` is true in the `close` method.&lt;/p&gt;</comment>
                            <comment id="17285212" author="purplefox" created="Tue, 16 Feb 2021 14:06:46 +0000"  >&lt;p&gt;Maybe I am missing something but writing to the connection (via flush) after closeOutbound has been called seems wrong to me.&lt;/p&gt;

&lt;p&gt;closeOutBound cause close_notify to be sent to the peer. AIUI, you shouldn&apos;t wrote more data on a connection after close_notify has been sent.&lt;/p&gt;

&lt;p&gt;When the peer receives the close_notify it might close the connection. If we then continue to send more data it&apos;s likely that we might receive &quot;connection reset by peer&quot; or similar as the connection will already have been closed (I believe this is what we see).&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17285215" author="ijuma" created="Tue, 16 Feb 2021 14:09:55 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=purplefox&quot; class=&quot;user-hover&quot; rel=&quot;purplefox&quot;&gt;purplefox&lt;/a&gt;&#160;The documentation for `closeOutbound` says you must still call `wrap` after:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;wrap(ByteBuffer, ByteBuffer) should be called to flush any remaining handshake data.&lt;/p&gt;&lt;/blockquote&gt;</comment>
                            <comment id="17285216" author="purplefox" created="Tue, 16 Feb 2021 14:10:03 +0000"  >&lt;p&gt;&amp;gt;&amp;gt;&#160;A possible issue (identified by&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=david.mao&quot; class=&quot;user-hover&quot; rel=&quot;david.mao&quot;&gt;david.mao&lt;/a&gt;) is that we don&apos;t check if `isOutboundDone` is true in the `close` method.&lt;/p&gt;

&lt;p&gt;Yes, I think this is also an issue (perhaps a separate one). According to the SSLEngine javadoc, wrap() or isOutboundDone() should be called &lt;em&gt;repeatedly&lt;/em&gt; until it returns CLOSED/true. Currently we only call it once and assume it will immediately return with CLOSED/true.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17285218" author="ijuma" created="Tue, 16 Feb 2021 14:10:43 +0000"  >&lt;p&gt;Also `isOutboundDone` says:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Returns whether wrap(ByteBuffer, ByteBuffer) will produce any more outbound data messages.&lt;br/&gt;
Note that during the closure phase, a SSLEngine may generate handshake closure data that must be sent to the peer. wrap() must be called to generate this data. When this method returns true, no more outbound data will be created.&lt;/p&gt;&lt;/blockquote&gt;</comment>
                            <comment id="17285220" author="ijuma" created="Tue, 16 Feb 2021 14:11:52 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=purplefox&quot; class=&quot;user-hover&quot; rel=&quot;purplefox&quot;&gt;purplefox&lt;/a&gt;&#160;it may be simplest if you submit a PR with the changes you think are required. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="13078083">KAFKA-5401</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 39 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2xl13:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>