<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:24:53 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-9769] ReplicaManager Partition.makeFollower Increases LeaderEpoch when ZooKeeper disconnect occurs</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-9769</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;The ZooKeeper Session once expired and got disconnected and the broker received the 1st LeaderAndIsr request simultaneously. As the broker was processing the 1st LeaderAndIsr Request, the ZooKeeper session has not been reestablished just yet.&lt;/p&gt;

&lt;p&gt;Within the makeFollowers method, &lt;em&gt;partition.getOrCreateReplica&lt;/em&gt; is called before the fetcher begins.&#160;&lt;em&gt;partition.getOrCreateReplica&lt;/em&gt; needs to fetch information from ZooKeeper but an exception is thrown when calling the ZooKeeper client because the session is invalid, rendering the fetcher start to be skipped.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;In Partition class&apos;s getOrCreateReplica method calls AdminZkClient&apos;s fetchEntityConfig(..) which throws an exception if the ZooKeeper session is invalid.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
val props = adminZkClient.fetchEntityConfig(ConfigType.Topic, topic)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;When this occurs, the leader epoch should not have been incremented due to ZooKeeper being invalid because once the second LeaderAndIsr request comes in, the leader epoch could be the same between the brokers.&#160;&lt;/p&gt;

&lt;p&gt;Few options I can think of for a fix. I think third route could be feasible:&lt;/p&gt;

&lt;p&gt;1 - Make LeaderEpoch update and fetch update atomic.&lt;/p&gt;

&lt;p&gt;2 - Wait until all individual partitions are successful without problems then process fetch.&lt;/p&gt;

&lt;p&gt;3 - Catch the ZooKeeper exception in the caller code block (ReplicaManager.makeFollowers) and simply do not touch the remaining partitions to ensure that the batch of successful partitions up to that point are updated and processed (fetch).&lt;/p&gt;

&lt;p&gt;4 - Or make LeaderAndIsr request never arrive at the broker in case of ZooKeeper disconnect, then that would be safe because it is already possible for some replicas to receive the LeaderAndIsr later than the others. However, in that case, the code need to make sure the controller will retry.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&#160;&lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (requestLeaderEpoch &amp;gt; currentLeaderEpoch) {
 &lt;span class=&quot;code-comment&quot;&gt;// If the leader epoch is valid record the epoch of the controller that made the leadership decision. 
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// This is useful &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; updating the isr to maintain the decision maker controller&apos;s epoch in the zookeeper path 
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (stateInfo.basePartitionState.replicas.contains(localBrokerId))       
partitionState.put(partition, stateInfo)
&lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; 
&#160;
def getOrCreateReplica(replicaId: Int, isNew: &lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt; = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;): Replica = {          allReplicasMap.getAndMaybePut(replicaId, { 
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (isReplicaLocal(replicaId)) {
val adminZkClient = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; AdminZkClient(zkClient) val props = adminZkClient.fetchEntityConfig(ConfigType.Topic, topic)




&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13294266">KAFKA-9769</key>
            <summary>ReplicaManager Partition.makeFollower Increases LeaderEpoch when ZooKeeper disconnect occurs</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="andrewchoi5">Andrew Choi</assignee>
                                    <reporter username="andrewchoi5">Andrew Choi</reporter>
                        <labels>
                            <label>kafka</label>
                            <label>replica</label>
                            <label>replication</label>
                    </labels>
                <created>Thu, 26 Mar 2020 18:06:16 +0000</created>
                <updated>Mon, 6 Jul 2020 18:27:50 +0000</updated>
                            <resolved>Mon, 6 Jul 2020 18:27:50 +0000</resolved>
                                                    <fixVersion>2.7.0</fixVersion>
                                    <component>replication</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17082798" author="githubbot" created="Tue, 14 Apr 2020 02:38:40 +0000"  >&lt;p&gt;andrewchoi5 commented on pull request #8479: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-9769&quot; title=&quot;ReplicaManager Partition.makeFollower Increases LeaderEpoch when ZooKeeper disconnect occurs&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-9769&quot;&gt;&lt;del&gt;KAFKA-9769&lt;/del&gt;&lt;/a&gt;: Finish operations for leaderEpoch-updated partitions up to point ZK Exception&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/8479&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/8479&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-9769&quot; title=&quot;ReplicaManager Partition.makeFollower Increases LeaderEpoch when ZooKeeper disconnect occurs&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-9769&quot;&gt;&lt;del&gt;KAFKA-9769&lt;/del&gt;&lt;/a&gt;: Finish operations for leaderEpoch-updated partitions up to point ZK Exception occurs.&lt;br/&gt;
   &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-9769&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-9769&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;   For example, in such case, we will have the following mechanism :&lt;br/&gt;
   1 - P1 and P2 succeeds. leaderEpoch for them are incremented because no ZkException occurs&lt;br/&gt;
   2 - while making follower for P3, ZkException occurs and the leaderEpoch is not updated and thus thepartitionsToMakeFollower += partition isn&#8217;t executed. We catch this ZkException in line 1498 and log it as an error. No Exception is thrown.&lt;br/&gt;
   3 - After catching the exception, makeFollower for P4 is then not executed.&lt;br/&gt;
   4 - so the partitionsToMakeFollower only contains P1, P2. And fetchers are added to these partitionsToMakeFollower&lt;/p&gt;

&lt;p&gt;   Signed-off-by: Andrew Choi &amp;lt;li_andchoi@microsoft.com&amp;gt;&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="17152237" author="junrao" created="Mon, 6 Jul 2020 18:27:50 +0000"  >&lt;p&gt;merged the PR to trunk&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 19 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0cy7c:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>