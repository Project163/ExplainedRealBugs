<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:42:38 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-15371] MetadataShell is stuck when bootstrapping</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-15371</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;I&#160; downloaded the 3.5.1 package and startup it, then use metadata shell to inspect the data&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// shell
&lt;/span&gt;bin/kafka-metadata-shell.sh --snapshot /tmp/kraft-combined-logs/__cluster_metadata-0/00000000000000000000.log&#160; &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Then process will stuck at loading.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13062235/13062235_image-2023-08-17-10-35-36-067.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13547648">KAFKA-15371</key>
            <summary>MetadataShell is stuck when bootstrapping</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gongxuanzhang">xuanzhang gong</assignee>
                                    <reporter username="dengziming">Deng Ziming</reporter>
                        <labels>
                    </labels>
                <created>Thu, 17 Aug 2023 02:37:46 +0000</created>
                <updated>Mon, 14 Apr 2025 06:13:55 +0000</updated>
                            <resolved>Mon, 14 Apr 2025 06:13:55 +0000</resolved>
                                    <version>3.5.1</version>
                                    <fixVersion>4.1.0</fixVersion>
                                        <due></due>
                            <votes>2</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="17781243" author="JIRAUSER302851" created="Tue, 31 Oct 2023 07:16:02 +0000"  >&lt;p&gt;Hi&#160;&lt;/p&gt;

&lt;p&gt;I get this issue in version 3.6.0 and also in 3.5.1&#160;&lt;/p&gt;

&lt;p&gt;in my case rarely I can access to the CLI but I didn&apos;t get all the options there (missing folders)&lt;/p&gt;

&lt;p&gt;more than that sometimes I get this error :&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13064004/13064004_image-2023-10-31-09-04-53-966.png&quot; height=&quot;184&quot; width=&quot;654&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;when I run the lsof command it looks like this shell opens the script to read-only (although the file with more than the right permissions 777) the read-only is in the FD column&#160; of lsof&#160;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13064007/13064007_image-2023-10-31-09-15-34-821.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;please check maybe when you open the file with the Java class you make it read-only?&lt;/p&gt;

&lt;p&gt;is there someone who can take care of this bug?&#160;&lt;/p&gt;</comment>
                            <comment id="17782846" author="JIRAUSER302935" created="Sat, 4 Nov 2023 09:45:13 +0000"  >&lt;p&gt;Weirdly, I had the same case than &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dengziming&quot; class=&quot;user-hover&quot; rel=&quot;dengziming&quot;&gt;dengziming&lt;/a&gt;, without any output, but this morning I&apos;ve the same exception message than &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lirangazer&quot; class=&quot;user-hover&quot; rel=&quot;lirangazer&quot;&gt;lirangazer&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;The difference is perhaps because the server was running today but stopped yesterday : maybe a race condition causes the error when the topic is written by server during dump ?&lt;/p&gt;

&lt;p&gt;How can we help to diagnose the problem ? Is there a debug mode ?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17782882" author="JIRAUSER302935" created="Sat, 4 Nov 2023 14:10:19 +0000"  >&lt;p&gt;It becomes more and more weird ...&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;with stopped node, command hangs on &quot;loading...&quot;&lt;/li&gt;
	&lt;li&gt;if I set &lt;tt&gt;log4j.rootLogger=INFO&lt;/tt&gt;, I get the prompt&lt;/li&gt;
	&lt;li&gt;with started server, I often get the NonWritableChannelException but sometimes&#160;I get the prompt&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;When I got the prompt, exploring node tree works fine&lt;/p&gt;</comment>
                            <comment id="17805460" author="JIRAUSER303430" created="Thu, 11 Jan 2024 09:24:28 +0000"  >&lt;p&gt;I was never able to read the metadata in the cluster. Versions kafka 3.6.0&lt;/p&gt;

&lt;p&gt;./bin/kafka-metadata-shell.sh -s ../kafka_2.13-3.6.0/log/__cluster_metadata-0/00000000000008838965.log&lt;br/&gt;
Loading...&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2024-01-11 12:23:15,640&amp;#93;&lt;/span&gt; ERROR Encountered shell fault: Error loading metadata log record from offset 100320740 (org.apache.kafka.server.fault.LoggingFaultH&lt;br/&gt;
andler)&lt;br/&gt;
java.lang.IllegalStateException: Tried to change broker 2, but that broker was not registered.&lt;br/&gt;
&#160; &#160; &#160; &#160; at org.apache.kafka.image.ClusterDelta.getBrokerOrThrow(ClusterDelta.java:83)&lt;br/&gt;
&#160; &#160; &#160; &#160; at org.apache.kafka.image.ClusterDelta.replay(ClusterDelta.java:112)&lt;br/&gt;
&#160; &#160; &#160; &#160; at org.apache.kafka.image.MetadataDelta.replay(MetadataDelta.java:321)&lt;br/&gt;
&#160; &#160; &#160; &#160; at org.apache.kafka.image.MetadataDelta.replay(MetadataDelta.java:229)&lt;br/&gt;
&#160; &#160; &#160; &#160; at org.apache.kafka.image.loader.MetadataBatchLoader.replay(MetadataBatchLoader.java:257)&lt;br/&gt;
&#160; &#160; &#160; &#160; at org.apache.kafka.image.loader.MetadataBatchLoader.loadBatch(MetadataBatchLoader.java:135)&lt;br/&gt;
&#160; &#160; &#160; &#160; at org.apache.kafka.image.loader.MetadataLoader.lambda$handleCommit$1(MetadataLoader.java:361)&lt;br/&gt;
&#160; &#160; &#160; &#160; at org.apache.kafka.queue.KafkaEventQueue$EventContext.run(KafkaEventQueue.java:127) &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; at org.apache.kafka.queue.KafkaEventQueue$EventHandler.handleEvents(KafkaEventQueue.java:210)&lt;br/&gt;
&#160; &#160; &#160; &#160; at org.apache.kafka.queue.KafkaEventQueue$EventHandler.run(KafkaEventQueue.java:181)&lt;br/&gt;
&#160; &#160; &#160; &#160; at java.base/java.lang.Thread.run(Thread.java:840)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2024-01-11 12:23:15,645&amp;#93;&lt;/span&gt; ERROR Encountered shell fault: Error loading metadata log record from offset 100320741 (org.apache.kafka.server.fault.LoggingFaultH&lt;br/&gt;
andler)&lt;br/&gt;
java.lang.NullPointerException: Cannot invoke &quot;org.apache.kafka.image.TopicImage.partitions()&quot; because &quot;this.image&quot; is null&lt;br/&gt;
&#160; &#160; &#160; &#160; at org.apache.kafka.image.TopicDelta.replay(TopicDelta.java:76)&lt;br/&gt;
&#160; &#160; &#160; &#160; at org.apache.kafka.image.TopicsDelta.replay(TopicsDelta.java:93)&lt;br/&gt;
&#160; &#160; &#160; &#160; at org.apache.kafka.image.MetadataDelta.replay(MetadataDelta.java:277)&lt;br/&gt;
&#160; &#160; &#160; &#160; at org.apache.kafka.image.MetadataDelta.replay(MetadataDelta.java:202)&lt;br/&gt;
&#160; &#160; &#160; &#160; at org.apache.kafka.image.loader.MetadataBatchLoader.replay(MetadataBatchLoader.java:257)&lt;br/&gt;
&#160; &#160; &#160; &#160; at org.apache.kafka.image.loader.MetadataBatchLoader.loadBatch(MetadataBatchLoader.java:135)&lt;br/&gt;
&#160; &#160; &#160; &#160; at org.apache.kafka.image.loader.MetadataLoader.lambda$handleCommit$1(MetadataLoader.java:361)&lt;br/&gt;
&#160; &#160; &#160; &#160; at org.apache.kafka.queue.KafkaEventQueue$EventContext.run(KafkaEventQueue.java:127) &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; at org.apache.kafka.queue.KafkaEventQueue$EventHandler.handleEvents(KafkaEventQueue.java:210)&lt;br/&gt;
&#160; &#160; &#160; &#160; at org.apache.kafka.queue.KafkaEventQueue$EventHandler.run(KafkaEventQueue.java:181)&lt;br/&gt;
&#160; &#160; &#160; &#160; at java.base/java.lang.Thread.run(Thread.java:840)&lt;/p&gt;</comment>
                            <comment id="17868447" author="JIRAUSER306317" created="Wed, 24 Jul 2024 18:34:35 +0000"  >&lt;p&gt;Facing similar error message as &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=endoftime&quot; class=&quot;user-hover&quot; rel=&quot;endoftime&quot;&gt;endoftime&lt;/a&gt; , but executing a different workflow:&lt;/p&gt;

&lt;p&gt;3 Node cluster with instance of Kafka in KRaft mode running on each node.&#160;&lt;br/&gt;
Simulating an unexpected shutdown by powering off all VMs in the cluster. Then, bringing them back by powering on all the VMs.&lt;br/&gt;
We see Kafka-1 and Kafka-2 pods (previously hot standbys before shutdown) restart successfully, but Kafka-0 pod status goes into Crash Loop Backoff.&#160;&lt;/p&gt;

&lt;p&gt;Checking the logs of Kafka-0 we see:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;2024-07-22 22:40:00,622&amp;#93;&lt;/span&gt; ERROR Encountered fatal fault: Error loading metadata log record from offset 8683181 (org.apache.kafka.server.fault.ProcessTerminatingFaultHandler)&lt;/p&gt;

&lt;p&gt;java.lang.IllegalStateException: Tried to change broker 1, but that broker was not registered.&lt;/p&gt;

&lt;p&gt;at org.apache.kafka.image.ClusterDelta.getBrokerOrThrow(ClusterDelta.java:83)&lt;/p&gt;

&lt;p&gt;at org.apache.kafka.image.ClusterDelta.replay(ClusterDelta.java:112)&lt;/p&gt;

&lt;p&gt;at org.apache.kafka.image.MetadataDelta.replay(MetadataDelta.java:321)&lt;/p&gt;

&lt;p&gt;at org.apache.kafka.image.MetadataDelta.replay(MetadataDelta.java:229)&lt;/p&gt;

&lt;p&gt;at org.apache.kafka.image.loader.MetadataBatchLoader.replay(MetadataBatchLoader.java:257)&lt;/p&gt;

&lt;p&gt;at org.apache.kafka.image.loader.MetadataBatchLoader.loadBatch(MetadataBatchLoader.java:135)&lt;/p&gt;

&lt;p&gt;at org.apache.kafka.image.loader.MetadataLoader.lambda$handleCommit$1(MetadataLoader.java:361)&lt;/p&gt;

&lt;p&gt;at org.apache.kafka.queue.KafkaEventQueue$EventContext.run(KafkaEventQueue.java:127)&lt;/p&gt;

&lt;p&gt;at org.apache.kafka.queue.KafkaEventQueue$EventHandler.handleEvents(KafkaEventQueue.java:210)&lt;/p&gt;

&lt;p&gt;at org.apache.kafka.queue.KafkaEventQueue$EventHandler.run(KafkaEventQueue.java:181)&lt;/p&gt;

&lt;p&gt;at java.base/java.lang.Thread.run(Thread.java:829)&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Cleaning up the log files for corresponding broker resolves the issue &#8211; it is able to come up and join the quorum, but this is not an ideal or preferred solution to the issue.&#160;&lt;/p&gt;

&lt;p&gt;Why does this happen exactly? And how can the broker recover after powering down the nodes, without a manual cleaning up of its logs?&#160;&lt;/p&gt;

&lt;p&gt;Kafka Version: 3.6.0&#160;&lt;/p&gt;

&lt;p&gt;Steps to reproduce:&lt;/p&gt;

&lt;p&gt;1. Bring up Kafka (KRaft mode) on 3 Node cluster.&lt;br/&gt;
2. Power off VMs.&#160;&lt;br/&gt;
3. Restart VMs. 2 Kafka pods will enter Ready state, the last will go into Crash Loop Backoff.&#160;&lt;/p&gt;</comment>
                            <comment id="17932559" author="chia7712" created="Wed, 5 Mar 2025 09:10:35 +0000"  >&lt;p&gt;the metadata shell is used to read snapshot (checkpoint) file rather than log file. &lt;a href=&quot;https://github.com/apache/kafka/pull/19103&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/19103&lt;/a&gt; is going to update the docs.&lt;/p&gt;</comment>
                            <comment id="17932594" author="dengziming" created="Wed, 5 Mar 2025 11:16:26 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chia7712&quot; class=&quot;user-hover&quot; rel=&quot;chia7712&quot;&gt;chia7712&lt;/a&gt; As far as I can see, the .log file has the same format with .checkpoint file, right? so this problem still makes sense, it&apos;s worth checking it.&lt;/p&gt;</comment>
                            <comment id="17941927" author="chia7712" created="Tue, 8 Apr 2025 15:32:34 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gongxuanzhang&quot; class=&quot;user-hover&quot; rel=&quot;gongxuanzhang&quot;&gt;gongxuanzhang&lt;/a&gt; will file a patch for it!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13062236" name="image-2023-08-17-10-35-01-039.png" size="274575" author="dengziming" created="Thu, 17 Aug 2023 02:35:02 +0000"/>
                            <attachment id="13062235" name="image-2023-08-17-10-35-36-067.png" size="274575" author="dengziming" created="Thu, 17 Aug 2023 02:35:38 +0000"/>
                            <attachment id="13064004" name="image-2023-10-31-09-04-53-966.png" size="161800" author="lirangazer" created="Tue, 31 Oct 2023 07:04:54 +0000"/>
                            <attachment id="13064005" name="image-2023-10-31-09-11-53-118.png" size="161800" author="lirangazer" created="Tue, 31 Oct 2023 07:11:53 +0000"/>
                            <attachment id="13064006" name="image-2023-10-31-09-12-19-051.png" size="16044" author="lirangazer" created="Tue, 31 Oct 2023 07:12:19 +0000"/>
                            <attachment id="13064007" name="image-2023-10-31-09-15-34-821.png" size="31335" author="lirangazer" created="Tue, 31 Oct 2023 07:15:35 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            31 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1ju8w:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>