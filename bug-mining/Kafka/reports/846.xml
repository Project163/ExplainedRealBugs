<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:48:50 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-2805] RecordAccumulator request timeout not enforced when all brokers are gone</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-2805</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;When no brokers are left in the cluster, the producer seems not to enforce the request timeout as expected.&lt;/p&gt;

&lt;p&gt;From the user mailing list, the null check in batch expiration in RecordAccumulator seems questionable: &lt;a href=&quot;https://github.com/apache/kafka/blob/ae5a5d7c08bb634576a414f6f2864c5b8a7e58a3/clients/src/main/java/org/apache/kafka/clients/producer/internals/RecordAccumulator.java#L220&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/ae5a5d7c08bb634576a414f6f2864c5b8a7e58a3/clients/src/main/java/org/apache/kafka/clients/producer/internals/RecordAccumulator.java#L220&lt;/a&gt;. &lt;/p&gt;

&lt;p&gt;If this is correct behavior, it is probably worthwhile clarifying the purpose of the check in a comment.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12912047">KAFKA-2805</key>
            <summary>RecordAccumulator request timeout not enforced when all brokers are gone</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mgharat">Mayuresh Gharat</assignee>
                                    <reporter username="hachikuji">Jason Gustafson</reporter>
                        <labels>
                    </labels>
                <created>Wed, 11 Nov 2015 01:51:37 +0000</created>
                <updated>Thu, 12 Nov 2015 02:42:46 +0000</updated>
                            <resolved>Thu, 12 Nov 2015 02:42:46 +0000</resolved>
                                                    <fixVersion>0.9.0.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="14999792" author="hachikuji" created="Wed, 11 Nov 2015 01:52:38 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mgharat&quot; class=&quot;user-hover&quot; rel=&quot;mgharat&quot;&gt;mgharat&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=becket_qin&quot; class=&quot;user-hover&quot; rel=&quot;becket_qin&quot;&gt;becket_qin&lt;/a&gt; Do you have any thoughts?&lt;/p&gt;</comment>
                            <comment id="14999828" author="junrao" created="Wed, 11 Nov 2015 02:23:55 +0000"  >&lt;p&gt;From the RB, that&apos;s the explanation from Mayuresh.&lt;/p&gt;

&lt;p&gt;In this case :&quot; Second, let&apos;s say the producer can&apos;t connect to any broker. The producer can&apos;t refresh the metdata. So the leader will still be the old one and may not be null. In this case, it seems that we should still expire the records.&quot;, the request will eventually fail due to requestTimeout and retry exhaustion, when trying to send to broker.&lt;/p&gt;

&lt;p&gt;What he is saying is that if the leader is not null, we will be keep resending to the leader broker that may not be reachable and eventually the request will error out when all retries are exhausted.&lt;/p&gt;</comment>
                            <comment id="14999844" author="mgharat" created="Wed, 11 Nov 2015 02:41:59 +0000"  >&lt;p&gt;Yes. That was the thinking. Also from the KIP-19 discussion it was decided that Request timeout will also be used when the batches in the accumulator that are ready but not drained due to metadata missing - we are reusing request timeout to timeout the batches in accumulator. When we say metadata is missing, it means that we don&apos;t have information about the leader.&lt;/p&gt;
</comment>
                            <comment id="14999858" author="hachikuji" created="Wed, 11 Nov 2015 02:59:45 +0000"  >&lt;p&gt;I was able to reproduce this following the steps from Luke Steensen&apos;s initial e-mail:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;# in separate terminals
$ ./bin/zookeeper-server-start.sh config/zookeeper.properties
$ ./bin/kafka-server-start.sh config/server.properties

# set request timeout
$ cat producer.properties
request.timeout.ms=1000

# run the verifiable producer, &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; example
$ ./bin/kafka-verifiable-producer.sh --broker-list localhost:9092 --topic
testing --throughput 5 --producer.config producer.properties
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
&lt;p&gt;If you then kill the kafka server process, you will see the producer hang&lt;br/&gt;
indefinitely. This is a very simple case, but the behavior is surprising.&lt;br/&gt;
We have also found it easy to reproduce this behavior in more realistic&lt;br/&gt;
environments with multiple brokers, custom producers, etc. The end result&lt;br/&gt;
is that we&apos;re not sure how to safely decommission a broker without&lt;br/&gt;
potentially leaving a producer with a permanently stuck request.&lt;/p&gt;&lt;/blockquote&gt;</comment>
                            <comment id="14999884" author="mgharat" created="Wed, 11 Nov 2015 03:29:14 +0000"  >&lt;p&gt;I did this experiment :&lt;/p&gt;

&lt;p&gt;1) I created a topic called &quot;kip-19-followup&quot; on one of our test cluster with 1 partition and replication factor 1.&lt;/p&gt;

&lt;p&gt;2) started the producer class :&lt;br/&gt;
./kafka-verifiable-producer.sh --topic kip-19-followup --broker-list (BROKER LIST) --max-messages 92233736 --acks 1&lt;/p&gt;

&lt;p&gt;3) The producer started producing  and I could see : &lt;/p&gt;
{&quot;partition&quot;:0,&quot;offset&quot;:3164368,&quot;time_ms&quot;:1447212192651,&quot;name&quot;:&quot;producer_send_success&quot;,&quot;topic&quot;:&quot;kip-19-followup&quot;,&quot;class&quot;:&quot;class org.apache.kafka.tools.VerifiableProducer&quot;,&quot;value&quot;:&quot;9547&quot;,&quot;key&quot;:null}

&lt;p&gt;4) Then I killed the broker that was hosting this topic and I could see :&lt;/p&gt;
{&quot;exception&quot;:&quot;class org.apache.kafka.common.errors.TimeoutException&quot;,&quot;time_ms&quot;:1447212028704,&quot;name&quot;:&quot;producer_send_error&quot;,&quot;topic&quot;:&quot;kip-19-followup&quot;,&quot;message&quot;:&quot;Batch Expired&quot;,&quot;class&quot;:&quot;class org.apache.kafka.tools.VerifiableProducer&quot;,&quot;value&quot;:&quot;107100&quot;,&quot;key&quot;:null}

&lt;p&gt;The producer did not hang. My broker is not on trunk though.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Mayuresh&lt;/p&gt;</comment>
                            <comment id="14999913" author="hachikuji" created="Wed, 11 Nov 2015 03:58:41 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mgharat&quot; class=&quot;user-hover&quot; rel=&quot;mgharat&quot;&gt;mgharat&lt;/a&gt; I was on trunk when I reproduced the problem. Perhaps something changed affecting the retry logic? It still seems a little puzzling to me that these cases are handled differently. If the timeout has expired before the batch could be sent, seems like you&apos;d want to expire regardless of the reason.&lt;/p&gt;</comment>
                            <comment id="14999924" author="mgharat" created="Wed, 11 Nov 2015 04:16:35 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hachikuji&quot; class=&quot;user-hover&quot; rel=&quot;hachikuji&quot;&gt;hachikuji&lt;/a&gt; My producer was on trunk when I ran this test. But my request timeout was set to 30 seconds instead of 1 sec. I will test this tomorrow again and keep a patch ready if required.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Mayuresh&lt;/p&gt;</comment>
                            <comment id="15000633" author="junrao" created="Wed, 11 Nov 2015 16:41:41 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mgharat&quot; class=&quot;user-hover&quot; rel=&quot;mgharat&quot;&gt;mgharat&lt;/a&gt;, I am not sure if the current logic works. If the leader is not null and is for a broker not connectable, in Sender.run(), the partitions for this leader will be ready, but are drainable since the leader is not connectable. So, messages in those partitions will never timeout in the current logic. &lt;/p&gt;

&lt;p&gt;In Jason&apos;s test, you can get into the above situation when the only broker is killed since metadata won&apos;t be refreshed after the broker is down. In your test, if you provided multiple brokers in broker list, things are a bit different. The producer will be able to refresh metadata from other brokers and see the leader is gone. In this case, the producer will see a null leader. That&apos;s probably why you don&apos;t see the issue in your test. In both case, the effect is pretty much the same---we can&apos;t send the partitions&apos; data. So, the simplest solution is probably to remove the null check on leader in abortExpiredBatches(). If the leader can&apos;t be connected for a long period of time, the partitions are guaranteed to be drained. If the leader is connectable, but the send fails (e.g., due to NotLeader), lastAttemptMs will be updated and we will go through the retries. Does that sound reasonable?&lt;/p&gt;</comment>
                            <comment id="15000636" author="junrao" created="Wed, 11 Nov 2015 16:43:04 +0000"  >&lt;p&gt;Marking this as an 0.9.0.0 blocker for now.&lt;/p&gt;</comment>
                            <comment id="15000651" author="lukesteensen" created="Wed, 11 Nov 2015 16:49:06 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mgharat&quot; class=&quot;user-hover&quot; rel=&quot;mgharat&quot;&gt;mgharat&lt;/a&gt; To answer your question from the mailing list, I was only running one broker in the cluster for this case. My intention was to do a simple test of the new behavior before pushing the new version to one of our deployed environments. &lt;/p&gt;

&lt;p&gt;It&apos;s worth noting that you can get this same behavior with the following producer config:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;retries=0
max.block.ms=1000
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I will continue testing, but it does seem that the configs are respected when running more than one broker. &lt;/p&gt;

&lt;p&gt;Thanks for taking a look!&lt;br/&gt;
Luke&lt;/p&gt;</comment>
                            <comment id="15000891" author="junrao" created="Wed, 11 Nov 2015 18:55:53 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mgharat&quot; class=&quot;user-hover&quot; rel=&quot;mgharat&quot;&gt;mgharat&lt;/a&gt;, since this blocks the 0.9.0.0 release, do you think you can look at this in the next few hours?&lt;/p&gt;</comment>
                            <comment id="15001004" author="hachikuji" created="Wed, 11 Nov 2015 20:14:52 +0000"  >&lt;p&gt;Went ahead and assigned to myself to try and unblock the release. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mgharat&quot; class=&quot;user-hover&quot; rel=&quot;mgharat&quot;&gt;mgharat&lt;/a&gt; If you&apos;re already working on it, feel free to assign it back to you.&lt;/p&gt;</comment>
                            <comment id="15001024" author="mgharat" created="Wed, 11 Nov 2015 20:24:42 +0000"  >&lt;p&gt;Hi Jason,&lt;/p&gt;

&lt;p&gt;I was debugging to find exactly what is happening. Is it ok if I can get back with a patch ( if necessary ) by EOD.&lt;br/&gt;
If I am not able to finish this today, you can go ahead with this jira. Is it ok?&lt;/p&gt;

&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Mayuresh&lt;/p&gt;</comment>
                            <comment id="15001040" author="hachikuji" created="Wed, 11 Nov 2015 20:31:28 +0000"  >&lt;p&gt;Works for me. I&apos;ll assign back to you.&lt;/p&gt;</comment>
                            <comment id="15001495" author="githubbot" created="Thu, 12 Nov 2015 02:04:24 +0000"  >&lt;p&gt;GitHub user MayureshGharat opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/503&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/503&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-2805&quot; title=&quot;RecordAccumulator request timeout not enforced when all brokers are gone&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-2805&quot;&gt;&lt;del&gt;KAFKA-2805&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Removed the check for only those expiring batches whose metadata is unavailable. Now the batches will be expired irrespective of whether the leader is available or not, as soon as it reaches the requestimeout threshold.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/MayureshGharat/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/MayureshGharat/kafka&lt;/a&gt; kafka-2805&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/503.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/503.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #503&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 573c68b9ee3107a50c96d383e22dd415fc39b96f&lt;br/&gt;
Author: Mayuresh Gharat &amp;lt;mgharat@mgharat-ld1.linkedin.biz&amp;gt;&lt;br/&gt;
Date:   2015-11-12T01:42:46Z&lt;/p&gt;

&lt;p&gt;    Removed the check for only those expiring batches whose metadata is unavailable. Now the batches will be expired irrespective of whether the leader is available or not, as soon as it reaches the requestimeout threshold&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15001559" author="mgharat" created="Thu, 12 Nov 2015 02:14:28 +0000"  >&lt;p&gt;Yes. That s right. The check was put in place because the KIP-19 explicitly mentioned that it should timeout the batches only if the metadata is unavailable. I debugged this today and found the same reasoning. I was going to write the same explanation before I read this comment. &lt;/p&gt;

&lt;p&gt;My bad, I should have considered that accumulator will not drain the batches for NOT ready nodes and the batches will not be expired since the metadata is stale and has the leader present. I have uploaded a patch for removing the check. &lt;/p&gt;</comment>
                            <comment id="15001598" author="githubbot" created="Thu, 12 Nov 2015 02:42:07 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/503&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/503&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15001600" author="junrao" created="Thu, 12 Nov 2015 02:42:46 +0000"  >&lt;p&gt;Issue resolved by pull request 503&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/kafka/pull/503&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/503&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 1 week, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2o86f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>