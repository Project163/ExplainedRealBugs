<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:24:35 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-10049] KTable-KTable Foreign Key join throwing Serialization Exception </title>
                <link>https://issues.apache.org/jira/browse/KAFKA-10049</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;&#160;I want to make use of &lt;em&gt;KTable-KTable&lt;/em&gt; Foreign Key join feature released in &lt;b&gt;&lt;em&gt;2.5.0&lt;/em&gt;&lt;/b&gt;&#160;but facing issue while running the code.&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&#160;

 &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void main(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] args) {

     Properties props = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Properties();
     props.put(StreamsConfig.APPLICATION_ID_CONFIG, &lt;span class=&quot;code-quote&quot;&gt;&quot;my-stream-processing-application-2&quot;&lt;/span&gt;);
     props.put(StreamsConfig.BOOTSTRAP_SERVERS_CONFIG, &lt;span class=&quot;code-quote&quot;&gt;&quot;localhost:9092&quot;&lt;/span&gt;);
     props.put(StreamsConfig.DEFAULT_KEY_SERDE_CLASS_CONFIG, Serdes.&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;().getClass());
     props.put(StreamsConfig.DEFAULT_VALUE_SERDE_CLASS_CONFIG, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; JSONSerdeComp&amp;lt;&amp;gt;().getClass());
     props.put(StreamsConfig.STATE_DIR_CONFIG, &lt;span class=&quot;code-quote&quot;&gt;&quot;C:\\temp&quot;&lt;/span&gt;);
     props.put(ConsumerConfig.AUTO_OFFSET_RESET_CONFIG, &lt;span class=&quot;code-quote&quot;&gt;&quot;earliest&quot;&lt;/span&gt;);

     StreamsBuilder builder = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; StreamsBuilder();
     KTable&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, OrderObject&amp;gt; ordersTable = builder.&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, OrderObject&amp;gt;table(TOPIC_Agora);
     KTable&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, StockMarketData&amp;gt; stockTable = builder.&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, StockMarketData&amp;gt;table(TOPIC_Stock_Data);

     KTable&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, EnrichedOrder&amp;gt; enriched = ordersTable.leftJoin(stockTable, OrderObject:: getSymbol, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ValueJoiner&amp;lt;OrderObject, StockMarketData, EnrichedOrder&amp;gt;() {

            @Override
            &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; EnrichedOrder apply(OrderObject order, StockMarketData stock) {
                EnrichedOrder enOrder = EnrichedOrder.builder()
                        .orderId(order.getOrderId())
                        .execPrice(order.getPrice())
                        .symbol(order.getSymbol())
                        .quanity(order.getQuanity())
                        .side(order.getSide())
                        .filledQty(order.getFilledQty())
                        .leaveQty(order.getLeaveQty())
                        .index(order.getIndex())
                        .vWaprelative(order.getVWaprelative())
                        .stockAsk(stock!=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;?stock.getAsk().doubleValue():0.0)
                        .stockBid(stock!=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;?stock.getBid().doubleValue():0.0)
                        .stockLast(stock!=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;?stock.getLast().doubleValue():0.0)
                        .stockClose(stock!=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;?stock.getClose().doubleValue():0.0)
                        .build();
                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; enOrder;
            }
        } , Materialized.with(Serdes.&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;(), &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; JSONSerdeComp&amp;lt;&amp;gt;()));

     enriched.toStream().foreach(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ForeachAction&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, EnrichedOrder&amp;gt;() \{
         @Override
        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void apply(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; arg0, EnrichedOrder arg1) {

             logger.info(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.format(&lt;span class=&quot;code-quote&quot;&gt;&quot;key = %s, value = %s&quot;&lt;/span&gt;, arg0, arg1));
        }
    });

     KafkaStreams streams = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; KafkaStreams(builder.build(), props);
     streams.start();

     &lt;span class=&quot;code-object&quot;&gt;Runtime&lt;/span&gt;.getRuntime().addShutdownHook(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;(() -&amp;gt; streams.close()));
}}}



&#160;

    &amp;lt;dependency&amp;gt;
        &amp;lt;groupId&amp;gt;org.apache.kafka&amp;lt;/groupId&amp;gt;
        &amp;lt;artifactId&amp;gt;kafka-clients&amp;lt;/artifactId&amp;gt;
        &amp;lt;version&amp;gt;2.5.0&amp;lt;/version&amp;gt;
    &amp;lt;/dependency&amp;gt;
    &amp;lt;dependency&amp;gt;
        &amp;lt;groupId&amp;gt;org.apache.kafka&amp;lt;/groupId&amp;gt;
        &amp;lt;artifactId&amp;gt;kafka-streams&amp;lt;/artifactId&amp;gt;
        &amp;lt;version&amp;gt;2.5.0&amp;lt;/version&amp;gt;
    &amp;lt;/dependency&amp;gt;

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;b&gt;&lt;ins&gt;Exception:&lt;/ins&gt;&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
18:49:31.525 [my-stream-processing-application-2-37cfd34a-6eb4-411a-a2dc-faa9194ce04e-StreamThread-1] ERROR org.apache.kafka.streams.processor.internals.ProcessorStateManager - stream-thread [my-stream-processing-application-2-37cfd34a-6eb4-411a-a2dc-faa9194ce04e-StreamThread-1] task [0_0] Failed to flush state store orders-STATE-STORE-0000000000: 
    org.apache.kafka.streams.errors.StreamsException: ClassCastException &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; producing data to a sink topic. A serializer (key: org.apache.kafka.common.serialization.StringSerializer / value: org.apache.kafka.streams.kstream.internals.foreignkeyjoin.SubscriptionWrapperSerde$SubscriptionWrapperSerializer) is not compatible to the actual key or value type (key type: java.lang.&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; / value type: org.apache.kafka.streams.kstream.internals.foreignkeyjoin.SubscriptionWrapper). Change the &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt; Serdes in StreamConfig or provide correct Serdes via method parameters (&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; example &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; using the DSL, `#to(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; topic, Produced&amp;lt;K, V&amp;gt; produced)` with `Produced.keySerde(WindowedSerdes.timeWindowedSerdeFrom(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.class))`).
        at org.apache.kafka.streams.processor.internals.SinkNode.process(SinkNode.java:94) ~[kafka-streams-2.5.0.jar:?]
        at org.apache.kafka.streams.processor.internals.ProcessorContextImpl.forward(ProcessorContextImpl.java:201) ~[kafka-streams-2.5.0.jar:?]
        at org.apache.kafka.streams.processor.internals.ProcessorContextImpl.forward(ProcessorContextImpl.java:180) ~[kafka-streams-2.5.0.jar:?]
        at org.apache.kafka.streams.processor.internals.ProcessorContextImpl.forward(ProcessorContextImpl.java:133) ~[kafka-streams-2.5.0.jar:?]
        at org.apache.kafka.streams.kstream.internals.foreignkeyjoin.ForeignJoinSubscriptionSendProcessorSupplier$UnbindChangeProcessor.process(ForeignJoinSubscriptionSendProcessorSupplier.java:157) ~[kafka-streams-2.5.0.jar:?]
        at org.apache.kafka.streams.kstream.internals.foreignkeyjoin.ForeignJoinSubscriptionSendProcessorSupplier$UnbindChangeProcessor.process(ForeignJoinSubscriptionSendProcessorSupplier.java:71) ~[kafka-streams-2.5.0.jar:?]
        at org.apache.kafka.streams.processor.internals.ProcessorNode.lambda$process$2(ProcessorNode.java:142) ~[kafka-streams-2.5.0.jar:?]
        at org.apache.kafka.streams.processor.internals.metrics.StreamsMetricsImpl.maybeMeasureLatency(StreamsMetricsImpl.java:806) ~[kafka-streams-2.5.0.jar:?]
        at org.apache.kafka.streams.processor.internals.ProcessorNode.process(ProcessorNode.java:142) ~[kafka-streams-2.5.0.jar:?]
        at org.apache.kafka.streams.processor.internals.ProcessorContextImpl.forward(ProcessorContextImpl.java:201) ~[kafka-streams-2.5.0.jar:?]
        at org.apache.kafka.streams.processor.internals.ProcessorContextImpl.forward(ProcessorContextImpl.java:180) ~[kafka-streams-2.5.0.jar:?]
        at org.apache.kafka.streams.kstream.internals.TimestampedCacheFlushListener.apply(TimestampedCacheFlushListener.java:45) ~[kafka-streams-2.5.0.jar:?]
        at org.apache.kafka.streams.kstream.internals.TimestampedCacheFlushListener.apply(TimestampedCacheFlushListener.java:28) ~[kafka-streams-2.5.0.jar:?]
        at org.apache.kafka.streams.state.internals.MeteredKeyValueStore.lambda$setFlushListener$1(MeteredKeyValueStore.java:119) ~[kafka-streams-2.5.0.jar:?]
        at org.apache.kafka.streams.state.internals.CachingKeyValueStore.putAndMaybeForward(CachingKeyValueStore.java:92) ~[kafka-streams-2.5.0.jar:?]
        at org.apache.kafka.streams.state.internals.CachingKeyValueStore.lambda$initInternal$0(CachingKeyValueStore.java:72) ~[kafka-streams-2.5.0.jar:?]
        at org.apache.kafka.streams.state.internals.NamedCache.flush(NamedCache.java:151) ~[kafka-streams-2.5.0.jar:?]
        at org.apache.kafka.streams.state.internals.NamedCache.flush(NamedCache.java:109) ~[kafka-streams-2.5.0.jar:?]
        at org.apache.kafka.streams.state.internals.ThreadCache.flush(ThreadCache.java:124) ~[kafka-streams-2.5.0.jar:?]
        at org.apache.kafka.streams.state.internals.CachingKeyValueStore.flush(CachingKeyValueStore.java:272) ~[kafka-streams-2.5.0.jar:?]
        at org.apache.kafka.streams.state.internals.WrappedStateStore.flush(WrappedStateStore.java:84) ~[kafka-streams-2.5.0.jar:?]
        at org.apache.kafka.streams.state.internals.MeteredKeyValueStore.lambda$flush$7(MeteredKeyValueStore.java:192) ~[kafka-streams-2.5.0.jar:?]
        at org.apache.kafka.streams.processor.internals.metrics.StreamsMetricsImpl.maybeMeasureLatency(StreamsMetricsImpl.java:806) ~[kafka-streams-2.5.0.jar:?]
        at org.apache.kafka.streams.state.internals.MeteredKeyValueStore.flush(MeteredKeyValueStore.java:192) ~[kafka-streams-2.5.0.jar:?]
        at org.apache.kafka.streams.processor.internals.ProcessorStateManager.flush(ProcessorStateManager.java:282) [kafka-streams-2.5.0.jar:?]
        at org.apache.kafka.streams.processor.internals.AbstractTask.flushState(AbstractTask.java:177) [kafka-streams-2.5.0.jar:?]
        at org.apache.kafka.streams.processor.internals.StreamTask.flushState(StreamTask.java:554) [kafka-streams-2.5.0.jar:?]
        at org.apache.kafka.streams.processor.internals.StreamTask.commit(StreamTask.java:490) [kafka-streams-2.5.0.jar:?]
        at org.apache.kafka.streams.processor.internals.StreamTask.commit(StreamTask.java:478) [kafka-streams-2.5.0.jar:?]
        at org.apache.kafka.streams.processor.internals.AssignedTasks.commit(AssignedTasks.java:226) [kafka-streams-2.5.0.jar:?]
        at org.apache.kafka.streams.processor.internals.TaskManager.commitAll(TaskManager.java:543) [kafka-streams-2.5.0.jar:?]
        at org.apache.kafka.streams.processor.internals.StreamThread.maybeCommit(StreamThread.java:977) [kafka-streams-2.5.0.jar:?]
        at org.apache.kafka.streams.processor.internals.StreamThread.runOnce(StreamThread.java:823) [kafka-streams-2.5.0.jar:?]
        at org.apache.kafka.streams.processor.internals.StreamThread.runLoop(StreamThread.java:697) [kafka-streams-2.5.0.jar:?]
        at org.apache.kafka.streams.processor.internals.StreamThread.run(StreamThread.java:670) [kafka-streams-2.5.0.jar:?]
    Caused by: java.lang.ClassCastException: java.lang.&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; cannot be &lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt; to com.messages.JSONSerdeCompatible
        at com.messages.JSONSerdeComp.serialize(JSONSerdeComp.java:1) ~[classes/:?]
        at org.apache.kafka.streams.kstream.internals.foreignkeyjoin.SubscriptionWrapperSerde$SubscriptionWrapperSerializer.serialize(SubscriptionWrapperSerde.java:79) ~[kafka-streams-2.5.0.jar:?]
        at org.apache.kafka.streams.kstream.internals.foreignkeyjoin.SubscriptionWrapperSerde$SubscriptionWrapperSerializer.serialize(SubscriptionWrapperSerde.java:51) ~[kafka-streams-2.5.0.jar:?]
        at org.apache.kafka.common.serialization.Serializer.serialize(Serializer.java:62) ~[kafka-clients-2.5.0.jar:?]
        at org.apache.kafka.streams.processor.internals.RecordCollectorImpl.send(RecordCollectorImpl.java:176) ~[kafka-streams-2.5.0.jar:?]
        at org.apache.kafka.streams.processor.internals.RecordCollectorImpl.send(RecordCollectorImpl.java:111) ~[kafka-streams-2.5.0.jar:?]
        at org.apache.kafka.streams.processor.internals.SinkNode.process(SinkNode.java:89) ~[kafka-streams-2.5.0.jar:?]
        ... 34 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13307633">KAFKA-10049</key>
            <summary>KTable-KTable Foreign Key join throwing Serialization Exception </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="abellemare">Adam Bellemare</assignee>
                                    <reporter username="amicngh">Amit Chauhan</reporter>
                        <labels>
                    </labels>
                <created>Wed, 27 May 2020 07:13:54 +0000</created>
                <updated>Fri, 12 Jun 2020 16:56:01 +0000</updated>
                            <resolved>Fri, 12 Jun 2020 16:56:01 +0000</resolved>
                                    <version>2.5.0</version>
                    <version>2.6.0</version>
                                    <fixVersion>2.5.1</fixVersion>
                    <fixVersion>2.6.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="17117922" author="vvcephei" created="Wed, 27 May 2020 16:55:49 +0000"  >&lt;p&gt;I&apos;ve marked this as a 2.6 blocker. It&apos;s not immediately clear to me what the root cause might be.&lt;/p&gt;</comment>
                            <comment id="17117933" author="mjsax" created="Wed, 27 May 2020 17:20:35 +0000"  >&lt;p&gt;Assigned the ticket to &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vvcephei&quot; class=&quot;user-hover&quot; rel=&quot;vvcephei&quot;&gt;vvcephei&lt;/a&gt;&#160;for now. Not sure if &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=abellemare&quot; class=&quot;user-hover&quot; rel=&quot;abellemare&quot;&gt;abellemare&lt;/a&gt;&#160;would be interested to pick it up?&#160;Think we should try to fix it for 2.6.0 if possible (and 2.5.1).&#160;We have like 2 weeks till code freeze.&lt;/p&gt;</comment>
                            <comment id="17117976" author="abellemare" created="Wed, 27 May 2020 18:12:09 +0000"  >&lt;p&gt;Is this us? I think this is their serializer complaining about their input types.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    Caused by: java.lang.ClassCastException: java.lang.&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; cannot be &lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt; to com.messages.JSONSerdeCompatible
        at com.messages.JSONSerdeComp.serialize(JSONSerdeComp.java:1) ~[classes/:?]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Isn&apos;t it that the com.messages.JSONSerdeComp.serialize() function is expecting a com.message.JSONSerdeCompatible?&lt;/p&gt;

&lt;p&gt;com.messages.* isn&apos;t showing up in maven repo for me, so I&apos;m pretty sure this is a private library issue.&lt;/p&gt;

&lt;p&gt;To &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=amicngh&quot; class=&quot;user-hover&quot; rel=&quot;amicngh&quot;&gt;amicngh&lt;/a&gt;, try using one of the basic StringSerdes instead and see if this still happens. The unit tests suggest it should not, but I just want to exclude the com.messages.JSONSerdeComp library before going any further.&lt;/p&gt;</comment>
                            <comment id="17118505" author="amicngh" created="Thu, 28 May 2020 09:46:54 +0000"  >&lt;p&gt;I am using JSON Compatible Serde form &lt;a href=&quot;https://github.com/apache/kafka/blob/2.3/streams/examples/src/main/java/org/apache/kafka/streams/examples/pageview/PageViewTypedDemo.java#L83&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;This Link.&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;JSONSerdeComp&amp;lt;T &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; JSONSerdeCompatible&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; Serializer&amp;lt;T&amp;gt;, Deserializer&amp;lt;T&amp;gt;, Serde&amp;lt;T&amp;gt; {
        &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ObjectMapper OBJECT_MAPPER = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ObjectMapper();

        @Override
        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void configure(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, ?&amp;gt; configs, &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isKey) {}

        @SuppressWarnings(&lt;span class=&quot;code-quote&quot;&gt;&quot;unchecked&quot;&lt;/span&gt;)
        @Override
        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; T deserialize(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; topic, &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] data) {
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (data == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
            }

            &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; (T) OBJECT_MAPPER.readValue(data, JSONSerdeCompatible.class);
            } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; IOException e) {
                &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SerializationException(e);
            }
        }

        @Override
        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] serialize(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; topic, &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; T data) {
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (data == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
            }

            &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; OBJECT_MAPPER.writeValueAsBytes(data);
            } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Exception e) {
                &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SerializationException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Error serializing JSON message&quot;&lt;/span&gt;, e);
            }
        }

        @Override
        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void close() {}

        @Override
        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; Serializer&amp;lt;T&amp;gt; serializer() {
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;;
        }

        @Override
        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; Deserializer&amp;lt;T&amp;gt; deserializer() {
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;;
        }
    }


   /**
     * An &lt;span class=&quot;code-keyword&quot;&gt;interface&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; registering types that can be de/serialized with {@link JSONSerde}.
     */
    @SuppressWarnings(&lt;span class=&quot;code-quote&quot;&gt;&quot;DefaultAnnotationParam&quot;&lt;/span&gt;) &lt;span class=&quot;code-comment&quot;&gt;// being explicit &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the example
&lt;/span&gt;    @JsonTypeInfo(use = JsonTypeInfo.Id.NAME, include = JsonTypeInfo.As.PROPERTY, property = &lt;span class=&quot;code-quote&quot;&gt;&quot;_t&quot;&lt;/span&gt;)
    @JsonSubTypes({
                      @JsonSubTypes.Type(value = OrderObject.class, name = &lt;span class=&quot;code-quote&quot;&gt;&quot;OrderObject&quot;&lt;/span&gt;),
                      @JsonSubTypes.Type(value = StockMarketData.class, name = &lt;span class=&quot;code-quote&quot;&gt;&quot;StockMarketData&quot;&lt;/span&gt;),
                      @JsonSubTypes.Type(value = EnrichedOrder.class, name = &lt;span class=&quot;code-quote&quot;&gt;&quot;EnrichedOrder&quot;&lt;/span&gt;),
           
                  })
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;interface&lt;/span&gt; JSONSerdeCompatible {

    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17118513" author="amicngh" created="Thu, 28 May 2020 09:52:30 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=abellemare&quot; class=&quot;user-hover&quot; rel=&quot;abellemare&quot;&gt;abellemare&lt;/a&gt;&#160;Don&apos;t know why it is expecting String while serializing value.&#160; In my case Key is String while value is&#160;&lt;ins&gt;JSONSerdeCompatible&lt;/ins&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17118533" author="amicngh" created="Thu, 28 May 2020 10:27:09 +0000"  >&lt;p&gt;worth mentioning here same application works with same primary key joins.&#160;&lt;/p&gt;</comment>
                            <comment id="17118937" author="abellemare" created="Thu, 28 May 2020 17:46:19 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=amicngh&quot; class=&quot;user-hover&quot; rel=&quot;amicngh&quot;&gt;amicngh&lt;/a&gt; Okay, I was able to reproduce it. I&apos;ll look into determining the root cause, but for now the easiest workaround is to use `Consumed.with` for both your input KTables:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
KTable&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, OrderObject&amp;gt; ordersTable = builder.&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, OrderObject&amp;gt;table(TOPIC_Agora, Consumed.with(Serdes.&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;(), &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; JSONSerde&amp;lt;&amp;gt;());
KTable&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, StockMarketData&amp;gt; stockTable = builder.&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, StockMarketData&amp;gt;table(TOPIC_Stock_Data, Consumed.with(Serdes.&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;(), &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; JSONSerde&amp;lt;&amp;gt;());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This will ensure the proper serializers / deserializers are being used.&lt;/p&gt;


&lt;p&gt;I&apos;m not entirely sure what&apos;s happening right now, but I had a similar issue previously where KTables without explicitly defined serdes via `Consumed.with` exhibited the same behaviour.&lt;/p&gt;</comment>
                            <comment id="17119014" author="abellemare" created="Thu, 28 May 2020 19:17:35 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vvcephei&quot; class=&quot;user-hover&quot; rel=&quot;vvcephei&quot;&gt;vvcephei&lt;/a&gt; Hey John, didn&apos;t you fix an issue around this a while back? This seems really familiar....&lt;/p&gt;</comment>
                            <comment id="17119197" author="abellemare" created="Fri, 29 May 2020 01:29:08 +0000"  >&lt;p&gt;Found the bug. The SubscriptionWrapperSerde wraps a Key Serde, but it is being overwritten by a valueSerde during init. Here&apos;s the line where the key is overwritten:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/streams/src/main/java/org/apache/kafka/streams/kstream/internals/foreignkeyjoin/SubscriptionWrapperSerde.java#L68&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/trunk/streams/src/main/java/org/apache/kafka/streams/kstream/internals/foreignkeyjoin/SubscriptionWrapperSerde.java#L68&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Here&apos;s the init where it calls setIfUnset (notice that it is passing in the valSerializer and valDeserializer, whereas SubscriptionWrapperSerde is expecting to be passed in a keySerde).&lt;br/&gt;
[https://github.com/apache/kafka/blob/trunk/streams/src/main/java/org/apache/kafka/streams/processor/internals/SinkNode.java#L72&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/streams/src/main/java/org/apache/kafka/streams/processor/internals/SourceNode.java#L92&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/trunk/streams/src/main/java/org/apache/kafka/streams/processor/internals/SourceNode.java#L92&lt;/a&gt;|https://github.com/apache/kafka/blob/trunk/streams/src/main/java/org/apache/kafka/streams/processor/internals/SinkNode.java#L72]&lt;/p&gt;

&lt;p&gt;I&apos;ll take a look at fixing it, but the workflow is fuzzy to me, so it may take a bit of time for me to understand it.&lt;/p&gt;</comment>
                            <comment id="17119771" author="vvcephei" created="Fri, 29 May 2020 17:10:29 +0000"  >&lt;p&gt;Woah, thanks for digging into that, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=abellemare&quot; class=&quot;user-hover&quot; rel=&quot;abellemare&quot;&gt;abellemare&lt;/a&gt; !&lt;/p&gt;

&lt;p&gt;That&apos;s 100% the bug, and it is a regression. It seems I&apos;m doomed to be haunted forever by my own code. This bug probably seems familiar because there have been like half a dozen bugs around the serdes for this feature. I don&apos;t think anyone could have predicted that the serdes would wind up to be the most complex part of foreign-key joins.&lt;/p&gt;

&lt;p&gt;The workflow is very fuzzy, because the &quot;default serde&quot; thing makes everything confusing. Hopefully we can fix it sometime soon.&lt;/p&gt;

&lt;p&gt;In the mean time, I think the safest thing to do is just let the wrapper serde itself decide whether it should wrap the key or value serde, since it happens to always be fixed by the type of the wrapper serde.&lt;/p&gt;

&lt;p&gt;What do you think about: &lt;a href=&quot;https://github.com/apache/kafka/pull/8756&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/8756&lt;/a&gt; ?&lt;/p&gt;

&lt;p&gt;Thanks for your help,&lt;/p&gt;

&lt;p&gt;-John&lt;/p&gt;</comment>
                            <comment id="17119810" author="mjsax" created="Fri, 29 May 2020 17:58:28 +0000"  >&lt;p&gt;Thanks for digging into it &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=abellemare&quot; class=&quot;user-hover&quot; rel=&quot;abellemare&quot;&gt;abellemare&lt;/a&gt;&#160;and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vvcephei&quot; class=&quot;user-hover&quot; rel=&quot;vvcephei&quot;&gt;vvcephei&lt;/a&gt;!&lt;/p&gt;</comment>
                            <comment id="17119818" author="abellemare" created="Fri, 29 May 2020 18:03:09 +0000"  >&lt;p&gt;Hey &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vvcephei&quot; class=&quot;user-hover&quot; rel=&quot;vvcephei&quot;&gt;vvcephei&lt;/a&gt;&#160; - thanks for the PR! I appreciate you taking a look!&lt;/p&gt;

&lt;p&gt;I took a look at it and noticed that the SourceNode wasn&apos;t updated, so I went ahead and did that one too. I also have included the test I was using to validate it (though it&apos;s not really ready to commit - this is dev-level testing). I have added it as a patch to this ticket (incorporating your changes as well).&lt;/p&gt;

&lt;p&gt;If you get a chance to integrate the changes first, great. If not, I will take a crack at it hopefully in the next few days to simplify the unit test down. Not sure if you think we should put it in, but I like how it exercises our code path with a serializer/deserializer that is very different than the standard primitive ones we tend to use. &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13004371/13004371_10049-bellemare.patch&quot; title=&quot;10049-bellemare.patch attached to KAFKA-10049&quot;&gt;10049-bellemare.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;I think it may have some value in ensuring that the default serdes work as expected when using the FKJ.&lt;/p&gt;</comment>
                            <comment id="17119824" author="vvcephei" created="Fri, 29 May 2020 18:14:40 +0000"  >&lt;p&gt;Thanks for the test, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=abellemare&quot; class=&quot;user-hover&quot; rel=&quot;abellemare&quot;&gt;abellemare&lt;/a&gt; ,&lt;/p&gt;

&lt;p&gt;Nice catch on the SourceNode.&lt;/p&gt;

&lt;p&gt;You&apos;re more than welcome to lead the fix for this. I just sent the PR as a way to communicate what I was thinking.&lt;/p&gt;

&lt;p&gt;How about I assign this ticket to you, and close my PR. Then, you can start your own PR, and I&apos;ll review it?&lt;/p&gt;

&lt;p&gt;I do think we should include the test. I didn&apos;t know that we already had jackson in the test scope; that makes the test much easier.&lt;/p&gt;

&lt;p&gt;Regarding the specific test, what do you think about modifying the org.apache.kafka.streams.kstream.internals.KTableKTableForeignKeyJoinScenarioTest instead of adding a new test?&lt;/p&gt;

&lt;p&gt;Looking at the methods in that class, it seems we intended to test for exactly this condition, but missed it because in the test, the key and value types are both String.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;-John&lt;/p&gt;</comment>
                            <comment id="17119834" author="abellemare" created="Fri, 29 May 2020 18:23:18 +0000"  >&lt;p&gt;Can do. I&apos;ll take care of it. Thanks for your help John, I greatly appreciate it!&lt;/p&gt;</comment>
                            <comment id="17120563" author="abellemare" created="Sun, 31 May 2020 14:50:07 +0000"  >&lt;p&gt;PR is up.&lt;/p&gt;</comment>
                            <comment id="17120564" author="abellemare" created="Sun, 31 May 2020 14:50:32 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=amicngh&quot; class=&quot;user-hover&quot; rel=&quot;amicngh&quot;&gt;amicngh&lt;/a&gt; for finding and reporting this bug!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13004371" name="10049-bellemare.patch" size="25412" author="abellemare" created="Fri, 29 May 2020 18:02:02 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 24 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0f788:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>