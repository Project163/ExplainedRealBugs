<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:04:10 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-6015] NPE in RecordAccumulator</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-6015</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;I found this inadvertently while trying to create a system test to reproduce  &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6003&quot; title=&quot;Replication Fetcher thread for a partition with no data fails to start&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-6003&quot;&gt;&lt;del&gt;KAFKA-6003&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.lang.NullPointerException
        at org.apache.kafka.clients.producer.internals.RecordAccumulator.drain(RecordAccumulator.java:542)
        at org.apache.kafka.clients.producer.internals.Sender.sendProducerData(Sender.java:270)
        at org.apache.kafka.clients.producer.internals.Sender.run(Sender.java:238)
        at org.apache.kafka.clients.producer.internals.Sender.run(Sender.java:163)
        at java.lang.Thread.run(Thread.java:748)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The problem is with this line&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (first.hasSequence() &amp;amp;&amp;amp; first.baseSequence() != transactionManager.nextBatchBySequence(first.topicPartition).baseSequence())
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It is possible for the producer state to be reset (for instance if retries are expired), in which case the transaction manager will drop the in flight batches it is tracking. However, these batches will continue to be in the accumulator with a sequence, causing an NPE in the background thread on this line.&lt;/p&gt;

&lt;p&gt;It would be better to drain the batches with the old Pid/Sequence in this case. Either they are accepted, or they will be returned to the user with an &lt;tt&gt;OutOfOrderSequenceException&lt;/tt&gt; which is clearer.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13107136">KAFKA-6015</key>
            <summary>NPE in RecordAccumulator</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="apurva">Apurva Mehta</assignee>
                                    <reporter username="apurva">Apurva Mehta</reporter>
                        <labels>
                    </labels>
                <created>Thu, 5 Oct 2017 05:22:51 +0000</created>
                <updated>Fri, 6 Oct 2017 22:07:19 +0000</updated>
                            <resolved>Fri, 6 Oct 2017 22:07:19 +0000</resolved>
                                    <version>1.0.0</version>
                                    <fixVersion>1.0.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16192523" author="githubbot" created="Thu, 5 Oct 2017 06:39:21 +0000"  >&lt;p&gt;GitHub user apurvam opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/4022&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/4022&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6015&quot; title=&quot;NPE in RecordAccumulator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-6015&quot;&gt;&lt;del&gt;KAFKA-6015&lt;/del&gt;&lt;/a&gt;: Fix NullPointerExceptionInRecordAccumulator&lt;/p&gt;

&lt;p&gt;    It is possible for batches with sequence numbers to be in the `deque` while at the same time the in flight batches in the `TransactionManager` are removed due to a producerId reset.&lt;/p&gt;

&lt;p&gt;    In this case, when the batches in the `deque` are drained, we will get a `NullPointerException` in the background thread due to this line: &lt;/p&gt;

&lt;p&gt;    ```java&lt;br/&gt;
    if (first.hasSequence() &amp;amp;&amp;amp; first.baseSequence() != transactionManager.nextBatchBySequence(first.topicPartition).baseSequence())&lt;br/&gt;
    ```&lt;/p&gt;

&lt;p&gt;    Particularly, `transactionManager.nextBatchBySequence` will return null, because there no inflight batches being tracked. &lt;/p&gt;

&lt;p&gt;    In this patch, we simply allow the batches in the `deque` to be drained if there are no in flight batches being tracked in the TransactionManager. If they succeed, well and good. If the responses come back with an error, the batces will be ultimately failed in the producer with an `OutOfOrderSequenceException` when the response comes back.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/apurvam/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apurvam/kafka&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6015&quot; title=&quot;NPE in RecordAccumulator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-6015&quot;&gt;&lt;del&gt;KAFKA-6015&lt;/del&gt;&lt;/a&gt;-npe-in-record-accumulator&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/4022.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/4022.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #4022&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 8d4ced9f42afb16113ed9464697b4d52394e1304&lt;br/&gt;
Author: Apurva Mehta &amp;lt;apurva@confluent.io&amp;gt;&lt;br/&gt;
Date:   2017-10-05T05:56:44Z&lt;/p&gt;

&lt;p&gt;    Fix NPE in Accumulator&lt;/p&gt;

&lt;p&gt;commit 18053f749d8b80bb878f7781f95cb02b58933f9f&lt;br/&gt;
Author: Apurva Mehta &amp;lt;apurva@confluent.io&amp;gt;&lt;br/&gt;
Date:   2017-10-05T06:34:47Z&lt;/p&gt;

&lt;p&gt;    Add test case to ensure that we can send queued batches from a previous producer id after the producer state is reset&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16195314" author="githubbot" created="Fri, 6 Oct 2017 22:06:14 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/4022&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/4022&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16195316" author="hachikuji" created="Fri, 6 Oct 2017 22:07:19 +0000"  >&lt;p&gt;Issue resolved by pull request 4022&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/kafka/pull/4022&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/4022&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 6 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3kwev:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>