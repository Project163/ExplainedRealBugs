<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:31:47 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-14382] StreamThreads can miss rebalance events when processing records during a rebalance</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-14382</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;One of the main improvements introduced by the cooperative protocol was the ability to continue processing records during a rebalance. In Streams, we take advantage of this by polling with a timeout of 0 when a rebalance is/has been in progress, so it can return immediately and continue on through the main loop to process new records. The main poll loop uses an algorithm based on the max.poll.interval.ms to ensure the StreamThread returns to call #poll in time to stay in the consumer group.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Generally speaking, it should exit the processing loop and invoke poll within a few minutes at most based on the poll interval, though typically it will break out much sooner once it&apos;s used up all the records from the last poll (based on the max.poll.records config which Streams sets to 1,000 by default). However, if doing heavy processing or setting a higher max.poll.records, the thread may continue processing for more than a few seconds. If it had sent out a JoinGroup request before going on to process and was waiting for its JoinGroup response, then once it does return to invoke #poll it will process this response and send out a SyncGroup &#8211; but if the processing took too long, this SyncGroup may immediately fail with the REBALANCE_IN_PROGRESS error.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Essentially, while the thread was processing the group leader will itself be processing the JoinGroup subscriptions of all members and generating an assignment, then sending this back in its SyncGroup. This may take only a few seconds or less, and the group coordinator will not yet have noticed (or care) that one of the consumers hasn&apos;t sent a SyncGroup &#8211; it will just return the assigned partitions in the SyncGroup request of the members who have responded in time, and &quot;complete&quot; the rebalance in their eyes. But if the assignment involved moving any partitions from one consumer to another, then it will need to trigger a followup rebalance right away to finish assigning those partitions which were revoked in the previous rebalance. This is what causes a new rebalance to be kicked off just seconds after the first one began.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;If the consumer that was stuck processing was among those who needed to revoke partitions, this can lead to repeating rebalances &#8211; since it fails the SyncGroup of the 1st rebalance it never receives the assignment for it and never knows to revoke those partitions, meaning it will rejoin for the new rebalance still claiming them among its ownedPartitions. When the assignor generates the same assignment for the 2nd rebalance, it will again see that some partitions need to be revoked and will therefore trigger yet another new rebalance after finishing the 2nd. This can go on for as long as the StreamThreads are struggling to finish the JoinGroup phase in time due to processing.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Note that the best workaround at the moment is probably to just set a lower max.poll.records to reduce the processing loop duration&lt;/p&gt;</description>
                <environment></environment>
        <key id="13501023">KAFKA-14382</key>
            <summary>StreamThreads can miss rebalance events when processing records during a rebalance</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ableegoldman">A. Sophie Blee-Goldman</assignee>
                                    <reporter username="ableegoldman">A. Sophie Blee-Goldman</reporter>
                        <labels>
                            <label>new-consumer-threading-should-fix</label>
                            <label>rebalancing</label>
                    </labels>
                <created>Fri, 11 Nov 2022 04:09:30 +0000</created>
                <updated>Tue, 14 Jan 2025 06:27:01 +0000</updated>
                            <resolved>Sat, 19 Nov 2022 06:52:36 +0000</resolved>
                                                    <fixVersion>3.0.3</fixVersion>
                    <fixVersion>3.1.3</fixVersion>
                    <fixVersion>3.2.4</fixVersion>
                    <fixVersion>3.3.2</fixVersion>
                    <fixVersion>3.4.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17636135" author="ableegoldman" created="Sat, 19 Nov 2022 09:50:12 +0000"  >&lt;p&gt;Ok while working out a fix I realized the true root cause of this bug, the above is all correct but the fundamental issue is how quickly we trigger a new rebalance, not the thread&apos;s inability to call poll within just a few seconds &#8211; it shouldn&apos;t have to. The problem is the assignor might schedule an immediate followup rebalance for itself and then leave the poll() call after sending the assignment/SyncGroup request, but before the rebalance is actually finished, and then trigger a new rebalance when it checks and sees that one has been scheduled.&#160;&lt;/p&gt;

&lt;p&gt;Basically we should just make sure the thread waits for any ongoing rebalance to finish before triggering a new one&lt;/p&gt;</comment>
                            <comment id="17679346" author="guozhang" created="Fri, 20 Jan 2023 22:51:28 +0000"  >&lt;p&gt;Thanks for catching this bug &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ableegoldman&quot; class=&quot;user-hover&quot; rel=&quot;ableegoldman&quot;&gt;ableegoldman&lt;/a&gt;! I&apos;m late reviewing the PR but I agree with your general case description still. And I think we already have the tools to solve the fundamentals as well:&lt;/p&gt;

&lt;p&gt;1) When we have the consumer thread refactoring done (hence that&apos;s why I also add the corresponding label), rebalance would be done by the background thread completely and not relying on Streams to call `poll` in time at all. To validate that the caller thread is still alive, we still need to call it within the max.poll.call, but nothing else like the rebalance related timeous would matter.&lt;/p&gt;

&lt;p&gt;2) When we have restoration (a heavy IO operation) to the separate thread, we should also see the likelihood that the stream thread stuck and not being able to call `poll` in time much less as well.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13505760">KAFKA-14419</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13505760">KAFKA-14419</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 42 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1bvz4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>