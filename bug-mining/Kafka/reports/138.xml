<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:36:22 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-596] LogSegment.firstAppendTime not reset after truncate to</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-596</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Currently, we don&apos;t reset LogSegment.firstAppendTime after the segment is truncated. What can happen is that we truncate the segment to size 0 and on next append, a new log segment with the same starting offset is rolled because the time-based rolling is triggered.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12614203">KAFKA-596</key>
            <summary>LogSegment.firstAppendTime not reset after truncate to</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="swapnilghike">Swapnil Ghike</assignee>
                                    <reporter username="junrao">Jun Rao</reporter>
                        <labels>
                            <label>bugs</label>
                    </labels>
                <created>Wed, 31 Oct 2012 16:48:27 +0000</created>
                <updated>Mon, 5 Nov 2012 23:11:19 +0000</updated>
                            <resolved>Mon, 5 Nov 2012 23:11:15 +0000</resolved>
                                    <version>0.8.0</version>
                                    <fixVersion>0.8.0</fixVersion>
                                    <component>core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                    <workratio workratioPercent="0"/>
                                    <progress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                    <timeoriginalestimate seconds="86400">24h</timeoriginalestimate>
                            <timeestimate seconds="86400">24h</timeestimate>
                                        <comments>
                            <comment id="13487947" author="junrao" created="Wed, 31 Oct 2012 16:52:34 +0000"  >&lt;p&gt;The fix is to set LogSegment.firstAppendTime to none if we truncate the segment to size 0. However, this brings up the deeper question of how do we prevent segments with identical starting offset from being created during log roll? Maybe, we should add a check in log.roll to guard this.&lt;/p&gt;</comment>
                            <comment id="13489059" author="swapnilghike" created="Thu, 1 Nov 2012 21:49:50 +0000"  >&lt;p&gt;Yes, that&apos;s a pretty sharp observation. The current time based roll policy only checks whether the segment was not appended for its lifetime. This patch has three fixes: &lt;/p&gt;

&lt;p&gt;1. Initial assignment of firstAppendTime in Logsegment, because the non-primary constructor could potentially initialize the messageSet and set its size &amp;gt; 0. (I don&apos;t know if this fix will affect any other jiras.)&lt;/p&gt;

&lt;p&gt;2. In maybeRoll(), a new condition makes sure that roll() happens based on time only if the messageset size &amp;gt; 0, thus different segments cannot have identical starting offsets. It also makes sure that a new segment is not rolled if the last segment is not appended with messages until now.&lt;/p&gt;

&lt;p&gt;2. A segment is reborn at three places by setting its firstAppendTime to None if the message set size is 0 - &lt;br/&gt;
i. Log.maybeRoll()&lt;br/&gt;
ii. Logsement.truncateTo()&lt;br/&gt;
iii. Log.markedDeletedWhile()&lt;/p&gt;</comment>
                            <comment id="13489266" author="junrao" created="Fri, 2 Nov 2012 05:04:56 +0000"  >&lt;p&gt;Thanks for the patch. A couple of comments:&lt;/p&gt;

&lt;p&gt;1.  Log.maybeRoll(): Are the following lines needed since we are not creating a new segment?&lt;br/&gt;
      if (segment.messageSet.sizeInBytes == 0)&lt;br/&gt;
        segment.firstAppendTime = None&lt;/p&gt;

&lt;p&gt;2. Log.markedDeletedWhile(): Is the following line needed since we are not creating a new segment?&lt;br/&gt;
          view(numToDelete - 1).firstAppendTime = None&lt;/p&gt;
</comment>
                            <comment id="13489286" author="swapnilghike" created="Fri, 2 Nov 2012 07:01:34 +0000"  >&lt;p&gt;Actually the modification in maybeRoll() in the conditions that determine whether to roll a new segment or not, is enough for correctly fixing the issue mentioned above. The fix rolls a new segment only if the size of messageSet is &amp;gt; 0. So if we truncated the segment to size 0, maybeRoll() will not roll a new segment at the same starting offset. &lt;/p&gt;

&lt;p&gt;I kept those lines in Log.maybeRoll(), Logsement.truncateTo() and Log.markedDeletedWhile() for optimization. Setting the firstAppendTime to None whenever the size is found to be 0 will postpone the next time based roll and also will not harm correctness.&lt;/p&gt;</comment>
                            <comment id="13489473" author="junrao" created="Fri, 2 Nov 2012 15:11:52 +0000"  >&lt;p&gt;I agree that setting firstAppendTime to None in Logsement.truncateTo() is necessary. However, I don&apos;t think this is necessary in Log.maybeRoll() and Log.markedDeletedWhile(). In both cases, we are not changing the log segment. So whoever changed the segment last to make its size 0 (either through truncation or creation) would have set firstAppendTime properly. Note that maybeRoll is called on every log append. We don&apos;t want to add unnecessary overhead.&lt;/p&gt;</comment>
                            <comment id="13489636" author="swapnilghike" created="Fri, 2 Nov 2012 18:32:32 +0000"  >&lt;p&gt;Yes, I see your point. Attached a new patch.&lt;/p&gt;</comment>
                            <comment id="13489857" author="swapnilghike" created="Fri, 2 Nov 2012 23:55:07 +0000"  >&lt;p&gt;After a discussion with Jun, reverted the conditions in maybeRoll() to the trunk version.&lt;/p&gt;

&lt;p&gt;Setting firstAppendTime to None in LogSegment.truncateTo() when messageSet size becomes 0 is enough to make sure that Log.maybeRoll() will not roll a new segment at the same starting offset as the last segment.&lt;/p&gt;</comment>
                            <comment id="13490298" author="nehanarkhede" created="Sun, 4 Nov 2012 21:42:46 +0000"  >&lt;p&gt;Good catch, Jun !&lt;/p&gt;

&lt;p&gt;+1 on v3&lt;/p&gt;</comment>
                            <comment id="13491025" author="junrao" created="Mon, 5 Nov 2012 23:11:15 +0000"  >&lt;p&gt;Thanks for patch v3. +1. Committed to 0.8.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12551901" name="kafka-596-v2.patch" size="1554" author="swapnilghike" created="Fri, 2 Nov 2012 18:32:32 +0000"/>
                            <attachment id="12551948" name="kafka-596-v3.patch" size="873" author="swapnilghike" created="Fri, 2 Nov 2012 23:55:07 +0000"/>
                            <attachment id="12551773" name="kafka-596.patch" size="2099" author="swapnilghike" created="Thu, 1 Nov 2012 21:49:50 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>253435</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 3 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0dnhz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>77736</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>