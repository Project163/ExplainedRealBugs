<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:39:01 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-16837] Kafka Connect fails on update connector for incorrect previous Config Provider tasks</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-16837</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Hello,&lt;/p&gt;

&lt;p&gt;We faced an issue when is not possible to update Connector config if the &lt;b&gt;previous&lt;/b&gt; task contains ConfigProvider&apos;s value with incorrect value that leads to ConfigException.&lt;/p&gt;

&lt;p&gt;I can provide simple Test Case to reproduce it with FileConfigProvider, but actually any ConfigProvider is acceptable that could raise exception if something wrong with config (like resource doesn&apos;t exist).&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Prerequisites:&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;Kafka Connect instance with config providers:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
config.providers=file
config.providers.file.class=org.apache.kafka.common.config.provider.FileConfigProvider&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;1. Create Kafka topic &quot;test&quot;&lt;br/&gt;
2. On the Kafka Connect instance create the file &quot;/opt/kafka/provider.properties&quot; with content&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
topics=test
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;3. Create simple FileSink connector:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
PUT /connectors/local-file-sink/config
{
  &lt;span class=&quot;code-quote&quot;&gt;&quot;connector.class&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;FileStreamSink&quot;&lt;/span&gt;,
  &lt;span class=&quot;code-quote&quot;&gt;&quot;tasks.max&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;1&quot;&lt;/span&gt;,
  &lt;span class=&quot;code-quote&quot;&gt;&quot;file&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;/opt/kafka/test.sink.txt&quot;&lt;/span&gt;,
  &lt;span class=&quot;code-quote&quot;&gt;&quot;topics&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;${file:/opt/kafka/provider.properties:topics}&quot;&lt;/span&gt;
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;4. Checks that everything works fine:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
GET /connectors?expand=info&amp;amp;expand=status
...
    &lt;span class=&quot;code-quote&quot;&gt;&quot;status&quot;&lt;/span&gt;: {
      &lt;span class=&quot;code-quote&quot;&gt;&quot;name&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;local-file-sink&quot;&lt;/span&gt;,
      &lt;span class=&quot;code-quote&quot;&gt;&quot;connector&quot;&lt;/span&gt;: {
        &lt;span class=&quot;code-quote&quot;&gt;&quot;state&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;RUNNING&quot;&lt;/span&gt;,
        &lt;span class=&quot;code-quote&quot;&gt;&quot;worker_id&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;10.10.10.10:8083&quot;&lt;/span&gt;
      },
      &lt;span class=&quot;code-quote&quot;&gt;&quot;tasks&quot;&lt;/span&gt;: [
        {
          &lt;span class=&quot;code-quote&quot;&gt;&quot;id&quot;&lt;/span&gt;: 0,
          &lt;span class=&quot;code-quote&quot;&gt;&quot;state&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;RUNNING&quot;&lt;/span&gt;,
          &lt;span class=&quot;code-quote&quot;&gt;&quot;worker_id&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;10.10.10.10:8083&quot;&lt;/span&gt;
        }
      ],
      &lt;span class=&quot;code-quote&quot;&gt;&quot;type&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;sink&quot;&lt;/span&gt;
    }
  }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Looks fine.&lt;/p&gt;

&lt;p&gt;5. Renames the file to &quot;/opt/kafka/provider2.properties&quot;.&lt;br/&gt;
6. Update connector with new correct file name:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
PUT /connectors/local-file-sink/config
{
  &lt;span class=&quot;code-quote&quot;&gt;&quot;connector.class&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;FileStreamSink&quot;&lt;/span&gt;,
  &lt;span class=&quot;code-quote&quot;&gt;&quot;tasks.max&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;1&quot;&lt;/span&gt;,
  &lt;span class=&quot;code-quote&quot;&gt;&quot;file&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;/opt/kafka/test.sink.txt&quot;&lt;/span&gt;,
  &lt;span class=&quot;code-quote&quot;&gt;&quot;topics&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;${file:/opt/kafka/provider2.properties:topics}&quot;&lt;/span&gt;
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Update &lt;b&gt;succeed&lt;/b&gt;, got 200. &lt;br/&gt;
7. Checks that everything works fine:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
{
  &lt;span class=&quot;code-quote&quot;&gt;&quot;local-file-sink&quot;&lt;/span&gt;: {
    &lt;span class=&quot;code-quote&quot;&gt;&quot;info&quot;&lt;/span&gt;: {
      &lt;span class=&quot;code-quote&quot;&gt;&quot;name&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;local-file-sink&quot;&lt;/span&gt;,
      &lt;span class=&quot;code-quote&quot;&gt;&quot;config&quot;&lt;/span&gt;: {
        &lt;span class=&quot;code-quote&quot;&gt;&quot;connector.class&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;FileStreamSink&quot;&lt;/span&gt;,
        &lt;span class=&quot;code-quote&quot;&gt;&quot;file&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;/opt/kafka/test.sink.txt&quot;&lt;/span&gt;,
        &lt;span class=&quot;code-quote&quot;&gt;&quot;tasks.max&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;1&quot;&lt;/span&gt;,
        &lt;span class=&quot;code-quote&quot;&gt;&quot;topics&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;${file:/opt/kafka/provider2.properties:topics}&quot;&lt;/span&gt;,
        &lt;span class=&quot;code-quote&quot;&gt;&quot;name&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;local-file-sink&quot;&lt;/span&gt;
      },
      &lt;span class=&quot;code-quote&quot;&gt;&quot;tasks&quot;&lt;/span&gt;: [
        {
          &lt;span class=&quot;code-quote&quot;&gt;&quot;connector&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;local-file-sink&quot;&lt;/span&gt;,
          &lt;span class=&quot;code-quote&quot;&gt;&quot;task&quot;&lt;/span&gt;: 0
        }
      ],
      &lt;span class=&quot;code-quote&quot;&gt;&quot;type&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;sink&quot;&lt;/span&gt;
    },
    &lt;span class=&quot;code-quote&quot;&gt;&quot;status&quot;&lt;/span&gt;: {
      &lt;span class=&quot;code-quote&quot;&gt;&quot;name&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;local-file-sink&quot;&lt;/span&gt;,
      &lt;span class=&quot;code-quote&quot;&gt;&quot;connector&quot;&lt;/span&gt;: {
        &lt;span class=&quot;code-quote&quot;&gt;&quot;state&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;RUNNING&quot;&lt;/span&gt;,
        &lt;span class=&quot;code-quote&quot;&gt;&quot;worker_id&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;10.10.10.10:8083&quot;&lt;/span&gt;
      },
      &lt;span class=&quot;code-quote&quot;&gt;&quot;tasks&quot;&lt;/span&gt;: [
        {
          &lt;span class=&quot;code-quote&quot;&gt;&quot;id&quot;&lt;/span&gt;: 0,
          &lt;span class=&quot;code-quote&quot;&gt;&quot;state&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;FAILED&quot;&lt;/span&gt;,
          &lt;span class=&quot;code-quote&quot;&gt;&quot;worker_id&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;10.10.10.10:8083&quot;&lt;/span&gt;,
          &lt;span class=&quot;code-quote&quot;&gt;&quot;trace&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;org.apache.kafka.common.errors.InvalidTopicException: Invalid topics: [${file:/opt/kafka/provider.properties:topics}]&quot;&lt;/span&gt;
        }
      ],
      &lt;span class=&quot;code-quote&quot;&gt;&quot;type&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;sink&quot;&lt;/span&gt;
    }
  }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Config has been updated, but new task has not been created. And as result connector doesn&apos;t work.&lt;/p&gt;

&lt;p&gt;It failed on:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[2024-05-24T12:08:24.362][ERROR][request_id= ][tenant_id= ][thread=DistributedHerder-connect-1-1][class=org.apache.kafka.connect.runtime.distributed.DistributedHerder][method=lambda$reconfigureConnectorTasksWithExponentialBackoffRetries$44] [Worker clientId=connect-1, groupId=streaming-service_streaming_service] Failed to reconfigure connector&apos;s tasks (local-file-sink), retrying after backoff.
org.apache.kafka.common.config.ConfigException: Could not read properties from file /opt/kafka/provider.properties
 at org.apache.kafka.common.config.provider.FileConfigProvider.get(FileConfigProvider.java:98)
 at org.apache.kafka.common.config.ConfigTransformer.transform(ConfigTransformer.java:103)
 at org.apache.kafka.connect.runtime.WorkerConfigTransformer.transform(WorkerConfigTransformer.java:58)
 at org.apache.kafka.connect.storage.ClusterConfigState.taskConfig(ClusterConfigState.java:181)
 at org.apache.kafka.connect.runtime.AbstractHerder.taskConfigsChanged(AbstractHerder.java:804)
 at org.apache.kafka.connect.runtime.distributed.DistributedHerder.publishConnectorTaskConfigs(DistributedHerder.java:2089)
 at org.apache.kafka.connect.runtime.distributed.DistributedHerder.reconfigureConnector(DistributedHerder.java:2082)
 at org.apache.kafka.connect.runtime.distributed.DistributedHerder.reconfigureConnectorTasksWithExponentialBackoffRetries(DistributedHerder.java:2025)
 at org.apache.kafka.connect.runtime.distributed.DistributedHerder.lambda$&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;$42(DistributedHerder.java:2038)
 at org.apache.kafka.connect.runtime.distributed.DistributedHerder.runRequest(DistributedHerder.java:2232)
 at org.apache.kafka.connect.runtime.distributed.DistributedHerder.tick(DistributedHerder.java:470)
 at org.apache.kafka.connect.runtime.distributed.DistributedHerder.run(DistributedHerder.java:371)
 at java.base/java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:539)
 at java.base/java.util.concurrent.FutureTask.run(FutureTask.java:264)
 at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1136)
 at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:635)
 at java.base/java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:840) &#160;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;As I understand it happens, because on the connector update AbstractHerder tries to update current tasks:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/AbstractHerder.java#L1051&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/trunk/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/AbstractHerder.java#L1051&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;and before do it, herder &lt;ins&gt;tries to compare old task config and new one&lt;/ins&gt;. But it doesn&apos;t compare original values, &lt;ins&gt;it tries to get ConfigProvider calculated value for previous task&lt;/ins&gt; and failed as not possible to get file for previous task, by ConfigProvider.&lt;/p&gt;

&lt;p&gt;The main question &lt;b&gt;do we really need to compare ConfigProvider calculated&lt;/b&gt; values there instead of comparing original configs? &lt;br/&gt;
Now it leads to issues as lot of ConfigProviders usually raise Exception if resource not found.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;As WA we can remove and create connector, instead of update. But there is one case when it doesn&apos;t help: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-16838&quot; title=&quot;Kafka Connect loads old tasks from removed connectors&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-16838&quot;&gt;&lt;del&gt;KAFKA-16838&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13580362">KAFKA-16837</key>
            <summary>Kafka Connect fails on update connector for incorrect previous Config Provider tasks</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ChrisEgerton">Chris Egerton</assignee>
                                    <reporter username="mrMigles">Sergey Ivanov</reporter>
                        <labels>
                    </labels>
                <created>Fri, 24 May 2024 12:33:58 +0000</created>
                <updated>Mon, 10 Jun 2024 21:03:20 +0000</updated>
                            <resolved>Tue, 4 Jun 2024 13:38:08 +0000</resolved>
                                    <version>3.5.1</version>
                    <version>3.6.1</version>
                    <version>3.8.0</version>
                                    <fixVersion>3.7.1</fixVersion>
                    <fixVersion>3.8.0</fixVersion>
                                    <component>connect</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17850059" author="chrisegerton" created="Tue, 28 May 2024 15:07:11 +0000"  >&lt;p&gt;Thanks for raising this &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mrMigles&quot; class=&quot;user-hover&quot; rel=&quot;mrMigles&quot;&gt;mrMigles&lt;/a&gt;, great find!&lt;/p&gt;

&lt;p&gt;I don&apos;t think we need to compare config provider-resolved values for task configs, since we end up performing that resolution at the same time for both sets of configs and that&apos;s likely to generate the same values. It should be fine to compare original (&quot;raw&quot;) configs instead.&lt;/p&gt;</comment>
                            <comment id="17850359" author="mrmigles" created="Wed, 29 May 2024 12:55:04 +0000"  >&lt;p&gt;Thanks for the answer, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ChrisEgerton&quot; class=&quot;user-hover&quot; rel=&quot;ChrisEgerton&quot;&gt;ChrisEgerton&lt;/a&gt;!&lt;/p&gt;

&lt;p&gt;I don&apos;t have enough Kafka source code experience to come right decision about that part, glad to hear you think the same about comparing original configs.&#160;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13270205">KAFKA-9228</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13069086" name="kafka_connect_config.png" size="58027" author="mrMigles" created="Fri, 24 May 2024 12:34:08 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 23 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1pepk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>