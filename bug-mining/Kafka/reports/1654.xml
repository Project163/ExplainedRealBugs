<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:03:36 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-5756] Synchronization issue on flush</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-5756</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Access to &lt;b&gt;OffsetStorageWriter#toFlush&lt;/b&gt; is not synchronized in &lt;b&gt;doFlush()&lt;/b&gt; method, whereas this collection can be accessed from 2 different threads:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;b&gt;WorkerSourceTask.execute()&lt;/b&gt;, finally block&lt;/li&gt;
	&lt;li&gt;&lt;b&gt;SourceTaskOffsetCommitter&lt;/b&gt;, from periodic flush task&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="13096320">KAFKA-5756</key>
            <summary>Synchronization issue on flush</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gharris1727">Greg Harris</assignee>
                                    <reporter username="olkuznsmith">Oleg Kuznetsov</reporter>
                        <labels>
                    </labels>
                <created>Sun, 20 Aug 2017 21:35:15 +0000</created>
                <updated>Thu, 16 Feb 2023 02:53:22 +0000</updated>
                            <resolved>Thu, 16 Feb 2023 02:29:40 +0000</resolved>
                                    <version>0.10.2.0</version>
                                    <fixVersion>3.3.3</fixVersion>
                    <fixVersion>3.4.1</fixVersion>
                    <fixVersion>3.5.0</fixVersion>
                                    <component>connect</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="16134573" author="githubbot" created="Sun, 20 Aug 2017 22:00:18 +0000"  >&lt;p&gt;GitHub user oleg-smith opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/3702&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3702&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5756&quot; title=&quot;Synchronization issue on flush&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-5756&quot;&gt;&lt;del&gt;KAFKA-5756&lt;/del&gt;&lt;/a&gt; Synchronization issue on flush&lt;/p&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/oleg-smith/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/oleg-smith/kafka&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5756&quot; title=&quot;Synchronization issue on flush&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-5756&quot;&gt;&lt;del&gt;KAFKA-5756&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/3702.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3702.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #3702&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 52eb748105fad16e7f810fdedc1a91dcb96b9117&lt;br/&gt;
Author: oleg &amp;lt;oleg@nexla.com&amp;gt;&lt;br/&gt;
Date:   2017-08-20T21:59:35Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5756&quot; title=&quot;Synchronization issue on flush&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-5756&quot;&gt;&lt;del&gt;KAFKA-5756&lt;/del&gt;&lt;/a&gt; Synchronization issue on flush&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16134575" author="olkuznsmith" created="Sun, 20 Aug 2017 22:06:18 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ewencp&quot; class=&quot;user-hover&quot; rel=&quot;ewencp&quot;&gt;ewencp&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rhauch&quot; class=&quot;user-hover&quot; rel=&quot;rhauch&quot;&gt;rhauch&lt;/a&gt; Could you take a look?&lt;/p&gt;</comment>
                            <comment id="16141672" author="rhauch" created="Fri, 25 Aug 2017 14:12:46 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=olkuznsmith&quot; class=&quot;user-hover&quot; rel=&quot;olkuznsmith&quot;&gt;olkuznsmith&lt;/a&gt;, thanks for the fix. As mentioned on the PR, the code change looks good. &lt;/p&gt;

&lt;p&gt;However, this PR needs to be against the &lt;tt&gt;trunk&lt;/tt&gt; branch rather than an older release branch. This is the case for all Apache Kafka PRs. &lt;/p&gt;

&lt;p&gt;To have a change backported, you simply need to ask for it in the PR and to mention the specific branches. If the PR is approved and the backporting is approved, the committer will merge the changes and backport to those branches. If there are any issues with backporting, the committer may ask you to create a specific PR against that branch.&lt;/p&gt;</comment>
                            <comment id="16155816" author="githubbot" created="Wed, 6 Sep 2017 18:15:45 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/3702&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3702&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16155837" author="hachikuji" created="Wed, 6 Sep 2017 18:26:57 +0000"  >&lt;p&gt;Issue resolved by pull request 3702&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/kafka/pull/3702&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3702&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16999546" author="chrisegerton" created="Wed, 18 Dec 2019 22:15:16 +0000"  >&lt;p&gt;I believe a very similar issue may still be possible and that the synchronization added in &lt;a href=&quot;https://github.com/apache/kafka/pull/3702&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3702&lt;/a&gt;, while an improvement, still doesn&apos;t prevent all possible errors caused by concurrent calls to &lt;tt&gt;WorkerSourceTask::commitOffsets&lt;/tt&gt; (which, as noted earlier in the ticket, can from from both the periodic offset commit from the &lt;tt&gt;SourceTaskOffsetCommitter&lt;/tt&gt; class and the end-of-life offset commit from the &lt;tt&gt;WorkerSourceTask&lt;/tt&gt; itself).&lt;/p&gt;

&lt;p&gt;The &lt;tt&gt;WorkerSourceTask&lt;/tt&gt; class takes care to ensure that &lt;tt&gt;OffsetStorageWriter::beginFlush&lt;/tt&gt; isn&apos;t invoked concurrently, which was implemented as part of &lt;a href=&quot;https://github.com/apache/kafka/pull/3702&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3702&lt;/a&gt;. However, there doesn&apos;t appear to be anything in place to prevent that method from being invoked before a flush has completed (either via a call to &lt;tt&gt;OffsetStorageWriter::cancelFlush&lt;/tt&gt; or to &lt;tt&gt;OffsetStorageWriter::doFlush::get&lt;/tt&gt;). If this occurs, &lt;a href=&quot;https://github.com/apache/kafka/blob/c6e25bb362899f4e6335ac5578b1cae31b7f2575/connect/runtime/src/main/java/org/apache/kafka/connect/storage/OffsetStorageWriter.java#L108-L112&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;an exception is thrown&lt;/a&gt; stating that &quot;the framework should not allow this&quot;.&lt;/p&gt;

&lt;p&gt;Reopening this issue until the above scenario has been addressed.&lt;/p&gt;</comment>
                            <comment id="16999547" author="chrisegerton" created="Wed, 18 Dec 2019 22:16:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=olkuznsmith&quot; class=&quot;user-hover&quot; rel=&quot;olkuznsmith&quot;&gt;olkuznsmith&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rhauch&quot; class=&quot;user-hover&quot; rel=&quot;rhauch&quot;&gt;rhauch&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hachikuji&quot; class=&quot;user-hover&quot; rel=&quot;hachikuji&quot;&gt;hachikuji&lt;/a&gt; do you agree with the analysis above?&lt;/p&gt;</comment>
                            <comment id="17161666" author="gharris1727" created="Tue, 21 Jul 2020 02:29:07 +0000"  >&lt;p&gt;I was able to reproduce this race condition with the following setup:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;ConnectDistributedTest.test_bounce&lt;/li&gt;
	&lt;li&gt;clean bounces = True&lt;/li&gt;
	&lt;li&gt;tests/kafkatest/tests/connect/templates/connect-distributed.properties edited to include offset.flush.interval.ms=1&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;This setup makes collisions between the periodic commitOffsets and the commitOffsets call from stop()/close() extremely likely. In a single run of 9 bounces, I managed to have 7 instances of duplication (12 records in 7 non-consecutive groups).&lt;/p&gt;

&lt;p&gt;An example log file when one of these race conditions happens. I&apos;ve interspersed the VerifiableSourceTask&apos;s stdout messages to indicate when the records are produced and committed.&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[2020-07-20 22:45:47,619] DEBUG Submitting 1 entries to backing store. The offsets are: {{id=1}={seqno=15709}
[2020-07-20 22:45:52,622] DEBUG Submitting 1 entries to backing store. The offsets are: {{id=1}={seqno=16209}}
[2020-07-20 22:45:52.622] {&quot;task&quot;:1,&quot;seqno&quot;:16210,&quot;time_ms&quot;:1595285152622,&quot;name&quot;:&quot;verifiable-source&quot;,&quot;topic&quot;:&quot;test&quot;}
[2020-07-20 22:45:52,623] DEBUG [Producer clientId=connector-producer-verifiable-source-1] Sending PRODUCE request with header RequestHeader(apiKey=PRODUCE, apiVersion=8, clientId=connector-producer-verifiable-source-1, correlationId=1395) and timeout 2147483647 to node 1: {acks=-1,timeout=2147483647,partitionSizes=[test-0=185]}
[2020-07-20 22:45:52,623] INFO Stopping task verifiable-source-1
[2020-07-20 22:45:52.627] {&quot;task&quot;:1,&quot;seqno&quot;:16211,&quot;time_ms&quot;:1595285152627,&quot;name&quot;:&quot;verifiable-source&quot;,&quot;topic&quot;:&quot;test&quot;}
[2020-07-20 22:45:52,627] INFO WorkerSourceTask{id=verifiable-source-1} Committing offsets (org.apache.kafka.connect.runtime.WorkerSourceTask)
[2020-07-20 22:45:52,627] DEBUG [Producer clientId=connector-producer-verifiable-source-1] Received PRODUCE response from node 1 for request with header RequestHeader(apiKey=PRODUCE, apiVersion=8, clientId=connector-producer-verifiable-source-1, correlationId=1395): org.apache.kafka.common.requests.ProduceResponse@464a5bec (org.apache.kafka.clients.NetworkClient)
[2020-07-20 22:45:52,627] ERROR Invalid call to OffsetStorageWriter flush() while already flushing, the framework should not allow this (org.apache.kafka.connect.storage.OffsetStorageWriter)
[2020-07-20 22:45:52,630] ERROR WorkerSourceTask{id=verifiable-source-1} Task threw an uncaught and unrecoverable exception (org.apache.kafka.connect.runtime.WorkerTask)
org.apache.kafka.connect.errors.ConnectException: OffsetStorageWriter is already flushing
        at org.apache.kafka.connect.storage.OffsetStorageWriter.beginFlush(OffsetStorageWriter.java:111)
        at org.apache.kafka.connect.runtime.WorkerSourceTask.commitOffsets(WorkerSourceTask.java:490)
        at org.apache.kafka.connect.runtime.WorkerSourceTask.execute(WorkerSourceTask.java:274)
        at org.apache.kafka.connect.runtime.WorkerTask.doRun(WorkerTask.java:185)
        at org.apache.kafka.connect.runtime.WorkerTask.run(WorkerTask.java:235)
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
        at java.util.concurrent.FutureTask.run(FutureTask.java:266)
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
        at java.lang.Thread.run(Thread.java:748)
[2020-07-20 22:45:52.630] {&quot;committed&quot;:true,&quot;task&quot;:1,&quot;seqno&quot;:16210,&quot;time_ms&quot;:1595285152630,&quot;name&quot;:&quot;verifiable-source&quot;,&quot;topic&quot;:&quot;test&quot;}
[2020-07-20 22:45:52,630] DEBUG [Producer clientId=connector-producer-verifiable-source-1] Sending PRODUCE request with header RequestHeader(apiKey=PRODUCE, apiVersion=8, clientId=connector-producer-verifiable-source-1, correlationId=1396) and timeout 2147483647 to node 1: {acks=-1,timeout=2147483647,partitionSizes=[test-0=185]}
[2020-07-20 22:45:52,630] ERROR WorkerSourceTask{id=verifiable-source-1} Task is being killed and will not recover until manually restarted (org.apache.kafka.connect.runtime.WorkerTask)
[2020-07-20 22:45:52,631] INFO WorkerSourceTask{id=verifiable-source-1} Finished commitOffsets successfully in 9 ms (org.apache.kafka.connect.runtime.WorkerSourceTask)
[2020-07-20 22:45:52,631] INFO [Producer clientId=connector-producer-verifiable-source-1] Closing the Kafka producer with timeoutMillis = 30000 ms.
[2020-07-20 22:45:52,632] DEBUG [Producer clientId=connector-producer-verifiable-source-1] Received PRODUCE response from node 1 for request with header RequestHeader(apiKey=PRODUCE, apiVersion=8, clientId=connector-producer-verifiable-source-1, correlationId=1396): org.apache.kafka.common.requests.ProduceResponse@6f98d76
[2020-07-20 22:45:52,632] DEBUG [Producer clientId=connector-producer-verifiable-source-1] Beginning shutdown of Kafka producer I/O thread, sending remaining records.
[2020-07-20 22:45:52.632] ducker10 {&quot;committed&quot;:true,&quot;task&quot;:1,&quot;seqno&quot;:16211,&quot;time_ms&quot;:1595285152632,&quot;name&quot;:&quot;verifiable-source&quot;,&quot;topic&quot;:&quot;test&quot;}
[2020-07-20 22:45:52,635] DEBUG [Producer clientId=connector-producer-verifiable-source-1] Shutdown of Kafka producer I/O thread has completed.
[2020-07-20 22:45:52,636] DEBUG [Producer clientId=connector-producer-verifiable-source-1] Kafka producer has been closed         
[2020-07-20 22:45:52,639] DEBUG Graceful stop of task verifiable-source-1 succeeded.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Sequence numbers 16210 and 16211 are then duplicated once the connector restarts, since the later commit including those offsets is discarded due to the exception.&lt;/p&gt;

&lt;p&gt;When the normal interval of 5000ms is used, the test is flakey but passes ~90% of the time. In order to resolve that flakiness, we need to resolve this race condition.&lt;/p&gt;</comment>
                            <comment id="17683888" author="mimaison" created="Fri, 3 Feb 2023 14:21:56 +0000"  >&lt;p&gt;As far as I can tell this is still an issue. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gharris1727&quot; class=&quot;user-hover&quot; rel=&quot;gharris1727&quot;&gt;gharris1727&lt;/a&gt; Were you planning to propose a fix?&lt;/p&gt;</comment>
                            <comment id="17684977" author="gharris1727" created="Tue, 7 Feb 2023 00:06:07 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mimaison&quot; class=&quot;user-hover&quot; rel=&quot;mimaison&quot;&gt;mimaison&lt;/a&gt; I have opened a PR that I think may alleviate this failure mode.&lt;/p&gt;</comment>
                            <comment id="17689450" author="chrisegerton" created="Thu, 16 Feb 2023 02:30:14 +0000"  >&lt;p&gt;I&apos;ve merged Greg&apos;s fix and updated the fix version to 3.5.0, since this issue was not fully addressed before that fix.&lt;/p&gt;

&lt;p&gt;I&apos;ve also backported to the 3.3 and 3.4 branches. It should be available in the next releases for each of those.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13351793">KAFKA-12182</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 38 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3j2lr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>