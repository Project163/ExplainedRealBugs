<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:39:02 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-16814] KRaft broker cannot startup when `partition.metadata` is missing</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-16814</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;When starting up kafka logManager, we&apos;ll check stray replicas to avoid some corner cases. But this check might cause broker unable to startup if `partition.metadata` is missing because when startup kafka, we load log from file, and the topicId of the log is coming from `partition.metadata` file. So, if `partition.metadata` is missing, the topicId will be None, and the `LogManager#isStrayKraftReplica` will fail with no topicID error.&lt;/p&gt;

&lt;p&gt;The `partition.metadata` missing could be some storage failure, or another possible path is unclean shutdown after topic is created in the replica, but before data is flushed into `partition.metadata` file. This is possible because we do the flush in async way &lt;a href=&quot;https://github.com/apache/kafka/blob/5552f5c26df4eb07b2d6ee218e4a29e4ca790d5c/core/src/main/scala/kafka/log/UnifiedLog.scala#L229&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ERROR Encountered fatal fault: Error starting LogManager (org.apache.kafka.server.fault.ProcessTerminatingFaultHandler)
java.lang.RuntimeException: The log dir Log(dir=/tmp/kraft-broker-logs/quickstart-events-0, topic=quickstart-events, partition=0, highWatermark=0, lastStableOffset=0, logStartOffset=0, logEndOffset=0) does not have a topic ID, which is not allowed when running in KRaft mode.
&#160; &#160; at kafka.log.LogManager$.$anonfun$isStrayKraftReplica$1(LogManager.scala:1609)
&#160; &#160; at scala.Option.getOrElse(Option.scala:201)
&#160; &#160; at kafka.log.LogManager$.isStrayKraftReplica(LogManager.scala:1608)
&#160; &#160; at kafka.server.metadata.BrokerMetadataPublisher.$anonfun$initializeManagers$1(BrokerMetadataPublisher.scala:294)
&#160; &#160; at kafka.server.metadata.BrokerMetadataPublisher.$anonfun$initializeManagers$1$adapted(BrokerMetadataPublisher.scala:294)
&#160; &#160; at kafka.log.LogManager.loadLog(LogManager.scala:359)
&#160; &#160; at kafka.log.LogManager.$anonfun$loadLogs$15(LogManager.scala:493)
&#160; &#160; at java.base/java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:577)
&#160; &#160; at java.base/java.util.concurrent.FutureTask.run(FutureTask.java:317)
&#160; &#160; at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1144)
&#160; &#160; at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:642)
&#160; &#160; at java.base/java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:1623) &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Because if we don&apos;t do the isStrayKraftReplica check, the topicID and the `partition.metadata` will get recovered after getting topic partition update and becoming leader or follower later. I&apos;m proposing we delete the `isStrayKraftReplica` check if topicID is None (see below), instead of throwing exception to terminate the kafka. &lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;=== update ===&lt;/p&gt;

&lt;p&gt;Checked &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-14616&quot; title=&quot;Topic recreation with offline broker causes permanent URPs&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-14616&quot;&gt;&lt;del&gt;KAFKA-14616&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-15605&quot; title=&quot;Topics marked for deletion in ZK are incorrectly migrated to KRaft&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-15605&quot;&gt;&lt;del&gt;KAFKA-15605&lt;/del&gt;&lt;/a&gt;, our purpose of finding strayReplicas and delete them is because the replica should be deleted, but left in the log dir. So, if we have a replica that doesn&apos;t have topicID (due to `partition.metadata` is missing), then we cannot identify if this is a stray replica or not. In this case, we can do:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Delete it&lt;/li&gt;
	&lt;li&gt;Ignore it&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;For (1), the impact is, if this is not a stray replica, and the replication-factor only has 1, then the data might be moved to another &quot;xxx-stray&quot; dir, and the partition becomes empty.&lt;/p&gt;

&lt;p&gt;For (2), the impact is, if this is a stray replica and we didn&apos;t delete it, it might cause partition dir is not created as in &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-15605&quot; title=&quot;Topics marked for deletion in ZK are incorrectly migrated to KRaft&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-15605&quot;&gt;&lt;del&gt;KAFKA-15605&lt;/del&gt;&lt;/a&gt; or &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-14616&quot; title=&quot;Topic recreation with offline broker causes permanent URPs&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-14616&quot;&gt;&lt;del&gt;KAFKA-14616&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;As the investigation above, this `partition.metadata` missing issue is mostly because the async `partition.metadata` when creating a topic. Later, before any data append into log, we must make sure partition metadata file is written to the log dir &lt;a href=&quot;https://github.com/apache/kafka/blob/5552f5c26df4eb07b2d6ee218e4a29e4ca790d5c/core/src/main/scala/kafka/log/UnifiedLog.scala#L772-L774&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. So, it should be fine if we delete it since the topic should be empty.&lt;/p&gt;

&lt;p&gt;In short, when finding a log without topicID, we should treat it as a stray log and then delete it.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13580100">KAFKA-16814</key>
            <summary>KRaft broker cannot startup when `partition.metadata` is missing</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="brandboat">Kuan Po Tseng</assignee>
                                    <reporter username="showuon">Luke Chen</reporter>
                        <labels>
                    </labels>
                <created>Wed, 22 May 2024 11:56:04 +0000</created>
                <updated>Wed, 5 Jun 2024 14:05:29 +0000</updated>
                            <resolved>Tue, 4 Jun 2024 23:56:42 +0000</resolved>
                                    <version>3.7.0</version>
                                    <fixVersion>3.7.1</fixVersion>
                    <fixVersion>3.8.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="17848584" author="showuon" created="Wed, 22 May 2024 11:57:02 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davidarthur&quot; class=&quot;user-hover&quot; rel=&quot;davidarthur&quot;&gt;davidarthur&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cmccabe&quot; class=&quot;user-hover&quot; rel=&quot;cmccabe&quot;&gt;cmccabe&lt;/a&gt; , thoughts about it?&lt;/p&gt;</comment>
                            <comment id="17848599" author="muralibasani" created="Wed, 22 May 2024 12:37:56 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=showuon&quot; class=&quot;user-hover&quot; rel=&quot;showuon&quot;&gt;showuon&lt;/a&gt; do you think this is in anyway related to &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-16790&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-16790&lt;/a&gt;, as remoteLogManaer is not configured in kraft broker before brokerMetadataPublisher is initialized and remote storage system is enabled.&lt;/p&gt;

&lt;p&gt;Did you enable REMOTE_LOG_STORAGE_SYSTEM_ENABLE_PROP&#160; in your issue ?&lt;/p&gt;</comment>
                            <comment id="17848781" author="showuon" created="Thu, 23 May 2024 00:10:52 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=muralibasani&quot; class=&quot;user-hover&quot; rel=&quot;muralibasani&quot;&gt;muralibasani&lt;/a&gt; , no, it&apos;s not related to remote storage. I didn&apos;t enable it.&lt;/p&gt;</comment>
                            <comment id="17849917" author="brandboat" created="Tue, 28 May 2024 07:24:12 +0000"  >&lt;p&gt;gentle ping &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=showuon&quot; class=&quot;user-hover&quot; rel=&quot;showuon&quot;&gt;showuon&lt;/a&gt; , I&apos;m willing to solve this issue. Will file a PR soon, many thanks~&lt;/p&gt;</comment>
                            <comment id="17849919" author="showuon" created="Tue, 28 May 2024 07:27:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=brandboat&quot; class=&quot;user-hover&quot; rel=&quot;brandboat&quot;&gt;brandboat&lt;/a&gt; , thanks for the help! I&apos;d like to make this fix into v3.7.1 and v3.8.0 because the impact of this issue is the broker cannot startup at all. Let me know if you have any problem.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 24 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1pd3c:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>