<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:30:55 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-14079] Source task will not commit offsets and develops memory leak if &quot;error.tolerance&quot; is set to &quot;all&quot;</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-14079</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-13348&quot; title=&quot;Allow Source Tasks to Handle Producer Exceptions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-13348&quot;&gt;&lt;del&gt;KAFKA-13348&lt;/del&gt;&lt;/a&gt; added the ability to ignore producer exceptions by setting &lt;tt&gt;error.tolerance&lt;/tt&gt; to &lt;tt&gt;all&lt;/tt&gt;.&#160; When this is set to all a null record metadata is passed to commitRecord() and the task continues.&lt;/p&gt;

&lt;p&gt;The issue is that records are tracked by &lt;tt&gt;SubmittedRecords&lt;/tt&gt; and the first time an error happens the code does not ack the record with the error and just skips it so it will not have the offsets committed or be removed from SubmittedRecords before calling commitRecord().&#160;&lt;/p&gt;

&lt;p&gt;This leads to a bug where future offsets won&apos;t be committed anymore and also a memory leak because the algorithm that removes acked records from the internal map to commit offsets &lt;a href=&quot;https://github.com/apache/kafka/blob/3.2.0/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/SubmittedRecords.java#L177&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;looks &lt;/a&gt; at the head of the Deque where the records are tracked in and if it sees the record is unacked it will not process anymore removals. This leads to all new records that go through the task to continue to be added and not have offsets committed and never removed from tracking until an OOM error occurs.&lt;/p&gt;

&lt;p&gt;The fix is to make sure to ack the failed records so they can have their offsets commited and be removed from tracking. This is fine to do as the records are intended to be skipped and not reprocessed. Metrics also need to be updated as well.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13471880">KAFKA-14079</key>
            <summary>Source task will not commit offsets and develops memory leak if &quot;error.tolerance&quot; is set to &quot;all&quot;</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cshannon">Christopher L. Shannon</assignee>
                                    <reporter username="cshannon">Christopher L. Shannon</reporter>
                        <labels>
                    </labels>
                <created>Sat, 16 Jul 2022 16:16:03 +0000</created>
                <updated>Tue, 26 Jul 2022 20:18:34 +0000</updated>
                            <resolved>Mon, 18 Jul 2022 22:08:11 +0000</resolved>
                                    <version>3.2.0</version>
                                    <fixVersion>3.2.1</fixVersion>
                    <fixVersion>3.3.0</fixVersion>
                    <fixVersion>3.4.0</fixVersion>
                                    <component>connect</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17567510" author="christopher.l.shannon" created="Sat, 16 Jul 2022 16:27:02 +0000"  >&lt;p&gt;I submitted a fix for the 3.2.x branch. The fix is relevant to 3.3.0 as well but a lot of refactoring was done for &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-10000&quot; title=&quot;Atomic commit of source connector records and offsets&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-10000&quot;&gt;&lt;del&gt;KAFKA-10000&lt;/del&gt;&lt;/a&gt; so if the community agrees this is a good fix I can also create another PR for trunk to fix it there as well.&#160;&lt;/p&gt;</comment>
                            <comment id="17567700" author="chrisegerton" created="Sun, 17 Jul 2022 17:43:50 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt; is it correct to say that, in addition to leaking resources, another consequence of this bug is that source tasks become unable to commit some or all source offsets? It might be worth updating the title to reflect that since, in addition to the increased memory utilization we&apos;d expect from an ever-growing deque of records, users may also discover this issue by observing that the offsets for a source connector have become stuck on one or more source partitions. Thoughts?&lt;/p&gt;</comment>
                            <comment id="17567745" author="christopher.l.shannon" created="Sun, 17 Jul 2022 22:07:41 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ChrisEgerton&quot; class=&quot;user-hover&quot; rel=&quot;ChrisEgerton&quot;&gt;ChrisEgerton&lt;/a&gt; - I agree, I updated the title and description and pushed a new PR update.&lt;/p&gt;</comment>
                            <comment id="17568626" author="rhauch" created="Tue, 19 Jul 2022 16:03:46 +0000"  >&lt;p&gt;Following up with some additional detail:&lt;/p&gt;

&lt;p&gt;This issue can affect users that are upgrading to AK 3.2.0, even if they don&apos;t modify any Connect worker config or connector configurations. For example, if a user has a pre-AK 3.2.0 Connect installation running with one or more source connector configurations that use&#160;&lt;tt&gt;error.tolerance=all&lt;/tt&gt;, then when that Connect installation is upgraded to AK 3.2.0&#160;&lt;em&gt;and&lt;/em&gt; subsequently the producer fails to send and ack messages generated by the source connector (e.g., message too large, etc.), then Connect will continue to write records to topics by will no longer commit source offsets for that connector. As mentioned above, Connect will accumulate those additional records in-memory, causing the worker to eventually fail with an OOM.&lt;/p&gt;

&lt;p&gt;Unfortunately, restarting is not likely to be helpful, either: the source offsets are not changed/committed once this condition happens, so upon restart the connector will resume from the previously-committed source offsets and will likely regenerate the same problematic messages as before, triggering the problem again and causing the same OOM.&lt;/p&gt;

&lt;p&gt;The only way to recover is to fix the underlying problem reported by the producer (e.g., message too large), and restart the Connect workers. Luckily the problems reported by the producer are captured in the worker logs.Note that changing the connector configuration to use &lt;tt&gt;error.tolerance=none&lt;/tt&gt;&#160;will cause the connector to stop/fail as soon as the producer fails to write a record to the topic (e.g., message too large), and will not generate duplicate messages beyond the first problematic one (like with&#160;&lt;tt&gt;error.tolerance=all&lt;/tt&gt;). But again, the underlying problem must be corrected before the connector can be restarted successfully.&lt;/p&gt;

&lt;p&gt;This issue does not affect:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;sink connectors;&lt;/li&gt;
	&lt;li&gt;source connector configurations that use&#160;&lt;tt&gt;error.tolerance=none&lt;/tt&gt;, which is the default behavior; or&lt;/li&gt;
	&lt;li&gt;source connectors that never use or rely upon source offsets (a smallish fraction of all source connector types)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Most source connectors do rely upon source offsets, though, so this is a fairly serious issue.&lt;/p&gt;

&lt;p&gt;Thanks, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ChrisEgerton&quot; class=&quot;user-hover&quot; rel=&quot;ChrisEgerton&quot;&gt;ChrisEgerton&lt;/a&gt; for the quick work and review of these PRs. Both PRs linked above (one for the `trunk` branch and one for the `3.2` branch) have been merged. The `3.2` PR was merged before the first 3.2.1 RC, and so the AK 3.2.1 release should include this fix.&lt;/p&gt;</comment>
                            <comment id="17571601" author="rhauch" created="Tue, 26 Jul 2022 20:18:34 +0000"  >&lt;p&gt;Merged to the `3.3` branch with permission from the 3.3 release manager.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 15 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z16www:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>rhauch</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>