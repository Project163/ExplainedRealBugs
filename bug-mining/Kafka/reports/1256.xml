<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:57:32 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-4366] KafkaStreams.close() blocks indefinitely</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-4366</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;KafkaStreams.close() method calls join on all its threads without a timeout, meaning indefinitely, which makes it prone to deadlocks and unfit to be used in shutdown hooks.&lt;/p&gt;

&lt;p&gt;(KafkaStreams::close is used in numerous examples by confluent: &lt;a href=&quot;https://github.com/confluentinc/examples/tree/kafka-0.10.0.1-cp-3.0.1/kafka-streams/src/main/java/io/confluent/examples/streams&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/confluentinc/examples/tree/kafka-0.10.0.1-cp-3.0.1/kafka-streams/src/main/java/io/confluent/examples/streams&lt;/a&gt; and &lt;a href=&quot;https://www.confluent.io/blog/introducing-kafka-streams-stream-processing-made-simple/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://www.confluent.io/blog/introducing-kafka-streams-stream-processing-made-simple/&lt;/a&gt; so we assumed it to be recommended practice)&lt;/p&gt;

&lt;p&gt;A deadlock happens, for instance, if System.exit() is called from within the uncaughtExceptionHandler. (We need to call System.exit() from the uncaughtExceptionHandler because &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-4355&quot; title=&quot;StreamThread intermittently dies with &amp;quot;Topic not found during partition assignment&amp;quot; when broker restarted&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-4355&quot;&gt;&lt;del&gt;KAFKA-4355&lt;/del&gt;&lt;/a&gt; issue shuts down the StreamThread and to recover we want the process to exit, as our infrastructure will then start it up again.)&lt;/p&gt;

&lt;p&gt;The System.exit call (from the uncaughtExceptionHandler, which runs in the StreamThread) will execute the shutdown hook in a new thread and wait for that thread to join. If the shutdown hook calls KafkaStreams.close, it will in turn block waiting for the StreamThread to join, hence the deadlock.&lt;/p&gt;

&lt;p&gt;Runtime.addShutdownHook javadocs state:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Shutdown hooks run at a delicate time in the life cycle of a virtual machine and should therefore be coded defensively. They should, in particular, be written to be thread-safe and to avoid deadlocks insofar as possible&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;and&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Shutdown hooks should also finish their work quickly.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Therefore the current implementation of KafkaStreams.close() which waits forever for threads to join is completely unsuitable for use in a shutdown hook. &lt;/p&gt;
</description>
                <environment></environment>
        <key id="13017149">KAFKA-4366</key>
            <summary>KafkaStreams.close() blocks indefinitely</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="damianguy">Damian Guy</assignee>
                                    <reporter username="mihbor">Michal Borowiecki</reporter>
                        <labels>
                    </labels>
                <created>Wed, 2 Nov 2016 10:02:19 +0000</created>
                <updated>Mon, 11 Sep 2017 18:02:57 +0000</updated>
                            <resolved>Thu, 17 Nov 2016 20:49:38 +0000</resolved>
                                    <version>0.10.0.1</version>
                    <version>0.10.1.0</version>
                                    <fixVersion>0.10.2.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="15633814" author="githubbot" created="Thu, 3 Nov 2016 18:51:18 +0000"  >&lt;p&gt;GitHub user dguy opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/2097&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2097&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-4366&quot; title=&quot;KafkaStreams.close() blocks indefinitely&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-4366&quot;&gt;&lt;del&gt;KAFKA-4366&lt;/del&gt;&lt;/a&gt;: KafkaStreams.close() blocks indefinitely&lt;/p&gt;

&lt;p&gt;    Added `timeout` and `timeUnit` to `KafkaStreams.close(..)`. Now do close on a thread and `join` that thread with the provided `timeout`.&lt;br/&gt;
    Changed `state` in `KafkaStreams` to use an enum.&lt;br/&gt;
    Added system test to ensure we don&apos;t deadlock on close when an uncaught exception handler that calls `System.exit(..)` is used and there is also a shutdown hook that calls `KafkaStreams.close(...)`&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/dguy/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/dguy/kafka&lt;/a&gt; kafka-4366&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/2097.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2097.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #2097&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 6dffa532ca0c065d2e67b812d82b3bdabe97b19d&lt;br/&gt;
Author: Damian Guy &amp;lt;damian.guy@gmail.com&amp;gt;&lt;br/&gt;
Date:   2016-11-03T18:46:33Z&lt;/p&gt;

&lt;p&gt;    add timeout to KafkaStreams.close(..)&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15674771" author="guozhang" created="Thu, 17 Nov 2016 20:49:39 +0000"  >&lt;p&gt;Issue resolved by pull request 2097&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/kafka/pull/2097&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2097&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15674774" author="githubbot" created="Thu, 17 Nov 2016 20:50:14 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/2097&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2097&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16149104" author="pvgpvg" created="Thu, 31 Aug 2017 15:06:29 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=damianguy&quot; class=&quot;user-hover&quot; rel=&quot;damianguy&quot;&gt;damianguy&lt;/a&gt; Still reproducible in streams 0.11.0.0, see thread dump attached&lt;br/&gt;
Code to reproduce:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;       KafkaStreams streams = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; KafkaStreams(builder, settings);
        streams.setUncaughtExceptionHandler((t, e) -&amp;gt; {
            &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.exit(0);
        });
        streams.start();
        &lt;span class=&quot;code-object&quot;&gt;Runtime&lt;/span&gt;.getRuntime().addShutdownHook(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;(streams::close));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16149596" author="mjsax" created="Thu, 31 Aug 2017 20:57:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pvg&quot; class=&quot;user-hover&quot; rel=&quot;pvg&quot;&gt;pvg&lt;/a&gt; You should use the newly introduced overload for &lt;tt&gt;close(long, TimeUnit)&lt;/tt&gt; that does accepted a timeout parameter... If you use &lt;tt&gt;close()&lt;/tt&gt; without parameter if can of course still block infinitely.&lt;/p&gt;</comment>
                            <comment id="16153390" author="habdank" created="Tue, 5 Sep 2017 09:45:06 +0000"  >&lt;p&gt;Questions: &lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;If I will use close(...) with timeout, could it be the case, that I am losing messages?&lt;/li&gt;
	&lt;li&gt;What exactly is happening, when timeout is reached?&lt;/li&gt;
	&lt;li&gt;What are the consequences of calling close(...) with timeout?&lt;/li&gt;
	&lt;li&gt;I had also problems with hanging close(), which in background is calling close(0), but why it can hangs?&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Thanks in advance for ansers &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.&lt;/p&gt;</comment>
                            <comment id="16154625" author="mjsax" created="Wed, 6 Sep 2017 00:24:04 +0000"  >&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;You will not loose messages.&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;KafkaStreams&lt;/tt&gt; wait until all &lt;tt&gt;StreamThread}}s did shut down &amp;#8211; if this does not happen within timeout, {{close()&lt;/tt&gt; just returns (cf. &lt;a href=&quot;https://github.com/apache/kafka/blob/0.11.0.0/streams/src/main/java/org/apache/kafka/streams/KafkaStreams.java#L520&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/0.11.0.0/streams/src/main/java/org/apache/kafka/streams/KafkaStreams.java#L520&lt;/a&gt;)&lt;/li&gt;
	&lt;li&gt;if &lt;tt&gt;close(0)&lt;/tt&gt; is called, &lt;em&gt;no&lt;/em&gt; timeout is applied and &lt;tt&gt;KafkaStreams&lt;/tt&gt; waits forever &amp;#8211; thus, timeout must be at least 1ms to be effective (an described in the JavaDocs): &lt;tt&gt;A timeout of 0 means to wait forever.&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310060">
                    <name>Container</name>
                                            <outwardlinks description="contains">
                                        <issuelink>
            <issuekey id="13045339">KAFKA-4787</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13016188">KAFKA-4355</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12884686" name="threadDump.log" size="39843" author="pvgpvg" created="Thu, 31 Aug 2017 15:05:57 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 10 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i35prj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>