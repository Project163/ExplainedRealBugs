<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:28:00 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-12835] Topic IDs can mismatch on brokers (after interbroker protocol version update)</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-12835</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;We had a Kafka cluster running 2.8 version with interbroker protocol set to 2.7. It had a number of topics and everything was fine.&lt;br/&gt;
Then we decided to update the interbroker protocol to 2.8 by the following procedure:&lt;br/&gt;
1. Run new brokers with the interbroker protocol set to 2.8.&lt;br/&gt;
2. Move the data from the old brokers to the new ones (normal partition reassignment API).&lt;br/&gt;
3. Decommission the old brokers.&lt;/p&gt;

&lt;p&gt;At the stage 2 we had the problem: old brokers started failing on &lt;tt&gt;LeaderAndIsrRequest&lt;/tt&gt; handling with&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ERROR [Broker id=&amp;lt;...&amp;gt;] Topic Id in memory: &amp;lt;...&amp;gt; does not match the topic Id &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition &amp;lt;...&amp;gt; provided in the request: &amp;lt;...&amp;gt;. (state.change.logger)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;for multiple topics. Topics were not recreated.&lt;/p&gt;

&lt;p&gt;We checked &lt;tt&gt;partition.metadata&lt;/tt&gt; files and IDs there were indeed different from the values in ZooKeeper. It was fixed by deleting the metadata files (and letting them be recreated).&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;


&lt;p&gt;The logs, unfortunately, didn&apos;t show anything that might point to the cause of the issue (or it happened longer ago than we store the logs).&lt;/p&gt;

&lt;p&gt;We tried to reproduce this also, but no success.&lt;/p&gt;

&lt;p&gt;If the community can point out what to check or beware of in future, it will be great. We&apos;ll be happy to provide additional information if needed. Thank you!&#160;&lt;/p&gt;

&lt;p&gt;Sorry for the ticket that might be not very actionable. We hope to at least rise awareness of this issue.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13379791">KAFKA-12835</key>
            <summary>Topic IDs can mismatch on brokers (after interbroker protocol version update)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jolshan">Justine Olshan</assignee>
                                    <reporter username="ivanyu">Ivan Yurchenko</reporter>
                        <labels>
                    </labels>
                <created>Fri, 21 May 2021 14:36:54 +0000</created>
                <updated>Tue, 30 Aug 2022 18:25:12 +0000</updated>
                            <resolved>Fri, 18 Jun 2021 16:08:57 +0000</resolved>
                                    <version>2.8.0</version>
                                    <fixVersion>2.8.1</fixVersion>
                    <fixVersion>3.0.0</fixVersion>
                                    <component>core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="17349352" author="jolshan" created="Fri, 21 May 2021 15:56:06 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ivanyu&quot; class=&quot;user-hover&quot; rel=&quot;ivanyu&quot;&gt;ivanyu&lt;/a&gt;. Thanks for pointing this out.&lt;br/&gt;
I was curious about your upgrade process. Is there a reason you moved from old brokers to new brokers rather than doing a rolling restart of the same brokers? (Described in the documentation here: &lt;a href=&quot;https://kafka.apache.org/documentation/#upgrade_2_7_0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://kafka.apache.org/documentation/#upgrade_2_7_0&lt;/a&gt;)&lt;/p&gt;</comment>
                            <comment id="17349479" author="jolshan" created="Fri, 21 May 2021 21:00:14 +0000"  >&lt;p&gt;I believe I found the cause to this issue and will be working on a fix.&lt;/p&gt;</comment>
                            <comment id="17350330" author="ivanyu" created="Mon, 24 May 2021 09:57:00 +0000"  >&lt;blockquote&gt;&lt;p&gt;I was curious about your upgrade process. Is there a reason you moved from old brokers to new brokers rather than doing a rolling restart of the same brokers?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;We try to keep machines immutable, nothing specific in Kafka itself.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I believe I found the cause to this issue and will be working on a fix.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Great to hear this! Could you please the idea at the higher level?&lt;/p&gt;</comment>
                            <comment id="17350684" author="jolshan" created="Mon, 24 May 2021 23:14:35 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ivanyu&quot; class=&quot;user-hover&quot; rel=&quot;ivanyu&quot;&gt;ivanyu&lt;/a&gt;. Previously we could lose topic IDs in the Znode when reassigning partitions. This could occur if we switched between controllers with IBP 2.8 back to 2.7 (where we reassign partitions) and back to 2.8. If the partition.metadata file still existed, we would have the old ID in that, but the new controller would see a topic ID missing in the ZNode and assign a new one.&#160;&lt;/p&gt;

&lt;p&gt;I&apos;ve opened a PR to prevent this loss of topic ID regardless of the IBP of the controller.&lt;/p&gt;</comment>
                            <comment id="17555852" author="JIRAUSER280457" created="Sat, 18 Jun 2022 07:29:10 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jolshan&quot; class=&quot;user-hover&quot; rel=&quot;jolshan&quot;&gt;jolshan&lt;/a&gt; Hello, I find an error similar to this issue mentioned below when I update my kafka from 2.7.0 to 2.8.1.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;2022-06-17 09:34:56,599&amp;#93;&lt;/span&gt; ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;Broker id=0&amp;#93;&lt;/span&gt; Topic Id in memory: PV_7diK7RJaS45KsEH4sng does not match the topic Id for partition __consumer_offsets-14 provided in the request: X_hrEUetShKyQ_RR_pEo9A. (state.change.logger)&lt;/p&gt;

&lt;p&gt;I found that the topic id of __consumer_offsets in partition.metadata is PV_7diK7RJaS45KsEH4sng. And in zookeeper the topic id is X_hrEUetShKyQ_RR_pEo9A.&lt;/p&gt;

&lt;p&gt;Then I delete all partition.metadata of topic __consumer_offsets, restart kafka, and fix this probelm.&lt;/p&gt;

&lt;p&gt;I try to recurrence this probelm the second time, but failed.&lt;/p&gt;

&lt;p&gt;I want to ask in which situation will make the topic id of __consumer_offsets diffirent between partition.metadata and zookeeper. Because when topic __consumer_offsets have this problem, the consumer will not work completely. I had to make attention on it.&lt;/p&gt;

&lt;p&gt;By the way, I found another situation recently, the leader of all partitions of __consumer_offsets always on the same broker.&lt;/p&gt;</comment>
                            <comment id="17598006" author="mrmigles" created="Tue, 30 Aug 2022 18:25:12 +0000"  >&lt;p&gt;Hi All,&lt;/p&gt;

&lt;p&gt;It seems this ticket already solved, but I&apos;d like to add my case too.&lt;/p&gt;


&lt;p&gt;We use Kafka 2.8.1, last upgrade from 2.7.1 to 2.8.1 was performed a few weeks ago.&#160;&lt;br/&gt;
And yesterday we found that Kafka consumes all provided CPU, and a lot of Kafka clients don&apos;t work and failed by timeout. Default logs didn&apos;t show any useful information, but in state-change logs we found a lot of rows with:&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[2022-08-30 17:33:19,804] ERROR [Broker id=3] Topic Id in memory: n1ld3W-pSMqWMS5ceX_v-Q does not match the topic Id &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition __consumer_offsets-14 provided in the request: LzjEgQA5Sw29x-cayfXYEw. (state.change.logger)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;for different topics, but in the most part for __consumer_offsets. We checked and yes, topic_id was different for &quot;patition.metadata&quot; on broker side and zookeeper.&#160;&lt;/p&gt;

&lt;p&gt;Also we found, that a lof of topics were in under ISR status, for example:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Topic: __consumer_offsets &#160; &#160; &#160; TopicId: LzjEgQA5Sw29x-cayfXYEw PartitionCount: 50 &#160; &#160; &#160;ReplicationFactor: 3 &#160; &#160;Configs: compression.type=producer,min.insync.replicas=2,cleanup.policy=compact,segment.bytes=104857600,max.message.bytes=10000000,retention.bytes=1610612735
&#160; &#160; &#160; &#160; Topic: __consumer_offsets &#160; &#160; &#160; Partition: 0 &#160; &#160;Leader: 1 &#160; &#160; &#160; Replicas: 1,3,2 Isr: 1
&#160; &#160; &#160; &#160; Topic: __consumer_offsets &#160; &#160; &#160; Partition: 1 &#160; &#160;Leader: 3 &#160; &#160; &#160; Replicas: 2,1,3 Isr: 3
&#160; &#160; &#160; &#160; Topic: __consumer_offsets &#160; &#160; &#160; Partition: 2 &#160; &#160;Leader: 1 &#160; &#160; &#160; Replicas: 3,2,1 Isr: 1
&#160; &#160; &#160; &#160; Topic: __consumer_offsets &#160; &#160; &#160; Partition: 3 &#160; &#160;Leader: 1 &#160; &#160; &#160; Replicas: 1,2,3 Isr: 1
&#160; &#160; &#160; &#160; Topic: __consumer_offsets &#160; &#160; &#160; Partition: 4 &#160; &#160;Leader: 3 &#160; &#160; &#160; Replicas: 2,3,1 Isr: 3
&#160; &#160; &#160; &#160; Topic: __consumer_offsets &#160; &#160; &#160; Partition: 5 &#160; &#160;Leader: 1 &#160; &#160; &#160; Replicas: 3,1,2 Isr: 1
&#160; &#160; &#160; &#160; Topic: __consumer_offsets &#160; &#160; &#160; Partition: 6 &#160; &#160;Leader: 2 &#160; &#160; &#160; Replicas: 1,3,2 Isr: 2
....
&#160; &#160; &#160; &#160; Topic: __consumer_offsets &#160; &#160; &#160; Partition: 48 &#160; Leader: 2 &#160; &#160; &#160; Replicas: 1,3,2 Isr: 2
  &#160; &#160; &#160; Topic: __consumer_offsets &#160; &#160; &#160; Partition: 49 &#160; Leader: 3 &#160; &#160; &#160; Replicas: 2,1,3 Isr: 3&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;and this didn&apos;t change for a lot of time.&#160;&lt;/p&gt;


&lt;p&gt;While Kafka was loaded in max CPU it couldn&apos;t answer clients correctly, especially consumers, because offsets topic was under ISR we think. So, all related to Kafka services are stuck.&lt;/p&gt;

&lt;p&gt;Thanks to this ticket, we solved a part of issues with removing &quot;partition.metadata&quot; and restart cluster. But Kafka still feels bad and some of partitions still have only one ISR with issue &quot;Non-monotonic update of high watermark&quot;. It looks like another issue &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-13077&quot; title=&quot;Replication failing after unclean shutdown of ZK and all brokers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-13077&quot;&gt;KAFKA-13077&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Is it expected, that we got this issue in 2.8.1 Kafka server?&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 10 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0r9gw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>dajac</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>