<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:01:06 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-5238] BrokerTopicMetrics can be recreated after topic is deleted</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-5238</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;As part of &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3258&quot; title=&quot;BrokerTopicMetrics of deleted topics are never deleted&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3258&quot;&gt;&lt;del&gt;KAFKA-3258&lt;/del&gt;&lt;/a&gt;, we added code to remove metrics during topic deletion. This works fine as long as there are no fetch requests in the purgatory. If there are, however, we&apos;ll recreate the metrics when we call `ReplicaManager.appendToLocalLog`.&lt;/p&gt;

&lt;p&gt;This can be reproduced by updating MetricsTest.testBrokerTopicMetricsUnregisteredAfterDeletingTopic() in the following way:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;@Test
  def testBrokerTopicMetricsUnregisteredAfterDeletingTopic() {
    val topic = &lt;span class=&quot;code-quote&quot;&gt;&quot;test-broker-topic-metric&quot;&lt;/span&gt;
    AdminUtils.createTopic(zkUtils, topic, 2, 1)
    &lt;span class=&quot;code-comment&quot;&gt;// Produce a few messages and consume them to create the metrics
&lt;/span&gt;    TestUtils.produceMessages(servers, topic, nMessages)
    TestUtils.consumeTopicRecords(servers, topic, nMessages)
    assertTrue(&lt;span class=&quot;code-quote&quot;&gt;&quot;Topic metrics don&apos;t exist&quot;&lt;/span&gt;, topicMetricGroups(topic).nonEmpty)
    assertNotNull(BrokerTopicStats.getBrokerTopicStats(topic))
    AdminUtils.deleteTopic(zkUtils, topic)
    TestUtils.verifyTopicDeletion(zkUtils, topic, 1, servers)
    &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(10000)
    assertEquals(&lt;span class=&quot;code-quote&quot;&gt;&quot;Topic metrics exists after deleteTopic&quot;&lt;/span&gt;, Set.empty, topicMetricGroups(topic))
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13071855">KAFKA-5238</key>
            <summary>BrokerTopicMetrics can be recreated after topic is deleted</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="10002" iconUrl="https://issues.apache.org/jira/images/icons/statuses/document.png" description="A patch for this issue has been uploaded to JIRA by a contributor.">Patch Available</status>
                    <statusCategory id="4" key="indeterminate" colorName="yellow"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="ecomar">Edoardo Comar</assignee>
                                    <reporter username="ijuma">Ismael Juma</reporter>
                        <labels>
                    </labels>
                <created>Sun, 14 May 2017 22:52:05 +0000</created>
                <updated>Mon, 27 Jan 2025 03:36:27 +0000</updated>
                                                                                <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="16010472" author="githubbot" created="Mon, 15 May 2017 13:09:47 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/3042&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3042&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16247762" author="ecomar" created="Fri, 10 Nov 2017 16:51:47 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ijuma&quot; class=&quot;user-hover&quot; rel=&quot;ijuma&quot;&gt;ijuma&lt;/a&gt; we may come up with a PR on this issue which is hitting us in a slightly different scenario,&lt;br/&gt;
but with the same root cause :&lt;br/&gt;
topic being deleted just after creation, which means there is a follower first fetch - delayed fetch request - still in the purgatory&lt;br/&gt;
while in your test case there is a delayed fetch because the consumer has issued a prefetch.&lt;/p&gt;

&lt;p&gt;our fix consists in &lt;br/&gt;
&lt;tt&gt;ReplicaManager.readFromLocalLog&lt;/tt&gt;&lt;br/&gt;
checking if&lt;br/&gt;
&lt;tt&gt;if(allPartitions.contains(tp))&lt;/tt&gt;&lt;br/&gt;
and if not throw an UnknownTopicOrPartitionException&lt;br/&gt;
which will be checked in &lt;tt&gt;KafkaApi.fetchResponseCallback&lt;/tt&gt; as a guard on invoking &lt;tt&gt;brokerTopicStats.updateBytesOut&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;does this approach makes sense?&lt;br/&gt;
Hope so, in that case will make the PR on Monday&lt;/p&gt;



</comment>
                            <comment id="16247803" author="githubbot" created="Fri, 10 Nov 2017 17:31:26 +0000"  >&lt;p&gt;GitHub user edoardocomar opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/4204&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/4204&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5238&quot; title=&quot;BrokerTopicMetrics can be recreated after topic is deleted&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-5238&quot;&gt;KAFKA-5238&lt;/a&gt;: BrokerTopicMetrics can be recreated after topic is deleted&lt;/p&gt;

&lt;p&gt;    Avoiding a DelayedFetch recreate the metrics when a topic has been&lt;br/&gt;
    deleted&lt;/p&gt;

&lt;p&gt;    developed with @mimaison&lt;/p&gt;

&lt;p&gt;    added unit test borrowed from @ijuma JIRA&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/edoardocomar/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/edoardocomar/kafka&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5238&quot; title=&quot;BrokerTopicMetrics can be recreated after topic is deleted&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-5238&quot;&gt;KAFKA-5238&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/4204.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/4204.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #4204&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 4e0cee4c81d8bc85ca35d59b927d797330234aab&lt;br/&gt;
Author: Edoardo Comar &amp;lt;ecomar@uk.ibm.com&amp;gt;&lt;br/&gt;
Date:   2017-11-10T17:09:18Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5238&quot; title=&quot;BrokerTopicMetrics can be recreated after topic is deleted&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-5238&quot;&gt;KAFKA-5238&lt;/a&gt;: BrokerTopicMetrics can be recreated after topic is deleted&lt;/p&gt;

&lt;p&gt;    Avoiding a DelayedFetch recreate the metrics when a topic has been&lt;br/&gt;
    deleted&lt;/p&gt;

&lt;p&gt;    developed with @mimaison&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="17676681" author="ecomar" created="Fri, 13 Jan 2023 16:25:22 +0000"  >&lt;p&gt;Retrying with &lt;a href=&quot;https://github.com/apache/kafka/pull/13113&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/13113&lt;/a&gt; &lt;br/&gt;
many years after the old PR,  as this patch has been adopted and used for more than 5 years in my organisation, where before this we were able to detect metrics leaking in long lived clusters.&lt;/p&gt;</comment>
                            <comment id="17693231" author="ecomar" created="Fri, 24 Feb 2023 15:07:50 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/apache/kafka/pull/13113&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/13113&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17884143" author="wushujames" created="Tue, 24 Sep 2024 07:17:34 +0000"  >&lt;p&gt;Hi. I see that there is a PR available. Is there any possibility of getting it merged?&lt;/p&gt;</comment>
                            <comment id="17884195" author="ecomar" created="Tue, 24 Sep 2024 09:39:37 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wushujames&quot; class=&quot;user-hover&quot; rel=&quot;wushujames&quot;&gt;wushujames&lt;/a&gt; at the time I did not manage to get the PR approved - same fate as its predecessor &lt;a href=&quot;https://github.com/apache/kafka/pull/4204&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/4204&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;OTOH, we&apos;ve been running Kafka with my patch for years and works well for us.&lt;/p&gt;

&lt;p&gt;The OR is now quite old and I&apos;d need to test the problem still exists in trunk and maybe update the PR. I will give it a go&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 7 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3eyc7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>