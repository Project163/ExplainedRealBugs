<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:12:53 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-7112] StreamThread does not check for state again after pollRequests()</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-7112</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;In StreamThread&apos;s main loop, we have:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (state == State.PARTITIONS_ASSIGNED) {
            &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; to fetch some records with zero poll millis
&lt;/span&gt;            &lt;span class=&quot;code-comment&quot;&gt;// to unblock the restoration as soon as possible
&lt;/span&gt;            records = pollRequests(Duration.ZERO);

            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (taskManager.updateNewAndRestoringTasks()) {
                setState(State.RUNNING);
            }
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;in which we first check for state, and if it is &lt;tt&gt;PARTITIONS_ASSIGNED&lt;/tt&gt; then call `consumer.poll()` and then call `askManager.updateNewAndRestoringTasks()`. There is a race condition though, that if another rebalance gets triggered, then `onPartitionRevoked` will be called in which we will &lt;tt&gt;restoreConsumer.unsubscribe();&lt;/tt&gt;, and then if we call &lt;tt&gt;taskManager.updateNewAndRestoringTasks()&lt;/tt&gt; right away we will see this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Encountered the following error during processing: (org.apache.kafka.streams.processor.internals.StreamThread)
java.lang.IllegalStateException: Consumer is not subscribed to any topics or assigned any partitions
        at org.apache.kafka.clients.consumer.KafkaConsumer.poll(KafkaConsumer.java:1159)
        at org.apache.kafka.clients.consumer.KafkaConsumer.poll(KafkaConsumer.java:1150)
        at org.apache.kafka.streams.processor.internals.StoreChangelogReader.restore(StoreChangelogReader.java:83)
        at org.apache.kafka.streams.processor.internals.TaskManager.updateNewAndRestoringTasks(TaskManager.java:317)
        at org.apache.kafka.streams.processor.internals.StreamThread.runOnce(StreamThread.java:808)
        at org.apache.kafka.streams.processor.internals.StreamThread.runLoop(StreamThread.java:767)
        at org.apache.kafka.streams.processor.internals.StreamThread.run(StreamThread.java:736)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13168737">KAFKA-7112</key>
            <summary>StreamThread does not check for state again after pollRequests()</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="guozhang">Guozhang Wang</assignee>
                                    <reporter username="guozhang">Guozhang Wang</reporter>
                        <labels>
                    </labels>
                <created>Thu, 28 Jun 2018 00:09:39 +0000</created>
                <updated>Fri, 29 Jun 2018 14:13:39 +0000</updated>
                            <resolved>Fri, 29 Jun 2018 14:13:39 +0000</resolved>
                                                    <fixVersion>2.0.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16525774" author="githubbot" created="Thu, 28 Jun 2018 00:39:31 +0000"  >&lt;p&gt;guozhangwang opened a new pull request #5306: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7112&quot; title=&quot;StreamThread does not check for state again after pollRequests()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7112&quot;&gt;&lt;del&gt;KAFKA-7112&lt;/del&gt;&lt;/a&gt;: Only resume restoration if state is still PARTITIONS_ASSIGNED after poll&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5306&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5306&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Before KIP-266, consumer.poll(0) would call `updateAssignmentMetadataIfNeeded(Long.MAX_VALUE)`, which makes sure that the rebalance is definitely completed, i.e. both onPartitionRevoked and onPartitionAssigned called within this `poll(0)`. After KIP-266, however, it is possible that only onPartitionRevoked will be called if timeout is elapsed. And hence we need to double check that state is still `PARTITIONS_ASSIGNED` after the `consumer.poll(duration)` call.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16525880" author="mjsax" created="Thu, 28 Jun 2018 03:52:38 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; What is affected version? 2.0? Would this be worth rolling a new RC?&lt;/p&gt;</comment>
                            <comment id="16526446" author="guozhang" created="Thu, 28 Jun 2018 15:42:59 +0000"  >&lt;p&gt;I think so, would chat to release manager &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rsivaram&quot; class=&quot;user-hover&quot; rel=&quot;rsivaram&quot;&gt;rsivaram&lt;/a&gt; for that.&lt;/p&gt;</comment>
                            <comment id="16526581" author="githubbot" created="Thu, 28 Jun 2018 17:19:45 +0000"  >&lt;p&gt;guozhangwang closed pull request #5306: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7112&quot; title=&quot;StreamThread does not check for state again after pollRequests()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7112&quot;&gt;&lt;del&gt;KAFKA-7112&lt;/del&gt;&lt;/a&gt;: Only resume restoration if state is still PARTITIONS_ASSIGNED after poll&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5306&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5306&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamThread.java b/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamThread.java&lt;br/&gt;
index a159e7b6c7a..77538ae9c78 100644&lt;br/&gt;
&amp;#8212; a/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamThread.java&lt;br/&gt;
+++ b/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamThread.java&lt;br/&gt;
@@ -804,21 +804,26 @@ long runOnce(final long recordsProcessedBeforeCommit) &lt;/p&gt;
{
             // try to fetch some records with zero poll millis
             // to unblock the restoration as soon as possible
             records = pollRequests(Duration.ZERO);
+        }
&lt;p&gt; else if (state == State.PARTITIONS_REVOKED) &lt;/p&gt;
{
+            // try to fetch some records with normal poll time
+            // in order to wait long enough to get the join response
+            records = pollRequests(pollTime);
+        }
&lt;p&gt; else if (state == State.RUNNING) &lt;/p&gt;
{
+            // try to fetch some records with normal poll time
+            // in order to get long polling
+            records = pollRequests(pollTime);
+        }
&lt;p&gt; else {&lt;br/&gt;
+            // any other state should not happen&lt;br/&gt;
+            log.error(&quot;Unexpected state {} during normal iteration&quot;, state);&lt;br/&gt;
+            throw new StreamsException(logPrefix + &quot;Unexpected state &quot; + state + &quot; during normal iteration&quot;);&lt;br/&gt;
+        }&lt;/p&gt;

&lt;p&gt;+        // only try to initialize the assigned tasks&lt;br/&gt;
+        // if the state is still in PARTITION_ASSIGNED after the poll call&lt;br/&gt;
+        if (state == State.PARTITIONS_ASSIGNED) {&lt;br/&gt;
             if (taskManager.updateNewAndRestoringTasks()) &lt;/p&gt;
{
                 setState(State.RUNNING);
             }
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;} else {&lt;/li&gt;
	&lt;li&gt;// try to fetch some records if necessary&lt;/li&gt;
	&lt;li&gt;records = pollRequests(pollTime);&lt;br/&gt;
-&lt;/li&gt;
	&lt;li&gt;// if state changed after the poll call,&lt;/li&gt;
	&lt;li&gt;// try to initialize the assigned tasks again&lt;/li&gt;
	&lt;li&gt;if (state == State.PARTITIONS_ASSIGNED) {&lt;/li&gt;
	&lt;li&gt;if (taskManager.updateNewAndRestoringTasks()) 
{
-                    setState(State.RUNNING);
-                }&lt;/li&gt;
	&lt;li&gt;}&lt;br/&gt;
         }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         if (records != null &amp;amp;&amp;amp; !records.isEmpty() &amp;amp;&amp;amp; taskManager.hasActiveRunningTasks()) {&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 20 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3vbb3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>