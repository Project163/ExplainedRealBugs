<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:37:18 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-748] Append to index fails due to invalid offset</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-748</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;We seem to be appending to the index and it checks to make sure we do not insert an entry with an offset that is larger than the actual offset of the message. We seem to be trying to insert an offset = 1 in the index while lastOffset is 24463. This seems to get fixed on restarting the broker.&lt;/p&gt;

&lt;p&gt;java.lang.IllegalArgumentException: Attempt to append an offset (1) to position 21703 no larger than the last offset appended (24463).&lt;br/&gt;
at kafka.log.OffsetIndex.append(OffsetIndex.scala:183)&lt;br/&gt;
at kafka.log.LogSegment.append(LogSegment.scala:60)&lt;br/&gt;
at kafka.log.Log.append(Log.scala:286)&lt;br/&gt;
at kafka.server.KafkaApis$$anonfun$appendToLocalLog$2.apply(KafkaApis.scala:188)&lt;br/&gt;
at kafka.server.KafkaApis$$anonfun$appendToLocalLog$2.apply(KafkaApis.scala:181)&lt;br/&gt;
at scala.collection.TraversableLike$$anonfun$map$1.apply(TraversableLike.scala:206)&lt;br/&gt;
at scala.collection.TraversableLike$$anonfun$map$1.apply(TraversableLike.scala:206)&lt;br/&gt;
at scala.collection.immutable.Map$Map1.foreach(Map.scala:105)&lt;br/&gt;
at scala.collection.TraversableLike$class.map(TraversableLike.scala:206)&lt;/p&gt;</description>
                <environment></environment>
        <key id="12630726">KAFKA-748</key>
            <summary>Append to index fails due to invalid offset</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jkreps">Jay Kreps</assignee>
                                    <reporter username="sriramsub">Sriram</reporter>
                        <labels>
                            <label>p1</label>
                    </labels>
                <created>Mon, 4 Feb 2013 19:14:12 +0000</created>
                <updated>Fri, 22 Feb 2013 05:32:33 +0000</updated>
                            <resolved>Fri, 8 Feb 2013 18:58:33 +0000</resolved>
                                    <version>0.8.0</version>
                                    <fixVersion>0.8.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13570743" author="sriramsub" created="Mon, 4 Feb 2013 23:29:26 +0000"  >&lt;p&gt;The last few lines in the index file are below. Looks like the offsets are not monotonically increasing. Note that these are the last lines that the DumpLogSegment tool could dump since it fails due to the mismatch. This still does not explain why the append is happening to offset 1. Adding some logging on startup, append and truncate code paths to ensure sanity and shutting down if there is inconsistency should help to get more info.&lt;/p&gt;


&lt;p&gt;offset: 24878 position: 278006637&lt;br/&gt;
offset: 24879 position: 278012656&lt;br/&gt;
offset: 24880 position: 278050159&lt;br/&gt;
offset: 24313 position: 249363783&lt;/p&gt;</comment>
                            <comment id="13574021" author="jkreps" created="Thu, 7 Feb 2013 22:54:04 +0000"  >&lt;p&gt;This is actually very easy to reproduce. Just do a clean shutdown on the broker while running the producer perf test. Haven&apos;t debugged it yet.&lt;/p&gt;</comment>
                            <comment id="13574067" author="jkreps" created="Thu, 7 Feb 2013 23:50:19 +0000"  >&lt;p&gt;Okay the problem here is the resize method. We generalized index.trimInvalid to index.resize to be able to enlarge the index when we load a segment. This was done to avoid rolling the log on a full index, I think, which had other problems with empty indexes. However it looks like this never actually was tried, because doing this resets the position in the mmap to 0, so we start overwriting the entries in the index from the beginning but expanding what we think the valid segment of the memory map is. When we close we then have a bunch of zeros at the end of the index and have overwritten the front of the file.&lt;/p&gt;</comment>
                            <comment id="13574093" author="jkreps" created="Fri, 8 Feb 2013 00:15:54 +0000"  >&lt;p&gt;Attached is a patch that retains the index position on resize. It also includes a few useful logging and assert statements.&lt;/p&gt;</comment>
                            <comment id="13574678" author="junrao" created="Fri, 8 Feb 2013 18:12:00 +0000"  >&lt;p&gt;Thanks for the patch. It looks good. So +1. I suggest that we add one more sanity check after loading all logs during startup: make sure that the position pointed to by the last index entry is less than FileMessageSet.sizeInBytes(). We can probably just do the check for the active log segment.&lt;/p&gt;

&lt;p&gt;Also, do you think this can cause &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-753&quot; title=&quot;Kafka broker shuts down while loading segments&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-753&quot;&gt;&lt;del&gt;KAFKA-753&lt;/del&gt;&lt;/a&gt; too?&lt;/p&gt;</comment>
                            <comment id="13574727" author="jkreps" created="Fri, 8 Feb 2013 18:58:33 +0000"  >&lt;p&gt;Checked in.&lt;/p&gt;

&lt;p&gt;Jun, I think we effectively do the check you describe already because we run translateOffset on the last index entry in order to initialize the log end offset.&lt;/p&gt;

&lt;p&gt;I am so sure that this can cause the negative position issue.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12568498" name="KAFKA-748-v1.patch" size="5906" author="jkreps" created="Fri, 8 Feb 2013 00:15:54 +0000"/>
                            <attachment id="12567905" name="outindex" size="715732" author="sriramsub" created="Mon, 4 Feb 2013 23:29:26 +0000"/>
                            <attachment id="12567906" name="outmsg" size="3140651" author="sriramsub" created="Mon, 4 Feb 2013 23:29:26 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>311222</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 41 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1hpk7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>311568</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>