<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:56:49 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-4298] LogCleaner writes inconsistent compressed message set if topic message format != message format</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-4298</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;When cleaning the log, we don&apos;t want to convert messages to the format configured for the topic due to &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3915&quot; title=&quot;LogCleaner IO buffers do not account for potential size difference due to message format change&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3915&quot;&gt;&lt;del&gt;KAFKA-3915&lt;/del&gt;&lt;/a&gt;. However, the cleaner logic for writing compressed messages (in case some messages in the message set were not retained) writes the topic message format version in the magic field of the outer message instead of the actual message format. The choice of the absolute/relative offset for the inner messages will also be based on the topic message format version.&lt;/p&gt;

&lt;p&gt;For example, if there is an old compressed message set with magic=0 in the log and the topic is configured for magic=1, then after cleaning, the new message set will have a wrapper with magic=1, the nested messages will still have magic=0, but the message offsets will be relative. If this happens, there does not seem to be an easy way to recover without manually fixing up the log.&lt;/p&gt;

&lt;p&gt;The offsets still work correctly as both the clients and broker use the outer message format version to decide if the relative offset needs to be converted to an absolute offset. So the main problem turns out to be that `ByteBufferMessageSet.deepIterator` throws an exception if there is a mismatch between outer and inner message format version.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (newMessage.magic != wrapperMessage.magic)
          &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IllegalStateException(s&lt;span class=&quot;code-quote&quot;&gt;&quot;Compressed message has magic value ${wrapperMessage.magic} &quot;&lt;/span&gt; +
            s&lt;span class=&quot;code-quote&quot;&gt;&quot;but &lt;span class=&quot;code-keyword&quot;&gt;inner&lt;/span&gt; message has magic value ${newMessage.magic}&quot;&lt;/span&gt;)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13011889">KAFKA-4298</key>
            <summary>LogCleaner writes inconsistent compressed message set if topic message format != message format</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hachikuji">Jason Gustafson</assignee>
                                    <reporter username="hachikuji">Jason Gustafson</reporter>
                        <labels>
                    </labels>
                <created>Thu, 13 Oct 2016 04:31:41 +0000</created>
                <updated>Fri, 14 Oct 2016 04:25:50 +0000</updated>
                            <resolved>Fri, 14 Oct 2016 04:25:34 +0000</resolved>
                                    <version>0.10.0.1</version>
                                    <fixVersion>0.10.1.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15570935" author="githubbot" created="Thu, 13 Oct 2016 05:45:17 +0000"  >&lt;p&gt;GitHub user hachikuji opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/2019&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2019&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-4298&quot; title=&quot;LogCleaner writes inconsistent compressed message set if topic message format != message format&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-4298&quot;&gt;&lt;del&gt;KAFKA-4298&lt;/del&gt;&lt;/a&gt;: Ensure compressed message sets are converted when cleaning the log&lt;/p&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/hachikuji/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/hachikuji/kafka&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-4298&quot; title=&quot;LogCleaner writes inconsistent compressed message set if topic message format != message format&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-4298&quot;&gt;&lt;del&gt;KAFKA-4298&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/2019.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2019.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #2019&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit af3b31b4d94ece1603ac470bfd8d781558987501&lt;br/&gt;
Author: Jason Gustafson &amp;lt;jason@confluent.io&amp;gt;&lt;br/&gt;
Date:   2016-10-13T04:56:52Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-4298&quot; title=&quot;LogCleaner writes inconsistent compressed message set if topic message format != message format&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-4298&quot;&gt;&lt;del&gt;KAFKA-4298&lt;/del&gt;&lt;/a&gt;: Ensure compressed message sets are converted when cleaning the log&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15571432" author="ijuma" created="Thu, 13 Oct 2016 09:37:14 +0000"  >&lt;p&gt;Great catch. I&apos;m a bit unsure why this hasn&apos;t been reported so far. I think the correct description is:&lt;/p&gt;

&lt;p&gt;&quot;When cleaning the log, we don&apos;t want to convert messages to the format configured for the topic due to &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3915&quot; title=&quot;LogCleaner IO buffers do not account for potential size difference due to message format change&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3915&quot;&gt;&lt;del&gt;KAFKA-3915&lt;/del&gt;&lt;/a&gt;. However, the cleaner logic for writing compressed messages (in case some messages in the message set were not retained) writes the topic message format version in the magic field of the outer message instead of the actual message format. The choice of the absolute/relative offset for the inner messages will also be based on the topic message format version.&lt;/p&gt;

&lt;p&gt;For example, if there is an old compressed message set with magic=0 in the log and the topic is configured for magic=1, then after cleaning, the new message set will have a wrapper with magic=1, the nested messages will still have magic=0, but the message offsets will be relative. If this happens, there does not seem to be an easy way to recover without manually fixing up the log.&quot;&lt;/p&gt;

&lt;p&gt;Edit: updated the description.&lt;/p&gt;</comment>
                            <comment id="15574146" author="hachikuji" created="Fri, 14 Oct 2016 04:25:34 +0000"  >&lt;p&gt;Issue resolved by pull request 2019&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/kafka/pull/2019&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2019&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15574148" author="githubbot" created="Fri, 14 Oct 2016 04:25:50 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/2019&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2019&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 5 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i34tfr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>