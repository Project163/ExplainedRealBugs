<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:27:36 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-12815] KTable.transformValue might have incorrect record metadata</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-12815</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;In the DSL, Kafka Streams applies an optimization for non-materialized tables: when these are queried an upstream state store is accessed. To ensure that the correct value is returned from the lookup, all intermediate processors after the materialized store, and before the processor that triggers the lookup are re-applied (cf `KTableValueGetter`).&lt;/p&gt;

&lt;p&gt;For re-applying DSL operators like filter/mapValues that works fine. However, for transformValue(), the method is executed with the incorrect `RecordContext` (note that DSL operators like filter don&apos;t have access to the `RecordContext` and thus, are not subject to this bug). Instead of using the record context from the value that was received from the upstream state store (and that is re-processed), the transformer would see the context from the record that triggered the lookup.&lt;/p&gt;

&lt;p&gt;Thus, the information about timestamp, offset, partition, topic name, and headers is incorrect.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13379376">KAFKA-12815</key>
            <summary>KTable.transformValue might have incorrect record metadata</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mjsax">Matthias J. Sax</assignee>
                                    <reporter username="mjsax">Matthias J. Sax</reporter>
                        <labels>
                    </labels>
                <created>Wed, 19 May 2021 21:48:15 +0000</created>
                <updated>Wed, 16 Jun 2021 16:57:29 +0000</updated>
                            <resolved>Wed, 19 May 2021 22:11:58 +0000</resolved>
                                                    <fixVersion>3.0.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17347887" author="ableegoldman" created="Wed, 19 May 2021 22:41:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mjsax&quot; class=&quot;user-hover&quot; rel=&quot;mjsax&quot;&gt;mjsax&lt;/a&gt;&#160;should we fix back to 2.8 at least? If it&apos;s a critical bug for FKJ or potentially any custom transformValues on a KTable, we should consider cherrypicking it back at least one version.&lt;/p&gt;</comment>
                            <comment id="17347995" author="guozhang" created="Thu, 20 May 2021 00:45:06 +0000"  >&lt;p&gt;For the longer term, I feel that we either need to 1) persist the topic / offset information into the upstream materialized store as well, or 2) just disable this optimization for KTable.transformValues(), or at least allow users to opt-in / opt-out if they know the risks of calling context.topic() / offset(). Personally, I&apos;d lean towards 2). &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mjsax&quot; class=&quot;user-hover&quot; rel=&quot;mjsax&quot;&gt;mjsax&lt;/a&gt; maybe we should create a new ticket open for this longer term solution?&lt;/p&gt;</comment>
                            <comment id="17348048" author="mjsax" created="Thu, 20 May 2021 04:36:39 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ableegoldman&quot; class=&quot;user-hover&quot; rel=&quot;ableegoldman&quot;&gt;ableegoldman&lt;/a&gt;&#160;This bug does not affect FK-joins. I am actually also not sure, how many users would actually user `KTable.transformValues` &lt;em&gt;and&lt;/em&gt; use the record context metadata (I would assume that if people to this, we would have gotten a bug report from them). Don&apos;t have a strong opinion on back-porting to `2.8`, but I don&apos;t think that it&apos;s a critical bug, so maybe we can just leave it as-is?&lt;/p&gt;

&lt;p&gt;For the long term, I am not sure either &#8211; I think it&apos;s ok to stay passive and only improve if users really start to raise it as an issue. Note, that the `RecordContext` JavaDocs already state that record information might not be available. So it&apos;s not a regression we are introducing with this fix, but it&apos;s a real fix, because we omit missing information instead of passing in incorrect information.&lt;/p&gt;</comment>
                            <comment id="17348068" author="guozhang" created="Thu, 20 May 2021 05:49:14 +0000"  >&lt;p&gt;Yup, we are definitely fixing forward rather than regressing here as previously people would just get the incorrect result silently. As for the longer term, I kinda also agree that we can wait and see how large of an impact it would be to not have topic/offsets be available; but what I&apos;m pointing out is that this is not an impossible task to do, we just need to be careful about our trade-offs here. For some advanced users that may be using `transformValues` heavily but do not leverage on topic/offsets, at least we should allow them to choose based on their own knowledge.&lt;/p&gt;</comment>
                            <comment id="17348072" author="mjsax" created="Thu, 20 May 2021 05:55:55 +0000"  >&lt;p&gt;Well, user can still force to materialize the result of `transformValues()` to avoid this issue. Or they can add topic/offset into the value to preserve the information.&lt;/p&gt;</comment>
                            <comment id="17348646" author="ableegoldman" created="Thu, 20 May 2021 17:23:11 +0000"  >&lt;p&gt;Ack, sorry I made a bad assumption about how FKJ are implemented internally. I wasn&apos;t the one to review them&lt;/p&gt;

&lt;p&gt;Given the limited scope of this bug I would say it feels appropriate to just fix in trunk for now, and file a followup ticket pointing out this bug/as an improvement to tighten up the processor context contract w.r.t topic() and offset(). If there are users currently out there for whom this is an essential feature, it will be pretty obvious once their apps start failing with an NPE, and they will probably let us know. We can re-evaluate whether to do a &quot;full fix&quot; if/when user reports come in&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13233851">KAFKA-8377</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 25 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0r6wo:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>