<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:39:19 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-1097] Race condition while reassigning low throughput partition leads to incorrect ISR information in zookeeper </title>
                <link>https://issues.apache.org/jira/browse/KAFKA-1097</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;While moving partitions, the controller moves the old replicas through the following state changes -&lt;/p&gt;

&lt;p&gt;ONLINE -&amp;gt; OFFLINE -&amp;gt; NON_EXISTENT&lt;/p&gt;

&lt;p&gt;During the offline state change, the controller removes the old replica and writes the updated ISR to zookeeper and notifies the leader. Note that it doesn&apos;t notify the old replicas to stop fetching from the leader (to be fixed in &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-1032&quot; title=&quot;Messages sent to the old leader will be lost on broker GC resulted failure&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-1032&quot;&gt;&lt;del&gt;KAFKA-1032&lt;/del&gt;&lt;/a&gt;). During the non-existent state change, the controller does not write the updated ISR or replica list to zookeeper. Right after the non-existent state change, the controller writes the new replica list to zookeeper, but does not update the ISR. So an old replica can send a fetch request after the offline state change, essentially letting the leader add it back to the ISR. The problem is that if there is no new data coming in for the partition and the old replica is fully caught up, the leader cannot remove it from the ISR. That lets a non existent replica live in the ISR at least until new data comes in to the partition&lt;/p&gt;</description>
                <environment></environment>
        <key id="12674908">KAFKA-1097</key>
            <summary>Race condition while reassigning low throughput partition leads to incorrect ISR information in zookeeper </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="nehanarkhede">Neha Narkhede</assignee>
                                    <reporter username="nehanarkhede">Neha Narkhede</reporter>
                        <labels>
                    </labels>
                <created>Mon, 21 Oct 2013 22:01:50 +0000</created>
                <updated>Fri, 1 Nov 2013 17:28:38 +0000</updated>
                            <resolved>Fri, 1 Nov 2013 17:28:34 +0000</resolved>
                                    <version>0.8.0</version>
                                    <fixVersion>0.8.1</fixVersion>
                                    <component>controller</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="13802108" author="nehanarkhede" created="Tue, 22 Oct 2013 18:42:18 +0000"  >&lt;p&gt;This is a timing issue between when the controller executes related state changes and when those state changes actually get executed on the broker. In this case, the right time to remove the replica from ISR is actually on receiving the StopReplicaResponse from the broker. This ensures that the broker will not send any more fetch requests to the leader and add itself back to the ISR. This is the right fix, but is a non-trivial change to the controller and is dependent on &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-1099&quot; title=&quot;StopReplicaRequest and StopReplicaResponse should also carry the replica ids&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-1099&quot;&gt;&lt;del&gt;KAFKA-1099&lt;/del&gt;&lt;/a&gt;. &lt;/p&gt;

&lt;p&gt;A short-term fix which will alleviate the issue, but not completely fix it is to send the stop replica request to the broker on the OfflineReplica state change, then shrink the ISR on the controller. In addition, send the stop replica (with delete) request on the NonExistentReplica state change and shrink the ISR again. There is a small chance that the broker hasn&apos;t acted on the 2 stop replica requests and still adds itself back to the ISR, after the controller shrinks the ISR during the NonExistentReplica state change. But this is unlikely. &lt;/p&gt;

&lt;p&gt;So the options for this bug fix are -&lt;/p&gt;

&lt;p&gt;1. Take the short term fix for 0.8 and leave the larger change for trunk&lt;br/&gt;
2. Don&apos;t even take the short term fix and just fix it properly on trunk&lt;/p&gt;</comment>
                            <comment id="13802132" author="sriramsub" created="Tue, 22 Oct 2013 18:56:04 +0000"  >&lt;p&gt;From the description, it does not seem like it causes bad things to happen. The non existent replica would be in the ISR till new data comes to the partition. Is there any bad things that can happen in this state?&lt;/p&gt;</comment>
                            <comment id="13802251" author="nehanarkhede" created="Tue, 22 Oct 2013 20:49:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sriramsub&quot; class=&quot;user-hover&quot; rel=&quot;sriramsub&quot;&gt;sriramsub&lt;/a&gt; Agree that it is sort of corner case. A potential risk is that while a partition is in this state (with no new data coming in) and the leader dies or needs to be bounced, there is a risk that the controller might try to elect a non existent replica as the leader. Since we don&apos;t retry leader elections based on response from the broker, this might be a potential issue.&lt;/p&gt;

&lt;p&gt;On the other hand, there is a workaround. The admin can patch the ISR manually in zookeeper and run the preferred replica election which makes the controller send the right ISR and assigned replica list to the leader, which will also fix the leader&apos;s internal data structures that hold the ISR.&lt;/p&gt;</comment>
                            <comment id="13802292" author="guozhang" created="Tue, 22 Oct 2013 21:32:20 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nehanarkhede&quot; class=&quot;user-hover&quot; rel=&quot;nehanarkhede&quot;&gt;nehanarkhede&lt;/a&gt;, as you have mentioned leader should be able to kick the stale replica out of ISR even if there is no more data coming, since it can also kick a replica based on time instead of data lagging. Why this did not happen?&lt;/p&gt;</comment>
                            <comment id="13802324" author="nehanarkhede" created="Tue, 22 Oct 2013 21:56:20 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; The ISR shrink logic marks replicas as possibly stuck only if the replicas are lagging behind the leader&apos;s highwatermark. You can argue that the leader can keep track of fully caught up replicas that have stopped fetching and kick the replicas out of ISR based on the replica&apos;s long poll timeout, but that is pretty complicated. So if the partition is not getting any more data and the old replica is fully caught up with the leader, there is nothing much the leader can do to shrink the ISR.&lt;/p&gt;</comment>
                            <comment id="13802335" author="jjkoshy" created="Tue, 22 Oct 2013 22:03:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; Neha&apos;s comment wrt not getting any more data and the leader not shrinking the ISR is when the old replica is already fully caught up. The time-based shrinking happens only if the replica was at a smaller log-end-offset.&lt;/p&gt;

&lt;p&gt;WRT this issue given that the old replica re-enters the ISR at the end of the new ISR, the likelihood of this being a issue (i.e., the old replica being elected as a leader) is relatively low (can you confirm?) That said, my preference would be the long-term fix on trunk instead of a partially correct fix on 0.8. However, the fact that we have an spurious/incorrect entry in the ISR list would skew the under-replicated partition count wouldn&apos;t it? In which case that would be a blocker issue.&lt;/p&gt;</comment>
                            <comment id="13802344" author="jjkoshy" created="Tue, 22 Oct 2013 22:07:42 +0000"  >&lt;p&gt;nm.. i think the previous comment addressed the concern already. the spurious entry would exist only as long as there is no data coming in. or else the leader would in fact kick it out of the ISR.&lt;/p&gt;</comment>
                            <comment id="13802546" author="charmalloc" created="Wed, 23 Oct 2013 03:06:50 +0000"  >&lt;p&gt;So, quick question.  If you have 3 brokers with replication 3 then this issue would not occur, right? If not then I am not understanding the problem &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13802566" author="nehanarkhede" created="Wed, 23 Oct 2013 03:51:35 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=joestein&quot; class=&quot;user-hover&quot; rel=&quot;joestein&quot;&gt;joestein&lt;/a&gt; This can happen only during partition reassignment.&lt;/p&gt;</comment>
                            <comment id="13802591" author="nehanarkhede" created="Wed, 23 Oct 2013 04:34:28 +0000"  >&lt;p&gt;Created reviewboard &lt;a href=&quot;https://reviews.apache.org/r/14865/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/14865/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13802598" author="nehanarkhede" created="Wed, 23 Oct 2013 04:38:12 +0000"  >&lt;p&gt;I think the changes are tricky and non trivial, so I suggest we take this on trunk, since we are close to the 0.8-final release and this error is recoverable through admin tools&lt;/p&gt;</comment>
                            <comment id="13804367" author="junrao" created="Thu, 24 Oct 2013 16:32:31 +0000"  >&lt;p&gt;Posted the comment on the RB. The patch is a bit tricky. I agree that we should patch it only in trunk so that we will can test it out more thoroughly.&lt;/p&gt;</comment>
                            <comment id="13804616" author="nehanarkhede" created="Thu, 24 Oct 2013 19:56:54 +0000"  >&lt;p&gt;Thinking about it more, my original proposed long term fix (mentioned in my 1st comment) is much less hackier and precise compared to the one in the rb. &lt;/p&gt;</comment>
                            <comment id="13808228" author="nehanarkhede" created="Tue, 29 Oct 2013 17:49:52 +0000"  >&lt;p&gt;Updated reviewboard &lt;a href=&quot;https://reviews.apache.org/r/14865/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/14865/&lt;/a&gt;&lt;br/&gt;
 against branch trunk&lt;/p&gt;</comment>
                            <comment id="13809909" author="nehanarkhede" created="Thu, 31 Oct 2013 04:46:11 +0000"  >&lt;p&gt;Updated reviewboard &lt;a href=&quot;https://reviews.apache.org/r/14865/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/14865/&lt;/a&gt;&lt;br/&gt;
 against branch trunk&lt;/p&gt;</comment>
                            <comment id="13810468" author="nehanarkhede" created="Thu, 31 Oct 2013 17:37:50 +0000"  >&lt;p&gt;Updated reviewboard &lt;a href=&quot;https://reviews.apache.org/r/14865/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/14865/&lt;/a&gt;&lt;br/&gt;
 against branch trunk&lt;/p&gt;</comment>
                            <comment id="13811442" author="nehanarkhede" created="Fri, 1 Nov 2013 16:55:58 +0000"  >&lt;p&gt;Updated reviewboard &lt;a href=&quot;https://reviews.apache.org/r/14865/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/14865/&lt;/a&gt;&lt;br/&gt;
 against branch trunk&lt;/p&gt;</comment>
                            <comment id="13811482" author="nehanarkhede" created="Fri, 1 Nov 2013 17:28:34 +0000"  >&lt;p&gt;Thanks a lot for the reviews, pushed to trunk.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12609797" name="KAFKA-1097.patch" size="10851" author="nehanarkhede" created="Wed, 23 Oct 2013 04:34:27 +0000"/>
                            <attachment id="12610879" name="KAFKA-1097_2013-10-29_10:49:45.patch" size="28700" author="nehanarkhede" created="Tue, 29 Oct 2013 17:49:52 +0000"/>
                            <attachment id="12611249" name="KAFKA-1097_2013-10-30_21:46:00.patch" size="41105" author="nehanarkhede" created="Thu, 31 Oct 2013 04:46:11 +0000"/>
                            <attachment id="12611433" name="KAFKA-1097_2013-10-31_10:37:29.patch" size="41485" author="nehanarkhede" created="Thu, 31 Oct 2013 17:37:45 +0000"/>
                            <attachment id="12611629" name="KAFKA-1097_2013-11-01_09:55:33.patch" size="41503" author="nehanarkhede" created="Fri, 1 Nov 2013 16:55:53 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>354530</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 3 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1p4dj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>354820</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>