<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:15:45 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-7080] WindowStoreBuilder incorrectly initializes CachingWindowStore</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-7080</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;When caching is enabled on the WindowStoreBuilder, it creates a CachingWindowStore. However, it incorrectly passes storeSupplier.segments() (the number of segments) to the segmentInterval argument.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The impact is low, since any valid number of segments is also a valid segment size, but it likely results in much smaller segments than intended. For example, the segments may be sized 3ms instead of 60,000ms.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Ideally the WindowBytesStoreSupplier interface would allow suppliers to advertise their segment size instead of segment count. I plan to create a KIP to propose this.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13167209">KAFKA-7080</key>
            <summary>WindowStoreBuilder incorrectly initializes CachingWindowStore</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="vvcephei">John Roesler</assignee>
                                    <reporter username="vvcephei">John Roesler</reporter>
                        <labels>
                    </labels>
                <created>Wed, 20 Jun 2018 17:07:11 +0000</created>
                <updated>Tue, 13 Nov 2018 19:26:29 +0000</updated>
                            <resolved>Tue, 10 Jul 2018 16:56:13 +0000</resolved>
                                    <version>1.0.0</version>
                    <version>1.0.1</version>
                    <version>1.1.0</version>
                    <version>2.0.0</version>
                                    <fixVersion>2.1.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16518371" author="githubbot" created="Wed, 20 Jun 2018 17:24:57 +0000"  >&lt;p&gt;vvcephei opened a new pull request #5257: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7080&quot; title=&quot;WindowStoreBuilder incorrectly initializes CachingWindowStore&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7080&quot;&gt;&lt;del&gt;KAFKA-7080&lt;/del&gt;&lt;/a&gt;: DRAFT: fix WindowStoreBuilder&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5257&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5257&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Note, this is a DRAFT pr, pending KIP approval.&lt;/p&gt;

&lt;p&gt;   Replace `segments()` with `segmentSize()` in `WindowBytesStoreSupplier`&lt;br/&gt;
   so that `WindowStoreBuilder` may pass it to `CachingWindowStore`.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16530555" author="githubbot" created="Mon, 2 Jul 2018 23:07:41 +0000"  >&lt;p&gt;guozhangwang closed pull request #5257: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7080&quot; title=&quot;WindowStoreBuilder incorrectly initializes CachingWindowStore&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7080&quot;&gt;&lt;del&gt;KAFKA-7080&lt;/del&gt;&lt;/a&gt;: replace numSegments with segmentInterval&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5257&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5257&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/streams/src/main/java/org/apache/kafka/streams/kstream/SessionWindows.java b/streams/src/main/java/org/apache/kafka/streams/kstream/SessionWindows.java&lt;br/&gt;
index aa3dec17239..fc1fb9f5d13 100644&lt;br/&gt;
&amp;#8212; a/streams/src/main/java/org/apache/kafka/streams/kstream/SessionWindows.java&lt;br/&gt;
+++ b/streams/src/main/java/org/apache/kafka/streams/kstream/SessionWindows.java&lt;br/&gt;
@@ -66,11 +66,11 @@&lt;br/&gt;
 public final class SessionWindows {&lt;/p&gt;

&lt;p&gt;     private final long gapMs;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private long maintainDurationMs;&lt;br/&gt;
+    private final long maintainDurationMs;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private SessionWindows(final long gapMs) {&lt;br/&gt;
+    private SessionWindows(final long gapMs, final long maintainDurationMs) 
{
         this.gapMs = gapMs;
-        maintainDurationMs = Windows.DEFAULT_MAINTAIN_DURATION_MS;
+        this.maintainDurationMs = maintainDurationMs;
     }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     /**&lt;br/&gt;
@@ -85,7 +85,8 @@ public static SessionWindows with(final long inactivityGapMs) {&lt;br/&gt;
         if (inactivityGapMs &amp;lt;= 0) &lt;/p&gt;
{
             throw new IllegalArgumentException(&quot;Gap time (inactivityGapMs) cannot be zero or negative.&quot;);
         }
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;return new SessionWindows(inactivityGapMs);&lt;br/&gt;
+        final long oneDayMs = 24 * 60 * 60_000L;&lt;br/&gt;
+        return new SessionWindows(inactivityGapMs, oneDayMs);&lt;br/&gt;
     }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     /**&lt;br/&gt;
@@ -99,9 +100,8 @@ public SessionWindows until(final long durationMs) throws IllegalArgumentExcepti&lt;br/&gt;
         if (durationMs &amp;lt; gapMs) &lt;/p&gt;
{
             throw new IllegalArgumentException(&quot;Window retention time (durationMs) cannot be smaller than window gap.&quot;);
         }
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;maintainDurationMs = durationMs;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;return this;&lt;br/&gt;
+        return new SessionWindows(gapMs, durationMs);&lt;br/&gt;
     }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     /**&lt;br/&gt;
diff --git a/streams/src/main/java/org/apache/kafka/streams/kstream/Windows.java b/streams/src/main/java/org/apache/kafka/streams/kstream/Windows.java&lt;br/&gt;
index 09fdfce948d..53ead1e9b73 100644&lt;br/&gt;
&amp;#8212; a/streams/src/main/java/org/apache/kafka/streams/kstream/Windows.java&lt;br/&gt;
+++ b/streams/src/main/java/org/apache/kafka/streams/kstream/Windows.java&lt;br/&gt;
@@ -36,18 +36,10 @@&lt;br/&gt;
  */&lt;br/&gt;
 public abstract class Windows&amp;lt;W extends Window&amp;gt; {&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private static final int DEFAULT_NUM_SEGMENTS = 3;&lt;br/&gt;
+    private long maintainDurationMs = 24 * 60 * 60 * 1000L; // default: one day&lt;br/&gt;
+    @Deprecated public int segments = 3;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;static final long DEFAULT_MAINTAIN_DURATION_MS = 24 * 60 * 60 * 1000L; // one day&lt;br/&gt;
-&lt;/li&gt;
	&lt;li&gt;private long maintainDurationMs;&lt;br/&gt;
-&lt;/li&gt;
	&lt;li&gt;public int segments;&lt;br/&gt;
-&lt;/li&gt;
	&lt;li&gt;protected Windows() 
{
-        segments = DEFAULT_NUM_SEGMENTS;
-        maintainDurationMs = DEFAULT_MAINTAIN_DURATION_MS;
-    }
&lt;p&gt;+    protected Windows() {}&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Set the window maintain duration (retention time) in milliseconds.&lt;br/&gt;
@@ -76,6 +68,19 @@ public long maintainMs() 
{
         return maintainDurationMs;
     }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;+    /**&lt;br/&gt;
+     * Return the segment interval in milliseconds.&lt;br/&gt;
+     *&lt;br/&gt;
+     * @return the segment interval&lt;br/&gt;
+     */&lt;br/&gt;
+    @SuppressWarnings(&quot;deprecation&quot;) // The deprecation is on the public visibility of segments. We intend to make the field private later.&lt;br/&gt;
+    public long segmentInterval() &lt;/p&gt;
{
+        // Pinned arbitrarily to a minimum of 60 seconds. Profiling may indicate a different value is more efficient.
+        final long minimumSegmentInterval = 60_000L;
+        // Scaled to the (possibly overridden) retention period
+        return Math.max(maintainMs() / (segments - 1), minimumSegmentInterval);
+    }
&lt;p&gt;+&lt;br/&gt;
     /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Set the number of segments to be used for rolling the window store.&lt;/li&gt;
	&lt;li&gt;This function is not exposed to users but can be called by developers that extend this class.&lt;br/&gt;
@@ -83,7 +88,9 @@ public long maintainMs() {&lt;/li&gt;
	&lt;li&gt;@param segments the number of segments to be used&lt;/li&gt;
	&lt;li&gt;@return itself&lt;/li&gt;
	&lt;li&gt;@throws IllegalArgumentException if specified segments is small than 2&lt;br/&gt;
+     * @deprecated since 2.1 Override segmentInterval() instead.&lt;br/&gt;
      */&lt;br/&gt;
+    @Deprecated&lt;br/&gt;
     protected Windows&amp;lt;W&amp;gt; segments(final int segments) throws IllegalArgumentException {&lt;br/&gt;
         if (segments &amp;lt; 2) {&lt;br/&gt;
             throw new IllegalArgumentException(&quot;Number of segments must be at least 2.&quot;);&lt;br/&gt;
diff --git a/streams/src/main/java/org/apache/kafka/streams/kstream/internals/KStreamImpl.java b/streams/src/main/java/org/apache/kafka/streams/kstream/internals/KStreamImpl.java&lt;br/&gt;
index bc56a3d0350..acfdf35b96a 100644
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/streams/src/main/java/org/apache/kafka/streams/kstream/internals/KStreamImpl.java&lt;br/&gt;
+++ b/streams/src/main/java/org/apache/kafka/streams/kstream/internals/KStreamImpl.java&lt;br/&gt;
@@ -844,12 +844,17 @@ public void process(final ProcessorSupplier&amp;lt;? super K, ? super V&amp;gt; processorSuppl&lt;br/&gt;
                                                                                    final Serde&amp;lt;K&amp;gt; keySerde,&lt;br/&gt;
                                                                                    final Serde&amp;lt;V&amp;gt; valueSerde,&lt;br/&gt;
                                                                                    final String storeName) 
{
-        return Stores.windowStoreBuilder(Stores.persistentWindowStore(storeName,
-                                                                      windows.maintainMs(),
-                                                                      windows.segments,
-                                                                      windows.size(),
-                                                                      true), keySerde, valueSerde);
-
+        return Stores.windowStoreBuilder(
+            Stores.persistentWindowStore(
+                storeName,
+                windows.maintainMs(),
+                windows.size(),
+                true,
+                windows.segmentInterval()
+            ),
+            keySerde,
+            valueSerde
+        );
     }&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     private class KStreamImplJoin {&lt;br/&gt;
diff --git a/streams/src/main/java/org/apache/kafka/streams/kstream/internals/TimeWindowedKStreamImpl.java b/streams/src/main/java/org/apache/kafka/streams/kstream/internals/TimeWindowedKStreamImpl.java&lt;br/&gt;
index e545f48e16a..7d6d174be5a 100644&lt;br/&gt;
&amp;#8212; a/streams/src/main/java/org/apache/kafka/streams/kstream/internals/TimeWindowedKStreamImpl.java&lt;br/&gt;
+++ b/streams/src/main/java/org/apache/kafka/streams/kstream/internals/TimeWindowedKStreamImpl.java&lt;br/&gt;
@@ -155,11 +155,13 @@&lt;br/&gt;
     private &amp;lt;VR&amp;gt; StoreBuilder&amp;lt;WindowStore&amp;lt;K, VR&amp;gt;&amp;gt; materialize(final MaterializedInternal&amp;lt;K, VR, WindowStore&amp;lt;Bytes, byte[]&amp;gt;&amp;gt; materialized) {&lt;br/&gt;
         WindowBytesStoreSupplier supplier = (WindowBytesStoreSupplier) materialized.storeSupplier();&lt;br/&gt;
         if (supplier == null) &lt;/p&gt;
{
-            supplier = Stores.persistentWindowStore(materialized.storeName(),
-                                                    windows.maintainMs(),
-                                                    windows.segments,
-                                                    windows.size(),
-                                                    false);
+            supplier = Stores.persistentWindowStore(
+                materialized.storeName(),
+                windows.maintainMs(),
+                windows.size(),
+                false,
+                windows.segmentInterval()
+            );
         }
&lt;p&gt;         final StoreBuilder&amp;lt;WindowStore&amp;lt;K, VR&amp;gt;&amp;gt; builder = Stores.windowStoreBuilder(supplier,&lt;br/&gt;
                                                                                    materialized.keySerde(),&lt;br/&gt;
diff --git a/streams/src/main/java/org/apache/kafka/streams/state/Stores.java b/streams/src/main/java/org/apache/kafka/streams/state/Stores.java&lt;br/&gt;
index eebd59fb012..c1b81c66f37 100644&lt;br/&gt;
&amp;#8212; a/streams/src/main/java/org/apache/kafka/streams/state/Stores.java&lt;br/&gt;
+++ b/streams/src/main/java/org/apache/kafka/streams/state/Stores.java&lt;br/&gt;
@@ -79,7 +79,7 @@&lt;br/&gt;
     /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Create a persistent 
{@link KeyValueBytesStoreSupplier}.&lt;br/&gt;
      * @param name  name of the store (cannot be {@code null})&lt;br/&gt;
-     * @return  an instance of a {@link KeyValueBytesStoreSupplier}
&lt;p&gt; that can be used&lt;br/&gt;
+     * @return an instance of a &lt;/p&gt;
{@link KeyValueBytesStoreSupplier} that can be used&lt;br/&gt;
      * to build a persistent store&lt;br/&gt;
      */&lt;br/&gt;
     public static KeyValueBytesStoreSupplier persistentKeyValueStore(final String name) {&lt;br/&gt;
@@ -90,7 +90,7 @@ public static KeyValueBytesStoreSupplier persistentKeyValueStore(final String na&lt;br/&gt;
     /**&lt;br/&gt;
      * Create an in-memory {@link KeyValueBytesStoreSupplier}
&lt;p&gt;.&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;@param name  name of the store (cannot be 
{@code null})&lt;br/&gt;
-     * @return  an instance of a {@link KeyValueBytesStoreSupplier} than can be used to&lt;br/&gt;
+     * @return an instance of a {@link KeyValueBytesStoreSupplier} than can be used to&lt;br/&gt;
      * build an in-memory store&lt;br/&gt;
      */&lt;br/&gt;
     public static KeyValueBytesStoreSupplier inMemoryKeyValueStore(final String name) {&lt;br/&gt;
@@ -151,25 +151,72 @@ public String metricsScope() {&lt;br/&gt;
      * @param windowSize            size of the windows (cannot be negative)&lt;br/&gt;
      * @param retainDuplicates      whether or not to retain duplicates.&lt;br/&gt;
      * @return an instance of {@link WindowBytesStoreSupplier}&lt;br/&gt;
+     * @deprecated since 2.1 Use {@link Stores#persistentWindowStore(String, long, long, boolean, long)} instead&lt;br/&gt;
      */&lt;br/&gt;
+    @Deprecated&lt;br/&gt;
     public static WindowBytesStoreSupplier persistentWindowStore(final String name,&lt;br/&gt;
                                                                  final long retentionPeriod,&lt;br/&gt;
                                                                  final int numSegments,&lt;br/&gt;
                                                                  final long windowSize,&lt;br/&gt;
                                                                  final boolean retainDuplicates) {&lt;br/&gt;
+        if (numSegments &amp;lt; 2) {
+            throw new IllegalArgumentException(&quot;numSegments cannot must smaller than 2&quot;);
+        }&lt;br/&gt;
+&lt;br/&gt;
+        final long legacySegmentInterval = Math.max(retentionPeriod / (numSegments - 1), 60_000L);&lt;br/&gt;
+&lt;br/&gt;
+        return persistentWindowStore(&lt;br/&gt;
+            name,&lt;br/&gt;
+            retentionPeriod,&lt;br/&gt;
+            windowSize,&lt;br/&gt;
+            retainDuplicates,&lt;br/&gt;
+            legacySegmentInterval&lt;br/&gt;
+        );&lt;br/&gt;
+    }&lt;br/&gt;
+&lt;br/&gt;
+    /**&lt;br/&gt;
+     * Create a persistent {@link WindowBytesStoreSupplier}.&lt;br/&gt;
+     * @param name                  name of the store (cannot be {@code null}
&lt;p&gt;)&lt;br/&gt;
+     * @param retentionPeriod       length of time to retain data in the store (cannot be negative)&lt;br/&gt;
+     * @param windowSize            size of the windows (cannot be negative)&lt;br/&gt;
+     * @param retainDuplicates      whether or not to retain duplicates.&lt;br/&gt;
+     * @return an instance of &lt;/p&gt;
{@link WindowBytesStoreSupplier}&lt;br/&gt;
+     */&lt;br/&gt;
+    public static WindowBytesStoreSupplier persistentWindowStore(final String name,&lt;br/&gt;
+                                                                 final long retentionPeriod,&lt;br/&gt;
+                                                                 final long windowSize,&lt;br/&gt;
+                                                                 final boolean retainDuplicates) {
+        // we&apos;re arbitrarily defaulting to segments no smaller than one minute.
+        final long defaultSegmentInterval = Math.max(retentionPeriod / 2, 60_000L);
+        return persistentWindowStore(name, retentionPeriod, windowSize, retainDuplicates, defaultSegmentInterval);
+    }&lt;br/&gt;
+&lt;br/&gt;
+    /**&lt;br/&gt;
+     * Create a persistent {@link WindowBytesStoreSupplier}
&lt;p&gt;.&lt;br/&gt;
+     * @param name                  name of the store (cannot be &lt;/p&gt;
{@code null}
&lt;p&gt;)&lt;br/&gt;
+     * @param retentionPeriod       length of time to retain data in the store (cannot be negative)&lt;br/&gt;
+     * @param segmentInterval       size of segments in ms (must be at least one minute)&lt;br/&gt;
+     * @param windowSize            size of the windows (cannot be negative)&lt;br/&gt;
+     * @param retainDuplicates      whether or not to retain duplicates.&lt;br/&gt;
+     * @return an instance of &lt;/p&gt;
{@link WindowBytesStoreSupplier}
&lt;p&gt;+     */&lt;br/&gt;
+    public static WindowBytesStoreSupplier persistentWindowStore(final String name,&lt;br/&gt;
+                                                                 final long retentionPeriod,&lt;br/&gt;
+                                                                 final long windowSize,&lt;br/&gt;
+                                                                 final boolean retainDuplicates,&lt;br/&gt;
+                                                                 final long segmentInterval) {&lt;br/&gt;
         Objects.requireNonNull(name, &quot;name cannot be null&quot;);&lt;br/&gt;
         if (retentionPeriod &amp;lt; 0) &lt;/p&gt;
{
             throw new IllegalArgumentException(&quot;retentionPeriod cannot be negative&quot;);
         }&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (numSegments &amp;lt; 2) 
{
-            throw new IllegalArgumentException(&quot;numSegments cannot must smaller than 2&quot;);
-        }
&lt;p&gt;         if (windowSize &amp;lt; 0) &lt;/p&gt;
{
             throw new IllegalArgumentException(&quot;windowSize cannot be negative&quot;);
         }&lt;/li&gt;
	&lt;li&gt;final long segmentIntervalMs = Math.max(retentionPeriod / (numSegments - 1), 60_000L);&lt;br/&gt;
+        if (segmentInterval &amp;lt; 60_000) 
{
+            throw new IllegalArgumentException(&quot;segmentInterval must be at least one minute&quot;);
+        }&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;return new RocksDbWindowBytesStoreSupplier(name, retentionPeriod, segmentIntervalMs, windowSize, retainDuplicates);&lt;br/&gt;
+        return new RocksDbWindowBytesStoreSupplier(name, retentionPeriod, segmentInterval, windowSize, retainDuplicates);&lt;br/&gt;
     }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     /**&lt;br/&gt;
diff --git a/streams/src/main/java/org/apache/kafka/streams/state/WindowBytesStoreSupplier.java b/streams/src/main/java/org/apache/kafka/streams/state/WindowBytesStoreSupplier.java&lt;br/&gt;
index 9cf70c2f89c..c071b344ba3 100644&lt;br/&gt;
&amp;#8212; a/streams/src/main/java/org/apache/kafka/streams/state/WindowBytesStoreSupplier.java&lt;br/&gt;
+++ b/streams/src/main/java/org/apache/kafka/streams/state/WindowBytesStoreSupplier.java&lt;br/&gt;
@@ -33,11 +33,22 @@&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;It is also used to reduce the amount of data that is scanned when caching is enabled.&lt;br/&gt;
      *&lt;/li&gt;
	&lt;li&gt;@return number of segments&lt;br/&gt;
+     * @deprecated since 2.1. Use 
{@link WindowBytesStoreSupplier#segmentIntervalMs()}
&lt;p&gt; instead.&lt;br/&gt;
      */&lt;br/&gt;
+    @Deprecated&lt;br/&gt;
     int segments();&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     /**&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;* The size of the windows any store created from this supplier is creating.&lt;br/&gt;
+     * The size of the segments (in milliseconds) the store has.&lt;br/&gt;
+     * If your store is segmented then this should be the size of segments in the underlying store.&lt;br/&gt;
+     * It is also used to reduce the amount of data that is scanned when caching is enabled.&lt;br/&gt;
+     *&lt;br/&gt;
+     * @return size of the segments (in milliseconds)&lt;br/&gt;
+     */&lt;br/&gt;
+    long segmentIntervalMs();&lt;br/&gt;
+&lt;br/&gt;
+    /**&lt;br/&gt;
+     * The size of the windows (in milliseconds) any store created from this supplier is creating.&lt;br/&gt;
      *&lt;/li&gt;
&lt;/ul&gt;
&lt;ul&gt;
	&lt;li&gt;@return window size&lt;br/&gt;
      */&lt;br/&gt;
diff --git a/streams/src/main/java/org/apache/kafka/streams/state/internals/RocksDbSessionBytesStoreSupplier.java b/streams/src/main/java/org/apache/kafka/streams/state/internals/RocksDbSessionBytesStoreSupplier.java&lt;br/&gt;
index c83ab599f7c..55e6877923d 100644
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/streams/src/main/java/org/apache/kafka/streams/state/internals/RocksDbSessionBytesStoreSupplier.java&lt;br/&gt;
+++ b/streams/src/main/java/org/apache/kafka/streams/state/internals/RocksDbSessionBytesStoreSupplier.java&lt;br/&gt;
@@ -53,6 +53,7 @@ public String metricsScope() {&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     @Override&lt;br/&gt;
     public long segmentIntervalMs() &lt;/p&gt;
{
+        // Selected somewhat arbitrarily. Profiling may reveal a different value is preferable.
         return Math.max(retentionPeriod / 2, 60_000L);
     }
&lt;p&gt; }&lt;br/&gt;
diff --git a/streams/src/main/java/org/apache/kafka/streams/state/internals/RocksDbWindowBytesStoreSupplier.java b/streams/src/main/java/org/apache/kafka/streams/state/internals/RocksDbWindowBytesStoreSupplier.java&lt;br/&gt;
index 4a7bffc850e..0684ba677bc 100644&lt;br/&gt;
&amp;#8212; a/streams/src/main/java/org/apache/kafka/streams/state/internals/RocksDbWindowBytesStoreSupplier.java&lt;br/&gt;
+++ b/streams/src/main/java/org/apache/kafka/streams/state/internals/RocksDbWindowBytesStoreSupplier.java&lt;br/&gt;
@@ -66,11 +66,17 @@ public String metricsScope() &lt;/p&gt;
{
         return &quot;rocksdb-window&quot;;
     }

&lt;p&gt;+    @Deprecated&lt;br/&gt;
     @Override&lt;br/&gt;
     public int segments() &lt;/p&gt;
{
         return (int) (retentionPeriod / segmentInterval) + 1;
     }

&lt;p&gt;+    @Override&lt;br/&gt;
+    public long segmentIntervalMs() &lt;/p&gt;
{
+        return segmentInterval;
+    }
&lt;p&gt;+&lt;br/&gt;
     @Override&lt;br/&gt;
     public long windowSize() &lt;/p&gt;
{
         return windowSize;
diff --git a/streams/src/main/java/org/apache/kafka/streams/state/internals/WindowStoreBuilder.java b/streams/src/main/java/org/apache/kafka/streams/state/internals/WindowStoreBuilder.java
index 97b4883084c..31d063a1b28 100644
--- a/streams/src/main/java/org/apache/kafka/streams/state/internals/WindowStoreBuilder.java
+++ b/streams/src/main/java/org/apache/kafka/streams/state/internals/WindowStoreBuilder.java
@@ -52,7 +52,7 @@ public WindowStoreBuilder(final WindowBytesStoreSupplier storeSupplier,
                                         keySerde,
                                         valueSerde,
                                         storeSupplier.windowSize(),
-                                        storeSupplier.segments());
+                                        storeSupplier.segmentIntervalMs());
     }

&lt;p&gt;     private WindowStore&amp;lt;Bytes, byte[]&amp;gt; maybeWrapLogging(final WindowStore&amp;lt;Bytes, byte[]&amp;gt; inner) {&lt;br/&gt;
diff --git a/streams/src/test/java/org/apache/kafka/streams/kstream/JoinWindowsTest.java b/streams/src/test/java/org/apache/kafka/streams/kstream/JoinWindowsTest.java&lt;br/&gt;
index 0611704ee4e..7b22df10c6f 100644&lt;br/&gt;
&amp;#8212; a/streams/src/test/java/org/apache/kafka/streams/kstream/JoinWindowsTest.java&lt;br/&gt;
+++ b/streams/src/test/java/org/apache/kafka/streams/kstream/JoinWindowsTest.java&lt;br/&gt;
@@ -112,16 +112,6 @@ public void untilShouldSetMaintainDuration() &lt;/p&gt;
{
         assertEquals(windowSize, windowSpec.until(windowSize).maintainMs());
     }

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;@Test&lt;/li&gt;
	&lt;li&gt;public void shouldUseWindowSizeForMaintainDurationWhenSizeLargerThanDefaultMaintainMs() 
{
-        final long size = Windows.DEFAULT_MAINTAIN_DURATION_MS;
-
-        final JoinWindows windowSpec = JoinWindows.of(size);
-        final long windowSize = windowSpec.size();
-
-        assertEquals(windowSize, windowSpec.maintainMs());
-    }
&lt;p&gt;-&lt;br/&gt;
     @Test&lt;br/&gt;
     public void retentionTimeMustNoBeSmallerThanWindowSize() {&lt;br/&gt;
         final JoinWindows windowSpec = JoinWindows.of(anySize);&lt;br/&gt;
diff --git a/streams/src/test/java/org/apache/kafka/streams/kstream/SessionWindowsTest.java b/streams/src/test/java/org/apache/kafka/streams/kstream/SessionWindowsTest.java&lt;br/&gt;
index 8c0a0b99684..d0e5996a481 100644&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/streams/src/test/java/org/apache/kafka/streams/kstream/SessionWindowsTest.java&lt;br/&gt;
+++ b/streams/src/test/java/org/apache/kafka/streams/kstream/SessionWindowsTest.java&lt;br/&gt;
@@ -50,7 +50,7 @@ public void windowSizeMustNotBeZero() {&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     @Test&lt;br/&gt;
     public void retentionTimeShouldBeGapIfGapIsLargerThanDefaultRetentionTime() &lt;/p&gt;
{
-        final long windowGap = 2 * Windows.DEFAULT_MAINTAIN_DURATION_MS;
+        final long windowGap = 2 * SessionWindows.with(1).maintainMs();
         assertEquals(windowGap, SessionWindows.with(windowGap).maintainMs());
     }

&lt;p&gt;diff --git a/streams/src/test/java/org/apache/kafka/streams/kstream/TimeWindowsTest.java b/streams/src/test/java/org/apache/kafka/streams/kstream/TimeWindowsTest.java&lt;br/&gt;
index 7e6bb3e5580..390678f33b0 100644&lt;br/&gt;
&amp;#8212; a/streams/src/test/java/org/apache/kafka/streams/kstream/TimeWindowsTest.java&lt;br/&gt;
+++ b/streams/src/test/java/org/apache/kafka/streams/kstream/TimeWindowsTest.java&lt;br/&gt;
@@ -47,7 +47,7 @@ public void shouldSetWindowRetentionTime() {&lt;/p&gt;

&lt;p&gt;     @Test&lt;br/&gt;
     public void shouldUseWindowSizeAsRentitionTimeIfWindowSizeIsLargerThanDefaultRetentionTime() &lt;/p&gt;
{
-        final long windowSize = 2 * Windows.DEFAULT_MAINTAIN_DURATION_MS;
+        final long windowSize = 2 * TimeWindows.of(1).maintainMs();
         assertEquals(windowSize, TimeWindows.of(windowSize).maintainMs());
     }

&lt;p&gt;diff --git a/streams/src/test/java/org/apache/kafka/streams/kstream/WindowsTest.java b/streams/src/test/java/org/apache/kafka/streams/kstream/WindowsTest.java&lt;br/&gt;
index 77faf1a1fe8..2e9246e046c 100644&lt;br/&gt;
&amp;#8212; a/streams/src/test/java/org/apache/kafka/streams/kstream/WindowsTest.java&lt;br/&gt;
+++ b/streams/src/test/java/org/apache/kafka/streams/kstream/WindowsTest.java&lt;br/&gt;
@@ -40,7 +40,13 @@ public long size() {&lt;br/&gt;
     @Test&lt;br/&gt;
     public void shouldSetNumberOfSegments() &lt;/p&gt;
{
         final int anySegmentSizeLargerThanOne = 5;
-        assertEquals(anySegmentSizeLargerThanOne, new TestWindows().segments(anySegmentSizeLargerThanOne).segments);
+        final TestWindows testWindow = new TestWindows();
+        final long maintainMs = testWindow.maintainMs();
+
+        assertEquals(
+            maintainMs / (anySegmentSizeLargerThanOne - 1),
+            testWindow.segments(anySegmentSizeLargerThanOne).segmentInterval()
+        );
     }

&lt;p&gt;     @Test&lt;br/&gt;
diff --git a/streams/src/test/java/org/apache/kafka/streams/perf/SimpleBenchmark.java b/streams/src/test/java/org/apache/kafka/streams/perf/SimpleBenchmark.java&lt;br/&gt;
index 7179293200e..654fd03f10a 100644&lt;br/&gt;
&amp;#8212; a/streams/src/test/java/org/apache/kafka/streams/perf/SimpleBenchmark.java&lt;br/&gt;
+++ b/streams/src/test/java/org/apache/kafka/streams/perf/SimpleBenchmark.java&lt;br/&gt;
@@ -32,10 +32,10 @@&lt;br/&gt;
 import org.apache.kafka.common.serialization.Serde;&lt;br/&gt;
 import org.apache.kafka.common.serialization.Serdes;&lt;br/&gt;
 import org.apache.kafka.common.utils.Utils;&lt;br/&gt;
-import org.apache.kafka.streams.kstream.Consumed;&lt;br/&gt;
 import org.apache.kafka.streams.KafkaStreams;&lt;br/&gt;
 import org.apache.kafka.streams.StreamsBuilder;&lt;br/&gt;
 import org.apache.kafka.streams.StreamsConfig;&lt;br/&gt;
+import org.apache.kafka.streams.kstream.Consumed;&lt;br/&gt;
 import org.apache.kafka.streams.kstream.ForeachAction;&lt;br/&gt;
 import org.apache.kafka.streams.kstream.JoinWindows;&lt;br/&gt;
 import org.apache.kafka.streams.kstream.KStream;&lt;br/&gt;
@@ -469,13 +469,18 @@ private void processStreamWithWindowStore(final String topic) {&lt;br/&gt;
         setStreamProperties(&quot;simple-benchmark-streams-with-store&quot;);&lt;/p&gt;

&lt;p&gt;         final StreamsBuilder builder = new StreamsBuilder();&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final StoreBuilder&amp;lt;WindowStore&amp;lt;Integer, byte[]&amp;gt;&amp;gt; storeBuilder&lt;/li&gt;
	&lt;li&gt;= Stores.windowStoreBuilder(Stores.persistentWindowStore(&quot;store&quot;,&lt;br/&gt;
+&lt;br/&gt;
+        final StoreBuilder&amp;lt;WindowStore&amp;lt;Integer, byte[]&amp;gt;&amp;gt; storeBuilder = Stores.windowStoreBuilder(&lt;br/&gt;
+            Stores.persistentWindowStore(&lt;br/&gt;
+                &quot;store&quot;,&lt;br/&gt;
                 AGGREGATE_WINDOW_SIZE * 3,&lt;/li&gt;
	&lt;li&gt;3,&lt;br/&gt;
                 AGGREGATE_WINDOW_SIZE,&lt;/li&gt;
	&lt;li&gt;false),&lt;/li&gt;
	&lt;li&gt;INTEGER_SERDE, BYTE_SERDE);&lt;br/&gt;
+                false,&lt;br/&gt;
+                60_000L&lt;br/&gt;
+            ),&lt;br/&gt;
+            INTEGER_SERDE,&lt;br/&gt;
+            BYTE_SERDE&lt;br/&gt;
+        );&lt;br/&gt;
         builder.addStateStore(storeBuilder.withCachingEnabled());&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         final KStream&amp;lt;Integer, byte[]&amp;gt; source = builder.stream(topic);&lt;br/&gt;
diff --git a/streams/src/test/java/org/apache/kafka/streams/processor/internals/InternalTopologyBuilderTest.java b/streams/src/test/java/org/apache/kafka/streams/processor/internals/InternalTopologyBuilderTest.java&lt;br/&gt;
index b0674ea338a..fb641302560 100644&lt;br/&gt;
&amp;#8212; a/streams/src/test/java/org/apache/kafka/streams/processor/internals/InternalTopologyBuilderTest.java&lt;br/&gt;
+++ b/streams/src/test/java/org/apache/kafka/streams/processor/internals/InternalTopologyBuilderTest.java&lt;br/&gt;
@@ -532,7 +532,15 @@ public void shouldAddInternalTopicConfigForWindowStores() {&lt;br/&gt;
         builder.setApplicationId(&quot;appId&quot;);&lt;br/&gt;
         builder.addSource(null, &quot;source&quot;, null, null, null, &quot;topic&quot;);&lt;br/&gt;
         builder.addProcessor(&quot;processor&quot;, new MockProcessorSupplier(), &quot;source&quot;);&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;builder.addStateStore(Stores.windowStoreBuilder(Stores.persistentWindowStore(&quot;store&quot;, 30000, 3, 10000, false), Serdes.String(), Serdes.String()), &quot;processor&quot;);&lt;br/&gt;
+&lt;br/&gt;
+        builder.addStateStore(&lt;br/&gt;
+            Stores.windowStoreBuilder(&lt;br/&gt;
+                Stores.persistentWindowStore(&quot;store&quot;, 30_000L, 10_000L, false),&lt;br/&gt;
+                Serdes.String(),&lt;br/&gt;
+                Serdes.String()&lt;br/&gt;
+            ),&lt;br/&gt;
+            &quot;processor&quot;&lt;br/&gt;
+        );&lt;br/&gt;
         final Map&amp;lt;Integer, InternalTopologyBuilder.TopicsInfo&amp;gt; topicGroups = builder.topicGroups();&lt;br/&gt;
         final InternalTopologyBuilder.TopicsInfo topicsInfo = topicGroups.values().iterator().next();&lt;br/&gt;
         final InternalTopicConfig topicConfig = topicsInfo.stateChangelogTopics.get(&quot;appId-store-changelog&quot;);&lt;br/&gt;
diff --git a/streams/src/test/java/org/apache/kafka/streams/state/StoresTest.java b/streams/src/test/java/org/apache/kafka/streams/state/StoresTest.java&lt;br/&gt;
index 5383c27ac43..23f246d001e 100644
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/streams/src/test/java/org/apache/kafka/streams/state/StoresTest.java&lt;br/&gt;
+++ b/streams/src/test/java/org/apache/kafka/streams/state/StoresTest.java&lt;br/&gt;
@@ -28,7 +28,6 @@&lt;br/&gt;
 import static org.hamcrest.MatcherAssert.assertThat;&lt;br/&gt;
 import static org.hamcrest.core.IsInstanceOf.instanceOf;&lt;br/&gt;
 import static org.hamcrest.core.IsNot.not;&lt;br/&gt;
-import static org.junit.Assert.fail;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; public class StoresTest {&lt;/p&gt;

&lt;p&gt;@@ -54,22 +53,28 @@ public void shouldThrowIfILruMapStoreCapacityIsNegative() {&lt;/p&gt;

&lt;p&gt;     @Test(expected = NullPointerException.class)&lt;br/&gt;
     public void shouldThrowIfIPersistentWindowStoreStoreNameIsNull() &lt;/p&gt;
{
-        Stores.persistentWindowStore(null, 0, 1, 0, false);
+        Stores.persistentWindowStore(null, 0L, 0L, false, 60_000L);
     }

&lt;p&gt;     @Test(expected = IllegalArgumentException.class)&lt;br/&gt;
     public void shouldThrowIfIPersistentWindowStoreRetentionPeriodIsNegative() &lt;/p&gt;
{
-        Stores.persistentWindowStore(&quot;anyName&quot;, -1, 1, 0, false);
+        Stores.persistentWindowStore(&quot;anyName&quot;, -1L, 0L, false, 60_000L);
     }

&lt;p&gt;+    @Deprecated&lt;br/&gt;
     @Test(expected = IllegalArgumentException.class)&lt;br/&gt;
     public void shouldThrowIfIPersistentWindowStoreIfNumberOfSegmentsSmallerThanOne() &lt;/p&gt;
{
-        Stores.persistentWindowStore(&quot;anyName&quot;, 0, 0, 0, false);
+        Stores.persistentWindowStore(&quot;anyName&quot;, 0L, 1, 0L, false);
     }

&lt;p&gt;     @Test(expected = IllegalArgumentException.class)&lt;br/&gt;
     public void shouldThrowIfIPersistentWindowStoreIfWindowSizeIsNegative() &lt;/p&gt;
{
-        Stores.persistentWindowStore(&quot;anyName&quot;, 0, 1, -1, false);
+        Stores.persistentWindowStore(&quot;anyName&quot;, 0L, -1L, false);
+    }
&lt;p&gt;+&lt;br/&gt;
+    @Test(expected = IllegalArgumentException.class)&lt;br/&gt;
+    public void shouldThrowIfIPersistentWindowStoreIfSegmentIntervalIsTooSmall() &lt;/p&gt;
{
+        Stores.persistentWindowStore(&quot;anyName&quot;, 1L, 1L, false, 59_999L);
     }

&lt;p&gt;     @Test(expected = NullPointerException.class)&lt;br/&gt;
@@ -97,16 +102,6 @@ public void shouldThrowIfSupplierIsNullForSessionStoreBuilder() &lt;/p&gt;
{
         Stores.sessionStoreBuilder(null, Serdes.ByteArray(), Serdes.ByteArray());
     }

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;@Test&lt;/li&gt;
	&lt;li&gt;public void shouldThrowIllegalArgumentExceptionWhenTryingToConstructWindowStoreWithLessThanTwoSegments() {&lt;/li&gt;
	&lt;li&gt;try 
{
-            Stores.persistentWindowStore(&quot;store&quot;, 1, 1, 1, false);
-            fail(&quot;Should have thrown illegal argument exception as number of segments is less than 2&quot;);
-        }
&lt;p&gt; catch (final IllegalArgumentException e) &lt;/p&gt;
{
-         // ok
-        }&lt;/li&gt;
	&lt;li&gt;}&lt;br/&gt;
-&lt;br/&gt;
     @Test&lt;br/&gt;
     public void shouldCreateInMemoryKeyValueStore() {&lt;br/&gt;
         assertThat(Stores.inMemoryKeyValueStore(&quot;memory&quot;).get(), instanceOf(InMemoryKeyValueStore.class));&lt;br/&gt;
@@ -124,7 +119,7 @@ public void shouldCreateRocksDbStore() {&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     @Test&lt;br/&gt;
     public void shouldCreateRocksDbWindowStore() &lt;/p&gt;
{
-        assertThat(Stores.persistentWindowStore(&quot;store&quot;, 1, 3, 1, false).get(), instanceOf(RocksDBWindowStore.class));
+        assertThat(Stores.persistentWindowStore(&quot;store&quot;, 1L, 1L, false).get(), instanceOf(RocksDBWindowStore.class));
     }

&lt;p&gt;     @Test&lt;br/&gt;
@@ -134,7 +129,7 @@ public void shouldCreateRocksDbSessionStore() {&lt;/p&gt;

&lt;p&gt;     @Test&lt;br/&gt;
     public void shouldBuildWindowStore() {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final WindowStore&amp;lt;String, String&amp;gt; store = Stores.windowStoreBuilder(Stores.persistentWindowStore(&quot;store&quot;, 3, 2, 3, true),&lt;br/&gt;
+        final WindowStore&amp;lt;String, String&amp;gt; store = Stores.windowStoreBuilder(Stores.persistentWindowStore(&quot;store&quot;, 3L, 3L, true),&lt;br/&gt;
                                                                       Serdes.String(),&lt;br/&gt;
                                                                       Serdes.String()).build();&lt;br/&gt;
         assertThat(store, not(nullValue()));&lt;br/&gt;
diff --git a/streams/src/test/java/org/apache/kafka/streams/state/internals/RocksDBSegmentedBytesStoreTest.java b/streams/src/test/java/org/apache/kafka/streams/state/internals/RocksDBSegmentedBytesStoreTest.java&lt;br/&gt;
index d7a72833765..6b9e7a808ae 100644
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/streams/src/test/java/org/apache/kafka/streams/state/internals/RocksDBSegmentedBytesStoreTest.java&lt;br/&gt;
+++ b/streams/src/test/java/org/apache/kafka/streams/state/internals/RocksDBSegmentedBytesStoreTest.java&lt;br/&gt;
@@ -244,7 +244,7 @@ public void shouldLoadSegementsWithOldStyleDateFormattedName() {&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         bytesStore = new RocksDBSegmentedBytesStore(storeName,&lt;br/&gt;
                 retention,&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;numSegments,&lt;br/&gt;
+                segmentInterval,&lt;br/&gt;
                 schema);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         bytesStore.init(context, bytesStore);&lt;br/&gt;
@@ -271,7 +271,7 @@ public void shouldLoadSegementsWithOldStyleColonFormattedName() {&lt;/p&gt;

&lt;p&gt;         bytesStore = new RocksDBSegmentedBytesStore(storeName,&lt;br/&gt;
                 retention,&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;numSegments,&lt;br/&gt;
+                segmentInterval,&lt;br/&gt;
                 schema);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         bytesStore.init(context, bytesStore);&lt;br/&gt;
diff --git a/streams/src/test/java/org/apache/kafka/streams/state/internals/RocksDBSessionStoreTest.java b/streams/src/test/java/org/apache/kafka/streams/state/internals/RocksDBSessionStoreTest.java&lt;br/&gt;
index c95cbbada98..b44d3691b99 100644&lt;br/&gt;
&amp;#8212; a/streams/src/test/java/org/apache/kafka/streams/state/internals/RocksDBSessionStoreTest.java&lt;br/&gt;
+++ b/streams/src/test/java/org/apache/kafka/streams/state/internals/RocksDBSessionStoreTest.java&lt;br/&gt;
@@ -53,7 +53,7 @@ public void before() {&lt;br/&gt;
         schema.init(&quot;topic&quot;);&lt;/p&gt;

&lt;p&gt;         final RocksDBSegmentedBytesStore bytesStore =&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;new RocksDBSegmentedBytesStore(&quot;session-store&quot;, 10000L, 3, schema);&lt;br/&gt;
+                new RocksDBSegmentedBytesStore(&quot;session-store&quot;, 10_000L, 60_000L, schema);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         sessionStore = new RocksDBSessionStore&amp;lt;&amp;gt;(bytesStore,&lt;br/&gt;
                                                  Serdes.String(),&lt;br/&gt;
diff --git a/streams/src/test/java/org/apache/kafka/streams/state/internals/RocksDBWindowStoreTest.java b/streams/src/test/java/org/apache/kafka/streams/state/internals/RocksDBWindowStoreTest.java&lt;br/&gt;
index 2a84a7b12e9..ac481a747ba 100644&lt;br/&gt;
&amp;#8212; a/streams/src/test/java/org/apache/kafka/streams/state/internals/RocksDBWindowStoreTest.java&lt;br/&gt;
+++ b/streams/src/test/java/org/apache/kafka/streams/state/internals/RocksDBWindowStoreTest.java&lt;br/&gt;
@@ -69,9 +69,9 @@&lt;br/&gt;
     private final int numSegments = 3;&lt;br/&gt;
     private final long windowSize = 3L;&lt;br/&gt;
     private final String windowName = &quot;window&quot;;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private final long segmentSize = 60_000;&lt;/li&gt;
	&lt;li&gt;private final long retentionPeriod = segmentSize * (numSegments - 1);&lt;/li&gt;
	&lt;li&gt;private final Segments segments = new Segments(windowName, retentionPeriod, segmentSize);&lt;br/&gt;
+    private final long segmentInterval = 60_000;&lt;br/&gt;
+    private final long retentionPeriod = segmentInterval * (numSegments - 1);&lt;br/&gt;
+    private final Segments segments = new Segments(windowName, retentionPeriod, segmentInterval);&lt;br/&gt;
     private final StateSerdes&amp;lt;Integer, String&amp;gt; serdes = new StateSerdes&amp;lt;&amp;gt;(&quot;&quot;, Serdes.Integer(), Serdes.String());&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     private final List&amp;lt;KeyValue&amp;lt;byte[], byte[]&amp;gt;&amp;gt; changeLog = new ArrayList&amp;lt;&amp;gt;();&lt;br/&gt;
@@ -107,12 +107,7 @@&lt;/p&gt;

&lt;p&gt;     private WindowStore&amp;lt;Integer, String&amp;gt; createWindowStore(final ProcessorContext context, final boolean retainDuplicates) {&lt;br/&gt;
         final WindowStore&amp;lt;Integer, String&amp;gt; store = Stores.windowStoreBuilder(&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Stores.persistentWindowStore(&lt;/li&gt;
	&lt;li&gt;windowName,&lt;/li&gt;
	&lt;li&gt;retentionPeriod,&lt;/li&gt;
	&lt;li&gt;numSegments,&lt;/li&gt;
	&lt;li&gt;windowSize,&lt;/li&gt;
	&lt;li&gt;retainDuplicates),&lt;br/&gt;
+            Stores.persistentWindowStore(windowName, retentionPeriod, windowSize, retainDuplicates, segmentInterval),&lt;br/&gt;
             Serdes.Integer(),&lt;br/&gt;
             Serdes.String()).build();&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;@@ -134,10 +129,10 @@ public void shouldOnlyIterateOpenSegments() {&lt;br/&gt;
         setCurrentTime(currentTime);&lt;br/&gt;
         windowStore.put(1, &quot;one&quot;);&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;currentTime = currentTime + segmentSize;&lt;br/&gt;
+        currentTime = currentTime + segmentInterval;&lt;br/&gt;
         setCurrentTime(currentTime);&lt;br/&gt;
         windowStore.put(1, &quot;two&quot;);&lt;/li&gt;
	&lt;li&gt;currentTime = currentTime + segmentSize;&lt;br/&gt;
+        currentTime = currentTime + segmentInterval;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         setCurrentTime(currentTime);&lt;br/&gt;
         windowStore.put(1, &quot;three&quot;);&lt;br/&gt;
@@ -145,7 +140,7 @@ public void shouldOnlyIterateOpenSegments() {&lt;br/&gt;
         final WindowStoreIterator&amp;lt;String&amp;gt; iterator = windowStore.fetch(1, 0, currentTime);&lt;/p&gt;

&lt;p&gt;         // roll to the next segment that will close the first&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;currentTime = currentTime + segmentSize;&lt;br/&gt;
+        currentTime = currentTime + segmentInterval;&lt;br/&gt;
         setCurrentTime(currentTime);&lt;br/&gt;
         windowStore.put(1, &quot;four&quot;);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;@@ -167,7 +162,7 @@ private ProcessorRecordContext createRecordContext(final long time) {&lt;br/&gt;
     @Test&lt;br/&gt;
     public void testRangeAndSinglePointFetch() {&lt;br/&gt;
         windowStore = createWindowStore(context, false);&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final long startTime = segmentSize - 4L;&lt;br/&gt;
+        final long startTime = segmentInterval - 4L;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         putFirstBatch(windowStore, startTime, context);&lt;/p&gt;

&lt;p&gt;@@ -226,7 +221,7 @@ public void testRangeAndSinglePointFetch() {&lt;br/&gt;
     @Test&lt;br/&gt;
     public void shouldGetAll() {&lt;br/&gt;
         windowStore = createWindowStore(context, false);&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final long startTime = segmentSize - 4L;&lt;br/&gt;
+        final long startTime = segmentInterval - 4L;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         putFirstBatch(windowStore, startTime, context);&lt;/p&gt;

&lt;p&gt;@@ -245,7 +240,7 @@ public void shouldGetAll() {&lt;br/&gt;
     @Test&lt;br/&gt;
     public void shouldFetchAllInTimeRange() {&lt;br/&gt;
         windowStore = createWindowStore(context, false);&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final long startTime = segmentSize - 4L;&lt;br/&gt;
+        final long startTime = segmentInterval - 4L;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         putFirstBatch(windowStore, startTime, context);&lt;/p&gt;

&lt;p&gt;@@ -274,7 +269,7 @@ public void shouldFetchAllInTimeRange() {&lt;br/&gt;
     @Test&lt;br/&gt;
     public void testFetchRange() {&lt;br/&gt;
         windowStore = createWindowStore(context, false);&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final long startTime = segmentSize - 4L;&lt;br/&gt;
+        final long startTime = segmentInterval - 4L;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         putFirstBatch(windowStore, startTime, context);&lt;/p&gt;

&lt;p&gt;@@ -322,7 +317,7 @@ public void testFetchRange() {&lt;br/&gt;
     @Test&lt;br/&gt;
     public void testPutAndFetchBefore() {&lt;br/&gt;
         windowStore = createWindowStore(context, false);&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final long startTime = segmentSize - 4L;&lt;br/&gt;
+        final long startTime = segmentInterval - 4L;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         putFirstBatch(windowStore, startTime, context);&lt;/p&gt;

&lt;p&gt;@@ -368,7 +363,7 @@ public void testPutAndFetchBefore() {&lt;br/&gt;
     @Test&lt;br/&gt;
     public void testPutAndFetchAfter() {&lt;br/&gt;
         windowStore = createWindowStore(context, false);&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final long startTime = segmentSize - 4L;&lt;br/&gt;
+        final long startTime = segmentInterval - 4L;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         putFirstBatch(windowStore, startTime, context);&lt;/p&gt;

&lt;p&gt;@@ -414,7 +409,7 @@ public void testPutAndFetchAfter() {&lt;br/&gt;
     @Test&lt;br/&gt;
     public void testPutSameKeyTimestamp() {&lt;br/&gt;
         windowStore = createWindowStore(context, true);&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final long startTime = segmentSize - 4L;&lt;br/&gt;
+        final long startTime = segmentInterval - 4L;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         setCurrentTime(startTime);&lt;br/&gt;
         windowStore.put(0, &quot;zero&quot;);&lt;br/&gt;
@@ -444,8 +439,8 @@ public void testRolling() {&lt;br/&gt;
         windowStore = createWindowStore(context, false);&lt;/p&gt;

&lt;p&gt;         // to validate segments&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final long startTime = segmentSize * 2;&lt;/li&gt;
	&lt;li&gt;final long increment = segmentSize / 2;&lt;br/&gt;
+        final long startTime = segmentInterval * 2;&lt;br/&gt;
+        final long increment = segmentInterval / 2;&lt;br/&gt;
         setCurrentTime(startTime);&lt;br/&gt;
         windowStore.put(0, &quot;zero&quot;);&lt;br/&gt;
         assertEquals(Utils.mkSet(segments.segmentName(2)), segmentDirs(baseDir));&lt;br/&gt;
@@ -573,8 +568,8 @@ public void testRolling() {&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     @Test&lt;br/&gt;
     public void testRestore() throws IOException {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final long startTime = segmentSize * 2;&lt;/li&gt;
	&lt;li&gt;final long increment = segmentSize / 2;&lt;br/&gt;
+        final long startTime = segmentInterval * 2;&lt;br/&gt;
+        final long increment = segmentInterval / 2;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         windowStore = createWindowStore(context, false);&lt;br/&gt;
         setCurrentTime(startTime);&lt;br/&gt;
@@ -725,7 +720,7 @@ public void testInitialLoading() {&lt;br/&gt;
         new File(storeDir, segments.segmentName(6L)).mkdir();&lt;br/&gt;
         windowStore.close();&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;context.setStreamTime(segmentSize * 6L);&lt;br/&gt;
+        context.setStreamTime(segmentInterval * 6L);&lt;br/&gt;
         windowStore = createWindowStore(context, false);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         final List&amp;lt;String&amp;gt; expected = Utils.mkList(segments.segmentName(4L), segments.segmentName(5L), segments.segmentName(6L));&lt;br/&gt;
@@ -768,13 +763,9 @@ public void shouldCloseOpenIteratorsWhenStoreIsClosedAndNotThrowInvalidStateStor&lt;br/&gt;
     public void shouldFetchAndIterateOverExactKeys() {&lt;br/&gt;
         final long windowSize = 0x7a00000000000000L;&lt;br/&gt;
         final long retentionPeriod = 0x7a00000000000000L;&lt;br/&gt;
+&lt;br/&gt;
         final WindowStore&amp;lt;String, String&amp;gt; windowStore = Stores.windowStoreBuilder(&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Stores.persistentWindowStore(&lt;/li&gt;
	&lt;li&gt;windowName,&lt;/li&gt;
	&lt;li&gt;retentionPeriod,&lt;/li&gt;
	&lt;li&gt;2,&lt;/li&gt;
	&lt;li&gt;windowSize,&lt;/li&gt;
	&lt;li&gt;true),&lt;br/&gt;
+            Stores.persistentWindowStore(windowName, retentionPeriod, windowSize, true),&lt;br/&gt;
             Serdes.String(),&lt;br/&gt;
             Serdes.String()).build();&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;@@ -837,7 +828,7 @@ public void shouldThrowNullPointerExceptionOnRangeNullToKey() {&lt;br/&gt;
     @Test&lt;br/&gt;
     public void shouldNoNullPointerWhenSerdeDoesNotHandleNull() {&lt;br/&gt;
         windowStore = new RocksDBWindowStore&amp;lt;&amp;gt;(&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;new RocksDBSegmentedBytesStore(windowName, retentionPeriod, numSegments, new WindowKeySchema()),&lt;br/&gt;
+            new RocksDBSegmentedBytesStore(windowName, retentionPeriod, segmentInterval, new WindowKeySchema()),&lt;br/&gt;
             Serdes.Integer(),&lt;br/&gt;
             new SerdeThatDoesntHandleNull(),&lt;br/&gt;
             false,&lt;br/&gt;
@@ -850,12 +841,7 @@ public void shouldNoNullPointerWhenSerdeDoesNotHandleNull() {&lt;br/&gt;
     @Test&lt;br/&gt;
     public void shouldFetchAndIterateOverExactBinaryKeys() {&lt;br/&gt;
         final WindowStore&amp;lt;Bytes, String&amp;gt; windowStore = Stores.windowStoreBuilder(&lt;/li&gt;
	&lt;li&gt;Stores.persistentWindowStore(&lt;/li&gt;
	&lt;li&gt;windowName,&lt;/li&gt;
	&lt;li&gt;60000,&lt;/li&gt;
	&lt;li&gt;2,&lt;/li&gt;
	&lt;li&gt;60000,&lt;/li&gt;
	&lt;li&gt;true),&lt;br/&gt;
+            Stores.persistentWindowStore(windowName, 60_000L, 60_000L, true),&lt;br/&gt;
             Serdes.Bytes(),&lt;br/&gt;
             Serdes.String()).build();&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;diff --git a/streams/src/test/java/org/apache/kafka/streams/state/internals/StreamThreadStateStoreProviderTest.java b/streams/src/test/java/org/apache/kafka/streams/state/internals/StreamThreadStateStoreProviderTest.java&lt;br/&gt;
index 66ea3c42779..4916cb09991 100644&lt;br/&gt;
&amp;#8212; a/streams/src/test/java/org/apache/kafka/streams/state/internals/StreamThreadStateStoreProviderTest.java&lt;br/&gt;
+++ b/streams/src/test/java/org/apache/kafka/streams/state/internals/StreamThreadStateStoreProviderTest.java&lt;br/&gt;
@@ -76,7 +76,13 @@ public void before() {&lt;br/&gt;
         topology.addSource(&quot;the-source&quot;, topicName);&lt;br/&gt;
         topology.addProcessor(&quot;the-processor&quot;, new MockProcessorSupplier(), &quot;the-source&quot;);&lt;br/&gt;
         topology.addStateStore(Stores.keyValueStoreBuilder(Stores.inMemoryKeyValueStore(&quot;kv-store&quot;), Serdes.String(), Serdes.String()), &quot;the-processor&quot;);&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;topology.addStateStore(Stores.windowStoreBuilder(Stores.persistentWindowStore(&quot;window-store&quot;, 10, 2, 2, false), Serdes.String(), Serdes.String()), &quot;the-processor&quot;);&lt;br/&gt;
+        topology.addStateStore(&lt;br/&gt;
+            Stores.windowStoreBuilder(&lt;br/&gt;
+                Stores.persistentWindowStore(&quot;window-store&quot;, 10L, 2L, false),&lt;br/&gt;
+                Serdes.String(),&lt;br/&gt;
+                Serdes.String()),&lt;br/&gt;
+            &quot;the-processor&quot;&lt;br/&gt;
+        );&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         final Properties properties = new Properties();&lt;br/&gt;
         final String applicationId = &quot;applicationId&quot;;&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16538944" author="vvcephei" created="Tue, 10 Jul 2018 16:56:13 +0000"  >&lt;p&gt;Fixed in&#160;&lt;a href=&quot;https://github.com/apache/kafka/pull/5257&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5257&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16572260" author="githubbot" created="Tue, 7 Aug 2018 20:14:37 +0000"  >&lt;p&gt;vvcephei opened a new pull request #5474: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7080&quot; title=&quot;WindowStoreBuilder incorrectly initializes CachingWindowStore&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7080&quot;&gt;&lt;del&gt;KAFKA-7080&lt;/del&gt;&lt;/a&gt;: pass segmentInterval to CachingWindowStore&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5474&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5474&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   WindowStoreBuilder incorrectly passes the number of segments instead of the segment interval.&lt;/p&gt;

&lt;p&gt;   In trunk, we made a larger change to fix this, but for backporting we simply compute the segment interval to pass.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16573867" author="githubbot" created="Wed, 8 Aug 2018 21:00:44 +0000"  >&lt;p&gt;guozhangwang closed pull request #5474: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7080&quot; title=&quot;WindowStoreBuilder incorrectly initializes CachingWindowStore&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7080&quot;&gt;&lt;del&gt;KAFKA-7080&lt;/del&gt;&lt;/a&gt;: pass segmentInterval to CachingWindowStore&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5474&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5474&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/streams/src/main/java/org/apache/kafka/streams/state/internals/WindowStoreBuilder.java b/streams/src/main/java/org/apache/kafka/streams/state/internals/WindowStoreBuilder.java&lt;br/&gt;
index 97b4883084c..cd0841a0bf7 100644&lt;br/&gt;
&amp;#8212; a/streams/src/main/java/org/apache/kafka/streams/state/internals/WindowStoreBuilder.java&lt;br/&gt;
+++ b/streams/src/main/java/org/apache/kafka/streams/state/internals/WindowStoreBuilder.java&lt;br/&gt;
@@ -52,7 +52,7 @@ public WindowStoreBuilder(final WindowBytesStoreSupplier storeSupplier,&lt;br/&gt;
                                         keySerde,&lt;br/&gt;
                                         valueSerde,&lt;br/&gt;
                                         storeSupplier.windowSize(),&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;storeSupplier.segments());&lt;br/&gt;
+                                        Segments.segmentInterval(storeSupplier.retentionPeriod(), storeSupplier.segments()));&lt;br/&gt;
     }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     private WindowStore&amp;lt;Bytes, byte[]&amp;gt; maybeWrapLogging(final WindowStore&amp;lt;Bytes, byte[]&amp;gt; inner) {&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16651008" author="githubbot" created="Tue, 16 Oct 2018 00:55:55 +0000"  >&lt;p&gt;mjsax opened a new pull request #5804: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7080&quot; title=&quot;WindowStoreBuilder incorrectly initializes CachingWindowStore&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7080&quot;&gt;&lt;del&gt;KAFKA-7080&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7222&quot; title=&quot;KIP-328: Add Window Grace Period (and deprecate Window Retention)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7222&quot;&gt;&lt;del&gt;KAFKA-7222&lt;/del&gt;&lt;/a&gt;: Cleanup overlapping KIP changes&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5804&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5804&lt;/a&gt;&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;KIP-319 and KIP-328 overlap and we can remove non-released deprecates methods&lt;/li&gt;
	&lt;li&gt;add upgrade docs for KIP-319&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16651087" author="githubbot" created="Tue, 16 Oct 2018 03:56:32 +0000"  >&lt;p&gt;mjsax closed pull request #5804: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7080&quot; title=&quot;WindowStoreBuilder incorrectly initializes CachingWindowStore&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7080&quot;&gt;&lt;del&gt;KAFKA-7080&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7222&quot; title=&quot;KIP-328: Add Window Grace Period (and deprecate Window Retention)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7222&quot;&gt;&lt;del&gt;KAFKA-7222&lt;/del&gt;&lt;/a&gt;: Cleanup overlapping KIP changes&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5804&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5804&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/docs/streams/upgrade-guide.html b/docs/streams/upgrade-guide.html&lt;br/&gt;
index b26f3c339cf..c0f28efe98b 100644&lt;br/&gt;
&amp;#8212; a/docs/streams/upgrade-guide.html&lt;br/&gt;
+++ b/docs/streams/upgrade-guide.html&lt;br/&gt;
@@ -134,6 +134,18 @@ &amp;lt;h3&amp;gt;&amp;lt;a id=&quot;streams_api_changes_210&quot; href=&quot;#streams_api_changes_210&quot;&amp;gt;Streams API&lt;br/&gt;
         see &amp;lt;a href=&quot;https://cwiki.apache.org/confluence/display/KAFKA/KIP-324%3A+Add+method+to+get+metrics%28%29+in+AdminClient&quot;&amp;gt;KIP-324&amp;lt;/a&amp;gt;&lt;br/&gt;
     &amp;lt;/p&amp;gt;&lt;/p&gt;

&lt;p&gt;+    &amp;lt;p&amp;gt;&lt;br/&gt;
+        We deprecated the notion of segments in window stores as those are intended to be an implementation details.&lt;br/&gt;
+        Thus, method &amp;lt;code&amp;gt;Windows#segments()&amp;lt;/code&amp;gt; and variable &amp;lt;code&amp;gt;Windows#segments&amp;lt;/code&amp;gt; were deprecated.&lt;br/&gt;
+        If you implement custom windows, you should update your code accordingly.&lt;br/&gt;
+        Similarly, &amp;lt;code&amp;gt;WindowBytesStoreSupplier#segments()&amp;lt;/code&amp;gt; was deprecated and replaced with &amp;lt;code&amp;gt;WindowBytesStoreSupplier#segmentInterval()&amp;lt;/code&amp;gt;.&lt;br/&gt;
+        If you implement custom window store, you need to update your code accordingly.&lt;br/&gt;
+	Finally, &amp;lt;code&amp;gt;Stores#persistentWindowStore(...)&amp;lt;/code&amp;gt; were deprecated and replaced with a new overload that does not allow to specify the number of segments any longer.&lt;br/&gt;
+        For more details, see &amp;lt;a href=&quot;https://cwiki.apache.org/confluence/display/KAFKA/KIP-319%3A+Replace+segments+with+segmentInterval+in+WindowBytesStoreSupplier&quot;&amp;gt;KIP-319&amp;lt;/a&amp;gt;&lt;br/&gt;
+        (note: &amp;lt;a href=&quot;https://cwiki.apache.org/confluence/display/KAFKA/KIP-328%3A+Ability+to+suppress+updates+for+KTables&quot;&amp;gt;KIP-328&amp;lt;/a&amp;gt; and &lt;br/&gt;
+	&amp;lt;a href=&quot;https://cwiki.apache.org/confluence/display/KAFKA/KIP-358%3A+Migrate+Streams+API+to+Duration+instead+of+long+ms+times&quot;&amp;gt;KIP-358&amp;lt;/a&amp;gt; &apos;overlap&apos; with KIP-319).&lt;br/&gt;
+    &amp;lt;/p&amp;gt;&lt;br/&gt;
+&lt;br/&gt;
     &amp;lt;h3&amp;gt;&amp;lt;a id=&quot;streams_api_changes_200&quot; href=&quot;#streams_api_changes_200&quot;&amp;gt;Streams API changes in 2.0.0&amp;lt;/a&amp;gt;&amp;lt;/h3&amp;gt;&lt;br/&gt;
     &amp;lt;p&amp;gt;&lt;br/&gt;
         In 2.0.0 we have added a few new APIs on the &amp;lt;code&amp;gt;ReadOnlyWindowStore&amp;lt;/code&amp;gt; interface (for details please read &amp;lt;a href=&quot;#streams_api_changes_200&quot;&amp;gt;Streams API changes&amp;lt;/a&amp;gt; below).&lt;br/&gt;
diff --git a/streams/src/main/java/org/apache/kafka/streams/kstream/Windows.java b/streams/src/main/java/org/apache/kafka/streams/kstream/Windows.java&lt;br/&gt;
index 4dfba2306cb..feaee1e1336 100644&lt;br/&gt;
&amp;#8212; a/streams/src/main/java/org/apache/kafka/streams/kstream/Windows.java&lt;br/&gt;
+++ b/streams/src/main/java/org/apache/kafka/streams/kstream/Windows.java&lt;br/&gt;
@@ -83,21 +83,6 @@ public long maintainMs() &lt;/p&gt;
{
         return maintainDurationMs;
     }

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;/**&lt;/li&gt;
	&lt;li&gt;* Return the segment interval in milliseconds.&lt;/li&gt;
	&lt;li&gt;*&lt;/li&gt;
	&lt;li&gt;* @return the segment interval&lt;/li&gt;
	&lt;li&gt;* @deprecated since 2.1. Instead, directly configure the segment interval in a store supplier and use 
{@link Materialized#as(WindowBytesStoreSupplier)}
&lt;p&gt;.&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;*/&lt;/li&gt;
	&lt;li&gt;@Deprecated&lt;/li&gt;
	&lt;li&gt;public long segmentInterval() 
{
-        // Pinned arbitrarily to a minimum of 60 seconds. Profiling may indicate a different value is more efficient.
-        final long minimumSegmentInterval = 60_000L;
-        // Scaled to the (possibly overridden) retention period
-        return Math.max(maintainMs() / (segments - 1), minimumSegmentInterval);
-    }
&lt;p&gt;-&lt;br/&gt;
-&lt;br/&gt;
     /**&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;ul&gt;
	&lt;li&gt;Set the number of segments to be used for rolling the window store.&lt;/li&gt;
	&lt;li&gt;This function is not exposed to users but can be called by developers that extend this class.&lt;br/&gt;
diff --git a/streams/src/main/java/org/apache/kafka/streams/state/Stores.java b/streams/src/main/java/org/apache/kafka/streams/state/Stores.java&lt;br/&gt;
index 30e51403714..f7a182472be 100644
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/streams/src/main/java/org/apache/kafka/streams/state/Stores.java&lt;br/&gt;
+++ b/streams/src/main/java/org/apache/kafka/streams/state/Stores.java&lt;br/&gt;
@@ -16,7 +16,6 @@&lt;br/&gt;
  */&lt;br/&gt;
 package org.apache.kafka.streams.state;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;-import java.time.Duration;&lt;br/&gt;
 import org.apache.kafka.common.annotation.InterfaceStability;&lt;br/&gt;
 import org.apache.kafka.common.serialization.Serde;&lt;br/&gt;
 import org.apache.kafka.common.serialization.Serdes;&lt;br/&gt;
@@ -32,6 +31,7 @@&lt;br/&gt;
 import org.apache.kafka.streams.state.internals.SessionStoreBuilder;&lt;br/&gt;
 import org.apache.kafka.streams.state.internals.WindowStoreBuilder;&lt;/p&gt;

&lt;p&gt;+import java.time.Duration;&lt;br/&gt;
 import java.util.Objects;&lt;/p&gt;

&lt;p&gt; /**&lt;br/&gt;
@@ -155,7 +155,7 @@ public String metricsScope() {&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;careful to set it the same as the windowed keys you&apos;re actually storing.&lt;/li&gt;
	&lt;li&gt;@param retainDuplicates      whether or not to retain duplicates.&lt;/li&gt;
	&lt;li&gt;@return an instance of 
{@link WindowBytesStoreSupplier}&lt;br/&gt;
-     * @deprecated since 2.1 Use {@link Stores#persistentWindowStore(String, long, long, boolean, long)} instead&lt;br/&gt;
+     * @deprecated since 2.1 Use {@link Stores#persistentWindowStore(String, Duration, Duration, boolean)} instead&lt;br/&gt;
      */&lt;br/&gt;
     @Deprecated&lt;br/&gt;
     public static WindowBytesStoreSupplier persistentWindowStore(final String name,&lt;br/&gt;
@@ -178,28 +178,6 @@ public static WindowBytesStoreSupplier persistentWindowStore(final String name,&lt;br/&gt;
         );&lt;br/&gt;
     }&lt;br/&gt;
 &lt;br/&gt;
-    /**&lt;br/&gt;
-     * Create a persistent {@link WindowBytesStoreSupplier}
&lt;p&gt;.&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;* @param name                  name of the store (cannot be 
{@code null})&lt;br/&gt;
-     * @param retentionPeriod       length of time to retain data in the store (cannot be negative)&lt;br/&gt;
-     *                              Note that the retention period must be at least long enough to contain the&lt;br/&gt;
-     *                              windowed data&apos;s entire life cycle, from window-start through window-end,&lt;br/&gt;
-     *                              and for the entire grace period.&lt;br/&gt;
-     * @param windowSize            size of the windows (cannot be negative)&lt;br/&gt;
-     * @param retainDuplicates      whether or not to retain duplicates.&lt;br/&gt;
-     * @return an instance of {@link WindowBytesStoreSupplier}&lt;br/&gt;
-     * @deprecated Use {@link #persistentWindowStore(String, Duration, Duration, boolean)} instead&lt;br/&gt;
-     */&lt;br/&gt;
-    @Deprecated&lt;br/&gt;
-    public static WindowBytesStoreSupplier persistentWindowStore(final String name,&lt;br/&gt;
-                                                                 final long retentionPeriod,&lt;br/&gt;
-                                                                 final long windowSize,&lt;br/&gt;
-                                                                 final boolean retainDuplicates) {
-        // we&apos;re arbitrarily defaulting to segments no smaller than one minute.
-        final long defaultSegmentInterval = Math.max(retentionPeriod / 2, 60_000L);
-        return persistentWindowStore(name, retentionPeriod, windowSize, retainDuplicates, defaultSegmentInterval);
-    }&lt;br/&gt;
-&lt;br/&gt;
     /**&lt;br/&gt;
      * Create a persistent {@link WindowBytesStoreSupplier}.&lt;br/&gt;
      * @param name                  name of the store (cannot be {@code null}
&lt;p&gt;)&lt;br/&gt;
@@ -220,28 +198,16 @@ public static WindowBytesStoreSupplier persistentWindowStore(final String name,&lt;br/&gt;
         ApiUtils.validateMillisecondDuration(retentionPeriod, &quot;retentionPeriod&quot;);&lt;br/&gt;
         ApiUtils.validateMillisecondDuration(windowSize, &quot;windowSize&quot;);&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;return persistentWindowStore(name, retentionPeriod.toMillis(), windowSize.toMillis(), retainDuplicates);&lt;br/&gt;
+        final long defaultSegmentInterval = Math.max(retentionPeriod.toMillis() / 2, 60_000L);&lt;br/&gt;
+&lt;br/&gt;
+        return persistentWindowStore(name, retentionPeriod.toMillis(), windowSize.toMillis(), retainDuplicates, defaultSegmentInterval);&lt;br/&gt;
     }&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;/**&lt;/li&gt;
	&lt;li&gt;* Create a persistent 
{@link WindowBytesStoreSupplier}.&lt;br/&gt;
-     * @param name                  name of the store (cannot be {@code null})&lt;br/&gt;
-     * @param retentionPeriod       length of time to retain data in the store (cannot be negative)&lt;br/&gt;
-     *                              Note that the retention period must be at least long enough to contain the&lt;br/&gt;
-     *                              windowed data&apos;s entire life cycle, from window-start through window-end,&lt;br/&gt;
-     *                              and for the entire grace period.&lt;br/&gt;
-     * @param segmentInterval       size of segments in ms (cannot be negative)&lt;br/&gt;
-     * @param windowSize            size of the windows (cannot be negative)&lt;br/&gt;
-     * @param retainDuplicates      whether or not to retain duplicates.&lt;br/&gt;
-     * @return an instance of {@link WindowBytesStoreSupplier}&lt;/li&gt;
	&lt;li&gt;* @deprecated Use 
{@link #persistentWindowStore(String, Duration, Duration, boolean)}
&lt;p&gt; instead&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;*/&lt;/li&gt;
	&lt;li&gt;@Deprecated&lt;/li&gt;
	&lt;li&gt;public static WindowBytesStoreSupplier persistentWindowStore(final String name,&lt;/li&gt;
	&lt;li&gt;final long retentionPeriod,&lt;/li&gt;
	&lt;li&gt;final long windowSize,&lt;/li&gt;
	&lt;li&gt;final boolean retainDuplicates,&lt;/li&gt;
	&lt;li&gt;final long segmentInterval) {&lt;br/&gt;
+    private static WindowBytesStoreSupplier persistentWindowStore(final String name,&lt;br/&gt;
+                                                                  final long retentionPeriod,&lt;br/&gt;
+                                                                  final long windowSize,&lt;br/&gt;
+                                                                  final boolean retainDuplicates,&lt;br/&gt;
+                                                                  final long segmentInterval) {&lt;br/&gt;
         Objects.requireNonNull(name, &quot;name cannot be null&quot;);&lt;br/&gt;
         if (retentionPeriod &amp;lt; 0L) {&lt;br/&gt;
             throw new IllegalArgumentException(&quot;retentionPeriod cannot be negative&quot;);&lt;br/&gt;
@@ -269,7 +235,9 @@ public static WindowBytesStoreSupplier persistentWindowStore(final String name,&lt;/li&gt;
&lt;/ul&gt;
&lt;ul&gt;
	&lt;li&gt;windowed data&apos;s entire life cycle, from window-start through window-end,&lt;/li&gt;
	&lt;li&gt;and for the entire grace period.&lt;/li&gt;
	&lt;li&gt;@return an instance of a 
{@link  SessionBytesStoreSupplier}&lt;br/&gt;
+     * @deprecated since 2.1 Use {@link Stores#persistentSessionStore(String, Duration)} instead&lt;br/&gt;
      */&lt;br/&gt;
+    @Deprecated&lt;br/&gt;
     public static SessionBytesStoreSupplier persistentSessionStore(final String name,&lt;br/&gt;
                                                                    final long retentionPeriod) {&lt;br/&gt;
         Objects.requireNonNull(name, &quot;name cannot be null&quot;);&lt;br/&gt;
@@ -288,6 +256,7 @@ public static SessionBytesStoreSupplier persistentSessionStore(final String name&lt;br/&gt;
      *                          and for the entire grace period.&lt;br/&gt;
      * @return an instance of a {@link  SessionBytesStoreSupplier}
&lt;p&gt;      */&lt;br/&gt;
+    @SuppressWarnings(&quot;deprecation&quot;)&lt;br/&gt;
     public static SessionBytesStoreSupplier persistentSessionStore(final String name,&lt;br/&gt;
                                                                    final Duration retentionPeriod) {&lt;br/&gt;
         ApiUtils.validateMillisecondDuration(retentionPeriod, &quot;retentionPeriod&quot;);&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;





&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16651951" author="githubbot" created="Tue, 16 Oct 2018 15:42:27 +0000"  >&lt;p&gt;vvcephei opened a new pull request #5806: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7080&quot; title=&quot;WindowStoreBuilder incorrectly initializes CachingWindowStore&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7080&quot;&gt;&lt;del&gt;KAFKA-7080&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7222&quot; title=&quot;KIP-328: Add Window Grace Period (and deprecate Window Retention)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7222&quot;&gt;&lt;del&gt;KAFKA-7222&lt;/del&gt;&lt;/a&gt;: Cleanup overlapping KIP changes Part 2&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5806&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5806&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   #5804 removed `Windows#segmentInterval`, but did not remove all references to it.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16653964" author="githubbot" created="Wed, 17 Oct 2018 18:05:46 +0000"  >&lt;p&gt;ewencp closed pull request #5806: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7080&quot; title=&quot;WindowStoreBuilder incorrectly initializes CachingWindowStore&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7080&quot;&gt;&lt;del&gt;KAFKA-7080&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7222&quot; title=&quot;KIP-328: Add Window Grace Period (and deprecate Window Retention)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7222&quot;&gt;&lt;del&gt;KAFKA-7222&lt;/del&gt;&lt;/a&gt;: Cleanup overlapping KIP changes Part 2&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5806&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5806&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/streams/src/main/java/org/apache/kafka/streams/kstream/internals/TimeWindowedKStreamImpl.java b/streams/src/main/java/org/apache/kafka/streams/kstream/internals/TimeWindowedKStreamImpl.java&lt;br/&gt;
index 8ba02bfefaf..ecfe1554815 100644&lt;br/&gt;
&amp;#8212; a/streams/src/main/java/org/apache/kafka/streams/kstream/internals/TimeWindowedKStreamImpl.java&lt;br/&gt;
+++ b/streams/src/main/java/org/apache/kafka/streams/kstream/internals/TimeWindowedKStreamImpl.java&lt;br/&gt;
@@ -193,9 +193,9 @@&lt;br/&gt;
                 supplier = Stores.persistentWindowStore(&lt;br/&gt;
                     materialized.storeName(),&lt;br/&gt;
                     windows.maintainMs(),&lt;br/&gt;
+                    windows.segments,&lt;br/&gt;
                     windows.size(),&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;false,&lt;/li&gt;
	&lt;li&gt;windows.segmentInterval()&lt;br/&gt;
+                    false&lt;br/&gt;
                 );&lt;br/&gt;
             }&lt;br/&gt;
         }&lt;br/&gt;
diff --git a/streams/src/test/java/org/apache/kafka/streams/kstream/WindowsTest.java b/streams/src/test/java/org/apache/kafka/streams/kstream/WindowsTest.java&lt;br/&gt;
index 8709031a468..49bc56cade8 100644
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/streams/src/test/java/org/apache/kafka/streams/kstream/WindowsTest.java&lt;br/&gt;
+++ b/streams/src/test/java/org/apache/kafka/streams/kstream/WindowsTest.java&lt;br/&gt;
@@ -40,19 +40,6 @@ public long gracePeriodMs() {&lt;br/&gt;
         }&lt;br/&gt;
     }&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;@SuppressWarnings(&quot;deprecation&quot;) // specifically testing deprecated APIs&lt;/li&gt;
	&lt;li&gt;@Test&lt;/li&gt;
	&lt;li&gt;public void shouldSetNumberOfSegments() 
{
-        final int anySegmentSizeLargerThanOne = 5;
-        final TestWindows testWindow = new TestWindows();
-        final long maintainMs = testWindow.maintainMs();
-
-        assertEquals(
-            maintainMs / (anySegmentSizeLargerThanOne - 1),
-            testWindow.segments(anySegmentSizeLargerThanOne).segmentInterval()
-        );
-    }
&lt;p&gt;-&lt;br/&gt;
     @SuppressWarnings(&quot;deprecation&quot;) // specifically testing deprecated APIs&lt;br/&gt;
     @Test&lt;br/&gt;
     public void shouldSetWindowRetentionTime() {&lt;br/&gt;
diff --git a/streams/src/test/java/org/apache/kafka/streams/perf/SimpleBenchmark.java b/streams/src/test/java/org/apache/kafka/streams/perf/SimpleBenchmark.java&lt;br/&gt;
index 4008689d3ef..4fe3c07f1cc 100644&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/streams/src/test/java/org/apache/kafka/streams/perf/SimpleBenchmark.java&lt;br/&gt;
+++ b/streams/src/test/java/org/apache/kafka/streams/perf/SimpleBenchmark.java&lt;br/&gt;
@@ -473,10 +473,9 @@ private void processStreamWithWindowStore(final String topic) {&lt;br/&gt;
         final StoreBuilder&amp;lt;WindowStore&amp;lt;Integer, byte[]&amp;gt;&amp;gt; storeBuilder = Stores.windowStoreBuilder(&lt;br/&gt;
             Stores.persistentWindowStore(&lt;br/&gt;
                 &quot;store&quot;,&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;AGGREGATE_WINDOW_SIZE * 3,&lt;/li&gt;
	&lt;li&gt;AGGREGATE_WINDOW_SIZE,&lt;/li&gt;
	&lt;li&gt;false,&lt;/li&gt;
	&lt;li&gt;60_000L&lt;br/&gt;
+                ofMillis(AGGREGATE_WINDOW_SIZE * 3),&lt;br/&gt;
+                ofMillis(AGGREGATE_WINDOW_SIZE),&lt;br/&gt;
+                false&lt;br/&gt;
             ),&lt;br/&gt;
             INTEGER_SERDE,&lt;br/&gt;
             BYTE_SERDE&lt;br/&gt;
diff --git a/streams/src/test/java/org/apache/kafka/streams/state/StoresTest.java b/streams/src/test/java/org/apache/kafka/streams/state/StoresTest.java&lt;br/&gt;
index b62364a4a2f..1d4a849a19d 100644
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/streams/src/test/java/org/apache/kafka/streams/state/StoresTest.java&lt;br/&gt;
+++ b/streams/src/test/java/org/apache/kafka/streams/state/StoresTest.java&lt;br/&gt;
@@ -24,6 +24,7 @@&lt;br/&gt;
 import org.apache.kafka.streams.state.internals.RocksDBWindowStore;&lt;br/&gt;
 import org.junit.Test;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;+import static java.time.Duration.ZERO;&lt;br/&gt;
 import static java.time.Duration.ofMillis;&lt;br/&gt;
 import static org.hamcrest.CoreMatchers.nullValue;&lt;br/&gt;
 import static org.hamcrest.MatcherAssert.assertThat;&lt;br/&gt;
@@ -55,12 +56,12 @@ public void shouldThrowIfILruMapStoreCapacityIsNegative() {&lt;/p&gt;

&lt;p&gt;     @Test(expected = NullPointerException.class)&lt;br/&gt;
     public void shouldThrowIfIPersistentWindowStoreStoreNameIsNull() &lt;/p&gt;
{
-        Stores.persistentWindowStore(null, 0L, 0L, false, 0L);
+        Stores.persistentWindowStore(null, ZERO, ZERO, false);
     }

&lt;p&gt;     @Test(expected = IllegalArgumentException.class)&lt;br/&gt;
     public void shouldThrowIfIPersistentWindowStoreRetentionPeriodIsNegative() &lt;/p&gt;
{
-        Stores.persistentWindowStore(&quot;anyName&quot;, -1L, 0L, false, 0L);
+        Stores.persistentWindowStore(&quot;anyName&quot;, ofMillis(-1L), ZERO, false);
     }

&lt;p&gt;     @Deprecated&lt;br/&gt;
@@ -74,11 +75,6 @@ public void shouldThrowIfIPersistentWindowStoreIfWindowSizeIsNegative() &lt;/p&gt;
{
         Stores.persistentWindowStore(&quot;anyName&quot;, ofMillis(0L), ofMillis(-1L), false);
     }

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;@Test(expected = IllegalArgumentException.class)&lt;/li&gt;
	&lt;li&gt;public void shouldThrowIfIPersistentWindowStoreIfSegmentIntervalIsTooSmall() 
{
-        Stores.persistentWindowStore(&quot;anyName&quot;, 1L, 1L, false, -1L);
-    }
&lt;p&gt;-&lt;br/&gt;
     @Test(expected = NullPointerException.class)&lt;br/&gt;
     public void shouldThrowIfIPersistentSessionStoreStoreNameIsNull() {&lt;br/&gt;
         Stores.persistentSessionStore(null, ofMillis(0));&lt;br/&gt;
diff --git a/streams/src/test/java/org/apache/kafka/streams/state/internals/RocksDBWindowStoreTest.java b/streams/src/test/java/org/apache/kafka/streams/state/internals/RocksDBWindowStoreTest.java&lt;br/&gt;
index cd0f49a7372..c41b0942301 100644&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/streams/src/test/java/org/apache/kafka/streams/state/internals/RocksDBWindowStoreTest.java&lt;br/&gt;
+++ b/streams/src/test/java/org/apache/kafka/streams/state/internals/RocksDBWindowStoreTest.java&lt;br/&gt;
@@ -54,6 +54,7 @@&lt;br/&gt;
 import java.util.Map;&lt;br/&gt;
 import java.util.Set;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;+import static java.time.Duration.ofMillis;&lt;br/&gt;
 import static java.time.Instant.ofEpochMilli;&lt;br/&gt;
 import static java.util.Objects.requireNonNull;&lt;br/&gt;
 import static org.hamcrest.CoreMatchers.equalTo;&lt;br/&gt;
@@ -70,7 +71,7 @@&lt;/p&gt;

&lt;p&gt;     private final int numSegments = 3;&lt;br/&gt;
     private final long windowSize = 3L;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private final long segmentInterval = 600L;&lt;br/&gt;
+    private final long segmentInterval = 60_000L;&lt;br/&gt;
     private final long retentionPeriod = segmentInterval * (numSegments - 1);&lt;br/&gt;
     private final String windowName = &quot;window&quot;;&lt;br/&gt;
     private final Segments segments = new Segments(windowName, retentionPeriod, segmentInterval);&lt;br/&gt;
@@ -108,7 +109,7 @@&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     private WindowStore&amp;lt;Integer, String&amp;gt; createWindowStore(final ProcessorContext context, final boolean retainDuplicates) {&lt;br/&gt;
         final WindowStore&amp;lt;Integer, String&amp;gt; store = Stores.windowStoreBuilder(&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Stores.persistentWindowStore(windowName, retentionPeriod, windowSize, retainDuplicates, segmentInterval),&lt;br/&gt;
+            Stores.persistentWindowStore(windowName, ofMillis(retentionPeriod), ofMillis(windowSize), retainDuplicates),&lt;br/&gt;
             Serdes.Integer(),&lt;br/&gt;
             Serdes.String()).build();&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;@@ -771,7 +772,7 @@ public void shouldFetchAndIterateOverExactKeys() {&lt;br/&gt;
         final long retentionPeriod = 0x7a00000000000000L;&lt;/p&gt;

&lt;p&gt;         final WindowStore&amp;lt;String, String&amp;gt; windowStore = Stores.windowStoreBuilder(&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Stores.persistentWindowStore(windowName, retentionPeriod, windowSize, true),&lt;br/&gt;
+            Stores.persistentWindowStore(windowName, ofMillis(retentionPeriod), ofMillis(windowSize), true),&lt;br/&gt;
             Serdes.String(),&lt;br/&gt;
             Serdes.String()).build();&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;@@ -848,7 +849,7 @@ public void shouldNoNullPointerWhenSerdeDoesNotHandleNull() {&lt;br/&gt;
     @Test&lt;br/&gt;
     public void shouldFetchAndIterateOverExactBinaryKeys() {&lt;br/&gt;
         final WindowStore&amp;lt;Bytes, String&amp;gt; windowStore = Stores.windowStoreBuilder(&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Stores.persistentWindowStore(windowName, 60_000L, 60_000L, true),&lt;br/&gt;
+            Stores.persistentWindowStore(windowName, ofMillis(60_000L), ofMillis(60_000L), true),&lt;br/&gt;
             Serdes.Bytes(),&lt;br/&gt;
             Serdes.String()).build();&lt;/li&gt;
&lt;/ul&gt;






&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16681546" author="omkreddy" created="Fri, 9 Nov 2018 14:52:16 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vvcephei&quot; class=&quot;user-hover&quot; rel=&quot;vvcephei&quot;&gt;vvcephei&lt;/a&gt;&#160; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt;&#160;Can we create a separate JIRA for the part that was fixed in 2.0 branch. This will help us to track the changes for 2.0.1 release.&lt;/p&gt;</comment>
                            <comment id="16685639" author="guozhang" created="Tue, 13 Nov 2018 19:26:29 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vvcephei&quot; class=&quot;user-hover&quot; rel=&quot;vvcephei&quot;&gt;vvcephei&lt;/a&gt; I checked all the four related PRs and it seems only one of them got into 2.0 branch, which is not directly related to this JIRA. Could you confirm?&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3v253:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>