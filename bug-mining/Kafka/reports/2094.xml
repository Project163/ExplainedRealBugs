<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:16:01 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-7412] Bug prone response from producer.send(ProducerRecord, Callback) if Kafka broker is not running</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-7412</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Hi there, I have probably found a bug in Java Kafka producer client.&lt;/p&gt;

&lt;p&gt;Scenario &amp;amp; current behavior:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Start Kafka broker, single instance.&lt;/li&gt;
	&lt;li&gt;Start application that produces messages to Kafka.&lt;/li&gt;
	&lt;li&gt;Let the application to load partitions for a topic to warm up the producer, e.g. send a message to Kafka. I&apos;m not sure if this is necessary step, but our code does it.&lt;/li&gt;
	&lt;li&gt;Gracefully stop the Kafka broker.&lt;/li&gt;
	&lt;li&gt;Application logs now contains &quot;org.apache.kafka.clients.NetworkClient: &lt;span class=&quot;error&quot;&gt;&amp;#91;Producer clientId=...&amp;#93;&lt;/span&gt; Connection to node 0 could not be established. Broker may not be available.&quot; so the client is aware about the Kafka unavailability.&lt;/li&gt;
	&lt;li&gt;Trigger the producer to send a message using KafkaProducer.send(ProducerRecord, Callback) method.&lt;/li&gt;
	&lt;li&gt;The callback that notifies business code receives non-null RecordMetadata and null Exception after request.timeout.ms. The metadata contains offset -1 which is value of ProduceResponse.INVALID_OFFSET.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Expected behavior:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;If the Kafka is not running and the message is not appended to the log, the callback should contain null RecordMetadata and non-null Exception. At least I subjectively understand the Javadoc this way, &quot;exception on production error&quot; in simple words.&lt;/li&gt;
	&lt;li&gt;Developer that is not aware of this behavior and that doesn&apos;t test for offset -1, may consider the message as successfully send and properly acked by the broker.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Known workaround&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Together with checking for non-null exception in the callback, add another condition for ProduceResponse.INVALID_OFFSET.&lt;/li&gt;
&lt;/ul&gt;


&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;                try {
                    producer.send(record, (metadata, exception) -&amp;gt; {
                        if (metadata != null) {
                            if (metadata.offset() != ProduceResponse.INVALID_OFFSET) {
                                // Success
                            } else {
                                // Failure
                            }
                        } else {
                            // Failure
                        }
                    });
                } catch (Exception e) {
                    // Failure
                }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Used setup&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Latest Kafka 2.0.0 for both broker and Java client.&lt;/li&gt;
	&lt;li&gt;Originally found with broker 0.11.0.1 and client 2.0.0.&lt;/li&gt;
	&lt;li&gt;Code is analogy of the one in Javadoc of KafkaProducer.send().&lt;/li&gt;
	&lt;li&gt;Used producer configuration (others use defaults).&lt;/li&gt;
&lt;/ul&gt;


&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;    bootstrap.servers = &quot;localhost:9092&quot;
    client.id = &quot;...&quot;
    acks = &quot;all&quot;
    retries = 1
    linger.ms = &quot;20&quot;
    compression.type = &quot;lz4&quot;
    request.timeout.ms = 5000 # The same behavior is with default, this is to speed up the tests
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13185092">KAFKA-7412</key>
            <summary>Bug prone response from producer.send(ProducerRecord, Callback) if Kafka broker is not running</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="huxi_2b">huxihx</assignee>
                                    <reporter username="turek@avast.com">Michal Turek</reporter>
                        <labels>
                    </labels>
                <created>Fri, 14 Sep 2018 09:05:20 +0000</created>
                <updated>Thu, 20 Feb 2020 18:57:37 +0000</updated>
                            <resolved>Fri, 9 Nov 2018 01:01:10 +0000</resolved>
                                    <version>2.0.0</version>
                                    <fixVersion>2.2.0</fixVersion>
                                    <component>producer </component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16618599" author="huxi_2b" created="Tue, 18 Sep 2018 07:25:07 +0000"  >&lt;p&gt;I would expect the exception should not be&#160;empty in your case. It will be much safer to check exception nullability first.&lt;/p&gt;</comment>
                            <comment id="16626414" author="sumannewton" created="Mon, 24 Sep 2018 20:24:10 +0000"  >&lt;p&gt;Even I have used the same client, broker, and code, but all the time there is an exception - org.apache.kafka.common.errors.TimeoutException. Re-run again and see if you can reproduce.&lt;/p&gt;</comment>
                            <comment id="16626825" author="turek@avast.com" created="Tue, 25 Sep 2018 06:13:11 +0000"  >&lt;p&gt;Hmm, I have just tried to repeat it multiple times with fresh Kafka installation with default configuration (according to quick start guide). The callback is now receiving org.apache.kafka.common.errors.TimeoutException together with non-null RecordMetadata, offset -1, which breaks &quot;Exactly one of the arguments will be non-null.&quot; contract from Javadoc. I still believe there is something broken inside the client.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;    /**
     * A callback method the user can implement to provide asynchronous handling of request completion. This method will
     * be called when the record sent to the server has been acknowledged. Exactly one of the arguments will be
     * non-null.
     * @param metadata The metadata for the record that was sent (i.e. the partition and offset). Null if an error
     *        occurred.
     * @param exception The exception thrown during processing of this record. Null if no error occurred.
     *                  Possible thrown exceptions include:
     * ...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Metadata AA_INPUT_666-0@-1, exception org.apache.kafka.common.errors.TimeoutException: Expiring 1 record(s) for AA_INPUT_666-0: 5036 ms has passed since batch creation plus linger time
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/12941168/12941168_both_metadata_and_exception.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;I have no idea why it started to behave differently. It&apos;s the same code with the same configuration and versions. This screenshot of debugging has been taken two weeks ago while creating the task.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/12939685/12939685_metadata_when_kafka_is_stopped.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="16649959" author="githubbot" created="Mon, 15 Oct 2018 09:25:13 +0000"  >&lt;p&gt;huxihx opened a new pull request #5798: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7412&quot; title=&quot;Bug prone response from producer.send(ProducerRecord, Callback) if Kafka broker is not running&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7412&quot;&gt;&lt;del&gt;KAFKA-7412&lt;/del&gt;&lt;/a&gt;: onComplete should not reassign `metadata` variable&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5798&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5798&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   The Java doc for `InterceptorCallback#onComplete` says that exactly one of the arguments(metadata and exception) will be non-null. However, the commitment will be broken when TimeoutException is encountered since the code reassigns a new-created RecordMetadata object to variable `metadata`.&lt;/p&gt;

&lt;p&gt;   The solution is to leave `metadata1` unchanged and pass a new RecordMetadata instance to `onAcknowledgement`.&lt;/p&gt;

&lt;p&gt;   *More detailed description of your change,&lt;br/&gt;
   if necessary. The PR title and PR message become&lt;br/&gt;
   the squashed commit message, so use a separate&lt;br/&gt;
   comment to ping reviewers.*&lt;/p&gt;

&lt;p&gt;   *Summary of testing strategy (including rationale)&lt;br/&gt;
   for the feature or bug fix. Unit and/or integration&lt;br/&gt;
   tests are expected for any behaviour change and&lt;br/&gt;
   system tests should be considered for larger changes.*&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16680684" author="githubbot" created="Fri, 9 Nov 2018 00:58:17 +0000"  >&lt;p&gt;junrao closed pull request #5798: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7412&quot; title=&quot;Bug prone response from producer.send(ProducerRecord, Callback) if Kafka broker is not running&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7412&quot;&gt;&lt;del&gt;KAFKA-7412&lt;/del&gt;&lt;/a&gt;: onComplete should not reassign `metadata` variable&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5798&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5798&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/clients/src/main/java/org/apache/kafka/clients/producer/Callback.java b/clients/src/main/java/org/apache/kafka/clients/producer/Callback.java&lt;br/&gt;
index a70e4e9a685..f7d4bcdd468 100644&lt;br/&gt;
&amp;#8212; a/clients/src/main/java/org/apache/kafka/clients/producer/Callback.java&lt;br/&gt;
+++ b/clients/src/main/java/org/apache/kafka/clients/producer/Callback.java&lt;br/&gt;
@@ -24,10 +24,11 @@&lt;/p&gt;

&lt;p&gt;     /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;A callback method the user can implement to provide asynchronous handling of request completion. This method will&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;* be called when the record sent to the server has been acknowledged. Exactly one of the arguments will be&lt;/li&gt;
	&lt;li&gt;* non-null.&lt;/li&gt;
	&lt;li&gt;* @param metadata The metadata for the record that was sent (i.e. the partition and offset). Null if an error&lt;/li&gt;
	&lt;li&gt;*        occurred.&lt;br/&gt;
+     * be called when the record sent to the server has been acknowledged. When exception is not null in the callback,&lt;br/&gt;
+     * metadata will contain the special -1 value for all fields except for topicPartition, which will be valid.&lt;br/&gt;
+     *&lt;br/&gt;
+     * @param metadata The metadata for the record that was sent (i.e. the partition and offset). An empty metadata&lt;br/&gt;
+     *                 with -1 value for all fields except for topicPartition will be returned if an error occurred.&lt;/li&gt;
&lt;/ul&gt;
&lt;ul&gt;
	&lt;li&gt;@param exception The exception thrown during processing of this record. Null if no error occurred.&lt;/li&gt;
	&lt;li&gt;Possible thrown exceptions include:&lt;br/&gt;
      *&lt;br/&gt;
@@ -49,5 +50,5 @@&lt;/li&gt;
	&lt;li&gt;TimeoutException&lt;/li&gt;
	&lt;li&gt;UnknownTopicOrPartitionException&lt;br/&gt;
      */&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public void onCompletion(RecordMetadata metadata, Exception exception);&lt;br/&gt;
+    void onCompletion(RecordMetadata metadata, Exception exception);&lt;br/&gt;
 }&lt;br/&gt;
diff --git a/examples/src/main/java/kafka/examples/Producer.java b/examples/src/main/java/kafka/examples/Producer.java&lt;br/&gt;
index 87212801246..b6998c58ac7 100644
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/examples/src/main/java/kafka/examples/Producer.java&lt;br/&gt;
+++ b/examples/src/main/java/kafka/examples/Producer.java&lt;br/&gt;
@@ -81,8 +81,8 @@ public DemoCallBack(long startTime, int key, String message) {&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;A callback method the user can implement to provide asynchronous handling of request completion. This method will&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;* be called when the record sent to the server has been acknowledged. Exactly one of the arguments will be&lt;/li&gt;
	&lt;li&gt;* non-null.&lt;br/&gt;
+     * be called when the record sent to the server has been acknowledged. When exception is not null in the callback,&lt;br/&gt;
+     * metadata will contain the special -1 value for all fields except for topicPartition, which will be valid.&lt;br/&gt;
      *&lt;/li&gt;
&lt;/ul&gt;
&lt;ul&gt;
	&lt;li&gt;@param metadata  The metadata for the record that was sent (i.e. the partition and offset). Null if an error&lt;/li&gt;
	&lt;li&gt;occurred.&lt;/li&gt;
&lt;/ul&gt;





&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16680686" author="junrao" created="Fri, 9 Nov 2018 01:01:10 +0000"  >&lt;p&gt;Clarified the javadoc in producer callback. Metadata is not null with non-null exception.&lt;/p&gt;

&lt;p&gt;Merged the PR to trunk.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13256818">KAFKA-8910</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12941168" name="both_metadata_and_exception.png" size="66719" author="turek@avast.com" created="Tue, 25 Sep 2018 06:01:37 +0000"/>
                            <attachment id="12939685" name="metadata_when_kafka_is_stopped.png" size="32370" author="turek@avast.com" created="Fri, 14 Sep 2018 09:05:09 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 1 week, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3y39j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>