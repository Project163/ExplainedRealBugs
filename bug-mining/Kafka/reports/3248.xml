<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:30:32 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-13889] Fix AclsDelta to handle ACCESS_CONTROL_ENTRY_RECORD quickly followed by REMOVE_ACCESS_CONTROL_ENTRY_RECORD for same ACL</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-13889</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;In &lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/metadata/src/main/java/org/apache/kafka/image/AclsDelta.java#L64&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/trunk/metadata/src/main/java/org/apache/kafka/image/AclsDelta.java#L64&lt;/a&gt; we store the pending deletion in the changes map. This could override a creation that might have just happened. This is an issue because in BrokerMetadataPublisher this results in us making a removeAcl call which finally results in &lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/metadata/src/main/java/org/apache/kafka/metadata/authorizer/StandardAuthorizerData.java#L203&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/trunk/metadata/src/main/java/org/apache/kafka/metadata/authorizer/StandardAuthorizerData.java#L203&lt;/a&gt; being executed and this code throws an exception if the ACL isnt in the Map yet. If the ACCESS_CONTROL_ENTRY_RECORD event never got processed by BrokerMetadataPublisher then the ACL wont be in the Map yet.&lt;/p&gt;

&lt;p&gt;My feeling is we might want to make removeAcl idempotent in that it returns success if the ACL doesn&apos;t exist: no matter how many times removeAcl is called it returns success if the ACL is deleted. Maybe we&#8217;d just log a warning or something?&lt;/p&gt;

&lt;p&gt;Note, I dont think the AclControlManager has this issue because it doesn&apos;t batch the events like AclsDelta does. However, we still do throw a RuntimeException here &lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/metadata/src/main/java/org/apache/kafka/controller/AclControlManager.java#L197&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/trunk/metadata/src/main/java/org/apache/kafka/controller/AclControlManager.java#L197&lt;/a&gt; - maybe we should still follow the same logic (if we make the fix suggested above) and just log a warning if the ACL doesnt exist in the Map?&lt;/p&gt;</description>
                <environment></environment>
        <key id="13444041">KAFKA-13889</key>
            <summary>Fix AclsDelta to handle ACCESS_CONTROL_ENTRY_RECORD quickly followed by REMOVE_ACCESS_CONTROL_ENTRY_RECORD for same ACL</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="andyg2">Andrew Grant</assignee>
                                    <reporter username="andyg2">Andrew Grant</reporter>
                        <labels>
                    </labels>
                <created>Mon, 9 May 2022 18:44:03 +0000</created>
                <updated>Thu, 26 May 2022 17:12:46 +0000</updated>
                            <resolved>Sun, 22 May 2022 01:24:23 +0000</resolved>
                                                    <fixVersion>3.3.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17534001" author="cmccabe" created="Mon, 9 May 2022 20:01:29 +0000"  >&lt;p&gt;Thanks for picking this up, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=andyg2&quot; class=&quot;user-hover&quot; rel=&quot;andyg2&quot;&gt;andyg2&lt;/a&gt;!&lt;/p&gt;

&lt;p&gt;I would really prefer that we not relax the invariants here. We don&apos;t want an actual bug to go undetected because we decided to ignore deletions of ACLs we couldn&apos;t locate.&lt;/p&gt;

&lt;p&gt;I think the best way to handle this is to check if the ACL being deleted exists in the image when adding a new deletion. If the ACL exists in the Delta but not in the underlying image, we can just remove it entirely from the Delta, so calling code never sees it.&lt;/p&gt;</comment>
                            <comment id="17534016" author="JIRAUSER289222" created="Mon, 9 May 2022 20:41:24 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cmccabe&quot; class=&quot;user-hover&quot; rel=&quot;cmccabe&quot;&gt;cmccabe&lt;/a&gt;. Yeah that&apos;s fair point - if a bug caused us to pass along the wrong ID for example we might end up not deleting the ACL and not even noticing.&lt;/p&gt;

&lt;p&gt;I think what you said makes sense. Since we have access to the AclImage we should be able to determine if we can just discard the ACL from the Map.&#160;&lt;/p&gt;</comment>
                            <comment id="17538973" author="jagsancio" created="Wed, 18 May 2022 17:19:12 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=andyg2&quot; class=&quot;user-hover&quot; rel=&quot;andyg2&quot;&gt;andyg2&lt;/a&gt; in the description you mention that this is also an issue in `AclControlManagaer`. I glanced at PR 12160 and it doesn&apos;t look to fix this type in that PR. Are you planning to include it in that PR or should we file a Jira for the issue with `AclControlManager`?&lt;/p&gt;</comment>
                            <comment id="17539039" author="JIRAUSER289222" created="Wed, 18 May 2022 19:42:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jagsancio&quot; class=&quot;user-hover&quot; rel=&quot;jagsancio&quot;&gt;jagsancio&lt;/a&gt; With the solution &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cmccabe&quot; class=&quot;user-hover&quot; rel=&quot;cmccabe&quot;&gt;cmccabe&lt;/a&gt; suggested above, and the code I&apos;ve implemented, AclControlManager doesnt need updating. Originally I suggested the code that calls removeAcl should catch the exception and continue on. If we had gone with this approach we&apos;d need to add that logic in AclControlManager and BrokerMetadataPublisher because both places call removeAcl and I figured we should be consistent in our error handling. But as &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cmccabe&quot; class=&quot;user-hover&quot; rel=&quot;cmccabe&quot;&gt;cmccabe&lt;/a&gt; mentioned above this could hide bugs. So in the PR I&apos;ve confined the changes to AclsDelta such that we wont return the delete event to BrokerMetadataPublisher and so we wont call removeAcl for an ACL that never got added. So with this approach neither AclControlManager nor BrokerMetadataPublisher need updating.&lt;/p&gt;

&lt;p&gt;Having said all this, per &lt;a href=&quot;https://cwiki.apache.org/confluence/display/KAFKA/KIP-595%3A+A+Raft+Protocol+for+the+Metadata+Quorum&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://cwiki.apache.org/confluence/display/KAFKA/KIP-595%3A+A+Raft+Protocol+for+the+Metadata+Quorum&lt;/a&gt; &quot;Note it is possible that a request could time out before the leader has successfully committed the records, and the client or the broker itself would retry, which would result in duplicated updates to the quorum. Since in Kafka&apos;s usage, all updates are overwrites which are idempotent (as the nature of configuration is a key-value mapping). Therefore, we do not need to implement serial number or request caching to achieve &quot;exactly-once&quot;.&quot; I&apos;m wondering if we do need to handle duplicates which could result in removeAcl being called twice. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hachikuji&quot; class=&quot;user-hover&quot; rel=&quot;hachikuji&quot;&gt;hachikuji&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cmccabe&quot; class=&quot;user-hover&quot; rel=&quot;cmccabe&quot;&gt;cmccabe&lt;/a&gt; Thoughts?&#160;&lt;/p&gt;

&lt;p&gt;FWIW I think the PR is still valid because we can still keep the logic in the PR regardless and it&apos;s strictly an improvement over what we have today. If we want to handle duplicate REMOVE_ACCESS_CONTROL_ENTRY_RECORD records I think it can be done in a separate, larger PR after more discussion (I can create a Jira if so).&lt;/p&gt;</comment>
                            <comment id="17539088" author="jagsancio" created="Wed, 18 May 2022 21:21:32 +0000"  >&lt;p&gt;&amp;gt; I&apos;m wondering if we do need to handle duplicates which could result in removeAcl being called twice&lt;/p&gt;

&lt;p&gt;Why would there be duplicates? Does the controller check that the ACL exists before writing the remove record and successfully responding to the RPC? Note that the controller always handles the queued events using the in-memory state which may include uncommitted data.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 25 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z127i0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>