<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:28:25 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-13010] Flaky test org.apache.kafka.streams.integration.TaskMetadataIntegrationTest.shouldReportCorrectCommittedOffsetInformation()</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-13010</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Integration test &lt;tt&gt;test org.apache.kafka.streams.integration.TaskMetadataIntegrationTest.shouldReportCorrectCommittedOffsetInformation()&lt;/tt&gt; sometimes fails with&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.AssertionError: only one task
	at org.hamcrest.MatcherAssert.assertThat(MatcherAssert.java:26)
	at org.apache.kafka.streams.integration.TaskMetadataIntegrationTest.getTaskMetadata(TaskMetadataIntegrationTest.java:162)
	at org.apache.kafka.streams.integration.TaskMetadataIntegrationTest.shouldReportCorrectCommittedOffsetInformation(TaskMetadataIntegrationTest.java:117)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13386493">KAFKA-13010</key>
            <summary>Flaky test org.apache.kafka.streams.integration.TaskMetadataIntegrationTest.shouldReportCorrectCommittedOffsetInformation()</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="wcarlson5">Walker Carlson</assignee>
                                    <reporter username="cadonna">Bruno Cadonna</reporter>
                        <labels>
                            <label>flaky-test</label>
                    </labels>
                <created>Tue, 29 Jun 2021 10:20:57 +0000</created>
                <updated>Wed, 5 Jul 2023 14:51:45 +0000</updated>
                            <resolved>Tue, 20 Jul 2021 21:56:41 +0000</resolved>
                                                    <fixVersion>3.0.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="17372977" author="cadonna" created="Thu, 1 Jul 2021 18:00:12 +0000"  >&lt;p&gt;Some logs that might be interesting:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[2021-06-29 12:19:40,200] INFO stream-thread [TaskMetadataTest_TaskMetadataIntegrationTestshouldReportCorrectCommittedOffsetInformation-6889e6c9-c4fa-427c-83bf-469b33a34bb5-StreamThread-2-consumer] Finished unstable assignment of tasks, a followup rebalance will be scheduled. (org.apache.kafka.streams.processor.internals.StreamsPartitionAssignor:818)
[2021-06-29 12:19:40,200] WARN [Consumer clientId=TaskMetadataTest_TaskMetadataIntegrationTestshouldReportCorrectCommittedOffsetInformation-6889e6c9-c4fa-427c-83bf-469b33a34bb5-StreamThread-2-consumer, groupId=TaskMetadataTest_TaskMetadataIntegrationTestshouldReportCorrectCommittedOffsetInformation] The following subscribed topics are not assigned to any members: [inputTaskMetadataIntegrationTestshouldReportCorrectCommittedOffsetInformation]  (org.apache.kafka.clients.consumer.internals.ConsumerCoordinator:611)
[2021-06-29 12:19:40,200] INFO [GroupCoordinator 0]: Assignment received from leader TaskMetadataTest_TaskMetadataIntegrationTestshouldReportCorrectCommittedOffsetInformation-6889e6c9-c4fa-427c-83bf-469b33a34bb5-StreamThread-2-consumer-0a548162-9e3f-4003-98c5-54ece6f5e1b8 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; group TaskMetadataTest_TaskMetadataIntegrationTestshouldReportCorrectCommittedOffsetInformation &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; generation 2. The group has 2 members, 0 of which are &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt;. (kafka.coordinator.group.GroupCoordinator:66)
[2021-06-29 12:19:40,201] INFO stream-thread [TaskMetadataTest_TaskMetadataIntegrationTestshouldReportCorrectCommittedOffsetInformation-6889e6c9-c4fa-427c-83bf-469b33a34bb5-StreamThread-1-consumer] Requested to schedule immediate rebalance &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; tasks to be safely revoked from current owner. (org.apache.kafka.streams.processor.internals.StreamsPartitionAssignor:1300)
[2021-06-29 12:19:40,201] INFO stream-thread [TaskMetadataTest_TaskMetadataIntegrationTestshouldReportCorrectCommittedOffsetInformation-6889e6c9-c4fa-427c-83bf-469b33a34bb5-StreamThread-2] State transition from RUNNING to PARTITIONS_REVOKED (org.apache.kafka.streams.processor.internals.StreamThread:229)
[2021-06-29 12:19:40,201] INFO stream-thread [TaskMetadataTest_TaskMetadataIntegrationTestshouldReportCorrectCommittedOffsetInformation-6889e6c9-c4fa-427c-83bf-469b33a34bb5-StreamThread-1] Handle &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; assignment with:
	New active tasks: []
	New standby tasks: []
	Existing active tasks: []
	Existing standby tasks: [] (org.apache.kafka.streams.processor.internals.TaskManager:263)
[2021-06-29 12:19:40,201] INFO stream-thread [TaskMetadataTest_TaskMetadataIntegrationTestshouldReportCorrectCommittedOffsetInformation-6889e6c9-c4fa-427c-83bf-469b33a34bb5-StreamThread-1] State transition from STARTING to PARTITIONS_ASSIGNED (org.apache.kafka.streams.processor.internals.StreamThread:229)
[2021-06-29 12:19:40,202] INFO stream-thread [TaskMetadataTest_TaskMetadataIntegrationTestshouldReportCorrectCommittedOffsetInformation-6889e6c9-c4fa-427c-83bf-469b33a34bb5-StreamThread-2] task [0_0] Suspended RUNNING (org.apache.kafka.streams.processor.internals.StreamTask:1187)
[2021-06-29 12:19:40,202] INFO stream-thread [TaskMetadataTest_TaskMetadataIntegrationTestshouldReportCorrectCommittedOffsetInformation-6889e6c9-c4fa-427c-83bf-469b33a34bb5-StreamThread-2] task [0_0] Suspended running (org.apache.kafka.streams.processor.internals.StreamTask:300)
[2021-06-29 12:19:40,202] INFO stream-thread [TaskMetadataTest_TaskMetadataIntegrationTestshouldReportCorrectCommittedOffsetInformation-6889e6c9-c4fa-427c-83bf-469b33a34bb5-StreamThread-2] partition revocation took 1 ms. (org.apache.kafka.streams.processor.internals.StreamThread:97)
[2021-06-29 12:19:40,202] INFO stream-thread [TaskMetadataTest_TaskMetadataIntegrationTestshouldReportCorrectCommittedOffsetInformation-6889e6c9-c4fa-427c-83bf-469b33a34bb5-StreamThread-2-consumer] No followup rebalance was requested, resetting the rebalance schedule. (org.apache.kafka.streams.processor.internals.StreamsPartitionAssignor:1306)
[2021-06-29 12:19:40,202] INFO stream-thread [TaskMetadataTest_TaskMetadataIntegrationTestshouldReportCorrectCommittedOffsetInformation-6889e6c9-c4fa-427c-83bf-469b33a34bb5-StreamThread-2] Handle &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; assignment with:
	New active tasks: []
	New standby tasks: []
	Existing active tasks: [0_0]
	Existing standby tasks: [] (org.apache.kafka.streams.processor.internals.TaskManager:263)
[2021-06-29 12:19:40,202] INFO stream-thread [TaskMetadataTest_TaskMetadataIntegrationTestshouldReportCorrectCommittedOffsetInformation-6889e6c9-c4fa-427c-83bf-469b33a34bb5-StreamThread-2] task [0_0] Closing record collector clean (org.apache.kafka.streams.processor.internals.RecordCollectorImpl:268)
[2021-06-29 12:19:40,202] INFO stream-thread [TaskMetadataTest_TaskMetadataIntegrationTestshouldReportCorrectCommittedOffsetInformation-6889e6c9-c4fa-427c-83bf-469b33a34bb5-StreamThread-2] task [0_0] Closed clean (org.apache.kafka.streams.processor.internals.StreamTask:524)
[2021-06-29 12:19:40,202] INFO stream-thread [TaskMetadataTest_TaskMetadataIntegrationTestshouldReportCorrectCommittedOffsetInformation-6889e6c9-c4fa-427c-83bf-469b33a34bb5-StreamThread-2] State transition from PARTITIONS_REVOKED to PARTITIONS_ASSIGNED (org.apache.kafka.streams.processor.internals.StreamThread:229)
[2021-06-29 12:19:40,203] INFO [GroupCoordinator 0]: Preparing to rebalance group TaskMetadataTest_TaskMetadataIntegrationTestshouldReportCorrectCommittedOffsetInformation in state PreparingRebalance with old generation 2 (__consumer_offsets-4) (reason: Leader TaskMetadataTest_TaskMetadataIntegrationTestshouldReportCorrectCommittedOffsetInformation-6889e6c9-c4fa-427c-83bf-469b33a34bb5-StreamThread-2-consumer-0a548162-9e3f-4003-98c5-54ece6f5e1b8 re-joining group during Stable) (kafka.coordinator.group.GroupCoordinator:66)
[2021-06-29 12:19:40,274] INFO stream-thread [TaskMetadataTest_TaskMetadataIntegrationTestshouldReportCorrectCommittedOffsetInformation-6889e6c9-c4fa-427c-83bf-469b33a34bb5-StreamThread-1] Restoration took 73 ms &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; all tasks [] (org.apache.kafka.streams.processor.internals.StreamThread:851)
[2021-06-29 12:19:40,274] INFO stream-thread [TaskMetadataTest_TaskMetadataIntegrationTestshouldReportCorrectCommittedOffsetInformation-6889e6c9-c4fa-427c-83bf-469b33a34bb5-StreamThread-1] State transition from PARTITIONS_ASSIGNED to RUNNING (org.apache.kafka.streams.processor.internals.StreamThread:229)
[2021-06-29 12:19:40,274] INFO stream-thread [TaskMetadataTest_TaskMetadataIntegrationTestshouldReportCorrectCommittedOffsetInformation-6889e6c9-c4fa-427c-83bf-469b33a34bb5-StreamThread-2] Restoration took 72 ms &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; all tasks [] (org.apache.kafka.streams.processor.internals.StreamThread:851)
[2021-06-29 12:19:40,274] INFO stream-thread [TaskMetadataTest_TaskMetadataIntegrationTestshouldReportCorrectCommittedOffsetInformation-6889e6c9-c4fa-427c-83bf-469b33a34bb5-StreamThread-2] State transition from PARTITIONS_ASSIGNED to RUNNING (org.apache.kafka.streams.processor.internals.StreamThread:229)
[2021-06-29 12:19:40,274] INFO stream-client [TaskMetadataTest_TaskMetadataIntegrationTestshouldReportCorrectCommittedOffsetInformation-6889e6c9-c4fa-427c-83bf-469b33a34bb5] State transition from REBALANCING to RUNNING (org.apache.kafka.streams.KafkaStreams:315)
[2021-06-29 12:19:40,274] INFO stream-thread [TaskMetadataTest_TaskMetadataIntegrationTestshouldReportCorrectCommittedOffsetInformation-6889e6c9-c4fa-427c-83bf-469b33a34bb5-StreamThread-1] Triggering the followup rebalance scheduled &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; 0 ms. (org.apache.kafka.streams.processor.internals.StreamThread:585)
[2021-06-29 12:19:40,274] INFO stream-client [TaskMetadataTest_TaskMetadataIntegrationTestshouldReportCorrectCommittedOffsetInformation-6889e6c9-c4fa-427c-83bf-469b33a34bb5] State transition from RUNNING to PENDING_SHUTDOWN (org.apache.kafka.streams.KafkaStreams:315)
[2021-06-29 12:19:40,275] INFO stream-thread [TaskMetadataTest_TaskMetadataIntegrationTestshouldReportCorrectCommittedOffsetInformation-6889e6c9-c4fa-427c-83bf-469b33a34bb5-StreamThread-1] Informed to shut down (org.apache.kafka.streams.processor.internals.StreamThread:1063)
[2021-06-29 12:19:40,275] INFO stream-thread [TaskMetadataTest_TaskMetadataIntegrationTestshouldReportCorr
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Especially this log message seems suspicious:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[2021-06-29 12:19:40,200] WARN [Consumer clientId=TaskMetadataTest_TaskMetadataIntegrationTestshouldReportCorrectCommittedOffsetInformation-6889e6c9-c4fa-427c-83bf-469b33a34bb5-StreamThread-2-consumer, groupId=TaskMetadataTest_TaskMetadataIntegrationTestshouldReportCorrectCommittedOffsetInformation] The following subscribed topics are not assigned to any members: [inputTaskMetadataIntegrationTestshouldReportCorrectCommittedOffsetInformation]  (org.apache.kafka.clients.consumer.internals.ConsumerCoordinator:611)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17380212" author="ableegoldman" created="Tue, 13 Jul 2021 22:34:59 +0000"  >&lt;p&gt;Failed again&#160;&lt;a href=&quot;https://ci-builds.apache.org/job/Kafka/job/kafka-pr/job/PR-10985/6/testReport/junit/org.apache.kafka.streams.integration/TaskMetadataIntegrationTest/Build___JDK_11_and_Scala_2_13___shouldReportCorrectCommittedOffsetInformation/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci-builds.apache.org/job/Kafka/job/kafka-pr/job/PR-10985/6/testReport/junit/org.apache.kafka.streams.integration/TaskMetadataIntegrationTest/Build___JDK_11_and_Scala_2_13___shouldReportCorrectCommittedOffsetInformation/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;FWIW I didn&apos;t see the above log message about that subscribed topic not being assigned to any members. The logs were truncated so it&apos;s possible that it actually was there, but I don&apos;t think that&apos;s the case since AFAICT the truncated logs are mostly from kafka/zookeeper. The relevant logs from the rebalance seem to be present&lt;/p&gt;</comment>
                            <comment id="17380444" author="cadonna" created="Wed, 14 Jul 2021 08:43:46 +0000"  >&lt;p&gt;For the future assignee of this ticket: I was able to reproduce this failure multiple times by running the test in IntelliJ in the until failure mode. It failed quite quickly after approx. 25 runs.&lt;/p&gt;</comment>
                            <comment id="17380838" author="ableegoldman" created="Wed, 14 Jul 2021 19:58:27 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wcarlson%40confluent.io&quot; class=&quot;user-hover&quot; rel=&quot;wcarlson@confluent.io&quot;&gt;wcarlson@confluent.io&lt;/a&gt; I&apos;m guessing you wrote this test so you have the most context, can you reproduce this locally and take a minute or two to look through the logs and see if anything jumps out at you?&#160;&lt;/p&gt;</comment>
                            <comment id="17380939" author="ableegoldman" created="Thu, 15 Jul 2021 01:55:57 +0000"  >&lt;p&gt;Not the exact same test, but I did manage to reproduce this same &quot;only one task&quot; failure in&#160;TaskMetadataIntegrationTest.shouldReportCorrectEndOffsetInformation:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.AssertionError: only one task
	at org.hamcrest.MatcherAssert.assertThat(MatcherAssert.java:26)
	at org.apache.kafka.streams.integration.TaskMetadataIntegrationTest.getTaskMetadata(TaskMetadataIntegrationTest.java:163)
	at org.apache.kafka.streams.integration.TaskMetadataIntegrationTest.shouldReportCorrectEndOffsetInformation(TaskMetadataIntegrationTest.java:144)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I saved the logs since they should actually be the full, un-truncated logs &#8211; hope this helps:&#160;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13030645/13030645_TaskMetadataIntegrationTest%23shouldReportCorrectEndOffsetInformation.rtf&quot; title=&quot;TaskMetadataIntegrationTest#shouldReportCorrectEndOffsetInformation.rtf attached to KAFKA-13010&quot;&gt;TaskMetadataIntegrationTest#shouldReportCorrectEndOffsetInformation.rtf&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="17383431" author="wcarlson5" created="Mon, 19 Jul 2021 16:12:32 +0000"  >&lt;p&gt;This failure should will effect both tests. When it is getting the task list it asserts that there is only one task in the very simple topology. I don&apos;t know if this is really a problem with the test or even the feature that the test is targeted at. It looks like the tasks created are not consistent. The task behavior might be intentional but I don&apos;t think so. I will see if I can reproduce and look at the logs.&lt;/p&gt;</comment>
                            <comment id="17383445" author="ableegoldman" created="Mon, 19 Jul 2021 16:43:21 +0000"  >&lt;p&gt;It&apos;s worth noting that this test seemed to be pretty stable for roughly a full release cycle, then started failing pretty frequently right after &lt;a href=&quot;https://cwiki.apache.org/confluence/display/KAFKA/KIP-744%3A+Migrate+TaskMetadata+and+ThreadMetadata+to+an+interface+with+internal+implementation&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;KIP-744&lt;/a&gt;&#160;/ &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-12849&quot; title=&quot;Consider migrating TaskMetadata to interface with internal implementation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-12849&quot;&gt;&lt;del&gt;KAFKA-12849&lt;/del&gt;&lt;/a&gt;&#160;was merged (June 25th). &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wcarlson5&quot; class=&quot;user-hover&quot; rel=&quot;wcarlson5&quot;&gt;wcarlson5&lt;/a&gt;&#160;I wonder if the changes to the metadata hierarchy could have introduced a potentially serious bug?&lt;/p&gt;</comment>
                            <comment id="17383474" author="wcarlson5" created="Mon, 19 Jul 2021 17:20:38 +0000"  >&lt;p&gt;It is possible &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ableegoldman&quot; class=&quot;user-hover&quot; rel=&quot;ableegoldman&quot;&gt;ableegoldman&lt;/a&gt; . I ran till failure (75 runs). And it seems that the metadata was reporting no tasks, so I would agree.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[ThreadMetadata{threadName=TaskMetadataTest_TaskMetadataIntegrationTestshouldReportCorrectCommittedOffsetInformation-c1a902ee-54b1-4b8e-a195-98d4a6143c1e-StreamThread-2, threadState=RUNNING, activeTasks=[], standbyTasks=[], consumerClientId=TaskMetadataTest_TaskMetadataIntegrationTestshouldReportCorrectCommittedOffsetInformation-c1a902ee-54b1-4b8e-a195-98d4a6143c1e-StreamThread-2-consumer, restoreConsumerClientId=TaskMetadataTest_TaskMetadataIntegrationTestshouldReportCorrectCommittedOffsetInformation-c1a902ee-54b1-4b8e-a195-98d4a6143c1e-StreamThread-2-restore-consumer, producerClientIds=[TaskMetadataTest_TaskMetadataIntegrationTestshouldReportCorrectCommittedOffsetInformation-c1a902ee-54b1-4b8e-a195-98d4a6143c1e-StreamThread-2-producer], adminClientId=TaskMetadataTest_TaskMetadataIntegrationTestshouldReportCorrectCommittedOffsetInformation-c1a902ee-54b1-4b8e-a195-98d4a6143c1e-admin}, ThreadMetadata{threadName=TaskMetadataTest_TaskMetadataIntegrationTestshouldReportCorrectCommittedOffsetInformation-c1a902ee-54b1-4b8e-a195-98d4a6143c1e-StreamThread-1, threadState=RUNNING, activeTasks=[], standbyTasks=[], consumerClientId=TaskMetadataTest_TaskMetadataIntegrationTestshouldReportCorrectCommittedOffsetInformation-c1a902ee-54b1-4b8e-a195-98d4a6143c1e-StreamThread-1-consumer, restoreConsumerClientId=TaskMetadataTest_TaskMetadataIntegrationTestshouldReportCorrectCommittedOffsetInformation-c1a902ee-54b1-4b8e-a195-98d4a6143c1e-StreamThread-1-restore-consumer, producerClientIds=[TaskMetadataTest_TaskMetadataIntegrationTestshouldReportCorrectCommittedOffsetInformation-c1a902ee-54b1-4b8e-a195-98d4a6143c1e-StreamThread-1-producer], adminClientId=TaskMetadataTest_TaskMetadataIntegrationTestshouldReportCorrectCommittedOffsetInformation-c1a902ee-54b1-4b8e-a195-98d4a6143c1e-admin}]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17383484" author="jlprat" created="Mon, 19 Jul 2021 17:55:36 +0000"  >&lt;p&gt;If it happened after KIP-744 probably I introduced the regression .&lt;/p&gt;

&lt;p&gt;I will also try to look if I can see where is the mistake. If I remember correctly, most of the code I wrote was just copied over from one place to another.&lt;/p&gt;</comment>
                            <comment id="17383504" author="ableegoldman" created="Mon, 19 Jul 2021 18:37:49 +0000"  >&lt;p&gt;Yeah it&apos;s honestly pretty hard to imagine how that could have introduced a bug like this, but the timing definitely is suspicious. Seeing as Walker was able to reproduce it after a &quot;reasonable&quot; number of retries, it should be easy to confirm the suspicion by just running the test again with sufficient repeats on the commit just before KIP-744 was merged.&lt;/p&gt;</comment>
                            <comment id="17383513" author="jlprat" created="Mon, 19 Jul 2021 18:54:02 +0000"  >&lt;p&gt;To add more to the mystery, I&apos;m running the test until failure and I&apos;m already over 250 repetitions and can&apos;t reproduce the bug (on a i7 CPU 4 cores, 8 threads).&lt;/p&gt;

&lt;p&gt;Maybe what I&apos;m about to say it&apos;s pretty obvious, but according to the logs you provide, it seems that when the test fails, TaskManager prints:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Handle &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; assignment with:
	New active tasks: []
	New standby tasks: []
	Existing active tasks: [0_0]
	Existing standby tasks: [] 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;instead of:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Handle &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; assignment with:
	New active tasks: [0_0]
	New standby tasks: []
	Existing active tasks: []
	Existing standby tasks: [] 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;(or at least it&apos;s what&apos;s been printed on my machine when test run successfully). Notice the &quot;0_0&quot; task being in the &quot;existing active tasks&quot; when failing instead of being in &quot;new active tasks&quot;.&lt;/p&gt;</comment>
                            <comment id="17383516" author="wcarlson5" created="Mon, 19 Jul 2021 18:58:42 +0000"  >&lt;p&gt;That does seem to be the case. I think somehow those &quot;existing active tasks&quot; are getting excluded from the `activeTasks()` list in the `ThreadMetadata`&lt;/p&gt;</comment>
                            <comment id="17383531" author="jlprat" created="Mon, 19 Jul 2021 19:26:39 +0000"  >&lt;p&gt;One thing that was modified under that PR that might cause some race conditions is the fact that StreamsMetadataImpl now saves all collections as immutable ones during creation instead of doing it inside the getters. Similar thing ThreadMetadataImpl that now saves producerClientIds as an immutable collection within the constructor.&lt;/p&gt;

&lt;p&gt;However, TaskMetadataImpl behaves the same in regards of immutable collections. I doubt it is related, but it&apos;s worth a shot.&lt;/p&gt;</comment>
                            <comment id="17383533" author="wcarlson5" created="Mon, 19 Jul 2021 19:30:44 +0000"  >&lt;p&gt;That sounds likely as the ThreadMetadata is retrieved using `metadataForLocalThreads()`&lt;/p&gt;</comment>
                            <comment id="17383537" author="jlprat" created="Mon, 19 Jul 2021 19:37:31 +0000"  >&lt;p&gt;If this is the reason why we are seeing this bug, by replacing line 60 in ThreadMetadataImpl the following might cause the test to not fail:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.producerClientIds = producerClientIds;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;As I can&apos;t reproduce the test locally would you be able to try this &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wcarlson5&quot; class=&quot;user-hover&quot; rel=&quot;wcarlson5&quot;&gt;wcarlson5&lt;/a&gt; ?&lt;/p&gt;</comment>
                            <comment id="17383553" author="wcarlson5" created="Mon, 19 Jul 2021 20:18:35 +0000"  >&lt;p&gt;it took about 126 runs but it still failed&lt;/p&gt;</comment>
                            <comment id="17383557" author="jlprat" created="Mon, 19 Jul 2021 20:25:49 +0000"  >&lt;p&gt;The only other difference left now is in StreamsMetadataImpl where the immutable collections were created within the getters instead of the constructor. A diff between StreamsMetadataImpl and the Deprecated StreamsMetadata class will show the places where it changed&lt;/p&gt;

&lt;p&gt;I guess it&apos;s another long shot&lt;/p&gt;</comment>
                            <comment id="17383560" author="wcarlson5" created="Mon, 19 Jul 2021 20:28:49 +0000"  >&lt;p&gt;This doesn&apos;t use the StreamsMetadata so I don&apos;t think that would be related&#160;&lt;/p&gt;</comment>
                            <comment id="17383564" author="jlprat" created="Mon, 19 Jul 2021 20:39:15 +0000"  >&lt;p&gt;I only mentioned because it seems to be the only other change in that PR that is not just moving implementations around.&lt;/p&gt;

&lt;p&gt;If you run the test before the KIP-744 changes were introduced, does it also fail after, let&apos;s say 200 iterations?&lt;/p&gt;</comment>
                            <comment id="17383620" author="wcarlson5" created="Mon, 19 Jul 2021 21:54:27 +0000"  >&lt;p&gt;I ran it for the commit before KIP-744 and it did fail. I am going to do a binary search from when the test was introduced to see where it started failing.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;EDIT: It looks like it always would fail eventually.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I am seeing if this is an error that will persist beyond one try&lt;/p&gt;</comment>
                            <comment id="17383653" author="wcarlson5" created="Mon, 19 Jul 2021 23:01:00 +0000"  >&lt;p&gt;It looks like the issue only shows up between cooperative rebalances and just retrying will fix it. I will make a PR with a fix shortly&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13395941">KAFKA-13215</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13395941">KAFKA-13215</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13030645" name="TaskMetadataIntegrationTest#shouldReportCorrectEndOffsetInformation.rtf" size="168361" author="ableegoldman" created="Thu, 15 Jul 2021 01:54:40 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 17 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0seqg:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>