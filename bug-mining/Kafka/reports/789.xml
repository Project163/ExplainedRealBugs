<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:45:01 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-2454] Dead lock between delete log segment and shutting down.</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-2454</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;When the broker shutdown, it will shutdown scheduler which grabs the scheduler lock then wait for all the threads in scheduler to shutdown.&lt;/p&gt;

&lt;p&gt;The dead lock will happen when the scheduled task try to delete old log segment, it will schedule a log delete task which also needs to acquire the scheduler lock. In this case the shutdown thread will hold scheduler lock and wait for the the log deletion thread to finish, but the log deletion thread will block on waiting for the scheduler lock.&lt;/p&gt;

&lt;p&gt;Related stack trace:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;&quot;Thread-1&quot; #21 prio=5 os_prio=0 tid=0x00007fe7601a7000 nid=0x1a4e waiting on condition [0x00007fe7cf698000]
   java.lang.Thread.State: TIMED_WAITING (parking)
        at sun.misc.Unsafe.park(Native Method)
        - parking to wait for  &amp;lt;0x0000000640d53540&amp;gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)
        at java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:215)
        at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.awaitNanos(AbstractQueuedSynchronizer.java:2078)
        at java.util.concurrent.ThreadPoolExecutor.awaitTermination(ThreadPoolExecutor.java:1465)
        at kafka.utils.KafkaScheduler.shutdown(KafkaScheduler.scala:94)
        - locked &amp;lt;0x0000000640b6d480&amp;gt; (a kafka.utils.KafkaScheduler)
        at kafka.server.KafkaServer$$anonfun$shutdown$4.apply$mcV$sp(KafkaServer.scala:352)
        at kafka.utils.CoreUtils$.swallow(CoreUtils.scala:79)
        at kafka.utils.Logging$class.swallowWarn(Logging.scala:92)
        at kafka.utils.CoreUtils$.swallowWarn(CoreUtils.scala:51)
        at kafka.utils.Logging$class.swallow(Logging.scala:94)
        at kafka.utils.CoreUtils$.swallow(CoreUtils.scala:51)
        at kafka.server.KafkaServer.shutdown(KafkaServer.scala:352)
        at kafka.server.KafkaServerStartable.shutdown(KafkaServerStartable.scala:42)
        at com.linkedin.kafka.KafkaServer.notifyShutdown(KafkaServer.java:99)
        at com.linkedin.util.factory.lifecycle.LifeCycleMgr.notifyShutdownListener(LifeCycleMgr.java:123)
        at com.linkedin.util.factory.lifecycle.LifeCycleMgr.notifyListeners(LifeCycleMgr.java:102)
        at com.linkedin.util.factory.lifecycle.LifeCycleMgr.notifyStop(LifeCycleMgr.java:82)
        - locked &amp;lt;0x0000000640b77bb0&amp;gt; (a java.util.ArrayDeque)
        at com.linkedin.util.factory.Generator.stop(Generator.java:177)
        - locked &amp;lt;0x0000000640b77bc8&amp;gt; (a java.lang.Object)
        at com.linkedin.offspring.servlet.OffspringServletRuntime.destroy(OffspringServletRuntime.java:82)
        at com.linkedin.offspring.servlet.OffspringServletContextListener.contextDestroyed(OffspringServletContextListener.java:51)
        at org.eclipse.jetty.server.handler.ContextHandler.doStop(ContextHandler.java:813)
        at org.eclipse.jetty.servlet.ServletContextHandler.doStop(ServletContextHandler.java:160)
        at org.eclipse.jetty.webapp.WebAppContext.doStop(WebAppContext.java:516)
        at com.linkedin.emweb.WebappContext.doStop(WebappContext.java:35)
        at org.eclipse.jetty.util.component.AbstractLifeCycle.stop(AbstractLifeCycle.java:89)
        - locked &amp;lt;0x00000006400018b8&amp;gt; (a java.lang.Object)
        at com.linkedin.emweb.ContextBasedHandlerImpl.doStop(ContextBasedHandlerImpl.java:112)
        at org.eclipse.jetty.util.component.AbstractLifeCycle.stop(AbstractLifeCycle.java:89)
        - locked &amp;lt;0x0000000640001900&amp;gt; (a java.lang.Object)
        at com.linkedin.emweb.WebappDeployerImpl.stop(WebappDeployerImpl.java:349)
        at com.linkedin.emweb.WebappDeployerImpl.doStop(WebappDeployerImpl.java:414)
        - locked &amp;lt;0x00000006400019c0&amp;gt; (a com.linkedin.emweb.MapBasedHandlerImpl)
        at org.eclipse.jetty.util.component.AbstractLifeCycle.stop(AbstractLifeCycle.java:89)
        - locked &amp;lt;0x00000006404ee8e8&amp;gt; (a java.lang.Object)
        at org.eclipse.jetty.util.component.AggregateLifeCycle.doStop(AggregateLifeCycle.java:107)
        at org.eclipse.jetty.server.handler.AbstractHandler.doStop(AbstractHandler.java:69)
        at org.eclipse.jetty.server.handler.HandlerWrapper.doStop(HandlerWrapper.java:108)
        at org.eclipse.jetty.server.Server.doStop(Server.java:338)
        at org.eclipse.jetty.util.component.AbstractLifeCycle.stop(AbstractLifeCycle.java:89)
        - locked &amp;lt;0x0000000640476ab0&amp;gt; (a java.lang.Object)
        at com.linkedin.emweb.BaseRunner.destroy(BaseRunner.java:162)
        at com.linkedin.spring.core.TerminationHandler.destroy(TerminationHandler.java:151)
        at com.linkedin.spring.core.TerminationHandler.runTermination(TerminationHandler.java:113)
        at com.linkedin.spring.core.TerminationHandler.destroy(TerminationHandler.java:79)
        at com.linkedin.spring.core.SettableFactoryBean.destroy(SettableFactoryBean.java:68)
        at org.springframework.beans.factory.support.DisposableBeanAdapter.destroy(DisposableBeanAdapter.java:211)
        at org.springframework.beans.factory.support.DefaultSingletonBeanRegistry.destroyBean(DefaultSingletonBeanRegistry.java:500)
        at org.springframework.beans.factory.support.DefaultSingletonBeanRegistry.destroySingleton(DefaultSingletonBeanRegistry.java:476)
        at org.springframework.beans.factory.support.DefaultSingletonBeanRegistry.destroySingletons(DefaultSingletonBeanRegistry.java:445)
        at org.springframework.context.support.AbstractApplicationContext.destroyBeans(AbstractApplicationContext.java:1078)
        at org.springframework.context.support.AbstractApplicationContext.doClose(AbstractApplicationContext.java:1052)
        at org.springframework.context.support.AbstractApplicationContext.close(AbstractApplicationContext.java:1000)
        - locked &amp;lt;0x000000064001c718&amp;gt; (a java.lang.Object)
        at com.linkedin.spring.cmdline.CmdLineAppRunner.terminate(CmdLineAppRunner.java:277)
        at com.linkedin.spring.cmdline.CmdLineAppRunner$1.run(CmdLineAppRunner.java:219)
...
&quot;kafka-scheduler-2&quot; #272 daemon prio=5 os_prio=0 tid=0x00007fecd58be000 nid=0x7868 waiting for monitor entry [0x00007feb991d4000]
   java.lang.Thread.State: BLOCKED (on object monitor)
        at kafka.utils.KafkaScheduler.schedule(KafkaScheduler.scala:103)
        - waiting to lock &amp;lt;0x0000000640b6d480&amp;gt; (a kafka.utils.KafkaScheduler)
        at kafka.log.Log.kafka$log$Log$$asyncDeleteSegment(Log.scala:789)
        at kafka.log.Log.kafka$log$Log$$deleteSegment(Log.scala:775)
        - locked &amp;lt;0x0000000641d18030&amp;gt; (a java.lang.Object)
        at kafka.log.Log$$anonfun$deleteOldSegments$1.apply(Log.scala:533)
        at kafka.log.Log$$anonfun$deleteOldSegments$1.apply(Log.scala:533)
        at scala.collection.immutable.List.foreach(List.scala:318)
        at kafka.log.Log.deleteOldSegments(Log.scala:533)
        - locked &amp;lt;0x0000000641d18030&amp;gt; (a java.lang.Object)
        at kafka.log.LogManager.kafka$log$LogManager$$cleanupExpiredSegments(LogManager.scala:421)
        at kafka.log.LogManager$$anonfun$cleanupLogs$3.apply(LogManager.scala:452)
        at kafka.log.LogManager$$anonfun$cleanupLogs$3.apply(LogManager.scala:450)
        at scala.collection.TraversableLike$WithFilter$$anonfun$foreach$1.apply(TraversableLike.scala:772)
        at scala.collection.Iterator$class.foreach(Iterator.scala:727)
        at scala.collection.AbstractIterator.foreach(Iterator.scala:1157)
        at scala.collection.IterableLike$class.foreach(IterableLike.scala:72)
        at scala.collection.AbstractIterable.foreach(Iterable.scala:54)
        at scala.collection.TraversableLike$WithFilter.foreach(TraversableLike.scala:771)
        at kafka.log.LogManager.cleanupLogs(LogManager.scala:450)
        at kafka.log.LogManager$$anonfun$startup$1.apply$mcV$sp(LogManager.scala:190)
        at kafka.utils.KafkaScheduler$$anonfun$1.apply$mcV$sp(KafkaScheduler.scala:108)
        at kafka.utils.CoreUtils$$anon$1.run(CoreUtils.scala:60)
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
        at java.util.concurrent.FutureTask.runAndReset(FutureTask.java:308)
        at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$301(ScheduledThreadPoolExecutor.java:180)
        at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:294)
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
        at java.lang.Thread.run(Thread.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12857598">KAFKA-2454</key>
            <summary>Dead lock between delete log segment and shutting down.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="becket_qin">Jiangjie Qin</assignee>
                                    <reporter username="becket_qin">Jiangjie Qin</reporter>
                        <labels>
                    </labels>
                <created>Thu, 20 Aug 2015 17:31:38 +0000</created>
                <updated>Wed, 21 Oct 2015 20:25:08 +0000</updated>
                            <resolved>Wed, 21 Oct 2015 20:25:08 +0000</resolved>
                                                    <fixVersion>0.9.0.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14705491" author="githubbot" created="Thu, 20 Aug 2015 18:23:24 +0000"  >&lt;p&gt;GitHub user becketqin opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/153&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/153&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-2454&quot; title=&quot;Dead lock between delete log segment and shutting down.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-2454&quot;&gt;&lt;del&gt;KAFKA-2454&lt;/del&gt;&lt;/a&gt;: Deadlock between log segment deletion and server shutdown.&lt;/p&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/becketqin/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/becketqin/kafka&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-2454&quot; title=&quot;Dead lock between delete log segment and shutting down.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-2454&quot;&gt;&lt;del&gt;KAFKA-2454&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/153.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/153.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #153&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 27c6a6e70f969ee13d857213d5a0aa3e40b1c19f&lt;br/&gt;
Author: Jiangjie Qin &amp;lt;becket.qin@gmail.com&amp;gt;&lt;br/&gt;
Date:   2015-08-20T18:21:32Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-2454&quot; title=&quot;Dead lock between delete log segment and shutting down.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-2454&quot;&gt;&lt;del&gt;KAFKA-2454&lt;/del&gt;&lt;/a&gt;: Deadlock between log segment deletion and server shutdown.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="14706019" author="jjkoshy" created="Fri, 21 Aug 2015 00:18:06 +0000"  >&lt;p&gt;I&apos;m a bit unclear on the root cause that you describe. The thread-dump shows that the deletion task has not even entered the executor at this point. It is definitely blocked on entering the executor, but that means &lt;tt&gt;executor.awaitTermination&lt;/tt&gt; must be from some other already executing task right?&lt;/p&gt;</comment>
                            <comment id="14706021" author="becket_qin" created="Fri, 21 Aug 2015 00:28:34 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jjkoshy&quot; class=&quot;user-hover&quot; rel=&quot;jjkoshy&quot;&gt;jjkoshy&lt;/a&gt; Here are the two threads:&lt;br/&gt;
Thread 1: The log deletion task that periodically running to delete log segments. This task has been scheduled when broker starts up. The problem is it is deleting log asynchronously by submitting another file deletion task to the scheduler. The deadlock happens here.&lt;br/&gt;
Thread 2: It is just the thread executing KafkaServer.shutdown(), it calls KafkaScheduler.shutdown() which grabs the lock and executor.awaitTermination().&lt;/p&gt;</comment>
                            <comment id="14707091" author="jjkoshy" created="Fri, 21 Aug 2015 17:32:02 +0000"  >&lt;p&gt;Thanks - got it. Will take a look at your patch today.&lt;/p&gt;</comment>
                            <comment id="14967809" author="githubbot" created="Wed, 21 Oct 2015 20:24:31 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/153&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/153&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14967813" author="jjkoshy" created="Wed, 21 Oct 2015 20:25:08 +0000"  >&lt;p&gt;Issue resolved by pull request 153&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/kafka/pull/153&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/153&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 4 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2j633:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>