<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:40:24 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-17410] Flaky test testPollThrowsInterruptExceptionIfInterrupted for new consumer</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-17410</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;KafkaConsumerTest.testPollThrowsInterruptExceptionIfInterrupted is flaky for the new consumer (passing consistently for the classic consumer).&lt;/p&gt;

&lt;p&gt;Fails with:&#160;&lt;/p&gt;

&lt;p&gt;org.opentest4j.AssertionFailedError: Expected org.apache.kafka.common.errors.InterruptException to be thrown, but nothing was thrown.&lt;/p&gt;

&lt;p&gt;It&apos;s been flaky since enabled for the new consumer recently&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://ge.apache.org/scans/tests?search.names=Git%20branch&amp;amp;search.rootProjectNames=kafka&amp;amp;search.startTimeMax=1724385599999&amp;amp;search.startTimeMin=1720065600000&amp;amp;search.timeZoneId=America%2FToronto&amp;amp;search.values=trunk&amp;amp;tests.container=org.apache.kafka.clients.consumer.KafkaConsumerTest&amp;amp;tests.test=testPollThrowsInterruptExceptionIfInterrupted(GroupProtocol)%5B2%5D.&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ge.apache.org/scans/tests?search.names=Git%20branch&amp;amp;search.rootProjectNames=kafka&amp;amp;search.startTimeMax=1724385599999&amp;amp;search.startTimeMin=1720065600000&amp;amp;search.timeZoneId=America%2FToronto&amp;amp;search.values=trunk&amp;amp;tests.container=org.apache.kafka.clients.consumer.KafkaConsumerTest&amp;amp;tests.test=testPollThrowsInterruptExceptionIfInterrupted(GroupProtocol)%5B2%5D&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Note that a very similar test already exist in AsyncKafkaConsumerTest.&lt;br/&gt;
testPollThrowsInterruptExceptionIfInterrupted, written specifically for the async consumer, and that passes consistently.&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13589824">KAFKA-17410</key>
            <summary>Flaky test testPollThrowsInterruptExceptionIfInterrupted for new consumer</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="frankvicky">TengYao Chi</assignee>
                                    <reporter username="lianetm">Lianet Magrans</reporter>
                        <labels>
                            <label>consumer-threading-refactor</label>
                            <label>flaky-test</label>
                    </labels>
                <created>Thu, 22 Aug 2024 22:10:35 +0000</created>
                <updated>Thu, 12 Sep 2024 10:41:43 +0000</updated>
                            <resolved>Thu, 12 Sep 2024 10:41:43 +0000</resolved>
                                                                    <component>clients</component>
                    <component>consumer</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17876142" author="JIRAUSER305181" created="Fri, 23 Aug 2024 00:32:12 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lianetm&quot; class=&quot;user-hover&quot; rel=&quot;lianetm&quot;&gt;lianetm&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;May I have this ticket and investigate?&lt;/p&gt;</comment>
                            <comment id="17876150" author="JIRAUSER300183" created="Fri, 23 Aug 2024 01:37:55 +0000"  >&lt;p&gt;Sure, assigned to you. Thanks!&lt;/p&gt;</comment>
                            <comment id="17876397" author="JIRAUSER305181" created="Sat, 24 Aug 2024 03:18:38 +0000"  >&lt;p&gt;Hello &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lianetm&quot; class=&quot;user-hover&quot; rel=&quot;lianetm&quot;&gt;lianetm&lt;/a&gt; ,&lt;/p&gt;

&lt;p&gt;I have reviewed the `testPollThrowsInterruptExceptionIfInterrupted` test case in both `KafkaConsumerTest` and `AsyncKafkaConsumerTest` classes.&lt;/p&gt;

&lt;p&gt;I found that these two classes throw exceptions at different points. &lt;br/&gt;
In `AsyncKafkaConsumerTest`, the `InterruptException` is thrown in the `pollForFetches` method. In `KafkaConsumerTest`, it is thrown in the `updateAssignmentMetadataIfNeeded` method.&lt;/p&gt;

&lt;p&gt;Normally, I would expect them to throw exceptions at the same point. However, in `AsyncKafkaConsumerTest`, the internal methods of `updateAssignmentMetadataIfNeeded` that might throw exceptions have been mocked.&lt;/p&gt;

&lt;p&gt;This discrepancy might be the cause of the flakiness in `KafkaConsumerTest#testPollThrowsInterruptExceptionIfInterrupted`.&lt;/p&gt;

&lt;p&gt;I am still investigating this issue, please let me know if you have any ideas.&lt;/p&gt;

&lt;p&gt;Many thanks &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="17878999" author="JIRAUSER300183" created="Tue, 3 Sep 2024 19:48:22 +0000"  >&lt;p&gt;Hey &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=frankvicky&quot; class=&quot;user-hover&quot; rel=&quot;frankvicky&quot;&gt;frankvicky&lt;/a&gt;, I would say it&apos;s expected and ok to see the interrupted coming from different places in both consumers, basically because their implementations are very different around this area. The new consumer has extensive use of futures and waits on them for results on the app thread, so basically whenever it hits one of those &quot;waits&quot; and the thread is interrupted, it will propagate the exception right there. The classic consumer is fundamentally different, as its does not have such same waits, and it&apos;s right after the client poll that it will maybeThrowInterruptException &lt;a href=&quot;https://github.com/apache/kafka/blob/b0d0956b20735575b7d4d870c2838912f4006940/clients/src/main/java/org/apache/kafka/clients/consumer/internals/ConsumerNetworkClient.java#L298&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/b0d0956b20735575b7d4d870c2838912f4006940/clients/src/main/java/org/apache/kafka/clients/consumer/internals/ConsumerNetworkClient.java#L298&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I wonder if the flakiness here was due to a gap in the addAndGet, and the future getting completed in-between the call the add, and the call to get? I ended up noticing and fixing that gap here &lt;a href=&quot;https://github.com/apache/kafka/blob/4c0d248b93bf295c5e6c9928b7870b04e4a699cd/clients/src/main/java/org/apache/kafka/clients/consumer/internals/events/ApplicationEventHandler.java#L114-L119&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/4c0d248b93bf295c5e6c9928b7870b04e4a699cd/clients/src/main/java/org/apache/kafka/clients/consumer/internals/events/ApplicationEventHandler.java#L114-L119&lt;/a&gt; , and seeing this issue now they seem related to me. What do you think? Worth maybe checking this test with the changes in that PR, to see if it&apos;s not flaky anymore? Hope it helps! sorry I had missed this comment earlier.&#160;&lt;/p&gt;</comment>
                            <comment id="17881034" author="JIRAUSER300183" created="Wed, 11 Sep 2024 15:53:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=frankvicky&quot; class=&quot;user-hover&quot; rel=&quot;frankvicky&quot;&gt;frankvicky&lt;/a&gt; this test is very noisy/flaky in trunk, and we already have coverage for the new consumer in AsyncKafkaConsumerTest.testPollThrowsInterruptExceptionIfInterrupted (passing consistently), so it would make sense to me to leave it running only for the classic consumer, what do you think?&#160;&lt;/p&gt;

&lt;p&gt;In parallel, given that we may have an idea of what could be behind the flakiness (but fix is in-flight), we can review it again once that fix goes in (jiras related already). Makes sense?&lt;/p&gt;

&lt;p&gt;If so, let me know if you have bandwidth for the PR just moving this back to the classic consumer, with the reference to the existing test for the new consumer. Happy to help with reviews. Thanks!&lt;/p&gt;</comment>
                            <comment id="17881040" author="JIRAUSER305181" created="Wed, 11 Sep 2024 16:14:20 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lianetm&quot; class=&quot;user-hover&quot; rel=&quot;lianetm&quot;&gt;lianetm&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;Apologies for the late response. Sadly, I still haven&#8217;t been able to reproduce the bug on my machine, despite trying every tricks I know. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/tongue.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Given the situation, your suggestion makes sense to me. I&#8217;ll go ahead and file a PR to disable this test for the AsyncConsumer.&#160;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13584547">KAFKA-17066</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 8 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1r114:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>lianetm</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>