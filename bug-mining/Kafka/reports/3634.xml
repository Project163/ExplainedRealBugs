<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:37:07 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-16017] Checkpointed offset is incorrect when task is revived and restoring </title>
                <link>https://issues.apache.org/jira/browse/KAFKA-16017</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Streams checkpoints the wrong offset when a task is revived after a &lt;tt&gt;TaskCorruptedException&lt;/tt&gt; and the task is then migrated to another stream thread during restoration.&lt;/p&gt;

&lt;p&gt;This might happen in a situation like the following if the Streams application runs under EOS:&lt;/p&gt;

&lt;p&gt;1. Streams encounters a Network error which triggers a &lt;tt&gt;TaskCorruptedException&lt;/tt&gt;&lt;br/&gt;
2. The task that encountered the exception is closed dirty and revived. The state store directory is wiped out and a rebalance is triggered.&lt;br/&gt;
3. Until the sync of the rebalance is received the revived task is restoring.&lt;br/&gt;
4. When the sync is received the revived task is revoked and a new rebalance is triggered. During the revocation the task is closed cleanly and a checkpoint file is written.&lt;br/&gt;
5. With the next rebalance the task moves back to stream thread from which it was revoked, read the checkpoint and starts restoring. (I might be enough if the task moves to a stream thread on the same Streams client that shares the same state directory).&lt;br/&gt;
6. The state of the task misses some records&lt;/p&gt;

&lt;p&gt;To mitigate the issue one can restart the the stream thread and delete of the state on disk. After that the state restores completely from the changelog topic and the state does not miss any records anymore.&lt;/p&gt;

&lt;p&gt;The root cause is that the checkpoint that is written in step 4 contains the offset that the record collector stored when it sent the records to the changelog topic. However, since in step 2 the state directory is wiped out, the state does not contain those records anymore. It only contains the records that it restored in step 3 which might be less. The root cause of this is that the offsets in the record collector are not cleaned up when the record collector is closed. &lt;/p&gt;

&lt;p&gt;I created a repro under &lt;a href=&quot;https://github.com/cadonna/kafka/tree/KAFKA-16017&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/cadonna/kafka/tree/KAFKA-16017&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;The repro can be started with&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
./gradlew streams:test -x checkstyleMain -x checkstyleTest -x spotbugsMain -x spotbugsTest --tests RestoreIntegrationTest.test --info &amp;gt; test.log
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The repro writes records into a state store and tries to retrieve them again (&lt;a href=&quot;https://github.com/cadonna/kafka/blob/355bdfe33df403e73deaac0918aae7d2c736342c/streams/src/test/java/org/apache/kafka/streams/integration/RestoreIntegrationTest.java#L582&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/cadonna/kafka/blob/355bdfe33df403e73deaac0918aae7d2c736342c/streams/src/test/java/org/apache/kafka/streams/integration/RestoreIntegrationTest.java#L582&lt;/a&gt;). It will throw an &lt;tt&gt;IllegalStateException&lt;/tt&gt; if it cannot find a record in the state (&lt;a href=&quot;https://github.com/cadonna/kafka/blob/355bdfe33df403e73deaac0918aae7d2c736342c/streams/src/test/java/org/apache/kafka/streams/integration/RestoreIntegrationTest.java#L594&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/cadonna/kafka/blob/355bdfe33df403e73deaac0918aae7d2c736342c/streams/src/test/java/org/apache/kafka/streams/integration/RestoreIntegrationTest.java#L594&lt;/a&gt;). Once the offsets in the record collector are cleared on close (&lt;a href=&quot;https://github.com/cadonna/kafka/blob/355bdfe33df403e73deaac0918aae7d2c736342c/streams/src/main/java/org/apache/kafka/streams/processor/internals/RecordCollectorImpl.java#L332&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/cadonna/kafka/blob/355bdfe33df403e73deaac0918aae7d2c736342c/streams/src/main/java/org/apache/kafka/streams/processor/internals/RecordCollectorImpl.java#L332&lt;/a&gt; and &lt;a href=&quot;https://github.com/cadonna/kafka/blob/355bdfe33df403e73deaac0918aae7d2c736342c/streams/src/main/java/org/apache/kafka/streams/processor/internals/RecordCollectorImpl.java#L349&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/cadonna/kafka/blob/355bdfe33df403e73deaac0918aae7d2c736342c/streams/src/main/java/org/apache/kafka/streams/processor/internals/RecordCollectorImpl.java#L349&lt;/a&gt;), the &lt;tt&gt;IllegalStateException&lt;/tt&gt; does not occur anymore.&lt;/p&gt;

&lt;p&gt;In the logs you can check for &lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;tt&gt;Restore batch end offset is&lt;/tt&gt; which are the restored offsets in the state.&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;task &lt;span class=&quot;error&quot;&gt;&amp;#91;0_1&amp;#93;&lt;/span&gt; Writing checkpoint:&lt;/tt&gt; which are the written checkpoints.&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;task &lt;span class=&quot;error&quot;&gt;&amp;#91;0_1&amp;#93;&lt;/span&gt; Checkpointable offsets&lt;/tt&gt; which show the offsets coming from the sending records to the changelog topic &lt;tt&gt;RestoreIntegrationTesttest-stateStore-changelog-1&lt;/tt&gt;&lt;br/&gt;
Always the last instances of these before the &lt;tt&gt;IllegalStateException&lt;/tt&gt; is thrown.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;You will see that the restored offsets are less than the offsets that are written to the checkpoint. The offsets written to the checkpoint come from the offsets stored when sending the records to the changelog topic.  &lt;/p&gt;
</description>
                <environment></environment>
        <key id="13562001">KAFKA-16017</key>
            <summary>Checkpointed offset is incorrect when task is revived and restoring </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cadonna">Bruno Cadonna</assignee>
                                    <reporter username="cadonna">Bruno Cadonna</reporter>
                        <labels>
                    </labels>
                <created>Fri, 15 Dec 2023 14:10:32 +0000</created>
                <updated>Mon, 29 Jan 2024 08:34:46 +0000</updated>
                            <resolved>Thu, 21 Dec 2023 11:59:03 +0000</resolved>
                                    <version>3.3.1</version>
                                    <fixVersion>3.4.2</fixVersion>
                    <fixVersion>3.5.3</fixVersion>
                    <fixVersion>3.6.2</fixVersion>
                    <fixVersion>3.7.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                        <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 47 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1mafk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>