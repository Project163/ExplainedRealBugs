<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:58:48 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-4576] Log segments close to max size break on fetch</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-4576</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;We are running Kafka 0.10.1.1~rc1 (it&apos;s the same as 0.10.1.1).&lt;/p&gt;

&lt;p&gt;Max segment size is set to 2147483647 globally, that&apos;s 1 byte less than max signed int32.&lt;/p&gt;

&lt;p&gt;Every now and then we see failures like this:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Dec 25 18:20:47 myhost kafka-run-class.sh[2054]: ERROR [Replica Manager on Broker 1006]: Error processing fetch operation on partition [mytopic,11], offset 483579108587 (kafka.server.ReplicaManager)
Dec 25 18:20:47 myhost kafka-run-class.sh[2054]: java.lang.IllegalStateException: Failed to read complete buffer for targetOffset 483686627237 startPosition 2145701130 in /disk/data0/kafka-logs/mytopic-11/00000000483571890786.log
Dec 25 18:20:47 myhost kafka-run-class.sh[2054]:         at kafka.log.FileMessageSet.searchForOffsetWithSize(FileMessageSet.scala:145)
Dec 25 18:20:47 myhost kafka-run-class.sh[2054]:         at kafka.log.LogSegment.translateOffset(LogSegment.scala:128)
Dec 25 18:20:47 myhost kafka-run-class.sh[2054]:         at kafka.log.LogSegment.read(LogSegment.scala:180)
Dec 25 18:20:47 myhost kafka-run-class.sh[2054]:         at kafka.log.Log.read(Log.scala:563)
Dec 25 18:20:47 myhost kafka-run-class.sh[2054]:         at kafka.server.ReplicaManager.kafka$server$ReplicaManager$$read$1(ReplicaManager.scala:567)
Dec 25 18:20:47 myhost kafka-run-class.sh[2054]:         at kafka.server.ReplicaManager$$anonfun$readFromLocalLog$1.apply(ReplicaManager.scala:606)
Dec 25 18:20:47 myhost kafka-run-class.sh[2054]:         at kafka.server.ReplicaManager$$anonfun$readFromLocalLog$1.apply(ReplicaManager.scala:605)
Dec 25 18:20:47 myhost kafka-run-class.sh[2054]:         at scala.collection.Iterator$class.foreach(Iterator.scala:893)
Dec 25 18:20:47 myhost kafka-run-class.sh[2054]:         at scala.collection.AbstractIterator.foreach(Iterator.scala:1336)
Dec 25 18:20:47 myhost kafka-run-class.sh[2054]:         at scala.collection.IterableLike$class.foreach(IterableLike.scala:72)
Dec 25 18:20:47 myhost kafka-run-class.sh[2054]:         at scala.collection.AbstractIterable.foreach(Iterable.scala:54)
Dec 25 18:20:47 myhost kafka-run-class.sh[2054]:         at kafka.server.ReplicaManager.readFromLocalLog(ReplicaManager.scala:605)
Dec 25 18:20:47 myhost kafka-run-class.sh[2054]:         at kafka.server.ReplicaManager.fetchMessages(ReplicaManager.scala:469)
Dec 25 18:20:47 myhost kafka-run-class.sh[2054]:         at kafka.server.KafkaApis.handleFetchRequest(KafkaApis.scala:534)
Dec 25 18:20:47 myhost kafka-run-class.sh[2054]:         at kafka.server.KafkaApis.handle(KafkaApis.scala:79)
Dec 25 18:20:47 myhost kafka-run-class.sh[2054]:         at kafka.server.KafkaRequestHandler.run(KafkaRequestHandler.scala:60)
Dec 25 18:20:47 myhost kafka-run-class.sh[2054]:         at java.lang.Thread.run(Thread.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;...
-rw-r--r-- 1 kafka kafka          0 Dec 25 15:15 00000000483557418204.timeindex
-rw-r--r-- 1 kafka kafka       9496 Dec 25 15:26 00000000483564654488.index
-rw-r--r-- 1 kafka kafka 2145763964 Dec 25 15:26 00000000483564654488.log
-rw-r--r-- 1 kafka kafka          0 Dec 25 15:26 00000000483564654488.timeindex
-rw-r--r-- 1 kafka kafka       9576 Dec 25 15:37 00000000483571890786.index
-rw-r--r-- 1 kafka kafka 2147483644 Dec 25 15:37 00000000483571890786.log
-rw-r--r-- 1 kafka kafka          0 Dec 25 15:37 00000000483571890786.timeindex
-rw-r--r-- 1 kafka kafka       9568 Dec 25 15:48 00000000483579135712.index
-rw-r--r-- 1 kafka kafka 2146791360 Dec 25 15:48 00000000483579135712.log
-rw-r--r-- 1 kafka kafka          0 Dec 25 15:48 00000000483579135712.timeindex
-rw-r--r-- 1 kafka kafka       9408 Dec 25 15:59 00000000483586374164.index
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Here 00000000483571890786.log is just 3 bytes below the max size.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13031329">KAFKA-4576</key>
            <summary>Log segments close to max size break on fetch</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="huxi_2b">huxihx</assignee>
                                    <reporter username="bobrik">Ivan Babrou</reporter>
                        <labels>
                            <label>reliability</label>
                    </labels>
                <created>Fri, 30 Dec 2016 18:11:56 +0000</created>
                <updated>Tue, 24 Jan 2017 11:02:56 +0000</updated>
                            <resolved>Tue, 24 Jan 2017 11:02:56 +0000</resolved>
                                    <version>0.10.1.1</version>
                                    <fixVersion>0.10.2.0</fixVersion>
                                    <component>log</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15794042" author="huxi_2b" created="Tue, 3 Jan 2017 03:45:55 +0000"  >&lt;p&gt;Seems FileChannel.read does not fill up the 12-byte buffer although there are enough bytes to read.&lt;/p&gt;

&lt;p&gt;The javadoc does not exactly specify how many bytes the buffer will be filled in. In practice, we are likely to always get a full buffer when using FileChannel, but actually Java does not make a guarantee about that. Instead, it depends on the OS implementation.&lt;/p&gt;

&lt;p&gt;Maybe we should use a while loop to make sure 12 bytes have been filled into the buffer without violating the corner case check. Does it make sense? &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ijuma&quot; class=&quot;user-hover&quot; rel=&quot;ijuma&quot;&gt;ijuma&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=becket_qin&quot; class=&quot;user-hover&quot; rel=&quot;becket_qin&quot;&gt;becket_qin&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15794567" author="onurkaraman" created="Tue, 3 Jan 2017 09:04:14 +0000"  >&lt;p&gt;I think you&apos;re right, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=huxi_2b&quot; class=&quot;user-hover&quot; rel=&quot;huxi_2b&quot;&gt;huxi_2b&lt;/a&gt;. It looks like we incorrectly assume &quot;FileChannel.read&quot; does the full read all throughout the FileMessageSet class.&lt;/p&gt;</comment>
                            <comment id="15794645" author="ijuma" created="Tue, 3 Jan 2017 09:43:46 +0000"  >&lt;p&gt;Great catch &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=huxi_2b&quot; class=&quot;user-hover&quot; rel=&quot;huxi_2b&quot;&gt;huxi_2b&lt;/a&gt;. The code in trunk has changed a lot and it should be easier to fix it as we have less direct calls to `FileChannel.read`. So, we&apos;ll probably need 2 different PRs if we want to fix the 0.10.1 branch as well. I suggest starting with trunk and then we can consider the backport. I suggest introducing an utility method `readFully` and use that from all places that we expect `FileChannel.read` to fill the buffer.&lt;/p&gt;</comment>
                            <comment id="15795040" author="huxi_2b" created="Tue, 3 Jan 2017 13:14:47 +0000"  >&lt;p&gt;If we use a loop structure to collect all the 12 bytes, there is a possibility that the loop never gets exited which otherwise is a very very rare situation.  Should we handle such situation if we decide to employ the loop?&lt;/p&gt;</comment>
                            <comment id="15795130" author="ijuma" created="Tue, 3 Jan 2017 14:03:13 +0000"  >&lt;p&gt;In theory, we should eventually reach the end of the file, read the 12 bytes or get some IO error. Network file systems could complicate things, but if we can&apos;t read from disk, there&apos;s not much we can do. `MemoryRecords.writeFullyTo` already includes a loop for the write side, so it should be fine to do it for the read side too.&lt;/p&gt;</comment>
                            <comment id="15836012" author="ijuma" created="Tue, 24 Jan 2017 11:02:56 +0000"  >&lt;p&gt;Issue resolved by pull request 2304&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/kafka/pull/2304&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2304&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 43 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3859r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>ijuma</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>