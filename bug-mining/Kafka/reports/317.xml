<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:38:43 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-999] Controlled shutdown never succeeds until the broker is killed</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-999</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;A race condition in the way leader and isr request is handled by the broker and controlled shutdown can lead to a situation where controlled shutdown can never succeed and the only way to bounce the broker is to kill it.&lt;/p&gt;

&lt;p&gt;The root cause is that broker uses a smart to avoid fetching from a leader that is not alive according to the controller. This leads to the broker aborting a become follower request. And in cases where replication factor is 2, the leader can never be transferred to a follower since it keeps rejecting the become follower request and stays out of the ISR. This causes controlled shutdown to fail forever&lt;/p&gt;

&lt;p&gt;One sequence of events that led to this bug is as follows -&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Broker 2 is leader and controller&lt;/li&gt;
	&lt;li&gt;Broker 2 is bounced (uncontrolled shutdown)&lt;/li&gt;
	&lt;li&gt;Controller fails over&lt;/li&gt;
	&lt;li&gt;Controlled shutdown is invoked on broker 1&lt;/li&gt;
	&lt;li&gt;Controller starts leader election for partitions that broker 2 led&lt;/li&gt;
	&lt;li&gt;Controller sends become follower request with leader as broker 1 to broker 2. At the same time, it does not include broker 1 in alive broker list sent as part of leader and isr request&lt;/li&gt;
	&lt;li&gt;Broker 2 rejects leaderAndIsr request since leader is not in the list of alive brokers&lt;/li&gt;
	&lt;li&gt;Broker 1 fails to transfer leadership to broker 2 since broker 2 is not in ISR&lt;/li&gt;
	&lt;li&gt;Controlled shutdown can never succeed on broker 1&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Since controlled shutdown is a config option, if there are bugs in controlled shutdown, there is no option but to kill the broker&lt;/p&gt;</description>
                <environment></environment>
        <key id="12661600">KAFKA-999</key>
            <summary>Controlled shutdown never succeeds until the broker is killed</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="swapnilghike">Swapnil Ghike</assignee>
                                    <reporter username="nehanarkhede">Neha Narkhede</reporter>
                        <labels>
                    </labels>
                <created>Sun, 4 Aug 2013 15:35:56 +0000</created>
                <updated>Wed, 7 Aug 2013 03:42:38 +0000</updated>
                            <resolved>Wed, 7 Aug 2013 03:42:38 +0000</resolved>
                                    <version>0.8.0</version>
                                                    <component>controller</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13729864" author="nehanarkhede" created="Mon, 5 Aug 2013 19:45:20 +0000"  >&lt;p&gt;I think the fix is to remove the smart in the broker&apos;s handling of a become follower request. Even if the leader is not alive, it should depend on the controller to send it another LeaderAndIsrRequest to connect to some other leader or to become a leader itself.&lt;/p&gt;</comment>
                            <comment id="13729869" author="sriramsub" created="Mon, 5 Aug 2013 19:48:30 +0000"  >&lt;p&gt;+1 on the proposed fix. Also this could happen only if the retry attempt is infinite.&lt;/p&gt;</comment>
                            <comment id="13730243" author="swapnilghike" created="Tue, 6 Aug 2013 01:16:46 +0000"  >&lt;p&gt;I think the right fix would be to undo any changes made to controllerContext during shutdownBroker() if the shutdown attempt failed on the controller. If the shutdown attempt failed, the controller&apos;s state should be equivalent to the state it would be in if the shutdown attempt was never made.&lt;/p&gt;

&lt;p&gt;In this case, it would mean removing broker 1 which is being shut down from controllerContext.shuttingDownBrokerIds set if a shutdown attempt failed. Thus, when the controller is sending out leaderAndIsr requests after broker 2 comes up, it will include broker 1 in the alive brokers.&lt;/p&gt;

&lt;p&gt;As far as dumbing down the broker is concerned to make it accept whatever controller says, I don&apos;t have a strong feeling. As Neha described, it will also resolve this ticket. However, doing only that and not fixing KafkaController.shutdownBroker() will hide an underlying bug - the controller had sent prematurely optimized information to broker 2 (the broker 1 was not dead, but the controller thought it will soon be dead, so why include it in alive leaders anyways).&lt;/p&gt;

&lt;p&gt;I also think it&apos;s ok for the broker to be a bit intelligent. As such, become-follower operation starts a thread that fetches from the leader. This fetching is a peer-to-peer action, so I don&apos;t see anything wrong with a broker being able to decide whether it wants to fetch or not.&lt;/p&gt;

&lt;p&gt;What do you think?&lt;/p&gt;</comment>
                            <comment id="13730294" author="nehanarkhede" created="Tue, 6 Aug 2013 03:02:48 +0000"  >&lt;p&gt;Sriram, Ack you are right. Forgot to mention that caveat in the bug description.&lt;/p&gt;

&lt;p&gt;Swapnil,&lt;/p&gt;

&lt;p&gt;The problem with undoing changes to controllerContext and removing the broker if the controlled shutdown request failed, is that there is a risk of mistakenly moving leaders to that broker. The reason is because even if the controlled shutdown attempt failed, it goes ahead with an uncontrolled shutdown. In that case, there is no value to letting it become a leader for more partitions since the point of controlled shutdown is to move existing leaders off.&lt;/p&gt;

&lt;p&gt;Split brain is always a problem that is both dangerous and causes unnecessary failures (e.g. consumer rebalancing). The purpose of a controller in Kafka is to be the only brain in the cluster and make state change decisions based on a single global view of the system. In this case, even if we keep the extra check on the broker, the leader can fail immediately after the if statement succeeds. So that check doesn&apos;t help anyways (Jun had pointed that out to me in the past, but I wasn&apos;t convinced back then &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; ). Also, even if the leader fails, the broker should depend on the controller to do the right thing and send another leader and isr request with a new leader. That way any changes to the controller logic (new features like controlled shutdown) will not cause unexpected side effects such as this bug.&lt;/p&gt;</comment>
                            <comment id="13730331" author="swapnilghike" created="Tue, 6 Aug 2013 04:35:37 +0000"  >&lt;p&gt;I see your points. After thinking a bit about the controlled shutdown --&amp;gt; uncontrolled shutdown scenario, your comments make sense.&lt;/p&gt;

&lt;p&gt;However controller passing live brokers minus shutting down brokers as live leaders in the LeaderAndIsrRequest sounds like a premature optimization and a bug. The check on the broker to not check live leaders will allow the broker to circumvent it.&lt;/p&gt;

&lt;p&gt;But, the good news is that after we make the fix you proposed for broker&apos;s handling of LeaderAndIsrRequest, LeaderAndIsrRequest does not need to contain aliveLeaders. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; So deleting that field automatically solves my concern. &lt;/p&gt;</comment>
                            <comment id="13730340" author="nehanarkhede" created="Tue, 6 Aug 2013 04:43:19 +0000"  >&lt;p&gt;&amp;gt;&amp;gt; However controller passing live brokers minus shutting down brokers as live leaders in the LeaderAndIsrRequest sounds like a premature optimization and a bug&lt;/p&gt;

&lt;p&gt;Well, the field is not required only after this JIRA is fixed, but there is no bug in the field. Like I explained above, live leaders cannot include the broker being shut down, so the controller passes accurate information to the broker. The bug is in the way the broker uses that field.&lt;/p&gt;

&lt;p&gt;Deleting the field in the future is a good idea. However, it is a change in wire protocol, so I suggest we file that JIRA and handle that part on trunk.&lt;/p&gt;</comment>
                            <comment id="13730348" author="swapnilghike" created="Tue, 6 Aug 2013 04:55:52 +0000"  >&lt;p&gt;Perhaps the word live misled me. Thanks for the clarifications, filed &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-1002&quot; title=&quot;Delete aliveLeaders field from LeaderAndIsrRequest&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-1002&quot;&gt;&lt;del&gt;KAFKA-1002&lt;/del&gt;&lt;/a&gt; to delete the field.&lt;/p&gt;</comment>
                            <comment id="13730439" author="swapnilghike" created="Tue, 6 Aug 2013 06:46:43 +0000"  >&lt;p&gt;Since we need leader broker&apos;s host:port to create ReplicaFetcherThread, the easiest fix for this ticket&apos;s purpose seems to be to pass all leaders through LeaderAndIsrRequest:&lt;/p&gt;

&lt;p&gt;val leaders = liveOrShuttingDownBrokers.filter(b =&amp;gt; leaderIds.contains(b.id))&lt;br/&gt;
val leaderAndIsrRequest = new LeaderAndIsrRequest(partitionStateInfos, leaders, controllerId, controllerEpoch, correlationId, clientId)&lt;/p&gt;

&lt;p&gt;Any suggestions on avoiding a wire protocol change?&lt;/p&gt;</comment>
                            <comment id="13731304" author="swapnilghike" created="Tue, 6 Aug 2013 21:34:33 +0000"  >&lt;p&gt;Small-scale fix for 0.8. &lt;/p&gt;</comment>
                            <comment id="13731427" author="nehanarkhede" created="Tue, 6 Aug 2013 23:15:19 +0000"  >&lt;p&gt;Thanks for the patch Swapnil. Overall, well thought through. Few minor comments -&lt;/p&gt;

&lt;p&gt;1. ControllerChannelManager&lt;/p&gt;

&lt;p&gt;leaderIds is not used anymore&lt;/p&gt;

&lt;p&gt;2. LeaderAndIsrRequest&lt;/p&gt;

&lt;p&gt;The field actually means all the brokers in the cluster. So can we rename it from leaders to allBrokers?&lt;br/&gt;
Same for Partition.scala and ReplicaManager.scala&lt;/p&gt;</comment>
                            <comment id="13731442" author="swapnilghike" created="Tue, 6 Aug 2013 23:25:55 +0000"  >&lt;p&gt;Thanks for pointing that out. Actually in ControllerChannelManager, we should rather pass liveOrShuttingDownBroker.filter(b =&amp;gt; leaderIds.contains(b.id)) as the leaders to LeaderAndIsrRequest.&lt;/p&gt;

&lt;p&gt;Attached patch v2.&lt;/p&gt;</comment>
                            <comment id="13731443" author="swapnilghike" created="Tue, 6 Aug 2013 23:28:34 +0000"  >&lt;p&gt;Renamed to leaders at one another place.&lt;/p&gt;</comment>
                            <comment id="13731608" author="nehanarkhede" created="Wed, 7 Aug 2013 03:41:17 +0000"  >&lt;p&gt;+1 on v3. &lt;/p&gt;</comment>
                            <comment id="13731609" author="nehanarkhede" created="Wed, 7 Aug 2013 03:42:38 +0000"  >&lt;p&gt;Committed v3 to 0.8&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12596431" name="kafka-999-v1.patch" size="13701" author="swapnilghike" created="Tue, 6 Aug 2013 21:35:40 +0000"/>
                            <attachment id="12596451" name="kafka-999-v2.patch" size="13711" author="swapnilghike" created="Tue, 6 Aug 2013 23:25:55 +0000"/>
                            <attachment id="12596460" name="kafka-999-v3.patch" size="14165" author="swapnilghike" created="Wed, 7 Aug 2013 00:02:19 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>341789</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 15 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1my1z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>342095</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>