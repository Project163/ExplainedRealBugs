<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:29:40 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-13435] Static membership protocol should let the leader skip assignment (KIP-814)</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-13435</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;When using consumer groups with static membership, if the consumer marked as leader has restarted, then metadata changes such as partition increase are not triggering expected rebalances.&lt;/p&gt;

&lt;p&gt;To reproduce this issue, simply:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Create a static consumer subscribed to a single topic&lt;/li&gt;
	&lt;li&gt;Close the consumer and create a new one with the same group instance id&lt;/li&gt;
	&lt;li&gt;Increase partitions for the topic&lt;/li&gt;
	&lt;li&gt;Observe that no rebalance occurs and the new partitions are not assigned&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;I have only tested this in 2.7, but it may apply to newer versions as well.&lt;/p&gt;
&lt;h3&gt;&lt;a name=&quot;Analysis&quot;&gt;&lt;/a&gt;Analysis&lt;/h3&gt;

&lt;p&gt;In &lt;em&gt;ConsumerCoordinator&lt;/em&gt;, one responsibility of the leader consumer is to track metadata and trigger a rebalance if there are changes such as new partitions added:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/kafka/blob/43bcc5682da82a602a4c0a000dc7433d0507b450/clients/src/main/java/org/apache/kafka/clients/consumer/internals/ConsumerCoordinator.java#L793&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/43bcc5682da82a602a4c0a000dc7433d0507b450/clients/src/main/java/org/apache/kafka/clients/consumer/internals/ConsumerCoordinator.java#L793&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (assignmentSnapshot != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; !assignmentSnapshot.matches(metadataSnapshot)) {
    ...
    requestRejoinIfNecessary(reason);
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Note that&#160;&lt;em&gt;assignmentSnapshot&lt;/em&gt; is currently only set if the consumer is the leader:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/kafka/blob/43bcc5682da82a602a4c0a000dc7433d0507b450/clients/src/main/java/org/apache/kafka/clients/consumer/internals/ConsumerCoordinator.java#L353&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/43bcc5682da82a602a4c0a000dc7433d0507b450/clients/src/main/java/org/apache/kafka/clients/consumer/internals/ConsumerCoordinator.java#L353&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// Only the leader is responsible &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; monitoring &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; metadata changes (i.e. partition changes)
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!isLeader)
    assignmentSnapshot = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;And &lt;em&gt;isLeader&lt;/em&gt; is only true after an assignment is performed during a rebalance:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/kafka/blob/43bcc5682da82a602a4c0a000dc7433d0507b450/clients/src/main/java/org/apache/kafka/clients/consumer/internals/ConsumerCoordinator.java#L634&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/43bcc5682da82a602a4c0a000dc7433d0507b450/clients/src/main/java/org/apache/kafka/clients/consumer/internals/ConsumerCoordinator.java#L634&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;That is, when a consumer group forms, exactly one consumer in the group should have&#160;&lt;em&gt;isLeader == True&lt;/em&gt; and be responsible for triggering rebalances on metadata changes.&lt;/p&gt;

&lt;p&gt;However, in the case of static membership, if the leader has been restarted and rejoined the group, the group essentially no longer has a current leader. Even though the metadata changes are fetched, no rebalance will be triggered. That is, &lt;em&gt;isLeader&lt;/em&gt; will be false for all members.&lt;/p&gt;

&lt;p&gt;This issue does not resolve until after an actual group change that causes a proper rebalance. In order to safely make a partition increase when using static membership, consumers must be stopped and have timed out, or forcibly removed with &lt;em&gt;AdminClient.removeMembersFromConsumerGroup()&lt;/em&gt;.&lt;/p&gt;

&lt;p&gt;Correcting this in the client probably also requires help from the broker. Currently, when a static consumer that is leader is restarted, the coordinator does recognize the change:&lt;/p&gt;

&lt;p&gt;e.g. leader &lt;em&gt;bbfcb930-61a3-4d21-945c-85f4576490ff&lt;/em&gt; was restarted&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[2021-11-04 13:53:13,487] INFO [GroupCoordinator 4]: Static member Some(1GK7DRJPHZ0LRV91Y4D3SYHS5928XHXJQ6263GT26V5P70QX0) of group ryan_test with unknown member id rejoins, assigning new member id 1GK7DRJPHZ0LRV91Y4D3SYHS5928XHXJQ6263GT26V5P70QX0-af88ecf2-
6ebf-47da-95ef-c54fef17ab74, while old member id 1GK7DRJPHZ0LRV91Y4D3SYHS5928XHXJQ6263GT26V5P70QX0-bbfcb930-61a3-4d21-945c-85f4576490ff will be removed. (
kafka.coordinator.group.GroupCoordinator)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;However, it does not attempt to update the leader id since this isn&apos;t a new rebalance, and JOIN_GROUP will continue returning the now stale member id as leader:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2021-11-04 13:53:13,490 DEBUG o.a.k.c.c.i.AbstractCoordinator [Consumer instanceId=1GK7DRJPHZ0LRV91Y4D3SYHS5928XHXJQ6263GT26V5P70QX0, clientId=1GK7DRJPHZ0LRV91Y4D3SYHS5928XHXJQ6263GT26V5P70QX0, groupId=ryan_test] Received successful JoinGroup response: JoinGroupResponseData(throttleTimeMs=0, errorCode=0, generationId=40, protocolType=&apos;consumer&apos;, protocolName=&apos;range&apos;, leader=&apos;1GK7DRJPHZ0LRV91Y4D3SYHS5928XHXJQ6263GT26V5P70QX0-bbfcb930-61a3-4d21-945c-85f4576490ff&apos;, memberId=&apos;1GK7DRJPHZ0LRV91Y4D3SYHS5928XHXJQ6263GT26V5P70QX0-af88ecf2-6ebf-47da-95ef-c54fef17ab74&apos;, members=[])&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This means that it&apos;s not easy for any particular restarted member to identify that it should consider itself leader and handle metadata changes.&lt;/p&gt;

&lt;p&gt;There is reference to the difficulty of leader restarts in &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7728&quot; title=&quot;Add JoinReason to the join group request for better rebalance handling&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7728&quot;&gt;&lt;del&gt;KAFKA-7728&lt;/del&gt;&lt;/a&gt; but the focus seemed mainly on avoiding needless rebalances for static members. That goal was accomplished, but this issue seems to be a side effect of both not rebalancing AND not having the rejoined member reclaim its leadership status.&lt;/p&gt;

&lt;p&gt;Also, I have not verified if it&apos;s strictly related or valid, but noticed this ticket has been opened too: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-12759&quot; title=&quot;Kafka consumers with static group membership won&amp;#39;t consume from newly subscribed topics&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-12759&quot;&gt;KAFKA-12759&lt;/a&gt;.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13410313">KAFKA-13435</key>
            <summary>Static membership protocol should let the leader skip assignment (KIP-814)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dajac">David Jacot</assignee>
                                    <reporter username="rleslie">Ryan Leslie</reporter>
                        <labels>
                            <label>new-rebalance-should-fix</label>
                    </labels>
                <created>Fri, 5 Nov 2021 18:59:45 +0000</created>
                <updated>Thu, 20 Oct 2022 00:20:15 +0000</updated>
                            <resolved>Mon, 14 Feb 2022 10:56:29 +0000</resolved>
                                    <version>3.0.0</version>
                                    <fixVersion>3.2.0</fixVersion>
                                    <component>consumer</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="17440816" author="guozhang" created="Mon, 8 Nov 2021 23:41:49 +0000"  >&lt;p&gt;Hello &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rleslie&quot; class=&quot;user-hover&quot; rel=&quot;rleslie&quot;&gt;rleslie&lt;/a&gt;, thanks for your reported issue. I looked through the code and I agree with you that this is a bug on the broker side &amp;#8212; unfortunately, since it is broker-side we need to fix it and upgrade the broker version in order to avoid hitting that again &amp;#8212; would you like to submit a PR that fixes on the broker? I think the fix should be inside &lt;tt&gt;updateStaticMemberAndRebalance&lt;/tt&gt;, where we update the &lt;tt&gt;group.leader&lt;/tt&gt; based on the oldMemberId.&lt;/p&gt;</comment>
                            <comment id="17440817" author="guozhang" created="Mon, 8 Nov 2021 23:42:25 +0000"  >&lt;p&gt;Updating the affected version since this bug still exists in trunk today.&lt;/p&gt;</comment>
                            <comment id="17442024" author="rleslie" created="Thu, 11 Nov 2021 01:06:45 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; Thanks for taking a look at this. You mentioned the broker change, but is any strategy also needed on the client side? I think with static membership we probably still don&apos;t want to trigger a full rebalance even if the leader rejoins. If I&apos;m interpreting it correctly, it looks like &lt;tt&gt;ConsumerCoordinator&lt;/tt&gt; current only sets &lt;tt&gt;isLeader / assignmentSnapshot&lt;/tt&gt; if there is an actual assignment performed. And without that, metadata changes won&apos;t trigger a subsequent rebalance. With static membership, if the broker is now changed to return the new &lt;tt&gt;leaderId&lt;/tt&gt;, is it still safe or useful for &lt;tt&gt;performAssignment()&lt;/tt&gt; to actually occur?&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/kafka/blob/43bcc5682da82a602a4c0a000dc7433d0507b450/clients/src/main/java/org/apache/kafka/clients/consumer/internals/AbstractCoordinator.java#L597&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/43bcc5682da82a602a4c0a000dc7433d0507b450/clients/src/main/java/org/apache/kafka/clients/consumer/internals/AbstractCoordinator.java#L597&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/kafka/blob/43bcc5682da82a602a4c0a000dc7433d0507b450/clients/src/main/java/org/apache/kafka/clients/consumer/internals/AbstractCoordinator.java#L694&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/43bcc5682da82a602a4c0a000dc7433d0507b450/clients/src/main/java/org/apache/kafka/clients/consumer/internals/AbstractCoordinator.java#L694&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;That is, could there be any side effects if a static member simply rejoining invokes its assignor and sends back a new assignment in &lt;tt&gt;SyncGroup&lt;/tt&gt;, one that also possibly differs from the existing assignment not meant to be updated?&lt;/p&gt;</comment>
                            <comment id="17444998" author="dajac" created="Wed, 17 Nov 2021 08:06:25 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rleslie&quot; class=&quot;user-hover&quot; rel=&quot;rleslie&quot;&gt;rleslie&lt;/a&gt; Thanks for reporting this bug. I have assigned the Jira to me and I plan to fix this in the coming weeks.&lt;/p&gt;</comment>
                            <comment id="17446106" author="guozhang" created="Thu, 18 Nov 2021 19:18:12 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rleslie&quot; class=&quot;user-hover&quot; rel=&quot;rleslie&quot;&gt;rleslie&lt;/a&gt; today only the brokers can determine if a join-group request would trigger a rebalance or not. In this specific case, if a join-group request is sent with a known instance id and its corresponding old member id is considered the leader, the broker&apos;s coordinator can still assign a new member id to it, set the leader to the new member id; but whether or not it would set the Leader ID in the response depends on whether there are any metadata change that really do need a rebalance. If there&apos;s no need for a rebalance, it would not set the leader id at all &amp;#8212; i.e. only the broker knows who&apos;s the current leader, but members do not know. I think this is okay since members do not try to remember who&apos;s the current leader anyways.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dajac&quot; class=&quot;user-hover&quot; rel=&quot;dajac&quot;&gt;dajac&lt;/a&gt; please let me know if you&apos;ve have a PR ready.&lt;/p&gt;</comment>
                            <comment id="17446202" author="rleslie" created="Thu, 18 Nov 2021 23:17:08 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dajac&quot; class=&quot;user-hover&quot; rel=&quot;dajac&quot;&gt;dajac&lt;/a&gt; Thank you for picking this up quickly.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; Thanks for reviewing again. I think as &lt;tt&gt;ConsumerCoordinator&lt;/tt&gt; is currently written, at least one member needs to know its the leader and record the assignment. Otherwise &lt;tt&gt;assignmentSnapshot&lt;/tt&gt; is not set and rebalance won&apos;t trigger when the metadata is refreshed with new partitions added. But I understand there may be another way to address this. Let&apos;s wait for David and see how the PR ends up looking.&lt;/p&gt;</comment>
                            <comment id="17446206" author="guozhang" created="Thu, 18 Nov 2021 23:35:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rleslie&quot; class=&quot;user-hover&quot; rel=&quot;rleslie&quot;&gt;rleslie&lt;/a&gt; Sorry I misunderstood your scenario, I thought that the member was not newly created and hence would still have its &lt;tt&gt;assignmentSnapshot&lt;/tt&gt; locally, now that I re-read the first section of the JIRA description I think I get you now.&lt;/p&gt;

&lt;p&gt;In this case, at the moment I feel we cannot avoid doing an unnecessary full rebalance which triggers perform-assignment.. but in the near future when we improve the rebalance protocol, I think it would be better to not having the client to remember whether itself is the leader or not, instead, anyone with the full subscription information should be able to do the assignment, and for anyone (including the leader) to re-join the group, it should be the broker&apos;s responsibility to decide if a rebalance needs to be triggered or not.&lt;/p&gt;</comment>
                            <comment id="17446209" author="rleslie" created="Thu, 18 Nov 2021 23:54:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; Awesome, glad we are more in sync now. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;I think it would be tough for most users of static membership to pick up a new Kafka version that suddenly triggers rebalance on leader rejoin, since this was avoided in the original implementation. This ticket is an edge case, after all. My thought was that if &lt;tt&gt;JoinResponse&lt;/tt&gt; can at least inform the client that it is the returning leader, then it can still have opportunity to check metadata for changes compared to its subscription and trigger the rebalance. It may not be a perfect solution, and it&apos;s still some careful refactoring. Hoping David has some ideas around this too. I agree with you it would be ideal if the broker controlled these decisions, but that does sound like an even bigger change.&lt;/p&gt;</comment>
                            <comment id="17451144" author="dajac" created="Tue, 30 Nov 2021 13:55:30 +0000"  >&lt;p&gt;I have looked into this issue and I do agree with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt;. It seems that the best way to proceed is to trigger a full rebalance when the leader rejoins the group. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rleslie&quot; class=&quot;user-hover&quot; rel=&quot;rleslie&quot;&gt;rleslie&lt;/a&gt; The issue with your proposal is that the returning leader does not know the so called `assignmentSnapshot` anymore therefore it cannot decide if a rebalance is required or not. `assignmentSnapshot` is assigned when the leader run the assignment locally. Moreover, comparing the subscription is not sufficient in this particular case. The subscription only contains the topic and it does not change here.&lt;/p&gt;

&lt;p&gt;I do agree that it is a bit unfortunate that we have to do a full rebalance in this case but I don&apos;t see any other solutions with the current protocol. I will prepare a PR going in this direction and we can discuss further in the PR if necessary.&lt;/p&gt;</comment>
                            <comment id="17451208" author="rleslie" created="Tue, 30 Nov 2021 15:56:30 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dajac&quot; class=&quot;user-hover&quot; rel=&quot;dajac&quot;&gt;dajac&lt;/a&gt; Triggering a rebalance whenever the leader rejoins is a backward incompatible change to the documented behavior of static membership. I maintain a system that strongly depends on the current behavior, and it would be impacted negatively by this. Would much prefer to have to manually restart consumers when adding partitions only than have that rebalance occur regularly just in case. If we are going to trigger a rebalance at all times it should at least be optional behavior based on a property so that users can opt out. I certainly would. And in that case this behavior change should require a KIP. Let&apos;s not rush the decision here.&lt;/p&gt;</comment>
                            <comment id="17451661" author="dajac" created="Wed, 1 Dec 2021 09:36:18 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rleslie&quot; class=&quot;user-hover&quot; rel=&quot;rleslie&quot;&gt;rleslie&lt;/a&gt; I understand your point. Manually restarting consumers when adding partitions is not even enough because the returning leader is not able to detect new partitions until a rebalance has taken place. This is required for two reasons: 1) to let it know that it is leader and 2) to let it rebuilt its internal `assignmentSnapshot` state. The leader needs both in order to be able to trigger a rebalance when the metadata has changed. However, you could force a rebalance with `Consumer#enforceRebalance` when you add partitions.&lt;/p&gt;

&lt;p&gt;I would like to better understand your case. Could you elaborate a bit more on why having a single rebalance is such an issue? I suppose that the members would retain their assignments so the disruption should be minimal (I am not sure if this is true for all assignors though).&lt;/p&gt;

&lt;p&gt;Alternatively, we could extend the group coordinator (on the broker side) to monitor the new partitions and trigger a rebalance when required. This is a bit tricky in the current implementation because the group coordinator does not parse the assignments. I am not sure if we want to go down that route at the moment.&lt;/p&gt;</comment>
                            <comment id="17451896" author="dajac" created="Wed, 1 Dec 2021 15:45:48 +0000"  >&lt;p&gt;I have put a bit more thoughts into this and it seems that we could (partially) resolve this issue with the following PR: &lt;a href=&quot;https://github.com/apache/kafka/pull/11559&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/11559&lt;/a&gt;. The main idea is to return to the re-joining leaders all the subscriptions such that it can re-compute the assignment and initialize its state. As the group is Stable, the new assignment is ignored by the group coordinator. This allow the leader to detect future metadata changes and trigger a rebalance if needed.&lt;/p&gt;

&lt;p&gt;However, it does not work if the new partitions were created while the leader was down because the new leader will directly have the newest metadata with the new partitions when it starts up. To circumvent this, the group coordinator could compare the new compute assignment with the current one and trigger a rebalance if they differ. This would rely on the assumption that the assignor is deterministic to avoid triggering an unnecessary rebalance. I am not sure if this is always true.&lt;/p&gt;

&lt;p&gt;What do you guys think?&lt;/p&gt;</comment>
                            <comment id="17451922" author="rleslie" created="Wed, 1 Dec 2021 16:57:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dajac&quot; class=&quot;user-hover&quot; rel=&quot;dajac&quot;&gt;dajac&lt;/a&gt; Yes, I was going to suggest something similar to this. The broker knows that the re-joining member is the leader based on its instance id, and can inform it of such in the JoinGroupResponse. And SyncGroup is also already responding with assignment data. So putting that together can possibly allow the client to rebuild enough state to continue monitoring metadata changes. You are completely right that this won&apos;t handle partitions being added in between the leader exiting and coming back. However, that is usually not meant to be a long time period or else it will time out or stall progress in the consumer group.&lt;/p&gt;

&lt;p&gt;Though it is a very clever idea, I&apos;m not 100% about taking it further to have the assignment actually recomputed instead of trying to have the broker return it. Users might define their own assignors and we can&apos;t be sure if they are side-effect free or not, regardless of whether or not they are deterministic. Rebuilding state in the consumer without invoking the assignor may require a separate code path in the client-side coordinator, however. Perhaps others can weigh in on this trade-off too.&lt;/p&gt;

&lt;p&gt;This bug is already quite rare, and AFAIK only reported once since the inception of static membership / internal.leave.group.on.close. It may be better to start with a 95% solution than a perfect one involving more frequent rebalancing or much more invasive changes that could lead to newer bugs.&lt;/p&gt;

&lt;p&gt;And sorry, when I said restart consumers above, I meant not only to close them but call &lt;em&gt;AdminClient.removeMembersFromConsumerGroup()&lt;/em&gt; as well so they are new members when coming back up.&lt;/p&gt;

&lt;p&gt;To answer your other question, the main purpose of static membership is obviously to avoid rebalances when restarting, and we have to assume those who explicitly enable are very interested in this for one reason or another. Any solution that changes that guarantee and involves rebalancing every time a particular member restarts is a pretty serious negative and goes against the documented behavior. I feel it would have to be a very serious bug to make that decision, not an edge case like this where we can be patient and explore workarounds.&lt;/p&gt;

&lt;p&gt;You are right that triggering the rebalance should never break any application, but it can result in the kind of slow down that users aim to avoid. In our case, we happen to have some processing decoupled from the actual Kafka consumer loop and rebalances can occur asynchronous of processing. Because of this we are not always able to wait and commit all processed offsets prior to a rebalance which leads to duplicate messages being processed afterwards. That is why we use static membership, to help reduce that and limit duplicates to only certain, and more rare, situations. I haven&apos;t gone into full detail, but I hope that clarifies the concern a bit more.&lt;/p&gt;</comment>
                            <comment id="17452494" author="dajac" created="Thu, 2 Dec 2021 16:24:34 +0000"  >&lt;p&gt;Yeah, I do agree that this solution does not fly if we can&apos;t assume that the assignor is deterministic and idempotent. I think that it is OK for internal assignors but as you said we don&apos;t know about external ones.&lt;/p&gt;

&lt;p&gt;I have been playing with an alternative approach. If we summarise, the issue is that the re-joining leader does not know that it is the leader because the group coordinator does not inform it on purpose to avoid doing an assignment. As a side effect, the leader is not longer able to trigger a rebalance when the metadata is updated (e.g. partitions added) and only the leader is able to do this at the moment. What if we relax this constraint?&lt;/p&gt;

&lt;p&gt;For the subscription, every member of the group does the check locally but only the leader known by the group coordinator can trigger a rebalance in the end. We can argue that we are wasting a bit of resources because all the non-leaders are doing it for nothing in the end. I wonder if we could do the same in our case for the metadata. All the members would check metadata changes and would try to trigger a rebalance. However, only the leader known by the group coordinator would succeed.&lt;/p&gt;

&lt;p&gt;Looking at all the options, that seems to be a reasonable approach which is not too disruptive. &lt;/p&gt;</comment>
                            <comment id="17452673" author="rleslie" created="Fri, 3 Dec 2021 01:00:51 +0000"  >&lt;p&gt;That&apos;s an interesting idea. Each member of the group is already refreshing its metadata, anyway. It&apos;s probably not much additional overhead given that metadata changes are rare. However, the current check relies on comparing the cached assignment for the group which only the leader has after the assignor is invoked. Is the plan to change this so that each member just compares the last two values of metadataSnapshot instead?&lt;/p&gt;</comment>
                            <comment id="17452990" author="dajac" created="Fri, 3 Dec 2021 13:01:11 +0000"  >&lt;p&gt;I don&apos;t have the implementation details yet but the idea would be to keep the metadata snapshot used to join the group and use it to trigger a rebalance when the metadata is updated. I need to workout the details. Before I do so, I&apos;d like to get a consensus on the approach with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hachikuji&quot; class=&quot;user-hover&quot; rel=&quot;hachikuji&quot;&gt;hachikuji&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17454118" author="dajac" created="Mon, 6 Dec 2021 16:21:13 +0000"  >&lt;p&gt;Let me summarise the options that we have discussed so far:&lt;/p&gt;

&lt;p&gt;1. The group coordinator could trigger a rebalance when the static leader re-joins the group. The major advantage of this solution is that it would fix the issue for all client versions. The downside is that it would trigger a rebalance every time that the leader re-joins the group and that goes a bit against the initial goal of the static members.&lt;/p&gt;

&lt;p&gt;2. The group coordinator could parse the assignments, listen to partition changes and trigger rebalances when required. That is very likely the cleanest option. However, as the group coordinator does not really parse the assignments yet, it would require a significant effort to be implemented. Given that this is an edge case, I am not sure that it is worth the effort. It might be better to address this when we redesign the protocol.&lt;/p&gt;

&lt;p&gt;3. At the moment, the re-joining leader can&apos;t detect metadata changes because it does not know that it is the leader when re-joining the group. This is something that we did on purpose otherwise the leader would compute assignment but they would not be propagated to other members. I am not sure if they is a real reason besides reducing noise and confusion on the client side. Here we could do this differently. For instance, we could tell the leader that it is the leader of the group when rejoining it by setting the correct leader in the JoinGroup response. Based on this, the leader would assign partitions and send a SyncGroup request. When the SyncGroup request is received from the leader and the group is Stable, we could check if the assignments have changed and trigger a rebalance if they did.&lt;/p&gt;

&lt;p&gt;4. As explained in pt. 3, the issue is that the re-joining member does not know that it is the leader when re-joining the group and this prevents the leader from monitoring any metadata changes based on the so called &quot;assignment snapshot&quot;. Unlike the subscriptions which are monitored by all members of the group, we have restricted this case to the leader only. It seems that we could relax this constraint and extend the mechanism to be executed by all members of the group. Note that only a JoinGroup request coming from the leader of group will trigger a rebalance. The downside is that it would increase the number of JoinGroup requests as all members would try to send them.&lt;/p&gt;</comment>
                            <comment id="17454313" author="guozhang" created="Tue, 7 Dec 2021 00:49:50 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dajac&quot; class=&quot;user-hover&quot; rel=&quot;dajac&quot;&gt;dajac&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rleslie&quot; class=&quot;user-hover&quot; rel=&quot;rleslie&quot;&gt;rleslie&lt;/a&gt; Thanks for the great discussions here, and for the summary. Personally I&apos;m leaning towards option 4) because:&lt;/p&gt;

&lt;p&gt;a) It&apos;s usually better to fix on client side only, than having to change both brokers and/or clients, since the latter requires such fixes to be only in after a broker is upgraded, which is much more infrequent than client upgrades.&lt;/p&gt;

&lt;p&gt;b) Today we are splitting the decision on &quot;when should a rebalance be triggered&quot; between the client and brokers, e.g. for metadata change the client have some logic that &quot;only leaders need to re-join&quot; and brokers have some logic that &quot;only leader&apos;s join will trigger&quot;. Given our long term plan is to move such triggering logic to brokers (i.e. option 2), I feel its okay to make client&apos;s side logic &quot;dummier&quot; since it aligns with the long term design a.k.a. dummy client and sophisticated brokers.&lt;/p&gt;

&lt;p&gt;The downside of course is that, in this interim period, we would have more entires flooding the rebalance logs since there would be more clients sending the join group request. AND that with a large group, these non-leader join-group requests may become a network request pressure on brokers &amp;#8212; in the even older days it&apos;s exactly as the proposed fix, where everyone can send join-group request, and brokers would treat them differently, I think we added this split-brain logic on the client side exactly for reducing the request rate with large groups &amp;#8212; but my preference is based on the assumption if we would soon remove this logic on the client completely and moves on to option 2). It might be a big IF though &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/tongue.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="17469592" author="hachikuji" created="Wed, 5 Jan 2022 23:22:44 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dajac&quot; class=&quot;user-hover&quot; rel=&quot;dajac&quot;&gt;dajac&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rleslie&quot; class=&quot;user-hover&quot; rel=&quot;rleslie&quot;&gt;rleslie&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; Thanks for the discussion. The protocol has us a bit boxed in. One problem I can think of with option 4) is that it doesn&apos;t handle the general case when subscriptions are not consistent among members. The leader needs a way to learn the subscriptions of all members. That is probably a rare case, so maybe it is not worth worrying about too much it, but it would be nice to have a complete solution. Another issue is that it requires a client update. &lt;/p&gt;

&lt;p&gt;I favor option 3) a bit more than I thought I would when I first heard about it from David. Our basic intent for static groups is to make the rebalance protocol idempotent so that returning members can rejoin without the need for a new rebalance (so long as the subscription hasn&apos;t changed). Our current approach cheats the protocol because we skip the leader&apos;s role in the rebalance. In other words, it is not actually idempotent because the end state is a group without a leader. It seems more consistent to let the leader recompute the assignment. Provided there are no changes, then the other members don&apos;t need to know about it. The big question is whether any of the standard assignors that AK ships have any non-deterministic behavior. &lt;/p&gt;</comment>
                            <comment id="17470930" author="guozhang" created="Fri, 7 Jan 2022 22:44:33 +0000"  >&lt;p&gt;Sounds good, thanks @Jason. Let&apos;s do option 3) for now.&lt;/p&gt;</comment>
                            <comment id="17472085" author="dajac" created="Mon, 10 Jan 2022 14:57:51 +0000"  >&lt;p&gt;Thanks, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hachikuji&quot; class=&quot;user-hover&quot; rel=&quot;hachikuji&quot;&gt;hachikuji&lt;/a&gt;. I think that AK assignors are usually deterministic given the exact same input. One issue that I can see is that the assignor interface takes a `Map&amp;lt;String, Subscription&amp;gt; subscriptions` (member id to subscription) as input. This means that we don&apos;t guarantee the ordering while iterating over the map to compute the assignment. The issue is that the new joining member will get a new member id so the input is not exactly the same and the ordering will change very likely. I tried this quickly with the RangeAssignor and the assignment changes depending on the new member id.&lt;/p&gt;</comment>
                            <comment id="17472449" author="rleslie" created="Tue, 11 Jan 2022 04:48:12 +0000"  >&lt;p&gt;Not ideal, but as a first step, is a partial solution achievable for sticky and cooperative-sticky? I believe the latter is slated to be the new default, at least. With these assignors I think the broker is sent UserData that includes the current assignments, and this is available in SyncGroupResponse to the returning leader. Then the client would need to store this and resume checking for metadata changes.&lt;/p&gt;</comment>
                            <comment id="17478765" author="dajac" created="Wed, 19 Jan 2022 15:28:42 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rleslie&quot; class=&quot;user-hover&quot; rel=&quot;rleslie&quot;&gt;rleslie&lt;/a&gt; I have published a small KIP to address this issue: &lt;a href=&quot;https://cwiki.apache.org/confluence/display/KAFKA/KIP-814%3A+Static+membership+protocol+should+let+the+leader+skip+assignment.&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://cwiki.apache.org/confluence/display/KAFKA/KIP-814%3A+Static+membership+protocol+should+let+the+leader+skip+assignment.&lt;/a&gt; I have discussed all the options with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hachikuji&quot; class=&quot;user-hover&quot; rel=&quot;hachikuji&quot;&gt;hachikuji&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; and we feel like this is the best approach overall.&lt;/p&gt;</comment>
                            <comment id="17620653" author="twmb" created="Thu, 20 Oct 2022 00:20:15 +0000"  >&lt;p&gt;KIP-814 doesn&apos;t have a solution to &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-12759&quot; title=&quot;Kafka consumers with static group membership won&amp;#39;t consume from newly subscribed topics&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-12759&quot;&gt;KAFKA-12759&lt;/a&gt; mentioned above. If the leader is turned off, has its assignment switched, and rejoins, the leader will receive its old assignment. KIP-814 says that a rebalance should not occur.&lt;/p&gt;

&lt;p&gt;If a leader is assigned &quot;foo&quot;, turns off, changes its configuration to be assigned &quot;bar&quot;, and turns back on, the broker will tell the leader that its current assignment is &quot;foo&quot;. Worse, the JoinGroupResponse will indicate that &quot;bar&quot; is the member assignment, and then the SyncGroupResponse will say &quot;you own foo&quot; even though the leader is not interested.&lt;/p&gt;

&lt;p&gt;Rather than returning leader&apos;s new protocol metadata, the broker should return the old leader protocol metadata. This would allow the leader to detect if its metadata has changed and if it should continue with a full balance and assignment.&lt;/p&gt;

&lt;p&gt;I&apos;ll open a new issue for this.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13377113">KAFKA-12759</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 3 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0whl4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>hachikuji</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>