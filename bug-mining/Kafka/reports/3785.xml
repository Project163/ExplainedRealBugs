<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:38:53 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-16371] Unstable committed offsets after triggering commits where metadata for some partitions are over the limit</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-16371</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Issue is reproducible with simple CLI tool - &lt;a href=&quot;https://gist.github.com/mlowicki/c3b942f5545faced93dc414e01a2da70&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gist.github.com/mlowicki/c3b942f5545faced93dc414e01a2da70&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
#!/usr/bin/env bash

&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; i in {1..100}
&lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt;
    kafka-committer --bootstrap &lt;span class=&quot;code-quote&quot;&gt;&quot;ADDR:9092&quot;&lt;/span&gt; --topic &lt;span class=&quot;code-quote&quot;&gt;&quot;TOPIC&quot;&lt;/span&gt; --group foo --metadata-min 6000 --metadata-max 10000 --partitions 72 --fetch
done&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;What it does it that initially it fetches committed offsets and then tries to commit for multiple partitions. If some of commits have metadata over the allowed limit then:&lt;br/&gt;
1. I see errors about too large commits (expected)&lt;/p&gt;

&lt;p&gt;2. Another run the tool fails at the stage of fetching commits with (this is the problem):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
config: ClientConfig { conf_map: { &lt;span class=&quot;code-quote&quot;&gt;&quot;group.id&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;bar&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;bootstrap.servers&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;ADDR:9092&quot;&lt;/span&gt;, }, log_level: Error, }
fetching committed offsets..
Error: Meta data fetch error: OperationTimedOut (Local: Timed out) Caused by: OperationTimedOut (Local: Timed out)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;On the Kafka side I see &lt;em&gt;unstable_offset_commits&lt;/em&gt; errors reported by out internal metric&#160;which is derived from:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt; kafka.network:type=RequestMetrics,name=ErrorsPerSec,request=X,error=Y&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Increasing the timeout doesn&apos;t help and the only solution I&apos;ve found is to trigger commits for all partitions with metadata below the limit or to use:&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
isolation.level=read_uncommitted&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I don&apos;t know that code very well but &lt;a href=&quot;https://github.com/apache/kafka/blob/3.7/core/src/main/scala/kafka/coordinator/group/GroupMetadataManager.scala#L492-L496&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/3.7/core/src/main/scala/kafka/coordinator/group/GroupMetadataManager.scala#L492-L496&lt;/a&gt; seems fishy:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (isTxnOffsetCommit) {
&#160; &#160; &#160; addProducerGroup(producerId, group.groupId)
&#160; &#160; &#160; group.prepareTxnOffsetCommit(producerId, offsetMetadata)
&#160; &#160; } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
&#160; &#160; &#160; group.prepareOffsetCommit(offsetMetadata)
&#160; &#160; }&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;as it&apos;s using &lt;em&gt;offsetMetadata&lt;/em&gt; and not &lt;em&gt;filteredOffsetMetadata&lt;/em&gt; and I see that while removing those pending commits we use filtered offset metadata around &lt;a href=&quot;https://github.com/apache/kafka/blob/3.7/core/src/main/scala/kafka/coordinator/group/GroupMetadataManager.scala#L397-L422&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/3.7/core/src/main/scala/kafka/coordinator/group/GroupMetadataManager.scala#L397-L422&lt;/a&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&#160; &#160; &#160; val responseError = group.inLock {
&#160; &#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (status.error == Errors.NONE) {
&#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!group.is(Dead)) {
&#160; &#160; &#160; &#160; &#160; &#160; filteredOffsetMetadata.forKeyValue { (topicIdPartition, offsetAndMetadata) =&amp;gt;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (isTxnOffsetCommit)
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; group.onTxnOffsetCommitAppend(producerId, topicIdPartition, CommitRecordMetadataAndOffset(Some(status.baseOffset), offsetAndMetadata))
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; group.onOffsetCommitAppend(topicIdPartition, CommitRecordMetadataAndOffset(Some(status.baseOffset), offsetAndMetadata))
&#160; &#160; &#160; &#160; &#160; &#160; }
&#160; &#160; &#160; &#160; &#160; }
&#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// Record the number of offsets committed to the log
&lt;/span&gt;&#160; &#160; &#160; &#160; &#160; offsetCommitsSensor.record(records.size)
&#160; &#160; &#160; &#160; &#160; Errors.NONE
&#160; &#160; &#160; &#160; } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
&#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!group.is(Dead)) {
&#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!group.hasPendingOffsetCommitsFromProducer(producerId))
&#160; &#160; &#160; &#160; &#160; &#160; &#160; removeProducerGroup(producerId, group.groupId)
&#160; &#160; &#160; &#160; &#160; &#160; filteredOffsetMetadata.forKeyValue { (topicIdPartition, offsetAndMetadata) =&amp;gt;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (isTxnOffsetCommit)
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; group.failPendingTxnOffsetCommit(producerId, topicIdPartition)
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; group.failPendingOffsetWrite(topicIdPartition, offsetAndMetadata)
&#160; &#160; &#160; &#160; &#160; &#160; }
&#160; &#160; &#160; &#160; &#160; }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;so the problem might be related to not cleaning up the data structure with pending commits properly.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13571862">KAFKA-16371</key>
            <summary>Unstable committed offsets after triggering commits where metadata for some partitions are over the limit</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dajac">David Jacot</assignee>
                                    <reporter username="mlowicki">mlowicki</reporter>
                        <labels>
                    </labels>
                <created>Thu, 14 Mar 2024 10:02:42 +0000</created>
                <updated>Mon, 27 May 2024 15:18:53 +0000</updated>
                            <resolved>Mon, 27 May 2024 15:13:04 +0000</resolved>
                                    <version>3.7.0</version>
                                    <fixVersion>3.7.1</fixVersion>
                    <fixVersion>3.8.0</fixVersion>
                                    <component>offset manager</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                        <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 34 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1nys0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>