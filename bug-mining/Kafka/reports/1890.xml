<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:10:03 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-5253] TopologyTestDriver must handle streams created with patterns</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-5253</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;&lt;b&gt;Context&lt;/b&gt;&lt;br/&gt;
 &lt;del&gt;KStreamTestDriver&lt;/del&gt;&#160;TopologyTestDriver (added via KIP-247) is being used to unit test topologies while developing KStreams apps.&lt;/p&gt;

&lt;p&gt;One such topology uses a Pattern to consume from multiple topics at once.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Problem&lt;/b&gt;&lt;br/&gt;
 The unit test of the topology fails because &lt;del&gt;KStreamTestDriver&lt;/del&gt;&#160;TopologyTestDriver fails to deal with Patterns properly.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Example&lt;/b&gt;&lt;br/&gt;
 Underneath is a unit test explaining what I understand should happen, but is failing.&lt;/p&gt;

&lt;p&gt;*&lt;b&gt;Note: the example below is outdate as it used the old KStreamTestDriver. The overall test layout can be adopted for TopologyTestDriver though, thus, we just leave it in the description.&lt;/b&gt;*&lt;/p&gt;

&lt;p&gt;Explicitly adding a source topic matching the topic pattern, generates an exception as the topology builder explicitly checks overlapping topic names and patterns, in any order of adding pattern and topic. So, it is intended behaviour.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    @Test
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void shouldProcessFromSourcesThatDoMatchThePattern() {
        &lt;span class=&quot;code-comment&quot;&gt;// -- setup stream pattern
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; KStream&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; source = builder.stream(Pattern.compile(&lt;span class=&quot;code-quote&quot;&gt;&quot;topic-source-\\d&quot;&lt;/span&gt;));
        source.to(&lt;span class=&quot;code-quote&quot;&gt;&quot;topic-sink&quot;&lt;/span&gt;);

        &lt;span class=&quot;code-comment&quot;&gt;// -- setup processor to capture results
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; MockProcessorSupplier&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; processorSupplier = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; MockProcessorSupplier&amp;lt;&amp;gt;();
        source.process(processorSupplier);

        &lt;span class=&quot;code-comment&quot;&gt;// -- add source to stream data from
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;//builder.addSource(builder.newName(KStreamImpl.SOURCE_NAME), &lt;span class=&quot;code-quote&quot;&gt;&quot;topic-source-3&quot;&lt;/span&gt;);
&lt;/span&gt;
        &lt;span class=&quot;code-comment&quot;&gt;// -- build test driver
&lt;/span&gt;        driver = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; KStreamTestDriver(builder); &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; should be TopologyTestDriver
&lt;/span&gt;        driver.setTime(0L);

        &lt;span class=&quot;code-comment&quot;&gt;// -- test
&lt;/span&gt;        driver.process(&lt;span class=&quot;code-quote&quot;&gt;&quot;topic-source-3&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;A&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;aa&quot;&lt;/span&gt;);

        &lt;span class=&quot;code-comment&quot;&gt;// -- validate
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// no exception was thrown
&lt;/span&gt;        assertEquals(Utils.mkList(&lt;span class=&quot;code-quote&quot;&gt;&quot;A:aa&quot;&lt;/span&gt;), processorSupplier.processed);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;b&gt;Solution&lt;/b&gt;&lt;br/&gt;
 If anybody can help in defining the solution, I can create a pull request for this change.-&lt;/p&gt;</description>
                <environment></environment>
        <key id="13072350">KAFKA-5253</key>
            <summary>TopologyTestDriver must handle streams created with patterns</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jadireddi">Jagadesh Adireddi</assignee>
                                    <reporter username="wimvanleuven">Wim Van Leuven</reporter>
                        <labels>
                            <label>beginner</label>
                            <label>needs-kip</label>
                            <label>newbie</label>
                    </labels>
                <created>Tue, 16 May 2017 08:28:28 +0000</created>
                <updated>Wed, 25 Apr 2018 09:41:28 +0000</updated>
                            <resolved>Fri, 20 Apr 2018 13:23:21 +0000</resolved>
                                    <version>1.1.0</version>
                                    <fixVersion>2.0.0</fixVersion>
                                    <component>streams</component>
                    <component>unit tests</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16020920" author="wimvanleuven" created="Tue, 23 May 2017 09:10:55 +0000"  >&lt;p&gt;Can anybody give direction in how to improve the KStreamTestDriver to support topic patterns?&lt;/p&gt;</comment>
                            <comment id="16021520" author="mjsax" created="Tue, 23 May 2017 17:40:42 +0000"  >&lt;p&gt;As you can see from the code &lt;tt&gt;KStreamTestDriver#process()&lt;/tt&gt; does lookup the source node to start processing via &lt;tt&gt;sourceNodeByTopicName()&lt;/tt&gt; &amp;#8211; it did not run the example code but I guess it does not find the source node and you end up with NPE. Thus,  &lt;tt&gt;sourceNodeByTopicName()&lt;/tt&gt; should be able to handle patterns, too.&lt;/p&gt;</comment>
                            <comment id="16344398" author="mjsax" created="Tue, 30 Jan 2018 02:10:58 +0000"  >&lt;p&gt;We should double check the new test artifact, if it can handle Patterns and if not update accordingly.&lt;/p&gt;</comment>
                            <comment id="16354332" author="mjsax" created="Tue, 6 Feb 2018 18:50:48 +0000"  >&lt;p&gt;I doubled checked &lt;tt&gt;TopologyTestDriver&lt;/tt&gt; and it is not able to handle Pattern subscription. The fix should be fairly easy, however, required a public API change and thus a KIP.&lt;/p&gt;</comment>
                            <comment id="16417896" author="adireddijagadesh@gmail.com" created="Wed, 28 Mar 2018 18:33:04 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mjsax&quot; class=&quot;user-hover&quot; rel=&quot;mjsax&quot;&gt;mjsax&lt;/a&gt;,&lt;/p&gt;


&lt;p&gt;I am new to Kafka contribution. I made code changes for above issue and it&apos;s working as expected.&lt;/p&gt;


&lt;p&gt;I have few questions before I submit pull request. I made changes inside &lt;b&gt;private&lt;/b&gt; method&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;KStreamTestDriver&lt;/b&gt;#&lt;b&gt;sourceNodeByTopicName .&lt;/b&gt;&#160;I haven&apos;t modified any method signature or so. Just embedded below code&#160;&lt;br/&gt;
&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 Set&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; sourceTopics = topology.sourceTopics();
&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; eachSourceTopic : sourceTopics) {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (Pattern.compile(eachSourceTopic).matcher(topicName).matches()) {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; topology.source(eachSourceTopic);
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Do i still need to submit KIP for this change, as i am not touching any public methods.&lt;/p&gt;</comment>
                            <comment id="16418111" author="mjsax" created="Wed, 28 Mar 2018 21:10:10 +0000"  >&lt;p&gt;Thanks for working on this. If the fix does not require a public API changes, we don&apos;t need a KIP &amp;#8211; when I created the KIP, I was assuming that we will need a public API for the fix. Please go ahead an open the PR and we can take it from there.&lt;/p&gt;</comment>
                            <comment id="16418503" author="githubbot" created="Thu, 29 Mar 2018 06:38:15 +0000"  >&lt;p&gt;jadireddi opened a new pull request #4793: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5253&quot; title=&quot;TopologyTestDriver must handle streams created with patterns&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-5253&quot;&gt;&lt;del&gt;KAFKA-5253&lt;/del&gt;&lt;/a&gt;: Fixed KStreamTestDriver to handle streams created with patterns&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/4793&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/4793&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5253&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-5253&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;   Fixed `KStreamTestDriver#sourceNodeByTopicName` to handle streams created with patterns.&lt;/p&gt;

&lt;p&gt;   *More detailed description of your change,&lt;br/&gt;
   if necessary. The PR title and PR message become&lt;br/&gt;
   the squashed commit message, so use a separate&lt;br/&gt;
   comment to ping reviewers.*&lt;/p&gt;

&lt;p&gt;   *Summary of testing strategy (including rationale)&lt;br/&gt;
   for the feature or bug fix. Unit and/or integration&lt;br/&gt;
   tests are expected for any behaviour change and&lt;br/&gt;
   system tests should be considered for larger changes.*&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16426334" author="mjsax" created="Wed, 4 Apr 2018 23:45:33 +0000"  >&lt;p&gt;As commented on the PR, this ticket addressed `TopololgyTestDriver` but not `KStreamTestDriver` (KStreamTestDriver will be removed via &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6474&quot; title=&quot;Rewrite test to use new public TopologyTestDriver&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-6474&quot;&gt;&lt;del&gt;KAFKA-6474&lt;/del&gt;&lt;/a&gt;)&lt;/p&gt;</comment>
                            <comment id="16427284" author="adireddijagadesh@gmail.com" created="Thu, 5 Apr 2018 17:15:56 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mjsax&quot; class=&quot;user-hover&quot; rel=&quot;mjsax&quot;&gt;mjsax&lt;/a&gt;,&lt;br/&gt;
Made changes to `&lt;tt&gt;TopologyTestDriver`&lt;/tt&gt;&#160;class for supporting patterns. Kindly review and let me know if any changes needed.&lt;/p&gt;</comment>
                            <comment id="16445704" author="githubbot" created="Fri, 20 Apr 2018 13:22:40 +0000"  >&lt;p&gt;mjsax closed pull request #4793: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5253&quot; title=&quot;TopologyTestDriver must handle streams created with patterns&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-5253&quot;&gt;&lt;del&gt;KAFKA-5253&lt;/del&gt;&lt;/a&gt;: Fixed KStreamTestDriver to handle streams created with patterns&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/4793&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/4793&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/streams/src/main/java/org/apache/kafka/streams/processor/internals/InternalTopologyBuilder.java b/streams/src/main/java/org/apache/kafka/streams/processor/internals/InternalTopologyBuilder.java&lt;br/&gt;
index 535f03524c0..b1d60a9ad88 100644&lt;br/&gt;
&amp;#8212; a/streams/src/main/java/org/apache/kafka/streams/processor/internals/InternalTopologyBuilder.java&lt;br/&gt;
+++ b/streams/src/main/java/org/apache/kafka/streams/processor/internals/InternalTopologyBuilder.java&lt;br/&gt;
@@ -1880,4 +1880,8 @@ public void updateSubscribedTopics(final Set&amp;lt;String&amp;gt; topics, final String logPre&lt;br/&gt;
         subscriptionUpdates.updateTopics(topics);&lt;br/&gt;
         updateSubscriptions(subscriptionUpdates, logPrefix);&lt;br/&gt;
     }&lt;br/&gt;
+&lt;br/&gt;
+    public synchronized Set&amp;lt;String&amp;gt; getSourceTopicNames() &lt;/p&gt;
{
+        return sourceTopicNames;
+    }
&lt;p&gt; }&lt;br/&gt;
diff --git a/streams/src/test/java/org/apache/kafka/streams/kstream/internals/KStreamImplTest.java b/streams/src/test/java/org/apache/kafka/streams/kstream/internals/KStreamImplTest.java&lt;br/&gt;
index 2009806fd18..ef65bb32b36 100644&lt;br/&gt;
&amp;#8212; a/streams/src/test/java/org/apache/kafka/streams/kstream/internals/KStreamImplTest.java&lt;br/&gt;
+++ b/streams/src/test/java/org/apache/kafka/streams/kstream/internals/KStreamImplTest.java&lt;br/&gt;
@@ -53,6 +53,7 @@&lt;br/&gt;
 import java.util.Arrays;&lt;br/&gt;
 import java.util.Collections;&lt;br/&gt;
 import java.util.concurrent.TimeUnit;&lt;br/&gt;
+import java.util.regex.Pattern;&lt;/p&gt;

&lt;p&gt; import static org.hamcrest.CoreMatchers.equalTo;&lt;br/&gt;
 import static org.hamcrest.core.IsInstanceOf.instanceOf;&lt;br/&gt;
@@ -542,4 +543,49 @@ public void shouldMergeMultipleStreams() &lt;/p&gt;
{
         assertEquals(Utils.mkList(&quot;A:aa&quot;, &quot;B:bb&quot;, &quot;C:cc&quot;, &quot;D:dd&quot;, &quot;E:ee&quot;, &quot;F:ff&quot;, &quot;G:gg&quot;, &quot;H:hh&quot;),
                      processorSupplier.processed);
     }
&lt;p&gt;+&lt;br/&gt;
+    @Test&lt;br/&gt;
+    public void shouldProcessFromSourceThatMatchPattern() &lt;/p&gt;
{
+        final KStream&amp;lt;String, String&amp;gt; pattern2Source = builder.stream(Pattern.compile(&quot;topic-\\d&quot;));
+
+        final MockProcessorSupplier&amp;lt;String, String&amp;gt; processorSupplier = new MockProcessorSupplier&amp;lt;&amp;gt;();
+        pattern2Source.process(processorSupplier);
+
+        driver.setUp(builder);
+        driver.setTime(0L);
+
+        driver.process(&quot;topic-3&quot;, &quot;A&quot;, &quot;aa&quot;);
+        driver.process(&quot;topic-4&quot;, &quot;B&quot;, &quot;bb&quot;);
+        driver.process(&quot;topic-5&quot;, &quot;C&quot;, &quot;cc&quot;);
+        driver.process(&quot;topic-6&quot;, &quot;D&quot;, &quot;dd&quot;);
+        driver.process(&quot;topic-7&quot;, &quot;E&quot;, &quot;ee&quot;);
+
+        assertEquals(Utils.mkList(&quot;A:aa&quot;, &quot;B:bb&quot;, &quot;C:cc&quot;, &quot;D:dd&quot;, &quot;E:ee&quot;),
+                processorSupplier.processed);
+    }
&lt;p&gt;+&lt;br/&gt;
+    @Test&lt;br/&gt;
+    public void shouldProcessFromSourcesThatMatchMultiplePattern() &lt;/p&gt;
{
+        final String topic3 = &quot;topic-without-pattern&quot;;
+
+        final KStream&amp;lt;String, String&amp;gt; pattern2Source1 = builder.stream(Pattern.compile(&quot;topic-\\d&quot;));
+        final KStream&amp;lt;String, String&amp;gt; pattern2Source2 = builder.stream(Pattern.compile(&quot;topic-[A-Z]&quot;));
+        final KStream&amp;lt;String, String&amp;gt; source3 = builder.stream(topic3);
+        final KStream&amp;lt;String, String&amp;gt; merged = pattern2Source1.merge(pattern2Source2).merge(source3);
+
+        final MockProcessorSupplier&amp;lt;String, String&amp;gt; processorSupplier = new MockProcessorSupplier&amp;lt;&amp;gt;();
+        merged.process(processorSupplier);
+
+        driver.setUp(builder);
+        driver.setTime(0L);
+
+        driver.process(&quot;topic-3&quot;, &quot;A&quot;, &quot;aa&quot;);
+        driver.process(&quot;topic-4&quot;, &quot;B&quot;, &quot;bb&quot;);
+        driver.process(&quot;topic-A&quot;, &quot;C&quot;, &quot;cc&quot;);
+        driver.process(&quot;topic-Z&quot;, &quot;D&quot;, &quot;dd&quot;);
+        driver.process(topic3, &quot;E&quot;, &quot;ee&quot;);
+
+        assertEquals(Utils.mkList(&quot;A:aa&quot;, &quot;B:bb&quot;, &quot;C:cc&quot;, &quot;D:dd&quot;, &quot;E:ee&quot;),
+                processorSupplier.processed);
+    }
&lt;p&gt; }&lt;br/&gt;
diff --git a/streams/src/test/java/org/apache/kafka/test/KStreamTestDriver.java b/streams/src/test/java/org/apache/kafka/test/KStreamTestDriver.java&lt;br/&gt;
index aebb84975e2..eb137dbabeb 100644&lt;br/&gt;
&amp;#8212; a/streams/src/test/java/org/apache/kafka/test/KStreamTestDriver.java&lt;br/&gt;
+++ b/streams/src/test/java/org/apache/kafka/test/KStreamTestDriver.java&lt;br/&gt;
@@ -42,6 +42,7 @@&lt;br/&gt;
 import java.util.List;&lt;br/&gt;
 import java.util.Map;&lt;br/&gt;
 import java.util.Set;&lt;br/&gt;
+import java.util.regex.Pattern;&lt;/p&gt;

&lt;p&gt; public class KStreamTestDriver extends ExternalResource {&lt;/p&gt;

&lt;p&gt;@@ -184,9 +185,15 @@ public void process(final String topicName, final Object key, final Object value&lt;/p&gt;

&lt;p&gt;     private ProcessorNode sourceNodeByTopicName(final String topicName) {&lt;br/&gt;
         ProcessorNode topicNode = topology.source(topicName);&lt;br/&gt;
-&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (topicNode == null &amp;amp;&amp;amp; globalTopology != null) {&lt;/li&gt;
	&lt;li&gt;topicNode = globalTopology.source(topicName);&lt;br/&gt;
+        if (topicNode == null) {&lt;br/&gt;
+            for (final String sourceTopic : topology.sourceTopics()) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+                if (Pattern.compile(sourceTopic).matcher(topicName).matches()) {
+                    return topology.source(sourceTopic);
+                }+            }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;+            if (globalTopology != null) &lt;/p&gt;
{
+                topicNode = globalTopology.source(topicName);
+            }
&lt;p&gt;         }&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         return topicNode;&lt;br/&gt;
diff --git a/streams/test-utils/src/main/java/org/apache/kafka/streams/TopologyTestDriver.java b/streams/test-utils/src/main/java/org/apache/kafka/streams/TopologyTestDriver.java&lt;br/&gt;
index 7730beddd0e..c03bf1a2e56 100644&lt;br/&gt;
&amp;#8212; a/streams/test-utils/src/main/java/org/apache/kafka/streams/TopologyTestDriver.java&lt;br/&gt;
+++ b/streams/test-utils/src/main/java/org/apache/kafka/streams/TopologyTestDriver.java&lt;br/&gt;
@@ -34,6 +34,7 @@&lt;br/&gt;
 import org.apache.kafka.common.utils.LogContext;&lt;br/&gt;
 import org.apache.kafka.common.utils.Time;&lt;br/&gt;
 import org.apache.kafka.streams.errors.LogAndContinueExceptionHandler;&lt;br/&gt;
+import org.apache.kafka.streams.errors.TopologyException;&lt;br/&gt;
 import org.apache.kafka.streams.processor.ProcessorContext;&lt;br/&gt;
 import org.apache.kafka.streams.processor.PunctuationType;&lt;br/&gt;
 import org.apache.kafka.streams.processor.Punctuator;&lt;br/&gt;
@@ -75,6 +76,7 @@&lt;br/&gt;
 import java.util.Set;&lt;br/&gt;
 import java.util.concurrent.TimeUnit;&lt;br/&gt;
 import java.util.concurrent.atomic.AtomicLong;&lt;br/&gt;
+import java.util.regex.Pattern;&lt;/p&gt;

&lt;p&gt; /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;This class makes it easier to write tests to verify the behavior of topologies created with 
{@link Topology}
&lt;p&gt; or&lt;br/&gt;
@@ -328,7 +330,10 @@ public void onRestoreEnd(final TopicPartition topicPartition, final String store&lt;br/&gt;
     public void pipeInput(final ConsumerRecord&amp;lt;byte[], byte[]&amp;gt; consumerRecord) {&lt;br/&gt;
         final String topicName = consumerRecord.topic();&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final TopicPartition topicPartition = partitionsByTopic.get(topicName);&lt;br/&gt;
+        if (!internalTopologyBuilder.getSourceTopicNames().isEmpty()) 
{
+            validateSourceTopicNameRegexPattern(consumerRecord.topic());
+        }
&lt;p&gt;+        final TopicPartition topicPartition = getTopicPartition(topicName);&lt;br/&gt;
         if (topicPartition != null) {&lt;br/&gt;
             final long offset = offsetsByTopicPartition.get(topicPartition).incrementAndGet() - 1;&lt;br/&gt;
             task.addRecords(topicPartition, Collections.singleton(new ConsumerRecord&amp;lt;&amp;gt;(&lt;br/&gt;
@@ -371,6 +376,28 @@ public void pipeInput(final ConsumerRecord&amp;lt;byte[], byte[]&amp;gt; consumerRecord) {&lt;br/&gt;
         }&lt;br/&gt;
     }&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;+    private void validateSourceTopicNameRegexPattern(final String inputRecordTopic) {&lt;br/&gt;
+        for (final String sourceTopicName : internalTopologyBuilder.getSourceTopicNames()) {&lt;br/&gt;
+            if (!sourceTopicName.equals(inputRecordTopic) &amp;amp;&amp;amp; Pattern.compile(sourceTopicName).matcher(inputRecordTopic).matches()) &lt;/p&gt;
{
+                throw new TopologyException(&quot;Topology add source of type String for topic: &quot; + sourceTopicName +
+                        &quot; cannot contain regex pattern for input record topic: &quot; + inputRecordTopic +
+                        &quot; and hence cannot process the message.&quot;);
+            }
&lt;p&gt;+        }&lt;br/&gt;
+    }&lt;br/&gt;
+&lt;br/&gt;
+    private TopicPartition getTopicPartition(final String topicName) {&lt;br/&gt;
+        final TopicPartition topicPartition = partitionsByTopic.get(topicName);&lt;br/&gt;
+        if (topicPartition == null) {&lt;br/&gt;
+            for (final Map.Entry&amp;lt;String, TopicPartition&amp;gt; entry : partitionsByTopic.entrySet()) {&lt;br/&gt;
+                if (Pattern.compile(entry.getKey()).matcher(topicName).matches()) &lt;/p&gt;
{
+                    return entry.getValue();
+                }
&lt;p&gt;+            }&lt;br/&gt;
+        }&lt;br/&gt;
+        return topicPartition;&lt;br/&gt;
+    }&lt;br/&gt;
+&lt;br/&gt;
     private void captureOutputRecords() {&lt;br/&gt;
         // Capture all the records sent to the producer ...&lt;br/&gt;
         final List&amp;lt;ProducerRecord&amp;lt;byte[], byte[]&amp;gt;&amp;gt; output = producer.history();&lt;br/&gt;
diff --git a/streams/test-utils/src/test/java/org/apache/kafka/streams/TopologyTestDriverTest.java b/streams/test-utils/src/test/java/org/apache/kafka/streams/TopologyTestDriverTest.java&lt;br/&gt;
index d757f3384b9..077b8ca3992 100644&lt;br/&gt;
&amp;#8212; a/streams/test-utils/src/test/java/org/apache/kafka/streams/TopologyTestDriverTest.java&lt;br/&gt;
+++ b/streams/test-utils/src/test/java/org/apache/kafka/streams/TopologyTestDriverTest.java&lt;br/&gt;
@@ -28,6 +28,7 @@&lt;br/&gt;
 import org.apache.kafka.common.utils.Bytes;&lt;br/&gt;
 import org.apache.kafka.common.utils.SystemTime;&lt;br/&gt;
 import org.apache.kafka.streams.kstream.Materialized;&lt;br/&gt;
+import org.apache.kafka.streams.errors.TopologyException;&lt;br/&gt;
 import org.apache.kafka.streams.processor.Processor;&lt;br/&gt;
 import org.apache.kafka.streams.processor.ProcessorContext;&lt;br/&gt;
 import org.apache.kafka.streams.processor.ProcessorSupplier;&lt;br/&gt;
@@ -54,6 +55,7 @@&lt;br/&gt;
 import java.util.Objects;&lt;br/&gt;
 import java.util.Properties;&lt;br/&gt;
 import java.util.Set;&lt;br/&gt;
+import java.util.regex.Pattern;&lt;/p&gt;

&lt;p&gt; import static org.hamcrest.CoreMatchers.equalTo;&lt;br/&gt;
 import static org.junit.Assert.assertEquals;&lt;br/&gt;
@@ -902,11 +904,11 @@ public void close() {}&lt;br/&gt;
             );&lt;br/&gt;
         }&lt;br/&gt;
     }&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;p&gt;+&lt;br/&gt;
     @Test&lt;br/&gt;
     public void shouldFeedStoreFromGlobalKTable() {&lt;br/&gt;
         final StreamsBuilder builder = new StreamsBuilder();&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;builder.globalTable(&quot;topic&quot;,&lt;br/&gt;
+        builder.globalTable(&quot;topic&quot;,&lt;br/&gt;
             Consumed.with(Serdes.String(), Serdes.String()),&lt;br/&gt;
             Materialized.&amp;lt;String, String, KeyValueStore&amp;lt;Bytes, byte[]&amp;gt;&amp;gt;as(&quot;globalStore&quot;));&lt;br/&gt;
         try (final TopologyTestDriver testDriver = new TopologyTestDriver(builder.build(), config)) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {@@ -919,4 +921,98 @@ public void shouldFeedStoreFromGlobalKTable() {
             Assert.assertEquals(&quot;value1&quot;, globalStore.get(&quot;k1&quot;));
         }     }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;+&lt;br/&gt;
+    private Topology setupMultipleSourcesPatternTopology(final Pattern... sourceTopicPatternNames) &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+        final Topology topology = new Topology();++        final String[] processorNames = new String[sourceTopicPatternNames.length];+        int i = 0;+        for (final Pattern sourceTopicPatternName }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;+&lt;br/&gt;
+    @Test&lt;br/&gt;
+    public void shouldProcessFromSourcesThatMatchMultiplePattern() &lt;/p&gt;
{
+
+        final  Pattern pattern2Source1 = Pattern.compile(&quot;source-topic-\\d&quot;);
+        final  Pattern pattern2Source2 = Pattern.compile(&quot;source-topic-[A-Z]&quot;);
+        final  String consumerTopic2 = &quot;source-topic-Z&quot;;
+
+        final ConsumerRecord&amp;lt;byte[], byte[]&amp;gt; consumerRecord2 = consumerRecordFactory.create(consumerTopic2, key2, value2, timestamp2);
+
+        testDriver = new TopologyTestDriver(setupMultipleSourcesPatternTopology(pattern2Source1, pattern2Source2), config);
+
+        final List&amp;lt;Record&amp;gt; processedRecords1 = mockProcessors.get(0).processedRecords;
+        final List&amp;lt;Record&amp;gt; processedRecords2 = mockProcessors.get(1).processedRecords;
+
+        testDriver.pipeInput(consumerRecord1);
+
+        assertEquals(1, processedRecords1.size());
+        assertEquals(0, processedRecords2.size());
+
+        final Record record1 = processedRecords1.get(0);
+        final Record expectedResult1 = new Record(consumerRecord1);
+        expectedResult1.offset = 0L;
+        assertThat(record1, equalTo(expectedResult1));
+
+        testDriver.pipeInput(consumerRecord2);
+
+        assertEquals(1, processedRecords1.size());
+        assertEquals(1, processedRecords2.size());
+
+        final Record record2 = processedRecords2.get(0);
+        final Record expectedResult2 = new Record(consumerRecord2);
+        expectedResult2.offset = 0L;
+        assertThat(record2, equalTo(expectedResult2));
+    }
&lt;p&gt;+&lt;br/&gt;
+    @Test&lt;br/&gt;
+    public void shouldProcessFromSourceThatMatchPattern() &lt;/p&gt;
{
+        final String sourceName = &quot;source&quot;;
+        final Pattern pattern2Source1 = Pattern.compile(&quot;source-topic-\\d&quot;);
+
+        final Topology topology = new Topology();
+
+        topology.addSource(sourceName, pattern2Source1);
+        topology.addSink(&quot;sink&quot;, SINK_TOPIC_1, sourceName);
+
+        testDriver = new TopologyTestDriver(topology, config);
+        testDriver.pipeInput(consumerRecord1);
+
+        final ProducerRecord outputRecord = testDriver.readOutput(SINK_TOPIC_1);
+        assertEquals(key1, outputRecord.key());
+        assertEquals(value1, outputRecord.value());
+        assertEquals(SINK_TOPIC_1, outputRecord.topic());
+    }
&lt;p&gt;+&lt;br/&gt;
+    @Test&lt;br/&gt;
+    public void shouldThrowPatternNotValidForTopicNameException() &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+        final String sourceName = &amp;quot;source&amp;quot;;+        final String pattern2Source1 = &amp;quot;source-topic-\d&amp;quot;;++        final Topology topology = new Topology();++        topology.addSource(sourceName, pattern2Source1);+        topology.addSink(&amp;quot;sink&amp;quot;, SINK_TOPIC_1, sourceName);++        testDriver = new TopologyTestDriver(topology, config);+        try {
+            testDriver.pipeInput(consumerRecord1);
+        } catch (final TopologyException exception) {
+            String str =
+                    String.format(
+                            &quot;Invalid topology: Topology add source of type String for topic: %s cannot contain regex pattern for &quot; +
+                                    &quot;input record topic: %s and hence cannot process the message.&quot;,
+                            pattern2Source1,
+                            SOURCE_TOPIC_1);
+            assertEquals(str, exception.getMessage());
+        }+    }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt; }&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;





&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12962640">KAFKA-3625</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10431"><![CDATA[Important]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 30 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3f1dz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>