<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:37:59 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-858] High watermark values can be overwritten during controlled shutdown</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-858</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Race condition between controlled shutdown, actual process shutdown and high watermark checkpoint thread frequency can cause high watermark values for a subset of partitions to be overwritten. So even if the controller sends a complete list of partitions to the broker, the highwatermark for some partitions is still 0. This causes the follower to fetch from the leader&apos;s start offset.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12641669">KAFKA-858</key>
            <summary>High watermark values can be overwritten during controlled shutdown</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="nehanarkhede">Neha Narkhede</assignee>
                                    <reporter username="nehanarkhede">Neha Narkhede</reporter>
                        <labels>
                            <label>kafka-0.8</label>
                            <label>p1</label>
                    </labels>
                <created>Tue, 9 Apr 2013 17:28:21 +0000</created>
                <updated>Tue, 9 Apr 2013 22:01:42 +0000</updated>
                            <resolved>Tue, 9 Apr 2013 22:01:27 +0000</resolved>
                                    <version>0.8.0</version>
                                                    <component>replication</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13626902" author="nehanarkhede" created="Tue, 9 Apr 2013 18:12:10 +0000"  >&lt;p&gt;-This is a corner case bug that shows up only if, after the controlled shutdown is issued to the broker and before the broker actually shuts down, the high watermark checkpoint thread wakes up and writes the high watermarks.&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Since we depend on allPartitions map to checkpoint high watermarks, I think the safest and least intrusive fix is to never remove partitions from that map. If we do, then we run into a risk of overwriting high watermark values for a partition.&lt;/li&gt;
	&lt;li&gt;If we do the above, we have to take care that the partition is essentially dormant from the point of view of the broker. So getPartition() should not return partitions that have been stopped during controlled shutdown. This will take care of failing future produce/fetching or having purgatory return the proper error code. So I added a stoppedPartitions set that maintains the list of stopped partitions.&lt;/li&gt;
	&lt;li&gt;PartitionCount mbean will show only the alive partitions&lt;/li&gt;
	&lt;li&gt;Stop replica request is half baked right now, but we don&apos;t need to focus on fixing it since those changes will be pretty big, intrusive and risky. All we need to make sure is that when stop replica request is received, we stop the fetcher and remove the partition from leaderPartitions, so the broker does not attempt to shrink isr for such partitions.&lt;/li&gt;
	&lt;li&gt;Apart from the fix, I cleaned up logging in two places -&lt;br/&gt;
1. adding/removing fetchers to print partition the way the rest of the code does. This is required for ease of grepping for a particular partition&lt;br/&gt;
2. state change log during leader/follower request to remove redundant entries&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13626995" author="junrao" created="Tue, 9 Apr 2013 19:38:33 +0000"  >&lt;p&gt;Thanks for the patch. Great catch of this bug.&lt;/p&gt;

&lt;p&gt;Not sure about the change in ReplicaManager though. It seems that a simpler fix is to in stopReplica(), only remove a partition from allPartitions if deletePartition is true. A partition still exists if its fetcher is stopped. It only stops to exist if the controller decides to delete it (currently, only because of partition reassignment). At this point, it can be taken out of allPartitions.&lt;/p&gt;</comment>
                            <comment id="13627071" author="nehanarkhede" created="Tue, 9 Apr 2013 20:38:52 +0000"  >&lt;p&gt;Thanks for the review, Jun! Your suggestion is simpler, included that in the v2 patch.&lt;/p&gt;</comment>
                            <comment id="13627116" author="junrao" created="Tue, 9 Apr 2013 21:09:27 +0000"  >&lt;p&gt;Thanks for patch v2. +1.&lt;/p&gt;</comment>
                            <comment id="13627178" author="nehanarkhede" created="Tue, 9 Apr 2013 22:01:27 +0000"  >&lt;p&gt;Checked in patch v2, thanks for the reviews&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12577886" name="kafka-858-v2.patch" size="3940" author="nehanarkhede" created="Tue, 9 Apr 2013 20:38:52 +0000"/>
                            <attachment id="12577845" name="kafka-858.patch" size="5930" author="nehanarkhede" created="Tue, 9 Apr 2013 18:12:10 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>322085</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 32 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1jkl3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>322430</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>