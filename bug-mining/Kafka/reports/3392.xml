<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:31:54 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-14260] InMemoryKeyValueStore iterator still throws ConcurrentModificationException</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-14260</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;This is the same bug as &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7912&quot; title=&quot;In-memory key-value store does not support concurrent access &quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7912&quot;&gt;&lt;del&gt;KAFKA-7912&lt;/del&gt;&lt;/a&gt; which was then re-introduced by &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-8802&quot; title=&quot;ConcurrentSkipListMap shows performance regression in cache and in-memory store&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-8802&quot;&gt;&lt;del&gt;KAFKA-8802&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Any iterator returned from &lt;tt&gt;InMemoryKeyValueStore&lt;/tt&gt; may end up throwing a ConcurrentModificationException because the backing map is not concurrent safe. I expect that this only happens when the store is retrieved from &lt;tt&gt;KafkaStreams.store()&lt;/tt&gt; from outside of the topology since any usage of the store from inside of the topology should be naturally single-threaded.&lt;/p&gt;

&lt;p&gt;To start off, a reminder that this behaviour explicitly violates the interface contract for &lt;tt&gt;ReadOnlyKeyValueStore&lt;/tt&gt; which states&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;The returned iterator must be safe from java.util.ConcurrentModificationExceptions&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;It is often complicated to make code to demonstrate concurrency bugs, but thankfully it is trivial to reason through the source code in &lt;tt&gt;InMemoryKeyValueStore.java&lt;/tt&gt; to show why this happens:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;All of the InMemoryKeyValueStore methods that return iterators do so by passing a keySet based on the backing TreeMap to the InMemoryKeyValueIterator constructor.&lt;/li&gt;
	&lt;li&gt;These keySets are all VIEWS of the backing map, not copies.&lt;/li&gt;
	&lt;li&gt;The InMemoryKeyValueIterator then makes a private copy of the keySet by passing the original keySet into the constructor for TreeSet. This copying was implemented in &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-8802&quot; title=&quot;ConcurrentSkipListMap shows performance regression in cache and in-memory store&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-8802&quot;&gt;&lt;del&gt;KAFKA-8802&lt;/del&gt;&lt;/a&gt;, incorrectly intending it to fix the concurrency problem.&lt;/li&gt;
	&lt;li&gt;TreeSet then iterates over the keySet to make a copy. If the original backing TreeMap in InMemoryKeyValueStore is changed while this copy is being created it will fail-fast a ConcurrentModificationException.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;This bug should be able to be trivially fixed by replacing the backing TreeMap with a ConcurrentSkipListMap but here&apos;s the rub:&lt;/p&gt;

&lt;p&gt;This bug has already been found in &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7912&quot; title=&quot;In-memory key-value store does not support concurrent access &quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7912&quot;&gt;&lt;del&gt;KAFKA-7912&lt;/del&gt;&lt;/a&gt; and the TreeMap was replaced with a ConcurrentSkipListMap. It was then reverted back to a TreeMap in &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-8802&quot; title=&quot;ConcurrentSkipListMap shows performance regression in cache and in-memory store&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-8802&quot;&gt;&lt;del&gt;KAFKA-8802&lt;/del&gt;&lt;/a&gt; because of the performance regression. I can &lt;a href=&quot;https://github.com/apache/kafka/pull/7212/commits/384c12e40f3a59591f897d916f92253e126820ed&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;see from one of the PRs&lt;/a&gt; that it was believed the concurrency problem with the TreeMap implementation was fixed by copying the keyset when the iterator is created but the problem remains, plus the fix creates an extra copy of the iterated portion of the set in memory.&lt;/p&gt;

&lt;p&gt;For what it&apos;s worth, the performance difference between TreeMap and ConcurrentSkipListMap do not extend into complexity. TreeMap enjoys a similar ~2x speed through all operations with any size of data, but at the cost of what turned out to be an easy-to-encounter bug.&lt;/p&gt;

&lt;p&gt;This is all unfortunate since the only time the state stores ever get accessed concurrently is through the `KafkaStreams.store()` mechanism, but I would imagine that &quot;correct and slightly slower) is better than &quot;incorrect and faster&quot;.&lt;/p&gt;

&lt;p&gt;Too bad BoilerBay&apos;s AirConcurrentMap is closed-source and patented.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13482990">KAFKA-14260</key>
            <summary>InMemoryKeyValueStore iterator still throws ConcurrentModificationException</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="Cerchie">Lucia Cerchie</assignee>
                                    <reporter username="aviperksy">Avi Cherry</reporter>
                        <labels>
                    </labels>
                <created>Sat, 24 Sep 2022 00:12:04 +0000</created>
                <updated>Sat, 10 Dec 2022 03:35:28 +0000</updated>
                            <resolved>Wed, 7 Dec 2022 03:42:03 +0000</resolved>
                                    <version>2.3.1</version>
                    <version>3.2.3</version>
                                    <fixVersion>3.4.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="17609705" author="guozhang" created="Mon, 26 Sep 2022 22:32:48 +0000"  >&lt;p&gt;Hello &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aviperksy&quot; class=&quot;user-hover&quot; rel=&quot;aviperksy&quot;&gt;aviperksy&lt;/a&gt; just checking is &lt;a href=&quot;https://github.com/apache/kafka/pull/11367&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/11367&lt;/a&gt; related?&lt;/p&gt;</comment>
                            <comment id="17609709" author="JIRAUSER296119" created="Mon, 26 Sep 2022 22:43:28 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; as far as I can see, your PR with the &quot;copyOnRange&quot; flag set does not manage to avoid the concurrency problem. InMemoryKeyValueStore.java line 125 still creates the iterator using the original map, and if that original map is a TreeMap then the iteration over the TreeMap when you&apos;re copying it/(or parts of it) will eventually result in a ConcurrentModificationException if the map is modified during the iteration. When the flag is not set, your PR uses a ConcurrentSkipListMap which is immune to ConcurrentModificationExceptions.&lt;/p&gt;</comment>
                            <comment id="17612164" author="guozhang" created="Mon, 3 Oct 2022 03:26:34 +0000"  >&lt;p&gt;Hello &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aviperksy&quot; class=&quot;user-hover&quot; rel=&quot;aviperksy&quot;&gt;aviperksy&lt;/a&gt; sorry for the late reply! I looked at the code again and I think I agree with you &amp;#8212; we are probably looking at different versions of the source code since in latest trunk, line 125 seems irrelevant (&lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/streams/src/main/java/org/apache/kafka/streams/state/internals/InMemoryKeyValueStore.java#L125&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/trunk/streams/src/main/java/org/apache/kafka/streams/state/internals/InMemoryKeyValueStore.java#L125&lt;/a&gt;) &amp;#8212; but the thing is that at the time when this line was called:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (forward) {
                &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.iter = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TreeSet&amp;lt;&amp;gt;(keySet).iterator();
            } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
                &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.iter = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TreeSet&amp;lt;&amp;gt;(keySet).descendingIterator();
            }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;in which the constructor of &lt;tt&gt;TreeSet&lt;/tt&gt; loops over the &lt;tt&gt;keySet&lt;/tt&gt;, if that &lt;tt&gt;keySet&lt;/tt&gt;&apos;s underlying map is modified then we will still have an issue. As for the fix, I think in the near term we&apos;d have to bite the bullet of performance can turn back to ConcurrentSkipListMap (we may tune some initial params e.g. using concurrencyLevel of 1). In the long term, I think we could leverage on similar ideas we are pursuing for transactional state stores, where we keep two in-memory maps, and the first map is read-only for IQ, and second is used to maintain deltas within a commit interval and during processing, we&apos;d need to read both maps, and upon committing we lock the first one to apply the deltas.&lt;/p&gt;

&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ableegoldman&quot; class=&quot;user-hover&quot; rel=&quot;ableegoldman&quot;&gt;ableegoldman&lt;/a&gt; what do you think?&lt;/p&gt;</comment>
                            <comment id="17632093" author="ableegoldman" created="Fri, 11 Nov 2022 06:07:26 +0000"  >&lt;p&gt;Seems like we should just make sure to synchronize when making an iterator/copying the key set, right? Actually it looks like most of the methods already are but I notice that the new #prefixScan for example is not. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aviperksy&quot; class=&quot;user-hover&quot; rel=&quot;aviperksy&quot;&gt;aviperksy&lt;/a&gt;&#160; were you using that API when you saw this ConcurrentModificationException?&lt;/p&gt;

&lt;p&gt;It would really be a bummer if we had to go back to the ConcurrentSkipList, it just could not keep up with the basic TreeSet especially for larger stores :/ Of course if we have to then we have to, but we should make sure to exhaust the alternatives before we settle on that&lt;/p&gt;</comment>
                            <comment id="17633855" author="JIRAUSER298120" created="Mon, 14 Nov 2022 14:57:34 +0000"  >&lt;p&gt;Getting to work adding the missing `sychronized`.&#160;&lt;/p&gt;</comment>
                            <comment id="17644129" author="ableegoldman" created="Wed, 7 Dec 2022 04:13:25 +0000"  >&lt;p&gt;Ok I did merge a patch to fix where we forgot to synchronize, which is certainly a bug leading to potential CME, but I realize that&apos;s not what this ticket was about so I want to explain why I resolved it: ie that synchronization is sufficient for avoiding CMEs. I do think you pointed out something of note here, though, which is worth following up on though perhaps tracking separately.&lt;/p&gt;

&lt;p&gt;In the IMKVIterator constructor from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt;&apos;s snippet above, it&apos;s true we get an iterator based on the original map, but it&apos;s still just a copy of that map: so this iterator doesn&apos;t pin any part of the original map and just happily returns the set of keys that were in the original map when the range API was invoked. There&apos;s no way to modify the contents of this copy as it&apos;s internal to the (also internal) iterator, and even if you delete a record with a given key in that store, the actual key object itself still exists (and can/will still be returned by that iterator)&lt;/p&gt;

&lt;p&gt;So I really don&apos;t see how a CME is possible if we properly synchronize the APIs to enforce single-threaded access while that copy is being made. Which we do (now, since merging &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Cerchie&quot; class=&quot;user-hover&quot; rel=&quot;Cerchie&quot;&gt;Cerchie&lt;/a&gt; &apos;s PR)&lt;/p&gt;

&lt;p&gt;That said, it still feels a bit awkward because the keyset-copy iterator can return keys that no longer exist in the actual store. In this case when we issue a get on that key it&apos;ll return null, and the range read will have an entry with a null value. Technically Streams makes no guarantees about whether a range scan will reflect only the original state store contents or only the latest contents or anything in between, and I&apos;m not sure there&apos;s even a &quot;right&quot; answer there.&lt;/p&gt;

&lt;p&gt;Still, returning a KeyValue(&quot;key1&quot;, null) is still pretty awkward and likely unexpected by most users, so I &lt;em&gt;can&lt;/em&gt; this resulting in an NPE. Fortunately that&apos;s a much easier fix, as we can just toss out that result and return whatever is next. I think it&apos;s worth filing a separate ticket for that one, though&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aviperksy&quot; class=&quot;user-hover&quot; rel=&quot;aviperksy&quot;&gt;aviperksy&lt;/a&gt; thoughts? Did I miss something obvious here? Also note that the code has changed a lot over the years, so it&apos;s possible what you described does affect some older branch(es)&lt;/p&gt;</comment>
                            <comment id="17645545" author="ableegoldman" created="Sat, 10 Dec 2022 03:35:28 +0000"  >&lt;p&gt;Well, actually, it turns out we are breaking a public contract here because I just happened to notice that we do in fact assert that null values shouldn&apos;t be returned. So I filed &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-14460&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-14460&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 48 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z18t0o:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>