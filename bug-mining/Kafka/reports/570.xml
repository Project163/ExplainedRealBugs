<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:42:08 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-1721] Snappy compressor is not thread safe</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-1721</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;From the mailing list, it can generate this exception:&lt;/p&gt;

&lt;p&gt;2014-10-20 18:55:21.841 &lt;span class=&quot;error&quot;&gt;&amp;#91;kafka-producer-network-thread&amp;#93;&lt;/span&gt; ERROR&lt;br/&gt;
org.apache.kafka.clients.producer.internals.Sender - Uncaught error in&lt;br/&gt;
kafka producer I/O thread:&lt;br/&gt;
&lt;b&gt;java.lang.NullPointerException&lt;/b&gt;&lt;br/&gt;
at&lt;br/&gt;
org.xerial.snappy.BufferRecycler.releaseInputBuffer(BufferRecycler.java:153)&lt;br/&gt;
at org.xerial.snappy.SnappyOutputStream.close(SnappyOutputStream.java:317)&lt;br/&gt;
at java.io.FilterOutputStream.close(FilterOutputStream.java:160)&lt;br/&gt;
at org.apache.kafka.common.record.Compressor.close(Compressor.java:94)&lt;br/&gt;
at&lt;br/&gt;
org.apache.kafka.common.record.MemoryRecords.close(MemoryRecords.java:119)&lt;br/&gt;
at&lt;br/&gt;
org.apache.kafka.clients.producer.internals.RecordAccumulator.drain(RecordAccumulator.java:285)&lt;br/&gt;
at org.apache.kafka.clients.producer.internals.Sender.run(Sender.java:162)&lt;br/&gt;
at org.apache.kafka.clients.producer.internals.Sender.run(Sender.java:115)&lt;br/&gt;
at java.lang.Thread.run(Thread.java:744)&lt;/p&gt;

&lt;p&gt;This appears to be an issue with the snappy-java library using ThreadLocal for an internal buffer recycling object which results in that object being shared unsafely across threads if one thread sends to multiple producers:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;I think the issue is that you&apos;re&lt;br/&gt;
using all your producers across a thread pool and the snappy library&lt;br/&gt;
uses ThreadLocal BufferRecyclers. When new Snappy streams are allocated,&lt;br/&gt;
they may be allocated from the same thread (e.g. one of your MyProducer&lt;br/&gt;
classes calls Producer.send() on multiple producers from the same&lt;br/&gt;
thread) and therefore use the same BufferRecycler. Eventually you hit&lt;br/&gt;
the code in the stacktrace, and if two producer send threads hit it&lt;br/&gt;
concurrently they improperly share the unsynchronized BufferRecycler.&lt;/p&gt;

&lt;p&gt;This seems like a pain to fix &amp;#8211; it&apos;s really a deficiency of the snappy&lt;br/&gt;
library and as far as I can see there&apos;s no external control over&lt;br/&gt;
BufferRecycler in their API. One possibility is to record the thread ID&lt;br/&gt;
when we generate a new stream in Compressor and use that to synchronize&lt;br/&gt;
access to ensure no concurrent BufferRecycler access. That could be made&lt;br/&gt;
specific to snappy so it wouldn&apos;t impact other codecs. Not exactly&lt;br/&gt;
ideal, but it would work. Unfortunately I can&apos;t think of any way for you&lt;br/&gt;
to protect against this in your own code since the problem arises in the&lt;br/&gt;
producer send thread, which your code should never know about.&lt;/p&gt;

&lt;p&gt;Another option would be to setup your producers differently to avoid the&lt;br/&gt;
possibility of unsynchronized access from multiple threads (i.e. don&apos;t&lt;br/&gt;
use the same thread pool approach), but whether you can do that will&lt;br/&gt;
depend on your use case.&lt;/p&gt;&lt;/blockquote&gt;</description>
                <environment></environment>
        <key id="12749406">KAFKA-1721</key>
            <summary>Snappy compressor is not thread safe</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ewencp">Ewen Cheslack-Postava</assignee>
                                    <reporter username="ewencp">Ewen Cheslack-Postava</reporter>
                        <labels>
                    </labels>
                <created>Tue, 21 Oct 2014 01:55:46 +0000</created>
                <updated>Fri, 14 Nov 2014 23:25:05 +0000</updated>
                            <resolved>Fri, 14 Nov 2014 23:25:05 +0000</resolved>
                                                    <fixVersion>0.8.2.0</fixVersion>
                                    <component>compression</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14178856" author="bmis13" created="Tue, 21 Oct 2014 19:01:14 +0000"  >&lt;p&gt;I have filled &lt;a href=&quot;https://github.com/xerial/snappy-java/issues/88&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/xerial/snappy-java/issues/88&lt;/a&gt; for tracking for Snappy. &lt;/p&gt;

&lt;p&gt;There is patch provided and Thanks to &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ewencp&quot; class=&quot;user-hover&quot; rel=&quot;ewencp&quot;&gt;ewencp&lt;/a&gt; for testing the patch.  Please see above link for more details.&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Bhavesh &lt;/p&gt;</comment>
                            <comment id="14181730" author="bmis13" created="Thu, 23 Oct 2014 18:32:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ewencp&quot; class=&quot;user-hover&quot; rel=&quot;ewencp&quot;&gt;ewencp&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;Thanks for fixing this issue.  Snappy Dev has release new version with fix &lt;a href=&quot;https://oss.sonatype.org/content/repositories/releases/org/xerial/snappy/snappy-java/1.1.1.4/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://oss.sonatype.org/content/repositories/releases/org/xerial/snappy/snappy-java/1.1.1.4/&lt;/a&gt; &lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
Bhavesh&lt;/p&gt;</comment>
                            <comment id="14182127" author="junrao" created="Thu, 23 Oct 2014 22:58:43 +0000"  >&lt;p&gt;Bhavesh,&lt;/p&gt;

&lt;p&gt;Do you want to submit a patch to upgrade the snappy jar in Kafka? Thanks,&lt;/p&gt;</comment>
                            <comment id="14182130" author="ewencp" created="Thu, 23 Oct 2014 23:00:37 +0000"  >&lt;p&gt;I have the trivial patch, but the upstream jar seems to be broken (see the earlier Github issue). I&apos;ll follow up on this once that issue is resolved.&lt;/p&gt;</comment>
                            <comment id="14182280" author="ewencp" created="Fri, 24 Oct 2014 01:17:28 +0000"  >&lt;p&gt;Created reviewboard &lt;a href=&quot;https://reviews.apache.org/r/27124/diff/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/27124/diff/&lt;/a&gt;&lt;br/&gt;
 against branch origin/trunk&lt;/p&gt;</comment>
                            <comment id="14187033" author="ewencp" created="Tue, 28 Oct 2014 16:25:56 +0000"  >&lt;p&gt;Updated reviewboard &lt;a href=&quot;https://reviews.apache.org/r/27124/diff/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/27124/diff/&lt;/a&gt;&lt;br/&gt;
 against branch origin/trunk&lt;/p&gt;</comment>
                            <comment id="14212611" author="ewencp" created="Fri, 14 Nov 2014 18:42:18 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=junrao&quot; class=&quot;user-hover&quot; rel=&quot;junrao&quot;&gt;junrao&lt;/a&gt; This is a trivial version update patch. It would be nice for the fix to make it to 0.8.2, but I&apos;m not sure we want to push a dependency version change between beta and final.&lt;/p&gt;</comment>
                            <comment id="14213059" author="junrao" created="Fri, 14 Nov 2014 23:25:05 +0000"  >&lt;p&gt;Thanks for the patch. Since this change is trivial, double committed to 0.8.2 and trunk.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12676804" name="KAFKA-1721.patch" size="727" author="ewencp" created="Fri, 24 Oct 2014 01:17:27 +0000"/>
                            <attachment id="12677626" name="KAFKA-1721_2014-10-28_09:25:50.patch" size="1489" author="ewencp" created="Tue, 28 Oct 2014 16:25:55 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 1 week, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i21dvb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>junrao</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>