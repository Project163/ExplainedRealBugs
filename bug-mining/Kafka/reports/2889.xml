<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:26:42 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-10413] rebalancing leads to unevenly balanced connectors</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-10413</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;GHi,&lt;/p&gt;

&lt;p&gt;With CP 5.5, running kafka connect s3 sink on EC2 whith autoscaling enabled, if a connect instance disappear, or a new one appear, we&apos;re seeing unbalanced consumption, much like mentionned in this post:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://stackoverflow.com/questions/58644622/incremental-cooperative-rebalancing-leads-to-unevenly-balanced-connectors&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://stackoverflow.com/questions/58644622/incremental-cooperative-rebalancing-leads-to-unevenly-balanced-connectors&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;This usually leads to one kafka connect instance taking most of the load and consumption not being able to keep on.&lt;br/&gt;
Currently, we&apos;re &quot;fixing&quot; this by deleting the connector and re-creating it, but this is far from ideal.&lt;/p&gt;

&lt;p&gt;Any suggestion on what we could do to mitigate this ?&lt;/p&gt;</description>
                <environment></environment>
        <key id="13323350">KAFKA-10413</key>
            <summary>rebalancing leads to unevenly balanced connectors</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ramkrish1489">rameshkrishnan muthusamy</assignee>
                                    <reporter username="yazgoo">yazgoo</reporter>
                        <labels>
                    </labels>
                <created>Tue, 18 Aug 2020 12:35:22 +0000</created>
                <updated>Thu, 27 Jun 2024 15:14:43 +0000</updated>
                            <resolved>Tue, 25 Jun 2024 11:08:17 +0000</resolved>
                                    <version>2.5.1</version>
                                    <fixVersion>2.4.2</fixVersion>
                    <fixVersion>2.5.2</fixVersion>
                    <fixVersion>2.6.2</fixVersion>
                    <fixVersion>2.7.1</fixVersion>
                    <fixVersion>2.8.0</fixVersion>
                                    <component>connect</component>
                        <due></due>
                            <votes>4</votes>
                                    <watches>13</watches>
                                                                                                                <comments>
                            <comment id="17192827" author="baz33" created="Wed, 9 Sep 2020 12:23:22 +0000"  >&lt;p&gt;I have this issue too when EC2 scale in (S3 sink connector).&lt;br/&gt;
 It seems that using the old&#160;connect.protocol=eager result in a well balanced tasks across the workers.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://stackoverflow.com/questions/63348308/how-to-get-kafka-connect-to-balance-tasks-connectors-evenly&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://stackoverflow.com/questions/63348308/how-to-get-kafka-connect-to-balance-tasks-connectors-evenly&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Here is a screenshot of tasks monitoring distibution by EC2 with scale in at 19h30.&lt;/p&gt;

&lt;p&gt;We can see that the new workers are poorly distributed compared to other one.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13011272/13011272_connect_worker_balanced.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="17193402" author="ramkrish1489" created="Thu, 10 Sep 2020 06:45:39 +0000"  >&lt;p&gt;This is an issue starting with Kafka version 2.4.x onwards. The only work around I could find is to switch back to eager protocol which defeats the purpose of incremental cooperative rebalancing all together.&#160;&lt;/p&gt;</comment>
                            <comment id="17194047" author="rossierfl" created="Fri, 11 Sep 2020 06:57:37 +0000"  >&lt;p&gt;Hi,&#160;&lt;/p&gt;

&lt;p&gt;We are also affected by this issue, seem&apos;s for us that is started with 2.3.0, when the incremental cooperative rebalancing was introduced.&lt;/p&gt;

&lt;p&gt;We mainly notice this issue with HDFS connectors on our side.&#160;&lt;/p&gt;

&lt;p&gt;BR&lt;/p&gt;</comment>
                            <comment id="17200015" author="ramkrish1489" created="Tue, 22 Sep 2020 11:27:27 +0000"  >&lt;p&gt;We have PR opened on &#160;this &lt;a href=&quot;https://github.com/apache/kafka/pull/9319&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/9319&lt;/a&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17277446" author="chrislee" created="Tue, 2 Feb 2021 20:47:11 +0000"  >&lt;p&gt;Hello, we&apos;re very excited the PR has been accepted and merged for this bug. Is there a fix-version?&#160;&lt;/p&gt;</comment>
                            <comment id="17277679" author="ramkrish1489" created="Wed, 3 Feb 2021 04:57:16 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chrisLee&quot; class=&quot;user-hover&quot; rel=&quot;chrisLee&quot;&gt;chrisLee&lt;/a&gt;&#160;we are looking to get this out fix in the next minor version release 2.7.1&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17278330" author="kkonstantine" created="Wed, 3 Feb 2021 19:58:15 +0000"  >&lt;p&gt;I&apos;m actually still in the process of cherry-picking into the previous release branches. Running the tests takes some time too.&#160;&lt;br/&gt;
I&apos;ll update the fixed versions and close the ticket once I&apos;m done very soon.&#160;&lt;/p&gt;

&lt;p&gt;Thanks again for the fix &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ramkrish1489&quot; class=&quot;user-hover&quot; rel=&quot;ramkrish1489&quot;&gt;ramkrish1489&lt;/a&gt;. Added you to the contributors list and assigned you the ticket&lt;/p&gt;</comment>
                            <comment id="17278617" author="rossierfl" created="Thu, 4 Feb 2021 07:32:55 +0000"  >&lt;p&gt;Thanks for this fix !&#160;&lt;/p&gt;</comment>
                            <comment id="17393227" author="yazgoo" created="Wed, 4 Aug 2021 14:38:04 +0000"  >&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;I&apos;m reopening this because I&apos;m still seeing this issue with CP 6.2.0 which ships with 2.8.0 which is marked as a fixed version.&lt;br/&gt;
We basically see the same behavior as mentioned in the issue description.&lt;/p&gt;</comment>
                            <comment id="17432564" author="stuxnet" created="Thu, 21 Oct 2021 15:46:46 +0000"  >&lt;p&gt;Hello,&#160;&lt;br/&gt;
I confirm that we also see the same issue, any news on this ?&lt;br/&gt;
Thanks&lt;/p&gt;</comment>
                            <comment id="17444846" author="preston.price" created="Tue, 16 Nov 2021 22:37:34 +0000"  >&lt;p&gt;I am experiencing this issue as well, and it&apos;s particularly nasty because we&apos;re running in kubernetes so we have to WAY over limit our CPU because we end up with very uneven distribution of tasks resulting in CPU throttling on the workers that get work over-allocated to them. I&apos;ve tried the mitigation of using connect.protocl=eager, but it seems my connector always gets back into an uneven state through pause/deploy/resume cycles.&lt;/p&gt;</comment>
                            <comment id="17477980" author="yazgoo" created="Tue, 18 Jan 2022 15:34:48 +0000"  >&lt;p&gt;Hi, any news on this issue ?&lt;br/&gt;
I&apos;m suspecting it is linked with &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-12495&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-12495&lt;/a&gt; (I tried the attached PR and did not see the unbalance occur).&lt;br/&gt;
The current way we found to mitigate this is to destroy / re-create the connectors.&lt;/p&gt;</comment>
                            <comment id="17810789" author="yazgoo" created="Thu, 25 Jan 2024 10:16:45 +0000"  >&lt;p&gt;Hello,&lt;/p&gt;

&lt;p&gt;One year later with CP 7.5, I still have the issue&lt;/p&gt;

&lt;p&gt;Regards&lt;/p&gt;</comment>
                            <comment id="17859905" author="sagarrao" created="Tue, 25 Jun 2024 11:08:17 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-12495&quot; title=&quot;Unbalanced connectors/tasks distribution will happen in Connect&amp;#39;s incremental cooperative assignor&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-12495&quot;&gt;&lt;del&gt;KAFKA-12495&lt;/del&gt;&lt;/a&gt; has been fixed.&lt;/p&gt;</comment>
                            <comment id="17859918" author="yazgoo" created="Tue, 25 Jun 2024 12:02:37 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sagarrao&quot; class=&quot;user-hover&quot; rel=&quot;sagarrao&quot;&gt;sagarrao&lt;/a&gt; , it did not fix it, I still have the issue with CP 7.6&lt;/p&gt;</comment>
                            <comment id="17859957" author="gharris1727" created="Tue, 25 Jun 2024 15:30:42 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yazgoo&quot; class=&quot;user-hover&quot; rel=&quot;yazgoo&quot;&gt;yazgoo&lt;/a&gt; Could you provide some more details that would help in debugging this, and open a new ticket? We currently don&apos;t have any leads for what could be causing the imbalance, and you could help with that.&lt;/p&gt;</comment>
                            <comment id="17859981" author="sagarrao" created="Tue, 25 Jun 2024 16:44:55 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yazgoo&quot; class=&quot;user-hover&quot; rel=&quot;yazgoo&quot;&gt;yazgoo&lt;/a&gt; , yeah as Greg mentioned can you provide more info. Also, looks like you are talking about Confluent platform while this ticket is for AK.&#160;&lt;/p&gt;</comment>
                            <comment id="17860408" author="yazgoo" created="Thu, 27 Jun 2024 09:59:22 +0000"  >&lt;p&gt;Hello, I launch the attached script :&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13069825/13069825_rebalance.sh&quot; title=&quot;rebalance.sh attached to KAFKA-10413&quot;&gt;rebalance.sh&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;And in my test after waiting for a few minutes, I get:&lt;/p&gt;

&lt;p&gt;one connect well balanced&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&#160;&#10095; curl -s http:&lt;span class=&quot;code-comment&quot;&gt;//localhost:8081/connectors/s3-connector2/status | jq .tasks |grep worker_id | sort | uniq -c
&lt;/span&gt;&#160; &#160; &#160;15 &#160; &#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;worker_id&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;k2:8082&quot;&lt;/span&gt;
&#160; &#160; &#160;15 &#160; &#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;worker_id&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;k3:8083&quot;&lt;/span&gt;
&#160; &#160; &#160;15 &#160; &#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;worker_id&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;k4:8084&quot;&lt;/span&gt;
&#160; &#160; &#160;15 &#160; &#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;worker_id&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;k5:8085&quot;&lt;/span&gt;
&#160; &#160; &#160;15 &#160; &#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;worker_id&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;k6:8086&quot;&lt;/span&gt;
&#160; &#160; &#160;15 &#160; &#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;worker_id&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;k7:8087&quot;&lt;/span&gt;
&#160; &#160; &#160;15 &#160; &#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;worker_id&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;k8:8088&quot;&lt;/span&gt;
&#160; &#160; &#160;15 &#160; &#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;worker_id&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;k9:8089&quot;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;And the other one unbalanced&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&#10095; curl -s http:&lt;span class=&quot;code-comment&quot;&gt;//localhost:8081/connectors/s3-connector1/status | jq .tasks |grep worker_id | sort | uniq -c
&lt;/span&gt;&#160; &#160; &#160;27 &#160; &#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;worker_id&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;k1:8081&quot;&lt;/span&gt;
&#160; &#160; &#160;11 &#160; &#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;worker_id&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;k2:8082&quot;&lt;/span&gt;
&#160; &#160; &#160;12 &#160; &#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;worker_id&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;k3:8083&quot;&lt;/span&gt;
&#160; &#160; &#160;11 &#160; &#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;worker_id&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;k4:8084&quot;&lt;/span&gt;
&#160; &#160; &#160;12 &#160; &#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;worker_id&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;k5:8085&quot;&lt;/span&gt;
&#160; &#160; &#160;12 &#160; &#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;worker_id&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;k6:8086&quot;&lt;/span&gt;
&#160; &#160; &#160;11 &#160; &#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;worker_id&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;k7:8087&quot;&lt;/span&gt;
&#160; &#160; &#160;12 &#160; &#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;worker_id&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;k8:8088&quot;&lt;/span&gt;
&#160; &#160; &#160;12 &#160; &#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;worker_id&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;k9:8089&quot;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Regards&lt;/p&gt;</comment>
                            <comment id="17860514" author="yazgoo" created="Thu, 27 Jun 2024 14:36:05 +0000"  >&lt;p&gt;Here is yet another simpler version of the script, with less workers and which does not try and restart any worker:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
#!/bin/bash
set -xe
dkill() {
&#160; docker stop &lt;span class=&quot;code-quote&quot;&gt;&quot;$1&quot;&lt;/span&gt; || &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
&#160; docker rm -v -f &lt;span class=&quot;code-quote&quot;&gt;&quot;$1&quot;&lt;/span&gt; || &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
}
write_topic() {
&#160; # write 200 messages to the topic
&#160; json=&lt;span class=&quot;code-quote&quot;&gt;&apos;{&lt;span class=&quot;code-quote&quot;&gt;&quot;name&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;test&quot;&lt;/span&gt;}&apos;&lt;/span&gt;
&#160; docker exec -i kafka bash -c &lt;span class=&quot;code-quote&quot;&gt;&quot;(&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; i in {1..200}; &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; echo &lt;span class=&quot;code-quote&quot;&gt;&apos;$json&apos;&lt;/span&gt;; done) | /opt/kafka/bin/kafka-console-producer.sh --bootstrap-server 0.0.0.0:9092 --topic test_topic$1&quot;&lt;/span&gt;
}

launch_minio() {
&#160; # Launch Minio (Fake S3)
&#160; docker run --network host -d --name minio \
&#160; &#160; -e MINIO_ROOT_USER=minioadmin \
&#160; &#160; -e MINIO_ROOT_PASSWORD=minioadmin \
&#160; &#160; minio/minio server --console-address :9001 /data
&#160; &#160; &#160; docker exec -it minio mkdir /data/my-minio-bucket
}
launch_kafka_connect() {
&#160; # Start Kafka Connect with S3 Connector
&#160; docker run --network host -d --name &lt;span class=&quot;code-quote&quot;&gt;&quot;kafka-connect$1&quot;&lt;/span&gt; \
&#160; &#160; -e &#160;AWS_ACCESS_KEY_ID=minioadmin \
&#160; &#160; -e &#160;AWS_SECRET_ACCESS_KEY=minioadmin \
&#160; &#160; -e &#160;CONNECT_REST_ADVERTISED_HOST_NAME=&lt;span class=&quot;code-quote&quot;&gt;&quot;k$1&quot;&lt;/span&gt; \
&#160; &#160; -e &#160;CONNECT_LISTENERS=&lt;span class=&quot;code-quote&quot;&gt;&quot;http:&lt;span class=&quot;code-comment&quot;&gt;//localhost:808$1&quot;&lt;/span&gt; \
&lt;/span&gt;&#160; &#160; -e &#160;CONNECT_BOOTSTRAP_SERVERS=0.0.0.0:9092 \
&#160; &#160; -e &#160;CONNECT_REST_PORT=&lt;span class=&quot;code-quote&quot;&gt;&quot;808$1&quot;&lt;/span&gt; \
&#160; &#160; -e &#160;CONNECT_GROUP_ID=&lt;span class=&quot;code-quote&quot;&gt;&quot;connect-cluster&quot;&lt;/span&gt; \
&#160; &#160; -e &#160;CONNECT_CONFIG_STORAGE_TOPIC=&lt;span class=&quot;code-quote&quot;&gt;&quot;connect-configs&quot;&lt;/span&gt; \
&#160; &#160; -e &#160;CONNECT_OFFSET_STORAGE_TOPIC=&lt;span class=&quot;code-quote&quot;&gt;&quot;connect-offsets&quot;&lt;/span&gt; \
&#160; &#160; -e &#160;CONNECT_STATUS_STORAGE_TOPIC=&lt;span class=&quot;code-quote&quot;&gt;&quot;connect-status&quot;&lt;/span&gt; \
&#160; &#160; -e &#160;CONNECT_KEY_CONVERTER=&lt;span class=&quot;code-quote&quot;&gt;&quot;org.apache.kafka.connect.json.JsonConverter&quot;&lt;/span&gt; \
&#160; &#160; -e &#160;CONNECT_VALUE_CONVERTER=&lt;span class=&quot;code-quote&quot;&gt;&quot;org.apache.kafka.connect.json.JsonConverter&quot;&lt;/span&gt; \
&#160; &#160; -e &#160;CONNECT_VALUE_CONVERTER_SCHEMAS_ENABLE=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt; \
&#160; &#160; -e &#160;CONNECT_INTERNAL_KEY_CONVERTER=&lt;span class=&quot;code-quote&quot;&gt;&quot;org.apache.kafka.connect.json.JsonConverter&quot;&lt;/span&gt; \
&#160; &#160; -e &#160;CONNECT_INTERNAL_VALUE_CONVERTER=&lt;span class=&quot;code-quote&quot;&gt;&quot;org.apache.kafka.connect.json.JsonConverter&quot;&lt;/span&gt; \
&#160; &#160; -e &#160;CONNECT_INTERNAL_VALUE_CONVERTER_SCHEMAS_ENABLE=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt; \
&#160; &#160; -e &#160;CONNECT_PLUGIN_PATH=&lt;span class=&quot;code-quote&quot;&gt;&quot;/usr/share/java,/usr/share/confluent-hub-components&quot;&lt;/span&gt; \
&#160; &#160; --entrypoint bash \
&#160; &#160; confluentinc/cp-kafka-connect:7.6.1 \
&#160; &#160; -c &lt;span class=&quot;code-quote&quot;&gt;&quot;confluent-hub install --no-prompt confluentinc/kafka-connect-s3:latest &amp;amp;&amp;amp; /etc/confluent/docker/run&quot;&lt;/span&gt;
}
cleanup_docker_env() {
&#160; docker volume prune -f
&#160; &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; container in $(&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; i in {1..9}; &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; echo &lt;span class=&quot;code-quote&quot;&gt;&quot;kafka-connect$i&quot;&lt;/span&gt;;done) kafka minio
&#160; &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt;
&#160; &#160; dkill &lt;span class=&quot;code-quote&quot;&gt;&quot;$container&quot;&lt;/span&gt;
&#160; done
}
launch_kafka() {
&#160; docker run --network host --hostname localhost --ulimit nofile=65536:65536 -d --name kafka -p 9092:9092 apache/kafka
&#160; &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; i in {1..2}
&#160; &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt;
&#160; &#160; # Create a Kafka topic
&#160; &#160; docker exec -it kafka /opt/kafka/bin/kafka-topics.sh --create --bootstrap-server 0.0.0.0:9092 --replication-factor 1 --partitions 120 --topic &lt;span class=&quot;code-quote&quot;&gt;&quot;test_topic$i&quot;&lt;/span&gt;
&#160; &#160; write_topic &lt;span class=&quot;code-quote&quot;&gt;&quot;$i&quot;&lt;/span&gt;
&#160; done
&#160; &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; topic in connect-configs connect-offsets connect-status
&#160; &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt;
&#160; &#160; # with cleanup.policy=compact, we can&apos;t have more than 1 partition
&#160; &#160; docker exec -it kafka /opt/kafka/bin/kafka-topics.sh --create --bootstrap-server 0.0.0.0:9092 --replication-factor 1 --partitions 1 --topic $topic --config cleanup.policy=compact
&#160; done
}
cleanup_docker_env
launch_kafka
launch_minio
launch_kafka_connect 1
&lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
&lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt;
&#160; sleep 5
&#160; # Check &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; Kafka Connect is up
&#160; curl http:&lt;span class=&quot;code-comment&quot;&gt;//localhost:8081/ || &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;
&lt;/span&gt;&#160; &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;
done
sleep 10
&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; i in {1..2}
&lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt;
# Set up a connector
curl -X POST -H &lt;span class=&quot;code-quote&quot;&gt;&quot;Content-Type: application/json&quot;&lt;/span&gt; --data &apos;{
&#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;name&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;s3-connector&lt;span class=&quot;code-quote&quot;&gt;&apos;&quot;&lt;/span&gt;$i&lt;span class=&quot;code-quote&quot;&gt;&quot;&apos;&lt;/span&gt;&quot;&lt;/span&gt;,
&#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;config&quot;&lt;/span&gt;: {
&#160; &#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;connector.class&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;io.confluent.connect.s3.S3SinkConnector&quot;&lt;/span&gt;,
&#160; &#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;tasks.max&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;120&quot;&lt;/span&gt;,
&#160; &#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;topics&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;test_topic&lt;span class=&quot;code-quote&quot;&gt;&apos;&quot;&lt;/span&gt;$i&lt;span class=&quot;code-quote&quot;&gt;&quot;&apos;&lt;/span&gt;&quot;&lt;/span&gt;,
&#160; &#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;s3.region&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;us-east-1&quot;&lt;/span&gt;,
&#160; &#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;store.url&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;http:&lt;span class=&quot;code-comment&quot;&gt;//0.0.0.0:9000&quot;&lt;/span&gt;,
&lt;/span&gt;&#160; &#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;s3.bucket.name&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;my-minio-bucket&quot;&lt;/span&gt;,
&#160; &#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;s3.part.size&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;5242880&quot;&lt;/span&gt;,
&#160; &#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;flush.size&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;3&quot;&lt;/span&gt;,
&#160; &#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;storage.class&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;io.confluent.connect.s3.storage.S3Storage&quot;&lt;/span&gt;,
&#160; &#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;format.class&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;io.confluent.connect.s3.format.json.JsonFormat&quot;&lt;/span&gt;,
&#160; &#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;schema.generator.class&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;io.confluent.connect.storage.hive.schema.DefaultSchemaGenerator&quot;&lt;/span&gt;,
&#160; &#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;schema.compatibility&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;NONE&quot;&lt;/span&gt;
&#160; }
}&apos; http:&lt;span class=&quot;code-comment&quot;&gt;//localhost:8081/connectors
&lt;/span&gt;done
launch_kafka_connect 2
launch_kafka_connect 3
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;When the script ends, I have one worker with connector #1 tasks, the other one with connector #2 tasks.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&#10095; curl -s http:&lt;span class=&quot;code-comment&quot;&gt;//localhost:8081/connectors/s3-connector1/status | jq .tasks |grep worker_id | sort | uniq -c
&lt;/span&gt;  &#160; 120 &#160; &#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;worker_id&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;k1:8081&quot;&lt;/span&gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&#10095; curl -s http:&lt;span class=&quot;code-comment&quot;&gt;//localhost:8081/connectors/s3-connector2/status | jq .tasks |grep worker_id | sort | uniq -c
&lt;/span&gt;&#160; &#160; 120 &#160; &#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;worker_id&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;k1:8081&quot;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Then I wait 3 minutes&lt;/p&gt;

&lt;p&gt;And I get the final state:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&#10095; curl -s http:&lt;span class=&quot;code-comment&quot;&gt;//localhost:8081/connectors/s3-connector2/status | jq .tasks |grep worker_id | sort | uniq -c
&lt;/span&gt;&#160; &#160; &#160;60 &#160; &#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;worker_id&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;k2:8082&quot;&lt;/span&gt;
&#160; &#160; &#160;60 &#160; &#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;worker_id&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;k3:8083&quot;&lt;/span&gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&#10095; curl -s http:&lt;span class=&quot;code-comment&quot;&gt;//localhost:8081/connectors/s3-connector1/status | jq .tasks |grep worker_id | sort | uniq -c
&lt;/span&gt;&#160; &#160; &#160;80 &#160; &#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;worker_id&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;k1:8081&quot;&lt;/span&gt;
&#160; &#160; &#160;20 &#160; &#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;worker_id&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;k2:8082&quot;&lt;/span&gt;
&#160; &#160; &#160;20 &#160; &#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;worker_id&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;k3:8083&quot;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;In the end, we indeed get 80 tasks on each workers, but for distribution reasons , I think it should be (40, 40, 40) for each connector, because all task don&apos;t do the same amount of work, which will lead to a processing/network imbalance overall.&lt;/p&gt;



&lt;p&gt;In my test I always get the same outcome.&lt;/p&gt;

&lt;p&gt;This is consistent with what we see in production.&lt;/p&gt;</comment>
                            <comment id="17860562" author="yazgoo" created="Thu, 27 Jun 2024 15:14:43 +0000"  >&lt;p&gt;I created &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-17049&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-17049&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13011272" name="connect_worker_balanced.png" size="43646" author="baz33" created="Wed, 9 Sep 2020 12:58:22 +0000"/>
                            <attachment id="13069825" name="rebalance.sh" size="4560" author="yazgoo" created="Thu, 27 Jun 2024 09:57:28 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 19 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0hvqg:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>