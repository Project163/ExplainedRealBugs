<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:41:36 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-17825] ByteBufferDeserializaer&apos;s array size can be inconsistent with the older version</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-17825</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;We&apos;ve noticed that using the ByteBufferDeserializer can yield a different byte array length compare to the deserializer from 3.5.2.&#160; This is attributed by KIP-863, in particular, the old deserializer truncated the byte array starting from&lt;/p&gt;

&lt;p&gt;`buffer.position() + buffer.arrayOffset() + offset` using `Utils.toArray`&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Whereas the current implementation is a passthrough.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;This can be reproduced using the&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
KafkaConsumerProducerDemo.java&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;by changing the type to &amp;lt;Integer, ByteBuffer&amp;gt; and perform a print after poll.&lt;/p&gt;

&lt;p&gt;For example, the producer produces a record &#160;&lt;span class=&quot;error&quot;&gt;&amp;#91;0, test0&amp;#93;&lt;/span&gt; (key is an int, &quot;test0&quot; is a 5 bytes long string, converted to byte buffer using&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ByteBuffer.wrap(value.getBytes())&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Prior to KIP-863 we see the following after polling the record from consumer:&lt;/p&gt;

&lt;p&gt;3.5.2: test0&lt;/p&gt;

&lt;p&gt;3.6.0:&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
?$&#65533;&#65533;&#65533;y&#65533;NN&#1925;&#65533;-p&#65533;=&#65533;&#65533;&#65533;&#65533;&#65533;NAc&#65533;&#65533;&#65533;&#65533;&#65533;8D&#65533;&#65533;&#65533;8D&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;
test0&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;And if you analyze the ByteBuffer post 3.6.0, we can see the current offset is at 140 with array length of 149.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=LSK&quot; class=&quot;user-hover&quot; rel=&quot;LSK&quot;&gt;LSK&lt;/a&gt; - since you wrote the kip and did the implementation, can you address this ?&lt;/p&gt;</description>
                <environment></environment>
        <key id="13595888">KAFKA-17825</key>
            <summary>ByteBufferDeserializaer&apos;s array size can be inconsistent with the older version</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="6">Invalid</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="pnee">Philip Nee</reporter>
                        <labels>
                    </labels>
                <created>Thu, 17 Oct 2024 21:00:10 +0000</created>
                <updated>Fri, 10 Jan 2025 23:40:26 +0000</updated>
                            <resolved>Thu, 9 Jan 2025 19:46:29 +0000</resolved>
                                    <version>3.6.0</version>
                                                    <component>consumer</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="17903445" author="JIRAUSER283568" created="Thu, 5 Dec 2024 17:22:20 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=LSK&quot; class=&quot;user-hover&quot; rel=&quot;LSK&quot;&gt;LSK&lt;/a&gt; - mind comment on this issue? This is relevant to &lt;a href=&quot;https://cwiki.apache.org/confluence/pages/viewpage.action?pageId=225152035#:~:text=This%20proposal%20has%20no%20compatibility%20issues%2C%20we%20just%20add%20default%20method%20deserialize(String%2C%20Headers%2C%20ByteBuffer)%20which%20is%20compatible%20with%20the%20existing%20Deserializers&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://cwiki.apache.org/confluence/pages/viewpage.action?pageId=225152035#:~:text=This%20proposal%20has%20no%20compatibility%20issues%2C%20we%20just%20add%20default%20method%20deserialize(String%2C%20Headers%2C%20ByteBuffer)%20which%20is%20compatible%20with%20the%20existing%20Deserializers&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17909000" author="mjsax" created="Tue, 31 Dec 2024 03:07:26 +0000"  >&lt;p&gt;I dug into this, and I am actually not sure if it&apos;s indeed a bug &#8211; my understanding is, that the KIP intentionally changes the contract, what means it&apos;s not a backward compatible change, which the KIP does not clearly call out though IMHO.&lt;/p&gt;

&lt;p&gt;The sentence&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;If someone wants the deserializer to be compatible with older versions of the kafka-clients library they should always implement the byte array-based deserialize methods.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;&lt;font color=&quot;#172b4d&quot;&gt;is rather cryptic.&lt;/font&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;#172b4d&quot;&gt;Overall, the contract of `ByteBufferDeserializer` is &lt;em&gt;not&lt;/em&gt; clearly specified from my POV.&lt;/font&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;#172b4d&quot;&gt;Prior to the KIP, we did make a deep copy, and thus using `array()` was &quot;safe&quot; in the sense that one does not need to care about arrayOffset,position,limit... Eg, a ByteBuffer could be converted into a String via `new String(byteBuffer.array())`.&lt;/font&gt;&lt;font color=&quot;#172b4d&quot;&gt; With this KIP, using `array()` is not &quot;safe&quot; any longer though and one would need to use `&lt;/font&gt;&lt;font color=&quot;#172b4d&quot;&gt;new String(buffer.array(), buffer.arrayOffset() + buffer.position(), buffer.remaining())` instead.&lt;/font&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;#172b4d&quot;&gt;However, it&apos;s not really clear what the contract is (not in 3.5, nor in 3.6). I assume that the statement in the KIP was supposed to mean, if you want a deep-copy, use the old `deserialize(String topic, byte[] data)` but that is not really practical, because if I use the `KafkaConsumer` I don&apos;t control which method the consumer calls, and it will in fact call the new `deserialize(String topic, Headers headers, ByteBuffer data)` so as a user I cannot force a deep copy. (User code does usually not call `deserialize()` themselves...)&lt;/font&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;#172b4d&quot;&gt;In the end, `ByterBufferDeserializer` is not an interface and thus &quot;should always implement the byte array-based deserialize methods&quot; does no apply &#8211; the user does not implement anything when using this class... They just plug it into the KafkaConsumer.&lt;/font&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;#172b4d&quot;&gt;In the end, the goal of the KIP was to avoid a deep-copy, but it did introduce a breaking change... This ship has sailed so the only thing we can do is to actually update the KIP, docs, and JavaDocs IMHO. Of course, we could also fall back to the old behavior, but this seems to defeat the purpose, and people can still force a deep-copy of the data by using `ByteArrayDeserializer` instead of `ByteBufferDeserializer`. I agree to the idea that `ByteBufferDeserializer` is more advanced and thus should avoid a deep-copy, and users need to understand how to use it correctly.&lt;/font&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;#172b4d&quot;&gt;Thoughts? \cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=LSK&quot; class=&quot;user-hover&quot; rel=&quot;LSK&quot;&gt;LSK&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnee&quot; class=&quot;user-hover&quot; rel=&quot;pnee&quot;&gt;pnee&lt;/a&gt; (also &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ChrisEgerton&quot; class=&quot;user-hover&quot; rel=&quot;ChrisEgerton&quot;&gt;ChrisEgerton&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=showuon&quot; class=&quot;user-hover&quot; rel=&quot;showuon&quot;&gt;showuon&lt;/a&gt; who reviews and vote the KIP).&lt;/font&gt;&lt;/p&gt;</comment>
                            <comment id="17909418" author="mjsax" created="Thu, 2 Jan 2025 20:19:31 +0000"  >&lt;p&gt;I also stumbled across &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-4852&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-4852&lt;/a&gt; again &#8211; it tried to make similar optimizations as KIP-863, but w/o a KIP and it also broke stuff &#8211; for this case, we did actually revert it: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-15602&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-15602&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;I am now wondering, if we should actually extend KIP-863 to include the deserializer part, which is also a breaking change, and ship with 4.0 release? As a major release, it would be ok to have a breaking change? (Not sure if it would be worth to roll back KIP-863 for 3.x versions in addition?)&lt;/p&gt;</comment>
                            <comment id="17911280" author="chrisegerton" created="Thu, 9 Jan 2025 01:31:41 +0000"  >&lt;p&gt;IMO this is an acceptable change as-is. Users of the &lt;tt&gt;ByteBuffer&lt;/tt&gt; API should always take a potential offset into account. It was never an explicit part of the &lt;tt&gt;ByteBufferDeserializer&lt;/tt&gt; API&apos;s contract that it return a zero-offset buffer, and it&apos;s only due to sheer coincidence that older client applications could make this assumption.&lt;/p&gt;</comment>
                            <comment id="17911630" author="mjsax" created="Thu, 9 Jan 2025 19:29:20 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ChrisEgerton&quot; class=&quot;user-hover&quot; rel=&quot;ChrisEgerton&quot;&gt;ChrisEgerton&lt;/a&gt; &#8211; I tend to agree. Let me do some PR to update the docs though, to call out this change explicitly.&lt;/p&gt;</comment>
                            <comment id="17911639" author="githubbot" created="Thu, 9 Jan 2025 20:10:25 +0000"  >&lt;p&gt;mjsax opened a new pull request, #660:&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka-site/pull/660&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka-site/pull/660&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;   Cf &lt;a href=&quot;https://github.com/apache/kafka/pull/18466&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/18466&lt;/a&gt;&lt;/p&gt;

</comment>
                            <comment id="17911667" author="mjsax" created="Thu, 9 Jan 2025 21:02:20 +0000"  >&lt;p&gt;I updated the &quot;Deprecation&quot; section of the KIP, too. Hope it&apos;s more clear now.&lt;/p&gt;</comment>
                            <comment id="17912150" author="githubbot" created="Fri, 10 Jan 2025 23:33:54 +0000"  >&lt;p&gt;mjsax merged PR #660:&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka-site/pull/660&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka-site/pull/660&lt;/a&gt;&lt;/p&gt;

</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13534244">KAFKA-14944</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13048596">KAFKA-4852</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            43 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1s2e0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>