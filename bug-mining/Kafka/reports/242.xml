<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:37:47 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-813] Minor cleanup in Controller</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-813</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Before starting work on delete topic support, uploading a patch first to address some minor hiccups that touch a bunch of files:&lt;/p&gt;

&lt;p&gt;1. Change PartitionOfflineException to PartitionUnavailableException because in the partition state machine we mark a partition offline when its leader is down, whereas the PartitionOfflineException is thrown when all the assigned replicas of the partition are down.&lt;br/&gt;
2. Change PartitionOfflineRate to UnavailablePartitionRate&lt;br/&gt;
3. Remove default leader selector from partition state machine&apos;s handleStateChange. We can specify null as default when we don&apos;t need to use a leader selector.&lt;br/&gt;
4. Include controller info in the client id of LeaderAndIsrRequest.&lt;br/&gt;
5. Rename controllerContext.allleaders to something more meaningful - partitionLeadershipInfo.&lt;br/&gt;
6. We don&apos;t need to put partition in OnlinePartition state in partition state machine initializeLeaderAndIsrForPartition, the state change occurs in handleStateChange.&lt;br/&gt;
7. Add todo in handleStateChanges&lt;br/&gt;
8. Left a comment above ReassignedPartitionLeaderSelector that reassigned replicas are already in the ISR (this is not true for other leader selectors), renamed the vals in the selector.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12637693">KAFKA-813</key>
            <summary>Minor cleanup in Controller</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="swapnilghike">Swapnil Ghike</assignee>
                                    <reporter username="swapnilghike">Swapnil Ghike</reporter>
                        <labels>
                            <label>kafka-0.8</label>
                    </labels>
                <created>Tue, 19 Mar 2013 01:04:25 +0000</created>
                <updated>Mon, 25 Mar 2013 16:48:49 +0000</updated>
                            <resolved>Mon, 25 Mar 2013 16:32:34 +0000</resolved>
                                    <version>0.8.0</version>
                                    <fixVersion>0.8.0</fixVersion>
                                    <component>controller</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13605893" author="swapnilghike" created="Tue, 19 Mar 2013 01:07:34 +0000"  >&lt;p&gt;Unit tests pass.&lt;/p&gt;</comment>
                            <comment id="13606514" author="junrao" created="Tue, 19 Mar 2013 17:07:55 +0000"  >&lt;p&gt;Thanks for the patch. Some comments:&lt;/p&gt;

&lt;p&gt;1. For 1 and 2, it seems that in this patch, we are treating PartitionOfflineException and PartitionUnavailableException the same. Is it better to just pick PartitionOfflineException (and remove PartitionUnavailableException) since it introduces fewer changes?&lt;/p&gt;

&lt;p&gt;2. PartiitonStateChange.handleStateChanges(): Is it a good idea to allow leaderSelector to be null? We will have to check and make sure that leaderSelector is null every time we use it.&lt;/p&gt;</comment>
                            <comment id="13606649" author="nehanarkhede" created="Tue, 19 Mar 2013 18:37:07 +0000"  >&lt;p&gt;Thanks for the cleanup patch, Swapnil. Here are some minor suggestions after which we can check it in -&lt;/p&gt;


&lt;p&gt;1. ControllerBrokerRequestBatch&lt;br/&gt;
1.1 Can we explicitly pass in controller id and controller client id ? It is better to avoid object passing if we can. &lt;br/&gt;
1.2 How about clientId() instead of toString(). This is because it makes it very explicit the purpose of the usage of that API. It is unlikely anything else would want to call toString() on KafkaController&lt;/p&gt;

&lt;p&gt;2. PartitionStateMachine&lt;br/&gt;
Let&apos;s not set the leaderSelector to null as default. Each invocation of handleStateChanges should pass in the correct leader selector for better code readability.&lt;/p&gt;
</comment>
                            <comment id="13606672" author="swapnilghike" created="Tue, 19 Mar 2013 18:58:11 +0000"  >&lt;p&gt;@Neha: 2. If the target state is not OnlinePartition, then we don&apos;t need to pass in any leader selector. &lt;/p&gt;</comment>
                            <comment id="13606678" author="nehanarkhede" created="Tue, 19 Mar 2013 19:11:25 +0000"  >&lt;p&gt;Correct, another way to do this is to defined a NoOpLeaderSelector and pass that in. The NoOpLeaderSelector can just return the leadership info from partitionLeadershipInfo. At least, that way, the leader selector logic is explicit which was the purpose of the change.&lt;/p&gt;</comment>
                            <comment id="13607165" author="swapnilghike" created="Wed, 20 Mar 2013 01:39:33 +0000"  >&lt;p&gt;Addressing comments: &lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=junrao&quot; class=&quot;user-hover&quot; rel=&quot;junrao&quot;&gt;junrao&lt;/a&gt;: &lt;br/&gt;
1. Renamed the exception to PartitionNoReplicaOnlineException, since &lt;br/&gt;
i. the old name caused confusion with OfflinePartition state of the partition state machine &lt;br/&gt;
ii. this exception is thrown when all the replicas assigned to a topic-partition are down, or there are no replicas assigned to a topic-partition&lt;/p&gt;

&lt;p&gt;2. Created a new NoOpLeaderSelector and set it as the default.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nehanarkhede&quot; class=&quot;user-hover&quot; rel=&quot;nehanarkhede&quot;&gt;nehanarkhede&lt;/a&gt;: &lt;br/&gt;
1.1. Passing the controllerId and clientId separately to ControllerBrokerRequestBatch&lt;br/&gt;
1.2. Renamed KafkaController.toString to clientId&lt;/p&gt;

&lt;p&gt;2. Created a new NoOpLeaderSelector, thanks for the great suggestion, and set it as the default. &lt;br/&gt;
i. It returns the existing leader and Isr and replica assignment, so the logs will first contain a warning issued by selectLeader() and then the Zk write will log an error.&lt;br/&gt;
ii. I think it is ok to set the no-op leader selector as the default, because we don&apos;t need to pass any leader selector when the target state is not OnlinePartition, and there could be little confusion in there about why no leader selector was passed. Earlier we had cases where the target state was OnlinePartition, but it was not clear which leader selector was used, since we provided OfflinePartitionLeaderSelector as the default to handleStateChanges().&lt;/p&gt;

&lt;p&gt;Additional changes:&lt;br/&gt;
1. Removed OfflinePartitionRate as discussed offline. Instead, created a new gauge OfflinePartitionsCount, which would measure the count of partitions whose individual &quot;leaders&quot; are down. The reason to make this change is that OfflinePartitionsRate would provide information about how many partitions go Offline in a given time window, but does not give information about how many partitions don&apos;t come back to Online State and stay Offline since the last time window.&lt;/p&gt;

&lt;p&gt;Marking the jira as blocker because of the metric change.&lt;/p&gt;</comment>
                            <comment id="13607697" author="junrao" created="Wed, 20 Mar 2013 15:12:32 +0000"  >&lt;p&gt;Thanks for patch v2. Some more comments.&lt;/p&gt;

&lt;p&gt;20. PartitionStateMachine.initializeLeaderAndIsrForPartition(): why is the following line removed?&lt;br/&gt;
          partitionState.put(topicAndPartition, OnlinePartition)&lt;/p&gt;

&lt;p&gt;21. PartitionNoReplicaOnlineException seems long. Is it better to use NoReplicaOnlineException?&lt;/p&gt;

&lt;p&gt;22. KafkaController: To compute the gauge OfflinePartitionsCount, we need to synchronize on controller lock.&lt;/p&gt;
</comment>
                            <comment id="13607705" author="nehanarkhede" created="Wed, 20 Mar 2013 15:19:31 +0000"  >&lt;p&gt;Thanks for patch v2 -&lt;/p&gt;

&lt;p&gt;1. KafkaController&lt;br/&gt;
1.1 The change to OfflinePartitionsCount looks good. However, there is a distinction between a partition whose leader is not alive but other replicas are so leader election will happen and a partition for which all replicas are dead. In the latter case, there can be no leader for that partition which is a much more dangerous state for a partition to be in. I suggest two metrics, OfflinePartitionsCount to indicate the former and UnavailablePartitionsCount to indicate the latter&lt;br/&gt;
1.2 I wonder why ActiveControllerCount and OfflinePartitionsCount are not part of ControllerStats ?&lt;/p&gt;

&lt;p&gt;2. NoOpLeaderSelector&lt;br/&gt;
Minor code style suggestion - return is not required here.&lt;/p&gt;

&lt;p&gt;3. PartitionStateMachine&lt;br/&gt;
We don&apos;t have to define the noOpLeaderSelector in the controller since it is used only in PartitionStateMachine.handleStateChanges(). Let&apos;s move it there. The reason offlineLeaderSelector is there since both the controller and the partition state machine access it.&lt;/p&gt;

&lt;p&gt;Nit pick - Can we change PartitionNoReplicaOnlineException to NoReplicaOnlineForPartitionException or simply NoReplicaOnlineException ? &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13608130" author="swapnilghike" created="Wed, 20 Mar 2013 20:16:36 +0000"  >&lt;p&gt;A couple of comments/questions before uploading the next patch:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=junrao&quot; class=&quot;user-hover&quot; rel=&quot;junrao&quot;&gt;junrao&lt;/a&gt;: &lt;br/&gt;
20. Because initializeLeaderAndIsrForPartition() is called at only one place, in handleStateChange(). And handleStateChange() puts the partition in Online state.&lt;br/&gt;
21. Ok, renaming to NoReplicaOnlineException.&lt;br/&gt;
22. Ok, also please read below.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nehanarkhede&quot; class=&quot;user-hover&quot; rel=&quot;nehanarkhede&quot;&gt;nehanarkhede&lt;/a&gt;: &lt;br/&gt;
1.1 I agree that having all the replicas assigned to a partition down is a dangerous situation. I guess that will be reflected if the OfflinePartitionsCount is non-zero for a while, and then we can dig into Zk. An OfflinePartitionsCount that remains non-zero for a while could also indicate another dangerous situation where the replicas are up but leader is not being assigned. So, i think that clues provided by an OfflinePartitionsCount that remains non-zero for a few minutes subsume the clues given by UnavailablePartitionsCount, and we may not specifically need the latter. Thoughts?&lt;/p&gt;

&lt;p&gt;2. Argh, yes, thanks.&lt;/p&gt;

&lt;p&gt;3. I agree that Controller does not need to know about a useless leader selector. Moving NoOpLeaderSelector object to partition state machine. &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=junrao&quot; class=&quot;user-hover&quot; rel=&quot;junrao&quot;&gt;junrao&lt;/a&gt;,&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nehanarkhede&quot; class=&quot;user-hover&quot; rel=&quot;nehanarkhede&quot;&gt;nehanarkhede&lt;/a&gt;: :1.2 I believe the reason was to initialize the gauges when the controller object is created. However, we can move the gauges to ControllerStats and force their initialization like server.registerStats(). So perhaps it would be good if we could decide which jmx beans need to be force-initialized and at which places in the code. Accordingly I can make the relevant changes. &lt;/p&gt;</comment>
                            <comment id="13608462" author="nehanarkhede" created="Thu, 21 Mar 2013 00:39:48 +0000"  >&lt;p&gt;1.1 Makes sense, we can just live with the existing counter for now.&lt;br/&gt;
Also, let&apos;s register the controller stats at startup. That way, they at least show a value of 0 instead of nan.&lt;/p&gt;</comment>
                            <comment id="13608512" author="swapnilghike" created="Thu, 21 Mar 2013 01:22:43 +0000"  >&lt;p&gt;Patch v3 takes care of the comments made above.&lt;/p&gt;</comment>
                            <comment id="13609038" author="junrao" created="Thu, 21 Mar 2013 15:34:56 +0000"  >&lt;p&gt;Thanks for patch v3. Looks good. Just one more comment:&lt;/p&gt;

&lt;p&gt;30. KafkaController: Is it really useful to include port in clientId?&lt;/p&gt;</comment>
                            <comment id="13609042" author="nehanarkhede" created="Thu, 21 Mar 2013 15:36:55 +0000"  >&lt;p&gt;+1 on patch v3&lt;/p&gt;</comment>
                            <comment id="13610100" author="swapnilghike" created="Fri, 22 Mar 2013 10:23:19 +0000"  >&lt;p&gt;30. port has been included to maintain consistency with other such clientIds. I agree that it&apos;s not specifically useful since the hostname gives enough information for log debugging etc. &lt;/p&gt;</comment>
                            <comment id="13610431" author="junrao" created="Fri, 22 Mar 2013 16:06:59 +0000"  >&lt;p&gt;Ok. That&apos;s fine then. One more comment:&lt;/p&gt;

&lt;p&gt;31. PartitionStateMachine.electLeaderForPartition(): In the following code, is there any value in wrapping a NoReplicaOnlineException over another NoReplicaOnlineException?&lt;br/&gt;
      case noReplicaOnlineEx: NoReplicaOnlineException =&amp;gt;&lt;br/&gt;
        val failMsg = &quot;All replicas %s for partition %s are dead. Marking this partition offline.&quot;&lt;br/&gt;
                        .format(controllerContext.partitionReplicaAssignment(topicAndPartition).mkString(&quot;,&quot;), topicAndPartition)&lt;br/&gt;
        throw new NoReplicaOnlineException(failMsg, noReplicaOnlineEx)&lt;/p&gt;</comment>
                            <comment id="13612020" author="swapnilghike" created="Sun, 24 Mar 2013 06:27:32 +0000"  >&lt;p&gt;Thanks for pointing that out. Attached patch v4. When the leader goes down, the state change log will show the OfflinePartition state change. So yes, there is no need to wrap it in another NoReplicaOnlineException. &lt;/p&gt;</comment>
                            <comment id="13612807" author="junrao" created="Mon, 25 Mar 2013 16:32:34 +0000"  >&lt;p&gt;Thanks for patch v4. +1 and committed to 0.8.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12574284" name="kafka-813-v1.patch" size="41296" author="swapnilghike" created="Tue, 19 Mar 2013 01:07:34 +0000"/>
                            <attachment id="12574473" name="kafka-813-v2.patch" size="43521" author="swapnilghike" created="Wed, 20 Mar 2013 01:39:33 +0000"/>
                            <attachment id="12574701" name="kafka-813-v3.patch" size="41647" author="swapnilghike" created="Thu, 21 Mar 2013 01:22:43 +0000"/>
                            <attachment id="12575210" name="kafka-813-v4.patch" size="39806" author="swapnilghike" created="Sun, 24 Mar 2013 06:27:32 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>318173</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 35 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1iwfb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>318514</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>