<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:19:36 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-8802] ConcurrentSkipListMap shows performance regression in cache and in-memory store</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-8802</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;The use of ConcurrentSkipListMap in the cache and in-memory stores caused a performance regression in 2.3.0. We should revert back to using TreeMap&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13250830">KAFKA-8802</key>
            <summary>ConcurrentSkipListMap shows performance regression in cache and in-memory store</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ableegoldman">A. Sophie Blee-Goldman</assignee>
                                    <reporter username="ableegoldman">A. Sophie Blee-Goldman</reporter>
                        <labels>
                    </labels>
                <created>Wed, 14 Aug 2019 17:10:23 +0000</created>
                <updated>Sat, 24 Sep 2022 00:38:19 +0000</updated>
                            <resolved>Tue, 20 Aug 2019 01:35:15 +0000</resolved>
                                    <version>2.3.0</version>
                                    <fixVersion>2.3.1</fixVersion>
                    <fixVersion>2.4.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16907464" author="githubbot" created="Wed, 14 Aug 2019 17:15:18 +0000"  >&lt;p&gt;ableegoldman commented on pull request #7212: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-8802&quot; title=&quot;ConcurrentSkipListMap shows performance regression in cache and in-memory store&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-8802&quot;&gt;&lt;del&gt;KAFKA-8802&lt;/del&gt;&lt;/a&gt;: ConcurrentSkipListMap shows performance regression in cache and in-memory store&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/7212&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/7212&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16907477" author="githubbot" created="Wed, 14 Aug 2019 17:32:21 +0000"  >&lt;p&gt;vvcephei commented on pull request #7213: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-8802&quot; title=&quot;ConcurrentSkipListMap shows performance regression in cache and in-memory store&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-8802&quot;&gt;&lt;del&gt;KAFKA-8802&lt;/del&gt;&lt;/a&gt;: ConcurrentSkipListMap shows performance regression in cache and in-memory store&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/7213&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/7213&lt;/a&gt;&lt;/p&gt;


&lt;ul&gt;
	&lt;li&gt;replace ConcurrentSkipListMap&lt;/li&gt;
	&lt;li&gt;synchronize&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;   See #7212&lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16909261" author="githubbot" created="Fri, 16 Aug 2019 17:41:32 +0000"  >&lt;p&gt;guozhangwang commented on pull request #7212: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-8802&quot; title=&quot;ConcurrentSkipListMap shows performance regression in cache and in-memory store&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-8802&quot;&gt;&lt;del&gt;KAFKA-8802&lt;/del&gt;&lt;/a&gt;: ConcurrentSkipListMap shows performance regression in cache and in-memory store&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/7212&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/7212&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16909301" author="githubbot" created="Fri, 16 Aug 2019 18:01:26 +0000"  >&lt;p&gt;vvcephei commented on pull request #7213: &lt;span class=&quot;error&quot;&gt;&amp;#91;DO NOT MERGE&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-8802&quot; title=&quot;ConcurrentSkipListMap shows performance regression in cache and in-memory store&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-8802&quot;&gt;&lt;del&gt;KAFKA-8802&lt;/del&gt;&lt;/a&gt;: ConcurrentSkipListMap shows performance regression in cache and in-memory store&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/7213&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/7213&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16911021" author="f2005870@gmail.com" created="Tue, 20 Aug 2019 06:01:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ableegoldman&quot; class=&quot;user-hover&quot; rel=&quot;ableegoldman&quot;&gt;ableegoldman&lt;/a&gt;&#160;Just curious if you could share what exactly was the performance hit and performance improvement by this PR.&#160;&lt;/p&gt;</comment>
                            <comment id="16911663" author="ableegoldman" created="Tue, 20 Aug 2019 19:04:57 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=f2005870%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;f2005870@gmail.com&quot;&gt;f2005870@gmail.com&lt;/a&gt;, I can&apos;t really give an exact number since it depends on so many factors.&lt;/p&gt;</comment>
                            <comment id="17608923" author="JIRAUSER296119" created="Sat, 24 Sep 2022 00:38:19 +0000"  >&lt;p&gt;Sorry to have to re-open this, but unfortunately copying the keyset view when creating the InMemoryKeyValueIterator doesn&apos;t stop the ConcurrentModificationException, but rather shifts when it happens to be while performing the copy during the creation of the InMemoryKeyValueIterator, instead of during the iteration. This might have made it slightly less likely to be triggered, but I just encountered it personally in the wild. Until this is fixed I will need to avoid using an InMemoryKeyValueStore in any place where it&apos;s accessed via &lt;tt&gt;KakfaStreams.store().&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;The performance hit for ConcurrentSkipListMap vs TreeMap from other sources I can find reports it at around half as fast. On the other hand, the existing version also makes an entire copy of the iterated data into a new TreeSet which takes time and especially unnecessary space. Another way you might look at this is that the InMemoryKeyValueStore would merely operate as fast as the fastest available (open-source) map implementation in Java that&apos;s both sorted and concurrent. If someone really, really needed that extra performance out of it they could license [AirConcurrentMap|&lt;a href=&quot;https://github.com/boilerbay/airconcurrentmap&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/boilerbay/airconcurrentmap&lt;/a&gt;] and reimplement InMemoryKeyValueStore using that. Heck, we could make the ConcurrentNavigableMap implementation configurable in Kafka Streams if it was important enough. Another potential option is to provide the option of creating a higher-performance in memory store using the TreeMap as long as it&apos;s guaranteed to only be used from a single thread.&lt;/p&gt;

&lt;p&gt;The new issue is at &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-14260&quot; title=&quot;InMemoryKeyValueStore iterator still throws ConcurrentModificationException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-14260&quot;&gt;&lt;del&gt;KAFKA-14260&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 7 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z05o1s:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>