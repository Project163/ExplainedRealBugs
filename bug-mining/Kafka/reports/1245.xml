<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:57:01 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-4117] Cleanup StreamPartitionAssignor behavior</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-4117</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;I went through the whole assignment logic once again and I feel the logic has now becomes a bit lossy, and I want to clean them up probably in another PR but just dump my thoughts here on the appropriate logic:&lt;/p&gt;

&lt;p&gt;Some background:&lt;/p&gt;

&lt;p&gt;1. Each &lt;tt&gt;KafkaStreams&lt;/tt&gt; instance contains a clientId, and if not specified default value is applicationId-1/2/etc if there are multiple instances inside the same JVM. One instance contains multiple threads where the thread-clientId is constructed as clientId-StreamThread-1/2/etc, and the thread-clientId is used as the embedded consumer clientId as well as metrics tag.&lt;/p&gt;

&lt;p&gt;2. However, since one instance can contain multiple threads, and hence multiple consumers, and when considering partition assignment, the streams library need to take the capacity into consideration based on the granularity of instance not on threads. Therefore we create a 4byte &lt;tt&gt;UUID.randomUUID()&lt;/tt&gt; as the processId and encode that in the subscription metadata bytes, and the leader then knows if multiple consumer members are actually belong to the same instance (i.e. belong to threads of that instance), so that when assigning partitions it can balance among instances. NOTE that in production we recommend one thread per instance, so consumersByClient will only have one consumer per client (i.e. instance).&lt;/p&gt;

&lt;p&gt;3. In addition, historically we hard-code the partition grouper logic, where for each task, it is assigned only with one partition of its subscribed topic. For example, if we have topicA with 5 partitions and topicB with 10 partitions, we will create 10 tasks, with the first five tasks containing one of the partitions each, while the last five tasks contain only one partition from topicB. And therefore the TaskId class contains the groupId of the sub-topology and the partition, so that taskId(group, 1) gets partition1 of topicA and partition1 of topicB. We later expose this to users to customize so that more than one partitions of the topic can be assigned to the same task, so that the partition field in the TaskId no longer indicate anything about which partitions are assigned, and we add &lt;tt&gt;AssignedPartitions&lt;/tt&gt; to capture which partitions are assigned to which tasks.&lt;/p&gt;

&lt;p&gt;4. While doing the assignment, the leader is also responsible for creating these changelog / repartition topics, and the number of partitions of these topics are equal to the number of tasks that needs to write to these topics, which are wrapped in &lt;tt&gt;stateChangelogTopicToTaskIds&lt;/tt&gt; and &lt;tt&gt;internalSourceTopicToTaskIds&lt;/tt&gt; respectively. After such topics are created, the leader also needs to &quot;augment&quot; the received cluster metadata with these topics to 1) check for copartitioning, and 2) maintained for QueryableState&apos;s discovery function.&lt;/p&gt;

&lt;p&gt;The current implementation is mixed with all these legacy logic and gets quite messy, and I&apos;m thinking to make a pass over the StreamPartitionAssignor and cleaning up it bit. More precisely:&lt;/p&gt;

&lt;p&gt;1. Read and parse the subscription information to construct the clientMetadata map, where each metadata contains the &lt;tt&gt;Set&amp;lt;String&amp;gt; consumerMemberIds&lt;/tt&gt;, &lt;tt&gt;ClientState&amp;lt;TaskId&amp;gt; state&lt;/tt&gt;, and &lt;tt&gt;HostInfo hostInfo&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;2. Access the (sub-)topology to create the corresponding changelog / repartition topics and construct the &lt;tt&gt;stateChangelogTopicToTaskIds&lt;/tt&gt; and &lt;tt&gt;internalSourceTopicToTaskIds&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;3. Call &lt;tt&gt;streamThread.partitionGrouper.partitionGroups&lt;/tt&gt; to get the map from created tasks to their assigned partitions.&lt;/p&gt;

&lt;p&gt;4. Call &lt;tt&gt;TaskAssignor.assign&lt;/tt&gt; (which now takes the whole clientMetadata map) to assign tasks to clients, and hence we get the assigned partitions to clients.&lt;/p&gt;

&lt;p&gt;5. For each client, use some round-robin manner (as we did now) to assign tasks to their hosted consumers with the &lt;tt&gt;clientMetadata.consumerMemberIds&lt;/tt&gt; map.&lt;/p&gt;

&lt;p&gt;6. Check co-partitioning of assigned partitions, and maintain the &lt;tt&gt;Cluster&lt;/tt&gt; metadata locally on the leader.&lt;/p&gt;

&lt;p&gt;7. Construct the assignment info, where activeTasks is also a map from &lt;tt&gt;TaskId&lt;/tt&gt; to list of &lt;tt&gt;TopicPartitions&lt;/tt&gt; since otherwise we will not know which partitions are assigned to which tasks.&lt;/p&gt;

&lt;p&gt;8. For non-leaders, when getting the assignment, also construct the Cluster metadata from the decoded assignment information; and also maintain the AssignmentInfo locally for constructing the tasks.&lt;/p&gt;

&lt;p&gt;And some minor improvements:&lt;/p&gt;

&lt;p&gt;1. The default &lt;tt&gt;thread-clientIds applicationId-x-StreamThread-y&lt;/tt&gt; may still be conflicting to each other with multiple JVMs / machines, which is bad for metrics collection / debugging across hosts. We can modify the default clientId to &lt;tt&gt;applicationId-processId&lt;/tt&gt; whereprocessId is the generated UUID, hence the default thread-clientId is &lt;tt&gt;applicationId-UUID-StreamThread-y&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;2. The &lt;tt&gt;TaskId.partition&lt;/tt&gt; field no longer indicate which partitions are actually assigned to this task, but we still need to keep its topicGroupId field as it indicates which sub-topology this task belongs to, hence helpful for debugging. So maybe we can rename the partition field to sth. like sequence?&lt;/p&gt;</description>
                <environment></environment>
        <key id="13002414">KAFKA-4117</key>
            <summary>Cleanup StreamPartitionAssignor behavior</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="guozhang">Guozhang Wang</assignee>
                                    <reporter username="guozhang">Guozhang Wang</reporter>
                        <labels>
                            <label>architecture</label>
                    </labels>
                <created>Fri, 2 Sep 2016 17:06:10 +0000</created>
                <updated>Tue, 26 May 2020 22:19:17 +0000</updated>
                            <resolved>Sat, 29 Oct 2016 17:49:32 +0000</resolved>
                                                    <fixVersion>0.10.2.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15565808" author="githubbot" created="Tue, 11 Oct 2016 15:48:53 +0000"  >&lt;p&gt;GitHub user guozhangwang opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/2012&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2012&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;span class=&quot;error&quot;&gt;&amp;#91;WIP&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-4117&quot; title=&quot;Cleanup StreamPartitionAssignor behavior&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-4117&quot;&gt;&lt;del&gt;KAFKA-4117&lt;/del&gt;&lt;/a&gt;: Stream partitionassignro cleanup&lt;/p&gt;

&lt;p&gt;    1. Create a new ClientMetadata` to collapse `Set&amp;lt;String&amp;gt; consumerMemberIds`, `ClientState&amp;lt;TaskId&amp;gt; state`, and `HostInfo hostInfo`.&lt;/p&gt;

&lt;p&gt;    2. Stop reusing `stateChangelogTopicToTaskIds` and `internalSourceTopicToTaskIds` to access the (sub-)topology&apos;s internal repartition and changelog topics for clarity; also use the source topics num.partitions to set the num.partitions for repartition topics, and clarify to NOT have cycles since otherwise the while loop will fail.&lt;/p&gt;

&lt;p&gt;    3. `ensure-copartition` at the end to modify the number of partitions for repartition topics if necessary to be equal to other co-partition topics.&lt;/p&gt;

&lt;p&gt;    4. refactor `ClientState` as well and update the logic of `TaskAssignor` for clarity as well.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/guozhangwang/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/guozhangwang/kafka&lt;/a&gt; K4117-stream-partitionassignro-cleanup&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/2012.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2012.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #2012&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit fb0ad26e27cf3310d1ff9ad1c08f2d0e4e489496&lt;br/&gt;
Author: Guozhang Wang &amp;lt;wangguoz@gmail.com&amp;gt;&lt;br/&gt;
Date:   2016-10-07T23:03:52Z&lt;/p&gt;

&lt;p&gt;    group client metadata&lt;/p&gt;

&lt;p&gt;commit 2a81a8eedb9c7b16e1446b580c9c006afa78ffac&lt;br/&gt;
Author: Guozhang Wang &amp;lt;wangguoz@gmail.com&amp;gt;&lt;br/&gt;
Date:   2016-10-08T03:15:13Z&lt;/p&gt;

&lt;p&gt;    cleanup co-partitioning process&lt;/p&gt;

&lt;p&gt;commit f44d07cffc065f7abaeefcb5344484d44651dfb0&lt;br/&gt;
Author: Guozhang Wang &amp;lt;wangguoz@gmail.com&amp;gt;&lt;br/&gt;
Date:   2016-10-08T03:52:11Z&lt;/p&gt;

&lt;p&gt;    re-order assignment logic&lt;/p&gt;

&lt;p&gt;commit ec369149b036bfeaff4f743ef7f7bfe93819e641&lt;br/&gt;
Author: Guozhang Wang &amp;lt;wangguoz@gmail.com&amp;gt;&lt;br/&gt;
Date:   2016-10-08T03:56:28Z&lt;/p&gt;

&lt;p&gt;    create changelog with compaction&lt;/p&gt;

&lt;p&gt;commit 41e8c758390614dd8c66e29bbd92bb8d29bef26b&lt;br/&gt;
Author: Guozhang Wang &amp;lt;wangguoz@gmail.com&amp;gt;&lt;br/&gt;
Date:   2016-10-08T22:04:24Z&lt;/p&gt;

&lt;p&gt;    fix unit test&lt;/p&gt;

&lt;p&gt;commit 6296da70a17f1c8129a35189890ebb117a130b8f&lt;br/&gt;
Author: Guozhang Wang &amp;lt;wangguoz@gmail.com&amp;gt;&lt;br/&gt;
Date:   2016-10-11T15:38:04Z&lt;/p&gt;

&lt;p&gt;    refactor client state&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15618493" author="githubbot" created="Sat, 29 Oct 2016 17:49:20 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/2012&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2012&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15618494" author="guozhang" created="Sat, 29 Oct 2016 17:49:33 +0000"  >&lt;p&gt;Issue resolved by pull request 2012&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/kafka/pull/2012&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2012&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13047348">KAFKA-4824</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13307560">KAFKA-10046</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 3 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3372f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>