<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:30:50 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-13474] Regression in dynamic update of broker certificate</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-13474</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;h1&gt;&lt;a name=&quot;Problem&quot;&gt;&lt;/a&gt;Problem&lt;/h1&gt;

&lt;p&gt;It seems, after updating listener SSL certificate with dynamic broker configuration update, old certificate is somehow still used for broker client SSL factory. Because of this broker fails to create new connection to controller after old certificate expires.&lt;/p&gt;
&lt;h1&gt;&lt;a name=&quot;History&quot;&gt;&lt;/a&gt;History&lt;/h1&gt;

&lt;p&gt;Back in &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-8336&quot; title=&quot;Enable dynamic update of client-side SSL factory in brokers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-8336&quot;&gt;&lt;del&gt;KAFKA-8336&lt;/del&gt;&lt;/a&gt; there was an issue, when client-side SSL factory wasn&apos;t updating certificate, when it was changed with dynamic configuration. That bug have been fixed in version 2.3 and I can confirm, that dynamic update worked for us with kafka 2.4. But now we have updated clusters to 2.7 and see this (or at least similar) problem again.&lt;/p&gt;
&lt;h1&gt;&lt;a name=&quot;Affectedversions&quot;&gt;&lt;/a&gt;Affected versions&lt;/h1&gt;

&lt;p&gt;First we&apos;ve seen this on confluent 6.1.2, which (I think) based on kafka 2.7.0. Then I tried vanilla versions 2.7.0 and 2.7.2 and can reproduce problem on them just fine&lt;/p&gt;
&lt;h1&gt;&lt;a name=&quot;Howtoreproduce&quot;&gt;&lt;/a&gt;How to reproduce&lt;/h1&gt;
&lt;ul&gt;
	&lt;li&gt;Have zookeeper somewhere (in my example it will be &quot;10.88.0.21:2181&quot;).&lt;/li&gt;
	&lt;li&gt;Get vanilla version 2.7.2 (or 2.7.0) from &lt;a href=&quot;https://kafka.apache.org/downloads&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://kafka.apache.org/downloads&lt;/a&gt; .&lt;/li&gt;
	&lt;li&gt;Make basic broker config like this (don&apos;t forget to actually create log.dirs):
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-none&quot;&gt;
broker.id=1

listeners=SSL://:9092
advertised.listeners=SSL://localhost:9092

log.dirs=/tmp/broker1/data

zookeeper.connect=10.88.0.21:2181

security.inter.broker.protocol=SSL
ssl.protocol=TLSv1.2
ssl.client.auth=required
ssl.endpoint.identification.algorithm=
ssl.keystore.type=PKCS12
ssl.keystore.location=/tmp/broker1/secrets/broker1.keystore.p12
ssl.keystore.password=changeme1
ssl.key.password=changeme1
ssl.truststore.type=PKCS12
ssl.truststore.location=/tmp/broker1/secrets/truststore.p12
ssl.truststore.password=changeme
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;(I use here TLS 1.2 just so I can see client certificate in TLS handshake in traffic dump, you will get same error with default TLS 1.3 too)&lt;/p&gt;
	&lt;ul&gt;
		&lt;li&gt;Repeat this config for another 2 brokers, changing id, listener port and certificate accordingly.&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;Make basic client config (I use for it one of brokers&apos; certificates):
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-none&quot;&gt;
security.protocol=SSL
ssl.key.password=changeme1
ssl.keystore.type=PKCS12
ssl.keystore.location=/tmp/broker1/secrets/broker1.keystore.p12
ssl.keystore.password=changeme1
ssl.truststore.type=PKCS12
ssl.truststore.location=/tmp/broker1/secrets/truststore.p12
ssl.truststore.password=changeme
ssl.endpoint.identification.algorithm=
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
	&lt;li&gt;Create usual local self-signed PKI for test
	&lt;ul&gt;
		&lt;li&gt;generate self-signed CA certificate and private key. Place certificate in truststore.&lt;/li&gt;
		&lt;li&gt;create keys for broker certificates and create requests from them as usual (I&apos;ll use here same subject for all brokers)&lt;/li&gt;
		&lt;li&gt;create 2 certificates as usual
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-bash&quot;&gt;
openssl x509 \
       -req -CAcreateserial -days 1 \
       -CA ca/ca-cert.pem -CAkey ca/ca-key.pem \
       -&lt;span class=&quot;code-object&quot;&gt;in&lt;/span&gt; broker1.csr -out broker1.crt
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
		&lt;li&gt;Use &quot;faketime&quot; utility to make third certificate expire soon:
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-bash&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;# date here is some point yesterday, so certificate will expire like 10-15 minutes from now
&lt;/span&gt;faketime &lt;span class=&quot;code-quote-red&quot;&gt;&quot;2021-11-23 10:15&quot;&lt;/span&gt; openssl x509 \
       -req -CAcreateserial -days 1 \
       -CA ca/ca-cert.pem -CAkey ca/ca-key.pem \
       -&lt;span class=&quot;code-object&quot;&gt;in&lt;/span&gt; broker2.csr -out broker2.crt
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
		&lt;li&gt;create keystores from certificates and place them according to broker configs from earlier&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;Run 3 brokers with your configs like
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-bash&quot;&gt;
./bin/kafka-server-start.sh server2.properties
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;(I start it here without daemon mode to see logs right on terminal - just use &quot;tmux&quot; or something to run 3 brokers simultaneously)&lt;/p&gt;
	&lt;ul&gt;
		&lt;li&gt;you can check that one broker certificate will expire soon with
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-bash&quot;&gt;
openssl s_client -connect localhost:9093 &amp;lt;/dev/null | openssl x509 -noout -text | grep -A2 Valid
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;Issue new certificate to replace one, which will expire soon, place it in keystore and replace old keystore with it.&lt;/li&gt;
	&lt;li&gt;Use dynamic configuration to make broker re-read keystore:
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-bash&quot;&gt;
./bin/kafka-configs --command-config ssl.properties --bootstrap-server localhost:9092 --entity-type brokers --entity-name &lt;span class=&quot;code-quote-red&quot;&gt;&quot;2&quot;&lt;/span&gt; --alter --add-config &lt;span class=&quot;code-quote-red&quot;&gt;&quot;listener.name.SSL.ssl.keystore.location=/tmp/broker2/secrets/broker2.keystore.p12&quot;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
	&lt;ul&gt;
		&lt;li&gt;You can check that broker now has new certificate on its listener with same command
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-bash&quot;&gt;
openssl s_client -connect localhost:9093 &amp;lt;/dev/null | openssl x509 -noout -text | grep -A2 Valid
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;Wait until that old certificate expires and make some changes, which provoke broker to make new controller connection. For example if I have controller on broker &quot;1&quot; and expired certificate was on broker &quot;2&quot;, then I restart broker &quot;3&quot;.&lt;/li&gt;
	&lt;li&gt;On broker with expired certificate you will see in log something like
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-none&quot;&gt;
INFO [broker-2-to-controller-send-thread]: Recorded new controller, from now on will use broker 1 (kafka.server.BrokerToControllerRequestThread)
INFO [broker-2-to-controller] Failed authentication with localhost/127.0.0.1 (SSL handshake failed) (org.apache.kafka.common.network.Selector)
ERROR [broker-2-to-controller] Connection to node 1 (localhost/127.0.0.1:9092) failed authentication due to: SSL handshake failed (org.apache.kafka.clients.NetworkClient)
ERROR [broker-2-to-controller-send-thread]: Failed to send the following request due to authentication error: ClientRequest(expectResponse=true, callback=kafka.server.BrokerToControllerRequestThread$$Lambda$996/0x0000000801724c40@4d3e77ce, destination=1, correlationId=626, clientId=2, createdTimeMs=1637718291682, requestBuilder=AlterIsrRequestData(brokerId=2, brokerEpoch=293, topics=&amp;lt;some topic topology&amp;gt; kafka.server.BrokerToControllerRequestThread)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;and controller log will show something like&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-none&quot;&gt;
INFO [SocketServer brokerId=1] Failed authentication with /127.0.0.1 (SSL handshake failed) (org.apache.kafka.common.network.Selector)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;and if broker with expired and changed certificate was controller itself, then it even could not connect to itself.&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;If you make traffic dump (and you use TLS 1.2 or less) then you will see that broker client connection tries to use old certificate in TLS handshake.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Here is example of traffic dump, when broker with expired and dynamically changed certificate is current controller, so it can&apos;t connect to itself: &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13036511/13036511_failed-controller-single-session-20211119.pcap.gz&quot; title=&quot;failed-controller-single-session-20211119.pcap.gz attached to KAFKA-13474&quot;&gt;failed-controller-single-session-20211119.pcap.gz&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; &lt;br/&gt;
In this example you will see that &quot;Server&quot; use new certificate and &quot;Client&quot; use old certificate, but it&apos;s same broker!&lt;/p&gt;</description>
                <environment></environment>
        <key id="13413510">KAFKA-13474</key>
            <summary>Regression in dynamic update of broker certificate</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="divijvaidya">Divij Vaidya</assignee>
                                    <reporter username="Shipenkov">Igor Shipenkov</reporter>
                        <labels>
                    </labels>
                <created>Wed, 24 Nov 2021 03:32:26 +0000</created>
                <updated>Tue, 12 Jul 2022 06:33:32 +0000</updated>
                            <resolved>Sat, 9 Jul 2022 10:12:19 +0000</resolved>
                                    <version>2.7.0</version>
                    <version>2.7.2</version>
                    <version>2.8.1</version>
                    <version>3.0.0</version>
                    <version>3.1.0</version>
                    <version>3.1.1</version>
                    <version>3.2.0</version>
                    <version>3.2.1</version>
                                    <fixVersion>3.2.1</fixVersion>
                    <fixVersion>3.3.0</fixVersion>
                                    <component>core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="17452158" author="JIRAUSER280700" created="Thu, 2 Dec 2021 03:28:43 +0000"  >&lt;p&gt;Tried to reproduce problem on kafka 2.8.1. And problem is still there: I&apos;ve updated certificate, I can see that listener use new certificate, but it still uses old certificate for client connections and when certificate expires, this broker can&apos;t connect to others, for example connection to controller get errors like&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-none&quot;&gt;
INFO [broker-2-to-controller] Failed authentication with localhost/127.0.0.1 (SSL handshake failed) (org.apache.kafka.common.network.Selector)

ERROR [broker-2-to-controller] Connection to node 1 (localhost/127.0.0.1:9092) failed authentication due to: SSL handshake failed (org.apache.kafka.clients.NetworkClient)

ERROR [broker-2-to-controller-send-thread]: Failed to send the following request due to authentication error: ClientRequest(expectResponse=true, callback=kafka.server.BrokerToControllerRequestThread$$Lambda$1289/0x00000008017d8440@28eb9d3c, destination=1, correlationId=7078, clientId=2, createdTimeMs=1638414992079, requestBuilder=AlterIsrRequestData(brokerId=2, brokerEpoch=1025, topics=[TopicData(name=&apos;amadeus-pnr&apos;, partitions=[long list of partitions])]) failed due to authentication error with controller (kafka.server.BrokerToControllerRequestThread)
org.apache.kafka.common.errors.SslAuthenticationException: SSL handshake failed
Caused by: javax.net.ssl.SSLProtocolException: Unexpected handshake message: server_hello
	at java.base/sun.security.ssl.Alert.createSSLException(Alert.java:129)
	at java.base/sun.security.ssl.Alert.createSSLException(Alert.java:117)
	at java.base/sun.security.ssl.TransportContext.fatal(TransportContext.java:307)
	at java.base/sun.security.ssl.TransportContext.fatal(TransportContext.java:263)
	at java.base/sun.security.ssl.TransportContext.fatal(TransportContext.java:254)
	at java.base/sun.security.ssl.HandshakeContext.dispatch(HandshakeContext.java:437)
	at java.base/sun.security.ssl.SSLEngineImpl$DelegatedTask$DelegatedAction.run(SSLEngineImpl.java:1074)
	at java.base/sun.security.ssl.SSLEngineImpl$DelegatedTask$DelegatedAction.run(SSLEngineImpl.java:1061)
	at java.base/java.security.AccessController.doPrivileged(AccessController.java:689)
	at java.base/sun.security.ssl.SSLEngineImpl$DelegatedTask.run(SSLEngineImpl.java:1008)
	at org.apache.kafka.common.network.SslTransportLayer.runDelegatedTasks(SslTransportLayer.java:430)
	at org.apache.kafka.common.network.SslTransportLayer.handshakeUnwrap(SslTransportLayer.java:514)
	at org.apache.kafka.common.network.SslTransportLayer.doHandshake(SslTransportLayer.java:368)
	at org.apache.kafka.common.network.SslTransportLayer.handshake(SslTransportLayer.java:291)
	at org.apache.kafka.common.network.KafkaChannel.prepare(KafkaChannel.java:178)
	at org.apache.kafka.common.network.Selector.pollSelectionKeys(Selector.java:543)
	at org.apache.kafka.common.network.Selector.poll(Selector.java:481)
	at org.apache.kafka.clients.NetworkClient.poll(NetworkClient.java:561)
	at kafka.common.InterBrokerSendThread.pollOnce(InterBrokerSendThread.scala:74)
	at kafka.server.BrokerToControllerRequestThread.doWork(BrokerToControllerChannelManager.scala:368)
	at kafka.utils.ShutdownableThread.run(ShutdownableThread.scala:96)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;and packet capture shows old client certificate in TLS handshake.&lt;br/&gt;
I will add 2.8.1 to list of affected versions.&lt;/p&gt;</comment>
                            <comment id="17452200" author="JIRAUSER280700" created="Thu, 2 Dec 2021 06:43:00 +0000"  >&lt;p&gt;Well, I tried version 3.0.0 and I can reproduce this problem on it just fine. Same &quot;SSL handshake failed&quot; error, still can see old client certificate in traffic dump.&lt;br/&gt;
Guess I&apos;ll just add this to affected version too.&lt;/p&gt;</comment>
                            <comment id="17491538" author="ijuma" created="Sun, 13 Feb 2022 09:26:20 +0000"  >&lt;p&gt;Thanks for the report. We should triage this before the next release.&lt;/p&gt;</comment>
                            <comment id="17516984" author="cadonna" created="Mon, 4 Apr 2022 17:52:53 +0000"  >&lt;p&gt;Moving to the next release since code freeze for 3.2.0 has passed.&lt;/p&gt;</comment>
                            <comment id="17561117" author="divijvaidya" created="Thu, 30 Jun 2022 16:54:34 +0000"  >&lt;p&gt;I have been able to reproduce this via a test in Kafka code. I assigned this ticket to myself and am working on filing a PR with the fix.&lt;/p&gt;</comment>
                            <comment id="17562788" author="divijvaidya" created="Tue, 5 Jul 2022 18:12:11 +0000"  >&lt;p&gt;PR for fixing this problem is ready for review: &lt;a href=&quot;https://github.com/apache/kafka/pull/12381&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/12381&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ijuma&quot; class=&quot;user-hover&quot; rel=&quot;ijuma&quot;&gt;ijuma&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=showuon&quot; class=&quot;user-hover&quot; rel=&quot;showuon&quot;&gt;showuon&lt;/a&gt; , perhaps you folks would be interested to review this?&#160;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13036511" name="failed-controller-single-session-20211119.pcap.gz" size="5748" author="Shipenkov" created="Wed, 24 Nov 2021 03:32:49 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 18 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0x15s:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>