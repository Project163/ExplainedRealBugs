<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:36:28 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-618] Deadlock between leader-finder-thread and consumer-fetcher-thread during broker failure</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-618</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;This causes the test failure reported in &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-607&quot; title=&quot;System Test Transient Failure (case 4011 Log Retention) - ConsoleConsumer receives less data&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-607&quot;&gt;&lt;del&gt;KAFKA-607&lt;/del&gt;&lt;/a&gt;. This affects high-level consumers - if they hit the deadlock then they would get wedged (or at least until the consumer timeout).&lt;/p&gt;

&lt;p&gt;Here is the threaddump output that shows the issue:&lt;/p&gt;

&lt;p&gt;Found one Java-level deadlock:&lt;br/&gt;
=============================&lt;br/&gt;
&quot;ConsumerFetcherThread-console-consumer-41755_jkoshy-ld-1353026496639-b0e24a70-0-1&quot;:&lt;br/&gt;
  waiting for ownable synchronizer 0x00007f2283ad0000, (a java.util.concurrent.locks.ReentrantLock$NonfairSync),&lt;br/&gt;
  which is held by &quot;console-consumer-41755_jkoshy-ld-1353026496639-b0e24a70-leader-finder-thread&quot;&lt;br/&gt;
&quot;console-consumer-41755_jkoshy-ld-1353026496639-b0e24a70-leader-finder-thread&quot;:&lt;br/&gt;
  waiting to lock monitor 0x00007f2288297190 (object 0x00007f2283ab01d0, a java.lang.Object),&lt;br/&gt;
  which is held by &quot;ConsumerFetcherThread-console-consumer-41755_jkoshy-ld-1353026496639-b0e24a70-0-1&quot;&lt;/p&gt;

&lt;p&gt;Java stack information for the threads listed above:&lt;br/&gt;
===================================================&lt;br/&gt;
&quot;ConsumerFetcherThread-console-consumer-41755_jkoshy-ld-1353026496639-b0e24a70-0-1&quot;:&lt;br/&gt;
        at sun.misc.Unsafe.park(Native Method)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;parking to wait for  &amp;lt;0x00007f2283ad0000&amp;gt; (a java.util.concurrent.locks.ReentrantLock$NonfairSync)&lt;br/&gt;
        at java.util.concurrent.locks.LockSupport.park(LockSupport.java:158)&lt;br/&gt;
        at java.util.concurrent.locks.AbstractQueuedSynchronizer.parkAndCheckInterrupt(AbstractQueuedSynchronizer.java:811)&lt;br/&gt;
        at java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireQueued(AbstractQueuedSynchronizer.java:842)&lt;br/&gt;
        at java.util.concurrent.locks.AbstractQueuedSynchronizer.acquire(AbstractQueuedSynchronizer.java:1178)&lt;br/&gt;
        at java.util.concurrent.locks.ReentrantLock$NonfairSync.lock(ReentrantLock.java:186)&lt;br/&gt;
        at java.util.concurrent.locks.ReentrantLock.lock(ReentrantLock.java:262)&lt;br/&gt;
        at kafka.consumer.ConsumerFetcherManager.getPartitionTopicInfo(ConsumerFetcherManager.scala:131)&lt;br/&gt;
        at kafka.consumer.ConsumerFetcherThread.processPartitionData(ConsumerFetcherThread.scala:43)&lt;br/&gt;
        at kafka.server.AbstractFetcherThread$$anonfun$doWork$5.apply(AbstractFetcherThread.scala:116)&lt;br/&gt;
        at kafka.server.AbstractFetcherThread$$anonfun$doWork$5.apply(AbstractFetcherThread.scala:99)&lt;br/&gt;
        at scala.collection.immutable.Map$Map1.foreach(Map.scala:105)&lt;br/&gt;
        at kafka.server.AbstractFetcherThread.doWork(AbstractFetcherThread.scala:99)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;0x00007f2283ab01d0&amp;gt; (a java.lang.Object)&lt;br/&gt;
        at kafka.utils.ShutdownableThread.run(ShutdownableThread.scala:50)&lt;br/&gt;
&quot;console-consumer-41755_jkoshy-ld-1353026496639-b0e24a70-leader-finder-thread&quot;:&lt;br/&gt;
        at kafka.server.AbstractFetcherThread.addPartition(AbstractFetcherThread.scala:142)&lt;/li&gt;
	&lt;li&gt;waiting to lock &amp;lt;0x00007f2283ab01d0&amp;gt; (a java.lang.Object)&lt;br/&gt;
        at kafka.server.AbstractFetcherManager.addFetcher(AbstractFetcherManager.scala:49)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;0x00007f2283ab0338&amp;gt; (a java.lang.Object)&lt;br/&gt;
        at kafka.consumer.ConsumerFetcherManager$$anon$1$$anonfun$doWork$5.apply(ConsumerFetcherManager.scala:81)&lt;br/&gt;
        at kafka.consumer.ConsumerFetcherManager$$anon$1$$anonfun$doWork$5.apply(ConsumerFetcherManager.scala:76)&lt;br/&gt;
        at scala.collection.mutable.HashMap$$anonfun$foreach$1.apply(HashMap.scala:80)&lt;br/&gt;
        at scala.collection.mutable.HashMap$$anonfun$foreach$1.apply(HashMap.scala:80)&lt;br/&gt;
        at scala.collection.Iterator$class.foreach(Iterator.scala:631)&lt;br/&gt;
        at scala.collection.mutable.HashTable$$anon$1.foreach(HashTable.scala:161)&lt;br/&gt;
        at scala.collection.mutable.HashTable$class.foreachEntry(HashTable.scala:194)&lt;br/&gt;
        at scala.collection.mutable.HashMap.foreachEntry(HashMap.scala:39)&lt;br/&gt;
        at scala.collection.mutable.HashMap.foreach(HashMap.scala:80)&lt;br/&gt;
        at kafka.consumer.ConsumerFetcherManager$$anon$1.doWork(ConsumerFetcherManager.scala:76)&lt;br/&gt;
        at kafka.utils.ShutdownableThread.run(ShutdownableThread.scala:50)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Found 1 deadlock.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12616351">KAFKA-618</key>
            <summary>Deadlock between leader-finder-thread and consumer-fetcher-thread during broker failure</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="jjkoshy">Joel Jacob Koshy</reporter>
                        <labels>
                    </labels>
                <created>Fri, 16 Nov 2012 01:20:12 +0000</created>
                <updated>Sat, 17 Nov 2012 01:39:30 +0000</updated>
                            <resolved>Sat, 17 Nov 2012 01:39:21 +0000</resolved>
                                    <version>0.8.0</version>
                                    <fixVersion>0.8.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13498555" author="junrao" created="Fri, 16 Nov 2012 03:11:40 +0000"  >&lt;p&gt;This is a very good finding. The following is one way of breaking the deadlock.&lt;/p&gt;

&lt;p&gt;In ConsumerFetcherManager, don&apos;t expose getPartitionTopicInfo(). Instead, pass partitionMap (which is immutable) to each newly created ConsumerFetcherThread. This way, ConsumerFetcherThread.processPartitionData() and ConsumerFetcherThread.handleOffsetOutOfRange() won&apos;t depend on ConsumerFetcherManager any more. If we do that, we can improve ConsumerFetcherManager.stopAllConnections() a bit too. The clearing of noLeaderPartitionSet and partitionMap can be done together before calling closeAllFetchers(). Before, we have to clear partitionMap last because before all fetchers are stopped, the processing of the fetch request still needs to read partitionMap and expects it to be non-null. &lt;/p&gt;</comment>
                            <comment id="13499272" author="jjkoshy" created="Sat, 17 Nov 2012 00:31:15 +0000"  >&lt;p&gt;Ran 20 iterations of testcase 4011 and they all pass.&lt;/p&gt;

&lt;p&gt;One potential concern is partitionMap in the ConsumerFetcherThread being null/inconsistent wrt the partitionMap in ConsumerFetcherManager, but I looked at it closely and don&apos;t think it is possible.&lt;/p&gt;</comment>
                            <comment id="13499309" author="junrao" created="Sat, 17 Nov 2012 01:31:02 +0000"  >&lt;p&gt;Thanks for the patch. +1&lt;/p&gt;</comment>
                            <comment id="13499314" author="jjkoshy" created="Sat, 17 Nov 2012 01:39:30 +0000"  >&lt;p&gt;Committed to 0.8&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="12616447">KAFKA-621</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                                                <inwardlinks description="is depended upon by">
                                        <issuelink>
            <issuekey id="12615664">KAFKA-607</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12553868" name="KAFKA-618-v1.patch" size="4770" author="jjkoshy" created="Sat, 17 Nov 2012 00:31:15 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>258113</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 1 week, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0kmy7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>118535</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>