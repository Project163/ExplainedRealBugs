<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:31:11 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-13959] Controller should unfence Broker with busy metadata log</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-13959</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-13955&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-13955&lt;/a&gt; showed that it is possible for the controller to not unfence a broker if the committed offset keeps increasing.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;One solution to this problem is to require the broker to only catch up to the last committed offset when they last sent the heartbeat. For example:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Broker sends a heartbeat with current offset of &lt;tt&gt;Y&lt;/tt&gt;. The last commit offset is &lt;tt&gt;X&lt;/tt&gt;. The controller remember this last commit offset, call it &lt;tt&gt;X&apos;&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;Broker sends another heartbeat with current offset of &lt;tt&gt;Z&lt;/tt&gt;. Unfence the broker if &lt;tt&gt;Z &amp;gt;= X&lt;/tt&gt; or &lt;tt&gt;Z &amp;gt;= X&apos;&lt;/tt&gt;.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Another solution is to unfence the broker when the applied offset of the broker has reached the offset of its own broker registration record.&lt;/p&gt;

&lt;p&gt;This change should also set the default for MetadataMaxIdleIntervalMs back to 500.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13448376">KAFKA-13959</key>
            <summary>Controller should unfence Broker with busy metadata log</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dengziming">Deng Ziming</assignee>
                                    <reporter username="jagsancio">Jose Armando Garcia Sancio</reporter>
                        <labels>
                    </labels>
                <created>Fri, 3 Jun 2022 18:45:32 +0000</created>
                <updated>Fri, 12 Aug 2022 17:03:49 +0000</updated>
                            <resolved>Fri, 12 Aug 2022 17:03:49 +0000</resolved>
                                    <version>3.3.0</version>
                                    <fixVersion>3.3.0</fixVersion>
                                    <component>kraft</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17546695" author="jagsancio" created="Fri, 3 Jun 2022 18:55:11 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dengziming&quot; class=&quot;user-hover&quot; rel=&quot;dengziming&quot;&gt;dengziming&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=showuon&quot; class=&quot;user-hover&quot; rel=&quot;showuon&quot;&gt;showuon&lt;/a&gt; Are you interested in working on this issue?&lt;/p&gt;</comment>
                            <comment id="17548215" author="dengziming" created="Sat, 4 Jun 2022 13:48:27 +0000"  >&lt;p&gt;I will take a look at this if no one assigned.&lt;/p&gt;</comment>
                            <comment id="17550173" author="showuon" created="Sun, 5 Jun 2022 07:10:43 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dengziming&quot; class=&quot;user-hover&quot; rel=&quot;dengziming&quot;&gt;dengziming&lt;/a&gt; !&lt;/p&gt;</comment>
                            <comment id="17550912" author="dengziming" created="Tue, 7 Jun 2022 10:04:29 +0000"  >&lt;p&gt;When&#160;BrokerLifecycleManager is starting up, it will send heartbeat every 10 milliseconds rather than 2000 milliseconds:&#160;&lt;/p&gt;

&lt;p&gt;`scheduleNextCommunication(NANOSECONDS.convert(10, MILLISECONDS))`&lt;/p&gt;

&lt;p&gt;which is already smaller than 500ms, so the reason for this bug is more complex, I need more time to investigate.&lt;/p&gt;</comment>
                            <comment id="17550941" author="showuon" created="Tue, 7 Jun 2022 11:24:26 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dengziming&quot; class=&quot;user-hover&quot; rel=&quot;dengziming&quot;&gt;dengziming&lt;/a&gt; , if it&apos;s 10 ms heartbeat, how could it not be able to catch up with 500ms no-op records?&lt;/p&gt;</comment>
                            <comment id="17550943" author="showuon" created="Tue, 7 Jun 2022 11:25:20 +0000"  >&lt;p&gt;Sorry, I didn&apos;t see your last sentence. Thanks for the investigation! Looking forward to knowing the root cause! &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="17551534" author="dengziming" created="Wed, 8 Jun 2022 10:25:04 +0000"  >&lt;p&gt;I haven&apos;t find the root cause, I just print the brokerOffset and controllerOffset when heartbeat, I find that every time the brokerOffset bump, the controllerOffset will also bump.&#160;&lt;/p&gt;

&lt;p&gt;```&lt;/p&gt;

&lt;p&gt;time: 1654679131904 broker 0 brokerOffset:27 controllerOffset:28&lt;br/&gt;
time: 1654679132115 broker 0 brokerOffset:27 controllerOffset:28&lt;br/&gt;
time: 1654679132381 broker 0 brokerOffset:28 controllerOffset:29&lt;br/&gt;
time: 1654679132592 broker 0 brokerOffset:28 controllerOffset:29&lt;br/&gt;
time: 1654679132878 broker 0 brokerOffset:29 controllerOffset:30&lt;br/&gt;
time: 1654679133089 broker 0 brokerOffset:29 controllerOffset:30&lt;br/&gt;
time: 1654679133299 broker 0 brokerOffset:30 controllerOffset:31&lt;br/&gt;
time: 1654679133509 broker 0 brokerOffset:30 controllerOffset:31&lt;/p&gt;

&lt;p&gt;```&lt;/p&gt;

&lt;p&gt;I try to increase the interval of heartbeats but got the same result, and if I set numberControllerNodes to 1, &#160;this problem disappear. I think this may be related to the logic of how we compute leader hw and follower hw. &#160;&lt;/p&gt;</comment>
                            <comment id="17551663" author="jagsancio" created="Wed, 8 Jun 2022 15:14:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dengziming&quot; class=&quot;user-hover&quot; rel=&quot;dengziming&quot;&gt;dengziming&lt;/a&gt;, If you haven&apos;t, maybe looking at the KRaft side of the implementation may help. Specially at the LEOs and HWM reported by KRaft for both the controller and the broker(s), any pending FETCH request(s) and how often brokers sends FETCH requests.&lt;/p&gt;</comment>
                            <comment id="17552106" author="showuon" created="Thu, 9 Jun 2022 10:29:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dengziming&quot; class=&quot;user-hover&quot; rel=&quot;dengziming&quot;&gt;dengziming&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jagsancio&quot; class=&quot;user-hover&quot; rel=&quot;jagsancio&quot;&gt;jagsancio&lt;/a&gt; , I did some investigation today, and here&apos;s my finding:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;broker heartbeat to active controller won&apos;t fetch any data or increase the offset. broker just sends the current offset and some broker info to the controller. So, even if we have small interval of heartbeat, it still won&apos;t help.&lt;/li&gt;
	&lt;li&gt;So, when will the broker offset increased? It only happened in broker metadataListener. the metadataListener is listening to raftClient. And raftClient is polling metadata from active controller.&lt;/li&gt;
	&lt;li&gt;About when the highwatermark will be updated in active controller: Whenever there&apos;s record append to the active controller log, it won&apos;t update the highwatermark, until there are voters fetch records from active controller and also update the highwatermark. ex: current active controller is in highwatermark 9, and a record append to active controller log to offset 10, it&apos;ll wait, until voters send fetch request to active controller to update highwatermark, and then, commit the offset 10 record, update the new highwatermark to 10, to make sure the record is replicated to a majority of the voters.&lt;/li&gt;
	&lt;li&gt;So, that explains what we saw in the issue:
	&lt;ol&gt;
		&lt;li&gt;active controller send no-op message to metadata topic, active controller append into log, but don&apos;t update highwatermark (still 9)&lt;/li&gt;
		&lt;li&gt;broker raftClient fetch records from active controller,&lt;/li&gt;
		&lt;li&gt;active controller return the records to offset 9, and then update the highwatermark to 10&lt;/li&gt;
		&lt;li&gt;broker metaListener will operate the records&lt;/li&gt;
		&lt;li&gt;broker send heartbeat to active controller with offest 9&lt;/li&gt;
		&lt;li&gt;since offset 9 is &amp;lt; active controller highwatermark 10&lt;/li&gt;
		&lt;li&gt;keep trying, and in the meantime, no-op message sent again, and back to step 1&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17552107" author="showuon" created="Thu, 9 Jun 2022 10:32:07 +0000"  >&lt;p&gt;So I think the proposed solution should fix the issue.&lt;/p&gt;

&lt;p&gt;One solution to this problem is to require the broker to only catch up to the last committed offset when they last sent the heartbeat. For example:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Broker sends a heartbeat with current offset of &lt;tt&gt;Y&lt;/tt&gt;. The last commit offset is &lt;tt&gt;X&lt;/tt&gt;. The controller remember this last commit offset, call it &lt;tt&gt;X&apos;&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;Broker sends another heartbeat with current offset of &lt;tt&gt;Z&lt;/tt&gt;. Unfence the broker if &lt;tt&gt;Z &amp;gt;= X&lt;/tt&gt; or &lt;tt&gt;Z &amp;gt;= X&apos;&lt;/tt&gt;.&lt;/li&gt;
&lt;/ol&gt;
</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 22 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z12y3c:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>