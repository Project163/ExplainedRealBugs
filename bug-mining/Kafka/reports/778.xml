<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:44:51 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-2614] No more clients can connect after `TooManyConnectionsException` threshold (max.connections.per.ip) is reached</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-2614</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;It seems no more clients can connect to Kafka after `max.connections.per.ip` is reached, even if previous clients were already disconnected.&lt;/p&gt;

&lt;p&gt;Using 0.8.3 (9c936b18), upon starting a fresh Kafka server that is configured with (max.connections.per.ip = 24), I noticed that I can cause the server to hit the error case of &lt;tt&gt;INFO Rejected connection from /0:0:0:0:0:0:0:1, address already has the configured maximum of 24 connections.&lt;/tt&gt; very quickly, by simply looping through a bunch of simple clients against the server:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;#! /bin/bash

for i in {1..30}; do
    # either:
    nc -vz 127.0.0.1 9092;
    # or:
    ( telnet 127.0.0.1 9092; ) &amp;amp;
done

# if using telnet, kill all connected jobs now via:
kill %{2..31}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The problem seems to be that the counter for such short-lived client connections aren&apos;t properly decrementing when using the `max.connections.per.ip` feature.&lt;/p&gt;

&lt;p&gt;Turning on DEBUG logs, I cannot see the log lines &quot;Closing connection from xxx&quot; on &lt;a href=&quot;https://github.com/apache/kafka/blob/0.8.2/core/src/main/scala/kafka/network/SocketServer.scala#L164&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this line&lt;/a&gt; from the first few still-under-threshold short-lived connections, but starts showing &lt;b&gt;after&lt;/b&gt; I hit the limit per that config.&lt;/p&gt;</description>
                <environment>Debian Jessie</environment>
        <key id="12902782">KAFKA-2614</key>
            <summary>No more clients can connect after `TooManyConnectionsException` threshold (max.connections.per.ip) is reached</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ijuma">Ismael Juma</assignee>
                                    <reporter username="stephenchu810">Stephen Chu</reporter>
                        <labels>
                    </labels>
                <created>Tue, 6 Oct 2015 19:01:08 +0000</created>
                <updated>Sat, 10 Oct 2015 22:25:04 +0000</updated>
                            <resolved>Sat, 10 Oct 2015 22:24:59 +0000</resolved>
                                    <version>0.8.2.1</version>
                                    <fixVersion>0.9.0.0</fixVersion>
                                    <component>core</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="14946786" author="ijuma" created="Wed, 7 Oct 2015 12:47:14 +0000"  >&lt;p&gt;Thanks for filing this, there is indeed an issue where we are not handling disconnections properly. I have fixed it locally and will push a PR soon for discussion.&lt;/p&gt;</comment>
                            <comment id="14948877" author="githubbot" created="Thu, 8 Oct 2015 15:44:48 +0000"  >&lt;p&gt;GitHub user ijuma opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/288&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/288&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-2614&quot; title=&quot;No more clients can connect after `TooManyConnectionsException` threshold (max.connections.per.ip) is reached&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-2614&quot;&gt;&lt;del&gt;KAFKA-2614&lt;/del&gt;&lt;/a&gt;; No more clients can connect after `TooManyConnectionsException` threshold (max.connections.per.ip) is reached&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Call `ConnectionQuotas.decr` when calling `Selector.close` and when disconnections happen.&lt;/li&gt;
	&lt;li&gt;Expand `SocketServerTest` to test for this and to close sockets.&lt;/li&gt;
	&lt;li&gt;Refactor and clean-up `SocketServer` and `Acceptor` to make the code easier to understand.&lt;/li&gt;
&lt;/ul&gt;




&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/ijuma/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/ijuma/kafka&lt;/a&gt; kafka-2614-connection-count-not-updated&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/288.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/288.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #288&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 1f0786e22e23858a6e76cd40c570ffbbd91fc349&lt;br/&gt;
Author: Ismael Juma &amp;lt;ismael@juma.me.uk&amp;gt;&lt;br/&gt;
Date:   2015-10-08T15:38:24Z&lt;/p&gt;

&lt;p&gt;    Call `ConnectionQuotas.decr` when calling `Selector.close` and when disconnections happen&lt;/p&gt;

&lt;p&gt;    Also:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Expand `SocketServerTest` to test for this and to close sockets.&lt;/li&gt;
	&lt;li&gt;Refactor and clean-up `SocketServer` and `Acceptor` to make the code easier to understand.&lt;/li&gt;
&lt;/ul&gt;


&lt;hr /&gt;</comment>
                            <comment id="14948885" author="ijuma" created="Thu, 8 Oct 2015 15:50:56 +0000"  >&lt;p&gt;Ready for review &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=junrao&quot; class=&quot;user-hover&quot; rel=&quot;junrao&quot;&gt;junrao&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="14952068" author="junrao" created="Sat, 10 Oct 2015 22:24:59 +0000"  >&lt;p&gt;Issue resolved by pull request 288&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/kafka/pull/288&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/288&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14952069" author="githubbot" created="Sat, 10 Oct 2015 22:25:04 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/288&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/288&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 6 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2mnj3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>junrao</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>