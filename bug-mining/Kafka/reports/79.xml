<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:35:28 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-489] Add metrics collection and graphs to the system test framework</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-489</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;We have a new system test framework that allows defining a test cluster, starting kafka processes in the cluster, running tests and collecting logs. In addition to this, it will be great to have the ability to do the following for each test case run -&lt;/p&gt;

&lt;p&gt;1. collect metrics as exposed by mbeans&lt;br/&gt;
2. collect various system metrics exposed by sar/vmstat/jvm&lt;br/&gt;
3. graph the metrics&lt;/p&gt;

&lt;p&gt;The expected output of this work should be the ability to output a link to all the graphs for each test case.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12605259">KAFKA-489</key>
            <summary>Add metrics collection and graphs to the system test framework</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="nehanarkhede">Neha Narkhede</assignee>
                                    <reporter username="nehanarkhede">Neha Narkhede</reporter>
                        <labels>
                            <label>replication-testing</label>
                    </labels>
                <created>Tue, 28 Aug 2012 17:32:53 +0000</created>
                <updated>Thu, 6 Sep 2012 22:28:51 +0000</updated>
                            <resolved>Thu, 6 Sep 2012 22:28:51 +0000</resolved>
                                    <version>0.8.0</version>
                                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13443453" author="nehanarkhede" created="Tue, 28 Aug 2012 19:49:34 +0000"  >
&lt;p&gt;1. Added a new metrics definition file defined in json format. The purpose of this file is to define the graphs that we want to plot at the end of each test case run. The file is organized as a list of dashboards, one per role (zookeeper/broker/producer/consumer). Each dashboard has all the graphs associated for that role. Each graph is associated with a mbean and has -&lt;br/&gt;
1. Graph title&lt;br/&gt;
2. Mbean name&lt;br/&gt;
3. Attributes and respective y axis labels.&lt;br/&gt;
	A separate graph is plotted for each attribute specified for a mbean. &lt;/p&gt;

&lt;p&gt;2. Metrics are collected when an entity is started. The metrics definition json file is read and the JmxTool is used to collect all the attributes for a particular mbean in a separate csv file. So, we have one csv file per mbean definied in metrics.json&lt;/p&gt;

&lt;p&gt;3. At the end of each test case run, the metrics scripts go through the metrics.json file, find the csv files for all entities associated with a mbean, and plot one graph per attribute. These graphs are placed under testcase/dashboards/&lt;span class=&quot;error&quot;&gt;&amp;#91;role&amp;#93;&lt;/span&gt;/. &lt;/p&gt;

&lt;p&gt;4. Once the graphs are plotted, another script goes through metrics.json and creates html dashboards arranging the graphs in html files, one per role. So we have 4 dashboards, one for zookeeper, broker, producer and consumer. To view the graphs, open testcase/dashboards/metrics.html&lt;/p&gt;

&lt;p&gt;5. Here are the new packages used to build this framework -&lt;br/&gt;
5.1. The graphs are plotted using matplotlib. So matplotlib needs to be installed in order to get these graphs&lt;br/&gt;
5.2. I included a very lightweight python package &#8220;pyh&#8221; to create the html pages. This avoids writing boiler-plate code to create simple html pages.&lt;/p&gt;

&lt;p&gt;6. Code changes -&lt;br/&gt;
6.1. metrics.py includes APIs to collect metrics, plot graphs and create dashboards&lt;br/&gt;
6.2. Currently, we use SnapshotStats to collect metrics. The problem is that it only supports collecting metrics at fixed time windows which is not configurable. It was hard coded to be 1 minute, but for tests, this turns out to be too large to get any meaningful metrics.  Another issue is that we use static objects to register mbeans in most places. I couldn&apos;t find a better way to pass the monitoring duration config parameter. For now, I&apos;ve hardcoded that to 1s, I realize that this is not ideal. But since we will be scraping SnapshotStats as part of &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-203&quot; title=&quot;Improve Kafka internal metrics&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-203&quot;&gt;&lt;del&gt;KAFKA-203&lt;/del&gt;&lt;/a&gt;, we can punt on this for now. &lt;br/&gt;
6.3. The new codahale metrics for socket server and request purgatory attached the broker id to the mbean name. This is inconvenient for most monitoring systems since now they need to pick up the broker id from the application config in order to create the right mbean name for metrics collection. Also, since each broker starts in a separate JVM, there isn&apos;t much value in identifying the mbeans by the broker id. So, I removed the broker id from all mbeans exposed by the codahale metrics package. &lt;br/&gt;
6.4. Right now, there is one csv file output per mbean. The other alternative is one csv file for all possible mbeans exposed by the kafka process. There are 2  concerns with including all metrics in one big csv file -&lt;br/&gt;
1. This file might become too large for long running tests. &lt;br/&gt;
2. If some column gets wedged for some mbean, that can affect the graphs for all other mbeans&lt;br/&gt;
6.5. Arguably, we don&apos;t even need this metrics.json file if we decide to collect all mbeans exposed by a kafka process. The reason I have one is that each graph needs to have a meaningful x/y axes label and a meaningful title. But, if we think the fully qualified mbean name is not too bad for a graph title, and the mbean attribute name is workable as the yaxes label, we could remove it. &lt;br/&gt;
6.6. Removed the single_host_multiple_brokers_test&lt;/p&gt;

&lt;p&gt;To see the graphs -&lt;/p&gt;

&lt;p&gt;1. Run the test&lt;br/&gt;
cd system_test&lt;br/&gt;
python -B system_test_runner.py&lt;/p&gt;

&lt;p&gt;2. Open the system_test/replication_testsuite/testcase_1/dashboards/metrics.html in a browser&lt;/p&gt;</comment>
                            <comment id="13443558" author="nehanarkhede" created="Tue, 28 Aug 2012 21:29:46 +0000"  >&lt;p&gt;Attaching some screenshots of the metrics dashboard for a test case run to give people an approximate idea of how the output looks like. &lt;/p&gt;</comment>
                            <comment id="13443650" author="jfung" created="Tue, 28 Aug 2012 23:26:29 +0000"  >&lt;p&gt;Hi Neha,&lt;/p&gt;

&lt;p&gt;The patch looks good in the system test framework part.&lt;/p&gt;

&lt;p&gt;1. However, the following exception is seen when the test is trying to plot graph. Is this something we can ignore for now ?&lt;/p&gt;

&lt;p&gt;2012-08-28 16:18:20,470 - ERROR - ERROR while plotting graph /home/jfung/workspace_kafka/kafka_r1378357_489v1_sanity/system_test/replication_testsuite/testcase_1/dashboards/broker/kafka.server:type=ProducerRequestPurgatory,name=SatisfactionRate:MeanRate.svg: &lt;span class=&quot;error&quot;&gt;&amp;#91;Errno 2&amp;#93;&lt;/span&gt; No such file or directory: u&apos;/home/jfung/workspace_kafka/kafka_r1378357_489v1_sanity/system_test/replication_testsuite/testcase_1/dashboards/broker/kafka.server:type=ProducerRequestPurgatory,name=SatisfactionRate:MeanRate.svg&apos; (metrics)&lt;br/&gt;
Traceback (most recent call last):&lt;br/&gt;
  File &quot;/home/jfung/workspace_kafka/kafka_r1378357_489v1_sanity/system_test/utils/metrics.py&quot;, line 176, in draw_graph_for_role&lt;br/&gt;
    &quot;time&quot;, labelAndAttribute&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt;, labelAndAttribute&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;, outputGraphFile)&lt;br/&gt;
  File &quot;/home/jfung/workspace_kafka/kafka_r1378357_489v1_sanity/system_test/utils/metrics.py&quot;, line 138, in plot_graphs&lt;br/&gt;
    plt.savefig(outputGraphFile)&lt;/p&gt;

&lt;p&gt;2. This is the pathname of the file in the exception message:&lt;/p&gt;

&lt;p&gt;/home/jfung/workspace_kafka/kafka_r1378357_489v1_sanity/system_test/replication_testsuite/testcase_1/dashboards/broker/kafka.server:type=ProducerRequestPurgatory,name=ExpirationRate:MeanRate.svg&lt;/p&gt;</comment>
                            <comment id="13443680" author="junrao" created="Wed, 29 Aug 2012 00:11:26 +0000"  >&lt;p&gt;+1 on the patch. One minor issue: We should remove the info level logging in SyncProducerStats.recordProduceRequest().&lt;/p&gt;</comment>
                            <comment id="13443709" author="nehanarkhede" created="Wed, 29 Aug 2012 00:59:19 +0000"  >&lt;p&gt;John, &lt;/p&gt;

&lt;p&gt;That was a bug in the patch that didn&apos;t pre-create the required dashboards directory. Hence the graph plotting script failed while writing to the svg file at that location. I&apos;ve fixed that in patch v2. &lt;/p&gt;

&lt;p&gt;Fixed the info statement in SyncProducerStats.&lt;/p&gt;</comment>
                            <comment id="13444231" author="jfung" created="Wed, 29 Aug 2012 17:37:39 +0000"  >&lt;p&gt;+1 on patch v2.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12542831" name="kafka-489-broker-metrics.pdf" size="1355703" author="nehanarkhede" created="Tue, 28 Aug 2012 21:29:46 +0000"/>
                            <attachment id="12542832" name="kafka-489-consumer-metrics.pdf" size="126373" author="nehanarkhede" created="Tue, 28 Aug 2012 21:29:46 +0000"/>
                            <attachment id="12542833" name="kafka-489-producer-metrics.pdf" size="115736" author="nehanarkhede" created="Tue, 28 Aug 2012 21:29:46 +0000"/>
                            <attachment id="12542814" name="kafka-489-v1.patch" size="104335" author="nehanarkhede" created="Tue, 28 Aug 2012 19:50:39 +0000"/>
                            <attachment id="12542874" name="kafka-489-v2.patch" size="105106" author="nehanarkhede" created="Wed, 29 Aug 2012 00:59:19 +0000"/>
                            <attachment id="12542834" name="kafka-metrics-home.pdf" size="16487" author="nehanarkhede" created="Tue, 28 Aug 2012 21:29:46 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>241663</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 12 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i029p3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>11172</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>