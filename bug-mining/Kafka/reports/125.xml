<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:36:13 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-573] System Test : Leader Failure Log Segment Checksum Mismatched When request-num-acks is 1</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-573</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;&#8226; Test Description:&lt;/p&gt;

&lt;p&gt;1. Start a 3-broker cluster as source&lt;br/&gt;
2. Send messages to source cluster&lt;br/&gt;
3. Find leader and terminate it (kill -15)&lt;br/&gt;
4. Start the broker again&lt;br/&gt;
5. Start a consumer to consume data&lt;br/&gt;
6. Compare the MessageID in the data between producer log and consumer log.&lt;/p&gt;

&lt;p&gt;&#8226; Issue: There will be data loss if request-num-acks is set to 1. &lt;/p&gt;

&lt;p&gt;&#8226; To reproduce this issue, please do the followings:&lt;/p&gt;

&lt;p&gt;1. Download the latest 0.8 branch&lt;br/&gt;
2. Apply the patch attached to this JIRA&lt;br/&gt;
3. Build kafka by running &quot;./sbt update package&quot;&lt;br/&gt;
4. Execute the test in directory &quot;system_test&quot; : &quot;python -B system_test_runner.py&quot;&lt;br/&gt;
5. This test will execute testcase_2 with the following settings:&lt;br/&gt;
    Replica factor : 3&lt;br/&gt;
    No. of partitions : 1&lt;br/&gt;
    No. of bouncing : 1&lt;/p&gt;</description>
                <environment></environment>
        <key id="12611772">KAFKA-573</key>
            <summary>System Test : Leader Failure Log Segment Checksum Mismatched When request-num-acks is 1</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="junrao">Jun Rao</assignee>
                                    <reporter username="jfung">John Fung</reporter>
                        <labels>
                    </labels>
                <created>Sun, 14 Oct 2012 22:43:55 +0000</created>
                <updated>Fri, 19 Oct 2012 00:10:56 +0000</updated>
                            <resolved>Fri, 19 Oct 2012 00:10:52 +0000</resolved>
                                    <version>0.8.0</version>
                                    <fixVersion>0.8.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="13475919" author="jfung" created="Sun, 14 Oct 2012 22:57:20 +0000"  >&lt;p&gt;These are some manual verification of the differences in the log segment files:&lt;/p&gt;

&lt;p&gt;&#8226; Merging the log segment files for each broker:&lt;br/&gt;
  $ for i in `find kafka_server_1_logs/ -name &apos;0*.log&apos; | sort`; do cat $i &amp;gt;&amp;gt; broker-1-merged/00000000000000000000.log; done&lt;br/&gt;
  $ for i in `find kafka_server_2_logs/ -name &apos;0*.log&apos; | sort`; do cat $i &amp;gt;&amp;gt; broker-2-merged/00000000000000000000.log; done&lt;br/&gt;
  $ for i in `find kafka_server_3_logs/ -name &apos;0*.log&apos; | sort`; do cat $i &amp;gt;&amp;gt; broker-3-merged/00000000000000000000.log; done&lt;/p&gt;

&lt;p&gt;&#8226; Verify the checksum of each merged log segment and they are different:&lt;br/&gt;
  $ cksum broker-1-merged/00000000000000000000.log &lt;br/&gt;
  1742950004 1638036 broker-1-merged/00000000000000000000.log&lt;br/&gt;
  $ cksum broker-2-merged/00000000000000000000.log &lt;br/&gt;
  2050258314 1639080 broker-2-merged/00000000000000000000.log&lt;br/&gt;
  $ cksum broker-3-merged/00000000000000000000.log &lt;br/&gt;
  1802214049 1639080 broker-3-merged/00000000000000000000.log&lt;/p&gt;

&lt;p&gt;&#8226; Get the dump log segments of the merged files:&lt;br/&gt;
  $ bin/kafka-run-class.sh kafka.tools.DumpLogSegments broker-1-merged/00000000000000000000.log &amp;gt; broker-1-dump-log-segment.log&lt;br/&gt;
  $ bin/kafka-run-class.sh kafka.tools.DumpLogSegments broker-2-merged/00000000000000000000.log &amp;gt; broker-2-dump-log-segment.log&lt;br/&gt;
  $ bin/kafka-run-class.sh kafka.tools.DumpLogSegments broker-3-merged/00000000000000000000.log &amp;gt; broker-3-dump-log-segment.log&lt;/p&gt;

&lt;p&gt;&#8226; Diff the dump log segment between broker-1 &amp;amp; broker-2:&lt;/p&gt;

&lt;p&gt;$ diff broker-1-dump-log-segment.log broker-2-dump-log-segment.log &lt;/p&gt;

&lt;p&gt;1c1&lt;br/&gt;
&amp;lt; Dumping broker-1-merged/00000000000000000000.log&lt;br/&gt;
&amp;#8212;&lt;br/&gt;
&amp;gt; Dumping broker-2-merged/00000000000000000000.log&lt;br/&gt;
113a114&lt;br/&gt;
&amp;gt; offset: 112 isvalid: true payloadsize: 500 magic: 2 compresscodec: NoCompressionCodec crc: 2581499653&lt;br/&gt;
168a170&lt;br/&gt;
&amp;gt; offset: 168 isvalid: true payloadsize: 500 magic: 2 compresscodec: NoCompressionCodec crc: 3880215630&lt;br/&gt;
387a390&lt;br/&gt;
&amp;gt; offset: 389 isvalid: true payloadsize: 500 magic: 2 compresscodec: NoCompressionCodec crc: 3744939326&lt;br/&gt;
2734d2736&lt;br/&gt;
&amp;lt; offset: 2737 isvalid: true payloadsize: 500 magic: 2 compresscodec: NoCompressionCodec crc: 314900536&lt;/p&gt;</comment>
                            <comment id="13475966" author="jfung" created="Mon, 15 Oct 2012 05:01:51 +0000"  >&lt;p&gt;If ack is set to 1, we actually don&apos;t guarantee no data loss. This is because when the client receives an ack, data is only guaranteed to be in the leader, but not necessarily in other replicas. So, if a leader is bounced, some acked data could be lost. &lt;/p&gt;

&lt;p&gt;Nevertheless, merged checksums should still match among all replicas. &lt;/p&gt;</comment>
                            <comment id="13478594" author="junrao" created="Thu, 18 Oct 2012 02:02:13 +0000"  >&lt;p&gt;Attach a patch. There are 2 problems. The first one is the most severe one. We recently changed FileMessageSet to remove the mutable flag. As a result, everytime a new FileMessageSet is created, the constructor sets the file channel&apos;s position to the end of the file. What&apos;s happening is that while a file channel is being appended for newly produced data, the file position is moved by FileMessageSet created for fetch requests. Since they are not properly synchronized, occasionally, a message in the log is overwritten. The second issue is that in ByteBufferMessageSet.writeTo. We try to reset the buffer position after writing the data in the buffer to the channel. However, since there is no guarantee that the whole buffer will be written to the channel in a single write, resetting the buffer position could cause incorrect bytes being written to the channel.&lt;/p&gt;

&lt;p&gt;The patch fixes both issues. The changes are: (1) Added a new flag in the constructor of FileMessageSet to control whether the channel position is set to the end of the file or not. (2) Changed ByteBufferMessageSet.writeTo so that we wait until the whole buffer is written to the channel before resetting the buffer position. (3) Added a few more logging that I found useful while investigating the issues.&lt;/p&gt;

&lt;p&gt;The system test passes now.&lt;/p&gt;</comment>
                            <comment id="13479092" author="jfung" created="Thu, 18 Oct 2012 15:54:27 +0000"  >&lt;p&gt;Thanks Jun for the patch. The patch is applied together with the reproducing issue patch to the latest 0.8 branch and it is working correctly now.&lt;/p&gt;</comment>
                            <comment id="13479328" author="jfung" created="Thu, 18 Oct 2012 20:27:51 +0000"  >&lt;p&gt;A full regression test (35 test cases) has been launched with this patch and the following is the summary of the results:&lt;/p&gt;

&lt;p&gt;1. There are all together 5 failures in 5 test cases out of 35 cases.&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;testcase_0103 : 2 out of 2300 msg lost (checksum matched) - failure case with Ack == 1 in Sync mode (1 topic, 1 partition)&lt;/li&gt;
	&lt;li&gt;testcase_0105 : 2 out of 2300 msg lost (checksum matched) - failure case with Ack == 1 in Async mode (1 topic, 1 partition)&lt;/li&gt;
	&lt;li&gt;testcase_0114 : 11 out of 5100 msg lost (checksum matched) - failure case with Ack == 1 in Async mode (1 topic, 3 partitions)&lt;/li&gt;
	&lt;li&gt;testcase_0117 : 44 out of 5100 msg lost (checksum matched) - failure case with Ack == 1 in Sync mode (1 topic, 3 partitions)&lt;/li&gt;
	&lt;li&gt;testcase_0122 : 1524 out of 4600 msg lost (checksum matched) - failure case with Ack == 1 in Sync mode ( 2 topics, 3 partitions)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;2. The results suggest that the fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-573&quot; title=&quot;System Test : Leader Failure Log Segment Checksum Mismatched When request-num-acks is 1&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-573&quot;&gt;&lt;del&gt;KAFKA-573&lt;/del&gt;&lt;/a&gt; is working well (minor data loss in the first 4 cases are expected in leader failure cases when ack == 1).&lt;/p&gt;

&lt;p&gt;3. The result in testcase_0122 could be related to a different issue and a new JIRA will be created to keep track of that.&lt;/p&gt;</comment>
                            <comment id="13479393" author="jjkoshy" created="Thu, 18 Oct 2012 21:37:23 +0000"  >&lt;p&gt;+1&lt;/p&gt;

&lt;p&gt;This must have been a pain to track down. Minor comment: In FileMessageSet, since we always open mutable, can you fix the comment (from javadoc) that says it can be opened immutable. Also, the info log reads a bit odd.&lt;/p&gt;</comment>
                            <comment id="13479429" author="nehanarkhede" created="Thu, 18 Oct 2012 22:31:04 +0000"  >&lt;p&gt;+1, this one was fun to track down. Reminded me of the FileChannel truncate bug.&lt;/p&gt;

&lt;p&gt;Minor comment - Probably best to delete the info statement - &lt;br/&gt;
 info(&quot;After changed to position %d with size %d&quot;.format(channel.position(), channel.size()))&lt;/p&gt;</comment>
                            <comment id="13479520" author="junrao" created="Fri, 19 Oct 2012 00:10:52 +0000"  >&lt;p&gt;Thanks for the review. Removed the unnecessary log statement and committed to 0.8.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12549097" name="acks1_leader_failure_data_loss.tar.gz" size="724722" author="jfung" created="Sun, 14 Oct 2012 22:51:36 +0000"/>
                            <attachment id="12549096" name="kafka-573-reproduce-issue.patch" size="39117" author="jfung" created="Sun, 14 Oct 2012 22:47:13 +0000"/>
                            <attachment id="12549629" name="kafka-573.patch" size="9473" author="junrao" created="Thu, 18 Oct 2012 02:02:13 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>248589</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 5 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i09w93:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>55666</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>