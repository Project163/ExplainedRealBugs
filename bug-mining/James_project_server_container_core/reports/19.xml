<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 19:29:16 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[JAMES-2557] NULL_SENDER throws an error in Dlp</title>
                <link>https://issues.apache.org/jira/browse/JAMES-2557</link>
                <project id="10411" key="JAMES">James Server</project>
                    <description>&lt;p&gt;Watching Kibana logs I got this recurring error:&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 	Exception calling dlp.Dlp: NULL sender &lt;span class=&quot;code-quote&quot;&gt;&apos;&amp;lt;&amp;gt;&apos;&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; not have domain part
java.lang.IllegalStateException: NULL sender &lt;span class=&quot;code-quote&quot;&gt;&apos;&amp;lt;&amp;gt;&apos;&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; not have domain part
	at org.apache.james.core.MailAddress$1.getDomain(MailAddress.java:87)
	at org.apache.james.transport.matchers.dlp.Dlp.matchingRule(Dlp.java:76)
	at org.apache.james.transport.matchers.dlp.Dlp.lambda$findFirstMatchingRule$0(Dlp.java:72)
	at java.util.Optional.flatMap(Optional.java:241)
	at org.apache.james.transport.matchers.dlp.Dlp.findFirstMatchingRule(Dlp.java:72)
	at org.apache.james.transport.matchers.dlp.Dlp.match(Dlp.java:55)
	at org.apache.james.mailetcontainer.impl.camel.MatcherSplitter.split(MatcherSplitter.java:109)
	at sun.reflect.GeneratedMethodAccessor70.invoke(Unknown Source)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:498)
	at org.apache.camel.component.bean.MethodInfo.invoke(MethodInfo.java:481)
	at org.apache.camel.component.bean.MethodInfo$1.doProceed(MethodInfo.java:300)
	at org.apache.camel.component.bean.MethodInfo$1.proceed(MethodInfo.java:273)
	at org.apache.camel.component.bean.AbstractBeanProcessor.process(AbstractBeanProcessor.java:187)
	at org.apache.camel.util.AsyncProcessorHelper.process(AsyncProcessorHelper.java:109)
	at org.apache.camel.component.bean.AbstractBeanProcessor.process(AbstractBeanProcessor.java:70)
	at org.apache.camel.language.bean.BeanExpression.invokeBean(BeanExpression.java:200)
	at org.apache.camel.language.bean.BeanExpression.evaluate(BeanExpression.java:124)
	at org.apache.camel.language.bean.BeanExpression.evaluate(BeanExpression.java:135)
	at org.apache.camel.processor.Splitter.createProcessorExchangePairs(Splitter.java:127)
	at org.apache.camel.processor.MulticastProcessor.process(MulticastProcessor.java:241)
	at org.apache.camel.processor.Splitter.process(Splitter.java:122)
	at org.apache.camel.processor.RedeliveryErrorHandler.process(RedeliveryErrorHandler.java:548)
	at org.apache.camel.processor.CamelInternalProcessor.process(CamelInternalProcessor.java:201)
	at org.apache.camel.processor.Pipeline.process(Pipeline.java:138)
	at org.apache.camel.processor.Pipeline.process(Pipeline.java:101)
	at org.apache.camel.processor.CamelInternalProcessor.process(CamelInternalProcessor.java:201)
	at org.apache.camel.component.direct.DirectBlockingProducer.process(DirectBlockingProducer.java:53)
	at org.apache.camel.processor.SharedCamelInternalProcessor.process(SharedCamelInternalProcessor.java:186)
	at org.apache.camel.processor.SharedCamelInternalProcessor.process(SharedCamelInternalProcessor.java:86)
	at org.apache.camel.impl.ProducerCache$1.doInProducer(ProducerCache.java:541)
	at org.apache.camel.impl.ProducerCache$1.doInProducer(ProducerCache.java:506)
	at org.apache.camel.impl.ProducerCache.doInProducer(ProducerCache.java:369)
	at org.apache.camel.impl.ProducerCache.sendExchange(ProducerCache.java:506)
	at org.apache.camel.impl.ProducerCache.send(ProducerCache.java:229)
	at org.apache.camel.impl.DefaultProducerTemplate.send(DefaultProducerTemplate.java:144)
	at org.apache.camel.impl.DefaultProducerTemplate.sendBody(DefaultProducerTemplate.java:161)
	at org.apache.camel.impl.DefaultProducerTemplate.sendBody(DefaultProducerTemplate.java:168)
	at org.apache.james.mailetcontainer.impl.camel.CamelMailetProcessor.service(CamelMailetProcessor.java:68)
	at org.apache.james.mailetcontainer.lib.AbstractStateCompositeProcessor.service(AbstractStateCompositeProcessor.java:84)
	at org.apache.james.mailetcontainer.impl.JamesMailSpooler.lambda$run$0(JamesMailSpooler.java:163)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It cames from the Dlp part (Dlp.java):&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; Optional&amp;lt;DLPConfigurationItem.Id&amp;gt; findFirstMatchingRule(Mail mail) {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; Optional
                .ofNullable(mail.getSender())
                .flatMap(sender -&amp;gt; matchingRule(sender, mail));
    }

    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; Optional&amp;lt;DLPConfigurationItem.Id&amp;gt; matchingRule(MailAddress address, Mail mail) {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; rulesLoader.load(address.getDomain()).match(mail);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Since `mail.getSender()` returns a `NULL_SENDER` and not a `null` value, `matchingRule` is executed, since it breaks the LSP, it breaks our code.&lt;/p&gt;

&lt;p&gt;There are two solutions:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Strengthening `MailAddress`&lt;/li&gt;
	&lt;li&gt;Checking `MailAddress.isNullSender()`&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="13190278">JAMES-2557</key>
            <summary>NULL_SENDER throws an error in Dlp</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="btellier">Benoit Tellier</reporter>
                        <labels>
                    </labels>
                <created>Tue, 9 Oct 2018 04:43:37 +0000</created>
                <updated>Tue, 11 Dec 2018 07:03:08 +0000</updated>
                            <resolved>Wed, 10 Oct 2018 08:50:44 +0000</resolved>
                                    <version>master</version>
                    <version>3.1.0</version>
                                    <fixVersion>3.2.0</fixVersion>
                                    <component>Mailet Contributions</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="16644653" author="btellier" created="Wed, 10 Oct 2018 08:50:44 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/linagora/james-project/pull/1789&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/linagora/james-project/pull/1789&lt;/a&gt; fixed this&lt;/p&gt;</comment>
                            <comment id="16655075" author="btellier" created="Thu, 18 Oct 2018 11:31:02 +0000"  >&lt;p&gt;We encopuntered the following logs in production:&lt;/p&gt;

&lt;p&gt;```&lt;br/&gt;
Exception calling SenderIsLocal: NULL sender &apos;&amp;lt;&amp;gt;&apos; do not have domain part java.lang.IllegalStateException: NULL sender &apos;&amp;lt;&amp;gt;&apos; do not have domain part at org.apache.james.core.MailAddress$1.getDomain(MailAddress.java:87) at org.apache.james.mailetcontainer.impl.JamesMailetContext.isLocalEmail(JamesMailetContext.java:253) at org.apache.james.transport.matchers.SenderIsLocal.isLocal(SenderIsLocal.java:43) at org.apache.james.transport.matchers.SenderIsLocal.match(SenderIsLocal.java:36) at org.apache.james.mailetcontainer.impl.camel.MatcherSplitter.split(MatcherSplitter.java:109) at sun.reflect.GeneratedMethodAccessor68.invoke(Unknown Source) at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) at java.lang.reflect.Method.invoke(Method.java:498) at org.apache.camel.component.bean.MethodInfo.invoke(MethodInfo.java:481)&lt;br/&gt;
```&lt;/p&gt;

&lt;p&gt;As this PR demonstrate, `MailAddress.nullSender()` hack is harmful and required a check each time the sender is checked/used.&lt;/p&gt;

&lt;p&gt;We could try to patch this in some places, where we know it will break.&lt;/p&gt;

&lt;p&gt;Known breakdown:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;`SenderIs*` matchers (see  )&lt;/li&gt;
	&lt;li&gt;MailetContext::bounce&lt;/li&gt;
	&lt;li&gt;Signature mailets&lt;/li&gt;
	&lt;li&gt;`IsSenderInRRTLoop SenderInFakeDomain`&lt;/li&gt;
	&lt;li&gt;JMAP vacation and Redirect that does rely to the original senders&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Alternative proposal&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Maybe a better alternative is to redesign the `Mail` api and propose a &lt;/p&gt;

&lt;p&gt;```&lt;br/&gt;
Optional&amp;lt;MailAddress&amp;gt; getSenderAsOptional()&lt;br/&gt;
```&lt;/p&gt;

&lt;p&gt;Deprecate todays `getSender()` and `nullSender()`...&lt;/p&gt;

&lt;p&gt;Then we have to make the existing code work with `getSenderAsOptional()` only...&lt;/p&gt;</comment>
                            <comment id="16655079" author="btellier" created="Thu, 18 Oct 2018 11:35:05 +0000"  >&lt;p&gt;See &lt;a href=&quot;https://github.com/linagora/james-project/pull/1818&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/linagora/james-project/pull/1818&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16661586" author="btellier" created="Wed, 24 Oct 2018 01:53:38 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/linagora/james-project/pull/1818&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/linagora/james-project/pull/1818&lt;/a&gt; solved a similar issue for SenderIs matchers&lt;/p&gt;</comment>
                            <comment id="16668033" author="btellier" created="Tue, 30 Oct 2018 02:42:18 +0000"  >&lt;p&gt;Added a MaybeSender object and did use it everywhere in Mailet related code. &lt;a href=&quot;https://github.com/linagora/james-project/pull/1846&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/linagora/james-project/pull/1846&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16671095" author="btellier" created="Thu, 1 Nov 2018 04:09:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/linagora/james-project/pull/1861&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/linagora/james-project/pull/1861&lt;/a&gt; MaybeSender should be used in SMTP layers&lt;/p&gt;</comment>
                            <comment id="16716371" author="btellier" created="Tue, 11 Dec 2018 07:02:53 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/linagora/james-project/pull/2003&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/linagora/james-project/pull/2003&lt;/a&gt; Use MaybeSender in SMTP session&lt;/p&gt;</comment>
                            <comment id="16716372" author="btellier" created="Tue, 11 Dec 2018 07:03:08 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/linagora/james-project/pull/2004&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/linagora/james-project/pull/2004&lt;/a&gt; Finally deprecate MailAddress::nullSender &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 48 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3yz4f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>