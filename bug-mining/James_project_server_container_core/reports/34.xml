<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 19:29:22 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[JAMES-3431] Relay DSN options on RemoteDelivery</title>
                <link>https://issues.apache.org/jira/browse/JAMES-3431</link>
                <project id="10411" key="JAMES">James Server</project>
                    <description>&lt;p&gt;Since James claims to support the DSN SMTP extension, it may receive a mail submission according to &lt;a href=&quot;https://tools.ietf.org/html/rfc3461&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;RFC 3461&lt;/a&gt;:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
MAIL FROM:&amp;lt;Alice@Example.ORG&amp;gt; RET=HDRS ENVID=QQ314159
RCPT TO:&amp;lt;Dana@Ivory.EDU&amp;gt; NOTIFY=SUCCESS,FAILURE,DELAY ORCPT=rfc822;Dana@Ivory.EDU
RCPT TO:&amp;lt;Fred@Bombs.AF.MIL&amp;gt; NOTIFY=NEVER&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;In this case James should&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;remember the given DSN options (NOTIFY, ORCPT, RET, ENVID) for each recipient, and&lt;/li&gt;
	&lt;li&gt;provide the same options when relaying the mail to remote servers via the RemoteDelivery mailet.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;(The DSN options should be accessible to other interested mailets as well, e.g. for bounce processing.)&lt;/p&gt;

&lt;p&gt;Possibly related issues:&lt;br/&gt;
 &lt;a href=&quot;https://issues.apache.org/jira/browse/JAMES-322&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/JAMES-322&lt;/a&gt;&lt;br/&gt;
 &lt;a href=&quot;https://issues.apache.org/jira/browse/JAMES-362&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/JAMES-362&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13336275">JAMES-3431</key>
            <summary>Relay DSN options on RemoteDelivery</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="kotto">Karsten Otto</reporter>
                        <labels>
                    </labels>
                <created>Tue, 20 Oct 2020 11:16:02 +0000</created>
                <updated>Tue, 23 Feb 2021 03:51:02 +0000</updated>
                            <resolved>Tue, 23 Feb 2021 03:51:02 +0000</resolved>
                                    <version>3.5.0</version>
                                    <fixVersion>3.6.0</fixVersion>
                                    <component>Remote Delivery</component>
                    <component>SMTPServer</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="17220640" author="btellier" created="Mon, 26 Oct 2020 12:02:33 +0000"  >&lt;p&gt;Hello Otto.&lt;/p&gt;

&lt;p&gt;Thanks for the report, this seems very interesting.&lt;/p&gt;

&lt;p&gt;We need to cary over these parameters from the SMTP server stack through the mailetcontainer into RemoteDelivery. The way I would see to do it is:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Either to modify the Mail object in order to modify the recipient property, in order to take parameters into account, but this is a breaking change in one of our core APIs.&lt;/li&gt;
	&lt;li&gt;Or a mail attribute could be set up, for each recipient.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Regarding &quot;remote delivery&quot;, SMTPTransport seems to handle DSN extension, `mail.smtp.dsn.notify` configure it server wide. I&apos;m however unsure we could get this working in a MX forwarding context (as this is a configured value). Subclassing SMTPTransport seems brittle, getting rid of javax.mail not doable quickly. Would configuring this at the server level help your use case?&lt;/p&gt;

&lt;p&gt;And of course James needs to comply to DSN specification as you mentionned: &lt;a href=&quot;https://issues.apache.org/jira/browse/JAMES-362&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/JAMES-362&lt;/a&gt; &lt;/p&gt;</comment>
                            <comment id="17220707" author="kotto" created="Mon, 26 Oct 2020 13:55:14 +0000"  >&lt;p&gt;&amp;gt; Would configuring this at the server level help your use case?&lt;/p&gt;

&lt;p&gt;Unfortunately not. The use case is a form of &quot;registered mail&quot; scenario, where a user requires notification once certain important mails reach the recipients inbox (NOTIFY=SUCCESS). But in general they only care about delivery failure (NOTIFY=FAILURE) and don&apos;t want any confirmations for each and every mail. Looking at the source code of SMTPTransport, mail.smtp.dsn.notify would set the NOTIFY option to a fixed value regardless, which is not helpful.&lt;/p&gt;

&lt;p&gt;However, I noticed that SMTPTransport actually can use the SMTPMessage subclass of MimeMessage to specify the NOTIFY and RET options, and possibly even ENVID via setMailExtension. Maybe this could be a backwards compatible way to make DSN work, without abandoning javax.mail? Of course there are still all the other issues regarding mail attributes and SMTP stack.&lt;/p&gt;</comment>
                            <comment id="17231246" author="btellier" created="Fri, 13 Nov 2020 08:18:36 +0000"  >&lt;p&gt;Hello Karsten,&lt;/p&gt;

&lt;p&gt;I took some time to come up with some end to end scenarii regarding DSN feature:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    Given a mail with no NOTIFY params &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; a local user When it succeed THEN no email is sent back to the sender
    Given a mail with no NOTIFY params &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; a local user When it fails THEN a regular bounce is sent back to the sender
    Given a mail with no NOTIFY params &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; a remote user When it succeed THEN no email is sent back to the sender
    Given a mail with no NOTIFY params &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; a remote user When it fails THEN a regular bounce is sent back to the sender

    Given a mail with NOTIFY=NEVER params &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; a local user When it succeed THEN no DSN success notification is sent to the sender
    Given a mail with NOTIFY=NEVER params &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; a local user When it fails THEN no bounce is sent back to the sender
    Given a mail with NOTIFY=NEVER params &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; a remote user When it succeed THEN no email is sent back to the sender (by James), james forward the responsibility to the remote server (NOTIFY=SUCCESS)
    Given a mail with NOTIFY=NEVER params &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; a remote user When it fails THEN no bounce is sent back to the sender

    Given a mail with NOTIFY=SUCCESS params &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; a local user When it succeed THEN a DSN success notification is sent to the sender
    Given a mail with NOTIFY=SUCCESS params &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; a local user When it fails THEN a regular bounce is sent back to the sender
    Given a mail with NOTIFY=SUCCESS params &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; a remote user When it succeed THEN no email is sent back to the sender (by James), james forward the responsibility to the remote server (NOTIFY=SUCCESS)
    Given a mail with NOTIFY=SUCCESS params &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; a remote user When it fails THEN a regular bounce is sent back to the sender

    Given a mail with NOTIFY=FAILURE params &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; a local user When it succeed THEN no email is sent back to the sender
    Given a mail with NOTIFY=FAILURE params &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; a local user When it fails THEN a dsn bounce is sent back to the sender
    Given a mail with NOTIFY=FAILURE params &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; a remote user When it succeed THEN no email is sent back to the sender (by James), james forward the responsibility to the remote server (NOTIFY=FAILURE)
    Given a mail with NOTIFY=FAILURE params &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; a remote user When it fails THEN a dsn bounce is sent back to the sender

    Given a mail with NOTIFY=DELAY params &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; a remote user When temporary failures are encountered THEN a dsn bounce is sent back to the sender, and James eventually forward the responsibility to the remote server (NOTIFY=FAILURE)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Here would be the steps to implement and test these behaviors:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;1. Modify the Mail object, of the mailet-api to include the &quot;per rcpt notify partameters&quot;&lt;/li&gt;
	&lt;li&gt;Emuate a strong type API on top of Email object, backed by mail attributes.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;2. Handling the NOTIFY  extension at the SMTP server level to position the &quot;per rcpt notify partameters&quot; on emails. Command handler saves intermediate states in the SMTP session.&lt;/li&gt;
	&lt;li&gt;MailCmdHandler handling for VERIFY and RET options&lt;/li&gt;
	&lt;li&gt;RcptCmdHandler should attach the NOTIFY and ORCPT parameters for the recipient to the SMTP session&lt;/li&gt;
	&lt;li&gt;Provide a JamesMessageHook to position DSN information on enqueued emails&lt;/li&gt;
	&lt;li&gt;Unit test as the command handler level&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;3. MailQueue needs to carry over &quot;per rcpt notify partameters&quot;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;4. MailRepositories needs to carry over &quot;per rcpt notify partameters&quot;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;5. Provide utilities for processing and generating DSN within the mailet container&lt;/li&gt;
	&lt;li&gt;Audit existing DSNBounce mailet, and provide more specilized mailet: DSNSuccess, DSNDelay, DSNFailure&lt;/li&gt;
	&lt;li&gt;RET option needs to be taken into account, on a per email basis and not as a global parameter&lt;/li&gt;
	&lt;li&gt;ENVID needs to be taken into account and returned within the bounce.&lt;/li&gt;
	&lt;li&gt;Add DSNSuccessRequested, DSNFailureRequested , DSNDelayRequested matchers&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;6. Remote Delivery should cary over NOTIFY parameters (using SMTPMessage)&lt;/li&gt;
	&lt;li&gt;Customize MockSmtpServer to register RCPT NOTIFY parameters&lt;/li&gt;
	&lt;li&gt;adapt interaction format &amp;amp; store&lt;/li&gt;
	&lt;li&gt;modify MockSMTPServer SMTP stack to capture Motification parameters into the interactions&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17241409" author="btellier" created="Tue, 1 Dec 2020 09:52:12 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/linagora/james-project/pull/4099&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/linagora/james-project/pull/4099&lt;/a&gt; introduce the POJOs to integrate to the MAIL object in order to represents DSNs&lt;/p&gt;

&lt;p&gt;Next steps will be to add a bridge to/from Mail attributed, and connect it to the Mail API via defaults methods. I will likely work on this on thursday.&lt;/p&gt;</comment>
                            <comment id="17242907" author="btellier" created="Thu, 3 Dec 2020 04:46:46 +0000"  >&lt;p&gt;I enhanced &lt;a href=&quot;https://github.com/linagora/james-project/pull/4099&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/linagora/james-project/pull/4099&lt;/a&gt; to add DsnParameters to the Mail object.&lt;/p&gt;

&lt;p&gt;To do so I leveraged mail attributes. In order to be as strong typed (and safe) as possible I leverage collections AttributeValues.&lt;/p&gt;

&lt;p&gt;However some implementations do break, as they (still!) rely on java serialization despite recent work on &lt;a href=&quot;https://issues.apache.org/jira/browse/JAMES-2578&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/JAMES-2578&lt;/a&gt; . &lt;/p&gt;

&lt;p&gt;The current work is working with RabbitMQ &amp;amp; memory mail queues but is not supported by file &amp;amp; jms implementations.&lt;/p&gt;

&lt;p&gt;Here are the options we have:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Accept DSN feature do not work on tese implementations (not my prefered at all!)&lt;/li&gt;
	&lt;li&gt;Re-implement DSNParameters attribute mapping to not use collection attributeValues. This work around the main issue for this specific use case of attribute values. (I feel okay with that)&lt;/li&gt;
	&lt;li&gt;Try to fix collection attributeValue java serialization is likely hard to do, but also keeps java serialization around for longer in the code base. Likely a dead-end.&lt;/li&gt;
	&lt;li&gt;No longer rely on Java serialization for &quot;JMS&quot; &amp;amp; &quot;File&quot; mail queues. This means either smart fallback code, or at worst an upgrade path with an empty mail queue. That is by far my prefered option, and I will start community discussions in that direction.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17242909" author="btellier" created="Thu, 3 Dec 2020 04:56:06 +0000"  >&lt;p&gt;Related mailing list discussion thread: &lt;a href=&quot;https://www.mail-archive.com/server-dev@james.apache.org/msg69107.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://www.mail-archive.com/server-dev@james.apache.org/msg69107.html&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17243007" author="kotto" created="Thu, 3 Dec 2020 08:35:50 +0000"  >&lt;p&gt;I believe variant 2 (Re-implement DSNParameters mapping) would be the best solution to get the DSN feature done with minimal impact on the general code base.&lt;/p&gt;

&lt;p&gt;Variant 4 (remove Java serialization) seems like cleaner solution overall, but with a wide impact on the James code base, and a high potential for unexpected difficulties. Seems more like a long term strategy.&lt;/p&gt;

&lt;p&gt;Maybe go for variant 2 for now, with an option to re-visit it at a later date, once&#160; there is a viable basis for it from variant 4?&lt;/p&gt;</comment>
                            <comment id="17243037" author="btellier" created="Thu, 3 Dec 2020 09:18:30 +0000"  >&lt;p&gt;Thanks for the feedback.&lt;/p&gt;

&lt;p&gt;The impact is overall limited (bonded to the 2 mail queue implementations), the complexity depends mostly on the upgrade path. The &quot;empty mailqueue&quot; is easy to perform, and easy to implement.&lt;/p&gt;

&lt;p&gt;I could try to work on option 4. for say 1 day, and default to 2. if this is more complicated than expected.&lt;/p&gt;

&lt;p&gt;Would it seem reasonable to you?&lt;/p&gt;</comment>
                            <comment id="17243040" author="kotto" created="Thu, 3 Dec 2020 09:22:00 +0000"  >&lt;p&gt;OK, you have a better overview of the possible impact. If you can fix the issue through option 4, sure, sounds reasonable.&lt;/p&gt;</comment>
                            <comment id="17247036" author="githubbot" created="Thu, 10 Dec 2020 06:01:59 +0000"  >&lt;p&gt;chibenwa opened a new pull request #278:&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/james-project/pull/278&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/james-project/pull/278&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   I decided to write DSN support as a completely optional extension to the James SMTP server.&lt;/p&gt;

&lt;p&gt;   Why? Because RFC-3461 compliance needs the mail processing to be correctly configured (and handle DSN bounces correctly). Which we cannot assume. Hence, for the sake of compliance, this should be optional.&lt;/p&gt;

&lt;p&gt;   For the sake of the exercise, I decided to challenge leveraging SMTP hooks to implement new ESMTP extensions. Needless to say, I had bad surprises.&lt;/p&gt;

&lt;p&gt;   I needed to modify &quot;core&quot; SMTP server code in order to:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Pass new supported ESMTP extensions to EHLO command&lt;/li&gt;
	&lt;li&gt;Cary over RCPT parameters to the RcptHooks.&lt;/li&gt;
	&lt;li&gt;Rcpt hooks needs to announce which RCPT parameters they can handle. Rcpt command should not reject those.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;   Default methods where used in order NOT to introduce braking changes.&lt;/p&gt;

&lt;p&gt;   To enable DSN in JAMES, add the following handler to smtpserver.xml : &lt;/p&gt;

&lt;p&gt;   ```&lt;br/&gt;
               &amp;lt;handler class=&quot;org.apache.james.smtpserver.dsn.DSNHeloHook&quot;/&amp;gt;&lt;br/&gt;
               &amp;lt;handler class=&quot;org.apache.james.smtpserver.dsn.DSNMailParameterHook&quot;/&amp;gt;&lt;br/&gt;
               &amp;lt;handler class=&quot;org.apache.james.smtpserver.dsn.DSNRcptParameterHook&quot;/&amp;gt;&lt;br/&gt;
               &amp;lt;handler class=&quot;org.apache.james.smtpserver.dsn.DSNMessageHook&quot;/&amp;gt;&lt;br/&gt;
   ```&lt;/p&gt;

&lt;p&gt;   Not only does this contribution enables opt-in DSN support,&lt;/p&gt;

&lt;p&gt;   But also it makes it easier for contributors to write their own ESMTP extensions.&lt;/p&gt;


&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="17247038" author="btellier" created="Thu, 10 Dec 2020 06:06:10 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kotto&quot; class=&quot;user-hover&quot; rel=&quot;kotto&quot;&gt;kotto&lt;/a&gt; &lt;a href=&quot;https://github.com/linagora/james-project/pull/4110&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/linagora/james-project/pull/4110&lt;/a&gt; contributed migrating away from JMS Mail queue.&lt;/p&gt;

&lt;p&gt;I finally did not attempted to handle it for file mail queue as this is deprecated.&lt;/p&gt;</comment>
                            <comment id="17247685" author="githubbot" created="Fri, 11 Dec 2020 06:29:53 +0000"  >&lt;p&gt;chibenwa commented on a change in pull request #278:&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/james-project/pull/278#discussion_r540720313&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/james-project/pull/278#discussion_r540720313&lt;/a&gt;&lt;/p&gt;



&lt;p&gt;##########&lt;br/&gt;
File path: protocols/smtp/src/main/java/org/apache/james/protocols/smtp/hook/HeloHook.java&lt;br/&gt;
##########&lt;br/&gt;
@@ -19,12 +19,19 @@&lt;/p&gt;

&lt;p&gt; package org.apache.james.protocols.smtp.hook;&lt;/p&gt;

&lt;p&gt;+import java.util.Set;&lt;br/&gt;
+&lt;br/&gt;
 import org.apache.james.protocols.smtp.SMTPSession;&lt;/p&gt;

&lt;p&gt;+import com.google.common.collect.ImmutableSet;&lt;br/&gt;
+&lt;br/&gt;
 /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Implement this interfaces to hook in the HELO Command&lt;br/&gt;
  */&lt;br/&gt;
 public interface HeloHook extends Hook {&lt;br/&gt;
+    default Set&amp;lt;String&amp;gt; implementedEsmtpFeatures() 
{

Review comment:
       We need Java Doc here!

##########
File path: protocols/smtp/src/main/java/org/apache/james/protocols/smtp/hook/RcptHook.java
##########
@@ -51,4 +62,8 @@ default HookResult doRcpt(SMTPSession session, MaybeSender sender, MailAddress r
         return doRcpt(session, sender.asOptional().orElse(null), rcpt);
     }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;+    default HookResult doRcpt(SMTPSession session, MaybeSender sender, MailAddress rcpt, Map&amp;lt;String, String&amp;gt; parameters) {&lt;/p&gt;

&lt;p&gt;Review comment:&lt;br/&gt;
       We need Java doc here!&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="17248770" author="githubbot" created="Mon, 14 Dec 2020 07:16:55 +0000"  >&lt;p&gt;Arsnael commented on a change in pull request #278:&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/james-project/pull/278#discussion_r542106707&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/james-project/pull/278#discussion_r542106707&lt;/a&gt;&lt;/p&gt;



&lt;p&gt;##########&lt;br/&gt;
File path: protocols/smtp/src/main/java/org/apache/james/protocols/smtp/hook/HeloHook.java&lt;br/&gt;
##########&lt;br/&gt;
@@ -19,12 +19,19 @@&lt;/p&gt;

&lt;p&gt; package org.apache.james.protocols.smtp.hook;&lt;/p&gt;

&lt;p&gt;+import java.util.Set;&lt;br/&gt;
+&lt;br/&gt;
 import org.apache.james.protocols.smtp.SMTPSession;&lt;/p&gt;

&lt;p&gt;+import com.google.common.collect.ImmutableSet;&lt;br/&gt;
+&lt;br/&gt;
 /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Implement this interfaces to hook in the HELO Command&lt;br/&gt;
  */&lt;br/&gt;
 public interface HeloHook extends Hook {&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Review comment:&lt;br/&gt;
       Not your fault but I think there is a typo in this hook&apos;s name... should be `EhloHook`?&lt;/p&gt;

&lt;p&gt;##########&lt;br/&gt;
File path: server/protocols/protocols-smtp/src/main/java/org/apache/james/smtpserver/dsn/DSNMailParameterHook.java&lt;br/&gt;
##########&lt;br/&gt;
@@ -0,0 +1,63 @@&lt;br/&gt;
+/****************************************************************&lt;br/&gt;
+ * Licensed to the Apache Software Foundation (ASF) under one   *&lt;br/&gt;
+ * or more contributor license agreements.  See the NOTICE file *&lt;br/&gt;
+ * distributed with this work for additional information        *&lt;br/&gt;
+ * regarding copyright ownership.  The ASF licenses this file   *&lt;br/&gt;
+ * to you under the Apache License, Version 2.0 (the            *&lt;br/&gt;
+ * &quot;License&quot;); you may not use this file except in compliance   *&lt;br/&gt;
+ * with the License.  You may obtain a copy of the License at   *&lt;br/&gt;
+ *                                                              *&lt;br/&gt;
+ *   &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;                 *&lt;br/&gt;
+ *                                                              *&lt;br/&gt;
+ * Unless required by applicable law or agreed to in writing,   *&lt;br/&gt;
+ * software distributed under the License is distributed on an  *&lt;br/&gt;
+ * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY       *&lt;br/&gt;
+ * KIND, either express or implied.  See the License for the    *&lt;br/&gt;
+ * specific language governing permissions and limitations      *&lt;br/&gt;
+ * under the License.                                           *&lt;br/&gt;
+ ****************************************************************/&lt;br/&gt;
+&lt;br/&gt;
+package org.apache.james.smtpserver.dsn;&lt;br/&gt;
+&lt;br/&gt;
+import static org.apache.james.protocols.api.ProtocolSession.State.Transaction;&lt;br/&gt;
+import static org.apache.mailet.DsnParameters.ENVID_PARAMETER;&lt;br/&gt;
+import static org.apache.mailet.DsnParameters.RET_PARAMETER;&lt;br/&gt;
+&lt;br/&gt;
+import java.util.Optional;&lt;br/&gt;
+&lt;br/&gt;
+import org.apache.james.protocols.api.ProtocolSession;&lt;br/&gt;
+import org.apache.james.protocols.smtp.SMTPSession;&lt;br/&gt;
+import org.apache.james.protocols.smtp.hook.HookResult;&lt;br/&gt;
+import org.apache.james.protocols.smtp.hook.MailParametersHook;&lt;br/&gt;
+import org.apache.mailet.DsnParameters;&lt;br/&gt;
+import org.slf4j.Logger;&lt;br/&gt;
+import org.slf4j.LoggerFactory;&lt;br/&gt;
+&lt;br/&gt;
+public class DSNMailParameterHook implements MailParametersHook {&lt;br/&gt;
+    private static final Logger LOGGER = LoggerFactory.getLogger(DSNMailParameterHook.class);&lt;br/&gt;
+&lt;br/&gt;
+    public static final ProtocolSession.AttachmentKey&amp;lt;DsnParameters.Ret&amp;gt; DSN_RET = ProtocolSession.AttachmentKey.of(&quot;DSN_RET&quot;, DsnParameters.Ret.class);&lt;br/&gt;
+    public static final ProtocolSession.AttachmentKey&amp;lt;DsnParameters.EnvId&amp;gt; DSN_ENVID = ProtocolSession.AttachmentKey.of(&quot;DSN_ENVID&quot;, DsnParameters.EnvId.class);&lt;br/&gt;
+&lt;br/&gt;
+    @Override&lt;br/&gt;
+    public HookResult doMailParameter(SMTPSession session, String paramName, String paramValue) {&lt;br/&gt;
+        if (paramName.equals(RET_PARAMETER)) {&lt;br/&gt;
+            DsnParameters.Ret.parse(paramValue)&lt;br/&gt;
+                .or(() -&amp;gt; {&lt;br/&gt;
+                    LOGGER.debug(&quot;Invalid DSN RET value: {}&quot;, paramValue);&lt;br/&gt;
+                    return Optional.empty();&lt;br/&gt;
+                })&lt;br/&gt;
+                .ifPresent(ret -&amp;gt; session.setAttachment(DSN_RET, ret, Transaction));&lt;br/&gt;
+        }&lt;br/&gt;
+        if (paramName.equals(ENVID_PARAMETER)) &lt;/p&gt;
{
+            DsnParameters.EnvId envId = DsnParameters.EnvId.of(paramValue);
+            session.setAttachment(DSN_ENVID, envId, Transaction);
+        }
&lt;p&gt;+        return HookResult.DECLINED;&lt;/p&gt;

&lt;p&gt;Review comment:&lt;br/&gt;
       why always returning DECLINED status?&lt;/p&gt;

&lt;p&gt;##########&lt;br/&gt;
File path: server/protocols/protocols-smtp/src/main/java/org/apache/james/smtpserver/dsn/DSNHeloHook.java&lt;br/&gt;
##########&lt;br/&gt;
@@ -0,0 +1,40 @@&lt;br/&gt;
+/****************************************************************&lt;br/&gt;
+ * Licensed to the Apache Software Foundation (ASF) under one   *&lt;br/&gt;
+ * or more contributor license agreements.  See the NOTICE file *&lt;br/&gt;
+ * distributed with this work for additional information        *&lt;br/&gt;
+ * regarding copyright ownership.  The ASF licenses this file   *&lt;br/&gt;
+ * to you under the Apache License, Version 2.0 (the            *&lt;br/&gt;
+ * &quot;License&quot;); you may not use this file except in compliance   *&lt;br/&gt;
+ * with the License.  You may obtain a copy of the License at   *&lt;br/&gt;
+ *                                                              *&lt;br/&gt;
+ *   &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;                 *&lt;br/&gt;
+ *                                                              *&lt;br/&gt;
+ * Unless required by applicable law or agreed to in writing,   *&lt;br/&gt;
+ * software distributed under the License is distributed on an  *&lt;br/&gt;
+ * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY       *&lt;br/&gt;
+ * KIND, either express or implied.  See the License for the    *&lt;br/&gt;
+ * specific language governing permissions and limitations      *&lt;br/&gt;
+ * under the License.                                           *&lt;br/&gt;
+ ****************************************************************/&lt;br/&gt;
+&lt;br/&gt;
+package org.apache.james.smtpserver.dsn;&lt;br/&gt;
+&lt;br/&gt;
+import java.util.Set;&lt;br/&gt;
+&lt;br/&gt;
+import org.apache.james.protocols.smtp.SMTPSession;&lt;br/&gt;
+import org.apache.james.protocols.smtp.hook.HeloHook;&lt;br/&gt;
+import org.apache.james.protocols.smtp.hook.HookResult;&lt;br/&gt;
+&lt;br/&gt;
+import com.google.common.collect.ImmutableSet;&lt;br/&gt;
+&lt;br/&gt;
+public class DSNHeloHook implements HeloHook {&lt;/p&gt;

&lt;p&gt;Review comment:&lt;br/&gt;
       here too... Helo -&amp;gt; Ehlo ?&lt;/p&gt;

&lt;p&gt;##########&lt;br/&gt;
File path: server/protocols/protocols-smtp/src/test/java/org/apache/james/smtpserver/DSNTest.java&lt;br/&gt;
##########&lt;br/&gt;
@@ -0,0 +1,354 @@&lt;br/&gt;
+/****************************************************************&lt;br/&gt;
+ * Licensed to the Apache Software Foundation (ASF) under one   *&lt;br/&gt;
+ * or more contributor license agreements.  See the NOTICE file *&lt;br/&gt;
+ * distributed with this work for additional information        *&lt;br/&gt;
+ * regarding copyright ownership.  The ASF licenses this file   *&lt;br/&gt;
+ * to you under the Apache License, Version 2.0 (the            *&lt;br/&gt;
+ * &quot;License&quot;); you may not use this file except in compliance   *&lt;br/&gt;
+ * with the License.  You may obtain a copy of the License at   *&lt;br/&gt;
+ *                                                              *&lt;br/&gt;
+ *   &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;                 *&lt;br/&gt;
+ *                                                              *&lt;br/&gt;
+ * Unless required by applicable law or agreed to in writing,   *&lt;br/&gt;
+ * software distributed under the License is distributed on an  *&lt;br/&gt;
+ * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY       *&lt;br/&gt;
+ * KIND, either express or implied.  See the License for the    *&lt;br/&gt;
+ * specific language governing permissions and limitations      *&lt;br/&gt;
+ * under the License.                                           *&lt;br/&gt;
+ ****************************************************************/&lt;br/&gt;
+package org.apache.james.smtpserver;&lt;br/&gt;
+&lt;br/&gt;
+import static org.apache.mailet.DsnParameters.Notify.DELAY;&lt;br/&gt;
+import static org.apache.mailet.DsnParameters.Notify.FAILURE;&lt;br/&gt;
+import static org.apache.mailet.DsnParameters.Notify.SUCCESS;&lt;br/&gt;
+import static org.assertj.core.api.Assertions.assertThat;&lt;br/&gt;
+import static org.mockito.Mockito.mock;&lt;br/&gt;
+import static org.mockito.Mockito.when;&lt;br/&gt;
+&lt;br/&gt;
+import java.net.InetSocketAddress;&lt;br/&gt;
+import java.util.EnumSet;&lt;br/&gt;
+&lt;br/&gt;
+import org.apache.commons.configuration2.BaseHierarchicalConfiguration;&lt;br/&gt;
+import org.apache.commons.net.smtp.SMTPClient;&lt;br/&gt;
+import org.apache.james.core.Domain;&lt;br/&gt;
+import org.apache.james.core.MailAddress;&lt;br/&gt;
+import org.apache.james.dnsservice.api.DNSService;&lt;br/&gt;
+import org.apache.james.dnsservice.api.InMemoryDNSService;&lt;br/&gt;
+import org.apache.james.domainlist.api.DomainList;&lt;br/&gt;
+import org.apache.james.domainlist.memory.MemoryDomainList;&lt;br/&gt;
+import org.apache.james.filesystem.api.FileSystem;&lt;br/&gt;
+import org.apache.james.mailrepository.api.MailRepositoryStore;&lt;br/&gt;
+import org.apache.james.mailrepository.api.Protocol;&lt;br/&gt;
+import org.apache.james.mailrepository.memory.MailRepositoryStoreConfiguration;&lt;br/&gt;
+import org.apache.james.mailrepository.memory.MemoryMailRepository;&lt;br/&gt;
+import org.apache.james.mailrepository.memory.MemoryMailRepositoryStore;&lt;br/&gt;
+import org.apache.james.mailrepository.memory.MemoryMailRepositoryUrlStore;&lt;br/&gt;
+import org.apache.james.mailrepository.memory.SimpleMailRepositoryLoader;&lt;br/&gt;
+import org.apache.james.metrics.api.Metric;&lt;br/&gt;
+import org.apache.james.metrics.api.MetricFactory;&lt;br/&gt;
+import org.apache.james.metrics.tests.RecordingMetricFactory;&lt;br/&gt;
+import org.apache.james.protocols.api.utils.ProtocolServerUtils;&lt;br/&gt;
+import org.apache.james.protocols.lib.mock.MockProtocolHandlerLoader;&lt;br/&gt;
+import org.apache.james.queue.api.MailQueueFactory;&lt;br/&gt;
+import org.apache.james.queue.api.RawMailQueueItemDecoratorFactory;&lt;br/&gt;
+import org.apache.james.queue.memory.MemoryMailQueueFactory;&lt;br/&gt;
+import org.apache.james.rrt.api.AliasReverseResolver;&lt;br/&gt;
+import org.apache.james.rrt.api.CanSendFrom;&lt;br/&gt;
+import org.apache.james.rrt.api.RecipientRewriteTable;&lt;br/&gt;
+import org.apache.james.rrt.api.RecipientRewriteTableConfiguration;&lt;br/&gt;
+import org.apache.james.rrt.lib.AliasReverseResolverImpl;&lt;br/&gt;
+import org.apache.james.rrt.lib.CanSendFromImpl;&lt;br/&gt;
+import org.apache.james.rrt.memory.MemoryRecipientRewriteTable;&lt;br/&gt;
+import org.apache.james.server.core.configuration.Configuration;&lt;br/&gt;
+import org.apache.james.server.core.configuration.FileConfigurationProvider;&lt;br/&gt;
+import org.apache.james.server.core.filesystem.FileSystemImpl;&lt;br/&gt;
+import org.apache.james.smtpserver.netty.SMTPServer;&lt;br/&gt;
+import org.apache.james.smtpserver.netty.SmtpMetricsImpl;&lt;br/&gt;
+import org.apache.james.user.api.UsersRepository;&lt;br/&gt;
+import org.apache.james.user.memory.MemoryUsersRepository;&lt;br/&gt;
+import org.apache.mailet.DsnParameters;&lt;br/&gt;
+import org.apache.mailet.Mail;&lt;br/&gt;
+import org.assertj.core.api.SoftAssertions;&lt;br/&gt;
+import org.jboss.netty.util.HashedWheelTimer;&lt;br/&gt;
+import org.junit.After;&lt;br/&gt;
+import org.junit.Before;&lt;br/&gt;
+import org.junit.Test;&lt;br/&gt;
+&lt;br/&gt;
+import com.google.common.collect.ImmutableList;&lt;br/&gt;
+import com.google.inject.TypeLiteral;&lt;br/&gt;
+&lt;br/&gt;
+public class DSNTest {&lt;br/&gt;
+    public static final String LOCAL_DOMAIN = &quot;example.local&quot;;&lt;br/&gt;
+&lt;br/&gt;
+    protected HashedWheelTimer hashedWheelTimer;&lt;br/&gt;
+    protected MemoryDomainList domainList;&lt;br/&gt;
+    protected MemoryUsersRepository usersRepository;&lt;br/&gt;
+    protected SMTPServerTest.AlterableDNSServer dnsServer;&lt;br/&gt;
+    protected MemoryMailRepositoryStore mailRepositoryStore;&lt;br/&gt;
+    protected FileSystemImpl fileSystem;&lt;br/&gt;
+    protected Configuration configuration;&lt;br/&gt;
+    protected MockProtocolHandlerLoader chain;&lt;br/&gt;
+    protected MemoryMailQueueFactory queueFactory;&lt;br/&gt;
+    protected MemoryMailQueueFactory.MemoryCacheableMailQueue queue;&lt;br/&gt;
+&lt;br/&gt;
+    private SMTPServer smtpServer;&lt;br/&gt;
+&lt;br/&gt;
+    @Before&lt;br/&gt;
+    public void setUp() throws Exception {&lt;br/&gt;
+        domainList = new MemoryDomainList(new InMemoryDNSService()&lt;br/&gt;
+            .registerMxRecord(Domain.LOCALHOST.asString(), &quot;127.0.0.1&quot;)&lt;br/&gt;
+            .registerMxRecord(LOCAL_DOMAIN, &quot;127.0.0.1&quot;)&lt;br/&gt;
+            .registerMxRecord(&quot;examplebis.local&quot;, &quot;127.0.0.1&quot;)&lt;br/&gt;
+            .registerMxRecord(&quot;127.0.0.1&quot;, &quot;127.0.0.1&quot;));&lt;br/&gt;
+        domainList.setAutoDetect(false);&lt;br/&gt;
+        domainList.setAutoDetectIP(false);&lt;/p&gt;

&lt;p&gt;Review comment:&lt;br/&gt;
       &lt;a href=&quot;https://github.com/linagora/james-project/pull/4115&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/linagora/james-project/pull/4115&lt;/a&gt; just got merged, rebase using this syntax for DomainList&lt;/p&gt;

&lt;p&gt;##########&lt;br/&gt;
File path: server/protocols/protocols-smtp/src/test/java/org/apache/james/smtpserver/DSNTest.java&lt;br/&gt;
##########&lt;br/&gt;
@@ -79,6 +83,8 @@&lt;/p&gt;

&lt;p&gt; public class DSNTest {&lt;br/&gt;
     public static final String LOCAL_DOMAIN = &quot;example.local&quot;;&lt;br/&gt;
+    public static final Username BOB = Username.of(&quot;bob@localhost&quot;);&lt;/p&gt;

&lt;p&gt;Review comment:&lt;br/&gt;
       this commit title misses the ticket number&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="17248771" author="githubbot" created="Mon, 14 Dec 2020 07:21:20 +0000"  >&lt;p&gt;chibenwa commented on a change in pull request #278:&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/james-project/pull/278#discussion_r542161132&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/james-project/pull/278#discussion_r542161132&lt;/a&gt;&lt;/p&gt;



&lt;p&gt;##########&lt;br/&gt;
File path: protocols/smtp/src/main/java/org/apache/james/protocols/smtp/hook/HeloHook.java&lt;br/&gt;
##########&lt;br/&gt;
@@ -19,12 +19,19 @@&lt;/p&gt;

&lt;p&gt; package org.apache.james.protocols.smtp.hook;&lt;/p&gt;

&lt;p&gt;+import java.util.Set;&lt;br/&gt;
+&lt;br/&gt;
 import org.apache.james.protocols.smtp.SMTPSession;&lt;/p&gt;

&lt;p&gt;+import com.google.common.collect.ImmutableSet;&lt;br/&gt;
+&lt;br/&gt;
 /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Implement this interfaces to hook in the HELO Command&lt;br/&gt;
  */&lt;br/&gt;
 public interface HeloHook extends Hook {&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Review comment:&lt;br/&gt;
       I do not want to change that as it will cause breaking changes for SMTP hooks implementors.&lt;/p&gt;

&lt;p&gt;   But you are right, there is a typo.&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="17248772" author="githubbot" created="Mon, 14 Dec 2020 07:22:44 +0000"  >&lt;p&gt;chibenwa commented on a change in pull request #278:&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/james-project/pull/278#discussion_r542161675&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/james-project/pull/278#discussion_r542161675&lt;/a&gt;&lt;/p&gt;



&lt;p&gt;##########&lt;br/&gt;
File path: server/protocols/protocols-smtp/src/main/java/org/apache/james/smtpserver/dsn/DSNMailParameterHook.java&lt;br/&gt;
##########&lt;br/&gt;
@@ -0,0 +1,63 @@&lt;br/&gt;
+/****************************************************************&lt;br/&gt;
+ * Licensed to the Apache Software Foundation (ASF) under one   *&lt;br/&gt;
+ * or more contributor license agreements.  See the NOTICE file *&lt;br/&gt;
+ * distributed with this work for additional information        *&lt;br/&gt;
+ * regarding copyright ownership.  The ASF licenses this file   *&lt;br/&gt;
+ * to you under the Apache License, Version 2.0 (the            *&lt;br/&gt;
+ * &quot;License&quot;); you may not use this file except in compliance   *&lt;br/&gt;
+ * with the License.  You may obtain a copy of the License at   *&lt;br/&gt;
+ *                                                              *&lt;br/&gt;
+ *   &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;                 *&lt;br/&gt;
+ *                                                              *&lt;br/&gt;
+ * Unless required by applicable law or agreed to in writing,   *&lt;br/&gt;
+ * software distributed under the License is distributed on an  *&lt;br/&gt;
+ * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY       *&lt;br/&gt;
+ * KIND, either express or implied.  See the License for the    *&lt;br/&gt;
+ * specific language governing permissions and limitations      *&lt;br/&gt;
+ * under the License.                                           *&lt;br/&gt;
+ ****************************************************************/&lt;br/&gt;
+&lt;br/&gt;
+package org.apache.james.smtpserver.dsn;&lt;br/&gt;
+&lt;br/&gt;
+import static org.apache.james.protocols.api.ProtocolSession.State.Transaction;&lt;br/&gt;
+import static org.apache.mailet.DsnParameters.ENVID_PARAMETER;&lt;br/&gt;
+import static org.apache.mailet.DsnParameters.RET_PARAMETER;&lt;br/&gt;
+&lt;br/&gt;
+import java.util.Optional;&lt;br/&gt;
+&lt;br/&gt;
+import org.apache.james.protocols.api.ProtocolSession;&lt;br/&gt;
+import org.apache.james.protocols.smtp.SMTPSession;&lt;br/&gt;
+import org.apache.james.protocols.smtp.hook.HookResult;&lt;br/&gt;
+import org.apache.james.protocols.smtp.hook.MailParametersHook;&lt;br/&gt;
+import org.apache.mailet.DsnParameters;&lt;br/&gt;
+import org.slf4j.Logger;&lt;br/&gt;
+import org.slf4j.LoggerFactory;&lt;br/&gt;
+&lt;br/&gt;
+public class DSNMailParameterHook implements MailParametersHook {&lt;br/&gt;
+    private static final Logger LOGGER = LoggerFactory.getLogger(DSNMailParameterHook.class);&lt;br/&gt;
+&lt;br/&gt;
+    public static final ProtocolSession.AttachmentKey&amp;lt;DsnParameters.Ret&amp;gt; DSN_RET = ProtocolSession.AttachmentKey.of(&quot;DSN_RET&quot;, DsnParameters.Ret.class);&lt;br/&gt;
+    public static final ProtocolSession.AttachmentKey&amp;lt;DsnParameters.EnvId&amp;gt; DSN_ENVID = ProtocolSession.AttachmentKey.of(&quot;DSN_ENVID&quot;, DsnParameters.EnvId.class);&lt;br/&gt;
+&lt;br/&gt;
+    @Override&lt;br/&gt;
+    public HookResult doMailParameter(SMTPSession session, String paramName, String paramValue) {&lt;br/&gt;
+        if (paramName.equals(RET_PARAMETER)) {&lt;br/&gt;
+            DsnParameters.Ret.parse(paramValue)&lt;br/&gt;
+                .or(() -&amp;gt; {&lt;br/&gt;
+                    LOGGER.debug(&quot;Invalid DSN RET value: {}&quot;, paramValue);&lt;br/&gt;
+                    return Optional.empty();&lt;br/&gt;
+                })&lt;br/&gt;
+                .ifPresent(ret -&amp;gt; session.setAttachment(DSN_RET, ret, Transaction));&lt;br/&gt;
+        }&lt;br/&gt;
+        if (paramName.equals(ENVID_PARAMETER)) &lt;/p&gt;
{
+            DsnParameters.EnvId envId = DsnParameters.EnvId.of(paramValue);
+            session.setAttachment(DSN_ENVID, envId, Transaction);
+        }
&lt;p&gt;+        return HookResult.DECLINED;&lt;/p&gt;

&lt;p&gt;Review comment:&lt;br/&gt;
       Declined = I&apos;m not taking decisions on whether the hooks should accept or reject the command. &lt;/p&gt;

&lt;p&gt;   I agree the naming is ambiguous here (but same thing I want to limit breaking changes in this part of the code!)&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="17248773" author="githubbot" created="Mon, 14 Dec 2020 07:23:00 +0000"  >&lt;p&gt;chibenwa commented on a change in pull request #278:&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/james-project/pull/278#discussion_r542161780&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/james-project/pull/278#discussion_r542161780&lt;/a&gt;&lt;/p&gt;



&lt;p&gt;##########&lt;br/&gt;
File path: server/protocols/protocols-smtp/src/main/java/org/apache/james/smtpserver/dsn/DSNHeloHook.java&lt;br/&gt;
##########&lt;br/&gt;
@@ -0,0 +1,40 @@&lt;br/&gt;
+/****************************************************************&lt;br/&gt;
+ * Licensed to the Apache Software Foundation (ASF) under one   *&lt;br/&gt;
+ * or more contributor license agreements.  See the NOTICE file *&lt;br/&gt;
+ * distributed with this work for additional information        *&lt;br/&gt;
+ * regarding copyright ownership.  The ASF licenses this file   *&lt;br/&gt;
+ * to you under the Apache License, Version 2.0 (the            *&lt;br/&gt;
+ * &quot;License&quot;); you may not use this file except in compliance   *&lt;br/&gt;
+ * with the License.  You may obtain a copy of the License at   *&lt;br/&gt;
+ *                                                              *&lt;br/&gt;
+ *   &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;                 *&lt;br/&gt;
+ *                                                              *&lt;br/&gt;
+ * Unless required by applicable law or agreed to in writing,   *&lt;br/&gt;
+ * software distributed under the License is distributed on an  *&lt;br/&gt;
+ * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY       *&lt;br/&gt;
+ * KIND, either express or implied.  See the License for the    *&lt;br/&gt;
+ * specific language governing permissions and limitations      *&lt;br/&gt;
+ * under the License.                                           *&lt;br/&gt;
+ ****************************************************************/&lt;br/&gt;
+&lt;br/&gt;
+package org.apache.james.smtpserver.dsn;&lt;br/&gt;
+&lt;br/&gt;
+import java.util.Set;&lt;br/&gt;
+&lt;br/&gt;
+import org.apache.james.protocols.smtp.SMTPSession;&lt;br/&gt;
+import org.apache.james.protocols.smtp.hook.HeloHook;&lt;br/&gt;
+import org.apache.james.protocols.smtp.hook.HookResult;&lt;br/&gt;
+&lt;br/&gt;
+import com.google.common.collect.ImmutableSet;&lt;br/&gt;
+&lt;br/&gt;
+public class DSNHeloHook implements HeloHook {&lt;/p&gt;

&lt;p&gt;Review comment:&lt;br/&gt;
       :+1:  to change this one.&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="17250138" author="githubbot" created="Wed, 16 Dec 2020 07:04:31 +0000"  >&lt;p&gt;chibenwa closed pull request #278:&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/james-project/pull/278&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/james-project/pull/278&lt;/a&gt;&lt;/p&gt;





&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="17250139" author="githubbot" created="Wed, 16 Dec 2020 07:04:35 +0000"  >&lt;p&gt;chibenwa commented on pull request #278:&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/james-project/pull/278#issuecomment-745810897&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/james-project/pull/278#issuecomment-745810897&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Merged&lt;/p&gt;


&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="17250207" author="btellier" created="Wed, 16 Dec 2020 09:36:01 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/linagora/james-project/pull/4144&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/linagora/james-project/pull/4144&lt;/a&gt; provides DSNFailureRequested, DSNSuccessRequested and DNSDelayRequested, allowing to write conditions for DSN handling within mailetcontainer.xml&lt;/p&gt;</comment>
                            <comment id="17250795" author="btellier" created="Thu, 17 Dec 2020 04:13:52 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/linagora/james-project/pull/4145&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/linagora/james-project/pull/4145&lt;/a&gt; did modify DSNBounce to make it spec compliant with RFC-3464, as well allow its use for other actions than &quot;failed&quot;&lt;/p&gt;

&lt;p&gt;It should :&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Take into account EnvId DSN parameter positioned by the client&lt;/li&gt;
	&lt;li&gt;Take into account RET DSN parameter positioned by the client&lt;/li&gt;
	&lt;li&gt;Allow customizing the action&lt;/li&gt;
	&lt;li&gt;Allow a default status code rather than aggressively defaulting to unknown&lt;/li&gt;
	&lt;li&gt;Add original subject in the human readable message to ease reading&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17253899" author="btellier" created="Wed, 23 Dec 2020 05:46:28 +0000"  >&lt;p&gt;Following our work on this topic, we need the tools totest how RemoteDelivery behaves in the face of DSN parameters. Do we correctly relay DSN parameters to remote server?&lt;/p&gt;

&lt;p&gt;In order to achieve that we need MockSMTP server to capture ESMTP parameters. To do so, we both need to modify it&apos;s underlying data model as well as its SMTP layers.&lt;/p&gt;

&lt;p&gt;Working with the Mock SMTP docker image I found out the following issues:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The use of untagged docker image (latest) causes current code to be brittle in face of MockSMTP server changes. We should use fix, immutable versions here. &lt;a href=&quot;https://github.com/linagora/james-project/pull/4161&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/linagora/james-project/pull/4161&lt;/a&gt; contributes this.&lt;/li&gt;
	&lt;li&gt;The code is compiled to a JDK target version 11 but we tried to run it against a JDK 8. We need to upgrade the base image used to run MockSmtpServer to rely on JDK 11.&lt;/li&gt;
	&lt;li&gt;Adding a &quot;version&quot; endpoints enables tests to clearly assert that they are working against the right API, regardless of the image.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The two later points are contributed as part of &lt;a href=&quot;https://github.com/linagora/james-project/pull/4162&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/linagora/james-project/pull/4162&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/linagora/james-project/pull/4162&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/linagora/james-project/pull/4162&lt;/a&gt; contributed parameter storage as part of the mail envelopes of email received by the mock SMTP server. The intent here is to be generic, and be able to have a generic tool to test how RemoteDelivery behaves in the face of ESMTP extensions. The format on the REST API of the MockSMTPServer (to access the emails that were received) did lead to breaking change, though they are abstracted away by the client used to work with this API (that did change too)&lt;/p&gt;

&lt;p&gt;Upcoming work includes a rewrite of the SMTP layers of the mock SMTP server in order to:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Advertise the DSN ESMTP extension upon EHLO&lt;/li&gt;
	&lt;li&gt;Capture Mail FROM and Rcpt TO ESMTP parameters and store them.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17254021" author="btellier" created="Wed, 23 Dec 2020 10:46:59 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/linagora/james-project/pull/4164&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/linagora/james-project/pull/4164&lt;/a&gt; Advertise the DSN ESMTP extension upon EHLO (Mock SMTP server)&lt;/p&gt;

&lt;p&gt;We need to add configurable advertised extensions, so to add a REST API, memory storage, and Feign client wiring. We need to rewrite the EHLO cmd handler of the mock smtp server.&lt;/p&gt;</comment>
                            <comment id="17255456" author="rcordier" created="Mon, 28 Dec 2020 07:48:36 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/linagora/james-project/pull/4161&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/linagora/james-project/pull/4161&lt;/a&gt; fixes a docker version for MockSMTPServer&lt;/p&gt;</comment>
                            <comment id="17255809" author="btellier" created="Tue, 29 Dec 2020 04:51:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/linagora/james-project/pull/4181&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/linagora/james-project/pull/4181&lt;/a&gt; carries over DSN options to remote SMTP servers relying on javax.mail SMTP server.&lt;/p&gt;

&lt;p&gt;Integration tests had been written using the Mock SMTP server previously modified.&lt;/p&gt;

&lt;p&gt;Please note that the current work suffer from the following flows, that are limitations induces by the use of javax.mail:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;No ORCPT support. This RCPT DSN parameter will be omitted on exchanges with remote SMTP servers. The impact is likely low: the value matches the RCPT TO, even in the case of mailing list rewrites. Maybe it is of some uses in the advent of aliases, for the sender MUA to display the actual user this mail was sent to.&lt;/li&gt;
	&lt;li&gt;As NOTIFY parameter is set on a per-SMTPMessage basis, we have to transmit several time the message (one time for each combinasons of NOTIFY parameters used for recipients of the message - recipients with the same notify parameters can be grouped together). The impact is low: it incurs a small performance cost. Also, I would be surprised MUAs set per-recipients values on sent emails and not global values.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;We now remain to write the integration tests listed above.&lt;/p&gt;</comment>
                            <comment id="17255914" author="btellier" created="Tue, 29 Dec 2020 10:25:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/linagora/james-project/pull/4183&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/linagora/james-project/pull/4183&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/JAMES-3431&quot; title=&quot;Relay DSN options on RemoteDelivery&quot; class=&quot;issue-link&quot; data-issue-key=&quot;JAMES-3431&quot;&gt;&lt;del&gt;JAMES-3431&lt;/del&gt;&lt;/a&gt; Document DSN setup for the Distributed Server&lt;/p&gt;

&lt;p&gt;We still need to validate this draft on a real system, but it provides insight about adaptations that should be made to the configuration to support the DSN bounce ESMTP extension.&lt;/p&gt;</comment>
                            <comment id="17256262" author="rcordier" created="Wed, 30 Dec 2020 03:43:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/linagora/james-project/pull/4162&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/linagora/james-project/pull/4162&lt;/a&gt; Mock SMTP server ReceivedMailRepository keep ESMTP parameters as part of the envelope&lt;br/&gt;
&lt;a href=&quot;https://github.com/linagora/james-project/pull/4164&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/linagora/james-project/pull/4164&lt;/a&gt; MockSMTPServer: Allow advertising extra extensions upon EHLO&lt;br/&gt;
&lt;a href=&quot;https://github.com/linagora/james-project/pull/4165&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/linagora/james-project/pull/4165&lt;/a&gt; MockSMTPServer: Capture MAIL FROM &amp;amp; RCPT TO ESMTP parameters&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/linagora/james-project/pull/4181&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/linagora/james-project/pull/4181&lt;/a&gt; RemoteDelivery: should cary over DSN parameters&lt;/p&gt;</comment>
                            <comment id="17258655" author="rcordier" created="Tue, 5 Jan 2021 04:59:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/linagora/james-project/pull/4185&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/linagora/james-project/pull/4185&lt;/a&gt; RRT processor needs to modify DSN parameters&lt;/p&gt;</comment>
                            <comment id="17260210" author="rcordier" created="Thu, 7 Jan 2021 04:09:25 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/linagora/james-project/pull/4198&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/linagora/james-project/pull/4198&lt;/a&gt; fix some exception variables names&lt;/p&gt;</comment>
                            <comment id="17285634" author="githubbot" created="Wed, 17 Feb 2021 05:21:10 +0000"  >&lt;p&gt;chibenwa opened a new pull request #299:&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/james-project/pull/299&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/james-project/pull/299&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Otto, Karsten Andreas reported the following issues so far regarding DSN&lt;/p&gt;

&lt;p&gt;   ```&lt;br/&gt;
    1. When I send a mail to an unknown user, the DSN report (part 1) has no text after &quot;Error message:&quot;. There is a comment in the mail MailDispatcher class that might explain it?&lt;br/&gt;
       // In order for this server to meet the requirements of the SMTP&lt;br/&gt;
       // specification, mails on the ERROR processor must be returned to&lt;br/&gt;
       // the sender. Note that this email doesn&apos;t include any details&lt;br/&gt;
       // regarding the details of the failure(s).&lt;br/&gt;
       // In the future we may wish to address this.&lt;br/&gt;
       Anyways, this is no big issue for us, as we can describe the problem in the &amp;lt;messageString&amp;gt;. But the empty text is confusing, I thought it to be a bug at first.&lt;br/&gt;
       =&amp;gt; Please change the report generation to just hide the &quot;Error message:&quot; part if there is no error message to report.&lt;/p&gt;

&lt;p&gt;    2. I see a strange date format in the DSN report (part 2), e.g.&lt;br/&gt;
       Last-Attempt-Date: Mon, 15 Feb 2021 15:45:20 XXXXX (CET)&lt;br/&gt;
       According to rfc3464#section-2.3.7 this header must use the numeric timezone format (+hh:mm/-hh:mm). Does the XXXXX serve any special purpose?&lt;br/&gt;
       =&amp;gt; Please fix this date format here to comply with the RFC.&lt;/p&gt;

&lt;p&gt;    3. We would also like to have the Arrival-Date (rfc3464#section-2.2.5) header in the DSN report (part 2) as well. In the past I found it a useful diagnostic in conjunction with Last-Attempt-Date, especially with delayed delivery cases. Does James per chance already record the timestamp on each incoming mail?&lt;br/&gt;
       =&amp;gt; Please add the Arrival-Date header to the DSN report. Record the necessary timestamp on mail arrival if James does not have this data already. &lt;br/&gt;
   ```&lt;/p&gt;


&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="17285692" author="githubbot" created="Wed, 17 Feb 2021 07:45:23 +0000"  >&lt;p&gt;Arsnael commented on a change in pull request #299:&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/james-project/pull/299#discussion_r577386789&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/james-project/pull/299#discussion_r577386789&lt;/a&gt;&lt;/p&gt;



&lt;p&gt;##########&lt;br/&gt;
File path: server/mailet/mailets/src/test/java/org/apache/james/transport/mailets/DSNBounceTest.java&lt;br/&gt;
##########&lt;br/&gt;
@@ -1276,6 +1279,50 @@ void envIdShouldBePositioned() throws Exception &lt;/p&gt;
{
         assertThat(IOUtils.toString(actualContent, StandardCharsets.UTF_8)).isEqualTo(expectedContent);
     }

&lt;p&gt;+    @Test&lt;br/&gt;
+    void ArrivalDateShouldBePositioned() throws Exception {&lt;/p&gt;

&lt;p&gt;Review comment:&lt;br/&gt;
       `arrivalDateShouldBePositioned`&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="27270">JAMES-322</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="31324">JAMES-362</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 38 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0jug8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>