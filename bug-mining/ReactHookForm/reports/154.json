{"url":"https://api.github.com/repos/react-hook-form/react-hook-form/issues/2667","repository_url":"https://api.github.com/repos/react-hook-form/react-hook-form","labels_url":"https://api.github.com/repos/react-hook-form/react-hook-form/issues/2667/labels{/name}","comments_url":"https://api.github.com/repos/react-hook-form/react-hook-form/issues/2667/comments","events_url":"https://api.github.com/repos/react-hook-form/react-hook-form/issues/2667/events","html_url":"https://github.com/react-hook-form/react-hook-form/issues/2667","id":683351804,"node_id":"MDU6SXNzdWU2ODMzNTE4MDQ=","number":2667,"title":"form.reset method call produces memory leak","user":{"login":"maxsbelt","id":950216,"node_id":"MDQ6VXNlcjk1MDIxNg==","avatar_url":"https://avatars.githubusercontent.com/u/950216?v=4","gravatar_id":"","url":"https://api.github.com/users/maxsbelt","html_url":"https://github.com/maxsbelt","followers_url":"https://api.github.com/users/maxsbelt/followers","following_url":"https://api.github.com/users/maxsbelt/following{/other_user}","gists_url":"https://api.github.com/users/maxsbelt/gists{/gist_id}","starred_url":"https://api.github.com/users/maxsbelt/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maxsbelt/subscriptions","organizations_url":"https://api.github.com/users/maxsbelt/orgs","repos_url":"https://api.github.com/users/maxsbelt/repos","events_url":"https://api.github.com/users/maxsbelt/events{/privacy}","received_events_url":"https://api.github.com/users/maxsbelt/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1260145696,"node_id":"MDU6TGFiZWwxMjYwMTQ1Njk2","url":"https://api.github.com/repos/react-hook-form/react-hook-form/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"}],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2020-08-21T07:08:47Z","updated_at":"2022-10-10T18:05:06Z","closed_at":"2020-08-21T07:58:36Z","author_association":"NONE","type":null,"active_lock_reason":"resolved","sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Describe the bug**\r\nI have a form that creates entity with 35 fields (some of them are conditional). I added next code to add ability to edit entity:\r\n\r\n```js\r\nconst Form = ({ entityFromProp }) => {\r\n  const { reset } = useForm();\r\n  ...\r\n  React.useEffect(() => {\r\n    if (entityFromProp) reset(entityFromProp)\r\n    else reset({})\r\n  }, [entityFromProp])\r\n  ...\r\n  // render form\r\n}\r\n```\r\n\r\nAnd after couple of `reset` calls I noticed significant performance issue (browser window hangs for some time). I think the root of the problem is [`MutationObserver` usage](https://github.com/react-hook-form/react-hook-form/blob/90d03bc/src/utils/onDomRemove.ts#L8-L20). Seems like `form.reset` call creates new observers but does not disconnect old ones.\r\n\r\nI think it makes sense to create only one `MutationObserver` instance at all or at least per `useForm` hook to reduce unnecessary browser work even if the leak itself will be fixed. \r\n\r\n**To Reproduce**\r\nSteps to reproduce the behavior (I can show problem only in local environment because it requires some small source code tweaks):\r\n\r\n1. Bootstrap `create-react-app` project and add `react-hook-form` dependency.\r\n2. Update `App.js`\r\n```js\r\nimport React from 'react';\r\nimport { useForm } from 'react-hook-form';\r\n\r\nconst App = () => {\r\n  const [index, setIndex] = React.useState(0);\r\n  const { register, reset, handleSubmit } = useForm();\r\n  const submit = () => {\r\n    reset({});\r\n  }\r\n  return (\r\n    <>\r\n      <button onClick={() => setIndex(i => i + 1)}>1 / 2 fields</button>\r\n      <br />\r\n      <form onSubmit={handleSubmit(submit)}>\r\n        <input ref={register} name='test' />\r\n        {index % 2 === 0 && <input ref={register} name='test' />}\r\n        <button>Reset</button>\r\n      </form>\r\n    </>\r\n  );\r\n}\r\n\r\nexport default App;\r\n\r\n```\r\n3. Go to `/node_modules/react-hook-form/dist/index.esm.js` and update `onDomRemove` method declaration (changes are highlighted in screenshot):\r\n\r\n<img width=\"697\" alt=\"Screenshot 2020-08-21 at 03 29 25\" src=\"https://user-images.githubusercontent.com/950216/90862463-2004b380-e396-11ea-9fb2-3fa45aa20a01.png\">\r\n\r\n\r\n```js\r\nsetInterval(() => {\r\n    console.log(observers.size);\r\n}, 1000);\r\n\r\nconst observers = new Set();\r\nfunction onDomRemove(element, onDetachCallback) {\r\n    const observer = new MutationObserver(() => {\r\n        if (isDetached(element)) {\r\n            observers.delete(observer);\r\n            observer.disconnect();\r\n            onDetachCallback();\r\n        }\r\n    });\r\n    observers.add(observer);\r\n    observer.observe(window.document, {\r\n        childList: true,\r\n        subtree: true,\r\n    });\r\n    return {\r\n        ...observer,\r\n        disconnect: () => {\r\n            observers.delete(observer);\r\n            observer.disconnect()\r\n        }\r\n    };\r\n}\r\n```\r\n4. Run project and click on `Reset` button\r\n5. Open browser console and observe that counter of active (not disconnected) observers increases:\r\n![condition](https://user-images.githubusercontent.com/950216/90862193-bdabb300-e395-11ea-85e4-d70429e25a33.gif)\r\n\r\n**Expected behavior**\r\nCount of active observers should be equal to count of the fields on the screen.\r\n\r\n**Codesandbox link (Required)**\r\nInclude a codesandbox will help us to investigate the issue quicker.\r\n\r\nhttps://codesandbox.io/s/react-hook-form-useform-template-forked-kl26f\r\n\r\n","closed_by":{"login":"bluebill1049","id":10513364,"node_id":"MDQ6VXNlcjEwNTEzMzY0","avatar_url":"https://avatars.githubusercontent.com/u/10513364?v=4","gravatar_id":"","url":"https://api.github.com/users/bluebill1049","html_url":"https://github.com/bluebill1049","followers_url":"https://api.github.com/users/bluebill1049/followers","following_url":"https://api.github.com/users/bluebill1049/following{/other_user}","gists_url":"https://api.github.com/users/bluebill1049/gists{/gist_id}","starred_url":"https://api.github.com/users/bluebill1049/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bluebill1049/subscriptions","organizations_url":"https://api.github.com/users/bluebill1049/orgs","repos_url":"https://api.github.com/users/bluebill1049/repos","events_url":"https://api.github.com/users/bluebill1049/events{/privacy}","received_events_url":"https://api.github.com/users/bluebill1049/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/react-hook-form/react-hook-form/issues/2667/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/react-hook-form/react-hook-form/issues/2667/timeline","performed_via_github_app":null,"state_reason":"completed"}