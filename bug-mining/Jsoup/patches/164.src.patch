diff --git a/CHANGES b/CHANGES
index bf86a22e..71488fb9 100644
--- a/CHANGES
+++ b/CHANGES
@@ -1,6 +1,10 @@
 jsoup changelog
 
-*** Release 1.11.1 [PENDING]
+*** Release 1.11.2 [PENDING]
+  * Fixed an issue where in a deep DOM stack, a StackOverFlow exception could occur when generating implied end tags.
+    <https://github.com/jhy/jsoup/issues/966>
+
+*** Release 1.11.1 [2017-Nov-06]
   * Updated language level to Java 7 from Java 5. To maintain Android support (of minversion 8), try-with-resources are
     not used.
     <https://github.com/jhy/jsoup/issues/899>
diff --git a/src/main/java/org/jsoup/parser/HtmlTreeBuilder.java b/src/main/java/org/jsoup/parser/HtmlTreeBuilder.java
index 8eb3904c..b8cc1f03 100644
--- a/src/main/java/org/jsoup/parser/HtmlTreeBuilder.java
+++ b/src/main/java/org/jsoup/parser/HtmlTreeBuilder.java
@@ -464,13 +464,13 @@ public class HtmlTreeBuilder extends TreeBuilder {
     }
 
     private boolean inSpecificScope(String[] targetNames, String[] baseTypes, String[] extraTypes) {
-        int depth = stack.size() -1;
-        if (depth > MaxScopeSearchDepth) {
-            depth = MaxScopeSearchDepth;
-        }
-        for (int pos = depth; pos >= 0; pos--) {
-            Element el = stack.get(pos);
-            String elName = el.nodeName();
+        // https://html.spec.whatwg.org/multipage/parsing.html#has-an-element-in-the-specific-scope
+        final int bottom = stack.size() -1;
+        final int top = bottom > MaxScopeSearchDepth ? bottom - MaxScopeSearchDepth : 0;
+        // don't walk too far up the tree
+
+        for (int pos = bottom; pos >= top; pos--) {
+            final String elName = stack.get(pos).nodeName();
             if (inSorted(elName, targetNames))
                 return true;
             if (inSorted(elName, baseTypes))
@@ -478,7 +478,7 @@ public class HtmlTreeBuilder extends TreeBuilder {
             if (extraTypes != null && inSorted(elName, extraTypes))
                 return false;
         }
-        Validate.fail("Should not be reachable");
+        //Validate.fail("Should not be reachable"); // would end up false because hitting 'html' at root (basetypes)
         return false;
     }
 
diff --git a/src/test/java/org/jsoup/integration/UrlConnectTest.java b/src/test/java/org/jsoup/integration/UrlConnectTest.java
index 02e97ad3..6a4a20fb 100644
--- a/src/test/java/org/jsoup/integration/UrlConnectTest.java
+++ b/src/test/java/org/jsoup/integration/UrlConnectTest.java
@@ -658,4 +658,13 @@ public class UrlConnectTest {
         assertTrue(System.currentTimeMillis() - start < 1000);
     }
 
+    @Test public void handles966() throws IOException {
+        // http://szshb.nxszs.gov.cn/
+        // https://github.com/jhy/jsoup/issues/966
+
+        Document doc = Jsoup.connect("http://szshb.nxszs.gov.cn/").get();
+
+        assertEquals("石嘴山市环境保护局", doc.title());
+    }
+
 }
diff --git a/src/test/java/org/jsoup/parser/HtmlParserTest.java b/src/test/java/org/jsoup/parser/HtmlParserTest.java
index afd2ee27..d7d7bd85 100644
--- a/src/test/java/org/jsoup/parser/HtmlParserTest.java
+++ b/src/test/java/org/jsoup/parser/HtmlParserTest.java
@@ -1068,4 +1068,17 @@ public class HtmlParserTest {
             assertTrue(template.childNodes().size() > 1);
         }
   }
+
+  @Test public void testHandlesDeepSpans() {
+        StringBuilder sb = new StringBuilder();
+        for (int i = 0; i < 200; i++) {
+            sb.append("<span>");
+        }
+
+        sb.append("<p>One</p>");
+
+        Document doc = Jsoup.parse(sb.toString());
+        assertEquals(200, doc.select("span").size());
+        assertEquals(1, doc.select("p").size());
+  }
 }
