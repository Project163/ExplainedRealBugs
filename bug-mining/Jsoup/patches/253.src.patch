diff --git a/src/main/java/org/jsoup/parser/XmlTreeBuilder.java b/src/main/java/org/jsoup/parser/XmlTreeBuilder.java
index 1c49f146..5fad99e2 100644
--- a/src/main/java/org/jsoup/parser/XmlTreeBuilder.java
+++ b/src/main/java/org/jsoup/parser/XmlTreeBuilder.java
@@ -130,10 +130,14 @@ public class XmlTreeBuilder extends TreeBuilder {
      * @param endTag tag to close
      */
     private void popStackToClose(Token.EndTag endTag) {
+        // like in HtmlTreeBuilder - don't scan up forever for very (artificially) deeply nested stacks
         String elName = settings.normalizeTag(endTag.tagName);
         Element firstFound = null;
 
-        for (int pos = stack.size() -1; pos >= 0; pos--) {
+        final int bottom = stack.size() - 1;
+        final int upper = bottom >= maxQueueDepth ? bottom - maxQueueDepth : 0;
+
+        for (int pos = stack.size() -1; pos >= upper; pos--) {
             Element next = stack.get(pos);
             if (next.nodeName().equals(elName)) {
                 firstFound = next;
@@ -150,6 +154,8 @@ public class XmlTreeBuilder extends TreeBuilder {
                 break;
         }
     }
+    private static final int maxQueueDepth = 256; // an arbitrary tension point between real XML and crafted pain
+
 
 
     List<Node> parseFragment(String inputFragment, String baseUri, Parser parser) {
diff --git a/src/test/resources/fuzztests/1640.html.gz b/src/test/resources/fuzztests/1640.html.gz
new file mode 100644
index 00000000..a9ce0f64
Binary files /dev/null and b/src/test/resources/fuzztests/1640.html.gz differ
