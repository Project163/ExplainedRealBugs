diff --git a/src/main/java/org/jsoup/parser/HtmlTreeBuilderState.java b/src/main/java/org/jsoup/parser/HtmlTreeBuilderState.java
index 516782b9..0bf75382 100644
--- a/src/main/java/org/jsoup/parser/HtmlTreeBuilderState.java
+++ b/src/main/java/org/jsoup/parser/HtmlTreeBuilderState.java
@@ -1547,7 +1547,9 @@ enum HtmlTreeBuilderState {
                     tb.clearFormattingElementsToLastMarker();
                     tb.popTemplateMode();
                     tb.resetInsertionMode();
-                    if (tb.state() != InTemplate) // spec deviation - if we did not break out of Template, stop processing
+                    // spec deviation - if we did not break out of Template, stop processing, and don't worry about cleaning up ultra-deep template stacks
+                    // limited depth because this can recurse and will blow stack if too deep
+                    if (tb.state() != InTemplate && tb.templateModeSize() < 12)
                         return tb.process(t);
                     else return true;
             }
diff --git a/src/test/resources/fuzztests/39164.html b/src/test/resources/fuzztests/39164.html
new file mode 100644
index 00000000..10899556
Binary files /dev/null and b/src/test/resources/fuzztests/39164.html differ
