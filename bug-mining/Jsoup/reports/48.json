{"url":"https://api.github.com/repos/jhy/jsoup/issues/156","repository_url":"https://api.github.com/repos/jhy/jsoup","labels_url":"https://api.github.com/repos/jhy/jsoup/issues/156/labels{/name}","comments_url":"https://api.github.com/repos/jhy/jsoup/issues/156/comments","events_url":"https://api.github.com/repos/jhy/jsoup/issues/156/events","html_url":"https://github.com/jhy/jsoup/issues/156","id":2527326,"node_id":"MDU6SXNzdWUyNTI3MzI2","number":156,"title":"bug with :all pseudo tag in WhiteList.isSafeAttribute","user":{"login":"tonig","id":1258357,"node_id":"MDQ6VXNlcjEyNTgzNTc=","avatar_url":"https://avatars.githubusercontent.com/u/1258357?v=4","gravatar_id":"","url":"https://api.github.com/users/tonig","html_url":"https://github.com/tonig","followers_url":"https://api.github.com/users/tonig/followers","following_url":"https://api.github.com/users/tonig/following{/other_user}","gists_url":"https://api.github.com/users/tonig/gists{/gist_id}","starred_url":"https://api.github.com/users/tonig/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tonig/subscriptions","organizations_url":"https://api.github.com/users/tonig/orgs","repos_url":"https://api.github.com/users/tonig/repos","events_url":"https://api.github.com/users/tonig/events{/privacy}","received_events_url":"https://api.github.com/users/tonig/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2011-12-12T19:28:13Z","updated_at":"2012-05-06T07:51:15Z","closed_at":"2012-05-06T07:51:15Z","author_association":"NONE","active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"At line 297:\n\n```\nboolean isSafeAttribute(String tagName, Element el, Attribute attr) {\n    TagName tag = TagName.valueOf(tagName);\n    AttributeKey key = AttributeKey.valueOf(attr.getKey());\n\n    if (attributes.containsKey(tag)) {\n        if (attributes.get(tag).contains(key)) {\n            if (protocols.containsKey(tag)) {\n                Map<AttributeKey, Set<Protocol>> attrProts = protocols.get(tag);\n                // ok if not defined protocol; otherwise test\n                return !attrProts.containsKey(key) || testValidProtocol(el, attr, attrProts.get(key));\n            } else { // attribute found, no protocols defined, so OK\n                return true;\n            }\n        }\n    } else { // no attributes defined for tag, try :all tag\n        return !tagName.equals(\":all\") && isSafeAttribute(\":all\", el, attr);\n    }\n    return false;\n}\n```\n\nmust be:\n\n```\nboolean isSafeAttribute(String tagName, Element el, Attribute attr) {\n    TagName tag = TagName.valueOf(tagName);\n    AttributeKey key = AttributeKey.valueOf(attr.getKey());\n\n    if (attributes.containsKey(tag)) {\n        if (attributes.get(tag).contains(key)) {\n            if (protocols.containsKey(tag)) {\n                Map<AttributeKey, Set<Protocol>> attrProts = protocols.get(tag);\n                // ok if not defined protocol; otherwise test\n                return !attrProts.containsKey(key) || testValidProtocol(el, attr, attrProts.get(key));\n            } else { // attribute found, no protocols defined, so OK\n                return true;\n            }\n        }\n    }\n    return !tagName.equals(\":all\") && isSafeAttribute(\":all\", el, attr);\n}\n```\n\nOtherwise, only tags with no attributes defined have default :all attributes applied.\nU can use this code for testing, where \"class\" is preserved in div, but not in table.\n        String unsafe = \n              \"<p><a href='http://example.com/' onclick='stealCookies()'>Link</a></p>\" +\n              \"<div class=\\\"test\\\" style=\\\"background:red\\\">oleadmin</div>\" +\n              \"<table class=\\\"tipusTaula1\\\"><th></th><tr><td>hell world</td></tr></table>\";\n        Whitelist whitelist = Whitelist.basic();\n        whitelist.addTags(\"div\",\"table\",\"tr\",\"td\");\n        whitelist.addAttributes(\"table\", \"border\");\n        whitelist.addAttributes(\":all\", \"class\", \"style\");\n\n```\n    String safe = Jsoup.clean(unsafe, whitelist);\n    System.out.println(safe);\n```\n","closed_by":{"login":"jhy","id":76934,"node_id":"MDQ6VXNlcjc2OTM0","avatar_url":"https://avatars.githubusercontent.com/u/76934?v=4","gravatar_id":"","url":"https://api.github.com/users/jhy","html_url":"https://github.com/jhy","followers_url":"https://api.github.com/users/jhy/followers","following_url":"https://api.github.com/users/jhy/following{/other_user}","gists_url":"https://api.github.com/users/jhy/gists{/gist_id}","starred_url":"https://api.github.com/users/jhy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jhy/subscriptions","organizations_url":"https://api.github.com/users/jhy/orgs","repos_url":"https://api.github.com/users/jhy/repos","events_url":"https://api.github.com/users/jhy/events{/privacy}","received_events_url":"https://api.github.com/users/jhy/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/jhy/jsoup/issues/156/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/jhy/jsoup/issues/156/timeline","performed_via_github_app":null,"state_reason":"completed"}