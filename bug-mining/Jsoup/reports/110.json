{"url":"https://api.github.com/repos/jhy/jsoup/issues/504","repository_url":"https://api.github.com/repos/jhy/jsoup","labels_url":"https://api.github.com/repos/jhy/jsoup/issues/504/labels{/name}","comments_url":"https://api.github.com/repos/jhy/jsoup/issues/504/comments","events_url":"https://api.github.com/repos/jhy/jsoup/issues/504/events","html_url":"https://github.com/jhy/jsoup/issues/504","id":51011511,"node_id":"MDU6SXNzdWU1MTAxMTUxMQ==","number":504,"title":"Performance issue in Parser.parseBodyFragment for nodes with many children","user":{"login":"kguelzau","id":1053246,"node_id":"MDQ6VXNlcjEwNTMyNDY=","avatar_url":"https://avatars.githubusercontent.com/u/1053246?v=4","gravatar_id":"","url":"https://api.github.com/users/kguelzau","html_url":"https://github.com/kguelzau","followers_url":"https://api.github.com/users/kguelzau/followers","following_url":"https://api.github.com/users/kguelzau/following{/other_user}","gists_url":"https://api.github.com/users/kguelzau/gists{/gist_id}","starred_url":"https://api.github.com/users/kguelzau/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kguelzau/subscriptions","organizations_url":"https://api.github.com/users/kguelzau/orgs","repos_url":"https://api.github.com/users/kguelzau/repos","events_url":"https://api.github.com/users/kguelzau/events{/privacy}","received_events_url":"https://api.github.com/users/kguelzau/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2014-12-04T18:40:34Z","updated_at":"2015-03-29T22:15:27Z","closed_at":"2015-03-29T22:12:43Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"We use jsoup to whitelist allowed html tags from html emails:\n\n```\nJsoup.clean(html, Whitelist.relaxed()\n  .addTags(\"span\")\n  .addTags(\"font\")\n  .addTags(\"s\")\n  .addAttributes(\":all\", \"style\")\n  .addAttributes(\"table\", \"height\", \"border\", \"bgcolor\", \"cellspacing\", \"cellpadding\")\n  .addAttributes(\"th\", \"height\", \"bgcolor\")\n  .addAttributes(\"tr\", \"width\", \"height\", \"bgcolor\")\n  .addAttributes(\"td\", \"height\", \"bgcolor\")\n  .addAttributes(\"font\", \"face\", \"size\", \"color\")\n  .addAttributes(\"a\",\"name\",\"target\")\n  .addAttributes(\"img\", \"border\")\n  .addProtocols(\"img\", \"src\", \"cid\"));\n```\n\nWe got some huge mails with a lot of logging output in the html body.\nThe body element contains ~ 270k childnodes (text, br, hr, h1).\n\nFor this mails our JVM was stuck in the jsoup code for about 10 minutes (high CPU + very high garbarge). :-(\nHere is a small JUnit-Test to show this behavior. The test should finish in under 1 second.\nOn my machine it takes about 4 seconds.\n\n```\npublic class JsoupTest {\n  private static StringBuilder longBody = new StringBuilder(500000);\n  @BeforeClass\n  public static void setup () {\n    for (int i = 0; i < 25000; i++) {\n      longBody.append(i).append(\"<br>\");\n    }\n  }\n\n  @Test\n  public void slow() {\n    // Arrange\n    // Act\n    long start = System.currentTimeMillis();\n    Document doc = Parser.parseBodyFragment(longBody.toString(), \"\");\n\n    // Assert\n    Assert.assertEquals(50000, doc.body().childNodeSize());\n    Assert.assertTrue(System.currentTimeMillis() - start < 1000);\n  }\n}\n```\n\nI think there are some big-o issues in Node.addChildren():\n\n```\nprotected void addChildren(Node... children) {\n    for (Node child: children) {\n        // XXX a child with a parent is removed from the old parent\n        // -> ArrayList.remove() + reindexChilds() = O(2*n)\n        reparentChild(child);\n        childNodes.add(child);\n        child.setSiblingIndex(childNodes.size()-1);\n    }\n}\n```\n\nI was surprised to see an ArrayList for a tree like structure. Isn't a LinkedList a better option?\nAs a quick optimization for my use case I would suggest to create the nodeList without a parentNode or to remove the parent just before adding the node to the bodyNode.\n\nWhat do you think? Is there a workaround for this behavior?\n","closed_by":{"login":"jhy","id":76934,"node_id":"MDQ6VXNlcjc2OTM0","avatar_url":"https://avatars.githubusercontent.com/u/76934?v=4","gravatar_id":"","url":"https://api.github.com/users/jhy","html_url":"https://github.com/jhy","followers_url":"https://api.github.com/users/jhy/followers","following_url":"https://api.github.com/users/jhy/following{/other_user}","gists_url":"https://api.github.com/users/jhy/gists{/gist_id}","starred_url":"https://api.github.com/users/jhy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jhy/subscriptions","organizations_url":"https://api.github.com/users/jhy/orgs","repos_url":"https://api.github.com/users/jhy/repos","events_url":"https://api.github.com/users/jhy/events{/privacy}","received_events_url":"https://api.github.com/users/jhy/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/jhy/jsoup/issues/504/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/jhy/jsoup/issues/504/timeline","performed_via_github_app":null,"state_reason":"completed"}