{"url":"https://api.github.com/repos/jhy/jsoup/issues/1910","repository_url":"https://api.github.com/repos/jhy/jsoup","labels_url":"https://api.github.com/repos/jhy/jsoup/issues/1910/labels{/name}","comments_url":"https://api.github.com/repos/jhy/jsoup/issues/1910/comments","events_url":"https://api.github.com/repos/jhy/jsoup/issues/1910/events","html_url":"https://github.com/jhy/jsoup/issues/1910","id":1605177763,"node_id":"I_kwDOAAbAPs5frRGj","number":1910,"title":"Entities.escape(String) can cause NullPointerException based on class initialization","user":{"login":"cernertrevor","id":44979171,"node_id":"MDQ6VXNlcjQ0OTc5MTcx","avatar_url":"https://avatars.githubusercontent.com/u/44979171?v=4","gravatar_id":"","url":"https://api.github.com/users/cernertrevor","html_url":"https://github.com/cernertrevor","followers_url":"https://api.github.com/users/cernertrevor/followers","following_url":"https://api.github.com/users/cernertrevor/following{/other_user}","gists_url":"https://api.github.com/users/cernertrevor/gists{/gist_id}","starred_url":"https://api.github.com/users/cernertrevor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cernertrevor/subscriptions","organizations_url":"https://api.github.com/users/cernertrevor/orgs","repos_url":"https://api.github.com/users/cernertrevor/repos","events_url":"https://api.github.com/users/cernertrevor/events{/privacy}","received_events_url":"https://api.github.com/users/cernertrevor/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":22026,"node_id":"MDU6TGFiZWwyMjAyNg==","url":"https://api.github.com/repos/jhy/jsoup/labels/bug","name":"bug","color":"D13131","default":true,"description":"A confirmed bug, that we should fix"},{"id":623963149,"node_id":"MDU6TGFiZWw2MjM5NjMxNDk=","url":"https://api.github.com/repos/jhy/jsoup/labels/fixed","name":"fixed","color":"7BE482","default":false,"description":"An {bug|improvement} that has been {fixed|implemented}"}],"state":"closed","locked":false,"assignee":{"login":"jhy","id":76934,"node_id":"MDQ6VXNlcjc2OTM0","avatar_url":"https://avatars.githubusercontent.com/u/76934?v=4","gravatar_id":"","url":"https://api.github.com/users/jhy","html_url":"https://github.com/jhy","followers_url":"https://api.github.com/users/jhy/followers","following_url":"https://api.github.com/users/jhy/following{/other_user}","gists_url":"https://api.github.com/users/jhy/gists{/gist_id}","starred_url":"https://api.github.com/users/jhy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jhy/subscriptions","organizations_url":"https://api.github.com/users/jhy/orgs","repos_url":"https://api.github.com/users/jhy/repos","events_url":"https://api.github.com/users/jhy/events{/privacy}","received_events_url":"https://api.github.com/users/jhy/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"jhy","id":76934,"node_id":"MDQ6VXNlcjc2OTM0","avatar_url":"https://avatars.githubusercontent.com/u/76934?v=4","gravatar_id":"","url":"https://api.github.com/users/jhy","html_url":"https://github.com/jhy","followers_url":"https://api.github.com/users/jhy/followers","following_url":"https://api.github.com/users/jhy/following{/other_user}","gists_url":"https://api.github.com/users/jhy/gists{/gist_id}","starred_url":"https://api.github.com/users/jhy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jhy/subscriptions","organizations_url":"https://api.github.com/users/jhy/orgs","repos_url":"https://api.github.com/users/jhy/repos","events_url":"https://api.github.com/users/jhy/events{/privacy}","received_events_url":"https://api.github.com/users/jhy/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/jhy/jsoup/milestones/25","html_url":"https://github.com/jhy/jsoup/milestone/25","labels_url":"https://api.github.com/repos/jhy/jsoup/milestones/25/labels","id":8941164,"node_id":"MI_kwDOAAbAPs4AiG5s","number":25,"title":"1.16.1","description":"","creator":{"login":"jhy","id":76934,"node_id":"MDQ6VXNlcjc2OTM0","avatar_url":"https://avatars.githubusercontent.com/u/76934?v=4","gravatar_id":"","url":"https://api.github.com/users/jhy","html_url":"https://github.com/jhy","followers_url":"https://api.github.com/users/jhy/followers","following_url":"https://api.github.com/users/jhy/following{/other_user}","gists_url":"https://api.github.com/users/jhy/gists{/gist_id}","starred_url":"https://api.github.com/users/jhy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jhy/subscriptions","organizations_url":"https://api.github.com/users/jhy/orgs","repos_url":"https://api.github.com/users/jhy/repos","events_url":"https://api.github.com/users/jhy/events{/privacy}","received_events_url":"https://api.github.com/users/jhy/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":14,"state":"closed","created_at":"2023-01-18T23:14:56Z","updated_at":"2023-05-06T02:28:37Z","due_on":"2023-04-23T07:00:00Z","closed_at":"2023-05-06T02:27:02Z"},"comments":3,"created_at":"2023-03-01T15:23:22Z","updated_at":"2024-08-12T04:04:42Z","closed_at":"2023-03-02T23:47:50Z","author_association":"NONE","active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"I've come across an interesting bug that results due to a partial circular dependency between the Entities class and the Document.OutputSettings class.  I did not see any existing issues that appeared to match this bug.\r\n\r\nHere's the situation.  I (as a consumer) want to use the Entities.escape(String) method that takes a single string parameter[1].  This method defaults the OutputSettings to a \"DefaultOutput\" variable within Entities that is initialized on class load[2].  Because this is a static variable, it is initialized when the Entities class is first invoked.  This _normally_ works fine, unless the Document.OutputSettings class is initialized before any Entities references (there could be any number of reasons why we might do this such as creating a static OutputSettings object with our preferred settings in a constant file).  \r\n\r\nIf a new Document.OutputSettings is initialized, it will default the EscapeMode to base[3].  However, because the EscapeMode enumeration is in the Entities class, the JVM classloader now needs to initialize the Entities class including its static creation of a DefaultOutput Document.OutputSettings object.  So at this point, the classloader needs to instantiate a second OutputSettings object (the first one is the one I'm instantiating in my consumer code, and this second one is for the DefaultOutput in Entities), but that means it needs to read that base EscapeMode enumeration again, but the code is already in the process of loading the Entities class from the first time through.  When the classloader sees this, it sets the EscapeMode on the second instantiation (the DefaultOutput object) to null.\r\n\r\nAt this point, because that object is static, if I were to call Entities.escape(\"\\u0013\") (in other words, a control character), then it will fall down this path[4] where escapeMode is expected to be non-null.  The NullPointerException is then thrown.\r\n\r\nThere are ways for me as a consumer to get around this; for example, I can specify an OutputSettings directly (using the overloaded escape), or always make sure that Entities is initialized prior to any OutputSettings references, but I don't think that should be my responsibility as a consumer, it essentially means I can't use the DefaultOutput version of Entities.escape() unless I keep a close eye on the order of invocation of third-party code, meaning that I have to be aware of the implementation details of the classes.\r\n\r\nI have created an example repl.it to reproduce[5].  It is a simple program that only pulls in JSoup (to demonstrate that there's nothing from my consumer code causing this).  There is an if condition that when no arguments are sent to the class, demonstrates the issue by initializing an OutputSettings variable and escaping a control character:\r\n\r\nOutputSettings test = new OutputSettings();\r\nEntities.escape(\"\\u0013\");\r\n\r\nThis throws the NPE.  From the shell, the class can be run again with any argument (e.g. \"java -classpath .:target/dependency/* Main 1\"), which will cause it to go down the working path, which calls the same code but initializes Entities first by calling Entities.escape before:\r\n\r\nEntities.escape(\"\\u0013\");\r\nOutputSettings test = new OutputSettings();\r\nEntities.escape(\"\\u0013\");\r\n\r\nNo NPE, and \"Hello World\" is written out to the console.  I don't believe I'm using any of the classes inappropriately, which is why I believe this to be a legitimate bug.  Let me know if there is any additional information I can provide or if there are any issues with the repl.it.  Thank you.\r\n\r\n[1] - https://github.com/jhy/jsoup/blob/master/src/main/java/org/jsoup/nodes/Entities.java#L159\r\n[2] - https://github.com/jhy/jsoup/blob/master/src/main/java/org/jsoup/nodes/Entities.java#L29\r\n[3] - https://github.com/jhy/jsoup/blob/master/src/main/java/org/jsoup/nodes/Document.java#L448\r\n[4] - https://github.com/jhy/jsoup/blob/master/src/main/java/org/jsoup/nodes/Entities.java#L240\r\n[5] - https://replit.com/@trevorrials/JsoupEscapeModeBug#Main.java","closed_by":{"login":"jhy","id":76934,"node_id":"MDQ6VXNlcjc2OTM0","avatar_url":"https://avatars.githubusercontent.com/u/76934?v=4","gravatar_id":"","url":"https://api.github.com/users/jhy","html_url":"https://github.com/jhy","followers_url":"https://api.github.com/users/jhy/followers","following_url":"https://api.github.com/users/jhy/following{/other_user}","gists_url":"https://api.github.com/users/jhy/gists{/gist_id}","starred_url":"https://api.github.com/users/jhy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jhy/subscriptions","organizations_url":"https://api.github.com/users/jhy/orgs","repos_url":"https://api.github.com/users/jhy/repos","events_url":"https://api.github.com/users/jhy/events{/privacy}","received_events_url":"https://api.github.com/users/jhy/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/jhy/jsoup/issues/1910/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/jhy/jsoup/issues/1910/timeline","performed_via_github_app":null,"state_reason":"completed"}