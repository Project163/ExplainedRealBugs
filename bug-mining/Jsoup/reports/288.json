{"url":"https://api.github.com/repos/jhy/jsoup/issues/1691","repository_url":"https://api.github.com/repos/jhy/jsoup","labels_url":"https://api.github.com/repos/jhy/jsoup/issues/1691/labels{/name}","comments_url":"https://api.github.com/repos/jhy/jsoup/issues/1691/comments","events_url":"https://api.github.com/repos/jhy/jsoup/issues/1691/events","html_url":"https://github.com/jhy/jsoup/issues/1691","id":1085243732,"node_id":"I_kwDOAAbAPs5Ar4FU","number":1691,"title":"SelectorParseException is broken - treats unsafe input as a String.format template.","user":{"login":"rzwitserloot","id":93303,"node_id":"MDQ6VXNlcjkzMzAz","avatar_url":"https://avatars.githubusercontent.com/u/93303?v=4","gravatar_id":"","url":"https://api.github.com/users/rzwitserloot","html_url":"https://github.com/rzwitserloot","followers_url":"https://api.github.com/users/rzwitserloot/followers","following_url":"https://api.github.com/users/rzwitserloot/following{/other_user}","gists_url":"https://api.github.com/users/rzwitserloot/gists{/gist_id}","starred_url":"https://api.github.com/users/rzwitserloot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rzwitserloot/subscriptions","organizations_url":"https://api.github.com/users/rzwitserloot/orgs","repos_url":"https://api.github.com/users/rzwitserloot/repos","events_url":"https://api.github.com/users/rzwitserloot/events{/privacy}","received_events_url":"https://api.github.com/users/rzwitserloot/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":22026,"node_id":"MDU6TGFiZWwyMjAyNg==","url":"https://api.github.com/repos/jhy/jsoup/labels/bug","name":"bug","color":"D13131","default":true,"description":"A confirmed bug, that we should fix"},{"id":623963149,"node_id":"MDU6TGFiZWw2MjM5NjMxNDk=","url":"https://api.github.com/repos/jhy/jsoup/labels/fixed","name":"fixed","color":"7BE482","default":false,"description":"An {bug|improvement} that has been {fixed|implemented}"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/jhy/jsoup/milestones/19","html_url":"https://github.com/jhy/jsoup/milestone/19","labels_url":"https://api.github.com/repos/jhy/jsoup/milestones/19/labels","id":6216969,"node_id":"MDk6TWlsZXN0b25lNjIxNjk2OQ==","number":19,"title":"1.15.1","description":"A planned future version of jsoup. Tag this milestone for breaking changes that were deprecated in 1.14.x.","creator":{"login":"jhy","id":76934,"node_id":"MDQ6VXNlcjc2OTM0","avatar_url":"https://avatars.githubusercontent.com/u/76934?v=4","gravatar_id":"","url":"https://api.github.com/users/jhy","html_url":"https://github.com/jhy","followers_url":"https://api.github.com/users/jhy/followers","following_url":"https://api.github.com/users/jhy/following{/other_user}","gists_url":"https://api.github.com/users/jhy/gists{/gist_id}","starred_url":"https://api.github.com/users/jhy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jhy/subscriptions","organizations_url":"https://api.github.com/users/jhy/orgs","repos_url":"https://api.github.com/users/jhy/repos","events_url":"https://api.github.com/users/jhy/events{/privacy}","received_events_url":"https://api.github.com/users/jhy/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":23,"state":"closed","created_at":"2020-12-16T00:23:00Z","updated_at":"2022-05-17T23:41:11Z","due_on":null,"closed_at":"2022-05-17T23:41:11Z"},"comments":2,"created_at":"2021-12-20T22:06:54Z","updated_at":"2021-12-23T00:16:26Z","closed_at":"2021-12-23T00:12:40Z","author_association":"NONE","active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"This problem is a bit like the log4shell stuff / similarities with SQL injection and the like, but I don't think there is a security leak here. It is, however, a problem of trusting dirty inputs. Just, fortunately, not in a way that I can imagine can be abused for nefarious purposes.\r\n\r\nVarious lines of code in the JSoup project, for example [QueryParser.java line 47](https://github.com/jhy/jsoup/blob/master/src/main/java/org/jsoup/select/QueryParser.java#L47)  will take a string that is __very much dirty__ and could contain, well, just about anything, and passes it straight through to the [Selector.java line 168](https://github.com/jhy/jsoup/blob/master/src/main/java/org/jsoup/select/Selector.java#L168) factory method that makes a new `SelectorParseException` - this constructor does __not__ deal with dirty input.\r\n\r\nAs a consequence, in certain possibly somewhat contrived scenarios, instead of a nice clean error pointing exactly at where with a nice message telling you exactly what, you get a completely useless exception, as an exception occurs whilst constructing a nice exception. Specifically, if the raw (dirty) input contains a `%` anywhere inside it, then `String.format` will therefore attempt to treat that bit as a format specifier (such as `%5d` to indicate: a 5-digit integral number here), and crash.\r\n\r\nOne easy-enough way to trigger this is to pass invalid regexes that contain e.g. `[%&#]` - `%&` in a `String.format` template string will cause `String.format` to throw.\r\n\r\nThe only real fix is probably to review __all__ calls to line 168 in Selector.java (search for `new SelectorParseException(...)`, or better yet, in a java editor, all callers of that constructor), and make sure that the first arg definitely, guaranteed, only contains clean inputs, preferably hard constants. There are many ways to go from here, and I leave it to the core maintainers to make a decision. hence, no pullrequest.\r\n\r\nOption 1: Review all callers and update them as follows:\r\n\r\n```java\r\n// Currently (QueryParser.java::47):\r\nthrow new Selector.SelectorParseException(e.getMessage());\r\n// Should become:\r\nthrow new Selector.SelectorParseException(\"%s\", e.getMessage());\r\n```\r\n\r\nOption 2: Special-case no format arguments.\r\n\r\n```java\r\n// Currently (Selector.java::168):\r\nsuper(String.format(msg, params));\r\n// should be:\r\nsuper(params.length == 0 ? msg : String.format(msg, params));\r\n```\r\n\r\nOption 3: Delete this API nicety, because its dangerous. **I think this is the correct choice, but it is also the most work**.\r\n\r\n```java\r\n// Currently (Selector.java::167-169):\r\npublic SelectorParseException(String msg, Object... params) {\r\n    super(String.format(msg, params));\r\n}\r\n// should be:\r\npublic SelectorParseException(String msg) {\r\n    super(msg);\r\n}\r\n```\r\n\r\nAnd on top of that, all code that now fails to compile needs to be adjusted; instead of `new SelectorParseException(a, b, c)`, change it to `new SelectorParseException(String.format(a, b, c))`, and do a quick doublecheck that the first arg definitely doesn't contain dirty strings.\r\n\r\n## Mindset warning\r\n\r\nPerhaps do a quick scan for `String.format` throughout the JSoup code base, this might not be the only place where raw (dirty) input ends up getting passed to places where dirty input shouldn't go.\r\n\r\n\r\nNB: Had `String.format` had an option to do a JNDI lookup to an LDAP server.... oh dear. Then we'd have a carbon copy of the log4shell CVE. Fortunately, String.format doesn't have that functionality. Phew.\r\n","closed_by":{"login":"jhy","id":76934,"node_id":"MDQ6VXNlcjc2OTM0","avatar_url":"https://avatars.githubusercontent.com/u/76934?v=4","gravatar_id":"","url":"https://api.github.com/users/jhy","html_url":"https://github.com/jhy","followers_url":"https://api.github.com/users/jhy/followers","following_url":"https://api.github.com/users/jhy/following{/other_user}","gists_url":"https://api.github.com/users/jhy/gists{/gist_id}","starred_url":"https://api.github.com/users/jhy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jhy/subscriptions","organizations_url":"https://api.github.com/users/jhy/orgs","repos_url":"https://api.github.com/users/jhy/repos","events_url":"https://api.github.com/users/jhy/events{/privacy}","received_events_url":"https://api.github.com/users/jhy/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/jhy/jsoup/issues/1691/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/jhy/jsoup/issues/1691/timeline","performed_via_github_app":null,"state_reason":"completed"}