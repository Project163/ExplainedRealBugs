{"url":"https://api.github.com/repos/jhy/jsoup/issues/2277","repository_url":"https://api.github.com/repos/jhy/jsoup","labels_url":"https://api.github.com/repos/jhy/jsoup/issues/2277/labels{/name}","comments_url":"https://api.github.com/repos/jhy/jsoup/issues/2277/comments","events_url":"https://api.github.com/repos/jhy/jsoup/issues/2277/events","html_url":"https://github.com/jhy/jsoup/issues/2277","id":2879935398,"node_id":"I_kwDOAAbAPs6rqFOm","number":2277,"title":"Apparent MemoryLeak in Evaluator code","user":{"login":"jstultz","id":308104,"node_id":"MDQ6VXNlcjMwODEwNA==","avatar_url":"https://avatars.githubusercontent.com/u/308104?v=4","gravatar_id":"","url":"https://api.github.com/users/jstultz","html_url":"https://github.com/jstultz","followers_url":"https://api.github.com/users/jstultz/followers","following_url":"https://api.github.com/users/jstultz/following{/other_user}","gists_url":"https://api.github.com/users/jstultz/gists{/gist_id}","starred_url":"https://api.github.com/users/jstultz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jstultz/subscriptions","organizations_url":"https://api.github.com/users/jstultz/orgs","repos_url":"https://api.github.com/users/jstultz/repos","events_url":"https://api.github.com/users/jstultz/events{/privacy}","received_events_url":"https://api.github.com/users/jstultz/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":22026,"node_id":"MDU6TGFiZWwyMjAyNg==","url":"https://api.github.com/repos/jhy/jsoup/labels/bug","name":"bug","color":"D13131","default":true,"description":"A confirmed bug, that we should fix"},{"id":623963149,"node_id":"MDU6TGFiZWw2MjM5NjMxNDk=","url":"https://api.github.com/repos/jhy/jsoup/labels/fixed","name":"fixed","color":"7BE482","default":false,"description":"An {bug|improvement} that has been {fixed|implemented}"}],"state":"closed","locked":false,"assignee":{"login":"jhy","id":76934,"node_id":"MDQ6VXNlcjc2OTM0","avatar_url":"https://avatars.githubusercontent.com/u/76934?v=4","gravatar_id":"","url":"https://api.github.com/users/jhy","html_url":"https://github.com/jhy","followers_url":"https://api.github.com/users/jhy/followers","following_url":"https://api.github.com/users/jhy/following{/other_user}","gists_url":"https://api.github.com/users/jhy/gists{/gist_id}","starred_url":"https://api.github.com/users/jhy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jhy/subscriptions","organizations_url":"https://api.github.com/users/jhy/orgs","repos_url":"https://api.github.com/users/jhy/repos","events_url":"https://api.github.com/users/jhy/events{/privacy}","received_events_url":"https://api.github.com/users/jhy/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"jhy","id":76934,"node_id":"MDQ6VXNlcjc2OTM0","avatar_url":"https://avatars.githubusercontent.com/u/76934?v=4","gravatar_id":"","url":"https://api.github.com/users/jhy","html_url":"https://github.com/jhy","followers_url":"https://api.github.com/users/jhy/followers","following_url":"https://api.github.com/users/jhy/following{/other_user}","gists_url":"https://api.github.com/users/jhy/gists{/gist_id}","starred_url":"https://api.github.com/users/jhy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jhy/subscriptions","organizations_url":"https://api.github.com/users/jhy/orgs","repos_url":"https://api.github.com/users/jhy/repos","events_url":"https://api.github.com/users/jhy/events{/privacy}","received_events_url":"https://api.github.com/users/jhy/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/jhy/jsoup/milestones/31","html_url":"https://github.com/jhy/jsoup/milestone/31","labels_url":"https://api.github.com/repos/jhy/jsoup/milestones/31/labels","id":11372863,"node_id":"MI_kwDOAAbAPs4ArYk_","number":31,"title":"1.19.1","description":"https://jsoup.org/news/release-1.19.1","creator":{"login":"jhy","id":76934,"node_id":"MDQ6VXNlcjc2OTM0","avatar_url":"https://avatars.githubusercontent.com/u/76934?v=4","gravatar_id":"","url":"https://api.github.com/users/jhy","html_url":"https://github.com/jhy","followers_url":"https://api.github.com/users/jhy/followers","following_url":"https://api.github.com/users/jhy/following{/other_user}","gists_url":"https://api.github.com/users/jhy/gists{/gist_id}","starred_url":"https://api.github.com/users/jhy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jhy/subscriptions","organizations_url":"https://api.github.com/users/jhy/orgs","repos_url":"https://api.github.com/users/jhy/repos","events_url":"https://api.github.com/users/jhy/events{/privacy}","received_events_url":"https://api.github.com/users/jhy/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":27,"state":"closed","created_at":"2024-07-29T04:35:06Z","updated_at":"2025-03-05T06:47:20Z","due_on":null,"closed_at":"2025-03-05T06:46:36Z"},"comments":2,"created_at":"2025-02-26T01:58:42Z","updated_at":"2025-03-02T20:31:52Z","closed_at":"2025-02-26T23:17:57Z","author_association":"NONE","active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Short version:\n\nIt looks like there's a memory leak in the `StructuralEvaluator` classes as a result of the `ThreadLocal` memoization implementation. When `matches` is called, values will be potentially added into the `IdentityHashMap` collections. This appears to be handled by the `reset` method clearing the hash maps, and it is called when using the Evaluator through Collectors. However, the `StructuralEvaluator` class wraps another Evaluator, and calls the `matches` method on it, which may result in its hash map being populated. But, crucially, the `StructuralEvaluator.reset` method does not call `reset` on the wrapped Evaluator. This means that if a `StructuralEvaluator` wraps another `StructuralEvaluator`, the latter may endlessly accumulate references to elements in its thread locals.\n\nThis reproduces for me (sorry for Scala not Java, but this is what I was working with today so it was easier to throw together by simplifying my problem case... hopefully sufficiently simple and clear):\n\n```scala\nimport org.jsoup.parser.{Parser, StreamParser}\nimport org.jsoup.select.QueryParser\n\nobject LeakTest {\n  def main(args: Array[String]): Unit = {\n    val xml = \"\"\"\n      <A>\n        <B>\n          <C>1</C>\n        </B>\n      </A>\n    \"\"\"\n\n    val q = QueryParser.parse(\"A B C\")\n\n    while (true) {\n      val parser = new StreamParser(Parser.xmlParser).parse(xml, \"\")\n      parser.selectFirst(q)\n      parser.stop\n      parser.close\n    }\n  }\n}\n```\n\nRunning this rapidly consumes all available memory:\n\n![Image](https://github.com/user-attachments/assets/25b67755-eb27-466f-afbb-3d28f4862b27)\n\nI imagine there are other ways to reproduce as well; this ancestral nesting of three elements was how I encountered it. If you remove one of the elements from the query, no leak.\n\nI ran into this because I'm using the StreamParser to process many potentially very large XML files in a long lived process in a way that hopefully avoids having to pull all the elements in the document into memory at once. We noticed that using strings directly for the select method was using quite a bit of CPU to parse the queries over and over, so we created long-lived Evaluators to avoid paying this cost repeatedly, as our queries aren't dynamic. Then, saw a memory leak and tracked it down to this. For now, I've worked around this by just creating new Evaluators for each run of the parser, which avoids a severe long term leakage, but it could still result in these hash maps growing quite large over the course of parsing a single very large file.\n\nI'm game to take a stab at a PR if you're open to it, but if it's easy and quick for you to resolve that'd be great too. My guess is that the solution is to override/update `reset` to also call `reset` on any wrapped evaluators as well (as the CombiningEvaluators do)\n\nPlease let me know if I've misunderstood anything in the above! I've only just spent the afternoon digging into the code and trying to understand what's going on, so it's not unlikely.","closed_by":{"login":"jhy","id":76934,"node_id":"MDQ6VXNlcjc2OTM0","avatar_url":"https://avatars.githubusercontent.com/u/76934?v=4","gravatar_id":"","url":"https://api.github.com/users/jhy","html_url":"https://github.com/jhy","followers_url":"https://api.github.com/users/jhy/followers","following_url":"https://api.github.com/users/jhy/following{/other_user}","gists_url":"https://api.github.com/users/jhy/gists{/gist_id}","starred_url":"https://api.github.com/users/jhy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jhy/subscriptions","organizations_url":"https://api.github.com/users/jhy/orgs","repos_url":"https://api.github.com/users/jhy/repos","events_url":"https://api.github.com/users/jhy/events{/privacy}","received_events_url":"https://api.github.com/users/jhy/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/jhy/jsoup/issues/2277/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/jhy/jsoup/issues/2277/timeline","performed_via_github_app":null,"state_reason":"completed"}