{"url":"https://api.github.com/repos/jhy/jsoup/issues/970","repository_url":"https://api.github.com/repos/jhy/jsoup","labels_url":"https://api.github.com/repos/jhy/jsoup/issues/970/labels{/name}","comments_url":"https://api.github.com/repos/jhy/jsoup/issues/970/comments","events_url":"https://api.github.com/repos/jhy/jsoup/issues/970/events","html_url":"https://github.com/jhy/jsoup/issues/970","id":273517524,"node_id":"MDU6SXNzdWUyNzM1MTc1MjQ=","number":970,"title":"Entities.canEncode() with non-fast-path encoding is not thread safe on Android (jsoup 1.11.1)","user":{"login":"baka-kaba","id":6281947,"node_id":"MDQ6VXNlcjYyODE5NDc=","avatar_url":"https://avatars.githubusercontent.com/u/6281947?v=4","gravatar_id":"","url":"https://api.github.com/users/baka-kaba","html_url":"https://github.com/baka-kaba","followers_url":"https://api.github.com/users/baka-kaba/followers","following_url":"https://api.github.com/users/baka-kaba/following{/other_user}","gists_url":"https://api.github.com/users/baka-kaba/gists{/gist_id}","starred_url":"https://api.github.com/users/baka-kaba/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/baka-kaba/subscriptions","organizations_url":"https://api.github.com/users/baka-kaba/orgs","repos_url":"https://api.github.com/users/baka-kaba/repos","events_url":"https://api.github.com/users/baka-kaba/events{/privacy}","received_events_url":"https://api.github.com/users/baka-kaba/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":22026,"node_id":"MDU6TGFiZWwyMjAyNg==","url":"https://api.github.com/repos/jhy/jsoup/labels/bug","name":"bug","color":"D13131","default":true,"description":"A confirmed bug, that we should fix"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/jhy/jsoup/milestones/13","html_url":"https://github.com/jhy/jsoup/milestone/13","labels_url":"https://api.github.com/repos/jhy/jsoup/milestones/13/labels","id":2893200,"node_id":"MDk6TWlsZXN0b25lMjg5MzIwMA==","number":13,"title":"1.11.2","description":null,"creator":{"login":"jhy","id":76934,"node_id":"MDQ6VXNlcjc2OTM0","avatar_url":"https://avatars.githubusercontent.com/u/76934?v=4","gravatar_id":"","url":"https://api.github.com/users/jhy","html_url":"https://github.com/jhy","followers_url":"https://api.github.com/users/jhy/followers","following_url":"https://api.github.com/users/jhy/following{/other_user}","gists_url":"https://api.github.com/users/jhy/gists{/gist_id}","starred_url":"https://api.github.com/users/jhy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jhy/subscriptions","organizations_url":"https://api.github.com/users/jhy/orgs","repos_url":"https://api.github.com/users/jhy/repos","events_url":"https://api.github.com/users/jhy/events{/privacy}","received_events_url":"https://api.github.com/users/jhy/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":13,"state":"closed","created_at":"2017-11-07T06:33:04Z","updated_at":"2017-12-10T18:43:36Z","due_on":null,"closed_at":"2017-12-03T22:38:51Z"},"comments":5,"created_at":"2017-11-13T17:43:00Z","updated_at":"2017-11-15T05:41:58Z","closed_at":"2017-11-15T05:38:52Z","author_association":"NONE","active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"(This crash doesn't occur on 1.10.3 or 1.10.2)\r\n\r\nI'm pulling a list of elements from a document and using several threads to parse them, but when I call ``Element.html()`` I get this exception\r\n\r\n``\r\nSystem.err: Caused by: java.lang.IllegalStateException: Current state = CODING_END, new state = CODING\r\nSystem.err:     at java.nio.charset.CharsetEncoder.throwIllegalStateException(CharsetEncoder.java:1014)\r\nSystem.err:     at java.nio.charset.CharsetEncoder.canEncode(CharsetEncoder.java:923)\r\nSystem.err:     at java.nio.charset.CharsetEncoder.canEncode(CharsetEncoder.java:973)\r\nSystem.err:     at org.jsoup.nodes.Entities.canEncode(Entities.java:298)\r\nSystem.err:     at org.jsoup.nodes.Entities.escape(Entities.java:233)\r\nSystem.err:     at org.jsoup.nodes.Attributes.html(Attributes.java:323)\r\nSystem.err:     at org.jsoup.nodes.Element.outerHtmlHead(Element.java:1328)\r\nSystem.err:     at org.jsoup.nodes.Node$OuterHtmlVisitor.head(Node.java:709)\r\nSystem.err:     at org.jsoup.select.NodeTraversor.traverse(NodeTraversor.java:45)\r\nSystem.err:     at org.jsoup.nodes.Node.outerHtml(Node.java:573)\r\nSystem.err:     at org.jsoup.nodes.Element.html(Element.java:1366)\r\nSystem.err:     at org.jsoup.nodes.Element.html(Element.java:1360)\r\nSystem.err:     at com.testapp.JsoupMultithreadedTest$ParseTask.call(JsoupMultithreadedTest.java:49)\r\nSystem.err:     at com.testapp.thread.JsoupMultithreadedTest$ParseTask.call(JsoupMultithreadedTest.java:39)\r\nSystem.err:     at java.util.concurrent.FutureTask.run(FutureTask.java:266)\r\nSystem.err:     at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1162)\r\nSystem.err:     at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:636)\r\nSystem.err:     at java.lang.Thread.run(Thread.java:764)\r\n``\r\n\r\nThe state can vary, I've also seen ``END_OF_INPUT`` and ``RESET``.\r\n\r\nHere's an example that displays the behaviour on Android - it seems to work fine on my Windows 10 machine, but crashes every time on an Android device (Android 6.0.1) and emulator (Android 8.0). The site's encoding [is apparently](https://validator.w3.org/nu/?doc=https%3A%2F%2Fforums.somethingawful.com%2F) ``Windows 1252`` even though the content type is set as ``iso-8859-1``. Works fine with a single thread, and you can run it multithreaded on ``1.10.3`` with no problems.\r\n\r\n```java\r\npublic class JsoupMultithreadedTest {\r\n\r\n    private static final String pageUrl = \"https://forums.somethingawful.com\";\r\n    private static final ExecutorService executor = Executors.newFixedThreadPool(2);\r\n\r\n    public static void run() throws IOException, InterruptedException, ExecutionException {\r\n        Document document = Jsoup.connect(pageUrl).get();\r\n        Elements headlines = document.select(\".forum\");\r\n\r\n        List<Callable<String>> tasks = new ArrayList<>();\r\n        for (Element headline : headlines) {\r\n            tasks.add(new ParseTask(headline));\r\n        }\r\n\r\n        for (Future<String> result : executor.invokeAll(tasks)) {\r\n            System.out.println(result.get());\r\n        }\r\n    }\r\n\r\n    private static class ParseTask implements Callable<String> {\r\n\r\n        private final Element rootElement;\r\n\r\n        private ParseTask(Element rootElement) {\r\n            this.rootElement = rootElement;\r\n        }\r\n\r\n        @Override\r\n        public String call() throws Exception {\r\n            return rootElement.html();\r\n        }\r\n    }\r\n}\r\n```","closed_by":{"login":"jhy","id":76934,"node_id":"MDQ6VXNlcjc2OTM0","avatar_url":"https://avatars.githubusercontent.com/u/76934?v=4","gravatar_id":"","url":"https://api.github.com/users/jhy","html_url":"https://github.com/jhy","followers_url":"https://api.github.com/users/jhy/followers","following_url":"https://api.github.com/users/jhy/following{/other_user}","gists_url":"https://api.github.com/users/jhy/gists{/gist_id}","starred_url":"https://api.github.com/users/jhy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jhy/subscriptions","organizations_url":"https://api.github.com/users/jhy/orgs","repos_url":"https://api.github.com/users/jhy/repos","events_url":"https://api.github.com/users/jhy/events{/privacy}","received_events_url":"https://api.github.com/users/jhy/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/jhy/jsoup/issues/970/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/jhy/jsoup/issues/970/timeline","performed_via_github_app":null,"state_reason":"completed"}