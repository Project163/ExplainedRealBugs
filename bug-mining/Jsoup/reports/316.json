{"url":"https://api.github.com/repos/jhy/jsoup/issues/2049","repository_url":"https://api.github.com/repos/jhy/jsoup","labels_url":"https://api.github.com/repos/jhy/jsoup/issues/2049/labels{/name}","comments_url":"https://api.github.com/repos/jhy/jsoup/issues/2049/comments","events_url":"https://api.github.com/repos/jhy/jsoup/issues/2049/events","html_url":"https://github.com/jhy/jsoup/issues/2049","id":1990635142,"node_id":"I_kwDOAAbAPs52pq6G","number":2049,"title":"Cleaner output is nested incorrectly if safelist and input document have differing cases","user":{"login":"Balf","id":1479618,"node_id":"MDQ6VXNlcjE0Nzk2MTg=","avatar_url":"https://avatars.githubusercontent.com/u/1479618?v=4","gravatar_id":"","url":"https://api.github.com/users/Balf","html_url":"https://github.com/Balf","followers_url":"https://api.github.com/users/Balf/followers","following_url":"https://api.github.com/users/Balf/following{/other_user}","gists_url":"https://api.github.com/users/Balf/gists{/gist_id}","starred_url":"https://api.github.com/users/Balf/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Balf/subscriptions","organizations_url":"https://api.github.com/users/Balf/orgs","repos_url":"https://api.github.com/users/Balf/repos","events_url":"https://api.github.com/users/Balf/events{/privacy}","received_events_url":"https://api.github.com/users/Balf/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":22026,"node_id":"MDU6TGFiZWwyMjAyNg==","url":"https://api.github.com/repos/jhy/jsoup/labels/bug","name":"bug","color":"D13131","default":true,"description":"A confirmed bug, that we should fix"},{"id":623963149,"node_id":"MDU6TGFiZWw2MjM5NjMxNDk=","url":"https://api.github.com/repos/jhy/jsoup/labels/fixed","name":"fixed","color":"7BE482","default":false,"description":"An {bug|improvement} that has been {fixed|implemented}"}],"state":"closed","locked":false,"assignee":{"login":"jhy","id":76934,"node_id":"MDQ6VXNlcjc2OTM0","avatar_url":"https://avatars.githubusercontent.com/u/76934?v=4","gravatar_id":"","url":"https://api.github.com/users/jhy","html_url":"https://github.com/jhy","followers_url":"https://api.github.com/users/jhy/followers","following_url":"https://api.github.com/users/jhy/following{/other_user}","gists_url":"https://api.github.com/users/jhy/gists{/gist_id}","starred_url":"https://api.github.com/users/jhy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jhy/subscriptions","organizations_url":"https://api.github.com/users/jhy/orgs","repos_url":"https://api.github.com/users/jhy/repos","events_url":"https://api.github.com/users/jhy/events{/privacy}","received_events_url":"https://api.github.com/users/jhy/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"jhy","id":76934,"node_id":"MDQ6VXNlcjc2OTM0","avatar_url":"https://avatars.githubusercontent.com/u/76934?v=4","gravatar_id":"","url":"https://api.github.com/users/jhy","html_url":"https://github.com/jhy","followers_url":"https://api.github.com/users/jhy/followers","following_url":"https://api.github.com/users/jhy/following{/other_user}","gists_url":"https://api.github.com/users/jhy/gists{/gist_id}","starred_url":"https://api.github.com/users/jhy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jhy/subscriptions","organizations_url":"https://api.github.com/users/jhy/orgs","repos_url":"https://api.github.com/users/jhy/repos","events_url":"https://api.github.com/users/jhy/events{/privacy}","received_events_url":"https://api.github.com/users/jhy/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/jhy/jsoup/milestones/27","html_url":"https://github.com/jhy/jsoup/milestone/27","labels_url":"https://api.github.com/repos/jhy/jsoup/milestones/27/labels","id":10097981,"node_id":"MI_kwDOAAbAPs4AmhU9","number":27,"title":"1.17.1","description":"","creator":{"login":"jhy","id":76934,"node_id":"MDQ6VXNlcjc2OTM0","avatar_url":"https://avatars.githubusercontent.com/u/76934?v=4","gravatar_id":"","url":"https://api.github.com/users/jhy","html_url":"https://github.com/jhy","followers_url":"https://api.github.com/users/jhy/followers","following_url":"https://api.github.com/users/jhy/following{/other_user}","gists_url":"https://api.github.com/users/jhy/gists{/gist_id}","starred_url":"https://api.github.com/users/jhy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jhy/subscriptions","organizations_url":"https://api.github.com/users/jhy/orgs","repos_url":"https://api.github.com/users/jhy/repos","events_url":"https://api.github.com/users/jhy/events{/privacy}","received_events_url":"https://api.github.com/users/jhy/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":27,"state":"closed","created_at":"2023-10-24T04:45:53Z","updated_at":"2023-11-27T09:00:22Z","due_on":null,"closed_at":"2023-11-27T09:00:22Z"},"comments":4,"created_at":"2023-11-13T13:11:23Z","updated_at":"2023-11-27T10:30:25Z","closed_at":"2023-11-22T23:47:17Z","author_association":"NONE","active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"@jhy We're running into an issue which might be related to #2040. In version 1.16.1 we used to code snippet below to clean SVG's and it worked fine. In 1.16.2 the same code breaks, because the cleaned SVG is invalid. Self closing elements are not parsed properly. How should we do this in 1.16.2?\r\n\r\n```\r\nString svg = \"...see below for the source svg\";\r\nSafelist safeList = Safelist.none();\r\n\r\nString[] lowercaseElementsArray = Arrays.stream(DEFAULT_SVG_ELEMENTS)\r\n            .map(String::toLowerCase)\r\n            .toList()\r\n            .toArray(new String[0]);\r\n\r\nString[] lowercaseAttributesArray = Arrays.stream(DEFAULT_SVG_ATTRIBUTES)\r\n            .map(String::toLowerCase)\r\n            .toList()\r\n            .toArray(new String[0]);\r\n\r\nsafelist.addTags(lowercaseElementsArray);\r\nsafelist.addAttributes(\":all\", lowercaseAttributesArray);\r\n\r\nString cleanedSvg = Jsoup.clean(svg, safeList)\r\n\r\n```\r\n**SVG Source**\r\n\r\n``` \r\n<svg width=\"200\" height=\"200\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\">\r\n    <filter id=\"feOffset\" x=\"-40\" y=\"-20\" width=\"100\" height=\"200\">\r\n        <feOffset in=\"SourceGraphic\" dx=\"60\" dy=\"60\" />\r\n        <feGaussianBlur in=\"SourceGraphic\" stdDeviation=\"5\" result=\"blur2\" />\r\n        <feMerge>\r\n            <feMergeNode\r\n                    in=\"blur2\"></feMergeNode>\r\n            <feMergeNode></feMergeNode>\r\n            <feMergeNode in=\"SourceGraphic\" />\r\n        </feMerge>\r\n    </filter>\r\n    <filter id=\"noise2\" x=\"0\" y=\"0\" width=\"100%\" height=\"100%\">\r\n        <feTurbulence baseFrequency=\"0.05\" />\r\n    </filter>\r\n    <clipPath id=\"myClip2\"          clipPathUnits=\"objectBoundingBox\">\r\n        <circle cx=\".5\" cy=\".5\" r=\".35\" />\r\n    </clipPath>\r\n    <filter id=\"convolveMatrix2\" x=\"0\" y=\"0\" width=\"100%\" height=\"100%\">\r\n        <feConvolveMatrix\r\n                kernelMatrix=\"-1 0 0 0 0 0 0 0 1\" />\r\n    </filter>\r\n    <rect\r\n            x=\"40\"\r\n            y=\"40\"\r\n            width=\"100\"\r\n            height=\"100\"\r\n            style=\"stroke: #000000; fill: green; filter: url(#feOffset);\" />\r\n    <rect\r\n            x=\"40\"\r\n            y=\"40\"\r\n            width=\"100\"\r\n            height=\"100\"\r\n            style=\"stroke: #000000; fill: green;\" />\r\n</svg> ```\r\n```\r\n**Expected result**\r\n\r\n```\r\n<svg width=\"200\" height=\"200\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\">\r\n <filter id=\"feOffset\" x=\"-40\" y=\"-20\" width=\"100\" height=\"200\">\r\n  <feOffset in=\"SourceGraphic\" dx=\"60\" dy=\"60\"></feOffset>\r\n  <feGaussianBlur in=\"SourceGraphic\" stdDeviation=\"5\" result=\"blur2\"></feGaussianBlur>\r\n  <feMerge>\r\n   <feMergeNode in=\"blur2\"></feMergeNode>\r\n   <feMergeNode></feMergeNode>\r\n   <feMergeNode in=\"SourceGraphic\"></feMergeNode>\r\n  </feMerge>\r\n </filter> <filter id=\"noise2\" x=\"0\" y=\"0\" width=\"100%\" height=\"100%\">\r\n  <feTurbulence baseFrequency=\"0.05\"></feTurbulence>\r\n </filter> <clipPath id=\"myClip2\" clipPathUnits=\"objectBoundingBox\">\r\n  <circle cx=\".5\" cy=\".5\" r=\".35\"></circle>\r\n </clipPath> <filter id=\"convolveMatrix2\" x=\"0\" y=\"0\" width=\"100%\" height=\"100%\">\r\n  <feConvolveMatrix kernelMatrix=\"-1 0 0 0 0 0 0 0 1\"></feConvolveMatrix>\r\n </filter> <rect x=\"40\" y=\"40\" width=\"100\" height=\"100\" style=\"stroke: #000000; fill: green; filter: url(#feOffset);\"></rect> <rect x=\"40\" y=\"40\" width=\"100\" height=\"100\" style=\"stroke: #000000; fill: green;\"></rect>\r\n</svg>\r\n```\r\n**Actual result**\r\n```\r\n<svg width=\"200\" height=\"200\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\">\r\n <filter id=\"feOffset\" x=\"-40\" y=\"-20\" width=\"100\" height=\"200\">\r\n  <feOffset in=\"SourceGraphic\" dx=\"60\" dy=\"60\">\r\n   <feGaussianBlur in=\"SourceGraphic\" result=\"blur2\">\r\n    <feMerge>\r\n     <feMergeNode in=\"blur2\">\r\n      <feMergeNode>\r\n       <feMergeNode in=\"SourceGraphic\">\r\n       </feMergeNode>\r\n       <filter id=\"noise2\" x=\"0\" y=\"0\" width=\"100%\" height=\"100%\">\r\n        <feTurbulence>\r\n        </feTurbulence>\r\n        <clipPath id=\"myClip2\">\r\n         <circle cx=\".5\" cy=\".5\" r=\".35\"></circle>\r\n         <filter id=\"convolveMatrix2\" x=\"0\" y=\"0\" width=\"100%\" height=\"100%\">\r\n          <feConvolveMatrix>\r\n          </feConvolveMatrix>\r\n          <rect x=\"40\" y=\"40\" width=\"100\" height=\"100\" style=\"stroke: #000000; fill: green; filter: url(#feOffset);\"></rect>\r\n          <rect x=\"40\" y=\"40\" width=\"100\" height=\"100\" style=\"stroke: #000000; fill: green;\"></rect>\r\n         </filter>\r\n        </clipPath>\r\n       </filter>\r\n      </feMergeNode>\r\n     </feMergeNode>\r\n    </feMerge>\r\n   </feGaussianBlur>\r\n  </feOffset>\r\n </filter>\r\n</svg>\r\n```","closed_by":{"login":"jhy","id":76934,"node_id":"MDQ6VXNlcjc2OTM0","avatar_url":"https://avatars.githubusercontent.com/u/76934?v=4","gravatar_id":"","url":"https://api.github.com/users/jhy","html_url":"https://github.com/jhy","followers_url":"https://api.github.com/users/jhy/followers","following_url":"https://api.github.com/users/jhy/following{/other_user}","gists_url":"https://api.github.com/users/jhy/gists{/gist_id}","starred_url":"https://api.github.com/users/jhy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jhy/subscriptions","organizations_url":"https://api.github.com/users/jhy/orgs","repos_url":"https://api.github.com/users/jhy/repos","events_url":"https://api.github.com/users/jhy/events{/privacy}","received_events_url":"https://api.github.com/users/jhy/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/jhy/jsoup/issues/2049/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/jhy/jsoup/issues/2049/timeline","performed_via_github_app":null,"state_reason":"completed"}