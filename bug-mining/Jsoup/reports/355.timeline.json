[{"url":"https://api.github.com/repos/jhy/jsoup/issues/comments/1867108076","html_url":"https://github.com/jhy/jsoup/issues/2088#issuecomment-1867108076","issue_url":"https://api.github.com/repos/jhy/jsoup/issues/2088","id":1867108076,"node_id":"IC_kwDOAAbAPs5vSc7s","user":{"login":"jhy","id":76934,"node_id":"MDQ6VXNlcjc2OTM0","avatar_url":"https://avatars.githubusercontent.com/u/76934?v=4","gravatar_id":"","url":"https://api.github.com/users/jhy","html_url":"https://github.com/jhy","followers_url":"https://api.github.com/users/jhy/followers","following_url":"https://api.github.com/users/jhy/following{/other_user}","gists_url":"https://api.github.com/users/jhy/gists{/gist_id}","starred_url":"https://api.github.com/users/jhy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jhy/subscriptions","organizations_url":"https://api.github.com/users/jhy/orgs","repos_url":"https://api.github.com/users/jhy/repos","events_url":"https://api.github.com/users/jhy/events{/privacy}","received_events_url":"https://api.github.com/users/jhy/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2023-12-22T01:11:15Z","updated_at":"2023-12-22T01:11:15Z","body":"Hi, thanks for the report.\r\n\r\nTo confirm -- your entry point is:\r\n\r\n```java\r\n    public Elements select(Evaluator evaluator) {\r\n        return Selector.select(evaluator, this);\r\n    }\r\n```\r\n\r\nRight?\r\n\r\nI am wondering if you are using that Evaluator object across multiple concurrent threads?\r\n\r\nI think that would explain it - the Iterator is created when the Evaluator is created and then is getting hit concurrently. And then in the `.hasNext()` / `.next()` calls there is a race on the `next` object.\r\n\r\nThe evaluator is supposed to be threadsafe and other instance fields are ThreadLocals. So I missed making the Iterator a threadlocal.\r\n\r\nThe iteration method in the `:has` evaluator changed in 1.17.1 which introduced this local Iterator, so you wouldn't have seen the issue in previous versions.","author_association":"OWNER","reactions":{"url":"https://api.github.com/repos/jhy/jsoup/issues/comments/1867108076/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"jhy","id":76934,"node_id":"MDQ6VXNlcjc2OTM0","avatar_url":"https://avatars.githubusercontent.com/u/76934?v=4","gravatar_id":"","url":"https://api.github.com/users/jhy","html_url":"https://github.com/jhy","followers_url":"https://api.github.com/users/jhy/followers","following_url":"https://api.github.com/users/jhy/following{/other_user}","gists_url":"https://api.github.com/users/jhy/gists{/gist_id}","starred_url":"https://api.github.com/users/jhy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jhy/subscriptions","organizations_url":"https://api.github.com/users/jhy/orgs","repos_url":"https://api.github.com/users/jhy/repos","events_url":"https://api.github.com/users/jhy/events{/privacy}","received_events_url":"https://api.github.com/users/jhy/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":11321655939,"node_id":"AE_lADOAAbAPs56Xby8zwAAAAKi0sKD","url":"https://api.github.com/repos/jhy/jsoup/issues/events/11321655939","actor":{"login":"jhy","id":76934,"node_id":"MDQ6VXNlcjc2OTM0","avatar_url":"https://avatars.githubusercontent.com/u/76934?v=4","gravatar_id":"","url":"https://api.github.com/users/jhy","html_url":"https://github.com/jhy","followers_url":"https://api.github.com/users/jhy/followers","following_url":"https://api.github.com/users/jhy/following{/other_user}","gists_url":"https://api.github.com/users/jhy/gists{/gist_id}","starred_url":"https://api.github.com/users/jhy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jhy/subscriptions","organizations_url":"https://api.github.com/users/jhy/orgs","repos_url":"https://api.github.com/users/jhy/repos","events_url":"https://api.github.com/users/jhy/events{/privacy}","received_events_url":"https://api.github.com/users/jhy/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"assigned","commit_id":null,"commit_url":null,"created_at":"2023-12-22T01:41:58Z","assignee":{"login":"jhy","id":76934,"node_id":"MDQ6VXNlcjc2OTM0","avatar_url":"https://avatars.githubusercontent.com/u/76934?v=4","gravatar_id":"","url":"https://api.github.com/users/jhy","html_url":"https://github.com/jhy","followers_url":"https://api.github.com/users/jhy/followers","following_url":"https://api.github.com/users/jhy/following{/other_user}","gists_url":"https://api.github.com/users/jhy/gists{/gist_id}","starred_url":"https://api.github.com/users/jhy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jhy/subscriptions","organizations_url":"https://api.github.com/users/jhy/orgs","repos_url":"https://api.github.com/users/jhy/repos","events_url":"https://api.github.com/users/jhy/events{/privacy}","received_events_url":"https://api.github.com/users/jhy/received_events","type":"User","user_view_type":"public","site_admin":false},"performed_via_github_app":null},{"id":11321656109,"node_id":"LE_lADOAAbAPs56Xby8zwAAAAKi0sMt","url":"https://api.github.com/repos/jhy/jsoup/issues/events/11321656109","actor":{"login":"jhy","id":76934,"node_id":"MDQ6VXNlcjc2OTM0","avatar_url":"https://avatars.githubusercontent.com/u/76934?v=4","gravatar_id":"","url":"https://api.github.com/users/jhy","html_url":"https://github.com/jhy","followers_url":"https://api.github.com/users/jhy/followers","following_url":"https://api.github.com/users/jhy/following{/other_user}","gists_url":"https://api.github.com/users/jhy/gists{/gist_id}","starred_url":"https://api.github.com/users/jhy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jhy/subscriptions","organizations_url":"https://api.github.com/users/jhy/orgs","repos_url":"https://api.github.com/users/jhy/repos","events_url":"https://api.github.com/users/jhy/events{/privacy}","received_events_url":"https://api.github.com/users/jhy/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2023-12-22T01:42:00Z","label":{"name":"bug","color":"e10c02"},"performed_via_github_app":null},{"id":11321656252,"node_id":"MIE_lADOAAbAPs56Xby8zwAAAAKi0sO8","url":"https://api.github.com/repos/jhy/jsoup/issues/events/11321656252","actor":{"login":"jhy","id":76934,"node_id":"MDQ6VXNlcjc2OTM0","avatar_url":"https://avatars.githubusercontent.com/u/76934?v=4","gravatar_id":"","url":"https://api.github.com/users/jhy","html_url":"https://github.com/jhy","followers_url":"https://api.github.com/users/jhy/followers","following_url":"https://api.github.com/users/jhy/following{/other_user}","gists_url":"https://api.github.com/users/jhy/gists{/gist_id}","starred_url":"https://api.github.com/users/jhy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jhy/subscriptions","organizations_url":"https://api.github.com/users/jhy/orgs","repos_url":"https://api.github.com/users/jhy/repos","events_url":"https://api.github.com/users/jhy/events{/privacy}","received_events_url":"https://api.github.com/users/jhy/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"milestoned","commit_id":null,"commit_url":null,"created_at":"2023-12-22T01:42:02Z","milestone":{"title":"1.17.2"},"performed_via_github_app":null},{"id":11321681430,"node_id":"CE_lADOAAbAPs56Xby8zwAAAAKi0yYW","url":"https://api.github.com/repos/jhy/jsoup/issues/events/11321681430","actor":{"login":"jhy","id":76934,"node_id":"MDQ6VXNlcjc2OTM0","avatar_url":"https://avatars.githubusercontent.com/u/76934?v=4","gravatar_id":"","url":"https://api.github.com/users/jhy","html_url":"https://github.com/jhy","followers_url":"https://api.github.com/users/jhy/followers","following_url":"https://api.github.com/users/jhy/following{/other_user}","gists_url":"https://api.github.com/users/jhy/gists{/gist_id}","starred_url":"https://api.github.com/users/jhy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jhy/subscriptions","organizations_url":"https://api.github.com/users/jhy/orgs","repos_url":"https://api.github.com/users/jhy/repos","events_url":"https://api.github.com/users/jhy/events{/privacy}","received_events_url":"https://api.github.com/users/jhy/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"closed","commit_id":"374ded2bc3d57108fffbead844371ecc5fab63ee","commit_url":"https://api.github.com/repos/jhy/jsoup/commits/374ded2bc3d57108fffbead844371ecc5fab63ee","created_at":"2023-12-22T01:47:27Z","state_reason":null,"performed_via_github_app":null},{"id":11321682214,"node_id":"LE_lADOAAbAPs56Xby8zwAAAAKi0ykm","url":"https://api.github.com/repos/jhy/jsoup/issues/events/11321682214","actor":{"login":"jhy","id":76934,"node_id":"MDQ6VXNlcjc2OTM0","avatar_url":"https://avatars.githubusercontent.com/u/76934?v=4","gravatar_id":"","url":"https://api.github.com/users/jhy","html_url":"https://github.com/jhy","followers_url":"https://api.github.com/users/jhy/followers","following_url":"https://api.github.com/users/jhy/following{/other_user}","gists_url":"https://api.github.com/users/jhy/gists{/gist_id}","starred_url":"https://api.github.com/users/jhy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jhy/subscriptions","organizations_url":"https://api.github.com/users/jhy/orgs","repos_url":"https://api.github.com/users/jhy/repos","events_url":"https://api.github.com/users/jhy/events{/privacy}","received_events_url":"https://api.github.com/users/jhy/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2023-12-22T01:47:36Z","label":{"name":"fixed","color":"c2e0c6"},"performed_via_github_app":null},{"id":11322294931,"node_id":"REFE_lADOAAbAPs56Xby8zwAAAAKi3IKT","url":"https://api.github.com/repos/jhy/jsoup/issues/events/11322294931","actor":{"login":"jhy","id":76934,"node_id":"MDQ6VXNlcjc2OTM0","avatar_url":"https://avatars.githubusercontent.com/u/76934?v=4","gravatar_id":"","url":"https://api.github.com/users/jhy","html_url":"https://github.com/jhy","followers_url":"https://api.github.com/users/jhy/followers","following_url":"https://api.github.com/users/jhy/following{/other_user}","gists_url":"https://api.github.com/users/jhy/gists{/gist_id}","starred_url":"https://api.github.com/users/jhy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jhy/subscriptions","organizations_url":"https://api.github.com/users/jhy/orgs","repos_url":"https://api.github.com/users/jhy/repos","events_url":"https://api.github.com/users/jhy/events{/privacy}","received_events_url":"https://api.github.com/users/jhy/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"78be89abde691c066fd55a1ca24254447e21cfe6","commit_url":"https://api.github.com/repos/jhy/jsoup/commits/78be89abde691c066fd55a1ca24254447e21cfe6","created_at":"2023-12-22T03:49:30Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/jhy/jsoup/issues/comments/1867979091","html_url":"https://github.com/jhy/jsoup/issues/2088#issuecomment-1867979091","issue_url":"https://api.github.com/repos/jhy/jsoup/issues/2088","id":1867979091,"node_id":"IC_kwDOAAbAPs5vVxlT","user":{"login":"justinleinbach-wk","id":89397406,"node_id":"MDQ6VXNlcjg5Mzk3NDA2","avatar_url":"https://avatars.githubusercontent.com/u/89397406?v=4","gravatar_id":"","url":"https://api.github.com/users/justinleinbach-wk","html_url":"https://github.com/justinleinbach-wk","followers_url":"https://api.github.com/users/justinleinbach-wk/followers","following_url":"https://api.github.com/users/justinleinbach-wk/following{/other_user}","gists_url":"https://api.github.com/users/justinleinbach-wk/gists{/gist_id}","starred_url":"https://api.github.com/users/justinleinbach-wk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/justinleinbach-wk/subscriptions","organizations_url":"https://api.github.com/users/justinleinbach-wk/orgs","repos_url":"https://api.github.com/users/justinleinbach-wk/repos","events_url":"https://api.github.com/users/justinleinbach-wk/events{/privacy}","received_events_url":"https://api.github.com/users/justinleinbach-wk/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2023-12-22T18:42:16Z","updated_at":"2023-12-22T18:42:16Z","body":"> Hi, thanks for the report.\r\n> \r\n> To confirm -- your entry point is:\r\n> \r\n> ```java\r\n>     public Elements select(Evaluator evaluator) {\r\n>         return Selector.select(evaluator, this);\r\n>     }\r\n> ```\r\n> \r\n> Right?\r\n> \r\n> I am wondering if you are using that Evaluator object across multiple concurrent threads?\r\n> \r\n> I think that would explain it - the Iterator is created when the Evaluator is created and then is getting hit concurrently. And then in the `.hasNext()` / `.next()` calls there is a race on the `next` object.\r\n> \r\n> The evaluator is supposed to be threadsafe and other instance fields are ThreadLocals. So I missed making the Iterator a threadlocal.\r\n> \r\n> The iteration method in the `:has` evaluator changed in 1.17.1 which introduced this local Iterator, so you wouldn't have seen the issue in previous versions.\r\n\r\nThat's correct.  We are sharing the evaluator between threads so that seems to us like the correct solution to the issue we were seeing.  Thanks!","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/jhy/jsoup/issues/comments/1867979091/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"justinleinbach-wk","id":89397406,"node_id":"MDQ6VXNlcjg5Mzk3NDA2","avatar_url":"https://avatars.githubusercontent.com/u/89397406?v=4","gravatar_id":"","url":"https://api.github.com/users/justinleinbach-wk","html_url":"https://github.com/justinleinbach-wk","followers_url":"https://api.github.com/users/justinleinbach-wk/followers","following_url":"https://api.github.com/users/justinleinbach-wk/following{/other_user}","gists_url":"https://api.github.com/users/justinleinbach-wk/gists{/gist_id}","starred_url":"https://api.github.com/users/justinleinbach-wk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/justinleinbach-wk/subscriptions","organizations_url":"https://api.github.com/users/justinleinbach-wk/orgs","repos_url":"https://api.github.com/users/justinleinbach-wk/repos","events_url":"https://api.github.com/users/justinleinbach-wk/events{/privacy}","received_events_url":"https://api.github.com/users/justinleinbach-wk/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":11358078982,"node_id":"REFE_lADOAAbAPs56Xby8zwAAAAKk_ogG","url":"https://api.github.com/repos/jhy/jsoup/issues/events/11358078982","actor":{"login":"benkard","id":57626,"node_id":"MDQ6VXNlcjU3NjI2","avatar_url":"https://avatars.githubusercontent.com/u/57626?v=4","gravatar_id":"","url":"https://api.github.com/users/benkard","html_url":"https://github.com/benkard","followers_url":"https://api.github.com/users/benkard/followers","following_url":"https://api.github.com/users/benkard/following{/other_user}","gists_url":"https://api.github.com/users/benkard/gists{/gist_id}","starred_url":"https://api.github.com/users/benkard/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/benkard/subscriptions","organizations_url":"https://api.github.com/users/benkard/orgs","repos_url":"https://api.github.com/users/benkard/repos","events_url":"https://api.github.com/users/benkard/events{/privacy}","received_events_url":"https://api.github.com/users/benkard/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"af047ff8cf944cbc615e21f105781e48c2bb2a18","commit_url":"https://api.github.com/repos/benkard/mulkcms2/commits/af047ff8cf944cbc615e21f105781e48c2bb2a18","created_at":"2023-12-29T18:01:08Z","performed_via_github_app":null},{"id":11668497631,"node_id":"REFE_lADOAAbAPs56Xby8zwAAAAK3fyTf","url":"https://api.github.com/repos/jhy/jsoup/issues/events/11668497631","actor":{"login":"rensx","id":46339813,"node_id":"MDQ6VXNlcjQ2MzM5ODEz","avatar_url":"https://avatars.githubusercontent.com/u/46339813?v=4","gravatar_id":"","url":"https://api.github.com/users/rensx","html_url":"https://github.com/rensx","followers_url":"https://api.github.com/users/rensx/followers","following_url":"https://api.github.com/users/rensx/following{/other_user}","gists_url":"https://api.github.com/users/rensx/gists{/gist_id}","starred_url":"https://api.github.com/users/rensx/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rensx/subscriptions","organizations_url":"https://api.github.com/users/rensx/orgs","repos_url":"https://api.github.com/users/rensx/repos","events_url":"https://api.github.com/users/rensx/events{/privacy}","received_events_url":"https://api.github.com/users/rensx/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"374ded2bc3d57108fffbead844371ecc5fab63ee","commit_url":"https://api.github.com/repos/rensx/jsoup/commits/374ded2bc3d57108fffbead844371ecc5fab63ee","created_at":"2024-02-01T11:10:49Z","performed_via_github_app":null}]