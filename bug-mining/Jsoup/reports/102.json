{"url":"https://api.github.com/repos/jhy/jsoup/issues/440","repository_url":"https://api.github.com/repos/jhy/jsoup","labels_url":"https://api.github.com/repos/jhy/jsoup/issues/440/labels{/name}","comments_url":"https://api.github.com/repos/jhy/jsoup/issues/440/comments","events_url":"https://api.github.com/repos/jhy/jsoup/issues/440/events","html_url":"https://github.com/jhy/jsoup/issues/440","id":38413442,"node_id":"MDU6SXNzdWUzODQxMzQ0Mg==","number":440,"title":"Error getting baseUri thus absUrl when having \"http-equiv\" charset in the HTML","user":{"login":"wgu-zz","id":1983314,"node_id":"MDQ6VXNlcjE5ODMzMTQ=","avatar_url":"https://avatars.githubusercontent.com/u/1983314?v=4","gravatar_id":"","url":"https://api.github.com/users/wgu-zz","html_url":"https://github.com/wgu-zz","followers_url":"https://api.github.com/users/wgu-zz/followers","following_url":"https://api.github.com/users/wgu-zz/following{/other_user}","gists_url":"https://api.github.com/users/wgu-zz/gists{/gist_id}","starred_url":"https://api.github.com/users/wgu-zz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wgu-zz/subscriptions","organizations_url":"https://api.github.com/users/wgu-zz/orgs","repos_url":"https://api.github.com/users/wgu-zz/repos","events_url":"https://api.github.com/users/wgu-zz/events{/privacy}","received_events_url":"https://api.github.com/users/wgu-zz/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2014-07-22T15:47:03Z","updated_at":"2014-09-27T23:21:39Z","closed_at":"2014-09-27T23:21:20Z","author_association":"NONE","active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**The problem:** take http://muamua.co/san-pham/ve-sinh_247.html as an example. (This is from others' issue link, I cannot provide mine as it is a little disgusting ;D) The HTML source has the \"http-equiv\" meta tag and setting the charset. Calling the Jsoup.parse or Jsoup.connect.get and then Document.baseUri will not get you the right base link the \"base\" tag defined. Detailed description: https://github.com/jhy/jsoup/issues/427.\n\n**The code issue:** I am using the latest version of jsoup 1.7.3. org.jsoup.helper.DataUtil.parseByteData(), line 101:\n\n```\nif (foundCharset != null && foundCharset.length() != 0 && !foundCharset.equals(defaultCharset)) { // need to re-decode\n    ...\n    doc = null;\n}\n```\n\nAfter the 1st round of data parsing, it found the charset and then at the end it rewound the byte data of the html and set the parsed doc to null, get to re-parse the byte with the correct encoding, line 113:\n\n```\nif (doc == null) {\n    ...\n    doc = parser.parseInput(docData, baseUri);\n    doc.outputSettings().charset(charsetName);\n}\n```\n\nThe problem is, the TreeBuilder in the Parser object it used to do the 2 parse operations has not been reset for the 2nd time. org.jsoup.parser.HtmlTreeBuilder.maybeSetBaseUri(), line 152:\n\n```\nif (baseUriSetFromDoc) // only listen to the first <base href> in parse\n    return;\n```\n\nThe baseUriSetFromDoc has been set to true during the 1st parse. Therefore the value of the base meta tag has finally not been set. \n\nNot sure there will be a case of having multiple base tags in a page. ~~Even if so, that should be a source error and we could always change the behaviour to listen to the last one specified, which leads to a simple solution, removing the \"baseUriSetFromDoc\" flag.~~\nEDIT: it seems the behaviour of having multiple base tags is always listening to the first. jhy is right. Thus I think it probably needs a new Parser to do the 2nd round of parse. \n\n**The workaround:** By far how I can get it through is to get the html string of a page and use Jsoup.parse(String html). It leaves the charset detection to yourself and parse the HTML only once.\n","closed_by":{"login":"jhy","id":76934,"node_id":"MDQ6VXNlcjc2OTM0","avatar_url":"https://avatars.githubusercontent.com/u/76934?v=4","gravatar_id":"","url":"https://api.github.com/users/jhy","html_url":"https://github.com/jhy","followers_url":"https://api.github.com/users/jhy/followers","following_url":"https://api.github.com/users/jhy/following{/other_user}","gists_url":"https://api.github.com/users/jhy/gists{/gist_id}","starred_url":"https://api.github.com/users/jhy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jhy/subscriptions","organizations_url":"https://api.github.com/users/jhy/orgs","repos_url":"https://api.github.com/users/jhy/repos","events_url":"https://api.github.com/users/jhy/events{/privacy}","received_events_url":"https://api.github.com/users/jhy/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/jhy/jsoup/issues/440/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/jhy/jsoup/issues/440/timeline","performed_via_github_app":null,"state_reason":"completed"}