{"url":"https://api.github.com/repos/jhy/jsoup/issues/1851","repository_url":"https://api.github.com/repos/jhy/jsoup","labels_url":"https://api.github.com/repos/jhy/jsoup/issues/1851/labels{/name}","comments_url":"https://api.github.com/repos/jhy/jsoup/issues/1851/comments","events_url":"https://api.github.com/repos/jhy/jsoup/issues/1851/events","html_url":"https://github.com/jhy/jsoup/issues/1851","id":1422115094,"node_id":"I_kwDOAAbAPs5Uw8EW","number":1851,"title":"Nested body and html tags trip jsoup into closing the stack too early","user":{"login":"0xabadea","id":1133622,"node_id":"MDQ6VXNlcjExMzM2MjI=","avatar_url":"https://avatars.githubusercontent.com/u/1133622?v=4","gravatar_id":"","url":"https://api.github.com/users/0xabadea","html_url":"https://github.com/0xabadea","followers_url":"https://api.github.com/users/0xabadea/followers","following_url":"https://api.github.com/users/0xabadea/following{/other_user}","gists_url":"https://api.github.com/users/0xabadea/gists{/gist_id}","starred_url":"https://api.github.com/users/0xabadea/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/0xabadea/subscriptions","organizations_url":"https://api.github.com/users/0xabadea/orgs","repos_url":"https://api.github.com/users/0xabadea/repos","events_url":"https://api.github.com/users/0xabadea/events{/privacy}","received_events_url":"https://api.github.com/users/0xabadea/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":623963149,"node_id":"MDU6TGFiZWw2MjM5NjMxNDk=","url":"https://api.github.com/repos/jhy/jsoup/labels/fixed","name":"fixed","color":"7BE482","default":false,"description":"An {bug|improvement} that has been {fixed|implemented}"}],"state":"closed","locked":false,"assignee":{"login":"jhy","id":76934,"node_id":"MDQ6VXNlcjc2OTM0","avatar_url":"https://avatars.githubusercontent.com/u/76934?v=4","gravatar_id":"","url":"https://api.github.com/users/jhy","html_url":"https://github.com/jhy","followers_url":"https://api.github.com/users/jhy/followers","following_url":"https://api.github.com/users/jhy/following{/other_user}","gists_url":"https://api.github.com/users/jhy/gists{/gist_id}","starred_url":"https://api.github.com/users/jhy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jhy/subscriptions","organizations_url":"https://api.github.com/users/jhy/orgs","repos_url":"https://api.github.com/users/jhy/repos","events_url":"https://api.github.com/users/jhy/events{/privacy}","received_events_url":"https://api.github.com/users/jhy/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"jhy","id":76934,"node_id":"MDQ6VXNlcjc2OTM0","avatar_url":"https://avatars.githubusercontent.com/u/76934?v=4","gravatar_id":"","url":"https://api.github.com/users/jhy","html_url":"https://github.com/jhy","followers_url":"https://api.github.com/users/jhy/followers","following_url":"https://api.github.com/users/jhy/following{/other_user}","gists_url":"https://api.github.com/users/jhy/gists{/gist_id}","starred_url":"https://api.github.com/users/jhy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jhy/subscriptions","organizations_url":"https://api.github.com/users/jhy/orgs","repos_url":"https://api.github.com/users/jhy/repos","events_url":"https://api.github.com/users/jhy/events{/privacy}","received_events_url":"https://api.github.com/users/jhy/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/jhy/jsoup/milestones/25","html_url":"https://github.com/jhy/jsoup/milestone/25","labels_url":"https://api.github.com/repos/jhy/jsoup/milestones/25/labels","id":8941164,"node_id":"MI_kwDOAAbAPs4AiG5s","number":25,"title":"1.16.1","description":"","creator":{"login":"jhy","id":76934,"node_id":"MDQ6VXNlcjc2OTM0","avatar_url":"https://avatars.githubusercontent.com/u/76934?v=4","gravatar_id":"","url":"https://api.github.com/users/jhy","html_url":"https://github.com/jhy","followers_url":"https://api.github.com/users/jhy/followers","following_url":"https://api.github.com/users/jhy/following{/other_user}","gists_url":"https://api.github.com/users/jhy/gists{/gist_id}","starred_url":"https://api.github.com/users/jhy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jhy/subscriptions","organizations_url":"https://api.github.com/users/jhy/orgs","repos_url":"https://api.github.com/users/jhy/repos","events_url":"https://api.github.com/users/jhy/events{/privacy}","received_events_url":"https://api.github.com/users/jhy/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":14,"state":"closed","created_at":"2023-01-18T23:14:56Z","updated_at":"2023-05-06T02:28:37Z","due_on":"2023-04-23T07:00:00Z","closed_at":"2023-05-06T02:27:02Z"},"comments":1,"created_at":"2022-10-25T08:59:41Z","updated_at":"2023-03-27T04:54:34Z","closed_at":"2023-03-27T04:54:12Z","author_association":"NONE","active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"For the attached [eisenachonline-de.html.gz](https://github.com/jhy/jsoup/files/9858757/eisenachonline-de.html.gz), jsoup 1.15.3 returns a tree different from that shown by Firefox and Chrome in their dev tools. There are nested body and especially html tags that seem to trip up the parser to close the stack prematurely.\r\n\r\nThe relevant HTML section looks like this:\r\n\r\n```\r\n<header class=\"entry-header\">\r\n   <h1 class=\"entry-title\">Unfall zwischen PKW und Fußgänger</h1>\r\n   <div class=\"entry-meta\">...</div>\r\n   <figure class=\"post-thumbnail\"><img ... /><figcaption>\r\n       <?xml encoding=\"utf-8\" ?><html><body><p>Bildquelle: &copy; Comofoto &ndash; stock.adobe.com<br>\r\n           Symbolbild</p>\r\n       </body></html>\r\n   </figcaption></figure>\r\n   <div class=\"entry-date\">\r\n       <time datetime=\"2022-10-20 14:24\">20. Oktober 2022</time>\r\n   </div>    </header>\r\n```\r\n\r\nFor this HTML, the following code:\r\n\r\n```\r\n    public static void main(String[] args) throws IOException {\r\n        Document doc = Jsoup.parse(new File(\"eisenachonline-de.html\"));\r\n        System.out.println(doc.selectFirst(\"header[class=entry-header]\").selectFirst(\"div[class=entry-date]\"));\r\n    }\r\n```\r\n\r\nshould print\r\n\r\n```\r\n<div class=\"entry-date\"><time datetime=\"2022-10-20 14:24\">20. Oktober 2022</time>\r\n</div>\r\n```\r\n\r\nbut prints null instead. The `entry-date` div is present in the parsed document, but it is a child of the `body` element.\r\n\r\nThere seems to be a deviation from the HTML spec in the jsoup implementation. In the `AfterBody` state, when processing an `html` end tag, jsoup pops the stack to close. In the \"after body\" insertion mode, the HTML spec only says to switch to the \"after after body\" mode, but it doesn't ask to close the stack. So it appears to me the stack is closed too early.","closed_by":{"login":"jhy","id":76934,"node_id":"MDQ6VXNlcjc2OTM0","avatar_url":"https://avatars.githubusercontent.com/u/76934?v=4","gravatar_id":"","url":"https://api.github.com/users/jhy","html_url":"https://github.com/jhy","followers_url":"https://api.github.com/users/jhy/followers","following_url":"https://api.github.com/users/jhy/following{/other_user}","gists_url":"https://api.github.com/users/jhy/gists{/gist_id}","starred_url":"https://api.github.com/users/jhy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jhy/subscriptions","organizations_url":"https://api.github.com/users/jhy/orgs","repos_url":"https://api.github.com/users/jhy/repos","events_url":"https://api.github.com/users/jhy/events{/privacy}","received_events_url":"https://api.github.com/users/jhy/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/jhy/jsoup/issues/1851/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/jhy/jsoup/issues/1851/timeline","performed_via_github_app":null,"state_reason":"completed"}