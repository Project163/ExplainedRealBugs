{"url":"https://api.github.com/repos/remix-run/react-router/issues/6387","repository_url":"https://api.github.com/repos/remix-run/react-router","labels_url":"https://api.github.com/repos/remix-run/react-router/issues/6387/labels{/name}","comments_url":"https://api.github.com/repos/remix-run/react-router/issues/6387/comments","events_url":"https://api.github.com/repos/remix-run/react-router/issues/6387/events","html_url":"https://github.com/remix-run/react-router/issues/6387","id":368845086,"node_id":"MDU6SXNzdWUzNjg4NDUwODY=","number":6387,"title":"Build products and package structure","user":{"login":"mjackson","id":92839,"node_id":"MDQ6VXNlcjkyODM5","avatar_url":"https://avatars.githubusercontent.com/u/92839?v=4","gravatar_id":"","url":"https://api.github.com/users/mjackson","html_url":"https://github.com/mjackson","followers_url":"https://api.github.com/users/mjackson/followers","following_url":"https://api.github.com/users/mjackson/following{/other_user}","gists_url":"https://api.github.com/users/mjackson/gists{/gist_id}","starred_url":"https://api.github.com/users/mjackson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mjackson/subscriptions","organizations_url":"https://api.github.com/users/mjackson/orgs","repos_url":"https://api.github.com/users/mjackson/repos","events_url":"https://api.github.com/users/mjackson/events{/privacy}","received_events_url":"https://api.github.com/users/mjackson/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2018-10-10T20:44:01Z","updated_at":"2018-12-11T22:55:43Z","closed_at":"2018-10-12T21:13:30Z","author_association":"MEMBER","type":null,"active_lock_reason":"resolved","sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"In the current 4.4 beta, we provide 4 different builds of all our code in the `react-router`, `react-router-dom`, and `react-router-config` packages:\r\n\r\n- A development CommonJS build in separate files in the package root\r\n- A development ES modules build in separate files in the `es` folder in the package root\r\n- A development UMD bundle in the `umd` folder in the package root\r\n- A production UMD bundle in the `umd` folder in the package root\r\n\r\n## The Proposal\r\n\r\nThere are 2 things I'd like to change:\r\n\r\n- We should provide production versions (w/out warnings) of our CJS and ESM builds. This is honestly just an oversight in our current build strategy.\r\n- We should stop providing separate files and deprecate stuff like `require('react-router/BrowserRouter')`. The separate files were supposed to provide a way for users to include only a portion of the library w/out including the whole thing (i.e. \"poor man's\" tree shaking). We actually take advantage of this ourselves in a few builds (e.g. [the CJS version of `react-router-dom`](https://github.com/ReactTraining/react-router/blob/master/packages/react-router-dom/modules/.babelrc#L10-L17)) to include only the modules from `react-router` that we need using `babel-plugin-transform-imports`. However, tools like rollup and webpack 4 have made it possible to do real tree shaking, so I'd prefer to tell people to update their build tooling instead of providing a bunch of separate files. This would also let us remove `babel-plugin-transform-imports` and simplify some of our tooling.\r\n\r\n## The Plan\r\n\r\n4.4: Use rollup for all our builds, including CJS and ESM. Builds should be available in one of 3 folders that denotes the type of the build: `cjs`, `esm`, or `umd`. So e.g. we should have the following files for the `react-router` package:\r\n\r\n- `cjs/react-router.js` (new)\r\n- `cjs/react-router.min.js` (new)\r\n- `esm/react-router.js` (new)\r\n- `esm/react-router.min.js` (new)\r\n- `umd/react-router.js`\r\n- `umd/react-router.min.js`\r\n\r\nTo help users with the migration, we can keep separate files in place that print warnings telling them to `require`/`import` the main package instead of that individual file. For bundlers using the CJS/ESM builds, we can provide a small stub file as the entry point that exports either the development or production build depending on the value of `process.env.NODE_ENV`. For example, the CJS entry point for `react-router` would look something like this:\r\n\r\n```js\r\nif (process.env.NODE_ENV === 'production') {\r\n  module.exports = require('./cjs/react-router.min.js');\r\n} else {\r\n  module.exports = require('./cjs/react-router.js');\r\n}\r\n```\r\n\r\nUsers can set `process.env.NODE_ENV` in their bundler to opt in to one build or the other, same as they do when bundling React itself.\r\n\r\n5.0: Remove the stubs with warnings and stop supporting old `require`/`import` from separate files.\r\n\r\nThoughts and/or concerns? /cc @timdorr @pshrmn ","closed_by":{"login":"mjackson","id":92839,"node_id":"MDQ6VXNlcjkyODM5","avatar_url":"https://avatars.githubusercontent.com/u/92839?v=4","gravatar_id":"","url":"https://api.github.com/users/mjackson","html_url":"https://github.com/mjackson","followers_url":"https://api.github.com/users/mjackson/followers","following_url":"https://api.github.com/users/mjackson/following{/other_user}","gists_url":"https://api.github.com/users/mjackson/gists{/gist_id}","starred_url":"https://api.github.com/users/mjackson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mjackson/subscriptions","organizations_url":"https://api.github.com/users/mjackson/orgs","repos_url":"https://api.github.com/users/mjackson/repos","events_url":"https://api.github.com/users/mjackson/events{/privacy}","received_events_url":"https://api.github.com/users/mjackson/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/remix-run/react-router/issues/6387/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/remix-run/react-router/issues/6387/timeline","performed_via_github_app":null,"state_reason":"completed"}