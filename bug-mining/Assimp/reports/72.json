{"url":"https://api.github.com/repos/assimp/assimp/issues/2714","repository_url":"https://api.github.com/repos/assimp/assimp","labels_url":"https://api.github.com/repos/assimp/assimp/issues/2714/labels{/name}","comments_url":"https://api.github.com/repos/assimp/assimp/issues/2714/comments","events_url":"https://api.github.com/repos/assimp/assimp/issues/2714/events","html_url":"https://github.com/assimp/assimp/issues/2714","id":507594199,"node_id":"MDU6SXNzdWU1MDc1OTQxOTk=","number":2714,"title":"Double free of embedded texture memory in glTF exporter","user":{"login":"ardenpm","id":5742686,"node_id":"MDQ6VXNlcjU3NDI2ODY=","avatar_url":"https://avatars.githubusercontent.com/u/5742686?v=4","gravatar_id":"","url":"https://api.github.com/users/ardenpm","html_url":"https://github.com/ardenpm","followers_url":"https://api.github.com/users/ardenpm/followers","following_url":"https://api.github.com/users/ardenpm/following{/other_user}","gists_url":"https://api.github.com/users/ardenpm/gists{/gist_id}","starred_url":"https://api.github.com/users/ardenpm/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ardenpm/subscriptions","organizations_url":"https://api.github.com/users/ardenpm/orgs","repos_url":"https://api.github.com/users/ardenpm/repos","events_url":"https://api.github.com/users/ardenpm/events{/privacy}","received_events_url":"https://api.github.com/users/ardenpm/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":831073868,"node_id":"MDU6TGFiZWw4MzEwNzM4Njg=","url":"https://api.github.com/repos/assimp/assimp/labels/glTF2.0","name":"glTF2.0","color":"1d76db","default":false,"description":"Bugs related to the glTF2.0 format"},{"id":2953329571,"node_id":"MDU6TGFiZWwyOTUzMzI5NTcx","url":"https://api.github.com/repos/assimp/assimp/labels/Export","name":"Export","color":"0e8a16","default":false,"description":"Bugs / Feature requests related to export."}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2019-10-16T03:42:05Z","updated_at":"2025-04-16T21:42:05Z","closed_at":"2019-11-16T21:20:44Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"The use case is as follows, create an aiScene with a material that references an embedded texture which is an encoded image (e.g., PNG). So the aiTexture has mHeight set to 0 and mWidth set to the number of bytes in the pcData array. Export the scene to glTF 2.0, the scene will export correctly however Assimp will crash when the exporter destructor is called, which in turn calls the destructor for the items in mTextures in aiTexture.\r\n\r\nThe issue appears to be due to the use of std::unique_ptr in the glTF2::Image classes mData member and the fact that the raw aiTexture::pcData memory is passed as a pointer in glTF2Exporter::GetMatTex instead of creating a copy of the data.\r\n\r\n```\r\nuint8_t* data = reinterpret_cast<uint8_t*>(tex->pcData);\r\ntexture->source->SetData(data, tex->mWidth, *mAsset);\r\n```\r\n\r\nWhen the glTFExporter destructor is called and the Image is destroyed the memory is released. The same memory then attempts to be released again by the destructor for aiTexture which fails since the control of the lifetime was given to the unique pointer in the Image object, which destroyed it as soon as it went out of scope.\r\n\r\nWith this issue it seems to be impossible to export embedded textures to a glTF without crashing after the export. The glTF is correctly written with the texture but Assimp then causes a crash afterwards due to the above issue.\r\n\r\nThe suggested fix would be to copy the contents of pcData into the glTF Image asset instead of referencing it by its pointer.","closed_by":{"login":"kimkulling","id":2323156,"node_id":"MDQ6VXNlcjIzMjMxNTY=","avatar_url":"https://avatars.githubusercontent.com/u/2323156?v=4","gravatar_id":"","url":"https://api.github.com/users/kimkulling","html_url":"https://github.com/kimkulling","followers_url":"https://api.github.com/users/kimkulling/followers","following_url":"https://api.github.com/users/kimkulling/following{/other_user}","gists_url":"https://api.github.com/users/kimkulling/gists{/gist_id}","starred_url":"https://api.github.com/users/kimkulling/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kimkulling/subscriptions","organizations_url":"https://api.github.com/users/kimkulling/orgs","repos_url":"https://api.github.com/users/kimkulling/repos","events_url":"https://api.github.com/users/kimkulling/events{/privacy}","received_events_url":"https://api.github.com/users/kimkulling/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/assimp/assimp/issues/2714/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/assimp/assimp/issues/2714/timeline","performed_via_github_app":null,"state_reason":"completed"}