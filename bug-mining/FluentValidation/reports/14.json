{"url":"https://api.github.com/repos/FluentValidation/FluentValidation/issues/2097","repository_url":"https://api.github.com/repos/FluentValidation/FluentValidation","labels_url":"https://api.github.com/repos/FluentValidation/FluentValidation/issues/2097/labels{/name}","comments_url":"https://api.github.com/repos/FluentValidation/FluentValidation/issues/2097/comments","events_url":"https://api.github.com/repos/FluentValidation/FluentValidation/issues/2097/events","html_url":"https://github.com/FluentValidation/FluentValidation/issues/2097","id":1647999318,"node_id":"I_kwDOAAbGOs5iOnlW","number":2097,"title":"Nested RuleForEach and ChildRules don't work in RuleSets","user":{"login":"UniMichael","id":127410138,"node_id":"U_kgDOB5gf2g","avatar_url":"https://avatars.githubusercontent.com/u/127410138?v=4","gravatar_id":"","url":"https://api.github.com/users/UniMichael","html_url":"https://github.com/UniMichael","followers_url":"https://api.github.com/users/UniMichael/followers","following_url":"https://api.github.com/users/UniMichael/following{/other_user}","gists_url":"https://api.github.com/users/UniMichael/gists{/gist_id}","starred_url":"https://api.github.com/users/UniMichael/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/UniMichael/subscriptions","organizations_url":"https://api.github.com/users/UniMichael/orgs","repos_url":"https://api.github.com/users/UniMichael/repos","events_url":"https://api.github.com/users/UniMichael/events{/privacy}","received_events_url":"https://api.github.com/users/UniMichael/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":true,"assignee":{"login":"JeremySkinner","id":90130,"node_id":"MDQ6VXNlcjkwMTMw","avatar_url":"https://avatars.githubusercontent.com/u/90130?v=4","gravatar_id":"","url":"https://api.github.com/users/JeremySkinner","html_url":"https://github.com/JeremySkinner","followers_url":"https://api.github.com/users/JeremySkinner/followers","following_url":"https://api.github.com/users/JeremySkinner/following{/other_user}","gists_url":"https://api.github.com/users/JeremySkinner/gists{/gist_id}","starred_url":"https://api.github.com/users/JeremySkinner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JeremySkinner/subscriptions","organizations_url":"https://api.github.com/users/JeremySkinner/orgs","repos_url":"https://api.github.com/users/JeremySkinner/repos","events_url":"https://api.github.com/users/JeremySkinner/events{/privacy}","received_events_url":"https://api.github.com/users/JeremySkinner/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"JeremySkinner","id":90130,"node_id":"MDQ6VXNlcjkwMTMw","avatar_url":"https://avatars.githubusercontent.com/u/90130?v=4","gravatar_id":"","url":"https://api.github.com/users/JeremySkinner","html_url":"https://github.com/JeremySkinner","followers_url":"https://api.github.com/users/JeremySkinner/followers","following_url":"https://api.github.com/users/JeremySkinner/following{/other_user}","gists_url":"https://api.github.com/users/JeremySkinner/gists{/gist_id}","starred_url":"https://api.github.com/users/JeremySkinner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JeremySkinner/subscriptions","organizations_url":"https://api.github.com/users/JeremySkinner/orgs","repos_url":"https://api.github.com/users/JeremySkinner/repos","events_url":"https://api.github.com/users/JeremySkinner/events{/privacy}","received_events_url":"https://api.github.com/users/JeremySkinner/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":2,"created_at":"2023-03-30T17:08:42Z","updated_at":"2023-04-22T00:09:51Z","closed_at":"2023-04-07T14:52:34Z","author_association":"NONE","type":null,"active_lock_reason":"resolved","sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### FluentValidation version\r\n\r\n11.5.1\r\n\r\n### ASP.NET version\r\n\r\n_No response_\r\n\r\n### Summary\r\n\r\nWe've been working on migrating a project that was previously using FluentValidation 10.3.0 to the newest version. In this project, we have a lot of rulesets that run rules on deeply-nested complex objects. After migrating to 11.5.1, some of our validation has stopped working. We've narrowed it down to an issue with nested complex objects in a nested `RuleForEach` and `ChildRules` chain.\r\n\r\nLooking at the changelogs, we haven't been able to find any mention of whether this is intentional or not, and most web searches lead to issues with `SetValidator()`, which isn't something we're using in our project. Porting the current rules over to individual validators would be very time consuming, so we'd like to avoid it for now, if possible.\r\n\r\nOur problem is as follows: \r\n\r\nGiven classes with lists of complex objects that have their own lists of complex objects (and so on), nested usage of `RuleForEach` and `ChildRules` breaks when inside a `RuleSet`, but works otherwise. \r\n\r\nAdditionally, adding the `\"default\"` ruleset rule to the validator seems to run these child rules, even if they are only declared in a ruleset. Note that this doesn't fix our issue, because it would run all rules that are in the \"default\" ruleset as well, which is something we don't want.\r\n\r\nI expect that this behavior should either work in rulesets, or not work outside of them. It shouldn't work in one case and not in the other.\r\n\r\nI am unsure if it supposed to work in the first place, and that we've been relying on a bug to get our current validation working.\r\n\r\n### Steps to Reproduce\r\n\r\n## Code sample\r\n\r\nBelow is a trivial code example that showcases the problem:\r\n\r\n```cs\r\npublic static class Program\r\n{\r\n    public class Foo\r\n    {\r\n        public List<string> Names { get; set; } = new();\r\n    }\r\n\r\n    public class Bar\r\n    {\r\n        public List<Foo> Foos { get; set; } = new();\r\n    }\r\n\r\n    public class Baz\r\n    {\r\n        public List<Bar> Bars { get; set; } = new();\r\n    }\r\n\r\n    public class WorkingValidator : AbstractValidator<Baz>\r\n    {\r\n        public WorkingValidator()\r\n        {\r\n            RuleForEach(baz => baz.Bars)\r\n                .ChildRules(barRule => barRule.RuleForEach(bar => bar.Foos)\r\n                    .ChildRules(fooRule => fooRule.RuleForEach(foo => foo.Names)\r\n                        .ChildRules(name => name.RuleFor(n => n)\r\n                            .NotEmpty()\r\n                            .WithMessage(\"Name is required\"))));\r\n        }\r\n    }\r\n\r\n    public class BrokenValidator : AbstractValidator<Baz>\r\n    {\r\n        public const string RuleSetName = \"Broken-Ruleset-Name\";\r\n        \r\n        public BrokenValidator()\r\n        {\r\n            RuleSet(RuleSetName, () =>\r\n            {\r\n                RuleForEach(baz => baz.Bars)\r\n                    .ChildRules(barRule => barRule.RuleForEach(bar => bar.Foos)\r\n                        .ChildRules(fooRule => fooRule.RuleForEach(foo => foo.Names)\r\n                            .ChildRules(name => name.RuleFor(n => n)\r\n                                .NotEmpty()\r\n                                .WithMessage(\"Name is required\"))));\r\n            });\r\n        }\r\n    }\r\n\r\n    public static void Main()\r\n    {\r\n        var foos = new List<Foo>()\r\n        {\r\n            new() { Names = { \"Bob\" }},\r\n            new() { Names = { string.Empty }},\r\n        };\r\n\r\n        var bars = new List<Bar>()\r\n        {\r\n            new(),\r\n            new() { Foos = foos }\r\n        };\r\n\r\n        var baz = new Baz()\r\n        {\r\n            Bars = bars\r\n        };\r\n\r\n        var workingValidator = new WorkingValidator();\r\n        var workingResult = workingValidator.Validate(baz);\r\n        \r\n        if (workingResult.IsValid)\r\n        {\r\n            Console.WriteLine(\"WorkingValidator - Valid\");\r\n        }\r\n        else\r\n        {\r\n            Console.WriteLine(\"WorkingValidator - Invalid\");\r\n            foreach (var error in workingResult.Errors)\r\n            {\r\n                Console.WriteLine(error.ErrorMessage);\r\n            }\r\n        }\r\n        \r\n        var brokenValidator = new BrokenValidator();\r\n        var brokenResult = brokenValidator.Validate(baz, options => options.IncludeRuleSets(BrokenValidator.RuleSetName));\r\n        \r\n        if (brokenResult.IsValid)\r\n        {\r\n            Console.WriteLine(\"BrokenValidator - Valid\");\r\n        }\r\n        else\r\n        {\r\n            Console.WriteLine(\"BrokenValidator - Invalid\");\r\n            foreach (var error in brokenResult.Errors)\r\n            {\r\n                Console.WriteLine(error.ErrorMessage);\r\n            }\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n## Expected output (FluentValidation 11.5.1)\r\n\r\nI would expect the following output:\r\n\r\n```\r\nWorkingValidator - Invalid\r\nName is required\r\nBrokenValidator - Invalid\r\nName is required\r\n```\r\n\r\nOr, in the events that this behavior isn't supported:\r\n\r\n```\r\nWorkingValidator - Valid\r\nBrokenValidator - Valid\r\n```\r\n\r\n## Actual output (FluentValidation 11.5.1)\r\n\r\n```\r\nWorkingValidator - Invalid\r\nName is required\r\nBrokenValidator - Valid\r\n```\r\n\r\n## Original output (FluentValidation 10.3.0)\r\n\r\n```\r\nWorkingValidator - Invalid\r\nName is required\r\nBrokenValidator - Invalid\r\nName is required\r\n```","closed_by":{"login":"JeremySkinner","id":90130,"node_id":"MDQ6VXNlcjkwMTMw","avatar_url":"https://avatars.githubusercontent.com/u/90130?v=4","gravatar_id":"","url":"https://api.github.com/users/JeremySkinner","html_url":"https://github.com/JeremySkinner","followers_url":"https://api.github.com/users/JeremySkinner/followers","following_url":"https://api.github.com/users/JeremySkinner/following{/other_user}","gists_url":"https://api.github.com/users/JeremySkinner/gists{/gist_id}","starred_url":"https://api.github.com/users/JeremySkinner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JeremySkinner/subscriptions","organizations_url":"https://api.github.com/users/JeremySkinner/orgs","repos_url":"https://api.github.com/users/JeremySkinner/repos","events_url":"https://api.github.com/users/JeremySkinner/events{/privacy}","received_events_url":"https://api.github.com/users/JeremySkinner/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/FluentValidation/FluentValidation/issues/2097/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/FluentValidation/FluentValidation/issues/2097/timeline","performed_via_github_app":null,"state_reason":"completed"}