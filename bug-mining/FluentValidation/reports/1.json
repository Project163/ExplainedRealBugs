{"url":"https://api.github.com/repos/FluentValidation/FluentValidation/issues/66","repository_url":"https://api.github.com/repos/FluentValidation/FluentValidation","labels_url":"https://api.github.com/repos/FluentValidation/FluentValidation/issues/66/labels{/name}","comments_url":"https://api.github.com/repos/FluentValidation/FluentValidation/issues/66/comments","events_url":"https://api.github.com/repos/FluentValidation/FluentValidation/issues/66/events","html_url":"https://github.com/FluentValidation/FluentValidation/issues/66","id":76768927,"node_id":"MDU6SXNzdWU3Njc2ODkyNw==","number":66,"title":"DelegateValidator causes a deadlock when running an async function synchronously.","user":{"login":"acollard","id":2044172,"node_id":"MDQ6VXNlcjIwNDQxNzI=","avatar_url":"https://avatars.githubusercontent.com/u/2044172?v=4","gravatar_id":"","url":"https://api.github.com/users/acollard","html_url":"https://github.com/acollard","followers_url":"https://api.github.com/users/acollard/followers","following_url":"https://api.github.com/users/acollard/following{/other_user}","gists_url":"https://api.github.com/users/acollard/gists{/gist_id}","starred_url":"https://api.github.com/users/acollard/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/acollard/subscriptions","organizations_url":"https://api.github.com/users/acollard/orgs","repos_url":"https://api.github.com/users/acollard/repos","events_url":"https://api.github.com/users/acollard/events{/privacy}","received_events_url":"https://api.github.com/users/acollard/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2015-05-15T15:49:48Z","updated_at":"2018-08-21T08:44:09Z","closed_at":"2015-06-01T15:57:03Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"The problem is the DelegateValidator is causing the current thread to wait for the result of the async task. This task may require the thread to be available so it can be posted back to. Both EF and ASP.Net using this technique of posting back to the original thread and if you are waiting on that thread you will get a deadlock.\n\n``` c#\npublic class DelegateValidator<T> : IValidationRule {\n        ...\n        public DelegateValidator(Func<T, ValidationContext<T>, Task<IEnumerable<ValidationFailure>>> asyncFunc) {\n            this.asyncFunc = asyncFunc;\n            func = (x, ctx) => this.asyncFunc(x, ctx).Result;\n        }\n       ...\n}\n```\n\nStephen Toub has a good post on making async calls synchronous. Basically he says try not to do it. But if you have to then run the task from a new thread (which you are doing) or use a message loop.\nhttp://blogs.msdn.com/b/pfxteam/archive/2012/04/13/10293638.aspx.\n\nThe best option in this scenario is to run the task on a new threadpool thread then wait on that.\n\n``` c#\n   func = (x, ctx) => Task.Run(()=> this.asyncFunc(x, ctx)).Result;\n```\n\nIn reality users who use Async validation should just use ValidateAsync so we never have to switch to synchronous, but consumers of the validator may not always be aware of how the rules are configured.\n","closed_by":{"login":"JeremySkinner","id":90130,"node_id":"MDQ6VXNlcjkwMTMw","avatar_url":"https://avatars.githubusercontent.com/u/90130?v=4","gravatar_id":"","url":"https://api.github.com/users/JeremySkinner","html_url":"https://github.com/JeremySkinner","followers_url":"https://api.github.com/users/JeremySkinner/followers","following_url":"https://api.github.com/users/JeremySkinner/following{/other_user}","gists_url":"https://api.github.com/users/JeremySkinner/gists{/gist_id}","starred_url":"https://api.github.com/users/JeremySkinner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JeremySkinner/subscriptions","organizations_url":"https://api.github.com/users/JeremySkinner/orgs","repos_url":"https://api.github.com/users/JeremySkinner/repos","events_url":"https://api.github.com/users/JeremySkinner/events{/privacy}","received_events_url":"https://api.github.com/users/JeremySkinner/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/FluentValidation/FluentValidation/issues/66/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/FluentValidation/FluentValidation/issues/66/timeline","performed_via_github_app":null,"state_reason":"completed"}