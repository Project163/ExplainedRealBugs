{"url":"https://api.github.com/repos/typeorm/typeorm/issues/9318","repository_url":"https://api.github.com/repos/typeorm/typeorm","labels_url":"https://api.github.com/repos/typeorm/typeorm/issues/9318/labels{/name}","comments_url":"https://api.github.com/repos/typeorm/typeorm/issues/9318/comments","events_url":"https://api.github.com/repos/typeorm/typeorm/issues/9318/events","html_url":"https://github.com/typeorm/typeorm/issues/9318","id":1349468261,"node_id":"I_kwDOAyVBJc5Qb0Bl","number":9318,"title":"Postgres version command incompatible with Redshift","user":{"login":"CaptainCrucial","id":39619545,"node_id":"MDQ6VXNlcjM5NjE5NTQ1","avatar_url":"https://avatars.githubusercontent.com/u/39619545?v=4","gravatar_id":"","url":"https://api.github.com/users/CaptainCrucial","html_url":"https://github.com/CaptainCrucial","followers_url":"https://api.github.com/users/CaptainCrucial/followers","following_url":"https://api.github.com/users/CaptainCrucial/following{/other_user}","gists_url":"https://api.github.com/users/CaptainCrucial/gists{/gist_id}","starred_url":"https://api.github.com/users/CaptainCrucial/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/CaptainCrucial/subscriptions","organizations_url":"https://api.github.com/users/CaptainCrucial/orgs","repos_url":"https://api.github.com/users/CaptainCrucial/repos","events_url":"https://api.github.com/users/CaptainCrucial/events{/privacy}","received_events_url":"https://api.github.com/users/CaptainCrucial/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-08-24T13:39:33Z","updated_at":"2022-08-25T12:40:13Z","closed_at":"2022-08-25T12:40:13Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"When connecting using the Postgres driver, the afterConnect method is running the SQL`SHOW server_version;` as part of feature support detection.\r\n\r\nThis command works on postgres and cockroachdb, but is incompatible with the redshift database.\r\n\r\nThis command could be adjusted to use the `SELECT version();` command which is supported across all of these database types.\r\n\r\nI've patched this command locally and successfully connected and read data using typeorm:\r\n\r\n```patch\r\ndiff --git a/src/driver/postgres/PostgresDriver.ts b/src/driver/postgres/PostgresDriver.ts\r\nindex 92142ba53..0dfad6d7a 100644\r\n--- a/src/driver/postgres/PostgresDriver.ts\r\n+++ b/src/driver/postgres/PostgresDriver.ts\r\n@@ -375,13 +375,16 @@ export class PostgresDriver implements Driver {\r\n \r\n         const results = (await this.executeQuery(\r\n             connection,\r\n-            \"SHOW server_version;\",\r\n+            \"SELECT version();\",\r\n         )) as {\r\n             rows: {\r\n-                server_version: string\r\n+                version: string\r\n             }[]\r\n         }\r\n-        const versionString = results.rows[0].server_version\r\n+        const versionString = results.rows[0].version.replace(\r\n+            /^PostgreSQL ([\\d\\.]+) .*$/,\r\n+            \"$1\",\r\n+        )\r\n         this.isGeneratedColumnsSupported = VersionUtils.isGreaterOrEqual(\r\n             versionString,\r\n             \"12.0\",\r\ndiff --git a/src/driver/postgres/PostgresQueryRunner.ts b/src/driver/postgres/PostgresQueryRunner.ts\r\nindex e8aaa3eaa..4a5c84655 100644\r\n--- a/src/driver/postgres/PostgresQueryRunner.ts\r\n+++ b/src/driver/postgres/PostgresQueryRunner.ts\r\n@@ -3989,8 +3989,8 @@ export class PostgresQueryRunner\r\n      * Loads Postgres version.\r\n      */\r\n     protected async getVersion(): Promise<string> {\r\n-        const result = await this.query(`SHOW SERVER_VERSION`)\r\n-        return result[0][\"server_version\"]\r\n+        const result = await this.query(`SELECT version()`)\r\n+        return result[0][\"version\"].replace(/^PostgreSQL ([\\d\\.]+) .*$/, \"$1\")\r\n     }\r\n \r\n     /**\r\ndiff --git a/test/functional/cube/postgres/cube-postgres.ts b/test/functional/cube/postgres/cube-postgres.ts\r\nindex f70baf10b..d5e81a68c 100644\r\n--- a/test/functional/cube/postgres/cube-postgres.ts\r\n+++ b/test/functional/cube/postgres/cube-postgres.ts\r\n@@ -109,10 +109,11 @@ describe(\"cube-postgres\", () => {\r\n                 // Get Postgres version because zero-length cubes are not legal\r\n                 // on all Postgres versions. Zero-length cubes are only tested\r\n                 // to be working on Postgres version >=10.6.\r\n-                const [{ server_version }] = await connection.query(\r\n-                    \"SHOW server_version\",\r\n-                )\r\n-                const semverArray = server_version.split(\".\").map(Number)\r\n+                const [{ version }] = await connection.query(\"SELECT version()\")\r\n+                const semverArray = version\r\n+                    .replace(/^PostgreSQL ([\\d\\.]+) .*$/, \"$1\")\r\n+                    .split(\".\")\r\n+                    .map(Number)\r\n                 if (!(semverArray[0] >= 10 && semverArray[1] >= 6)) {\r\n                     return\r\n                 }\r\n```\r\n\r\nGood to get your thoughts","closed_by":{"login":"pleerock","id":1753397,"node_id":"MDQ6VXNlcjE3NTMzOTc=","avatar_url":"https://avatars.githubusercontent.com/u/1753397?v=4","gravatar_id":"","url":"https://api.github.com/users/pleerock","html_url":"https://github.com/pleerock","followers_url":"https://api.github.com/users/pleerock/followers","following_url":"https://api.github.com/users/pleerock/following{/other_user}","gists_url":"https://api.github.com/users/pleerock/gists{/gist_id}","starred_url":"https://api.github.com/users/pleerock/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pleerock/subscriptions","organizations_url":"https://api.github.com/users/pleerock/orgs","repos_url":"https://api.github.com/users/pleerock/repos","events_url":"https://api.github.com/users/pleerock/events{/privacy}","received_events_url":"https://api.github.com/users/pleerock/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/typeorm/typeorm/issues/9318/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/typeorm/typeorm/issues/9318/timeline","performed_via_github_app":null,"state_reason":"completed"}