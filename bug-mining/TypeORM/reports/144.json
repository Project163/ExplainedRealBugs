{"url":"https://api.github.com/repos/typeorm/typeorm/issues/9323","repository_url":"https://api.github.com/repos/typeorm/typeorm","labels_url":"https://api.github.com/repos/typeorm/typeorm/issues/9323/labels{/name}","comments_url":"https://api.github.com/repos/typeorm/typeorm/issues/9323/comments","events_url":"https://api.github.com/repos/typeorm/typeorm/issues/9323/events","html_url":"https://github.com/typeorm/typeorm/issues/9323","id":1351598734,"node_id":"I_kwDOAyVBJc5Qj8KO","number":9323,"title":"VirtualColumn Decorator","user":{"login":"CollinCashio","id":69058468,"node_id":"MDQ6VXNlcjY5MDU4NDY4","avatar_url":"https://avatars.githubusercontent.com/u/69058468?v=4","gravatar_id":"","url":"https://api.github.com/users/CollinCashio","html_url":"https://github.com/CollinCashio","followers_url":"https://api.github.com/users/CollinCashio/followers","following_url":"https://api.github.com/users/CollinCashio/following{/other_user}","gists_url":"https://api.github.com/users/CollinCashio/gists{/gist_id}","starred_url":"https://api.github.com/users/CollinCashio/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/CollinCashio/subscriptions","organizations_url":"https://api.github.com/users/CollinCashio/orgs","repos_url":"https://api.github.com/users/CollinCashio/repos","events_url":"https://api.github.com/users/CollinCashio/events{/privacy}","received_events_url":"https://api.github.com/users/CollinCashio/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":364554717,"node_id":"MDU6TGFiZWwzNjQ1NTQ3MTc=","url":"https://api.github.com/repos/typeorm/typeorm/labels/new%20feature","name":"new feature","color":"fbca04","default":false,"description":null},{"id":2454823078,"node_id":"MDU6TGFiZWwyNDU0ODIzMDc4","url":"https://api.github.com/repos/typeorm/typeorm/labels/requires%20triage","name":"requires triage","color":"f9aeb0","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2022-08-26T00:56:09Z","updated_at":"2024-07-25T23:14:02Z","closed_at":"2022-09-20T12:23:39Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## Feature Description\r\nI would like to add a new feature to TypeORM so that I can consolidate my code and simply run a subSelect with every get request on the requested entity. This would improve performance and allow me to utilize the full potential of the supported relational databases PostgresQL, MySql, and MSSQL.\r\n\r\nBelow is what I am planning on implementing and tying to this Issue once it is completed (I will be coding this up tonight and think that it would bring value to this project overall)\r\n\r\n### The Problem\r\nWhen querying data against any relational database there is often a need to return some query (a sub-select, count, etc.) that returns with a model. For example, if we create an entity of type Company that has a one-to-many relationship on employees, it may make sense to have a totalEmployeesCount column (\"Virtual Column\") that calculates this on every request *or even better when the column is selected in the base entity query*. This is what I am wanting to implement in TypeORM. This is common in most ORM solutions and I would love to see it here.\r\n\r\n### The Solution\r\nLet's use the same example above: we have entity of type Company that has a one-to-many relationship on an employee entity (employees), it may make sense to have a totalEmployeesCount column that could be re-calculated on every fetch of the entity:\r\n\r\n```js\r\nimport { BaseEntity, PrimaryColumn, OneToMany, ManyToOne, VirtualColumn } from \"typeorm\";\r\n\r\n@Entity({ name: \"companies\" })\r\nexport class Company extends BaseEntity {\r\n  @PrimaryColumn(\"varchar\", { length: 50 })\r\n  name: string;\r\n\r\n  @VirtualColumn({ query: (alias) => `SELECT COUNT(\"name\") FROM \"employees\" WHERE \"companyName\" = ${alias}.name` })\r\n  totalEmployeesCount: number;\r\n\r\n  @OneToMany((type) => Employee, (employee) => employee.company)\r\n  employees: Employee[];\r\n}\r\n\r\n@Entity({ name: \"employees\" })\r\nexport class Employee extends BaseEntity {\r\n  @PrimaryColumn(\"varchar\", { length: 50 })\r\n  name: string;\r\n\r\n  @ManyToOne((type) => Company, (company) => company.employees)\r\n  company: Company;\r\n}\r\n```\r\n\r\n__Some notes on the VirtualColumn Decorator:__\r\n1. The \"query\" property will be used to populate the column data. This query is used when generating the relational db script. The query function is called with the current entities alias automatically generated by TypeORM.\r\n\r\n2. A virtual column is not an editable column. It is a record that should be considered as readonly and it is ignored when the save entity function is run.\r\n\r\n### Considered Alternatives\r\nOne workaround would be to create a query builder but in doing so, this would add complexity, and it doesn't solve the overall need: code redundancy, and consistent entity result sets.\r\n\r\nThe second workaround would to be to add an @AfterLoad() decorator and perform a query there, but this is a poor solution since it would not allow us to utilize the relational databases query optimization engine when performing a query leading to worse performance. This proposed solution would be faster and avoid several unnecessary database hits.\r\n\r\n### Relevant Database Driver(s)\r\n\r\nThis solution would work for all relational databases (it is possible to add non-relational databases to this as well but the immediate need is for relational databases.\r\n\r\n| DB Type           | Relevant      |\r\n|-------------------| ---           |\r\n| `aurora-mysql`    | yes            |\r\n| `aurora-postgres` | yes            |\r\n| `better-sqlite3`  | yes            |\r\n| `cockroachdb`     | no            |\r\n| `cordova`         | no            |\r\n| `expo`            | no            |\r\n| `mongodb`         | no            |\r\n| `mysql`           | yes            |\r\n| `nativescript`    | no            |\r\n| `oracle`          | no            |\r\n| `postgres`        | yes            |\r\n| `react-native`    | no            |\r\n| `sap`             | no            |\r\n| `spanner`         | no            |\r\n| `sqlite`          | yes            |\r\n| `sqlite-abstract` | yes            |\r\n| `sqljs`           | yes            |\r\n| `sqlserver`       | yes            |\r\n\r\n\r\n### Are you willing to resolve this issue by submitting a Pull Request?\r\n - ✅ Yes, I have the time, and I know how to start. (**Already working on a solution**)\r\n - ✖️ Yes, I have the time, but I don't know how to start. I would need guidance.\r\n - ✖️ No, I don’t have the time, but I can support (using donations) development.\r\n - ✖️ No, I don’t have the time and I’m okay to wait for the community / maintainers to resolve this issue.","closed_by":{"login":"pleerock","id":1753397,"node_id":"MDQ6VXNlcjE3NTMzOTc=","avatar_url":"https://avatars.githubusercontent.com/u/1753397?v=4","gravatar_id":"","url":"https://api.github.com/users/pleerock","html_url":"https://github.com/pleerock","followers_url":"https://api.github.com/users/pleerock/followers","following_url":"https://api.github.com/users/pleerock/following{/other_user}","gists_url":"https://api.github.com/users/pleerock/gists{/gist_id}","starred_url":"https://api.github.com/users/pleerock/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pleerock/subscriptions","organizations_url":"https://api.github.com/users/pleerock/orgs","repos_url":"https://api.github.com/users/pleerock/repos","events_url":"https://api.github.com/users/pleerock/events{/privacy}","received_events_url":"https://api.github.com/users/pleerock/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/typeorm/typeorm/issues/9323/reactions","total_count":3,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":3,"eyes":0},"timeline_url":"https://api.github.com/repos/typeorm/typeorm/issues/9323/timeline","performed_via_github_app":null,"state_reason":"completed"}