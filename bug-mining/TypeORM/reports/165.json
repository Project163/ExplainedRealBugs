{"url":"https://api.github.com/repos/typeorm/typeorm/issues/11563","repository_url":"https://api.github.com/repos/typeorm/typeorm","labels_url":"https://api.github.com/repos/typeorm/typeorm/issues/11563/labels{/name}","comments_url":"https://api.github.com/repos/typeorm/typeorm/issues/11563/comments","events_url":"https://api.github.com/repos/typeorm/typeorm/issues/11563/events","html_url":"https://github.com/typeorm/typeorm/issues/11563","id":3211317692,"node_id":"I_kwDOAyVBJc6_aNG8","number":11563,"title":"Array modification bug in QueryRunner drop methods causes elements to be skipped during iteration","user":{"login":"taina0407","id":5900860,"node_id":"MDQ6VXNlcjU5MDA4NjA=","avatar_url":"https://avatars.githubusercontent.com/u/5900860?v=4","gravatar_id":"","url":"https://api.github.com/users/taina0407","html_url":"https://github.com/taina0407","followers_url":"https://api.github.com/users/taina0407/followers","following_url":"https://api.github.com/users/taina0407/following{/other_user}","gists_url":"https://api.github.com/users/taina0407/gists{/gist_id}","starred_url":"https://api.github.com/users/taina0407/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/taina0407/subscriptions","organizations_url":"https://api.github.com/users/taina0407/orgs","repos_url":"https://api.github.com/users/taina0407/repos","events_url":"https://api.github.com/users/taina0407/events{/privacy}","received_events_url":"https://api.github.com/users/taina0407/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":333605711,"node_id":"MDU6TGFiZWwzMzM2MDU3MTE=","url":"https://api.github.com/repos/typeorm/typeorm/labels/bug","name":"bug","color":"fc2929","default":true,"description":null},{"id":2454823078,"node_id":"MDU6TGFiZWwyNDU0ODIzMDc4","url":"https://api.github.com/repos/typeorm/typeorm/labels/requires%20triage","name":"requires triage","color":"f9aeb0","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2025-07-08T07:07:02Z","updated_at":"2025-07-09T06:23:49Z","closed_at":"2025-07-09T06:23:49Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Issue description\n\nMultiple QueryRunner implementations have a critical bug where iterating over arrays (foreign keys, indices, columns, unique constraints) and modifying them during iteration causes elements to be skipped due to in-place array modification.\n\n### Expected Behavior\n\nWhen methods like `dropForeignKeys()`, `dropIndices()`, `dropColumns()`, and `dropUniqueConstraints()` iterate over arrays using `for (const item of array)` and call individual drop methods, these individual methods internally remove items from the same array being iterated over. This causes the iterator to skip elements because the array indices shift during iteration, all items in the array should be dropped from the database table.\n\n\n### Actual Behavior\n\nDue to array modification during iteration, only some of the items are actually dropped. Elements get skipped because the array indices shift when items are removed during the loop.\n\nFor example, when dropping columns `[A, B, C]`:\n1. Iterator starts at index 0, drops column A\n2. Array becomes `[B, C]`, but iterator moves to index 1  \n3. Iterator now points to column C (skipping B)\n4. Only columns A and C are dropped, B remains\n\n\n### Steps to reproduce\n\n\n```typescript\nimport { DataSource } from 'typeorm';\n\n// Create a table with multiple columns\nconst queryRunner = dataSource.createQueryRunner();\nawait queryRunner.createTable(new Table({\n    name: 'test_table',\n    columns: [\n        { name: 'id', type: 'int', isPrimary: true },\n        { name: 'col1', type: 'varchar', length: '255' },\n        { name: 'col2', type: 'varchar', length: '255' },\n        { name: 'col3', type: 'varchar', length: '255' },\n        { name: 'col4', type: 'varchar', length: '255' }\n    ]\n}));\n\n// Try to drop multiple columns at once\nconst table = await queryRunner.getTable('test_table');\nconst columnsToRemove = ['col1', 'col2', 'col3', 'col4'];\n\nawait queryRunner.dropColumns(table, columnsToRemove);\n\n// Check remaining columns - some columns will still exist\nconst updatedTable = await queryRunner.getTable('test_table');\nconsole.log(updatedTable.columns.map(c => c.name)); \n// Expected: ['id']\n// Actual: ['id', 'col2', 'col4'] (col1 and col3 dropped, col2 and col4 remain)\n```\n\n\n### My Environment\n\n| Dependency          | Version  |\n| ---                 | ---      |\n| Operating System    | Any      |\n| Node.js version     | Any      |\n| Typescript version  | Any      |\n| TypeORM version     | 0.3.x (all versions with affected QueryRunners) |\n\n### Additional Context\n\n\n### Affected Methods and Files:\n- `dropForeignKeys()` - SpannerQueryRunner, PostgresQueryRunner, CockroachQueryRunner\n- `dropIndices()` - SpannerQueryRunner, PostgresQueryRunner, CockroachQueryRunner  \n- `dropColumns()` - All major QueryRunners (Spanner, Postgres, MySQL, SQLServer, Oracle, CockroachDB, SAP, AuroraMySQL)\n- `dropUniqueConstraints()` - PostgresQueryRunner, CockroachQueryRunner\n\n### Example of problematic code pattern:\n```typescript\nasync dropColumns(tableOrName: Table | string, columns: TableColumn[] | string[]): Promise<void> {\n    // BUG: Iterating over array while modifying it\n    for (const column of columns) {\n        await this.dropColumn(tableOrName, column) // This modifies the 'columns' array internally\n    }\n}\n```\n\n### Proposed fix:\n```typescript\nasync dropColumns(tableOrName: Table | string, columns: TableColumn[] | string[]): Promise<void> {\n    // Create a copy of the array to avoid modification during iteration\n    for (const column of [...columns]) {\n        await this.dropColumn(tableOrName, column)\n    }\n}\n```\n\n### Safe methods (no changes needed):\n- `dropCheckConstraints()` - Uses `Promise.all()` pattern\n- `dropExclusionConstraints()` - Uses `Promise.all()` pattern\n- SQLite-based QueryRunners - Use table cloning/recreation\n- All `create*` methods - Don't modify arrays during iteration\n\nThis is a systematic issue affecting multiple database drivers with potential for data loss and inconsistent database states.\n\n\n### Relevant Database Driver(s)\n\n- [x] aurora-mysql\n- [x] aurora-postgres\n- [ ] better-sqlite3\n- [x] cockroachdb\n- [ ] cordova\n- [ ] expo\n- [ ] mongodb\n- [x] mysql\n- [ ] nativescript\n- [x] oracle\n- [x] postgres\n- [ ] react-native\n- [x] sap\n- [x] spanner\n- [x] sqlite\n- [x] sqlite-abstract\n- [ ] sqljs\n- [x] sqlserver\n\n### Are you willing to resolve this issue by submitting a Pull Request?\n\nYes, I have the time, and I know how to start.","closed_by":{"login":"gioboa","id":35845425,"node_id":"MDQ6VXNlcjM1ODQ1NDI1","avatar_url":"https://avatars.githubusercontent.com/u/35845425?v=4","gravatar_id":"","url":"https://api.github.com/users/gioboa","html_url":"https://github.com/gioboa","followers_url":"https://api.github.com/users/gioboa/followers","following_url":"https://api.github.com/users/gioboa/following{/other_user}","gists_url":"https://api.github.com/users/gioboa/gists{/gist_id}","starred_url":"https://api.github.com/users/gioboa/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gioboa/subscriptions","organizations_url":"https://api.github.com/users/gioboa/orgs","repos_url":"https://api.github.com/users/gioboa/repos","events_url":"https://api.github.com/users/gioboa/events{/privacy}","received_events_url":"https://api.github.com/users/gioboa/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/typeorm/typeorm/issues/11563/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/typeorm/typeorm/issues/11563/timeline","performed_via_github_app":null,"state_reason":"completed"}