{"url":"https://api.github.com/repos/typeorm/typeorm/issues/4277","repository_url":"https://api.github.com/repos/typeorm/typeorm","labels_url":"https://api.github.com/repos/typeorm/typeorm/issues/4277/labels{/name}","comments_url":"https://api.github.com/repos/typeorm/typeorm/issues/4277/comments","events_url":"https://api.github.com/repos/typeorm/typeorm/issues/4277/events","html_url":"https://github.com/typeorm/typeorm/issues/4277","id":455100591,"node_id":"MDU6SXNzdWU0NTUxMDA1OTE=","number":4277,"title":"Using cache in findAndCount and getManyAndCount returns 0 as count","user":{"login":"Tallyrald","id":35098410,"node_id":"MDQ6VXNlcjM1MDk4NDEw","avatar_url":"https://avatars.githubusercontent.com/u/35098410?v=4","gravatar_id":"","url":"https://api.github.com/users/Tallyrald","html_url":"https://github.com/Tallyrald","followers_url":"https://api.github.com/users/Tallyrald/followers","following_url":"https://api.github.com/users/Tallyrald/following{/other_user}","gists_url":"https://api.github.com/users/Tallyrald/gists{/gist_id}","starred_url":"https://api.github.com/users/Tallyrald/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Tallyrald/subscriptions","organizations_url":"https://api.github.com/users/Tallyrald/orgs","repos_url":"https://api.github.com/users/Tallyrald/repos","events_url":"https://api.github.com/users/Tallyrald/events{/privacy}","received_events_url":"https://api.github.com/users/Tallyrald/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":333605711,"node_id":"MDU6TGFiZWwzMzM2MDU3MTE=","url":"https://api.github.com/repos/typeorm/typeorm/labels/bug","name":"bug","color":"fc2929","default":true,"description":null},{"id":712054471,"node_id":"MDU6TGFiZWw3MTIwNTQ0NzE=","url":"https://api.github.com/repos/typeorm/typeorm/labels/driver:%20mysql","name":"driver: mysql","color":"0052cc","default":false,"description":null},{"id":712054626,"node_id":"MDU6TGFiZWw3MTIwNTQ2MjY=","url":"https://api.github.com/repos/typeorm/typeorm/labels/driver:%20mariadb","name":"driver: mariadb","color":"0052cc","default":false,"description":null},{"id":1212579422,"node_id":"MDU6TGFiZWwxMjEyNTc5NDIy","url":"https://api.github.com/repos/typeorm/typeorm/labels/comp:%20cache","name":"comp: cache","color":"1d76db","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2019-06-12T09:17:18Z","updated_at":"2021-10-22T09:29:06Z","closed_at":"2021-10-21T11:48:56Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Issue type:**\r\n\r\n[ ] question\r\n[x] bug report\r\n[ ] feature request\r\n[ ] documentation issue\r\n\r\n**Database system/driver:**\r\n\r\n[ ] `cordova`\r\n[ ] `mongodb`\r\n[ ] `mssql`\r\n[x] `mysql` / `mariadb`\r\n[ ] `oracle`\r\n[ ] `postgres`\r\n[ ] `cockroachdb`\r\n[ ] `sqlite`\r\n[ ] `sqljs`\r\n[ ] `react-native`\r\n[ ] `expo`\r\n\r\n**TypeORM version:**\r\n\r\n[ ] `latest`\r\n[x] `@next`\r\n[x] `0.2.18`\r\n\r\n**Steps to reproduce or a small repository showing the problem:**\r\n\r\nConsider the following code (the function is inside an abstract class):\r\n```ts\r\nstatic async GetBasicList(userRepo: Repository<User>, limit: number, page: number): Promise<[User[], number]> {\r\n\treturn userRepo.findAndCount({\r\n\t\tcache: {\r\n\t\t\tid: 'userBasicList',\r\n\t\t\tmilliseconds: 100000,\r\n\t\t},\r\n\t\torder: {\r\n\t\t\tid: 'DESC',\r\n\t\t},\r\n\t\trelations: ['profile'],\r\n\t\tskip: page * limit,\r\n\t\ttake: limit,\r\n\t});\r\n}\r\n```\r\nWithout the cache, the result is fully correct (returns the correct amount of users in the right order, loads the profile relation, correctly paginates and gives back the number of total hits). However when the above is run with caching (as it is specified above) the full result count returns 0.\r\nFor example if I have 10 users in my database and I run the query with limit set to 5 and page set to 0, I get 5 users and a count of 0 instead of 10.\r\n\r\nThe User entity is fairly complex with 11 relations and some other fields, however nothing is eagerly loaded. Some relations have cascade set to true (like the profile the query uses), but removing cascades does not help.\r\n\r\nCaching is enabled in ormconfig.js and this issue is present with database cache and ioredis as well.\r\n\r\nAlso interesting to observe that in the cache, there are 2 queries inserted. One with the 'userBasicList' identifier and one with a NULL identifier. The latter contains a query that starts like this:\r\n```sql\r\nSELECT DISTINCT `distinctAlias`.`User_id` as \"ids_User_id\", `distinctAlias`.`User_id` FROM (SELECT...\r\n```\r\n\r\nTried using @next, but the same thing happened.\r\n\r\nEDIT:\r\nForgot to mention but the exact same pattern applies when a queryBuilder.getManyAndCount() is used.","closed_by":{"login":"pleerock","id":1753397,"node_id":"MDQ6VXNlcjE3NTMzOTc=","avatar_url":"https://avatars.githubusercontent.com/u/1753397?v=4","gravatar_id":"","url":"https://api.github.com/users/pleerock","html_url":"https://github.com/pleerock","followers_url":"https://api.github.com/users/pleerock/followers","following_url":"https://api.github.com/users/pleerock/following{/other_user}","gists_url":"https://api.github.com/users/pleerock/gists{/gist_id}","starred_url":"https://api.github.com/users/pleerock/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pleerock/subscriptions","organizations_url":"https://api.github.com/users/pleerock/orgs","repos_url":"https://api.github.com/users/pleerock/repos","events_url":"https://api.github.com/users/pleerock/events{/privacy}","received_events_url":"https://api.github.com/users/pleerock/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/typeorm/typeorm/issues/4277/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/typeorm/typeorm/issues/4277/timeline","performed_via_github_app":null,"state_reason":"completed"}