{"url":"https://api.github.com/repos/typeorm/typeorm/issues/7146","repository_url":"https://api.github.com/repos/typeorm/typeorm","labels_url":"https://api.github.com/repos/typeorm/typeorm/issues/7146/labels{/name}","comments_url":"https://api.github.com/repos/typeorm/typeorm/issues/7146/comments","events_url":"https://api.github.com/repos/typeorm/typeorm/issues/7146/events","html_url":"https://github.com/typeorm/typeorm/issues/7146","id":755792576,"node_id":"MDU6SXNzdWU3NTU3OTI1NzY=","number":7146,"title":"Lazy relations resolve to 'undefined' instead of 'null'","user":{"login":"securedirective","id":6537231,"node_id":"MDQ6VXNlcjY1MzcyMzE=","avatar_url":"https://avatars.githubusercontent.com/u/6537231?v=4","gravatar_id":"","url":"https://api.github.com/users/securedirective","html_url":"https://github.com/securedirective","followers_url":"https://api.github.com/users/securedirective/followers","following_url":"https://api.github.com/users/securedirective/following{/other_user}","gists_url":"https://api.github.com/users/securedirective/gists{/gist_id}","starred_url":"https://api.github.com/users/securedirective/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/securedirective/subscriptions","organizations_url":"https://api.github.com/users/securedirective/orgs","repos_url":"https://api.github.com/users/securedirective/repos","events_url":"https://api.github.com/users/securedirective/events{/privacy}","received_events_url":"https://api.github.com/users/securedirective/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":333605711,"node_id":"MDU6TGFiZWwzMzM2MDU3MTE=","url":"https://api.github.com/repos/typeorm/typeorm/labels/bug","name":"bug","color":"fc2929","default":true,"description":null},{"id":2454823078,"node_id":"MDU6TGFiZWwyNDU0ODIzMDc4","url":"https://api.github.com/repos/typeorm/typeorm/labels/requires%20triage","name":"requires triage","color":"f9aeb0","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2020-12-03T03:51:54Z","updated_at":"2021-01-11T12:09:09Z","closed_at":"2021-01-11T12:09:09Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"<!--\r\n  Please follow the template.  If you don't, your issue may be closed.\r\n\r\n  Have a question?  This is the TypeORM issue tracker - and not the right place\r\n  for general support or questions.  Instead, check the \"Support\" Documentation\r\n  on the best places to ask questions!\r\n\r\n  https://github.com/typeorm/typeorm/blob/master/docs/support.md\r\n-->\r\n\r\n## Issue Description\r\n\r\n### Expected Behavior\r\n\r\n<!--\r\n  A clear and concise description of what you expected to happen.\r\n-->\r\n\r\nAfter reading about the partial-update feature, where a literal `null` is required to save `NULL` to the database, and `undefined` indicates the field should be skipped entirely... I expected similar behavior when reading the `NULL` back from the database: a Javascript `null` in all cases.\r\n\r\nSpecifically, I expected to be able to define my nullable field as `Category | null` and guarantee that the value will only ever be a `Category` instance or a `null`.\r\n\r\n### Actual Behavior\r\n\r\n<!--\r\n  A clear and concise description of what actually happened.\r\n\r\n  Please wrap any error messages or output in code tags, instead of images.\r\n-->\r\n\r\nLazy relations that are *not* in the `'relations'` find option return a Promise that resolves to a Javascript **`undefined`**. The other scenarios return a **`null`**.\r\n\r\nSince Typescript is unaware of this unexpected behavior, there are no compile-time errors. But this inconsistency causes problems later when the actual value of the variable does not match the type specification, so we have to use `Category | null | undefined` all over the place to account for both possibilities.\r\n\r\nWhile I don't have much of a preference of `null` vs. `undefined`, the *method of retrieval* (lazy-loaded vs lazy-loaded but included in the `'relations'` find option vs. eager-loaded) should not change the outcome. That inconsistency is what I'd consider a bug.\r\n\r\n### Steps to Reproduce\r\n\r\n<!--\r\n  Your bug will be investigated much faster if we can run your code and it doesn't\r\n  have dependencies other than TypeORM. Issues without reproduction steps or\r\n  code examples may be closed as not actionable.\r\n\r\n  Please try to provide a Minimal, Complete, and Verifiable example.\r\n  http://stackoverflow.com/help/mcve\r\n-->\r\n\r\nThis is a somewhat-contrived example, just to illustrate:\r\n\r\n```typescript\r\n@Entity()\r\nexport class Category {\r\n    @PrimaryGeneratedColumn()\r\n    id!: number;\r\n}\r\n\r\n@Entity()\r\nexport class Post {\r\n    @PrimaryGeneratedColumn()\r\n    id!: number;\r\n\r\n    @ManyToOne(type => Category, { eager: true })\r\n    eagerCategory!: Category | null;\r\n\r\n    @ManyToOne(type => Category)\r\n    lazyCategory!: Promise<Category | null>;\r\n}\r\n```\r\n\r\n```typescript\r\nfunction verifyCategoryIsNull(category: Category | null) {\r\n  if (category === null) {\r\n    console.log('Oops! Post has no category');\r\n  } else {\r\n    console.log(`Awesome. Post has a category: ${category}`);\r\n  }\r\n}\r\n\r\nlet post: Post;\r\npost = new Post();\r\nawait connection.manager.save(post);\r\n\r\n// Completely lazy\r\npost = await connection.manager.findOneOrFail(Post);\r\nverifyCategoryIsNull(await post.lazyCategory);\r\n\r\n// Lazy by definition, but marked for eager-loading at the query level\r\npost = await connection.manager.findOneOrFail(Post, { relations: ['lazyCategory'] });\r\nverifyCategoryIsNull(await post.lazyCategory);\r\n\r\n// Always eager, so no need for a Promise at all\r\npost = await connection.manager.findOneOrFail(Post);\r\nverifyCategoryIsNull(post.eagerCategory);\r\n```\r\n\r\nHere is the output:\r\n```\r\nAwesome. Post has a category: undefined\r\nOops! Post has no category\r\nOops! Post has no category\r\n```\r\n\r\nYes, I am aware that I could just replace `===` with `==`, since that happens to match both `null` and `undefined`. Or I could do `if (!category)` and accept that it also matches other stuff. But a prominent purpose for using Typescript in the first place is to implement strong typing across the codebase. Ending up with a value that doesn't match the type specification is a problem.\r\n\r\n### My Environment\r\n\r\n<!--\r\n  Please add any other relevant dependencies to this table at the end.\r\n  For example: Electron, React Native, or NestJS.\r\n-->\r\n\r\n| Dependency          | Version  |\r\n| ---                 | ---      |\r\n| Operating System    | Ubuntu   |\r\n| Node.js version     | v15.3.0  | <!-- run `node -v` to obtain this -->\r\n| Typescript version  | v3.6.5   | <!-- run `npm list typescript` to obtain this -->\r\n| TypeORM version     | v0.2.29  | <!-- run `npm list typeorm` to obtain this -->\r\n\r\n\r\n### Additional Context\r\n\r\n<!--\r\n  Add any other context about the bug report here.\r\n-->\r\n\r\nI am using strict mode in Typescript.\r\n\r\n### Relevant Database Driver(s)\r\n\r\n<!--\r\n  Please include the relevant database drivers to your issue.\r\n\r\n  Please include an `x` inside the brackets like so:\r\n\r\n  - [ ] `cockroachdb`\r\n  - [x] `cordova`\r\n  - [ ] `expo`\r\n-->\r\n\r\nI demonstrated the failure on the following drivers, though it likely affects all of them; I don't think this is a driver-specific issue.\r\n\r\n- [ ] `aurora-data-api`\r\n- [ ] `aurora-data-api-pg`\r\n- [ ] `better-sqlite3`\r\n- [x] `cockroachdb`\r\n- [ ] `cordova`\r\n- [ ] `expo`\r\n- [ ] `mongodb`\r\n- [x] `mysql`\r\n- [ ] `nativescript`\r\n- [ ] `oracle`\r\n- [x] `postgres`\r\n- [ ] `react-native`\r\n- [ ] `sap`\r\n- [ ] `sqlite`\r\n- [ ] `sqlite-abstract`\r\n- [ ] `sqljs`\r\n- [ ] `sqlserver`\r\n\r\n\r\n### Are you willing to resolve this issue by submitting a Pull Request?\r\n\r\n<!--\r\n  Remember that first-time contributors are welcome! ðŸ™Œ\r\n-->\r\n\r\n- [x] Yes, I have the time, and I know how to start.\r\n- [ ] Yes, I have the time, but I don't know how to start. I would need guidance.\r\n- [ ] No, I don't have the time, although I believe I could do it if I had the time...\r\n- [ ] No, I don't have the time and I wouldn't even know how to start.\r\n\r\nI've already forked the repo, fixed the issue, and prepared a PR and unit suite to hilight the issue. Working on some final touches, and I'll post when that is complete.\r\n\r\n<!--\r\n  ðŸ‘‹ Have a great day and thank you for the bug report!\r\n-->\r\n","closed_by":{"login":"pleerock","id":1753397,"node_id":"MDQ6VXNlcjE3NTMzOTc=","avatar_url":"https://avatars.githubusercontent.com/u/1753397?v=4","gravatar_id":"","url":"https://api.github.com/users/pleerock","html_url":"https://github.com/pleerock","followers_url":"https://api.github.com/users/pleerock/followers","following_url":"https://api.github.com/users/pleerock/following{/other_user}","gists_url":"https://api.github.com/users/pleerock/gists{/gist_id}","starred_url":"https://api.github.com/users/pleerock/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pleerock/subscriptions","organizations_url":"https://api.github.com/users/pleerock/orgs","repos_url":"https://api.github.com/users/pleerock/repos","events_url":"https://api.github.com/users/pleerock/events{/privacy}","received_events_url":"https://api.github.com/users/pleerock/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/typeorm/typeorm/issues/7146/reactions","total_count":3,"+1":3,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/typeorm/typeorm/issues/7146/timeline","performed_via_github_app":null,"state_reason":"completed"}