{"url":"https://api.github.com/repos/typeorm/typeorm/issues/3792","repository_url":"https://api.github.com/repos/typeorm/typeorm","labels_url":"https://api.github.com/repos/typeorm/typeorm/issues/3792/labels{/name}","comments_url":"https://api.github.com/repos/typeorm/typeorm/issues/3792/comments","events_url":"https://api.github.com/repos/typeorm/typeorm/issues/3792/events","html_url":"https://github.com/typeorm/typeorm/issues/3792","id":419165985,"node_id":"MDU6SXNzdWU0MTkxNjU5ODU=","number":3792,"title":"Crash when running schema:log on postgres","user":{"login":"romain-gilliotte","id":1374063,"node_id":"MDQ6VXNlcjEzNzQwNjM=","avatar_url":"https://avatars.githubusercontent.com/u/1374063?v=4","gravatar_id":"","url":"https://api.github.com/users/romain-gilliotte","html_url":"https://github.com/romain-gilliotte","followers_url":"https://api.github.com/users/romain-gilliotte/followers","following_url":"https://api.github.com/users/romain-gilliotte/following{/other_user}","gists_url":"https://api.github.com/users/romain-gilliotte/gists{/gist_id}","starred_url":"https://api.github.com/users/romain-gilliotte/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/romain-gilliotte/subscriptions","organizations_url":"https://api.github.com/users/romain-gilliotte/orgs","repos_url":"https://api.github.com/users/romain-gilliotte/repos","events_url":"https://api.github.com/users/romain-gilliotte/events{/privacy}","received_events_url":"https://api.github.com/users/romain-gilliotte/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2019-03-10T09:36:25Z","updated_at":"2019-03-10T17:09:13Z","closed_at":"2019-03-10T17:09:13Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Issue type:**\r\n\r\n[ ] question\r\n[x ] bug report\r\n[ ] feature request\r\n[ ] documentation issue\r\n\r\n**Database system/driver:**\r\n\r\n[ ] `cordova`\r\n[ ] `mongodb`\r\n[ ] `mssql`\r\n[ ] `mysql` / `mariadb`\r\n[ ] `oracle`\r\n[x ] `postgres`\r\n[ ] `sqlite`\r\n[ ] `sqljs`\r\n[ ] `react-native`\r\n[ ] `expo`\r\n\r\n**TypeORM version:**\r\n\r\n[ ] `latest`\r\n[ ] `@next`\r\n[ x] `0.2.14`\r\n\r\n# Description of the problem\r\n\r\nWhen fetching columns metadata on the `loadTables()` method, quotes are missing before casting to postgres type \"regtype\".\r\n\r\nThis cause typeorm CLI to crash on a \"type not found\" error when running `schema:log` and `migration:generate` on some situations.\r\n\r\nThis happens, when the following conditions are met:\r\n- Using custom name for tables with capitalization (`@Entity({ name: 'MyTable' })`)\r\n- Using an enum column on the same table (`@Column({ type: 'enum', enum: Whatever })`)\r\n- `typeorm schema:sync` was run at least once (in order to create the enum type on the database)\r\n\r\nOn the PostgresQueryRunner.buildEnumName() method, when generating a name for the enum type, the name of the column is lowercased but not the name of the table, which leads to the name of the enum type to contain capitalization, hence the need for quoting.\r\n\r\n# Steps to reproduce\r\n\r\nWith the following code:\r\n\r\n```ts\r\nenum DetailType {\r\n    PAYMENT = 'PAYMENT',\r\n    ADMISSION = 'ADMISSION',\r\n}\r\n\r\n@Entity({ name: 'Detail' })\r\nexport class Detail {\r\n\r\n    @Column({ type: 'enum', enum: DetailType })\r\n    type: DetailType;\r\n}\r\n```\r\n\r\nRunning `typeorm schema:log` will work.\r\nHowever, after running `typeorm schema:sync`, and creating the enum type on on the database, subsequent calls to `typeorm schema:log` and `typeorm migration:generate` will crash on a `type not found` error from postgres\r\n\r\n# Temporary workaround\r\n\r\nWaiting for a version of typeorm, the bug can be worked around by patching the compiled version of typeorm with `patch-package` and this [attached patch](https://github.com/typeorm/typeorm/files/2949274/patches.zip).\r\n\r\n```\r\nnpm install --save patch-package\r\nunzip patches.zip\r\n```\r\nThen modify `package.json` and add a `postinstall` script, [as shown in documentation](https://www.npmjs.com/package/patch-package#set-up)\r\n\r\nThen run installation again\r\n```\r\nnpm install\r\n```\r\n\r\n# Definitive workaround\r\n\r\nI'll be posting a pull request in 10 minutes","closed_by":{"login":"pleerock","id":1753397,"node_id":"MDQ6VXNlcjE3NTMzOTc=","avatar_url":"https://avatars.githubusercontent.com/u/1753397?v=4","gravatar_id":"","url":"https://api.github.com/users/pleerock","html_url":"https://github.com/pleerock","followers_url":"https://api.github.com/users/pleerock/followers","following_url":"https://api.github.com/users/pleerock/following{/other_user}","gists_url":"https://api.github.com/users/pleerock/gists{/gist_id}","starred_url":"https://api.github.com/users/pleerock/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pleerock/subscriptions","organizations_url":"https://api.github.com/users/pleerock/orgs","repos_url":"https://api.github.com/users/pleerock/repos","events_url":"https://api.github.com/users/pleerock/events{/privacy}","received_events_url":"https://api.github.com/users/pleerock/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/typeorm/typeorm/issues/3792/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/typeorm/typeorm/issues/3792/timeline","performed_via_github_app":null,"state_reason":"completed"}