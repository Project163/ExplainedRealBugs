{"url":"https://api.github.com/repos/typeorm/typeorm/issues/6958","repository_url":"https://api.github.com/repos/typeorm/typeorm","labels_url":"https://api.github.com/repos/typeorm/typeorm/issues/6958/labels{/name}","comments_url":"https://api.github.com/repos/typeorm/typeorm/issues/6958/comments","events_url":"https://api.github.com/repos/typeorm/typeorm/issues/6958/events","html_url":"https://github.com/typeorm/typeorm/issues/6958","id":726704418,"node_id":"MDU6SXNzdWU3MjY3MDQ0MTg=","number":6958,"title":"Promises never get resolved in specific cases","user":{"login":"shiro","id":13651492,"node_id":"MDQ6VXNlcjEzNjUxNDky","avatar_url":"https://avatars.githubusercontent.com/u/13651492?v=4","gravatar_id":"","url":"https://api.github.com/users/shiro","html_url":"https://github.com/shiro","followers_url":"https://api.github.com/users/shiro/followers","following_url":"https://api.github.com/users/shiro/following{/other_user}","gists_url":"https://api.github.com/users/shiro/gists{/gist_id}","starred_url":"https://api.github.com/users/shiro/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/shiro/subscriptions","organizations_url":"https://api.github.com/users/shiro/orgs","repos_url":"https://api.github.com/users/shiro/repos","events_url":"https://api.github.com/users/shiro/events{/privacy}","received_events_url":"https://api.github.com/users/shiro/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":333605711,"node_id":"MDU6TGFiZWwzMzM2MDU3MTE=","url":"https://api.github.com/repos/typeorm/typeorm/labels/bug","name":"bug","color":"fc2929","default":true,"description":null},{"id":2398302183,"node_id":"MDU6TGFiZWwyMzk4MzAyMTgz","url":"https://api.github.com/repos/typeorm/typeorm/labels/next","name":"next","color":"2af2f9","default":false,"description":"An issue related to the next branch"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2020-10-21T17:22:37Z","updated_at":"2021-07-08T18:11:23Z","closed_at":"2021-05-10T09:22:02Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Issue type:**\r\n\r\n<!--\r\n     Have a question?\r\n     Check the \"Support\" Documentation on the best places to ask questions!\r\n     ---\r\n     https://github.com/typeorm/typeorm/blob/master/docs/support.md\r\n-->\r\n\r\n[x] bug report\r\n[ ] feature request\r\n[ ] documentation issue\r\n\r\n**Database system/driver:**\r\n\r\n[ ] `cordova`\r\n[ ] `mongodb`\r\n[ ] `mssql`\r\n[ ] `mysql` / `mariadb`\r\n[ ] `oracle`\r\n[x] `postgres`\r\n[ ] `cockroachdb`\r\n[ ] `sqlite`\r\n[ ] `sqljs`\r\n[ ] `react-native`\r\n[ ] `expo`\r\n\r\n**TypeORM version:**\r\n\r\n[ ] `latest`\r\n[x] `@next`\r\n[ ] `0.x.x` (or put your version here)\r\n\r\n**Steps to reproduce or a small repository showing the problem:**\r\n\r\nSometimes promises just never resolve. At first I thought it might be related with running scripts with `ts-node`, however even when using pure JS the issue is the same.\r\n\r\nThe freeze always happens when I try to perform a query after another query was performed without closing the connection. Here closing and re-connecting seems to avoid the bug, however I had another case where I tried saving an entity to a repository after performing a raw query and it also froze on the `await repository.save(...)` method, re-connecting did not fix it.\r\n\r\nHere's a code snippet:\r\n\r\n```.js\r\nconst createConnection = require(\"typeorm\").createConnection;\r\n\r\n\r\n(async () => {\r\n    const con = await createConnection();\r\n    await con.createQueryRunner().query(`SELECT 1 as foo`);\r\n    // re-connecting would work here...\r\n    // await con.close();\r\n    // await con.connect();\r\n    await con.createQueryRunner().query(`SELECT 1 as foo`);\r\n    console.log(1);\r\n    await con.close(); // freezes here\r\n    console.log(2); // this is never reached\r\n})();\r\n```\r\n\r\nThe actual contents of the raw query do not seem to matter, it happens every time. The problem is probably related to raw queries since the problem didn't happen with repositories (until doing a raw query once, after that it does).\r\n\r\nAlso tried it without `await` by using `.then(...)` callbacks, same outcome.","closed_by":{"login":"AlexMesser","id":17142628,"node_id":"MDQ6VXNlcjE3MTQyNjI4","avatar_url":"https://avatars.githubusercontent.com/u/17142628?v=4","gravatar_id":"","url":"https://api.github.com/users/AlexMesser","html_url":"https://github.com/AlexMesser","followers_url":"https://api.github.com/users/AlexMesser/followers","following_url":"https://api.github.com/users/AlexMesser/following{/other_user}","gists_url":"https://api.github.com/users/AlexMesser/gists{/gist_id}","starred_url":"https://api.github.com/users/AlexMesser/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AlexMesser/subscriptions","organizations_url":"https://api.github.com/users/AlexMesser/orgs","repos_url":"https://api.github.com/users/AlexMesser/repos","events_url":"https://api.github.com/users/AlexMesser/events{/privacy}","received_events_url":"https://api.github.com/users/AlexMesser/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/typeorm/typeorm/issues/6958/reactions","total_count":3,"+1":3,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/typeorm/typeorm/issues/6958/timeline","performed_via_github_app":null,"state_reason":"completed"}