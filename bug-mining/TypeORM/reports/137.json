{"url":"https://api.github.com/repos/typeorm/typeorm/issues/2927","repository_url":"https://api.github.com/repos/typeorm/typeorm","labels_url":"https://api.github.com/repos/typeorm/typeorm/issues/2927/labels{/name}","comments_url":"https://api.github.com/repos/typeorm/typeorm/issues/2927/comments","events_url":"https://api.github.com/repos/typeorm/typeorm/issues/2927/events","html_url":"https://github.com/typeorm/typeorm/issues/2927","id":369844122,"node_id":"MDU6SXNzdWUzNjk4NDQxMjI=","number":2927,"title":"When using base class' custom repository, the discriminator is ignored","user":{"login":"ryuuji3","id":9097492,"node_id":"MDQ6VXNlcjkwOTc0OTI=","avatar_url":"https://avatars.githubusercontent.com/u/9097492?v=4","gravatar_id":"","url":"https://api.github.com/users/ryuuji3","html_url":"https://github.com/ryuuji3","followers_url":"https://api.github.com/users/ryuuji3/followers","following_url":"https://api.github.com/users/ryuuji3/following{/other_user}","gists_url":"https://api.github.com/users/ryuuji3/gists{/gist_id}","starred_url":"https://api.github.com/users/ryuuji3/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ryuuji3/subscriptions","organizations_url":"https://api.github.com/users/ryuuji3/orgs","repos_url":"https://api.github.com/users/ryuuji3/repos","events_url":"https://api.github.com/users/ryuuji3/events{/privacy}","received_events_url":"https://api.github.com/users/ryuuji3/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":333605711,"node_id":"MDU6TGFiZWwzMzM2MDU3MTE=","url":"https://api.github.com/repos/typeorm/typeorm/labels/bug","name":"bug","color":"fc2929","default":true,"description":null},{"id":333605716,"node_id":"MDU6TGFiZWwzMzM2MDU3MTY=","url":"https://api.github.com/repos/typeorm/typeorm/labels/question","name":"question","color":"cc317c","default":true,"description":null},{"id":628526544,"node_id":"MDU6TGFiZWw2Mjg1MjY1NDQ=","url":"https://api.github.com/repos/typeorm/typeorm/labels/comp:%20table%20inheritance","name":"comp: table inheritance","color":"1d76db","default":false,"description":null},{"id":712054568,"node_id":"MDU6TGFiZWw3MTIwNTQ1Njg=","url":"https://api.github.com/repos/typeorm/typeorm/labels/driver:%20postgres","name":"driver: postgres","color":"0052cc","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2018-10-13T21:41:26Z","updated_at":"2023-06-26T22:29:09Z","closed_at":"2020-12-28T04:33:16Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Issue type:**\r\n\r\n[x ] question\r\n[x ] bug report\r\n[ ] feature request\r\n[ ] documentation issue\r\n\r\n**Database system/driver:**\r\n\r\n[ ] `cordova`\r\n[ ] `mongodb`\r\n[ ] `mssql`\r\n[ ] `mysql` / `mariadb`\r\n[ ] `oracle`\r\n[x ] `postgres`\r\n[ ] `sqlite`\r\n[ ] `sqljs`\r\n[ ] `react-native`\r\n[ ] `expo`\r\n\r\n**TypeORM version:**\r\n\r\n[x ] `latest`\r\n[ ] `@next`\r\n[ ] `0.x.x` (or put your version here)\r\n\r\n**Steps to reproduce or a small repository showing the problem:**\r\n\r\nI have a Single Table Inheritance structure; User and its child classes. At some point I am saving an instance of User's child class created with the appropriate constructor;\r\n\r\n```ts\r\n  static getUserInstanceFromPayload(payload: IUserPayload) {\r\n    switch(payload.role) {\r\n      case UserRole.ADMIN: return new Admin(); // class Admin extends User\r\n      default: throw new Error(`Invalid role ${role}`);\r\n    }\r\n  }\r\n  /* elsewhere... */\r\n  const payload = req.payload as IUserPayload;\r\n  const repository = em.getCustomRepository(User);\r\n  const user = getUserInstanceFromPayload(payload);\r\n\r\n  user.populateFromPayload(payload);\r\n\r\n  return repository.save(user);\r\n```\r\n\r\nSo I receive a payload object and then match the role and choose the appropriate constructor so that it should be the right kind of entity, and then populate it and save.\r\n\r\nHowever, when I run this code, I receive this error:\r\n\r\n```\r\nQuery failed: INSERT INTO \"user\"(\"id\", \"username\", \"password\", \"firstName\", \"lastName\", \"createdDate\", \"lastUpdatedDate\", \"role\") VALUES (DEFAULT, $1, $2, $3, $4, DEFAULT, DEFAULT, $5) RETURNING \"id\", \"createdDate\", \"lastUpdatedDate\", \"role\" -- PARAMETERS: [\"joe.schmoe@example.com\",\"$2b$07$J4XESA9hrVFJPpG.Xjfo0.zv9HOB4cd3T2xLxbEI37N20Dvx11TsG\",\"Joe\",\"Schmoe\",\"User\"]\r\nError: error: invalid input value for enum user_role_enum: \"User\"\r\n```\r\n\r\nSo I see that when it saves, it is somehow obtaining \"User\" as the discriminator value from the repository. \r\n\r\nMy solution has been to use the EntityManager to save the entity and it works as expected. So it's not like it's impossible to do what I want.\r\n\r\n```ts\r\nreturn em.save(user); // works as expected\r\n```\r\n\r\nAdditional info:\r\n\r\n```ts\r\nenum UserRole {\r\n  ADMIN = \"ADMIN\",\r\n  // etc...\r\n}\r\n```\r\nMy User entity:\r\n```ts\r\n@Entity()\r\n@TableInheritance({\r\n  column: {\r\n    name: \"role\",\r\n    type: \"enum\",\r\n    enum: UserRole,\r\n    default: UserRole.BASIC_USER\r\n  }\r\n})\r\nexport abstract class User {\r\n  @Expose()\r\n  protected role: UserRole;\r\n}\r\n```\r\n\r\nAnd the admin:\r\n```ts\r\n@ChildEntity(UserRole.ADMIN)\r\nexport class Admin extends User {\r\n\r\n  constructor() {\r\n    super();\r\n\r\n    this.role = UserRole.ADMIN; // this is only here so that unit tests work\r\n  }\r\n}\r\n```","closed_by":{"login":"ryuuji3","id":9097492,"node_id":"MDQ6VXNlcjkwOTc0OTI=","avatar_url":"https://avatars.githubusercontent.com/u/9097492?v=4","gravatar_id":"","url":"https://api.github.com/users/ryuuji3","html_url":"https://github.com/ryuuji3","followers_url":"https://api.github.com/users/ryuuji3/followers","following_url":"https://api.github.com/users/ryuuji3/following{/other_user}","gists_url":"https://api.github.com/users/ryuuji3/gists{/gist_id}","starred_url":"https://api.github.com/users/ryuuji3/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ryuuji3/subscriptions","organizations_url":"https://api.github.com/users/ryuuji3/orgs","repos_url":"https://api.github.com/users/ryuuji3/repos","events_url":"https://api.github.com/users/ryuuji3/events{/privacy}","received_events_url":"https://api.github.com/users/ryuuji3/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/typeorm/typeorm/issues/2927/reactions","total_count":7,"+1":7,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/typeorm/typeorm/issues/2927/timeline","performed_via_github_app":null,"state_reason":"completed"}