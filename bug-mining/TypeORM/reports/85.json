{"url":"https://api.github.com/repos/typeorm/typeorm/issues/6552","repository_url":"https://api.github.com/repos/typeorm/typeorm","labels_url":"https://api.github.com/repos/typeorm/typeorm/issues/6552/labels{/name}","comments_url":"https://api.github.com/repos/typeorm/typeorm/issues/6552/comments","events_url":"https://api.github.com/repos/typeorm/typeorm/issues/6552/events","html_url":"https://github.com/typeorm/typeorm/issues/6552","id":677689209,"node_id":"MDU6SXNzdWU2Nzc2ODkyMDk=","number":6552,"title":"MongoRepository delete by ObjectId deletes the wrong entity","user":{"login":"danmana","id":498419,"node_id":"MDQ6VXNlcjQ5ODQxOQ==","avatar_url":"https://avatars.githubusercontent.com/u/498419?v=4","gravatar_id":"","url":"https://api.github.com/users/danmana","html_url":"https://github.com/danmana","followers_url":"https://api.github.com/users/danmana/followers","following_url":"https://api.github.com/users/danmana/following{/other_user}","gists_url":"https://api.github.com/users/danmana/gists{/gist_id}","starred_url":"https://api.github.com/users/danmana/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/danmana/subscriptions","organizations_url":"https://api.github.com/users/danmana/orgs","repos_url":"https://api.github.com/users/danmana/repos","events_url":"https://api.github.com/users/danmana/events{/privacy}","received_events_url":"https://api.github.com/users/danmana/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":333605711,"node_id":"MDU6TGFiZWwzMzM2MDU3MTE=","url":"https://api.github.com/repos/typeorm/typeorm/labels/bug","name":"bug","color":"fc2929","default":true,"description":null},{"id":712054782,"node_id":"MDU6TGFiZWw3MTIwNTQ3ODI=","url":"https://api.github.com/repos/typeorm/typeorm/labels/driver:%20mongodb","name":"driver: mongodb","color":"0052cc","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2020-08-12T13:21:15Z","updated_at":"2020-10-07T08:34:47Z","closed_at":"2020-10-07T08:34:47Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Issue type:**\r\n\r\n[ ] question\r\n[x] bug report\r\n[ ] feature request\r\n[ ] documentation issue\r\n\r\n**Database system/driver:**\r\n\r\n[ ] `cordova`\r\n[x] `mongodb`\r\n[ ] `mssql`\r\n[ ] `mysql` / `mariadb`\r\n[ ] `oracle`\r\n[ ] `postgres`\r\n[ ] `cockroachdb`\r\n[ ] `sqlite`\r\n[ ] `sqljs`\r\n[ ] `react-native`\r\n[ ] `expo`\r\n\r\n**TypeORM version:**\r\n\r\n[x] `latest`\r\n[ ] `@next`\r\n[ ] `0.x.x` (or put your version here)\r\n\r\n**Steps to reproduce or a small repository showing the problem:**\r\n\r\n```ts\r\n@Entity()\r\nexport class Post {\r\n\r\n    @ObjectIdColumn()\r\n    _id: ObjectID;\r\n\r\n    @Column()\r\n    title: string;\r\n\r\n}\r\n\r\n// try to delete a post by passing directly it's ObjectId (as the signature suggests should be possible)\r\n// delete(criteria: string|string[]|number|number[]|Date|Date[]|ObjectID|ObjectID[]|FindConditions<Entity>): Promise<DeleteResult>\r\nconst post: Post = getSomePost();\r\nrepository.delete(post._id);\r\n```\r\nIf you look at the actual query executed (in MongoQueryRunner) you will see `deleteOne({})`.\r\nNotice the empty query! This will have a side effect of removing the first Post from the collection, whatever that is ...\r\n\r\nIf the Post entity has the id field renamed to `postId` the query will be `deleteOne({ _id: Buffer})`, which is still wrong, because the type should be ObjectId not Buffer. In this case the sideffect is less severe, it just doesn't delete anything\r\n\r\nThe workaround is to use `repository.delete({_id: post._id})` which works correctly.\r\n\r\nThe problem is in [MongoEntityManager.convertMixedCriteria](https://github.com/typeorm/typeorm/blob/0.2.25/src/entity-manager/MongoEntityManager.ts#L633) which tests for instanceof ObjectId in the wrong order:\r\n\r\n```ts\r\nprotected convertMixedCriteria(metadata: EntityMetadata, idMap: any): ObjectLiteral {\r\n        if (idMap instanceof Object) {\r\n            return metadata.columns.reduce((query, column) => {\r\n                const columnValue = column.getEntityValue(idMap);\r\n                if (columnValue !== undefined)\r\n                    query[column.databasePath] = columnValue;\r\n                return query;\r\n            }, {} as any);\r\n        }\r\n\r\n        // means idMap is just object id\r\n        const objectIdInstance = PlatformTools.load(\"mongodb\").ObjectID;\r\n        return {\r\n            \"_id\": (idMap instanceof objectIdInstance) ? idMap : new objectIdInstance(idMap)\r\n        };\r\n    }\r\n```\r\nIf `idMap` is an ObjectId it will obviously also be an instance of Object and it will enter wrongly in the first branch, never reaching the code at the bottom.\r\n\r\n","closed_by":{"login":"imnotjames","id":1551593,"node_id":"MDQ6VXNlcjE1NTE1OTM=","avatar_url":"https://avatars.githubusercontent.com/u/1551593?v=4","gravatar_id":"","url":"https://api.github.com/users/imnotjames","html_url":"https://github.com/imnotjames","followers_url":"https://api.github.com/users/imnotjames/followers","following_url":"https://api.github.com/users/imnotjames/following{/other_user}","gists_url":"https://api.github.com/users/imnotjames/gists{/gist_id}","starred_url":"https://api.github.com/users/imnotjames/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imnotjames/subscriptions","organizations_url":"https://api.github.com/users/imnotjames/orgs","repos_url":"https://api.github.com/users/imnotjames/repos","events_url":"https://api.github.com/users/imnotjames/events{/privacy}","received_events_url":"https://api.github.com/users/imnotjames/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/typeorm/typeorm/issues/6552/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/typeorm/typeorm/issues/6552/timeline","performed_via_github_app":null,"state_reason":"completed"}