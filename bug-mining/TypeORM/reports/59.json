{"url":"https://api.github.com/repos/typeorm/typeorm/issues/4880","repository_url":"https://api.github.com/repos/typeorm/typeorm","labels_url":"https://api.github.com/repos/typeorm/typeorm/issues/4880/labels{/name}","comments_url":"https://api.github.com/repos/typeorm/typeorm/issues/4880/comments","events_url":"https://api.github.com/repos/typeorm/typeorm/issues/4880/events","html_url":"https://github.com/typeorm/typeorm/issues/4880","id":504687754,"node_id":"MDU6SXNzdWU1MDQ2ODc3NTQ=","number":4880,"title":"Make MigrationExecutor API more controllable and public","user":{"login":"leonardofalk","id":5649915,"node_id":"MDQ6VXNlcjU2NDk5MTU=","avatar_url":"https://avatars.githubusercontent.com/u/5649915?v=4","gravatar_id":"","url":"https://api.github.com/users/leonardofalk","html_url":"https://github.com/leonardofalk","followers_url":"https://api.github.com/users/leonardofalk/followers","following_url":"https://api.github.com/users/leonardofalk/following{/other_user}","gists_url":"https://api.github.com/users/leonardofalk/gists{/gist_id}","starred_url":"https://api.github.com/users/leonardofalk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/leonardofalk/subscriptions","organizations_url":"https://api.github.com/users/leonardofalk/orgs","repos_url":"https://api.github.com/users/leonardofalk/repos","events_url":"https://api.github.com/users/leonardofalk/events{/privacy}","received_events_url":"https://api.github.com/users/leonardofalk/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2019-10-09T14:25:28Z","updated_at":"2019-11-22T03:34:29Z","closed_at":"2019-11-22T03:34:29Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Issue type:**\r\n\r\n[ ] question\r\n[ ] bug report\r\n[x] feature request\r\n[ ] documentation issue\r\n\r\n**Database system/driver:**\r\n\r\nDoesn't apply to a specific driver.\r\n\r\n**TypeORM version:**\r\n\r\n[x] `latest`\r\n[ ] `@next`\r\n[ ] `0.x.x` (or put your version here)\r\n\r\nI'd like to use MigrationExecutor to deal with migrations myself, today all that can be done is calling `runMigrations`, and a few other methods.\r\n\r\nIn my scenario, if by some reason a duplicated table/column error is thrown I'd like to ignore this migration, add it to done migrations and call the next one, this is impossible without calling MigrationExecutor private API or reimplementing it.\r\n\r\nThis is a piece of code that show how I'm doing it today:\r\n\r\n```ts\r\nimport { Connection, QueryRunner } from 'typeorm/browser'\r\nimport { MigrationExecutor } from 'typeorm/browser/migration/MigrationExecutor'\r\nimport _ from 'lodash'\r\n\r\nconst IGNORED_ERRORS = [\r\n  /table .+ already exists/i,\r\n  /index .+ already exists/i,\r\n  /duplicate column name/i,\r\n  /no such table: .+/i,\r\n  /no such index: .+/i,\r\n].map(r => new RegExp(r))\r\n\r\nexport class DatabaseMigrationService {\r\n  executor: any\r\n  queryRunner: QueryRunner\r\n\r\n  constructor(connection: Connection) {\r\n    this.executor = new MigrationExecutor(connection)\r\n    this.queryRunner = this.executor.queryRunner || connection.createQueryRunner('master')\r\n  }\r\n\r\n  call() {\r\n    const queryRunner = this.queryRunner\r\n\r\n    return new Promise(async (resolve, reject) => {\r\n      try {\r\n        const migrations: Migration[] = this.executor.getMigrations()\r\n        const doneMigrations = await this.executor.loadExecutedMigrations(queryRunner)\r\n        const newMigrations: any = _.reject(migrations, migration =>\r\n          _.find(doneMigrations, ['timestamp', migration.timestamp])\r\n        )\r\n\r\n        _.each(newMigrations, async migration => await this.executeMigration(queryRunner, migration))\r\n\r\n        resolve()\r\n      } catch (e) {\r\n        reject(e)\r\n      } finally {\r\n        if (this.queryRunner) {\r\n          this.queryRunner.release()\r\n        }\r\n      }\r\n    })\r\n  }\r\n\r\n  executeMigration(queryRunner: QueryRunner, migration: Migration): Promise<boolean> {\r\n    this.executor.transaction = false\r\n\r\n    return new Promise(async (resolve, reject) => {\r\n      try {\r\n        this.registerLog(`Migration ${migration.name} started`)\r\n\r\n        await (migration.instance as any).up(queryRunner)\r\n        await this.insertExecutedMigration(migration)\r\n\r\n        resolve(true)\r\n      } catch (e) {\r\n        this.registerLog(e.message, { level: 'ERROR' })\r\n\r\n        if (this.shouldIgnoreError(e)) {\r\n          this.insertExecutedMigration(migration)\r\n          resolve(true)\r\n        } else {\r\n          reject(e)\r\n        }\r\n      } finally {\r\n        this.registerLog(`Migration ${migration.name} finished`)\r\n      }\r\n    })\r\n  }\r\n\r\n  shouldIgnoreError(error: Error): boolean {\r\n    return _.some(IGNORED_ERRORS, r => r.test(error.message))\r\n  }\r\n\r\n  registerLog(content: string, props = {}) {\r\n    // register this with external apis ...\r\n  }\r\n\r\n  insertExecutedMigration(migration: Migration) {\r\n    return this.executor.insertExecutedMigration(this.queryRunner, migration)\r\n  }\r\n}\r\n```\r\n\r\nI'd like to propose this changes:\r\n\r\n- Make getMigrations, loadExecutedMigrations, insertExecutedMigration, deleteExecutedMigration, methods public\r\n- Make `import { MigrationExecutor } from 'typeorm'` available\r\n- Maybe add/rename some methods (ie.: showMigrations could be hasMigrationsPending, while showMigrations could be preserved as a way to log migration status), add getPendingMigrations, rename/add loadExecutedMigrations to getDoneMigrations, and maybe other methods\r\n\r\nIf this is approved I could put a work on it.","closed_by":{"login":"pleerock","id":1753397,"node_id":"MDQ6VXNlcjE3NTMzOTc=","avatar_url":"https://avatars.githubusercontent.com/u/1753397?v=4","gravatar_id":"","url":"https://api.github.com/users/pleerock","html_url":"https://github.com/pleerock","followers_url":"https://api.github.com/users/pleerock/followers","following_url":"https://api.github.com/users/pleerock/following{/other_user}","gists_url":"https://api.github.com/users/pleerock/gists{/gist_id}","starred_url":"https://api.github.com/users/pleerock/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pleerock/subscriptions","organizations_url":"https://api.github.com/users/pleerock/orgs","repos_url":"https://api.github.com/users/pleerock/repos","events_url":"https://api.github.com/users/pleerock/events{/privacy}","received_events_url":"https://api.github.com/users/pleerock/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/typeorm/typeorm/issues/4880/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/typeorm/typeorm/issues/4880/timeline","performed_via_github_app":null,"state_reason":"completed"}