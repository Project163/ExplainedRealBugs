{"url":"https://api.github.com/repos/typeorm/typeorm/issues/5762","repository_url":"https://api.github.com/repos/typeorm/typeorm","labels_url":"https://api.github.com/repos/typeorm/typeorm/issues/5762/labels{/name}","comments_url":"https://api.github.com/repos/typeorm/typeorm/issues/5762/comments","events_url":"https://api.github.com/repos/typeorm/typeorm/issues/5762/events","html_url":"https://github.com/typeorm/typeorm/issues/5762","id":588022649,"node_id":"MDU6SXNzdWU1ODgwMjI2NDk=","number":5762,"title":"Using URL as a rich column type breaks","user":{"login":"dhritzkiv","id":1349865,"node_id":"MDQ6VXNlcjEzNDk4NjU=","avatar_url":"https://avatars.githubusercontent.com/u/1349865?v=4","gravatar_id":"","url":"https://api.github.com/users/dhritzkiv","html_url":"https://github.com/dhritzkiv","followers_url":"https://api.github.com/users/dhritzkiv/followers","following_url":"https://api.github.com/users/dhritzkiv/following{/other_user}","gists_url":"https://api.github.com/users/dhritzkiv/gists{/gist_id}","starred_url":"https://api.github.com/users/dhritzkiv/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dhritzkiv/subscriptions","organizations_url":"https://api.github.com/users/dhritzkiv/orgs","repos_url":"https://api.github.com/users/dhritzkiv/repos","events_url":"https://api.github.com/users/dhritzkiv/events{/privacy}","received_events_url":"https://api.github.com/users/dhritzkiv/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":333605711,"node_id":"MDU6TGFiZWwzMzM2MDU3MTE=","url":"https://api.github.com/repos/typeorm/typeorm/labels/bug","name":"bug","color":"fc2929","default":true,"description":null},{"id":712054568,"node_id":"MDU6TGFiZWw3MTIwNTQ1Njg=","url":"https://api.github.com/repos/typeorm/typeorm/labels/driver:%20postgres","name":"driver: postgres","color":"0052cc","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"imnotjames","id":1551593,"node_id":"MDQ6VXNlcjE1NTE1OTM=","avatar_url":"https://avatars.githubusercontent.com/u/1551593?v=4","gravatar_id":"","url":"https://api.github.com/users/imnotjames","html_url":"https://github.com/imnotjames","followers_url":"https://api.github.com/users/imnotjames/followers","following_url":"https://api.github.com/users/imnotjames/following{/other_user}","gists_url":"https://api.github.com/users/imnotjames/gists{/gist_id}","starred_url":"https://api.github.com/users/imnotjames/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imnotjames/subscriptions","organizations_url":"https://api.github.com/users/imnotjames/orgs","repos_url":"https://api.github.com/users/imnotjames/repos","events_url":"https://api.github.com/users/imnotjames/events{/privacy}","received_events_url":"https://api.github.com/users/imnotjames/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"imnotjames","id":1551593,"node_id":"MDQ6VXNlcjE1NTE1OTM=","avatar_url":"https://avatars.githubusercontent.com/u/1551593?v=4","gravatar_id":"","url":"https://api.github.com/users/imnotjames","html_url":"https://github.com/imnotjames","followers_url":"https://api.github.com/users/imnotjames/followers","following_url":"https://api.github.com/users/imnotjames/following{/other_user}","gists_url":"https://api.github.com/users/imnotjames/gists{/gist_id}","starred_url":"https://api.github.com/users/imnotjames/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imnotjames/subscriptions","organizations_url":"https://api.github.com/users/imnotjames/orgs","repos_url":"https://api.github.com/users/imnotjames/repos","events_url":"https://api.github.com/users/imnotjames/events{/privacy}","received_events_url":"https://api.github.com/users/imnotjames/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":4,"created_at":"2020-03-25T22:13:45Z","updated_at":"2021-07-05T06:29:13Z","closed_at":"2021-07-05T06:29:13Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Issue type:**\r\n\r\n[x] bug report\r\n\r\n**Database system/driver:**\r\n\r\n[x] `postgres`\r\n\r\n**TypeORM version:**\r\n\r\n[x] `latest`\r\n\r\n**Steps to reproduce or a small repository showing the problem:**\r\n\r\n```ts\r\n// ./Doc.entity.ts\r\n@Entity()\r\nexport class Doc {\r\n\t@PrimaryGeneratedColumn(\"uuid\")\r\n\tid: string;\r\n\r\n\t@Column(\"varchar\", {\r\n\t\tlength: 2000,\r\n\t\tnullable: true,\r\n\t\t// marshall \r\n\t\ttransformer: {\r\n\t\t\tfrom(value: string | null): URL | null {\r\n\t\t\t\treturn value !== null ? new URL(value) : value;\r\n\t\t\t},\r\n\t\t\tto(value: URL | null): string | null {\r\n\t\t\t\treturn value?.toString() || null;\r\n\t\t\t},\r\n\t\t},\r\n\t})\r\n\turl: URL | null;\r\n}\r\n\r\n// elsewhereâ€¦\r\n\r\nconst doc = new Doc();\r\ndoc.url = new URL(\"https://typeorm.io/\")\r\n\r\nawait repository.save(doc); // <- throws here with `TypeError: Cannot set property 'flags' of undefined`\r\n```\r\n\r\nThe stack trace suggests that Node internals for URL are throwing here \r\nhttps://github.com/nodejs/node/blob/2fa74e3e38bb028339e48763138456b3ed10ed97/lib/internal/url.js#L240 (`ctx` is undefined?)\r\n after `href#set` is called: https://github.com/nodejs/node/blob/2fa74e3e38bb028339e48763138456b3ed10ed97/lib/internal/url.js#L458\r\n\r\nwhich is triggered from the TypeORM library here:\r\nhttps://github.com/typeorm/typeorm/blob/685d76b20464388c6f86c7d268770577452124b6/src/util/OrmUtils.ts#L90\r\n\r\nI've previously employed richer types + transformers for other data types flawlessly. However, this data type (URL) fails before it even gets to the transformers to Marshall to the database.\r\n\r\nI'm not familiar enough with the inner workings of how TypeORM serializes its data to break this problem down. Is there something about the URL data type specifically that prevents it from working as expected?\r\n\r\nIn the meantime, I can work with the data type as a string, and transform it to a URL manually.","closed_by":{"login":"imnotjames","id":1551593,"node_id":"MDQ6VXNlcjE1NTE1OTM=","avatar_url":"https://avatars.githubusercontent.com/u/1551593?v=4","gravatar_id":"","url":"https://api.github.com/users/imnotjames","html_url":"https://github.com/imnotjames","followers_url":"https://api.github.com/users/imnotjames/followers","following_url":"https://api.github.com/users/imnotjames/following{/other_user}","gists_url":"https://api.github.com/users/imnotjames/gists{/gist_id}","starred_url":"https://api.github.com/users/imnotjames/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imnotjames/subscriptions","organizations_url":"https://api.github.com/users/imnotjames/orgs","repos_url":"https://api.github.com/users/imnotjames/repos","events_url":"https://api.github.com/users/imnotjames/events{/privacy}","received_events_url":"https://api.github.com/users/imnotjames/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/typeorm/typeorm/issues/5762/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/typeorm/typeorm/issues/5762/timeline","performed_via_github_app":null,"state_reason":"completed"}