[{"url":"https://api.github.com/repos/redis/go-redis/issues/comments/1163016770","html_url":"https://github.com/redis/go-redis/issues/2126#issuecomment-1163016770","issue_url":"https://api.github.com/repos/redis/go-redis/issues/2126","id":1163016770,"node_id":"IC_kwDOAE8G285FUjpC","user":{"login":"vmihailenco","id":290976,"node_id":"MDQ6VXNlcjI5MDk3Ng==","avatar_url":"https://avatars.githubusercontent.com/u/290976?v=4","gravatar_id":"","url":"https://api.github.com/users/vmihailenco","html_url":"https://github.com/vmihailenco","followers_url":"https://api.github.com/users/vmihailenco/followers","following_url":"https://api.github.com/users/vmihailenco/following{/other_user}","gists_url":"https://api.github.com/users/vmihailenco/gists{/gist_id}","starred_url":"https://api.github.com/users/vmihailenco/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/vmihailenco/subscriptions","organizations_url":"https://api.github.com/users/vmihailenco/orgs","repos_url":"https://api.github.com/users/vmihailenco/repos","events_url":"https://api.github.com/users/vmihailenco/events{/privacy}","received_events_url":"https://api.github.com/users/vmihailenco/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-06-22T12:07:36Z","updated_at":"2022-06-22T12:07:36Z","body":"`c.shards` should not contain `nil` shards. Do you have an idea what conditions cause go-redis to have a nil shard in the map?","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/redis/go-redis/issues/comments/1163016770/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"vmihailenco","id":290976,"node_id":"MDQ6VXNlcjI5MDk3Ng==","avatar_url":"https://avatars.githubusercontent.com/u/290976?v=4","gravatar_id":"","url":"https://api.github.com/users/vmihailenco","html_url":"https://github.com/vmihailenco","followers_url":"https://api.github.com/users/vmihailenco/followers","following_url":"https://api.github.com/users/vmihailenco/following{/other_user}","gists_url":"https://api.github.com/users/vmihailenco/gists{/gist_id}","starred_url":"https://api.github.com/users/vmihailenco/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/vmihailenco/subscriptions","organizations_url":"https://api.github.com/users/vmihailenco/orgs","repos_url":"https://api.github.com/users/vmihailenco/repos","events_url":"https://api.github.com/users/vmihailenco/events{/privacy}","received_events_url":"https://api.github.com/users/vmihailenco/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/redis/go-redis/issues/comments/1163083220","html_url":"https://github.com/redis/go-redis/issues/2126#issuecomment-1163083220","issue_url":"https://api.github.com/repos/redis/go-redis/issues/2126","id":1163083220,"node_id":"IC_kwDOAE8G285FUz3U","user":{"login":"alemrtv","id":33660441,"node_id":"MDQ6VXNlcjMzNjYwNDQx","avatar_url":"https://avatars.githubusercontent.com/u/33660441?v=4","gravatar_id":"","url":"https://api.github.com/users/alemrtv","html_url":"https://github.com/alemrtv","followers_url":"https://api.github.com/users/alemrtv/followers","following_url":"https://api.github.com/users/alemrtv/following{/other_user}","gists_url":"https://api.github.com/users/alemrtv/gists{/gist_id}","starred_url":"https://api.github.com/users/alemrtv/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alemrtv/subscriptions","organizations_url":"https://api.github.com/users/alemrtv/orgs","repos_url":"https://api.github.com/users/alemrtv/repos","events_url":"https://api.github.com/users/alemrtv/events{/privacy}","received_events_url":"https://api.github.com/users/alemrtv/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-06-22T13:15:00Z","updated_at":"2022-06-22T13:15:00Z","body":"We use a structure `S` which (simplified) looks like this:\r\n```go\r\nimport \"github.com/go-redis/redis/v8\"\r\n...\r\ntype S struct {\r\n  mu sync.RWMutex\r\n  ring *redis.Ring\r\n  ...\r\n}\r\n\r\n`*redis.Ring` is the one from `package redis` in go-redis/redis@v8.11.4.\r\n\r\n```\r\nAnd function `f` which (simplified) does something like this:\r\n```go\r\nfunc (s *S) f() {\r\n  s.mu.Lock()\r\n  defer s.mu.Unlock()\r\n  ...\r\n  // here we change opts.Addrs map\r\n  var newOpts redis.RingOptions = ... \r\n  // here the shards map gets changed and we substitute the old ring with the new one\r\n  prev, s.ring = s.ring, redis.NewRing(&newOpts) the//new one\r\n  ...\r\n  defer func() {\r\n    if prev != nil {\r\n      go func() {\r\n        if err := prev.Close(); err != nil {\r\n          log(err)\r\n        }\r\n      }()    \r\n    }\r\n  }()\r\n}\r\n```\r\n\r\nAt some random points of time we call `f()` to reinitialize S in order to change `opts.Addrs`. We take the lock while doing this to avoid any race conditions. \r\n\r\nHowever, as I can see in the source code, between the moment [when the hash is calculated](https://github.com/go-redis/redis/blob/a40b4f0f69429e0b11945193cbcc05e565cd9776/ring.go#L643) and the moment [when we retrieve a shard by it a bit later](https://github.com/go-redis/redis/blob/a40b4f0f69429e0b11945193cbcc05e565cd9776/ring.go#L668), there is no lock held. \r\n\r\nI suppose that we might have a situation, when things happen in the following order:\r\n1. The `hash` is calculated in `generalProcessPipeline()`\r\n2. Our `s.f()` is called, it does its work and changes the shards map\r\n3. `GetByName()` tries to retrieve a shard with an invalid hash and gets a shard without checking if it is nil. This is where the nil pointer dereference happens.","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/redis/go-redis/issues/comments/1163083220/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"alemrtv","id":33660441,"node_id":"MDQ6VXNlcjMzNjYwNDQx","avatar_url":"https://avatars.githubusercontent.com/u/33660441?v=4","gravatar_id":"","url":"https://api.github.com/users/alemrtv","html_url":"https://github.com/alemrtv","followers_url":"https://api.github.com/users/alemrtv/followers","following_url":"https://api.github.com/users/alemrtv/following{/other_user}","gists_url":"https://api.github.com/users/alemrtv/gists{/gist_id}","starred_url":"https://api.github.com/users/alemrtv/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alemrtv/subscriptions","organizations_url":"https://api.github.com/users/alemrtv/orgs","repos_url":"https://api.github.com/users/alemrtv/repos","events_url":"https://api.github.com/users/alemrtv/events{/privacy}","received_events_url":"https://api.github.com/users/alemrtv/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":6882206301,"node_id":"LE_lADOAE8G285MNTmwzwAAAAGaNiJd","url":"https://api.github.com/repos/redis/go-redis/issues/events/6882206301","actor":{"login":"vmihailenco","id":290976,"node_id":"MDQ6VXNlcjI5MDk3Ng==","avatar_url":"https://avatars.githubusercontent.com/u/290976?v=4","gravatar_id":"","url":"https://api.github.com/users/vmihailenco","html_url":"https://github.com/vmihailenco","followers_url":"https://api.github.com/users/vmihailenco/followers","following_url":"https://api.github.com/users/vmihailenco/following{/other_user}","gists_url":"https://api.github.com/users/vmihailenco/gists{/gist_id}","starred_url":"https://api.github.com/users/vmihailenco/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/vmihailenco/subscriptions","organizations_url":"https://api.github.com/users/vmihailenco/orgs","repos_url":"https://api.github.com/users/vmihailenco/repos","events_url":"https://api.github.com/users/vmihailenco/events{/privacy}","received_events_url":"https://api.github.com/users/vmihailenco/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2022-06-27T06:04:30Z","label":{"name":"bug","color":"fc2929"},"performed_via_github_app":null},{"id":6986817730,"node_id":"REFE_lADOAE8G285MNTmwzwAAAAGgcmDC","url":"https://api.github.com/repos/redis/go-redis/issues/events/6986817730","actor":{"login":"kavu","id":1994,"node_id":"MDQ6VXNlcjE5OTQ=","avatar_url":"https://avatars.githubusercontent.com/u/1994?v=4","gravatar_id":"","url":"https://api.github.com/users/kavu","html_url":"https://github.com/kavu","followers_url":"https://api.github.com/users/kavu/followers","following_url":"https://api.github.com/users/kavu/following{/other_user}","gists_url":"https://api.github.com/users/kavu/gists{/gist_id}","starred_url":"https://api.github.com/users/kavu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kavu/subscriptions","organizations_url":"https://api.github.com/users/kavu/orgs","repos_url":"https://api.github.com/users/kavu/repos","events_url":"https://api.github.com/users/kavu/events{/privacy}","received_events_url":"https://api.github.com/users/kavu/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"1d4456bba4df8a1ff97300f761899be9788a21a9","commit_url":"https://api.github.com/repos/kavu/redis/commits/1d4456bba4df8a1ff97300f761899be9788a21a9","created_at":"2022-07-13T14:59:59Z","performed_via_github_app":null},{"actor":{"login":"kavu","id":1994,"node_id":"MDQ6VXNlcjE5OTQ=","avatar_url":"https://avatars.githubusercontent.com/u/1994?v=4","gravatar_id":"","url":"https://api.github.com/users/kavu","html_url":"https://github.com/kavu","followers_url":"https://api.github.com/users/kavu/followers","following_url":"https://api.github.com/users/kavu/following{/other_user}","gists_url":"https://api.github.com/users/kavu/gists{/gist_id}","starred_url":"https://api.github.com/users/kavu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kavu/subscriptions","organizations_url":"https://api.github.com/users/kavu/orgs","repos_url":"https://api.github.com/users/kavu/repos","events_url":"https://api.github.com/users/kavu/events{/privacy}","received_events_url":"https://api.github.com/users/kavu/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-07-13T15:06:37Z","updated_at":"2022-07-13T15:06:37Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/redis/go-redis/issues/2153","repository_url":"https://api.github.com/repos/redis/go-redis","labels_url":"https://api.github.com/repos/redis/go-redis/issues/2153/labels{/name}","comments_url":"https://api.github.com/repos/redis/go-redis/issues/2153/comments","events_url":"https://api.github.com/repos/redis/go-redis/issues/2153/events","html_url":"https://github.com/redis/go-redis/pull/2153","id":1303575771,"node_id":"PR_kwDOAE8G2847WACW","number":2153,"title":"fix: Handle panic in ringShards Hash function when Ring got closed","user":{"login":"kavu","id":1994,"node_id":"MDQ6VXNlcjE5OTQ=","avatar_url":"https://avatars.githubusercontent.com/u/1994?v=4","gravatar_id":"","url":"https://api.github.com/users/kavu","html_url":"https://github.com/kavu","followers_url":"https://api.github.com/users/kavu/followers","following_url":"https://api.github.com/users/kavu/following{/other_user}","gists_url":"https://api.github.com/users/kavu/gists{/gist_id}","starred_url":"https://api.github.com/users/kavu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kavu/subscriptions","organizations_url":"https://api.github.com/users/kavu/orgs","repos_url":"https://api.github.com/users/kavu/repos","events_url":"https://api.github.com/users/kavu/events{/privacy}","received_events_url":"https://api.github.com/users/kavu/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-07-13T15:06:37Z","updated_at":"2022-07-28T10:25:07Z","closed_at":"2022-07-28T10:25:06Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"draft":false,"repository":{"id":5179099,"node_id":"MDEwOlJlcG9zaXRvcnk1MTc5MDk5","name":"go-redis","full_name":"redis/go-redis","private":false,"owner":{"login":"redis","id":1529926,"node_id":"MDEyOk9yZ2FuaXphdGlvbjE1Mjk5MjY=","avatar_url":"https://avatars.githubusercontent.com/u/1529926?v=4","gravatar_id":"","url":"https://api.github.com/users/redis","html_url":"https://github.com/redis","followers_url":"https://api.github.com/users/redis/followers","following_url":"https://api.github.com/users/redis/following{/other_user}","gists_url":"https://api.github.com/users/redis/gists{/gist_id}","starred_url":"https://api.github.com/users/redis/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/redis/subscriptions","organizations_url":"https://api.github.com/users/redis/orgs","repos_url":"https://api.github.com/users/redis/repos","events_url":"https://api.github.com/users/redis/events{/privacy}","received_events_url":"https://api.github.com/users/redis/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/redis/go-redis","description":"Redis Go client","fork":false,"url":"https://api.github.com/repos/redis/go-redis","forks_url":"https://api.github.com/repos/redis/go-redis/forks","keys_url":"https://api.github.com/repos/redis/go-redis/keys{/key_id}","collaborators_url":"https://api.github.com/repos/redis/go-redis/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/redis/go-redis/teams","hooks_url":"https://api.github.com/repos/redis/go-redis/hooks","issue_events_url":"https://api.github.com/repos/redis/go-redis/issues/events{/number}","events_url":"https://api.github.com/repos/redis/go-redis/events","assignees_url":"https://api.github.com/repos/redis/go-redis/assignees{/user}","branches_url":"https://api.github.com/repos/redis/go-redis/branches{/branch}","tags_url":"https://api.github.com/repos/redis/go-redis/tags","blobs_url":"https://api.github.com/repos/redis/go-redis/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/redis/go-redis/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/redis/go-redis/git/refs{/sha}","trees_url":"https://api.github.com/repos/redis/go-redis/git/trees{/sha}","statuses_url":"https://api.github.com/repos/redis/go-redis/statuses/{sha}","languages_url":"https://api.github.com/repos/redis/go-redis/languages","stargazers_url":"https://api.github.com/repos/redis/go-redis/stargazers","contributors_url":"https://api.github.com/repos/redis/go-redis/contributors","subscribers_url":"https://api.github.com/repos/redis/go-redis/subscribers","subscription_url":"https://api.github.com/repos/redis/go-redis/subscription","commits_url":"https://api.github.com/repos/redis/go-redis/commits{/sha}","git_commits_url":"https://api.github.com/repos/redis/go-redis/git/commits{/sha}","comments_url":"https://api.github.com/repos/redis/go-redis/comments{/number}","issue_comment_url":"https://api.github.com/repos/redis/go-redis/issues/comments{/number}","contents_url":"https://api.github.com/repos/redis/go-redis/contents/{+path}","compare_url":"https://api.github.com/repos/redis/go-redis/compare/{base}...{head}","merges_url":"https://api.github.com/repos/redis/go-redis/merges","archive_url":"https://api.github.com/repos/redis/go-redis/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/redis/go-redis/downloads","issues_url":"https://api.github.com/repos/redis/go-redis/issues{/number}","pulls_url":"https://api.github.com/repos/redis/go-redis/pulls{/number}","milestones_url":"https://api.github.com/repos/redis/go-redis/milestones{/number}","notifications_url":"https://api.github.com/repos/redis/go-redis/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/redis/go-redis/labels{/name}","releases_url":"https://api.github.com/repos/redis/go-redis/releases{/id}","deployments_url":"https://api.github.com/repos/redis/go-redis/deployments","created_at":"2012-07-25T13:01:39Z","updated_at":"2025-11-10T11:10:52Z","pushed_at":"2025-11-10T11:29:31Z","git_url":"git://github.com/redis/go-redis.git","ssh_url":"git@github.com:redis/go-redis.git","clone_url":"https://github.com/redis/go-redis.git","svn_url":"https://github.com/redis/go-redis","homepage":"https://redis.io","size":11410,"stargazers_count":21654,"watchers_count":21654,"language":"Go","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":false,"has_pages":false,"has_discussions":true,"forks_count":2521,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":71,"license":{"key":"bsd-2-clause","name":"BSD 2-Clause \"Simplified\" License","spdx_id":"BSD-2-Clause","url":"https://api.github.com/licenses/bsd-2-clause","node_id":"MDc6TGljZW5zZTQ="},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["go","golang","redis","redis-client","redis-cluster"],"visibility":"public","forks":2521,"open_issues":71,"watchers":21654,"default_branch":"master","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"pull_request":{"url":"https://api.github.com/repos/redis/go-redis/pulls/2153","html_url":"https://github.com/redis/go-redis/pull/2153","diff_url":"https://github.com/redis/go-redis/pull/2153.diff","patch_url":"https://github.com/redis/go-redis/pull/2153.patch","merged_at":"2022-07-28T10:25:06Z"},"body":"Fixes #2126 \r\n\r\nTried to figure out how we can fix the #2126 the panic that raises from `func (c *ringShards) Hash(key string)`. And the easiest way is no add missing wiping of `numShard` on `ringShards`, so `c.hash.Get` (where `hash` is nil) will not be called.\r\n\r\nInteresting thing that without moving the `c.mu.RUnlock()` in `func (c *ringShards) Hash(key string)` up and to make it deferred test got completely stuck. I think it is connected to the unhandled panic. In a deferred approach mutex will be released no matter how the function exited. So I changed some of the locks to avoid similar problems in other places.","reactions":{"url":"https://api.github.com/repos/redis/go-redis/issues/2153/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/redis/go-redis/issues/2153/timeline","performed_via_github_app":null,"state_reason":null}},"event":"cross-referenced"},{"id":6986891976,"node_id":"REFE_lADOAE8G285MNTmwzwAAAAGgc4LI","url":"https://api.github.com/repos/redis/go-redis/issues/events/6986891976","actor":{"login":"kavu","id":1994,"node_id":"MDQ6VXNlcjE5OTQ=","avatar_url":"https://avatars.githubusercontent.com/u/1994?v=4","gravatar_id":"","url":"https://api.github.com/users/kavu","html_url":"https://github.com/kavu","followers_url":"https://api.github.com/users/kavu/followers","following_url":"https://api.github.com/users/kavu/following{/other_user}","gists_url":"https://api.github.com/users/kavu/gists{/gist_id}","starred_url":"https://api.github.com/users/kavu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kavu/subscriptions","organizations_url":"https://api.github.com/users/kavu/orgs","repos_url":"https://api.github.com/users/kavu/repos","events_url":"https://api.github.com/users/kavu/events{/privacy}","received_events_url":"https://api.github.com/users/kavu/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"ffbab222837fba21519440ce4020beb28951e6a4","commit_url":"https://api.github.com/repos/kavu/redis/commits/ffbab222837fba21519440ce4020beb28951e6a4","created_at":"2022-07-13T15:08:28Z","performed_via_github_app":null},{"id":6986903265,"node_id":"REFE_lADOAE8G285MNTmwzwAAAAGgc67h","url":"https://api.github.com/repos/redis/go-redis/issues/events/6986903265","actor":{"login":"kavu","id":1994,"node_id":"MDQ6VXNlcjE5OTQ=","avatar_url":"https://avatars.githubusercontent.com/u/1994?v=4","gravatar_id":"","url":"https://api.github.com/users/kavu","html_url":"https://github.com/kavu","followers_url":"https://api.github.com/users/kavu/followers","following_url":"https://api.github.com/users/kavu/following{/other_user}","gists_url":"https://api.github.com/users/kavu/gists{/gist_id}","starred_url":"https://api.github.com/users/kavu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kavu/subscriptions","organizations_url":"https://api.github.com/users/kavu/orgs","repos_url":"https://api.github.com/users/kavu/repos","events_url":"https://api.github.com/users/kavu/events{/privacy}","received_events_url":"https://api.github.com/users/kavu/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"a80b84f01f9fc0d3e6f08445ba21f7e07880775e","commit_url":"https://api.github.com/repos/kavu/redis/commits/a80b84f01f9fc0d3e6f08445ba21f7e07880775e","created_at":"2022-07-13T15:09:51Z","performed_via_github_app":null},{"id":6987089609,"node_id":"REFE_lADOAE8G285MNTmwzwAAAAGgdobJ","url":"https://api.github.com/repos/redis/go-redis/issues/events/6987089609","actor":{"login":"kavu","id":1994,"node_id":"MDQ6VXNlcjE5OTQ=","avatar_url":"https://avatars.githubusercontent.com/u/1994?v=4","gravatar_id":"","url":"https://api.github.com/users/kavu","html_url":"https://github.com/kavu","followers_url":"https://api.github.com/users/kavu/followers","following_url":"https://api.github.com/users/kavu/following{/other_user}","gists_url":"https://api.github.com/users/kavu/gists{/gist_id}","starred_url":"https://api.github.com/users/kavu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kavu/subscriptions","organizations_url":"https://api.github.com/users/kavu/orgs","repos_url":"https://api.github.com/users/kavu/repos","events_url":"https://api.github.com/users/kavu/events{/privacy}","received_events_url":"https://api.github.com/users/kavu/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"a9a5affc9801e06dc87dde77d71720bc227b1296","commit_url":"https://api.github.com/repos/kavu/redis/commits/a9a5affc9801e06dc87dde77d71720bc227b1296","created_at":"2022-07-13T15:32:45Z","performed_via_github_app":null},{"actor":{"login":"kavu","id":1994,"node_id":"MDQ6VXNlcjE5OTQ=","avatar_url":"https://avatars.githubusercontent.com/u/1994?v=4","gravatar_id":"","url":"https://api.github.com/users/kavu","html_url":"https://github.com/kavu","followers_url":"https://api.github.com/users/kavu/followers","following_url":"https://api.github.com/users/kavu/following{/other_user}","gists_url":"https://api.github.com/users/kavu/gists{/gist_id}","starred_url":"https://api.github.com/users/kavu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kavu/subscriptions","organizations_url":"https://api.github.com/users/kavu/orgs","repos_url":"https://api.github.com/users/kavu/repos","events_url":"https://api.github.com/users/kavu/events{/privacy}","received_events_url":"https://api.github.com/users/kavu/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-07-14T19:54:39Z","updated_at":"2022-07-14T19:54:39Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/redis/go-redis/issues/2157","repository_url":"https://api.github.com/repos/redis/go-redis","labels_url":"https://api.github.com/repos/redis/go-redis/issues/2157/labels{/name}","comments_url":"https://api.github.com/repos/redis/go-redis/issues/2157/comments","events_url":"https://api.github.com/repos/redis/go-redis/issues/2157/events","html_url":"https://github.com/redis/go-redis/pull/2157","id":1305226273,"node_id":"PR_kwDOAE8G2847bgOi","number":2157,"title":"fix: provide a signal channel to end heartbeat goroutine","user":{"login":"kavu","id":1994,"node_id":"MDQ6VXNlcjE5OTQ=","avatar_url":"https://avatars.githubusercontent.com/u/1994?v=4","gravatar_id":"","url":"https://api.github.com/users/kavu","html_url":"https://github.com/kavu","followers_url":"https://api.github.com/users/kavu/followers","following_url":"https://api.github.com/users/kavu/following{/other_user}","gists_url":"https://api.github.com/users/kavu/gists{/gist_id}","starred_url":"https://api.github.com/users/kavu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kavu/subscriptions","organizations_url":"https://api.github.com/users/kavu/orgs","repos_url":"https://api.github.com/users/kavu/repos","events_url":"https://api.github.com/users/kavu/events{/privacy}","received_events_url":"https://api.github.com/users/kavu/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2022-07-14T19:54:39Z","updated_at":"2022-07-28T10:23:33Z","closed_at":"2022-07-28T10:23:33Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"draft":false,"repository":{"id":5179099,"node_id":"MDEwOlJlcG9zaXRvcnk1MTc5MDk5","name":"go-redis","full_name":"redis/go-redis","private":false,"owner":{"login":"redis","id":1529926,"node_id":"MDEyOk9yZ2FuaXphdGlvbjE1Mjk5MjY=","avatar_url":"https://avatars.githubusercontent.com/u/1529926?v=4","gravatar_id":"","url":"https://api.github.com/users/redis","html_url":"https://github.com/redis","followers_url":"https://api.github.com/users/redis/followers","following_url":"https://api.github.com/users/redis/following{/other_user}","gists_url":"https://api.github.com/users/redis/gists{/gist_id}","starred_url":"https://api.github.com/users/redis/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/redis/subscriptions","organizations_url":"https://api.github.com/users/redis/orgs","repos_url":"https://api.github.com/users/redis/repos","events_url":"https://api.github.com/users/redis/events{/privacy}","received_events_url":"https://api.github.com/users/redis/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/redis/go-redis","description":"Redis Go client","fork":false,"url":"https://api.github.com/repos/redis/go-redis","forks_url":"https://api.github.com/repos/redis/go-redis/forks","keys_url":"https://api.github.com/repos/redis/go-redis/keys{/key_id}","collaborators_url":"https://api.github.com/repos/redis/go-redis/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/redis/go-redis/teams","hooks_url":"https://api.github.com/repos/redis/go-redis/hooks","issue_events_url":"https://api.github.com/repos/redis/go-redis/issues/events{/number}","events_url":"https://api.github.com/repos/redis/go-redis/events","assignees_url":"https://api.github.com/repos/redis/go-redis/assignees{/user}","branches_url":"https://api.github.com/repos/redis/go-redis/branches{/branch}","tags_url":"https://api.github.com/repos/redis/go-redis/tags","blobs_url":"https://api.github.com/repos/redis/go-redis/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/redis/go-redis/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/redis/go-redis/git/refs{/sha}","trees_url":"https://api.github.com/repos/redis/go-redis/git/trees{/sha}","statuses_url":"https://api.github.com/repos/redis/go-redis/statuses/{sha}","languages_url":"https://api.github.com/repos/redis/go-redis/languages","stargazers_url":"https://api.github.com/repos/redis/go-redis/stargazers","contributors_url":"https://api.github.com/repos/redis/go-redis/contributors","subscribers_url":"https://api.github.com/repos/redis/go-redis/subscribers","subscription_url":"https://api.github.com/repos/redis/go-redis/subscription","commits_url":"https://api.github.com/repos/redis/go-redis/commits{/sha}","git_commits_url":"https://api.github.com/repos/redis/go-redis/git/commits{/sha}","comments_url":"https://api.github.com/repos/redis/go-redis/comments{/number}","issue_comment_url":"https://api.github.com/repos/redis/go-redis/issues/comments{/number}","contents_url":"https://api.github.com/repos/redis/go-redis/contents/{+path}","compare_url":"https://api.github.com/repos/redis/go-redis/compare/{base}...{head}","merges_url":"https://api.github.com/repos/redis/go-redis/merges","archive_url":"https://api.github.com/repos/redis/go-redis/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/redis/go-redis/downloads","issues_url":"https://api.github.com/repos/redis/go-redis/issues{/number}","pulls_url":"https://api.github.com/repos/redis/go-redis/pulls{/number}","milestones_url":"https://api.github.com/repos/redis/go-redis/milestones{/number}","notifications_url":"https://api.github.com/repos/redis/go-redis/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/redis/go-redis/labels{/name}","releases_url":"https://api.github.com/repos/redis/go-redis/releases{/id}","deployments_url":"https://api.github.com/repos/redis/go-redis/deployments","created_at":"2012-07-25T13:01:39Z","updated_at":"2025-11-10T11:10:52Z","pushed_at":"2025-11-10T11:29:31Z","git_url":"git://github.com/redis/go-redis.git","ssh_url":"git@github.com:redis/go-redis.git","clone_url":"https://github.com/redis/go-redis.git","svn_url":"https://github.com/redis/go-redis","homepage":"https://redis.io","size":11410,"stargazers_count":21654,"watchers_count":21654,"language":"Go","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":false,"has_pages":false,"has_discussions":true,"forks_count":2521,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":71,"license":{"key":"bsd-2-clause","name":"BSD 2-Clause \"Simplified\" License","spdx_id":"BSD-2-Clause","url":"https://api.github.com/licenses/bsd-2-clause","node_id":"MDc6TGljZW5zZTQ="},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["go","golang","redis","redis-client","redis-cluster"],"visibility":"public","forks":2521,"open_issues":71,"watchers":21654,"default_branch":"master","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"pull_request":{"url":"https://api.github.com/repos/redis/go-redis/pulls/2157","html_url":"https://github.com/redis/go-redis/pull/2157","diff_url":"https://github.com/redis/go-redis/pull/2157.diff","patch_url":"https://github.com/redis/go-redis/pull/2157.patch","merged_at":"2022-07-28T10:23:33Z"},"body":"Hi!\r\n\r\nWe continue to investigate various problems with `Ring` which arise from our case, briefly described in #2126.\r\n\r\nThis time it is massive goroutines leaks of Heartbeat goroutines. The reason is that there is no way to exit the ticker `range channel` loop: \r\n\r\nhttps://github.com/go-redis/redis/blob/e061db8c13fd6b5e007d73370873026e360719de/ring.go#L313-L334\r\n\r\nSimple program to demonstrate the problem:\r\n\r\n```go\r\npackage main\r\n\r\nimport (\r\n\t\"context\"\r\n\t\"fmt\"\r\n\t\"log\"\r\n\t\"net/http\"\r\n\t_ \"net/http/pprof\"\r\n\t\"runtime\"\r\n\r\n\t\"github.com/go-redis/redis/v9\"\r\n)\r\n\r\nfunc main() {\r\n\tctx := context.Background()\r\n\r\n\topts := &redis.RingOptions{\r\n\t\tAddrs: map[string]string{\r\n\t\t\t\"shard0\": \":6379\",\r\n\t\t},\r\n\t}\r\n\r\n\tfor i := 0; i < 1000; i++ {\r\n\t\trdb := redis.NewRing(opts)\r\n\t\trdb.Ping(ctx)\r\n\t\trdb.Close()\r\n\t}\r\n\r\n\t// Let's check how many Goroutines we have now\r\n\tfmt.Println(runtime.NumGoroutine())\r\n\r\n\t// Let's start HTTP and check pprof at http://localhost:8080/debug/pprof/goroutine?debug=1\r\n\tlog.Println(http.ListenAndServe(\":8080\", nil))\r\n}\r\n\r\n```\r\n\r\nIn this example will see around 1000 goroutines, and `pprof/goroutine` profile will show something like (note the thousand):\r\n\r\n```\r\ngoroutine profile: total 1003\r\n1000 @ 0x102f93878 0x102f62cc0 0x102f62724 0x103191688 0x102fc2dc4\r\n#\t0x103191687\tgithub.com/go-redis/redis/v9.(*ringShards).Heartbeat+0x87\t/Users/kavu/go/pkg/mod/github.com/go-redis/redis/v9@v9.0.0-beta.1.0.20220714104342-e061db8c13fd/ring.go:318\r\n\r\n1 @ 0x102f93878 0x102f8cf54 0x102fbd094 0x103002edc 0x103003a14 0x103003a05 0x10308637c 0x1030907d8 0x103126058 0x102fc2dc4\r\n#\t0x102fbd093\tinternal/poll.runtime_pollWait+0xa3\t\t/opt/homebrew/Cellar/go/1.18.4/libexec/src/runtime/netpoll.go:302\r\n#\t0x103002edb\tinternal/poll.(*pollDesc).wait+0x2b\t\t/opt/homebrew/Cellar/go/1.18.4/libexec/src/internal/poll/fd_poll_runtime.go:83\r\n``` \r\n\r\nSuch an amount of goroutines alone can create a visible pressure on CPU (actually this amount is almost exactly the same as we observed one of our services), but if you will set a pretty low value for a heartbeat frequency it can become even more visible and painful.\r\n\r\nI tested in on v8, current v9 beta, and the latest master commit, just to be 100% sure.\r\n\r\nSo I suggest a relatively straightforward approach â€” a signal channel for the goroutine to end the loop.\r\n\r\nAnother additional option to consider is an option to disable heartbeats completely. Sill, it won't be enough, as in cases when it is enabled leak will still be observed. \r\n\r\nI'll gladly discuss any other approach here if you have any concerns here.\r\n\r\nThank you!","reactions":{"url":"https://api.github.com/repos/redis/go-redis/issues/2157/reactions","total_count":4,"+1":4,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/redis/go-redis/issues/2157/timeline","performed_via_github_app":null,"state_reason":null}},"event":"cross-referenced"},{"id":7080134466,"node_id":"CE_lADOAE8G285MNTmwzwAAAAGmAkdC","url":"https://api.github.com/repos/redis/go-redis/issues/events/7080134466","actor":{"login":"vmihailenco","id":290976,"node_id":"MDQ6VXNlcjI5MDk3Ng==","avatar_url":"https://avatars.githubusercontent.com/u/290976?v=4","gravatar_id":"","url":"https://api.github.com/users/vmihailenco","html_url":"https://github.com/vmihailenco","followers_url":"https://api.github.com/users/vmihailenco/followers","following_url":"https://api.github.com/users/vmihailenco/following{/other_user}","gists_url":"https://api.github.com/users/vmihailenco/gists{/gist_id}","starred_url":"https://api.github.com/users/vmihailenco/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/vmihailenco/subscriptions","organizations_url":"https://api.github.com/users/vmihailenco/orgs","repos_url":"https://api.github.com/users/vmihailenco/repos","events_url":"https://api.github.com/users/vmihailenco/events{/privacy}","received_events_url":"https://api.github.com/users/vmihailenco/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"closed","commit_id":null,"commit_url":null,"created_at":"2022-07-28T10:25:07Z","state_reason":null,"performed_via_github_app":null}]