{"url":"https://api.github.com/repos/redis/go-redis/issues/1766","repository_url":"https://api.github.com/repos/redis/go-redis","labels_url":"https://api.github.com/repos/redis/go-redis/issues/1766/labels{/name}","comments_url":"https://api.github.com/repos/redis/go-redis/issues/1766/comments","events_url":"https://api.github.com/repos/redis/go-redis/issues/1766/events","html_url":"https://github.com/redis/go-redis/issues/1766","id":902628316,"node_id":"MDU6SXNzdWU5MDI2MjgzMTY=","number":1766,"title":"[BUG] XReadGroup method hashes incorrect key. Leads to NOGROUP error.","user":{"login":"dhh93","id":50035896,"node_id":"MDQ6VXNlcjUwMDM1ODk2","avatar_url":"https://avatars.githubusercontent.com/u/50035896?v=4","gravatar_id":"","url":"https://api.github.com/users/dhh93","html_url":"https://github.com/dhh93","followers_url":"https://api.github.com/users/dhh93/followers","following_url":"https://api.github.com/users/dhh93/following{/other_user}","gists_url":"https://api.github.com/users/dhh93/gists{/gist_id}","starred_url":"https://api.github.com/users/dhh93/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dhh93/subscriptions","organizations_url":"https://api.github.com/users/dhh93/orgs","repos_url":"https://api.github.com/users/dhh93/repos","events_url":"https://api.github.com/users/dhh93/events{/privacy}","received_events_url":"https://api.github.com/users/dhh93/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2021-05-26T16:17:07Z","updated_at":"2021-05-27T03:24:25Z","closed_at":"2021-05-27T03:24:25Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Hello,\r\n\r\nThere seems to be a bug in the slice indexing logic in the `XReadGroup` method that results in the incorrect key being hashed. When used with `Ring`, this causes the client to search through an incorrect shard, which throws a `NOGROUP` / key not found error.\r\n\r\nI think the initial `keyPos` in [commands.go/Line 1774](https://github.com/go-redis/redis/blob/8f0fbd2fe81b4af1a394a0109820362df011c0ae/commands.go#L1774) should start at `3` instead of `1`. Because `GROUP group consumer` are three required parameters in the [XREADGROUP](https://redis.io/commands/xreadgroup) command, the current iteration logic stops about 3 indices too short.\r\n\r\n## Expected Behavior\r\n\r\nConsider the following command:\r\n\r\n`XREADGROUP GROUP foo bar COUNT 10 BLOCK 0 STREAMS hello >`\r\n- `keyPos` should be `9`, but the current value is `6`. Code hashes `block` instead of `hello`.\r\n\r\nIf `COUNT` is omitted (pulling in every message):\r\n\r\n`XREADGROUP GROUP foo bar BLOCK 0 STREAMS hello >`\r\n- `keyPos` should be `7`, but the current value is `4`. \r\n\r\n## Current Behavior\r\n\r\nSee above.\r\n\r\n## Possible Solution\r\n\r\n1. Change starting index position to 3 in [Line 1774](https://github.com/go-redis/redis/blob/8f0fbd2fe81b4af1a394a0109820362df011c0ae/commands.go#L1774)\r\n2. Increment `keyPos` by 2 instead of 1 in [Line 1785](https://github.com/go-redis/redis/blob/8f0fbd2fe81b4af1a394a0109820362df011c0ae/commands.go#L1785) to start at first key instead of the `STREAMS` parameter\r\n\r\n### Current code\r\n\r\n```go\r\n\tkeyPos := int8(1) \r\n\tif a.Count > 0 {\r\n\t\targs = append(args, \"count\", a.Count)\r\n\t\tkeyPos += 2\r\n\t}\r\n\tif a.Block >= 0 {\r\n\t\targs = append(args, \"block\", int64(a.Block/time.Millisecond))\r\n\t\tkeyPos += 2\r\n\t}\r\n\tif a.NoAck {\r\n\t\targs = append(args, \"noack\")\r\n\t\tkeyPos++\r\n\t}\r\n\targs = append(args, \"streams\")\r\n\tkeyPos++\r\n\tfor _, s := range a.Streams {\r\n\t\targs = append(args, s)\r\n\t}\r\n```\r\n\r\n### Proposed Change\r\n\r\n```go\r\n\tkeyPos := int8(3) // XREADGROUP GROUP group consumer are required parameters, start at index 3\r\n\tif a.Count > 0 {\r\n\t\targs = append(args, \"count\", a.Count)\r\n\t\tkeyPos += 2\r\n\t}\r\n\tif a.Block >= 0 {\r\n\t\targs = append(args, \"block\", int64(a.Block/time.Millisecond))\r\n\t\tkeyPos += 2\r\n\t}\r\n\tif a.NoAck {\r\n\t\targs = append(args, \"noack\")\r\n\t\tkeyPos++\r\n\t}\r\n\targs = append(args, \"streams\")\r\n\tkeyPos += 2 // increment by 2 instead of 1 so the cursor starts at first key\r\n\tfor _, s := range a.Streams {\r\n\t\targs = append(args, s)\r\n\t}\r\n```\r\n\r\n## Steps to Reproduce\r\n\r\n1. `*Ring` client with >1 shard\r\n2. Stream `hello` with consumer group `foo`\r\n\r\nSample code below:\r\n\r\n```go\r\npackage main\r\n\r\nimport (\r\n\t\"context\"\r\n\r\n\t\"github.com/go-redis/redis/v8\"\r\n)\r\n\r\nfunc main() {\r\n\trdb := redis.NewRing(&redis.RingOptions{\r\n\t\tAddrs: map[string]string{\r\n\t\t\t\"shard1\": \":7000\",\r\n\t\t\t\"shard2\": \":7001\",\r\n\t\t\t\"shard3\": \":7002\",\r\n\t\t},\r\n\t})\r\n\r\n\t// create stream \"hello\" with consumer group \"foo\" and ID \"0\" (fetch entire msg history)\r\n\r\n\t_, _ = rdb.XGroupCreateMkStream(context.Background(), \"hello\", \"foo\", \"0\")\r\n\r\n\t// add test message\r\n\r\n\txArgs := &redis.XAddArgs{\r\n\t\tStream: \"hello\",\r\n\t\tValues: map[string]interface{}{\r\n\t\t\t\"hello\": \"world\",\r\n\t\t},\r\n\t}\r\n\r\n\t_, _ = rdb.XAdd(context.Background(), xArgs).Result()\r\n\r\n\t// read message from stream as consumer \"Bob\" and group \"foo\"\r\n\r\n\treadArgs := &redis.XReadGroupArgs{\r\n\t\tGroup:    \"foo\",\r\n\t\tConsumer: \"Bob\",\r\n\t\tStreams:  []string{\"hello\", \">\"},\r\n\t\tCount:    10,\r\n\t\t// Block and NoAck zero values\r\n\t}\r\n\r\n\t_, _ = rdb.XReadGroup(context.Background(), readArgs).Result()\r\n\r\n\t// Should throw the following error:\r\n\t// NOGROUP No such key 'hello' or consumer group 'foo' in XREADGROUP with GROUP option\r\n\r\n}\r\n```","closed_by":{"login":"monkey92t","id":23448594,"node_id":"MDQ6VXNlcjIzNDQ4NTk0","avatar_url":"https://avatars.githubusercontent.com/u/23448594?v=4","gravatar_id":"","url":"https://api.github.com/users/monkey92t","html_url":"https://github.com/monkey92t","followers_url":"https://api.github.com/users/monkey92t/followers","following_url":"https://api.github.com/users/monkey92t/following{/other_user}","gists_url":"https://api.github.com/users/monkey92t/gists{/gist_id}","starred_url":"https://api.github.com/users/monkey92t/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/monkey92t/subscriptions","organizations_url":"https://api.github.com/users/monkey92t/orgs","repos_url":"https://api.github.com/users/monkey92t/repos","events_url":"https://api.github.com/users/monkey92t/events{/privacy}","received_events_url":"https://api.github.com/users/monkey92t/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/redis/go-redis/issues/1766/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/redis/go-redis/issues/1766/timeline","performed_via_github_app":null,"state_reason":"completed"}