{"url":"https://api.github.com/repos/redis/go-redis/issues/578","repository_url":"https://api.github.com/repos/redis/go-redis","labels_url":"https://api.github.com/repos/redis/go-redis/issues/578/labels{/name}","comments_url":"https://api.github.com/repos/redis/go-redis/issues/578/comments","events_url":"https://api.github.com/repos/redis/go-redis/issues/578/events","html_url":"https://github.com/redis/go-redis/issues/578","id":236625665,"node_id":"MDU6SXNzdWUyMzY2MjU2NjU=","number":578,"title":"Ring client not safe for concurrent use","user":{"login":"willroberts","id":2236656,"node_id":"MDQ6VXNlcjIyMzY2NTY=","avatar_url":"https://avatars.githubusercontent.com/u/2236656?v=4","gravatar_id":"","url":"https://api.github.com/users/willroberts","html_url":"https://github.com/willroberts","followers_url":"https://api.github.com/users/willroberts/followers","following_url":"https://api.github.com/users/willroberts/following{/other_user}","gists_url":"https://api.github.com/users/willroberts/gists{/gist_id}","starred_url":"https://api.github.com/users/willroberts/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/willroberts/subscriptions","organizations_url":"https://api.github.com/users/willroberts/orgs","repos_url":"https://api.github.com/users/willroberts/repos","events_url":"https://api.github.com/users/willroberts/events{/privacy}","received_events_url":"https://api.github.com/users/willroberts/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2017-06-17T00:17:15Z","updated_at":"2017-06-17T09:42:53Z","closed_at":"2017-06-17T09:42:53Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"From: https://github.com/go-redis/redis/blob/v.5.2.9/ring.go#L113L115\r\n```\r\n// Ring is a Redis client that uses consistent hashing to distribute\r\n// keys across multiple Redis servers (shards). It's safe for\r\n// concurrent use by multiple goroutines.\r\n```\r\n\r\nOffending code: https://github.com/go-redis/redis/blob/v5.2.9/ring.go#L207L222\r\n`c.cmdsInfoOnce` is read on line 208 and written on line 216.\r\n\r\nThis is being detected as a race in my build environment (Go 1.8.0 on Linux):\r\n```\r\n23:19:11 WARNING: DATA RACE\r\n23:19:11 Write at 0x00c42016e280 by goroutine 19:\r\n23:19:11   gopkg.in/redis.v5.(*Ring).cmdInfo.func1()\r\n23:19:11       /go/src/gopkg.in/redis.v5/ring.go:216 +0x1db\r\n23:19:11   sync.(*Once).Do()\r\n23:19:11       /usr/local/go/src/sync/once.go:44 +0xe1\r\n23:19:11   gopkg.in/redis.v5.(*Ring).cmdInfo()\r\n23:19:11       /go/src/gopkg.in/redis.v5/ring.go:217 +0x9b\r\n23:19:11   gopkg.in/redis.v5.(*Ring).cmdShard()\r\n23:19:11       /go/src/gopkg.in/redis.v5/ring.go:268 +0x64\r\n23:19:11   gopkg.in/redis.v5.(*Ring).Process()\r\n23:19:11       /go/src/gopkg.in/redis.v5/ring.go:274 +0x50\r\n23:19:11   gopkg.in/redis.v5.(*Ring).Process-fm()\r\n23:19:11       /go/src/gopkg.in/redis.v5/ring.go:151 +0x55\r\n23:19:11   gopkg.in/redis.v5.(*cmdable).Del()\r\n23:19:11       /go/src/gopkg.in/redis.v5/commands.go:302 +0x250\r\n23:19:11   gopkg.in/redis.v5.(*Ring).Del()\r\n23:19:11       <autogenerated>:1005 +0x72\r\n23:19:11\r\n23:19:11 Previous read at 0x00c42016e280 by goroutine 20:\r\n23:19:11   gopkg.in/redis.v5.(*Ring).cmdInfo()\r\n23:19:11       /go/src/gopkg.in/redis.v5/ring.go:208 +0x7f\r\n23:19:11   gopkg.in/redis.v5.(*Ring).cmdShard()\r\n23:19:11       /go/src/gopkg.in/redis.v5/ring.go:268 +0x64\r\n23:19:11   gopkg.in/redis.v5.(*Ring).Process()\r\n23:19:11       /go/src/gopkg.in/redis.v5/ring.go:274 +0x50\r\n23:19:11   gopkg.in/redis.v5.(*Ring).Process-fm()\r\n23:19:11       /go/src/gopkg.in/redis.v5/ring.go:151 +0x55\r\n23:19:11   gopkg.in/redis.v5.(*cmdable).HSet()\r\n23:19:11       /go/src/gopkg.in/redis.v5/commands.go:901 +0x264\r\n23:19:11   gopkg.in/redis.v5.(*Ring).HSet()\r\n23:19:11       <autogenerated>:1071 +0x96\r\n```\r\n\r\nNote: these commands are not operating on the same key.","closed_by":{"login":"vmihailenco","id":290976,"node_id":"MDQ6VXNlcjI5MDk3Ng==","avatar_url":"https://avatars.githubusercontent.com/u/290976?v=4","gravatar_id":"","url":"https://api.github.com/users/vmihailenco","html_url":"https://github.com/vmihailenco","followers_url":"https://api.github.com/users/vmihailenco/followers","following_url":"https://api.github.com/users/vmihailenco/following{/other_user}","gists_url":"https://api.github.com/users/vmihailenco/gists{/gist_id}","starred_url":"https://api.github.com/users/vmihailenco/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/vmihailenco/subscriptions","organizations_url":"https://api.github.com/users/vmihailenco/orgs","repos_url":"https://api.github.com/users/vmihailenco/repos","events_url":"https://api.github.com/users/vmihailenco/events{/privacy}","received_events_url":"https://api.github.com/users/vmihailenco/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/redis/go-redis/issues/578/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/redis/go-redis/issues/578/timeline","performed_via_github_app":null,"state_reason":"completed"}