{"url":"https://api.github.com/repos/redis/go-redis/issues/2126","repository_url":"https://api.github.com/repos/redis/go-redis","labels_url":"https://api.github.com/repos/redis/go-redis/issues/2126/labels{/name}","comments_url":"https://api.github.com/repos/redis/go-redis/issues/2126/comments","events_url":"https://api.github.com/repos/redis/go-redis/issues/2126/events","html_url":"https://github.com/redis/go-redis/issues/2126","id":1278556592,"node_id":"I_kwDOAE8G285MNTmw","number":2126,"title":"go-redis/v8 nil shard in the shards map","user":{"login":"alemrtv","id":33660441,"node_id":"MDQ6VXNlcjMzNjYwNDQx","avatar_url":"https://avatars.githubusercontent.com/u/33660441?v=4","gravatar_id":"","url":"https://api.github.com/users/alemrtv","html_url":"https://github.com/alemrtv","followers_url":"https://api.github.com/users/alemrtv/followers","following_url":"https://api.github.com/users/alemrtv/following{/other_user}","gists_url":"https://api.github.com/users/alemrtv/gists{/gist_id}","starred_url":"https://api.github.com/users/alemrtv/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alemrtv/subscriptions","organizations_url":"https://api.github.com/users/alemrtv/orgs","repos_url":"https://api.github.com/users/alemrtv/repos","events_url":"https://api.github.com/users/alemrtv/events{/privacy}","received_events_url":"https://api.github.com/users/alemrtv/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":10161157,"node_id":"MDU6TGFiZWwxMDE2MTE1Nw==","url":"https://api.github.com/repos/redis/go-redis/labels/bug","name":"bug","color":"fc2929","default":true,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-06-21T14:42:00Z","updated_at":"2022-07-28T10:25:07Z","closed_at":"2022-07-28T10:25:07Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## Expected Behavior\r\n\r\nno panic due to nil pointer dereference after retrieving a nil shard from the shards map\r\n\r\n## Current Behavior\r\n\r\n[There is no check if a shard is not nil before returning it](https://github.com/go-redis/redis/blob/a40b4f0f69429e0b11945193cbcc05e565cd9776/ring.go#L305).\r\n\r\nIt might cause panic due to nil pointer dereference [here](https://github.com/go-redis/redis/blob/a40b4f0f69429e0b11945193cbcc05e565cd9776/ring.go#L677)\r\n\r\n## Possible Solution\r\n\r\nCheck if shard is not nil before returning it.\r\n\r\n## Steps to Reproduce\r\n\r\nWe have a proprietary code which wraps `go-redis/go` and sometimes recreates the Ring structure (and hence repopulating the shards map), all while holding the mutex.\r\nDespite it, sometimes after the ring is recreated, we get panic in the place linked above because the shard retrieved by the name is nil.\r\n\r\n## Possible Implementation\r\n\r\n```go\r\nfunc (c *ringShards) GetByName(shardName string) (*ringShard, error) {\r\n\tif shardName == \"\" {\r\n\t\treturn c.Random()\r\n\t}\r\n\r\n\tc.mu.RLock()\r\n\tshard := c.shards[shardName]\r\n\tc.mu.RUnlock()\r\n\r\n\tif shard == nil {\r\n\t\treturn nil, fmt.Errorf(\"a shard named %q is nil\", shardName)\r\n\t}\r\n\r\n\treturn shard, nil\r\n}\r\n```","closed_by":{"login":"vmihailenco","id":290976,"node_id":"MDQ6VXNlcjI5MDk3Ng==","avatar_url":"https://avatars.githubusercontent.com/u/290976?v=4","gravatar_id":"","url":"https://api.github.com/users/vmihailenco","html_url":"https://github.com/vmihailenco","followers_url":"https://api.github.com/users/vmihailenco/followers","following_url":"https://api.github.com/users/vmihailenco/following{/other_user}","gists_url":"https://api.github.com/users/vmihailenco/gists{/gist_id}","starred_url":"https://api.github.com/users/vmihailenco/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/vmihailenco/subscriptions","organizations_url":"https://api.github.com/users/vmihailenco/orgs","repos_url":"https://api.github.com/users/vmihailenco/repos","events_url":"https://api.github.com/users/vmihailenco/events{/privacy}","received_events_url":"https://api.github.com/users/vmihailenco/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/redis/go-redis/issues/2126/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/redis/go-redis/issues/2126/timeline","performed_via_github_app":null,"state_reason":"completed"}