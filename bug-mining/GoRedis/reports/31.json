{"url":"https://api.github.com/repos/redis/go-redis/issues/977","repository_url":"https://api.github.com/repos/redis/go-redis","labels_url":"https://api.github.com/repos/redis/go-redis/issues/977/labels{/name}","comments_url":"https://api.github.com/repos/redis/go-redis/issues/977/comments","events_url":"https://api.github.com/repos/redis/go-redis/issues/977/events","html_url":"https://github.com/redis/go-redis/issues/977","id":414967730,"node_id":"MDU6SXNzdWU0MTQ5Njc3MzA=","number":977,"title":"Retry error - READONLY You can't write against a read only slave.","user":{"login":"afsalparavakkal","id":27821315,"node_id":"MDQ6VXNlcjI3ODIxMzE1","avatar_url":"https://avatars.githubusercontent.com/u/27821315?v=4","gravatar_id":"","url":"https://api.github.com/users/afsalparavakkal","html_url":"https://github.com/afsalparavakkal","followers_url":"https://api.github.com/users/afsalparavakkal/followers","following_url":"https://api.github.com/users/afsalparavakkal/following{/other_user}","gists_url":"https://api.github.com/users/afsalparavakkal/gists{/gist_id}","starred_url":"https://api.github.com/users/afsalparavakkal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/afsalparavakkal/subscriptions","organizations_url":"https://api.github.com/users/afsalparavakkal/orgs","repos_url":"https://api.github.com/users/afsalparavakkal/repos","events_url":"https://api.github.com/users/afsalparavakkal/events{/privacy}","received_events_url":"https://api.github.com/users/afsalparavakkal/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2019-02-27T06:38:28Z","updated_at":"2019-03-05T10:00:58Z","closed_at":"2019-02-27T11:11:02Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"I got below error while executing LUA script using evalsha command. \r\n\r\nERR Error running script (call to f_f67cbd63cdf1434540da47a9f06f9c7d868574c6): @user_script:8: @user_script: 8: -READONLY You can't write against a read only slave\r\n\r\nI suspect this error can be reproducible for any write commands. \r\n\r\nMy findings is that, driver is able to chose and send commands to right master node for the first time. But if the first transaction fails due to timeout or EOF erros, It will retry on Random node. And one of the retry goes to the Slave of the master which has the key and redis throws this error. \r\n\r\n\r\nPlease note that, readonly option is true at my client (version : v6.15.1 https://github.com/go-redis/redis/tree/v6.15.1). \r\n\r\n\r\n**Redis slave node configuration is given below :** \r\n\r\n```\r\nport 7004\r\ncluster-enabled yes\r\ncluster-config-file nodes.conf\r\ncluster-node-timeout 5000\r\nappendonly yes\r\nrequirepass redis\r\nslave-read-only yes\r\nslave-serve-stale-data yes\r\nmasterauth redis\r\n```\r\n\r\n\r\nQuick fix I have done is given below. I request your help for a proper fix. \r\n\r\npackage : redis (cluster.go)\r\nmethod : defaultProcess\r\n\r\n```\r\nif internal.IsRetryableError(err, true) {\r\n\t\t\t// First retry the same node.\r\n\t\t\tif attempt == 0 {\r\n\t\t\t\tcontinue\r\n\t\t\t}\r\n\r\n                       // newly added block. \r\n\t\t\tcmdInfo := c.cmdInfo(cmd.Name())\r\n\t\t\t// if slave is readonly , redirect all i/o write commands to master\r\n\t\t\tif c.opt.ReadOnly && cmdInfo != nil && !cmdInfo.ReadOnly {\r\n\t\t\t\tnode = nil\r\n\t\t\t\tcontinue\r\n\t\t\t}\r\n                       // end of newly added block\r\n\r\n\t\t\t// Second try random node.\r\n\t\t\tnode, err = c.nodes.Random()\r\n\t\t\tif err != nil {\r\n\t\t\t\tbreak\r\n\t\t\t}\r\n\t\t\tcontinue\r\n\t\t}\r\n```\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\nThanks in advance. ","closed_by":{"login":"vmihailenco","id":290976,"node_id":"MDQ6VXNlcjI5MDk3Ng==","avatar_url":"https://avatars.githubusercontent.com/u/290976?v=4","gravatar_id":"","url":"https://api.github.com/users/vmihailenco","html_url":"https://github.com/vmihailenco","followers_url":"https://api.github.com/users/vmihailenco/followers","following_url":"https://api.github.com/users/vmihailenco/following{/other_user}","gists_url":"https://api.github.com/users/vmihailenco/gists{/gist_id}","starred_url":"https://api.github.com/users/vmihailenco/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/vmihailenco/subscriptions","organizations_url":"https://api.github.com/users/vmihailenco/orgs","repos_url":"https://api.github.com/users/vmihailenco/repos","events_url":"https://api.github.com/users/vmihailenco/events{/privacy}","received_events_url":"https://api.github.com/users/vmihailenco/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/redis/go-redis/issues/977/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/redis/go-redis/issues/977/timeline","performed_via_github_app":null,"state_reason":"completed"}