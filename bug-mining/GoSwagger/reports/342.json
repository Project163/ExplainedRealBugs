{"url":"https://api.github.com/repos/go-swagger/go-swagger/issues/1083","repository_url":"https://api.github.com/repos/go-swagger/go-swagger","labels_url":"https://api.github.com/repos/go-swagger/go-swagger/issues/1083/labels{/name}","comments_url":"https://api.github.com/repos/go-swagger/go-swagger/issues/1083/comments","events_url":"https://api.github.com/repos/go-swagger/go-swagger/issues/1083/events","html_url":"https://github.com/go-swagger/go-swagger/issues/1083","id":239459844,"node_id":"MDU6SXNzdWUyMzk0NTk4NDQ=","number":1083,"title":"escaped parameters fail to generate the correct url path when a base path is present.","user":{"login":"james-lawrence","id":2835871,"node_id":"MDQ6VXNlcjI4MzU4NzE=","avatar_url":"https://avatars.githubusercontent.com/u/2835871?v=4","gravatar_id":"","url":"https://api.github.com/users/james-lawrence","html_url":"https://github.com/james-lawrence","followers_url":"https://api.github.com/users/james-lawrence/followers","following_url":"https://api.github.com/users/james-lawrence/following{/other_user}","gists_url":"https://api.github.com/users/james-lawrence/gists{/gist_id}","starred_url":"https://api.github.com/users/james-lawrence/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/james-lawrence/subscriptions","organizations_url":"https://api.github.com/users/james-lawrence/orgs","repos_url":"https://api.github.com/users/james-lawrence/repos","events_url":"https://api.github.com/users/james-lawrence/events{/privacy}","received_events_url":"https://api.github.com/users/james-lawrence/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":148436504,"node_id":"MDU6TGFiZWwxNDg0MzY1MDQ=","url":"https://api.github.com/repos/go-swagger/go-swagger/labels/bug","name":"bug","color":"fc2929","default":true,"description":null},{"id":770973794,"node_id":"MDU6TGFiZWw3NzA5NzM3OTQ=","url":"https://api.github.com/repos/go-swagger/go-swagger/labels/generate%20client","name":"generate client","color":"72e0ad","default":false,"description":null},{"id":843246613,"node_id":"MDU6TGFiZWw4NDMyNDY2MTM=","url":"https://api.github.com/repos/go-swagger/go-swagger/labels/runtime","name":"runtime","color":"f29b59","default":false,"description":"Relates to github.com/go-openapi/runtime"},{"id":975136500,"node_id":"MDU6TGFiZWw5NzUxMzY1MDA=","url":"https://api.github.com/repos/go-swagger/go-swagger/labels/pending%20PR","name":"pending PR","color":"7ff47f","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2017-06-29T12:18:46Z","updated_at":"2023-12-28T08:40:40Z","closed_at":"2023-12-28T08:40:40Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"If a path parameter needs to be escaped the runtime code generates an invalid path.\r\n\r\nBasePath = \"/foo\"\r\nPath = \"/v1/{param}\"\r\n\r\nI suggest adding a transport to the HTTP client that dumps the request.\r\n```\r\nimport openapiclient \"github.com/go-openapi/runtime/client\"\r\nc := generatedClient.New(\r\n\t\topenapiclient.NewWithClient(\"localhost\", \"/foo\", []string{\"http\"}, http.DefaultClient),\r\n\t\tnil,\r\n)\r\n\r\n// all of the following fail.\r\n// passing in a raw string will invoke an invalid path: /foo/v1/param/value\r\nc.ResourceMethod((&ResourceMethodParameters{}).WithParam(\"param/value\"))\r\n// passing in an escaped string will invoke an invalid path: /foo/v1/param/value\r\nc.ResourceMethod((&ResourceMethodParameters{}).WithParam(url.PathEscape(\"param/value\")))\r\n```\r\nThese fail because of the runtime/client's interaction with URL.\r\nThe http client uses URL.EscapedPath() to determine what path to use.\r\n```\r\nfunc (u *URL) EscapedPath() string {\r\n\tif u.RawPath != \"\" && validEncodedPath(u.RawPath) {\r\n\t\tp, err := unescape(u.RawPath, encodePath)\r\n\t\tif err == nil && p == u.Path {\r\n\t\t\treturn u.RawPath\r\n\t\t}\r\n\t}\r\n\tif u.Path == \"*\" {\r\n\t\treturn \"*\" // don't escape (Issue 11202)\r\n\t}\r\n\treturn escape(u.Path, encodePath)\r\n}\r\n```\r\n\r\nclient.Runtime.Submit has the following code:\r\n```\r\nfunc (r *Runtime) Submit(operation *runtime.ClientOperation) (interface{}, error) {\r\n        // ...\r\n\tif req.URL.Path != \"\" && req.URL.Path != \"/\" && req.URL.Path[len(req.URL.Path)-1] == '/' {\r\n\t\treinstateSlash = true\r\n\t}\r\n\treq.URL.Path = path.Join(r.BasePath, req.URL.Path)\r\n\tif reinstateSlash {\r\n\t\treq.URL.Path = req.URL.Path + \"/\"\r\n\t}\r\n        // ...\r\n}\r\n```\r\n\r\nsetting `req.URL.Path = path.Join(r.BasePath, req.URL.Path)` causes url.EscapedPath() to return\r\nreq.URL.Path unescaped, since escape(u.Path, encodePath) only escapes the ?, it assumes the fragments have already been properly escaped.\r\n\r\nthe fix is to properly set both the RawPath and the Path in the submit function.\r\n```\r\n\treq.URL.Path = path.Join(r.BasePath, req.URL.Path)\r\n        req.URL.RawPath = path.Join(r.BasePath, req.URL.RawPath)\r\n```\r\n\r\nI also believe that `func (r *request) BuildHTTP(...) (*http.Request, error) {` should properly escape the path parameters, but that breaks current behaviour.\r\n```\r\n\t// create http request\r\n\tpath := r.pathPattern\r\n\tfor k, v := range r.pathParams {\r\n\t\tlog.Println(\"replacing\", \"{\"+k+\"}\", \"with\", v, \"in\", path)\r\n\t\tpath = strings.Replace(path, \"{\"+k+\"}\", url.PathEscape(v), -1)\r\n\t}\r\n```\r\n\r\n## Environment\r\nswagger version: master, d507f49829bea7a9c1cc313e80de65bae4a9a6bc \r\ngo version: 1.8.1\r\nOS: linux\r\n","closed_by":{"login":"fredbi","id":14262513,"node_id":"MDQ6VXNlcjE0MjYyNTEz","avatar_url":"https://avatars.githubusercontent.com/u/14262513?v=4","gravatar_id":"","url":"https://api.github.com/users/fredbi","html_url":"https://github.com/fredbi","followers_url":"https://api.github.com/users/fredbi/followers","following_url":"https://api.github.com/users/fredbi/following{/other_user}","gists_url":"https://api.github.com/users/fredbi/gists{/gist_id}","starred_url":"https://api.github.com/users/fredbi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fredbi/subscriptions","organizations_url":"https://api.github.com/users/fredbi/orgs","repos_url":"https://api.github.com/users/fredbi/repos","events_url":"https://api.github.com/users/fredbi/events{/privacy}","received_events_url":"https://api.github.com/users/fredbi/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/go-swagger/go-swagger/issues/1083/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/go-swagger/go-swagger/issues/1083/timeline","performed_via_github_app":null,"state_reason":"completed"}