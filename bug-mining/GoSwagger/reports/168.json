{"url":"https://api.github.com/repos/go-swagger/go-swagger/issues/515","repository_url":"https://api.github.com/repos/go-swagger/go-swagger","labels_url":"https://api.github.com/repos/go-swagger/go-swagger/issues/515/labels{/name}","comments_url":"https://api.github.com/repos/go-swagger/go-swagger/issues/515/comments","events_url":"https://api.github.com/repos/go-swagger/go-swagger/issues/515/events","html_url":"https://github.com/go-swagger/go-swagger/issues/515","id":154632879,"node_id":"MDU6SXNzdWUxNTQ2MzI4Nzk=","number":515,"title":"File downloads","user":{"login":"fiorix","id":129742,"node_id":"MDQ6VXNlcjEyOTc0Mg==","avatar_url":"https://avatars.githubusercontent.com/u/129742?v=4","gravatar_id":"","url":"https://api.github.com/users/fiorix","html_url":"https://github.com/fiorix","followers_url":"https://api.github.com/users/fiorix/followers","following_url":"https://api.github.com/users/fiorix/following{/other_user}","gists_url":"https://api.github.com/users/fiorix/gists{/gist_id}","starred_url":"https://api.github.com/users/fiorix/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fiorix/subscriptions","organizations_url":"https://api.github.com/users/fiorix/orgs","repos_url":"https://api.github.com/users/fiorix/repos","events_url":"https://api.github.com/users/fiorix/events{/privacy}","received_events_url":"https://api.github.com/users/fiorix/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":10,"created_at":"2016-05-13T04:42:54Z","updated_at":"2016-06-21T11:12:33Z","closed_at":"2016-06-19T15:05:32Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## Problem statement\n\nIf the response type of one of your endpoints is type=file, the generated Go code returns a runtime.File, which is meant for uploads. My case is an API that returns mostly JSON, but some of the endpoints return files associated to users.\n## Swagger specification\n\nHere's my spec, without the actual API, only the file download endpoint:\n\n```\nswagger: \"2.0\"\ninfo:\n  description: API + File download\n  title: Test\n  version: 1.0.0\nschemes:\n- http\nconsumes:\n- application/json\nproduces:\n- application/json\npaths:\n  /some/file.txt:\n    get:\n      operationId: someFile\n      produces:\n      - application/octet-stream\n      responses:\n        200:\n          description: download file\n          schema:\n            type: file\n```\n## Steps to reproduce\n\nGenerate the code, look at restpi/operations/some_file_response.go:\n\n```\ntype SomeFileOK struct {                                                        \n\n        // In: body                                                             \n        Payload runtime.File `json:\"body,omitempty\"`                            \n}                                                                               \n```\n\nThat is definitely not what I want. I started looking around in the swagger package and go-openapi for a middleware.Responder for octet streams and couldn't find one. I'm currently using this as a workaround in my handlers:\n\n```\nfunc NewOctetStream(f *os.File) middleware.Responder {\n        return middleware.ResponderFunc(func(w http.ResponseWriter, _ runtime.Producer) {\n                fn := filepath.Base(f.Name())\n                w.Header().Set(\"Content-Type\", \"application/octet-stream\")\n                w.Header().Set(\"Content-Disposition\", fmt.Sprintf(\"attachment; filename=%q\", fn))\n                io.Copy(w, f)\n                f.Close()\n        })\n}\n```\n\nThere are many downsides to this despite solving my problem. For one, looks very hack-ish because the producer is ignored. Also, you cannot `defer f.Close()` in the handler, because the middleware executes after you return. That forces me to take ownership of the file in the mw and close it there.\n\nIs this a gap in the current implementation or am I completely off?\n","closed_by":{"login":"casualjim","id":456109,"node_id":"MDQ6VXNlcjQ1NjEwOQ==","avatar_url":"https://avatars.githubusercontent.com/u/456109?v=4","gravatar_id":"","url":"https://api.github.com/users/casualjim","html_url":"https://github.com/casualjim","followers_url":"https://api.github.com/users/casualjim/followers","following_url":"https://api.github.com/users/casualjim/following{/other_user}","gists_url":"https://api.github.com/users/casualjim/gists{/gist_id}","starred_url":"https://api.github.com/users/casualjim/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/casualjim/subscriptions","organizations_url":"https://api.github.com/users/casualjim/orgs","repos_url":"https://api.github.com/users/casualjim/repos","events_url":"https://api.github.com/users/casualjim/events{/privacy}","received_events_url":"https://api.github.com/users/casualjim/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/go-swagger/go-swagger/issues/515/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/go-swagger/go-swagger/issues/515/timeline","performed_via_github_app":null,"state_reason":"completed"}