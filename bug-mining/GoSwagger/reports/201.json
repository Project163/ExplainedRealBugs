{"url":"https://api.github.com/repos/go-swagger/go-swagger/issues/1316","repository_url":"https://api.github.com/repos/go-swagger/go-swagger","labels_url":"https://api.github.com/repos/go-swagger/go-swagger/issues/1316/labels{/name}","comments_url":"https://api.github.com/repos/go-swagger/go-swagger/issues/1316/comments","events_url":"https://api.github.com/repos/go-swagger/go-swagger/issues/1316/events","html_url":"https://github.com/go-swagger/go-swagger/issues/1316","id":280483895,"node_id":"MDU6SXNzdWUyODA0ODM4OTU=","number":1316,"title":"Shutdown method on server do not close the server","user":{"login":"Crevil","id":6881694,"node_id":"MDQ6VXNlcjY4ODE2OTQ=","avatar_url":"https://avatars.githubusercontent.com/u/6881694?v=4","gravatar_id":"","url":"https://api.github.com/users/Crevil","html_url":"https://github.com/Crevil","followers_url":"https://api.github.com/users/Crevil/followers","following_url":"https://api.github.com/users/Crevil/following{/other_user}","gists_url":"https://api.github.com/users/Crevil/gists{/gist_id}","starred_url":"https://api.github.com/users/Crevil/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Crevil/subscriptions","organizations_url":"https://api.github.com/users/Crevil/orgs","repos_url":"https://api.github.com/users/Crevil/repos","events_url":"https://api.github.com/users/Crevil/events{/privacy}","received_events_url":"https://api.github.com/users/Crevil/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":148436506,"node_id":"MDU6TGFiZWwxNDg0MzY1MDY=","url":"https://api.github.com/repos/go-swagger/go-swagger/labels/enhancement","name":"enhancement","color":"84b6eb","default":true,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2017-12-08T13:06:46Z","updated_at":"2017-12-14T05:29:35Z","closed_at":"2017-12-14T05:29:35Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## Problem statement\r\nWhen generating a server implementation and calling `Server.Shutdown` method from `restapi` package the server is not actually closed though the documentation states `Shutdown server and clean up resources`. Only the `API.ServerShutdown` callback from `operations` package is called but the actual server is not closed.\r\n\r\nThe graceful server exposes the API needed to shut it down gracefully but the generated abstraction does not allow access to this API. Because of this, only an OS signal can kill the graceful server when running the generated server.\r\n\r\nI propose to expand the `Server.Shutdown` method to signal the graceful server to initiate a shutdown. It is a fairly simple addition to the API and I'm happy to make a PR with the changes.\r\n\r\nWhen looking over the source the following changes are necessary:\r\n- `Server.Serve` should listen for on a shutdown channel and stop the graceful server when receiving a signal\r\n- `Server.Shutdown` should send a signal on the shutdown channel\r\n- Code on examples should be updated to hold the new implementation\r\n\r\n## Steps to reproduce\r\nA slightly modified version of the [`custom-server` tutorial example](https://github.com/go-swagger/go-swagger/tree/master/examples/tutorials/custom-server) shows the behaviour. After 5 seconds the server is instructed to shut down by calling `Shutdown`. The `ServerShutdown` callback is called but the server continuous to run. \r\n\r\nWhen running the output is as follows. Not that I manually interrupt the server with CTRL + C.\r\n```\r\n$ go run ./cmd/greeter/main.go --port 3000\r\n2017/12/08 14:03:39 Serving greeter at http://[::]:3000\r\n2017/12/08 14:03:44 api shutdown called\r\n^C2017/12/08 14:03:53 shutdown initiated\r\n2017/12/08 14:03:53 Stopped serving greeter at http://[::]:3000\r\n```\r\n\r\nBelow is a stripped snippet from the `main.go`.\r\n\r\n```go\r\n// from  examples/tutorials/custom-server/cmd/greeter/main.go\r\n\r\n// create new service API\r\napi := operations.NewGreeterAPI(swaggerSpec)\r\napi.ServerShutdown = func() { log.Println(\"api shutdown called\") } // added\r\nserver := restapi.NewServer(api)\r\n\r\n// parse flags\r\nflag.Parse()\r\n// set the port this service will be run on\r\nserver.Port = *portFlag\r\n\r\n// GetGreetingHandler greets the given name,\r\n// in case the name is not given, it will default to World\r\napi.GetGreetingHandler = operations.GetGreetingHandlerFunc(\r\n\tfunc(params operations.GetGreetingParams) middleware.Responder {\r\n\t\t// ...\r\n\t})\r\n\r\n// added\r\ngo func() {\r\n\ttime.Sleep(5 * time.Second)\r\n\tserver.Shutdown()\r\n}()\r\n\r\n// serve API\r\n```","closed_by":{"login":"casualjim","id":456109,"node_id":"MDQ6VXNlcjQ1NjEwOQ==","avatar_url":"https://avatars.githubusercontent.com/u/456109?v=4","gravatar_id":"","url":"https://api.github.com/users/casualjim","html_url":"https://github.com/casualjim","followers_url":"https://api.github.com/users/casualjim/followers","following_url":"https://api.github.com/users/casualjim/following{/other_user}","gists_url":"https://api.github.com/users/casualjim/gists{/gist_id}","starred_url":"https://api.github.com/users/casualjim/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/casualjim/subscriptions","organizations_url":"https://api.github.com/users/casualjim/orgs","repos_url":"https://api.github.com/users/casualjim/repos","events_url":"https://api.github.com/users/casualjim/events{/privacy}","received_events_url":"https://api.github.com/users/casualjim/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/go-swagger/go-swagger/issues/1316/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/go-swagger/go-swagger/issues/1316/timeline","performed_via_github_app":null,"state_reason":"completed"}