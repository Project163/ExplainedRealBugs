{"url":"https://api.github.com/repos/go-swagger/go-swagger/issues/1796","repository_url":"https://api.github.com/repos/go-swagger/go-swagger","labels_url":"https://api.github.com/repos/go-swagger/go-swagger/issues/1796/labels{/name}","comments_url":"https://api.github.com/repos/go-swagger/go-swagger/issues/1796/comments","events_url":"https://api.github.com/repos/go-swagger/go-swagger/issues/1796/events","html_url":"https://github.com/go-swagger/go-swagger/issues/1796","id":381623317,"node_id":"MDU6SXNzdWUzODE2MjMzMTc=","number":1796,"title":"Recursive model errors during flattening stage of generate server","user":{"login":"kstedman9","id":16196785,"node_id":"MDQ6VXNlcjE2MTk2Nzg1","avatar_url":"https://avatars.githubusercontent.com/u/16196785?v=4","gravatar_id":"","url":"https://api.github.com/users/kstedman9","html_url":"https://github.com/kstedman9","followers_url":"https://api.github.com/users/kstedman9/followers","following_url":"https://api.github.com/users/kstedman9/following{/other_user}","gists_url":"https://api.github.com/users/kstedman9/gists{/gist_id}","starred_url":"https://api.github.com/users/kstedman9/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kstedman9/subscriptions","organizations_url":"https://api.github.com/users/kstedman9/orgs","repos_url":"https://api.github.com/users/kstedman9/repos","events_url":"https://api.github.com/users/kstedman9/events{/privacy}","received_events_url":"https://api.github.com/users/kstedman9/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":148436504,"node_id":"MDU6TGFiZWwxNDg0MzY1MDQ=","url":"https://api.github.com/repos/go-swagger/go-swagger/labels/bug","name":"bug","color":"fc2929","default":true,"description":null},{"id":770925345,"node_id":"MDU6TGFiZWw3NzA5MjUzNDU=","url":"https://api.github.com/repos/go-swagger/go-swagger/labels/Ref%20resolution","name":"Ref resolution","color":"ea9a07","default":false,"description":null},{"id":975136500,"node_id":"MDU6TGFiZWw5NzUxMzY1MDA=","url":"https://api.github.com/repos/go-swagger/go-swagger/labels/pending%20PR","name":"pending PR","color":"7ff47f","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"fredbi","id":14262513,"node_id":"MDQ6VXNlcjE0MjYyNTEz","avatar_url":"https://avatars.githubusercontent.com/u/14262513?v=4","gravatar_id":"","url":"https://api.github.com/users/fredbi","html_url":"https://github.com/fredbi","followers_url":"https://api.github.com/users/fredbi/followers","following_url":"https://api.github.com/users/fredbi/following{/other_user}","gists_url":"https://api.github.com/users/fredbi/gists{/gist_id}","starred_url":"https://api.github.com/users/fredbi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fredbi/subscriptions","organizations_url":"https://api.github.com/users/fredbi/orgs","repos_url":"https://api.github.com/users/fredbi/repos","events_url":"https://api.github.com/users/fredbi/events{/privacy}","received_events_url":"https://api.github.com/users/fredbi/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"fredbi","id":14262513,"node_id":"MDQ6VXNlcjE0MjYyNTEz","avatar_url":"https://avatars.githubusercontent.com/u/14262513?v=4","gravatar_id":"","url":"https://api.github.com/users/fredbi","html_url":"https://github.com/fredbi","followers_url":"https://api.github.com/users/fredbi/followers","following_url":"https://api.github.com/users/fredbi/following{/other_user}","gists_url":"https://api.github.com/users/fredbi/gists{/gist_id}","starred_url":"https://api.github.com/users/fredbi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fredbi/subscriptions","organizations_url":"https://api.github.com/users/fredbi/orgs","repos_url":"https://api.github.com/users/fredbi/repos","events_url":"https://api.github.com/users/fredbi/events{/privacy}","received_events_url":"https://api.github.com/users/fredbi/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":2,"created_at":"2018-11-16T14:32:57Z","updated_at":"2018-11-17T16:52:04Z","closed_at":"2018-11-17T16:52:04Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## Problem statement\r\nI have a recursive model that is separated into a models file that is referred to by \"$ref\" tag.  When I try to generate the server it panics during the flattening process.  So you can also test by just running the flattening.  If I remove the recursion it works just fine.  To remove recursion I just change in the QueryNode model all \"$ref\": \"#/QueryNode\"  to  \"type\": \"object\"\r\n\r\nPart of the output messages with debug turned on.\r\n```\r\nanalysis:2018/11/16 09:14:15 flatten.go:803: importing external schema for [#/paths/~1search/post/parameters/0/schema/properties/queryRoot/properties/and/items, #/paths/~1search/post/parameters/0/schema/properties/queryRoot/properties/or/items, #/paths/~1search/post/parameters/0/schema/properties/queryRoot/properties/not/items] from /home/kstedman/projects/develop/swag_issue/models/query.json#/QueryNode\r\nanalysis:2018/11/16 09:14:15 flatten.go:807: new name for [#/paths/~1search/post/parameters/0/schema/properties/queryRoot/properties/and/items, #/paths/~1search/post/parameters/0/schema/properties/queryRoot/properties/or/items, #/paths/~1search/post/parameters/0/schema/properties/queryRoot/properties/not/items]: queryNode - with name conflict:false\r\nanalysis:2018/11/16 09:14:15 flatten.go:950: updating ref for #/paths/~1search/post/parameters/0/schema/properties/queryRoot/properties/and/items with #/definitions/queryNode\r\nanalysis:2018/11/16 09:14:15 flatten.go:950: updating ref for #/paths/~1search/post/parameters/0/schema/properties/queryRoot/properties/or/items with #/definitions/queryNode\r\nanalysis:2018/11/16 09:14:15 flatten.go:950: updating ref for #/paths/~1search/post/parameters/0/schema/properties/queryRoot/properties/not/items with #/definitions/queryNode\r\nanalysis:2018/11/16 09:14:15 flatten.go:1260: name pointers\r\nanalysis:2018/11/16 09:14:15 flatten.go:1272: planning pointer to replace at #/definitions/queryNode/properties/or/items: models/query.json#/QueryNode, resolved to: models/query.json#/QueryNode\r\nanalysis:2018/11/16 09:14:15 flatten.go:1272: planning pointer to replace at #/definitions/queryNode/properties/and/items: models/query.json#/QueryNode, resolved to: models/query.json#/QueryNode\r\nanalysis:2018/11/16 09:14:15 flatten.go:1272: planning pointer to replace at #/definitions/queryNode/properties/not/items: models/query.json#/QueryNode, resolved to: models/query.json#/QueryNode\r\nanalysis:2018/11/16 09:14:15 flatten.go:1298: replacing pointer at #/definitions/queryNode/properties/and/items: resolved to: models/query.json#/QueryNode\r\nanalysis:2018/11/16 09:14:15 flatten.go:1314: namePointers at #/definitions/queryNode/properties/and/items for models/query.json#/QueryNode\r\npanic: runtime error: invalid memory address or nil pointer dereference\r\n[signal SIGSEGV: segmentation violation code=0x1 addr=0x1a0 pc=0x7dab09]\r\n\r\ngoroutine 1 [running]:\r\ngithub.com/go-swagger/go-swagger/vendor/github.com/go-openapi/analysis.(*AnalyzedSchema).initializeFlags(0xc0005e21c0)\r\n\t/home/kstedman/go/src/github.com/go-swagger/go-swagger/vendor/github.com/go-openapi/analysis/schema.go:213 +0x29\r\ngithub.com/go-swagger/go-swagger/vendor/github.com/go-openapi/analysis.Schema(0x0, 0xb32600, 0xc0002cc700, 0xc000690c40, 0x3a, 0x0, 0xc00046a580, 0xc0007868e0, 0x1)\r\n\t/home/kstedman/go/src/github.com/go-swagger/go-swagger/vendor/github.com/go-openapi/analysis/schema.go:25 +0x97\r\ngithub.com/go-swagger/go-swagger/vendor/github.com/go-openapi/analysis.namePointers(0xc0006e8330, 0xc0007799a0, 0x7bae49)\r\n\t/home/kstedman/go/src/github.com/go-swagger/go-swagger/vendor/github.com/go-openapi/analysis/flatten.go:1317 +0xed1\r\ngithub.com/go-swagger/go-swagger/vendor/github.com/go-openapi/analysis.stripPointersAndOAIGen(0xc0006e8330, 0x0, 0x0)\r\n\t/home/kstedman/go/src/github.com/go-swagger/go-swagger/vendor/github.com/go-openapi/analysis/flatten.go:1130 +0x2f\r\ngithub.com/go-swagger/go-swagger/vendor/github.com/go-openapi/analysis.Flatten(0xc000695180, 0x0, 0x7ffe431501cb, 0xf, 0x10101, 0x8, 0x7)\r\n\t/home/kstedman/go/src/github.com/go-swagger/go-swagger/vendor/github.com/go-openapi/analysis/flatten.go:182 +0x2e5\r\ngithub.com/go-swagger/go-swagger/cmd/swagger/commands.(*FlattenSpec).Execute(0xc00008e690, 0xc00039f080, 0x1, 0x6, 0xc00008e690, 0x1)\r\n\t/home/kstedman/go/src/github.com/go-swagger/go-swagger/cmd/swagger/commands/flatten.go:43 +0x18f\r\ngithub.com/go-swagger/go-swagger/vendor/github.com/jessevdk/go-flags.(*Parser).ParseArgs(0xc00039f020, 0xc00001e080, 0x6, 0x6, 0x40dac8, 0x30, 0xb7ba60, 0xc000092990, 0xc000431b00)\r\n\t/home/kstedman/go/src/github.com/go-swagger/go-swagger/vendor/github.com/jessevdk/go-flags/parser.go:316 +0x800\r\ngithub.com/go-swagger/go-swagger/vendor/github.com/jessevdk/go-flags.(*Parser).Parse(0xc00039f020, 0x6, 0xbcba2a, 0x6, 0x0, 0xc16ff0)\r\n\t/home/kstedman/go/src/github.com/go-swagger/go-swagger/vendor/github.com/jessevdk/go-flags/parser.go:186 +0x71\r\nmain.main()\r\n\t/home/kstedman/go/src/github.com/go-swagger/go-swagger/cmd/swagger/swagger.go:140 +0xb68\r\n```\r\n## Swagger specification\r\nSo I have a swagger json definition.  The top level file contains the paths. Models are found in a subfolder models.  FYI this is a small part of a very large swagger project.\r\n\r\n./queryIssue.json\r\n```\r\n{\r\n  \"swagger\": \"2.0\",\r\n  \"info\": {\r\n    \"title\": \"Query Model Issue\",\r\n    \"description\": \"Test for Query Model Issue\",\r\n    \"version\": \"0.0.1\"\r\n  },\r\n  \"schemes\": [\"http\"],\r\n  \"produces\": [\"application/json\"],\r\n  \"paths\": {\r\n \r\n    \"/search\": {\r\n      \"post\": {\r\n        \"operationId\": \"searchObject\",\r\n        \"tags\": [\"Query\"],\r\n        \"produces\": [\"application/json\"],\r\n        \"consumes\": [\"application/json\"],\r\n        \"security\": [\r\n          {\r\n            \"Bearer\": []\r\n          }\r\n        ],\r\n        \"summary\":\r\n          \"Get a list of the algorithms available in the AlgorithmBank instance. By default returns the first 10 results.\",\r\n        \"parameters\": [\r\n          {\r\n            \"name\": \"query\",\r\n            \"in\": \"body\",\r\n            \"required\": true,\r\n            \"schema\": {\r\n              \"$ref\": \"./models/query.json#/Query\"\r\n            }\r\n          }\r\n        ], \r\n        \"responses\": {\r\n          \"200\": {\r\n            \"description\": \"OK\",\r\n            \"schema\": {\r\n              \"type\": \"string\"\r\n            }\r\n          },\r\n          \"400\": {\r\n            \"description\": \"Invalid parameters.\"\r\n          },\r\n          \"401\": {\r\n            \"description\": \"Unauthenticated.\"\r\n          },\r\n          \"403\": {\r\n            \"description\": \"User is not authorized to perform the action\",\r\n            \"schema\": {\r\n              \"type\": \"string\"\r\n            }\r\n          },\r\n          \"500\": {\r\n            \"description\": \"Internal Server Error\",\r\n            \"schema\": {\r\n              \"type\": \"string\"\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  },\r\n  \"definitions\": {\r\n\r\n  }\r\n}\r\n```\r\n\r\n./models/query.json:\r\n```\r\n{\r\n    \"Query\": {\r\n       \"description\":\r\n         \"Represents a search query using a boolean expression tree\",\r\n       \"type\": \"object\",\r\n       \"properties\": {\r\n         \"queryRoot\": {\r\n           \"$ref\": \"#/QueryNode\"\r\n         },\r\n         \"limit\": {\r\n           \"type\": \"integer\",\r\n           \"format\": \"int64\"\r\n         },\r\n         \"offset\": {\r\n           \"type\": \"integer\",\r\n           \"format\": \"int64\"\r\n         }\r\n       },\r\n       \"x-go-type\": {\r\n           \"import\": {\r\n              \"package\": \"bitbucket.di2e.net/scm/pir/ab-models.git\",\r\n              \"alias\": \"models\"\r\n           },\r\n           \"type\": \"Query\"\r\n       }\r\n     },\r\n     \"QueryNode\": {\r\n      \"description\":\r\n        \"Node in a boolean expression tree that represents a query\",\r\n      \"type\": \"object\",\r\n      \"properties\": {\r\n        \"and\": {\r\n          \"type\": \"array\",\r\n          \"items\": {\r\n            \"$ref\": \"#/QueryNode\"\r\n          }\r\n        },\r\n        \"or\": {\r\n          \"type\": \"array\",\r\n          \"items\": {\r\n            \"$ref\": \"#/QueryNode\"\r\n          }\r\n        },\r\n        \"not\": {\r\n          \"type\": \"array\",\r\n          \"items\": {\r\n            \"$ref\": \"#/QueryNode\"\r\n          }\r\n        },\r\n        \"wildcards\": {\r\n          \"description\":\r\n            \"Array of key/value pairs representing wildcard term matches\",\r\n          \"type\": \"array\",\r\n          \"items\": {\r\n            \"$ref\": \"./pair.json#/Pair\"\r\n          }\r\n        },\r\n        \"exact\": {\r\n          \"description\":\r\n            \"Array of key/value pairs representing exact term matches\",\r\n          \"type\": \"array\",\r\n          \"items\": {\r\n            \"$ref\": \"./pair.json#/Pair\"\r\n          }\r\n        }\r\n      },\r\n      \"x-go-type\": {\r\n          \"import\": {\r\n            \"package\": \"bitbucket.di2e.net/scm/pir/ab-models.git\",\r\n            \"alias\": \"models\"\r\n          },\r\n          \"type\": \"QueryNode\"\r\n      }\r\n    }\r\n }\r\n```\r\n\r\n./models/pair.json:\r\n```\r\n{\r\n    \"Pair\": {\r\n        \"description\":\r\n          \"Simple key value pair model that is used by some of the other models.\",\r\n        \"type\": \"object\",\r\n        \"required\": [\"key\", \"value\"],\r\n        \"properties\": {\r\n          \"key\": {\r\n            \"type\": \"string\"\r\n          },\r\n          \"value\": {\r\n            \"type\": \"string\"\r\n          }\r\n        },\r\n        \"x-go-type\": {\r\n            \"import\": {\r\n              \"package\": \"bitbucket.di2e.net/scm/pir/ab-models.git\",\r\n              \"alias\": \"abmodels\"\r\n            },\r\n            \"type\": \"Pair\"\r\n        }\r\n     }\r\n  }\r\n```\r\n\r\n## Steps to reproduce\r\n\r\nRun: swagger flatten -o queryIssueFlatten.json --format=json --with-expand queryIssue.json\r\nor\r\nRun: swagger generate server -f queryIssue.json -A queryissue\r\n\r\nBoth commands give the same issue\r\n\r\n\r\n## Environment\r\nswagger version: 0.17.2 and master branch  \r\ngo version: 1.10.x, 1.11.x\r\nOS:   Centos 7\r\n\r\n\r\nAttached are all the json files and the complete log output.\r\n[issue.zip](https://github.com/go-swagger/go-swagger/files/2589626/issue.zip)\r\n\r\n\r\n","closed_by":{"login":"casualjim","id":456109,"node_id":"MDQ6VXNlcjQ1NjEwOQ==","avatar_url":"https://avatars.githubusercontent.com/u/456109?v=4","gravatar_id":"","url":"https://api.github.com/users/casualjim","html_url":"https://github.com/casualjim","followers_url":"https://api.github.com/users/casualjim/followers","following_url":"https://api.github.com/users/casualjim/following{/other_user}","gists_url":"https://api.github.com/users/casualjim/gists{/gist_id}","starred_url":"https://api.github.com/users/casualjim/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/casualjim/subscriptions","organizations_url":"https://api.github.com/users/casualjim/orgs","repos_url":"https://api.github.com/users/casualjim/repos","events_url":"https://api.github.com/users/casualjim/events{/privacy}","received_events_url":"https://api.github.com/users/casualjim/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/go-swagger/go-swagger/issues/1796/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/go-swagger/go-swagger/issues/1796/timeline","performed_via_github_app":null,"state_reason":"completed"}