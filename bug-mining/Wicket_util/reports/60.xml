<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 22:28:13 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[WICKET-4839] Date converters should use a new instance of DateFormat to be thread safe</title>
                <link>https://issues.apache.org/jira/browse/WICKET-4839</link>
                <project id="12310561" key="WICKET">Wicket</project>
                    <description>&lt;p&gt;Please consider the linked issue &lt;a href=&quot;https://issues.apache.org/jira/browse/WICKET-4833&quot; title=&quot;DateConverter is not thread-safe&quot; class=&quot;issue-link&quot; data-issue-key=&quot;WICKET-4833&quot;&gt;&lt;del&gt;WICKET-4833&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I had to open a new issue because I cannot attach the quickstart project I&apos;ve prepared to a closed issue.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12613489">WICKET-4839</key>
            <summary>Date converters should use a new instance of DateFormat to be thread safe</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mgrigorov">Martin Tzvetanov Grigorov</assignee>
                                    <reporter username="soulspirit">SoulSpirit</reporter>
                        <labels>
                    </labels>
                <created>Thu, 25 Oct 2012 14:05:43 +0000</created>
                <updated>Thu, 15 Nov 2012 08:49:56 +0000</updated>
                            <resolved>Thu, 15 Nov 2012 08:49:56 +0000</resolved>
                                    <version>1.4.19</version>
                    <version>6.2.0</version>
                                    <fixVersion>1.5.9</fixVersion>
                                    <component>wicket</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="13484152" author="soulspirit" created="Thu, 25 Oct 2012 14:17:19 +0000"  >&lt;p&gt;The attached project demonstrates that instances of DateFormat managed by org.apache.wicket.util.convert.converter.DateConverter are shared between different requests and different sessions, thus DateConverter should be thread-safe.&lt;/p&gt;

&lt;p&gt;The application writes to the console the instance number of the DateFormat instance used by DateConverter, and it&apos;s clear it doesn&apos;t change refreshing the page or running a different HTTP session, provided the Locale assigned by Wicket to the user doesn&apos;t change.&lt;/p&gt;</comment>
                            <comment id="13489466" author="mgrigorov" created="Fri, 2 Nov 2012 15:08:16 +0000"  >&lt;p&gt;From now on ConverterLocator will create a new instance of all date based converters.&lt;br/&gt;
Thanks!&lt;/p&gt;</comment>
                            <comment id="13490173" author="soulspirit" created="Sun, 4 Nov 2012 12:02:34 +0000"  >&lt;p&gt;Sorry if I&apos;m insisting, but your solution isn&apos;t optimal: &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=wicket.git;a=commitdiff;h=7d139086fe0cd036d90fd7a32209776c1653ec5c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=wicket.git;a=commitdiff;h=7d139086fe0cd036d90fd7a32209776c1653ec5c&lt;/a&gt;&lt;br/&gt;
Your fix prevents the user to register its own converters for date related datatypes.&lt;/p&gt;

&lt;p&gt;ConverterLocator is a registry, not a factory. The right way to register a custom converter is to call ConverterLocator#set() , which registers an &lt;b&gt;INSTANCE&lt;/b&gt; of the submitted converter in a map. With your fix custom converters aren&apos;t looked up from this map, making the class buggy.&lt;/p&gt;

&lt;p&gt;There are to solutions coming to my mind:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;synchronizing the code that makes use of DateFormat in DateConverter and other similar converters (non optimal)&lt;/li&gt;
	&lt;li&gt;forcing the creation of a new DateFormat object each time DateConverter has to use it (a better one)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Thanks for your time.&lt;/p&gt;</comment>
                            <comment id="13490485" author="mgrigorov" created="Mon, 5 Nov 2012 07:16:07 +0000"  >&lt;p&gt;Good catch! Thanks for reviewing!&lt;/p&gt;

&lt;p&gt;I improved it by checking first in the registered converters and if there is no match then check for the date types and use the new logic.&lt;/p&gt;

&lt;p&gt;It would be even better if instead of registering the converter itself it was possible to register a provider for the converter but we cannot make API breaks until Wicket 7 so this improvement will have to wait.&lt;/p&gt;</comment>
                            <comment id="13490500" author="soulspirit" created="Mon, 5 Nov 2012 08:28:29 +0000"  >&lt;p&gt;Ok, this way the patch works, but it tricks the user who wants to subclass DateConverter.&lt;br/&gt;
It would appear legitimate to subclass DateConverter overriding #getDateFormat() to make it use a different date format than the hard-coded DateFormat.SHORT, but doing so would make the class unsafe, because the special code in ConverterLocator would not trigger.&lt;br/&gt;
To make it work, the subclass should handle concurrency by itself, and it would sound strange, given that DateConverter doesn&apos;t do anything special about it.&lt;/p&gt;

&lt;p&gt;I think it would better making clear that IConverter(s) instances are shared between threads, and making each IConverter implementation handle the concurrency by itself.&lt;/p&gt;

&lt;p&gt;In our specific case of DateConverter, the call to DateFormat#getDateInstance() should be simply replaced by a call to new DateFormat() . Simple and safe.&lt;/p&gt;

&lt;p&gt;A more involved but elegant solution could make use of a ThreadLocal&amp;lt;DateFormat&amp;gt; to &quot;cache&quot; the DateFormat instance, but a simple new DateFormat() would suffice it.&lt;/p&gt;

&lt;p&gt;Thanks again.&lt;/p&gt;</comment>
                            <comment id="13490510" author="mgrigorov" created="Mon, 5 Nov 2012 08:44:15 +0000"  >&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;I&apos;m not sure that I understand. A patch would make it more clear, I believe.&lt;/p&gt;

&lt;p&gt;&quot;should be simply replaced by a call to new DateFormat() . Simple and safe.&quot;&lt;br/&gt;
Could be, but DateFormat&apos;s constructor is not visible (at least in JDK 6), so I&apos;m not sure how you instantiated it. Maybe you use SimpleDateFormat instead...&lt;/p&gt;

&lt;p&gt;Additionally DateConverter creates a new DateFormat instance for each call to #convertToString() so I&apos;m starting wonder whether my change is needed at all. It seems to be OK even without it. Many threads share the same DateConverter instance but since it is stateless (doesn&apos;t keep state) and creates new instances of DateFormat for each usage of #convertToXYZ() it should be safe.&lt;/p&gt;</comment>
                            <comment id="13490541" author="soulspirit" created="Mon, 5 Nov 2012 10:02:37 +0000"  >&lt;p&gt;This patch addresses DateConverter thread-safeness problem.&lt;/p&gt;</comment>
                            <comment id="13490544" author="soulspirit" created="Mon, 5 Nov 2012 10:05:33 +0000"  >&lt;p&gt;The problem isn&apos;t DateConverter itself. It is true, it&apos;s stateless, but java.text.DateFormat isn&apos;t. Its apidoc says:&lt;/p&gt;

&lt;p&gt;Date formats are not synchronized.&lt;br/&gt;
It is recommended to create separate format instances for each thread.&lt;br/&gt;
If multiple threads access a format concurrently, it must be synchronized&lt;br/&gt;
externally.&lt;/p&gt;

&lt;p&gt;And you can verify it by running the quickstart project I&apos;ve previously attached.&lt;/p&gt;</comment>
                            <comment id="13490553" author="mgrigorov" created="Mon, 5 Nov 2012 10:25:52 +0000"  >&lt;p&gt;I&apos;m not sure why the current code deals with DateFormat.getDateInstance(DateFormat.SHORT, locale) instead of returning a new instance of SimpleDateFormat every time.&lt;br/&gt;
I also think that this method returns instances from a pool. I&apos;m not sure why Emond said that the providers are pooled but the DatFormat instances are not. &lt;br/&gt;
The code in java.text.DateFormat#get(int timeStyle, int dateStyle, int flags, Locale) looks like:&lt;/p&gt;

&lt;p&gt;LocaleServiceProviderPool pool =&lt;br/&gt;
                LocaleServiceProviderPool.getPool(DateFormatProvider.class);&lt;br/&gt;
            if (pool.hasProviders()) {&lt;br/&gt;
                DateFormat providersInstance = pool.getLocalizedObject(&lt;br/&gt;
                                                    DateFormatGetter.INSTANCE,&lt;br/&gt;
                                                    loc, &lt;br/&gt;
                                                    timeStyle,&lt;br/&gt;
                                                    dateStyle,&lt;br/&gt;
                                                    flags);&lt;br/&gt;
                if (providersInstance != null) &lt;/p&gt;
{
                    return providersInstance;
                }
&lt;p&gt;            }&lt;/p&gt;

&lt;p&gt;So, I agree that org.apache.wicket.util.convert.converter.DateConverter#getDateFormat(Locale) should look like:&lt;/p&gt;

&lt;p&gt;public DateFormat getDateFormat(Locale locale)&lt;br/&gt;
	{&lt;br/&gt;
		if (locale == null)&lt;/p&gt;
		{
			locale = Locale.getDefault();
		}

&lt;p&gt;		return new SimpleDateFormat(getPattern(), locale);&lt;br/&gt;
	}&lt;/p&gt;

&lt;p&gt;protected String getPattern() &lt;/p&gt;
{ ....}

&lt;p&gt;And with this improvement the earlier commits in ConverterLocator should be reverted.&lt;br/&gt;
Agree ?&lt;/p&gt;</comment>
                            <comment id="13490558" author="soulspirit" created="Mon, 5 Nov 2012 10:44:29 +0000"  >&lt;p&gt;Exactly.&lt;br/&gt;
In the patch I had to take the pattern from the DateFormat instance because there is no way to emulate the style defined by DateFormat.SHORT with a pattern for SimpleDateFormat (DateFormat.SHORT&apos;s pattern is somehow generated very differently for each Locale).&lt;br/&gt;
So, I made it a two-step conversion to keep the maximum date pattern compatibility with the original version of DateConverter. I like your proposal of a #getPattern() method.&lt;/p&gt;</comment>
                            <comment id="13490573" author="mgrigorov" created="Mon, 5 Nov 2012 11:18:02 +0000"  >&lt;p&gt;Now, I see what is the reason to use DateFormat.getDateInstance(DateFormat.SHORT, locale) - &lt;a href=&quot;http://stackoverflow.com/questions/4594519/how-do-i-get-localized-date-pattern-string&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://stackoverflow.com/questions/4594519/how-do-i-get-localized-date-pattern-string&lt;/a&gt;.&lt;br/&gt;
SimpleDateFormat is not able to produce a short pattern for all possible locales. I.e. DateFormat.getDateInstance() will not always return SimpleDateFormat and as your patch suggests it will throw a ClassCastException. And with your approach it will return an invalid (for the passed locale) pattern in this case.&lt;/p&gt;

&lt;p&gt;The only safe way is to return a clone of the returned DateFormat instance:&lt;/p&gt;

&lt;p&gt;public DateFormat getDateFormat(Locale locale)&lt;br/&gt;
	{&lt;br/&gt;
		if (locale == null)&lt;/p&gt;
		{
			locale = Locale.getDefault();
		}&lt;br/&gt;
&lt;br/&gt;
		// return a clone because DateFormats are not thread-safe and&lt;br/&gt;
		// DateFormat.getDateInstance may return an instance from a pool&lt;br/&gt;
		return (DateFormat) DateFormat.getDateInstance(DateFormat.SHORT, locale).clone();&lt;br/&gt;
	}&lt;br/&gt;
&lt;br/&gt;
Another way is &lt;br/&gt;
&lt;br/&gt;
public DateFormat getDateFormat(Locale locale)&lt;br/&gt;
	{&lt;br/&gt;
		if (locale == null)&lt;br/&gt;
		{			locale = Locale.getDefault();		}

&lt;p&gt;		DateFormat dateFormat = DateFormat.getDateInstance(DateFormat.SHORT, locale);&lt;br/&gt;
		if (dateFormat instanceof SimpleDateFormat)&lt;/p&gt;
		{
			String pattern = ((SimpleDateFormat) dateFormat).toLocalizedPattern();
			dateFormat = new SimpleDateFormat(pattern, locale);
		}
&lt;p&gt;		return dateFormat;&lt;br/&gt;
	} &lt;/p&gt;

&lt;p&gt; i.e. a more explicit way of making a clone for SimpleDateFormat.&lt;br/&gt;
I prefer the first approach.&lt;/p&gt;</comment>
                            <comment id="13490588" author="svenmeier" created="Mon, 5 Nov 2012 12:07:04 +0000"  >&lt;p&gt;+1 for just using clone(), it seems the simplest solution. People who are concerned about performance (if this is an issue at all) can always register their own converter.&lt;/p&gt;</comment>
                            <comment id="13490616" author="soulspirit" created="Mon, 5 Nov 2012 13:26:29 +0000"  >&lt;p&gt;Speaking about performance, it should be much faster just synchronizing the block, that has the plus to make clear to everyone that DateConverter has to be thread-safe:&lt;/p&gt;

&lt;p&gt;@Override&lt;br/&gt;
public String convertToString(final Date value, final Locale locale)&lt;br/&gt;
{&lt;br/&gt;
  final DateFormat dateFormat = getDateFormat(locale);&lt;br/&gt;
  if (dateFormat != null)&lt;br/&gt;
  {&lt;br/&gt;
    synchronized (dateFormat) &lt;/p&gt;
{
      return dateFormat.format(value);
    }
&lt;p&gt;  }&lt;br/&gt;
  return value.toString();&lt;br/&gt;
}&lt;/p&gt;</comment>
                            <comment id="13491286" author="mgrigorov" created="Tue, 6 Nov 2012 07:58:54 +0000"  >&lt;p&gt;See &lt;a href=&quot;https://issues.apache.org/jira/browse/WICKET-4858&quot; title=&quot;Introduce AbstractDateConverter that holds the common code for util.Date, sql.Date, sql.Time and sql.Timestamp&quot; class=&quot;issue-link&quot; data-issue-key=&quot;WICKET-4858&quot;&gt;&lt;del&gt;WICKET-4858&lt;/del&gt;&lt;/a&gt;. There I tried to consolidate the common code for all Date-based converters in one AbstractDateConverter but clirr-maven-plugin sees problems in applying the change for Wicket 6.x, so it will have to wait for Wicket 7.&lt;/p&gt;

&lt;p&gt;For Wicket 1.5.9/6.3.0 I&apos;m going to revert the change in ConverterLocator and use #clone(). Later this can be optimized if it shows performance problems.&lt;/p&gt;</comment>
                            <comment id="13491312" author="mgrigorov" created="Tue, 6 Nov 2012 08:29:06 +0000"  >&lt;p&gt;Done.&lt;br/&gt;
From now on a cloned instance of the returned DateFormat will be used.&lt;/p&gt;</comment>
                            <comment id="13491335" author="papegaaij" created="Tue, 6 Nov 2012 09:13:16 +0000"  >&lt;p&gt;The quickstart attached to this ticket is invalid. SimpleDateFormat.toString is not an indication of the actual instance of SimpleDateFormat because the hashCode method is overridden to return the hash code of the pattern, which will always be the same. If you change the debug output to System.identityHashCode( dateFormat ), you&apos;ll see a new instance is used on every call. Therefore, I opt to undo the changed made for this ticket, because they are not needed. DateFormat.getInstance will not return the same instance twice.&lt;/p&gt;</comment>
                            <comment id="13491381" author="soulspirit" created="Tue, 6 Nov 2012 10:57:25 +0000"  >&lt;p&gt;You&apos;re right Emond, I&apos;ve been tricked by both DateFormat#toString() and the misleading method&apos;s name DateFormat#getDateInstance() ( #newDateInstance() seems more appropriate).&lt;br/&gt;
Thanks to everyone and sorry for the misguiding bug submission.&lt;/p&gt;</comment>
                            <comment id="13497851" author="mgrigorov" created="Thu, 15 Nov 2012 08:49:56 +0000"  >&lt;p&gt;The change is reverted in 6.x branch.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12614914">WICKET-4858</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12613260">WICKET-4833</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12552081" name="0001-WICKET-4839-DateFormat-should-be-thread-safe.patch" size="1509" author="soulspirit" created="Mon, 5 Nov 2012 10:02:37 +0000"/>
                            <attachment id="12550780" name="quickstart.zip" size="23082" author="soulspirit" created="Thu, 25 Oct 2012 14:17:19 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>251027</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 1 week, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0b3dj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>62659</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>