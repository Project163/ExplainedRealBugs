{"url":"https://api.github.com/repos/bevyengine/bevy/issues/16992","repository_url":"https://api.github.com/repos/bevyengine/bevy","labels_url":"https://api.github.com/repos/bevyengine/bevy/issues/16992/labels{/name}","comments_url":"https://api.github.com/repos/bevyengine/bevy/issues/16992/comments","events_url":"https://api.github.com/repos/bevyengine/bevy/issues/16992/events","html_url":"https://github.com/bevyengine/bevy/issues/16992","id":2760410902,"node_id":"I_kwDODf6-U86kiIcW","number":16992,"title":"Incorrect alignment with `RenderDevice::align_copy_bytes_per_row` when using `Readback::texture`","user":{"login":"ThePuzzlemaker","id":12666617,"node_id":"MDQ6VXNlcjEyNjY2NjE3","avatar_url":"https://avatars.githubusercontent.com/u/12666617?v=4","gravatar_id":"","url":"https://api.github.com/users/ThePuzzlemaker","html_url":"https://github.com/ThePuzzlemaker","followers_url":"https://api.github.com/users/ThePuzzlemaker/followers","following_url":"https://api.github.com/users/ThePuzzlemaker/following{/other_user}","gists_url":"https://api.github.com/users/ThePuzzlemaker/gists{/gist_id}","starred_url":"https://api.github.com/users/ThePuzzlemaker/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ThePuzzlemaker/subscriptions","organizations_url":"https://api.github.com/users/ThePuzzlemaker/orgs","repos_url":"https://api.github.com/users/ThePuzzlemaker/repos","events_url":"https://api.github.com/users/ThePuzzlemaker/events{/privacy}","received_events_url":"https://api.github.com/users/ThePuzzlemaker/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1795619323,"node_id":"MDU6TGFiZWwxNzk1NjE5MzIz","url":"https://api.github.com/repos/bevyengine/bevy/labels/C-Bug","name":"C-Bug","color":"d73a4a","default":false,"description":"An unexpected or incorrect behavior"},{"id":2045383863,"node_id":"MDU6TGFiZWwyMDQ1MzgzODYz","url":"https://api.github.com/repos/bevyengine/bevy/labels/A-Rendering","name":"A-Rendering","color":"C6A751","default":false,"description":"Drawing game state to the screen"},{"id":3166151441,"node_id":"MDU6TGFiZWwzMTY2MTUxNDQx","url":"https://api.github.com/repos/bevyengine/bevy/labels/S-Ready-For-Implementation","name":"S-Ready-For-Implementation","color":"D876E3","default":false,"description":"This issue is ready for an implementation PR. Go for it!"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2024-12-27T05:21:51Z","updated_at":"2024-12-30T06:08:55Z","closed_at":"2024-12-30T06:08:55Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## Bevy version\n\nv0.15.0\n\n```ignore\nAdapterInfo { name: \"AMD Radeon RX 6700 XT (RADV NAVI22)\", vendor: 4098, device: 29663, device_type: DiscreteGpu, driver: \"radv\", driver_info: \"Mesa 24.2.6\", backend: Vulkan }\n```\n\n## What you did\n\nPlease excuse my messy code ðŸ˜… \n\n```rust\nfn main() {\n    App::new()\n        .add_plugins(DefaultPlugins.set(ImagePlugin::default_nearest()))\n        .add_systems(Startup, setup)\n        .run();\n}\n\nfn setup(\n    mut commands: Commands,\n    asset_server: Res<AssetServer>,\n    mut images: ResMut<Assets<Image>>,\n) {\n    let bake_layer = RenderLayers::layer(1);\n\n    let size = Extent3d {\n        width: 128,\n        height: 128,\n        ..default()\n    };\n    let mut image = Image::new_fill(\n        size,\n        TextureDimension::D2,\n        &[0, 0, 0, 0],\n        TextureFormat::Bgra8UnormSrgb,\n        RenderAssetUsages::default(),\n    );\n    image.texture_descriptor.usage = TextureUsages::TEXTURE_BINDING\n        | TextureUsages::COPY_DST\n        | TextureUsages::COPY_SRC\n        | TextureUsages::RENDER_ATTACHMENT;\n\n    let image_handle = images.add(image);\n\n    commands.spawn((\n        Camera3d::default(),\n        Transform::from_xyz(0.5, 0.0, -0.91)\n            .with_rotation(Quat::from_rotation_x(-50.5f32.to_radians())),\n        Projection::Orthographic(OrthographicProjection {\n            scaling_mode: ScalingMode::WindowSize,\n            scale: 1.0 / 64.0,\n            near: -128.0,\n            ..OrthographicProjection::default_3d()\n        }),\n        Camera {\n            target: image_handle.clone().into(),\n            clear_color: Color::NONE.into(),\n            ..default()\n        },\n        bake_layer.clone().with(0),\n    ));\n\n    commands.spawn((\n        DirectionalLight {\n            illuminance: light_consts::lux::OVERCAST_DAY,\n            shadows_enabled: true,\n            ..default()\n        },\n        Transform {\n            translation: Vec3::new(0.0, 10.0, 0.0),\n            rotation: Quat::from_rotation_x(-PI / 2.0)\n                * Quat::from_rotation_z(39.5f32.to_radians()),\n            ..default()\n        },\n        CascadeShadowConfigBuilder {\n            first_cascade_far_bound: 4.0,\n            maximum_distance: 10.0,\n            ..default()\n        }\n        .build(),\n        bake_layer.clone(),\n    ));\n    let handle = asset_server.load(GltfAssetLabel::Scene(0).from_asset(\"tile/example.glb\"));\n\n    commands.spawn((SceneRoot(handle), bake_layer.clone()));\n\n    commands.spawn(Sprite::from_image(image_handle.clone()));\n    commands.spawn((\n        Camera2d,\n        Camera {\n            order: 1,\n            ..default()\n        },\n        OrthographicProjection {\n            ..OrthographicProjection::default_2d()\n        },\n    ));\n\n    commands\n        .spawn(Readback::texture(image_handle.clone()))\n        .observe(move |trigger: Trigger<ReadbackComplete>| {\n            let row_bytes = size.width as usize * 4;\n            let aligned_row_bytes = RenderDevice::align_copy_bytes_per_row(row_bytes) as usize;\n\n            let image_data = &trigger.event().0;\n            let image_data = image_data\n                .chunks(aligned_row_bytes)\n                .take(size.height as usize)\n                .flat_map(|row| &row[..row_bytes.min(row.len())])\n                .cloned()\n                .collect();\n            let image = Image::new(\n                size,\n                TextureDimension::D2,\n                image_data,\n                TextureFormat::Bgra8UnormSrgb,\n                RenderAssetUsages::default(),\n            );\n            let image = image.try_into_dynamic().unwrap();\n            image.save(\"tmp.png\").unwrap();\n        });\n}\n\n```\n\n## What went wrong\n\nIf it's not clear, break this out into:\n\n- what were you expecting? a proper image\n  - ![Image](https://github.com/user-attachments/assets/53697f47-88a6-4eeb-80e2-41cb1517a57d)\n- what actually happened? weird interlaced image\n  - ![Image](https://github.com/user-attachments/assets/defa58a8-341f-4d0f-bfe0-a615e1e258d4)\n\n## Additional information\n\nThe proper image was generated with this alignment function derived from the `headless_render` example\n```rust\npub(crate) fn align_byte_size(value: u32) -> u32 {\n    let align = wgpu::COPY_BYTES_PER_ROW_ALIGNMENT;\n    value + (align - (value % align))\n}\n```\nCompare to [`RenderDevice::align_copy_bytes_per_row`](https://github.com/bevyengine/bevy/blob/64efd08e13c55598587f3071070f750f8945e28e/crates/bevy_render/src/renderer/render_device.rs#L234C1-L238C6) which contains an extra `% align`","closed_by":{"login":"alice-i-cecile","id":3579909,"node_id":"MDQ6VXNlcjM1Nzk5MDk=","avatar_url":"https://avatars.githubusercontent.com/u/3579909?v=4","gravatar_id":"","url":"https://api.github.com/users/alice-i-cecile","html_url":"https://github.com/alice-i-cecile","followers_url":"https://api.github.com/users/alice-i-cecile/followers","following_url":"https://api.github.com/users/alice-i-cecile/following{/other_user}","gists_url":"https://api.github.com/users/alice-i-cecile/gists{/gist_id}","starred_url":"https://api.github.com/users/alice-i-cecile/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alice-i-cecile/subscriptions","organizations_url":"https://api.github.com/users/alice-i-cecile/orgs","repos_url":"https://api.github.com/users/alice-i-cecile/repos","events_url":"https://api.github.com/users/alice-i-cecile/events{/privacy}","received_events_url":"https://api.github.com/users/alice-i-cecile/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/bevyengine/bevy/issues/16992/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/bevyengine/bevy/issues/16992/timeline","performed_via_github_app":null,"state_reason":"completed"}