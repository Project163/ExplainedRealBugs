[{"id":16199414033,"node_id":"MEE_lADODf6-U86o5z6jzwAAAAPFj3ER","url":"https://api.github.com/repos/bevyengine/bevy/issues/events/16199414033","actor":{"login":"Victoronz","id":59878206,"node_id":"MDQ6VXNlcjU5ODc4MjA2","avatar_url":"https://avatars.githubusercontent.com/u/59878206?v=4","gravatar_id":"","url":"https://api.github.com/users/Victoronz","html_url":"https://github.com/Victoronz","followers_url":"https://api.github.com/users/Victoronz/followers","following_url":"https://api.github.com/users/Victoronz/following{/other_user}","gists_url":"https://api.github.com/users/Victoronz/gists{/gist_id}","starred_url":"https://api.github.com/users/Victoronz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Victoronz/subscriptions","organizations_url":"https://api.github.com/users/Victoronz/orgs","repos_url":"https://api.github.com/users/Victoronz/repos","events_url":"https://api.github.com/users/Victoronz/events{/privacy}","received_events_url":"https://api.github.com/users/Victoronz/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2025-02-05T18:56:37Z","performed_via_github_app":null},{"id":16199414037,"node_id":"SE_lADODf6-U86o5z6jzwAAAAPFj3EV","url":"https://api.github.com/repos/bevyengine/bevy/issues/events/16199414037","actor":{"login":"Victoronz","id":59878206,"node_id":"MDQ6VXNlcjU5ODc4MjA2","avatar_url":"https://avatars.githubusercontent.com/u/59878206?v=4","gravatar_id":"","url":"https://api.github.com/users/Victoronz","html_url":"https://github.com/Victoronz","followers_url":"https://api.github.com/users/Victoronz/followers","following_url":"https://api.github.com/users/Victoronz/following{/other_user}","gists_url":"https://api.github.com/users/Victoronz/gists{/gist_id}","starred_url":"https://api.github.com/users/Victoronz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Victoronz/subscriptions","organizations_url":"https://api.github.com/users/Victoronz/orgs","repos_url":"https://api.github.com/users/Victoronz/repos","events_url":"https://api.github.com/users/Victoronz/events{/privacy}","received_events_url":"https://api.github.com/users/Victoronz/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2025-02-05T18:56:37Z","performed_via_github_app":null},{"id":16199416372,"node_id":"LE_lADODf6-U86o5z6jzwAAAAPFj3o0","url":"https://api.github.com/repos/bevyengine/bevy/issues/events/16199416372","actor":{"login":"alice-i-cecile","id":3579909,"node_id":"MDQ6VXNlcjM1Nzk5MDk=","avatar_url":"https://avatars.githubusercontent.com/u/3579909?v=4","gravatar_id":"","url":"https://api.github.com/users/alice-i-cecile","html_url":"https://github.com/alice-i-cecile","followers_url":"https://api.github.com/users/alice-i-cecile/followers","following_url":"https://api.github.com/users/alice-i-cecile/following{/other_user}","gists_url":"https://api.github.com/users/alice-i-cecile/gists{/gist_id}","starred_url":"https://api.github.com/users/alice-i-cecile/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alice-i-cecile/subscriptions","organizations_url":"https://api.github.com/users/alice-i-cecile/orgs","repos_url":"https://api.github.com/users/alice-i-cecile/repos","events_url":"https://api.github.com/users/alice-i-cecile/events{/privacy}","received_events_url":"https://api.github.com/users/alice-i-cecile/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2025-02-05T18:56:48Z","label":{"name":"C-Bug","color":"d73a4a"},"performed_via_github_app":null},{"id":16199416379,"node_id":"LE_lADODf6-U86o5z6jzwAAAAPFj3o7","url":"https://api.github.com/repos/bevyengine/bevy/issues/events/16199416379","actor":{"login":"alice-i-cecile","id":3579909,"node_id":"MDQ6VXNlcjM1Nzk5MDk=","avatar_url":"https://avatars.githubusercontent.com/u/3579909?v=4","gravatar_id":"","url":"https://api.github.com/users/alice-i-cecile","html_url":"https://github.com/alice-i-cecile","followers_url":"https://api.github.com/users/alice-i-cecile/followers","following_url":"https://api.github.com/users/alice-i-cecile/following{/other_user}","gists_url":"https://api.github.com/users/alice-i-cecile/gists{/gist_id}","starred_url":"https://api.github.com/users/alice-i-cecile/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alice-i-cecile/subscriptions","organizations_url":"https://api.github.com/users/alice-i-cecile/orgs","repos_url":"https://api.github.com/users/alice-i-cecile/repos","events_url":"https://api.github.com/users/alice-i-cecile/events{/privacy}","received_events_url":"https://api.github.com/users/alice-i-cecile/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2025-02-05T18:56:48Z","label":{"name":"A-ECS","color":"c6a751"},"performed_via_github_app":null},{"id":16199416387,"node_id":"LE_lADODf6-U86o5z6jzwAAAAPFj3pD","url":"https://api.github.com/repos/bevyengine/bevy/issues/events/16199416387","actor":{"login":"alice-i-cecile","id":3579909,"node_id":"MDQ6VXNlcjM1Nzk5MDk=","avatar_url":"https://avatars.githubusercontent.com/u/3579909?v=4","gravatar_id":"","url":"https://api.github.com/users/alice-i-cecile","html_url":"https://github.com/alice-i-cecile","followers_url":"https://api.github.com/users/alice-i-cecile/followers","following_url":"https://api.github.com/users/alice-i-cecile/following{/other_user}","gists_url":"https://api.github.com/users/alice-i-cecile/gists{/gist_id}","starred_url":"https://api.github.com/users/alice-i-cecile/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alice-i-cecile/subscriptions","organizations_url":"https://api.github.com/users/alice-i-cecile/orgs","repos_url":"https://api.github.com/users/alice-i-cecile/repos","events_url":"https://api.github.com/users/alice-i-cecile/events{/privacy}","received_events_url":"https://api.github.com/users/alice-i-cecile/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2025-02-05T18:56:48Z","label":{"name":"S-Needs-Investigation","color":"D876E1"},"performed_via_github_app":null},{"id":16199416396,"node_id":"LE_lADODf6-U86o5z6jzwAAAAPFj3pM","url":"https://api.github.com/repos/bevyengine/bevy/issues/events/16199416396","actor":{"login":"alice-i-cecile","id":3579909,"node_id":"MDQ6VXNlcjM1Nzk5MDk=","avatar_url":"https://avatars.githubusercontent.com/u/3579909?v=4","gravatar_id":"","url":"https://api.github.com/users/alice-i-cecile","html_url":"https://github.com/alice-i-cecile","followers_url":"https://api.github.com/users/alice-i-cecile/followers","following_url":"https://api.github.com/users/alice-i-cecile/following{/other_user}","gists_url":"https://api.github.com/users/alice-i-cecile/gists{/gist_id}","starred_url":"https://api.github.com/users/alice-i-cecile/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alice-i-cecile/subscriptions","organizations_url":"https://api.github.com/users/alice-i-cecile/orgs","repos_url":"https://api.github.com/users/alice-i-cecile/repos","events_url":"https://api.github.com/users/alice-i-cecile/events{/privacy}","received_events_url":"https://api.github.com/users/alice-i-cecile/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2025-02-05T18:56:48Z","label":{"name":"P-Unsound","color":"FF7b00"},"performed_via_github_app":null},{"id":16199416744,"node_id":"MIE_lADODf6-U86o5z6jzwAAAAPFj3uo","url":"https://api.github.com/repos/bevyengine/bevy/issues/events/16199416744","actor":{"login":"alice-i-cecile","id":3579909,"node_id":"MDQ6VXNlcjM1Nzk5MDk=","avatar_url":"https://avatars.githubusercontent.com/u/3579909?v=4","gravatar_id":"","url":"https://api.github.com/users/alice-i-cecile","html_url":"https://github.com/alice-i-cecile","followers_url":"https://api.github.com/users/alice-i-cecile/followers","following_url":"https://api.github.com/users/alice-i-cecile/following{/other_user}","gists_url":"https://api.github.com/users/alice-i-cecile/gists{/gist_id}","starred_url":"https://api.github.com/users/alice-i-cecile/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alice-i-cecile/subscriptions","organizations_url":"https://api.github.com/users/alice-i-cecile/orgs","repos_url":"https://api.github.com/users/alice-i-cecile/repos","events_url":"https://api.github.com/users/alice-i-cecile/events{/privacy}","received_events_url":"https://api.github.com/users/alice-i-cecile/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"milestoned","commit_id":null,"commit_url":null,"created_at":"2025-02-05T18:56:51Z","milestone":{"title":"0.16"},"performed_via_github_app":null},{"actor":{"login":"alice-i-cecile","id":3579909,"node_id":"MDQ6VXNlcjM1Nzk5MDk=","avatar_url":"https://avatars.githubusercontent.com/u/3579909?v=4","gravatar_id":"","url":"https://api.github.com/users/alice-i-cecile","html_url":"https://github.com/alice-i-cecile","followers_url":"https://api.github.com/users/alice-i-cecile/followers","following_url":"https://api.github.com/users/alice-i-cecile/following{/other_user}","gists_url":"https://api.github.com/users/alice-i-cecile/gists{/gist_id}","starred_url":"https://api.github.com/users/alice-i-cecile/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alice-i-cecile/subscriptions","organizations_url":"https://api.github.com/users/alice-i-cecile/orgs","repos_url":"https://api.github.com/users/alice-i-cecile/repos","events_url":"https://api.github.com/users/alice-i-cecile/events{/privacy}","received_events_url":"https://api.github.com/users/alice-i-cecile/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2025-02-05T18:57:35Z","updated_at":"2025-02-05T18:57:35Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/bevyengine/bevy/issues/15858","repository_url":"https://api.github.com/repos/bevyengine/bevy","labels_url":"https://api.github.com/repos/bevyengine/bevy/issues/15858/labels{/name}","comments_url":"https://api.github.com/repos/bevyengine/bevy/issues/15858/comments","events_url":"https://api.github.com/repos/bevyengine/bevy/issues/15858/events","html_url":"https://github.com/bevyengine/bevy/pull/15858","id":2581845804,"node_id":"PR_kwDODf6-U85-Xb7S","number":15858,"title":"Introduce methods on QueryState to obtain a Query","user":{"login":"chescock","id":8494645,"node_id":"MDQ6VXNlcjg0OTQ2NDU=","avatar_url":"https://avatars.githubusercontent.com/u/8494645?v=4","gravatar_id":"","url":"https://api.github.com/users/chescock","html_url":"https://github.com/chescock","followers_url":"https://api.github.com/users/chescock/followers","following_url":"https://api.github.com/users/chescock/following{/other_user}","gists_url":"https://api.github.com/users/chescock/gists{/gist_id}","starred_url":"https://api.github.com/users/chescock/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chescock/subscriptions","organizations_url":"https://api.github.com/users/chescock/orgs","repos_url":"https://api.github.com/users/chescock/repos","events_url":"https://api.github.com/users/chescock/events{/privacy}","received_events_url":"https://api.github.com/users/chescock/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":2197761682,"node_id":"MDU6TGFiZWwyMTk3NzYxNjgy","url":"https://api.github.com/repos/bevyengine/bevy/labels/A-ECS","name":"A-ECS","color":"c6a751","default":false,"description":"Entities, components, systems, and events"},{"id":2287994822,"node_id":"MDU6TGFiZWwyMjg3OTk0ODIy","url":"https://api.github.com/repos/bevyengine/bevy/labels/C-Code-Quality","name":"C-Code-Quality","color":"B8B8B8","default":false,"description":"A section of code that is hard to understand or change"},{"id":2747857990,"node_id":"MDU6TGFiZWwyNzQ3ODU3OTkw","url":"https://api.github.com/repos/bevyengine/bevy/labels/C-Usability","name":"C-Usability","color":"b8b8b8","default":false,"description":"A targeted quality-of-life change that makes Bevy easier to use"},{"id":2747865511,"node_id":"MDU6TGFiZWwyNzQ3ODY1NTEx","url":"https://api.github.com/repos/bevyengine/bevy/labels/S-Ready-For-Final-Review","name":"S-Ready-For-Final-Review","color":"D876E3","default":false,"description":"This PR has been approved by the community. It's ready for a maintainer to consider merging it"},{"id":3166133948,"node_id":"MDU6TGFiZWwzMTY2MTMzOTQ4","url":"https://api.github.com/repos/bevyengine/bevy/labels/M-Migration-Guide","name":"M-Migration-Guide","color":"006B75","default":false,"description":"A breaking change to Bevy's public API that needs to be noted in a migration guide"},{"id":6600141374,"node_id":"LA_kwDODf6-U88AAAABiWYqPg","url":"https://api.github.com/repos/bevyengine/bevy/labels/M-Release-Note","name":"M-Release-Note","color":"006B75","default":false,"description":"Work that should be called out in the blog due to impact"},{"id":6899552399,"node_id":"LA_kwDODf6-U88AAAABmz7Qjw","url":"https://api.github.com/repos/bevyengine/bevy/labels/X-Contentious","name":"X-Contentious","color":"D93F0B","default":false,"description":"There are nontrivial implications that should be thought through"},{"id":6899576022,"node_id":"LA_kwDODf6-U88AAAABmz8s1g","url":"https://api.github.com/repos/bevyengine/bevy/labels/D-Modest","name":"D-Modest","color":"008672","default":false,"description":"A \"normal\" level of difficulty; suitable for simple features or challenging fixes"},{"id":6899583116,"node_id":"LA_kwDODf6-U88AAAABmz9IjA","url":"https://api.github.com/repos/bevyengine/bevy/labels/D-Unsafe","name":"D-Unsafe","color":"008672","default":false,"description":"Touches with unsafe code in some way"}],"state":"closed","locked":false,"assignee":{"login":"Trashtalk217","id":24552941,"node_id":"MDQ6VXNlcjI0NTUyOTQx","avatar_url":"https://avatars.githubusercontent.com/u/24552941?v=4","gravatar_id":"","url":"https://api.github.com/users/Trashtalk217","html_url":"https://github.com/Trashtalk217","followers_url":"https://api.github.com/users/Trashtalk217/followers","following_url":"https://api.github.com/users/Trashtalk217/following{/other_user}","gists_url":"https://api.github.com/users/Trashtalk217/gists{/gist_id}","starred_url":"https://api.github.com/users/Trashtalk217/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Trashtalk217/subscriptions","organizations_url":"https://api.github.com/users/Trashtalk217/orgs","repos_url":"https://api.github.com/users/Trashtalk217/repos","events_url":"https://api.github.com/users/Trashtalk217/events{/privacy}","received_events_url":"https://api.github.com/users/Trashtalk217/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"Trashtalk217","id":24552941,"node_id":"MDQ6VXNlcjI0NTUyOTQx","avatar_url":"https://avatars.githubusercontent.com/u/24552941?v=4","gravatar_id":"","url":"https://api.github.com/users/Trashtalk217","html_url":"https://github.com/Trashtalk217","followers_url":"https://api.github.com/users/Trashtalk217/followers","following_url":"https://api.github.com/users/Trashtalk217/following{/other_user}","gists_url":"https://api.github.com/users/Trashtalk217/gists{/gist_id}","starred_url":"https://api.github.com/users/Trashtalk217/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Trashtalk217/subscriptions","organizations_url":"https://api.github.com/users/Trashtalk217/orgs","repos_url":"https://api.github.com/users/Trashtalk217/repos","events_url":"https://api.github.com/users/Trashtalk217/events{/privacy}","received_events_url":"https://api.github.com/users/Trashtalk217/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/bevyengine/bevy/milestones/28","html_url":"https://github.com/bevyengine/bevy/milestone/28","labels_url":"https://api.github.com/repos/bevyengine/bevy/milestones/28/labels","id":11655039,"node_id":"MI_kwDODf6-U84Asdd_","number":28,"title":"0.16","description":"","creator":{"login":"alice-i-cecile","id":3579909,"node_id":"MDQ6VXNlcjM1Nzk5MDk=","avatar_url":"https://avatars.githubusercontent.com/u/3579909?v=4","gravatar_id":"","url":"https://api.github.com/users/alice-i-cecile","html_url":"https://github.com/alice-i-cecile","followers_url":"https://api.github.com/users/alice-i-cecile/followers","following_url":"https://api.github.com/users/alice-i-cecile/following{/other_user}","gists_url":"https://api.github.com/users/alice-i-cecile/gists{/gist_id}","starred_url":"https://api.github.com/users/alice-i-cecile/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alice-i-cecile/subscriptions","organizations_url":"https://api.github.com/users/alice-i-cecile/orgs","repos_url":"https://api.github.com/users/alice-i-cecile/repos","events_url":"https://api.github.com/users/alice-i-cecile/events{/privacy}","received_events_url":"https://api.github.com/users/alice-i-cecile/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":558,"state":"closed","created_at":"2024-09-30T20:15:21Z","updated_at":"2025-04-25T13:01:43Z","due_on":null,"closed_at":"2025-04-25T13:01:43Z"},"comments":11,"created_at":"2024-10-11T17:17:34Z","updated_at":"2025-03-25T20:08:26Z","closed_at":"2025-02-05T18:50:05Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"draft":false,"repository":{"id":234798675,"node_id":"MDEwOlJlcG9zaXRvcnkyMzQ3OTg2NzU=","name":"bevy","full_name":"bevyengine/bevy","private":false,"owner":{"login":"bevyengine","id":60047606,"node_id":"MDEyOk9yZ2FuaXphdGlvbjYwMDQ3NjA2","avatar_url":"https://avatars.githubusercontent.com/u/60047606?v=4","gravatar_id":"","url":"https://api.github.com/users/bevyengine","html_url":"https://github.com/bevyengine","followers_url":"https://api.github.com/users/bevyengine/followers","following_url":"https://api.github.com/users/bevyengine/following{/other_user}","gists_url":"https://api.github.com/users/bevyengine/gists{/gist_id}","starred_url":"https://api.github.com/users/bevyengine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bevyengine/subscriptions","organizations_url":"https://api.github.com/users/bevyengine/orgs","repos_url":"https://api.github.com/users/bevyengine/repos","events_url":"https://api.github.com/users/bevyengine/events{/privacy}","received_events_url":"https://api.github.com/users/bevyengine/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/bevyengine/bevy","description":"A refreshingly simple data-driven game engine built in Rust","fork":false,"url":"https://api.github.com/repos/bevyengine/bevy","forks_url":"https://api.github.com/repos/bevyengine/bevy/forks","keys_url":"https://api.github.com/repos/bevyengine/bevy/keys{/key_id}","collaborators_url":"https://api.github.com/repos/bevyengine/bevy/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/bevyengine/bevy/teams","hooks_url":"https://api.github.com/repos/bevyengine/bevy/hooks","issue_events_url":"https://api.github.com/repos/bevyengine/bevy/issues/events{/number}","events_url":"https://api.github.com/repos/bevyengine/bevy/events","assignees_url":"https://api.github.com/repos/bevyengine/bevy/assignees{/user}","branches_url":"https://api.github.com/repos/bevyengine/bevy/branches{/branch}","tags_url":"https://api.github.com/repos/bevyengine/bevy/tags","blobs_url":"https://api.github.com/repos/bevyengine/bevy/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/bevyengine/bevy/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/bevyengine/bevy/git/refs{/sha}","trees_url":"https://api.github.com/repos/bevyengine/bevy/git/trees{/sha}","statuses_url":"https://api.github.com/repos/bevyengine/bevy/statuses/{sha}","languages_url":"https://api.github.com/repos/bevyengine/bevy/languages","stargazers_url":"https://api.github.com/repos/bevyengine/bevy/stargazers","contributors_url":"https://api.github.com/repos/bevyengine/bevy/contributors","subscribers_url":"https://api.github.com/repos/bevyengine/bevy/subscribers","subscription_url":"https://api.github.com/repos/bevyengine/bevy/subscription","commits_url":"https://api.github.com/repos/bevyengine/bevy/commits{/sha}","git_commits_url":"https://api.github.com/repos/bevyengine/bevy/git/commits{/sha}","comments_url":"https://api.github.com/repos/bevyengine/bevy/comments{/number}","issue_comment_url":"https://api.github.com/repos/bevyengine/bevy/issues/comments{/number}","contents_url":"https://api.github.com/repos/bevyengine/bevy/contents/{+path}","compare_url":"https://api.github.com/repos/bevyengine/bevy/compare/{base}...{head}","merges_url":"https://api.github.com/repos/bevyengine/bevy/merges","archive_url":"https://api.github.com/repos/bevyengine/bevy/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/bevyengine/bevy/downloads","issues_url":"https://api.github.com/repos/bevyengine/bevy/issues{/number}","pulls_url":"https://api.github.com/repos/bevyengine/bevy/pulls{/number}","milestones_url":"https://api.github.com/repos/bevyengine/bevy/milestones{/number}","notifications_url":"https://api.github.com/repos/bevyengine/bevy/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/bevyengine/bevy/labels{/name}","releases_url":"https://api.github.com/repos/bevyengine/bevy/releases{/id}","deployments_url":"https://api.github.com/repos/bevyengine/bevy/deployments","created_at":"2020-01-18T21:13:55Z","updated_at":"2025-11-10T00:30:24Z","pushed_at":"2025-11-09T20:05:46Z","git_url":"git://github.com/bevyengine/bevy.git","ssh_url":"git@github.com:bevyengine/bevy.git","clone_url":"https://github.com/bevyengine/bevy.git","svn_url":"https://github.com/bevyengine/bevy","homepage":"https://bevy.org","size":152673,"stargazers_count":42996,"watchers_count":42996,"language":"Rust","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":false,"has_pages":true,"has_discussions":true,"forks_count":4220,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":3116,"license":{"key":"apache-2.0","name":"Apache License 2.0","spdx_id":"Apache-2.0","url":"https://api.github.com/licenses/apache-2.0","node_id":"MDc6TGljZW5zZTI="},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["bevy","game-development","game-engine","gamedev","open-source","rust"],"visibility":"public","forks":4220,"open_issues":3116,"watchers":42996,"default_branch":"main","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"pull_request":{"url":"https://api.github.com/repos/bevyengine/bevy/pulls/15858","html_url":"https://github.com/bevyengine/bevy/pull/15858","diff_url":"https://github.com/bevyengine/bevy/pull/15858.diff","patch_url":"https://github.com/bevyengine/bevy/pull/15858.patch","merged_at":"2025-02-05T18:50:05Z"},"body":"# Objective\r\n\r\nSimplify and expand the API for `QueryState`.  \r\n\r\n`QueryState` has a lot of methods that mirror those on `Query`.  These are then multiplied by variants that take `&World`, `&mut World`, and `UnsafeWorldCell`.  In addition, many of them have `_manual` variants that take `&QueryState` and avoid calling `update_archetypes()`.  Not all of the combinations exist, however, so some operations are not possible.  \r\n\r\n## Solution\r\n\r\nIntroduce methods to get a `Query` from a `QueryState`.  That will reduce duplication between the types, and ensure that the full `Query` API is always available for `QueryState`.  \r\n\r\nIntroduce methods on `Query` that consume the query to return types with the full `'w` lifetime.  This avoids issues with borrowing where things like `query_state.query(&world).get(entity)` don't work because they borrow from the temporary `Query`.  \r\n\r\nFinally, implement `Copy` for read-only `Query`s.  `get_inner` and `iter_inner` currently take `&self`, so changing them to consume `self` would be a breaking change.  By making `Query: Copy`, they can consume a copy of `self` and continue to work.  \r\n\r\nThe consuming methods also let us simplify the implementation of methods on `Query`, by doing `fn foo(&self) { self.as_readonly().foo_inner() }` and `fn foo_mut(&mut self) { self.reborrow().foo_inner() }`.  That structure makes it more difficult to accidentally extend lifetimes, since the safe `as_readonly()` and `reborrow()` methods shrink them appropriately.  The optimizer is able to see that they are both identity functions and inline them, so there should be no performance cost.  \r\n\r\nNote that this change would conflict with #15848.  If `QueryState` is stored as a `Cow`, then the consuming methods cannot be implemented, and `Copy` cannot be implemented.  \r\n\r\n## Future Work\r\n\r\nThe next step is to mark the methods on `QueryState` as `#[deprecated]`, and move the implementations into `Query`.  \r\n\r\n## Migration Guide\r\n\r\n`Query::to_readonly` has been renamed to `Query::as_readonly`.  ","reactions":{"url":"https://api.github.com/repos/bevyengine/bevy/issues/15858/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/bevyengine/bevy/issues/15858/timeline","performed_via_github_app":null,"state_reason":null}},"event":"cross-referenced"},{"url":"https://api.github.com/repos/bevyengine/bevy/issues/comments/2637770585","html_url":"https://github.com/bevyengine/bevy/issues/17693#issuecomment-2637770585","issue_url":"https://api.github.com/repos/bevyengine/bevy/issues/17693","id":2637770585,"node_id":"IC_kwDODf6-U86dOS9Z","user":{"login":"alice-i-cecile","id":3579909,"node_id":"MDQ6VXNlcjM1Nzk5MDk=","avatar_url":"https://avatars.githubusercontent.com/u/3579909?v=4","gravatar_id":"","url":"https://api.github.com/users/alice-i-cecile","html_url":"https://github.com/alice-i-cecile","followers_url":"https://api.github.com/users/alice-i-cecile/followers","following_url":"https://api.github.com/users/alice-i-cecile/following{/other_user}","gists_url":"https://api.github.com/users/alice-i-cecile/gists{/gist_id}","starred_url":"https://api.github.com/users/alice-i-cecile/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alice-i-cecile/subscriptions","organizations_url":"https://api.github.com/users/alice-i-cecile/orgs","repos_url":"https://api.github.com/users/alice-i-cecile/repos","events_url":"https://api.github.com/users/alice-i-cecile/events{/privacy}","received_events_url":"https://api.github.com/users/alice-i-cecile/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2025-02-05T18:58:32Z","updated_at":"2025-02-05T18:58:32Z","body":"Good eye; that's worth double checking. I think the best way to test this is to open a draft PR with a test that tries to exploit this, and see if miri complains.","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/bevyengine/bevy/issues/comments/2637770585/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"alice-i-cecile","id":3579909,"node_id":"MDQ6VXNlcjM1Nzk5MDk=","avatar_url":"https://avatars.githubusercontent.com/u/3579909?v=4","gravatar_id":"","url":"https://api.github.com/users/alice-i-cecile","html_url":"https://github.com/alice-i-cecile","followers_url":"https://api.github.com/users/alice-i-cecile/followers","following_url":"https://api.github.com/users/alice-i-cecile/following{/other_user}","gists_url":"https://api.github.com/users/alice-i-cecile/gists{/gist_id}","starred_url":"https://api.github.com/users/alice-i-cecile/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alice-i-cecile/subscriptions","organizations_url":"https://api.github.com/users/alice-i-cecile/orgs","repos_url":"https://api.github.com/users/alice-i-cecile/repos","events_url":"https://api.github.com/users/alice-i-cecile/events{/privacy}","received_events_url":"https://api.github.com/users/alice-i-cecile/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/bevyengine/bevy/issues/comments/2637787219","html_url":"https://github.com/bevyengine/bevy/issues/17693#issuecomment-2637787219","issue_url":"https://api.github.com/repos/bevyengine/bevy/issues/17693","id":2637787219,"node_id":"IC_kwDODf6-U86dOXBT","user":{"login":"13ros27","id":32036861,"node_id":"MDQ6VXNlcjMyMDM2ODYx","avatar_url":"https://avatars.githubusercontent.com/u/32036861?v=4","gravatar_id":"","url":"https://api.github.com/users/13ros27","html_url":"https://github.com/13ros27","followers_url":"https://api.github.com/users/13ros27/followers","following_url":"https://api.github.com/users/13ros27/following{/other_user}","gists_url":"https://api.github.com/users/13ros27/gists{/gist_id}","starred_url":"https://api.github.com/users/13ros27/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/13ros27/subscriptions","organizations_url":"https://api.github.com/users/13ros27/orgs","repos_url":"https://api.github.com/users/13ros27/repos","events_url":"https://api.github.com/users/13ros27/events{/privacy}","received_events_url":"https://api.github.com/users/13ros27/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2025-02-05T19:02:50Z","updated_at":"2025-02-05T19:08:00Z","body":"To check if I understand this idea correctly:\n```rust\nfn test(query: Query<&mut Test>) {\n    let lens = query.transmute_lens::<&Test>();\n    let query2 = lens.query();\n    let query_copy = query2;\n    let lens2 = query_copy.transmute_lens::<&Test>();\n    let query3 = lens2.query(); // And the issue is that this potentially no longer has a reference on `query`?\n}\n```","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/bevyengine/bevy/issues/comments/2637787219/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"13ros27","id":32036861,"node_id":"MDQ6VXNlcjMyMDM2ODYx","avatar_url":"https://avatars.githubusercontent.com/u/32036861?v=4","gravatar_id":"","url":"https://api.github.com/users/13ros27","html_url":"https://github.com/13ros27","followers_url":"https://api.github.com/users/13ros27/followers","following_url":"https://api.github.com/users/13ros27/following{/other_user}","gists_url":"https://api.github.com/users/13ros27/gists{/gist_id}","starred_url":"https://api.github.com/users/13ros27/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/13ros27/subscriptions","organizations_url":"https://api.github.com/users/13ros27/orgs","repos_url":"https://api.github.com/users/13ros27/repos","events_url":"https://api.github.com/users/13ros27/events{/privacy}","received_events_url":"https://api.github.com/users/13ros27/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/bevyengine/bevy/issues/comments/2637793601","html_url":"https://github.com/bevyengine/bevy/issues/17693#issuecomment-2637793601","issue_url":"https://api.github.com/repos/bevyengine/bevy/issues/17693","id":2637793601,"node_id":"IC_kwDODf6-U86dOYlB","user":{"login":"chescock","id":8494645,"node_id":"MDQ6VXNlcjg0OTQ2NDU=","avatar_url":"https://avatars.githubusercontent.com/u/8494645?v=4","gravatar_id":"","url":"https://api.github.com/users/chescock","html_url":"https://github.com/chescock","followers_url":"https://api.github.com/users/chescock/followers","following_url":"https://api.github.com/users/chescock/following{/other_user}","gists_url":"https://api.github.com/users/chescock/gists{/gist_id}","starred_url":"https://api.github.com/users/chescock/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chescock/subscriptions","organizations_url":"https://api.github.com/users/chescock/orgs","repos_url":"https://api.github.com/users/chescock/repos","events_url":"https://api.github.com/users/chescock/events{/privacy}","received_events_url":"https://api.github.com/users/chescock/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2025-02-05T19:05:29Z","updated_at":"2025-02-05T19:05:29Z","body":"I think that translates to\n\n```rust\nfn foo(mut query: Query<EntityMut>) {\n    let mut first_lens = query.as_query_lens();\n    let second_query = first_lens.query();\n    let mut second_query_copy = second_query;\n    let mut second_lens = second_query_copy.as_query_lens();\n    let bad_item_one = query.iter_mut().next();\n    let bad_item_two = second_lens.query().into_iter().next();\n}\n```\n\nThat does give me a \"cannot borrow `query` as mutable more than once at a time\" error.  \n\nOh, but wait, rust-analyzer tells me everything there is a `Query<EntityMut>`, so I haven't managed to `Copy` anything yet.  ","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/bevyengine/bevy/issues/comments/2637793601/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"chescock","id":8494645,"node_id":"MDQ6VXNlcjg0OTQ2NDU=","avatar_url":"https://avatars.githubusercontent.com/u/8494645?v=4","gravatar_id":"","url":"https://api.github.com/users/chescock","html_url":"https://github.com/chescock","followers_url":"https://api.github.com/users/chescock/followers","following_url":"https://api.github.com/users/chescock/following{/other_user}","gists_url":"https://api.github.com/users/chescock/gists{/gist_id}","starred_url":"https://api.github.com/users/chescock/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chescock/subscriptions","organizations_url":"https://api.github.com/users/chescock/orgs","repos_url":"https://api.github.com/users/chescock/repos","events_url":"https://api.github.com/users/chescock/events{/privacy}","received_events_url":"https://api.github.com/users/chescock/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/bevyengine/bevy/issues/comments/2637801079","html_url":"https://github.com/bevyengine/bevy/issues/17693#issuecomment-2637801079","issue_url":"https://api.github.com/repos/bevyengine/bevy/issues/17693","id":2637801079,"node_id":"IC_kwDODf6-U86dOaZ3","user":{"login":"13ros27","id":32036861,"node_id":"MDQ6VXNlcjMyMDM2ODYx","avatar_url":"https://avatars.githubusercontent.com/u/32036861?v=4","gravatar_id":"","url":"https://api.github.com/users/13ros27","html_url":"https://github.com/13ros27","followers_url":"https://api.github.com/users/13ros27/followers","following_url":"https://api.github.com/users/13ros27/following{/other_user}","gists_url":"https://api.github.com/users/13ros27/gists{/gist_id}","starred_url":"https://api.github.com/users/13ros27/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/13ros27/subscriptions","organizations_url":"https://api.github.com/users/13ros27/orgs","repos_url":"https://api.github.com/users/13ros27/repos","events_url":"https://api.github.com/users/13ros27/events{/privacy}","received_events_url":"https://api.github.com/users/13ros27/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2025-02-05T19:09:24Z","updated_at":"2025-02-05T19:09:24Z","body":"> Oh, but wait, rust-analyzer tells me everything there is a `Query<EntityMut>`, so I haven't managed to `Copy` anything yet.\n\nI think you need to use `transmute_lens` to make it read_only?","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/bevyengine/bevy/issues/comments/2637801079/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"13ros27","id":32036861,"node_id":"MDQ6VXNlcjMyMDM2ODYx","avatar_url":"https://avatars.githubusercontent.com/u/32036861?v=4","gravatar_id":"","url":"https://api.github.com/users/13ros27","html_url":"https://github.com/13ros27","followers_url":"https://api.github.com/users/13ros27/followers","following_url":"https://api.github.com/users/13ros27/following{/other_user}","gists_url":"https://api.github.com/users/13ros27/gists{/gist_id}","starred_url":"https://api.github.com/users/13ros27/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/13ros27/subscriptions","organizations_url":"https://api.github.com/users/13ros27/orgs","repos_url":"https://api.github.com/users/13ros27/repos","events_url":"https://api.github.com/users/13ros27/events{/privacy}","received_events_url":"https://api.github.com/users/13ros27/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/bevyengine/bevy/issues/comments/2637845849","html_url":"https://github.com/bevyengine/bevy/issues/17693#issuecomment-2637845849","issue_url":"https://api.github.com/repos/bevyengine/bevy/issues/17693","id":2637845849,"node_id":"IC_kwDODf6-U86dOlVZ","user":{"login":"chescock","id":8494645,"node_id":"MDQ6VXNlcjg0OTQ2NDU=","avatar_url":"https://avatars.githubusercontent.com/u/8494645?v=4","gravatar_id":"","url":"https://api.github.com/users/chescock","html_url":"https://github.com/chescock","followers_url":"https://api.github.com/users/chescock/followers","following_url":"https://api.github.com/users/chescock/following{/other_user}","gists_url":"https://api.github.com/users/chescock/gists{/gist_id}","starred_url":"https://api.github.com/users/chescock/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chescock/subscriptions","organizations_url":"https://api.github.com/users/chescock/orgs","repos_url":"https://api.github.com/users/chescock/repos","events_url":"https://api.github.com/users/chescock/events{/privacy}","received_events_url":"https://api.github.com/users/chescock/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2025-02-05T19:29:01Z","updated_at":"2025-02-05T19:29:01Z","body":"The chain of custody should be in the `'w` parameter.  `transmute_lens()` goes from `&mut self` to `QueryLens<'_, D>`, so the lens is only allowed to access the world while the original borrow is ongoing.  Ah, `QueryLens::query` goes from `&mut self` to `Query<'w, '_, Q, F>`.  I see: The intent there was that restricting the `'s` lifetime would be enough, and it could use the original `'w` lifetime.  \n\nIf that's unsound here, would it have already been unsound with `get_inner()` and `iter_inner()`?  `lens.query().get_inner()` would give you something with the `'w` lifetime from the lens, but only if it was read-only.  And the lens was permanently read-only, since there was no `Query::into_readonly()` or anything.  So I think that was sound then, but is unsound now that we can do `lens.query().into_readonly().get_inner()`.  \n\nSo, I still haven't worked out the exact way to reproduce it, but I agree that I introduced unsoundness!  \n\nCould we fix it by changing `QueryLens::query` to return `Query<'_, '_, Q, F>`?  That would fit the model that we're *borrowing* the world access for the duration of the query.  But it would make it impossible to get `'w` data back out of the lens.  \n\nOh, but maybe we could have `QueryLens::query_inner` that returns `Query<'w, '_, Q, F>` but that requires `Q:ReadOnlyQueryData`?  If that's sound, it should cover all the cases that were possible before, since you could only get `_inner` data for read-only queries.  ","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/bevyengine/bevy/issues/comments/2637845849/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"chescock","id":8494645,"node_id":"MDQ6VXNlcjg0OTQ2NDU=","avatar_url":"https://avatars.githubusercontent.com/u/8494645?v=4","gravatar_id":"","url":"https://api.github.com/users/chescock","html_url":"https://github.com/chescock","followers_url":"https://api.github.com/users/chescock/followers","following_url":"https://api.github.com/users/chescock/following{/other_user}","gists_url":"https://api.github.com/users/chescock/gists{/gist_id}","starred_url":"https://api.github.com/users/chescock/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chescock/subscriptions","organizations_url":"https://api.github.com/users/chescock/orgs","repos_url":"https://api.github.com/users/chescock/repos","events_url":"https://api.github.com/users/chescock/events{/privacy}","received_events_url":"https://api.github.com/users/chescock/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/bevyengine/bevy/issues/comments/2637860518","html_url":"https://github.com/bevyengine/bevy/issues/17693#issuecomment-2637860518","issue_url":"https://api.github.com/repos/bevyengine/bevy/issues/17693","id":2637860518,"node_id":"IC_kwDODf6-U86dOo6m","user":{"login":"chescock","id":8494645,"node_id":"MDQ6VXNlcjg0OTQ2NDU=","avatar_url":"https://avatars.githubusercontent.com/u/8494645?v=4","gravatar_id":"","url":"https://api.github.com/users/chescock","html_url":"https://github.com/chescock","followers_url":"https://api.github.com/users/chescock/followers","following_url":"https://api.github.com/users/chescock/following{/other_user}","gists_url":"https://api.github.com/users/chescock/gists{/gist_id}","starred_url":"https://api.github.com/users/chescock/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chescock/subscriptions","organizations_url":"https://api.github.com/users/chescock/orgs","repos_url":"https://api.github.com/users/chescock/repos","events_url":"https://api.github.com/users/chescock/events{/privacy}","received_events_url":"https://api.github.com/users/chescock/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2025-02-05T19:36:46Z","updated_at":"2025-02-05T19:36:46Z","body":"Okay, one reproduction is\n\n```rust\nfn bad<'w>(mut lens: QueryLens<'w, EntityMut>, entity: Entity) {\n    let one: EntityMut<'w> = lens.query().get_inner(entity).unwrap();\n    let two: EntityMut<'w> = lens.query().get_inner(entity).unwrap();\n    assert!(one.entity() == two.entity());\n}\n```\n\nAnd changing the return type of `QueryLens::query()` from `Query<'w, '_, Q, F>` to `Query<'_, '_, Q, F>` does make that fail to compile.  ","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/bevyengine/bevy/issues/comments/2637860518/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"chescock","id":8494645,"node_id":"MDQ6VXNlcjg0OTQ2NDU=","avatar_url":"https://avatars.githubusercontent.com/u/8494645?v=4","gravatar_id":"","url":"https://api.github.com/users/chescock","html_url":"https://github.com/chescock","followers_url":"https://api.github.com/users/chescock/followers","following_url":"https://api.github.com/users/chescock/following{/other_user}","gists_url":"https://api.github.com/users/chescock/gists{/gist_id}","starred_url":"https://api.github.com/users/chescock/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chescock/subscriptions","organizations_url":"https://api.github.com/users/chescock/orgs","repos_url":"https://api.github.com/users/chescock/repos","events_url":"https://api.github.com/users/chescock/events{/privacy}","received_events_url":"https://api.github.com/users/chescock/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/bevyengine/bevy/issues/comments/2637867550","html_url":"https://github.com/bevyengine/bevy/issues/17693#issuecomment-2637867550","issue_url":"https://api.github.com/repos/bevyengine/bevy/issues/17693","id":2637867550,"node_id":"IC_kwDODf6-U86dOqoe","user":{"login":"Victoronz","id":59878206,"node_id":"MDQ6VXNlcjU5ODc4MjA2","avatar_url":"https://avatars.githubusercontent.com/u/59878206?v=4","gravatar_id":"","url":"https://api.github.com/users/Victoronz","html_url":"https://github.com/Victoronz","followers_url":"https://api.github.com/users/Victoronz/followers","following_url":"https://api.github.com/users/Victoronz/following{/other_user}","gists_url":"https://api.github.com/users/Victoronz/gists{/gist_id}","starred_url":"https://api.github.com/users/Victoronz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Victoronz/subscriptions","organizations_url":"https://api.github.com/users/Victoronz/orgs","repos_url":"https://api.github.com/users/Victoronz/repos","events_url":"https://api.github.com/users/Victoronz/events{/privacy}","received_events_url":"https://api.github.com/users/Victoronz/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2025-02-05T19:40:27Z","updated_at":"2025-02-05T19:40:27Z","body":"I remember making this [comment](https://github.com/bevyengine/bevy/pull/16141#issuecomment-2567218790) on another PR, I think it summarizes the `'w` quite well:\n\n>Revisiting this, I think this is definitely a more intricate issue than it at first seems. This is my current understanding of the lifetimes here:\n>\n>The 'w lifetime doesn't semantically mean what it sounds like:\nAs far as I understand, it is supposed to represent a \"borrow from world\", which conceptually means that there is a &'w World that 'w refers to. However, that isn't really the case. Semantically, a 'w lifetime is simply a named lifetime like any other, i.e. 'a. Its scope must match any other mention of 'w in the item it is defined in, and satisfy any specified bounds on top of that. Because there is not just one \"world borrow lifetime\", we are lead to confusing situations where we have both 'world and 'w, which are both supposed to be the same, yet are semantically not.\n>\n>Furthermore, &'w mut Query<'w, ...> doesn't mean we have a borrow of Query that lives as long as world, but that 'w is now constrained to match the scope of that query borrow.\nIf we obtain an EntityMut<'_> from that query, what is originally written as 'w in the struct definition instead becomes scoped on our query borrow (we could call this 'q). If we now fetch an item from EntityMut, we rely on a borrow of that struct, not directly of Query, or World.\nIn these constrained cases, switching '_ to 'w is actually unsound! See: https://github.com/bevyengine/bevy/pull/17035\nI think there are handful of these unsound conversions in this PR.\n(Similar to this are transmutes, where the 's in a newly constructed Query borrows from a QueryLens).\n>\n>I do like '_ when it can remove noise, and say \"it is inferred, don't worry about this\", and I like 'w when it can clarify noise, and say \"it is a world borrow, don't worry about this\".\n>\n>When either applies is heavily case dependent, and I don't think I can broadly say.","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/bevyengine/bevy/issues/comments/2637867550/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"Victoronz","id":59878206,"node_id":"MDQ6VXNlcjU5ODc4MjA2","avatar_url":"https://avatars.githubusercontent.com/u/59878206?v=4","gravatar_id":"","url":"https://api.github.com/users/Victoronz","html_url":"https://github.com/Victoronz","followers_url":"https://api.github.com/users/Victoronz/followers","following_url":"https://api.github.com/users/Victoronz/following{/other_user}","gists_url":"https://api.github.com/users/Victoronz/gists{/gist_id}","starred_url":"https://api.github.com/users/Victoronz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Victoronz/subscriptions","organizations_url":"https://api.github.com/users/Victoronz/orgs","repos_url":"https://api.github.com/users/Victoronz/repos","events_url":"https://api.github.com/users/Victoronz/events{/privacy}","received_events_url":"https://api.github.com/users/Victoronz/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/bevyengine/bevy/issues/comments/2637899611","html_url":"https://github.com/bevyengine/bevy/issues/17693#issuecomment-2637899611","issue_url":"https://api.github.com/repos/bevyengine/bevy/issues/17693","id":2637899611,"node_id":"IC_kwDODf6-U86dOydb","user":{"login":"chescock","id":8494645,"node_id":"MDQ6VXNlcjg0OTQ2NDU=","avatar_url":"https://avatars.githubusercontent.com/u/8494645?v=4","gravatar_id":"","url":"https://api.github.com/users/chescock","html_url":"https://github.com/chescock","followers_url":"https://api.github.com/users/chescock/followers","following_url":"https://api.github.com/users/chescock/following{/other_user}","gists_url":"https://api.github.com/users/chescock/gists{/gist_id}","starred_url":"https://api.github.com/users/chescock/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chescock/subscriptions","organizations_url":"https://api.github.com/users/chescock/orgs","repos_url":"https://api.github.com/users/chescock/repos","events_url":"https://api.github.com/users/chescock/events{/privacy}","received_events_url":"https://api.github.com/users/chescock/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2025-02-05T19:56:46Z","updated_at":"2025-02-05T19:56:46Z","body":"I believe the semantics for `Query` should be that `Query<'w, 's, D, F>` comes with permission to access the components matched by `self.state.component_access` for the lifetime `'w`.  That's what the executor gives the parameter when we schedule a system, and that's enough to justify the implementations of its methods both before and after #15858.  \n\nI would expect the same thing for `QueryLens<'w, D, F>`.  \n\nDo those rules seem reasonable?  If not, what *should* the rules be?  \n\nUnder those rules, `QueryLens::query()` is unsound, since it hands out permission for the full `'w` lifetime, but then claims it has it again when the `'_` lifetime ends.  The fix is to hand out permission only for `'_`.  \n\nBut I think a `QueryLens::query_inner()` that hands out a full `'w` lifetime but requires `D: ReadOnlyQueryData` should be sound.  It does have the access to give away, and it's okay that it has it again later because read-only access doesn't conflict with itself.  Since the only way to use the full `'w` lifetime prior to #15858 required `ReadOnlyQueryData`, that should cover any cases broken by the change to `QueryLens::query()`.  \n\nI'll try to push up a PR with those two changes in case that's the way we want to go.  ","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/bevyengine/bevy/issues/comments/2637899611/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"chescock","id":8494645,"node_id":"MDQ6VXNlcjg0OTQ2NDU=","avatar_url":"https://avatars.githubusercontent.com/u/8494645?v=4","gravatar_id":"","url":"https://api.github.com/users/chescock","html_url":"https://github.com/chescock","followers_url":"https://api.github.com/users/chescock/followers","following_url":"https://api.github.com/users/chescock/following{/other_user}","gists_url":"https://api.github.com/users/chescock/gists{/gist_id}","starred_url":"https://api.github.com/users/chescock/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chescock/subscriptions","organizations_url":"https://api.github.com/users/chescock/orgs","repos_url":"https://api.github.com/users/chescock/repos","events_url":"https://api.github.com/users/chescock/events{/privacy}","received_events_url":"https://api.github.com/users/chescock/received_events","type":"User","user_view_type":"public","site_admin":false}},{"actor":{"login":"chescock","id":8494645,"node_id":"MDQ6VXNlcjg0OTQ2NDU=","avatar_url":"https://avatars.githubusercontent.com/u/8494645?v=4","gravatar_id":"","url":"https://api.github.com/users/chescock","html_url":"https://github.com/chescock","followers_url":"https://api.github.com/users/chescock/followers","following_url":"https://api.github.com/users/chescock/following{/other_user}","gists_url":"https://api.github.com/users/chescock/gists{/gist_id}","starred_url":"https://api.github.com/users/chescock/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chescock/subscriptions","organizations_url":"https://api.github.com/users/chescock/orgs","repos_url":"https://api.github.com/users/chescock/repos","events_url":"https://api.github.com/users/chescock/events{/privacy}","received_events_url":"https://api.github.com/users/chescock/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2025-02-05T20:08:35Z","updated_at":"2025-02-05T20:08:35Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/bevyengine/bevy/issues/17694","repository_url":"https://api.github.com/repos/bevyengine/bevy","labels_url":"https://api.github.com/repos/bevyengine/bevy/issues/17694/labels{/name}","comments_url":"https://api.github.com/repos/bevyengine/bevy/issues/17694/comments","events_url":"https://api.github.com/repos/bevyengine/bevy/issues/17694/events","html_url":"https://github.com/bevyengine/bevy/pull/17694","id":2833862540,"node_id":"PR_kwDODf6-U86KMJoG","number":17694,"title":"Shorten the 'world lifetime returned from `QueryLens::query()`.","user":{"login":"chescock","id":8494645,"node_id":"MDQ6VXNlcjg0OTQ2NDU=","avatar_url":"https://avatars.githubusercontent.com/u/8494645?v=4","gravatar_id":"","url":"https://api.github.com/users/chescock","html_url":"https://github.com/chescock","followers_url":"https://api.github.com/users/chescock/followers","following_url":"https://api.github.com/users/chescock/following{/other_user}","gists_url":"https://api.github.com/users/chescock/gists{/gist_id}","starred_url":"https://api.github.com/users/chescock/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chescock/subscriptions","organizations_url":"https://api.github.com/users/chescock/orgs","repos_url":"https://api.github.com/users/chescock/repos","events_url":"https://api.github.com/users/chescock/events{/privacy}","received_events_url":"https://api.github.com/users/chescock/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1795619323,"node_id":"MDU6TGFiZWwxNzk1NjE5MzIz","url":"https://api.github.com/repos/bevyengine/bevy/labels/C-Bug","name":"C-Bug","color":"d73a4a","default":false,"description":"An unexpected or incorrect behavior"},{"id":2197761682,"node_id":"MDU6TGFiZWwyMTk3NzYxNjgy","url":"https://api.github.com/repos/bevyengine/bevy/labels/A-ECS","name":"A-ECS","color":"c6a751","default":false,"description":"Entities, components, systems, and events"},{"id":2747865511,"node_id":"MDU6TGFiZWwyNzQ3ODY1NTEx","url":"https://api.github.com/repos/bevyengine/bevy/labels/S-Ready-For-Final-Review","name":"S-Ready-For-Final-Review","color":"D876E3","default":false,"description":"This PR has been approved by the community. It's ready for a maintainer to consider merging it"},{"id":3166133948,"node_id":"MDU6TGFiZWwzMTY2MTMzOTQ4","url":"https://api.github.com/repos/bevyengine/bevy/labels/M-Migration-Guide","name":"M-Migration-Guide","color":"006B75","default":false,"description":"A breaking change to Bevy's public API that needs to be noted in a migration guide"},{"id":4102809496,"node_id":"LA_kwDODf6-U870i-eY","url":"https://api.github.com/repos/bevyengine/bevy/labels/P-Unsound","name":"P-Unsound","color":"FF7b00","default":false,"description":"A bug that results in undefined compiler behavior"},{"id":6899576022,"node_id":"LA_kwDODf6-U88AAAABmz8s1g","url":"https://api.github.com/repos/bevyengine/bevy/labels/D-Modest","name":"D-Modest","color":"008672","default":false,"description":"A \"normal\" level of difficulty; suitable for simple features or challenging fixes"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2025-02-05T20:08:34Z","updated_at":"2025-02-12T22:57:33Z","closed_at":"2025-02-12T22:57:32Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"draft":false,"repository":{"id":234798675,"node_id":"MDEwOlJlcG9zaXRvcnkyMzQ3OTg2NzU=","name":"bevy","full_name":"bevyengine/bevy","private":false,"owner":{"login":"bevyengine","id":60047606,"node_id":"MDEyOk9yZ2FuaXphdGlvbjYwMDQ3NjA2","avatar_url":"https://avatars.githubusercontent.com/u/60047606?v=4","gravatar_id":"","url":"https://api.github.com/users/bevyengine","html_url":"https://github.com/bevyengine","followers_url":"https://api.github.com/users/bevyengine/followers","following_url":"https://api.github.com/users/bevyengine/following{/other_user}","gists_url":"https://api.github.com/users/bevyengine/gists{/gist_id}","starred_url":"https://api.github.com/users/bevyengine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bevyengine/subscriptions","organizations_url":"https://api.github.com/users/bevyengine/orgs","repos_url":"https://api.github.com/users/bevyengine/repos","events_url":"https://api.github.com/users/bevyengine/events{/privacy}","received_events_url":"https://api.github.com/users/bevyengine/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/bevyengine/bevy","description":"A refreshingly simple data-driven game engine built in Rust","fork":false,"url":"https://api.github.com/repos/bevyengine/bevy","forks_url":"https://api.github.com/repos/bevyengine/bevy/forks","keys_url":"https://api.github.com/repos/bevyengine/bevy/keys{/key_id}","collaborators_url":"https://api.github.com/repos/bevyengine/bevy/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/bevyengine/bevy/teams","hooks_url":"https://api.github.com/repos/bevyengine/bevy/hooks","issue_events_url":"https://api.github.com/repos/bevyengine/bevy/issues/events{/number}","events_url":"https://api.github.com/repos/bevyengine/bevy/events","assignees_url":"https://api.github.com/repos/bevyengine/bevy/assignees{/user}","branches_url":"https://api.github.com/repos/bevyengine/bevy/branches{/branch}","tags_url":"https://api.github.com/repos/bevyengine/bevy/tags","blobs_url":"https://api.github.com/repos/bevyengine/bevy/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/bevyengine/bevy/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/bevyengine/bevy/git/refs{/sha}","trees_url":"https://api.github.com/repos/bevyengine/bevy/git/trees{/sha}","statuses_url":"https://api.github.com/repos/bevyengine/bevy/statuses/{sha}","languages_url":"https://api.github.com/repos/bevyengine/bevy/languages","stargazers_url":"https://api.github.com/repos/bevyengine/bevy/stargazers","contributors_url":"https://api.github.com/repos/bevyengine/bevy/contributors","subscribers_url":"https://api.github.com/repos/bevyengine/bevy/subscribers","subscription_url":"https://api.github.com/repos/bevyengine/bevy/subscription","commits_url":"https://api.github.com/repos/bevyengine/bevy/commits{/sha}","git_commits_url":"https://api.github.com/repos/bevyengine/bevy/git/commits{/sha}","comments_url":"https://api.github.com/repos/bevyengine/bevy/comments{/number}","issue_comment_url":"https://api.github.com/repos/bevyengine/bevy/issues/comments{/number}","contents_url":"https://api.github.com/repos/bevyengine/bevy/contents/{+path}","compare_url":"https://api.github.com/repos/bevyengine/bevy/compare/{base}...{head}","merges_url":"https://api.github.com/repos/bevyengine/bevy/merges","archive_url":"https://api.github.com/repos/bevyengine/bevy/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/bevyengine/bevy/downloads","issues_url":"https://api.github.com/repos/bevyengine/bevy/issues{/number}","pulls_url":"https://api.github.com/repos/bevyengine/bevy/pulls{/number}","milestones_url":"https://api.github.com/repos/bevyengine/bevy/milestones{/number}","notifications_url":"https://api.github.com/repos/bevyengine/bevy/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/bevyengine/bevy/labels{/name}","releases_url":"https://api.github.com/repos/bevyengine/bevy/releases{/id}","deployments_url":"https://api.github.com/repos/bevyengine/bevy/deployments","created_at":"2020-01-18T21:13:55Z","updated_at":"2025-11-10T00:30:24Z","pushed_at":"2025-11-09T20:05:46Z","git_url":"git://github.com/bevyengine/bevy.git","ssh_url":"git@github.com:bevyengine/bevy.git","clone_url":"https://github.com/bevyengine/bevy.git","svn_url":"https://github.com/bevyengine/bevy","homepage":"https://bevy.org","size":152673,"stargazers_count":42996,"watchers_count":42996,"language":"Rust","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":false,"has_pages":true,"has_discussions":true,"forks_count":4220,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":3116,"license":{"key":"apache-2.0","name":"Apache License 2.0","spdx_id":"Apache-2.0","url":"https://api.github.com/licenses/apache-2.0","node_id":"MDc6TGljZW5zZTI="},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["bevy","game-development","game-engine","gamedev","open-source","rust"],"visibility":"public","forks":4220,"open_issues":3116,"watchers":42996,"default_branch":"main","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"pull_request":{"url":"https://api.github.com/repos/bevyengine/bevy/pulls/17694","html_url":"https://github.com/bevyengine/bevy/pull/17694","diff_url":"https://github.com/bevyengine/bevy/pull/17694.diff","patch_url":"https://github.com/bevyengine/bevy/pull/17694.patch","merged_at":"2025-02-12T22:57:32Z"},"body":"# Objective\r\n\r\nFix unsoundness introduced by #15858.  `QueryLens::query()` would hand out a `Query` with the full `'w` lifetime, and the new `_inner` methods would let the results outlive the `Query`.  This could be used to create aliasing mutable references, like\r\n\r\n```rust\r\nfn bad<'w>(mut lens: QueryLens<'w, EntityMut>, entity: Entity) {\r\n    let one: EntityMut<'w> = lens.query().get_inner(entity).unwrap();\r\n    let two: EntityMut<'w> = lens.query().get_inner(entity).unwrap();\r\n    assert!(one.entity() == two.entity());\r\n}\r\n```\r\n\r\nFixes #17693 \r\n\r\n## Solution\r\n\r\nRestrict the `'world` lifetime in the `Query` returned by `QueryLens::query()` to `'_`, the lifetime of the borrow of the `QueryLens`.  \r\n\r\nThe model here is that `Query<'w, 's, D, F>` and `QueryLens<'w, D, F>` have permission to access their components for the lifetime `'w`.  So going from `&'a mut QueryLens<'w>` to `Query<'w, 'a>` would borrow the permission only for the `'a` lifetime, but incorrectly give it out for the full `'w` lifetime.  \r\n\r\nTo handle any cases where users were calling `get_inner()` or `iter_inner()` on the `Query` and expecting the full `'w` lifetime, we introduce a new `QueryLens::query_inner()` method.  This is only valid for `ReadOnlyQueryData`, so it may safely hand out a copy of the permission for the full `'w` lifetime.  Since `get_inner()` and `iter_inner()` were only valid on `ReadOnlyQueryData` prior to #15858, that should cover any uses that relied on the longer lifetime.  \r\n\r\n## Migration Guide\r\n\r\nUsers of `QueryLens::query()` who were calling `get_inner()` or `iter_inner()` will need to replace the call with `QueryLens::query_inner()`.  ","reactions":{"url":"https://api.github.com/repos/bevyengine/bevy/issues/17694/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/bevyengine/bevy/issues/17694/timeline","performed_via_github_app":null,"state_reason":null}},"event":"cross-referenced"},{"url":"https://api.github.com/repos/bevyengine/bevy/issues/comments/2637959831","html_url":"https://github.com/bevyengine/bevy/issues/17693#issuecomment-2637959831","issue_url":"https://api.github.com/repos/bevyengine/bevy/issues/17693","id":2637959831,"node_id":"IC_kwDODf6-U86dPBKX","user":{"login":"Victoronz","id":59878206,"node_id":"MDQ6VXNlcjU5ODc4MjA2","avatar_url":"https://avatars.githubusercontent.com/u/59878206?v=4","gravatar_id":"","url":"https://api.github.com/users/Victoronz","html_url":"https://github.com/Victoronz","followers_url":"https://api.github.com/users/Victoronz/followers","following_url":"https://api.github.com/users/Victoronz/following{/other_user}","gists_url":"https://api.github.com/users/Victoronz/gists{/gist_id}","starred_url":"https://api.github.com/users/Victoronz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Victoronz/subscriptions","organizations_url":"https://api.github.com/users/Victoronz/orgs","repos_url":"https://api.github.com/users/Victoronz/repos","events_url":"https://api.github.com/users/Victoronz/events{/privacy}","received_events_url":"https://api.github.com/users/Victoronz/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2025-02-05T20:30:42Z","updated_at":"2025-02-05T20:33:16Z","body":"> I believe the semantics for `Query` should be that `Query<'w, 's, D, F>` comes with permission to access the components matched by `self.state.component_access` for the lifetime `'w`. That's what the executor gives the parameter when we schedule a system, and that's enough to justify the implementations of its methods both before and after [#15858](https://github.com/bevyengine/bevy/pull/15858).\n> \n> I would expect the same thing for `QueryLens<'w, D, F>`.\n> \n> Do those rules seem reasonable? If not, what _should_ the rules be?\n> \n> Under those rules, `QueryLens::query()` is unsound, since it hands out permission for the full `'w` lifetime, but then claims it has it again when the `'_` lifetime ends. The fix is to hand out permission only for `'_`.\n\nThis captures why this all is so confusing!\nAs I understand:\n`&'a Query<'w, 's, D, F>` introduces the requirement that both `'w` and `'s` live for at least as long as `'a`.\nAny method of query that returns something containing a `'_` lifetime constrains that return type to `'a`.\nThe `QueryLens` return types do properly contain `'_`, meaning that they propagate the `'a` constraint.\nIf we now return a `Query` from that `QueryLens`, we now introduce `'b` from `&'b QueryLens`, and this time `'s` inherits that constraint.\nAs long as the constraints are propagated via the self lifetimes, we remain sound!\nHowever, as soon as we try to skirt it, we need to be careful.\n\n`Query<'w, 's, D, F>` does not exactly come with the permission to access the components it matches for the lifetime of `'w`. It is both  `'w` and `'s`.\nAdditionally, **'w does not, and must not, semantically, only mean the original `&'a World`**, instead, it can be instantiated with multiple constraints, only one of which should have been derived from `&'a World` at some point.\n\nNote that in some items, `'a` is defined as a separate lifetime, and in some places, it is defined as `&'w Query<'w, 's, D, F>` which is more restrictive than need be. It means that if `'s` is shorter than `'w`, like in a `QueryLens`-derived `Query`, those impls are no longer applicable. Hierarchy code contained such overly restrictive impls for example.\n\nIn general, we have the inconsistent naming scheme of `'w`, `'world`, `'a`, ... today because we intuitively want to write `'w` to mean \"**the** world borrow lifetime\" when in actuality it should be \"**a** lifetime originally derived from a world borrow\".\n\n\n","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/bevyengine/bevy/issues/comments/2637959831/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"Victoronz","id":59878206,"node_id":"MDQ6VXNlcjU5ODc4MjA2","avatar_url":"https://avatars.githubusercontent.com/u/59878206?v=4","gravatar_id":"","url":"https://api.github.com/users/Victoronz","html_url":"https://github.com/Victoronz","followers_url":"https://api.github.com/users/Victoronz/followers","following_url":"https://api.github.com/users/Victoronz/following{/other_user}","gists_url":"https://api.github.com/users/Victoronz/gists{/gist_id}","starred_url":"https://api.github.com/users/Victoronz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Victoronz/subscriptions","organizations_url":"https://api.github.com/users/Victoronz/orgs","repos_url":"https://api.github.com/users/Victoronz/repos","events_url":"https://api.github.com/users/Victoronz/events{/privacy}","received_events_url":"https://api.github.com/users/Victoronz/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/bevyengine/bevy/issues/comments/2638100341","html_url":"https://github.com/bevyengine/bevy/issues/17693#issuecomment-2638100341","issue_url":"https://api.github.com/repos/bevyengine/bevy/issues/17693","id":2638100341,"node_id":"IC_kwDODf6-U86dPjd1","user":{"login":"chescock","id":8494645,"node_id":"MDQ6VXNlcjg0OTQ2NDU=","avatar_url":"https://avatars.githubusercontent.com/u/8494645?v=4","gravatar_id":"","url":"https://api.github.com/users/chescock","html_url":"https://github.com/chescock","followers_url":"https://api.github.com/users/chescock/followers","following_url":"https://api.github.com/users/chescock/following{/other_user}","gists_url":"https://api.github.com/users/chescock/gists{/gist_id}","starred_url":"https://api.github.com/users/chescock/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chescock/subscriptions","organizations_url":"https://api.github.com/users/chescock/orgs","repos_url":"https://api.github.com/users/chescock/repos","events_url":"https://api.github.com/users/chescock/events{/privacy}","received_events_url":"https://api.github.com/users/chescock/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2025-02-05T21:51:02Z","updated_at":"2025-02-05T21:51:02Z","body":"I think we might be talking past each other somehow?  I understand the language-level rules, and that lifetime parameters can be substituted with different arguments.  \n\nHere we're building safe abstractions with unsafe implementations, so we need to define our own safety requirements.  That is, somewhere in `<&T as QueryData>::fetch()` we get a raw pointer from storage and cast it to an `&T`.  We need a proof that this doesn't cause aliasing violations.  To construct that proof, we want to define safety requirements for individual pieces so that we can check each step locally.  \n\nDo you agree that that's a good way to construct proofs for unsafe operations?  \n\nI'm proposing that the safety requirements for `struct Query<'world, 'state, D: QueryData, F: QueryFilter = ()>` be that it have access as defined by `state.component_access` that is valid for the lifetime `'world`, and similarly for `struct QueryLens<'w, Q: QueryData, F: QueryFilter = ()>` and `'w`.  \n\nI am not including the `'state` lifetime in any way, because it is only used for safe borrows of `QueryState` and so can be checked by the compiler.  \n\nDo you think that is a reasonable safety requirement for those types?  \n\nThe signature of `QueryLens::query()` is `fn(&'a mut QueryLens<'w, Q, F>) -> Query<'w, 'a, Q, F>`.  Under my proposal, the `QueryLens` there has some access for lifetime `'w`, and we are *borrowing* that access exclusively for some shorter lifetime `'a`.  But then we hand out a `Query` that has that access for the full lifetime `'w`.  That's unsound, because the original `QueryLens` still holds that access after the `'a` lifetime ends.  It's essentially doing `fn(&'a mut &'w mut T) -> &'w mut T`.  \n\nDo you agree that `QueryLens::query()` is unsound under my proposal?  ","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/bevyengine/bevy/issues/comments/2638100341/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"chescock","id":8494645,"node_id":"MDQ6VXNlcjg0OTQ2NDU=","avatar_url":"https://avatars.githubusercontent.com/u/8494645?v=4","gravatar_id":"","url":"https://api.github.com/users/chescock","html_url":"https://github.com/chescock","followers_url":"https://api.github.com/users/chescock/followers","following_url":"https://api.github.com/users/chescock/following{/other_user}","gists_url":"https://api.github.com/users/chescock/gists{/gist_id}","starred_url":"https://api.github.com/users/chescock/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chescock/subscriptions","organizations_url":"https://api.github.com/users/chescock/orgs","repos_url":"https://api.github.com/users/chescock/repos","events_url":"https://api.github.com/users/chescock/events{/privacy}","received_events_url":"https://api.github.com/users/chescock/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/bevyengine/bevy/issues/comments/2643324027","html_url":"https://github.com/bevyengine/bevy/issues/17693#issuecomment-2643324027","issue_url":"https://api.github.com/repos/bevyengine/bevy/issues/17693","id":2643324027,"node_id":"IC_kwDODf6-U86djex7","user":{"login":"Victoronz","id":59878206,"node_id":"MDQ6VXNlcjU5ODc4MjA2","avatar_url":"https://avatars.githubusercontent.com/u/59878206?v=4","gravatar_id":"","url":"https://api.github.com/users/Victoronz","html_url":"https://github.com/Victoronz","followers_url":"https://api.github.com/users/Victoronz/followers","following_url":"https://api.github.com/users/Victoronz/following{/other_user}","gists_url":"https://api.github.com/users/Victoronz/gists{/gist_id}","starred_url":"https://api.github.com/users/Victoronz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Victoronz/subscriptions","organizations_url":"https://api.github.com/users/Victoronz/orgs","repos_url":"https://api.github.com/users/Victoronz/repos","events_url":"https://api.github.com/users/Victoronz/events{/privacy}","received_events_url":"https://api.github.com/users/Victoronz/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2025-02-07T15:56:34Z","updated_at":"2025-02-07T15:56:34Z","body":">Here we're building safe abstractions with unsafe implementations, so we need to define our own safety requirements. That is, somewhere in <&T as QueryData>::fetch() we get a raw pointer from storage and cast it to an &T. We need a proof that this doesn't cause aliasing violations. To construct that proof, we want to define safety requirements for individual pieces so that we can check each step locally.\n>\n>Do you agree that that's a good way to construct proofs for unsafe operations?\n\nI think we agree? In the sense that we need to determine each use of unsafe to be sound for safe abstraction to be sound in turn.\n\n>I'm proposing that the safety requirements for struct Query<'world, 'state, D: QueryData, F: QueryFilter = ()> be that it have access as defined by state.component_access that is valid for the lifetime 'world, and similarly for struct QueryLens<'w, Q: QueryData, F: QueryFilter = ()> and 'w.\n>\n>I am not including the 'state lifetime in any way, because it is only used for safe borrows of QueryState and so can be checked by the compiler.\n>\n>Do you think that is a reasonable safety requirement for those types?\n\nHmm, I don't have full overview over the access infrastructure in the engine, so I am a bit cautious about this, I would definitely want other eyes to confirm that `'state` isn't relied upon elsewhere, or will be in the future.\n\n>The signature of QueryLens::query() is fn(&'a mut QueryLens<'w, Q, F>) -> Query<'w, 'a, Q, F>. Under my proposal, the QueryLens there has some access for lifetime 'w, and we are borrowing that access exclusively for some shorter lifetime 'a. But then we hand out a Query that has that access for the full lifetime 'w. That's unsound, because the original QueryLens still holds that access after the 'a lifetime ends. It's essentially doing fn(&'a mut &'w mut T) -> &'w mut T.\n>\n>Do you agree that QueryLens::query() is unsound under my proposal?\n\nI agree that it is unsound. If `'w` is the only constraint in the end, then that is what we have to limit when we hand out borrows.","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/bevyengine/bevy/issues/comments/2643324027/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"Victoronz","id":59878206,"node_id":"MDQ6VXNlcjU5ODc4MjA2","avatar_url":"https://avatars.githubusercontent.com/u/59878206?v=4","gravatar_id":"","url":"https://api.github.com/users/Victoronz","html_url":"https://github.com/Victoronz","followers_url":"https://api.github.com/users/Victoronz/followers","following_url":"https://api.github.com/users/Victoronz/following{/other_user}","gists_url":"https://api.github.com/users/Victoronz/gists{/gist_id}","starred_url":"https://api.github.com/users/Victoronz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Victoronz/subscriptions","organizations_url":"https://api.github.com/users/Victoronz/orgs","repos_url":"https://api.github.com/users/Victoronz/repos","events_url":"https://api.github.com/users/Victoronz/events{/privacy}","received_events_url":"https://api.github.com/users/Victoronz/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/bevyengine/bevy/issues/comments/2644041639","html_url":"https://github.com/bevyengine/bevy/issues/17693#issuecomment-2644041639","issue_url":"https://api.github.com/repos/bevyengine/bevy/issues/17693","id":2644041639,"node_id":"IC_kwDODf6-U86dmN-n","user":{"login":"chescock","id":8494645,"node_id":"MDQ6VXNlcjg0OTQ2NDU=","avatar_url":"https://avatars.githubusercontent.com/u/8494645?v=4","gravatar_id":"","url":"https://api.github.com/users/chescock","html_url":"https://github.com/chescock","followers_url":"https://api.github.com/users/chescock/followers","following_url":"https://api.github.com/users/chescock/following{/other_user}","gists_url":"https://api.github.com/users/chescock/gists{/gist_id}","starred_url":"https://api.github.com/users/chescock/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chescock/subscriptions","organizations_url":"https://api.github.com/users/chescock/orgs","repos_url":"https://api.github.com/users/chescock/repos","events_url":"https://api.github.com/users/chescock/events{/privacy}","received_events_url":"https://api.github.com/users/chescock/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2025-02-07T20:16:14Z","updated_at":"2025-02-07T20:16:14Z","body":"> I think we agree?\n\nOh, good!  It must just have been me failing to understand something, then.  Sorry!  \n\n> Hmm, I don't have full overview over the access infrastructure in the engine, so I am a bit cautious about this, I would definitely want other eyes to confirm that `'state` isn't relied upon elsewhere, or will be in the future.\n\nYup, agreed that more eyes are good!  I already missed that `QueryLens` didn't work the way I thought, so I've almost certainly missed something else.  \n\nIt might also help to document the safety rules a little better.  I'm not sure where to put them, though.  The obvious place is on the `Query` type itself, but that's one of the first types a user will encounter, so I don't think we want a lot of scary implementation details about internal engine safety requirements on the front page of its documentation.  Maybe `Query::new()`, which is `pub(crate)`?  ","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/bevyengine/bevy/issues/comments/2644041639/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"chescock","id":8494645,"node_id":"MDQ6VXNlcjg0OTQ2NDU=","avatar_url":"https://avatars.githubusercontent.com/u/8494645?v=4","gravatar_id":"","url":"https://api.github.com/users/chescock","html_url":"https://github.com/chescock","followers_url":"https://api.github.com/users/chescock/followers","following_url":"https://api.github.com/users/chescock/following{/other_user}","gists_url":"https://api.github.com/users/chescock/gists{/gist_id}","starred_url":"https://api.github.com/users/chescock/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chescock/subscriptions","organizations_url":"https://api.github.com/users/chescock/orgs","repos_url":"https://api.github.com/users/chescock/repos","events_url":"https://api.github.com/users/chescock/events{/privacy}","received_events_url":"https://api.github.com/users/chescock/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":16288136599,"node_id":"REFE_lADODf6-U86o5z6jzwAAAAPK2T2X","url":"https://api.github.com/repos/bevyengine/bevy/issues/events/16288136599","actor":{"login":"github-merge-queue[bot]","id":118344674,"node_id":"BOT_kgDOBw3L4g","avatar_url":"https://avatars.githubusercontent.com/u/9919?v=4","gravatar_id":"","url":"https://api.github.com/users/github-merge-queue%5Bbot%5D","html_url":"https://github.com/apps/github-merge-queue","followers_url":"https://api.github.com/users/github-merge-queue%5Bbot%5D/followers","following_url":"https://api.github.com/users/github-merge-queue%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/github-merge-queue%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/github-merge-queue%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/github-merge-queue%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/github-merge-queue%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/github-merge-queue%5Bbot%5D/repos","events_url":"https://api.github.com/users/github-merge-queue%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/github-merge-queue%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"62c1812e72dc2367c8d537d8224f1d55eae2535f","commit_url":"https://api.github.com/repos/bevyengine/bevy/commits/62c1812e72dc2367c8d537d8224f1d55eae2535f","created_at":"2025-02-12T22:57:32Z","performed_via_github_app":null},{"id":16288136754,"node_id":"CE_lADODf6-U86o5z6jzwAAAAPK2T4y","url":"https://api.github.com/repos/bevyengine/bevy/issues/events/16288136754","actor":{"login":"alice-i-cecile","id":3579909,"node_id":"MDQ6VXNlcjM1Nzk5MDk=","avatar_url":"https://avatars.githubusercontent.com/u/3579909?v=4","gravatar_id":"","url":"https://api.github.com/users/alice-i-cecile","html_url":"https://github.com/alice-i-cecile","followers_url":"https://api.github.com/users/alice-i-cecile/followers","following_url":"https://api.github.com/users/alice-i-cecile/following{/other_user}","gists_url":"https://api.github.com/users/alice-i-cecile/gists{/gist_id}","starred_url":"https://api.github.com/users/alice-i-cecile/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alice-i-cecile/subscriptions","organizations_url":"https://api.github.com/users/alice-i-cecile/orgs","repos_url":"https://api.github.com/users/alice-i-cecile/repos","events_url":"https://api.github.com/users/alice-i-cecile/events{/privacy}","received_events_url":"https://api.github.com/users/alice-i-cecile/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"closed","commit_id":null,"commit_url":null,"created_at":"2025-02-12T22:57:34Z","state_reason":null,"performed_via_github_app":null}]