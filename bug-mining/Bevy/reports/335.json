{"url":"https://api.github.com/repos/bevyengine/bevy/issues/14679","repository_url":"https://api.github.com/repos/bevyengine/bevy","labels_url":"https://api.github.com/repos/bevyengine/bevy/issues/14679/labels{/name}","comments_url":"https://api.github.com/repos/bevyengine/bevy/issues/14679/comments","events_url":"https://api.github.com/repos/bevyengine/bevy/issues/14679/events","html_url":"https://github.com/bevyengine/bevy/issues/14679","id":2458022006,"node_id":"I_kwDODf6-U86SgnB2","number":14679,"title":"Poor performance with Query::iter_combinations_mut compared to a similar algorithm in a Nannou project","user":{"login":"polaris64","id":616310,"node_id":"MDQ6VXNlcjYxNjMxMA==","avatar_url":"https://avatars.githubusercontent.com/u/616310?v=4","gravatar_id":"","url":"https://api.github.com/users/polaris64","html_url":"https://github.com/polaris64","followers_url":"https://api.github.com/users/polaris64/followers","following_url":"https://api.github.com/users/polaris64/following{/other_user}","gists_url":"https://api.github.com/users/polaris64/gists{/gist_id}","starred_url":"https://api.github.com/users/polaris64/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/polaris64/subscriptions","organizations_url":"https://api.github.com/users/polaris64/orgs","repos_url":"https://api.github.com/users/polaris64/repos","events_url":"https://api.github.com/users/polaris64/events{/privacy}","received_events_url":"https://api.github.com/users/polaris64/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":2197761682,"node_id":"MDU6TGFiZWwyMTk3NzYxNjgy","url":"https://api.github.com/repos/bevyengine/bevy/labels/A-ECS","name":"A-ECS","color":"c6a751","default":false,"description":"Entities, components, systems, and events"},{"id":2272098452,"node_id":"MDU6TGFiZWwyMjcyMDk4NDUy","url":"https://api.github.com/repos/bevyengine/bevy/labels/C-Performance","name":"C-Performance","color":"B8B8B8","default":false,"description":"A change motivated by improving speed, memory usage or compile times"},{"id":3166126807,"node_id":"MDU6TGFiZWwzMTY2MTI2ODA3","url":"https://api.github.com/repos/bevyengine/bevy/labels/S-Needs-Investigation","name":"S-Needs-Investigation","color":"D876E1","default":false,"description":"This issue requires detective work to figure out what's going wrong"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2024-08-09T14:12:51Z","updated_at":"2024-08-09T18:00:40Z","closed_at":"2024-08-09T18:00:40Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"I'm currently experiencing some poor performance in Bevy, specifically with `Query::iter_combinations_mut`. I'm aware that this is quite a costly operation however I am implementing the same algorithm in another project using Nannou and with the same number of combinations it is much faster.\r\n\r\nI'm quite new to Bevy and Nannou so I decided to try implementing one of my projects (Verlet Physics Playground, <https://codeberg.org/polaris64/verlet-physics-playground>) in Nannou first, then a game engine. For the game engine I chose Bevy.\r\n\r\nThe specific performance issue I have experienced is when handling collisions between objects. In the Nannou version, this algorithm is implemented here: <https://codeberg.org/polaris64/verlet-physics-playground/src/commit/e631f4b43e758872f753383d358f0f1322c57ca4/src/main.rs#L147>. With 1,000 objects I count 499,500 (999th triangular number) collision checks with this algorithm, but the frame rate is high (well over 60fps). In Bevy, I'm handling the collisions like this: -\r\n\r\n```rust\r\n  fn handle_verlet_collisions(\r\n      mut query: Query<(&mut Transform, &VerletProperties)>,\r\n  ) {\r\n      let mut combinations = query.iter_combinations_mut();\r\n      while let Some([\r\n          (\r\n              mut tr1,\r\n              pr1\r\n          ),\r\n          (\r\n              mut tr2,\r\n              pr2\r\n          )\r\n      ]) = combinations.fetch_next() {\r\n          let mut norm = tr2.translation - tr1.translation;\r\n          let dist = norm.length();\r\n          if dist < pr1.radius + pr2.radius {\r\n              let overlap = (pr1.radius + pr2.radius) - dist;\r\n              norm = norm.normalize();\r\n              if !pr1.pinned {\r\n                  tr1.translation.x -= norm.x * overlap * 0.5f32;\r\n                  tr1.translation.y -= norm.y * overlap * 0.5f32;\r\n              }\r\n              if !pr2.pinned {\r\n                  tr2.translation.x += norm.x * overlap * 0.5f32;\r\n                  tr2.translation.y += norm.y * overlap * 0.5f32;\r\n              }\r\n          }\r\n      }\r\n  }\r\n```\r\n\r\nCounting the number of checks per update again shows 499,500, however when run with Bevy the frame rate is extremely low, probably in the range of around 1-2fps. Removing this system causes the frame rate to become very high again, showing that it's not a rendering issue, just an issue with this collision check system.\r\n\r\nI have implemented the advice given about Bevy performance optimisation and I have tried running the project in both `dev` and `release` profiles, however the performance never gets better than around 1-2fps with 1,000 objects.\r\n\r\nAs I say, I know that iterating combinations is expensive (499,500 iterations per update in this case), however I'm not sure why the same number of checks in Bevy are so much slower than those in my Nannou project.\r\n\r\n\r\n## Bevy version\r\n\r\n0.14.1\r\n\r\n## \\[Optional\\] Relevant system information\r\n\r\n`cargo 1.80.0 (376290515 2024-07-16)`\r\n\r\n`AdapterInfo { name: \"NVIDIA GeForce RTX 2060\", vendor: 4318, device: 7957, device_type: DiscreteGpu, driver: \"NVIDIA\", driver_info: \"555.58.02\", backend: Vulkan }`\r\n\r\n`Linux tikal 6.10.3-arch1-2 #1 SMP PREEMPT_DYNAMIC Tue, 06 Aug 2024 07:21:19 +0000 x86_64 GNU/Linux`\r\n","closed_by":{"login":"alice-i-cecile","id":3579909,"node_id":"MDQ6VXNlcjM1Nzk5MDk=","avatar_url":"https://avatars.githubusercontent.com/u/3579909?v=4","gravatar_id":"","url":"https://api.github.com/users/alice-i-cecile","html_url":"https://github.com/alice-i-cecile","followers_url":"https://api.github.com/users/alice-i-cecile/followers","following_url":"https://api.github.com/users/alice-i-cecile/following{/other_user}","gists_url":"https://api.github.com/users/alice-i-cecile/gists{/gist_id}","starred_url":"https://api.github.com/users/alice-i-cecile/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alice-i-cecile/subscriptions","organizations_url":"https://api.github.com/users/alice-i-cecile/orgs","repos_url":"https://api.github.com/users/alice-i-cecile/repos","events_url":"https://api.github.com/users/alice-i-cecile/events{/privacy}","received_events_url":"https://api.github.com/users/alice-i-cecile/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/bevyengine/bevy/issues/14679/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/bevyengine/bevy/issues/14679/timeline","performed_via_github_app":null,"state_reason":"completed"}