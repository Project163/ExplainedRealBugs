{"url":"https://api.github.com/repos/bevyengine/bevy/issues/17828","repository_url":"https://api.github.com/repos/bevyengine/bevy","labels_url":"https://api.github.com/repos/bevyengine/bevy/issues/17828/labels{/name}","comments_url":"https://api.github.com/repos/bevyengine/bevy/issues/17828/comments","events_url":"https://api.github.com/repos/bevyengine/bevy/issues/17828/events","html_url":"https://github.com/bevyengine/bevy/issues/17828","id":2849296210,"node_id":"I_kwDODf6-U86p1M9S","number":17828,"title":"Unflushed commands before exclusive system when configured with `*_ignore_deferred`","user":{"login":"urben1680","id":55257931,"node_id":"MDQ6VXNlcjU1MjU3OTMx","avatar_url":"https://avatars.githubusercontent.com/u/55257931?v=4","gravatar_id":"","url":"https://api.github.com/users/urben1680","html_url":"https://github.com/urben1680","followers_url":"https://api.github.com/users/urben1680/followers","following_url":"https://api.github.com/users/urben1680/following{/other_user}","gists_url":"https://api.github.com/users/urben1680/gists{/gist_id}","starred_url":"https://api.github.com/users/urben1680/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/urben1680/subscriptions","organizations_url":"https://api.github.com/users/urben1680/orgs","repos_url":"https://api.github.com/users/urben1680/repos","events_url":"https://api.github.com/users/urben1680/events{/privacy}","received_events_url":"https://api.github.com/users/urben1680/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1795619323,"node_id":"MDU6TGFiZWwxNzk1NjE5MzIz","url":"https://api.github.com/repos/bevyengine/bevy/labels/C-Bug","name":"C-Bug","color":"d73a4a","default":false,"description":"An unexpected or incorrect behavior"},{"id":2197761682,"node_id":"MDU6TGFiZWwyMTk3NzYxNjgy","url":"https://api.github.com/repos/bevyengine/bevy/labels/A-ECS","name":"A-ECS","color":"c6a751","default":false,"description":"Entities, components, systems, and events"},{"id":3166126807,"node_id":"MDU6TGFiZWwzMTY2MTI2ODA3","url":"https://api.github.com/repos/bevyengine/bevy/labels/S-Needs-Investigation","name":"S-Needs-Investigation","color":"D876E1","default":false,"description":"This issue requires detective work to figure out what's going wrong"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2025-02-12T20:35:29Z","updated_at":"2025-02-26T20:56:59Z","closed_at":"2025-02-26T20:56:59Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## Bevy version\n\nI saw this behavior at around 0.14 I think but only now got around making a minimal reproducible example on `main`, or at least a fairly recent commit behind `main`.\n\n## What you did\n\nI ran this code:\n\n```rs\nuse bevy::prelude::*;\n\n#[derive(Resource)]\nstruct InsertTest;\n\nfn insert_system(mut commands: Commands) {\n    commands.insert_resource(InsertTest);\n}\nfn assert_system(world: &mut World) {\n    assert!(world.contains_resource::<InsertTest>())\n}\n\nfn main() {\n    App::new()\n        .add_systems(\n            Update, \n            (insert_system, assert_system).chain_ignore_deferred()\n        )\n        .update();\n}\n```\n\n## What went wrong\n\n`assert_system` is an exclusive system, therefore it is expected that the command in `insert_system` is flushed before it runs. The assertion should not fail but it does.\n\n## Additional information\n\nI did some extensive testing and noticed that this bug occurs no matter how I do this configuration as long I make use of the `_ignore_deferred` variants. The following table lists these configurations and gives each a number because that matters for another observation I elaborate further down.\n\n| inserting config by | asserting config by | config | test |\n| - | - | - | - | \n| system | system | `after_ignore_deferred` | ‚ùå `1` |\n| system | system | `before_ignore_deferred` | ‚ùå `2` |\n| system | system | `chain_ignore_deferred` | ‚ùå `3` |\n| system | set | `after_ignore_deferred` | ‚ùå `4` |\n| system | set | `before_ignore_deferred` | ‚ùå `5` |\n| set | system | `after_ignore_deferred` | ‚ùå `6` |\n| set | system | `before_ignore_deferred` | ‚ùå `7` |\n| set | set | `after_ignore_deferred` | ‚ùå `8` |\n| set | set | `before_ignore_deferred` | ‚ùå `9` |\n| set | set | `chain_ignore_deferred` | ‚ùå `10` |\n\nFor example the configuration... \n```rs\n(insert_system, assert_system).chain_ignore_deferred()\n```\n... is the third row in the table, where \"inserting config by\" with \"system\" means that the first element in the chain tuple is the system, and \"asserting config by\" with \"system\" means that the second element in the tuple is also the system itself.\n\n\"set\" means if the argument is a set, so a `configure_sets` with this configuration... \n```rs\n(SetWithInsertSystem, SetWithAssertSystem).chain_ignore_deferred()\n```\n... is the last row.\n\n`chain` cannot mix systems and sets, but `before` and `after` can mix, therefore these have more rows.\n\n**General observations regarding the two system:**\n- the tests do not fail if `insert_system` is exclusive\n- the tests do not fail if `insert_system` is exclusive and `assert_system` is not exclusive\n\n### Third system affecting the outcome of the tests\n\nNow I am adding a third, empty system and order them after the two above. I observed that this results in some test going green suddenly.\n\n```rs\nfn third() {}\n```\n\n| insert-assert config by | third config by | config | ‚úÖ fixes the failing test of ... |\n| - | - | - | - | \n| each system | system | `after` | `1` ` ` `3` `4` ` ` ` ` `7` `8` `9` `10` |\n| config tuple | system | `before` | `1` ` ` `3` `4` ` ` ` ` `7` `8` `9` `10`  |\n| config tuple | system | `chain` | ` ` ` ` ` ` `4` ` ` ` ` `7` `8` `9` `10` |\n| each system | set | `after` |`1` `2` `3` ` ` `5` `6` ` ` `8` `9` `10` |\n| config tuple | set | `before` | `1` ` ` `3` `4` ` ` ` ` `7` `8` `9` `10` |\n| set | system | `after` | `1` `2` `3` `4` `5` ` ` `7` `8` `9` `10` |\n| set | system | `before` | `1` `2` `3` ` ` `5` `6` ` ` ` ` ` ` `  ` |\n| set | set | `after`| `1` `2` `3` ` ` `5` `6` ` ` ` ` ` ` `  ` |\n| set | set | `before` | `1` `2` `3` ` ` `5` `6` ` ` ` ` ` ` `  ` |\n| set | set | `chain`| `1` `2` `3` ` ` `5` `6` ` ` ` ` ` ` `  ` |\n\nFor example this is the first row with `3`...\n```rs\nfn main() {\n    App::new()\n        .add_systems(\n            Update, \n            (\n                (insert_system, assert_system).chain_ignore_deferred(),\n                third.after(insert_system).after(assert_system)\n            )\n        )\n        .update();\n}\n```\n... and this the second row with `3` ...\n```rs\nfn main() {\n    App::new()\n        .add_systems(\n            Update, \n            (\n                (insert_system, assert_system)\n                    .chain_ignore_deferred().before(third),\n                third\n            )\n        )\n        .update();\n}\n```\n... which both no longer fail.\n\n**General observations regarding the third system:**\n- it does not matter if `third` is exclusive or not\n- If `third` is configured with `_ignore_deferred` variants, it does not affect the results of the first tests\n- If `third` is put before the two, not after, it does not affect the result of the first tests\n\n### Test file\n\nI generated the tests with [this file](https://gist.github.com/urben1680/f6b323b9e70e1f9c9375123990de31b2) which also tests many other combinations that do not fail. It might come useful for testing fixes for this issue. Sorry if it looks horribly, that is how I generate tests. ü´£ Also worth noting that I double-checked that like 5 times but mistakes may only come up with a sixth time. I am just comfortable enough to list the results.\n\n","closed_by":{"login":"alice-i-cecile","id":3579909,"node_id":"MDQ6VXNlcjM1Nzk5MDk=","avatar_url":"https://avatars.githubusercontent.com/u/3579909?v=4","gravatar_id":"","url":"https://api.github.com/users/alice-i-cecile","html_url":"https://github.com/alice-i-cecile","followers_url":"https://api.github.com/users/alice-i-cecile/followers","following_url":"https://api.github.com/users/alice-i-cecile/following{/other_user}","gists_url":"https://api.github.com/users/alice-i-cecile/gists{/gist_id}","starred_url":"https://api.github.com/users/alice-i-cecile/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alice-i-cecile/subscriptions","organizations_url":"https://api.github.com/users/alice-i-cecile/orgs","repos_url":"https://api.github.com/users/alice-i-cecile/repos","events_url":"https://api.github.com/users/alice-i-cecile/events{/privacy}","received_events_url":"https://api.github.com/users/alice-i-cecile/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/bevyengine/bevy/issues/17828/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/bevyengine/bevy/issues/17828/timeline","performed_via_github_app":null,"state_reason":"completed"}