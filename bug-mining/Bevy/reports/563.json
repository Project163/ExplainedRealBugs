{"url":"https://api.github.com/repos/bevyengine/bevy/issues/16208","repository_url":"https://api.github.com/repos/bevyengine/bevy","labels_url":"https://api.github.com/repos/bevyengine/bevy/issues/16208/labels{/name}","comments_url":"https://api.github.com/repos/bevyengine/bevy/issues/16208/comments","events_url":"https://api.github.com/repos/bevyengine/bevy/issues/16208/events","html_url":"https://github.com/bevyengine/bevy/issues/16208","id":2629830522,"node_id":"I_kwDODf6-U86cwAd6","number":16208,"title":"Allow certain components to be marked immutable","user":{"login":"nakedible","id":445682,"node_id":"MDQ6VXNlcjQ0NTY4Mg==","avatar_url":"https://avatars.githubusercontent.com/u/445682?v=4","gravatar_id":"","url":"https://api.github.com/users/nakedible","html_url":"https://github.com/nakedible","followers_url":"https://api.github.com/users/nakedible/followers","following_url":"https://api.github.com/users/nakedible/following{/other_user}","gists_url":"https://api.github.com/users/nakedible/gists{/gist_id}","starred_url":"https://api.github.com/users/nakedible/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nakedible/subscriptions","organizations_url":"https://api.github.com/users/nakedible/orgs","repos_url":"https://api.github.com/users/nakedible/repos","events_url":"https://api.github.com/users/nakedible/events{/privacy}","received_events_url":"https://api.github.com/users/nakedible/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1795619326,"node_id":"MDU6TGFiZWwxNzk1NjE5MzI2","url":"https://api.github.com/repos/bevyengine/bevy/labels/C-Feature","name":"C-Feature","color":"b8b8b8","default":false,"description":"A new feature, making something new possible"},{"id":2197761682,"node_id":"MDU6TGFiZWwyMTk3NzYxNjgy","url":"https://api.github.com/repos/bevyengine/bevy/labels/A-ECS","name":"A-ECS","color":"c6a751","default":false,"description":"Entities, components, systems, and events"},{"id":3166152189,"node_id":"MDU6TGFiZWwzMTY2MTUyMTg5","url":"https://api.github.com/repos/bevyengine/bevy/labels/S-Needs-Design","name":"S-Needs-Design","color":"D876E3","default":false,"description":"This issue requires design work to think about how it would best be accomplished"},{"id":6899576022,"node_id":"LA_kwDODf6-U88AAAABmz8s1g","url":"https://api.github.com/repos/bevyengine/bevy/labels/D-Modest","name":"D-Modest","color":"008672","default":false,"description":"A \"normal\" level of difficulty; suitable for simple features or challenging fixes"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2024-11-01T20:36:30Z","updated_at":"2024-12-05T14:46:54Z","closed_at":"2024-12-05T14:46:54Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## What problem does this solve or what need does it fill?\n\nThere are needs to enforce invariants, to build indexes or otherwise keep things consistent in the ECS between multiple entities or between multiple components in a single entity. The new \"component hooks\" system goes a long way towards making it easy to keep things in sync, as they can be triggered on component addition, removal and replace.\n\nHowever, the hooks system does not catch mutation currently, and catching mutation has a lot of difficult problems to solve if it needs to be synchronously and with every way of mutating a component. Even if all the fields inside a component are marked private, that doesn't prevent the user from assigning a new instance of that component to it, overwriting the data for the old component - and no hooks will be fired, only asynchronous change events. This means that it is currently impossible to use hooks to maintain an invariant if the user mutates components directly.\n\n## What solution would you like?\n\nThere could be a flag on components that marks the component immutable. When set, it would mean that no API will return mutable references to the component, making it impossible to mutate the values in the component. This doesn't mean that there would be any change in how `insert`, `remove`, `take` etc. would work, so it would still be fully permitted to remove the component, or add a new one, or replace an existing with a new one. The current hooks system will fire `on_replace` and `on_insert` hooks when a component is replaced this way instead of mutated in-place.\n\nHow the mutation APIs should behave when called on a component that is marked immutable is still unspecified. Perhaps they should panic when trying to mutate a component that can't be mutated. Or maybe they act as if the component doesn't exist on the object if attempting to get a mutable reference. Or perhaps this can somehow be extended all the way to the type system so the calls which attempt to take a mutable reference to a component simply won't compile because those are not implemented for components which are immutable.\n\n## What alternative(s) have you considered?\n\nThe big alternative is that absolutely no change is needed. Preventing mutation is just a safeguard for certain kinds of components, and if the fields of the component are private, doing a mutable assignment on a component is not easy to accidentally do â€“ so for most usages it's probably enough to just say in documentation \"please don't mutate this component\".\n\nThe second alternative is also that absolutely no change is needed. Such components may be made private, and exposed through `QueryData` and `Bundle` in interfaces such that the real component is never accessible, hence never mutated. It might still be accessible via reflection, save/load, etc. but all bets are off there anyway. This is not as nice as it requires a bunch of boilerplate, and the whole point of component hooks was to allow such invariants to be implemented without creating a shadow API to do all the ECS operations while keeping invariants.\n\nThe third alternative is to somehow make synchronous change detection hooks work. There is already change detection, so it's not so impossible to think that it could run a hook real time, possibly both before change and after a change. Then we could just have `on_mutate` and that would probably cover the vast majority of cases that would benefit from immutable components.\n\n## Additional context\n\nI'm writing this issue mainly as a placeholder, and to see comments. It's one problem related to hooks that may or may not be common enough to warrant doing something about it. If there comes a strong use case for this that isn't easily solved by other means, and this problem is the primary motivation to make components private, then I will likely want to revisit this.","closed_by":{"login":"alice-i-cecile","id":3579909,"node_id":"MDQ6VXNlcjM1Nzk5MDk=","avatar_url":"https://avatars.githubusercontent.com/u/3579909?v=4","gravatar_id":"","url":"https://api.github.com/users/alice-i-cecile","html_url":"https://github.com/alice-i-cecile","followers_url":"https://api.github.com/users/alice-i-cecile/followers","following_url":"https://api.github.com/users/alice-i-cecile/following{/other_user}","gists_url":"https://api.github.com/users/alice-i-cecile/gists{/gist_id}","starred_url":"https://api.github.com/users/alice-i-cecile/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alice-i-cecile/subscriptions","organizations_url":"https://api.github.com/users/alice-i-cecile/orgs","repos_url":"https://api.github.com/users/alice-i-cecile/repos","events_url":"https://api.github.com/users/alice-i-cecile/events{/privacy}","received_events_url":"https://api.github.com/users/alice-i-cecile/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/bevyengine/bevy/issues/16208/reactions","total_count":5,"+1":5,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/bevyengine/bevy/issues/16208/timeline","performed_via_github_app":null,"state_reason":"completed"}