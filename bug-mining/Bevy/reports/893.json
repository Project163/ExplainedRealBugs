{"url":"https://api.github.com/repos/bevyengine/bevy/issues/19594","repository_url":"https://api.github.com/repos/bevyengine/bevy","labels_url":"https://api.github.com/repos/bevyengine/bevy/issues/19594/labels{/name}","comments_url":"https://api.github.com/repos/bevyengine/bevy/issues/19594/comments","events_url":"https://api.github.com/repos/bevyengine/bevy/issues/19594/events","html_url":"https://github.com/bevyengine/bevy/issues/19594","id":3140015281,"node_id":"I_kwDODf6-U867KNSx","number":19594,"title":"StateTransition schedule is inconsistent","user":{"login":"Wuketuke","id":59253838,"node_id":"MDQ6VXNlcjU5MjUzODM4","avatar_url":"https://avatars.githubusercontent.com/u/59253838?v=4","gravatar_id":"","url":"https://api.github.com/users/Wuketuke","html_url":"https://github.com/Wuketuke","followers_url":"https://api.github.com/users/Wuketuke/followers","following_url":"https://api.github.com/users/Wuketuke/following{/other_user}","gists_url":"https://api.github.com/users/Wuketuke/gists{/gist_id}","starred_url":"https://api.github.com/users/Wuketuke/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Wuketuke/subscriptions","organizations_url":"https://api.github.com/users/Wuketuke/orgs","repos_url":"https://api.github.com/users/Wuketuke/repos","events_url":"https://api.github.com/users/Wuketuke/events{/privacy}","received_events_url":"https://api.github.com/users/Wuketuke/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1795619323,"node_id":"MDU6TGFiZWwxNzk1NjE5MzIz","url":"https://api.github.com/repos/bevyengine/bevy/labels/C-Bug","name":"C-Bug","color":"d73a4a","default":false,"description":"An unexpected or incorrect behavior"},{"id":3166126807,"node_id":"MDU6TGFiZWwzMTY2MTI2ODA3","url":"https://api.github.com/repos/bevyengine/bevy/labels/S-Needs-Investigation","name":"S-Needs-Investigation","color":"D876E1","default":false,"description":"This issue requires detective work to figure out what's going wrong"},{"id":7257627940,"node_id":"LA_kwDODf6-U88AAAABsJadJA","url":"https://api.github.com/repos/bevyengine/bevy/labels/A-States","name":"A-States","color":"c6a751","default":false,"description":"App-level states machines"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2025-06-12T12:00:19Z","updated_at":"2025-07-07T20:11:21Z","closed_at":"2025-07-04T06:39:44Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## What I did\n\nI have a state that holds information about the general game state (being in main menu, splash screen, main game etc).\nSome resources in my application are only relevant in that specific state, so i want to remove them when they are not needed\nI thought the `StateTransition` schedule is where the new state gets set, so i can put any system that removes / inserts the relevant resources there\n\n## What went wrong\n\nSometimes, the StateTransition schedule gets run 1 frame later than the global state is set (i think), so any systems relying on state specific resources will cause the game to crash\nin this example, it will just print an error to the console\n\n## Workarounds\n\nI could insert a custom resource that handles the game state and transitions, but what is the point of bevys own system feature then?\nI dont understand what the point of a dedicated `StateTransition` schedule is, if not for things like this\n\n## Code\n\n```rust\nuse bevy::prelude::*;\n\nfn main() {\n    App::new()\n        .add_plugins(DefaultPlugins)\n        .add_systems(Update, sys_start_transition)\n        .add_systems(StateTransition, sys_do_transition)\n        .add_systems(FixedUpdate, sys_main_menu.run_if(in_main_menu))\n        .add_systems(FixedUpdate, sys_in_game.run_if(in_game))\n        .init_state::<GameState>()\n        .run();\n}\n\n#[derive(Clone, Copy, PartialEq, Eq, States, Debug, Hash, Default)]\nenum GameState {\n    #[default]\n    Init,\n    MainMenu,\n    InGame,\n}\n\n/// key input to transition to a new state\nfn sys_start_transition(\n    mut transition: ResMut<NextState<GameState>>,\n    mut commands: Commands,\n    current: Res<State<GameState>>,\n    keys: Res<ButtonInput<KeyCode>>,\n) {\n    let current = **current;\n    let next = match current {\n        GameState::Init => GameState::MainMenu,\n        GameState::MainMenu => GameState::InGame,\n        GameState::InGame => GameState::MainMenu,\n    };\n\n    // the issue occures no matter if the transition is triggered with Commands or NextState\n    if keys.just_pressed(KeyCode::Space) {\n        commands.set_state(next);\n    } else if keys.just_pressed(KeyCode::Enter) {\n        transition.set(next);\n    } else {\n        return;\n    };\n\n    info!(\"transition from {current:?} to {next:?}\");\n}\n\n/// remove and insert the state specific resources\nfn sys_do_transition(\n    mut commands: Commands,\n    mut events: EventReader<StateTransitionEvent<GameState>>,\n) {\n    for event in events.read() {\n        let old = event.exited;\n        let new = event.entered;\n\n        // remove old state\n        match old {\n            Some(GameState::Init) => (),\n            Some(GameState::MainMenu) => commands.remove_resource::<MainMenuData>(),\n            Some(GameState::InGame) => commands.remove_resource::<InGameData>(),\n            None => (),\n        }\n\n        // insert new state\n        match new {\n            Some(GameState::Init) => (),\n            Some(GameState::MainMenu) => commands.init_resource::<MainMenuData>(),\n            Some(GameState::InGame) => commands.init_resource::<InGameData>(),\n            None => (),\n        }\n    }\n}\n\n#[derive(Default, Resource)]\nstruct MainMenuData;\n\n#[derive(Default, Resource)]\nstruct InGameData;\n\n/// example system that gets run in the game\nfn sys_in_game(data: Option<ResMut<InGameData>>) {\n    if data.is_none() {\n        error!(\"InGameData cannot be found!!\")\n    }\n}\n\n/// example system that gets run in the main menu\nfn sys_main_menu(data: Option<ResMut<MainMenuData>>) {\n    if data.is_none() {\n        error!(\"MainMenuData cannot be found!!\")\n    }\n}\n\nfn in_main_menu(state: Res<State<GameState>>) -> bool {\n    matches!(**state, GameState::MainMenu)\n}\n\nfn in_game(state: Res<State<GameState>>) -> bool {\n    matches!(**state, GameState::InGame)\n}\n```\n\n\n## Bevy version\n\ni tested this on 0.15.0, 0.15.3, 0.16.1, and the main branch\n","closed_by":{"login":"alice-i-cecile","id":3579909,"node_id":"MDQ6VXNlcjM1Nzk5MDk=","avatar_url":"https://avatars.githubusercontent.com/u/3579909?v=4","gravatar_id":"","url":"https://api.github.com/users/alice-i-cecile","html_url":"https://github.com/alice-i-cecile","followers_url":"https://api.github.com/users/alice-i-cecile/followers","following_url":"https://api.github.com/users/alice-i-cecile/following{/other_user}","gists_url":"https://api.github.com/users/alice-i-cecile/gists{/gist_id}","starred_url":"https://api.github.com/users/alice-i-cecile/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alice-i-cecile/subscriptions","organizations_url":"https://api.github.com/users/alice-i-cecile/orgs","repos_url":"https://api.github.com/users/alice-i-cecile/repos","events_url":"https://api.github.com/users/alice-i-cecile/events{/privacy}","received_events_url":"https://api.github.com/users/alice-i-cecile/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/bevyengine/bevy/issues/19594/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/bevyengine/bevy/issues/19594/timeline","performed_via_github_app":null,"state_reason":"completed"}