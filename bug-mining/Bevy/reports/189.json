{"url":"https://api.github.com/repos/bevyengine/bevy/issues/12612","repository_url":"https://api.github.com/repos/bevyengine/bevy","labels_url":"https://api.github.com/repos/bevyengine/bevy/issues/12612/labels{/name}","comments_url":"https://api.github.com/repos/bevyengine/bevy/issues/12612/comments","events_url":"https://api.github.com/repos/bevyengine/bevy/issues/12612/events","html_url":"https://github.com/bevyengine/bevy/issues/12612","id":2199908446,"node_id":"I_kwDODf6-U86DH_Be","number":12612,"title":"CPU spikes when running the unfocused app in web ","user":{"login":"beoboo","id":210002,"node_id":"MDQ6VXNlcjIxMDAwMg==","avatar_url":"https://avatars.githubusercontent.com/u/210002?v=4","gravatar_id":"","url":"https://api.github.com/users/beoboo","html_url":"https://github.com/beoboo","followers_url":"https://api.github.com/users/beoboo/followers","following_url":"https://api.github.com/users/beoboo/following{/other_user}","gists_url":"https://api.github.com/users/beoboo/gists{/gist_id}","starred_url":"https://api.github.com/users/beoboo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/beoboo/subscriptions","organizations_url":"https://api.github.com/users/beoboo/orgs","repos_url":"https://api.github.com/users/beoboo/repos","events_url":"https://api.github.com/users/beoboo/events{/privacy}","received_events_url":"https://api.github.com/users/beoboo/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1795619323,"node_id":"MDU6TGFiZWwxNzk1NjE5MzIz","url":"https://api.github.com/repos/bevyengine/bevy/labels/C-Bug","name":"C-Bug","color":"d73a4a","default":false,"description":"An unexpected or incorrect behavior"},{"id":2272055811,"node_id":"MDU6TGFiZWwyMjcyMDU1ODEx","url":"https://api.github.com/repos/bevyengine/bevy/labels/A-Windowing","name":"A-Windowing","color":"c6a751","default":false,"description":"Platform-agnostic interface layer to run your app in"},{"id":2351483673,"node_id":"MDU6TGFiZWwyMzUxNDgzNjcz","url":"https://api.github.com/repos/bevyengine/bevy/labels/O-Web","name":"O-Web","color":"2e6991","default":false,"description":"Specific to web (WASM) builds"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/bevyengine/bevy/milestones/20","html_url":"https://github.com/bevyengine/bevy/milestone/20","labels_url":"https://api.github.com/repos/bevyengine/bevy/milestones/20/labels","id":10463467,"node_id":"MI_kwDODf6-U84An6jr","number":20,"title":"0.14","description":"","creator":{"login":"alice-i-cecile","id":3579909,"node_id":"MDQ6VXNlcjM1Nzk5MDk=","avatar_url":"https://avatars.githubusercontent.com/u/3579909?v=4","gravatar_id":"","url":"https://api.github.com/users/alice-i-cecile","html_url":"https://github.com/alice-i-cecile","followers_url":"https://api.github.com/users/alice-i-cecile/followers","following_url":"https://api.github.com/users/alice-i-cecile/following{/other_user}","gists_url":"https://api.github.com/users/alice-i-cecile/gists{/gist_id}","starred_url":"https://api.github.com/users/alice-i-cecile/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alice-i-cecile/subscriptions","organizations_url":"https://api.github.com/users/alice-i-cecile/orgs","repos_url":"https://api.github.com/users/alice-i-cecile/repos","events_url":"https://api.github.com/users/alice-i-cecile/events{/privacy}","received_events_url":"https://api.github.com/users/alice-i-cecile/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":404,"state":"closed","created_at":"2024-01-24T15:23:42Z","updated_at":"2024-07-04T20:09:44Z","due_on":null,"closed_at":"2024-07-04T20:09:44Z"},"comments":3,"created_at":"2024-03-21T11:21:28Z","updated_at":"2024-05-02T20:12:46Z","closed_at":"2024-05-02T20:12:46Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## Bevy version\r\n\r\nThis is happening only in Bevy 0.13.x, since the recent refactor to winit 0.29.\r\n\r\n## Relevant system information\r\n\r\nTested on Windows 11 and MacOS, using Chrome. I've not been able to reproduce it in Firefox, but it might be only because of different rendering speed, since the error in non-deterministic.\r\n\r\n## What you did\r\n\r\n* Run the `low-power` example in WASM\r\n* Unfocus the page (it works best if switching to a different tab in the browser)\r\n* Check the CPU usage (e.g. in ActivityMonitor): it spikes up to 400% more than the default focused behaviour.\r\n\r\n## What went wrong\r\n\r\nThe expected result should be that:\r\n* in game mode, it should continue to use the same amount of CPU (i.e. continuously running) => OK\r\n* in reactive mode, without RequestRedraw, it should use a very low amount of CPU in unfocused mode\r\n* in reactive mode, with RequestRedraw, I'm not really sure what's the expected behavior. \r\n\r\n## What I discovered\r\n1. `window.request_redraw()` is called depending on the visibility of the window. This is discouraged by winit, and it doesn't really help because the focused/unfocused state is not the same thing as the visible/invisible one. The [winit control_flow example](https://github.com/rust-windowing/winit/blob/v0.29.15/examples/control_flow.rs) doesn't use the visibility as a check to redraw the window.\r\n2. [this](https://github.com/bevyengine/bevy/blob/main/crates/bevy_winit/src/lib.rs#L399-L408) should run only if the wait timeout has elapsed (I think).\r\n3. the `runner_state.wait_elapsed` should only be updated in NewEvents (and never reset manually like [here](https://github.com/bevyengine/bevy/blob/main/crates/bevy_winit/src/lib.rs#L736)). This is because a very common flow is `NewEvents` => `RedrawRequested` => `AboutToWait`, but even if the first sets the wait_elapsed to true, this would be immediately reset in the second and thus irrelevant in the third.\r\n\r\n\r\nAs sidenotes to be considered:\r\n* the `WinitAppRunnerState` contains the `ActiveState` (that tracks the current app state), and also values related to rendering and waiting, more linked to the event loop. IMO these two parts should be decoupled as they don't touch each other and change for different reasons. \r\n* the UpdateMode::Continuous should be removed from WASM as it doesn't make sense","closed_by":{"login":"mockersf","id":8672791,"node_id":"MDQ6VXNlcjg2NzI3OTE=","avatar_url":"https://avatars.githubusercontent.com/u/8672791?v=4","gravatar_id":"","url":"https://api.github.com/users/mockersf","html_url":"https://github.com/mockersf","followers_url":"https://api.github.com/users/mockersf/followers","following_url":"https://api.github.com/users/mockersf/following{/other_user}","gists_url":"https://api.github.com/users/mockersf/gists{/gist_id}","starred_url":"https://api.github.com/users/mockersf/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mockersf/subscriptions","organizations_url":"https://api.github.com/users/mockersf/orgs","repos_url":"https://api.github.com/users/mockersf/repos","events_url":"https://api.github.com/users/mockersf/events{/privacy}","received_events_url":"https://api.github.com/users/mockersf/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/bevyengine/bevy/issues/12612/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/bevyengine/bevy/issues/12612/timeline","performed_via_github_app":null,"state_reason":"completed"}