{"url":"https://api.github.com/repos/bevyengine/bevy/issues/19324","repository_url":"https://api.github.com/repos/bevyengine/bevy","labels_url":"https://api.github.com/repos/bevyengine/bevy/issues/19324/labels{/name}","comments_url":"https://api.github.com/repos/bevyengine/bevy/issues/19324/comments","events_url":"https://api.github.com/repos/bevyengine/bevy/issues/19324/events","html_url":"https://github.com/bevyengine/bevy/issues/19324","id":3080589953,"node_id":"I_kwDODf6-U863nhKB","number":19324,"title":"`EntityCloner` has no concept of required components after configuration which may have surprising effects depending on the target archetype","user":{"login":"urben1680","id":55257931,"node_id":"MDQ6VXNlcjU1MjU3OTMx","avatar_url":"https://avatars.githubusercontent.com/u/55257931?v=4","gravatar_id":"","url":"https://api.github.com/users/urben1680","html_url":"https://github.com/urben1680","followers_url":"https://api.github.com/users/urben1680/followers","following_url":"https://api.github.com/users/urben1680/following{/other_user}","gists_url":"https://api.github.com/users/urben1680/gists{/gist_id}","starred_url":"https://api.github.com/users/urben1680/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/urben1680/subscriptions","organizations_url":"https://api.github.com/users/urben1680/orgs","repos_url":"https://api.github.com/users/urben1680/repos","events_url":"https://api.github.com/users/urben1680/events{/privacy}","received_events_url":"https://api.github.com/users/urben1680/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1795619323,"node_id":"MDU6TGFiZWwxNzk1NjE5MzIz","url":"https://api.github.com/repos/bevyengine/bevy/labels/C-Bug","name":"C-Bug","color":"d73a4a","default":false,"description":"An unexpected or incorrect behavior"},{"id":2488007862,"node_id":"MDU6TGFiZWwyNDg4MDA3ODYy","url":"https://api.github.com/repos/bevyengine/bevy/labels/S-Needs-Triage","name":"S-Needs-Triage","color":"D876e3","default":false,"description":"This issue needs to be labelled"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2025-05-21T15:15:13Z","updated_at":"2025-05-30T19:49:54Z","closed_at":"2025-05-30T19:49:54Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## Bevy version\n0.16\n\n## What you did\n\n```rs\n#[derive(Component, PartialEq, Debug, Default, Copy, Clone)]\n#[require(Required)]\nstruct Explicit(u8);\n\n#[derive(Component, PartialEq, Debug, Default, Copy, Clone)]\nstruct Required(u8);\n\nlet mut world = World::new();\nlet target = world.spawn(Required(10)).id();\nworld.spawn((Explicit(20), Required(20))).clone_components::<Explicit>(target);\nassert_eq!(world.get(target), Some(&Required(10)));\n```\n\n## What went wrong\n\nThe assertion fails, the target now contains `Required(20)`.\nThis is surprising, since I did not explicitly ask for that to be cloned and it should not happen if the target already contains it.\n\nThe issue here is that `EntityCloner` has no information of the target entity at the time of configuration. You can either tell it to move `Explicit` with or without `Required`, the latter by using `EntityCloner::without_required_components`. This is not comfortable because you would have to check the target archetype first to pick the correct configuration. There is no automatism.\n\nTo make the issue more clear, these are the possible scenarios if I wanted to clone `Explicit` with or without `Required`:\n\n| use `without_required_components` | target before | target after |\n| - | - | - |\n| no | `Explicit(10)`, `Required(10)` | `Explicit(20)`, `Required(20)` ❌ |\n| no | `Required(10)` | `Explicit(20)`, `Required(20)` ❌ |\n| no | | `Explicit(20)`, `Required(20)` ✅ |\n| yes| `Explicit(10)`, `Required(10)` | `Explicit(20)`, `Required(10)` ✅ |\n| yes| `Required(10)` | `Explicit(20)`, `Required(10)` ✅ |\n| yes | | `Explicit(20)`, `Required(0)` ❌ |\n\nAs you can see, if you only want to clone `Required` if it does not exist at the target yet, like `insert` behaves where it only constructs a default `Required` when needed, you _need_  to check the target archetype first and pick the correct cloner configuration based on that.\n\nThis makes this API uncomfortable.\n\nA proper fix, if we want to keep `EntityCloner` agnostic to the target archetype (since it may be used on multiple source/target pairs as I saw in the code), it should at least know which `ComponentId` were given as explicit or implicit.","closed_by":{"login":"alice-i-cecile","id":3579909,"node_id":"MDQ6VXNlcjM1Nzk5MDk=","avatar_url":"https://avatars.githubusercontent.com/u/3579909?v=4","gravatar_id":"","url":"https://api.github.com/users/alice-i-cecile","html_url":"https://github.com/alice-i-cecile","followers_url":"https://api.github.com/users/alice-i-cecile/followers","following_url":"https://api.github.com/users/alice-i-cecile/following{/other_user}","gists_url":"https://api.github.com/users/alice-i-cecile/gists{/gist_id}","starred_url":"https://api.github.com/users/alice-i-cecile/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alice-i-cecile/subscriptions","organizations_url":"https://api.github.com/users/alice-i-cecile/orgs","repos_url":"https://api.github.com/users/alice-i-cecile/repos","events_url":"https://api.github.com/users/alice-i-cecile/events{/privacy}","received_events_url":"https://api.github.com/users/alice-i-cecile/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/bevyengine/bevy/issues/19324/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/bevyengine/bevy/issues/19324/timeline","performed_via_github_app":null,"state_reason":"completed"}