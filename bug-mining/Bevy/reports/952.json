{"url":"https://api.github.com/repos/bevyengine/bevy/issues/14709","repository_url":"https://api.github.com/repos/bevyengine/bevy","labels_url":"https://api.github.com/repos/bevyengine/bevy/issues/14709/labels{/name}","comments_url":"https://api.github.com/repos/bevyengine/bevy/issues/14709/comments","events_url":"https://api.github.com/repos/bevyengine/bevy/issues/14709/events","html_url":"https://github.com/bevyengine/bevy/issues/14709","id":2459603719,"node_id":"I_kwDODf6-U86SmpMH","number":14709,"title":"`CombinatorSystem` is unsound","user":{"login":"SkiFire13","id":9020423,"node_id":"MDQ6VXNlcjkwMjA0MjM=","avatar_url":"https://avatars.githubusercontent.com/u/9020423?v=4","gravatar_id":"","url":"https://api.github.com/users/SkiFire13","html_url":"https://github.com/SkiFire13","followers_url":"https://api.github.com/users/SkiFire13/followers","following_url":"https://api.github.com/users/SkiFire13/following{/other_user}","gists_url":"https://api.github.com/users/SkiFire13/gists{/gist_id}","starred_url":"https://api.github.com/users/SkiFire13/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SkiFire13/subscriptions","organizations_url":"https://api.github.com/users/SkiFire13/orgs","repos_url":"https://api.github.com/users/SkiFire13/repos","events_url":"https://api.github.com/users/SkiFire13/events{/privacy}","received_events_url":"https://api.github.com/users/SkiFire13/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1795619323,"node_id":"MDU6TGFiZWwxNzk1NjE5MzIz","url":"https://api.github.com/repos/bevyengine/bevy/labels/C-Bug","name":"C-Bug","color":"d73a4a","default":false,"description":"An unexpected or incorrect behavior"},{"id":2197761682,"node_id":"MDU6TGFiZWwyMTk3NzYxNjgy","url":"https://api.github.com/repos/bevyengine/bevy/labels/A-ECS","name":"A-ECS","color":"c6a751","default":false,"description":"Entities, components, systems, and events"},{"id":3166143717,"node_id":"MDU6TGFiZWwzMTY2MTQzNzE3","url":"https://api.github.com/repos/bevyengine/bevy/labels/D-Complex","name":"D-Complex","color":"008672","default":false,"description":"Quite challenging from either a design or technical perspective. Ask for help!"},{"id":4102809496,"node_id":"LA_kwDODf6-U870i-eY","url":"https://api.github.com/repos/bevyengine/bevy/labels/P-Unsound","name":"P-Unsound","color":"FF7b00","default":false,"description":"A bug that results in undefined compiler behavior"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2024-08-11T13:52:42Z","updated_at":"2025-09-01T23:15:14Z","closed_at":"2025-09-01T23:15:14Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## Bevy version\r\n\r\n0.14.1\r\n\r\n## What you did\r\n\r\n```rs\r\nuse bevy_ecs::system::{CombinatorSystem, Combine, IntoSystem, Resource, System};\r\nuse bevy_ecs::world::World;\r\nuse scoped_tls_hkt::scoped_thread_local; // scoped_tls_hkt = \"0.1.4\" in Cargo.toml\r\n\r\n#[derive(Clone, Copy)]\r\nstruct BadFn<'a>(&'a dyn Fn());\r\n\r\nscoped_thread_local!(static BAD_FN: for<'a> BadFn<'a>);\r\n\r\nstruct BadCombine;\r\n\r\nimpl<A: System<In = (), Out = ()>, B: System<In = (), Out = ()>> Combine<A, B> for BadCombine {\r\n    type In = ();\r\n    type Out = ();\r\n\r\n    fn combine(\r\n        _input: Self::In,\r\n        a: impl FnOnce(A::In) -> A::Out,\r\n        b: impl FnOnce(B::In) -> B::Out,\r\n    ) -> Self::Out {\r\n        let a = std::cell::Cell::new(Some(a));\r\n        let bad_fn = BadFn(Box::leak(Box::new(move || (a.take().unwrap())(()))));\r\n        BAD_FN.set(bad_fn, || b(()));\r\n    }\r\n}\r\n\r\n#[derive(Resource)]\r\nstruct Foo(String);\r\n\r\nfn a(world: &mut World) {\r\n    world.remove_resource::<Foo>();\r\n}\r\n\r\nfn b(world: &mut World) {\r\n    world.insert_resource(Foo(\"foo\".to_string()));\r\n    let foo = world.resource::<Foo>();\r\n    BAD_FN.with(|bad_fn| (bad_fn.0)());\r\n    println!(\"{}\", foo.0);\r\n}\r\n\r\nfn main() {\r\n    let mut world = World::new();\r\n\r\n    let a_system = IntoSystem::into_system(a);\r\n    let b_system = IntoSystem::into_system(b);\r\n    let mut combinator_system =\r\n        CombinatorSystem::<BadCombine, _, _>::new(a_system, b_system, \"\".into());\r\n\r\n    combinator_system.initialize(&mut world);\r\n    combinator_system.run((), &mut world);\r\n}\r\n```\r\n\r\n## What went wrong\r\n\r\nThis should either fail to compile or throw an error at runtime. Instead, this produced UB due to `b` holding a reference to a resource that has been removed. MIRI also flags this as UB:\r\n\r\n<details>\r\n```\r\nerror: Undefined Behavior: not granting access to tag <24319> because that would remove [Unique for <19222>] which is strongly protected because it is an argument of call 4818\r\n   --> E:\\Programmi\\Rust\\.cargo\\registry\\src\\index.crates.io-6f17d22bba15001f\\bevy_ptr-0.14.1\\src/lib.rs:574:18\r\n    |\r\n574 |         unsafe { &mut *self.get() }\r\n    |                  ^^^^^^^^^^^^^^^^ not granting access to tag <24319> because that would remove [Unique for <19222>] which is strongly protected because it is an argument of call 4818    \r\n    |\r\n    = help: this indicates a potential bug in the program: it performed an invalid operation, but the Stacked Borrows rules it violated are still experimental\r\n    = help: see https://github.com/rust-lang/unsafe-code-guidelines/blob/master/wip/stacked-borrows.md for further information\r\nhelp: <24319> was created by a SharedReadWrite retag at offsets [0x0..0x458]\r\n   --> src/main.rs:22:55\r\n    |\r\n22  |         let bad_fn = BadFn(Box::leak(Box::new(move || (a.take().unwrap())(()))));\r\n    |                                                       ^^^^^^^^^^^^^^^^^^^^^^^\r\nhelp: <19222> is this argument\r\n   --> src/main.rs:34:6\r\n    |\r\n34  | fn b(world: &mut World) {\r\n    |      ^^^^^\r\n    = note: BACKTRACE (of the first span):\r\n    = note: inside `<&std::cell::UnsafeCell<bevy_ecs::world::World> as bevy_ecs::bevy_ptr::UnsafeCellDeref<'_, bevy_ecs::world::World>>::deref_mut` at E:\\Programmi\\Rust\\.cargo\\registry\\src\\index.crates.io-6f17d22bba15001f\\bevy_ptr-0.14.1\\src/lib.rs:574:18: 574:34\r\n    = note: inside closure at E:\\Programmi\\Rust\\.cargo\\registry\\src\\index.crates.io-6f17d22bba15001f\\bevy_ecs-0.14.1\\src\\system\\combinator.rs:194:48: 194:65\r\nnote: inside closure\r\n   --> src/main.rs:22:55\r\n    |\r\n22  |         let bad_fn = BadFn(Box::leak(Box::new(move || (a.take().unwrap())(()))));\r\n    |                                                       ^^^^^^^^^^^^^^^^^^^^^^^\r\nnote: inside closure\r\n   --> src/main.rs:37:26\r\n    |\r\n37  |     BAD_FN.with(|bad_fn| (bad_fn.0)());\r\n    |                          ^^^^^^^^^^^^\r\nnote: inside `BAD_FN::<impl BAD_FN<'static>>::with::<{closure@src/main.rs:37:17: 37:25}, ()>`\r\n   --> src/main.rs:8:1\r\n    |\r\n8   | scoped_thread_local!(static BAD_FN: for<'a> BadFn<'a>);\r\n    | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\nnote: inside `b`\r\n   --> src/main.rs:37:5\r\n    |\r\n37  |     BAD_FN.with(|bad_fn| (bad_fn.0)());\r\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n    = note: inside `<for<'a> fn(&'a mut bevy_ecs::world::World) {b} as std::ops::FnMut<(&mut bevy_ecs::world::World,)>>::call_mut - shim(for<'a> fn(&'a mut bevy_ecs::world::World) {b})` at E:\\Programmi\\Rust\\.rustup\\toolchains\\nightly-x86_64-pc-windows-msvc\\lib\\rustlib\\src\\rust\\library\\core\\src\\ops\\function.rs:166:5: 166:75\r\n    = note: inside `std::ops::function::impls::<impl std::ops::FnMut<(&mut bevy_ecs::world::World,)> for &mut for<'a> fn(&'a mut bevy_ecs::world::World) {b}>::call_mut` at E:\\Programmi\\Rust\\.rustup\\toolchains\\nightly-x86_64-pc-windows-msvc\\lib\\rustlib\\src\\rust\\library\\core\\src\\ops\\function.rs:294:13: 294:35\r\n    = note: inside `<Func as bevy_ecs::system::ExclusiveSystemParamFunction<fn() -> Out>>::run::call_inner::<(), &mut for<'a> fn(&'a mut bevy_ecs::world::World) {b}>` at E:\\Programmi\\Rust\\.cargo\\registry\\src\\index.crates.io-6f17d22bba15001f\\bevy_ecs-0.14.1\\src\\system\\exclusive_function_system.rs:218:21: 218:42\r\n    = note: inside `<for<'a> fn(&'a mut bevy_ecs::world::World) {b} as bevy_ecs::system::ExclusiveSystemParamFunction<fn()>>::run` at E:\\Programmi\\Rust\\.cargo\\registry\\src\\index.crates.io-6f17d22bba15001f\\bevy_ecs-0.14.1\\src\\system\\exclusive_function_system.rs:221:17: 221:53\r\n    = note: inside closure at E:\\Programmi\\Rust\\.cargo\\registry\\src\\index.crates.io-6f17d22bba15001f\\bevy_ecs-0.14.1\\src\\system\\exclusive_function_system.rs:111:23: 111:58\r\n    = note: inside `bevy_ecs::world::World::last_change_tick_scope::<(), {closure@<bevy_ecs::system::ExclusiveFunctionSystem<fn(), for<'a> fn(&'a mut bevy_ecs::world::World) {b}> as bevy_ecs::system::System>::run::{closure#0}}>` at E:\\Programmi\\Rust\\.cargo\\registry\\src\\index.crates.io-6f17d22bba15001f\\bevy_ecs-0.14.1\\src\\world\\mod.rs:2215:9: 2215:23\r\n    = note: inside `<bevy_ecs::system::ExclusiveFunctionSystem<fn(), for<'a> fn(&'a mut bevy_ecs::world::World) {b}> as bevy_ecs::system::System>::run` at E:\\Programmi\\Rust\\.cargo\\registry\\src\\index.crates.io-6f17d22bba15001f\\bevy_ecs-0.14.1\\src\\system\\exclusive_function_system.rs:103:9: 119:11\r\n    = note: inside closure at E:\\Programmi\\Rust\\.cargo\\registry\\src\\index.crates.io-6f17d22bba15001f\\bevy_ecs-0.14.1\\src\\system\\combinator.rs:196:21: 196:68\r\nnote: inside closure\r\n   --> src/main.rs:23:31\r\n    |\r\n23  |         BAD_FN.set(bad_fn, || b(()));\r\n    |                               ^^^^^\r\nnote: inside `BAD_FN::<impl BAD_FN<'static>>::set::<{closure@src/main.rs:23:28: 23:30}, ()>`\r\n   --> src/main.rs:8:1\r\n    |\r\n8   | scoped_thread_local!(static BAD_FN: for<'a> BadFn<'a>);\r\n    | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\nnote: inside `<BadCombine as bevy_ecs::system::Combine<bevy_ecs::system::ExclusiveFunctionSystem<fn(), for<'a> fn(&'a mut bevy_ecs::world::World) {a}>, bevy_ecs::system::ExclusiveFunctionSystem<fn(), for<'a> fn(&'a mut bevy_ecs::world::World) {b}>>>::combine::<{closure@<bevy_ecs::system::CombinatorSystem<BadCombine, bevy_ecs::system::ExclusiveFunctionSystem<fn(), for<'a> fn(&'a mut bevy_ecs::world::World) {a}>, bevy_ecs::system::ExclusiveFunctionSystem<fn(), for<'a> fn(&'a mut bevy_ecs::world::World) {b}>> as bevy_ecs::system::System>::run::{closure#0}}, {closure@<bevy_ecs::system::CombinatorSystem<BadCombine, bevy_ecs::system::ExclusiveFunctionSystem<fn(), for<'a> fn(&'a mut bevy_ecs::world::World) {a}>, bevy_ecs::system::ExclusiveFunctionSystem<fn(), for<'a> fn(&'a mut bevy_ecs::world::World) {b}>> as bevy_ecs::system::System>::run::{closure#1}}>`\r\n   --> src/main.rs:23:9\r\n    |\r\n23  |         BAD_FN.set(bad_fn, || b(()));\r\n    |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n    = note: inside `<bevy_ecs::system::CombinatorSystem<BadCombine, bevy_ecs::system::ExclusiveFunctionSystem<fn(), for<'a> fn(&'a mut bevy_ecs::world::World) {a}>, bevy_ecs::system::ExclusiveFunctionSystem<fn(), for<'a> fn(&'a mut bevy_ecs::world::World) {b}>> as bevy_ecs::system::System>::run` at E:\\Programmi\\Rust\\.cargo\\registry\\src\\index.crates.io-6f17d22bba15001f\\bevy_ecs-0.14.1\\src\\system\\combinator.rs:189:9: 197:10\r\nnote: inside `main`\r\n   --> src/main.rs:50:5\r\n    |\r\n50  |     combinator_system.run((), &mut world);\r\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n    = note: this error originates in the macro `scoped_thread_local` (in Nightly builds, run with -Z macro-backtrace for more info)\r\n```\r\n</details>\r\n\r\n## Additional information\r\n\r\nThe issue is that `CombinatorSystem` gives to the `Func::combine` implementation two closures, each of which holds an `UnsafeWorldCell` that assumes is valid for calling that system:\r\n\r\nhttps://github.com/bevyengine/bevy/blob/91fa4bb64905121a18b40df0062dbd85714aa3ce/crates/bevy_ecs/src/system/combinator.rs#L185-L198\r\n\r\nThe safety comment assumes that since the functions are `!Send + !Sync + !'static` then they cannot possibly be called in a _parallel_ way. However this fails to see that they can still be called in a reentrant way, that is one function calling the other while it's running. This effectively also creates overlapping references to the world or its contents and thus leads to UB.\r\n\r\nActually exploiting this issue is not that easy though, as can be seen in the code above, since one closure cannot be smuggled directly to the other, thus having to go through some global state. This might seem that it requires `'static` (and in fact using only the stdlib is does), but there are libraries that allow doing this like `scoped-tls-hkt`, which allows to store non-`'static` data in a thread local, ensuring it will be overwritten before it goes out of scope. With this one closure can actually be smuggled into the other and lead to the overlapping access to the world and thus UB.","closed_by":{"login":"alice-i-cecile","id":3579909,"node_id":"MDQ6VXNlcjM1Nzk5MDk=","avatar_url":"https://avatars.githubusercontent.com/u/3579909?v=4","gravatar_id":"","url":"https://api.github.com/users/alice-i-cecile","html_url":"https://github.com/alice-i-cecile","followers_url":"https://api.github.com/users/alice-i-cecile/followers","following_url":"https://api.github.com/users/alice-i-cecile/following{/other_user}","gists_url":"https://api.github.com/users/alice-i-cecile/gists{/gist_id}","starred_url":"https://api.github.com/users/alice-i-cecile/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alice-i-cecile/subscriptions","organizations_url":"https://api.github.com/users/alice-i-cecile/orgs","repos_url":"https://api.github.com/users/alice-i-cecile/repos","events_url":"https://api.github.com/users/alice-i-cecile/events{/privacy}","received_events_url":"https://api.github.com/users/alice-i-cecile/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/bevyengine/bevy/issues/14709/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/bevyengine/bevy/issues/14709/timeline","performed_via_github_app":null,"state_reason":"completed"}