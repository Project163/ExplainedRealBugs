{"url":"https://api.github.com/repos/bevyengine/bevy/issues/17885","repository_url":"https://api.github.com/repos/bevyengine/bevy","labels_url":"https://api.github.com/repos/bevyengine/bevy/issues/17885/labels{/name}","comments_url":"https://api.github.com/repos/bevyengine/bevy/issues/17885/comments","events_url":"https://api.github.com/repos/bevyengine/bevy/issues/17885/events","html_url":"https://github.com/bevyengine/bevy/issues/17885","id":2856364467,"node_id":"I_kwDODf6-U86qQKmz","number":17885,"title":"2d specialized material shader defs aren't updated","user":{"login":"rparrett","id":200550,"node_id":"MDQ6VXNlcjIwMDU1MA==","avatar_url":"https://avatars.githubusercontent.com/u/200550?v=4","gravatar_id":"","url":"https://api.github.com/users/rparrett","html_url":"https://github.com/rparrett","followers_url":"https://api.github.com/users/rparrett/followers","following_url":"https://api.github.com/users/rparrett/following{/other_user}","gists_url":"https://api.github.com/users/rparrett/gists{/gist_id}","starred_url":"https://api.github.com/users/rparrett/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rparrett/subscriptions","organizations_url":"https://api.github.com/users/rparrett/orgs","repos_url":"https://api.github.com/users/rparrett/repos","events_url":"https://api.github.com/users/rparrett/events{/privacy}","received_events_url":"https://api.github.com/users/rparrett/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1795619323,"node_id":"MDU6TGFiZWwxNzk1NjE5MzIz","url":"https://api.github.com/repos/bevyengine/bevy/labels/C-Bug","name":"C-Bug","color":"d73a4a","default":false,"description":"An unexpected or incorrect behavior"},{"id":2488007862,"node_id":"MDU6TGFiZWwyNDg4MDA3ODYy","url":"https://api.github.com/repos/bevyengine/bevy/labels/S-Needs-Triage","name":"S-Needs-Triage","color":"D876e3","default":false,"description":"This issue needs to be labelled"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2025-02-16T22:15:19Z","updated_at":"2025-02-17T19:47:50Z","closed_at":"2025-02-17T19:47:50Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## Bevy version\n\nmain, bisected to #17787\n\n## Relevant system information\n\nSystemInfo { os: \"macOS 15.3 Sequoia\", kernel: \"24.3.0\", cpu: \"Apple M4 Max\", core_count: \"16\", memory: \"64.0 GiB\" }    \nAdapterInfo { name: \"Apple M4 Max\", vendor: 0, device: 0, device_type: IntegratedGpu, driver: \"\", driver_info: \"\", backend: Metal }\n\n## What you did\n\nModified the `shader_defs` example:\n- Make everything 2d\n- Add a system that changes one of the materials when space is pressed\n\n<details>\n<summary>Expand modified 2d <code>shader_defs.rs</code></summary>\n\n```rust\n//! A shader that uses \"shaders defs\", which selectively toggle parts of a shader.\n\nuse bevy::{\n    prelude::*,\n    reflect::TypePath,\n    render::{\n        mesh::MeshVertexBufferLayoutRef,\n        render_resource::{\n            AsBindGroup, RenderPipelineDescriptor, ShaderRef, SpecializedMeshPipelineError,\n        },\n    },\n    sprite::{Material2d, Material2dKey, Material2dPlugin},\n};\n\n/// This example uses a shader source file from the assets subdirectory\nconst SHADER_ASSET_PATH: &str = \"shaders/shader_defs.wgsl\";\n\n#[derive(Component)]\nstruct Controllable;\n\nfn main() {\n    App::new()\n        .add_plugins((\n            DefaultPlugins,\n            Material2dPlugin::<CustomMaterial>::default(),\n        ))\n        .add_systems(Startup, setup)\n        .add_systems(Update, control)\n        .run();\n}\n\n/// set up a simple 2d scene\nfn setup(\n    mut commands: Commands,\n    mut meshes: ResMut<Assets<Mesh>>,\n    mut materials: ResMut<Assets<CustomMaterial>>,\n) {\n    // blue cube\n    commands.spawn((\n        Mesh2d(meshes.add(Rectangle::default())),\n        MeshMaterial2d(materials.add(CustomMaterial {\n            color: LinearRgba::BLUE,\n            is_red: false,\n        })),\n        Transform::from_xyz(-100.0, 50., 0.0).with_scale(Vec2::splat(100.).extend(1.)),\n        Controllable,\n    ));\n\n    // red cube (with green color overridden by the IS_RED \"shader def\")\n    commands.spawn((\n        Mesh2d(meshes.add(Rectangle::default())),\n        MeshMaterial2d(materials.add(CustomMaterial {\n            color: LinearRgba::GREEN,\n            is_red: true,\n        })),\n        Transform::from_xyz(100.0, 50., 0.0).with_scale(Vec2::splat(100.).extend(1.)),\n    ));\n\n    // camera\n    commands.spawn(Camera2d::default());\n}\n\nfn control(\n    handles: Query<&MeshMaterial2d<CustomMaterial>, With<Controllable>>,\n    mut materials: ResMut<Assets<CustomMaterial>>,\n    input: Res<ButtonInput<KeyCode>>,\n) {\n    if !input.just_pressed(KeyCode::Space) {\n        return;\n    }\n\n    for handle in &handles {\n        let Some(mat) = materials.get_mut(handle) else {\n            continue;\n        };\n\n        mat.is_red = !mat.is_red;\n    }\n}\n\nimpl Material2d for CustomMaterial {\n    fn fragment_shader() -> ShaderRef {\n        SHADER_ASSET_PATH.into()\n    }\n\n    fn specialize(\n        descriptor: &mut RenderPipelineDescriptor,\n        _layout: &MeshVertexBufferLayoutRef,\n        key: Material2dKey<Self>,\n    ) -> Result<(), SpecializedMeshPipelineError> {\n        if key.bind_group_data.is_red {\n            let fragment = descriptor.fragment.as_mut().unwrap();\n            fragment.shader_defs.push(\"IS_RED\".into());\n        }\n        Ok(())\n    }\n}\n\n// This is the struct that will be passed to your shader\n#[derive(Asset, TypePath, AsBindGroup, Debug, Clone)]\n#[bind_group_data(CustomMaterialKey)]\nstruct CustomMaterial {\n    #[uniform(0)]\n    color: LinearRgba,\n    is_red: bool,\n}\n\n// This key is used to identify a specific permutation of this material pipeline.\n// In this case, we specialize on whether or not to configure the \"IS_RED\" shader def.\n// Specialization keys should be kept as small / cheap to hash as possible,\n// as they will be used to look up the pipeline for each drawn entity with this material type.\n#[derive(Eq, PartialEq, Hash, Clone)]\nstruct CustomMaterialKey {\n    is_red: bool,\n}\n\nimpl From<&CustomMaterial> for CustomMaterialKey {\n    fn from(material: &CustomMaterial) -> Self {\n        Self {\n            is_red: material.is_red,\n        }\n    }\n}\n```\n</details>\n\n`cargo run --example shader_defs`\n\n## What went wrong\n\nLeft square should toggle between blue and red.\n\nInstead, the square only changes on the first press. After that, it stays red.\n\n## Additional information\n\n- @hukasu may be investigating a related but different bug. Credit to them for the discovery.\n- After doing some light archaeology, It seems to me like 2d is missing the following:\n  ```rust\n  app.add_plugins((\n      BinnedRenderPhasePlugin::<Opaque2d, Mesh2dPipeline>::new(RenderDebugFlags::default()),\n      BinnedRenderPhasePlugin::<AlphaMask2d, Mesh2dPipeline>::new(RenderDebugFlags::default()),\n      SortedRenderPhasePlugin::<Transparent2d, Mesh2dPipeline>::new(RenderDebugFlags::default()),\n  ));\n  ```\n  But there appears to be more to the story, because adding those results in some errors I don't understand.\n- This *does* work in 3d.\n\n<details>\n<summary>Expand 3d NON-repro</summary>\n\n```rust\n//! A shader that uses \"shaders defs\", which selectively toggle parts of a shader.\n\nuse bevy::{\n    pbr::{MaterialPipeline, MaterialPipelineKey},\n    prelude::*,\n    reflect::TypePath,\n    render::{\n        mesh::MeshVertexBufferLayoutRef,\n        render_resource::{\n            AsBindGroup, RenderPipelineDescriptor, ShaderRef, SpecializedMeshPipelineError,\n        },\n    },\n};\n\n/// This example uses a shader source file from the assets subdirectory\nconst SHADER_ASSET_PATH: &str = \"shaders/shader_defs.wgsl\";\n\n#[derive(Component)]\nstruct Controllable;\n\nfn main() {\n    App::new()\n        .add_plugins((DefaultPlugins, MaterialPlugin::<CustomMaterial>::default()))\n        .add_systems(Startup, setup)\n        .add_systems(Update, control)\n        .run();\n}\n\n/// set up a simple 3D scene\nfn setup(\n    mut commands: Commands,\n    mut meshes: ResMut<Assets<Mesh>>,\n    mut materials: ResMut<Assets<CustomMaterial>>,\n) {\n    // blue cube\n    commands.spawn((\n        Mesh3d(meshes.add(Cuboid::default())),\n        MeshMaterial3d(materials.add(CustomMaterial {\n            color: LinearRgba::BLUE,\n            is_red: false,\n        })),\n        Transform::from_xyz(-1.0, 0.5, 0.0),\n        Controllable,\n    ));\n\n    // red cube (with green color overridden by the IS_RED \"shader def\")\n    commands.spawn((\n        Mesh3d(meshes.add(Cuboid::default())),\n        MeshMaterial3d(materials.add(CustomMaterial {\n            color: LinearRgba::GREEN,\n            is_red: true,\n        })),\n        Transform::from_xyz(1.0, 0.5, 0.0),\n    ));\n\n    // camera\n    commands.spawn((\n        Camera3d::default(),\n        Transform::from_xyz(-2.0, 2.5, 5.0).looking_at(Vec3::ZERO, Vec3::Y),\n    ));\n}\n\nfn control(\n    handles: Query<&MeshMaterial3d<CustomMaterial>, With<Controllable>>,\n    mut materials: ResMut<Assets<CustomMaterial>>,\n    input: Res<ButtonInput<KeyCode>>,\n) {\n    if !input.just_pressed(KeyCode::Space) {\n        return;\n    }\n\n    for handle in &handles {\n        let Some(mat) = materials.get_mut(handle) else {\n            continue;\n        };\n\n        mat.is_red = !mat.is_red;\n    }\n}\n\nimpl Material for CustomMaterial {\n    fn fragment_shader() -> ShaderRef {\n        SHADER_ASSET_PATH.into()\n    }\n\n    fn specialize(\n        _pipeline: &MaterialPipeline<Self>,\n        descriptor: &mut RenderPipelineDescriptor,\n        _layout: &MeshVertexBufferLayoutRef,\n        key: MaterialPipelineKey<Self>,\n    ) -> Result<(), SpecializedMeshPipelineError> {\n        if key.bind_group_data.is_red {\n            let fragment = descriptor.fragment.as_mut().unwrap();\n            fragment.shader_defs.push(\"IS_RED\".into());\n        }\n        Ok(())\n    }\n}\n\n// This is the struct that will be passed to your shader\n#[derive(Asset, TypePath, AsBindGroup, Debug, Clone)]\n#[bind_group_data(CustomMaterialKey)]\nstruct CustomMaterial {\n    #[uniform(0)]\n    color: LinearRgba,\n    is_red: bool,\n}\n\n// This key is used to identify a specific permutation of this material pipeline.\n// In this case, we specialize on whether or not to configure the \"IS_RED\" shader def.\n// Specialization keys should be kept as small / cheap to hash as possible,\n// as they will be used to look up the pipeline for each drawn entity with this material type.\n#[derive(Eq, PartialEq, Hash, Clone)]\nstruct CustomMaterialKey {\n    is_red: bool,\n}\n\nimpl From<&CustomMaterial> for CustomMaterialKey {\n    fn from(material: &CustomMaterial) -> Self {\n        Self {\n            is_red: material.is_red,\n        }\n    }\n}\n```\n</details>","closed_by":{"login":"superdump","id":302146,"node_id":"MDQ6VXNlcjMwMjE0Ng==","avatar_url":"https://avatars.githubusercontent.com/u/302146?v=4","gravatar_id":"","url":"https://api.github.com/users/superdump","html_url":"https://github.com/superdump","followers_url":"https://api.github.com/users/superdump/followers","following_url":"https://api.github.com/users/superdump/following{/other_user}","gists_url":"https://api.github.com/users/superdump/gists{/gist_id}","starred_url":"https://api.github.com/users/superdump/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/superdump/subscriptions","organizations_url":"https://api.github.com/users/superdump/orgs","repos_url":"https://api.github.com/users/superdump/repos","events_url":"https://api.github.com/users/superdump/events{/privacy}","received_events_url":"https://api.github.com/users/superdump/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/bevyengine/bevy/issues/17885/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/bevyengine/bevy/issues/17885/timeline","performed_via_github_app":null,"state_reason":"completed"}