{"url":"https://api.github.com/repos/bevyengine/bevy/issues/11969","repository_url":"https://api.github.com/repos/bevyengine/bevy","labels_url":"https://api.github.com/repos/bevyengine/bevy/issues/11969/labels{/name}","comments_url":"https://api.github.com/repos/bevyengine/bevy/issues/11969/comments","events_url":"https://api.github.com/repos/bevyengine/bevy/issues/11969/events","html_url":"https://github.com/bevyengine/bevy/issues/11969","id":2141290354,"node_id":"I_kwDODf6-U85_oX9y","number":11969,"title":"Deprecate current `bevy_dynamic_plugin` implementation","user":{"login":"BD103","id":59022059,"node_id":"MDQ6VXNlcjU5MDIyMDU5","avatar_url":"https://avatars.githubusercontent.com/u/59022059?v=4","gravatar_id":"","url":"https://api.github.com/users/BD103","html_url":"https://github.com/BD103","followers_url":"https://api.github.com/users/BD103/followers","following_url":"https://api.github.com/users/BD103/following{/other_user}","gists_url":"https://api.github.com/users/BD103/gists{/gist_id}","starred_url":"https://api.github.com/users/BD103/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BD103/subscriptions","organizations_url":"https://api.github.com/users/BD103/orgs","repos_url":"https://api.github.com/users/BD103/repos","events_url":"https://api.github.com/users/BD103/events{/privacy}","received_events_url":"https://api.github.com/users/BD103/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":3166125535,"node_id":"MDU6TGFiZWwzMTY2MTI1NTM1","url":"https://api.github.com/repos/bevyengine/bevy/labels/A-App","name":"A-App","color":"c6a751","default":false,"description":"Bevy apps and plugins"},{"id":4058407495,"node_id":"LA_kwDODf6-U87x5mJH","url":"https://api.github.com/repos/bevyengine/bevy/labels/X-Controversial","name":"X-Controversial","color":"D93F0B","default":false,"description":"There is active debate or serious implications around merging this PR"},{"id":4102809496,"node_id":"LA_kwDODf6-U870i-eY","url":"https://api.github.com/repos/bevyengine/bevy/labels/P-Unsound","name":"P-Unsound","color":"FF7b00","default":false,"description":"A bug that results in undefined compiler behavior"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2024-02-19T01:03:13Z","updated_at":"2024-05-20T20:15:56Z","closed_at":"2024-05-20T20:15:56Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## What problem does this solve or what need does it fill?\r\n\r\n[`bevy_dynamic_plugin`] is likely unsound, or at the very least so dangerous that it should not be an officially sanctioned crate. It currently works by deriving `bevy_app::DynamicPlugin` onto a unit struct that implements `Plugin`. The code can then be built as a `cdylib` and loaded with `bevy_dynamic_plugin::dynamically_load_plugin`.\r\n\r\n[`bevy_dynamic_plugin`]: https://github.com/bevyengine/bevy/tree/main/crates/bevy_dynamic_plugin\r\n\r\nThere are a few potential footguns / problems with this approach:\r\n\r\n- It works by loading and executing foreign code, which is drastically unsafe.\r\n  - Loading a library could run [`ctor`] code unconditionally, without calling any functions.\r\n- Plugins must be built with the exact same Bevy and Rust versions.\r\n  - This prevents plugins from taking advantage of new optimizations in the compiler and important bug fixes in Bevy.\r\n  - `#[derive(DynamicPlugin)]` creates `_bevy_create_plugin`, which returns `&'static dyn Plugin`. `dyn` references are fat pointers, where the metadata is a VTable. VTable layouts are not guaranteed.\r\n- Lots of Bevy uses generics and type-level code, especially in `App`.\r\n  - I don't believe Rust provides any guarantees with how generics / types are generated, even across compiles with the same version. (This needs fact-checked.)\r\n  - There's also a lot of `TypeId` usage. `TypePath` somewhat fixes this, but it's not used everywhere.\r\n\r\n[`ctor`]: https://lib.rs/crates/ctor\r\n\r\n## What solution would you like?\r\n\r\nMark `dynamically_load_plugin` and `DynamicPluginExt::load_plugin` as deprecated for Bevy 0.14. In Bevy 0.15, they will be removed and `bevy_dynamic_plugin` will be turned into an empty crate likely moved to [`bevy-crate-reservations`].\r\n\r\n[`bevy-crate-reservations`]: https://github.com/bevyengine/bevy-crate-reservations\r\n\r\nI think the current implementation is just too unsafe to continue in the main Bevy library. As [mentioned by Alice], it may be worth recommending [`dextrous_developer`] in the module or deprecation notes.\r\n\r\n[mentioned by Alice]: https://elk.zone/mastodon.gamedev.place/@alice_i_cecile/111919126897119034\r\n[`dextrous_developer`]: https://github.com/lee-orr/dexterous_developer\r\n\r\n## What alternative(s) have you considered?\r\n\r\nTry to fix the above issues by exclusively using `TypePath` instead of `TypeId` and manually recreating the VTable struct. ctor is unavoidable, we just have to hope it won't be encountered in practice.\r\n\r\n## Additional context\r\n\r\nSome discussion [on Discord] on `bevy_dynamic_plugin`, while I was working on #11622.\r\n\r\n[on Discord]: https://discord.com/channels/691052431525675048/692572690833473578/1201958798307369020\r\n\r\nI think there is promise is dynamically loading plugins, so I would not be opposed to `bevy_dynamic_plugin` being re-introduced in the future, but I don't think the current implementation should be kept.","closed_by":{"login":"mockersf","id":8672791,"node_id":"MDQ6VXNlcjg2NzI3OTE=","avatar_url":"https://avatars.githubusercontent.com/u/8672791?v=4","gravatar_id":"","url":"https://api.github.com/users/mockersf","html_url":"https://github.com/mockersf","followers_url":"https://api.github.com/users/mockersf/followers","following_url":"https://api.github.com/users/mockersf/following{/other_user}","gists_url":"https://api.github.com/users/mockersf/gists{/gist_id}","starred_url":"https://api.github.com/users/mockersf/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mockersf/subscriptions","organizations_url":"https://api.github.com/users/mockersf/orgs","repos_url":"https://api.github.com/users/mockersf/repos","events_url":"https://api.github.com/users/mockersf/events{/privacy}","received_events_url":"https://api.github.com/users/mockersf/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/bevyengine/bevy/issues/11969/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/bevyengine/bevy/issues/11969/timeline","performed_via_github_app":null,"state_reason":"completed"}