{"url":"https://api.github.com/repos/bevyengine/bevy/issues/15417","repository_url":"https://api.github.com/repos/bevyengine/bevy","labels_url":"https://api.github.com/repos/bevyengine/bevy/issues/15417/labels{/name}","comments_url":"https://api.github.com/repos/bevyengine/bevy/issues/15417/comments","events_url":"https://api.github.com/repos/bevyengine/bevy/issues/15417/events","html_url":"https://github.com/bevyengine/bevy/issues/15417","id":2547035148,"node_id":"I_kwDODf6-U86X0KwM","number":15417,"title":"Subassets of subassets do not work.","user":{"login":"andriyDev","id":22285953,"node_id":"MDQ6VXNlcjIyMjg1OTUz","avatar_url":"https://avatars.githubusercontent.com/u/22285953?v=4","gravatar_id":"","url":"https://api.github.com/users/andriyDev","html_url":"https://github.com/andriyDev","followers_url":"https://api.github.com/users/andriyDev/followers","following_url":"https://api.github.com/users/andriyDev/following{/other_user}","gists_url":"https://api.github.com/users/andriyDev/gists{/gist_id}","starred_url":"https://api.github.com/users/andriyDev/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/andriyDev/subscriptions","organizations_url":"https://api.github.com/users/andriyDev/orgs","repos_url":"https://api.github.com/users/andriyDev/repos","events_url":"https://api.github.com/users/andriyDev/events{/privacy}","received_events_url":"https://api.github.com/users/andriyDev/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":2272055462,"node_id":"MDU6TGFiZWwyMjcyMDU1NDYy","url":"https://api.github.com/repos/bevyengine/bevy/labels/A-Assets","name":"A-Assets","color":"c6a751","default":false,"description":"Load files from disk to use for things like images, models, and sounds"},{"id":2747857990,"node_id":"MDU6TGFiZWwyNzQ3ODU3OTkw","url":"https://api.github.com/repos/bevyengine/bevy/labels/C-Usability","name":"C-Usability","color":"b8b8b8","default":false,"description":"A targeted quality-of-life change that makes Bevy easier to use"},{"id":3166133948,"node_id":"MDU6TGFiZWwzMTY2MTMzOTQ4","url":"https://api.github.com/repos/bevyengine/bevy/labels/M-Migration-Guide","name":"M-Migration-Guide","color":"006B75","default":false,"description":"A breaking change to Bevy's public API that needs to be noted in a migration guide"},{"id":3166152189,"node_id":"MDU6TGFiZWwzMTY2MTUyMTg5","url":"https://api.github.com/repos/bevyengine/bevy/labels/S-Needs-Design","name":"S-Needs-Design","color":"D876E3","default":false,"description":"This issue requires design work to think about how it would best be accomplished"},{"id":4058407495,"node_id":"LA_kwDODf6-U87x5mJH","url":"https://api.github.com/repos/bevyengine/bevy/labels/X-Controversial","name":"X-Controversial","color":"D93F0B","default":false,"description":"There is active debate or serious implications around merging this PR"},{"id":6899576022,"node_id":"LA_kwDODf6-U88AAAABmz8s1g","url":"https://api.github.com/repos/bevyengine/bevy/labels/D-Modest","name":"D-Modest","color":"008672","default":false,"description":"A \"normal\" level of difficulty; suitable for simple features or challenging fixes"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2024-09-25T06:15:55Z","updated_at":"2025-02-10T21:24:26Z","closed_at":"2025-02-10T21:24:26Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## Problem\r\n\r\nToday, `ErasedLoadedAsset` holds the asset as `Box<dyn AssetContainer>`, and holds subassets as `HashMap<String, ErasedLoadedAsset>` (not really, but for simplicity, this is true). This means that subassets can themselves hold subassets, and so on, and so on. This makes it very confusing when you find out that these \"nested subassets\" get \"flattened\" when they get inserted by the `AssetServer`. For example, consider the following loader:\r\n\r\n```rust\r\nasync fn load(load_context: &mut LoadContext) -> Result<Self::Asset, Self::Error> {\r\n    load_context.add_labeled_asset(\"A\".into(), Self::Asset(1));\r\n    load_context.labeled_asset_scope(\"B\".into(), |load_context| {\r\n        // This asset replaces the \"root\" subasset labeled \"A\"\r\n        load_context.add_labeled_asset(\"A\".into(), Self::Asset(2));\r\n        Self::Asset(3)\r\n    });\r\n    Ok(Self::Asset(4))\r\n}\r\n```\r\n\r\nThe `ErasedLoadedAsset` for this looks like:\r\n\r\n```ron\r\n{\r\n    value: SomeAsset(4),\r\n    labeled_assets: {\r\n        \"A\": ErasedLoadedAsset {\r\n            value: SomeAsset(1),\r\n        },\r\n        \"B\": ErasedLoadedAsset {\r\n            value: SomeAsset(3),\r\n            labeled_assets: {\r\n                \"A\": ErasedLoadedAsset {\r\n                    value: SomeAsset(2)\r\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\n```\r\n\r\nThe resulting Assets would be:\r\n\r\n```ron\r\n{\r\n    \"my_asset.blah\": SomeAsset(4),\r\n    \"my_asset.blah#A\": SomeAsset(2),\r\n    \"my_asset.blah#B\": SomeAsset(3),\r\n}\r\n```\r\n\r\n## What solution would you like?\r\n\r\n1. Remove `labeled_assets` from `ErasedLoadedAsset`/`LoadedAsset `and propagate it separately. The hashmap of labeled assets should continue to just use `ErasedLoadedAsset`.\r\n2. Make the `LoadContext::labeled_asset_scope` (and related) merge the current and the new set of subassets.\r\n\r\n    1. We could consider disallowing subassets to themselves load subassets (though this is likely not desirable)\r\n    2. Overwriting a subasset should probably be a warning or maybe even a panic.\r\n    \r\n3. Make `AssetServer::send_loaded_asset` no longer recursive.\r\n\r\n## What alternative(s) have you considered?\r\n\r\nDo nothing. Keep the confusing behavior. This is only an issue if, in an asset loader, in a `LoadContext::labeled_asset_scope` (or equivalent), a subasset shares a name with a previously added subasset.\r\n\r\nAnother alternative: Make them actually work! We could create some notation to support nested subassets in `AssetPath` (for example, \"my_asset.blah#A#B#C\" or maybe \"my_asset.blah#A/B/C\"). It's not clear that this is something anyone wants or needs, so the complexity seems unwarranted.\r\n","closed_by":{"login":"alice-i-cecile","id":3579909,"node_id":"MDQ6VXNlcjM1Nzk5MDk=","avatar_url":"https://avatars.githubusercontent.com/u/3579909?v=4","gravatar_id":"","url":"https://api.github.com/users/alice-i-cecile","html_url":"https://github.com/alice-i-cecile","followers_url":"https://api.github.com/users/alice-i-cecile/followers","following_url":"https://api.github.com/users/alice-i-cecile/following{/other_user}","gists_url":"https://api.github.com/users/alice-i-cecile/gists{/gist_id}","starred_url":"https://api.github.com/users/alice-i-cecile/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alice-i-cecile/subscriptions","organizations_url":"https://api.github.com/users/alice-i-cecile/orgs","repos_url":"https://api.github.com/users/alice-i-cecile/repos","events_url":"https://api.github.com/users/alice-i-cecile/events{/privacy}","received_events_url":"https://api.github.com/users/alice-i-cecile/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/bevyengine/bevy/issues/15417/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/bevyengine/bevy/issues/15417/timeline","performed_via_github_app":null,"state_reason":"completed"}