{"url":"https://api.github.com/repos/bevyengine/bevy/issues/20804","repository_url":"https://api.github.com/repos/bevyengine/bevy","labels_url":"https://api.github.com/repos/bevyengine/bevy/issues/20804/labels{/name}","comments_url":"https://api.github.com/repos/bevyengine/bevy/issues/20804/comments","events_url":"https://api.github.com/repos/bevyengine/bevy/issues/20804/events","html_url":"https://github.com/bevyengine/bevy/issues/20804","id":3369584054,"node_id":"I_kwDODf6-U87I18W2","number":20804,"title":"Memory leak in bevy_pbr","user":{"login":"ed-2100","id":81470842,"node_id":"MDQ6VXNlcjgxNDcwODQy","avatar_url":"https://avatars.githubusercontent.com/u/81470842?v=4","gravatar_id":"","url":"https://api.github.com/users/ed-2100","html_url":"https://github.com/ed-2100","followers_url":"https://api.github.com/users/ed-2100/followers","following_url":"https://api.github.com/users/ed-2100/following{/other_user}","gists_url":"https://api.github.com/users/ed-2100/gists{/gist_id}","starred_url":"https://api.github.com/users/ed-2100/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ed-2100/subscriptions","organizations_url":"https://api.github.com/users/ed-2100/orgs","repos_url":"https://api.github.com/users/ed-2100/repos","events_url":"https://api.github.com/users/ed-2100/events{/privacy}","received_events_url":"https://api.github.com/users/ed-2100/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1795619323,"node_id":"MDU6TGFiZWwxNzk1NjE5MzIz","url":"https://api.github.com/repos/bevyengine/bevy/labels/C-Bug","name":"C-Bug","color":"d73a4a","default":false,"description":"An unexpected or incorrect behavior"},{"id":2045383863,"node_id":"MDU6TGFiZWwyMDQ1MzgzODYz","url":"https://api.github.com/repos/bevyengine/bevy/labels/A-Rendering","name":"A-Rendering","color":"C6A751","default":false,"description":"Drawing game state to the screen"},{"id":2272098452,"node_id":"MDU6TGFiZWwyMjcyMDk4NDUy","url":"https://api.github.com/repos/bevyengine/bevy/labels/C-Performance","name":"C-Performance","color":"B8B8B8","default":false,"description":"A change motivated by improving speed, memory usage or compile times"},{"id":3166151441,"node_id":"MDU6TGFiZWwzMTY2MTUxNDQx","url":"https://api.github.com/repos/bevyengine/bevy/labels/S-Ready-For-Implementation","name":"S-Ready-For-Implementation","color":"D876E3","default":false,"description":"This issue is ready for an implementation PR. Go for it!"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/bevyengine/bevy/milestones/32","html_url":"https://github.com/bevyengine/bevy/milestone/32","labels_url":"https://api.github.com/repos/bevyengine/bevy/milestones/32/labels","id":12377016,"node_id":"MI_kwDODf6-U84AvNu4","number":32,"title":"0.17","description":"","creator":{"login":"alice-i-cecile","id":3579909,"node_id":"MDQ6VXNlcjM1Nzk5MDk=","avatar_url":"https://avatars.githubusercontent.com/u/3579909?v=4","gravatar_id":"","url":"https://api.github.com/users/alice-i-cecile","html_url":"https://github.com/alice-i-cecile","followers_url":"https://api.github.com/users/alice-i-cecile/followers","following_url":"https://api.github.com/users/alice-i-cecile/following{/other_user}","gists_url":"https://api.github.com/users/alice-i-cecile/gists{/gist_id}","starred_url":"https://api.github.com/users/alice-i-cecile/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alice-i-cecile/subscriptions","organizations_url":"https://api.github.com/users/alice-i-cecile/orgs","repos_url":"https://api.github.com/users/alice-i-cecile/repos","events_url":"https://api.github.com/users/alice-i-cecile/events{/privacy}","received_events_url":"https://api.github.com/users/alice-i-cecile/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":584,"state":"closed","created_at":"2025-02-24T21:56:04Z","updated_at":"2025-09-30T22:33:43Z","due_on":null,"closed_at":"2025-09-30T22:33:43Z"},"comments":3,"created_at":"2025-08-30T23:05:11Z","updated_at":"2025-08-31T16:27:00Z","closed_at":"2025-08-31T16:27:00Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## Bevy version and features\n\n94bb6e158535f6f484c7750bf84a274e67766656 w/ default features.\n\n## What I did\n\nI made a basic bevy app with default plugins and ran it.\n\n## What went wrong\n\nI witnessed unbounded memory growth in my task manager and then proceeded to debug bevy using the following steps:\n\n1. `valgrind --tool=massif --time-unit=ms target/debug/my_app`\n2. `massif-visualizer $MY_MASSIF_FILE`\n3. Found that process_queue() in `crates/bevy_render/src/render_resource/pipeline_cache.rs` was processing pipelines without me doing anything.\n4. I proceeded to use lldb-dap to trace the calls from `process_queue()` to `queue_atmosphere_probe_pipelines`.\n\nIn `crates/bevy_pbr/src/atmosphere/environment.rs`:\n```rs\npub fn queue_atmosphere_probe_pipelines(\n    pipeline_cache: Res<PipelineCache>,\n    layouts: Res<AtmosphereProbeLayouts>,\n    asset_server: Res<AssetServer>,\n    mut commands: Commands,\n) {\n    let environment = pipeline_cache.queue_compute_pipeline(ComputePipelineDescriptor {\n        label: Some(\"environment_pipeline\".into()),\n        layout: vec![layouts.environment.clone()],\n        shader: load_embedded_asset!(asset_server.as_ref(), \"environment.wgsl\"),\n        ..default()\n    });\n    commands.insert_resource(AtmosphereProbePipelines { environment });\n}\n```\n\nThis function is getting called in the `Render` schedule in the `Queue` phase.\n\nIn `crates/bevy_pbr/src/atmosphere/mod.rs`:\n```rs\n            .add_systems(\n                Render,\n                (\n                    configure_camera_depth_usages.in_set(RenderSystems::ManageViews),\n                    queue_render_sky_pipelines.in_set(RenderSystems::Queue),\n                    prepare_atmosphere_textures.in_set(RenderSystems::PrepareResources),\n                    prepare_probe_textures\n                        .in_set(RenderSystems::PrepareResources)\n                        .after(prepare_atmosphere_textures),\n                    prepare_atmosphere_probe_bind_groups.in_set(RenderSystems::PrepareBindGroups),\n                    queue_atmosphere_probe_pipelines // Problematic line here\n                        .in_set(RenderSystems::Queue)\n                        .after(init_atmosphere_probe_layout),\n                    prepare_atmosphere_transforms.in_set(RenderSystems::PrepareResources),\n                    prepare_atmosphere_bind_groups.in_set(RenderSystems::PrepareBindGroups),\n                ),\n            )\n```\n\nI'm not really familiar with this code, so I don't really know how to fix it, but here's an issue so somebody who knows how to can.\n\nI also saw some other suspicious calls in massif, but one step at a time.","closed_by":{"login":"mockersf","id":8672791,"node_id":"MDQ6VXNlcjg2NzI3OTE=","avatar_url":"https://avatars.githubusercontent.com/u/8672791?v=4","gravatar_id":"","url":"https://api.github.com/users/mockersf","html_url":"https://github.com/mockersf","followers_url":"https://api.github.com/users/mockersf/followers","following_url":"https://api.github.com/users/mockersf/following{/other_user}","gists_url":"https://api.github.com/users/mockersf/gists{/gist_id}","starred_url":"https://api.github.com/users/mockersf/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mockersf/subscriptions","organizations_url":"https://api.github.com/users/mockersf/orgs","repos_url":"https://api.github.com/users/mockersf/repos","events_url":"https://api.github.com/users/mockersf/events{/privacy}","received_events_url":"https://api.github.com/users/mockersf/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/bevyengine/bevy/issues/20804/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/bevyengine/bevy/issues/20804/timeline","performed_via_github_app":null,"state_reason":"completed"}