{"url":"https://api.github.com/repos/bevyengine/bevy/issues/16594","repository_url":"https://api.github.com/repos/bevyengine/bevy","labels_url":"https://api.github.com/repos/bevyengine/bevy/issues/16594/labels{/name}","comments_url":"https://api.github.com/repos/bevyengine/bevy/issues/16594/comments","events_url":"https://api.github.com/repos/bevyengine/bevy/issues/16594/events","html_url":"https://github.com/bevyengine/bevy/issues/16594","id":2710143036,"node_id":"I_kwDODf6-U86hiYA8","number":16594,"title":"Make `StateTransitionSteps` public for better ergonomics of State Scoped Resources","user":{"login":"Phoqinu","id":176324086,"node_id":"U_kgDOCoJ99g","avatar_url":"https://avatars.githubusercontent.com/u/176324086?v=4","gravatar_id":"","url":"https://api.github.com/users/Phoqinu","html_url":"https://github.com/Phoqinu","followers_url":"https://api.github.com/users/Phoqinu/followers","following_url":"https://api.github.com/users/Phoqinu/following{/other_user}","gists_url":"https://api.github.com/users/Phoqinu/gists{/gist_id}","starred_url":"https://api.github.com/users/Phoqinu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Phoqinu/subscriptions","organizations_url":"https://api.github.com/users/Phoqinu/orgs","repos_url":"https://api.github.com/users/Phoqinu/repos","events_url":"https://api.github.com/users/Phoqinu/events{/privacy}","received_events_url":"https://api.github.com/users/Phoqinu/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1795619327,"node_id":"MDU6TGFiZWwxNzk1NjE5MzI3","url":"https://api.github.com/repos/bevyengine/bevy/labels/D-Trivial","name":"D-Trivial","color":"008672","default":false,"description":"Nice and easy! A great choice to get started with Bevy"},{"id":2747857990,"node_id":"MDU6TGFiZWwyNzQ3ODU3OTkw","url":"https://api.github.com/repos/bevyengine/bevy/labels/C-Usability","name":"C-Usability","color":"b8b8b8","default":false,"description":"A targeted quality-of-life change that makes Bevy easier to use"},{"id":3166151441,"node_id":"MDU6TGFiZWwzMTY2MTUxNDQx","url":"https://api.github.com/repos/bevyengine/bevy/labels/S-Ready-For-Implementation","name":"S-Ready-For-Implementation","color":"D876E3","default":false,"description":"This issue is ready for an implementation PR. Go for it!"},{"id":7257627940,"node_id":"LA_kwDODf6-U88AAAABsJadJA","url":"https://api.github.com/repos/bevyengine/bevy/labels/A-States","name":"A-States","color":"c6a751","default":false,"description":"App-level states machines"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2024-12-02T00:50:20Z","updated_at":"2024-12-03T20:09:24Z","closed_at":"2024-12-03T20:09:24Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## What problem does this solve or what need does it fill?\n\nAs of `0.15` `Entity`s and `Event`s can be bound to a state.\nEntities will be despawned on state exit and events will be initialized and cleaned-up on state exit.\nThere's no official way of doing this for resources but we can make our own.\n\nConsider this naive impl: \n```rust\nfn init_state_scoped_resource<R: Resource + FromWorld>(\n        &mut self,\n        state: impl States,\n    ) -> &mut Self {\n        self.add_systems(OnEnter(state.clone()), init_state_scoped_resource_impl::<_, R>(state.clone()));\n        self.add_systems(OnExit(state.clone()), clear_state_scoped_resource_impl::<_, R>(state));\n        self\n}\n```\n\n```rust\napp.init_state_scoped_resource::<Foo>(BazState::Bar);\n```\nWhile it does work it can race with this system:\n```rust\napp.add_systems(OnEnter(BazState::Bar), |foo: Res<Foo>| {});\n```\n\n## What solution would you like?\n\nThere are 3 solutions I can think of:\n1. Keep using naive OnEnter/OnExit and offer some `SystemSet` to let users (me) order racy systems but this is imo quite un-ergonomic and error prone - you can forget to do it.\n2. Switch OnEnter/OnExit schedules to `StateTransition` schedule and modify inner init/clear fns to behave like [clear_state_scoped_entities](https://github.com/bevyengine/bevy/blob/56d559102858d4ce8a5b5e3bccd7053dd687a197/crates/bevy_state/src/state_scoped.rs#L67). This fixes possible race and there's no need to offer system set but it will behave differently than other systems running in that schedule and I'm not sure what effects it could have.\n3. Like 2. + add `.in_set(StateTransitionSteps::EnterSchedules)` and `.in_set(StateTransitionSteps::ExitSchedules)` to user-defined `init_state_scoped_resource` inner fns. This will offer the \"best\" compatibility out of the mentioned 3 but it's not possible because `StateTransitionSteps` is [private](https://github.com/bevyengine/bevy/blob/56d559102858d4ce8a5b5e3bccd7053dd687a197/crates/bevy_state/src/state/transitions.rs#L71).\n\n## What alternative(s) have you considered?\n\nI can't think of other alternatives.\n\n## Additional context\n\nNone.\n","closed_by":{"login":"alice-i-cecile","id":3579909,"node_id":"MDQ6VXNlcjM1Nzk5MDk=","avatar_url":"https://avatars.githubusercontent.com/u/3579909?v=4","gravatar_id":"","url":"https://api.github.com/users/alice-i-cecile","html_url":"https://github.com/alice-i-cecile","followers_url":"https://api.github.com/users/alice-i-cecile/followers","following_url":"https://api.github.com/users/alice-i-cecile/following{/other_user}","gists_url":"https://api.github.com/users/alice-i-cecile/gists{/gist_id}","starred_url":"https://api.github.com/users/alice-i-cecile/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alice-i-cecile/subscriptions","organizations_url":"https://api.github.com/users/alice-i-cecile/orgs","repos_url":"https://api.github.com/users/alice-i-cecile/repos","events_url":"https://api.github.com/users/alice-i-cecile/events{/privacy}","received_events_url":"https://api.github.com/users/alice-i-cecile/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/bevyengine/bevy/issues/16594/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/bevyengine/bevy/issues/16594/timeline","performed_via_github_app":null,"state_reason":"completed"}