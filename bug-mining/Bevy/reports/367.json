{"url":"https://api.github.com/repos/bevyengine/bevy/issues/14348","repository_url":"https://api.github.com/repos/bevyengine/bevy","labels_url":"https://api.github.com/repos/bevyengine/bevy/issues/14348/labels{/name}","comments_url":"https://api.github.com/repos/bevyengine/bevy/issues/14348/comments","events_url":"https://api.github.com/repos/bevyengine/bevy/issues/14348/events","html_url":"https://github.com/bevyengine/bevy/issues/14348","id":2411348493,"node_id":"I_kwDODf6-U86PukIN","number":14348,"title":"Unsoundness in dynamic queries: sparse filters are ignored if the typed query is dense","user":{"login":"SkiFire13","id":9020423,"node_id":"MDQ6VXNlcjkwMjA0MjM=","avatar_url":"https://avatars.githubusercontent.com/u/9020423?v=4","gravatar_id":"","url":"https://api.github.com/users/SkiFire13","html_url":"https://github.com/SkiFire13","followers_url":"https://api.github.com/users/SkiFire13/followers","following_url":"https://api.github.com/users/SkiFire13/following{/other_user}","gists_url":"https://api.github.com/users/SkiFire13/gists{/gist_id}","starred_url":"https://api.github.com/users/SkiFire13/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SkiFire13/subscriptions","organizations_url":"https://api.github.com/users/SkiFire13/orgs","repos_url":"https://api.github.com/users/SkiFire13/repos","events_url":"https://api.github.com/users/SkiFire13/events{/privacy}","received_events_url":"https://api.github.com/users/SkiFire13/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1795619323,"node_id":"MDU6TGFiZWwxNzk1NjE5MzIz","url":"https://api.github.com/repos/bevyengine/bevy/labels/C-Bug","name":"C-Bug","color":"d73a4a","default":false,"description":"An unexpected or incorrect behavior"},{"id":2197761682,"node_id":"MDU6TGFiZWwyMTk3NzYxNjgy","url":"https://api.github.com/repos/bevyengine/bevy/labels/A-ECS","name":"A-ECS","color":"c6a751","default":false,"description":"Entities, components, systems, and events"},{"id":4102809496,"node_id":"LA_kwDODf6-U870i-eY","url":"https://api.github.com/repos/bevyengine/bevy/labels/P-Unsound","name":"P-Unsound","color":"FF7b00","default":false,"description":"A bug that results in undefined compiler behavior"},{"id":6899583116,"node_id":"LA_kwDODf6-U88AAAABmz9IjA","url":"https://api.github.com/repos/bevyengine/bevy/labels/D-Unsafe","name":"D-Unsafe","color":"008672","default":false,"description":"Touches with unsafe code in some way"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/bevyengine/bevy/milestones/24","html_url":"https://github.com/bevyengine/bevy/milestone/24","labels_url":"https://api.github.com/repos/bevyengine/bevy/milestones/24/labels","id":11048296,"node_id":"MI_kwDODf6-U84AqJVo","number":24,"title":"0.15","description":"","creator":{"login":"alice-i-cecile","id":3579909,"node_id":"MDQ6VXNlcjM1Nzk5MDk=","avatar_url":"https://avatars.githubusercontent.com/u/3579909?v=4","gravatar_id":"","url":"https://api.github.com/users/alice-i-cecile","html_url":"https://github.com/alice-i-cecile","followers_url":"https://api.github.com/users/alice-i-cecile/followers","following_url":"https://api.github.com/users/alice-i-cecile/following{/other_user}","gists_url":"https://api.github.com/users/alice-i-cecile/gists{/gist_id}","starred_url":"https://api.github.com/users/alice-i-cecile/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alice-i-cecile/subscriptions","organizations_url":"https://api.github.com/users/alice-i-cecile/orgs","repos_url":"https://api.github.com/users/alice-i-cecile/repos","events_url":"https://api.github.com/users/alice-i-cecile/events{/privacy}","received_events_url":"https://api.github.com/users/alice-i-cecile/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":550,"state":"closed","created_at":"2024-05-13T18:42:18Z","updated_at":"2024-11-30T03:58:51Z","due_on":null,"closed_at":"2024-11-29T22:40:27Z"},"comments":10,"created_at":"2024-07-16T14:42:12Z","updated_at":"2024-08-27T01:14:44Z","closed_at":"2024-08-27T01:14:44Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## Bevy version\r\n\r\nBoth 0.14.0 and af865e76a323fc87dd16157e7f4d7593d02c2b95\r\n\r\n## What you did\r\n\r\n```rs\r\n#[derive(Component)]\r\nstruct Dense;\r\n\r\n#[derive(Component)]\r\n#[component(storage = \"SparseSet\")]\r\nstruct Sparse;\r\n\r\nlet mut world = World::new();\r\n\r\nworld.spawn(Dense);\r\nworld.spawn((Dense, Sparse));\r\n\r\n// How this is not working as intended:\r\nlet mut query = QueryBuilder::<&Dense>::new(&mut world)\r\n    .without::<Sparse>()\r\n    .build();\r\n// Prints 2 but only 1 entity should be matched.\r\ndbg!(query.iter(&world).count());\r\n\r\n// How this is unsound:\r\nfn sys(q1: Query<&mut Dense, With<Sparse>>, q2: Query<(Entity, &mut Dense)>) {\r\n    for (entity, _) in &q2 {\r\n        assert!(!q1.contains(entity));\r\n    }\r\n}\r\nSystemBuilder::<(Query<&mut Dense, With<Sparse>>,)>::new(&mut world)\r\n    .builder::<Query<(Entity, &mut Dense)>>(|builder| {\r\n        builder.without::<Sparse>();\r\n    })\r\n    .build(sys)\r\n    .run((), &mut world);\r\n```\r\n\r\n## What went wrong\r\n\r\nIn the simple demonstration the query contains 2 entities, but only 1 should match all the filters. The reason both are yielded is because the static part of the query is dense and so the dense iteration optimization kick in and iterates over the table matching it. But doing so completly ignores the filter on the sparse component.\r\n\r\nIn the soundness issue this is exploited in a dynamic system where the sparse filter is used to make the two queries disjoint, which is however broken by the bug just showed.","closed_by":{"login":"alice-i-cecile","id":3579909,"node_id":"MDQ6VXNlcjM1Nzk5MDk=","avatar_url":"https://avatars.githubusercontent.com/u/3579909?v=4","gravatar_id":"","url":"https://api.github.com/users/alice-i-cecile","html_url":"https://github.com/alice-i-cecile","followers_url":"https://api.github.com/users/alice-i-cecile/followers","following_url":"https://api.github.com/users/alice-i-cecile/following{/other_user}","gists_url":"https://api.github.com/users/alice-i-cecile/gists{/gist_id}","starred_url":"https://api.github.com/users/alice-i-cecile/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alice-i-cecile/subscriptions","organizations_url":"https://api.github.com/users/alice-i-cecile/orgs","repos_url":"https://api.github.com/users/alice-i-cecile/repos","events_url":"https://api.github.com/users/alice-i-cecile/events{/privacy}","received_events_url":"https://api.github.com/users/alice-i-cecile/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/bevyengine/bevy/issues/14348/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/bevyengine/bevy/issues/14348/timeline","performed_via_github_app":null,"state_reason":"completed"}