{"url":"https://api.github.com/repos/bevyengine/bevy/issues/21526","repository_url":"https://api.github.com/repos/bevyengine/bevy","labels_url":"https://api.github.com/repos/bevyengine/bevy/issues/21526/labels{/name}","comments_url":"https://api.github.com/repos/bevyengine/bevy/issues/21526/comments","events_url":"https://api.github.com/repos/bevyengine/bevy/issues/21526/events","html_url":"https://github.com/bevyengine/bevy/issues/21526","id":3509324420,"node_id":"I_kwDODf6-U87RLAqE","number":21526,"title":"Memory leak in `EntitySpecializationTicks` when a material uses `NotShadowCaster`","user":{"login":"EmbersArc","id":1352472,"node_id":"MDQ6VXNlcjEzNTI0NzI=","avatar_url":"https://avatars.githubusercontent.com/u/1352472?v=4","gravatar_id":"","url":"https://api.github.com/users/EmbersArc","html_url":"https://github.com/EmbersArc","followers_url":"https://api.github.com/users/EmbersArc/followers","following_url":"https://api.github.com/users/EmbersArc/following{/other_user}","gists_url":"https://api.github.com/users/EmbersArc/gists{/gist_id}","starred_url":"https://api.github.com/users/EmbersArc/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/EmbersArc/subscriptions","organizations_url":"https://api.github.com/users/EmbersArc/orgs","repos_url":"https://api.github.com/users/EmbersArc/repos","events_url":"https://api.github.com/users/EmbersArc/events{/privacy}","received_events_url":"https://api.github.com/users/EmbersArc/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1795619323,"node_id":"MDU6TGFiZWwxNzk1NjE5MzIz","url":"https://api.github.com/repos/bevyengine/bevy/labels/C-Bug","name":"C-Bug","color":"d73a4a","default":false,"description":"An unexpected or incorrect behavior"},{"id":2045383863,"node_id":"MDU6TGFiZWwyMDQ1MzgzODYz","url":"https://api.github.com/repos/bevyengine/bevy/labels/A-Rendering","name":"A-Rendering","color":"C6A751","default":false,"description":"Drawing game state to the screen"},{"id":2272098452,"node_id":"MDU6TGFiZWwyMjcyMDk4NDUy","url":"https://api.github.com/repos/bevyengine/bevy/labels/C-Performance","name":"C-Performance","color":"B8B8B8","default":false,"description":"A change motivated by improving speed, memory usage or compile times"},{"id":3166151441,"node_id":"MDU6TGFiZWwzMTY2MTUxNDQx","url":"https://api.github.com/repos/bevyengine/bevy/labels/S-Ready-For-Implementation","name":"S-Ready-For-Implementation","color":"D876E3","default":false,"description":"This issue is ready for an implementation PR. Go for it!"},{"id":6899576022,"node_id":"LA_kwDODf6-U88AAAABmz8s1g","url":"https://api.github.com/repos/bevyengine/bevy/labels/D-Modest","name":"D-Modest","color":"008672","default":false,"description":"A \"normal\" level of difficulty; suitable for simple features or challenging fixes"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/bevyengine/bevy/milestones/38","html_url":"https://github.com/bevyengine/bevy/milestone/38","labels_url":"https://api.github.com/repos/bevyengine/bevy/milestones/38/labels","id":13815567,"node_id":"MI_kwDODf6-U84A0s8P","number":38,"title":"0.17.3","description":"","creator":{"login":"mockersf","id":8672791,"node_id":"MDQ6VXNlcjg2NzI3OTE=","avatar_url":"https://avatars.githubusercontent.com/u/8672791?v=4","gravatar_id":"","url":"https://api.github.com/users/mockersf","html_url":"https://github.com/mockersf","followers_url":"https://api.github.com/users/mockersf/followers","following_url":"https://api.github.com/users/mockersf/following{/other_user}","gists_url":"https://api.github.com/users/mockersf/gists{/gist_id}","starred_url":"https://api.github.com/users/mockersf/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mockersf/subscriptions","organizations_url":"https://api.github.com/users/mockersf/orgs","repos_url":"https://api.github.com/users/mockersf/repos","events_url":"https://api.github.com/users/mockersf/events{/privacy}","received_events_url":"https://api.github.com/users/mockersf/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":11,"closed_issues":31,"state":"open","created_at":"2025-10-04T07:14:43Z","updated_at":"2025-11-09T20:05:46Z","due_on":null,"closed_at":null},"comments":4,"created_at":"2025-10-13T10:04:54Z","updated_at":"2025-11-09T18:15:54Z","closed_at":"2025-11-09T18:15:53Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## Bevy version and features\n\n0.17.2\n\n## What you did\n\nThis came out of a longer debugging session I \"documented\" in a [bluesky thread](https://bsky.app/profile/embersarc.bsky.social/post/3m2yef2dzqc22).\n\nEDIT: This has been fixed in https://github.com/bevyengine/bevy/pull/21410. See further down for a case that still leaks memory.\n\n```rust\n//! Example to reproduce memory leak issue.\n//!\nuse bevy::{\n    pbr::{ExtendedMaterial, MaterialExtension},\n    prelude::*,\n};\nuse bevy_render::render_resource::AsBindGroup;\n\nfn main() {\n    App::new()\n        .add_plugins(DefaultPlugins)\n        .add_plugins(MaterialPlugin::<MyExtendedMaterial1>::default())\n        // Issue goes away when only a single material is present.\n        .add_plugins(MaterialPlugin::<MyExtendedMaterial2>::default())\n        .init_resource::<Handles>()\n        .add_systems(Startup, setup)\n        .add_systems(Update, update)\n        .run();\n}\n\n#[derive(Resource)]\nstruct Handles(Handle<MyExtendedMaterial1>, Handle<Mesh>);\n\ntype MyExtendedMaterial1 = ExtendedMaterial<StandardMaterial, MyExtension1>;\n\n#[derive(Default, Clone, AsBindGroup, Asset, TypePath)]\nstruct MyExtension1 {}\n\nimpl MaterialExtension for MyExtension1 {}\n\ntype MyExtendedMaterial2 = ExtendedMaterial<StandardMaterial, MyExtension2>;\n\n#[derive(Default, Clone, AsBindGroup, Asset, TypePath)]\nstruct MyExtension2 {}\n\nimpl MaterialExtension for MyExtension2 {}\n\nimpl FromWorld for Handles {\n    fn from_world(world: &mut World) -> Self {\n        let material1_handle = world\n            .resource_mut::<Assets<MyExtendedMaterial1>>()\n            .add(MyExtendedMaterial1::default());\n        let mesh_handle = world.resource_mut::<Assets<Mesh>>().add(Cuboid::default());\n        Self(material1_handle, mesh_handle)\n    }\n}\n\nfn update(\n    mut commands: Commands,\n    existing_meshes: Query<Entity, With<MeshMaterial3d<MyExtendedMaterial1>>>,\n    handles: Res<Handles>,\n) {\n    dbg!(existing_meshes.count());\n\n    const COUNT: usize = 100;\n\n    for _ in 0..COUNT {\n        commands.spawn((Mesh3d(handles.1.clone()), MeshMaterial3d(handles.0.clone())));\n    }\n\n    existing_meshes\n        .iter()\n        .take(COUNT)\n        .for_each(|entity| commands.entity(entity).despawn());\n}\n\nfn setup(mut commands: Commands) {\n    commands.spawn((\n        Camera3d::default(),\n        Transform::from_xyz(0.0, 7., 14.0).looking_at(Vec3::new(0., 1., 0.), Vec3::Y),\n    ));\n}\n```\n\n## What went wrong\n\n`EntitySpecializationTicks` and `SpecializedMaterialPipelineCache` grow with each set of spawned/despawned entities, eventually slowing the systems that use them to a crawl.\n\nRunning `extract_entities_needs_specialization` explicitly after `early_sweep_material_instances` fixes the leaks.\n\n## However\n\nIn the presence of entities with a `NotShadowCaster` component, the `EntitySpecializationTicks` keep growing:\n\n```rust\n//! Example to reproduce memory leak issue.\n//!\nuse bevy::{\n    light::NotShadowCaster,\n    pbr::{ExtendedMaterial, MaterialExtension},\n    prelude::*,\n};\nuse bevy_render::render_resource::AsBindGroup;\n\nfn main() {\n    App::new()\n        .add_plugins(DefaultPlugins)\n        .add_plugins(MaterialPlugin::<MyExtendedMaterial1>::default())\n        // Issue goes away when only a single material is present.\n        .add_plugins(MaterialPlugin::<MyExtendedMaterial2>::default())\n        .init_resource::<Handles>()\n        .add_systems(Startup, setup)\n        .add_systems(Update, update)\n        .run();\n}\n\n#[derive(Resource)]\nstruct Handles(\n    Handle<MyExtendedMaterial1>,\n    Handle<MyExtendedMaterial2>,\n    Handle<Mesh>,\n);\n\ntype MyExtendedMaterial1 = ExtendedMaterial<StandardMaterial, MyExtension1>;\n\n#[derive(Default, Clone, AsBindGroup, Asset, TypePath)]\nstruct MyExtension1 {}\n\nimpl MaterialExtension for MyExtension1 {}\n\ntype MyExtendedMaterial2 = ExtendedMaterial<StandardMaterial, MyExtension2>;\n\n#[derive(Default, Clone, AsBindGroup, Asset, TypePath)]\nstruct MyExtension2 {}\n\nimpl MaterialExtension for MyExtension2 {}\n\nimpl FromWorld for Handles {\n    fn from_world(world: &mut World) -> Self {\n        let material1_handle = world\n            .resource_mut::<Assets<MyExtendedMaterial1>>()\n            .add(MyExtendedMaterial1::default());\n        let material2_handle = world\n            .resource_mut::<Assets<MyExtendedMaterial2>>()\n            .add(MyExtendedMaterial2::default());\n        let mesh_handle = world.resource_mut::<Assets<Mesh>>().add(Cuboid::default());\n        Self(material1_handle, material2_handle, mesh_handle)\n    }\n}\n\nfn update(\n    mut commands: Commands,\n    existing_meshes1: Query<Entity, With<MeshMaterial3d<MyExtendedMaterial1>>>,\n    existing_meshes2: Query<Entity, With<MeshMaterial3d<MyExtendedMaterial2>>>,\n    handles: Res<Handles>,\n) {\n    dbg!(existing_meshes1.count());\n    dbg!(existing_meshes2.count());\n\n    const COUNT: usize = 100;\n\n    for _ in 0..COUNT {\n        commands.spawn((Mesh3d(handles.2.clone()), MeshMaterial3d(handles.0.clone())));\n        commands.spawn((\n            Mesh3d(handles.2.clone()),\n            MeshMaterial3d(handles.1.clone()),\n            NotShadowCaster,\n        ));\n    }\n\n    existing_meshes1\n        .iter()\n        .take(COUNT)\n        .for_each(|entity| commands.entity(entity).despawn());\n    existing_meshes2\n        .iter()\n        .take(COUNT)\n        .for_each(|entity| commands.entity(entity).despawn());\n}\n\nfn setup(mut commands: Commands) {\n    commands.spawn((\n        Camera3d::default(),\n        Transform::from_xyz(0.0, 7., 14.0).looking_at(Vec3::new(0., 1., 0.), Vec3::Y),\n    ));\n}\n```\n\n## Additional context\n\nRelated: https://github.com/bevyengine/bevy/pull/21410","closed_by":{"login":"alice-i-cecile","id":3579909,"node_id":"MDQ6VXNlcjM1Nzk5MDk=","avatar_url":"https://avatars.githubusercontent.com/u/3579909?v=4","gravatar_id":"","url":"https://api.github.com/users/alice-i-cecile","html_url":"https://github.com/alice-i-cecile","followers_url":"https://api.github.com/users/alice-i-cecile/followers","following_url":"https://api.github.com/users/alice-i-cecile/following{/other_user}","gists_url":"https://api.github.com/users/alice-i-cecile/gists{/gist_id}","starred_url":"https://api.github.com/users/alice-i-cecile/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alice-i-cecile/subscriptions","organizations_url":"https://api.github.com/users/alice-i-cecile/orgs","repos_url":"https://api.github.com/users/alice-i-cecile/repos","events_url":"https://api.github.com/users/alice-i-cecile/events{/privacy}","received_events_url":"https://api.github.com/users/alice-i-cecile/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/bevyengine/bevy/issues/21526/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/bevyengine/bevy/issues/21526/timeline","performed_via_github_app":null,"state_reason":"completed"}