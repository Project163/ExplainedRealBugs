{"url":"https://api.github.com/repos/bevyengine/bevy/issues/21551","repository_url":"https://api.github.com/repos/bevyengine/bevy","labels_url":"https://api.github.com/repos/bevyengine/bevy/issues/21551/labels{/name}","comments_url":"https://api.github.com/repos/bevyengine/bevy/issues/21551/comments","events_url":"https://api.github.com/repos/bevyengine/bevy/issues/21551/events","html_url":"https://github.com/bevyengine/bevy/issues/21551","id":3515821657,"node_id":"I_kwDODf6-U87Rjy5Z","number":21551,"title":"Left shift arithmetic overflow in `bevy_pbr::lightmap`","user":{"login":"eira-fransham","id":29733394,"node_id":"MDQ6VXNlcjI5NzMzMzk0","avatar_url":"https://avatars.githubusercontent.com/u/29733394?v=4","gravatar_id":"","url":"https://api.github.com/users/eira-fransham","html_url":"https://github.com/eira-fransham","followers_url":"https://api.github.com/users/eira-fransham/followers","following_url":"https://api.github.com/users/eira-fransham/following{/other_user}","gists_url":"https://api.github.com/users/eira-fransham/gists{/gist_id}","starred_url":"https://api.github.com/users/eira-fransham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/eira-fransham/subscriptions","organizations_url":"https://api.github.com/users/eira-fransham/orgs","repos_url":"https://api.github.com/users/eira-fransham/repos","events_url":"https://api.github.com/users/eira-fransham/events{/privacy}","received_events_url":"https://api.github.com/users/eira-fransham/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1795619323,"node_id":"MDU6TGFiZWwxNzk1NjE5MzIz","url":"https://api.github.com/repos/bevyengine/bevy/labels/C-Bug","name":"C-Bug","color":"d73a4a","default":false,"description":"An unexpected or incorrect behavior"},{"id":2045383863,"node_id":"MDU6TGFiZWwyMDQ1MzgzODYz","url":"https://api.github.com/repos/bevyengine/bevy/labels/A-Rendering","name":"A-Rendering","color":"C6A751","default":false,"description":"Drawing game state to the screen"},{"id":2272057257,"node_id":"MDU6TGFiZWwyMjcyMDU3MjU3","url":"https://api.github.com/repos/bevyengine/bevy/labels/P-Crash","name":"P-Crash","color":"FF7b00","default":false,"description":"A sudden unexpected crash"},{"id":8535644019,"node_id":"LA_kwDODf6-U88AAAAB_MOXcw","url":"https://api.github.com/repos/bevyengine/bevy/labels/S-Needs-Reproduction","name":"S-Needs-Reproduction","color":"D876E3","default":false,"description":"Needs an up-to-date or minimal reproduction"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2025-10-14T23:23:12Z","updated_at":"2025-10-16T21:28:25Z","closed_at":"2025-10-16T21:28:25Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## Bevy version\n\n- Bevy 0.17.2\n\n#### Features\n\n- `bevy_reflect`: `features = [\"glam\"]`\n- `bevy_math`: `features = [\"serialize\", \"bevy_reflect\"]`\n\nI would be surprised if these are related, but they are included for completeness.\n\n#### Adapter info\n\n```ignore\nAdapterInfo { name: \"Intel(R) Graphics (RPL-P)\", vendor: 32902, device: 42912, device_type: IntegratedGpu, driver: \"Intel open-source Mesa driver\", driver_info: \"Mesa 22.3.6\", backend: Vulkan }\n```\n\n## What you did\n\nUsing `bevy_trenchbroom` to load BSP files into Bevy. Specifically, the lightmaps are from `bevy_trenchbroom::bsp::lighting::types::AnimatedLighting`.\n\n- [ ] _TODO_: Investigate exactly how the lightmaps end up in `bevy_pbr`.\n\n## What went wrong\n\nI get a panic in `bevy_pbr` seemingly at random, with the following message:\n\n```ignore\nthread 'Compute Task Pool (6)' (442851) panicked at /home/eira/Github/bevy/crates/bevy_pbr/src/lightmap/mod.rs:421:37:\nattempt to shift left with overflow\nnote: run with `RUST_BACKTRACE=1` environment variable to display a backtrace\nEncountered a panic in system `bevy_pbr::lightmap::extract_lightmaps`!\n```\n\nIt does not seem to be related to which map I try to load, as the same map may sometimes cause the crash and sometimes not. I originally thought it was due to https://github.com/bevyengine/bevy/issues/12756 causing Bevy to load the same map multiple times (and therefore creating too many copies of the lightmap), but even after applying https://github.com/bevyengine/bevy/pull/20449 locally (which fixes the issue) the crash in the lightmap allocation appears to still happen. It also appears to occasionally happen when loading the first map, which could rule out the possibility of the old map not being fully deloaded before the next is loaded. \n\nThe path shows a local checkout of Bevy due to applying #20449. Otherwise the branch is identical to the `release-0.17.2` branch, specifically commit 566358363126dd69f6e457e47f306c68f8041d2a.\n\n## Additional information\n\nIt's possible that this is a bug in `bevy_trenchbroom`, but I have not yet had time to investigate that. Either way, this seems like it should cause Bevy to produce an error message rather than hard-crashing. If I have time I'll try to put together a quick fix that at least prevents the panic.","closed_by":{"login":"alice-i-cecile","id":3579909,"node_id":"MDQ6VXNlcjM1Nzk5MDk=","avatar_url":"https://avatars.githubusercontent.com/u/3579909?v=4","gravatar_id":"","url":"https://api.github.com/users/alice-i-cecile","html_url":"https://github.com/alice-i-cecile","followers_url":"https://api.github.com/users/alice-i-cecile/followers","following_url":"https://api.github.com/users/alice-i-cecile/following{/other_user}","gists_url":"https://api.github.com/users/alice-i-cecile/gists{/gist_id}","starred_url":"https://api.github.com/users/alice-i-cecile/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alice-i-cecile/subscriptions","organizations_url":"https://api.github.com/users/alice-i-cecile/orgs","repos_url":"https://api.github.com/users/alice-i-cecile/repos","events_url":"https://api.github.com/users/alice-i-cecile/events{/privacy}","received_events_url":"https://api.github.com/users/alice-i-cecile/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/bevyengine/bevy/issues/21551/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/bevyengine/bevy/issues/21551/timeline","performed_via_github_app":null,"state_reason":"completed"}