{"url":"https://api.github.com/repos/bevyengine/bevy/issues/13329","repository_url":"https://api.github.com/repos/bevyengine/bevy","labels_url":"https://api.github.com/repos/bevyengine/bevy/issues/13329/labels{/name}","comments_url":"https://api.github.com/repos/bevyengine/bevy/issues/13329/comments","events_url":"https://api.github.com/repos/bevyengine/bevy/issues/13329/events","html_url":"https://github.com/bevyengine/bevy/issues/13329","id":2291016743,"node_id":"I_kwDODf6-U86IjiQn","number":13329,"title":"Implement `WorldQuery` and `QueryData` for `Mut`","user":{"login":"Themayu","id":16105710,"node_id":"MDQ6VXNlcjE2MTA1NzEw","avatar_url":"https://avatars.githubusercontent.com/u/16105710?v=4","gravatar_id":"","url":"https://api.github.com/users/Themayu","html_url":"https://github.com/Themayu","followers_url":"https://api.github.com/users/Themayu/followers","following_url":"https://api.github.com/users/Themayu/following{/other_user}","gists_url":"https://api.github.com/users/Themayu/gists{/gist_id}","starred_url":"https://api.github.com/users/Themayu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Themayu/subscriptions","organizations_url":"https://api.github.com/users/Themayu/orgs","repos_url":"https://api.github.com/users/Themayu/repos","events_url":"https://api.github.com/users/Themayu/events{/privacy}","received_events_url":"https://api.github.com/users/Themayu/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1795619326,"node_id":"MDU6TGFiZWwxNzk1NjE5MzI2","url":"https://api.github.com/repos/bevyengine/bevy/labels/C-Feature","name":"C-Feature","color":"b8b8b8","default":false,"description":"A new feature, making something new possible"},{"id":2197761682,"node_id":"MDU6TGFiZWwyMTk3NzYxNjgy","url":"https://api.github.com/repos/bevyengine/bevy/labels/A-ECS","name":"A-ECS","color":"c6a751","default":false,"description":"Entities, components, systems, and events"},{"id":6899552399,"node_id":"LA_kwDODf6-U88AAAABmz7Qjw","url":"https://api.github.com/repos/bevyengine/bevy/labels/X-Contentious","name":"X-Contentious","color":"D93F0B","default":false,"description":"There are nontrivial implications that should be thought through"},{"id":6899571146,"node_id":"LA_kwDODf6-U88AAAABmz8Zyg","url":"https://api.github.com/repos/bevyengine/bevy/labels/D-Straightforward","name":"D-Straightforward","color":"008672","default":false,"description":"Simple bug fixes and API improvements, docs, test and examples"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2024-05-11T18:14:32Z","updated_at":"2024-05-14T12:54:31Z","closed_at":"2024-05-14T12:54:31Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"This is an alternative means of achieving the goals of #12920.\r\n\r\n## What problem does this solve or what need does it fill?\r\n\r\nCurrently, the `QueryData` derive macro transforms fields of the type `&'static mut T` to `Mut<'w, T>` when generating the item type for the query. However, the readonly item type continues to use `&'w T` as the reference type. This makes it impossible to use change detection on the readonly form of mutable queries.\r\n\r\nAs an example from my code:\r\n\r\n```rust\r\n#[derive(QueryData)]\r\n#[query_data(mutable)]\r\npub struct TextBoxQuery {\r\n    pub data: &'static mut TextBox,\r\n    pub style: &'static mut TextBoxStyle,\r\n    pub text_style: &'static mut TextBoxTextStyle,\r\n}\r\n\r\n// derive(QueryData) output\r\npub struct TextBoxQueryItem<'w> {\r\n    pub data: Mut<'w, TextBox>,\r\n    pub style: Mut<'w, TextBoxStyle>,\r\n    pub text_style: Mut<'w, TextBoxTextStyle>,\r\n}\r\n\r\npub struct TextBoxQueryReadOnlyItem<'w> {\r\n    pub data: &'w TextBox,\r\n    pub style: &'w TextBoxStyle,\r\n    pub text_style: &'w TextBoxTextStyle,\r\n}\r\n```\r\n\r\n## What solution would you like?\r\n\r\nIn #12920, I proposed extending the `QueryData` derive to add a `detect_changes` option that would make the derive macro emit `Ref<T>` instead of `Self::ReadOnly` when it encounters a `&mut T`. I've since realised a simpler way of handling the problem: implement `WorldQuery` and `QueryData` for `Mut<T>` directly, setting its `ReadOnly` type alias to `Ref<T>`.\r\n\r\nI realised this alternate solution during an [unstructured discussion in the #ecs_dev Discord channel](https://discord.com/channels/691052431525675048/749335865876021248/1238625335847944324) where some additional questions were brought up.\r\n\r\nThis would allow for opting into change detection in the readonly form of the query without requiring extension of the derive macro itself, by defining a field as `Mut<'_, T>` instead of `&'_ mut T`:\r\n\r\n```rust\r\n#[derive(QueryData)]\r\n#[query_data(mutable)]\r\npub struct TextBoxQuery {\r\n    pub data: Mut<'static, TextBox>,\r\n    pub style: &'static mut TextBoxStyle,\r\n    pub text_style: &'static mut TextBoxTextStyle,\r\n}\r\n\r\n// derive(QueryData) output\r\npub struct TextBoxQueryItem<'w> {\r\n    pub data: Mut<'w, TextBox>,\r\n    pub style: Mut<'w, TextBoxStyle>, // this seems confusing, so I was hesitant to bring the idea up at first\r\n    pub text_style: Mut<'w, TextBoxTextStyle>,\r\n}\r\n\r\npub struct TextBoxQueryReadOnlyItem<'w> {\r\n    pub data: Ref<'w, TextBox>,\r\n    pub style: &'w TextBoxStyle,\r\n    pub text_style: &'w TextBoxTextStyle,\r\n}\r\n```\r\n\r\n## What alternative(s) have you considered?\r\n\r\nContinue with #12920, which has proven difficult to even begin implementing.\r\n","closed_by":{"login":"alice-i-cecile","id":3579909,"node_id":"MDQ6VXNlcjM1Nzk5MDk=","avatar_url":"https://avatars.githubusercontent.com/u/3579909?v=4","gravatar_id":"","url":"https://api.github.com/users/alice-i-cecile","html_url":"https://github.com/alice-i-cecile","followers_url":"https://api.github.com/users/alice-i-cecile/followers","following_url":"https://api.github.com/users/alice-i-cecile/following{/other_user}","gists_url":"https://api.github.com/users/alice-i-cecile/gists{/gist_id}","starred_url":"https://api.github.com/users/alice-i-cecile/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alice-i-cecile/subscriptions","organizations_url":"https://api.github.com/users/alice-i-cecile/orgs","repos_url":"https://api.github.com/users/alice-i-cecile/repos","events_url":"https://api.github.com/users/alice-i-cecile/events{/privacy}","received_events_url":"https://api.github.com/users/alice-i-cecile/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/bevyengine/bevy/issues/13329/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/bevyengine/bevy/issues/13329/timeline","performed_via_github_app":null,"state_reason":"completed"}