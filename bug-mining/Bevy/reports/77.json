{"url":"https://api.github.com/repos/bevyengine/bevy/issues/12057","repository_url":"https://api.github.com/repos/bevyengine/bevy","labels_url":"https://api.github.com/repos/bevyengine/bevy/issues/12057/labels{/name}","comments_url":"https://api.github.com/repos/bevyengine/bevy/issues/12057/comments","events_url":"https://api.github.com/repos/bevyengine/bevy/issues/12057/events","html_url":"https://github.com/bevyengine/bevy/issues/12057","id":2150256403,"node_id":"I_kwDODf6-U86AKk8T","number":12057,"title":"Can't get Rendering Assets to unload from RAM on wasm webgl2.0 build","user":{"login":"egol","id":16660306,"node_id":"MDQ6VXNlcjE2NjYwMzA2","avatar_url":"https://avatars.githubusercontent.com/u/16660306?v=4","gravatar_id":"","url":"https://api.github.com/users/egol","html_url":"https://github.com/egol","followers_url":"https://api.github.com/users/egol/followers","following_url":"https://api.github.com/users/egol/following{/other_user}","gists_url":"https://api.github.com/users/egol/gists{/gist_id}","starred_url":"https://api.github.com/users/egol/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/egol/subscriptions","organizations_url":"https://api.github.com/users/egol/orgs","repos_url":"https://api.github.com/users/egol/repos","events_url":"https://api.github.com/users/egol/events{/privacy}","received_events_url":"https://api.github.com/users/egol/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1795619323,"node_id":"MDU6TGFiZWwxNzk1NjE5MzIz","url":"https://api.github.com/repos/bevyengine/bevy/labels/C-Bug","name":"C-Bug","color":"d73a4a","default":false,"description":"An unexpected or incorrect behavior"},{"id":2351483673,"node_id":"MDU6TGFiZWwyMzUxNDgzNjcz","url":"https://api.github.com/repos/bevyengine/bevy/labels/O-Web","name":"O-Web","color":"2e6991","default":false,"description":"Specific to web (WASM) builds"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/bevyengine/bevy/milestones/21","html_url":"https://github.com/bevyengine/bevy/milestone/21","labels_url":"https://api.github.com/repos/bevyengine/bevy/milestones/21/labels","id":10570096,"node_id":"MI_kwDODf6-U84AoUlw","number":21,"title":"0.13.1","description":"","creator":{"login":"cart","id":2694663,"node_id":"MDQ6VXNlcjI2OTQ2NjM=","avatar_url":"https://avatars.githubusercontent.com/u/2694663?v=4","gravatar_id":"","url":"https://api.github.com/users/cart","html_url":"https://github.com/cart","followers_url":"https://api.github.com/users/cart/followers","following_url":"https://api.github.com/users/cart/following{/other_user}","gists_url":"https://api.github.com/users/cart/gists{/gist_id}","starred_url":"https://api.github.com/users/cart/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cart/subscriptions","organizations_url":"https://api.github.com/users/cart/orgs","repos_url":"https://api.github.com/users/cart/repos","events_url":"https://api.github.com/users/cart/events{/privacy}","received_events_url":"https://api.github.com/users/cart/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":59,"state":"closed","created_at":"2024-02-16T19:38:53Z","updated_at":"2024-03-18T22:44:09Z","due_on":null,"closed_at":"2024-03-18T22:44:09Z"},"comments":3,"created_at":"2024-02-23T02:17:36Z","updated_at":"2024-02-28T00:55:20Z","closed_at":"2024-02-28T00:55:19Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## Bevy version\r\nv0.13.0\r\n\r\n## \\[Optional\\] Relevant system information\r\nGPU: RTX 2080 Ti\r\nUsing Firefox 122 on Windows 10\r\n```ignore\r\nAdapterInfo { name: \"ANGLE (NVIDIA, NVIDIA GeForce GTX 980 Direct3D11 vs_5_0 ps_5_0)\", vendor: 4318, device: 0, device_type: Other, driver: \"\", driver_info: \"\", backend: Gl }\r\n```\r\n(Not sure why the adapter info shows GTX 980 for firefox but problem is persistent on chrome as well)\r\n\r\nUsing Chrome shows:\r\n```ignore\r\n AdapterInfo { name: \"ANGLE (NVIDIA, NVIDIA GeForce RTX 2080 Ti (0x00001E07) Direct3D11 vs_5_0 ps_5_0, D3D11)\", vendor: 4318, device: 0, device_type: Other, driver: \"\", driver_info: \"\", backend: Gl }\r\n```\r\n## What you did\r\n\r\nI am trying to get the new \"[Unload Rendering Assets from RAM](https://bevyengine.org/news/bevy-0-13/#unload-rendering-assets-from-ram)\" feature working. I have been successful on a `local cargo run --release` build but I have not been able to replicate the memory usage on a `wasm` `webgl` build. The attachment below shows the comparative ram usage of the local windows build and the `wasm` build. For some reason the `wasm` build never ends up offloading the memory and stays at the pictured amount.\r\nFor reference, I am loading 63 jpg images that are on average 2MB in size and have a resolution of 2587x3375 (obviously this could be optimized and I am currently perusing a workaround of drastically decreasing their resolution)\r\n\r\nThis is the code that sets my image assets to be offloaded:\r\n```rust\r\nfn check_asset_loading (\r\n    mut next_state: ResMut<NextState<AppState>>,\r\n    book_query: Query<&Book>,\r\n    mut images: ResMut<Assets<Image>>,\r\n    server: Res<AssetServer>,\r\n    mut loading_progress: ResMut<LoadingProgress>\r\n)\r\n{\r\n    let mut loaded = true;\r\n    use bevy::asset::LoadState;\r\n    for book in book_query.iter() {\r\n\r\n        let mut num_loaded = 0;\r\n\r\n        for handle in book.image_handles.iter() {\r\n            let load_state = server.get_load_state(handle);\r\n\r\n            if load_state.is_some() {\r\n                if load_state.unwrap() != LoadState::Loaded {\r\n                    loaded = false;\r\n                }\r\n                else {\r\n                    num_loaded += 1;\r\n\r\n                    if let Some(image) = images.get_mut(handle) {\r\n                        image.asset_usage = RenderAssetUsages::RENDER_WORLD;\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        loading_progress.current = (100.0 / book.image_handles.len() as f32) * num_loaded as f32;\r\n\r\n        if loaded && book.image_handles.len() == num_loaded {\r\n            info!(\"all images loaded!\");\r\n            // window.single_mut().visible = true;\r\n            next_state.set(AppState::Running);\r\n        }\r\n    }\r\n\r\n}\r\n```\r\n\r\nthis is my build pipeline for wasm:\r\n\r\n```ignore\r\ncargo build --profile wasm-release --target wasm32-unknown-unknown\r\nwasm-bindgen --no-typescript --target web --out-dir ./out/ --out-name \"mygame\" ./target/wasm32-unknown-unknown/release/book1-0.wasm\r\n```\r\nrelevant toml:\r\n```ignore\r\n[profile.wasm-release]\r\ninherits = \"release\"\r\nopt-level = \"z\"\r\nlto = \"fat\"\r\ncodegen-units = 1\r\n```\r\n\r\nhtml used to run wasm:\r\n```html\r\n<!doctype html>\r\n<html lang=\"en\">\r\n\r\n<body style=\"margin: 0px;\">\r\n  <script type=\"module\">\r\n    import init from './mygame.js'\r\n\r\n    init().catch((error) => {\r\n      if (!error.message.startsWith(\"Using exceptions for control flow, don't mind me. This isn't actually an error!\")) {\r\n        throw error;\r\n      }\r\n    });\r\n  </script>\r\n\r\n  <canvas id=\"mygame-canvas\" width=\"1280\" height=\"720\"></canvas>\r\n</body>\r\n\r\n</html>\r\n```\r\n\r\n## What went wrong\r\n\r\nOffloading to GPU memory works on a local windows build of my application but does not happen on a wasm build of the same application. \r\n\r\n\r\n## Additional information\r\nMemory usage:\r\n![image](https://github.com/bevyengine/bevy/assets/16660306/6d380de6-9bdf-44b9-881c-63fcc6577252)\r\nFirefox performance graph:\r\n![image](https://github.com/bevyengine/bevy/assets/16660306/364c4420-fcc4-4257-a7df-6841ae952487)\r\n","closed_by":{"login":"james7132","id":3137680,"node_id":"MDQ6VXNlcjMxMzc2ODA=","avatar_url":"https://avatars.githubusercontent.com/u/3137680?v=4","gravatar_id":"","url":"https://api.github.com/users/james7132","html_url":"https://github.com/james7132","followers_url":"https://api.github.com/users/james7132/followers","following_url":"https://api.github.com/users/james7132/following{/other_user}","gists_url":"https://api.github.com/users/james7132/gists{/gist_id}","starred_url":"https://api.github.com/users/james7132/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/james7132/subscriptions","organizations_url":"https://api.github.com/users/james7132/orgs","repos_url":"https://api.github.com/users/james7132/repos","events_url":"https://api.github.com/users/james7132/events{/privacy}","received_events_url":"https://api.github.com/users/james7132/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/bevyengine/bevy/issues/12057/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/bevyengine/bevy/issues/12057/timeline","performed_via_github_app":null,"state_reason":"completed"}