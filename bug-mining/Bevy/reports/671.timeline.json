[{"id":16094193889,"node_id":"LE_lADODf6-U86n1odOzwAAAAO_Sejh","url":"https://api.github.com/repos/bevyengine/bevy/issues/events/16094193889","actor":{"login":"ickshonpe","id":27962798,"node_id":"MDQ6VXNlcjI3OTYyNzk4","avatar_url":"https://avatars.githubusercontent.com/u/27962798?v=4","gravatar_id":"","url":"https://api.github.com/users/ickshonpe","html_url":"https://github.com/ickshonpe","followers_url":"https://api.github.com/users/ickshonpe/followers","following_url":"https://api.github.com/users/ickshonpe/following{/other_user}","gists_url":"https://api.github.com/users/ickshonpe/gists{/gist_id}","starred_url":"https://api.github.com/users/ickshonpe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ickshonpe/subscriptions","organizations_url":"https://api.github.com/users/ickshonpe/orgs","repos_url":"https://api.github.com/users/ickshonpe/repos","events_url":"https://api.github.com/users/ickshonpe/events{/privacy}","received_events_url":"https://api.github.com/users/ickshonpe/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2025-01-28T14:32:44Z","label":{"name":"A-Text","color":"c6A751"},"performed_via_github_app":null},{"id":16094193901,"node_id":"LE_lADODf6-U86n1odOzwAAAAO_Sejt","url":"https://api.github.com/repos/bevyengine/bevy/issues/events/16094193901","actor":{"login":"ickshonpe","id":27962798,"node_id":"MDQ6VXNlcjI3OTYyNzk4","avatar_url":"https://avatars.githubusercontent.com/u/27962798?v=4","gravatar_id":"","url":"https://api.github.com/users/ickshonpe","html_url":"https://github.com/ickshonpe","followers_url":"https://api.github.com/users/ickshonpe/followers","following_url":"https://api.github.com/users/ickshonpe/following{/other_user}","gists_url":"https://api.github.com/users/ickshonpe/gists{/gist_id}","starred_url":"https://api.github.com/users/ickshonpe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ickshonpe/subscriptions","organizations_url":"https://api.github.com/users/ickshonpe/orgs","repos_url":"https://api.github.com/users/ickshonpe/repos","events_url":"https://api.github.com/users/ickshonpe/events{/privacy}","received_events_url":"https://api.github.com/users/ickshonpe/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2025-01-28T14:32:44Z","label":{"name":"C-Bug","color":"d73a4a"},"performed_via_github_app":null},{"id":16094196665,"node_id":"LE_lADODf6-U86n1odOzwAAAAO_SfO5","url":"https://api.github.com/repos/bevyengine/bevy/issues/events/16094196665","actor":{"login":"ickshonpe","id":27962798,"node_id":"MDQ6VXNlcjI3OTYyNzk4","avatar_url":"https://avatars.githubusercontent.com/u/27962798?v=4","gravatar_id":"","url":"https://api.github.com/users/ickshonpe","html_url":"https://github.com/ickshonpe","followers_url":"https://api.github.com/users/ickshonpe/followers","following_url":"https://api.github.com/users/ickshonpe/following{/other_user}","gists_url":"https://api.github.com/users/ickshonpe/gists{/gist_id}","starred_url":"https://api.github.com/users/ickshonpe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ickshonpe/subscriptions","organizations_url":"https://api.github.com/users/ickshonpe/orgs","repos_url":"https://api.github.com/users/ickshonpe/repos","events_url":"https://api.github.com/users/ickshonpe/events{/privacy}","received_events_url":"https://api.github.com/users/ickshonpe/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2025-01-28T14:32:55Z","label":{"name":"A-UI","color":"c6a751"},"performed_via_github_app":null},{"actor":{"login":"ickshonpe","id":27962798,"node_id":"MDQ6VXNlcjI3OTYyNzk4","avatar_url":"https://avatars.githubusercontent.com/u/27962798?v=4","gravatar_id":"","url":"https://api.github.com/users/ickshonpe","html_url":"https://github.com/ickshonpe","followers_url":"https://api.github.com/users/ickshonpe/followers","following_url":"https://api.github.com/users/ickshonpe/following{/other_user}","gists_url":"https://api.github.com/users/ickshonpe/gists{/gist_id}","starred_url":"https://api.github.com/users/ickshonpe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ickshonpe/subscriptions","organizations_url":"https://api.github.com/users/ickshonpe/orgs","repos_url":"https://api.github.com/users/ickshonpe/repos","events_url":"https://api.github.com/users/ickshonpe/events{/privacy}","received_events_url":"https://api.github.com/users/ickshonpe/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2025-01-28T14:50:02Z","updated_at":"2025-01-28T14:50:02Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/bevyengine/bevy/issues/17579","repository_url":"https://api.github.com/repos/bevyengine/bevy","labels_url":"https://api.github.com/repos/bevyengine/bevy/issues/17579/labels{/name}","comments_url":"https://api.github.com/repos/bevyengine/bevy/issues/17579/comments","events_url":"https://api.github.com/repos/bevyengine/bevy/issues/17579/events","html_url":"https://github.com/bevyengine/bevy/pull/17579","id":2815908751,"node_id":"PR_kwDODf6-U86JPUPV","number":17579,"title":"Store UI render target info locally per node","user":{"login":"ickshonpe","id":27962798,"node_id":"MDQ6VXNlcjI3OTYyNzk4","avatar_url":"https://avatars.githubusercontent.com/u/27962798?v=4","gravatar_id":"","url":"https://api.github.com/users/ickshonpe","html_url":"https://github.com/ickshonpe","followers_url":"https://api.github.com/users/ickshonpe/followers","following_url":"https://api.github.com/users/ickshonpe/following{/other_user}","gists_url":"https://api.github.com/users/ickshonpe/gists{/gist_id}","starred_url":"https://api.github.com/users/ickshonpe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ickshonpe/subscriptions","organizations_url":"https://api.github.com/users/ickshonpe/orgs","repos_url":"https://api.github.com/users/ickshonpe/repos","events_url":"https://api.github.com/users/ickshonpe/events{/privacy}","received_events_url":"https://api.github.com/users/ickshonpe/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1795619323,"node_id":"MDU6TGFiZWwxNzk1NjE5MzIz","url":"https://api.github.com/repos/bevyengine/bevy/labels/C-Bug","name":"C-Bug","color":"d73a4a","default":false,"description":"An unexpected or incorrect behavior"},{"id":2045383863,"node_id":"MDU6TGFiZWwyMDQ1MzgzODYz","url":"https://api.github.com/repos/bevyengine/bevy/labels/A-Rendering","name":"A-Rendering","color":"C6A751","default":false,"description":"Drawing game state to the screen"},{"id":2272055811,"node_id":"MDU6TGFiZWwyMjcyMDU1ODEx","url":"https://api.github.com/repos/bevyengine/bevy/labels/A-Windowing","name":"A-Windowing","color":"c6a751","default":false,"description":"Platform-agnostic interface layer to run your app in"},{"id":2272098452,"node_id":"MDU6TGFiZWwyMjcyMDk4NDUy","url":"https://api.github.com/repos/bevyengine/bevy/labels/C-Performance","name":"C-Performance","color":"B8B8B8","default":false,"description":"A change motivated by improving speed, memory usage or compile times"},{"id":2276469463,"node_id":"MDU6TGFiZWwyMjc2NDY5NDYz","url":"https://api.github.com/repos/bevyengine/bevy/labels/A-UI","name":"A-UI","color":"c6a751","default":false,"description":"Graphical user interfaces, styles, layouts, and widgets"},{"id":2287994822,"node_id":"MDU6TGFiZWwyMjg3OTk0ODIy","url":"https://api.github.com/repos/bevyengine/bevy/labels/C-Code-Quality","name":"C-Code-Quality","color":"B8B8B8","default":false,"description":"A section of code that is hard to understand or change"},{"id":2747857990,"node_id":"MDU6TGFiZWwyNzQ3ODU3OTkw","url":"https://api.github.com/repos/bevyengine/bevy/labels/C-Usability","name":"C-Usability","color":"b8b8b8","default":false,"description":"A targeted quality-of-life change that makes Bevy easier to use"},{"id":2747865511,"node_id":"MDU6TGFiZWwyNzQ3ODY1NTEx","url":"https://api.github.com/repos/bevyengine/bevy/labels/S-Ready-For-Final-Review","name":"S-Ready-For-Final-Review","color":"D876E3","default":false,"description":"This PR has been approved by the community. It's ready for a maintainer to consider merging it"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2025-01-28T14:50:01Z","updated_at":"2025-02-10T21:42:04Z","closed_at":"2025-02-10T07:44:48Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"draft":false,"repository":{"id":234798675,"node_id":"MDEwOlJlcG9zaXRvcnkyMzQ3OTg2NzU=","name":"bevy","full_name":"bevyengine/bevy","private":false,"owner":{"login":"bevyengine","id":60047606,"node_id":"MDEyOk9yZ2FuaXphdGlvbjYwMDQ3NjA2","avatar_url":"https://avatars.githubusercontent.com/u/60047606?v=4","gravatar_id":"","url":"https://api.github.com/users/bevyengine","html_url":"https://github.com/bevyengine","followers_url":"https://api.github.com/users/bevyengine/followers","following_url":"https://api.github.com/users/bevyengine/following{/other_user}","gists_url":"https://api.github.com/users/bevyengine/gists{/gist_id}","starred_url":"https://api.github.com/users/bevyengine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bevyengine/subscriptions","organizations_url":"https://api.github.com/users/bevyengine/orgs","repos_url":"https://api.github.com/users/bevyengine/repos","events_url":"https://api.github.com/users/bevyengine/events{/privacy}","received_events_url":"https://api.github.com/users/bevyengine/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/bevyengine/bevy","description":"A refreshingly simple data-driven game engine built in Rust","fork":false,"url":"https://api.github.com/repos/bevyengine/bevy","forks_url":"https://api.github.com/repos/bevyengine/bevy/forks","keys_url":"https://api.github.com/repos/bevyengine/bevy/keys{/key_id}","collaborators_url":"https://api.github.com/repos/bevyengine/bevy/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/bevyengine/bevy/teams","hooks_url":"https://api.github.com/repos/bevyengine/bevy/hooks","issue_events_url":"https://api.github.com/repos/bevyengine/bevy/issues/events{/number}","events_url":"https://api.github.com/repos/bevyengine/bevy/events","assignees_url":"https://api.github.com/repos/bevyengine/bevy/assignees{/user}","branches_url":"https://api.github.com/repos/bevyengine/bevy/branches{/branch}","tags_url":"https://api.github.com/repos/bevyengine/bevy/tags","blobs_url":"https://api.github.com/repos/bevyengine/bevy/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/bevyengine/bevy/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/bevyengine/bevy/git/refs{/sha}","trees_url":"https://api.github.com/repos/bevyengine/bevy/git/trees{/sha}","statuses_url":"https://api.github.com/repos/bevyengine/bevy/statuses/{sha}","languages_url":"https://api.github.com/repos/bevyengine/bevy/languages","stargazers_url":"https://api.github.com/repos/bevyengine/bevy/stargazers","contributors_url":"https://api.github.com/repos/bevyengine/bevy/contributors","subscribers_url":"https://api.github.com/repos/bevyengine/bevy/subscribers","subscription_url":"https://api.github.com/repos/bevyengine/bevy/subscription","commits_url":"https://api.github.com/repos/bevyengine/bevy/commits{/sha}","git_commits_url":"https://api.github.com/repos/bevyengine/bevy/git/commits{/sha}","comments_url":"https://api.github.com/repos/bevyengine/bevy/comments{/number}","issue_comment_url":"https://api.github.com/repos/bevyengine/bevy/issues/comments{/number}","contents_url":"https://api.github.com/repos/bevyengine/bevy/contents/{+path}","compare_url":"https://api.github.com/repos/bevyengine/bevy/compare/{base}...{head}","merges_url":"https://api.github.com/repos/bevyengine/bevy/merges","archive_url":"https://api.github.com/repos/bevyengine/bevy/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/bevyengine/bevy/downloads","issues_url":"https://api.github.com/repos/bevyengine/bevy/issues{/number}","pulls_url":"https://api.github.com/repos/bevyengine/bevy/pulls{/number}","milestones_url":"https://api.github.com/repos/bevyengine/bevy/milestones{/number}","notifications_url":"https://api.github.com/repos/bevyengine/bevy/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/bevyengine/bevy/labels{/name}","releases_url":"https://api.github.com/repos/bevyengine/bevy/releases{/id}","deployments_url":"https://api.github.com/repos/bevyengine/bevy/deployments","created_at":"2020-01-18T21:13:55Z","updated_at":"2025-11-10T00:30:24Z","pushed_at":"2025-11-09T20:05:46Z","git_url":"git://github.com/bevyengine/bevy.git","ssh_url":"git@github.com:bevyengine/bevy.git","clone_url":"https://github.com/bevyengine/bevy.git","svn_url":"https://github.com/bevyengine/bevy","homepage":"https://bevy.org","size":152673,"stargazers_count":42996,"watchers_count":42996,"language":"Rust","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":false,"has_pages":true,"has_discussions":true,"forks_count":4220,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":3116,"license":{"key":"apache-2.0","name":"Apache License 2.0","spdx_id":"Apache-2.0","url":"https://api.github.com/licenses/apache-2.0","node_id":"MDc6TGljZW5zZTI="},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["bevy","game-development","game-engine","gamedev","open-source","rust"],"visibility":"public","forks":4220,"open_issues":3116,"watchers":42996,"default_branch":"main","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"pull_request":{"url":"https://api.github.com/repos/bevyengine/bevy/pulls/17579","html_url":"https://github.com/bevyengine/bevy/pull/17579","diff_url":"https://github.com/bevyengine/bevy/pull/17579.diff","patch_url":"https://github.com/bevyengine/bevy/pull/17579.patch","merged_at":"2025-02-10T07:44:48Z"},"body":"# Objective\r\n\r\nIt's difficult to understand or make changes to the UI systems because of how each system needs to individually track changes to scale factor, windows and camera targets in local hashmaps, particularly for new contributors. Any major change inevitably introduces new scale factor bugs. \r\n\r\nInstead of per-system resolution we can resolve the camera target info for all UI nodes in a system at the start of `PostUpdate` and then store it per-node in components that can be queried with change detection.\r\n\r\nFixes #17613\r\nFixes #17578\r\nFixes #15143\r\n\r\n## Solution\r\n\r\nStore the UI render target's data locally per node in a component that is updated in `PostUpdate` before any other UI systems run.\r\n\r\nThis component can be then be queried with change detection so that UI systems no longer need to have knowledge of cameras and windows and don't require fragile custom change detection solutions using local hashmaps. \r\n\r\n## Showcase\r\nCompare `measure_text_system` from main (which has a bug the causes it to use the wrong scale factor when a node's camera target changes):\r\n```\r\npub fn measure_text_system(\r\n    mut scale_factors_buffer: Local<EntityHashMap<f32>>,\r\n    mut last_scale_factors: Local<EntityHashMap<f32>>,\r\n    fonts: Res<Assets<Font>>,\r\n    camera_query: Query<(Entity, &Camera)>,\r\n    default_ui_camera: DefaultUiCamera,\r\n    ui_scale: Res<UiScale>,\r\n    mut text_query: Query<\r\n        (\r\n            Entity,\r\n            Ref<TextLayout>,\r\n            &mut ContentSize,\r\n            &mut TextNodeFlags,\r\n            &mut ComputedTextBlock,\r\n            Option<&UiTargetCamera>,\r\n        ),\r\n        With<Node>,\r\n    >,\r\n    mut text_reader: TextUiReader,\r\n    mut text_pipeline: ResMut<TextPipeline>,\r\n    mut font_system: ResMut<CosmicFontSystem>,\r\n) {\r\n    scale_factors_buffer.clear();\r\n\r\n    let default_camera_entity = default_ui_camera.get();\r\n\r\n    for (entity, block, content_size, text_flags, computed, maybe_camera) in &mut text_query {\r\n        let Some(camera_entity) = maybe_camera\r\n            .map(UiTargetCamera::entity)\r\n            .or(default_camera_entity)\r\n        else {\r\n            continue;\r\n        };\r\n        let scale_factor = match scale_factors_buffer.entry(camera_entity) {\r\n            Entry::Occupied(entry) => *entry.get(),\r\n            Entry::Vacant(entry) => *entry.insert(\r\n                camera_query\r\n                    .get(camera_entity)\r\n                    .ok()\r\n                    .and_then(|(_, c)| c.target_scaling_factor())\r\n                    .unwrap_or(1.0)\r\n                    * ui_scale.0,\r\n            ),\r\n        };\r\n\r\n        if last_scale_factors.get(&camera_entity) != Some(&scale_factor)\r\n            || computed.needs_rerender()\r\n            || text_flags.needs_measure_fn\r\n            || content_size.is_added()\r\n        {\r\n            create_text_measure(\r\n                entity,\r\n                &fonts,\r\n                scale_factor.into(),\r\n                text_reader.iter(entity),\r\n                block,\r\n                &mut text_pipeline,\r\n                content_size,\r\n                text_flags,\r\n                computed,\r\n                &mut font_system,\r\n            );\r\n        }\r\n    }\r\n    core::mem::swap(&mut *last_scale_factors, &mut *scale_factors_buffer);\r\n}\r\n```\r\n\r\nwith `measure_text_system` from this PR (which always uses the correct scale factor):\r\n```\r\npub fn measure_text_system(\r\n    fonts: Res<Assets<Font>>,\r\n    mut text_query: Query<\r\n        (\r\n            Entity,\r\n            Ref<TextLayout>,\r\n            &mut ContentSize,\r\n            &mut TextNodeFlags,\r\n            &mut ComputedTextBlock,\r\n            Ref<ComputedNodeTarget>,\r\n        ),\r\n        With<Node>,\r\n    >,\r\n    mut text_reader: TextUiReader,\r\n    mut text_pipeline: ResMut<TextPipeline>,\r\n    mut font_system: ResMut<CosmicFontSystem>,\r\n) {\r\n    for (entity, block, content_size, text_flags, computed, computed_target) in &mut text_query {\r\n        // Note: the ComputedTextBlock::needs_rerender bool is cleared in create_text_measure().\r\n        if computed_target.is_changed()\r\n            || computed.needs_rerender()\r\n            || text_flags.needs_measure_fn\r\n            || content_size.is_added()\r\n        {\r\n            create_text_measure(\r\n                entity,\r\n                &fonts,\r\n                computed_target.scale_factor.into(),\r\n                text_reader.iter(entity),\r\n                block,\r\n                &mut text_pipeline,\r\n                content_size,\r\n                text_flags,\r\n                computed,\r\n                &mut font_system,\r\n            );\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n## Testing\r\n\r\nI removed an alarming number of tests from the `layout` module but they were mostly to do with the deleted camera synchronisation logic. The remaining tests should all pass now.\r\n\r\nThe most relevant examples are `multiple_windows` and `split_screen`, the behaviour of both should be unchanged from main.\r\n","reactions":{"url":"https://api.github.com/repos/bevyengine/bevy/issues/17579/reactions","total_count":1,"+1":0,"-1":0,"laugh":0,"hooray":1,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/bevyengine/bevy/issues/17579/timeline","performed_via_github_app":null,"state_reason":null}},"event":"cross-referenced"},{"id":16242754864,"node_id":"REFE_lADODf6-U86n1odOzwAAAAPIJMUw","url":"https://api.github.com/repos/bevyengine/bevy/issues/events/16242754864","actor":{"login":"github-merge-queue[bot]","id":118344674,"node_id":"BOT_kgDOBw3L4g","avatar_url":"https://avatars.githubusercontent.com/u/9919?v=4","gravatar_id":"","url":"https://api.github.com/users/github-merge-queue%5Bbot%5D","html_url":"https://github.com/apps/github-merge-queue","followers_url":"https://api.github.com/users/github-merge-queue%5Bbot%5D/followers","following_url":"https://api.github.com/users/github-merge-queue%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/github-merge-queue%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/github-merge-queue%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/github-merge-queue%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/github-merge-queue%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/github-merge-queue%5Bbot%5D/repos","events_url":"https://api.github.com/users/github-merge-queue%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/github-merge-queue%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"300fe4db4d58b1a0a0e74fb9026ab494c2b88e80","commit_url":"https://api.github.com/repos/bevyengine/bevy/commits/300fe4db4d58b1a0a0e74fb9026ab494c2b88e80","created_at":"2025-02-10T07:44:48Z","performed_via_github_app":null},{"id":16242755021,"node_id":"CE_lADODf6-U86n1odOzwAAAAPIJMXN","url":"https://api.github.com/repos/bevyengine/bevy/issues/events/16242755021","actor":{"login":"alice-i-cecile","id":3579909,"node_id":"MDQ6VXNlcjM1Nzk5MDk=","avatar_url":"https://avatars.githubusercontent.com/u/3579909?v=4","gravatar_id":"","url":"https://api.github.com/users/alice-i-cecile","html_url":"https://github.com/alice-i-cecile","followers_url":"https://api.github.com/users/alice-i-cecile/followers","following_url":"https://api.github.com/users/alice-i-cecile/following{/other_user}","gists_url":"https://api.github.com/users/alice-i-cecile/gists{/gist_id}","starred_url":"https://api.github.com/users/alice-i-cecile/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alice-i-cecile/subscriptions","organizations_url":"https://api.github.com/users/alice-i-cecile/orgs","repos_url":"https://api.github.com/users/alice-i-cecile/repos","events_url":"https://api.github.com/users/alice-i-cecile/events{/privacy}","received_events_url":"https://api.github.com/users/alice-i-cecile/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"closed","commit_id":null,"commit_url":null,"created_at":"2025-02-10T07:44:50Z","state_reason":null,"performed_via_github_app":null}]