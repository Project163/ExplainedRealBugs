{"url":"https://api.github.com/repos/bevyengine/bevy/issues/16715","repository_url":"https://api.github.com/repos/bevyengine/bevy","labels_url":"https://api.github.com/repos/bevyengine/bevy/issues/16715/labels{/name}","comments_url":"https://api.github.com/repos/bevyengine/bevy/issues/16715/comments","events_url":"https://api.github.com/repos/bevyengine/bevy/issues/16715/events","html_url":"https://github.com/bevyengine/bevy/issues/16715","id":2725458398,"node_id":"I_kwDODf6-U86iczHe","number":16715,"title":"`Readback` only reads the first layer of 2D array images","user":{"login":"EmbersArc","id":1352472,"node_id":"MDQ6VXNlcjEzNTI0NzI=","avatar_url":"https://avatars.githubusercontent.com/u/1352472?v=4","gravatar_id":"","url":"https://api.github.com/users/EmbersArc","html_url":"https://github.com/EmbersArc","followers_url":"https://api.github.com/users/EmbersArc/followers","following_url":"https://api.github.com/users/EmbersArc/following{/other_user}","gists_url":"https://api.github.com/users/EmbersArc/gists{/gist_id}","starred_url":"https://api.github.com/users/EmbersArc/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/EmbersArc/subscriptions","organizations_url":"https://api.github.com/users/EmbersArc/orgs","repos_url":"https://api.github.com/users/EmbersArc/repos","events_url":"https://api.github.com/users/EmbersArc/events{/privacy}","received_events_url":"https://api.github.com/users/EmbersArc/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1795619323,"node_id":"MDU6TGFiZWwxNzk1NjE5MzIz","url":"https://api.github.com/repos/bevyengine/bevy/labels/C-Bug","name":"C-Bug","color":"d73a4a","default":false,"description":"An unexpected or incorrect behavior"},{"id":2045383863,"node_id":"MDU6TGFiZWwyMDQ1MzgzODYz","url":"https://api.github.com/repos/bevyengine/bevy/labels/A-Rendering","name":"A-Rendering","color":"C6A751","default":false,"description":"Drawing game state to the screen"},{"id":3166151441,"node_id":"MDU6TGFiZWwzMTY2MTUxNDQx","url":"https://api.github.com/repos/bevyengine/bevy/labels/S-Ready-For-Implementation","name":"S-Ready-For-Implementation","color":"D876E3","default":false,"description":"This issue is ready for an implementation PR. Go for it!"},{"id":6899576022,"node_id":"LA_kwDODf6-U88AAAABmz8s1g","url":"https://api.github.com/repos/bevyengine/bevy/labels/D-Modest","name":"D-Modest","color":"008672","default":false,"description":"A \"normal\" level of difficulty; suitable for simple features or challenging fixes"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2024-12-08T18:51:20Z","updated_at":"2024-12-17T19:29:52Z","closed_at":"2024-12-17T19:29:52Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## Bevy version\n\n0.15\n\n## What you did\n\n```rust\nuse bevy::{\n    image::{self as bevy_image, TextureFormatPixelInfo},\n    prelude::*,\n    render::{\n        render_asset::RenderAssetUsages,\n        render_resource::{\n            Extent3d, TextureDescriptor, TextureDimension, TextureFormat, TextureUsages,\n        },\n    },\n};\n\nfn main() {\n    let mut app = App::new();\n    app.add_plugins(DefaultPlugins)\n        .add_systems(Startup, setup)\n        .add_systems(Update, readback_system);\n    app.run();\n}\n\n#[derive(Resource)]\nstruct ImageResource(Handle<Image>);\n\nconst TEXTURE_RESOLUTION: u32 = 256;\nconst FORMAT: TextureFormat = TextureFormat::R32Uint;\nconst LAYERS: u32 = 10;\n\nfn setup(mut commands: Commands, mut images: ResMut<Assets<Image>>) {\n    let pixel_count = (TEXTURE_RESOLUTION * TEXTURE_RESOLUTION * LAYERS) as usize;\n    let size = pixel_count * FORMAT.pixel_size();\n    let image = Image {\n        data: vec![0; size],\n        texture_descriptor: TextureDescriptor {\n            label: Some(\"image\"),\n            size: Extent3d {\n                width: TEXTURE_RESOLUTION,\n                height: TEXTURE_RESOLUTION,\n                depth_or_array_layers: LAYERS,\n            },\n            mip_level_count: 1,\n            sample_count: 1,\n            dimension: TextureDimension::D2,\n            format: FORMAT,\n            usage: TextureUsages::COPY_DST | TextureUsages::COPY_SRC,\n            view_formats: &[],\n        },\n        sampler: bevy_image::ImageSampler::Default,\n        texture_view_descriptor: None,\n        asset_usage: RenderAssetUsages::RENDER_WORLD,\n    };\n\n    commands.insert_resource(ImageResource(images.add(image)));\n}\n\nfn readback_system(\n    mut commands: Commands,\n    keys: Res<ButtonInput<KeyCode>>,\n    image: Res<ImageResource>,\n) {\n    if !keys.just_pressed(KeyCode::KeyR) {\n        return;\n    }\n\n    commands\n        .spawn(bevy::render::gpu_readback::Readback::Texture(\n            image.0.clone(),\n        ))\n        .observe(\n            |trigger: Trigger<bevy::render::gpu_readback::ReadbackComplete>,\n             mut commands: Commands| {\n                info!(\"readback complete\");\n\n                let event = trigger.event();\n                let shader_type: Vec<u32> = event.to_shader_type();\n\n                let actual_size = shader_type.len();\n                let expected_layer_size = TEXTURE_RESOLUTION * TEXTURE_RESOLUTION;\n                let expected_full_size = LAYERS * expected_layer_size;\n                info!(\n                    \"size was {actual_size} but expected {expected_full_size} for the full image \\\n                    or {expected_layer_size} for the first layer\"\n                );\n\n                commands.entity(trigger.entity()).despawn();\n            },\n        );\n}\n```\n\n\n## What went wrong\n\nThe program above prints \"size was 81920 but expected 655360 for the full image or 65536 for the first layer\". The 81920 vs. 65536 is likely due to alignment reasons that I do not understand yet, but the amount of data clearly only belongs to the first layer.","closed_by":{"login":"alice-i-cecile","id":3579909,"node_id":"MDQ6VXNlcjM1Nzk5MDk=","avatar_url":"https://avatars.githubusercontent.com/u/3579909?v=4","gravatar_id":"","url":"https://api.github.com/users/alice-i-cecile","html_url":"https://github.com/alice-i-cecile","followers_url":"https://api.github.com/users/alice-i-cecile/followers","following_url":"https://api.github.com/users/alice-i-cecile/following{/other_user}","gists_url":"https://api.github.com/users/alice-i-cecile/gists{/gist_id}","starred_url":"https://api.github.com/users/alice-i-cecile/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alice-i-cecile/subscriptions","organizations_url":"https://api.github.com/users/alice-i-cecile/orgs","repos_url":"https://api.github.com/users/alice-i-cecile/repos","events_url":"https://api.github.com/users/alice-i-cecile/events{/privacy}","received_events_url":"https://api.github.com/users/alice-i-cecile/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/bevyengine/bevy/issues/16715/reactions","total_count":1,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":1},"timeline_url":"https://api.github.com/repos/bevyengine/bevy/issues/16715/timeline","performed_via_github_app":null,"state_reason":"completed"}