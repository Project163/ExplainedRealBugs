{"url":"https://api.github.com/repos/bevyengine/bevy/issues/18041","repository_url":"https://api.github.com/repos/bevyengine/bevy","labels_url":"https://api.github.com/repos/bevyengine/bevy/issues/18041/labels{/name}","comments_url":"https://api.github.com/repos/bevyengine/bevy/issues/18041/comments","events_url":"https://api.github.com/repos/bevyengine/bevy/issues/18041/events","html_url":"https://github.com/bevyengine/bevy/issues/18041","id":2879858381,"node_id":"I_kwDODf6-U86rpybN","number":18041,"title":"Bulk operations on entity relationships","user":{"login":"viridia","id":1166135,"node_id":"MDQ6VXNlcjExNjYxMzU=","avatar_url":"https://avatars.githubusercontent.com/u/1166135?v=4","gravatar_id":"","url":"https://api.github.com/users/viridia","html_url":"https://github.com/viridia","followers_url":"https://api.github.com/users/viridia/followers","following_url":"https://api.github.com/users/viridia/following{/other_user}","gists_url":"https://api.github.com/users/viridia/gists{/gist_id}","starred_url":"https://api.github.com/users/viridia/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/viridia/subscriptions","organizations_url":"https://api.github.com/users/viridia/orgs","repos_url":"https://api.github.com/users/viridia/repos","events_url":"https://api.github.com/users/viridia/events{/privacy}","received_events_url":"https://api.github.com/users/viridia/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":2197761682,"node_id":"MDU6TGFiZWwyMTk3NzYxNjgy","url":"https://api.github.com/repos/bevyengine/bevy/labels/A-ECS","name":"A-ECS","color":"c6a751","default":false,"description":"Entities, components, systems, and events"},{"id":2272098452,"node_id":"MDU6TGFiZWwyMjcyMDk4NDUy","url":"https://api.github.com/repos/bevyengine/bevy/labels/C-Performance","name":"C-Performance","color":"B8B8B8","default":false,"description":"A change motivated by improving speed, memory usage or compile times"},{"id":2747857990,"node_id":"MDU6TGFiZWwyNzQ3ODU3OTkw","url":"https://api.github.com/repos/bevyengine/bevy/labels/C-Usability","name":"C-Usability","color":"b8b8b8","default":false,"description":"A targeted quality-of-life change that makes Bevy easier to use"},{"id":3166151441,"node_id":"MDU6TGFiZWwzMTY2MTUxNDQx","url":"https://api.github.com/repos/bevyengine/bevy/labels/S-Ready-For-Implementation","name":"S-Ready-For-Implementation","color":"D876E3","default":false,"description":"This issue is ready for an implementation PR. Go for it!"},{"id":6899549740,"node_id":"LA_kwDODf6-U88AAAABmz7GLA","url":"https://api.github.com/repos/bevyengine/bevy/labels/X-Uncontroversial","name":"X-Uncontroversial","color":"d93f0b","default":false,"description":"This work is generally agreed upon"},{"id":6899576022,"node_id":"LA_kwDODf6-U88AAAABmz8s1g","url":"https://api.github.com/repos/bevyengine/bevy/labels/D-Modest","name":"D-Modest","color":"008672","default":false,"description":"A \"normal\" level of difficulty; suitable for simple features or challenging fixes"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2025-02-26T00:52:23Z","updated_at":"2025-03-19T20:29:54Z","closed_at":"2025-03-19T20:29:54Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## What problem does this solve or what need does it fill?\n\nBefore relationships, we had the `replace_children` method, which wasn't particularly efficient (it removed all existing children, even the ones that were carried over, and then replaced them with the new list), but it was useful. There's no method in the new API which provides the same level of functionality.\n\nFor implementing reactions (as illustrated in cart's discussion post as well as my various libraries) it is a very common operation to want to replace all children of an entity with a new list of children, where the two lists may have elements in common. Currently this requires a hacky workaround: removing the `Children` component from the parent, and then adding the new children via `add_related`.\n\nIdeally what we want to have happen is:\n\n* Remove the `ChildOf` component from any existing children which are not in the new list.\n* Add `ChildOf` components to any new children which are not in the old list.\n* For elements which are in both the old and new lists, do nothing - don't modify the `ChildOf` components.\n* Update the `Children` component to contain the new list with the correct ordering of entities.\n\nNote that in many cases the first step can be omitted, since the old children are about to be despawned anyway.\n\nNow, it might sound that in order to do this correctly, you would need to allocate memory - effectively what's described in the preceding steps are set operations (all A not in B) which would require an EntitySet. In other words, you'd start by initializing the set to the existing children, and remove from the set any children that are being carried over. What's left is the children that need to be unlinked. Unfortunately, set operations allocate memory.\n\nHowever, we can avoid this by making the caller do the work. The reactive framework has in all likelyhood already done this calculation (determining which children are new and which are to be removed), so there's no need for the low-level relationship API to do this computation again. What the caller cannot (and should not) do, however, is directly modify the contents of Children and ChildOf components. So we need an API which allows the caller to provide the results of this calculation.\n\n## What solution would you like?\n\nWhat I am envisioning is a method on `EntityWorldMut` which accepts three arguments (plus self), all of which are entity slices:\n\n* The replacement entity list, which will become the new contents of `Children`.\n* A list of entities which are being added. A `ChildOf` component will be added to each entity in this list.\n* A list of entities which are being removed. The `ChildOf` component will be removed from each entity in this list.\n\nIt's the caller's responsibility to ensure that the arguments are consistent: the list of newly added entities should be a subset of the list of replacements, and the list of newly removed entities should be a subset of the exiting children.\n\nIn cases where the removed entities are being immediately despawned, we can get by with passing in an empty slice as the third argument - this means that the work of removing the `ChildOf` components can be skipped.\n\nWe may also want to have a variant of this which replaces just a sub-range of children, specified by starting index and length. So there would be 4 arguments: the three given above, plus a range argument.\n\n## What alternative(s) have you considered?\n\nIt's possible to do this one entity at a time with current APIs, but it's not very efficient. The current hacky workaround also works, but does needless archetype moves (deleting the `ChildOf` component and then immediately adding it back again).\n\nAssuming we can agree on the design of the API, the implementation should be relatively easy.\n\n## Additional context\n\nSee the discussion on in-place reactions #17917\n\n@cart @alice-i-cecile ","closed_by":{"login":"alice-i-cecile","id":3579909,"node_id":"MDQ6VXNlcjM1Nzk5MDk=","avatar_url":"https://avatars.githubusercontent.com/u/3579909?v=4","gravatar_id":"","url":"https://api.github.com/users/alice-i-cecile","html_url":"https://github.com/alice-i-cecile","followers_url":"https://api.github.com/users/alice-i-cecile/followers","following_url":"https://api.github.com/users/alice-i-cecile/following{/other_user}","gists_url":"https://api.github.com/users/alice-i-cecile/gists{/gist_id}","starred_url":"https://api.github.com/users/alice-i-cecile/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alice-i-cecile/subscriptions","organizations_url":"https://api.github.com/users/alice-i-cecile/orgs","repos_url":"https://api.github.com/users/alice-i-cecile/repos","events_url":"https://api.github.com/users/alice-i-cecile/events{/privacy}","received_events_url":"https://api.github.com/users/alice-i-cecile/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/bevyengine/bevy/issues/18041/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/bevyengine/bevy/issues/18041/timeline","performed_via_github_app":null,"state_reason":"completed"}