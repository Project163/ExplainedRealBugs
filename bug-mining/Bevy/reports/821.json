{"url":"https://api.github.com/repos/bevyengine/bevy/issues/19150","repository_url":"https://api.github.com/repos/bevyengine/bevy","labels_url":"https://api.github.com/repos/bevyengine/bevy/issues/19150/labels{/name}","comments_url":"https://api.github.com/repos/bevyengine/bevy/issues/19150/comments","events_url":"https://api.github.com/repos/bevyengine/bevy/issues/19150/events","html_url":"https://github.com/bevyengine/bevy/issues/19150","id":3053144521,"node_id":"I_kwDODf6-U861-0nJ","number":19150,"title":"`DepthPrepass` doesn't respect changing `alpha_mode` from `Opaque` to `Blend`.","user":{"login":"eero-lehtinen","id":7013023,"node_id":"MDQ6VXNlcjcwMTMwMjM=","avatar_url":"https://avatars.githubusercontent.com/u/7013023?v=4","gravatar_id":"","url":"https://api.github.com/users/eero-lehtinen","html_url":"https://github.com/eero-lehtinen","followers_url":"https://api.github.com/users/eero-lehtinen/followers","following_url":"https://api.github.com/users/eero-lehtinen/following{/other_user}","gists_url":"https://api.github.com/users/eero-lehtinen/gists{/gist_id}","starred_url":"https://api.github.com/users/eero-lehtinen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/eero-lehtinen/subscriptions","organizations_url":"https://api.github.com/users/eero-lehtinen/orgs","repos_url":"https://api.github.com/users/eero-lehtinen/repos","events_url":"https://api.github.com/users/eero-lehtinen/events{/privacy}","received_events_url":"https://api.github.com/users/eero-lehtinen/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1795619323,"node_id":"MDU6TGFiZWwxNzk1NjE5MzIz","url":"https://api.github.com/repos/bevyengine/bevy/labels/C-Bug","name":"C-Bug","color":"d73a4a","default":false,"description":"An unexpected or incorrect behavior"},{"id":2045383863,"node_id":"MDU6TGFiZWwyMDQ1MzgzODYz","url":"https://api.github.com/repos/bevyengine/bevy/labels/A-Rendering","name":"A-Rendering","color":"C6A751","default":false,"description":"Drawing game state to the screen"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2025-05-09T20:43:23Z","updated_at":"2025-05-18T06:46:15Z","closed_at":"2025-05-18T06:46:14Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## Bevy version\n\nmain 95470df3c800\n\n```\nSystemInfo { os: \"Windows 11 Pro\", kernel: \"26100\", cpu: \"AMD Ryzen 9 9950X 16-Core Processor\", core_count: \"16\", memory: \"31.2 GiB\" }\n\nAdapterInfo { name: \"NVIDIA GeForce RTX 3070 Ti\", vendor: 4318, device: 9346, device_type: DiscreteGpu, driver: \"NVIDIA\", driver_info: \"576.28\", backend: Vulkan }\n```\n\n## What you did\n\nI added a depth prepass to the camera and changed the alpha mode of an entity with `StandardMaterial` from `Opaque` to `Blend` in the `3d_scene` example.\n\nExample:\n```rust\nuse bevy::{core_pipeline::prepass::DepthPrepass, prelude::*};\n\nfn main() {\n    App::new()\n        .add_plugins(DefaultPlugins)\n        .insert_resource(ClearColor(Color::BLACK))\n        .add_systems(Startup, setup)\n        .add_systems(Update, update)\n        .run();\n}\n\n#[derive(Component)]\nstruct Shape;\n\n/// set up a simple 3D scene\nfn setup(\n    mut commands: Commands,\n    mut meshes: ResMut<Assets<Mesh>>,\n    mut materials: ResMut<Assets<StandardMaterial>>,\n) {\n    // circular base\n    commands.spawn((\n        Mesh3d(meshes.add(Circle::new(4.0))),\n        MeshMaterial3d(materials.add(Color::WHITE)),\n        Transform::from_rotation(Quat::from_rotation_x(-std::f32::consts::FRAC_PI_2)),\n    ));\n    // cube\n    commands.spawn((\n        Shape,\n        Mesh3d(meshes.add(Cuboid::new(1.0, 1.0, 1.0))),\n        MeshMaterial3d(materials.add(Color::srgba_u8(124, 144, 255, 50))),\n        Transform::from_xyz(0.0, 0.5, 0.0),\n    ));\n    // light\n    commands.spawn((\n        PointLight {\n            shadows_enabled: true,\n            ..default()\n        },\n        Transform::from_xyz(4.0, 8.0, 4.0),\n    ));\n    // camera\n    commands.spawn((\n        Camera3d::default(),\n        Transform::from_xyz(-2.5, 4.5, 9.0).looking_at(Vec3::ZERO, Vec3::Y),\n        DepthPrepass,\n    ));\n}\n\nfn update(\n    keyboard_input: Res<ButtonInput<KeyCode>>,\n    mut materials: ResMut<Assets<StandardMaterial>>,\n    mut mat_q: Query<&mut MeshMaterial3d<StandardMaterial>, With<Shape>>,\n) {\n    if keyboard_input.just_pressed(KeyCode::Space) {\n        if let Ok(mat) = mat_q.single_mut() {\n            let m = materials.get_mut(&mat.0).unwrap();\n            m.alpha_mode = if m.alpha_mode == AlphaMode::Opaque {\n                AlphaMode::Blend\n            } else {\n                AlphaMode::Opaque\n            };\n        };\n    }\n}\n```\n\n## What went wrong\n\nAt first the alpha mode is blend, and looks transparent as it should.\n\n![Image](https://github.com/user-attachments/assets/45ba703f-6b65-45eb-a322-2429079f33b3)\n\nThen pressing space makes it opaque, it looks opaque as it should.\n\n![Image](https://github.com/user-attachments/assets/6e47ea76-21e7-449c-bd9c-9e617608d110)\n\nThen once more pressing space the material goes back to blend, but you can see through the white circle, which is wrong. I assume the reason is that `DepthPrepass` doesn't \"realize\" that the object is not opaque anymore and doesn't bother to draw anything behind it. Might be a retained rendering issue.\n\n![Image](https://github.com/user-attachments/assets/d576f6d7-bffc-4054-9981-d7f79193aa6e)\n\n## Additional information\n","closed_by":{"login":"superdump","id":302146,"node_id":"MDQ6VXNlcjMwMjE0Ng==","avatar_url":"https://avatars.githubusercontent.com/u/302146?v=4","gravatar_id":"","url":"https://api.github.com/users/superdump","html_url":"https://github.com/superdump","followers_url":"https://api.github.com/users/superdump/followers","following_url":"https://api.github.com/users/superdump/following{/other_user}","gists_url":"https://api.github.com/users/superdump/gists{/gist_id}","starred_url":"https://api.github.com/users/superdump/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/superdump/subscriptions","organizations_url":"https://api.github.com/users/superdump/orgs","repos_url":"https://api.github.com/users/superdump/repos","events_url":"https://api.github.com/users/superdump/events{/privacy}","received_events_url":"https://api.github.com/users/superdump/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/bevyengine/bevy/issues/19150/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/bevyengine/bevy/issues/19150/timeline","performed_via_github_app":null,"state_reason":"completed"}