[{"id":13936251512,"node_id":"LE_lADODf6-U86TemgCzwAAAAM-qlJ4","url":"https://api.github.com/repos/bevyengine/bevy/issues/events/13936251512","actor":{"login":"viridia","id":1166135,"node_id":"MDQ6VXNlcjExNjYxMzU=","avatar_url":"https://avatars.githubusercontent.com/u/1166135?v=4","gravatar_id":"","url":"https://api.github.com/users/viridia","html_url":"https://github.com/viridia","followers_url":"https://api.github.com/users/viridia/followers","following_url":"https://api.github.com/users/viridia/following{/other_user}","gists_url":"https://api.github.com/users/viridia/gists{/gist_id}","starred_url":"https://api.github.com/users/viridia/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/viridia/subscriptions","organizations_url":"https://api.github.com/users/viridia/orgs","repos_url":"https://api.github.com/users/viridia/repos","events_url":"https://api.github.com/users/viridia/events{/privacy}","received_events_url":"https://api.github.com/users/viridia/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2024-08-19T21:51:15Z","label":{"name":"C-Enhancement","color":"b8b8b8"},"performed_via_github_app":null},{"id":13936251514,"node_id":"LE_lADODf6-U86TemgCzwAAAAM-qlJ6","url":"https://api.github.com/repos/bevyengine/bevy/issues/events/13936251514","actor":{"login":"viridia","id":1166135,"node_id":"MDQ6VXNlcjExNjYxMzU=","avatar_url":"https://avatars.githubusercontent.com/u/1166135?v=4","gravatar_id":"","url":"https://api.github.com/users/viridia","html_url":"https://github.com/viridia","followers_url":"https://api.github.com/users/viridia/followers","following_url":"https://api.github.com/users/viridia/following{/other_user}","gists_url":"https://api.github.com/users/viridia/gists{/gist_id}","starred_url":"https://api.github.com/users/viridia/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/viridia/subscriptions","organizations_url":"https://api.github.com/users/viridia/orgs","repos_url":"https://api.github.com/users/viridia/repos","events_url":"https://api.github.com/users/viridia/events{/privacy}","received_events_url":"https://api.github.com/users/viridia/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2024-08-19T21:51:15Z","label":{"name":"S-Needs-Triage","color":"D876e3"},"performed_via_github_app":null},{"id":13936251580,"node_id":"MEE_lADODf6-U86TemgCzwAAAAM-qlK8","url":"https://api.github.com/repos/bevyengine/bevy/issues/events/13936251580","actor":{"login":"cart","id":2694663,"node_id":"MDQ6VXNlcjI2OTQ2NjM=","avatar_url":"https://avatars.githubusercontent.com/u/2694663?v=4","gravatar_id":"","url":"https://api.github.com/users/cart","html_url":"https://github.com/cart","followers_url":"https://api.github.com/users/cart/followers","following_url":"https://api.github.com/users/cart/following{/other_user}","gists_url":"https://api.github.com/users/cart/gists{/gist_id}","starred_url":"https://api.github.com/users/cart/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cart/subscriptions","organizations_url":"https://api.github.com/users/cart/orgs","repos_url":"https://api.github.com/users/cart/repos","events_url":"https://api.github.com/users/cart/events{/privacy}","received_events_url":"https://api.github.com/users/cart/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2024-08-19T21:51:16Z","performed_via_github_app":null},{"id":13936251589,"node_id":"SE_lADODf6-U86TemgCzwAAAAM-qlLF","url":"https://api.github.com/repos/bevyengine/bevy/issues/events/13936251589","actor":{"login":"cart","id":2694663,"node_id":"MDQ6VXNlcjI2OTQ2NjM=","avatar_url":"https://avatars.githubusercontent.com/u/2694663?v=4","gravatar_id":"","url":"https://api.github.com/users/cart","html_url":"https://github.com/cart","followers_url":"https://api.github.com/users/cart/followers","following_url":"https://api.github.com/users/cart/following{/other_user}","gists_url":"https://api.github.com/users/cart/gists{/gist_id}","starred_url":"https://api.github.com/users/cart/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cart/subscriptions","organizations_url":"https://api.github.com/users/cart/orgs","repos_url":"https://api.github.com/users/cart/repos","events_url":"https://api.github.com/users/cart/events{/privacy}","received_events_url":"https://api.github.com/users/cart/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2024-08-19T21:51:16Z","performed_via_github_app":null},{"id":13988781858,"node_id":"UNLE_lADODf6-U86TemgCzwAAAANBy98i","url":"https://api.github.com/repos/bevyengine/bevy/issues/events/13988781858","actor":{"login":"TrialDragon","id":31419708,"node_id":"MDQ6VXNlcjMxNDE5NzA4","avatar_url":"https://avatars.githubusercontent.com/u/31419708?v=4","gravatar_id":"","url":"https://api.github.com/users/TrialDragon","html_url":"https://github.com/TrialDragon","followers_url":"https://api.github.com/users/TrialDragon/followers","following_url":"https://api.github.com/users/TrialDragon/following{/other_user}","gists_url":"https://api.github.com/users/TrialDragon/gists{/gist_id}","starred_url":"https://api.github.com/users/TrialDragon/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TrialDragon/subscriptions","organizations_url":"https://api.github.com/users/TrialDragon/orgs","repos_url":"https://api.github.com/users/TrialDragon/repos","events_url":"https://api.github.com/users/TrialDragon/events{/privacy}","received_events_url":"https://api.github.com/users/TrialDragon/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"unlabeled","commit_id":null,"commit_url":null,"created_at":"2024-08-23T06:35:37Z","label":{"name":"S-Needs-Triage","color":"D876e3"},"performed_via_github_app":null},{"id":13988781864,"node_id":"LE_lADODf6-U86TemgCzwAAAANBy98o","url":"https://api.github.com/repos/bevyengine/bevy/issues/events/13988781864","actor":{"login":"TrialDragon","id":31419708,"node_id":"MDQ6VXNlcjMxNDE5NzA4","avatar_url":"https://avatars.githubusercontent.com/u/31419708?v=4","gravatar_id":"","url":"https://api.github.com/users/TrialDragon","html_url":"https://github.com/TrialDragon","followers_url":"https://api.github.com/users/TrialDragon/followers","following_url":"https://api.github.com/users/TrialDragon/following{/other_user}","gists_url":"https://api.github.com/users/TrialDragon/gists{/gist_id}","starred_url":"https://api.github.com/users/TrialDragon/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TrialDragon/subscriptions","organizations_url":"https://api.github.com/users/TrialDragon/orgs","repos_url":"https://api.github.com/users/TrialDragon/repos","events_url":"https://api.github.com/users/TrialDragon/events{/privacy}","received_events_url":"https://api.github.com/users/TrialDragon/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2024-08-23T06:35:37Z","label":{"name":"A-UI","color":"c6a751"},"performed_via_github_app":null},{"id":13988781874,"node_id":"LE_lADODf6-U86TemgCzwAAAANBy98y","url":"https://api.github.com/repos/bevyengine/bevy/issues/events/13988781874","actor":{"login":"TrialDragon","id":31419708,"node_id":"MDQ6VXNlcjMxNDE5NzA4","avatar_url":"https://avatars.githubusercontent.com/u/31419708?v=4","gravatar_id":"","url":"https://api.github.com/users/TrialDragon","html_url":"https://github.com/TrialDragon","followers_url":"https://api.github.com/users/TrialDragon/followers","following_url":"https://api.github.com/users/TrialDragon/following{/other_user}","gists_url":"https://api.github.com/users/TrialDragon/gists{/gist_id}","starred_url":"https://api.github.com/users/TrialDragon/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TrialDragon/subscriptions","organizations_url":"https://api.github.com/users/TrialDragon/orgs","repos_url":"https://api.github.com/users/TrialDragon/repos","events_url":"https://api.github.com/users/TrialDragon/events{/privacy}","received_events_url":"https://api.github.com/users/TrialDragon/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2024-08-23T06:35:37Z","label":{"name":"C-Usability","color":"b8b8b8"},"performed_via_github_app":null},{"id":13988781877,"node_id":"LE_lADODf6-U86TemgCzwAAAANBy981","url":"https://api.github.com/repos/bevyengine/bevy/issues/events/13988781877","actor":{"login":"TrialDragon","id":31419708,"node_id":"MDQ6VXNlcjMxNDE5NzA4","avatar_url":"https://avatars.githubusercontent.com/u/31419708?v=4","gravatar_id":"","url":"https://api.github.com/users/TrialDragon","html_url":"https://github.com/TrialDragon","followers_url":"https://api.github.com/users/TrialDragon/followers","following_url":"https://api.github.com/users/TrialDragon/following{/other_user}","gists_url":"https://api.github.com/users/TrialDragon/gists{/gist_id}","starred_url":"https://api.github.com/users/TrialDragon/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TrialDragon/subscriptions","organizations_url":"https://api.github.com/users/TrialDragon/orgs","repos_url":"https://api.github.com/users/TrialDragon/repos","events_url":"https://api.github.com/users/TrialDragon/events{/privacy}","received_events_url":"https://api.github.com/users/TrialDragon/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2024-08-23T06:35:38Z","label":{"name":"S-Needs-Design","color":"D876E3"},"performed_via_github_app":null},{"url":"https://api.github.com/repos/bevyengine/bevy/issues/comments/2310907557","html_url":"https://github.com/bevyengine/bevy/issues/14826#issuecomment-2310907557","issue_url":"https://api.github.com/repos/bevyengine/bevy/issues/14826","id":2310907557,"node_id":"IC_kwDODf6-U86Jvaal","user":{"login":"viridia","id":1166135,"node_id":"MDQ6VXNlcjExNjYxMzU=","avatar_url":"https://avatars.githubusercontent.com/u/1166135?v=4","gravatar_id":"","url":"https://api.github.com/users/viridia","html_url":"https://github.com/viridia","followers_url":"https://api.github.com/users/viridia/followers","following_url":"https://api.github.com/users/viridia/following{/other_user}","gists_url":"https://api.github.com/users/viridia/gists{/gist_id}","starred_url":"https://api.github.com/users/viridia/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/viridia/subscriptions","organizations_url":"https://api.github.com/users/viridia/orgs","repos_url":"https://api.github.com/users/viridia/repos","events_url":"https://api.github.com/users/viridia/events{/privacy}","received_events_url":"https://api.github.com/users/viridia/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-08-26T19:20:53Z","updated_at":"2024-08-26T19:20:53Z","body":"Here's an illustration of how this could be used. The blue-tinted node would be hidden, but its children would be displayed as if they were direct children of the flexbox.\r\n\r\n![hidden-node](https://github.com/user-attachments/assets/04e119fa-96e1-436b-bad7-cfc15df27c8c)\r\n","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/bevyengine/bevy/issues/comments/2310907557/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"viridia","id":1166135,"node_id":"MDQ6VXNlcjExNjYxMzU=","avatar_url":"https://avatars.githubusercontent.com/u/1166135?v=4","gravatar_id":"","url":"https://api.github.com/users/viridia","html_url":"https://github.com/viridia","followers_url":"https://api.github.com/users/viridia/followers","following_url":"https://api.github.com/users/viridia/following{/other_user}","gists_url":"https://api.github.com/users/viridia/gists{/gist_id}","starred_url":"https://api.github.com/users/viridia/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/viridia/subscriptions","organizations_url":"https://api.github.com/users/viridia/orgs","repos_url":"https://api.github.com/users/viridia/repos","events_url":"https://api.github.com/users/viridia/events{/privacy}","received_events_url":"https://api.github.com/users/viridia/received_events","type":"User","user_view_type":"public","site_admin":false}},{"actor":{"login":"viridia","id":1166135,"node_id":"MDQ6VXNlcjExNjYxMzU=","avatar_url":"https://avatars.githubusercontent.com/u/1166135?v=4","gravatar_id":"","url":"https://api.github.com/users/viridia","html_url":"https://github.com/viridia","followers_url":"https://api.github.com/users/viridia/followers","following_url":"https://api.github.com/users/viridia/following{/other_user}","gists_url":"https://api.github.com/users/viridia/gists{/gist_id}","starred_url":"https://api.github.com/users/viridia/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/viridia/subscriptions","organizations_url":"https://api.github.com/users/viridia/orgs","repos_url":"https://api.github.com/users/viridia/repos","events_url":"https://api.github.com/users/viridia/events{/privacy}","received_events_url":"https://api.github.com/users/viridia/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-08-28T18:39:38Z","updated_at":"2024-08-28T18:39:38Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/viridia/quill/issues/22","repository_url":"https://api.github.com/repos/viridia/quill","labels_url":"https://api.github.com/repos/viridia/quill/issues/22/labels{/name}","comments_url":"https://api.github.com/repos/viridia/quill/issues/22/comments","events_url":"https://api.github.com/repos/viridia/quill/issues/22/events","html_url":"https://github.com/viridia/quill/issues/22","id":2471504242,"node_id":"I_kwDOMLp2KM6TUCly","number":22,"title":"Panic despawning non-existent entity","user":{"login":"keis","id":125062,"node_id":"MDQ6VXNlcjEyNTA2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/125062?v=4","gravatar_id":"","url":"https://api.github.com/users/keis","html_url":"https://github.com/keis","followers_url":"https://api.github.com/users/keis/followers","following_url":"https://api.github.com/users/keis/following{/other_user}","gists_url":"https://api.github.com/users/keis/gists{/gist_id}","starred_url":"https://api.github.com/users/keis/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/keis/subscriptions","organizations_url":"https://api.github.com/users/keis/orgs","repos_url":"https://api.github.com/users/keis/repos","events_url":"https://api.github.com/users/keis/events{/privacy}","received_events_url":"https://api.github.com/users/keis/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2024-08-17T12:25:16Z","updated_at":"2024-08-28T19:38:12Z","closed_at":"2024-08-28T18:37:23Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"repository":{"id":817526312,"node_id":"R_kgDOMLp2KA","name":"quill","full_name":"viridia/quill","private":false,"owner":{"login":"viridia","id":1166135,"node_id":"MDQ6VXNlcjExNjYxMzU=","avatar_url":"https://avatars.githubusercontent.com/u/1166135?v=4","gravatar_id":"","url":"https://api.github.com/users/viridia","html_url":"https://github.com/viridia","followers_url":"https://api.github.com/users/viridia/followers","following_url":"https://api.github.com/users/viridia/following{/other_user}","gists_url":"https://api.github.com/users/viridia/gists{/gist_id}","starred_url":"https://api.github.com/users/viridia/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/viridia/subscriptions","organizations_url":"https://api.github.com/users/viridia/orgs","repos_url":"https://api.github.com/users/viridia/repos","events_url":"https://api.github.com/users/viridia/events{/privacy}","received_events_url":"https://api.github.com/users/viridia/received_events","type":"User","user_view_type":"public","site_admin":false},"html_url":"https://github.com/viridia/quill","description":"A reactive UI framework for Bevy","fork":false,"url":"https://api.github.com/repos/viridia/quill","forks_url":"https://api.github.com/repos/viridia/quill/forks","keys_url":"https://api.github.com/repos/viridia/quill/keys{/key_id}","collaborators_url":"https://api.github.com/repos/viridia/quill/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/viridia/quill/teams","hooks_url":"https://api.github.com/repos/viridia/quill/hooks","issue_events_url":"https://api.github.com/repos/viridia/quill/issues/events{/number}","events_url":"https://api.github.com/repos/viridia/quill/events","assignees_url":"https://api.github.com/repos/viridia/quill/assignees{/user}","branches_url":"https://api.github.com/repos/viridia/quill/branches{/branch}","tags_url":"https://api.github.com/repos/viridia/quill/tags","blobs_url":"https://api.github.com/repos/viridia/quill/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/viridia/quill/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/viridia/quill/git/refs{/sha}","trees_url":"https://api.github.com/repos/viridia/quill/git/trees{/sha}","statuses_url":"https://api.github.com/repos/viridia/quill/statuses/{sha}","languages_url":"https://api.github.com/repos/viridia/quill/languages","stargazers_url":"https://api.github.com/repos/viridia/quill/stargazers","contributors_url":"https://api.github.com/repos/viridia/quill/contributors","subscribers_url":"https://api.github.com/repos/viridia/quill/subscribers","subscription_url":"https://api.github.com/repos/viridia/quill/subscription","commits_url":"https://api.github.com/repos/viridia/quill/commits{/sha}","git_commits_url":"https://api.github.com/repos/viridia/quill/git/commits{/sha}","comments_url":"https://api.github.com/repos/viridia/quill/comments{/number}","issue_comment_url":"https://api.github.com/repos/viridia/quill/issues/comments{/number}","contents_url":"https://api.github.com/repos/viridia/quill/contents/{+path}","compare_url":"https://api.github.com/repos/viridia/quill/compare/{base}...{head}","merges_url":"https://api.github.com/repos/viridia/quill/merges","archive_url":"https://api.github.com/repos/viridia/quill/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/viridia/quill/downloads","issues_url":"https://api.github.com/repos/viridia/quill/issues{/number}","pulls_url":"https://api.github.com/repos/viridia/quill/pulls{/number}","milestones_url":"https://api.github.com/repos/viridia/quill/milestones{/number}","notifications_url":"https://api.github.com/repos/viridia/quill/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/viridia/quill/labels{/name}","releases_url":"https://api.github.com/repos/viridia/quill/releases{/id}","deployments_url":"https://api.github.com/repos/viridia/quill/deployments","created_at":"2024-06-19T23:05:44Z","updated_at":"2025-11-09T02:23:43Z","pushed_at":"2025-08-27T22:22:50Z","git_url":"git://github.com/viridia/quill.git","ssh_url":"git@github.com:viridia/quill.git","clone_url":"https://github.com/viridia/quill.git","svn_url":"https://github.com/viridia/quill","homepage":null,"size":4342,"stargazers_count":183,"watchers_count":183,"language":"Rust","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":true,"has_pages":false,"has_discussions":false,"forks_count":13,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":12,"license":{"key":"apache-2.0","name":"Apache License 2.0","spdx_id":"Apache-2.0","url":"https://api.github.com/licenses/apache-2.0","node_id":"MDc6TGljZW5zZTI="},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":[],"visibility":"public","forks":13,"open_issues":12,"watchers":183,"default_branch":"main","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"body":"I have setup using `For::each`, `Cond`, and a `Mutable` which can cause quill to get into trouble trying to despawn an entity.\r\n\r\n```\r\n2024-08-17T12:18:19.750435Z  WARN bevy_ecs::world: error[B0003]: Could not despawn entity Entity { index: 20, generation: 1 } because it doesn't exist in this World. See: https://bevyengine.org/learn/errors/#b0003\r\n```\r\n\r\nI've tried to create a reduced example but could probably be simplified more. Removing either the Cond or the update of the mutable stops the panic from happening. I was able to bisect the issue to be starting from 479fc2aedfd5646abf88aa1f1dec7ee018829813\r\n\r\n- Run the example\r\n- click the button\r\n- panic\r\n\r\n```\r\n//! Example of a simple UI layout\r\n#![feature(impl_trait_in_assoc_type)]\r\n\r\n#[path = \"./common/lib.rs\"]\r\nmod common;\r\n\r\nuse bevy::prelude::*;\r\nuse bevy_mod_picking::prelude::*;\r\nuse bevy_quill::{Cond, Cx, Element, For, Mutable, QuillPlugin, View, ViewTemplate};\r\nuse common::*;\r\n\r\nfn main() {\r\n    App::new()\r\n        .add_plugins((\r\n            DefaultPlugins.set(ImagePlugin::default_nearest()),\r\n            QuillPlugin,\r\n            DefaultPickingPlugins,\r\n        ))\r\n        .init_resource::<Birds>()\r\n        .observe(Birds::on_add)\r\n        .observe(Birds::on_remove)\r\n        .add_systems(Startup, (setup, setup_view_root, setup_birds))\r\n        .add_systems(Update, (close_on_esc, rotate))\r\n        .run();\r\n}\r\n\r\nfn setup_view_root(mut commands: Commands) {\r\n    commands.spawn(Reproduce.to_root());\r\n}\r\n\r\nfn setup_birds(mut commands: Commands) {\r\n    commands.spawn(Bird);\r\n}\r\n\r\n#[derive(Component)]\r\nstruct Bird;\r\n\r\n#[derive(Resource, Default)]\r\nstruct Birds(Vec<Entity>);\r\n\r\nimpl Birds {\r\n    pub fn on_add(trigger: Trigger<OnAdd, Bird>, mut birds: ResMut<Self>) {\r\n        birds.0.push(trigger.entity());\r\n    }\r\n\r\n    pub fn on_remove(trigger: Trigger<OnRemove, Bird>, mut birds: ResMut<Self>) {\r\n        birds.0.retain(|&e| e != trigger.entity());\r\n    }\r\n}\r\n\r\n#[derive(Clone, PartialEq)]\r\nstruct Reproduce;\r\n\r\nimpl ViewTemplate for Reproduce {\r\n    type View = impl View;\r\n\r\n    fn create(&self, cx: &mut Cx) -> Self::View {\r\n        let selected = cx.create_mutable::<Option<Entity>>(None);\r\n        let birds = cx.use_resource::<Birds>().0.clone();\r\n        selected.update(cx, |mut selected: Mut<Option<Entity>>| {\r\n            let new_selected = selected\r\n                .filter(|s| birds.contains(s))\r\n                .or(birds.first().copied());\r\n            if new_selected != *selected {\r\n                info!(\"Updating selected {:?}\", new_selected);\r\n                *selected = new_selected;\r\n            }\r\n        });\r\n        Element::<NodeBundle>::new().children((\r\n            For::each(birds, move |&item| SubComponent { item, selected }),\r\n            Element::<ButtonBundle>::new()\r\n                .insert_dyn(\r\n                    move |_| {\r\n                        On::<Pointer<Click>>::run(\r\n                            move |mut commands: Commands, birds: Query<Entity, With<Bird>>| {\r\n                                info!(\"Clicked\");\r\n                                for bird in &birds {\r\n                                    commands.entity(bird).despawn();\r\n                                }\r\n                            },\r\n                        )\r\n                    },\r\n                    (),\r\n                )\r\n                .children(\"Click me\"),\r\n        ))\r\n    }\r\n}\r\n\r\n#[derive(Clone, PartialEq)]\r\nstruct SubComponent {\r\n    pub item: Entity,\r\n    pub selected: Mutable<Option<Entity>>,\r\n}\r\n\r\nimpl ViewTemplate for SubComponent {\r\n    type View = impl View;\r\n\r\n    fn create(&self, cx: &mut Cx) -> Self::View {\r\n        let selected = self.selected.get(cx);\r\n        Cond::new(\r\n            selected.is_some(),\r\n            Element::<NodeBundle>::new().children(\"Bird\"),\r\n            (),\r\n        )\r\n    }\r\n}\r\n```","reactions":{"url":"https://api.github.com/repos/viridia/quill/issues/22/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/viridia/quill/issues/22/timeline","performed_via_github_app":null,"state_reason":"completed"}},"event":"cross-referenced"},{"url":"https://api.github.com/repos/bevyengine/bevy/issues/comments/2323033955","html_url":"https://github.com/bevyengine/bevy/issues/14826#issuecomment-2323033955","issue_url":"https://api.github.com/repos/bevyengine/bevy/issues/14826","id":2323033955,"node_id":"IC_kwDODf6-U86Kdq9j","user":{"login":"viridia","id":1166135,"node_id":"MDQ6VXNlcjExNjYxMzU=","avatar_url":"https://avatars.githubusercontent.com/u/1166135?v=4","gravatar_id":"","url":"https://api.github.com/users/viridia","html_url":"https://github.com/viridia","followers_url":"https://api.github.com/users/viridia/followers","following_url":"https://api.github.com/users/viridia/following{/other_user}","gists_url":"https://api.github.com/users/viridia/gists{/gist_id}","starred_url":"https://api.github.com/users/viridia/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/viridia/subscriptions","organizations_url":"https://api.github.com/users/viridia/orgs","repos_url":"https://api.github.com/users/viridia/repos","events_url":"https://api.github.com/users/viridia/events{/privacy}","received_events_url":"https://api.github.com/users/viridia/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-08-31T20:18:07Z","updated_at":"2024-08-31T20:21:29Z","body":"A few more comments on this:\r\n\r\nCSS has a similar concept, called `display: content`: https://caniuse.com/css-display-contents .\r\n\r\nAnother reason why I can't simply use components to store the template state (beyond the ones I already mentioned) is the case of nested control constructs, such as a nested \"if\". Since you can't store two components of the same type on an entity, each \"if\" needs to be stored on a separate entity. This is very easy to do if the entities are nested in the same way that the if-statements are. But the if-statements shouldn't show up in the visible scene.\r\n\r\nAlso, the motivation for this ticket comes out of [this discussion](https://github.com/bevyengine/bevy/discussions/14437#discussioncomment-10400104) on the next-gen scene ui design. Specifically, the part where @cart says: \"I'm very in favor of not maintaining a fully separate hierarchy.\"\r\n\r\nAlso, it's important that the solution chosen be agnostic to the rendering technology: that is, the same marker component should work regardless of whether we are talking about ui code or 3d scenes. The reason is because the templating language is meant to work with both, and we shouldn't have to use a different kind of \"if\" statement or \"for\" loop in different contexts. In this sense, it's no different from `Visibility` or `Transform`, which is universal.","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/bevyengine/bevy/issues/comments/2323033955/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"viridia","id":1166135,"node_id":"MDQ6VXNlcjExNjYxMzU=","avatar_url":"https://avatars.githubusercontent.com/u/1166135?v=4","gravatar_id":"","url":"https://api.github.com/users/viridia","html_url":"https://github.com/viridia","followers_url":"https://api.github.com/users/viridia/followers","following_url":"https://api.github.com/users/viridia/following{/other_user}","gists_url":"https://api.github.com/users/viridia/gists{/gist_id}","starred_url":"https://api.github.com/users/viridia/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/viridia/subscriptions","organizations_url":"https://api.github.com/users/viridia/orgs","repos_url":"https://api.github.com/users/viridia/repos","events_url":"https://api.github.com/users/viridia/events{/privacy}","received_events_url":"https://api.github.com/users/viridia/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":14092591435,"node_id":"MEE_lADODf6-U86TemgCzwAAAANH--FL","url":"https://api.github.com/repos/bevyengine/bevy/issues/events/14092591435","actor":{"login":"cart","id":2694663,"node_id":"MDQ6VXNlcjI2OTQ2NjM=","avatar_url":"https://avatars.githubusercontent.com/u/2694663?v=4","gravatar_id":"","url":"https://api.github.com/users/cart","html_url":"https://github.com/cart","followers_url":"https://api.github.com/users/cart/followers","following_url":"https://api.github.com/users/cart/following{/other_user}","gists_url":"https://api.github.com/users/cart/gists{/gist_id}","starred_url":"https://api.github.com/users/cart/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cart/subscriptions","organizations_url":"https://api.github.com/users/cart/orgs","repos_url":"https://api.github.com/users/cart/repos","events_url":"https://api.github.com/users/cart/events{/privacy}","received_events_url":"https://api.github.com/users/cart/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2024-08-31T20:18:08Z","performed_via_github_app":null},{"id":14092591439,"node_id":"SE_lADODf6-U86TemgCzwAAAANH--FP","url":"https://api.github.com/repos/bevyengine/bevy/issues/events/14092591439","actor":{"login":"cart","id":2694663,"node_id":"MDQ6VXNlcjI2OTQ2NjM=","avatar_url":"https://avatars.githubusercontent.com/u/2694663?v=4","gravatar_id":"","url":"https://api.github.com/users/cart","html_url":"https://github.com/cart","followers_url":"https://api.github.com/users/cart/followers","following_url":"https://api.github.com/users/cart/following{/other_user}","gists_url":"https://api.github.com/users/cart/gists{/gist_id}","starred_url":"https://api.github.com/users/cart/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cart/subscriptions","organizations_url":"https://api.github.com/users/cart/orgs","repos_url":"https://api.github.com/users/cart/repos","events_url":"https://api.github.com/users/cart/events{/privacy}","received_events_url":"https://api.github.com/users/cart/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2024-08-31T20:18:08Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/bevyengine/bevy/issues/comments/2323458227","html_url":"https://github.com/bevyengine/bevy/issues/14826#issuecomment-2323458227","issue_url":"https://api.github.com/repos/bevyengine/bevy/issues/14826","id":2323458227,"node_id":"IC_kwDODf6-U86KfSiz","user":{"login":"UkoeHB","id":37489173,"node_id":"MDQ6VXNlcjM3NDg5MTcz","avatar_url":"https://avatars.githubusercontent.com/u/37489173?v=4","gravatar_id":"","url":"https://api.github.com/users/UkoeHB","html_url":"https://github.com/UkoeHB","followers_url":"https://api.github.com/users/UkoeHB/followers","following_url":"https://api.github.com/users/UkoeHB/following{/other_user}","gists_url":"https://api.github.com/users/UkoeHB/gists{/gist_id}","starred_url":"https://api.github.com/users/UkoeHB/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/UkoeHB/subscriptions","organizations_url":"https://api.github.com/users/UkoeHB/orgs","repos_url":"https://api.github.com/users/UkoeHB/repos","events_url":"https://api.github.com/users/UkoeHB/events{/privacy}","received_events_url":"https://api.github.com/users/UkoeHB/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-01T18:50:44Z","updated_at":"2024-09-01T18:54:31Z","body":"Thinking about this a bit more, it could be implemented with a marker component `CollapseChildren` that causes an entity's children to be treated 'as if' they were inserted to the entity's position in its parent's `Children` list for purposes of hierarchy traversal (UI layout, visibility, transform). If the entity has no children, or all children are 'collapse', then the entity will be skipped over entirely.\r\n\r\nThis would solve another issue in UI where it's useful to attach observers as children of nodes so they will be auto-despawned when nodes are despawned.","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/bevyengine/bevy/issues/comments/2323458227/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"UkoeHB","id":37489173,"node_id":"MDQ6VXNlcjM3NDg5MTcz","avatar_url":"https://avatars.githubusercontent.com/u/37489173?v=4","gravatar_id":"","url":"https://api.github.com/users/UkoeHB","html_url":"https://github.com/UkoeHB","followers_url":"https://api.github.com/users/UkoeHB/followers","following_url":"https://api.github.com/users/UkoeHB/following{/other_user}","gists_url":"https://api.github.com/users/UkoeHB/gists{/gist_id}","starred_url":"https://api.github.com/users/UkoeHB/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/UkoeHB/subscriptions","organizations_url":"https://api.github.com/users/UkoeHB/orgs","repos_url":"https://api.github.com/users/UkoeHB/repos","events_url":"https://api.github.com/users/UkoeHB/events{/privacy}","received_events_url":"https://api.github.com/users/UkoeHB/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/bevyengine/bevy/issues/comments/2323468763","html_url":"https://github.com/bevyengine/bevy/issues/14826#issuecomment-2323468763","issue_url":"https://api.github.com/repos/bevyengine/bevy/issues/14826","id":2323468763,"node_id":"IC_kwDODf6-U86KfVHb","user":{"login":"viridia","id":1166135,"node_id":"MDQ6VXNlcjExNjYxMzU=","avatar_url":"https://avatars.githubusercontent.com/u/1166135?v=4","gravatar_id":"","url":"https://api.github.com/users/viridia","html_url":"https://github.com/viridia","followers_url":"https://api.github.com/users/viridia/followers","following_url":"https://api.github.com/users/viridia/following{/other_user}","gists_url":"https://api.github.com/users/viridia/gists{/gist_id}","starred_url":"https://api.github.com/users/viridia/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/viridia/subscriptions","organizations_url":"https://api.github.com/users/viridia/orgs","repos_url":"https://api.github.com/users/viridia/repos","events_url":"https://api.github.com/users/viridia/events{/privacy}","received_events_url":"https://api.github.com/users/viridia/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-01T19:26:38Z","updated_at":"2024-09-01T19:30:18Z","body":"There's been some discussion about naming. I chose the word \"fragment\" because there's an analogous concept in React, but I'm open to suggestions.\r\n\r\nAnother word that might apply here is \"flatten\" or \"flat\".\r\n\r\nAlso, @nicoburns Suggested the idea of an iterator or library function which would do the recursive traversal needed to produce the flat list of visible entities - that is, it would traverse into any fragments and produce a flat sequence of entities. This could then be used by the layout code.\r\n\r\nAnother open question is whether to use a marker component or a new visibility variant. There are pros and cons:\r\n* The advantage of a visibility variant is that we don't have to query a new component in the layout and extractor code.\r\n* The disadvantage is that visibility calculations which traverse upwards - for things like visibility inheritance - now have to be smart enough to skip over fragments.","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/bevyengine/bevy/issues/comments/2323468763/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"viridia","id":1166135,"node_id":"MDQ6VXNlcjExNjYxMzU=","avatar_url":"https://avatars.githubusercontent.com/u/1166135?v=4","gravatar_id":"","url":"https://api.github.com/users/viridia","html_url":"https://github.com/viridia","followers_url":"https://api.github.com/users/viridia/followers","following_url":"https://api.github.com/users/viridia/following{/other_user}","gists_url":"https://api.github.com/users/viridia/gists{/gist_id}","starred_url":"https://api.github.com/users/viridia/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/viridia/subscriptions","organizations_url":"https://api.github.com/users/viridia/orgs","repos_url":"https://api.github.com/users/viridia/repos","events_url":"https://api.github.com/users/viridia/events{/privacy}","received_events_url":"https://api.github.com/users/viridia/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":14095476446,"node_id":"MEE_lADODf6-U86TemgCzwAAAANIJ-be","url":"https://api.github.com/repos/bevyengine/bevy/issues/events/14095476446","actor":{"login":"nicoburns","id":1007307,"node_id":"MDQ6VXNlcjEwMDczMDc=","avatar_url":"https://avatars.githubusercontent.com/u/1007307?v=4","gravatar_id":"","url":"https://api.github.com/users/nicoburns","html_url":"https://github.com/nicoburns","followers_url":"https://api.github.com/users/nicoburns/followers","following_url":"https://api.github.com/users/nicoburns/following{/other_user}","gists_url":"https://api.github.com/users/nicoburns/gists{/gist_id}","starred_url":"https://api.github.com/users/nicoburns/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nicoburns/subscriptions","organizations_url":"https://api.github.com/users/nicoburns/orgs","repos_url":"https://api.github.com/users/nicoburns/repos","events_url":"https://api.github.com/users/nicoburns/events{/privacy}","received_events_url":"https://api.github.com/users/nicoburns/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2024-09-01T19:30:19Z","performed_via_github_app":null},{"id":14095476450,"node_id":"SE_lADODf6-U86TemgCzwAAAANIJ-bi","url":"https://api.github.com/repos/bevyengine/bevy/issues/events/14095476450","actor":{"login":"nicoburns","id":1007307,"node_id":"MDQ6VXNlcjEwMDczMDc=","avatar_url":"https://avatars.githubusercontent.com/u/1007307?v=4","gravatar_id":"","url":"https://api.github.com/users/nicoburns","html_url":"https://github.com/nicoburns","followers_url":"https://api.github.com/users/nicoburns/followers","following_url":"https://api.github.com/users/nicoburns/following{/other_user}","gists_url":"https://api.github.com/users/nicoburns/gists{/gist_id}","starred_url":"https://api.github.com/users/nicoburns/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nicoburns/subscriptions","organizations_url":"https://api.github.com/users/nicoburns/orgs","repos_url":"https://api.github.com/users/nicoburns/repos","events_url":"https://api.github.com/users/nicoburns/events{/privacy}","received_events_url":"https://api.github.com/users/nicoburns/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2024-09-01T19:30:19Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/bevyengine/bevy/issues/comments/2323479962","html_url":"https://github.com/bevyengine/bevy/issues/14826#issuecomment-2323479962","issue_url":"https://api.github.com/repos/bevyengine/bevy/issues/14826","id":2323479962,"node_id":"IC_kwDODf6-U86KfX2a","user":{"login":"UkoeHB","id":37489173,"node_id":"MDQ6VXNlcjM3NDg5MTcz","avatar_url":"https://avatars.githubusercontent.com/u/37489173?v=4","gravatar_id":"","url":"https://api.github.com/users/UkoeHB","html_url":"https://github.com/UkoeHB","followers_url":"https://api.github.com/users/UkoeHB/followers","following_url":"https://api.github.com/users/UkoeHB/following{/other_user}","gists_url":"https://api.github.com/users/UkoeHB/gists{/gist_id}","starred_url":"https://api.github.com/users/UkoeHB/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/UkoeHB/subscriptions","organizations_url":"https://api.github.com/users/UkoeHB/orgs","repos_url":"https://api.github.com/users/UkoeHB/repos","events_url":"https://api.github.com/users/UkoeHB/events{/privacy}","received_events_url":"https://api.github.com/users/UkoeHB/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-01T20:03:52Z","updated_at":"2024-09-01T20:03:52Z","body":"We should assume users don't know anything about React and pick a name that makes sense within Bevy. To me, who does not know React, `Fragment` doesn't tell me anything about what the component actually does to an entity. I would be fine with `FlattenChildren` since that lines up with rust iterator flattening.\r\n\r\n> Another open question is whether to use a marker component or a new visibility variant.\r\n\r\nVisibility is about what gets rendered, not how trees of entities are traversed. We should keep the concepts separate.\r\n","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/bevyengine/bevy/issues/comments/2323479962/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"UkoeHB","id":37489173,"node_id":"MDQ6VXNlcjM3NDg5MTcz","avatar_url":"https://avatars.githubusercontent.com/u/37489173?v=4","gravatar_id":"","url":"https://api.github.com/users/UkoeHB","html_url":"https://github.com/UkoeHB","followers_url":"https://api.github.com/users/UkoeHB/followers","following_url":"https://api.github.com/users/UkoeHB/following{/other_user}","gists_url":"https://api.github.com/users/UkoeHB/gists{/gist_id}","starred_url":"https://api.github.com/users/UkoeHB/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/UkoeHB/subscriptions","organizations_url":"https://api.github.com/users/UkoeHB/orgs","repos_url":"https://api.github.com/users/UkoeHB/repos","events_url":"https://api.github.com/users/UkoeHB/events{/privacy}","received_events_url":"https://api.github.com/users/UkoeHB/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/bevyengine/bevy/issues/comments/2351509572","html_url":"https://github.com/bevyengine/bevy/issues/14826#issuecomment-2351509572","issue_url":"https://api.github.com/repos/bevyengine/bevy/issues/14826","id":2351509572,"node_id":"IC_kwDODf6-U86MKTBE","user":{"login":"Diddykonga","id":2092062,"node_id":"MDQ6VXNlcjIwOTIwNjI=","avatar_url":"https://avatars.githubusercontent.com/u/2092062?v=4","gravatar_id":"","url":"https://api.github.com/users/Diddykonga","html_url":"https://github.com/Diddykonga","followers_url":"https://api.github.com/users/Diddykonga/followers","following_url":"https://api.github.com/users/Diddykonga/following{/other_user}","gists_url":"https://api.github.com/users/Diddykonga/gists{/gist_id}","starred_url":"https://api.github.com/users/Diddykonga/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Diddykonga/subscriptions","organizations_url":"https://api.github.com/users/Diddykonga/orgs","repos_url":"https://api.github.com/users/Diddykonga/repos","events_url":"https://api.github.com/users/Diddykonga/events{/privacy}","received_events_url":"https://api.github.com/users/Diddykonga/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-15T10:03:59Z","updated_at":"2024-09-15T10:03:59Z","body":"Not sure if it makes sense or not, but would be nice if this were more modular and had specific naming that represented what it does.\r\n`NoUILayout` + `NoUIRender`","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/bevyengine/bevy/issues/comments/2351509572/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"Diddykonga","id":2092062,"node_id":"MDQ6VXNlcjIwOTIwNjI=","avatar_url":"https://avatars.githubusercontent.com/u/2092062?v=4","gravatar_id":"","url":"https://api.github.com/users/Diddykonga","html_url":"https://github.com/Diddykonga","followers_url":"https://api.github.com/users/Diddykonga/followers","following_url":"https://api.github.com/users/Diddykonga/following{/other_user}","gists_url":"https://api.github.com/users/Diddykonga/gists{/gist_id}","starred_url":"https://api.github.com/users/Diddykonga/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Diddykonga/subscriptions","organizations_url":"https://api.github.com/users/Diddykonga/orgs","repos_url":"https://api.github.com/users/Diddykonga/repos","events_url":"https://api.github.com/users/Diddykonga/events{/privacy}","received_events_url":"https://api.github.com/users/Diddykonga/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/bevyengine/bevy/issues/comments/2351580008","html_url":"https://github.com/bevyengine/bevy/issues/14826#issuecomment-2351580008","issue_url":"https://api.github.com/repos/bevyengine/bevy/issues/14826","id":2351580008,"node_id":"IC_kwDODf6-U86MKkNo","user":{"login":"villor","id":7102243,"node_id":"MDQ6VXNlcjcxMDIyNDM=","avatar_url":"https://avatars.githubusercontent.com/u/7102243?v=4","gravatar_id":"","url":"https://api.github.com/users/villor","html_url":"https://github.com/villor","followers_url":"https://api.github.com/users/villor/followers","following_url":"https://api.github.com/users/villor/following{/other_user}","gists_url":"https://api.github.com/users/villor/gists{/gist_id}","starred_url":"https://api.github.com/users/villor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/villor/subscriptions","organizations_url":"https://api.github.com/users/villor/orgs","repos_url":"https://api.github.com/users/villor/repos","events_url":"https://api.github.com/users/villor/events{/privacy}","received_events_url":"https://api.github.com/users/villor/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-15T12:50:35Z","updated_at":"2024-09-15T12:50:35Z","body":"It seems like this would benefit from some kind of generic solution for _shadow hierarchies_ in `bevy_hierarchy`.\r\n\r\nWe want to iterate children as if some entities in the hierarchy does not exist, let's call those _shadow entities_. The children of those shadow entities are considered children of the shadow entity's first non-shadow ancestor, unless the child is also a shadow entity, in which case the traversal continues...\r\n\r\nSo, we have a _shadow hierarchy_. A hierarchy where some entities are treated as _shadow entities_.\r\n\r\n### Hierarchy traversal\r\nToday we have `iter_descendants`, which traverses the whole parent-child hierarchy breadth-first.\r\n\r\nNot sure how viable this is, but maybe we can add extensions to traverse the hierarchy with a `QueryFilter` applied?\r\n\r\nSomething like:\r\n- `iter_descendants_shadowed::<F: QueryFilter>`: Works just like `iter_descendants`, but filters out entities that match the QueryFilter (those are considered shadow entities).\r\n- `iter_ancestors_shadowed::<F: QueryFilter>`: Works just like `iter_ancestors`, but filters out entities that match the QueryFilter (those are considered shadow entities).\r\n- `iter_children_shadowed::<F: QueryFilter>`: Works like `iter_descendants_shadowed` but stops traversing further down when a non-shadow entity is found, treating the first non-shadow as a child.\r\n\r\nFor the purpose of UI fragments, it could be explicit by using a filter like `Without<Fragment>`. Or it could be implicit by using something like `With<Node>`.\r\n\r\n### Potential optimization: Retained shadow hierarchies\r\nOne downside of the extensions above are that they might do some unnecessary tree traversal on every frame. Compare this to how layout code works today, iterating `Children` directly, no traversal necessary.\r\n\r\nOne way to solve this could be to allow defining shadow hierarchies upfront in `bevy_hierarchy`, which would store them just like `Parent` and `Children`, and update them automatically.\r\n\r\nWe could add a new pair of components:\r\n```rust\r\n#[derive(Component)]\r\nstruct ShadowParent<F: QueryFilter>(pub(crate) Entity);\r\n\r\n#[derive(Component)]\r\nstruct ShadowChildren<F: QueryFilter>(pub(crate) SmallVec<[Entity; 8]>);\r\n```\r\n\r\nTo make use of these, the shadow hierarchy would need to be initialized upfront:\r\n```rust\r\napp.init_shadow_hierarchy::<Without<LayoutFragment>>();\r\n```\r\nThis would set up the systems/hooks/observers necessary to keep them up-to-date.\r\n\r\nThose components could then be used in place of `Parent` or `Children` in a system, for example for UI layout:\r\n```rust\r\nfn ui_layout_system(\r\n    /* ... */\r\n    children_query: Query<(Entity, Ref<ShadowChildren<Without<LayoutFragment>>), With<Node>>,\r\n    just_children_query: Query<&ShadowChildren<Without<LayoutFragment>>,\r\n    /* ... */\r\n) {\r\n    /* ... */\r\n}\r\n```","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/bevyengine/bevy/issues/comments/2351580008/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"villor","id":7102243,"node_id":"MDQ6VXNlcjcxMDIyNDM=","avatar_url":"https://avatars.githubusercontent.com/u/7102243?v=4","gravatar_id":"","url":"https://api.github.com/users/villor","html_url":"https://github.com/villor","followers_url":"https://api.github.com/users/villor/followers","following_url":"https://api.github.com/users/villor/following{/other_user}","gists_url":"https://api.github.com/users/villor/gists{/gist_id}","starred_url":"https://api.github.com/users/villor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/villor/subscriptions","organizations_url":"https://api.github.com/users/villor/orgs","repos_url":"https://api.github.com/users/villor/repos","events_url":"https://api.github.com/users/villor/events{/privacy}","received_events_url":"https://api.github.com/users/villor/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/bevyengine/bevy/issues/comments/2351697625","html_url":"https://github.com/bevyengine/bevy/issues/14826#issuecomment-2351697625","issue_url":"https://api.github.com/repos/bevyengine/bevy/issues/14826","id":2351697625,"node_id":"IC_kwDODf6-U86MLA7Z","user":{"login":"viridia","id":1166135,"node_id":"MDQ6VXNlcjExNjYxMzU=","avatar_url":"https://avatars.githubusercontent.com/u/1166135?v=4","gravatar_id":"","url":"https://api.github.com/users/viridia","html_url":"https://github.com/viridia","followers_url":"https://api.github.com/users/viridia/followers","following_url":"https://api.github.com/users/viridia/following{/other_user}","gists_url":"https://api.github.com/users/viridia/gists{/gist_id}","starred_url":"https://api.github.com/users/viridia/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/viridia/subscriptions","organizations_url":"https://api.github.com/users/viridia/orgs","repos_url":"https://api.github.com/users/viridia/repos","events_url":"https://api.github.com/users/viridia/events{/privacy}","received_events_url":"https://api.github.com/users/viridia/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-15T17:44:23Z","updated_at":"2024-09-15T17:44:23Z","body":"I kind of like the name \"shadow hierarchies\".","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/bevyengine/bevy/issues/comments/2351697625/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"viridia","id":1166135,"node_id":"MDQ6VXNlcjExNjYxMzU=","avatar_url":"https://avatars.githubusercontent.com/u/1166135?v=4","gravatar_id":"","url":"https://api.github.com/users/viridia","html_url":"https://github.com/viridia","followers_url":"https://api.github.com/users/viridia/followers","following_url":"https://api.github.com/users/viridia/following{/other_user}","gists_url":"https://api.github.com/users/viridia/gists{/gist_id}","starred_url":"https://api.github.com/users/viridia/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/viridia/subscriptions","organizations_url":"https://api.github.com/users/viridia/orgs","repos_url":"https://api.github.com/users/viridia/repos","events_url":"https://api.github.com/users/viridia/events{/privacy}","received_events_url":"https://api.github.com/users/viridia/received_events","type":"User","user_view_type":"public","site_admin":false}},{"actor":{"login":"villor","id":7102243,"node_id":"MDQ6VXNlcjcxMDIyNDM=","avatar_url":"https://avatars.githubusercontent.com/u/7102243?v=4","gravatar_id":"","url":"https://api.github.com/users/villor","html_url":"https://github.com/villor","followers_url":"https://api.github.com/users/villor/followers","following_url":"https://api.github.com/users/villor/following{/other_user}","gists_url":"https://api.github.com/users/villor/gists{/gist_id}","starred_url":"https://api.github.com/users/villor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/villor/subscriptions","organizations_url":"https://api.github.com/users/villor/orgs","repos_url":"https://api.github.com/users/villor/repos","events_url":"https://api.github.com/users/villor/events{/privacy}","received_events_url":"https://api.github.com/users/villor/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-15T21:44:57Z","updated_at":"2024-09-15T21:44:57Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/bevyengine/bevy/issues/15238","repository_url":"https://api.github.com/repos/bevyengine/bevy","labels_url":"https://api.github.com/repos/bevyengine/bevy/issues/15238/labels{/name}","comments_url":"https://api.github.com/repos/bevyengine/bevy/issues/15238/comments","events_url":"https://api.github.com/repos/bevyengine/bevy/issues/15238/events","html_url":"https://github.com/bevyengine/bevy/pull/15238","id":2527216104,"node_id":"PR_kwDODf6-U857jqs5","number":15238,"title":"Shadow Hierarchies (aka fragments/auxilary nodes)","user":{"login":"villor","id":7102243,"node_id":"MDQ6VXNlcjcxMDIyNDM=","avatar_url":"https://avatars.githubusercontent.com/u/7102243?v=4","gravatar_id":"","url":"https://api.github.com/users/villor","html_url":"https://github.com/villor","followers_url":"https://api.github.com/users/villor/followers","following_url":"https://api.github.com/users/villor/following{/other_user}","gists_url":"https://api.github.com/users/villor/gists{/gist_id}","starred_url":"https://api.github.com/users/villor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/villor/subscriptions","organizations_url":"https://api.github.com/users/villor/orgs","repos_url":"https://api.github.com/users/villor/repos","events_url":"https://api.github.com/users/villor/events{/privacy}","received_events_url":"https://api.github.com/users/villor/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1795619326,"node_id":"MDU6TGFiZWwxNzk1NjE5MzI2","url":"https://api.github.com/repos/bevyengine/bevy/labels/C-Feature","name":"C-Feature","color":"b8b8b8","default":false,"description":"A new feature, making something new possible"},{"id":2197761682,"node_id":"MDU6TGFiZWwyMTk3NzYxNjgy","url":"https://api.github.com/repos/bevyengine/bevy/labels/A-ECS","name":"A-ECS","color":"c6a751","default":false,"description":"Entities, components, systems, and events"},{"id":2276469463,"node_id":"MDU6TGFiZWwyMjc2NDY5NDYz","url":"https://api.github.com/repos/bevyengine/bevy/labels/A-UI","name":"A-UI","color":"c6a751","default":false,"description":"Graphical user interfaces, styles, layouts, and widgets"},{"id":3166152189,"node_id":"MDU6TGFiZWwzMTY2MTUyMTg5","url":"https://api.github.com/repos/bevyengine/bevy/labels/S-Needs-Design","name":"S-Needs-Design","color":"D876E3","default":false,"description":"This issue requires design work to think about how it would best be accomplished"},{"id":6600141374,"node_id":"LA_kwDODf6-U88AAAABiWYqPg","url":"https://api.github.com/repos/bevyengine/bevy/labels/M-Release-Note","name":"M-Release-Note","color":"006B75","default":false,"description":"Work that should be called out in the blog due to impact"},{"id":6899552399,"node_id":"LA_kwDODf6-U88AAAABmz7Qjw","url":"https://api.github.com/repos/bevyengine/bevy/labels/X-Contentious","name":"X-Contentious","color":"D93F0B","default":false,"description":"There are nontrivial implications that should be thought through"},{"id":6899591173,"node_id":"LA_kwDODf6-U88AAAABmz9oBQ","url":"https://api.github.com/repos/bevyengine/bevy/labels/S-Waiting-on-Author","name":"S-Waiting-on-Author","color":"D876E3","default":false,"description":"The author needs to make changes or address concerns before this can be merged"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":9,"created_at":"2024-09-15T21:44:56Z","updated_at":"2025-01-28T04:45:09Z","closed_at":"2024-09-20T23:56:07Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"draft":true,"repository":{"id":234798675,"node_id":"MDEwOlJlcG9zaXRvcnkyMzQ3OTg2NzU=","name":"bevy","full_name":"bevyengine/bevy","private":false,"owner":{"login":"bevyengine","id":60047606,"node_id":"MDEyOk9yZ2FuaXphdGlvbjYwMDQ3NjA2","avatar_url":"https://avatars.githubusercontent.com/u/60047606?v=4","gravatar_id":"","url":"https://api.github.com/users/bevyengine","html_url":"https://github.com/bevyengine","followers_url":"https://api.github.com/users/bevyengine/followers","following_url":"https://api.github.com/users/bevyengine/following{/other_user}","gists_url":"https://api.github.com/users/bevyengine/gists{/gist_id}","starred_url":"https://api.github.com/users/bevyengine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bevyengine/subscriptions","organizations_url":"https://api.github.com/users/bevyengine/orgs","repos_url":"https://api.github.com/users/bevyengine/repos","events_url":"https://api.github.com/users/bevyengine/events{/privacy}","received_events_url":"https://api.github.com/users/bevyengine/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/bevyengine/bevy","description":"A refreshingly simple data-driven game engine built in Rust","fork":false,"url":"https://api.github.com/repos/bevyengine/bevy","forks_url":"https://api.github.com/repos/bevyengine/bevy/forks","keys_url":"https://api.github.com/repos/bevyengine/bevy/keys{/key_id}","collaborators_url":"https://api.github.com/repos/bevyengine/bevy/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/bevyengine/bevy/teams","hooks_url":"https://api.github.com/repos/bevyengine/bevy/hooks","issue_events_url":"https://api.github.com/repos/bevyengine/bevy/issues/events{/number}","events_url":"https://api.github.com/repos/bevyengine/bevy/events","assignees_url":"https://api.github.com/repos/bevyengine/bevy/assignees{/user}","branches_url":"https://api.github.com/repos/bevyengine/bevy/branches{/branch}","tags_url":"https://api.github.com/repos/bevyengine/bevy/tags","blobs_url":"https://api.github.com/repos/bevyengine/bevy/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/bevyengine/bevy/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/bevyengine/bevy/git/refs{/sha}","trees_url":"https://api.github.com/repos/bevyengine/bevy/git/trees{/sha}","statuses_url":"https://api.github.com/repos/bevyengine/bevy/statuses/{sha}","languages_url":"https://api.github.com/repos/bevyengine/bevy/languages","stargazers_url":"https://api.github.com/repos/bevyengine/bevy/stargazers","contributors_url":"https://api.github.com/repos/bevyengine/bevy/contributors","subscribers_url":"https://api.github.com/repos/bevyengine/bevy/subscribers","subscription_url":"https://api.github.com/repos/bevyengine/bevy/subscription","commits_url":"https://api.github.com/repos/bevyengine/bevy/commits{/sha}","git_commits_url":"https://api.github.com/repos/bevyengine/bevy/git/commits{/sha}","comments_url":"https://api.github.com/repos/bevyengine/bevy/comments{/number}","issue_comment_url":"https://api.github.com/repos/bevyengine/bevy/issues/comments{/number}","contents_url":"https://api.github.com/repos/bevyengine/bevy/contents/{+path}","compare_url":"https://api.github.com/repos/bevyengine/bevy/compare/{base}...{head}","merges_url":"https://api.github.com/repos/bevyengine/bevy/merges","archive_url":"https://api.github.com/repos/bevyengine/bevy/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/bevyengine/bevy/downloads","issues_url":"https://api.github.com/repos/bevyengine/bevy/issues{/number}","pulls_url":"https://api.github.com/repos/bevyengine/bevy/pulls{/number}","milestones_url":"https://api.github.com/repos/bevyengine/bevy/milestones{/number}","notifications_url":"https://api.github.com/repos/bevyengine/bevy/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/bevyengine/bevy/labels{/name}","releases_url":"https://api.github.com/repos/bevyengine/bevy/releases{/id}","deployments_url":"https://api.github.com/repos/bevyengine/bevy/deployments","created_at":"2020-01-18T21:13:55Z","updated_at":"2025-11-10T00:30:24Z","pushed_at":"2025-11-09T20:05:46Z","git_url":"git://github.com/bevyengine/bevy.git","ssh_url":"git@github.com:bevyengine/bevy.git","clone_url":"https://github.com/bevyengine/bevy.git","svn_url":"https://github.com/bevyengine/bevy","homepage":"https://bevy.org","size":152673,"stargazers_count":42996,"watchers_count":42996,"language":"Rust","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":false,"has_pages":true,"has_discussions":true,"forks_count":4220,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":3116,"license":{"key":"apache-2.0","name":"Apache License 2.0","spdx_id":"Apache-2.0","url":"https://api.github.com/licenses/apache-2.0","node_id":"MDc6TGljZW5zZTI="},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["bevy","game-development","game-engine","gamedev","open-source","rust"],"visibility":"public","forks":4220,"open_issues":3116,"watchers":42996,"default_branch":"main","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"pull_request":{"url":"https://api.github.com/repos/bevyengine/bevy/pulls/15238","html_url":"https://github.com/bevyengine/bevy/pull/15238","diff_url":"https://github.com/bevyengine/bevy/pull/15238.diff","patch_url":"https://github.com/bevyengine/bevy/pull/15238.patch","merged_at":null},"body":"_This is my first ever draft/PR for Bevy, so please let me know if there is anything missing_\r\n\r\n# Objective\r\nSee for background: #14826\r\n\r\n- TLDR: In some cases (like reactive UIs), we need a way to \"skip\" certain entities in the tree, treating their children as children of their parent in some contexts, like layout. Similar to how `Fragment` works in react.\r\n\r\n## Solution\r\n\r\nIt seems like this would benefit from some kind of generic solution for this in `bevy_hierarchy`, I'm going to call it _shadow hierarchies_ for now.\r\n\r\nWe want to iterate children as if some entities in the hierarchy does not exist, let's call those `shadow entities`. The children of those shadow entities are considered children of the shadow entity's first non-shadow ancestor, unless the child is also a shadow entity, in which case the traversal continues...\r\n\r\nSo, we have a `shadow hierarchy`. A hierarchy where some entities are treated as `shadow entities`. (naming open for discussion)\r\n\r\nThe proposed solution is to use a marker component to mark shadow entities, for this example let's call it `ShadowChild`.\r\n\r\nI have added a generic extension to traverse the shadow hierarchy finding the children of an entity: `iter_children_shadowed`. The function can be called on a `Query<Option<&Children>, Option<&T>>` where `T` is the component marking the shadow entities.\r\n\r\nFor completeness, there should probably also be a `get_parent_shadowed` (not yet implemented), which would get the closest non-shadow ancestor or `None` if not present.\r\n\r\n## Testing\r\n- New testcase added for `iter_children_shadowed` to test traversal with shadow entities both as a parent and leaf node.\r\n\r\n## Questions\r\n- Naming of stuff?\r\n- Should there be one \"generic\" marker component for shadow entities used by engine things like UI layout, transform propagation, visibility propagation etc? E.g. a `Fragment`/`ShadowChild`. Or should things be kept separate with their own shadow hierarchies? E.g a `LayoutShadowChild`/`SpatialShadowChild` etc\r\n- Is `iter_children_shadowed` enough for updating the UI layout code, or are further optimizations necessary?\r\n- Do we also want to implement shadow hierarchies for transform/visibility propagation?\r\n\r\n## TODO\r\n- [x] Implement `iter_children_shadowed`\r\n- [ ] Implement `get_parent_shadowed`\r\n- [ ] Update UI layout system (and maybe also transform/visibility propagation?) to use a shadow hierarchy\r\n- [ ] Optimize? see below\r\n\r\n### Potential optimization: Retained shadow hierarchies\r\n_Needs opinions. Is this necessary?_\r\nOne downside of the extensions above are that they might do some unnecessary tree traversal on every frame. Compare this to how layout code works today, iterating `Children` directly, no traversal necessary.\r\n\r\nOne way to solve this could be to allow defining shadow hierarchies upfront in `bevy_hierarchy`, which would store them just like `Parent` and `Children`, and update them automatically.\r\n\r\nWe could add a new pair of components:\r\n```rust\r\n#[derive(Component)]\r\nstruct ShadowParent<T: Component>(pub(crate) Entity);\r\n\r\n#[derive(Component)]\r\nstruct ShadowChildren<T: Component>(pub(crate) SmallVec<[Entity; 8]>);\r\n```\r\n\r\nTo make use of these, the shadow hierarchy would need to be initialized upfront:\r\n```rust\r\napp.init_shadow_hierarchy::<ShadowChild>();\r\n```\r\nThis would set up the systems/hooks/observers necessary to keep them up-to-date.\r\n\r\nThose components could then be used as drop-in replacements for `Parent` and `Children` in systems where its necessary to skip certain entities.\r\n","reactions":{"url":"https://api.github.com/repos/bevyengine/bevy/issues/15238/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/bevyengine/bevy/issues/15238/timeline","performed_via_github_app":null,"state_reason":null}},"event":"cross-referenced"},{"url":"https://api.github.com/repos/bevyengine/bevy/issues/comments/2351802967","html_url":"https://github.com/bevyengine/bevy/issues/14826#issuecomment-2351802967","issue_url":"https://api.github.com/repos/bevyengine/bevy/issues/14826","id":2351802967,"node_id":"IC_kwDODf6-U86MLapX","user":{"login":"villor","id":7102243,"node_id":"MDQ6VXNlcjcxMDIyNDM=","avatar_url":"https://avatars.githubusercontent.com/u/7102243?v=4","gravatar_id":"","url":"https://api.github.com/users/villor","html_url":"https://github.com/villor","followers_url":"https://api.github.com/users/villor/followers","following_url":"https://api.github.com/users/villor/following{/other_user}","gists_url":"https://api.github.com/users/villor/gists{/gist_id}","starred_url":"https://api.github.com/users/villor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/villor/subscriptions","organizations_url":"https://api.github.com/users/villor/orgs","repos_url":"https://api.github.com/users/villor/repos","events_url":"https://api.github.com/users/villor/events{/privacy}","received_events_url":"https://api.github.com/users/villor/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-15T21:49:23Z","updated_at":"2024-09-15T21:49:23Z","body":"Decided that the QueryFilter approach was a little bit too much, and tried implementing traversal for  \"shadow hierarchies\" using a marker for the shadow entities.\r\nDraft at #15238","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/bevyengine/bevy/issues/comments/2351802967/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"villor","id":7102243,"node_id":"MDQ6VXNlcjcxMDIyNDM=","avatar_url":"https://avatars.githubusercontent.com/u/7102243?v=4","gravatar_id":"","url":"https://api.github.com/users/villor","html_url":"https://github.com/villor","followers_url":"https://api.github.com/users/villor/followers","following_url":"https://api.github.com/users/villor/following{/other_user}","gists_url":"https://api.github.com/users/villor/gists{/gist_id}","starred_url":"https://api.github.com/users/villor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/villor/subscriptions","organizations_url":"https://api.github.com/users/villor/orgs","repos_url":"https://api.github.com/users/villor/repos","events_url":"https://api.github.com/users/villor/events{/privacy}","received_events_url":"https://api.github.com/users/villor/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/bevyengine/bevy/issues/comments/2352272994","html_url":"https://github.com/bevyengine/bevy/issues/14826#issuecomment-2352272994","issue_url":"https://api.github.com/repos/bevyengine/bevy/issues/14826","id":2352272994,"node_id":"IC_kwDODf6-U86MNNZi","user":{"login":"viridia","id":1166135,"node_id":"MDQ6VXNlcjExNjYxMzU=","avatar_url":"https://avatars.githubusercontent.com/u/1166135?v=4","gravatar_id":"","url":"https://api.github.com/users/viridia","html_url":"https://github.com/viridia","followers_url":"https://api.github.com/users/viridia/followers","following_url":"https://api.github.com/users/viridia/following{/other_user}","gists_url":"https://api.github.com/users/viridia/gists{/gist_id}","starred_url":"https://api.github.com/users/viridia/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/viridia/subscriptions","organizations_url":"https://api.github.com/users/viridia/orgs","repos_url":"https://api.github.com/users/viridia/repos","events_url":"https://api.github.com/users/viridia/events{/privacy}","received_events_url":"https://api.github.com/users/viridia/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-16T08:15:38Z","updated_at":"2024-09-16T08:15:38Z","body":"A few more comments:\r\n\r\n1) I'd be OK with renaming this issue \"Shadow Nodes\" if no one objects.\r\n2) I still prefer using `Visibility` for this, and here's my reasoning: we want most of the Bevy code to be unaware of shadow nodes - to treat them (and their children) exactly like any other entity with children. This includes observers, queries and so on. The only code that we want to actually be aware of shadow nodes is layout, rendering extraction, and picking - which are, coincidentally, the only parts of Bevy that pay attention to the `Visibility`. component. And although I haven't actually looked at the code in detail, I strongly suspect that the code that implements shadow nodes would be located close to the code that handles visibility. So a shadow node is simply a node with the component `Visibility::Shadow`.\r\n3) Note that the \"shadow node\" behavior is *not* the same as \"shadow DOM\" in HTML, so let's not get confused.\r\n\r\nI recognize, of course, that I'm making several assumptions here:\r\n* I'm assuming that the only parts of Bevy that would care about shadow nodes are layout, rendering extraction, and picking. It's hard to know a definitive answer to this without knowing all of Bevy's code, which obviously I don't.\r\n* I'm assuming that overloading `Visibility` in this way wouldn't create other problems. As you know, there's both a `Visibility` and `InheritedVisibility` which is calculated from the former. I'm assuming that the `InheritedVisibility` enum would not need to change, however the way it's calculated would be. If a child of a shadow node had `Inherited` visibility, the code would have to skip over the shadow node parent to get the true visibility. (The shadow node itself would always have `InheritedVisibility::Hidden` so nothing complex there.) This calculation would have to happen regardless of how we implement shadow nodes, but I think using `Visibility::Shadow` is actually more efficient because it avoids the need to query for an extra `ShadowParent` component during the visibility calculation. But I could be wrong about this...\r\n\r\nHere's some things I don't know yet:\r\n* First, I have no sense of whether or not people think this is a good idea. I'd really like to build a consensus around this before diving into an implementation.\r\n* Second, I have a rough idea of what parts of Bevy would be impacted by this, but I don't know for sure if my ideas are accurate. Similarly, I'd like to get a sense of how hard this would be to implement.\r\n* I'd very much like to know if other people have use cases other than the ones I have come up with. That is, if the only library that uses this is my own library (bevy_quill), then I would vote against doing it. However, I think it has broader applicability than just my own use case.\r\n\r\nPart of what I'm trying to do here is define a path for reactivity in BSN. Whether sickle_ui or any other framework will take advantage of this I can't estimate, but I can see advantages to doing so. I haven't gotten a lot of feedback from cart, but some comments made by both him and Sander have propelled me in this direction. I think that in order to satisfy their stated preference of to having reactivity in a \"single hierarchy\" (as opposed to the dual-hierarchy approach used by Quill now) we need some way to have these extra nodes inserted in the hierarchy.\r\n\r\nA typical example of how shadow nodes might be used is a templating language that supports a reactive \"if\" statement - that is, a conditional branch which automatically re-executes when the test condition changes. When the template is run, it creates an entity tree for the template content, including a shadow node representing the \"if\" statement itself, and child nodes representing the content of the current branch (true branch or false branch). If the branch is empty (returns void) then the shadow node might not have any children. The shadow node also has an \"If\" or \"Cond\" Component which contains, among other things, the formula for computing the test expression and the sub-templates for the two branches. An ECS system queries for the `If` component, evaluates the expression, and if it's changed it despawns all of the children of the shadow node (representing the old branch, no longer taken), and then executes the template for the new branch, which then populates the children of the shadow node.\r\n\r\nNote that this can be done even without reactivity: you can write a system that simply re-executes the conditional expression every frame. All that reactivity adds here is a performance optimization, where you only run the test expression if the variables used within the test expression change.\r\n\r\nThe templating language will, of course, generate all of this machinery automatically, so the user only needs to write a normal-looking \"if\" statement within the template.","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/bevyengine/bevy/issues/comments/2352272994/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"viridia","id":1166135,"node_id":"MDQ6VXNlcjExNjYxMzU=","avatar_url":"https://avatars.githubusercontent.com/u/1166135?v=4","gravatar_id":"","url":"https://api.github.com/users/viridia","html_url":"https://github.com/viridia","followers_url":"https://api.github.com/users/viridia/followers","following_url":"https://api.github.com/users/viridia/following{/other_user}","gists_url":"https://api.github.com/users/viridia/gists{/gist_id}","starred_url":"https://api.github.com/users/viridia/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/viridia/subscriptions","organizations_url":"https://api.github.com/users/viridia/orgs","repos_url":"https://api.github.com/users/viridia/repos","events_url":"https://api.github.com/users/viridia/events{/privacy}","received_events_url":"https://api.github.com/users/viridia/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/bevyengine/bevy/issues/comments/2352417459","html_url":"https://github.com/bevyengine/bevy/issues/14826#issuecomment-2352417459","issue_url":"https://api.github.com/repos/bevyengine/bevy/issues/14826","id":2352417459,"node_id":"IC_kwDODf6-U86MNwqz","user":{"login":"villor","id":7102243,"node_id":"MDQ6VXNlcjcxMDIyNDM=","avatar_url":"https://avatars.githubusercontent.com/u/7102243?v=4","gravatar_id":"","url":"https://api.github.com/users/villor","html_url":"https://github.com/villor","followers_url":"https://api.github.com/users/villor/followers","following_url":"https://api.github.com/users/villor/following{/other_user}","gists_url":"https://api.github.com/users/villor/gists{/gist_id}","starred_url":"https://api.github.com/users/villor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/villor/subscriptions","organizations_url":"https://api.github.com/users/villor/orgs","repos_url":"https://api.github.com/users/villor/repos","events_url":"https://api.github.com/users/villor/events{/privacy}","received_events_url":"https://api.github.com/users/villor/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-16T09:28:02Z","updated_at":"2024-09-16T09:28:02Z","body":"I posted some thoughts in https://github.com/bevyengine/bevy/pull/15238\r\n\r\nI started leaning more towards Ghost Nodes to not confuse them with actual rendered shadows. Not confusing them with shadow DOM is another good point.\r\n\r\nI like the idea of using Visibility for this. Had not considered how my proposed approach would handle picking. Ill do some research on how/where Visibility is used today and what it would mean to add a Shadow/Ghost variant.","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/bevyengine/bevy/issues/comments/2352417459/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"villor","id":7102243,"node_id":"MDQ6VXNlcjcxMDIyNDM=","avatar_url":"https://avatars.githubusercontent.com/u/7102243?v=4","gravatar_id":"","url":"https://api.github.com/users/villor","html_url":"https://github.com/villor","followers_url":"https://api.github.com/users/villor/followers","following_url":"https://api.github.com/users/villor/following{/other_user}","gists_url":"https://api.github.com/users/villor/gists{/gist_id}","starred_url":"https://api.github.com/users/villor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/villor/subscriptions","organizations_url":"https://api.github.com/users/villor/orgs","repos_url":"https://api.github.com/users/villor/repos","events_url":"https://api.github.com/users/villor/events{/privacy}","received_events_url":"https://api.github.com/users/villor/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/bevyengine/bevy/issues/comments/2352427273","html_url":"https://github.com/bevyengine/bevy/issues/14826#issuecomment-2352427273","issue_url":"https://api.github.com/repos/bevyengine/bevy/issues/14826","id":2352427273,"node_id":"IC_kwDODf6-U86MNzEJ","user":{"login":"villor","id":7102243,"node_id":"MDQ6VXNlcjcxMDIyNDM=","avatar_url":"https://avatars.githubusercontent.com/u/7102243?v=4","gravatar_id":"","url":"https://api.github.com/users/villor","html_url":"https://github.com/villor","followers_url":"https://api.github.com/users/villor/followers","following_url":"https://api.github.com/users/villor/following{/other_user}","gists_url":"https://api.github.com/users/villor/gists{/gist_id}","starred_url":"https://api.github.com/users/villor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/villor/subscriptions","organizations_url":"https://api.github.com/users/villor/orgs","repos_url":"https://api.github.com/users/villor/repos","events_url":"https://api.github.com/users/villor/events{/privacy}","received_events_url":"https://api.github.com/users/villor/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-16T09:33:05Z","updated_at":"2024-09-16T09:33:05Z","body":"About the consensus before implementation. I personally like to get my hands dirty as early as possible since that is the natural way for me to truly understand the problem at hand and its implications.\r\n\r\nAnd maybe a more concrete draft can help bring consensus as well!","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/bevyengine/bevy/issues/comments/2352427273/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"villor","id":7102243,"node_id":"MDQ6VXNlcjcxMDIyNDM=","avatar_url":"https://avatars.githubusercontent.com/u/7102243?v=4","gravatar_id":"","url":"https://api.github.com/users/villor","html_url":"https://github.com/villor","followers_url":"https://api.github.com/users/villor/followers","following_url":"https://api.github.com/users/villor/following{/other_user}","gists_url":"https://api.github.com/users/villor/gists{/gist_id}","starred_url":"https://api.github.com/users/villor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/villor/subscriptions","organizations_url":"https://api.github.com/users/villor/orgs","repos_url":"https://api.github.com/users/villor/repos","events_url":"https://api.github.com/users/villor/events{/privacy}","received_events_url":"https://api.github.com/users/villor/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/bevyengine/bevy/issues/comments/2353457031","html_url":"https://github.com/bevyengine/bevy/issues/14826#issuecomment-2353457031","issue_url":"https://api.github.com/repos/bevyengine/bevy/issues/14826","id":2353457031,"node_id":"IC_kwDODf6-U86MRueH","user":{"login":"viridia","id":1166135,"node_id":"MDQ6VXNlcjExNjYxMzU=","avatar_url":"https://avatars.githubusercontent.com/u/1166135?v=4","gravatar_id":"","url":"https://api.github.com/users/viridia","html_url":"https://github.com/viridia","followers_url":"https://api.github.com/users/viridia/followers","following_url":"https://api.github.com/users/viridia/following{/other_user}","gists_url":"https://api.github.com/users/viridia/gists{/gist_id}","starred_url":"https://api.github.com/users/viridia/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/viridia/subscriptions","organizations_url":"https://api.github.com/users/viridia/orgs","repos_url":"https://api.github.com/users/viridia/repos","events_url":"https://api.github.com/users/viridia/events{/privacy}","received_events_url":"https://api.github.com/users/viridia/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-16T17:02:50Z","updated_at":"2024-09-16T17:02:50Z","body":"@villor Another reason for doing an early implementation is to convince people that the idea is possible; sometimes it's easier to get consensus if people think it's a done deal.\r\n\r\nI'm fine with the name \"Ghost nodes\".","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/bevyengine/bevy/issues/comments/2353457031/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"viridia","id":1166135,"node_id":"MDQ6VXNlcjExNjYxMzU=","avatar_url":"https://avatars.githubusercontent.com/u/1166135?v=4","gravatar_id":"","url":"https://api.github.com/users/viridia","html_url":"https://github.com/viridia","followers_url":"https://api.github.com/users/viridia/followers","following_url":"https://api.github.com/users/viridia/following{/other_user}","gists_url":"https://api.github.com/users/viridia/gists{/gist_id}","starred_url":"https://api.github.com/users/viridia/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/viridia/subscriptions","organizations_url":"https://api.github.com/users/viridia/orgs","repos_url":"https://api.github.com/users/viridia/repos","events_url":"https://api.github.com/users/viridia/events{/privacy}","received_events_url":"https://api.github.com/users/viridia/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":14276699087,"node_id":"MEE_lADODf6-U86TemgCzwAAAANS9SPP","url":"https://api.github.com/repos/bevyengine/bevy/issues/events/14276699087","actor":{"login":"villor","id":7102243,"node_id":"MDQ6VXNlcjcxMDIyNDM=","avatar_url":"https://avatars.githubusercontent.com/u/7102243?v=4","gravatar_id":"","url":"https://api.github.com/users/villor","html_url":"https://github.com/villor","followers_url":"https://api.github.com/users/villor/followers","following_url":"https://api.github.com/users/villor/following{/other_user}","gists_url":"https://api.github.com/users/villor/gists{/gist_id}","starred_url":"https://api.github.com/users/villor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/villor/subscriptions","organizations_url":"https://api.github.com/users/villor/orgs","repos_url":"https://api.github.com/users/villor/repos","events_url":"https://api.github.com/users/villor/events{/privacy}","received_events_url":"https://api.github.com/users/villor/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2024-09-16T17:02:52Z","performed_via_github_app":null},{"id":14276699111,"node_id":"SE_lADODf6-U86TemgCzwAAAANS9SPn","url":"https://api.github.com/repos/bevyengine/bevy/issues/events/14276699111","actor":{"login":"villor","id":7102243,"node_id":"MDQ6VXNlcjcxMDIyNDM=","avatar_url":"https://avatars.githubusercontent.com/u/7102243?v=4","gravatar_id":"","url":"https://api.github.com/users/villor","html_url":"https://github.com/villor","followers_url":"https://api.github.com/users/villor/followers","following_url":"https://api.github.com/users/villor/following{/other_user}","gists_url":"https://api.github.com/users/villor/gists{/gist_id}","starred_url":"https://api.github.com/users/villor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/villor/subscriptions","organizations_url":"https://api.github.com/users/villor/orgs","repos_url":"https://api.github.com/users/villor/repos","events_url":"https://api.github.com/users/villor/events{/privacy}","received_events_url":"https://api.github.com/users/villor/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2024-09-16T17:02:52Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/bevyengine/bevy/issues/comments/2353614240","html_url":"https://github.com/bevyengine/bevy/issues/14826#issuecomment-2353614240","issue_url":"https://api.github.com/repos/bevyengine/bevy/issues/14826","id":2353614240,"node_id":"IC_kwDODf6-U86MSU2g","user":{"login":"viridia","id":1166135,"node_id":"MDQ6VXNlcjExNjYxMzU=","avatar_url":"https://avatars.githubusercontent.com/u/1166135?v=4","gravatar_id":"","url":"https://api.github.com/users/viridia","html_url":"https://github.com/viridia","followers_url":"https://api.github.com/users/viridia/followers","following_url":"https://api.github.com/users/viridia/following{/other_user}","gists_url":"https://api.github.com/users/viridia/gists{/gist_id}","starred_url":"https://api.github.com/users/viridia/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/viridia/subscriptions","organizations_url":"https://api.github.com/users/viridia/orgs","repos_url":"https://api.github.com/users/viridia/repos","events_url":"https://api.github.com/users/viridia/events{/privacy}","received_events_url":"https://api.github.com/users/viridia/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-16T18:26:42Z","updated_at":"2024-09-16T18:45:41Z","body":"I cobbled together a prototype of what bevy_reactor would look like with ghost nodes. You can browse the code here: https://github.com/viridia/bevy_reactor/blob/main/crates/bevy_reactor_views/src/view.rs#L12 - it doesn't actually work without the ghost nodes (it spews lots of warnings about the lack of InheritedVisibility and such), but it does compile and run.\r\n\r\nIn this new scheme, the `View` trait only has one method that you have to implement, `build()`:\r\n\r\n```rust\r\npub trait View {\r\n    /// Initialize the view, creating any entities needed.\r\n    ///\r\n    /// Arguments:\r\n    /// * `owner`: The entity that owns this view.\r\n    /// * `world`: The Bevy world.\r\n    /// * `scope`: The parent tracking scope which owns any reactions created by this view.\r\n    /// * `out`: A mutable reference to a vector where the output entities will be stored.\r\n    fn build(\r\n        &mut self,\r\n        owner: Entity,\r\n        world: &mut World,\r\n        scope: &mut TrackingScope,\r\n        out: &mut Vec<Entity>,\r\n    );\r\n}\r\n```\r\n(There's one other method in `View`, `to_root()`, but the default implementation is provided.)\r\n\r\nAll of the other methods of `View` are gone:\r\n* There's no `raze()` method any more, because views can be despawned using Bevy's standard `despawn_recursive()`.\r\n* There's no `nodes()` method any more, because output nodes can never change unless the view is destroyed - instead, the build method returns the output nodes in a `Vec`.\r\n* Similar, there's no longer any `attach_children()` or `children_changed()` methods, for the same reason.\r\n\r\nIn the previous design, we had to deal with the fact that the children of a template node could be changed as a result of a control-flow construct such as if/for, which required fixing up the ancestor's children list. With ghost nodes, however, the ghost node is responsible for changing its own children, the logic of which is purely internal to the ghost node - no other nodes need be affected or aware of the change. So there's no need for complex logic to patch up the hierarchy when this happens.\r\n\r\nCheck out the source to `Cond` which is now much easier to follow: https://github.com/viridia/bevy_reactor/blob/main/crates/bevy_reactor_views/src/cond.rs - the `Cond` view spawns a node with a `CondReaction`, which handles destroying and re-creating the children when the test condition changes.\r\n\r\nHowever, this experiment does raise one important detail that needs to be handled: the case where the root of the hierarchy is a ghost node. This case happens in my prototype because the \"view root\" - that is, the root element which is responsible for executing all the templates that are attached to the root - is a ghost node. In this case, the ideal behavior is that the children of the ghost node should behave as if they had no parent. This is probably what would happen anyway, but we need to make sure our test cases include this.","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/bevyengine/bevy/issues/comments/2353614240/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"viridia","id":1166135,"node_id":"MDQ6VXNlcjExNjYxMzU=","avatar_url":"https://avatars.githubusercontent.com/u/1166135?v=4","gravatar_id":"","url":"https://api.github.com/users/viridia","html_url":"https://github.com/viridia","followers_url":"https://api.github.com/users/viridia/followers","following_url":"https://api.github.com/users/viridia/following{/other_user}","gists_url":"https://api.github.com/users/viridia/gists{/gist_id}","starred_url":"https://api.github.com/users/viridia/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/viridia/subscriptions","organizations_url":"https://api.github.com/users/viridia/orgs","repos_url":"https://api.github.com/users/viridia/repos","events_url":"https://api.github.com/users/viridia/events{/privacy}","received_events_url":"https://api.github.com/users/viridia/received_events","type":"User","user_view_type":"public","site_admin":false}}]