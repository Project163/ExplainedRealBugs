{"url":"https://api.github.com/repos/bevyengine/bevy/issues/14467","repository_url":"https://api.github.com/repos/bevyengine/bevy","labels_url":"https://api.github.com/repos/bevyengine/bevy/issues/14467/labels{/name}","comments_url":"https://api.github.com/repos/bevyengine/bevy/issues/14467/comments","events_url":"https://api.github.com/repos/bevyengine/bevy/issues/14467/events","html_url":"https://github.com/bevyengine/bevy/issues/14467","id":2428696401,"node_id":"I_kwDODf6-U86QwvdR","number":14467,"title":"Panic when a despawning `Entity`'s observer spawns an `Entity`","user":{"login":"Yttrmin","id":5376181,"node_id":"MDQ6VXNlcjUzNzYxODE=","avatar_url":"https://avatars.githubusercontent.com/u/5376181?v=4","gravatar_id":"","url":"https://api.github.com/users/Yttrmin","html_url":"https://github.com/Yttrmin","followers_url":"https://api.github.com/users/Yttrmin/followers","following_url":"https://api.github.com/users/Yttrmin/following{/other_user}","gists_url":"https://api.github.com/users/Yttrmin/gists{/gist_id}","starred_url":"https://api.github.com/users/Yttrmin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Yttrmin/subscriptions","organizations_url":"https://api.github.com/users/Yttrmin/orgs","repos_url":"https://api.github.com/users/Yttrmin/repos","events_url":"https://api.github.com/users/Yttrmin/events{/privacy}","received_events_url":"https://api.github.com/users/Yttrmin/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1795619323,"node_id":"MDU6TGFiZWwxNzk1NjE5MzIz","url":"https://api.github.com/repos/bevyengine/bevy/labels/C-Bug","name":"C-Bug","color":"d73a4a","default":false,"description":"An unexpected or incorrect behavior"},{"id":2197761682,"node_id":"MDU6TGFiZWwyMTk3NzYxNjgy","url":"https://api.github.com/repos/bevyengine/bevy/labels/A-ECS","name":"A-ECS","color":"c6a751","default":false,"description":"Entities, components, systems, and events"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2024-07-25T00:26:07Z","updated_at":"2024-09-24T01:25:14Z","closed_at":"2024-09-24T01:25:14Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## Bevy version\r\n\r\n`0.14.0`\r\n\r\n## What you did\r\n\r\n```rust\r\nuse bevy::prelude::*;\r\n\r\nfn main() {\r\n    App::new()\r\n        .add_plugins(MinimalPlugins)\r\n        .add_systems(Startup, startup)\r\n        .add_systems(Update, update)\r\n        .run();\r\n}\r\n\r\n#[derive(Component)]\r\nstruct Marker;\r\n\r\nfn startup(mut commands: Commands) {\r\n    commands.spawn(Marker).observe(|_: Trigger<OnRemove, Marker>, mut commands: Commands| {\r\n        commands.spawn_empty();\r\n    });\r\n}\r\n\r\nfn update(\r\n    query: Query<Entity, With<Marker>>,\r\n    mut commands: Commands\r\n) {\r\n    for entity in &query {\r\n        commands.entity(entity).despawn();\r\n    }\r\n}\r\n```\r\n\r\n## What went wrong\r\n### What were you expecting?\r\n1. Entity with `Marker` component gets queued for despawning.\r\n2. Its observer runs and queues the spawning of a new entity.\r\n3. End result is the entity with `Marker` being despawned, and a new empty entity being spawned.\r\n4. App continues to run.\r\n### What actually happened?\r\n```\r\nthread 'main' panicked at F:\\packages\\cargo\\registry\\src\\index.crates.io-6f17d22bba15001f\\bevy_ecs-0.14.0\\src\\entity\\mod.rs:582:9:\r\nflush() needs to be called before this operation is legal\r\nnote: run with `RUST_BACKTRACE=1` environment variable to display a backtrace\r\nEncountered a panic when applying buffers for system `flush_panic_repro::update`!\r\nEncountered a panic in system `bevy_app::main_schedule::Main::run_main`!\r\nerror: process didn't exit successfully: `target\\debug\\flush_panic_repro.exe` (exit code: 101)\r\n```\r\n\r\n## Additional information\r\n\r\n#14300 runs into the same panic, but involves component hooks, `MapEntities`, and `DynamicScene`. I don't know enough about Bevy's internals to know if these are ultimately the same bug, or just coincidentally panic in the same spot.\r\n\r\n---\r\nIf just the `Marker` component is removed without despawning its entity, the observer still runs (as expected) but there is no panic:\r\n```rust\r\nfn update(\r\n    query: Query<Entity, With<Marker>>,\r\n    mut commands: Commands\r\n) {\r\n    for entity in &query {\r\n        commands.entity(entity).remove::<Marker>(); // Does NOT panic.\r\n    }\r\n}\r\n// Rest of code is unchanged.\r\n```\r\n\r\n---\r\nHere's what seems like the most relevant part of the panic backtrace:\r\n```\r\n2: bevy_ecs::entity::Entities::verify_flushed\r\n   at F:\\packages\\cargo\\registry\\src\\index.crates.io-6f17d22bba15001f\\bevy_ecs-0.14.0\\src\\entity\\mod.rs:582\r\n3: bevy_ecs::entity::Entities::free\r\n   at F:\\packages\\cargo\\registry\\src\\index.crates.io-6f17d22bba15001f\\bevy_ecs-0.14.0\\src\\entity\\mod.rs:680\r\n4: bevy_ecs::world::entity_ref::EntityWorldMut::despawn\r\n   at F:\\packages\\cargo\\registry\\src\\index.crates.io-6f17d22bba15001f\\bevy_ecs-0.14.0\\src\\world\\entity_ref.rs:1235\r\n5: bevy_ecs::world::World::despawn\r\n   at F:\\packages\\cargo\\registry\\src\\index.crates.io-6f17d22bba15001f\\bevy_ecs-0.14.0\\src\\world\\mod.rs:1105\r\n6: bevy_ecs::system::commands::despawn\r\n   at F:\\packages\\cargo\\registry\\src\\index.crates.io-6f17d22bba15001f\\bevy_ecs-0.14.0\\src\\system\\commands\\mod.rs:1241\r\n```","closed_by":{"login":"alice-i-cecile","id":3579909,"node_id":"MDQ6VXNlcjM1Nzk5MDk=","avatar_url":"https://avatars.githubusercontent.com/u/3579909?v=4","gravatar_id":"","url":"https://api.github.com/users/alice-i-cecile","html_url":"https://github.com/alice-i-cecile","followers_url":"https://api.github.com/users/alice-i-cecile/followers","following_url":"https://api.github.com/users/alice-i-cecile/following{/other_user}","gists_url":"https://api.github.com/users/alice-i-cecile/gists{/gist_id}","starred_url":"https://api.github.com/users/alice-i-cecile/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alice-i-cecile/subscriptions","organizations_url":"https://api.github.com/users/alice-i-cecile/orgs","repos_url":"https://api.github.com/users/alice-i-cecile/repos","events_url":"https://api.github.com/users/alice-i-cecile/events{/privacy}","received_events_url":"https://api.github.com/users/alice-i-cecile/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/bevyengine/bevy/issues/14467/reactions","total_count":3,"+1":3,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/bevyengine/bevy/issues/14467/timeline","performed_via_github_app":null,"state_reason":"completed"}