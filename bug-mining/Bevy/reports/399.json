{"url":"https://api.github.com/repos/bevyengine/bevy/issues/14540","repository_url":"https://api.github.com/repos/bevyengine/bevy","labels_url":"https://api.github.com/repos/bevyengine/bevy/issues/14540/labels{/name}","comments_url":"https://api.github.com/repos/bevyengine/bevy/issues/14540/comments","events_url":"https://api.github.com/repos/bevyengine/bevy/issues/14540/events","html_url":"https://github.com/bevyengine/bevy/issues/14540","id":2438464839,"node_id":"I_kwDODf6-U86RWAVH","number":14540,"title":"`MeshAllocator` panics when spawning and despawning lots of meshes","user":{"login":"eero-lehtinen","id":7013023,"node_id":"MDQ6VXNlcjcwMTMwMjM=","avatar_url":"https://avatars.githubusercontent.com/u/7013023?v=4","gravatar_id":"","url":"https://api.github.com/users/eero-lehtinen","html_url":"https://github.com/eero-lehtinen","followers_url":"https://api.github.com/users/eero-lehtinen/followers","following_url":"https://api.github.com/users/eero-lehtinen/following{/other_user}","gists_url":"https://api.github.com/users/eero-lehtinen/gists{/gist_id}","starred_url":"https://api.github.com/users/eero-lehtinen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/eero-lehtinen/subscriptions","organizations_url":"https://api.github.com/users/eero-lehtinen/orgs","repos_url":"https://api.github.com/users/eero-lehtinen/repos","events_url":"https://api.github.com/users/eero-lehtinen/events{/privacy}","received_events_url":"https://api.github.com/users/eero-lehtinen/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1795619323,"node_id":"MDU6TGFiZWwxNzk1NjE5MzIz","url":"https://api.github.com/repos/bevyengine/bevy/labels/C-Bug","name":"C-Bug","color":"d73a4a","default":false,"description":"An unexpected or incorrect behavior"},{"id":2045383863,"node_id":"MDU6TGFiZWwyMDQ1MzgzODYz","url":"https://api.github.com/repos/bevyengine/bevy/labels/A-Rendering","name":"A-Rendering","color":"C6A751","default":false,"description":"Drawing game state to the screen"},{"id":2272057257,"node_id":"MDU6TGFiZWwyMjcyMDU3MjU3","url":"https://api.github.com/repos/bevyengine/bevy/labels/P-Crash","name":"P-Crash","color":"FF7b00","default":false,"description":"A sudden unexpected crash"},{"id":3166152189,"node_id":"MDU6TGFiZWwzMTY2MTUyMTg5","url":"https://api.github.com/repos/bevyengine/bevy/labels/S-Needs-Design","name":"S-Needs-Design","color":"D876E3","default":false,"description":"This issue requires design work to think about how it would best be accomplished"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/bevyengine/bevy/milestones/24","html_url":"https://github.com/bevyengine/bevy/milestone/24","labels_url":"https://api.github.com/repos/bevyengine/bevy/milestones/24/labels","id":11048296,"node_id":"MI_kwDODf6-U84AqJVo","number":24,"title":"0.15","description":"","creator":{"login":"alice-i-cecile","id":3579909,"node_id":"MDQ6VXNlcjM1Nzk5MDk=","avatar_url":"https://avatars.githubusercontent.com/u/3579909?v=4","gravatar_id":"","url":"https://api.github.com/users/alice-i-cecile","html_url":"https://github.com/alice-i-cecile","followers_url":"https://api.github.com/users/alice-i-cecile/followers","following_url":"https://api.github.com/users/alice-i-cecile/following{/other_user}","gists_url":"https://api.github.com/users/alice-i-cecile/gists{/gist_id}","starred_url":"https://api.github.com/users/alice-i-cecile/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alice-i-cecile/subscriptions","organizations_url":"https://api.github.com/users/alice-i-cecile/orgs","repos_url":"https://api.github.com/users/alice-i-cecile/repos","events_url":"https://api.github.com/users/alice-i-cecile/events{/privacy}","received_events_url":"https://api.github.com/users/alice-i-cecile/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":550,"state":"closed","created_at":"2024-05-13T18:42:18Z","updated_at":"2024-11-30T03:58:51Z","due_on":null,"closed_at":"2024-11-29T22:40:27Z"},"comments":3,"created_at":"2024-07-30T18:47:29Z","updated_at":"2024-09-16T23:11:35Z","closed_at":"2024-09-16T23:11:34Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## Bevy version\r\n\r\nMain (ba09f3547)\r\n\r\n`MeshAllocator` was added recently in #14257.\r\n\r\n## Relevant system information\r\n\r\n```\r\nRust v1.80.0\r\nSystemInfo { os: \"Linux rolling EndeavourOS\", kernel: \"6.10.1-arch1-1\", cpu: \"AMD Ryzen 7 5800X3D 8-Core Processor\", core_count: \"8\", memory: \"31.3 GiB\" }\r\nAdapterInfo { name: \"NVIDIA GeForce RTX 3070 Ti\", vendor: 4318, device: 9346, device_type: DiscreteGpu, driver: \"NVIDIA\", driver_info: \"555.58.02\", backend: Vulkan }\r\n```\r\n\r\n## What you did\r\n\r\nRan into this issue in my game. Was able to reproduce in a fairly minimal example. After running it for a couple of seconds, it panics.\r\n\r\nBelow are my logs when running the example code and the example code itself.\r\n\r\n### Panic Logs\r\n```\r\n2024-07-30T18:34:41.538405Z  INFO bevy_diagnostic::system_information_diagnostics_plugin::internal: SystemInfo { os: \"Linux rolling EndeavourOS\", kernel: \"6.10.1-arch1-1\", cpu: \"AMD Ryzen 7 5800X3D 8-Core Processor\", core_count: \"8\", memory: \"31.3 GiB\" }\r\n2024-07-30T18:34:41.742583Z  INFO bevy_render::renderer: AdapterInfo { name: \"NVIDIA GeForce RTX 3070 Ti\", vendor: 4318, device: 9346, device_type: DiscreteGpu, driver: \"NVIDIA\", driver_info: \"555.58.02\", backend: Vulkan }\r\n2024-07-30T18:34:42.278247Z  INFO gilrs_core::platform::platform::gamepad: Gamepad /dev/input/event9 (Generic X-Box pad) connected.    \r\n2024-07-30T18:34:42.379764Z  INFO bevy_winit::system: Creating new window \"App\" (Entity { index: 0, generation: 1 })\r\n2024-07-30T18:34:42.380248Z  INFO winit::platform_impl::linux::x11::window: Guessed window scale factor: 1.25\r\n2024-07-30T18:34:42.385865Z  INFO bevy_input::gamepad: Gamepad { id: 0 } Connected\r\n2024-07-30T18:34:42.686618Z  WARN bevy_render::view::window: Couldn't get swap chain texture. This often happens with the NVIDIA drivers on Linux. It can be safely ignored.\r\n2024-07-30T18:34:44.077495Z  INFO 3d_shapes: Spawned 100 entities\r\n2024-07-30T18:34:45.561625Z  INFO 3d_shapes: Spawned 100 entities\r\n2024-07-30T18:34:47.125133Z  INFO 3d_shapes: Spawned 100 entities\r\n2024-07-30T18:34:48.576740Z  INFO 3d_shapes: Spawned 100 entities\r\n2024-07-30T18:34:50.082296Z  INFO 3d_shapes: Spawned 100 entities\r\n2024-07-30T18:34:51.547897Z  INFO 3d_shapes: Spawned 100 entities\r\n2024-07-30T18:34:52.980272Z  INFO 3d_shapes: Spawned 100 entities\r\n2024-07-30T18:34:54.472600Z  INFO 3d_shapes: Spawned 100 entities\r\n2024-07-30T18:34:56.042392Z  INFO 3d_shapes: Spawned 100 entities\r\n2024-07-30T18:34:58.284618Z  INFO 3d_shapes: Freed entities\r\n2024-07-30T18:35:00.384228Z  INFO 3d_shapes: Spawned 100 entities\r\n2024-07-30T18:35:01.903551Z  INFO 3d_shapes: Spawned 100 entities\r\n2024-07-30T18:35:03.328986Z  INFO 3d_shapes: Spawned 100 entities\r\n2024-07-30T18:35:04.864563Z  INFO 3d_shapes: Spawned 100 entities\r\n2024-07-30T18:35:06.239920Z  INFO 3d_shapes: Spawned 100 entities\r\nthread 'Compute Task Pool (7)' panicked at crates/bevy_render/src/mesh/allocator.rs:674:21:\r\ninternal error: entered unreachable code: Slab not found\r\nnote: run with `RUST_BACKTRACE=1` environment variable to display a backtrace\r\nEncountered a panic in system `bevy_render::mesh::allocator::allocate_and_free_meshes`!\r\n2024-07-30T18:35:07.681254Z  INFO 3d_shapes: Spawned 100 entities\r\nthread '<unnamed>' panicked at /rustc/051478957371ee0084a7c0913941d2a8c4757bb9/library/std/src/thread/local.rs:260:26:\r\ncannot access a Thread Local Storage value during or after destruction: AccessError\r\nfatal runtime error: failed to initiate panic, error 5\r\n```\r\n\r\n### Example Code\r\n```rs\r\nuse bevy::prelude::*;\r\n\r\nfn main() {\r\n    App::new()\r\n        .add_plugins(DefaultPlugins)\r\n        .add_systems(Startup, setup)\r\n        .add_systems(Update, update)\r\n        .run();\r\n}\r\n\r\n/// A marker component for our shapes so we can query them separately from the ground plane\r\n#[derive(Component)]\r\nstruct Shape;\r\n\r\nfn setup(mut commands: Commands) {\r\n    commands.spawn(Camera3dBundle {\r\n        transform: Transform::from_xyz(0.0, 7., 14.0).looking_at(Vec3::new(0., 1., 0.), Vec3::Y),\r\n        ..default()\r\n    });\r\n}\r\n\r\nfn update(\r\n    query: Query<Entity, With<Shape>>,\r\n    mut meshes: ResMut<Assets<Mesh>>,\r\n    mut materials: ResMut<Assets<StandardMaterial>>,\r\n    mut commands: Commands,\r\n    mut counter: Local<u32>,\r\n) {\r\n    *counter += 1;\r\n\r\n    if *counter % 100 == 0 {\r\n        for entity in query.iter() {\r\n            commands.entity(entity).despawn();\r\n        }\r\n        info!(\"Freed entities\");\r\n    }\r\n\r\n    let n = if *counter % 100 > 50 && *counter % 100 < 60 {\r\n        100\r\n    } else {\r\n        0\r\n    };\r\n\r\n    let material = materials.add(StandardMaterial::default());\r\n    for _ in 0..n {\r\n        let mesh = meshes.add(Sphere::new(1.).mesh().ico(50 + n / 10).unwrap());\r\n\r\n        commands.spawn((\r\n            PbrBundle {\r\n                mesh,\r\n                material: material.clone(),\r\n                transform: Transform::from_xyz(1000., 2., 2.),\r\n                ..default()\r\n            },\r\n            Shape,\r\n        ));\r\n    }\r\n\r\n    if n > 0 {\r\n        info!(\"Spawned {} entities\", n);\r\n    }\r\n}\r\n```\r\n\r\n## Additional information\r\nThis change to the problem area seems to fix the issue, but I don't really understand the whole system that well so might be wrong.\r\n```diff\r\ndiff --git a/crates/bevy_render/src/mesh/allocator.rs b/crates/bevy_render/src/mesh/allocator.rs\r\nindex 218e19c47..1599f75da 100644\r\n--- a/crates/bevy_render/src/mesh/allocator.rs\r\n+++ b/crates/bevy_render/src/mesh/allocator.rs\r\n@@ -671,7 +671,7 @@ impl MeshAllocator {\r\n         'slab: for &slab_id in &*candidate_slabs {\r\n             loop {\r\n                 let Some(Slab::General(ref mut slab)) = self.slabs.get_mut(&slab_id) else {\r\n-                    unreachable!(\"Slab not found\")\r\n+                    continue 'slab;\r\n                 };\r\n \r\n                 if let Some(allocation) = slab.allocator.allocate(data_slot_count) {\r\n```\r\n\r\n\r\n","closed_by":{"login":"alice-i-cecile","id":3579909,"node_id":"MDQ6VXNlcjM1Nzk5MDk=","avatar_url":"https://avatars.githubusercontent.com/u/3579909?v=4","gravatar_id":"","url":"https://api.github.com/users/alice-i-cecile","html_url":"https://github.com/alice-i-cecile","followers_url":"https://api.github.com/users/alice-i-cecile/followers","following_url":"https://api.github.com/users/alice-i-cecile/following{/other_user}","gists_url":"https://api.github.com/users/alice-i-cecile/gists{/gist_id}","starred_url":"https://api.github.com/users/alice-i-cecile/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alice-i-cecile/subscriptions","organizations_url":"https://api.github.com/users/alice-i-cecile/orgs","repos_url":"https://api.github.com/users/alice-i-cecile/repos","events_url":"https://api.github.com/users/alice-i-cecile/events{/privacy}","received_events_url":"https://api.github.com/users/alice-i-cecile/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/bevyengine/bevy/issues/14540/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/bevyengine/bevy/issues/14540/timeline","performed_via_github_app":null,"state_reason":"completed"}