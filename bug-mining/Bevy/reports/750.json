{"url":"https://api.github.com/repos/bevyengine/bevy/issues/18430","repository_url":"https://api.github.com/repos/bevyengine/bevy","labels_url":"https://api.github.com/repos/bevyengine/bevy/issues/18430/labels{/name}","comments_url":"https://api.github.com/repos/bevyengine/bevy/issues/18430/comments","events_url":"https://api.github.com/repos/bevyengine/bevy/issues/18430/events","html_url":"https://github.com/bevyengine/bevy/issues/18430","id":2933542619,"node_id":"I_kwDODf6-U86u2k7b","number":18430,"title":"`despawn_world_recursive` benchmarks panic","user":{"login":"kirawulff","id":29414730,"node_id":"MDQ6VXNlcjI5NDE0NzMw","avatar_url":"https://avatars.githubusercontent.com/u/29414730?v=4","gravatar_id":"","url":"https://api.github.com/users/kirawulff","html_url":"https://github.com/kirawulff","followers_url":"https://api.github.com/users/kirawulff/followers","following_url":"https://api.github.com/users/kirawulff/following{/other_user}","gists_url":"https://api.github.com/users/kirawulff/gists{/gist_id}","starred_url":"https://api.github.com/users/kirawulff/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kirawulff/subscriptions","organizations_url":"https://api.github.com/users/kirawulff/orgs","repos_url":"https://api.github.com/users/kirawulff/repos","events_url":"https://api.github.com/users/kirawulff/events{/privacy}","received_events_url":"https://api.github.com/users/kirawulff/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":2197761682,"node_id":"MDU6TGFiZWwyMTk3NzYxNjgy","url":"https://api.github.com/repos/bevyengine/bevy/labels/A-ECS","name":"A-ECS","color":"c6a751","default":false,"description":"Entities, components, systems, and events"},{"id":3166151441,"node_id":"MDU6TGFiZWwzMTY2MTUxNDQx","url":"https://api.github.com/repos/bevyengine/bevy/labels/S-Ready-For-Implementation","name":"S-Ready-For-Implementation","color":"D876E3","default":false,"description":"This issue is ready for an implementation PR. Go for it!"},{"id":6392754453,"node_id":"LA_kwDODf6-U88AAAABfQmxFQ","url":"https://api.github.com/repos/bevyengine/bevy/labels/C-Benchmarks","name":"C-Benchmarks","color":"b8b8b8","default":false,"description":"Stress tests and benchmarks used to measure how fast things are"},{"id":6899571146,"node_id":"LA_kwDODf6-U88AAAABmz8Zyg","url":"https://api.github.com/repos/bevyengine/bevy/labels/D-Straightforward","name":"D-Straightforward","color":"008672","default":false,"description":"Simple bug fixes and API improvements, docs, test and examples"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2025-03-20T00:25:49Z","updated_at":"2025-03-22T03:46:24Z","closed_at":"2025-03-22T03:46:24Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## Bevy version\n\n`main` (`c719a6cb`)\n\n## What you did\n\nThe quickest way to replicate should be\n\n```\ncargo bench -p benches --bench ecs despawn_world_recursive\n```\n\n## What went wrong\n\nThe benchmark panics as it can not find an entity. Backtrace:\n\n```\nBenchmarking despawn_world_recursive/1_entities: Warming up for 500.00 ms\nthread 'main' panicked at benches/benches/bevy_ecs/world/despawn_recursive.rs:29:27:\nThe entity with ID 1v1 does not exist (enable `track_location` feature for more details)\nstack backtrace:\n   0: __rustc::rust_begin_unwind\n   1: core::panicking::panic_fmt\n   2: bevy_ecs::world::World::entity_mut::panic_on_err\n   3: criterion::bencher::Bencher<M>::iter\n   4: <criterion::routine::Function<M,F,T> as criterion::routine::Routine<M,T>>::warm_up\n   5: criterion::routine::Routine::sample\n   6: criterion::analysis::common\n   7: criterion::benchmark_group::BenchmarkGroup<M>::bench_function\n   8: ecs::world::despawn_recursive::world_despawn_recursive\n   9: ecs::main\nnote: Some details are omitted, run with `RUST_BACKTRACE=full` for a verbose backtrace\n```\n\n## Additional information\n\nHi, I'm new here, so I don't know all the context.\n\nThat said, what I think has to do with a major overhaul on entities' relationships. I did a bisect, and ended with the git commit `21f1e304 Relationships (non-fragmenting, one-to-many) (#17398)`. That changed the API for recursively destroying entities, and introduced this panic.\n\nComparing the non-recursive and recursive versions of this bench yields basically no difference except for entities having children, with the recursive version pasted below, which would make one think there's some bug with entity despawning in the recursive version, but I don't think that's the case.\n\nThe difference in the way the two despawn entities means the non-recursive version uses `World::despawn()` and the recursive version uses `EntityWorldMut::despawn()`. Critically, these two handle failure (in this case, I think a double despawn) in different ways: `World::despawn()` returns false and prints a warning, while `EntityWorldMut::despawn()` panics.\n\nMy theory is that both the recursive and non-recursive benchmarks are double despawning everything due to the iteration of the benchmarker, and it's only panicking on the recursive version because the non-recursive fails silently.\n\nLet me know if this is the correct diagnosis, and I'm happy to work on this if I can get some guidance","closed_by":{"login":"alice-i-cecile","id":3579909,"node_id":"MDQ6VXNlcjM1Nzk5MDk=","avatar_url":"https://avatars.githubusercontent.com/u/3579909?v=4","gravatar_id":"","url":"https://api.github.com/users/alice-i-cecile","html_url":"https://github.com/alice-i-cecile","followers_url":"https://api.github.com/users/alice-i-cecile/followers","following_url":"https://api.github.com/users/alice-i-cecile/following{/other_user}","gists_url":"https://api.github.com/users/alice-i-cecile/gists{/gist_id}","starred_url":"https://api.github.com/users/alice-i-cecile/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alice-i-cecile/subscriptions","organizations_url":"https://api.github.com/users/alice-i-cecile/orgs","repos_url":"https://api.github.com/users/alice-i-cecile/repos","events_url":"https://api.github.com/users/alice-i-cecile/events{/privacy}","received_events_url":"https://api.github.com/users/alice-i-cecile/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/bevyengine/bevy/issues/18430/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/bevyengine/bevy/issues/18430/timeline","performed_via_github_app":null,"state_reason":"completed"}