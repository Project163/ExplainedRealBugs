{"url":"https://api.github.com/repos/bevyengine/bevy/issues/12627","repository_url":"https://api.github.com/repos/bevyengine/bevy","labels_url":"https://api.github.com/repos/bevyengine/bevy/issues/12627/labels{/name}","comments_url":"https://api.github.com/repos/bevyengine/bevy/issues/12627/comments","events_url":"https://api.github.com/repos/bevyengine/bevy/issues/12627/events","html_url":"https://github.com/bevyengine/bevy/issues/12627","id":2200670614,"node_id":"I_kwDODf6-U86DK5GW","number":12627,"title":"Make Bevy's compile-fail tests less fragile","user":{"login":"alice-i-cecile","id":3579909,"node_id":"MDQ6VXNlcjM1Nzk5MDk=","avatar_url":"https://avatars.githubusercontent.com/u/3579909?v=4","gravatar_id":"","url":"https://api.github.com/users/alice-i-cecile","html_url":"https://github.com/alice-i-cecile","followers_url":"https://api.github.com/users/alice-i-cecile/followers","following_url":"https://api.github.com/users/alice-i-cecile/following{/other_user}","gists_url":"https://api.github.com/users/alice-i-cecile/gists{/gist_id}","starred_url":"https://api.github.com/users/alice-i-cecile/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alice-i-cecile/subscriptions","organizations_url":"https://api.github.com/users/alice-i-cecile/orgs","repos_url":"https://api.github.com/users/alice-i-cecile/repos","events_url":"https://api.github.com/users/alice-i-cecile/events{/privacy}","received_events_url":"https://api.github.com/users/alice-i-cecile/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":2197761682,"node_id":"MDU6TGFiZWwyMTk3NzYxNjgy","url":"https://api.github.com/repos/bevyengine/bevy/labels/A-ECS","name":"A-ECS","color":"c6a751","default":false,"description":"Entities, components, systems, and events"},{"id":2272053257,"node_id":"MDU6TGFiZWwyMjcyMDUzMjU3","url":"https://api.github.com/repos/bevyengine/bevy/labels/A-Build-System","name":"A-Build-System","color":"c6A751","default":false,"description":"Related to build systems or continuous integration"},{"id":2287994822,"node_id":"MDU6TGFiZWwyMjg3OTk0ODIy","url":"https://api.github.com/repos/bevyengine/bevy/labels/C-Code-Quality","name":"C-Code-Quality","color":"B8B8B8","default":false,"description":"A section of code that is hard to understand or change"},{"id":3166092163,"node_id":"MDU6TGFiZWwzMTY2MDkyMTYz","url":"https://api.github.com/repos/bevyengine/bevy/labels/C-Testing","name":"C-Testing","color":"b8b8b8","default":false,"description":"A change that impacts how we test Bevy or how users test their apps"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2024-03-21T16:44:05Z","updated_at":"2024-04-27T00:15:13Z","closed_at":"2024-04-27T00:15:13Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## What problem does this solve or what need does it fill?\r\n\r\nBevy uses compile fail tests in [bevy_ecs_compile_fail_tests](https://github.com/bevyengine/bevy/tree/main/crates/bevy_ecs_compile_fail_tests), `deref_derive`, `deref_mut_derive` and [reflect_derives](https://github.com/bevyengine/bevy/actions/runs/8378534423/job/22943464592?pr=12623#step:6:261) to help ensure that our trait implementations fail as we expect.\r\n\r\nHowever, these regularly break (see #12620 for an example) whenever Rust's diagnostics outputs change.\r\nThese aren't real failures (caused by a violation of the invariants we're testing for): they're simply changes to the error messages.\r\n\r\nNote that this will affect Bevy devs locally as well, if their version of the Rust toolchain doesn't exactly match the one used in CI.\r\n\r\n## What solution would you like?\r\n\r\nParse the diagnostic output to ensure that the key bits of information are correct.\r\n\r\n## What alternative(s) have you considered?\r\n\r\nWe could check only the error number, but this will reduce our ability to detect real and valid failures. We want to know *why* the various traits aren't implemented and ensure it's for the correct reason.\r\n\r\nWe could also include the rustc toolchain version used to generate the tests, and only run the comparison if the user is on that version. This would help with local failures, but result in a more complex setup and not help us when we update rustc versions in CI.\r\n\r\n## Additional context\r\n\r\n#12625 discusses how we can catch these errors sooner, but this issue covers how we can avoid them breaking at all.\r\n\r\nSwapping from `trybuild` to `ui_test` might make this easier to do.\r\n\r\nThanks to @estebank, @workingjubilee and @compiler-errors for the suggestions and guidance here.","closed_by":{"login":"mockersf","id":8672791,"node_id":"MDQ6VXNlcjg2NzI3OTE=","avatar_url":"https://avatars.githubusercontent.com/u/8672791?v=4","gravatar_id":"","url":"https://api.github.com/users/mockersf","html_url":"https://github.com/mockersf","followers_url":"https://api.github.com/users/mockersf/followers","following_url":"https://api.github.com/users/mockersf/following{/other_user}","gists_url":"https://api.github.com/users/mockersf/gists{/gist_id}","starred_url":"https://api.github.com/users/mockersf/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mockersf/subscriptions","organizations_url":"https://api.github.com/users/mockersf/orgs","repos_url":"https://api.github.com/users/mockersf/repos","events_url":"https://api.github.com/users/mockersf/events{/privacy}","received_events_url":"https://api.github.com/users/mockersf/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/bevyengine/bevy/issues/12627/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/bevyengine/bevy/issues/12627/timeline","performed_via_github_app":null,"state_reason":"completed"}