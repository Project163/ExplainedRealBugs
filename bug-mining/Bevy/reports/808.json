{"url":"https://api.github.com/repos/bevyengine/bevy/issues/18054","repository_url":"https://api.github.com/repos/bevyengine/bevy","labels_url":"https://api.github.com/repos/bevyengine/bevy/issues/18054/labels{/name}","comments_url":"https://api.github.com/repos/bevyengine/bevy/issues/18054/comments","events_url":"https://api.github.com/repos/bevyengine/bevy/issues/18054/events","html_url":"https://github.com/bevyengine/bevy/issues/18054","id":2882597037,"node_id":"I_kwDODf6-U86r0PCt","number":18054,"title":"Improve Performance of Entities::alloc_at","user":{"login":"ElliottjPierce","id":79881080,"node_id":"MDQ6VXNlcjc5ODgxMDgw","avatar_url":"https://avatars.githubusercontent.com/u/79881080?v=4","gravatar_id":"","url":"https://api.github.com/users/ElliottjPierce","html_url":"https://github.com/ElliottjPierce","followers_url":"https://api.github.com/users/ElliottjPierce/followers","following_url":"https://api.github.com/users/ElliottjPierce/following{/other_user}","gists_url":"https://api.github.com/users/ElliottjPierce/gists{/gist_id}","starred_url":"https://api.github.com/users/ElliottjPierce/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ElliottjPierce/subscriptions","organizations_url":"https://api.github.com/users/ElliottjPierce/orgs","repos_url":"https://api.github.com/users/ElliottjPierce/repos","events_url":"https://api.github.com/users/ElliottjPierce/events{/privacy}","received_events_url":"https://api.github.com/users/ElliottjPierce/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":2197761682,"node_id":"MDU6TGFiZWwyMTk3NzYxNjgy","url":"https://api.github.com/repos/bevyengine/bevy/labels/A-ECS","name":"A-ECS","color":"c6a751","default":false,"description":"Entities, components, systems, and events"},{"id":2272098452,"node_id":"MDU6TGFiZWwyMjcyMDk4NDUy","url":"https://api.github.com/repos/bevyengine/bevy/labels/C-Performance","name":"C-Performance","color":"B8B8B8","default":false,"description":"A change motivated by improving speed, memory usage or compile times"},{"id":3166151441,"node_id":"MDU6TGFiZWwzMTY2MTUxNDQx","url":"https://api.github.com/repos/bevyengine/bevy/labels/S-Ready-For-Implementation","name":"S-Ready-For-Implementation","color":"D876E3","default":false,"description":"This issue is ready for an implementation PR. Go for it!"},{"id":3166152189,"node_id":"MDU6TGFiZWwzMTY2MTUyMTg5","url":"https://api.github.com/repos/bevyengine/bevy/labels/S-Needs-Design","name":"S-Needs-Design","color":"D876E3","default":false,"description":"This issue requires design work to think about how it would best be accomplished"},{"id":6899552399,"node_id":"LA_kwDODf6-U88AAAABmz7Qjw","url":"https://api.github.com/repos/bevyengine/bevy/labels/X-Contentious","name":"X-Contentious","color":"D93F0B","default":false,"description":"There are nontrivial implications that should be thought through"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":11,"created_at":"2025-02-26T19:24:31Z","updated_at":"2025-05-10T14:50:21Z","closed_at":"2025-05-05T23:35:03Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"`Entities::alloc_at` and `alloc_at_without_replacement` currently have performance issues. See [this conversation](https://discord.com/channels/691052431525675048/1342561489734602853/1344086844572438528) for the full background.\n\n# When and why is it slow?\n\nBoth these functions currently have a linear search through the `pending` list to try to find and remove the requested entity. When there are lots of `pending` entities, this is very slow.\n\nSee also the [source](https://github.com/bevyengine/bevy/blob/11db71727d25bdbe86f709574b531cab686d0e0a/crates/bevy_ecs/src/entity/mod.rs#L700).\n\n# Practical Impact\n\nIn the conversation mentioned above, a user was spawning waves of sprite projectiles. Each wave was ~90,000 entities and was spawned and desawned over 8 seconds, repeating for each wave. This lead to measurable frame drops because, on the second wave, the render world was using `alloc_at_without_replacement` with 90,000 entities in the pending list. For massive, wave oriented games, this is a big deal.\n\n# Solution\n\nAdd a field to `EntityMeta` that stores the index of the entity in the `pending` list if it is fee. This will remove the linear search and fix the problem.\n\nDownside: `EntityMeta` will be bigger, so less of them can fit in cache. This is relevant to lots of *very* hot paths.\n\n# Alternatives\n\nWe could try to keep the `pending` list small by not storing tail entities. For example, if there are 16 entries in `meta` and entities of index 8-15 are in the pending list, we could remove them since their pending nature could be implied by shortening `meta`. But this gives extra overhead and can be ruined by keeping just one high-index entity around.\n\nWe could also try to pack the index of the entity in the `pending` list into some other fields of `EntityMeta`. Maybe `table_row` or something, but that looses/invalidates other information about the entity. If anyone has a way of doing this without dropping some information, this would be an ideal solution.\n\nFinally, we could sort the pending list after `Entities::flush`. This could let us change the linear search to a binary search, but keeping the sorted invariance may have additional overhead.\n\n","closed_by":{"login":"alice-i-cecile","id":3579909,"node_id":"MDQ6VXNlcjM1Nzk5MDk=","avatar_url":"https://avatars.githubusercontent.com/u/3579909?v=4","gravatar_id":"","url":"https://api.github.com/users/alice-i-cecile","html_url":"https://github.com/alice-i-cecile","followers_url":"https://api.github.com/users/alice-i-cecile/followers","following_url":"https://api.github.com/users/alice-i-cecile/following{/other_user}","gists_url":"https://api.github.com/users/alice-i-cecile/gists{/gist_id}","starred_url":"https://api.github.com/users/alice-i-cecile/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alice-i-cecile/subscriptions","organizations_url":"https://api.github.com/users/alice-i-cecile/orgs","repos_url":"https://api.github.com/users/alice-i-cecile/repos","events_url":"https://api.github.com/users/alice-i-cecile/events{/privacy}","received_events_url":"https://api.github.com/users/alice-i-cecile/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/bevyengine/bevy/issues/18054/reactions","total_count":1,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":1,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/bevyengine/bevy/issues/18054/timeline","performed_via_github_app":null,"state_reason":"completed"}