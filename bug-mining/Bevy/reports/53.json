{"url":"https://api.github.com/repos/bevyengine/bevy/issues/11898","repository_url":"https://api.github.com/repos/bevyengine/bevy","labels_url":"https://api.github.com/repos/bevyengine/bevy/issues/11898/labels{/name}","comments_url":"https://api.github.com/repos/bevyengine/bevy/issues/11898/comments","events_url":"https://api.github.com/repos/bevyengine/bevy/issues/11898/events","html_url":"https://github.com/bevyengine/bevy/issues/11898","id":2138601771,"node_id":"I_kwDODf6-U85_eHkr","number":11898,"title":"Lightmaps don't work with shadow-enabled directional lights.","user":{"login":"doonv","id":58695417,"node_id":"MDQ6VXNlcjU4Njk1NDE3","avatar_url":"https://avatars.githubusercontent.com/u/58695417?v=4","gravatar_id":"","url":"https://api.github.com/users/doonv","html_url":"https://github.com/doonv","followers_url":"https://api.github.com/users/doonv/followers","following_url":"https://api.github.com/users/doonv/following{/other_user}","gists_url":"https://api.github.com/users/doonv/gists{/gist_id}","starred_url":"https://api.github.com/users/doonv/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/doonv/subscriptions","organizations_url":"https://api.github.com/users/doonv/orgs","repos_url":"https://api.github.com/users/doonv/repos","events_url":"https://api.github.com/users/doonv/events{/privacy}","received_events_url":"https://api.github.com/users/doonv/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1795619323,"node_id":"MDU6TGFiZWwxNzk1NjE5MzIz","url":"https://api.github.com/repos/bevyengine/bevy/labels/C-Bug","name":"C-Bug","color":"d73a4a","default":false,"description":"An unexpected or incorrect behavior"},{"id":2045383863,"node_id":"MDU6TGFiZWwyMDQ1MzgzODYz","url":"https://api.github.com/repos/bevyengine/bevy/labels/A-Rendering","name":"A-Rendering","color":"C6A751","default":false,"description":"Drawing game state to the screen"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/bevyengine/bevy/milestones/17","html_url":"https://github.com/bevyengine/bevy/milestone/17","labels_url":"https://api.github.com/repos/bevyengine/bevy/milestones/17/labels","id":9938844,"node_id":"MI_kwDODf6-U84Al6ec","number":17,"title":"0.13","description":"","creator":{"login":"mockersf","id":8672791,"node_id":"MDQ6VXNlcjg2NzI3OTE=","avatar_url":"https://avatars.githubusercontent.com/u/8672791?v=4","gravatar_id":"","url":"https://api.github.com/users/mockersf","html_url":"https://github.com/mockersf","followers_url":"https://api.github.com/users/mockersf/followers","following_url":"https://api.github.com/users/mockersf/following{/other_user}","gists_url":"https://api.github.com/users/mockersf/gists{/gist_id}","starred_url":"https://api.github.com/users/mockersf/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mockersf/subscriptions","organizations_url":"https://api.github.com/users/mockersf/orgs","repos_url":"https://api.github.com/users/mockersf/repos","events_url":"https://api.github.com/users/mockersf/events{/privacy}","received_events_url":"https://api.github.com/users/mockersf/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":196,"state":"closed","created_at":"2023-09-19T15:44:30Z","updated_at":"2024-02-18T21:14:43Z","due_on":"2024-02-03T08:00:00Z","closed_at":"2024-02-18T21:14:43Z"},"comments":1,"created_at":"2024-02-16T13:13:41Z","updated_at":"2024-02-17T01:33:24Z","closed_at":"2024-02-17T01:33:24Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## Bevy version\r\n\r\nmain (https://github.com/bevyengine/bevy/commit/fe777d5c3fba64bec250b8ced3a6ba98fbd07a64)\r\n\r\n## What you did\r\n\r\nI used lightmaps with the directional lights where `shadows_enabled` is set to `true`, here's an example:\r\n\r\n```rs\r\n//! Rendering a scene with baked lightmaps.\r\n\r\nuse bevy::pbr::Lightmap;\r\nuse bevy::prelude::*;\r\n\r\nfn main() {\r\n    App::new()\r\n        .add_plugins(DefaultPlugins)\r\n        .insert_resource(AmbientLight::NONE)\r\n        .add_systems(Startup, setup)\r\n        .add_systems(Update, add_lightmaps_to_meshes)\r\n        .run();\r\n}\r\n\r\nfn setup(mut commands: Commands, asset_server: Res<AssetServer>) {\r\n    commands.spawn(SceneBundle {\r\n        scene: asset_server.load(\"models/CornellBox/CornellBox.glb#Scene0\"),\r\n        ..default()\r\n    });\r\n\r\n    commands.spawn(Camera3dBundle {\r\n        transform: Transform::from_xyz(-278.0, 273.0, 800.0),\r\n        ..default()\r\n    });\r\n    commands.spawn(DirectionalLightBundle {\r\n        directional_light: DirectionalLight {\r\n            shadows_enabled: true, // This must be enabled for it to panic!\r\n            ..default()\r\n        },\r\n        ..default()\r\n    });\r\n}\r\n\r\nfn add_lightmaps_to_meshes(\r\n    mut commands: Commands,\r\n    asset_server: Res<AssetServer>,\r\n    mut materials: ResMut<Assets<StandardMaterial>>,\r\n    meshes: Query<\r\n        (Entity, &Name, &Handle<StandardMaterial>),\r\n        (With<Handle<Mesh>>, Without<Lightmap>),\r\n    >,\r\n) {\r\n    let exposure = 250.0;\r\n    for (entity, name, material) in meshes.iter() {\r\n        if &**name == \"Light\" {\r\n            materials.get_mut(material).unwrap().emissive = Color::WHITE * exposure;\r\n            continue;\r\n        }\r\n\r\n        if &**name == \"large_box\" {\r\n            materials.get_mut(material).unwrap().lightmap_exposure = exposure;\r\n            commands.entity(entity).insert(Lightmap {\r\n                image: asset_server.load(\"lightmaps/CornellBox-Large.zstd.ktx2\"),\r\n                ..default()\r\n            });\r\n            continue;\r\n        }\r\n\r\n        if &**name == \"small_box\" {\r\n            materials.get_mut(material).unwrap().lightmap_exposure = exposure;\r\n            commands.entity(entity).insert(Lightmap {\r\n                image: asset_server.load(\"lightmaps/CornellBox-Small.zstd.ktx2\"),\r\n                ..default()\r\n            });\r\n            continue;\r\n        }\r\n\r\n        if name.starts_with(\"cornell_box\") {\r\n            materials.get_mut(material).unwrap().lightmap_exposure = exposure;\r\n            commands.entity(entity).insert(Lightmap {\r\n                image: asset_server.load(\"lightmaps/CornellBox-Box.zstd.ktx2\"),\r\n                ..default()\r\n            });\r\n            continue;\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n## What went wrong\r\n\r\nI got this panic:\r\n\r\n```\r\n2024-02-16T13:06:01.153062Z ERROR log: Handling wgpu errors as fatal by default    \r\nthread '<unnamed>' panicked at /home/doonv/.cargo/registry/src/index.crates.io-6f17d22bba15001f/wgpu-0.19.1/src/backend/wgpu_core.rs:3009:5:\r\nwgpu error: Validation Error\r\n\r\nCaused by:\r\n    In a RenderPass\r\n      note: encoder = `shadow_pass_command_encoder`\r\n    In a draw command, indexed:true indirect:false\r\n      note: render pipeline = `pbr_prepass_pipeline`\r\n    Incompatible bind group at index 1 in the current render pipeline\r\n      note: Should be compatible an with an explicit bind group layout with label = `mesh_layout`\r\n      note: Assigned explicit bind group layout with label = `lightmapped_mesh_layout`\r\n      note: Entry 4 not found in expected bind group layout\r\n      note: Entry 5 not found in expected bind group layout\r\n\r\n\r\nnote: run with `RUST_BACKTRACE=1` environment variable to display a backtrace\r\nEncountered a panic in exclusive system `bevy_render::renderer::render_system`!\r\nthread 'Compute Task Pool (6)' panicked at crates/bevy_render/src/pipelined_rendering.rs:49:67:\r\ncalled `Result::unwrap()` on an `Err` value: RecvError\r\n```\r\n\r\n## Additional information\r\n\r\nThe lightmaps PR: https://github.com/bevyengine/bevy/pull/10231\r\n\r\nThis issue has been present since lightmaps were introduced.\r\n\r\n","closed_by":{"login":"cart","id":2694663,"node_id":"MDQ6VXNlcjI2OTQ2NjM=","avatar_url":"https://avatars.githubusercontent.com/u/2694663?v=4","gravatar_id":"","url":"https://api.github.com/users/cart","html_url":"https://github.com/cart","followers_url":"https://api.github.com/users/cart/followers","following_url":"https://api.github.com/users/cart/following{/other_user}","gists_url":"https://api.github.com/users/cart/gists{/gist_id}","starred_url":"https://api.github.com/users/cart/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cart/subscriptions","organizations_url":"https://api.github.com/users/cart/orgs","repos_url":"https://api.github.com/users/cart/repos","events_url":"https://api.github.com/users/cart/events{/privacy}","received_events_url":"https://api.github.com/users/cart/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/bevyengine/bevy/issues/11898/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/bevyengine/bevy/issues/11898/timeline","performed_via_github_app":null,"state_reason":"completed"}