{"url":"https://api.github.com/repos/bevyengine/bevy/issues/17642","repository_url":"https://api.github.com/repos/bevyengine/bevy","labels_url":"https://api.github.com/repos/bevyengine/bevy/issues/17642/labels{/name}","comments_url":"https://api.github.com/repos/bevyengine/bevy/issues/17642/comments","events_url":"https://api.github.com/repos/bevyengine/bevy/issues/17642/events","html_url":"https://github.com/bevyengine/bevy/issues/17642","id":2825634675,"node_id":"I_kwDODf6-U86oa8Nz","number":17642,"title":"`CubicSegment` lacks functionality of `CubicCurve`","user":{"login":"hocop","id":13086130,"node_id":"MDQ6VXNlcjEzMDg2MTMw","avatar_url":"https://avatars.githubusercontent.com/u/13086130?v=4","gravatar_id":"","url":"https://api.github.com/users/hocop","html_url":"https://github.com/hocop","followers_url":"https://api.github.com/users/hocop/followers","following_url":"https://api.github.com/users/hocop/following{/other_user}","gists_url":"https://api.github.com/users/hocop/gists{/gist_id}","starred_url":"https://api.github.com/users/hocop/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hocop/subscriptions","organizations_url":"https://api.github.com/users/hocop/orgs","repos_url":"https://api.github.com/users/hocop/repos","events_url":"https://api.github.com/users/hocop/events{/privacy}","received_events_url":"https://api.github.com/users/hocop/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":2747857990,"node_id":"MDU6TGFiZWwyNzQ3ODU3OTkw","url":"https://api.github.com/repos/bevyengine/bevy/labels/C-Usability","name":"C-Usability","color":"b8b8b8","default":false,"description":"A targeted quality-of-life change that makes Bevy easier to use"},{"id":3166124969,"node_id":"MDU6TGFiZWwzMTY2MTI0OTY5","url":"https://api.github.com/repos/bevyengine/bevy/labels/A-Math","name":"A-Math","color":"c6a751","default":false,"description":"Fundamental domain-agnostic mathematical operations"},{"id":3166151441,"node_id":"MDU6TGFiZWwzMTY2MTUxNDQx","url":"https://api.github.com/repos/bevyengine/bevy/labels/S-Ready-For-Implementation","name":"S-Ready-For-Implementation","color":"D876E3","default":false,"description":"This issue is ready for an implementation PR. Go for it!"},{"id":6899549740,"node_id":"LA_kwDODf6-U88AAAABmz7GLA","url":"https://api.github.com/repos/bevyengine/bevy/labels/X-Uncontroversial","name":"X-Uncontroversial","color":"d93f0b","default":false,"description":"This work is generally agreed upon"},{"id":6899576022,"node_id":"LA_kwDODf6-U88AAAABmz8s1g","url":"https://api.github.com/repos/bevyengine/bevy/labels/D-Modest","name":"D-Modest","color":"008672","default":false,"description":"A \"normal\" level of difficulty; suitable for simple features or challenging fixes"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2025-02-02T06:18:15Z","updated_at":"2025-02-26T20:55:53Z","closed_at":"2025-02-26T20:55:53Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## What problem does this solve or what need does it fill?\n\n`CubicCurve`, which is a `Vec<CubicSegment>`, can be used in many ways, e.g. creating roads and paths.\n\nHowever, in many cases `CubicSegment` is very useful by itself. For example, I want to check if my entity will not collide with anything, while following a curved path. But the check is still local enough, so I don't need the whole `CubicCurve`\n\n**Performance considerations.** \n\n`CubicCurve` contains a `Vec`, which is heap allocated. It is expensive, if spawned every frame for many entities.\n\n`CubicSegment`, on the other hand, is fixed size, which is ideal for such scenario.\n\nHowever, the [implementation](https://github.com/bevyengine/bevy/blob/082d87141fdf7951ed04dc3550d6542f4a9da07f/crates/bevy_math/src/cubic_splines/mod.rs#L1035) of `CubicSegment::new_bezier` includes creating a `CubicCurve` of size 1, only to take the first element later. It is still an allocation, and in this case, an unnecessary one.\n\n## What solution would you like?\n\n1. I want be able to create `CubicSegment` from 4 control points, not just 2. Right now it seems like it is just intended for animation easing purposes.\n2. I would like it to be as fast as can be expected from creating a fixed size struct.\n3. I would like `CubicSegment::iter_positions` and other cool functions that `CubicCurve` has\n\n## What alternative(s) have you considered?\n\nI implemented my own hacky trait to have this functionality:\n\n```rust\npub trait CubicSegment4 {\n    fn new_bezier_4(p1: impl Into<Vec2>, p2: impl Into<Vec2>, p3: impl Into<Vec2>, p4: impl Into<Vec2>) -> Self;\n\n    fn iter_positions(self, subdivisions: usize) -> impl Iterator<Item=Vec2>;\n}\n\nimpl CubicSegment4 for CubicSegment<Vec2> {\n    fn new_bezier_4(p1: impl Into<Vec2>, p2: impl Into<Vec2>, p3: impl Into<Vec2>, p4: impl Into<Vec2>) -> Self {\n        // A derivation for this matrix can be found in \"General Matrix Representations for B-splines\" by Kaihuai Qin.\n        // <https://xiaoxingchen.github.io/2020/03/02/bspline_in_so3/general_matrix_representation_for_bsplines.pdf>\n        // See section 4.2 and equation 11.\n        let char_matrix = [\n            [1., 0., 0., 0.],\n            [-3., 3., 0., 0.],\n            [3., -6., 3., 0.],\n            [-1., 3., -3., 1.],\n        ];\n        let p: [Vec2; 4] = [p1.into(), p2.into(), p3.into(), p4.into()];\n        coefficients(p, char_matrix)\n    }\n\n    fn iter_positions(self, subdivisions: usize) -> impl Iterator<Item=Vec2> {\n        let step = 1.0 / subdivisions as f32;\n        (0..=subdivisions).map(move |i| i as f32 * step)\n        .map(move |t| self.position(t))\n    }\n}\n\nfn coefficients<P: VectorSpace>(p: [P; 4], char_matrix: [[f32; 4]; 4]) -> CubicSegment<P> {\n    let [c0, c1, c2, c3] = char_matrix;\n    // These are the polynomial coefficients, computed by multiplying the characteristic\n    // matrix by the point matrix.\n    let coeff = [\n        p[0] * c0[0] + p[1] * c0[1] + p[2] * c0[2] + p[3] * c0[3],\n        p[0] * c1[0] + p[1] * c1[1] + p[2] * c1[2] + p[3] * c1[3],\n        p[0] * c2[0] + p[1] * c2[1] + p[2] * c2[2] + p[3] * c2[3],\n        p[0] * c3[0] + p[1] * c3[1] + p[2] * c3[2] + p[3] * c3[3],\n    ];\n    CubicSegment::<P> { coeff }\n}\n```\n\nIt does the thing without memory allocations. But has some duplicated code.\n\nExample usage:\n```rust\npub fn get_curve(\n    pos_1: Vec2,\n    pos_2: Vec2,\n    anchor: Option<Vec2>\n) -> CubicSegment<Vec2> {\n    if let Some(anchor) = anchor {\n        // Curve with anchor point\n        CubicSegment::new_bezier_4(\n            pos_1,\n            pos_1.lerp(anchor, 0.66),\n            pos_2.lerp(anchor, 0.66),\n            pos_2\n        )\n    } else {\n        // Straight line\n        CubicSegment::new_bezier_4(\n            pos_1,\n            pos_1.lerp(pos_2, 0.33),\n            pos_1.lerp(pos_2, 0.66),\n            pos_2\n        )\n    }\n}\n```\n\n## Additional context\n\nLooking at code, looks like `CubicSegment` is being sort of ignored in favor of the `CubicCurve`. I think many functions like the `new_bezier` and `new_bezier_4` should really be implemented on the base structure.","closed_by":{"login":"alice-i-cecile","id":3579909,"node_id":"MDQ6VXNlcjM1Nzk5MDk=","avatar_url":"https://avatars.githubusercontent.com/u/3579909?v=4","gravatar_id":"","url":"https://api.github.com/users/alice-i-cecile","html_url":"https://github.com/alice-i-cecile","followers_url":"https://api.github.com/users/alice-i-cecile/followers","following_url":"https://api.github.com/users/alice-i-cecile/following{/other_user}","gists_url":"https://api.github.com/users/alice-i-cecile/gists{/gist_id}","starred_url":"https://api.github.com/users/alice-i-cecile/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alice-i-cecile/subscriptions","organizations_url":"https://api.github.com/users/alice-i-cecile/orgs","repos_url":"https://api.github.com/users/alice-i-cecile/repos","events_url":"https://api.github.com/users/alice-i-cecile/events{/privacy}","received_events_url":"https://api.github.com/users/alice-i-cecile/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/bevyengine/bevy/issues/17642/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/bevyengine/bevy/issues/17642/timeline","performed_via_github_app":null,"state_reason":"completed"}