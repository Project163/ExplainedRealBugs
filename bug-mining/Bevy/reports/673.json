{"url":"https://api.github.com/repos/bevyengine/bevy/issues/13373","repository_url":"https://api.github.com/repos/bevyengine/bevy","labels_url":"https://api.github.com/repos/bevyengine/bevy/issues/13373/labels{/name}","comments_url":"https://api.github.com/repos/bevyengine/bevy/issues/13373/comments","events_url":"https://api.github.com/repos/bevyengine/bevy/issues/13373/events","html_url":"https://github.com/bevyengine/bevy/issues/13373","id":2296464609,"node_id":"I_kwDODf6-U86I4UTh","number":13373,"title":"User provided mesh binding / per-instance mesh data","user":{"login":"tychedelia","id":10366310,"node_id":"MDQ6VXNlcjEwMzY2MzEw","avatar_url":"https://avatars.githubusercontent.com/u/10366310?v=4","gravatar_id":"","url":"https://api.github.com/users/tychedelia","html_url":"https://github.com/tychedelia","followers_url":"https://api.github.com/users/tychedelia/followers","following_url":"https://api.github.com/users/tychedelia/following{/other_user}","gists_url":"https://api.github.com/users/tychedelia/gists{/gist_id}","starred_url":"https://api.github.com/users/tychedelia/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tychedelia/subscriptions","organizations_url":"https://api.github.com/users/tychedelia/orgs","repos_url":"https://api.github.com/users/tychedelia/repos","events_url":"https://api.github.com/users/tychedelia/events{/privacy}","received_events_url":"https://api.github.com/users/tychedelia/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1795619326,"node_id":"MDU6TGFiZWwxNzk1NjE5MzI2","url":"https://api.github.com/repos/bevyengine/bevy/labels/C-Feature","name":"C-Feature","color":"b8b8b8","default":false,"description":"A new feature, making something new possible"},{"id":2045383863,"node_id":"MDU6TGFiZWwyMDQ1MzgzODYz","url":"https://api.github.com/repos/bevyengine/bevy/labels/A-Rendering","name":"A-Rendering","color":"C6A751","default":false,"description":"Drawing game state to the screen"},{"id":3166143717,"node_id":"MDU6TGFiZWwzMTY2MTQzNzE3","url":"https://api.github.com/repos/bevyengine/bevy/labels/D-Complex","name":"D-Complex","color":"008672","default":false,"description":"Quite challenging from either a design or technical perspective. Ask for help!"},{"id":3166151441,"node_id":"MDU6TGFiZWwzMTY2MTUxNDQx","url":"https://api.github.com/repos/bevyengine/bevy/labels/S-Ready-For-Implementation","name":"S-Ready-For-Implementation","color":"D876E3","default":false,"description":"This issue is ready for an implementation PR. Go for it!"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2024-05-14T21:46:41Z","updated_at":"2025-02-10T22:59:17Z","closed_at":"2025-02-10T22:59:17Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## What problem does this solve or what need does it fill?\r\n\r\nA common pattern in creative coding is to use the instance index in a shader in order to sample from something like a texture or read from a SSBO. For example, the shader might use one texture in order to offset the position of the mesh and a second texture in order to determine the vertex color. \r\n\r\nCurrently, batch rendered entities (i.e. entities that share the same mesh and material) are instanced in a random order relative to how they were spawned. This is due a variety of causes:\r\n- Instability in ECS queries.\r\n- GPU preprocessing compute shader.\r\n- Order of rendering bins.\r\n\r\nConsequently, because the instance index is \"random\", it's not possible in a custom shader to know where to sample from an input texture. \r\n\r\nSee the following pseudo UV maps to see what this looks like with different rendering features enabled:\r\n<img src=\"https://github.com/bevyengine/bevy/assets/10366310/01e09e9c-3d85-4ba8-8603-f779a46c14d9\" width=250 height=250/>\r\n<img src=\"https://github.com/bevyengine/bevy/assets/10366310/d679f4af-f151-4c9c-ad6d-aee7f959828d\" width=250 height=250/>\r\n\r\n## What solution would you like?\r\n\r\nThe user should be able to provide a custom binding representing per-instance mesh data, i.e. a SSBO that they can index into with the instance index to retrieve additional data required for their vertex shader.\r\n\r\nThe difficult part here is that in order to write into the user data buffer, it needs to be plumbed everywhere the `MeshUniform` is created, including our new preprocessing compute shader. In order not to pollute all our rendering code, this means we need some kind of generic plugin for instance data that gets type erased in our rendering code so that it can optionally injected everywhere it needs to go.\r\n\r\n## What alternative(s) have you considered?\r\n\r\nWe could, alternatively, track some kind of total \"spawn order\" and add this as a new index to `MeshUniform`. The user could then bind their buffer to their material and index into that instead. This has a few disadvantages:\r\n- Adding a `u32` to every mesh uniform that is likely unnecessary for most users.\r\n- Requiring all possible data to be input to the material even though many of the instances may be culled.\r\n- Difficult to track when the spawn order should be when meshes are despawned and respawned.\r\n\r\n## Additional context\r\n\r\nThere's prior art here I'm happy to reference in terms of how this typically works in creative coding applications.\r\n","closed_by":{"login":"alice-i-cecile","id":3579909,"node_id":"MDQ6VXNlcjM1Nzk5MDk=","avatar_url":"https://avatars.githubusercontent.com/u/3579909?v=4","gravatar_id":"","url":"https://api.github.com/users/alice-i-cecile","html_url":"https://github.com/alice-i-cecile","followers_url":"https://api.github.com/users/alice-i-cecile/followers","following_url":"https://api.github.com/users/alice-i-cecile/following{/other_user}","gists_url":"https://api.github.com/users/alice-i-cecile/gists{/gist_id}","starred_url":"https://api.github.com/users/alice-i-cecile/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alice-i-cecile/subscriptions","organizations_url":"https://api.github.com/users/alice-i-cecile/orgs","repos_url":"https://api.github.com/users/alice-i-cecile/repos","events_url":"https://api.github.com/users/alice-i-cecile/events{/privacy}","received_events_url":"https://api.github.com/users/alice-i-cecile/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/bevyengine/bevy/issues/13373/reactions","total_count":3,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":3,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/bevyengine/bevy/issues/13373/timeline","performed_via_github_app":null,"state_reason":"completed"}