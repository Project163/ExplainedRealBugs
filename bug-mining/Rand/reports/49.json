{"url":"https://api.github.com/repos/rust-random/rand/issues/1158","repository_url":"https://api.github.com/repos/rust-random/rand","labels_url":"https://api.github.com/repos/rust-random/rand/issues/1158/labels{/name}","comments_url":"https://api.github.com/repos/rust-random/rand/issues/1158/comments","events_url":"https://api.github.com/repos/rust-random/rand/issues/1158/events","html_url":"https://github.com/rust-random/rand/issues/1158","id":973972536,"node_id":"MDU6SXNzdWU5NzM5NzI1MzY=","number":1158,"title":"Unsoundness in <BlockRng64 as RngCore>:: next_u32","user":{"login":"joshlf","id":1046063,"node_id":"MDQ6VXNlcjEwNDYwNjM=","avatar_url":"https://avatars.githubusercontent.com/u/1046063?v=4","gravatar_id":"","url":"https://api.github.com/users/joshlf","html_url":"https://github.com/joshlf","followers_url":"https://api.github.com/users/joshlf/followers","following_url":"https://api.github.com/users/joshlf/following{/other_user}","gists_url":"https://api.github.com/users/joshlf/gists{/gist_id}","starred_url":"https://api.github.com/users/joshlf/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/joshlf/subscriptions","organizations_url":"https://api.github.com/users/joshlf/orgs","repos_url":"https://api.github.com/users/joshlf/repos","events_url":"https://api.github.com/users/joshlf/events{/privacy}","received_events_url":"https://api.github.com/users/joshlf/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2021-08-18T19:07:01Z","updated_at":"2021-09-12T14:57:59Z","closed_at":"2021-09-12T14:57:59Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Here's the code in question:\r\n\r\nhttps://github.com/rust-random/rand/blob/54e219d7b269ae9e2440193938958870051d5716/rand_core/src/block.rs#L349-L376\r\n\r\nThe following unsafe block...\r\n\r\nhttps://github.com/rust-random/rand/blob/54e219d7b269ae9e2440193938958870051d5716/rand_core/src/block.rs#L368-L375\r\n\r\n...is only sound if we are guaranteed that `self.results.as_ref()` returns a slice of sufficient length. However, if we simply provide a `BlockRngCore` implementation with `Results = [u64; 0]`, the code becomes unsound because it reads out-of-bounds memory.\r\n\r\nI was able to prototype this with the following code (see [on the Rust playground](https://play.rust-lang.org/?version=stable&mode=debug&edition=2018&gist=e7386357b86dc7309cd61ad40a4af2eb)):\r\n\r\n```rust\r\nstruct BadCore;\r\n\r\nimpl BlockRngCore for BadCore {\r\n    type Item = u64;\r\n    type Results = [u64; 0];\r\n    fn generate(&mut self, _results: &mut Self::Results) {}\r\n}\r\n\r\nfn main() {\r\n    let mut r = BlockRng64::new(BadCore);\r\n    let _ = r.next_u32();\r\n}\r\n```\r\n\r\nRunning under MIRI, we get the following error:\r\n\r\n<details>\r\n\r\n<summary>MIRI error</summary>\r\n\r\n```text\r\nerror: Undefined Behavior: trying to reborrow for SharedReadOnly at alloc1442, but parent tag <untagged> does not have an appropriate item in the borrow stack\r\n   --> /playground/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/slice/mod.rs:363:18\r\n    |\r\n363 |         unsafe { &*index.get_unchecked(self) }\r\n    |                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^ trying to reborrow for SharedReadOnly at alloc1442, but parent tag <untagged> does not have an appropriate item in the borrow stack\r\n    |\r\n    = help: this indicates a potential bug in the program: it performed an invalid operation, but the rules it violated are still experimental\r\n    = help: see https://github.com/rust-lang/unsafe-code-guidelines/blob/master/wip/stacked-borrows.md for further information\r\n            \r\n    = note: inside `core::slice::<impl [u32]>::get_unchecked::<usize>` at /playground/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/slice/mod.rs:363:18\r\n    = note: inside `<rand_core::block::BlockRng64<BadCore> as rand_core::RngCore>::next_u32` at /playground/.cargo/registry/src/github.com-1ecc6299db9ec823/rand_core-0.6.3/src/block.rs:371:18\r\nnote: inside `main` at src/main.rs:39:13\r\n   --> src/main.rs:39:13\r\n    |\r\n39  |     let _ = r.next_u32();\r\n    |             ^^^^^^^^^^^^\r\n    = note: inside `<fn() as std::ops::FnOnce<()>>::call_once - shim(fn())` at /playground/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/ops/function.rs:227:5\r\n    = note: inside `std::sys_common::backtrace::__rust_begin_short_backtrace::<fn(), ()>` at /playground/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/sys_common/backtrace.rs:125:18\r\n    = note: inside closure at /playground/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/rt.rs:63:18\r\n    = note: inside `std::ops::function::impls::<impl std::ops::FnOnce<()> for &dyn std::ops::Fn() -> i32 + std::marker::Sync + std::panic::RefUnwindSafe>::call_once` at /playground/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/ops/function.rs:259:13\r\n    = note: inside `std::panicking::r#try::do_call::<&dyn std::ops::Fn() -> i32 + std::marker::Sync + std::panic::RefUnwindSafe, i32>` at /playground/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/panicking.rs:403:40\r\n    = note: inside `std::panicking::r#try::<i32, &dyn std::ops::Fn() -> i32 + std::marker::Sync + std::panic::RefUnwindSafe>` at /playground/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/panicking.rs:367:19\r\n    = note: inside `std::panic::catch_unwind::<&dyn std::ops::Fn() -> i32 + std::marker::Sync + std::panic::RefUnwindSafe, i32>` at /playground/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/panic.rs:129:14\r\n    = note: inside closure at /playground/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/rt.rs:45:48\r\n    = note: inside `std::panicking::r#try::do_call::<[closure@std::rt::lang_start_internal::{closure#2}], isize>` at /playground/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/panicking.rs:403:40\r\n    = note: inside `std::panicking::r#try::<isize, [closure@std::rt::lang_start_internal::{closure#2}]>` at /playground/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/panicking.rs:367:19\r\n    = note: inside `std::panic::catch_unwind::<[closure@std::rt::lang_start_internal::{closure#2}], isize>` at /playground/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/panic.rs:129:14\r\n    = note: inside `std::rt::lang_start_internal` at /playground/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/rt.rs:45:20\r\n    = note: inside `std::rt::lang_start::<()>` at /playground/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/rt.rs:62:5\r\n```\r\n\r\n</details>\r\n\r\nNote, by the way, that it is not sufficient to first bounds check `self.results.as_ref()` and then later call `self.results.as_ref()` inside of the `unsafe` block, as there's no guarantee that subsequent calls to `as_ref` always return the same reference, or even slice references with the same length. It's necessary to assign `self.results.as_ref()` to a local variable, bounds check that, and then use the local variable inside of the `unsafe` block.","closed_by":{"login":"vks","id":33460,"node_id":"MDQ6VXNlcjMzNDYw","avatar_url":"https://avatars.githubusercontent.com/u/33460?v=4","gravatar_id":"","url":"https://api.github.com/users/vks","html_url":"https://github.com/vks","followers_url":"https://api.github.com/users/vks/followers","following_url":"https://api.github.com/users/vks/following{/other_user}","gists_url":"https://api.github.com/users/vks/gists{/gist_id}","starred_url":"https://api.github.com/users/vks/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/vks/subscriptions","organizations_url":"https://api.github.com/users/vks/orgs","repos_url":"https://api.github.com/users/vks/repos","events_url":"https://api.github.com/users/vks/events{/privacy}","received_events_url":"https://api.github.com/users/vks/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rust-random/rand/issues/1158/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rust-random/rand/issues/1158/timeline","performed_via_github_app":null,"state_reason":"completed"}