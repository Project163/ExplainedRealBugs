{"url":"https://api.github.com/repos/rust-random/rand/issues/734","repository_url":"https://api.github.com/repos/rust-random/rand","labels_url":"https://api.github.com/repos/rust-random/rand/issues/734/labels{/name}","comments_url":"https://api.github.com/repos/rust-random/rand/issues/734/comments","events_url":"https://api.github.com/repos/rust-random/rand/issues/734/events","html_url":"https://github.com/rust-random/rand/issues/734","id":411778482,"node_id":"MDU6SXNzdWU0MTE3Nzg0ODI=","number":734,"title":"Slow sampling of binomial distribution for small p","user":{"login":"geq1t","id":46968560,"node_id":"MDQ6VXNlcjQ2OTY4NTYw","avatar_url":"https://avatars.githubusercontent.com/u/46968560?v=4","gravatar_id":"","url":"https://api.github.com/users/geq1t","html_url":"https://github.com/geq1t","followers_url":"https://api.github.com/users/geq1t/followers","following_url":"https://api.github.com/users/geq1t/following{/other_user}","gists_url":"https://api.github.com/users/geq1t/gists{/gist_id}","starred_url":"https://api.github.com/users/geq1t/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/geq1t/subscriptions","organizations_url":"https://api.github.com/users/geq1t/orgs","repos_url":"https://api.github.com/users/geq1t/repos","events_url":"https://api.github.com/users/geq1t/events{/privacy}","received_events_url":"https://api.github.com/users/geq1t/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":9,"created_at":"2019-02-19T07:15:49Z","updated_at":"2019-02-27T15:25:30Z","closed_at":"2019-02-27T15:25:30Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Hi,\r\n\r\nFirst off, I use the rand crate in our quantum computer simulator, and on the whole it has been a pleasure to use, so thank you for creating it.\r\n\r\nOn to my problem: I experienced some unexpected and inconsistent slowdowns when executing certain programs, and I managed to track the problem down to  sampling from a binomial distribution using a very small success probability (caused by round off errors, the probability should have been exactly zero). I can reproduce the problem, e.g. with the following sample program:\r\n\r\n```\r\nextern crate rand;\r\n\r\nuse rand::Rng;\r\n\r\nfn main()\r\n{\r\n    let n = 1000000;\r\n    let mut  p = 1.0e-15;\r\n\r\n    for _ in 0..20\r\n    {\r\n        let distr = rand::distributions::Binomial::new(n, p);\r\n\r\n        let tic = ::std::time::Instant::now();\r\n        let count = rand::thread_rng().sample(&distr);\r\n\r\n        let dur = tic.elapsed();\r\n        println!(\"{:.2e} {} {}.{:03}\", p, count, dur.as_secs(), dur.subsec_millis());\r\n        p *= 0.1;\r\n    }\r\n}\r\n```\r\n\r\nUsing rand 0.6.5, on my computer this gives the following output (debug build):\r\n```\r\n1.00e-15 0 0.001\r\n1.00e-16 0 0.000\r\n1.00e-17 0 0.001\r\n1.00e-18 0 0.000\r\n1.00e-19 0 0.001\r\n1.00e-20 0 0.002\r\n1.00e-21 0 0.023\r\n1.00e-22 0 0.009\r\n1.00e-23 0 0.030\r\n1.00e-24 0 0.009\r\n1.00e-25 0 0.034\r\n1.00e-26 0 0.033\r\n1.00e-27 0 0.200\r\n1.00e-28 0 0.227\r\n1.00e-29 0 0.887\r\n1.00e-30 0 1.213\r\n1.00e-31 0 0.953\r\n1.00e-32 0 3.550\r\n1.00e-33 0 1.056\r\n1.00e-34 0 11.135\r\n```\r\n\r\nI realize this is something of a pathological problem, but would it be possible to harden the binomial sampling against such abuse?","closed_by":{"login":"dhardy","id":134893,"node_id":"MDQ6VXNlcjEzNDg5Mw==","avatar_url":"https://avatars.githubusercontent.com/u/134893?v=4","gravatar_id":"","url":"https://api.github.com/users/dhardy","html_url":"https://github.com/dhardy","followers_url":"https://api.github.com/users/dhardy/followers","following_url":"https://api.github.com/users/dhardy/following{/other_user}","gists_url":"https://api.github.com/users/dhardy/gists{/gist_id}","starred_url":"https://api.github.com/users/dhardy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dhardy/subscriptions","organizations_url":"https://api.github.com/users/dhardy/orgs","repos_url":"https://api.github.com/users/dhardy/repos","events_url":"https://api.github.com/users/dhardy/events{/privacy}","received_events_url":"https://api.github.com/users/dhardy/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rust-random/rand/issues/734/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rust-random/rand/issues/734/timeline","performed_via_github_app":null,"state_reason":"completed"}