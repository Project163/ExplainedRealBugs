{"url":"https://api.github.com/repos/catchorg/Catch2/issues/2897","repository_url":"https://api.github.com/repos/catchorg/Catch2","labels_url":"https://api.github.com/repos/catchorg/Catch2/issues/2897/labels{/name}","comments_url":"https://api.github.com/repos/catchorg/Catch2/issues/2897/comments","events_url":"https://api.github.com/repos/catchorg/Catch2/issues/2897/events","html_url":"https://github.com/catchorg/Catch2/issues/2897","id":2459159680,"node_id":"I_kwDOABA2rM6Sk8yA","number":2897,"title":"Huge performance hit & termination due to high memory usage when using the JUnit reporter","user":{"login":"irieger","id":142033,"node_id":"MDQ6VXNlcjE0MjAzMw==","avatar_url":"https://avatars.githubusercontent.com/u/142033?v=4","gravatar_id":"","url":"https://api.github.com/users/irieger","html_url":"https://github.com/irieger","followers_url":"https://api.github.com/users/irieger/followers","following_url":"https://api.github.com/users/irieger/following{/other_user}","gists_url":"https://api.github.com/users/irieger/gists{/gist_id}","starred_url":"https://api.github.com/users/irieger/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/irieger/subscriptions","organizations_url":"https://api.github.com/users/irieger/orgs","repos_url":"https://api.github.com/users/irieger/repos","events_url":"https://api.github.com/users/irieger/events{/privacy}","received_events_url":"https://api.github.com/users/irieger/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2024-08-10T16:37:07Z","updated_at":"2024-08-13T19:14:07Z","closed_at":"2024-08-13T17:35:44Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Describe the bug**\r\nI recently upgraded my C++ projects unit tests by adding a JUnit reporter to use the resulting XML reports in gitlab for test result reports. While the gitlab part works well, I discovered, that adding the JUnit reporter increases the runtime of some of the tests in a really massive way. What normally takes < 10s including all the overhead of managing my environment in the gitlab executor takes - depending on the platform - up to around 4 minutes. The only change being the additional `--reporter \"JUnit::out=/tmp/catch2-xml-report\"`.\r\n\r\n*Edit:*\r\nAdditionally, the memory usage also explodes as I just found out. My CI test process, as I was extending my test cases, just \"exploded\". Meaning it was killed due to memory usage. I found hints to use GNU time to measure not only time but memory information. From what I got the interesting line is the following, first without the JUnit reporter, second with (this is from my actual project):\r\n```\r\nMaximum resident set size (kbytes): 1678916\r\nMaximum resident set size (kbytes): 29153956\r\n```\r\n\r\nFor the sample project:\r\n```\r\n... % /usr/bin/time -v ./sample_test                                      [cpp-playground/catch2-speed-sample/build/Release]\r\nRandomness seeded to: 1267125391\r\n===============================================================================\r\nAll tests passed (62914560 assertions in 1 test case)\r\n\r\n\tCommand being timed: \"./sample_test\"\r\n\tUser time (seconds): 1.06\r\n\tSystem time (seconds): 0.03\r\n\tPercent of CPU this job got: 99%\r\n\tElapsed (wall clock) time (h:mm:ss or m:ss): 0:01.10\r\n\tAverage shared text size (kbytes): 0\r\n\tAverage unshared data size (kbytes): 0\r\n\tAverage stack size (kbytes): 0\r\n\tAverage total size (kbytes): 0\r\n\tMaximum resident set size (kbytes): 249876\r\n\tAverage resident set size (kbytes): 0\r\n\tMajor (requiring I/O) page faults: 0\r\n\tMinor (reclaiming a frame) page faults: 294\r\n\tVoluntary context switches: 1\r\n\tInvoluntary context switches: 11\r\n\tSwaps: 0\r\n\tFile system inputs: 0\r\n\tFile system outputs: 0\r\n\tSocket messages sent: 0\r\n\tSocket messages received: 0\r\n\tSignals delivered: 0\r\n\tPage size (bytes): 4096\r\n\tExit status: 0\r\n... % /usr/bin/time -v ./sample_test --reporter \"JUnit::out=/tmp/catch2-xml-report\" --reporter 'console::out=-::colour-mode=ansi'\r\nRandomness seeded to: 3630092844\r\n===============================================================================\r\nAll tests passed (62914560 assertions in 1 test case)\r\n\r\n\tCommand being timed: \"./sample_test --reporter JUnit::out=/tmp/catch2-xml-report --reporter console::out=-::colour-mode=ansi\"\r\n\tUser time (seconds): 11.01\r\n\tSystem time (seconds): 7.73\r\n\tPercent of CPU this job got: 99%\r\n\tElapsed (wall clock) time (h:mm:ss or m:ss): 0:18.86\r\n\tAverage shared text size (kbytes): 0\r\n\tAverage unshared data size (kbytes): 0\r\n\tAverage stack size (kbytes): 0\r\n\tAverage total size (kbytes): 0\r\n\tMaximum resident set size (kbytes): 29087972\r\n\tAverage resident set size (kbytes): 0\r\n\tMajor (requiring I/O) page faults: 0\r\n\tMinor (reclaiming a frame) page faults: 565154\r\n\tVoluntary context switches: 1\r\n\tInvoluntary context switches: 250\r\n\tSwaps: 0\r\n\tFile system inputs: 0\r\n\tFile system outputs: 0\r\n\tSocket messages sent: 0\r\n\tSocket messages received: 0\r\n\tSignals delivered: 0\r\n\tPage size (bytes): 4096\r\n\tExit status: 0\r\n```\r\n\r\n**Expected behavior**\r\nThe test running with only minimal overhead. At least for the success case. In the end the report only contains more or less the same information as the command line (plus the name of each test & its runtime, but that shouldn't be too costly, right?). The file (in the success case) is just 448 characters.\r\n\r\n**Reproduction steps**\r\nI build a small sample project showing the problem. It uses conan to get Catch2 but I guess it could easily be included otherwise, conan is just the way I'm used to now: https://github.com/irieger/cpp-playground/blob/main/catch2-speed-sample/\r\n\r\nThe relevant file is `catch2-speed-sample/src/catch2_many_assertions.cpp`. It \"simulates\" a common use case - at least for me - where I have a large vector holding image data comparing an input processed through an algorithm with a reference, often with an accepted difference.\r\n\r\nThis results in quite some millions of assertions. In this case I simulate a 30 Megapixel RGB image. Normally I have much smaller tests but also quite a few of those resulting in some million assertions in sum too.\r\n\r\nRunning this either directly (or with manually set console output) vs. a JUnit reporter shows the difference. Here is the output of running 10 times for each showing that the timing is overall consistent.\r\n\r\nConsole only, very consistent ~1.2s overall time for execution per run. Output piped to /dev/null as there intentionally are some assertions failing here:\r\n```\r\n... % for i in $(seq 10); do time ./sample_test --reporter 'console::out=-::colour-mode=ansi' >/dev/null; done\r\n./sample_test --reporter 'console::out=-::colour-mode=ansi' > /dev/null  1.15s user 0.06s system 99% cpu 1.212 total\r\n./sample_test --reporter 'console::out=-::colour-mode=ansi' > /dev/null  1.14s user 0.05s system 99% cpu 1.200 total\r\n./sample_test --reporter 'console::out=-::colour-mode=ansi' > /dev/null  1.13s user 0.06s system 99% cpu 1.201 total\r\n./sample_test --reporter 'console::out=-::colour-mode=ansi' > /dev/null  1.17s user 0.04s system 99% cpu 1.212 total\r\n./sample_test --reporter 'console::out=-::colour-mode=ansi' > /dev/null  1.14s user 0.06s system 99% cpu 1.204 total\r\n./sample_test --reporter 'console::out=-::colour-mode=ansi' > /dev/null  1.18s user 0.03s system 99% cpu 1.215 total\r\n./sample_test --reporter 'console::out=-::colour-mode=ansi' > /dev/null  1.14s user 0.06s system 99% cpu 1.203 total\r\n./sample_test --reporter 'console::out=-::colour-mode=ansi' > /dev/null  1.15s user 0.05s system 99% cpu 1.199 total\r\n./sample_test --reporter 'console::out=-::colour-mode=ansi' > /dev/null  1.18s user 0.04s system 99% cpu 1.218 total\r\n./sample_test --reporter 'console::out=-::colour-mode=ansi' > /dev/null  1.13s user 0.08s system 99% cpu 1.215 total\r\n```\r\n\r\nRun with JUnit reporter, time per execution ~24.4s:\r\n```\r\n.. % for i in $(seq 10); do time ./sample_test --reporter \"JUnit::out=/tmp/catch2-xml-report\"; done             \r\n./sample_test --reporter \"JUnit::out=/tmp/catch2-xml-report\"  11.38s user 12.52s system 99% cpu 24.019 total\r\n./sample_test --reporter \"JUnit::out=/tmp/catch2-xml-report\"  11.60s user 13.07s system 99% cpu 24.794 total\r\n./sample_test --reporter \"JUnit::out=/tmp/catch2-xml-report\"  11.90s user 12.85s system 99% cpu 24.884 total\r\n./sample_test --reporter \"JUnit::out=/tmp/catch2-xml-report\"  11.78s user 13.06s system 99% cpu 24.956 total\r\n./sample_test --reporter \"JUnit::out=/tmp/catch2-xml-report\"  11.71s user 12.19s system 99% cpu 24.020 total\r\n./sample_test --reporter \"JUnit::out=/tmp/catch2-xml-report\"  11.48s user 12.88s system 99% cpu 24.484 total\r\n./sample_test --reporter \"JUnit::out=/tmp/catch2-xml-report\"  11.82s user 12.96s system 99% cpu 24.910 total\r\n./sample_test --reporter \"JUnit::out=/tmp/catch2-xml-report\"  11.56s user 12.91s system 99% cpu 24.585 total\r\n./sample_test --reporter \"JUnit::out=/tmp/catch2-xml-report\"  11.73s user 12.99s system 99% cpu 24.851 total\r\n./sample_test --reporter \"JUnit::out=/tmp/catch2-xml-report\"  11.44s user 12.63s system 99% cpu 24.199 total\r\n```\r\n\r\nIf I change it to succeed, it takes ~1.1s with the console output & ~18s\r\n\r\n**Platform information:**\r\n - OS: Arch Linux\r\n - Compiler+version: **GCC v14.2.1**\r\n - Catch version: **v3.6.0**\r\n\r\nThe measurements and system information above are from my workstation. In my CI I can reproduce the behaviour for Linux, Mac (for arm64 native and x64 cross-compiled run in Rosetta 2) and Windows, although the performance hit isn't exactly the same, in all cases the reporter is several times slower. In the end it is roughly 10-30 times slower.\r\n\r\n**Additional context**\r\nThe reporter is a really nice addition and I was happy to find it. But blocking a CI runners for 240s instead of 10s is really a huge hit. Hope there is a way to prevent that.\r\n\r\nMaybe an alternative if that is performance relevant could be to have a flag to only report the number of successes/faild in the XML, not report each with a line in the XML? Maybe this is the overhead?","closed_by":{"login":"horenmar","id":9026413,"node_id":"MDQ6VXNlcjkwMjY0MTM=","avatar_url":"https://avatars.githubusercontent.com/u/9026413?v=4","gravatar_id":"","url":"https://api.github.com/users/horenmar","html_url":"https://github.com/horenmar","followers_url":"https://api.github.com/users/horenmar/followers","following_url":"https://api.github.com/users/horenmar/following{/other_user}","gists_url":"https://api.github.com/users/horenmar/gists{/gist_id}","starred_url":"https://api.github.com/users/horenmar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/horenmar/subscriptions","organizations_url":"https://api.github.com/users/horenmar/orgs","repos_url":"https://api.github.com/users/horenmar/repos","events_url":"https://api.github.com/users/horenmar/events{/privacy}","received_events_url":"https://api.github.com/users/horenmar/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/catchorg/Catch2/issues/2897/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/catchorg/Catch2/issues/2897/timeline","performed_via_github_app":null,"state_reason":"completed"}