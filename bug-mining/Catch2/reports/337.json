{"url":"https://api.github.com/repos/catchorg/Catch2/issues/3038","repository_url":"https://api.github.com/repos/catchorg/Catch2","labels_url":"https://api.github.com/repos/catchorg/Catch2/issues/3038/labels{/name}","comments_url":"https://api.github.com/repos/catchorg/Catch2/issues/3038/comments","events_url":"https://api.github.com/repos/catchorg/Catch2/issues/3038/events","html_url":"https://github.com/catchorg/Catch2/issues/3038","id":3491765927,"node_id":"I_kwDOABA2rM7QIB6n","number":3038,"title":"Section path filtering is hilarious broken","user":{"login":"horenmar","id":9026413,"node_id":"MDQ6VXNlcjkwMjY0MTM=","avatar_url":"https://avatars.githubusercontent.com/u/9026413?v=4","gravatar_id":"","url":"https://api.github.com/users/horenmar","html_url":"https://github.com/horenmar","followers_url":"https://api.github.com/users/horenmar/followers","following_url":"https://api.github.com/users/horenmar/following{/other_user}","gists_url":"https://api.github.com/users/horenmar/gists{/gist_id}","starred_url":"https://api.github.com/users/horenmar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/horenmar/subscriptions","organizations_url":"https://api.github.com/users/horenmar/orgs","repos_url":"https://api.github.com/users/horenmar/repos","events_url":"https://api.github.com/users/horenmar/events{/privacy}","received_events_url":"https://api.github.com/users/horenmar/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":513089685,"node_id":"MDU6TGFiZWw1MTMwODk2ODU=","url":"https://api.github.com/repos/catchorg/Catch2/labels/Bug","name":"Bug","color":"e99695","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2025-10-07T14:34:49Z","updated_at":"2025-10-16T07:22:31Z","closed_at":"2025-10-16T07:22:31Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## When things work as expected\n\n### The test in question\n```cpp\nTEST_CASE( \"TRY FILTERS\" ) {\n    SECTION( \"A\" ) {\n        SECTION( \"B\" ) {\n            SECTION( \"C1\" ) {\n                SECTION( \"D\" ) { REQUIRE( true ); }\n            }\n            SECTION( \"C2\" ) {\n                SECTION( \"D\" ) { REQUIRE( true ); }\n            }\n        }\n    }\n}\n```\n\n### Usage examples\n\n**Section path prefix filter**\n```\n./tests/SelfTest \"TRY FILTERS\" -c \"A\" -c \"B\"\nFilters: \"TRY FILTERS\"\nRandomness seeded to: 2698325630\n===============================================================================\nAll tests passed (2 assertions in 1 test case)\n```\nThis works as expected, that is, we run both assertions, because the section\npath prefix we specified contains both of them.\n\n\n**Disambiguated section path prefix filter**\n```\n./tests/SelfTest \"TRY FILTERS\" -c \"A\" -c \"B\" -c \"C1\"\nFilters: \"TRY FILTERS\"\nRandomness seeded to: 4049078214\n===============================================================================\nAll tests passed (1 assertion in 1 test case)\n```\nWe disambiguated the two \"C\" sections, and only run 1 assertion.\n\n\n**Bad section name in section filter**\n```\n$ ./tests/SelfTest \"TRY FILTERS\" -c \"A\" -c \"ZZZZZZZZ\" -c \"C1\"\nFilters: \"TRY FILTERS\"\nRandomness seeded to: 4083994241\n===============================================================================\ntest cases: 1 | 1 passed\nassertions: - none -\n```\nNo assertions run, because the \"ZZZZZZZZ\" filter doesn't pass through\nthe \"B\" section.\n\n\n**Missing part of the section filter**\n```\n$ ./tests/SelfTest \"TRY FILTERS\" -c \"A\" -c \"C1\"\nFilters: \"TRY FILTERS\"\nRandomness seeded to: 134702392\n===============================================================================\ntest cases: 1 | 1 passed\nassertions: - none -\n```\nNo assertions run, because there is no \"B\" in our filter.\n\n\nSo far, so good. So what are the broken parts?\n\n\n## When things get broken\n\nWe are still using the same example test case:\n```cpp\nTEST_CASE( \"TRY FILTERS\" ) {\n    SECTION( \"A\" ) {\n        SECTION( \"B\" ) {\n            SECTION( \"C1\" ) {\n                SECTION( \"D\" ) { REQUIRE( true ); }\n            }\n            SECTION( \"C2\" ) {\n                SECTION( \"D\" ) { REQUIRE( true ); }\n            }\n        }\n    }\n}\n```\n\n**Overly long section filter**\n```\n$ ./tests/SelfTest \"TRY FILTERS\" -c \"A\" -c \"B\" -c \"C1\" -c \"C2\" -c \"D\"\nFilters: \"TRY FILTERS\"\nRandomness seeded to: 3171617314\n===============================================================================\nAll tests passed (2 assertions in 1 test case)\n```\nWe ended up running 2 assertions, because both of the \"C\" sections are\nentered, even though they do not form a linear path.\n\nNote that for extra confusion, omitting the `-c \"D\"` at the end runs no\nassertions, contrary to the prefix-path behaviour from the previous section:\n```\n$ ./tests/SelfTest \"TRY FILTERS\" -c \"A\" -c \"B\" -c \"C1\" -c \"C2\"\nFilters: \"TRY FILTERS\"\nRandomness seeded to: 2012568784\n===============================================================================\ntest cases: 1 | 1 passed\nassertions: - none -\n```\n\n\n**Random noise in the section filter**\n```\n$ ./tests/SelfTest \"TRY FILTERS\" -c \"A\" -c \"B\" -c \"C1\"  -c \"LOL\" -c \"LMAO\" -c \"ROFL\" -c \"D\"\nFilters: \"TRY FILTERS\"\nRandomness seeded to: 2513554073\n===============================================================================\nAll tests passed (1 assertion in 1 test case)\n```\nThe \"LOL\", \"LMAO\", and \"ROFL\" filters are 'ignored' and the assertion\ninside the \"C1\" section is run. Note that as before, the `-c \"D\"` filter\nat the end is required for the assertion to be run.\n\n\n**Section filter in wrong order**\n```\n$ ./tests/SelfTest \"TRY FILTERS\" -c \"LOL\" -c \"LMAO\" -c \"ROFL\" -c \"D\" -c \"C1\" -c \"B\" -c \"A\"\nFilters: \"TRY FILTERS\"\nRandomness seeded to: 3370816543\n===============================================================================\nAll tests passed (1 assertion in 1 test case)\n```\nYes, that also runs the assertion inside the \"C1\" section. Note that\nlaughing less stops the assertion from running, at least for this order\nof the \"real\" filters.\n\n\n## Why is it broken\n\nCurrent filtering implementation is **weird**, and the result is that\nthe section filtering is partially order dependent, and also partially\nisn't. The filters specified by user via `-c` are strictly ordered,\nand every time Catch2 enters a section, it removes the first one and then\npasses the rest down for further filtering.\n\nHowever, the filtering check on whether a section should be entered is\ndone via `std::find` over all remaining filters. So e.g. in the last example,\nwhen we try to enter the \"A\" section, we check whether there is **a** \"A\"\nfilter, and then we pop \"LOL\" filter from the filter stack. Then, when\nentering \"B\" section, we check whether there is \"B\" filter _somewhere_\nin the stack, and then pop \"LMAO\" filter... Thus by laughing enough, we\nkeep the \"D\" filter in stack long enough to enter the section and execute\nthe assertion.\n\n\n## How do we fix it\n\nInstead of checking all remaining filters for the name of the section that\nwe are trying to enter, check just the first filter. This will remove\nall of the surprising behaviour above, at the cost of disallowing the user\nto pick sections \"A1\" and \"A2\", but not \"A3\" in the example below.\n\n```cpp\nTEST_CASE() {\n    SECTION( \"A1\" ) {}\n    SECTION( \"A2\" ) {}\n    SECTION( \"A3\" ) {}\n}\n```\n\nWith the current implementation, they could do this by abusing the check\nlogic with `-c \"A1\" -c \"A2\"` section filter spec. If we want to support\nthis behaviour in the future, we should extend the section filter specs\nto support similar set of operators as test filters do.\n","closed_by":{"login":"horenmar","id":9026413,"node_id":"MDQ6VXNlcjkwMjY0MTM=","avatar_url":"https://avatars.githubusercontent.com/u/9026413?v=4","gravatar_id":"","url":"https://api.github.com/users/horenmar","html_url":"https://github.com/horenmar","followers_url":"https://api.github.com/users/horenmar/followers","following_url":"https://api.github.com/users/horenmar/following{/other_user}","gists_url":"https://api.github.com/users/horenmar/gists{/gist_id}","starred_url":"https://api.github.com/users/horenmar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/horenmar/subscriptions","organizations_url":"https://api.github.com/users/horenmar/orgs","repos_url":"https://api.github.com/users/horenmar/repos","events_url":"https://api.github.com/users/horenmar/events{/privacy}","received_events_url":"https://api.github.com/users/horenmar/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/catchorg/Catch2/issues/3038/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/catchorg/Catch2/issues/3038/timeline","performed_via_github_app":null,"state_reason":"completed"}