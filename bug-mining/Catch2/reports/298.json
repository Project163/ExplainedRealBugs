{"url":"https://api.github.com/repos/catchorg/Catch2/issues/2674","repository_url":"https://api.github.com/repos/catchorg/Catch2","labels_url":"https://api.github.com/repos/catchorg/Catch2/issues/2674/labels{/name}","comments_url":"https://api.github.com/repos/catchorg/Catch2/issues/2674/comments","events_url":"https://api.github.com/repos/catchorg/Catch2/issues/2674/events","html_url":"https://github.com/catchorg/Catch2/issues/2674","id":1674008077,"node_id":"I_kwDOABA2rM5jx1YN","number":2674,"title":"CMake Integration does not support test names containing semicolons and backslashes","user":{"login":"robinchrist","id":22774099,"node_id":"MDQ6VXNlcjIyNzc0MDk5","avatar_url":"https://avatars.githubusercontent.com/u/22774099?v=4","gravatar_id":"","url":"https://api.github.com/users/robinchrist","html_url":"https://github.com/robinchrist","followers_url":"https://api.github.com/users/robinchrist/followers","following_url":"https://api.github.com/users/robinchrist/following{/other_user}","gists_url":"https://api.github.com/users/robinchrist/gists{/gist_id}","starred_url":"https://api.github.com/users/robinchrist/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/robinchrist/subscriptions","organizations_url":"https://api.github.com/users/robinchrist/orgs","repos_url":"https://api.github.com/users/robinchrist/repos","events_url":"https://api.github.com/users/robinchrist/events{/privacy}","received_events_url":"https://api.github.com/users/robinchrist/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":755139583,"node_id":"MDU6TGFiZWw3NTUxMzk1ODM=","url":"https://api.github.com/repos/catchorg/Catch2/labels/Extras","name":"Extras","color":"f9efae","default":false,"description":"Touches utility scripts outside of Catch2 proper, e.g. CMake integration."}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2023-04-19T00:51:06Z","updated_at":"2023-06-14T21:40:13Z","closed_at":"2023-06-14T21:40:13Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Describe the bug**\r\nOne of our working students has created several test cases for the parser of a custom DSL which often contains `;` (semicolon) and Windows-style file paths in expressions and has named them after the expression that is being tested if short enough, e.g.\r\n```\r\nTEST_CASE(\"@Script[C:\\\\EPM1A]=x;\\\"SCALA_ZERO:\\\"\", \"[script regressions]\")\r\n```\r\n\r\nThis leads to the creation of a lot of wrong test cases, potentially leading to false positives:\r\n```\r\nThe following tests FAILED:\r\n         13 - @Script[C:\\EPM1A]=x (Failed)\r\n         14 - \"SCALA_ZERO:\" (Failed)\r\n```\r\n\r\nThis can also be seen in the corresponding `tests-<hash>-cmake`:\r\n```\r\nadd_test( [==[@Script[C:\\EPM1A]=x]==] /censored/path [==[@Script\\[C:\\EPM1A\\]=x]==]  )\r\nset_tests_properties( [==[@Script[C:\\EPM1A]=x]==] PROPERTIES WORKING_DIRECTORY /censored/path)\r\nadd_test( [==[\"SCALA_ZERO:\"]==] /censored/path [==[\"SCALA_ZERO:\"]==]  )\r\nset_tests_properties( [==[\"SCALA_ZERO:\"]==] PROPERTIES WORKING_DIRECTORY /censored/path)\r\n```\r\n\r\nBy adding some debug logging to `CatchAddTests.cmake`, we can see that it's a bug in the `foreach` logic:\r\n\r\nDebug log statements:\r\n```\r\nmessage(\"Line: ${test}\")\r\nmessage(\"Escaped Line: ${test_name}\")\r\n```\r\n\r\n```\r\nLine: @Script[C:\\EPM1A]=x\r\nEscaped Line: @Script\\[C:\\EPM1A\\]=x\r\nLine: \"SCALA_ZERO:\"\r\nEscaped Line: \"SCALA_ZERO:\"\r\n```\r\n\r\nI believe this is due to https://github.com/catchorg/Catch2/blob/9a2a4eadc0e50e0534278010624eac15991413a7/extras/CatchAddTests.cmake#L67\r\n```\r\nstring(REPLACE \"\\n\" \";\" output \"${output}\")\r\n```\r\nObviously, if the test case name already contains `;`, the test case will be split and it won't work.\r\n\r\n```\r\nstring(REPLACE \";\" \"\\;\" output \"${output}\")\r\nstring(REPLACE \"\\n\" \";\" output \"${output}\")\r\n```\r\n\r\nseems to fix this.\r\n\r\nOne thing we can also see in the resulting output file (one we have applied the fix above):\r\n```\r\nadd_test( [==[@Script[C:\\EPM1A]=x;\"SCALA_ZERO:\"]==] /censored/path [==[@Script\\[C:\\EPM1A\\]=x;\"SCALA_ZERO:\"]==]  )\r\n```\r\nIf we take the part `@Script\\[C:\\EPM1A\\]=x;\"SCALA_ZERO:\"` and do\r\n`test-binary '@Script\\[C:\\EPM1A\\]=x;\"SCALA_ZERO:\"'` we will get:\r\n```\r\nNo tests ran\r\n```\r\n\r\nUh oh!\r\n\r\nWell, there's another issue: `\\` in test names are not properly escaped.\r\nWe need to change `foreach(char , [ ])` to `foreach(char \\\\ , [ ])`\r\n**Note that the order is important: The replacement of `\\` needs to happen first!**\r\n\r\nAdditionally, the strings must be handles correctly (i.e. set in quotes everywhere to preserve the `;`, otherwise CMake will do funny list stuff...)\r\n\r\nSo in total this looks like:\r\n```\r\nstring(REPLACE \";\" \"\\;\" output \"${output}\")\r\nstring(REPLACE \"\\n\" \";\" output \"${output}\")\r\n\r\n...\r\n\r\n# Parse output\r\nforeach(line ${output})\r\n  set(test \"${line}\")\r\n  # Escape characters in test case names that would be parsed by Catch2\r\n  set(test_name \"${test}\")\r\n  foreach(char \\\\ , [ ])\r\n    string(REPLACE ${char} \"\\\\${char}\" test_name \"${test_name}\")\r\n  endforeach(char)\r\n  # ...add output dir\r\n  if(output_dir)\r\n    string(REGEX REPLACE \"[^A-Za-z0-9_]\" \"_\" test_name_clean \"${test_name}\")\r\n    set(output_dir_arg \"--out ${output_dir}/${output_prefix}${test_name_clean}${output_suffix}\")\r\n  endif()\r\n  ```\r\n\r\n\r\n\r\n**Expected behavior**\r\nOnly a single test should be created \r\n\r\n**Reproduction steps**\r\nCreate a test case containing a semicolon in its name and use the CMake integration, e.g.\r\n```\r\nTEST_CASE(\"@Script[C:\\\\EPM1A]=x;\\\"SCALA_ZERO:\\\"\", \"[script regressions]\")\r\n```\r\n\r\n\r\n**Platform information:**\r\nCMake 3.22.2\r\nCatch2 v3.3.2\r\n\r\n\r\n**Additional context**\r\nSorry, I added the backslashes part later, so this is all a bit incoherent... \r\n\r\nI should probably create a pull request with the fixed code?\r\n","closed_by":{"login":"horenmar","id":9026413,"node_id":"MDQ6VXNlcjkwMjY0MTM=","avatar_url":"https://avatars.githubusercontent.com/u/9026413?v=4","gravatar_id":"","url":"https://api.github.com/users/horenmar","html_url":"https://github.com/horenmar","followers_url":"https://api.github.com/users/horenmar/followers","following_url":"https://api.github.com/users/horenmar/following{/other_user}","gists_url":"https://api.github.com/users/horenmar/gists{/gist_id}","starred_url":"https://api.github.com/users/horenmar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/horenmar/subscriptions","organizations_url":"https://api.github.com/users/horenmar/orgs","repos_url":"https://api.github.com/users/horenmar/repos","events_url":"https://api.github.com/users/horenmar/events{/privacy}","received_events_url":"https://api.github.com/users/horenmar/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/catchorg/Catch2/issues/2674/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/catchorg/Catch2/issues/2674/timeline","performed_via_github_app":null,"state_reason":"completed"}