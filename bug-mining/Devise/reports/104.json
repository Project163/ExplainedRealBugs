{"url":"https://api.github.com/repos/heartcombo/devise/issues/2060","repository_url":"https://api.github.com/repos/heartcombo/devise","labels_url":"https://api.github.com/repos/heartcombo/devise/issues/2060/labels{/name}","comments_url":"https://api.github.com/repos/heartcombo/devise/issues/2060/comments","events_url":"https://api.github.com/repos/heartcombo/devise/issues/2060/events","html_url":"https://github.com/heartcombo/devise/issues/2060","id":6834539,"node_id":"MDU6SXNzdWU2ODM0NTM5","number":2060,"title":"Unexpected reconfirmable behaviors especially trying to re-send confirmation email","user":{"login":"mcbsys","id":865498,"node_id":"MDQ6VXNlcjg2NTQ5OA==","avatar_url":"https://avatars.githubusercontent.com/u/865498?v=4","gravatar_id":"","url":"https://api.github.com/users/mcbsys","html_url":"https://github.com/mcbsys","followers_url":"https://api.github.com/users/mcbsys/followers","following_url":"https://api.github.com/users/mcbsys/following{/other_user}","gists_url":"https://api.github.com/users/mcbsys/gists{/gist_id}","starred_url":"https://api.github.com/users/mcbsys/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mcbsys/subscriptions","organizations_url":"https://api.github.com/users/mcbsys/orgs","repos_url":"https://api.github.com/users/mcbsys/repos","events_url":"https://api.github.com/users/mcbsys/events{/privacy}","received_events_url":"https://api.github.com/users/mcbsys/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":29712,"node_id":"MDU6TGFiZWwyOTcxMg==","url":"https://api.github.com/repos/heartcombo/devise/labels/Feature","name":"Feature","color":"ff4c4c","default":false,"description":null},{"id":40645,"node_id":"MDU6TGFiZWw0MDY0NQ==","url":"https://api.github.com/repos/heartcombo/devise/labels/Bug","name":"Bug","color":"ededed","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2012-09-12T23:04:44Z","updated_at":"2015-02-07T15:21:53Z","closed_at":"2012-12-13T08:13:54Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"I'm testing the reconfirmable feature with Rails 3.2.8 with Devise 2.1.2, upgraded from 1.5.3. I've come across a few unexpected behaviors:\n1. When the user changes his email, the confirmation email is sent to the `unconfirmed_email`, but the email body greets the user with the old `email`: `Welcome <%= @resource.email %>!`. I can fix that in views/devise/mailer/confirmation_instructions (see below).\n2. If the user doesn't get the instructions, he may try the \"Resend confirmation instructions\" link with his new email address. He will get the message, \"[new email] not found\". The WHERE clause here should be something like `WHERE \"users\".\"email\" = [form_email] OR \"users\".\"unconfirmed_email\" = [form_email]`. Assuming that will work that way someday, I guess that means I should index `unconfirmed_email` in my migration.\n3. On the Resend confirmation page, maybe the user will think to enter his old email address to get it to send confirmation instructions to his new email address. He will get the message, \"[old email] was already confirmed. Please try signing in.\" Maybe `confirmed_at` should be set to nil when a (re-)confirmation is pending?\n4. So the user finally tries signing in using his old email address. This works. In my app, he can now go to the Edit User screen, where he will see his old email address. \"What? I thought I changed that!\" But if he changes it again, he will get another confirmation email.\n5. Some of this wouldn't be so confusing if the user was informed of the flow. Is there a built-in message I should be displaying? If not, I will to add some code to the Users controller so that when the user changes his email, the flash message tells him, \"A confirmation email has been sent to [new email]. Until you confirm the new email, you can continue to log in as [old email].\" And maybe I'll #show the user `unconfirmed_email` as \"New email (pending confirmation)\".\n\nHere is my updated confirmation_instructions.html.erb:\n\n```\n<% if @resource.unconfirmed_email %>\n  <p>Welcome <%= @resource.unconfirmed_email %>!</p>\n  <p>Please confirm your new email address by clicking on the link below:</p>\n<% else %>\n  <p>Welcome <%= @resource.email %>!</p>\n  <p>Please confirm your account by clicking on the link below:</p>\n<% end %>\n\n<p><%= link_to 'Confirm my account', confirmation_url(@resource, :confirmation_token => @resource.confirmation_token) %></p>\n```\n","closed_by":{"login":"josevalim","id":9582,"node_id":"MDQ6VXNlcjk1ODI=","avatar_url":"https://avatars.githubusercontent.com/u/9582?v=4","gravatar_id":"","url":"https://api.github.com/users/josevalim","html_url":"https://github.com/josevalim","followers_url":"https://api.github.com/users/josevalim/followers","following_url":"https://api.github.com/users/josevalim/following{/other_user}","gists_url":"https://api.github.com/users/josevalim/gists{/gist_id}","starred_url":"https://api.github.com/users/josevalim/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/josevalim/subscriptions","organizations_url":"https://api.github.com/users/josevalim/orgs","repos_url":"https://api.github.com/users/josevalim/repos","events_url":"https://api.github.com/users/josevalim/events{/privacy}","received_events_url":"https://api.github.com/users/josevalim/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/heartcombo/devise/issues/2060/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/heartcombo/devise/issues/2060/timeline","performed_via_github_app":null,"state_reason":"completed"}