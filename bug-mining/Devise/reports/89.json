{"url":"https://api.github.com/repos/heartcombo/devise/issues/1708","repository_url":"https://api.github.com/repos/heartcombo/devise","labels_url":"https://api.github.com/repos/heartcombo/devise/issues/1708/labels{/name}","comments_url":"https://api.github.com/repos/heartcombo/devise/issues/1708/comments","events_url":"https://api.github.com/repos/heartcombo/devise/issues/1708/events","html_url":"https://github.com/heartcombo/devise/issues/1708","id":3583913,"node_id":"MDU6SXNzdWUzNTgzOTEz","number":1708,"title":"send_confirmation_instructions called on UserObserver update when reconfirmation_required? == false","user":{"login":"aprescott","id":342081,"node_id":"MDQ6VXNlcjM0MjA4MQ==","avatar_url":"https://avatars.githubusercontent.com/u/342081?v=4","gravatar_id":"","url":"https://api.github.com/users/aprescott","html_url":"https://github.com/aprescott","followers_url":"https://api.github.com/users/aprescott/followers","following_url":"https://api.github.com/users/aprescott/following{/other_user}","gists_url":"https://api.github.com/users/aprescott/gists{/gist_id}","starred_url":"https://api.github.com/users/aprescott/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/aprescott/subscriptions","organizations_url":"https://api.github.com/users/aprescott/orgs","repos_url":"https://api.github.com/users/aprescott/repos","events_url":"https://api.github.com/users/aprescott/events{/privacy}","received_events_url":"https://api.github.com/users/aprescott/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2012-03-09T14:47:51Z","updated_at":"2012-04-22T19:35:33Z","closed_at":"2012-03-09T17:12:49Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"I've seen this on Rails 3.2.1 with both Devise 2.0.0 and 2.0.4. The result of this in my specific case is that a second confirmation email is being sent. I believe it's a bug, having searched on Google with no luck other than finding two mailing list posts[1] with a similar issue of confirmation emails being sent twice.\n\nI have a `User` model which is using confirmable. There is a `UserObserver` which has an `after_create` method which calls `user.update_attribute(:foo, \"bar\")`. Before the `update_attribute` method is called, the value of `user.send(:reconfirmation_required?)` is `false` (`send` is used because it's a protected method).\n\nOn creating a new user, the first confirmation email goes out, then a second one with \"Welcome !\" (showing the `@resource` instance var isn't being set properly) and a different confirmation token value. When the `user.update_attribute(:foo, \"bar\")` called in `UserObserver` is commented out, the second confirmation isn't sent and everything's fine.\n\nLooking at [confirmable.rb](https://github.com/plataformatec/devise/blob/a909bfaf85a07e94da8f15fdeb22101606dea57c/lib/devise/models/confirmable.rb), I can see that there is a callback defined:\n\n``` ruby\nafter_update :send_confirmation_instructions, :if => :reconfirmation_required?\n```\n\nDespite the condition of `reconfirmation_required?` being false (as shown by the `send(:reconfirmation_required?) == false`), when creating a new user, a confirmation email is sent out with the confirmation token of `foo` and immediately after that, a second confirmation email is sent out with a confirmation token different from `foo` and with an opening line of \"Welcome !\" in the body.\n\nI've checked that `send_confirmation_instructions` is the thing actually being called by simply defining\n\n``` ruby\ndef user.send_confirmation_instructions\n  raise :foo\nend\n```\n\nwhich raises. Since `send_confirmation_instructions` had `send_on_create_confirmation_instructions` split off from it, the `after_update` callback is the only thing I can find which is calling `send_confirmation_instructions`.\n\nHaving explained all that, if, before confirming the new user by clicking the link, you fire up the Rails console and retrieve it with `User.last`, then call `update_attribute(:foo, \"bar\")` on it, no additional confirmation email is sent out. But in the `UserObserver` the second email _does_ get sent out. In `UserObserver`, `send(:reconfirmation_required?)` is `false`, and in the console it's `nil`.\n\n[1]: http://groups.google.com/group/plataformatec-devise/browse_thread/thread/4ccb926ea3b25f5b and http://groups.google.com/group/plataformatec-devise/browse_thread/thread/3e062cf1d30755d8\n","closed_by":{"login":"josevalim","id":9582,"node_id":"MDQ6VXNlcjk1ODI=","avatar_url":"https://avatars.githubusercontent.com/u/9582?v=4","gravatar_id":"","url":"https://api.github.com/users/josevalim","html_url":"https://github.com/josevalim","followers_url":"https://api.github.com/users/josevalim/followers","following_url":"https://api.github.com/users/josevalim/following{/other_user}","gists_url":"https://api.github.com/users/josevalim/gists{/gist_id}","starred_url":"https://api.github.com/users/josevalim/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/josevalim/subscriptions","organizations_url":"https://api.github.com/users/josevalim/orgs","repos_url":"https://api.github.com/users/josevalim/repos","events_url":"https://api.github.com/users/josevalim/events{/privacy}","received_events_url":"https://api.github.com/users/josevalim/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/heartcombo/devise/issues/1708/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/heartcombo/devise/issues/1708/timeline","performed_via_github_app":null,"state_reason":"completed"}