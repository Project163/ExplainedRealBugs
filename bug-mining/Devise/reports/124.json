{"url":"https://api.github.com/repos/heartcombo/devise/issues/2936","repository_url":"https://api.github.com/repos/heartcombo/devise","labels_url":"https://api.github.com/repos/heartcombo/devise/issues/2936/labels{/name}","comments_url":"https://api.github.com/repos/heartcombo/devise/issues/2936/comments","events_url":"https://api.github.com/repos/heartcombo/devise/issues/2936/events","html_url":"https://github.com/heartcombo/devise/issues/2936","id":29846216,"node_id":"MDU6SXNzdWUyOTg0NjIxNg==","number":2936,"title":"Devise::RegistrationsController#create and #update only yield to block on success","user":{"login":"dpehrson","id":263184,"node_id":"MDQ6VXNlcjI2MzE4NA==","avatar_url":"https://avatars.githubusercontent.com/u/263184?v=4","gravatar_id":"","url":"https://api.github.com/users/dpehrson","html_url":"https://github.com/dpehrson","followers_url":"https://api.github.com/users/dpehrson/followers","following_url":"https://api.github.com/users/dpehrson/following{/other_user}","gists_url":"https://api.github.com/users/dpehrson/gists{/gist_id}","starred_url":"https://api.github.com/users/dpehrson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dpehrson/subscriptions","organizations_url":"https://api.github.com/users/dpehrson/orgs","repos_url":"https://api.github.com/users/dpehrson/repos","events_url":"https://api.github.com/users/dpehrson/events{/privacy}","received_events_url":"https://api.github.com/users/dpehrson/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":16,"created_at":"2014-03-20T18:44:16Z","updated_at":"2019-09-23T12:43:16Z","closed_at":"2014-03-24T09:58:17Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Howdy all,\n\nWhile making use of the excellent functionality introduced by #2728 I found what I think to be a bug/incomplete functionality.\n\nin [`Devise::RegistrationsController#create` at line 16](https://github.com/plataformatec/devise/blob/master/app/controllers/devise/registrations_controller.rb#L16) and [`Devise::RegistrationsController#update` at line 45](https://github.com/plataformatec/devise/blob/master/app/controllers/devise/registrations_controller.rb#L45) the resource is only yielded to the provided block upon successful creation/update and not on failures.\n\nIn my specific use-case I need to capture failures in order to register events with my analytics engines. This is currently impossible without completely replacing the method as far as I can tell which is what #2728 was trying to fix.\n\nI think fixing it may be as simple as doing something like this:\n\n``` ruby\ndef create\n  build_resource(sign_up_params)\n\n  saved = resource.save # Save and store result\n  yield resource if block_given? # Yield always, block can check resource.persisted? to detect success or failure\n  if saved\n    if resource.active_for_authentication?\n      set_flash_message :notice, :signed_up if is_flashing_format?\n      sign_up(resource_name, resource)\n      respond_with resource, location: after_sign_up_path_for(resource)\n    else\n      set_flash_message :notice, :\"signed_up_but_#{resource.inactive_message}\" if is_flashing_format?\n      expire_data_after_sign_in!\n      respond_with resource, location: after_inactive_sign_up_path_for(resource)\n    end\n  else\n    clean_up_passwords resource\n    respond_with resource\n  end\nend\n```\n\nDoes this seem reasonable? If so I will start working on a pull request.\n","closed_by":{"login":"josevalim","id":9582,"node_id":"MDQ6VXNlcjk1ODI=","avatar_url":"https://avatars.githubusercontent.com/u/9582?v=4","gravatar_id":"","url":"https://api.github.com/users/josevalim","html_url":"https://github.com/josevalim","followers_url":"https://api.github.com/users/josevalim/followers","following_url":"https://api.github.com/users/josevalim/following{/other_user}","gists_url":"https://api.github.com/users/josevalim/gists{/gist_id}","starred_url":"https://api.github.com/users/josevalim/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/josevalim/subscriptions","organizations_url":"https://api.github.com/users/josevalim/orgs","repos_url":"https://api.github.com/users/josevalim/repos","events_url":"https://api.github.com/users/josevalim/events{/privacy}","received_events_url":"https://api.github.com/users/josevalim/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/heartcombo/devise/issues/2936/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/heartcombo/devise/issues/2936/timeline","performed_via_github_app":null,"state_reason":"completed"}