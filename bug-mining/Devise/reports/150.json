{"url":"https://api.github.com/repos/heartcombo/devise/issues/4783","repository_url":"https://api.github.com/repos/heartcombo/devise","labels_url":"https://api.github.com/repos/heartcombo/devise/issues/4783/labels{/name}","comments_url":"https://api.github.com/repos/heartcombo/devise/issues/4783/comments","events_url":"https://api.github.com/repos/heartcombo/devise/issues/4783/events","html_url":"https://github.com/heartcombo/devise/issues/4783","id":300320232,"node_id":"MDU6SXNzdWUzMDAzMjAyMzI=","number":4783,"title":"In Rails4, unauthenticated controller tests lost their content_type","user":{"login":"gmcnaughton","id":78888,"node_id":"MDQ6VXNlcjc4ODg4","avatar_url":"https://avatars.githubusercontent.com/u/78888?v=4","gravatar_id":"","url":"https://api.github.com/users/gmcnaughton","html_url":"https://github.com/gmcnaughton","followers_url":"https://api.github.com/users/gmcnaughton/followers","following_url":"https://api.github.com/users/gmcnaughton/following{/other_user}","gists_url":"https://api.github.com/users/gmcnaughton/gists{/gist_id}","starred_url":"https://api.github.com/users/gmcnaughton/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gmcnaughton/subscriptions","organizations_url":"https://api.github.com/users/gmcnaughton/orgs","repos_url":"https://api.github.com/users/gmcnaughton/repos","events_url":"https://api.github.com/users/gmcnaughton/events{/privacy}","received_events_url":"https://api.github.com/users/gmcnaughton/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2018-02-26T17:07:30Z","updated_at":"2018-02-26T18:04:04Z","closed_at":"2018-02-26T18:04:04Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## Environment\r\n\r\n- Ruby 2.4.1\r\n- Rails 4.2.8\r\n- Devise 4.4.1\r\n\r\n## Current behavior\r\n\r\nIn Rails 4, controller tests which trigger the failure app lose their content_type (`response.content_type` is nil).\r\n\r\n````\r\ntest \"returns the content type of a failure app\" do\r\n  get :index, params: { format: :xml }\r\n  assert response.content_type.include?('application/xml') # <= content_type is nil!\r\nend\r\n````\r\n\r\nThis started with bb44d42 (Devise 4.2), which changed how `Devise::Test::ControllerHelpers` simulates failure responses.\r\n\r\nPreviously ControllerHelpers called `render` with a content-type. Now, values are set on `@controller.response` manually but content_type is skipped.\r\n\r\nThis doesn't impact Rails5, as [`ActionDispatch::Response#content_type`](https://github.com/rails/rails/blob/master/actionpack/lib/action_dispatch/http/response.rb#L246) parses the content-type header on demand. But in Rails4, without a call to [#content_type=](https://github.com/rails/rails/blob/4-2-stable/actionpack/lib/action_dispatch/http/response.rb#L62) it will remain nil.\r\n\r\n## Expected behavior\r\n\r\nController tests which trigger the failure app should be able to inspect `response.content_type`. It should match the content type of the original request.","closed_by":{"login":"rafaelfranca","id":47848,"node_id":"MDQ6VXNlcjQ3ODQ4","avatar_url":"https://avatars.githubusercontent.com/u/47848?v=4","gravatar_id":"","url":"https://api.github.com/users/rafaelfranca","html_url":"https://github.com/rafaelfranca","followers_url":"https://api.github.com/users/rafaelfranca/followers","following_url":"https://api.github.com/users/rafaelfranca/following{/other_user}","gists_url":"https://api.github.com/users/rafaelfranca/gists{/gist_id}","starred_url":"https://api.github.com/users/rafaelfranca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rafaelfranca/subscriptions","organizations_url":"https://api.github.com/users/rafaelfranca/orgs","repos_url":"https://api.github.com/users/rafaelfranca/repos","events_url":"https://api.github.com/users/rafaelfranca/events{/privacy}","received_events_url":"https://api.github.com/users/rafaelfranca/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/heartcombo/devise/issues/4783/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/heartcombo/devise/issues/4783/timeline","performed_via_github_app":null,"state_reason":"completed"}