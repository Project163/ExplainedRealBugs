{"url":"https://api.github.com/repos/heartcombo/devise/issues/3431","repository_url":"https://api.github.com/repos/heartcombo/devise","labels_url":"https://api.github.com/repos/heartcombo/devise/issues/3431/labels{/name}","comments_url":"https://api.github.com/repos/heartcombo/devise/issues/3431/comments","events_url":"https://api.github.com/repos/heartcombo/devise/issues/3431/events","html_url":"https://github.com/heartcombo/devise/issues/3431","id":54727428,"node_id":"MDU6SXNzdWU1NDcyNzQyOA==","number":3431,"title":"Devise shows misleading \"reset password token is invalid\" error when including authentication key in strip_whitespace_keys","user":{"login":"rockorequin","id":794677,"node_id":"MDQ6VXNlcjc5NDY3Nw==","avatar_url":"https://avatars.githubusercontent.com/u/794677?v=4","gravatar_id":"","url":"https://api.github.com/users/rockorequin","html_url":"https://github.com/rockorequin","followers_url":"https://api.github.com/users/rockorequin/followers","following_url":"https://api.github.com/users/rockorequin/following{/other_user}","gists_url":"https://api.github.com/users/rockorequin/gists{/gist_id}","starred_url":"https://api.github.com/users/rockorequin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rockorequin/subscriptions","organizations_url":"https://api.github.com/users/rockorequin/orgs","repos_url":"https://api.github.com/users/rockorequin/repos","events_url":"https://api.github.com/users/rockorequin/events{/privacy}","received_events_url":"https://api.github.com/users/rockorequin/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":40645,"node_id":"MDU6TGFiZWw0MDY0NQ==","url":"https://api.github.com/repos/heartcombo/devise/labels/Bug","name":"Bug","color":"ededed","default":false,"description":null},{"id":133106,"node_id":"MDU6TGFiZWwxMzMxMDY=","url":"https://api.github.com/repos/heartcombo/devise/labels/Needs%20more%20work","name":"Needs more work","color":"d7e102","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":15,"created_at":"2015-01-19T05:24:51Z","updated_at":"2017-03-06T22:51:19Z","closed_at":"2017-01-27T01:21:39Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"With devise 3.4.1 (and also the latest from git as of 2015-01-19) and Rails 4.1.8, if I try to reset my password I get a misleading error message \"reset password token is invalid\" if I have this in the config/initializers/devise.rb file:\n\n<code>\nconfig.authentication_keys = [ :user_name ]\n</code>\n<code>\nconfig.strip_whitespace_keys = [ :user_name ]\n</code>\n\nI have stepped through the code and found that the encrypted token that Devise creates from the posted token matches the reset_password_token in the user record exactly, so \"reset password token is invalid\" is not actually the issue.\n\nInstead, what happens is that lib/devise/models/recoverable.rb#reset_password_by_token has this line:\n\n<code>\nrecoverable = find_or_initialize_with_error_by(:reset_password_token, reset_password_token)\n</code>\n\nand this method eventually calls lib/devise/parameter_filter.rb#filter to construct a conditions hash to find the user record using the reset_password_token that was calculated. However, this line in the filter method:\n\n<code>\nconditions.merge!(filtered_hash_by_method_for_given_keys(conditions.dup, :strip, @strip_whitespace_keys))\n</code>\n\nadds { user_name: nil } to the conditions hash, and as a result the find first method returns no user record (obviously since no records have a null authentication field in the database). Since the user record is null, reset_password_by_token then creates a new user record, which has the \"reset password token is invalid\" error in it.\n\nThe workaround is to remove the authentication key :user_name from the strip_whitespace_keys, and the error no longer occurs.\n\nIt might also be relevant that I have configured Devise to use the Person model (via \"devise_for :people...\" in config/routes.rb).\n\nAm I misusing the strip_whitespace_keys configuration? I don't see why devise insists on adding user_name to the conditions hash when it hasn't been passed user_name as an attribute to match.\n","closed_by":{"login":"georgeguimaraes","id":2929,"node_id":"MDQ6VXNlcjI5Mjk=","avatar_url":"https://avatars.githubusercontent.com/u/2929?v=4","gravatar_id":"","url":"https://api.github.com/users/georgeguimaraes","html_url":"https://github.com/georgeguimaraes","followers_url":"https://api.github.com/users/georgeguimaraes/followers","following_url":"https://api.github.com/users/georgeguimaraes/following{/other_user}","gists_url":"https://api.github.com/users/georgeguimaraes/gists{/gist_id}","starred_url":"https://api.github.com/users/georgeguimaraes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/georgeguimaraes/subscriptions","organizations_url":"https://api.github.com/users/georgeguimaraes/orgs","repos_url":"https://api.github.com/users/georgeguimaraes/repos","events_url":"https://api.github.com/users/georgeguimaraes/events{/privacy}","received_events_url":"https://api.github.com/users/georgeguimaraes/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/heartcombo/devise/issues/3431/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/heartcombo/devise/issues/3431/timeline","performed_via_github_app":null,"state_reason":"completed"}