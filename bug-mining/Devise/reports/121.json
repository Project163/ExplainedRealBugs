{"url":"https://api.github.com/repos/heartcombo/devise/issues/2742","repository_url":"https://api.github.com/repos/heartcombo/devise","labels_url":"https://api.github.com/repos/heartcombo/devise/issues/2742/labels{/name}","comments_url":"https://api.github.com/repos/heartcombo/devise/issues/2742/comments","events_url":"https://api.github.com/repos/heartcombo/devise/issues/2742/events","html_url":"https://github.com/heartcombo/devise/issues/2742","id":22676747,"node_id":"MDU6SXNzdWUyMjY3Njc0Nw==","number":2742,"title":"Redirect to original path after sign in doesn't forward original GET parameters","user":{"login":"masterkain","id":12844,"node_id":"MDQ6VXNlcjEyODQ0","avatar_url":"https://avatars.githubusercontent.com/u/12844?v=4","gravatar_id":"","url":"https://api.github.com/users/masterkain","html_url":"https://github.com/masterkain","followers_url":"https://api.github.com/users/masterkain/followers","following_url":"https://api.github.com/users/masterkain/following{/other_user}","gists_url":"https://api.github.com/users/masterkain/gists{/gist_id}","starred_url":"https://api.github.com/users/masterkain/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/masterkain/subscriptions","organizations_url":"https://api.github.com/users/masterkain/orgs","repos_url":"https://api.github.com/users/masterkain/repos","events_url":"https://api.github.com/users/masterkain/events{/privacy}","received_events_url":"https://api.github.com/users/masterkain/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2013-11-14T17:07:00Z","updated_at":"2014-06-19T23:58:39Z","closed_at":"2013-11-20T21:13:13Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Our spec suite caught a test failure after upgrading from 3.2.0 to 3.2.1.\n\nI run an integration spec to test the workflow to authenticate through OAuth2 to our service, this is the typical workflow for a non signed in user:\n### First request\n\nThis ends up being redirected to the sign in page because there isn't a valid session yet, but gets called with few GET params that needs to be restored during the redirect after the sign_in:\n\n``` ruby\nStarted GET \"/oauth2/authorize?response_type=code&client_id=b8f6aa2a48c5164e774097efcee039f5&redirect_uri=http%3A%2F%2Fexternal.website%2Ftest%2Foauth2%2Faccount%2Fauth%2Fmyapp%2Fcallback\"\nCompleted 401 Unauthorized in 23ms\n```\n### Second and third requests\n\nBrowser hits the sign in page, the test fills the sign in form and press submit:\n\n``` ruby\nStarted GET \"/account/sign_in\" for 127.0.0.1 at 2013-11-14 17:42:36 +0100\nCompleted 200 OK in 112ms (Views: 106.8ms | ActiveRecord: 0.0ms)\nStarted POST \"/account/sign_in\" for 127.0.0.1 at 2013-11-14 17:42:36 +0100\nProcessing by Devise::SessionsController#create as HTML\nRedirected to https://myapp/oauth2/authorize\nCompleted 302 Found in 32ms (ActiveRecord: 2.0ms)\n```\n### Fourth and failing request\n\nA redirected happened but it lacks the original params, failing my authentication process:\n\n``` ruby\nStarted GET \"/oauth2/authorize\" for 127.0.0.1 at 2013-11-14 17:42:36 +0100\n```\n\nIs it a side effect of the recent code changes to expose a helper method to set the current location to accept only paths https://github.com/plataformatec/devise/commit/0582467032dcf25dd26f460dfef1b1edbaf65608#diff-69e4dec55d542382a2998bef45d66401R35 and later further manipulated to strip extra chars.\n\nSpec passes on `v3.2.0`:\n\n``` ruby\nStarted POST \"/account/sign_in\" for 127.0.0.1 at 2013-11-14 18:05:16 +0100\nProcessing by Devise::SessionsController#create as HTML\nRedirected to https://myapp/oauth2/authorize?response_type=code&client_id= b8f6aa2a48c5164e774097efcee039f5&redirect_uri=http%3A%2F%2Fexternal.website%2Ftest%2Foauth2%2Faccount%2Fauth%2Fmyapp%2Fcallback\n```\n\nI have other cases when the user lands on a sign-in required page and parameters needs to be preserved when hitting the page again after login.\n","closed_by":{"login":"josevalim","id":9582,"node_id":"MDQ6VXNlcjk1ODI=","avatar_url":"https://avatars.githubusercontent.com/u/9582?v=4","gravatar_id":"","url":"https://api.github.com/users/josevalim","html_url":"https://github.com/josevalim","followers_url":"https://api.github.com/users/josevalim/followers","following_url":"https://api.github.com/users/josevalim/following{/other_user}","gists_url":"https://api.github.com/users/josevalim/gists{/gist_id}","starred_url":"https://api.github.com/users/josevalim/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/josevalim/subscriptions","organizations_url":"https://api.github.com/users/josevalim/orgs","repos_url":"https://api.github.com/users/josevalim/repos","events_url":"https://api.github.com/users/josevalim/events{/privacy}","received_events_url":"https://api.github.com/users/josevalim/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/heartcombo/devise/issues/2742/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/heartcombo/devise/issues/2742/timeline","performed_via_github_app":null,"state_reason":"completed"}