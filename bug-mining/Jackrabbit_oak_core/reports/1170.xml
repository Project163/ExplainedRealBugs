<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:47:23 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-2557] VersionGC uses way too much memory if there is a large pile of garbage</title>
                <link>https://issues.apache.org/jira/browse/OAK-2557</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;It has been noticed that on a system where revision-gc (VersionGarbageCollector of mongomk) did not run for a few days (due to not interfering with some tests/large bulk operations) that there was such a large pile of garbage accumulating, that the following code&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;VersionGarbageCollector.collectDeletedDocuments
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;in the for loop, creates such a large list of NodeDocuments to delete (docIdsToDelete) that it uses up too much memory, causing the JVM&apos;s GC to constantly spin in Full-GCs.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12778275">OAK-2557</key>
            <summary>VersionGC uses way too much memory if there is a large pile of garbage</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="chetanm">Chetan Mehrotra</assignee>
                                    <reporter username="stefanegli">Stefan Egli</reporter>
                        <labels>
                    </labels>
                <created>Fri, 27 Feb 2015 18:27:15 +0000</created>
                <updated>Tue, 8 Oct 2019 15:22:02 +0000</updated>
                            <resolved>Thu, 12 Mar 2015 16:39:01 +0000</resolved>
                                    <version>1.0.11</version>
                                    <fixVersion>1.0.13</fixVersion>
                    <fixVersion>1.1.8</fixVersion>
                                    <component>core</component>
                    <component>mongomk</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14341522" author="egli" created="Sat, 28 Feb 2015 13:31:45 +0000"  >&lt;p&gt;Here&apos;s a stacktrace that keeps showing up when this particular VM is running into low memory/full-gc-loops:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-quote&quot;&gt;&quot;pool-5-thread-5&quot;&lt;/span&gt; prio=10 tid=0x0000000001413800 nid=0x1aa5 runnable [0x00007f247599f000]
   java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: RUNNABLE
        at java.util.HashMap.addEntry(HashMap.java:884)
        at java.util.LinkedHashMap.addEntry(LinkedHashMap.java:427)
        at java.util.HashMap.put(HashMap.java:505)
        at org.bson.BasicBSONObject.put(BasicBSONObject.java:288)
        at org.bson.BasicBSONCallback._put(BasicBSONCallback.java:184)
        at org.bson.BasicBSONCallback.gotLong(BasicBSONCallback.java:132)
        at org.bson.BasicBSONDecoder.decodeElement(BasicBSONDecoder.java:222)
        at org.bson.BasicBSONDecoder._decode(BasicBSONDecoder.java:154)
        at org.bson.BasicBSONDecoder.decode(BasicBSONDecoder.java:132)
        at com.mongodb.DefaultDBDecoder.decode(DefaultDBDecoder.java:62)
        at com.mongodb.Response.&amp;lt;init&amp;gt;(Response.java:85)
        at com.mongodb.DBPort$1.execute(DBPort.java:141)
        at com.mongodb.DBPort$1.execute(DBPort.java:135)
        at com.mongodb.DBPort.doOperation(DBPort.java:164)
        - locked &amp;lt;0x000000064f6049d0&amp;gt; (a com.mongodb.DBPort)
        at com.mongodb.DBPort.call(DBPort.java:135)
        at com.mongodb.DBTCPConnector.innerCall(DBTCPConnector.java:292)
        at com.mongodb.DBTCPConnector.call(DBTCPConnector.java:271)
        at com.mongodb.DBTCPConnector.call(DBTCPConnector.java:237)
        at com.mongodb.QueryResultIterator.getMore(QueryResultIterator.java:137)
        at com.mongodb.QueryResultIterator.hasNext(QueryResultIterator.java:127)
        at com.mongodb.DBCursor._hasNext(DBCursor.java:551)
        at com.mongodb.DBCursor.hasNext(DBCursor.java:571)
        at com.google.common.collect.TransformedIterator.hasNext(TransformedIterator.java:43)
        at org.apache.jackrabbit.oak.plugins.document.VersionGarbageCollector.collectDeletedDocuments(VersionGarbageCollector.java:95)
        at org.apache.jackrabbit.oak.plugins.document.VersionGarbageCollector.gc(VersionGarbageCollector.java:79)
        at org.apache.jackrabbit.oak.plugins.document.DocumentNodeStoreService$2.run(DocumentNodeStoreService.java:472)
        at org.apache.jackrabbit.oak.spi.state.RevisionGC$1.call(RevisionGC.java:68)
        at org.apache.jackrabbit.oak.spi.state.RevisionGC$1.call(RevisionGC.java:64)
        at java.util.concurrent.FutureTask.run(FutureTask.java:262)
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14342911" author="chetanm" created="Mon, 2 Mar 2015 08:24:02 +0000"  >&lt;p&gt;&lt;tt&gt;docIdsToDelete&lt;/tt&gt; is just a set of string ids to be deleted and does not keep reference to &lt;tt&gt;NodeDocument&lt;/tt&gt;. Is that set becoming too large to cause an OOM? Do we have access to the heapdump to determine the size of set. We can possibly change the logic to delete once we have got say 500 ids collected but before that would like to confirm if thats the case here&lt;/p&gt;</comment>
                            <comment id="14352714" author="chetanm" created="Mon, 9 Mar 2015 09:26:31 +0000"  >&lt;blockquote&gt;&lt;p&gt;Is that set becoming too large to cause an OOM&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Indeed thats the case. The array list had 12M entries taking 3 GB of space. So GC logic should do the deletion in in between&lt;/p&gt;</comment>
                            <comment id="14352736" author="egli" created="Mon, 9 Mar 2015 10:04:02 +0000"  >&lt;p&gt;Could it be a side-effect of too many nodes being indexed due to &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-2559&quot; title=&quot;Lucene index rules should be case insensitive&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-2559&quot;&gt;&lt;del&gt;OAK-2559&lt;/del&gt;&lt;/a&gt; ?&lt;/p&gt;</comment>
                            <comment id="14352738" author="chetanm" created="Mon, 9 Mar 2015 10:06:52 +0000"  >&lt;blockquote&gt;&lt;p&gt;Could it be a side-effect of too many nodes being indexed due to &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-2559&quot; title=&quot;Lucene index rules should be case insensitive&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-2559&quot;&gt;&lt;del&gt;OAK-2559&lt;/del&gt;&lt;/a&gt; ?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Nopes. The paths in the list were for some property index. Probably the GC was disabled or has been run after long time.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-2559&quot; title=&quot;Lucene index rules should be case insensitive&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-2559&quot;&gt;&lt;del&gt;OAK-2559&lt;/del&gt;&lt;/a&gt; is related to Lucene which stores the content in binary files. Worst case I can expect 10k files which need to be deleted but not 12M. &lt;/p&gt;</comment>
                            <comment id="14352768" author="chetanm" created="Mon, 9 Mar 2015 10:36:09 +0000"  >&lt;p&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12703402/12703402_OAK-2557.patch&quot; title=&quot;OAK-2557.patch attached to OAK-2557&quot;&gt;patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; which flushes the deletes in batches of 450 (kept it less than batch size of MongoDocumentStore of 500). &lt;/p&gt;

&lt;p&gt;However saw an strange issue where the test fails. Test case creates nodes like &lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;/x
/x/child0
/x/child1
...
/x/child950
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;When initial batch is deleted it also picks up &lt;tt&gt;/x&lt;/tt&gt;. Due to this when later deletion logic tries to deleted say /x/child501 then it is not able to locate the commit root for delete and assumes that node is visible&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mreutegg&quot; class=&quot;user-hover&quot; rel=&quot;mreutegg&quot;&gt;mreutegg&lt;/a&gt; Can you have a look. Looks like a potential bug in DocumentStore logic. Or we need to ensure that we delete nodes going from child to parent? Further this problem would only arise if we try to delete ids in batches and would not come if pre emptively determine what all ids to be removed&lt;/p&gt;
</comment>
                            <comment id="14352819" author="mreutegg" created="Mon, 9 Mar 2015 11:13:07 +0000"  >&lt;p&gt;The revision GC needs to remove documents starting at the leafs. Otherwise the store is in an inconsistent state as you noticed. I assume the revision GC considers /x/child501 as not yet committed because commit flag is missing, hence it cannot be removed.&lt;/p&gt;</comment>
                            <comment id="14352867" author="chetanm" created="Mon, 9 Mar 2015 12:03:54 +0000"  >&lt;p&gt;After an offline discussion with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mreutegg&quot; class=&quot;user-hover&quot; rel=&quot;mreutegg&quot;&gt;mreutegg&lt;/a&gt; we come to following conclusion&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;Deletion logic has to work like creation logic and has to perform deletion in bottom to top way. Creation currently works from top to bottom i.e. ensures that parent get created first and child thereafter. So deletion logic has to complement that&lt;/li&gt;
	&lt;li&gt;Current logic also has a potential issue where if the system performing GC crashes in between then it might lead to a state where parent would have got removed before child and in that case such child document can never be GCed. So as a fix we should first sort the batch via &lt;tt&gt;PathComparator&lt;/tt&gt; in reverse and then perform deletion from child to parent. &lt;del&gt;&lt;font color=&quot;brown&quot;&gt;Open a new issue for that&lt;/font&gt;&lt;/del&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-2603&quot; title=&quot;Failure in one of the batch in VersionGC might lead to orphaned nodes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-2603&quot;&gt;&lt;del&gt;OAK-2603&lt;/del&gt;&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;For large deletion (like current case) we make use of &lt;tt&gt;ExternalSort&lt;/tt&gt; where sorting is performed on disk and we read for paths stored in file. This would make use of all the support developed in Blob GC in &lt;tt&gt;MarkSweepGarbageCollector&lt;/tt&gt;&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;All in all this would not be a simple fix that I initially thought &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14355322" author="egli" created="Tue, 10 Mar 2015 17:58:57 +0000"  >&lt;p&gt;&lt;tt&gt;&amp;lt;feature-creep-warning&amp;gt;&lt;/tt&gt;&lt;br/&gt;
we could make the VersionGC play nicely to existing load on the system: it could progress slower if the load is higher and vice-verca. One simple measure could be: if the observation queue is small (eg below 10) then the load is low and it could progress full-speed. Otherwise it could add some artificial sleeping in between.&lt;br/&gt;
&lt;tt&gt;&amp;lt;/feature-creep-warning&amp;gt;&lt;/tt&gt;&lt;/p&gt;</comment>
                            <comment id="14356267" author="chetanm" created="Wed, 11 Mar 2015 04:25:18 +0000"  >&lt;p&gt;Version GC currently ensures that query fired is made against the Secondary (if present). However having some throttling in such background task would be good thing to have. But first we need to have some &lt;tt&gt;SystemLoadIndicator&lt;/tt&gt; notion in Oak which can be provide details say in percentage 1..100 about system load. We can then expose configurable threshold which VersionGC would listen for and adjust its working accordingly.&lt;/p&gt;

&lt;p&gt;It can be a JMX bean which emits notification and we have our components listen to those notification (or use OSGi SR/Events). That can be used in other places like Observation processing, Blob GC etc&lt;/p&gt;</comment>
                            <comment id="14356751" author="chetanm" created="Wed, 11 Mar 2015 11:37:02 +0000"  >&lt;p&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12703888/12703888_OAK-2557-2.patch&quot; title=&quot;OAK-2557-2.patch attached to OAK-2557&quot;&gt;patch2&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; which uses &lt;tt&gt;ExternalSort&lt;/tt&gt; to sort the DocumentId. It uses in memory approach for upto 100k ids. If more than that limit are to be deleted then it switches to &lt;tt&gt;ExternalSort&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stefanegli&quot; class=&quot;user-hover&quot; rel=&quot;stefanegli&quot;&gt;stefanegli&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mreutegg&quot; class=&quot;user-hover&quot; rel=&quot;mreutegg&quot;&gt;mreutegg&lt;/a&gt; Can you have a look&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=amitjain&quot; class=&quot;user-hover&quot; rel=&quot;amitjain&quot;&gt;amitjain&lt;/a&gt; Can you review the usage of ExternalSort as this was also used in Blob GC. So your feedback would be helpful!&lt;/p&gt;</comment>
                            <comment id="14358376" author="egli" created="Thu, 12 Mar 2015 09:37:22 +0000"  >&lt;p&gt;Discussed offline with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mreutegg&quot; class=&quot;user-hover&quot; rel=&quot;mreutegg&quot;&gt;mreutegg&lt;/a&gt;: created &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-2613&quot; title=&quot;Do versionGC more frequently and at adjusted speed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-2613&quot;&gt;&lt;del&gt;OAK-2613&lt;/del&gt;&lt;/a&gt; to follow this up&lt;/p&gt;</comment>
                            <comment id="14358413" author="mreutegg" created="Thu, 12 Mar 2015 10:01:46 +0000"  >&lt;p&gt;I have a couple of suggestions:&lt;/p&gt;

&lt;p&gt;In VersionGarbageCollector:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;            if (log.isDebugEnabled() &amp;amp;&amp;amp; docIdsToDelete.size &amp;lt; 1000) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Rather call &lt;tt&gt;docIdsToDelete.getSize()&lt;/tt&gt;? Maybe even promote NodeDocIdCollector to a top level class to avoid breaking encapsulation?&lt;/p&gt;

&lt;p&gt;NodeDocIdCollector.sort() uses a hard coded Comparator when sorting in memory instead of the instance passed in the constructor.&lt;/p&gt;

&lt;p&gt;NodeDocIdCollector.flushToFile() uses &lt;tt&gt;PrintWriter.println()&lt;/tt&gt;. This method does not throw an IOException when the write fails. I think it would be better to use BufferedWriter directly.&lt;/p&gt;

&lt;p&gt;VersionGCState.close() deletes the the directory before resources are closed. I think this will fail on Windows based machines.&lt;/p&gt;</comment>
                            <comment id="14358517" author="chetanm" created="Thu, 12 Mar 2015 11:19:47 +0000"  >&lt;p&gt;Thanks for the detailed review &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mreutegg&quot; class=&quot;user-hover&quot; rel=&quot;mreutegg&quot;&gt;mreutegg&lt;/a&gt;. Attached is the &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12704137/12704137_OAK-2557-3.patch&quot; title=&quot;OAK-2557-3.patch attached to OAK-2557&quot;&gt;updated patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Maybe even promote NodeDocIdCollector to a top level class to avoid breaking encapsulation?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That makes more sense as its a generic class not bound to Document logic. I have refactored and moved this class to oak-commons under sort package. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thomasm&quot; class=&quot;user-hover&quot; rel=&quot;thomasm&quot;&gt;thomasm&lt;/a&gt; Can you have a quick look as with this it becomes part of Oak API&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;NodeDocIdCollector.sort() uses a hard coded Comparator when sorting in memory instead of the instance passed in the constructor.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Fixed that&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;NodeDocIdCollector.flushToFile() uses PrintWriter.println(). This method does not throw an IOException when the write fails. I think it would be better to use BufferedWriter directly.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Did not knew that. Refactored to use &lt;tt&gt;BufferedWriter&lt;/tt&gt;&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;VersionGCState.close() deletes the the directory before resources are closed. I think this will fail on Windows based machines.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Thanks for catching that. Would have missed this completely!&lt;/p&gt;</comment>
                            <comment id="14358591" author="mreutegg" created="Thu, 12 Mar 2015 12:30:29 +0000"  >&lt;p&gt;Looks better now. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thomasm&quot; class=&quot;user-hover&quot; rel=&quot;thomasm&quot;&gt;thomasm&lt;/a&gt;, WDYT?&lt;/p&gt;</comment>
                            <comment id="14358595" author="mreutegg" created="Thu, 12 Mar 2015 12:35:12 +0000"  >&lt;p&gt;Forgot one thing: the patch contains a change in the logback-test.xml. I assume this is unintentional and will not be committed.&lt;/p&gt;</comment>
                            <comment id="14358601" author="tmueller" created="Thu, 12 Mar 2015 12:44:07 +0000"  >&lt;p&gt;The StringSort doesn&apos;t support newlines so it&apos;s not a generic tool yet, also performance could probably be improved by pre-sorting and removing duplicates in the buffer (before writing), but that&apos;s all minor issue.&lt;/p&gt;</comment>
                            <comment id="14358628" author="egli" created="Thu, 12 Mar 2015 13:09:38 +0000"  >&lt;p&gt;Only a small comment/question: is there a reason you&apos;re doing the temp file creation manually vs using &lt;tt&gt;java.io.File.createTempFile&lt;/tt&gt; ?&lt;/p&gt;</comment>
                            <comment id="14358632" author="tmueller" created="Thu, 12 Mar 2015 13:14:33 +0000"  >&lt;p&gt;I assume the document ids can not contain strange characters (newlines), right?&lt;/p&gt;

&lt;p&gt;I noticed with debug level logging, the removed entries are logged, but only up to 1000. Maybe it&apos;s better to log in all cases? The list is iterated over twice in this case (for logging and for removing), but the logic looks good to me. &lt;/p&gt;</comment>
                            <comment id="14358639" author="tmueller" created="Thu, 12 Mar 2015 13:18:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stefanegli&quot; class=&quot;user-hover&quot; rel=&quot;stefanegli&quot;&gt;stefanegli&lt;/a&gt;, I think createTempFile can not create directories (which is what we need here).&lt;/p&gt;</comment>
                            <comment id="14358694" author="chetanm" created="Thu, 12 Mar 2015 13:56:28 +0000"  >&lt;blockquote&gt;&lt;p&gt;I noticed with debug level logging, the removed entries are logged, but only up to 1000&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Can do that. But like in current case the list might be pretty big 12M. So avoided flooding the logs&lt;/p&gt;</comment>
                            <comment id="14358699" author="tmueller" created="Thu, 12 Mar 2015 14:03:40 +0000"  >&lt;p&gt;I think large log files are acceptable, maybe it could help us see the progress?&lt;/p&gt;</comment>
                            <comment id="14358704" author="tmueller" created="Thu, 12 Mar 2015 14:08:36 +0000"  >&lt;p&gt;I made some code coverage tests, and it looks very good to me. What is not covered by &quot;deleteLargeNumber&quot; are:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;collectDeletedDocuments
    ..
        docIdsToDelete.add(prevDoc.getId()); &amp;lt;&amp;lt; this
    ..
    if (docIdsToDelete.isEmpty()){
        return; &amp;lt;&amp;lt; this
    }
    ..
    if (log.isDebugEnabled() &amp;amp;&amp;amp; docIdsToDelete.getSize() &amp;lt; 1000) {
        .. &amp;lt;&amp;lt; this
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The &quot;log&quot; part has a side effect (docIdsToDelete.getIds(), which might open new files)&lt;/p&gt;</comment>
                            <comment id="14358718" author="egli" created="Thu, 12 Mar 2015 14:22:17 +0000"  >&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thomasm&quot; class=&quot;user-hover&quot; rel=&quot;thomasm&quot;&gt;thomasm&lt;/a&gt; I think createTempFile can not create directories (which is what we need here).&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;&lt;a href=&quot;http://stackoverflow.com/questions/617414/create-a-temporary-directory-in-java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;right&lt;/a&gt;, I see&lt;/p&gt;</comment>
                            <comment id="14358742" author="mduerig" created="Thu, 12 Mar 2015 14:43:23 +0000"  >&lt;p&gt;You can do&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  directory = File.createTempFile();
  directory.delete();
  directory.mkdir();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14358934" author="mreutegg" created="Thu, 12 Mar 2015 16:39:01 +0000"  >&lt;p&gt;Chetan committed the patch to trunk: &lt;a href=&quot;http://svn.apache.org/r1666220&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1666220&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;and merged it to 1.0: &lt;a href=&quot;http://svn.apache.org/r1666221&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1666221&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14359896" author="chetanm" created="Fri, 13 Mar 2015 03:52:07 +0000"  >&lt;blockquote&gt;&lt;p&gt;maybe it could help us see the progress&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That would be useful. Changed the impl a bit with &lt;a href=&quot;http://svn.apache.org/r1666352&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1666352&lt;/a&gt;. Would that meet the requirements&lt;/p&gt;</comment>
                            <comment id="14359898" author="chetanm" created="Fri, 13 Mar 2015 03:54:02 +0000"  >&lt;p&gt;Minor nit pick there &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Above approach creates a potential security risk as per &lt;a href=&quot;http://docs.guava-libraries.googlecode.com/git/javadoc/com/google/common/io/Files.html#createTempDir%28%29&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Guava Files&lt;/a&gt;. Though those risks do not apply in our usecase!&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Use this method instead of File.createTempFile(String, String) when you wish to create a directory, not a regular file. A common pitfall is to call createTempFile, delete the file and create a directory in its place, but this leads a race condition which can be exploited to create security vulnerabilities, especially when executable files are to be written into the directory. &lt;/p&gt;&lt;/blockquote&gt;</comment>
                            <comment id="14359903" author="chetanm" created="Fri, 13 Mar 2015 04:06:13 +0000"  >&lt;blockquote&gt;&lt;p&gt;docIdsToDelete.add(prevDoc.getId()); &amp;lt;&amp;lt; this&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Thats important and should be covered by a test. Opened &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-2623&quot; title=&quot;Add test for GC of previous docs of a deleted document&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-2623&quot;&gt;&lt;del&gt;OAK-2623&lt;/del&gt;&lt;/a&gt; for that&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;The &quot;log&quot; part has a side effect (docIdsToDelete.getIds(), which might open new files)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Changed the log part to not have that side effect&lt;/p&gt;</comment>
                            <comment id="14502834" author="edivad" created="Mon, 20 Apr 2015 13:45:18 +0000"  >&lt;p&gt;Bulk close for 1.0.13&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12780818">OAK-2603</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12970334">OAK-4372</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12703888" name="OAK-2557-2.patch" size="20540" author="chetanm" created="Wed, 11 Mar 2015 11:37:02 +0000"/>
                            <attachment id="12704137" name="OAK-2557-3.patch" size="26304" author="chetanm" created="Thu, 12 Mar 2015 11:16:06 +0000"/>
                            <attachment id="12703402" name="OAK-2557.patch" size="4624" author="chetanm" created="Mon, 9 Mar 2015 10:36:09 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 30 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i265tb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>