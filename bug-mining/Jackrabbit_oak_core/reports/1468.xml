<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:50:32 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-4065] Counter index can get out of sync</title>
                <link>https://issues.apache.org/jira/browse/OAK-4065</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;I don&apos;t have a reproducible test case yet, but it looks like some usage pattern  (for example creating, deleting, moving many nodes in one transaction) can cause the counter index to get out of sync with the real data. Worst case, the counter index thinks that the repository is empty (the root node has no descendent nodes).&lt;/p&gt;

&lt;p&gt;I want to write test cases to find the problem, or to prove that it doesn&apos;t get out of sync.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12944489">OAK-4065</key>
            <summary>Counter index can get out of sync</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="thomasm">Thomas Mueller</assignee>
                                    <reporter username="thomasm">Thomas Mueller</reporter>
                        <labels>
                    </labels>
                <created>Thu, 25 Feb 2016 14:12:55 +0000</created>
                <updated>Tue, 8 Oct 2019 15:21:27 +0000</updated>
                            <resolved>Tue, 15 Mar 2016 15:05:10 +0000</resolved>
                                                    <fixVersion>1.5.0</fixVersion>
                    <fixVersion>1.6.0</fixVersion>
                                        <due></due>
                            <votes>1</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15177711" author="tmueller" created="Thu, 3 Mar 2016 11:43:36 +0000"  >&lt;p&gt;I didn&apos;t find a problem in the code, but maybe the problem is that after some time, if many nodes are added and removed, the count can get out of sync. A test case that adds 1 million nodes, then 10 times do this: adds 1 million nodes and remove 1 million nodes. After that, the expected value is 1 million. However, the histogram shows the following. The first image is using a cap (never go below zero), while the second image does not use a cap, so values can be below zero.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/12791154/12791154_probability_1m_10times-add1remove1m.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;So for the first case, the most likely value is actually 0, which is what I saw. For my taste, too many values are outside of the acceptable window. So maybe this is the reason why the counter got out of sync.&lt;/p&gt;

&lt;p&gt;To get a more accurate count, we could:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;don&apos;t trust (near) 0 values in the cost estimate&lt;/li&gt;
	&lt;li&gt;take into account the approximate count of children as well, as the average of parent and children is more accurate&lt;/li&gt;
	&lt;li&gt;from time to time, for example once a week, (partially) reindex the counter index&lt;/li&gt;
	&lt;li&gt;use a mechanism that is accurate over time when adding, removing, adding nodes&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;A more accurate mechanism would be for example: instead of an independent pseudo-random value, calculate the hash code of the node name, and if that modulo 10000 is 0, increment / decrement the counter. That way, counts below 0 are not possible, as each add/remove pair will result in exactly 0 (most are +0/-0, and 1:10000 there is a +1/-1 pair).&lt;/p&gt;</comment>
                            <comment id="15177968" author="tmueller" created="Thu, 3 Mar 2016 15:35:20 +0000"  >&lt;p&gt;Possible patch (work in progress). Uses SipHash to hash the path, and for some nodes it increments / decrements the counter.&lt;/p&gt;

&lt;p&gt;Missing pieces: &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Resolution is set to 10 for testing (should be 1000 or so).&lt;/li&gt;
	&lt;li&gt;Seed is not set, so attacks (causing incorrect node count estimates) are possible if an attacker can control the node names created.&lt;/li&gt;
	&lt;li&gt;Property indexes still use the old logic.&lt;/li&gt;
	&lt;li&gt;Some refactoring would be nice to avoid duplicate code, and Javadocs.&lt;/li&gt;
	&lt;li&gt;Documentation.&lt;/li&gt;
	&lt;li&gt;Additional tests.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15195440" author="tmueller" created="Tue, 15 Mar 2016 15:04:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-4065&quot; title=&quot;Counter index can get out of sync&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-4065&quot;&gt;&lt;del&gt;OAK-4065&lt;/del&gt;&lt;/a&gt;-b.patch&lt;/p&gt;</comment>
                            <comment id="15195445" author="tmueller" created="Tue, 15 Mar 2016 15:05:10 +0000"  >&lt;p&gt;&lt;a href=&quot;http://svn.apache.org/r1735094&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1735094&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15221440" author="amitjain" created="Fri, 1 Apr 2016 09:22:43 +0000"  >&lt;p&gt;Bulk close for 1.5.0&lt;/p&gt;</comment>
                            <comment id="15706282" author="catholicon" created="Tue, 29 Nov 2016 19:24:52 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thomasm&quot; class=&quot;user-hover&quot; rel=&quot;thomasm&quot;&gt;thomasm&lt;/a&gt;, I think this issue is worth backporting?&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12961646">OAK-4275</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12723090">OAK-1907</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12793549" name="OAK-4065-b.patch" size="14991" author="thomasm" created="Tue, 15 Mar 2016 15:04:33 +0000"/>
                            <attachment id="12791191" name="OAK-4065.patch" size="12471" author="thomasm" created="Thu, 3 Mar 2016 15:35:20 +0000"/>
                            <attachment id="12791154" name="probability_1m_10times-add1remove1m.png" size="71080" author="thomasm" created="Thu, 3 Mar 2016 11:29:25 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 50 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2tqvb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>