<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:45:43 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-2049] ArrayIndexOutOfBoundsException in Segment.getRefId()</title>
                <link>https://issues.apache.org/jira/browse/OAK-2049</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;It looks like there is some SegmentMK bug that causes the &lt;tt&gt;Segment.getRefId()&lt;/tt&gt; to throw an &lt;tt&gt;ArrayIndexOutOfBoundsException&lt;/tt&gt; in some fairly rare corner cases.&lt;br/&gt;
The data was originally migrated into oak via the crx2oak tool mentioned here: &lt;a href=&quot;http://docs.adobe.com/docs/en/aem/6-0/deploy/upgrade.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://docs.adobe.com/docs/en/aem/6-0/deploy/upgrade.html&lt;/a&gt;&lt;br/&gt;
That tool uses &lt;b&gt;oak-core-1.0.0&lt;/b&gt; creating an oak instance.&lt;/p&gt;

&lt;p&gt;Similar to &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-1566&quot; title=&quot;ArrayIndexOutOfBoundsException in Segment.getRefId()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-1566&quot;&gt;&lt;del&gt;OAK-1566&lt;/del&gt;&lt;/a&gt; this system was using FileDataStore with SegmentNodeStore.&lt;/p&gt;

&lt;p&gt;In this case the error is seen when running offline compaction using oak-run-1.1-SNAPSHOT.jar (latest).&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-none&quot;&gt;&amp;gt; java -Xmx4096m -jar oak-run-1.1-SNAPSHOT.jar compact /oak/crx-quickstart/repository/segmentstore
Apache Jackrabbit Oak 1.1-SNAPSHOT
Compacting /wcm/cq-author/crx-quickstart/repository/segmentstore
before [data00055a.tar, data00064a.tar, data00045b.tar, data00005a.tar, data00018a.tar, data00022a.tar, data00047a.tar, data00037a.tar, data00049a.tar, data00014a.tar, data00066a.tar, data00020a.tar, data00058a.tar, data00065a.tar, data00069a.tar, data00012a.tar, data00009a.tar, data00060a.tar, data00041a.tar, data00016a.tar, data00072a.tar, data00048a.tar, data00061a.tar, data00053a.tar, data00038a.tar, data00001a.tar, data00034a.tar, data00003a.tar, data00052a.tar, data00006a.tar, data00027a.tar, data00031a.tar, data00056a.tar, data00035a.tar, data00063a.tar, data00068a.tar, data00008v.tar, data00010a.tar, data00043b.tar, data00021a.tar, data00017a.tar, data00024a.tar, data00054a.tar, data00051a.tar, data00057a.tar, data00059a.tar, data00036a.tar, data00033a.tar, data00019a.tar, data00046a.tar, data00067a.tar, data00004a.tar, data00044a.tar, data00013a.tar, data00070a.tar, data00026a.tar, data00002a.tar, data00011a.tar, journal.log, data00030a.tar, data00042a.tar, data00025a.tar, data00062a.tar, data00023a.tar, data00071a.tar, data00032b.tar, data00040a.tar, data00015a.tar, data00029a.tar, data00050a.tar, data00000a.tar, data00007a.tar, data00028a.tar, data00039a.tar]
-&amp;gt; compacting
Exception in thread &quot;main&quot; java.lang.ArrayIndexOutOfBoundsException: 206
at org.apache.jackrabbit.oak.plugins.segment.Segment.getRefId(Segment.java:191)
at org.apache.jackrabbit.oak.plugins.segment.Segment.internalReadRecordId(Segment.java:299)
at org.apache.jackrabbit.oak.plugins.segment.Segment.readRecordId(Segment.java:295)
at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeState.getTemplateId(SegmentNodeState.java:69)
at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeState.getTemplate(SegmentNodeState.java:78)
at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeState.getProperties(SegmentNodeState.java:150)
at org.apache.jackrabbit.oak.plugins.memory.EmptyNodeState.compareAgainstEmptyState(EmptyNodeState.java:154)
at org.apache.jackrabbit.oak.plugins.segment.Compactor$CompactDiff.childNodeAdded(Compactor.java:124)
at org.apache.jackrabbit.oak.plugins.memory.EmptyNodeState.compareAgainstEmptyState(EmptyNodeState.java:160)
at org.apache.jackrabbit.oak.plugins.segment.Compactor$CompactDiff.childNodeAdded(Compactor.java:124)
at org.apache.jackrabbit.oak.plugins.memory.EmptyNodeState.compareAgainstEmptyState(EmptyNodeState.java:160)
at org.apache.jackrabbit.oak.plugins.segment.Compactor$CompactDiff.childNodeAdded(Compactor.java:124)
at org.apache.jackrabbit.oak.plugins.memory.EmptyNodeState.compareAgainstEmptyState(EmptyNodeState.java:160)
at org.apache.jackrabbit.oak.plugins.segment.Compactor$CompactDiff.childNodeAdded(Compactor.java:124)
at org.apache.jackrabbit.oak.plugins.memory.EmptyNodeState.compareAgainstEmptyState(EmptyNodeState.java:160)
at org.apache.jackrabbit.oak.plugins.segment.Compactor$CompactDiff.childNodeAdded(Compactor.java:124)
at org.apache.jackrabbit.oak.plugins.memory.EmptyNodeState.compareAgainstEmptyState(EmptyNodeState.java:160)
at org.apache.jackrabbit.oak.plugins.segment.Compactor$CompactDiff.childNodeAdded(Compactor.java:124)
at org.apache.jackrabbit.oak.plugins.memory.EmptyNodeState.compareAgainstEmptyState(EmptyNodeState.java:160)
at org.apache.jackrabbit.oak.plugins.segment.Compactor$CompactDiff.childNodeAdded(Compactor.java:124)
at org.apache.jackrabbit.oak.plugins.memory.EmptyNodeState.compareAgainstEmptyState(EmptyNodeState.java:160)
at org.apache.jackrabbit.oak.plugins.segment.Compactor$CompactDiff.childNodeAdded(Compactor.java:124)
at org.apache.jackrabbit.oak.plugins.memory.EmptyNodeState.compareAgainstEmptyState(EmptyNodeState.java:160)
at org.apache.jackrabbit.oak.plugins.segment.Compactor$CompactDiff.childNodeAdded(Compactor.java:124)
at org.apache.jackrabbit.oak.plugins.memory.EmptyNodeState.compareAgainstEmptyState(EmptyNodeState.java:160)
at org.apache.jackrabbit.oak.plugins.segment.Compactor$CompactDiff.childNodeAdded(Compactor.java:124)
at org.apache.jackrabbit.oak.plugins.memory.EmptyNodeState.compareAgainstEmptyState(EmptyNodeState.java:160)
at org.apache.jackrabbit.oak.plugins.segment.Compactor$CompactDiff.childNodeAdded(Compactor.java:124)
at org.apache.jackrabbit.oak.plugins.memory.EmptyNodeState.compareAgainstEmptyState(EmptyNodeState.java:160)
at org.apache.jackrabbit.oak.plugins.segment.Compactor$CompactDiff.childNodeAdded(Compactor.java:124)
at org.apache.jackrabbit.oak.plugins.memory.EmptyNodeState.compareAgainstEmptyState(EmptyNodeState.java:160)
at org.apache.jackrabbit.oak.plugins.segment.Compactor$CompactDiff.childNodeAdded(Compactor.java:124)
at org.apache.jackrabbit.oak.plugins.memory.EmptyNodeState.compareAgainstEmptyState(EmptyNodeState.java:160)
at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeState.compareAgainstBaseState(SegmentNodeState.java:395)
at org.apache.jackrabbit.oak.plugins.segment.Compactor.process(Compactor.java:80)
at org.apache.jackrabbit.oak.plugins.segment.Compactor.compact(Compactor.java:85)
at org.apache.jackrabbit.oak.plugins.segment.file.FileStore.compact(FileStore.java:438)
at org.apache.jackrabbit.oak.run.Main.compact(Main.java:311)
at org.apache.jackrabbit.oak.run.Main.main(Main.java:133)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12735894">OAK-2049</key>
            <summary>ArrayIndexOutOfBoundsException in Segment.getRefId()</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mduerig">Michael D&#252;rig</assignee>
                                    <reporter username="akhoury">Andrew Khoury</reporter>
                        <labels>
                    </labels>
                <created>Thu, 21 Aug 2014 20:52:14 +0000</created>
                <updated>Tue, 8 Oct 2019 15:21:36 +0000</updated>
                            <resolved>Tue, 16 Sep 2014 13:46:01 +0000</resolved>
                                    <version>1.0.4</version>
                    <version>1.1.0</version>
                                    <fixVersion>1.0.6</fixVersion>
                    <fixVersion>1.1.0</fixVersion>
                                    <component>core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="14112254" author="alex.parvulescu" created="Wed, 27 Aug 2014 13:50:34 +0000"  >&lt;p&gt;In rev &lt;a href=&quot;http://svn.apache.org/r1620898&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1620898&lt;/a&gt; I added protection against the outofbounds exception, also I added the segment id to the logs for followup debugging if needed.&lt;/p&gt;</comment>
                            <comment id="14112385" author="jukkaz" created="Wed, 27 Aug 2014 16:15:35 +0000"  >&lt;p&gt;It would be great if we could identify the segment where this happens (with the logging Alex added), so it can be inspected in more detail. I recall we had some problem in earlier Oak 1.0.x versions where a particular corner case ended up producing malformed records. I&apos;ll see if I can find the issue reference.&lt;/p&gt;</comment>
                            <comment id="14128208" author="alex.parvulescu" created="Wed, 10 Sep 2014 08:05:59 +0000"  >&lt;p&gt;The error apparently came from the upgrade process introducing some weird state. Using the latest repo upgrade tool, we can now see the error at upgrade time.&lt;br/&gt;
Keep in mind that this is not repeatable, we ran the upgrade twice and the second time looks like it went well, no upgrade error, but I&apos;m not sure about corruption in the repo.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;xception in thread &lt;span class=&quot;code-quote&quot;&gt;&quot;main&quot;&lt;/span&gt; javax.jcr.RepositoryException: Failed to copy content
	at org.apache.jackrabbit.oak.upgrade.RepositoryUpgrade.copy(RepositoryUpgrade.java:311)
	at com.adobe.granite.crx2oak.CRX2Oak.crx2oak(CRX2Oak.java:194)
	at com.adobe.granite.crx2oak.CRX2Oak.crx2oak(CRX2Oak.java:146)
	at com.adobe.granite.crx2oak.CRX2Oak.main(CRX2Oak.java:120)
Caused by: java.lang.ArrayIndexOutOfBoundsException: 92
	at org.apache.jackrabbit.oak.plugins.segment.Segment.getRefId(Segment.java:183)
	at org.apache.jackrabbit.oak.plugins.segment.Segment.internalReadRecordId(Segment.java:291)
	at org.apache.jackrabbit.oak.plugins.segment.Segment.readRecordId(Segment.java:287)
	at org.apache.jackrabbit.oak.plugins.segment.Segment.loadTemplate(Segment.java:369)
	at org.apache.jackrabbit.oak.plugins.segment.Segment.readTemplate(Segment.java:351)
	at org.apache.jackrabbit.oak.plugins.segment.Segment.readTemplate(Segment.java:345)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeState.getTemplate(SegmentNodeState.java:74)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeState.getProperties(SegmentNodeState.java:142)
	at org.apache.jackrabbit.oak.plugins.memory.EmptyNodeState.compareAgainstEmptyState(EmptyNodeState.java:154)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeState.compareAgainstBaseState(SegmentNodeState.java:387)
	at org.apache.jackrabbit.oak.spi.commit.EditorDiff.childNodeAdded(EditorDiff.java:125)
	at org.apache.jackrabbit.oak.plugins.memory.EmptyNodeState.compareAgainstEmptyState(EmptyNodeState.java:160)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeState.compareAgainstBaseState(SegmentNodeState.java:387)
	at org.apache.jackrabbit.oak.spi.commit.EditorDiff.childNodeAdded(EditorDiff.java:125)
	at org.apache.jackrabbit.oak.plugins.memory.EmptyNodeState.compareAgainstEmptyState(EmptyNodeState.java:160)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeState.compareAgainstBaseState(SegmentNodeState.java:387)
	at org.apache.jackrabbit.oak.spi.commit.EditorDiff.childNodeAdded(EditorDiff.java:125)
	at org.apache.jackrabbit.oak.plugins.memory.EmptyNodeState.compareAgainstEmptyState(EmptyNodeState.java:160)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeState.compareAgainstBaseState(SegmentNodeState.java:387)
	at org.apache.jackrabbit.oak.spi.commit.EditorDiff.childNodeAdded(EditorDiff.java:125)
	at org.apache.jackrabbit.oak.plugins.memory.EmptyNodeState.compareAgainstEmptyState(EmptyNodeState.java:160)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeState.compareAgainstBaseState(SegmentNodeState.java:387)
	at org.apache.jackrabbit.oak.spi.commit.EditorDiff.childNodeAdded(EditorDiff.java:125)
	at org.apache.jackrabbit.oak.plugins.memory.EmptyNodeState.compareAgainstEmptyState(EmptyNodeState.java:160)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeState.compareAgainstBaseState(SegmentNodeState.java:387)
	at org.apache.jackrabbit.oak.spi.commit.EditorDiff.childNodeAdded(EditorDiff.java:125)
	at org.apache.jackrabbit.oak.plugins.memory.EmptyNodeState.compareAgainstEmptyState(EmptyNodeState.java:160)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeState.compareAgainstBaseState(SegmentNodeState.java:387)
	at org.apache.jackrabbit.oak.spi.commit.EditorDiff.childNodeAdded(EditorDiff.java:125)
	at org.apache.jackrabbit.oak.plugins.memory.EmptyNodeState.compareAgainstEmptyState(EmptyNodeState.java:160)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeState.compareAgainstBaseState(SegmentNodeState.java:387)
	at org.apache.jackrabbit.oak.spi.commit.EditorDiff.childNodeAdded(EditorDiff.java:125)
	at org.apache.jackrabbit.oak.plugins.memory.EmptyNodeState.compareAgainstEmptyState(EmptyNodeState.java:160)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeState.compareAgainstBaseState(SegmentNodeState.java:387)
	at org.apache.jackrabbit.oak.spi.commit.EditorDiff.childNodeAdded(EditorDiff.java:125)
	at org.apache.jackrabbit.oak.plugins.memory.EmptyNodeState.compareAgainstEmptyState(EmptyNodeState.java:160)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeState.compareAgainstBaseState(SegmentNodeState.java:387)
	at org.apache.jackrabbit.oak.spi.commit.EditorDiff.childNodeAdded(EditorDiff.java:125)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeState.compareAgainstBaseState(SegmentNodeState.java:505)
	at org.apache.jackrabbit.oak.spi.commit.EditorDiff.process(EditorDiff.java:52)
	at org.apache.jackrabbit.oak.spi.commit.EditorHook.processCommit(EditorHook.java:54)
	at org.apache.jackrabbit.oak.spi.commit.CompositeHook.processCommit(CompositeHook.java:60)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeStore$Commit.prepare(SegmentNodeStore.java:341)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeStore$Commit.optimisticMerge(SegmentNodeStore.java:372)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeStore$Commit.execute(SegmentNodeStore.java:428)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeStore.merge(SegmentNodeStore.java:140)
	at org.apache.jackrabbit.oak.upgrade.RepositoryUpgrade.copy(RepositoryUpgrade.java:309)
	... 3 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14133891" author="tmueller" created="Mon, 15 Sep 2014 13:38:52 +0000"  >&lt;p&gt;Possibly the problem is in SegmentWriter.prepare, where &quot;rootcount--&quot; is called in a loop. In cases where the same record is referenced multiple times from the current record, and this record was so far a root record (for example the last record that was written, but not strictly necessary), I think this can end up with a wrong &quot;rootcount&quot;, such that the segment is not flushed even thought it should be.&lt;/p&gt;

&lt;p&gt;Proposed patch (just the fix, no test case yet):&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Index: src/main/java/org/apache/jackrabbit/oak/plugins/segment/SegmentWriter.java
===================================================================
--- src/main/java/org/apache/jackrabbit/oak/plugins/segment/SegmentWriter.java	(revision 1624000)
+++ src/main/java/org/apache/jackrabbit/oak/plugins/segment/SegmentWriter.java	(working copy)
@@ -46,6 +46,7 @@
 import java.util.Arrays;
 import java.util.Collection;
 import java.util.Collections;
+import java.util.HashSet;
 import java.util.LinkedHashMap;
 import java.util.List;
 import java.util.Map;
@@ -291,14 +292,32 @@
             refcount -= idcount;
 
             Set&amp;lt;SegmentId&amp;gt; segmentIds = newIdentityHashSet();
+            
+            // The set of old record ids in this segment
+            // that were previously root record ids, but will no longer be,
+            // because the record to be written references them.
+            // This needs to be a set, because the list of ids can
+            // potentially reference the same record multiple times
+            Set&amp;lt;RecordId&amp;gt; notRoots = new HashSet&amp;lt;RecordId&amp;gt;();
+            
             for (RecordId recordId : ids) {
                 SegmentId segmentId = recordId.getSegmentId();
                 if (segmentId != segment.getSegmentId()) {
                     segmentIds.add(segmentId);
                 } else if (roots.containsKey(recordId)) {
-                    rootcount--;
+                    
+                    // log to verify OAK-2049 was hit
+                    // TODO this can be removed later on
+                    if (log.isDebugEnabled()) {
+                        if (notRoots.contains(recordId)) {
+                            log.debug(&quot;Multiple pointers to the same record&quot;);
+                        }
+                    }
+                    
+                    notRoots.add(recordId);
                 }
             }
+            rootcount -= notRoots.size();
             if (!segmentIds.isEmpty()) {
                 for (int refid = 1; refid &amp;lt; refcount; refid++) {
                     segmentIds.remove(segment.getRefId(refid));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14133893" author="tmueller" created="Mon, 15 Sep 2014 13:43:18 +0000"  >&lt;p&gt;Partial test case (doesn&apos;t actually fail, but will hit the condition above and log a debug level message if this is enabled):&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Index: src/test/java/org/apache/jackrabbit/oak/jcr/CRUDTest.java
===================================================================
--- src/test/java/org/apache/jackrabbit/oak/jcr/CRUDTest.java	(revision 1624000)
+++ src/test/java/org/apache/jackrabbit/oak/jcr/CRUDTest.java	(working copy)
@@ -39,6 +39,32 @@
     public CRUDTest(NodeStoreFixture fixture) {
         super(fixture);
     }
+    
+    @Test
+    public void testMultiValue() throws RepositoryException {
+        Session session = getAdminSession();
+        // Create
+        Node testRoot = session.getRootNode().addNode(&quot;testRoot&quot;);
+        long last = System.currentTimeMillis();
+        for (int i = 0; i &amp;lt; 1000000; i++) {
+            if (i % 1000 == 0) {
+                long now = System.currentTimeMillis();
+                if (now - last &amp;gt; 1000) {
+                    System.out.println(i);
+                }
+            }
+            Node test = testRoot.addNode(&quot;test&quot;);
+            for (int j = 0; j &amp;lt; 100; j++) {
+                String s = &quot;test&quot; + i + &quot;-&quot; + j;
+                test.setProperty(&quot;p&quot; + j, new String[] { s, s, s, s, s, s, s,
+                        s, s, s, s, s, s, s });
+            }
+            session.save();
+            test.remove();
+            session.save();
+        }
+        session.save();
+    }
 
     @Test
     public void testCRUD() throws RepositoryException {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14134036" author="mduerig" created="Mon, 15 Sep 2014 15:53:27 +0000"  >&lt;p&gt;To make it fail we should probably add an assertion into &lt;tt&gt;SegmentWriter.flush&lt;/tt&gt;. Something like&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    checkState(length &amp;lt;= buffer.length);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Putting this right before the segment size adjustment causes you test to fail reliable for me.&lt;/p&gt;</comment>
                            <comment id="14134443" author="mduerig" created="Mon, 15 Sep 2014 20:37:17 +0000"  >&lt;p&gt;At &lt;a href=&quot;http://svn.apache.org/r1625158&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1625158&lt;/a&gt; I added a test case that reproduces the issue at the &lt;tt&gt;SegmentWriter&lt;/tt&gt; level. I can confirm that the patch from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thomasm&quot; class=&quot;user-hover&quot; rel=&quot;thomasm&quot;&gt;thomasm&lt;/a&gt; makes the test pass. &lt;/p&gt;

&lt;p&gt;I also merged the test case to 1.0 at &lt;a href=&quot;http://svn.apache.org/r1625225&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1625225&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Note that this test actually takes the issue to the extreme such that the segment writer&apos;s internal position gets negative. This will cause a subsequent assertion to fail: &lt;a href=&quot;https://github.com/apache/jackrabbit-oak/blob/trunk/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/SegmentWriter.java#L322&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/jackrabbit-oak/blob/trunk/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/SegmentWriter.java#L322&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14135249" author="mduerig" created="Tue, 16 Sep 2014 10:23:08 +0000"  >&lt;p&gt;Committed Tom&apos;s patch, and additional runtime assertion and a more aggressive test case to trunk at &lt;a href=&quot;http://svn.apache.org/r1625237&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1625237&lt;/a&gt; and to 1.0 at &lt;a href=&quot;http://svn.apache.org/r1625253&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1625253&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14135445" author="alex.parvulescu" created="Tue, 16 Sep 2014 13:46:01 +0000"  >&lt;p&gt;marking as fixed&lt;/p&gt;</comment>
                            <comment id="14147426" author="amitjain" created="Thu, 25 Sep 2014 05:37:17 +0000"  >&lt;p&gt;Bulk close for 1.0.6&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10020">
                    <name>Cloners</name>
                                            <outwardlinks description="is a clone of">
                                        <issuelink>
            <issuekey id="12702283">OAK-1566</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12738766">OAK-2070</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12746964">OAK-2172</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 8 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1z7af:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>