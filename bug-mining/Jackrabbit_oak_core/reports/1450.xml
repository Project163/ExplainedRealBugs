<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:50:21 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-3923] Async indexing delayed by 30 minutes because stop order is incorrect</title>
                <link>https://issues.apache.org/jira/browse/OAK-3923</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;The stop order of Oak components is incorrect, and this can lead to an async indexing delay of 30 minutes, because the indexing lease is not removed. The problem is that the node store is stopped before the async index is stopped, so that async indexing can still be in progress, and then when async indexing is done, the lease can not be removed because the node store is not available.&lt;/p&gt;

&lt;p&gt;From the log file:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;error.log:
21.01.2016 11:53:56.898 *INFO* [FelixStartLevel] org.apache.jackrabbit.oak-tarmk-standby BundleEvent STOPPED
21.01.2016 11:53:56.900 *INFO* [FelixStartLevel] org.apache.jackrabbit.oak-solr-osgi Service [org.apache.jackrabbit.oak.plugins.index.solr.osgi.SolrIndexEditorProviderService,571, [org.apache.jackrabbit.oak.plugins.index.IndexEditorProvider]] ServiceEvent UNREGISTERING
...
21.01.2016 11:53:56.930 *INFO* [FelixStartLevel] org.apache.jackrabbit.oak-lucene BundleEvent STOPPING
21.01.2016 11:53:56.930 *INFO* [FelixStartLevel] org.apache.jackrabbit.oak-lucene BundleEvent STOPPED
21.01.2016 11:53:56.931 *INFO* [FelixStartLevel] org.apache.jackrabbit.oak-core Service [org.apache.jackrabbit.oak.plugins.index.property.PropertyIndexProvider,405, [org.apache.jackrabbit.oak.spi.query.QueryIndexProvider]] ServiceEvent UNREGISTERING
...
21.01.2016 11:53:56.936 *INFO* [FelixStartLevel] com.adobe.granite.repository.impl.SlingRepositoryManager stop: Repository still running, forcing shutdown
...
21.01.2016 11:53:56.960 *WARN* [FelixStartLevel] org.apache.jackrabbit.oak.osgi.OsgiWhiteboard Error unregistering service: com.adobe.granite.repository.impl.SlingRepositoryManager$1@7c052458 of type java.util.concurrent.Executor
java.lang.IllegalStateException: Service already unregistered.
	at org.apache.felix.framework.ServiceRegistrationImpl.unregister(ServiceRegistrationImpl.java:136)
	at org.apache.jackrabbit.oak.osgi.OsgiWhiteboard$1.unregister(OsgiWhiteboard.java:81)
	at org.apache.jackrabbit.oak.spi.whiteboard.CompositeRegistration.unregister(CompositeRegistration.java:43)
	at org.apache.jackrabbit.oak.Oak$6.close(Oak.java:592)
...
21.01.2016 11:56:50.985 *INFO* [FelixStartLevel] org.apache.jackrabbit.oak-core Service [763, [org.apache.jackrabbit.oak.plugins.segment.SegmentStoreProvider]] ServiceEvent UNREGISTERING
 
debug.log:
21.01.2016 11:56:51.964 *WARN* [sling-default-4] org.apache.jackrabbit.oak.plugins.index.AsyncIndexUpdate [async] The index update failed
java.lang.IllegalStateException: service must be activated when used
	at com.google.common.base.Preconditions.checkState(Preconditions.java:150)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeStoreService.getNodeStore(SegmentNodeStoreService.java:233)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeStoreService.getNodeStore(SegmentNodeStoreService.java:92)
	at org.apache.jackrabbit.oak.spi.state.ProxyNodeStore.getRoot(ProxyNodeStore.java:36)
	at org.apache.jackrabbit.oak.plugins.index.AsyncIndexUpdate$AsyncUpdateCallback.close(AsyncIndexUpdate.java:266)
	at org.apache.jackrabbit.oak.plugins.index.AsyncIndexUpdate.updateIndex(AsyncIndexUpdate.java:451)
	at org.apache.jackrabbit.oak.plugins.index.AsyncIndexUpdate.run(AsyncIndexUpdate.java:351)
 
error.log:
21.01.2016 11:56:51.965 *ERROR* [sling-default-4] org.apache.sling.commons.scheduler.impl.QuartzScheduler Exception during job execution of org.apache.jackrabbit.oak.plugins.index.AsyncIndexUpdate@1706b18c : service must be activated when used
java.lang.IllegalStateException: service must be activated when used
	at com.google.common.base.Preconditions.checkState(Preconditions.java:150)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeStoreService.getNodeStore(SegmentNodeStoreService.java:233)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeStoreService.getNodeStore(SegmentNodeStoreService.java:92)
	at org.apache.jackrabbit.oak.spi.state.ProxyNodeStore.release(ProxyNodeStore.java:90)
	at org.apache.jackrabbit.oak.plugins.index.AsyncIndexUpdate.run(AsyncIndexUpdate.java:372)
	at org.apache.sling.commons.scheduler.impl.QuartzJobExecutor.execute(QuartzJobExecutor.java:115)
	at org.quartz.core.JobRunShell.run(JobRunShell.java:202)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
	at java.lang.Thread.run(Thread.java:745)

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12934066">OAK-3923</key>
            <summary>Async indexing delayed by 30 minutes because stop order is incorrect</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="chetanm">Chetan Mehrotra</assignee>
                                    <reporter username="thomasm">Thomas Mueller</reporter>
                        <labels>
                    </labels>
                <created>Tue, 26 Jan 2016 08:32:18 +0000</created>
                <updated>Tue, 8 Oct 2019 15:22:07 +0000</updated>
                            <resolved>Fri, 29 Jan 2016 10:07:59 +0000</resolved>
                                                    <fixVersion>1.0.32</fixVersion>
                    <fixVersion>1.2.11</fixVersion>
                    <fixVersion>1.3.15</fixVersion>
                    <fixVersion>1.4</fixVersion>
                                    <component>core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15120937" author="chetanm" created="Thu, 28 Jan 2016 07:27:44 +0000"  >&lt;p&gt;On a side note (adding more logs below). It appears that repository is being closed multiple time. The logs start with service unregistration calls for various services registered in Oak class. And in the end it appears that close is called again. Which leads to those warn logs . For this I think we should have logic in Oak#close to avoid/ignore multiple close calls. &lt;/p&gt;

&lt;p&gt;For now opened &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-3944&quot; title=&quot;OsgiWhiteboard should handle multiple unregister call&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-3944&quot;&gt;&lt;del&gt;OAK-3944&lt;/del&gt;&lt;/a&gt; to handle multiple unregister calls in a better manner&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;17.12.2015 16:53:24.439 *INFO* [FelixStartLevel] com.adobe.granite.repository.impl.SlingRepositoryManager stop: Repository still running, forcing shutdown
17.12.2015 16:53:24.453 *INFO* [FelixStartLevel] com.adobe.granite.repository Service [com.adobe.granite.repository.impl.SlingRepositoryManager,522, [org.apache.sling.jcr.api.SlingRepository, javax.jcr.Repository, org.apache.jackrabbit.api.management.RepositoryManager, org.apache.jackrabbit.api.JackrabbitRepository, com.day.crx.CRXRepository]] ServiceEvent UNREGISTERING
17.12.2015 16:53:24.464 *INFO* [FelixStartLevel] com.adobe.granite.repository Service [com.day.crx.sling.server.impl.jmx.ManagedRepository,551, [com.day.crx.sling.server.jmx.ManagedRepositoryMBean]] ServiceEvent UNREGISTERING
17.12.2015 16:53:24.467 *INFO* [FelixStartLevel] com.adobe.granite.repository Service [com.day.crx.core.backup.FileStoreBackupServiceImpl,550, [com.day.crx.core.backup.FileStoreBackupService]] ServiceEvent UNREGISTERING
17.12.2015 16:53:24.471 *INFO* [FelixStartLevel] com.adobe.granite.repository Service [518, [org.apache.jackrabbit.api.jmx.QueryStatManagerMBean]] ServiceEvent UNREGISTERING
17.12.2015 16:53:24.473 *INFO* [FelixStartLevel] com.adobe.granite.repository Service [519, [org.apache.jackrabbit.oak.api.jmx.RepositoryStatsMBean]] ServiceEvent UNREGISTERING
17.12.2015 16:53:24.475 *INFO* [FelixStartLevel] com.adobe.granite.repository Service [520, [java.lang.Runnable]] ServiceEvent UNREGISTERING
17.12.2015 16:53:24.476 *INFO* [FelixStartLevel] com.adobe.granite.repository Service [521, [org.apache.jackrabbit.oak.spi.gc.GCMonitor]] ServiceEvent UNREGISTERING
17.12.2015 16:53:24.479 *INFO* [FelixStartLevel] com.adobe.granite.repository Service [510, [java.util.concurrent.Executor]] ServiceEvent UNREGISTERING
17.12.2015 16:53:24.481 *INFO* [FelixStartLevel] com.adobe.granite.repository Service [511, [java.lang.Runnable]] ServiceEvent UNREGISTERING
17.12.2015 16:53:24.483 *INFO* [FelixStartLevel] com.adobe.granite.repository Service [512, [org.apache.jackrabbit.oak.api.jmx.IndexStatsMBean]] ServiceEvent UNREGISTERING
17.12.2015 16:53:24.485 *INFO* [FelixStartLevel] com.adobe.granite.repository Service [513, [java.lang.RunnableAdapterble]] ServiceEvent UNREGISTERING
17.12.2015 16:53:24.486 *INFO* [FelixStartLevel] com.adobe.granite.repository Service [514, [org.apache.jackrabbit.oak.plugins.index.property.jmx.PropertyIndexAsyncReindexMBean]] ServiceEvent UNREGISTERING
17.12.2015 16:53:24.488 *INFO* [FelixStartLevel] com.adobe.granite.repository Service [515, [org.apache.jackrabbit.oak.plugins.index.counter.jmx.NodeCounterMBean]] ServiceEvent UNREGISTERING
17.12.2015 16:53:24.490 *INFO* [FelixStartLevel] com.adobe.granite.repository Service [516, [org.apache.jackrabbit.oak.api.jmx.QueryEngineSettingsMBean]] ServiceEvent UNREGISTERING
17.12.2015 16:53:24.491 *INFO* [FelixStartLevel] com.adobe.granite.repository Service [517, [org.apache.jackrabbit.oak.api.jmx.RepositoryManagementMBean]] ServiceEvent UNREGISTERING
17.12.2015 16:53:24.494 *WARN* [FelixStartLevel] org.apache.jackrabbit.oak.osgi.OsgiWhiteboard Error unregistering service: com.adobe.granite.repository.impl.SlingRepositoryManager$1@20eec2a6 of type java.util.concurrent.Executor
java.lang.IllegalStateException: Service already unregistered.
	at org.apache.felix.framework.ServiceRegistrationImpl.unregister(ServiceRegistrationImpl.java:136)
	at org.apache.jackrabbit.oak.osgi.OsgiWhiteboard$1.unregister(OsgiWhiteboard.java:81)
	at org.apache.jackrabbit.oak.spi.whiteboard.CompositeRegistration.unregister(CompositeRegistration.java:43)
	at org.apache.jackrabbit.oak.Oak$6.close(Oak.java:592)
	at com.adobe.granite.repository.impl.CRX3RepositoryImpl.shutdown(CRX3RepositoryImpl.java:124)
	at com.adobe.granite.repository.impl.SlingRepositoryManager.disposeRepository(SlingRepositoryManager.java:308)
	at org.apache.sling.jcr.base.AbstractSlingRepositoryManager.stop(AbstractSlingRepositoryManager.java:361)
	at com.adobe.granite.repository.impl.SlingRepositoryManager.deactivate(SlingRepositoryManager.java:282)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:606)
	at org.apache.felix.scr.impl.helper.BaseMethod.invokeMethod(BaseMethod.java:222)
	at org.apache.felix.scr.impl.helper.BaseMethod.access$500(BaseMethod.java:37)
	at org.apache.felix.scr.impl.helper.BaseMethod$Resolved.invoke(BaseMethod.java:615)
	at org.apache.felix.scr.impl.helper.BaseMethod.invoke(BaseMethod.java:499)
	at org.apache.felix.scr.impl.helper.ActivateMethod.invoke(ActivateMethod.java:295)
	at org.apache.felix.scr.impl.manager.SingleComponentManager.disposeImplementationObject(SingleComponentManager.java:342)
	at org.apache.felix.scr.impl.manager.SingleComponentManager.deleteComponent(SingleComponentManager.java:157)
	at org.apache.felix.scr.impl.manager.AbstractComponentManager.doDeactivate(AbstractComponentManager.java:783)
	at org.apache.felix.scr.impl.manager.AbstractComponentManager.deactivateInternal(AbstractComponentManager.java:757)
	at org.apache.felix.scr.impl.manager.DependencyManager$SingleStaticCustomizer.removedService(DependencyManager.java:970)
	at org.apache.felix.scr.impl.manager.DependencyManager$SingleStaticCustomizer.removedService(DependencyManager.java:891)
	at org.apache.felix.scr.impl.manager.ServiceTracker$Tracked.customizerRemoved(ServiceTracker.java:1518)
	at org.apache.felix.scr.impl.manager.ServiceTracker$Tracked.customizerRemoved(ServiceTracker.java:1413)
	at org.apache.felix.scr.impl.manager.ServiceTracker$AbstractTracked.untrack(ServiceTracker.java:1273)
	at org.apache.felix.scr.impl.manager.ServiceTracker$Tracked.serviceChanged(ServiceTracker.java:1452)
	at org.apache.felix.framework.util.EventDispatcher.invokeServiceListenerCallback(EventDispatcher.java:987)
	at org.apache.felix.framework.util.EventDispatcher.fireEventImmediately(EventDispatcher.java:838)
	at org.apache.felix.framework.util.EventDispatcher.fireServiceEvent(EventDispatcher.java:545)
	at org.apache.felix.framework.Felix.fireServiceEvent(Felix.java:4547)
	at org.apache.felix.framework.Felix.access$000(Felix.java:106)
	at org.apache.felix.framework.Felix$1.serviceChanged(Felix.java:436)
	at org.apache.felix.framework.ServiceRegistry.unregisterService(ServiceRegistry.java:165)
	at org.apache.felix.framework.ServiceRegistrationImpl.unregister(ServiceRegistrationImpl.java:140)
	at org.apache.sling.commons.threads.impl.Activator.stop(Activator.java:67)
	at org.apache.felix.framework.util.SecureAction.stopActivator(SecureAction.java:719)
	at org.apache.felix.framework.Felix.stopBundle(Felix.java:2607)
	at org.apache.felix.framework.Felix.setActiveStartLevel(Felix.java:1386)
	at org.apache.felix.framework.FrameworkStartLevelImpl.run(FrameworkStartLevelImpl.java:308)
	at java.lang.Thread.run(Thread.java:745)
17.12.2015 16:53:24.494 *WARN* [FelixStartLevel] org.apache.jackrabbit.oak.osgi.OsgiWhiteboard Error unregistering service: org.apache.jackrabbit.oak.plugins.index.AsyncIndexUpdate@56eee6d5 of type java.lang.Runnable
java.lang.IllegalStateException: Service already unregistered.
	at org.apache.felix.framework.ServiceRegistrationImpl.unregister(ServiceRegistrationImpl.java:136)
	at org.apache.jackrabbit.oak.osgi.OsgiWhiteboard$1.unregister(OsgiWhiteboard.java:81)
	at org.apache.jackrabbit.oak.spi.whiteboard.CompositeRegistration.unregister(CompositeRegistration.java:43)
	at org.apache.jackrabbit.oak.Oak$6.close(Oak.java:592)
	at com.adobe.granite.repository.impl.CRX3RepositoryImpl.shutdown(CRX3RepositoryImpl.java:124)
	at com.adobe.granite.repository.impl.SlingRepositoryManager.disposeRepository(SlingRepositoryManager.java:308)
	at org.apache.sling.jcr.base.AbstractSlingRepositoryManager.stop(AbstractSlingRepositoryManager.java:361)
	at com.adobe.granite.repository.impl.SlingRepositoryManager.deactivate(SlingRepositoryManager.java:282)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:606)
	at org.apache.felix.scr.impl.helper.BaseMethod.invokeMethod(BaseMethod.java:222)
	at org.apache.felix.scr.impl.helper.BaseMethod.access$500(BaseMethod.java:37)
	at org.apache.felix.scr.impl.helper.BaseMethod$Resolved.invoke(BaseMethod.java:615)
	at org.apache.felix.scr.impl.helper.BaseMethod.invoke(BaseMethod.java:499)
	at org.apache.felix.scr.impl.helper.ActivateMethod.invoke(ActivateMethod.java:295)
	at org.apache.felix.scr.impl.manager.SingleComponentManager.disposeImplementationObject(SingleComponentManager.java:342)
	at org.apache.felix.scr.impl.manager.SingleComponentManager.deleteComponent(SingleComponentManager.java:157)
	at org.apache.felix.scr.impl.manager.AbstractComponentManager.doDeactivate(AbstractComponentManager.java:783)
	at org.apache.felix.scr.impl.manager.AbstractComponentManager.deactivateInternal(AbstractComponentManager.java:757)
	at org.apache.felix.scr.impl.manager.DependencyManager$SingleStaticCustomizer.removedService(DependencyManager.java:970)
	at org.apache.felix.scr.impl.manager.DependencyManager$SingleStaticCustomizer.removedService(DependencyManager.java:891)
	at org.apache.felix.scr.impl.manager.ServiceTracker$Tracked.customizerRemoved(ServiceTracker.java:1518)
	at org.apache.felix.scr.impl.manager.ServiceTracker$Tracked.customizerRemoved(ServiceTracker.java:1413)
	at org.apache.felix.scr.impl.manager.ServiceTracker$AbstractTracked.untrack(ServiceTracker.java:1273)
	at org.apache.felix.scr.impl.manager.ServiceTracker$Tracked.serviceChanged(ServiceTracker.java:1452)
	at org.apache.felix.framework.util.EventDispatcher.invokeServiceListenerCallback(EventDispatcher.java:987)
	at org.apache.felix.framework.util.EventDispatcher.fireEventImmediately(EventDispatcher.java:838)
	at org.apache.felix.framework.util.EventDispatcher.fireServiceEvent(EventDispatcher.java:545)
	at org.apache.felix.framework.Felix.fireServiceEvent(Felix.java:4547)
	at org.apache.felix.framework.Felix.access$000(Felix.java:106)
	at org.apache.felix.framework.Felix$1.serviceChanged(Felix.java:436)
	at org.apache.felix.framework.ServiceRegistry.unregisterService(ServiceRegistry.java:165)
	at org.apache.felix.framework.ServiceRegistrationImpl.unregister(ServiceRegistrationImpl.java:140)
	at org.apache.sling.commons.threads.impl.Activator.stop(Activator.java:67)
	at org.apache.felix.framework.util.SecureAction.stopActivator(SecureAction.java:719)
	at org.apache.felix.framework.Felix.stopBundle(Felix.java:2607)
	at org.apache.felix.framework.Felix.setActiveStartLevel(Felix.java:1386)
	at org.apache.felix.framework.FrameworkStartLevelImpl.run(FrameworkStartLevelImpl.java:308)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15121316" author="chetanm" created="Thu, 28 Jan 2016 12:24:40 +0000"  >&lt;p&gt;&lt;tt&gt;AsyncIndexUpdate&lt;/tt&gt; logic ensures that if any exception comes then the lease is released in the finally block. However this would fail if the exception comes in actual release of lease itself. This can occur in following ways&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;Some exception occurs and lease is to be released but thread is interrupted - In this case SegmentNodeStore would throw exception during merge call. Note that SegmentNodeStore is still active
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;17.12.2015 16:53:24.364 *WARN* [pool-8-thread-3] org.apache.jackrabbit.oak.plugins.index.AsyncIndexUpdate [async] The index update failed
org.apache.jackrabbit.oak.api.CommitFailedException: OakSegment0002: Merge interrupted
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeStore.merge(SegmentNodeStore.java:216)
	at org.apache.jackrabbit.oak.spi.state.ProxyNodeStore.merge(ProxyNodeStore.java:43)
	at org.apache.jackrabbit.oak.plugins.index.AsyncIndexUpdate.mergeWithConcurrencyCheck(AsyncIndexUpdate.java:454)
	at org.apache.jackrabbit.oak.plugins.index.AsyncIndexUpdate.access$400(AsyncIndexUpdate.java:76)
	at org.apache.jackrabbit.oak.plugins.index.AsyncIndexUpdate$AsyncUpdateCallback.close(AsyncIndexUpdate.java:242)
	at org.apache.jackrabbit.oak.plugins.index.AsyncIndexUpdate.updateIndex(AsyncIndexUpdate.java:415)
	at org.apache.jackrabbit.oak.plugins.index.AsyncIndexUpdate.run(AsyncIndexUpdate.java:323)
	at org.apache.sling.commons.scheduler.impl.QuartzJobExecutor.execute(QuartzJobExecutor.java:105)
	at org.quartz.core.JobRunShell.run(JobRunShell.java:202)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
	at java.lang.Thread.run(Thread.java:745)
Caused by: java.lang.InterruptedException: null
	at java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireSharedInterruptibly(AbstractQueuedSynchronizer.java:1301)
	at java.util.concurrent.Semaphore.acquire(Semaphore.java:317)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeStore.merge(SegmentNodeStore.java:205)
	... 11 common frames omitted
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
	&lt;li&gt;SegementNodeStore service itself has gone away
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;21.01.2016 11:56:51.964 *WARN* [sling-default-4] org.apache.jackrabbit.oak.plugins.index.AsyncIndexUpdate [async] The index update failed
java.lang.IllegalStateException: service must be activated when used
	at com.google.common.base.Preconditions.checkState(Preconditions.java:150)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeStoreService.getNodeStore(SegmentNodeStoreService.java:233)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeStoreService.getNodeStore(SegmentNodeStoreService.java:92)
	at org.apache.jackrabbit.oak.spi.state.ProxyNodeStore.getRoot(ProxyNodeStore.java:36)
	at org.apache.jackrabbit.oak.plugins.index.AsyncIndexUpdate$AsyncUpdateCallback.close(AsyncIndexUpdate.java:266)
	at org.apache.jackrabbit.oak.plugins.index.AsyncIndexUpdate.updateIndex(AsyncIndexUpdate.java:451)
	at org.apache.jackrabbit.oak.plugins.index.AsyncIndexUpdate.run(AsyncIndexUpdate.java:351)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;For #1 we cannot do much. It depends upon host app to not call interrupt and allow graceful exit. For Sling apps this should get better with &lt;a href=&quot;https://issues.apache.org/jira/browse/SLING-5416&quot; title=&quot;Thread Pool should stop &amp;quot;gracefully&amp;quot;&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SLING-5416&quot;&gt;&lt;del&gt;SLING-5416&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;A situation like #2 can occur in following way&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;System is in shutdown mode&lt;/li&gt;
	&lt;li&gt;NodeStore service is about to unregister&lt;/li&gt;
	&lt;li&gt;Before that an AsyncIndexUpdate job starts and proceeds for diff&lt;/li&gt;
	&lt;li&gt;As NodeStore is about to go now &lt;tt&gt;RepositoryManager&lt;/tt&gt; deactivates and closes the &lt;tt&gt;ContentRepository&lt;/tt&gt; and unregisters all the scheduled task. In Sling world this would cause the Quartz Scheduler to remove the scheduled task. However current running task would continue to execute&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;RepositoryManager&lt;/tt&gt; deactivates  and &lt;tt&gt;NodeStore&lt;/tt&gt; shuts down&lt;/li&gt;
	&lt;li&gt;This causes exception in async update task processing and it attempts to release the lease&lt;/li&gt;
	&lt;li&gt;As NodeStore is attempt to release the lease fails&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;To fix this at #4 we need to ensure that &lt;tt&gt;RepositoryManager&lt;/tt&gt; only deactivates after any running task gets completed. This can be done by&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;AsyncIndexUpdate implements Closeable&lt;/li&gt;
	&lt;li&gt;It has a semaphore for permit to run the job&lt;/li&gt;
	&lt;li&gt;Upon deactivation in Oak#close all &lt;tt&gt;AsyncIndexUpdate&lt;/tt&gt; are closed&lt;/li&gt;
	&lt;li&gt;In close it sets up a flag that close is requested and then it attempts to acquire a permit semaphore. It would wait till it gets the permit&lt;/li&gt;
	&lt;li&gt;AsyncIndexUpdate updated callback would check if close is set and throws exception&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thomasm&quot; class=&quot;user-hover&quot; rel=&quot;thomasm&quot;&gt;thomasm&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=alexparvulescu&quot; class=&quot;user-hover&quot; rel=&quot;alexparvulescu&quot;&gt;alexparvulescu&lt;/a&gt; Thoughts?&lt;/p&gt;
</comment>
                            <comment id="15121687" author="alex.parvulescu" created="Thu, 28 Jan 2016 15:25:17 +0000"  >&lt;blockquote&gt;&lt;p&gt;To fix this at #4 we need to ensure that RepositoryManager only deactivates after any running task gets completed. This can be done by&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Or by basically &lt;em&gt;trying&lt;/em&gt; to make en effort to signal the ongoing job to finish earlier, which is included in the proposed fix already, but I wanted to clarify this anyway.&lt;br/&gt;
I like the outline of the idea, seems like a very reasonable fix.&lt;/p&gt;</comment>
                            <comment id="15122067" author="chetanm" created="Thu, 28 Jan 2016 18:39:35 +0000"  >&lt;p&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12784990/12784990_OAK-3923-v1.patch&quot; title=&quot;OAK-3923-v1.patch attached to OAK-3923&quot;&gt;proposed patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; implementing above approach.&lt;/p&gt;

&lt;p&gt;Main points&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;AsyncIndexUpdate implements &lt;tt&gt;Cloaseable&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;Close call has following flow
	&lt;ol&gt;
		&lt;li&gt;First it checks if any indexing run is in progress. Then it waits for &lt;tt&gt;softTimeOut&lt;/tt&gt; (default 2 mins) to let run complete fine&lt;/li&gt;
		&lt;li&gt;If the async run is still in progress then it sets the &lt;tt&gt;stopFlag&lt;/tt&gt; so as to *force&quot; async index take notice of close call. Async logic would check the &lt;tt&gt;stopFlag&lt;/tt&gt; in &lt;tt&gt;indexUpdated&lt;/tt&gt; callback and would throw a &lt;tt&gt;CommitFailedException&lt;/tt&gt; to unwind&lt;/li&gt;
		&lt;li&gt;If &lt;tt&gt;stopFlag&lt;/tt&gt; is not noticed for &lt;tt&gt;hardTimeOut&lt;/tt&gt; then close call gives up&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
	&lt;li&gt;AsyncIndexUpdate run method is now changed to first acquire the &lt;tt&gt;runPermit&lt;/tt&gt;. If close is initiated then this permit cannot be obtained and run would be skipped&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;Oak&lt;/tt&gt; would register all &lt;tt&gt;AyncIndexUpdate&lt;/tt&gt; with &lt;tt&gt;Closer&lt;/tt&gt; such that they get closed upon repository close&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=alex.parvulescu&quot; class=&quot;user-hover&quot; rel=&quot;alex.parvulescu&quot;&gt;alex.parvulescu&lt;/a&gt; Can you review the patch. Due to bit elaborate logging flow in &lt;tt&gt;close&lt;/tt&gt; method might be not clear. So have a closer look!. Test case for this required bit of jumping around so look complex but fear not &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="15123204" author="alex.parvulescu" created="Fri, 29 Jan 2016 08:56:39 +0000"  >&lt;p&gt;+1 very nice! it took some time to walk though the patch, but it&apos;s made of the good stuff &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;one very minor thing: a log.info message needs a an extra space: &quot;&lt;span class=&quot;error&quot;&gt;&amp;#91;CLOSED OK&amp;#93;&lt;/span&gt;Async indexing&quot; -&amp;gt; &quot;&lt;span class=&quot;error&quot;&gt;&amp;#91;CLOSED OK&amp;#93;&lt;/span&gt; Async indexing&quot; &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;one thing I&apos;m worried about is the verbosity of logging in the patch. Given the frequency of the indexer(s) I imagine this will happen a lot, so does it make sense to have it report almost all of these messages on &lt;em&gt;info&lt;/em&gt; / &lt;em&gt;warn&lt;/em&gt;? My suggestion is to minimize the noise as much as possible and set all logs from &lt;tt&gt;run&lt;/tt&gt; and &lt;tt&gt;close&lt;/tt&gt; to &lt;em&gt;debug&lt;/em&gt;. If the hard limit is reached there&apos;s going to the the &lt;tt&gt;INTERRUPTED&lt;/tt&gt; error in the logs anyway, that&apos;s plenty to signal what&apos;s going on.&lt;br/&gt;
Thinking about the &lt;tt&gt;INTERRUPTED&lt;/tt&gt; error, does it make sense to make it even clearer that it is considered a normal operations process, and not a failure? how about instead of &apos;Indexing stopped&apos; we say &apos;Indexing forcibly stopped due to shutdown&apos;, or something?&lt;/p&gt;
</comment>
                            <comment id="15123261" author="chetanm" created="Fri, 29 Jan 2016 09:40:18 +0000"  >&lt;p&gt;Thanks Alex for the review!&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;one thing I&apos;m worried about is the verbosity of logging in the patch. Given the frequency of the indexer(s) I imagine this will happen a lot&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;No the logs should come only 1-2 times in a given start stop cycle as they are done from close method. Remember that AsyncIndexUpdate job is unscheduled first via the close of CompositeRegistration of job reg in Oak#close and then only the task is closed. So that should avoid the case where close is signalled and run is being attempted&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;My suggestion is to minimize the noise as much as possible and set all logs from run and close to debug.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Makes sense. The logs were more for aiding the testcase to assert and also to help us analyze such situations where close is being done forcibly&lt;/p&gt;
</comment>
                            <comment id="15123298" author="chetanm" created="Fri, 29 Jan 2016 10:07:59 +0000"  >&lt;p&gt;Applied modified patch incorporating Alex&apos;s suggestion in 1727508&lt;/p&gt;</comment>
                            <comment id="15125857" author="chetanm" created="Mon, 1 Feb 2016 07:10:38 +0000"  >&lt;p&gt;Updated close call logic to support multiple calls to &lt;tt&gt;close&lt;/tt&gt; method with 1727893&lt;/p&gt;</comment>
                            <comment id="15138394" author="chetanm" created="Tue, 9 Feb 2016 06:04:54 +0000"  >&lt;p&gt;Merged to 1.2 with 1729314&lt;/p&gt;</comment>
                            <comment id="15361194" author="chetanm" created="Mon, 4 Jul 2016 11:35:53 +0000"  >&lt;p&gt;Merged to 1.0 with 1751250&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12934777">OAK-3944</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12927225">OAK-3834</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12935032">OAK-3952</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12742399">OAK-2108</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12941276">OAK-4035</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12784990" name="OAK-3923-v1.patch" size="18520" author="chetanm" created="Thu, 28 Jan 2016 18:39:35 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 19 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2ryuv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>