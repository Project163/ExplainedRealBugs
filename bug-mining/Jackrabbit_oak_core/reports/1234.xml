<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:48:04 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-2401] SegmentNodeStoreService prone to deadlocks</title>
                <link>https://issues.apache.org/jira/browse/OAK-2401</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;The SegmentNodeStoreService is prone to deadlocks because of the way in which is synchronizes access to the &lt;em&gt;SegmentNodeStore&lt;/em&gt; delegate.&lt;/p&gt;

&lt;p&gt;The issue can now be seen on #deactivate, when the deregistration is being synchronously broadcast and if a referring service calls #getNodeStore the deadlock happens.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Found one Java-level deadlock:
=============================
&lt;span class=&quot;code-quote&quot;&gt;&quot;qtp844483043-936&quot;&lt;/span&gt;:
  waiting to lock monitor 0x000001d1aacc7208 (object 0x000001d231f52698, a org.apache.jackrabbit.oak.plugins.segment.SegmentNodeStoreService),
  which is held by &lt;span class=&quot;code-quote&quot;&gt;&quot;CM Event Dispatcher (Fire ConfigurationEvent: pid=org.apache.jackrabbit.oak.plugins.segment.SegmentNodeStoreService)&quot;&lt;/span&gt;
&lt;span class=&quot;code-quote&quot;&gt;&quot;CM Event Dispatcher (Fire ConfigurationEvent: pid=org.apache.jackrabbit.oak.plugins.segment.SegmentNodeStoreService)&quot;&lt;/span&gt;:
  waiting to lock monitor 0x000001d4d0907c88 (object 0x000001d2334be930, a java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;),
  which is held by &lt;span class=&quot;code-quote&quot;&gt;&quot;pool-5-thread-4&quot;&lt;/span&gt;
&lt;span class=&quot;code-quote&quot;&gt;&quot;pool-5-thread-4&quot;&lt;/span&gt;:
  waiting to lock monitor 0x000001d1aacc7208 (object 0x000001d231f52698, a org.apache.jackrabbit.oak.plugins.segment.SegmentNodeStoreService),
  which is held by &lt;span class=&quot;code-quote&quot;&gt;&quot;CM Event Dispatcher (Fire ConfigurationEvent: pid=org.apache.jackrabbit.oak.plugins.segment.SegmentNodeStoreService)&quot;&lt;/span&gt;

Java stack information &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the threads listed above:
===================================================
&lt;span class=&quot;code-quote&quot;&gt;&quot;qtp844483043-936&quot;&lt;/span&gt;:
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeStoreService.getNodeStore(SegmentNodeStoreService.java:144)
	- waiting to lock &amp;lt;0x000001d231f52698&amp;gt; (a org.apache.jackrabbit.oak.plugins.segment.SegmentNodeStoreService)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeStoreService.getNodeStore(SegmentNodeStoreService.java:73)
	at org.apache.jackrabbit.oak.spi.state.ProxyNodeStore.getRoot(ProxyNodeStore.java:35)
	at org.apache.jackrabbit.oak.core.MutableRoot.&amp;lt;init&amp;gt;(MutableRoot.java:160)
	at org.apache.jackrabbit.oak.core.ContentSessionImpl.getLatestRoot(ContentSessionImpl.java:110)
	at org.apache.jackrabbit.oak.spi.security.authentication.AbstractLoginModule.getRoot(AbstractLoginModule.java:403)
	at org.apache.jackrabbit.oak.security.authentication.token.TokenLoginModule.getTokenProvider(TokenLoginModule.java:215)
	at org.apache.jackrabbit.oak.security.authentication.token.TokenLoginModule.login(TokenLoginModule.java:128)
	at org.apache.felix.jaas.boot.ProxyLoginModule.login(ProxyLoginModule.java:52)
	at sun.reflect.GeneratedMethodAccessor65.invoke(Unknown Source)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:606)
	at javax.security.auth.login.LoginContext.invoke(LoginContext.java:762)
	at javax.security.auth.login.LoginContext.access$000(LoginContext.java:203)
	at javax.security.auth.login.LoginContext$4.run(LoginContext.java:690)
	at javax.security.auth.login.LoginContext$4.run(LoginContext.java:688)
	at java.security.AccessController.doPrivileged(Native Method)
	at javax.security.auth.login.LoginContext.invokePriv(LoginContext.java:687)
	at javax.security.auth.login.LoginContext.login(LoginContext.java:595)
	at org.apache.jackrabbit.oak.core.ContentRepositoryImpl.login(ContentRepositoryImpl.java:161)
	at org.apache.jackrabbit.oak.jcr.repository.RepositoryImpl.login(RepositoryImpl.java:256)
	at com.adobe.granite.repository.impl.CRX3RepositoryImpl.login(CRX3RepositoryImpl.java:92)
	at org.apache.jackrabbit.oak.jcr.repository.RepositoryImpl.login(RepositoryImpl.java:197)
	at org.apache.sling.jcr.base.AbstractSlingRepository2.login(AbstractSlingRepository2.java:297)
	at org.apache.sling.jcr.resource.internal.helper.jcr.JcrResourceProviderFactory.getResourceProviderInternal(JcrResourceProviderFactory.java:289)
	at org.apache.sling.jcr.resource.internal.helper.jcr.JcrResourceProviderFactory.getResourceProvider(JcrResourceProviderFactory.java:201)
	at org.apache.sling.resourceresolver.impl.tree.ResourceProviderFactoryHandler.login(ResourceProviderFactoryHandler.java:164)
	at org.apache.sling.resourceresolver.impl.tree.RootResourceProviderEntry.loginToRequiredFactories(RootResourceProviderEntry.java:95)
	at org.apache.sling.resourceresolver.impl.CommonResourceResolverFactoryImpl.getResourceResolverInternal(CommonResourceResolverFactoryImpl.java:109)
	at org.apache.sling.resourceresolver.impl.CommonResourceResolverFactoryImpl.getResourceResolver(CommonResourceResolverFactoryImpl.java:90)
	at org.apache.sling.resourceresolver.impl.ResourceResolverFactoryImpl.getResourceResolver(ResourceResolverFactoryImpl.java:93)
	at org.apache.sling.auth.core.impl.SlingAuthenticator.getAnonymousResolver(SlingAuthenticator.java:839)
	at org.apache.sling.auth.core.impl.SlingAuthenticator.doHandleSecurity(SlingAuthenticator.java:478)
	at org.apache.sling.auth.core.impl.SlingAuthenticator.handleSecurity(SlingAuthenticator.java:438)
	at org.apache.sling.engine.impl.SlingHttpContext.handleSecurity(SlingHttpContext.java:121)
	at org.apache.felix.http.base.internal.context.ServletContextImpl.handleSecurity(ServletContextImpl.java:335)
	at org.apache.felix.http.base.internal.handler.ServletHandler.doHandle(ServletHandler.java:337)
	at org.apache.felix.http.base.internal.handler.ServletHandler.handle(ServletHandler.java:300)
	at org.apache.felix.http.base.internal.dispatch.ServletPipeline.handle(ServletPipeline.java:93)
	at org.apache.felix.http.base.internal.dispatch.InvocationFilterChain.doFilter(InvocationFilterChain.java:50)
	at org.apache.felix.http.base.internal.dispatch.HttpFilterChain.doFilter(HttpFilterChain.java:31)
	at org.apache.sling.i18n.impl.I18NFilter.doFilter(I18NFilter.java:128)
	at org.apache.felix.http.base.internal.handler.FilterHandler.doHandle(FilterHandler.java:108)
	at org.apache.felix.http.base.internal.handler.FilterHandler.handle(FilterHandler.java:80)
	at org.apache.felix.http.base.internal.dispatch.InvocationFilterChain.doFilter(InvocationFilterChain.java:46)
	at org.apache.felix.http.base.internal.dispatch.HttpFilterChain.doFilter(HttpFilterChain.java:31)
	at org.apache.felix.http.sslfilter.internal.SslFilter.doFilter(SslFilter.java:55)
	at org.apache.felix.http.base.internal.handler.FilterHandler.doHandle(FilterHandler.java:108)
	at org.apache.felix.http.base.internal.handler.FilterHandler.handle(FilterHandler.java:80)
	at org.apache.felix.http.base.internal.dispatch.InvocationFilterChain.doFilter(InvocationFilterChain.java:46)
	at org.apache.felix.http.base.internal.dispatch.HttpFilterChain.doFilter(HttpFilterChain.java:31)
	at org.apache.felix.http.sslfilter.internal.SslFilter.doFilter(SslFilter.java:89)
	at org.apache.felix.http.base.internal.handler.FilterHandler.doHandle(FilterHandler.java:108)
	at org.apache.felix.http.base.internal.handler.FilterHandler.handle(FilterHandler.java:80)
	at org.apache.felix.http.base.internal.dispatch.InvocationFilterChain.doFilter(InvocationFilterChain.java:46)
	at org.apache.felix.http.base.internal.dispatch.HttpFilterChain.doFilter(HttpFilterChain.java:31)
	at com.adobe.granite.license.impl.LicenseCheckFilter.doFilter(LicenseCheckFilter.java:298)
	at org.apache.felix.http.base.internal.handler.FilterHandler.doHandle(FilterHandler.java:108)
	at org.apache.felix.http.base.internal.handler.FilterHandler.handle(FilterHandler.java:80)
	at org.apache.felix.http.base.internal.dispatch.InvocationFilterChain.doFilter(InvocationFilterChain.java:46)
	at org.apache.felix.http.base.internal.dispatch.HttpFilterChain.doFilter(HttpFilterChain.java:31)
	at org.apache.sling.security.impl.ReferrerFilter.doFilter(ReferrerFilter.java:290)
	at org.apache.felix.http.base.internal.handler.FilterHandler.doHandle(FilterHandler.java:108)
	at org.apache.felix.http.base.internal.handler.FilterHandler.handle(FilterHandler.java:80)
	at org.apache.felix.http.base.internal.dispatch.InvocationFilterChain.doFilter(InvocationFilterChain.java:46)
	at org.apache.felix.http.base.internal.dispatch.HttpFilterChain.doFilter(HttpFilterChain.java:31)
	at org.apache.sling.featureflags.impl.FeatureManager.doFilter(FeatureManager.java:115)
	at org.apache.felix.http.base.internal.handler.FilterHandler.doHandle(FilterHandler.java:108)
	at org.apache.felix.http.base.internal.handler.FilterHandler.handle(FilterHandler.java:80)
	at org.apache.felix.http.base.internal.dispatch.InvocationFilterChain.doFilter(InvocationFilterChain.java:46)
	at org.apache.felix.http.base.internal.dispatch.HttpFilterChain.doFilter(HttpFilterChain.java:31)
	at org.apache.sling.engine.impl.log.RequestLoggerFilter.doFilter(RequestLoggerFilter.java:75)
	at org.apache.felix.http.base.internal.handler.FilterHandler.doHandle(FilterHandler.java:108)
	at org.apache.felix.http.base.internal.handler.FilterHandler.handle(FilterHandler.java:80)
	at org.apache.felix.http.base.internal.dispatch.InvocationFilterChain.doFilter(InvocationFilterChain.java:46)
	at org.apache.felix.http.base.internal.dispatch.HttpFilterChain.doFilter(HttpFilterChain.java:31)
	at org.apache.felix.http.base.internal.dispatch.FilterPipeline.dispatch(FilterPipeline.java:76)
	at org.apache.felix.http.base.internal.dispatch.Dispatcher.dispatch(Dispatcher.java:49)
	at org.apache.felix.http.base.internal.DispatcherServlet.service(DispatcherServlet.java:67)
	at javax.servlet.http.HttpServlet.service(HttpServlet.java:722)
	at org.eclipse.jetty.servlet.ServletHolder.handle(ServletHolder.java:684)
	at org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:501)
	at org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:229)
	at org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1086)
	at org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:428)
	at org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:193)
	at org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1020)
	at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:135)
	at org.eclipse.jetty.server.handler.ContextHandlerCollection.handle(ContextHandlerCollection.java:255)
	at org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:116)
	at org.eclipse.jetty.server.Server.handle(Server.java:370)
	at org.eclipse.jetty.server.AbstractHttpConnection.handleRequest(AbstractHttpConnection.java:494)
	at org.eclipse.jetty.server.AbstractHttpConnection.headerComplete(AbstractHttpConnection.java:971)
	at org.eclipse.jetty.server.AbstractHttpConnection$RequestHandler.headerComplete(AbstractHttpConnection.java:1033)
	at org.eclipse.jetty.http.HttpParser.parseNext(HttpParser.java:644)
	at org.eclipse.jetty.http.HttpParser.parseAvailable(HttpParser.java:235)
	at org.eclipse.jetty.server.AsyncHttpConnection.handle(AsyncHttpConnection.java:82)
	at org.eclipse.jetty.io.nio.SelectChannelEndPoint.handle(SelectChannelEndPoint.java:667)
	at org.eclipse.jetty.io.nio.SelectChannelEndPoint$1.run(SelectChannelEndPoint.java:52)
	at org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:608)
	at org.eclipse.jetty.util.thread.QueuedThreadPool$3.run(QueuedThreadPool.java:543)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
&lt;span class=&quot;code-quote&quot;&gt;&quot;CM Event Dispatcher (Fire ConfigurationEvent: pid=org.apache.jackrabbit.oak.plugins.segment.SegmentNodeStoreService)&quot;&lt;/span&gt;:
	at org.apache.sling.discovery.impl.DiscoveryServiceImpl.unbindTopologyEventListener(DiscoveryServiceImpl.java:242)
	- waiting to lock &amp;lt;0x000001d2334be930&amp;gt; (a java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:606)
	at org.apache.felix.scr.impl.helper.BaseMethod.invokeMethod(BaseMethod.java:231)
	at org.apache.felix.scr.impl.helper.BaseMethod.access$500(BaseMethod.java:39)
	at org.apache.felix.scr.impl.helper.BaseMethod$Resolved.invoke(BaseMethod.java:624)
	at org.apache.felix.scr.impl.helper.BaseMethod.invoke(BaseMethod.java:508)
	at org.apache.felix.scr.impl.helper.BindMethod.invoke(BindMethod.java:37)
	at org.apache.felix.scr.impl.manager.DependencyManager.invokeUnbindMethod(DependencyManager.java:1717)
	at org.apache.felix.scr.impl.manager.SingleComponentManager.invokeUnbindMethod(SingleComponentManager.java:404)
	at org.apache.felix.scr.impl.manager.DependencyManager$MultipleDynamicCustomizer.removedService(DependencyManager.java:376)
	at org.apache.felix.scr.impl.manager.DependencyManager$MultipleDynamicCustomizer.removedService(DependencyManager.java:304)
	at org.apache.felix.scr.impl.manager.ServiceTracker$Tracked.customizerRemoved(ServiceTracker.java:1506)
	at org.apache.felix.scr.impl.manager.ServiceTracker$Tracked.customizerRemoved(ServiceTracker.java:1401)
	at org.apache.felix.scr.impl.manager.ServiceTracker$AbstractTracked.untrack(ServiceTracker.java:1261)
	at org.apache.felix.scr.impl.manager.ServiceTracker$Tracked.serviceChanged(ServiceTracker.java:1440)
	at org.apache.felix.framework.util.EventDispatcher.invokeServiceListenerCallback(EventDispatcher.java:940)
	at org.apache.felix.framework.util.EventDispatcher.fireEventImmediately(EventDispatcher.java:794)
	at org.apache.felix.framework.util.EventDispatcher.fireServiceEvent(EventDispatcher.java:544)
	at org.apache.felix.framework.Felix.fireServiceEvent(Felix.java:4425)
	at org.apache.felix.framework.Felix.access$000(Felix.java:75)
	at org.apache.felix.framework.Felix$1.serviceChanged(Felix.java:402)
	at org.apache.felix.framework.ServiceRegistry.unregisterService(ServiceRegistry.java:153)
	at org.apache.felix.framework.ServiceRegistrationImpl.unregister(ServiceRegistrationImpl.java:128)
	at org.apache.felix.scr.impl.manager.AbstractComponentManager$3.unregister(AbstractComponentManager.java:1011)
	at org.apache.felix.scr.impl.manager.AbstractComponentManager$3.unregister(AbstractComponentManager.java:992)
	at org.apache.felix.scr.impl.manager.RegistrationManager.changeRegistration(RegistrationManager.java:141)
	at org.apache.felix.scr.impl.manager.AbstractComponentManager.unregisterService(AbstractComponentManager.java:1054)
	at org.apache.felix.scr.impl.manager.AbstractComponentManager.doDeactivate(AbstractComponentManager.java:900)
	at org.apache.felix.scr.impl.manager.AbstractComponentManager.deactivateInternal(AbstractComponentManager.java:883)
	at org.apache.felix.scr.impl.manager.DependencyManager$SingleStaticCustomizer.removedService(DependencyManager.java:974)
	at org.apache.felix.scr.impl.manager.DependencyManager$SingleStaticCustomizer.removedService(DependencyManager.java:895)
	at org.apache.felix.scr.impl.manager.ServiceTracker$Tracked.customizerRemoved(ServiceTracker.java:1506)
	at org.apache.felix.scr.impl.manager.ServiceTracker$Tracked.customizerRemoved(ServiceTracker.java:1401)
	at org.apache.felix.scr.impl.manager.ServiceTracker$AbstractTracked.untrack(ServiceTracker.java:1261)
	at org.apache.felix.scr.impl.manager.ServiceTracker$Tracked.serviceChanged(ServiceTracker.java:1440)
	at org.apache.felix.framework.util.EventDispatcher.invokeServiceListenerCallback(EventDispatcher.java:940)
	at org.apache.felix.framework.util.EventDispatcher.fireEventImmediately(EventDispatcher.java:794)
	at org.apache.felix.framework.util.EventDispatcher.fireServiceEvent(EventDispatcher.java:544)
	at org.apache.felix.framework.Felix.fireServiceEvent(Felix.java:4425)
	at org.apache.felix.framework.Felix.access$000(Felix.java:75)
	at org.apache.felix.framework.Felix$1.serviceChanged(Felix.java:402)
	at org.apache.felix.framework.ServiceRegistry.unregisterService(ServiceRegistry.java:153)
	at org.apache.felix.framework.ServiceRegistrationImpl.unregister(ServiceRegistrationImpl.java:128)
	at org.apache.sling.jcr.base.AbstractSlingRepositoryManager.unregisterService(AbstractSlingRepositoryManager.java:258)
	at org.apache.sling.jcr.base.AbstractSlingRepositoryManager.stop(AbstractSlingRepositoryManager.java:345)
	at com.adobe.granite.repository.impl.SlingRepositoryManager.deactivate(SlingRepositoryManager.java:194)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:606)
	at org.apache.felix.scr.impl.helper.BaseMethod.invokeMethod(BaseMethod.java:231)
	at org.apache.felix.scr.impl.helper.BaseMethod.access$500(BaseMethod.java:39)
	at org.apache.felix.scr.impl.helper.BaseMethod$Resolved.invoke(BaseMethod.java:624)
	at org.apache.felix.scr.impl.helper.BaseMethod.invoke(BaseMethod.java:508)
	at org.apache.felix.scr.impl.helper.ActivateMethod.invoke(ActivateMethod.java:149)
	at org.apache.felix.scr.impl.manager.SingleComponentManager.disposeImplementationObject(SingleComponentManager.java:355)
	at org.apache.felix.scr.impl.manager.SingleComponentManager.deleteComponent(SingleComponentManager.java:170)
	at org.apache.felix.scr.impl.manager.AbstractComponentManager.doDeactivate(AbstractComponentManager.java:908)
	at org.apache.felix.scr.impl.manager.AbstractComponentManager.deactivateInternal(AbstractComponentManager.java:883)
	at org.apache.felix.scr.impl.manager.DependencyManager$SingleStaticCustomizer.removedService(DependencyManager.java:974)
	at org.apache.felix.scr.impl.manager.DependencyManager$SingleStaticCustomizer.removedService(DependencyManager.java:895)
	at org.apache.felix.scr.impl.manager.ServiceTracker$Tracked.customizerRemoved(ServiceTracker.java:1506)
	at org.apache.felix.scr.impl.manager.ServiceTracker$Tracked.customizerRemoved(ServiceTracker.java:1401)
	at org.apache.felix.scr.impl.manager.ServiceTracker$AbstractTracked.untrack(ServiceTracker.java:1261)
	at org.apache.felix.scr.impl.manager.ServiceTracker$Tracked.serviceChanged(ServiceTracker.java:1440)
	at org.apache.felix.framework.util.EventDispatcher.invokeServiceListenerCallback(EventDispatcher.java:940)
	at org.apache.felix.framework.util.EventDispatcher.fireEventImmediately(EventDispatcher.java:794)
	at org.apache.felix.framework.util.EventDispatcher.fireServiceEvent(EventDispatcher.java:544)
	at org.apache.felix.framework.Felix.fireServiceEvent(Felix.java:4425)
	at org.apache.felix.framework.Felix.access$000(Felix.java:75)
	at org.apache.felix.framework.Felix$1.serviceChanged(Felix.java:402)
	at org.apache.felix.framework.ServiceRegistry.unregisterService(ServiceRegistry.java:153)
	at org.apache.felix.framework.ServiceRegistrationImpl.unregister(ServiceRegistrationImpl.java:128)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeStoreService.unregisterNodeStore(SegmentNodeStoreService.java:320)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeStoreService.deactivate(SegmentNodeStoreService.java:295)
	- locked &amp;lt;0x000001d231f52698&amp;gt; (a org.apache.jackrabbit.oak.plugins.segment.SegmentNodeStoreService)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:606)
	at org.apache.felix.scr.impl.helper.BaseMethod.invokeMethod(BaseMethod.java:231)
	at org.apache.felix.scr.impl.helper.BaseMethod.access$500(BaseMethod.java:39)
	at org.apache.felix.scr.impl.helper.BaseMethod$Resolved.invoke(BaseMethod.java:624)
	at org.apache.felix.scr.impl.helper.BaseMethod.invoke(BaseMethod.java:508)
	at org.apache.felix.scr.impl.helper.ActivateMethod.invoke(ActivateMethod.java:149)
	at org.apache.felix.scr.impl.manager.SingleComponentManager.disposeImplementationObject(SingleComponentManager.java:355)
	at org.apache.felix.scr.impl.manager.SingleComponentManager.deleteComponent(SingleComponentManager.java:170)
	at org.apache.felix.scr.impl.manager.AbstractComponentManager.doDeactivate(AbstractComponentManager.java:908)
	at org.apache.felix.scr.impl.manager.AbstractComponentManager.deactivateInternal(AbstractComponentManager.java:883)
	at org.apache.felix.scr.impl.manager.SingleComponentManager.reconfigure(SingleComponentManager.java:638)
	at org.apache.felix.scr.impl.config.ConfigurableComponentHolder.configurationUpdated(ConfigurableComponentHolder.java:328)
	at org.apache.felix.scr.impl.config.ConfigurationSupport.configurationEvent(ConfigurationSupport.java:290)
	at org.apache.felix.cm.impl.ConfigurationManager$FireConfigurationEvent.sendEvent(ConfigurationManager.java:2032)
	at org.apache.felix.cm.impl.ConfigurationManager$FireConfigurationEvent.run(ConfigurationManager.java:2002)
	at org.apache.felix.cm.impl.UpdateThread.run(UpdateThread.java:103)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
&lt;span class=&quot;code-quote&quot;&gt;&quot;pool-5-thread-4&quot;&lt;/span&gt;:
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeStoreService.getNodeStore(SegmentNodeStoreService.java:144)
	- waiting to lock &amp;lt;0x000001d231f52698&amp;gt; (a org.apache.jackrabbit.oak.plugins.segment.SegmentNodeStoreService)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeStoreService.getNodeStore(SegmentNodeStoreService.java:73)
	at org.apache.jackrabbit.oak.spi.state.ProxyNodeStore.getRoot(ProxyNodeStore.java:35)
	at org.apache.jackrabbit.oak.core.MutableRoot.&amp;lt;init&amp;gt;(MutableRoot.java:160)
	at org.apache.jackrabbit.oak.core.ContentSessionImpl.getLatestRoot(ContentSessionImpl.java:110)
	at org.apache.jackrabbit.oak.jcr.delegate.SessionDelegate.&amp;lt;init&amp;gt;(SessionDelegate.java:160)
	at org.apache.jackrabbit.oak.jcr.repository.RepositoryImpl$1.&amp;lt;init&amp;gt;(RepositoryImpl.java:273)
	at org.apache.jackrabbit.oak.jcr.repository.RepositoryImpl.createSessionDelegate(RepositoryImpl.java:271)
	at org.apache.jackrabbit.oak.jcr.repository.RepositoryImpl.login(RepositoryImpl.java:257)
	at com.adobe.granite.repository.impl.CRX3RepositoryImpl.login(CRX3RepositoryImpl.java:92)
	at com.adobe.granite.repository.impl.SlingRepositoryImpl$2.run(SlingRepositoryImpl.java:108)
	at com.adobe.granite.repository.impl.SlingRepositoryImpl$2.run(SlingRepositoryImpl.java:100)
	at java.security.AccessController.doPrivileged(Native Method)
	at javax.security.auth.Subject.doAsPrivileged(Subject.java:536)
	at com.adobe.granite.repository.impl.SlingRepositoryImpl.createAdministrativeSession(SlingRepositoryImpl.java:100)
	at org.apache.sling.jcr.base.AbstractSlingRepository2.loginAdministrative(AbstractSlingRepository2.java:362)
	at org.apache.sling.jcr.resource.internal.helper.jcr.JcrResourceProviderFactory.getResourceProviderInternal(JcrResourceProviderFactory.java:246)
	at org.apache.sling.jcr.resource.internal.helper.jcr.JcrResourceProviderFactory.getAdministrativeResourceProvider(JcrResourceProviderFactory.java:209)
	at org.apache.sling.resourceresolver.impl.tree.ResourceProviderFactoryHandler.login(ResourceProviderFactoryHandler.java:162)
	at org.apache.sling.resourceresolver.impl.tree.RootResourceProviderEntry.loginToRequiredFactories(RootResourceProviderEntry.java:95)
	at org.apache.sling.resourceresolver.impl.CommonResourceResolverFactoryImpl.getResourceResolverInternal(CommonResourceResolverFactoryImpl.java:109)
	at org.apache.sling.resourceresolver.impl.CommonResourceResolverFactoryImpl.getAdministrativeResourceResolver(CommonResourceResolverFactoryImpl.java:76)
	at org.apache.sling.resourceresolver.impl.ResourceResolverFactoryImpl.getAdministrativeResourceResolver(ResourceResolverFactoryImpl.java:98)
	at org.apache.sling.discovery.impl.cluster.ClusterViewServiceImpl.getClusterView(ClusterViewServiceImpl.java:132)
	at org.apache.sling.discovery.impl.DiscoveryServiceImpl.getTopology(DiscoveryServiceImpl.java:418)
	at org.apache.sling.discovery.impl.DiscoveryServiceImpl.handlePotentialTopologyChange(DiscoveryServiceImpl.java:466)
	at org.apache.sling.discovery.impl.DiscoveryServiceImpl.handleTopologyChanged(DiscoveryServiceImpl.java:650)
	- locked &amp;lt;0x000001d2334be930&amp;gt; (a java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;)
	at org.apache.sling.discovery.impl.topology.TopologyChangeHandler.handleTopologyChanged(TopologyChangeHandler.java:134)
	at org.apache.sling.discovery.impl.topology.TopologyChangeHandler.handleEvent(TopologyChangeHandler.java:124)
	at org.apache.felix.eventadmin.impl.handler.EventHandlerProxy.sendEvent(EventHandlerProxy.java:412)
	at org.apache.felix.eventadmin.impl.tasks.SyncDeliverTasks.execute(SyncDeliverTasks.java:118)
	at org.apache.felix.eventadmin.impl.handler.EventAdminImpl.sendEvent(EventAdminImpl.java:114)
	at org.apache.felix.eventadmin.impl.security.EventAdminSecurityDecorator.sendEvent(EventAdminSecurityDecorator.java:96)
	at org.apache.sling.jcr.resource.internal.OakResourceListener.sendOsgiEvent(OakResourceListener.java:243)
	at org.apache.sling.jcr.resource.internal.OakResourceListener.changed(OakResourceListener.java:133)
	at org.apache.jackrabbit.oak.plugins.observation.NodeObserver$NodeEventHandler.leave(NodeObserver.java:208)
	at org.apache.jackrabbit.oak.plugins.observation.FilteredHandler.leave(FilteredHandler.java:51)
	at org.apache.jackrabbit.oak.plugins.observation.EventGenerator$Continuation.run(EventGenerator.java:175)
	at org.apache.jackrabbit.oak.plugins.observation.EventGenerator.generate(EventGenerator.java:118)
	at org.apache.jackrabbit.oak.plugins.observation.NodeObserver.contentChanged(NodeObserver.java:156)
	at org.apache.jackrabbit.oak.spi.commit.BackgroundObserver$1$1.call(BackgroundObserver.java:117)
	at org.apache.jackrabbit.oak.spi.commit.BackgroundObserver$1$1.call(BackgroundObserver.java:111)
	at java.util.concurrent.FutureTask.run(FutureTask.java:262)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)

Found 1 deadlock.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12767690">OAK-2401</key>
            <summary>SegmentNodeStoreService prone to deadlocks</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="chetanm">Chetan Mehrotra</assignee>
                                    <reporter username="stillalex">Alex Deparvu</reporter>
                        <labels>
                            <label>resilience</label>
                    </labels>
                <created>Thu, 15 Jan 2015 09:29:50 +0000</created>
                <updated>Thu, 9 Jun 2016 15:24:26 +0000</updated>
                            <resolved>Mon, 29 Jun 2015 06:21:12 +0000</resolved>
                                                    <fixVersion>1.0.17</fixVersion>
                    <fixVersion>1.2.3</fixVersion>
                    <fixVersion>1.3.2</fixVersion>
                    <fixVersion>1.4</fixVersion>
                                    <component>segmentmk</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="14278484" author="alex.parvulescu" created="Thu, 15 Jan 2015 09:33:48 +0000"  >&lt;p&gt;attaching a best effort patch. I&apos;m not sure how this can be tested in an OSGi env, if it can even be tested at all.&lt;/p&gt;

&lt;p&gt;I also found some inconsistencies between registration &amp;amp; unregistration of the node store when installed with a custom blob store.&lt;br/&gt;
One more thing, a bunch of registration methods are public, not sure why, but I&apos;d like to reduce the visibility (not included in the patch).&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mduerig&quot; class=&quot;user-hover&quot; rel=&quot;mduerig&quot;&gt;mduerig&lt;/a&gt; care to take a look?&lt;/p&gt;</comment>
                            <comment id="14325679" author="alex.parvulescu" created="Wed, 18 Feb 2015 10:21:20 +0000"  >&lt;p&gt;fyi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chetanm&quot; class=&quot;user-hover&quot; rel=&quot;chetanm&quot;&gt;chetanm&lt;/a&gt; I&apos;ve set the fix version to 1.1.8 maybe you can take a quick look if time permits.&lt;/p&gt;</comment>
                            <comment id="14386634" author="mduerig" created="Mon, 30 Mar 2015 12:37:30 +0000"  >&lt;p&gt;Why can we remove the synchronization from &lt;tt&gt;deactivate&lt;/tt&gt;? Why did we need it in the first place? And, can&apos;t we also remove synchronization from the other methods? I think this class needs a deeper review. Also re. its public API.&lt;/p&gt;</comment>
                            <comment id="14550488" author="frm" created="Tue, 19 May 2015 14:10:34 +0000"  >&lt;p&gt;Synchronization in &lt;tt&gt;SegmentNodeStoreService&lt;/tt&gt; is necessary because of the dynamic tracking of &lt;tt&gt;BlobStore&lt;/tt&gt; services.&lt;/p&gt;

&lt;p&gt;The biggest issue, in my opinion, is synchronized keyword on the &lt;tt&gt;getNodeStore()&lt;/tt&gt; method. This excessive locking interferes with the lifecycle of the component in the OSGi framework.&lt;/p&gt;

&lt;p&gt;Moreover, there are some minor mistakes in the way registration and unregistration of services is done. In particular, the current version of the class fails to handle the case when &lt;tt&gt;bindBlobStore()&lt;/tt&gt; may be called right after &lt;tt&gt;activate()&lt;/tt&gt;. In this case, &lt;tt&gt;bindBlobStore()&lt;/tt&gt; must take care of the unregistration of the registered services, if any.&lt;/p&gt;

&lt;p&gt;The attached &lt;tt&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-2401&quot; title=&quot;SegmentNodeStoreService prone to deadlocks&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-2401&quot;&gt;&lt;del&gt;OAK-2401&lt;/del&gt;&lt;/a&gt;-01.patch&lt;/tt&gt; should fix these problems.&lt;/p&gt;</comment>
                            <comment id="14570694" author="mduerig" created="Wed, 3 Jun 2015 11:39:23 +0000"  >&lt;p&gt;The patch is taking the right approach AFAICS. However I feel uneasy with doing such changes to &lt;tt&gt;SegmentNodeStoreService&lt;/tt&gt; without any test coverage at all. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=frm&quot; class=&quot;user-hover&quot; rel=&quot;frm&quot;&gt;frm&lt;/a&gt;, WDYT, could you have a look at &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-2883&quot; title=&quot;Tests for SegmentNodeStoreService&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-2883&quot;&gt;&lt;del&gt;OAK-2883&lt;/del&gt;&lt;/a&gt; first?&lt;/p&gt;</comment>
                            <comment id="14570705" author="frm" created="Wed, 3 Jun 2015 11:49:32 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mduerig&quot; class=&quot;user-hover&quot; rel=&quot;mduerig&quot;&gt;mduerig&lt;/a&gt; I will attach a patch with to &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-2883&quot; title=&quot;Tests for SegmentNodeStoreService&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-2883&quot;&gt;&lt;del&gt;OAK-2883&lt;/del&gt;&lt;/a&gt; with some tests first. Once that&apos;s done, we can use those tests to validate the patch attached here.&lt;/p&gt;</comment>
                            <comment id="14572859" author="frm" created="Thu, 4 Jun 2015 14:27:19 +0000"  >&lt;p&gt;I need to attach another patch. The attached &lt;tt&gt;OAK&amp;#45;2401-01.patch&lt;/tt&gt; doesn&apos;t apply anymore because of the changes introduced in &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-2016&quot; title=&quot;Make blob gc max age configurable in SegmentNodeStoreService&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-2016&quot;&gt;&lt;del&gt;OAK-2016&lt;/del&gt;&lt;/a&gt;. Moreover, &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-2016&quot; title=&quot;Make blob gc max age configurable in SegmentNodeStoreService&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-2016&quot;&gt;&lt;del&gt;OAK-2016&lt;/del&gt;&lt;/a&gt; is probably incorrect, as explained in &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-2960&quot; title=&quot;SegmentNodeStoreService doesn&amp;#39;t fully implement a @Modified method&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-2960&quot;&gt;&lt;del&gt;OAK-2960&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="14576736" author="egli" created="Mon, 8 Jun 2015 08:25:02 +0000"  >&lt;p&gt;Marked blocker and fix version also 1.2.3 and 1.0.15 as this has been seen in production on 1.0.x recently again.&lt;/p&gt;</comment>
                            <comment id="14576822" author="edivad" created="Mon, 8 Jun 2015 09:38:52 +0000"  >&lt;p&gt;Bulk move to 1.3.1&lt;/p&gt;</comment>
                            <comment id="14581996" author="frm" created="Thu, 11 Jun 2015 14:36:58 +0000"  >&lt;p&gt;&lt;tt&gt;OAK&amp;#45;2401-02.patch&lt;/tt&gt; should be applicable on the latest trunk. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=amitjain&quot; class=&quot;user-hover&quot; rel=&quot;amitjain&quot;&gt;amitjain&lt;/a&gt;, can you take a look at it?&lt;/p&gt;</comment>
                            <comment id="14587471" author="amitjain" created="Tue, 16 Jun 2015 04:45:28 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=frm&quot; class=&quot;user-hover&quot; rel=&quot;frm&quot;&gt;frm&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I think the usage of &lt;tt&gt;ReentrantReadWriteLock&lt;/tt&gt; would still be an issue as the writeLock() is exclusive &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; (pointed to by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chetanm&quot; class=&quot;user-hover&quot; rel=&quot;chetanm&quot;&gt;chetanm&lt;/a&gt;). &lt;br/&gt;
From an offline discussion with Chetan, the option to avoid deadlocks is to have a timeout while reading(use tryLock())&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;http://stackoverflow.com/questions/18354339/reentrantreadwritelock-whats-the-difference-between-readlock-and-writelock&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://stackoverflow.com/questions/18354339/reentrantreadwritelock-whats-the-difference-between-readlock-and-writelock&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14588311" author="frm" created="Tue, 16 Jun 2015 16:18:03 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=amitjain&quot; class=&quot;user-hover&quot; rel=&quot;amitjain&quot;&gt;amitjain&lt;/a&gt;, the doubts expressed by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chetanm&quot; class=&quot;user-hover&quot; rel=&quot;chetanm&quot;&gt;chetanm&lt;/a&gt; are well founded. The real problem is that an OSGi component shouldn&apos;t call  the framework holding locks. The framework should be considered foreign code. &lt;tt&gt;SegmentNodeStoreService&lt;/tt&gt; is holding a lock when unregistering and registering services, both before and after the patch.&lt;/p&gt;

&lt;p&gt;Since &lt;tt&gt;SegmentNodeStoreService&lt;/tt&gt; is a critical component that touches the filesystem, and should do it in an exclusive way, I would suggest to apply the easiest solution possible: declare the reference to the &lt;tt&gt;BlobStore&lt;/tt&gt; to be static, greedy and optional. Static forces a reactivation every time a new service is bound to the reference. Greedy will force reactivation only if a better service is present. Optional means that the component is supposed to work even if no &lt;tt&gt;BlobStore&lt;/tt&gt; is available.&lt;/p&gt;

&lt;p&gt;This way there will be no service overlapping (e.g. two &lt;tt&gt;NodeStore&lt;/tt&gt; services registered at once), and making any changes to the configuration or publishing a better &lt;tt&gt;BlobStore&lt;/tt&gt; service will cause a complete reboot of the component. I don&apos;t think that the loss of dynamism will be a problem for this &lt;tt&gt;SegmentNodeStoreService&lt;/tt&gt;. If you all agree, I will rework the patch.&lt;/p&gt;</comment>
                            <comment id="14588440" author="frm" created="Tue, 16 Jun 2015 17:42:18 +0000"  >&lt;p&gt;&lt;tt&gt;OAK&amp;#45;2401-03.patch&lt;/tt&gt; implements the static, greedy reference to &lt;tt&gt;BlobStore&lt;/tt&gt; as described in my previous comment.&lt;/p&gt;</comment>
                            <comment id="14589325" author="chetanm" created="Wed, 17 Jun 2015 05:25:02 +0000"  >&lt;blockquote&gt;&lt;p&gt;declare the reference to the BlobStore to be static, greedy and optional&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=frm&quot; class=&quot;user-hover&quot; rel=&quot;frm&quot;&gt;frm&lt;/a&gt; Not sure if that is the problem. &lt;tt&gt;SegmentNodeStoreService&lt;/tt&gt; does not make call to foreign code from within the synchronized block (except in deactivate, explained later in comment). So its doing the right thing there. At least for this issue the problem was in Discovery as it was calling to framework while holding the locks.&lt;/p&gt;

&lt;p&gt;As you noted &lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;The biggest issue, in my opinion, is synchronized keyword on the getNodeStore() method. This excessive locking interferes with the lifecycle of the component in the OSGi framework.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The required fix here would be&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Drop synchronized from &lt;tt&gt;getNodeStore&lt;/tt&gt; and mark delegate as volatile - A NodeStore instance would only be available to outside world once it is registered with OSGi ServiceRegistery and by that time NodeStore would be properly initialized. So for startup case no call can come for &lt;tt&gt;getNodeStore&lt;/tt&gt; untill it gets initialized.&lt;/li&gt;
	&lt;li&gt;Drop synchronized from the deactivate - By contract the deactivate would only be called from a single thread. Or if we want to play safe do the unregistering part outside of synchronized. This would ensure that we do not hold any lock while calling to OSGi (which infact is the root cause of deadlock here)&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;With this change for above scenario should work fine. &lt;/p&gt;

&lt;p&gt;I think we should &lt;/p&gt;</comment>
                            <comment id="14589428" author="chetanm" created="Wed, 17 Jun 2015 07:40:12 +0000"  >&lt;p&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12740062/12740062_OAK-2401-04-testcase-fix.patch&quot; title=&quot;OAK-2401-04-testcase-fix.patch attached to OAK-2401&quot;&gt;patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; which has a testcase to reproduce the deadlock and has a potential fix&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=frm&quot; class=&quot;user-hover&quot; rel=&quot;frm&quot;&gt;frm&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=amitj_76&quot; class=&quot;user-hover&quot; rel=&quot;amitj_76&quot;&gt;amitj_76&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=alex.parvulescu&quot; class=&quot;user-hover&quot; rel=&quot;alex.parvulescu&quot;&gt;alex.parvulescu&lt;/a&gt; Can you review the patch?&lt;/p&gt;</comment>
                            <comment id="14589574" author="frm" created="Wed, 17 Jun 2015 10:02:47 +0000"  >&lt;p&gt;There is still the window open by the &lt;tt&gt;bindBlobStore()&lt;/tt&gt; and &lt;tt&gt;unbindBlobStore()&lt;/tt&gt; methods. They occur asynchronously and need synchronisation. Moreover, when a bound service is replaced with a better one, &lt;tt&gt;unbindBlobStore()&lt;/tt&gt; for the old service is called after the &lt;tt&gt;bindBlobStore()&lt;/tt&gt; for the new service, thus deregistering the new registrations made available by &lt;tt&gt;registerNodeStore()&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;The more I think about it, the more I&apos;m convinced that we should have a static, greedy reference to the &lt;tt&gt;BlobStore&lt;/tt&gt; and solve every synchronisation problem at once in the most straightforward way.&lt;/p&gt;</comment>
                            <comment id="14589588" author="chetanm" created="Wed, 17 Jun 2015 10:12:48 +0000"  >&lt;p&gt;I do not think this issue is related to BlobStore registration. So changing that would not solve this issue at least&lt;/p&gt;

&lt;p&gt;Further in a given system there should be one and only one BlobStore configured and they should be configured once and not changed once a setup is running. Otherwise it would lead to repository state inconsistency where some binaries may be written to BlobStore and some not. So this would be a setup issue and outside of SegmentNodeStoreService control&lt;/p&gt;</comment>
                            <comment id="14589675" author="frm" created="Wed, 17 Jun 2015 12:02:36 +0000"  >&lt;blockquote&gt;&lt;p&gt;Further in a given system there should be one and only one BlobStore configured and they should be configured once and not changed once a setup is running.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This is, in my opinion, another reason to have a static reference instead of a dynamic one. A static reference makes a clearer statement about the kind of dependency existing between a &lt;tt&gt;SegmentNodeStoreService&lt;/tt&gt; and a &lt;tt&gt;BlobStore&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="14589692" author="chetanm" created="Wed, 17 Jun 2015 12:13:02 +0000"  >&lt;blockquote&gt;&lt;p&gt;This is, in my opinion, another reason to have a static reference instead of a dynamic one&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Making it static does not change the implementation much as its only known via configuration that wether BlobStore is required or not. If you mark it static, greedy and optional then following flows are possible&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;BlobStore required
	&lt;ol&gt;
		&lt;li&gt;At time of activation BlobStore has been registered - In this case the BlobStore would be bound&lt;/li&gt;
		&lt;li&gt;At time of activation BlobStore is not registered - In that case also activation proceed (its optional per SCR). Later when BlobStore comes the bind method would be invoked.&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
	&lt;li&gt;BlobStore not required - In this case at time of activation SNS would know by reading the config that BlobStore is not required and it would proceed and create the SegmentNodeStore&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;So changing the BlobStore reference options does not help. &lt;/p&gt;

&lt;p&gt;Probably what you are looking for is &apos;&amp;lt;refname&amp;gt;.cardinality.minimum&apos; support added to SCR as part of RFC 190 (Section 5.10 &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;) (see &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-4391&quot; title=&quot;[DS] R6/rfc190 Support &amp;lt;refname&amp;gt;.cardinality.minimum configuration property&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-4391&quot;&gt;&lt;del&gt;FELIX-4391&lt;/del&gt;&lt;/a&gt;). If we use that then yes those binad/unbind method logic can be avoided&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://github.com/osgi/design/raw/master/rfcs/rfc0190/rfc-0190-Declarative_Services_Enhancements.pdf&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/osgi/design/raw/master/rfcs/rfc0190/rfc-0190-Declarative_Services_Enhancements.pdf&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14589725" author="frm" created="Wed, 17 Jun 2015 12:43:51 +0000"  >&lt;p&gt;I see that the &lt;tt&gt;SegmentNodeStoreService&lt;/tt&gt; was written with some assumptions in mind that were not clear to me before submitting my patches. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chetanm&quot; class=&quot;user-hover&quot; rel=&quot;chetanm&quot;&gt;chetanm&lt;/a&gt;, if you are confident that your patch solves the problem, given the assumptions you described, we should better go with it. Do &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=amitjain&quot; class=&quot;user-hover&quot; rel=&quot;amitjain&quot;&gt;amitjain&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=alexparvulescu&quot; class=&quot;user-hover&quot; rel=&quot;alexparvulescu&quot;&gt;alexparvulescu&lt;/a&gt; have something to add?&lt;/p&gt;</comment>
                            <comment id="14591212" author="amitjain" created="Thu, 18 Jun 2015 04:16:24 +0000"  >&lt;p&gt;+1 for test &amp;amp; patch&lt;/p&gt;</comment>
                            <comment id="14595582" author="edivad" created="Mon, 22 Jun 2015 09:39:32 +0000"  >&lt;p&gt;Bulk moving to 1.3.2&lt;/p&gt;</comment>
                            <comment id="14602931" author="alex.parvulescu" created="Fri, 26 Jun 2015 14:23:54 +0000"  >&lt;p&gt;I think this looks good! we also have a test now, which makes it even better, good stuff! &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
fyi I had to tweak the patch to get it to compile (changed import to &lt;em&gt;org.apache.felix.connect.launch.PojoServiceRegistry&lt;/em&gt;), but otherwise looks good.&lt;br/&gt;
+1&lt;/p&gt;</comment>
                            <comment id="14605189" author="chetanm" created="Mon, 29 Jun 2015 06:21:12 +0000"  >&lt;p&gt;Applied the patch&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;trunk - 1688090,1688089&lt;/li&gt;
	&lt;li&gt;1.0 - 1688092 (skipped the test as oak-pojosr is not maintained in branch much)&lt;/li&gt;
	&lt;li&gt;1.2 - 1688094&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14614741" author="edivad" created="Mon, 6 Jul 2015 09:12:02 +0000"  >&lt;p&gt;Bulk close for 1.3.2&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12778740">OAK-2560</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12823926">OAK-2811</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12733824" name="OAK-2401-01.patch" size="13967" author="frm" created="Tue, 19 May 2015 14:10:34 +0000"/>
                            <attachment id="12739060" name="OAK-2401-02.patch" size="10181" author="frm" created="Thu, 11 Jun 2015 14:36:58 +0000"/>
                            <attachment id="12739920" name="OAK-2401-03.patch" size="9262" author="frm" created="Tue, 16 Jun 2015 17:42:18 +0000"/>
                            <attachment id="12740062" name="OAK-2401-04-testcase-fix.patch" size="8250" author="chetanm" created="Wed, 17 Jun 2015 07:40:12 +0000"/>
                            <attachment id="12692492" name="OAK-2401.patch" size="2114" author="stillalex" created="Thu, 15 Jan 2015 09:33:48 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 19 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i24ejr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>