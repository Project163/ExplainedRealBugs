<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:50:39 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-3488] LastRevRecovery for self async?</title>
                <link>https://issues.apache.org/jira/browse/OAK-3488</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;Currently, when a cluster node starts and discovers that it wasn&apos;t properly shutdown, it first runs the complete LastRevRecovery and only continues startup when done.&lt;/p&gt;

&lt;p&gt;However, when it fails to acquire the recovery lock, which implies that a different cluster node is already running the recovery on its behalf, it simply skips recovery and continues startup?&lt;/p&gt;

&lt;p&gt;So what is it? Is running the recovery before proceeding critical or not? If it is, this code in &lt;tt&gt;LastRevRecoveryAgent&lt;/tt&gt; needs to change:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        &lt;span class=&quot;code-comment&quot;&gt;//TODO What &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; recovery is being performed &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; current clusterNode by some other node
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;//should we halt the startup
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(!lockAcquired){
            log.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Last revision recovery already being performed by some other node. &quot;&lt;/span&gt; +
                    &lt;span class=&quot;code-quote&quot;&gt;&quot;Would not attempt recovery&quot;&lt;/span&gt;);
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; 0;
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If it&apos;s not critical, we may want to run the recovery always asynchronously. &lt;br/&gt;
cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mreutegg&quot; class=&quot;user-hover&quot; rel=&quot;mreutegg&quot;&gt;mreutegg&lt;/a&gt;  and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chetanm&quot; class=&quot;user-hover&quot; rel=&quot;chetanm&quot;&gt;chetanm&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12902929">OAK-3488</key>
            <summary>LastRevRecovery for self async?</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mreutegg">Marcel Reutegger</assignee>
                                    <reporter username="reschke">Julian Reschke</reporter>
                        <labels>
                            <label>resilience</label>
                    </labels>
                <created>Wed, 7 Oct 2015 08:58:41 +0000</created>
                <updated>Mon, 19 Dec 2016 21:44:32 +0000</updated>
                            <resolved>Mon, 18 Apr 2016 09:27:09 +0000</resolved>
                                                    <fixVersion>1.5.2</fixVersion>
                    <fixVersion>1.6.0</fixVersion>
                                    <component>documentmk</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="14946568" author="mreutegg" created="Wed, 7 Oct 2015 09:15:54 +0000"  >&lt;p&gt;I think the current behavior is wrong. It should either wait until recovery is done or fail the startup.&lt;/p&gt;</comment>
                            <comment id="14946928" author="reschke" created="Wed, 7 Oct 2015 14:23:54 +0000"  >&lt;p&gt;If we wait (which sounds right) we may paint us into a corner if the node running the recovery has died without releasing the lock.&lt;/p&gt;</comment>
                            <comment id="14946963" author="mreutegg" created="Wed, 7 Oct 2015 14:48:46 +0000"  >&lt;p&gt;Yes, that&apos;s correct. This shows another flaw of the current recovery locking mechanism, which should be fixed as well.&lt;/p&gt;

&lt;p&gt;We need a way to detect if the recovering instance is still alive. If we know, which instance is recovering we could use the existing lease mechanism. However, this does not work when an instance recovers itself, at least with the current implementation. The DocumentNodeStore runs recovery first before it starts the lease update thread. &lt;/p&gt;</comment>
                            <comment id="14946975" author="reschke" created="Wed, 7 Oct 2015 14:53:12 +0000"  >&lt;p&gt;The recovering instance is tracked since &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-3435&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/OAK-3435&lt;/a&gt;...&lt;/p&gt;</comment>
                            <comment id="15138563" author="mreutegg" created="Tue, 9 Feb 2016 09:00:41 +0000"  >&lt;p&gt;Changed issue type to Bug. The current behaviour is wrong when another cluster node is performing recovery for a starting cluster node.&lt;/p&gt;</comment>
                            <comment id="15139136" author="mreutegg" created="Tue, 9 Feb 2016 16:17:52 +0000"  >&lt;p&gt;Attached a WIP patch. With those changes, a DocumentNodeStore waits at most 60 seconds for an ongoing recovery and then fails the startup if recovery is still not finished. It does not yet check if the recovering cluster node is still alive.&lt;/p&gt;</comment>
                            <comment id="15142428" author="mreutegg" created="Thu, 11 Feb 2016 08:42:04 +0000"  >&lt;p&gt;Continued work in a GitHub branch: &lt;a href=&quot;https://github.com/mreutegg/jackrabbit-oak/tree/OAK-3488&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/mreutegg/jackrabbit-oak/tree/OAK-3488&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;With the changes on the GitHub branch, the lastRev recovery mechanism now also check whether the recovering cluster node is still alive and if needed breaks the recovery lock to take over the recovery.&lt;/p&gt;</comment>
                            <comment id="15245358" author="mreutegg" created="Mon, 18 Apr 2016 09:27:09 +0000"  >&lt;p&gt;Committed work on the GitHub branch to trunk: &lt;a href=&quot;http://svn.apache.org/r1739717&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1739717&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15284599" author="edivad" created="Mon, 16 May 2016 13:58:27 +0000"  >&lt;p&gt;Bulk close for 1.5.2&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12895139">OAK-3435</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13029268">OAK-5337</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12787088" name="OAK-3488.patch" size="16347" author="mreutegg" created="Tue, 9 Feb 2016 16:17:52 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311120" key="com.pyxis.greenhopper.jira:gh-epic-link">
                        <customfieldname>Epic Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>OAK-3270</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 26 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1zjz1:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>