<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:47:47 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-2778] DocumentNodeState is null for revision rx-x-x</title>
                <link>https://issues.apache.org/jira/browse/OAK-2778</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;On a system running Oak 1.0.12 the following exception is seen repeatedly when the async index update tries to update a lucene index:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.sling.commons.scheduler.impl.QuartzScheduler Exception during job execution of org.apache.jackrabbit.oak.plugins.index.AsyncIndexUpdate@6be42cde : DocumentNodeState is null for revision r14cbbd50ad2-0-1 of /oak:index/lucene/:data/_1co.cfe (aborting getChildNodes())
org.apache.jackrabbit.oak.plugins.document.DocumentStoreException: DocumentNodeState is null for revision r14cbbd50ad2-0-1 of /oak:index/lucene/:data/_1co.cfe (aborting getChildNodes())
at org.apache.jackrabbit.oak.plugins.document.DocumentNodeStore$6.apply(DocumentNodeStore.java:925)
at org.apache.jackrabbit.oak.plugins.document.DocumentNodeStore$6.apply(DocumentNodeStore.java:919)
at com.google.common.collect.Iterators$8.transform(Iterators.java:794)
at com.google.common.collect.TransformedIterator.next(TransformedIterator.java:48)
at com.google.common.collect.TransformedIterator.next(TransformedIterator.java:48)
at org.apache.jackrabbit.oak.plugins.document.DocumentNodeState$ChildNodeEntryIterator.next(DocumentNodeState.java:618)
at org.apache.jackrabbit.oak.plugins.document.DocumentNodeState$ChildNodeEntryIterator.next(DocumentNodeState.java:587)
at com.google.common.collect.TransformedIterator.next(TransformedIterator.java:48)
at com.google.common.collect.Iterators.addAll(Iterators.java:357)
at com.google.common.collect.Lists.newArrayList(Lists.java:146)
at com.google.common.collect.Iterables.toCollection(Iterables.java:334)
at com.google.common.collect.Iterables.toArray(Iterables.java:312)
at org.apache.jackrabbit.oak.plugins.index.lucene.OakDirectory.listAll(OakDirectory.java:69)
at org.apache.lucene.index.DirectoryReader.indexExists(DirectoryReader.java:339)
at org.apache.lucene.index.IndexWriter.&amp;lt;init&amp;gt;(IndexWriter.java:720)
at org.apache.jackrabbit.oak.plugins.index.lucene.LuceneIndexEditorContext.getWriter(LuceneIndexEditorContext.java:134)
at org.apache.jackrabbit.oak.plugins.index.lucene.LuceneIndexEditor.addOrUpdate(LuceneIndexEditor.java:260)
at org.apache.jackrabbit.oak.plugins.index.lucene.LuceneIndexEditor.leave(LuceneIndexEditor.java:171)
at org.apache.jackrabbit.oak.spi.commit.CompositeEditor.leave(CompositeEditor.java:74)
at org.apache.jackrabbit.oak.spi.commit.VisibleEditor.leave(VisibleEditor.java:63)
at org.apache.jackrabbit.oak.spi.commit.EditorDiff.childNodeAdded(EditorDiff.java:130)
at org.apache.jackrabbit.oak.plugins.memory.EmptyNodeState.compareAgainstEmptyState(EmptyNodeState.java:160)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;A similar issue was already fixed with &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-2420&quot; title=&quot;DocumentNodeStore revision GC may lead to NPE&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-2420&quot;&gt;&lt;del&gt;OAK-2420&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12821478">OAK-2778</key>
            <summary>DocumentNodeState is null for revision rx-x-x</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mreutegg">Marcel Reutegger</assignee>
                                    <reporter username="mreutegg">Marcel Reutegger</reporter>
                        <labels>
                    </labels>
                <created>Thu, 16 Apr 2015 10:04:15 +0000</created>
                <updated>Wed, 2 Mar 2016 11:31:33 +0000</updated>
                            <resolved>Mon, 27 Apr 2015 10:20:53 +0000</resolved>
                                    <version>1.0</version>
                    <version>1.2</version>
                                    <fixVersion>1.0.14</fixVersion>
                    <fixVersion>1.2.3</fixVersion>
                    <fixVersion>1.3.0</fixVersion>
                    <fixVersion>1.4</fixVersion>
                                    <component>core</component>
                    <component>mongomk</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="14502794" author="mreutegg" created="Mon, 20 Apr 2015 13:39:13 +0000"  >&lt;p&gt;The root cause is most likely a race condition in the VersionGarbageCollector. It first gets a list of candidate documents to remove. The condition for those documents is: the _deletedOnce flag is true and the _modified timestamp is older than one day. Then the VersionGarbageCollector goes through each of the documents and checks if the node based on that document exists at the head revision when the GC started. It the node doesn&apos;t exist, the document is considered garbage and removed.&lt;br/&gt;
The race condition occurs, when the node is re-created after the GC started and is going through the candidate documents. The VersionGarbageCollector will consider the document as garbage even though it was modified after the given timestamp.&lt;br/&gt;
The race condition is usually quite unlikely for the lucene index update. Almost all lucene files are write once and never modified. The exception is when a re-index occurs. Oak will delete all existing lucene files and start a new index from scratch (atomically). This means the new index files will use names of files that existed before. Again, in most cases even a re-index is not a problem, because of the way lucene assigns names to files. Almost all lucene files have a generation suffix, which is a hexadecimal number, which increments with each new generation. The suffix is monotonically increasing and starts as 0. This means, the garbage collector will always remove the oldest generations and not touch the active part of the index. Even if a re-index occurs, the previously active lucene index will be at a rather high generation, which makes it unlikely to overlap with the generation of the new index.&lt;/p&gt;

&lt;p&gt;The probability increases considerably if multiple re-indexes occur, e.g. once a day. This means the lucene generations eligible for garbage collection will overlap with the new generations to be used by the active index.&lt;/p&gt;

&lt;p&gt;I&apos;ll try to create a test to reproduce the issue.&lt;/p&gt;</comment>
                            <comment id="14503342" author="chetanm" created="Mon, 20 Apr 2015 18:24:19 +0000"  >&lt;p&gt;Possible options (think out loud kind &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; )&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;In VersionGC make use of modCount - While determining the docs to be deleted also get there modCount and when issuing actual delete call include the modCount. This would prevent such concurrent modified nodes from getting deleted. But yes chance of race condition still exist&lt;/li&gt;
	&lt;li&gt;Use different dir in Lucene directory for every reindex - Currently every time in reindex it uses &lt;tt&gt;:data&lt;/tt&gt;. Possibly we can append the &lt;tt&gt;reindexCount&lt;/tt&gt; and that would avoid &lt;em&gt;collision&lt;/em&gt; of file names.&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="14504456" author="mreutegg" created="Tue, 21 Apr 2015 06:49:52 +0000"  >&lt;p&gt;I would rather like to fix the VersionGC and make sure it doesn&apos;t remove documents that are still in use. To me it looks like there is no way around a conditional &lt;tt&gt;DocumentStore.remove()&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="14504503" author="mreutegg" created="Tue, 21 Apr 2015 07:27:36 +0000"  >&lt;p&gt;Added test (currently ignored) to reproduce the exception: &lt;a href=&quot;http://svn.apache.org/r1675054&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1675054&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14508766" author="mreutegg" created="Thu, 23 Apr 2015 09:59:57 +0000"  >&lt;p&gt;Fixed in trunk: &lt;a href=&quot;http://svn.apache.org/r1675566&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1675566&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The VersionGarbageCollector now uses the conditional remove method introduced with &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-2804&quot; title=&quot;Conditional remove on DocumentStore&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-2804&quot;&gt;&lt;del&gt;OAK-2804&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I&apos;ll keep this issue open for now to analyze the performance impact of this change on bigger repositories...&lt;/p&gt;</comment>
                            <comment id="14513719" author="mreutegg" created="Mon, 27 Apr 2015 08:38:07 +0000"  >&lt;p&gt;Ran a RevisionGCTest (see &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-2812&quot; title=&quot;RevisionGC benchmark&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-2812&quot;&gt;&lt;del&gt;OAK-2812&lt;/del&gt;&lt;/a&gt;) on trunk and the 1.2 branch. The test created 10 million nodes with a garbage ratio of 1%.&lt;/p&gt;

&lt;p&gt;On trunk the result is:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;VersionGCStats {
    ignoredGCDueToCheckPoint=false, 
    deletedDocGCCount=208208, 
    splitDocGCCount=0, 
    intermediateSplitDocGCCount=0, 
    timeToCollectDeletedDocs=3.032 s, 
    timeTakenToDeleteDocs=20.77 s
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;on the 1.2 branch (without this fix):&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;VersionGCStats {
    ignoredGCDueToCheckPoint=false, 
    deletedDocGCCount=182182, 
    splitDocGCCount=0, 
    intermediateSplitDocGCCount=0, 
    timeToCollectDeletedDocs=2.381 s, 
    timeTakenToDeleteDocs=6.494 s
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The time to delete the docs did go up, but I think it is still OK.&lt;/p&gt;</comment>
                            <comment id="14514141" author="mreutegg" created="Mon, 27 Apr 2015 13:42:34 +0000"  >&lt;p&gt;Merged into 1.0 branch: &lt;a href=&quot;http://svn.apache.org/r1676262&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1676262&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14548083" author="edivad" created="Mon, 18 May 2015 14:29:45 +0000"  >&lt;p&gt;Bulk close for 1.0.14&lt;/p&gt;</comment>
                            <comment id="14551934" author="mreutegg" created="Wed, 20 May 2015 07:25:46 +0000"  >&lt;p&gt;Merged into 1.2 branch: &lt;a href=&quot;http://svn.apache.org/r1680466&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1680466&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                                                <inwardlinks description="is blocked by">
                                        <issuelink>
            <issuekey id="12823041">OAK-2804</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12824182">OAK-2812</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 26 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2dc67:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>