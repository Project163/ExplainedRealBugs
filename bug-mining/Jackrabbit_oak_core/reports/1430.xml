<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:50:10 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-3864] Filestore cleanup removes referenced segments</title>
                <link>https://issues.apache.org/jira/browse/OAK-3864</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;In some situations &lt;tt&gt;FileStore.cleanup()&lt;/tt&gt; may remove segments that are still referenced, subsequently causing a &lt;tt&gt;SNFE&lt;/tt&gt;. &lt;/p&gt;

&lt;p&gt;This is a regression introduced with &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-1828&quot; title=&quot;Improved SegmentWriter&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-1828&quot;&gt;&lt;del&gt;OAK-1828&lt;/del&gt;&lt;/a&gt;. &lt;/p&gt;

&lt;p&gt;&lt;tt&gt;FileStore.cleanup()&lt;/tt&gt; relies on the ordering of the segments in the tar files: later segments only reference earlier segments. As we have seen in other places this assumption does not hold any more (e.g. &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-3794&quot; title=&quot;The Cold Standby should expect loops in the segment graph&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-3794&quot;&gt;&lt;del&gt;OAK-3794&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-3793&quot; title=&quot;The Explorer should expect loops in the segment graph&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-3793&quot;&gt;&lt;del&gt;OAK-3793&lt;/del&gt;&lt;/a&gt;) since &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-1828&quot; title=&quot;Improved SegmentWriter&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-1828&quot;&gt;&lt;del&gt;OAK-1828&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
 &lt;tt&gt;cleanup&lt;/tt&gt; traverses the segments backwards maintaining a list of referenced ids. When a segment is not in that list, it is removed. However, this approach does not work with forward references as those are only seen later when the segment has been removed already. &lt;/p&gt;

&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=alex.parvulescu&quot; class=&quot;user-hover&quot; rel=&quot;alex.parvulescu&quot;&gt;alex.parvulescu&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=frm&quot; class=&quot;user-hover&quot; rel=&quot;frm&quot;&gt;frm&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12929459">OAK-3864</key>
            <summary>Filestore cleanup removes referenced segments</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mduerig">Michael D&#252;rig</assignee>
                                    <reporter username="mduerig">Michael D&#252;rig</reporter>
                        <labels>
                            <label>regression</label>
                    </labels>
                <created>Tue, 12 Jan 2016 11:05:42 +0000</created>
                <updated>Wed, 20 Apr 2016 12:47:21 +0000</updated>
                            <resolved>Wed, 13 Jan 2016 16:27:26 +0000</resolved>
                                                    <fixVersion>1.3.14</fixVersion>
                    <fixVersion>1.4</fixVersion>
                                    <component>segmentmk</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="15093742" author="mduerig" created="Tue, 12 Jan 2016 11:08:20 +0000"  >&lt;p&gt;Test case at &lt;a href=&quot;http://svn.apache.org/viewvc?rev=1724202&amp;amp;view=rev&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?rev=1724202&amp;amp;view=rev&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15093756" author="mduerig" created="Tue, 12 Jan 2016 11:22:13 +0000"  >&lt;p&gt;I see 2 approaches to fixing this: &lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;fix the cleanup to be able to cope with cycles in the segment graph&lt;/li&gt;
	&lt;li&gt;re-establish the invariant that segments never have forward references&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;While that invariant is certainly a very nice property to have, it has never been strictly enforced. Even before &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-1828&quot; title=&quot;Improved SegmentWriter&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-1828&quot;&gt;&lt;del&gt;OAK-1828&lt;/del&gt;&lt;/a&gt; you could have run into this situation by writing to the file store through multiple segment writers in a certain way. The only reason we did not see the problem there is because we didn&apos;t do this. With the current approach where we stripe writing segment across various segment buffer writers it seems very hard to re-establish the invariant. &lt;/p&gt;

&lt;p&gt;OTOH making cleanup cope with cycles / forward references in the segment graph probably means we need to turn this simple one pass algorithm into a two pass mark and sweep like approach. &lt;/p&gt;
</comment>
                            <comment id="15094649" author="mduerig" created="Tue, 12 Jan 2016 19:55:08 +0000"  >&lt;p&gt;Thinking a bit more about this I came to the conclusion that 2. is not feasible: it would put constraints on the order in which segment buffer writers could flush. This would either re-introduce blocking (which to remove was a purpose of &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-1828&quot; title=&quot;Improved SegmentWriter&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-1828&quot;&gt;&lt;del&gt;OAK-1828&lt;/del&gt;&lt;/a&gt;) or require a much deeper refactoring effectively redesigning the way segments are written and flushed. &lt;/p&gt;

&lt;p&gt;1. should be feasible. Exploiting the fact that forward references are rare and only span a few segments it should even be possible to fix cleanup without having to resort to a full fledged mark and sweep. The idea would be to do a first forward pass over the segments collecting the forward references. The following backward pass would then use those to augment the reference set passed along. &lt;/p&gt;
</comment>
                            <comment id="15096478" author="mduerig" created="Wed, 13 Jan 2016 16:27:26 +0000"  >&lt;p&gt;Fixed at &lt;a href=&quot;http://svn.apache.org/viewvc?rev=1724451&amp;amp;view=rev&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?rev=1724451&amp;amp;view=rev&lt;/a&gt; by adding the ids of segments referenced through forward references into the initial set of referenced ids. This potentially requires multiple passes over all entries in all tar readers. I added additional logging so we can catch it when this takes too long.&lt;/p&gt;</comment>
                            <comment id="15112182" author="edivad" created="Fri, 22 Jan 2016 09:21:17 +0000"  >&lt;p&gt;Bulk close for 1.3.14&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="12960329">OAK-4256</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12861779">OAK-3348</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12936278">OAK-3972</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311120" key="com.pyxis.greenhopper.jira:gh-epic-link">
                        <customfieldname>Epic Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>OAK-2849</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 43 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2r6h3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>