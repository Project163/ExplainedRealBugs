<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:49:06 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-3201] Use static references in SecurityProviderImpl for composite services</title>
                <link>https://issues.apache.org/jira/browse/OAK-3201</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;&lt;tt&gt;SecurityProviderImpl&lt;/tt&gt; has dynamic references to many other services, like &lt;tt&gt;RestrictionProvider&lt;/tt&gt;, that represent the configuration of this component.&lt;/p&gt;

&lt;p&gt;Being these services dynamic, the OSGi runtime has no clear dependency relationship between the &lt;tt&gt;SecurityProviderImpl&lt;/tt&gt; and the required services. Thus, it may happen that an instance of &lt;tt&gt;SecurityProviderImpl&lt;/tt&gt; is published before the services it requires are started, creating a window where the &lt;tt&gt;SecurityProviderimpl&lt;/tt&gt; is operating differently from the way it&apos;s configured.&lt;/p&gt;

&lt;p&gt;I suggest to turn the dynamic references in &lt;tt&gt;SecurityProviderImpl&lt;/tt&gt; to static ones to improve the consistency of the implementation.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12853793">OAK-3201</key>
            <summary>Use static references in SecurityProviderImpl for composite services</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="frm">Francesco Mari</assignee>
                                    <reporter username="frm">Francesco Mari</reporter>
                        <labels>
                    </labels>
                <created>Mon, 10 Aug 2015 10:17:23 +0000</created>
                <updated>Wed, 2 Mar 2016 14:23:12 +0000</updated>
                            <resolved>Fri, 18 Sep 2015 07:41:06 +0000</resolved>
                                                    <fixVersion>1.0.22</fixVersion>
                    <fixVersion>1.2.7</fixVersion>
                    <fixVersion>1.3.7</fixVersion>
                    <fixVersion>1.4</fixVersion>
                                    <component>core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="14681384" author="frm" created="Tue, 11 Aug 2015 07:47:41 +0000"  >&lt;p&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12749785/12749785_OAK-3201-01.patch&quot; title=&quot;OAK-3201-01.patch attached to OAK-3201&quot;&gt;OAK-3201-01.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; forces static references to &lt;tt&gt;AuthorizableNodeName&lt;/tt&gt;, &lt;tt&gt;AuthorizableActionProvider&lt;/tt&gt;, &lt;tt&gt;RestrictionProvider&lt;/tt&gt; and &lt;tt&gt;UserAuthenticationFactory&lt;/tt&gt;. &lt;/p&gt;

&lt;p&gt;This changes the behaviour of the component: if an instance of any of the referenced services is created, modified or stopped, &lt;tt&gt;SecurityProviderImpl&lt;/tt&gt; will go through a full deactivation/activation cycle. While this decreases the dynamism of the component, it mitigates the chance of the publication of a repository which references a half-configured &lt;tt&gt;SecurityProviderImpl&lt;/tt&gt;.&lt;/p&gt;
</comment>
                            <comment id="14693699" author="frm" created="Wed, 12 Aug 2015 15:43:09 +0000"  >&lt;p&gt;I&apos;m not sure if &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12749785/12749785_OAK-3201-01.patch&quot; title=&quot;OAK-3201-01.patch attached to OAK-3201&quot;&gt;OAK-3201-01.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; solves the problem, because it is still possible for a &lt;tt&gt;SecurityProviderImpl&lt;/tt&gt; to exist even if its dependencies are not completely loaded. The only solution to this problem is, in my opinion, to encapsulate all the dependencies of &lt;tt&gt;SecurityProviderImpl&lt;/tt&gt; into a separated OSGi component.&lt;/p&gt;

&lt;p&gt;In example, this component would contain the settings for the &lt;tt&gt;SecurityProviderImpl&lt;/tt&gt;:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;interface&lt;/span&gt; SecurityProviderSettings {
    AuthorizableNodeName getAuthorizableNodeName();    
    AuthorizableActionProvider getAuthorizableActionProvider();    
    &lt;span class=&quot;code-comment&quot;&gt;// More dependencies &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the SecurityProvider    
&lt;/span&gt;}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In this case, &lt;tt&gt;SecurityProviderImpl&lt;/tt&gt; would have a static, unary and mandatory reference on this interface:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;SecurityProviderImpl &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; SecurityProvider, WhiteboardAware {
    @Reference
    SecurityProviderSettings settings;
    &lt;span class=&quot;code-comment&quot;&gt;// More code &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; SecurityProviderImpl...
&lt;/span&gt;}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If the &lt;tt&gt;SecurityProviderSettings&lt;/tt&gt; is not provided, the &lt;tt&gt;SecurityProviderImpl&lt;/tt&gt; will not start, ultimately preventing the repository to start. This solution would prevent the repository to be in an unwanted state (default values), even for a short period of time. With this change, the assurance of consistency is driven by whoever deploys the repository into an OSGi environment, provided that some custom settings need to be provided.&lt;/p&gt;

&lt;p&gt;The default values could (and probably should) be encapsulated in a default implementation of the settings service:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;DefaultSecurityProviderSettings &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; SecurityProviderSettings {
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; AuthorizableNodeName getAuthorizableNodeName() {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; AuthorizableNodeName.DEFAULT;
    }
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; AuthorizableActionProvider getAuthorizableActionProvider() {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; DefaultAuthorizableActionProvider();
    }
    &lt;span class=&quot;code-comment&quot;&gt;// More &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt; values... 
&lt;/span&gt;}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The default settings can also be published as a service, maybe starting it conditionally based on OSGi configuration. If a user wants to provide custom settings, he can provide a different implementation of &lt;tt&gt;SecurityProviderSettings&lt;/tt&gt; with a higher service ranking, or disable the default settings via OSGi configuration to prevent even the slightest overlap.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=anchela&quot; class=&quot;user-hover&quot; rel=&quot;anchela&quot;&gt;anchela&lt;/a&gt;, do you think that this change is acceptable? If yes, I will provide an additional patch.&lt;/p&gt;</comment>
                            <comment id="14695383" author="anchela" created="Thu, 13 Aug 2015 15:42:02 +0000"  >&lt;p&gt;i can&apos;t tell you what would be suited from an OSGi point of view. what looks a bit awkward to me is the fact that settings of the various security related modules get mixed in that SecurityProviderSettings.&lt;/p&gt;

&lt;p&gt;if going with the settings approach is considered the correct solution, i would prefer to have it separated from &apos;usermanagement&apos; and &apos;authorization&apos;.&lt;/p&gt;

&lt;p&gt;alternatively, we might consider removing it from the security provider altogether and just make them become referenced in the &lt;tt&gt;UserConfigurationImpl&lt;/tt&gt; and &lt;tt&gt;AuthorizationConfigurationImpl&lt;/tt&gt; respectively. the reason why these configurations are treated differently from the security-module setup is the fact that most of them can be considered an implementation detail of the module. &lt;/p&gt;

&lt;p&gt;for example: it&apos;s just an implementation detail of the user management, that there exists something like a &lt;tt&gt;AuthorizableNodeName&lt;/tt&gt; and an &lt;tt&gt;AuthorizableActionProvider&lt;/tt&gt;... someone plugging his custom user management implementation by just deploying another service implementing &lt;tt&gt;UserConfiguration&lt;/tt&gt; might just not have this special thingies in place. that&apos;s why they ended up in the &lt;tt&gt;ConfigurationParamters&lt;/tt&gt; associated with the module configuration and not being regularly exposed as part of the API such as &lt;tt&gt;UserConfiguration.getUserManager&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;i don&apos;t feel particularly attached to having those &apos;special&apos; configurations in the &lt;tt&gt;SecurityProvider&lt;/tt&gt; if there is a better way to achieve the same (or better) result... as long as we can have the java setup I am fine.&lt;/p&gt;

&lt;p&gt;After all that would feel more natural to me than inventing an artificial &lt;tt&gt;SecurityProviderSettings&lt;/tt&gt; that doesn&apos;t reflect the fact that those settings are actually tied to the individual security modules and not the &lt;tt&gt;SecurityProvider&lt;/tt&gt; itself... that latter is just the &apos;entry point&apos; and the extra stuff ended up there for well... probably for not properly working it out and my hesitation to add &quot;@Reference&quot; annotations to the individual security configuration implemenations.&lt;/p&gt;

&lt;p&gt;wdyt? would that work? wouldn&apos;t it even make more sense?&lt;/p&gt;</comment>
                            <comment id="14731031" author="frm" created="Fri, 4 Sep 2015 16:32:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=anchela&quot; class=&quot;user-hover&quot; rel=&quot;anchela&quot;&gt;anchela&lt;/a&gt;, I agree with you with the idea that services like &lt;tt&gt;AuthorizableNodeName&lt;/tt&gt; should not be linked directly to &lt;tt&gt;SecurityProviderImpl&lt;/tt&gt;. They should be attached directly to the components using them, instead.&lt;/p&gt;

&lt;p&gt;Since running a &lt;tt&gt;SecurityProvider&lt;/tt&gt; without OSGi looks like an important use case, I suggest doing a relatively simple (albeit lengthy) refactoring of &lt;tt&gt;SecurityProviderImpl&lt;/tt&gt;. The purpose of the refactoring would be to create an implementation of &lt;tt&gt;SecurityProvider&lt;/tt&gt; completely independent of OSGi. When this implementation is in place, I can create a set of OSGi components on top of it capable of automatically taking care of dependency injection. When the &lt;tt&gt;SecurityProvider&lt;/tt&gt; is used without OSGi, the dependencies should be instantiated and linked manually.&lt;/p&gt;

&lt;p&gt;This way, the &lt;tt&gt;SecurityProvider&lt;/tt&gt; implementation will be cleaner, since the code doesn&apos;t have &lt;tt&gt;@Component&lt;/tt&gt; and &lt;tt&gt;@Reference&lt;/tt&gt; annotations all over the place.&lt;/p&gt;

&lt;p&gt;What do you think?&lt;/p&gt;</comment>
                            <comment id="14732094" author="frm" created="Sat, 5 Sep 2015 20:15:51 +0000"  >&lt;p&gt;To better illustrate my previous comment, I attached &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12754346/12754346_OAK-3201-02.patch&quot; title=&quot;OAK-3201-02.patch attached to OAK-3201&quot;&gt;OAK-3201-02.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; with three classes to be used as an example.&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;DefaultSecurityProvider&lt;/tt&gt; is an implementation of &lt;tt&gt;SecurityProvider&lt;/tt&gt; that is completely unaware of OSGi. The &lt;tt&gt;DefaultSecurityProviderBuilder&lt;/tt&gt; is just an helper class to help users in building new instances of &lt;tt&gt;DefaultSecurityProvider&lt;/tt&gt;. The &lt;tt&gt;DefaultSecurityProviderBuilder&lt;/tt&gt; is unaware of OSGi, too. These classes can be surely used outside of an OSGi framework.&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;DefaultSecurityProviderRegistration&lt;/tt&gt; takes care of gathering the dependencies of a &lt;tt&gt;DefaultSecurityProvider&lt;/tt&gt; from the OSGi environment, creating a new instance of &lt;tt&gt;DefaultSecurityProvider&lt;/tt&gt; using the &lt;tt&gt;DefaultSecurityProviderBuilder&lt;/tt&gt;, and registering the newly created instance into the OSGi framework as a new service. Being this a default implementation, we give the possibility to users to deactivate it by using a flag exposed as OSGi configuration.&lt;/p&gt;

&lt;p&gt;I didn&apos;t go further with my example, but the same pattern can be applied to implementations of &lt;tt&gt;AuthorizationConfiguration&lt;/tt&gt;, &lt;tt&gt;AuthenticationConfiguration&lt;/tt&gt;, and so on.&lt;/p&gt;</comment>
                            <comment id="14733389" author="frm" created="Mon, 7 Sep 2015 08:28:36 +0000"  >&lt;p&gt;Committed the first proposed patch at r1701579 as a temporary solution. I will open a new issue to track progress for an eventual refactoring of &lt;tt&gt;SecurityProviderImpl&lt;/tt&gt; and its dependencies.&lt;/p&gt;</comment>
                            <comment id="14733473" author="mreutegg" created="Mon, 7 Sep 2015 09:42:16 +0000"  >&lt;p&gt;Please set a fix version when you resolve an issue.&lt;/p&gt;

&lt;p&gt;This change also introduced a regression and fails a test in oak-pojosr:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;jmxIntegration(org.apache.jackrabbit.oak.run.osgi.MBeanIntegrationTest)  Time elapsed: 0.485 sec  &amp;lt;&amp;lt;&amp;lt; FAILURE!
Assertion failed: 

assert mbeans.size() == 1
       |      |      |
       |      2      false
       [org.apache.jackrabbit.oak.management.RepositoryManager[org.apache.jackrabbit.oak:name=&quot;repository manager&quot;,type=&quot;RepositoryManagement&quot;,id=168], org.apache.jackrabbit.oak.management.RepositoryManager[org.apache.jackrabbit.oak:name=&quot;repository manager&quot;,type=&quot;RepositoryManagement&quot;,id=161]]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14733509" author="frm" created="Mon, 7 Sep 2015 10:19:59 +0000"  >&lt;blockquote&gt;&lt;p&gt;Please set a fix version when you resolve an issue.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Sorry, I did it.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;This change also introduced a regression and fails a test in oak-pojosr&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I run a full build of Oak before committing, no test failed. I tried again now, but my build doesn&apos;t fail. May it be a timing issue?&lt;/p&gt;</comment>
                            <comment id="14733561" author="chetanm" created="Mon, 7 Sep 2015 11:21:54 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=frm&quot; class=&quot;user-hover&quot; rel=&quot;frm&quot;&gt;frm&lt;/a&gt; I looked into the test failure and it appears to be related to recent change. Whats happening is like below&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;07.09.2015 16:35:17.067 *INFO* [main] org.apache.jackrabbit.oak-jcr Service [60, [org.apache.jackrabbit.oak.api.jmx.RepositoryManagementMBean]] ServiceEvent REGISTERED
07.09.2015 16:35:17.090 *INFO* [main] org.apache.jackrabbit.oak-jcr Service [61, [org.apache.jackrabbit.api.jmx.QueryStatManagerMBean]] ServiceEvent REGISTERED
07.09.2015 16:35:17.092 *INFO* [main] org.apache.jackrabbit.oak-jcr Service [62, [org.apache.jackrabbit.oak.api.jmx.RepositoryStatsMBean]] ServiceEvent REGISTERED
07.09.2015 16:35:17.094 *INFO* [main] org.apache.jackrabbit.oak-jcr Service [63, [java.lang.Runnable]] ServiceEvent REGISTERED
07.09.2015 16:35:17.095 *INFO* [main] org.apache.jackrabbit.oak-jcr Service [64, [org.apache.jackrabbit.oak.spi.gc.GCMonitor]] ServiceEvent REGISTERED
07.09.2015 16:35:17.096 *INFO* [main] org.apache.jackrabbit.oak-jcr Service [65, [javax.jcr.Repository]] ServiceEvent REGISTERED
07.09.2015 16:35:17.097 *INFO* [main] org.apache.jackrabbit.oak-core Service [org.apache.jackrabbit.oak.security.SecurityProviderImpl,52, [org.apache.jackrabbit.oak.spi.security.SecurityProvider]] ServiceEvent REGISTERED
07.09.2015 16:35:17.098 *INFO* [main] org.apache.jackrabbit.oak-core Service [org.apache.jackrabbit.oak.security.authorization.restriction.RestrictionProviderImpl,66, [org.apache.jackrabbit.oak.spi.security.authorization.restriction.RestrictionProvider]] ServiceEvent REGISTERED
07.09.2015 16:35:17.100 *INFO* [main] org.apache.jackrabbit.oak-jcr Service [65, [javax.jcr.Repository]] ServiceEvent UNREGISTERING
07.09.2015 16:35:17.106 *INFO* [main] org.apache.jackrabbit.oak-core Service [org.apache.jackrabbit.oak.security.SecurityProviderImpl,52, [org.apache.jackrabbit.oak.spi.security.SecurityProvider]] ServiceEvent UNREGISTERING
07.09.2015 16:35:17.124 *INFO* [main] org.apache.jackrabbit.oak-jcr Service [68, [java.util.concurrent.Executor]] ServiceEvent REGISTERED
07.09.2015 16:35:17.139 *INFO* [main] org.apache.jackrabbit.oak-jcr Service [69, [java.lang.Runnable]] ServiceEvent REGISTERED
07.09.2015 16:35:17.140 *INFO* [main] org.apache.jackrabbit.oak-jcr Service [70, [org.apache.jackrabbit.oak.api.jmx.IndexStatsMBean]] ServiceEvent REGISTERED
07.09.2015 16:35:17.141 *INFO* [main] org.apache.jackrabbit.oak-jcr Service [71, [java.lang.Runnable]] ServiceEvent REGISTERED
07.09.2015 16:35:17.141 *INFO* [main] org.apache.jackrabbit.oak-jcr Service [72, [org.apache.jackrabbit.oak.plugins.index.property.jmx.PropertyIndexAsyncReindexMBean]] ServiceEvent REGISTERED
07.09.2015 16:35:17.142 *INFO* [main] org.apache.jackrabbit.oak-jcr Service [73, [org.apache.jackrabbit.oak.plugins.index.counter.jmx.NodeCounterMBean]] ServiceEvent REGISTERED
07.09.2015 16:35:17.143 *INFO* [main] org.apache.jackrabbit.oak-jcr Service [74, [org.apache.jackrabbit.oak.api.jmx.QueryEngineSettingsMBean]] ServiceEvent REGISTERED
07.09.2015 16:35:17.148 *INFO* [main] org.apache.jackrabbit.oak-jcr Service [75, [org.apache.jackrabbit.oak.api.jmx.RepositoryManagementMBean]] ServiceEvent REGISTERED
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;it appears that Repository service gets re-registered possibly due to SecurityProvider getting restarted multiple times (see &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12754479/12754479_mbean-test.log&quot; title=&quot;mbean-test.log attached to OAK-3201&quot;&gt;logs&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;) where you can see &lt;tt&gt;SecurityProvider&lt;/tt&gt; getting registered and unregistered multiple times in a single startup. This would cause issue as once Repository is bounded with one SecurityProvider it would get recycled. I see that you used STATIC policy along with OPTIONAL_MULTIPLE. In such a case DS would still start SecurityProvider even if there are 0 reference of type OPTIONAL_MULTIPLE and later once a any matching service is registered the SecurityProvider would be reactivated.&lt;/p&gt;

&lt;p&gt;Can you review the approach as as to avoid scenarios where repository gets reactivated in normal startup as such a situation would need to be avoided&lt;/p&gt;</comment>
                            <comment id="14733563" author="chetanm" created="Mon, 7 Sep 2015 11:24:22 +0000"  >&lt;p&gt;Missed on reading your first comment&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;This changes the behaviour of the component: if an instance of any of the referenced services is created, modified or stopped, SecurityProviderImpl will go through a full deactivation/activation cycle. While this decreases the dynamism of the component, it mitigates the chance of the publication of a repository which references a half-configured SecurityProviderImpl.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I still think whatever approach we take we should avoid get repository reactivated in a normal setup to ensure stable startup&lt;/p&gt;</comment>
                            <comment id="14733618" author="reschke" created="Mon, 7 Sep 2015 12:24:14 +0000"  >&lt;p&gt;It fails for me as well, and I just wasted hours to find the revision causing the breakage. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=frm&quot; class=&quot;user-hover&quot; rel=&quot;frm&quot;&gt;frm&lt;/a&gt; can you please revert the change until there&apos;s new information?&lt;/p&gt;</comment>
                            <comment id="14733666" author="frm" created="Mon, 7 Sep 2015 12:58:57 +0000"  >&lt;blockquote&gt;&lt;p&gt;I still think whatever approach we take we should avoid get repository reactivated in a normal setup to ensure stable startup&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I will try another solution, but this could be a major change in &lt;tt&gt;SecurityProviderImpl&lt;/tt&gt;, at least from the point of view of the implementation.&lt;/p&gt;</comment>
                            <comment id="14734446" author="frm" created="Tue, 8 Sep 2015 08:55:25 +0000"  >&lt;p&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12754600/12754600_OAK-3201-03.patch&quot; title=&quot;OAK-3201-03.patch attached to OAK-3201&quot;&gt;OAK-3201-03.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; should solve the issue. Unit and integration tests are passing on my machine.&lt;/p&gt;

&lt;p&gt;I didn&apos;t have to modify any test, except for an OSGi configuration used in &lt;tt&gt;OakOSGiRepositoryFactoryTest&lt;/tt&gt;. This test uses a custom implementation of &lt;tt&gt;AuthorizableActionProvider&lt;/tt&gt;. so I had to provide a way to disable the default implementation. I could have disabled the component, but I personally like to have this option available via OSGi configuration. If this patch is applied, I would like to use the same strategy for the other components (but this is out of the scope of the current fix).&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chetanm&quot; class=&quot;user-hover&quot; rel=&quot;chetanm&quot;&gt;chetanm&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mreutegg&quot; class=&quot;user-hover&quot; rel=&quot;mreutegg&quot;&gt;mreutegg&lt;/a&gt;, can you have a look at the patch?&lt;/p&gt;
</comment>
                            <comment id="14734543" author="mreutegg" created="Tue, 8 Sep 2015 09:55:55 +0000"  >&lt;p&gt;With the most recent patch, the oak-pojosr tests run fine on my machine.&lt;/p&gt;

&lt;p&gt;FTR, my environment is:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Apache Maven 3.2.1 (ea8b2b07643dbb1b84b6d16e1f08391b666bc1e9; 2014-02-14T18:37:52+01:00)
Maven home: /Users/mreutegg/devel/apache/apache-maven-3.2.1
Java version: 1.7.0_67, vendor: Oracle Corporation
Java home: /Library/Java/JavaVirtualMachines/jdk1.7.0_67.jdk/Contents/Home/jre
Default locale: en_US, platform encoding: UTF-8
OS name: &quot;mac os x&quot;, version: &quot;10.10.5&quot;, arch: &quot;x86_64&quot;, family: &quot;mac&quot;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14734670" author="chetanm" created="Tue, 8 Sep 2015 11:36:10 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=frm&quot; class=&quot;user-hover&quot; rel=&quot;frm&quot;&gt;frm&lt;/a&gt; Can you provide some details on what is the intended behaviour for the patch. As it looks like above patch is changing the implementation behaviour of SecurityProvider. For e.g. current implementation support multiple RestrictionProvider (WhiteboardRestrictionProvider wraps all providers in a CompositeRestrictionProvider). With above patch the system would only have a single provider and we have some customers which provide there own providers here. Similar issue exist for some other references which are meant to be supporting multiple implementation.&lt;/p&gt;

&lt;p&gt;To provide some background on the problem have a look at &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-1476?focusedCommentId=13923888&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13923888&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;OAK-1476 comment&lt;/a&gt;. An easier solution would have been the use of cardinality.minimum support but that would require latest SCR implementation and hence cannot be used.&lt;/p&gt;

&lt;p&gt;Another possible approach would be to implement what &lt;tt&gt;cardinality.minimum&lt;/tt&gt; does but on our own. It would be similar to what we do in NodeStore impls to handle optional BlobStore support. So via OSGi config an admin can tell what all implementation are to be supported (cardinality!). And then we keep track of all such implementation getting registered either via a service tracker or via bind/unbind callback. Once its known that all required dependencies are fullfilled then security provider can register the service in service registry (i.e. keep the current securityproviderimpl just as a component). This way system only sees securityprovider when all its required dependencies are satisfied&lt;/p&gt;
</comment>
                            <comment id="14734718" author="frm" created="Tue, 8 Sep 2015 12:22:19 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chetanm&quot; class=&quot;user-hover&quot; rel=&quot;chetanm&quot;&gt;chetanm&lt;/a&gt;, I&apos;m aware of the change of behaviour. I decided to fix the issue this way because I didn&apos;t find contexts where &lt;tt&gt;SecurityProviderImpl&lt;/tt&gt; uses multiple implementations of its dependencies. &lt;/p&gt;

&lt;p&gt;Personally, I think that &lt;tt&gt;cardinality.minimum&lt;/tt&gt; is a workaround for a use case that was probably not well defined. &lt;tt&gt;cardinality.minimum&lt;/tt&gt; would prevent &lt;tt&gt;SecurityProviderImpl&lt;/tt&gt; to start unless the minimum amount of implementations for a reference are found. But who defines what is the minimum amount of implementations to expect? In example, just because Oak provides one implementation of &lt;tt&gt;AuthorizableActionProvider&lt;/tt&gt; that we use as a default, we can&apos;t arbitrarily use a &lt;tt&gt;cardinality.minimum=1&lt;/tt&gt; for the reference to &lt;tt&gt;AuthorizableActionProvider&lt;/tt&gt;. What if a user writes a custom implementation of &lt;tt&gt;AuthorizableActionProvider&lt;/tt&gt; that is supposed to live along our default implementation? What if this user wants &lt;tt&gt;SecurityProviderImpl&lt;/tt&gt; to start only if the two implementations of &lt;tt&gt;AuthorizableActionProvider&lt;/tt&gt; are available?&lt;/p&gt;

&lt;p&gt;Sure, we can define our own mechanism to substitute &lt;tt&gt;cardinality.minimum&lt;/tt&gt;. But I think that a different approach would be cleaner:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Create a new implementation of &lt;tt&gt;AuthorizableActionProvider&lt;/tt&gt;.&lt;/li&gt;
	&lt;li&gt;If multiple implementation of &lt;tt&gt;AuthorizableActionProvider&lt;/tt&gt; should be wired together, use &lt;tt&gt;CompositeAuthorizableActionProvider&lt;/tt&gt; as a base class for the implementation.&lt;/li&gt;
	&lt;li&gt;Register the new implementation.&lt;/li&gt;
	&lt;li&gt;Disable the default implementation or give the new implementation a higher service ranking (restart bundles as needed).&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;With this approach, we don&apos;t have to hardcode a &lt;tt&gt;cardinality.minimum&lt;/tt&gt; in &lt;tt&gt;SecurityManagerImpl&lt;/tt&gt;, or implement a similar mechanism on our own.&lt;/p&gt;

&lt;p&gt;This solution would also allowed us to switch to a dynamic approach, like we currently have. We could create an implementation like the following:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;DynamicAuthorizableActionProvider &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; AuthorizableActionProvider {
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; List&amp;lt;? &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; AuthorizableAction&amp;gt; getAuthorizableActions(@Nonnull SecurityProvider securityProvider) {
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; getComposite(lookupImplementationsOtherThanMe()).getAuthorizableActions(securityProvider)
  }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;But at least, it would be clear that, by using this dynamic solution, you could have a potentially half-iniitialized repository.&lt;/p&gt;</comment>
                            <comment id="14734953" author="chetanm" created="Tue, 8 Sep 2015 15:05:13 +0000"  >&lt;blockquote&gt;&lt;p&gt;Personally, I think that cardinality.minimum is a workaround for a use case that was probably not well defined. cardinality.minimum would prevent SecurityProviderImpl to start unless the minimum amount of implementations for a reference are found. But who defines what is the minimum amount of implementations to expect?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Thats the job of system administrator. As this depends on setup requirements and the system administrator would know that for this setup this many say restriction providers are required. For more details refer to &lt;a href=&quot;https://github.com/osgi/design/raw/master/rfcs/rfc0190/rfc-0190-Declarative_Services_Enhancements.pdf&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;5.10 of RFC 190&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;AuthorizableActionProvider&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think current impl of WhiteboardAuthorizableActionProvider is same as CompositeAuthorizableActionProvider. Do not see how the proposed approach is different. Same problem still exist for DynamicAuthorizableActionProvider. How would the component registering DynamicAuthorizableActionProvider know that all the providers are present and it should be registered. The problem just gets transferred here!&lt;/p&gt;

&lt;p&gt;I revisited the dependencies of SecurityProviderImpl and I think it can currently handle all the cases fine except for RestrictionProvider&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;WhiteboardAuthorizableNodeName - Fallbacks to DEFAULT in absence of any other implementation&lt;/li&gt;
	&lt;li&gt;WhiteboardAuthorizableActionProvider - This is just a callback. If any action is present that would be called otherwise noop&lt;/li&gt;
	&lt;li&gt;WhiteboardUserAuthenticationFactory - This also fallbacks to a default. If supporting factory is not present then that authentication call would fail&lt;/li&gt;
	&lt;li&gt;WhiteboardRestrictionProvider - This is the problamatic one where we have seen issue. The default impl used throws exception in all cases.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;All other cases are also designed for dynamic deployment. So we can either just fix the RestrictionProvider  by possibly following the approach we took with property index case OR we implement a solution where the security provider setup requirements are known via config and it is only published when all such requirements are known to be ready. Any system supporting multiple implementation and requiring all such multiple implementation must be ready faces such a problem!&lt;/p&gt;</comment>
                            <comment id="14736335" author="frm" created="Wed, 9 Sep 2015 07:06:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chetanm&quot; class=&quot;user-hover&quot; rel=&quot;chetanm&quot;&gt;chetanm&lt;/a&gt;, continuing the offline conversation we had yesterday, should we go with my solution as a first fix, and schedule another issue to improve on it when we have support for &lt;tt&gt;cardinality.minimum&lt;/tt&gt; in the OSGi version we support?&lt;/p&gt;</comment>
                            <comment id="14736341" author="chetanm" created="Wed, 9 Sep 2015 07:09:58 +0000"  >&lt;p&gt;I would not be comfortable with this fix. We cannot remove feature but then fixing stability issue is also important. If we go with your fix then customer making use of those extension points would not be able to do that&lt;/p&gt;</comment>
                            <comment id="14736349" author="frm" created="Wed, 9 Sep 2015 07:17:49 +0000"  >&lt;blockquote&gt;&lt;p&gt;If we go with your fix then customer making use of those extension points would not be able to do that.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Not true. They can still do it, but they have to register a new implementation of the extension and deactivate the new one. It&apos;s a compromise between the effort that a customer has to put in plugging in his implementation(s) and the stability of the repository at startup time. I personally think that the second is preferable.&lt;/p&gt;</comment>
                            <comment id="14736394" author="chetanm" created="Wed, 9 Sep 2015 07:57:42 +0000"  >&lt;blockquote&gt;&lt;p&gt;Not true. They can still do it, but they have to register a new implementation of the extension and deactivate the new one.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That would then be a backward compatibility change. Also problem related to 1..N kind of references like RestrictionProvider still exist. &lt;/p&gt;</comment>
                            <comment id="14736477" author="frm" created="Wed, 9 Sep 2015 08:51:30 +0000"  >&lt;p&gt;Every deployment using the current version of &lt;tt&gt;SecurityProviderImpl&lt;/tt&gt; is broken anyway. Maybe the bug didn&apos;t hit them, but it&apos;s there. Every time a repository starts up, there is a time window when the repository is not working as expected. Those systems have to be upgraded anyway, but only if they use multiple implementations of &lt;tt&gt;PrincipalConfiguration&lt;/tt&gt;, &lt;tt&gt;TokenConfiguration&lt;/tt&gt;, &lt;tt&gt;AuthorizableNodeName&lt;/tt&gt;, &lt;tt&gt;AuthorizableActionProvider&lt;/tt&gt;, &lt;tt&gt;RestrictionProvider&lt;/tt&gt;, or &lt;tt&gt;UserAuthenticationFactory&lt;/tt&gt;. If only one implementation is used, nothing has to be changed. My fix doesn&apos;t prevent the usage of multiple implementations of those interfaces, it just makes it less &quot;dynamic&quot;.&lt;/p&gt;

&lt;p&gt;Talking about dynamism, why the relationships to those interfaces are modeled that way? Do we really expect a &lt;tt&gt;RestrictionProvider&lt;/tt&gt; or an &lt;tt&gt;AuthorizableNodeName&lt;/tt&gt; to come and go at runtime?&lt;/p&gt;</comment>
                            <comment id="14736579" author="chetanm" created="Wed, 9 Sep 2015 10:00:29 +0000"  >&lt;blockquote&gt;&lt;p&gt;Every deployment using the current version of SecurityProviderImpl is broken anyway. Maybe the bug didn&apos;t hit them, but it&apos;s there.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Ack there is a race condition and a small potential window where security provider is not stable. But one fix cannot break other parts. We should still be able to come up with a fix which can address the current issue without breaking backward compatibility and loss of current featureset. Also even with current proposed approach it would not be possible to support multiple restriction providers &lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Talking about dynamism, why the relationships to those interfaces are modeled that way? Do we really expect a RestrictionProvider or an AuthorizableNodeName to come and go at runtime?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I cannot comment on that as I have not implemented that part. However for any logic which supports multiple implementations (kind of multiplexing) such problem exist&lt;/p&gt;</comment>
                            <comment id="14736730" author="dsuess" created="Wed, 9 Sep 2015 12:02:00 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=frm&quot; class=&quot;user-hover&quot; rel=&quot;frm&quot;&gt;frm&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chetanm&quot; class=&quot;user-hover&quot; rel=&quot;chetanm&quot;&gt;chetanm&lt;/a&gt; - Sling hit a simliar issue when introducing the pluggable ResourceProviders making the resourceResolverFactory available before the mandatory providers where available. Sling took a configuration approach where the ResoureResolverFactory can be configured with &quot;Required Providers&quot;. By default this is only the single entry &quot;org.apache.sling.jcr.resource.internal.helper.jcr.JcrResourceProviderFactory&quot; but any installation can define an own set of mandatory providers. The ResourceProviderFactory is only made available through the corresponding activator if the required provider are available.&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/sling/blob/trunk/bundles/resourceresolver/src/main/java/org/apache/sling/resourceresolver/impl/ResourceResolverFactoryActivator.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/sling/blob/trunk/bundles/resourceresolver/src/main/java/org/apache/sling/resourceresolver/impl/ResourceResolverFactoryActivator.java&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14736789" author="frm" created="Wed, 9 Sep 2015 12:53:54 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dsuess&quot; class=&quot;user-hover&quot; rel=&quot;dsuess&quot;&gt;dsuess&lt;/a&gt;, thanks for the pointer. I will try to rework my solution, hopefully meeting everyone&apos;s requirements.&lt;/p&gt;</comment>
                            <comment id="14737121" author="frm" created="Wed, 9 Sep 2015 16:21:06 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chetanm&quot; class=&quot;user-hover&quot; rel=&quot;chetanm&quot;&gt;chetanm&lt;/a&gt;, I started outlining a possible solution in &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12754940/12754940_OAK-3201-04.patch&quot; title=&quot;OAK-3201-04.patch attached to OAK-3201&quot;&gt;OAK-3201-04.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;, but I found very difficult to retrofit the current version of &lt;tt&gt;SecurityProviderImpl&lt;/tt&gt; - and related classes - to the solution.&lt;/p&gt;

&lt;p&gt;In particular, many classes require a &lt;tt&gt;SecurityProvider&lt;/tt&gt; to be injected. They usually save the injected instance of &lt;tt&gt;SecurityProvider&lt;/tt&gt; in an instance variable and use it for their purposes. In example, see &lt;tt&gt;ConfigurationBase&lt;/tt&gt;, the base class of many configuration classes.&lt;/p&gt;

&lt;p&gt;IMO this approach is wrong if there are multiple implementations of &lt;tt&gt;SecurityProvider&lt;/tt&gt; around using the same configurations. Do you have any idea about how to solve this problem without refactoring the internal APIs?&lt;/p&gt;</comment>
                            <comment id="14740568" author="chetanm" created="Fri, 11 Sep 2015 10:57:57 +0000"  >&lt;p&gt;Approach look fine now.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I found very difficult to retrofit the current version of SecurityProviderImpl - and related classes - to the solution.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Not getting the problem here. Current usage of SecurityProvider is quite intertwined but above approach would still work. I think most places the config is always fetched and not held on for long time. So at least for this issue we can probably live with that and look into refactoring it (for trunk) in a separate issue.&lt;/p&gt;</comment>
                            <comment id="14741165" author="frm" created="Fri, 11 Sep 2015 17:15:46 +0000"  >&lt;p&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12755447/12755447_OAK-3201-05.patch&quot; title=&quot;OAK-3201-05.patch attached to OAK-3201&quot;&gt;OAK-3201-05.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; finalizes the work of my previous patch. I have to add some tests, but the fix should be functionally complete. All the tests are passing on my machine.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chetanm&quot; class=&quot;user-hover&quot; rel=&quot;chetanm&quot;&gt;chetanm&lt;/a&gt;, can you have a look at it?&lt;/p&gt;</comment>
                            <comment id="14743121" author="mreutegg" created="Mon, 14 Sep 2015 08:32:10 +0000"  >&lt;p&gt;Bulk move to 1.3.7&lt;/p&gt;</comment>
                            <comment id="14743433" author="frm" created="Mon, 14 Sep 2015 12:20:59 +0000"  >&lt;p&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12755717/12755717_OAK-3201-06.patch&quot; title=&quot;OAK-3201-06.patch attached to OAK-3201&quot;&gt;OAK-3201-06.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; should be the final patch. Compared with the previous patch, I added tests in Oak PojoSR and fixed some minor issues that arose during testing. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chetanm&quot; class=&quot;user-hover&quot; rel=&quot;chetanm&quot;&gt;chetanm&lt;/a&gt;, feel free to review.&lt;/p&gt;</comment>
                            <comment id="14744985" author="frm" created="Tue, 15 Sep 2015 07:20:15 +0000"  >&lt;p&gt;I&apos;m pretty satisfied with the result, I&apos;m going to commit this today unless somebody finds a major blocker.&lt;/p&gt;</comment>
                            <comment id="14745023" author="chetanm" created="Tue, 15 Sep 2015 08:01:24 +0000"  >&lt;p&gt;Missed reviewing it due to other issues. Some quick comments &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;tt&gt;SecurityProviderRegistration&lt;/tt&gt; has a pretty big synchronized block. Holding synchronized block while making the registration can lead to deadlocks like the one we saw in &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-2401&quot; title=&quot;SegmentNodeStoreService prone to deadlocks&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-2401&quot;&gt;&lt;del&gt;OAK-2401&lt;/del&gt;&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;Having synchornized for all getServices might pose problem - Securityprovider is invoked on critical path in concurrent manner. So we should avoid having any synchronized blocks in getServices call. Note that default implementation of Whitboard makes quite an effort to avoid synchronized blocks in getServices call.&lt;/li&gt;
	&lt;li&gt;No default value for &lt;tt&gt;requiredServicePids&lt;/tt&gt;. For e.g. we already have &lt;tt&gt;RestrictionProviderImpl&lt;/tt&gt; registered as a service so it should be part of default pids otherwise current issue still remains i.e. if &lt;tt&gt;RestrictionProviderImpl&lt;/tt&gt; comes later then it would not picked up&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14745476" author="frm" created="Tue, 15 Sep 2015 13:46:44 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chetanm&quot; class=&quot;user-hover&quot; rel=&quot;chetanm&quot;&gt;chetanm&lt;/a&gt;, the latest patch should address your concerns. &lt;/p&gt;

&lt;p&gt;In particular, I used synchronization more sparingly, taking care of not calling OSGi or any external code while holding the lock. I also removed the need for locking in the &lt;tt&gt;getServices()&lt;/tt&gt; methods.&lt;/p&gt;

&lt;p&gt;I added a default value for the &lt;tt&gt;requiredServicePids&lt;/tt&gt; configuration property. The default components used by &lt;tt&gt;SecurityProviderImpl&lt;/tt&gt; now have &lt;tt&gt;immediate=true&lt;/tt&gt; in their definition, too.&lt;/p&gt;</comment>
                            <comment id="14747375" author="frm" created="Wed, 16 Sep 2015 11:59:59 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chetanm&quot; class=&quot;user-hover&quot; rel=&quot;chetanm&quot;&gt;chetanm&lt;/a&gt;, I implemented the changes we discussed offline in &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12756233/12756233_OAK-3201-08.patch&quot; title=&quot;OAK-3201-08.patch attached to OAK-3201&quot;&gt;OAK-3201-08.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;. Please review.&lt;/p&gt;</comment>
                            <comment id="14791662" author="chetanm" created="Thu, 17 Sep 2015 06:37:41 +0000"  >&lt;p&gt;Looks better!. Some more comments&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Setting immediate to true - That should not be required per se as DS can figure out that there is a requirement of services of given type and those components would be then activated. So some component would have dependency on SecurityProvider which in turn &lt;b&gt;expresses&lt;/b&gt; its dependency on various providers and thus DS would initialize them. So you can omit that change&lt;/li&gt;
	&lt;li&gt;SecurityProviderRegistrationTest - Various stub class can possibly be removed with Mocks.&lt;/li&gt;
	&lt;li&gt;Preconditions - areSatisfied - You can also use Guava Sets.difference there&lt;/li&gt;
	&lt;li&gt;SecurityProviderRegistration
	&lt;ul&gt;
		&lt;li&gt;createCompositePrincipalConfiguration, createCompositeTokenConfiguration - Given that by the time SecurityProvider is being constructed all the dependencies are met you can just as well populate the actual composites&lt;/li&gt;
		&lt;li&gt;createCompositeRestrictionProvider, createCompositeAuthorizableActionProvider - Here also we just well initialize the composites with required instances. This would prevent unnecessary garbage creation of a new list for every invocation&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;getRequiredServicePids - It would be better to also pass a default value there and not rely on metatype providing default values&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14791710" author="frm" created="Thu, 17 Sep 2015 07:25:44 +0000"  >&lt;blockquote&gt;&lt;p&gt;Setting immediate to true - That should not be required per se as DS can figure out that there is a requirement of services of given type and those components would be then activated. So some component would have dependency on SecurityProvider which in turn expresses its dependency on various providers and thus DS would initialize them. So you can omit that change.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I will revert those changes before committing (or if I post another patch for review, of course).&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;SecurityProviderRegistrationTest - Various stub class can possibly be removed with Mocks.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I hoped to use Groovy&apos;s MockFor, but it doesn&apos;t work. I will user Mockito instead.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Preconditions - areSatisfied - You can also use Guava Sets.difference there&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I will use Guava for that, but I will not propose a new patch for review because of this change.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;createCompositePrincipalConfiguration, createCompositeTokenConfiguration - Given that by the time SecurityProvider is being constructed all the dependencies are met you can just as well populate the actual composites.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This may work the first time, but it doesn&apos;t work if another, non-required PrincipalConfiguration or TokenConfiguration is subsequently bound to SecurityProviderRegistration. Moreover, an unregistration of the SecurityProvider followed by a registration creates a new instance of SecurityProvider that has to be bound to the configurations (again).&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;createCompositeRestrictionProvider, createCompositeAuthorizableActionProvider - Here also we just well initialize the composites with required instances. This would prevent unnecessary garbage creation of a new list for every invocation.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Similar problem of the point above. New, non-required instances of RestrictionProvider or AuthorizableActionProvider can be bound at any time after the registration of the SecurityProvider.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;getRequiredServicePids - It would be better to also pass a default value there and not rely on metatype providing default values.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I already provide a default value, which is the empty array. If you think that the default value should be the PIDs of services that I think should be required, I don&apos;t feel comfortable with that. If the list of required PIDs change over time, I don&apos;t want to recompile oak-core because the default value was hardcoded in SecurityProviderRegistration.&lt;/p&gt;</comment>
                            <comment id="14791725" author="chetanm" created="Thu, 17 Sep 2015 07:38:13 +0000"  >&lt;blockquote&gt;&lt;p&gt;This may work the first time, but it doesn&apos;t work if another, non-required PrincipalConfiguration or TokenConfiguration is subsequently bound to SecurityProviderRegistration.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I thought that it was concluded that Security system technically cannot support OSGi dynamics i.e. all such dependencies are considered required. None of the dependency can be considered optional at all as its hard to reason for scenarios where SecurityProvider continues to work in absence of an optional dependency. &lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Moreover, an unregistration of the SecurityProvider followed by a registration creates a new instance of SecurityProvider that has to be bound to the configurations (again).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yup but I do not see how that is related to current proposed approach. SecurityProvider goes away -&amp;gt; Repository shutdown and thus all other sub system stop making use of that config. SecurityProvider comes again -&amp;gt; Repository starts again and then all other sub system fetch new config. &lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I already provide a default value, which is the empty array. If you think that the default value should be the PIDs of services that I think should be required, I don&apos;t feel comfortable with that.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I am not very sure but then it needs to be validated with a test. Just specifying the default value would only help in populating the config form in Felix Web Console. As the component does not have config policy of required it would start without any explicit config and in that case the pid would be null. So once we make this change then for it to be really effective we would also need to provision the default config. So something to be aware of &lt;/p&gt;</comment>
                            <comment id="14791761" author="frm" created="Thu, 17 Sep 2015 08:12:25 +0000"  >&lt;blockquote&gt;&lt;p&gt;Yup but I do not see how that is related to current proposed approach. SecurityProvider goes away -&amp;gt; Repository shutdown and thus all other sub system stop making use of that config. SecurityProvider comes again -&amp;gt; Repository starts again and then all other sub system fetch new config.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Since the patch does exactly that (and also handle dynamic dependencies, which are anyway discouraged), I think we could agree that the proposed approach is correct.&lt;/p&gt;</comment>
                            <comment id="14791812" author="frm" created="Thu, 17 Sep 2015 09:02:18 +0000"  >&lt;p&gt;Just for completeness, &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12756443/12756443_OAK-3201-09.patch&quot; title=&quot;OAK-3201-09.patch attached to OAK-3201&quot;&gt;OAK-3201-09.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; contains the latest modifications discussed today. If there are no major blockers, I&apos;m going to commit it today.&lt;/p&gt;</comment>
                            <comment id="14805138" author="frm" created="Fri, 18 Sep 2015 07:35:33 +0000"  >&lt;p&gt;Committed in trunk in r1703758.&lt;/p&gt;</comment>
                            <comment id="14906023" author="frm" created="Thu, 24 Sep 2015 08:41:43 +0000"  >&lt;p&gt;Backported to 1.2 in r1705014.&lt;/p&gt;</comment>
                            <comment id="14906236" author="frm" created="Thu, 24 Sep 2015 11:44:36 +0000"  >&lt;p&gt;Backported to 1.0 in r1705037.&lt;/p&gt;</comment>
                            <comment id="14939251" author="amitjain" created="Thu, 1 Oct 2015 03:35:15 +0000"  >&lt;p&gt;Bulk close for 1.3.7&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12862170">OAK-3358</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12863081">OAK-3392</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12749785" name="OAK-3201-01.patch" size="4702" author="frm" created="Tue, 11 Aug 2015 07:47:41 +0000"/>
                            <attachment id="12754346" name="OAK-3201-02.patch" size="12575" author="frm" created="Sat, 5 Sep 2015 20:15:51 +0000"/>
                            <attachment id="12754600" name="OAK-3201-03.patch" size="24034" author="frm" created="Tue, 8 Sep 2015 08:55:25 +0000"/>
                            <attachment id="12754940" name="OAK-3201-04.patch" size="15143" author="frm" created="Wed, 9 Sep 2015 16:21:06 +0000"/>
                            <attachment id="12755447" name="OAK-3201-05.patch" size="49358" author="frm" created="Fri, 11 Sep 2015 17:15:46 +0000"/>
                            <attachment id="12755717" name="OAK-3201-06.patch" size="64540" author="frm" created="Mon, 14 Sep 2015 12:20:59 +0000"/>
                            <attachment id="12756007" name="OAK-3201-07.patch" size="81300" author="frm" created="Tue, 15 Sep 2015 13:46:44 +0000"/>
                            <attachment id="12756233" name="OAK-3201-08.patch" size="69900" author="frm" created="Wed, 16 Sep 2015 11:59:59 +0000"/>
                            <attachment id="12756443" name="OAK-3201-09.patch" size="58106" author="frm" created="Thu, 17 Sep 2015 09:02:18 +0000"/>
                            <attachment id="12754479" name="mbean-test.log" size="32457" author="chetanm" created="Mon, 7 Sep 2015 11:17:29 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>10.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 7 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2iixj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>