<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:46:45 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-2056] Optimize orderings by date fields</title>
                <link>https://issues.apache.org/jira/browse/OAK-2056</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;Sorting by date fields is very slow in oak, especially if result set size is large.&lt;/p&gt;

&lt;p&gt;I&apos;m running the following JCR-SQL2 query&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;SELECT * FROM [cq:PageContent] AS [c] WHERE ISDESCENDANTNODE(&lt;span class=&quot;code-quote&quot;&gt;&apos;/content&apos;&lt;/span&gt;)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;which returns 3270 results on my oak repo.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Query execution times are as below
---------------------------------------
No order clause 		|  0,147 sec
ORDER BY [jcr:title]	        |  1,203 sec
ORDER BY [jcr:createdBy]	|  1,018 sec
ORDER BY [jcr:created]		| 25,229 sec
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Ordering by date field adds extra 24 seconds overhead.&lt;/p&gt;
</description>
                <environment></environment>
        <key id="12737059">OAK-2056</key>
            <summary>Optimize orderings by date fields</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="edivad">Davide Giannella</assignee>
                                    <reporter username="ppakulski">Przemyslaw Pakulski</reporter>
                        <labels>
                            <label>performance</label>
                    </labels>
                <created>Wed, 27 Aug 2014 09:34:55 +0000</created>
                <updated>Fri, 30 Jan 2015 12:30:26 +0000</updated>
                            <resolved>Wed, 17 Dec 2014 14:54:31 +0000</resolved>
                                    <version>1.0.4</version>
                    <version>1.0.8</version>
                                    <fixVersion>1.1.4</fixVersion>
                                    <component>query</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14112094" author="ppakulski" created="Wed, 27 Aug 2014 09:48:28 +0000"  >&lt;p&gt;I think the reason is that comparator used to sort results have to parse date each time when a comparison is needed.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;PropertyStateValue.compareAsDate(...) {
...
            Calendar c1 = ISO8601.parse(v1);
            Calendar c2 = ISO8601.parse(v2);
...
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And number of comparisons grows exponentially with a large size of results.&lt;/p&gt;

&lt;p&gt;Is there any reason why dates are using &lt;em&gt;GenericPropertyState&lt;/em&gt; which keeps internally date as string ? &lt;br/&gt;
Can we instead create a &lt;em&gt;&quot;DatePropertyState&quot;&lt;/em&gt; which keeps date as a long or Calendar?&lt;/p&gt;</comment>
                            <comment id="14112111" author="mduerig" created="Wed, 27 Aug 2014 10:19:00 +0000"  >&lt;blockquote&gt;&lt;p&gt;Is there any reason why dates are using GenericPropertyState which keeps internally date as string ?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-1111&quot; title=&quot;Node#setProperty(String, Calendar) doesn&amp;#39;t take time zone in account&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-1111&quot;&gt;&lt;del&gt;OAK-1111&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14242448" author="ppakulski" created="Thu, 11 Dec 2014 12:04:16 +0000"  >&lt;p&gt;Any plans to fix it ?&lt;/p&gt;

&lt;p&gt;If we have to store dates as strings, it would  be good to limit number of conversions at least which are quite expensive.&lt;/p&gt;

&lt;p&gt;I&apos;ve take a look, but cannot see good place to change it.&lt;/p&gt;</comment>
                            <comment id="14244035" author="edivad" created="Fri, 12 Dec 2014 11:58:31 +0000"  >&lt;p&gt;Committed in &lt;a href=&quot;http://svn.apache.org/r1644863&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1644863&lt;/a&gt; (trunk) a scalability&lt;br/&gt;
benchmark for measuring any potential code changes in the future.&lt;/p&gt;

&lt;p&gt;Run on my local with the command &lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java -Xmx2048m -Dincrements=&quot;10,100,1000,5000&quot; -Dindex=false \
   -jar oak-run*.jar scalability \
   --base /var/tmp/oak/ ScalabilityBlobSearchSuite:OrderByDate Oak-Tar
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;and these are the results&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;# OrderByDate                      min     10%     50%     90%     max       N
Oak-Tar                             31      31     764   35351   35351       4
	# Iterations/Load           	10	100	1000	5000
	Time (ms)                    	31     	51     	1476   	35351  
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14244445" author="edivad" created="Fri, 12 Dec 2014 16:59:23 +0000"  >&lt;p&gt;In &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12686877/12686877_OAK-2056-r1.patch&quot; title=&quot;OAK-2056-r1.patch attached to OAK-2056&quot;&gt;OAK-2056-r1.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; a proposal for a change in the compareTo&lt;br/&gt;
method. Basically I fell back to string literals in case of same time&lt;br/&gt;
zone that should be the most common use case.&lt;/p&gt;

&lt;p&gt;The new numbers with the patch in place are:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;# OrderByDate                      min     10%     50%     90%     max       N
Oak-Tar                             21      21     124    3903    3903       4
    # Iterations/Load               10     100     1000     5000
    Time (ms)                       23      21      225     3903
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;if did correctly the math we&apos;re in the range of 80-90% faster.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mduerig&quot; class=&quot;user-hover&quot; rel=&quot;mduerig&quot;&gt;mduerig&lt;/a&gt; could you please review the patch. If fine I&apos;ll commit to&lt;br/&gt;
trunk.&lt;/p&gt;

</comment>
                            <comment id="14244488" author="mduerig" created="Fri, 12 Dec 2014 17:37:04 +0000"  >&lt;p&gt;Dunno ISO8601 date format form the inside out. But from a quick glance the patch looks fine.&lt;/p&gt;</comment>
                            <comment id="14246447" author="edivad" created="Mon, 15 Dec 2014 08:31:45 +0000"  >&lt;p&gt;Gave a look at the function code and wikipedia page. Plus I covered the whole function with unit testing. Personally I&apos;m confident.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mduerig&quot; class=&quot;user-hover&quot; rel=&quot;mduerig&quot;&gt;mduerig&lt;/a&gt; can you think on a way to extend the unit testing? If not I&apos;ll commit.&lt;/p&gt;
</comment>
                            <comment id="14249729" author="ppakulski" created="Wed, 17 Dec 2014 11:25:06 +0000"  >&lt;p&gt;I can confirm, It helped with my queries as well. Ordering timings by date fields are now comparable to other types (e.g. strings).&lt;/p&gt;

&lt;p&gt;Any chance to include it in upcoming release ?&lt;/p&gt;</comment>
                            <comment id="14249933" author="edivad" created="Wed, 17 Dec 2014 14:54:31 +0000"  >&lt;p&gt;Committed to trunk at &lt;a href=&quot;http://svn.apache.org/r1646274&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1646274&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Marking as resolved. We&apos;ll follow-up with bugs in case.&lt;/p&gt;</comment>
                            <comment id="14274893" author="edivad" created="Tue, 13 Jan 2015 08:14:28 +0000"  >&lt;p&gt;Bulk close for 1.1.4&lt;/p&gt;</comment>
                            <comment id="14298568" author="ppakulski" created="Fri, 30 Jan 2015 12:30:26 +0000"  >&lt;p&gt;As the fix is pretty save and tested already, I would like to have it ported to 1.0.x branch and included in 1.0.12.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12686877" name="OAK-2056-r1.patch" size="8668" author="edivad" created="Fri, 12 Dec 2014 16:59:23 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 42 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1zdvr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>