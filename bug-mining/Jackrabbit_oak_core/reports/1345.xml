<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:49:20 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-3371] Wrong evaluation of NOT clause</title>
                <link>https://issues.apache.org/jira/browse/OAK-3371</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;When executing a query like &lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;SELECT * FROM [nt:unstructured] WHERE ISDESCENDANTNODE([/test]) AND NOT CONTAINS(foo, &apos;bar&apos;)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;and the &lt;tt&gt;nodeType&lt;/tt&gt; index plays the not clause is not applied properly. Nodes *&lt;b&gt;with&lt;/b&gt;* the property are returned as well.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12754606/12754606_OAK-3371-test.diff&quot; title=&quot;OAK-3371-test.diff attached to OAK-3371&quot;&gt;test&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; showing the bug.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12862368">OAK-3371</key>
            <summary>Wrong evaluation of NOT clause</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="edivad">Davide Giannella</assignee>
                                    <reporter username="edivad">Davide Giannella</reporter>
                        <labels>
                    </labels>
                <created>Tue, 8 Sep 2015 09:43:52 +0000</created>
                <updated>Tue, 8 Oct 2019 15:21:56 +0000</updated>
                            <resolved>Thu, 1 Oct 2015 12:43:56 +0000</resolved>
                                    <version>1.2.4</version>
                    <version>1.3.5</version>
                                    <fixVersion>1.2.7</fixVersion>
                    <fixVersion>1.3.8</fixVersion>
                    <fixVersion>1.4</fixVersion>
                                    <component>query</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="14734622" author="edivad" created="Tue, 8 Sep 2015 11:02:23 +0000"  >&lt;p&gt;Quick analysis. &lt;/p&gt;

&lt;p&gt;Nodetype index should not play in case of full-text queries. The&lt;br/&gt;
full-text condition doesn&apos;t make it to the filter, nor as &lt;tt&gt;not&lt;/tt&gt; nor&lt;br/&gt;
as &lt;tt&gt;full-text&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;This makes the nodetype index not aware of the full-text condition and&lt;br/&gt;
returns all the nodes that matches the path condition.&lt;/p&gt;

&lt;p&gt;With &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-2050&quot; title=&quot;Query engine: disable or restrict built-in full-text engine&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-2050&quot;&gt;&lt;del&gt;OAK-2050&lt;/del&gt;&lt;/a&gt; we removed the support of Fulltext queries from the&lt;br/&gt;
query engine saying that full-text queries should be played only by a&lt;br/&gt;
full-text index (ie: lucene or solr).&lt;/p&gt;

&lt;p&gt;Lucene should already be able to support a single &lt;tt&gt;NOT CONTAINS()&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;So the next steps are:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;find a way to represent &lt;tt&gt;NOT CONTAINS()&lt;/tt&gt; in the Filter as a&lt;br/&gt;
  fulltext&lt;/li&gt;
	&lt;li&gt;Nodetype index should then not play any longer&lt;/li&gt;
	&lt;li&gt;Ensure lucene handle correctly the condition.&lt;/li&gt;
	&lt;li&gt;Ensure Solr handle correctly the condition.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;/cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thomasm&quot; class=&quot;user-hover&quot; rel=&quot;thomasm&quot;&gt;thomasm&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chetanm&quot; class=&quot;user-hover&quot; rel=&quot;chetanm&quot;&gt;chetanm&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=teofili&quot; class=&quot;user-hover&quot; rel=&quot;teofili&quot;&gt;teofili&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14738883" author="edivad" created="Thu, 10 Sep 2015 15:06:16 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chetanm&quot; class=&quot;user-hover&quot; rel=&quot;chetanm&quot;&gt;chetanm&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thomasm&quot; class=&quot;user-hover&quot; rel=&quot;thomasm&quot;&gt;thomasm&lt;/a&gt; could you please review the &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12755146/12755146_OAK-3371.patch&quot; title=&quot;OAK-3371.patch attached to OAK-3371&quot;&gt;attached patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; that solves the issue. Ideally I&apos;d like to resolve it for 1.3.6.&lt;/p&gt;</comment>
                            <comment id="14739070" author="edivad" created="Thu, 10 Sep 2015 16:35:43 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chetanm&quot; class=&quot;user-hover&quot; rel=&quot;chetanm&quot;&gt;chetanm&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thomasm&quot; class=&quot;user-hover&quot; rel=&quot;thomasm&quot;&gt;thomasm&lt;/a&gt;: was carrying out some more tests and the&lt;br/&gt;
above patch while works with lucene property index, does not work with&lt;br/&gt;
lucene aggregate v1. If you want to give a preliminary overview it&apos;s&lt;br/&gt;
welcome but I&apos;ll submit a new one.&lt;/p&gt;</comment>
                            <comment id="14739634" author="edivad" created="Thu, 10 Sep 2015 21:28:12 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chetanm&quot; class=&quot;user-hover&quot; rel=&quot;chetanm&quot;&gt;chetanm&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thomasm&quot; class=&quot;user-hover&quot; rel=&quot;thomasm&quot;&gt;thomasm&lt;/a&gt;: &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12755233/12755233_OAK-3371-2.patch&quot; title=&quot;OAK-3371-2.patch attached to OAK-3371&quot;&gt;second patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; for reviewing. thanks.&lt;/p&gt;</comment>
                            <comment id="14740249" author="tmueller" created="Fri, 11 Sep 2015 06:00:21 +0000"  >&lt;p&gt;Generally, it looks good, I like the approach. There are a few minor things I would like to change: I don&apos;t like the &quot;instanceof&quot; check there. I think it&apos;s possible to avoid it, or move it to the &quot;simplify&quot; method. The method name &quot;restrictPropertyOnFilter&quot;: it seems to be unnecessary, as the same can be done using &quot;enforcePropertyExistence&quot;.&lt;/p&gt;

&lt;p&gt;I will try to work on the patch and upload a new one.&lt;/p&gt;</comment>
                            <comment id="14740522" author="edivad" created="Fri, 11 Sep 2015 10:10:42 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thomasm&quot; class=&quot;user-hover&quot; rel=&quot;thomasm&quot;&gt;thomasm&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I don&apos;t like the &quot;instanceof&quot; check there. I think it&apos;s possible to avoid it, or move it to the &quot;simplify&quot; method.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I don&apos;t like it either but didn&apos;t find any other way so far. I thought as well of the simplify but didn&apos;t actually try it out.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;The method name &quot;restrictPropertyOnFilter&quot;: it seems to be unnecessary, as the same can be done using &quot;enforcePropertyExistence&quot;.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;missed this one.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I will try to work on the patch and upload a new one.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Waiting for it. In the meantime I&apos;m looking more in details at the test coverage as it&apos;s not convincing me 100%.&lt;/p&gt;</comment>
                            <comment id="14740562" author="edivad" created="Fri, 11 Sep 2015 10:51:11 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thomasm&quot; class=&quot;user-hover&quot; rel=&quot;thomasm&quot;&gt;thomasm&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chetanm&quot; class=&quot;user-hover&quot; rel=&quot;chetanm&quot;&gt;chetanm&lt;/a&gt; there&apos;s an edge case in case of lucene&lt;br/&gt;
aggregate v1.&lt;/p&gt;

&lt;p&gt;If you specify an aggregation rule, let&apos;s say&lt;br/&gt;
&lt;tt&gt;[nt:folder]/[subnode]&lt;/tt&gt; and then you perform a query like &lt;br/&gt;
&lt;tt&gt;from [nt:folder] where not contains(foo, &apos;bar&apos;)&lt;/tt&gt;; a node like &lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;{{ test { jcr:primaryType = nt:folder, foo = bar, subnode : { ... } } }}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;where &lt;tt&gt;subnode&lt;/tt&gt; does not have the &lt;tt&gt;foo&lt;/tt&gt; property or it&apos;s not set&lt;br/&gt;
to &lt;tt&gt;bar&lt;/tt&gt;, will be returned anyhow as of the aggregation rule. I&lt;br/&gt;
personally don&apos;t consider this an issue, rather an expected behaviour.&lt;/p&gt;

&lt;p&gt;Thoughts?&lt;/p&gt;
</comment>
                            <comment id="14743153" author="mreutegg" created="Mon, 14 Sep 2015 08:32:15 +0000"  >&lt;p&gt;Bulk move to 1.3.7&lt;/p&gt;</comment>
                            <comment id="14745325" author="tmueller" created="Tue, 15 Sep 2015 12:15:06 +0000"  >&lt;p&gt;I think the following case doesn&apos;t work: &lt;tt&gt;contains(x, &apos;foo bar&apos;)&lt;/tt&gt;. It looks like this is converted to &quot;-foo bar&quot;, but that sounds wrong.&lt;/p&gt;

&lt;p&gt;I think more tests are needed.&lt;/p&gt;</comment>
                            <comment id="14745333" author="tmueller" created="Tue, 15 Sep 2015 12:20:52 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-3371&quot; title=&quot;Wrong evaluation of NOT clause&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-3371&quot;&gt;&lt;del&gt;OAK-3371&lt;/del&gt;&lt;/a&gt;-3-oak-core.patch (just the oak-core part).&lt;br/&gt;
More work is needed (additional test, fix the &quot;not contains(., &apos;foo bar&apos;)&quot; issue)&lt;/p&gt;</comment>
                            <comment id="14900693" author="edivad" created="Mon, 21 Sep 2015 13:32:48 +0000"  >&lt;p&gt;By looking at &lt;a href=&quot;http://www.day.com/specs/jcr/2.0/6_Query.html#6.7.19%20FullTextSearch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.day.com/specs/jcr/2.0/6_Query.html#6.7.19%20FullTextSearch&lt;/a&gt;&lt;br/&gt;
I understand that a query in the format &lt;tt&gt;not contains (x, &apos;foo bar&apos;&lt;/tt&gt;&lt;br/&gt;
has to be translated into &lt;tt&gt;(not contains(x, &apos;foo&apos;) and not contains(x, bar))&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Read it as all the terms in the fulltext separated by white space must&lt;br/&gt;
be ANDed.&lt;/p&gt;

&lt;p&gt;Will start working towards it.&lt;/p&gt;

&lt;p&gt;Gave a look at your patch, but understanding the diff on top my diff&lt;br/&gt;
it&apos;s rather tricky. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

</comment>
                            <comment id="14900900" author="edivad" created="Mon, 21 Sep 2015 16:13:10 +0000"  >&lt;p&gt;In &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12761454/12761454_OAK-3371-4-notworking.patch&quot; title=&quot;OAK-3371-4-notworking.patch attached to OAK-3371&quot;&gt;OAK-3371-4-notworking.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; a full new patch (not working) where&lt;br/&gt;
I try to cover the use case of &lt;tt&gt;not contains(x, &apos;foo bar&apos;)&lt;/tt&gt;. So far&lt;br/&gt;
I didn&apos;t manage to identify the correct lucene plan to be sent.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chetanm&quot; class=&quot;user-hover&quot; rel=&quot;chetanm&quot;&gt;chetanm&lt;/a&gt; could you please have a look?&lt;/p&gt;
</comment>
                            <comment id="14902260" author="chetanm" created="Tue, 22 Sep 2015 09:02:32 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=edivad&quot; class=&quot;user-hover&quot; rel=&quot;edivad&quot;&gt;edivad&lt;/a&gt; For me testcase is failing at &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        assertQuery(
            &lt;span class=&quot;code-quote&quot;&gt;&quot;SELECT * FROM [nt:unstructured] WHERE ISDESCENDANTNODE(&lt;span class=&quot;code-quote&quot;&gt;&apos;/test&apos;&lt;/span&gt;) AND CONTAINS(foo, &lt;span class=&quot;code-quote&quot;&gt;&apos;bar OR cat&apos;&lt;/span&gt;)&quot;&lt;/span&gt;,
            of(&lt;span class=&quot;code-quote&quot;&gt;&quot;/test/d&quot;&lt;/span&gt;));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;With &lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.lang.AssertionError: Result set size is different 
Expected :1
Actual   :3
 &amp;lt;Click to see difference&amp;gt;
	at org.junit.Assert.fail(Assert.java:93)
	at org.junit.Assert.failNotEquals(Assert.java:647)
	at org.junit.Assert.assertEquals(Assert.java:128)
	at org.junit.Assert.assertEquals(Assert.java:472)
	at org.apache.jackrabbit.oak.query.AbstractQueryTest.assertQuery(AbstractQueryTest.java:314)
	at org.apache.jackrabbit.oak.query.AbstractQueryTest.assertQuery(AbstractQueryTest.java:305)
	at org.apache.jackrabbit.oak.query.AbstractQueryTest.assertQuery(AbstractQueryTest.java:283)
	at org.apache.jackrabbit.oak.plugins.index.lucene.LuceneIndexQueryTest.oak3371(LuceneIndexQueryTest.java:549)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I was expecting the last assertion to fail. So before I dig further wanted to check if thats the current state of patch or I missed something?&lt;/p&gt;</comment>
                            <comment id="14902356" author="edivad" created="Tue, 22 Sep 2015 10:23:55 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chetanm&quot; class=&quot;user-hover&quot; rel=&quot;chetanm&quot;&gt;chetanm&lt;/a&gt; I think is a left over in the test. Let me check &apos;cause it was not there when I checked in. Will provide a new patch or ping you directly.&lt;/p&gt;</comment>
                            <comment id="14902642" author="edivad" created="Tue, 22 Sep 2015 13:44:22 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chetanm&quot; class=&quot;user-hover&quot; rel=&quot;chetanm&quot;&gt;chetanm&lt;/a&gt; here is the &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12761649/12761649_OAK-3371-5-notworking.patch&quot; title=&quot;OAK-3371-5-notworking.patch attached to OAK-3371&quot;&gt;patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; with the&lt;br/&gt;
failing test. Can you help out on the lucene side of the query?&lt;/p&gt;</comment>
                            <comment id="14904651" author="edivad" created="Wed, 23 Sep 2015 15:23:34 +0000"  >&lt;p&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12761908/12761908_OAK-3371-6.patch&quot; title=&quot;OAK-3371-6.patch attached to OAK-3371&quot;&gt;updated patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; that covers and solve the double not&lt;br/&gt;
contains.&lt;/p&gt;

&lt;p&gt;Still have the instanceof in place.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thomasm&quot; class=&quot;user-hover&quot; rel=&quot;thomasm&quot;&gt;thomasm&lt;/a&gt; please review. In case you want to submit a patch with&lt;br/&gt;
improvements, please make it against my patch in place or it will be&lt;br/&gt;
difficult to understand what you changed.&lt;/p&gt;
</comment>
                            <comment id="14939614" author="edivad" created="Thu, 1 Oct 2015 10:00:15 +0000"  >&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;trunk: &lt;a href=&quot;https://svn.apache.org/r1706212&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1706212&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;1.2: &lt;a href=&quot;https://svn.apache.org/r1706216&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1706216&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14950365" author="edivad" created="Fri, 9 Oct 2015 13:22:14 +0000"  >&lt;p&gt;Bulk close for 1.2.7&lt;/p&gt;</comment>
                            <comment id="16221907" author="tmueller" created="Fri, 27 Oct 2017 08:09:10 +0000"  >&lt;p&gt;One question is, what does the following query mean:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;/jcr:root//*[jcr:contains(., &apos;-test&apos;)]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The current (and I think correct) interpretation is: return all nodes (of the whole repository), except those that contains the term &quot;test&quot;.&lt;/p&gt;</comment>
                            <comment id="16221909" author="tmueller" created="Fri, 27 Oct 2017 08:14:51 +0000"  >&lt;p&gt;For testing, I made a patch (with a test case) for a different interpretation of the the query above: with the patch, the query doesn&apos;t return all nodes (except those that contain &apos;test&apos;), but returns all nodes &lt;em&gt;in the index&lt;/em&gt; (except those that contain &apos;test&apos;). I think that interpretation is not correct, but I include the patch here for reference: &lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;### Eclipse Workspace Patch 1.0
#P oak-lucene
Index: src/test/java/org/apache/jackrabbit/oak/plugins/index/lucene/LuceneIndexQueryTest.java
===================================================================
--- src/test/java/org/apache/jackrabbit/oak/plugins/index/lucene/LuceneIndexQueryTest.java	(revision 1813478)
+++ src/test/java/org/apache/jackrabbit/oak/plugins/index/lucene/LuceneIndexQueryTest.java	(working copy)
@@ -20,6 +20,7 @@
 
 import java.util.ArrayList;
 import java.util.Iterator;
+import java.util.List;
 
 import org.apache.jackrabbit.oak.Oak;
 import org.apache.jackrabbit.oak.api.ContentRepository;
@@ -31,6 +32,7 @@
 import org.apache.jackrabbit.oak.spi.commit.Observer;
 import org.apache.jackrabbit.oak.spi.query.QueryIndexProvider;
 import org.apache.jackrabbit.oak.spi.security.OpenSecurityProvider;
+import org.junit.Assert;
 import org.junit.Ignore;
 import org.junit.Test;
 
@@ -182,6 +186,51 @@
 
     }
 
+    @Test
+    public void containsNot() throws Exception {
+
+        // see also OAK-3371
+        // &quot;if we have only NOT CLAUSES we have to add a match all docs (*.*) for the
+        // query to work&quot;
+
+        String planPrefix = &quot;[nt:base] as [a] /* lucene:test-index(/oak:index/test-index) &quot;;
+
+        assertXPathPlan(&quot;/jcr:root//*[@a]&quot;,
+                planPrefix + &quot;a:[* TO *]&quot;);
+
+        assertXPathPlan(&quot;/jcr:root//*[jcr:contains(., &apos;*&apos;)]&quot;,
+                planPrefix + &quot;:fulltext:* ft:(\&quot;*\&quot;)&quot;);
+
+        assertXPathPlan(&quot;/jcr:root//*[jcr:contains(@a,&apos;*&apos;)]&quot;,
+                planPrefix + &quot;full:a:* ft:(a:\&quot;*\&quot;)&quot;);
+
+        assertXPathPlan(&quot;/jcr:root//*[jcr:contains(@a,&apos;hello -world&apos;)]&quot;,
+                planPrefix + &quot;+full:a:hello -full:a:world ft:(a:\&quot;hello\&quot; -a:\&quot;world\&quot;)&quot;);
+
+        assertXPathPlan(&quot;/jcr:root//*[jcr:contains(@a,&apos;test*&apos;)]&quot;,
+                planPrefix + &quot;full:a:test* ft:(a:\&quot;test*\&quot;)&quot;);
+
+        assertXPathPlan(&quot;/jcr:root//*[jcr:contains(@a,&apos;-test&apos;)]&quot;,
+                planPrefix + &quot;-full:a:test full:a:[* TO *] ft:(-a:\&quot;test\&quot;)&quot;);
+
+        assertXPathPlan(&quot;/jcr:root//*[jcr:contains(@a,&apos;-test*&apos;)]&quot;,
+                planPrefix + &quot;-full:a:test* full:a:[* TO *] ft:(-a:\&quot;test*\&quot;)&quot;);
+
+        assertXPathPlan(&quot;/jcr:root//*[jcr:contains(., &apos;-*&apos;)]&quot;,
+                planPrefix + &quot;-:fulltext:* :fulltext:[* TO *] ft:(-\&quot;*\&quot;)&quot;);
+
+    }
+
+    private void assertXPathPlan(String xpathQuery, String expectedPlan) {
+        List&amp;lt;String&amp;gt; result = executeQuery(&quot;explain &quot; + xpathQuery, &quot;xpath&quot;, false);
+        String plan = result.get(0);
+        int newline = plan.indexOf(&apos;\n&apos;);
+        if (newline &amp;gt;= 0) {
+            plan = plan.substring(0, newline);
+        }
+        Assert.assertEquals(expectedPlan, plan);
+    }
+
     @Ignore(&quot;OAK-2424&quot;)
     @Test
     public void containsDash() throws Exception {
Index: src/main/java/org/apache/jackrabbit/oak/plugins/index/lucene/LucenePropertyIndex.java
===================================================================
--- src/main/java/org/apache/jackrabbit/oak/plugins/index/lucene/LucenePropertyIndex.java	(revision 1813478)
+++ src/main/java/org/apache/jackrabbit/oak/plugins/index/lucene/LucenePropertyIndex.java	(working copy)
@@ -27,6 +27,7 @@
 import java.util.Arrays;
 import java.util.Collection;
 import java.util.Deque;
+import java.util.HashSet;
 import java.util.Iterator;
 import java.util.LinkedList;
 import java.util.List;
@@ -60,6 +61,7 @@
 import org.apache.jackrabbit.oak.plugins.index.lucene.util.SpellcheckHelper;
 import org.apache.jackrabbit.oak.plugins.index.lucene.util.SuggestHelper;
 import org.apache.jackrabbit.oak.plugins.memory.PropertyValues;
+import org.apache.jackrabbit.oak.query.FilterIterators;
 import org.apache.jackrabbit.oak.spi.query.fulltext.FullTextAnd;
 import org.apache.jackrabbit.oak.spi.query.fulltext.FullTextContains;
 import org.apache.jackrabbit.oak.spi.query.fulltext.FullTextExpression;
@@ -101,6 +103,7 @@
 import org.apache.lucene.search.BooleanQuery;
 import org.apache.lucene.search.IndexSearcher;
 import org.apache.lucene.search.MatchAllDocsQuery;
+import org.apache.lucene.search.MultiTermQuery;
 import org.apache.lucene.search.NumericRangeQuery;
 import org.apache.lucene.search.PrefixQuery;
 import org.apache.lucene.search.Query;
@@ -936,16 +939,33 @@
             if (q instanceof BooleanQuery) {
                 BooleanQuery ibq = (BooleanQuery) q;
                 boolean onlyNotClauses = true;
+                HashSet&amp;lt;String&amp;gt; fields = new HashSet&amp;lt;String&amp;gt;();
                 for (BooleanClause c : ibq.getClauses()) {
                     if (c.getOccur() != BooleanClause.Occur.MUST_NOT) {
                         onlyNotClauses = false;
                         break;
+                    } else {
+                        Query q2 = c.getQuery();
+                        if (q2 instanceof TermQuery) {
+                            TermQuery tq = (TermQuery) q2;
+                            String field = tq.getTerm().field();
+                            fields.add(field);
+                        } else if (q2 instanceof MultiTermQuery) {
+                            MultiTermQuery tq = (MultiTermQuery) q2;
+                            String field = tq.getField();
+                            fields.add(field);
+                        }
                     }
                 }
                 if (onlyNotClauses) {
                     // if we have only NOT CLAUSES we have to add a match all docs (*.*) for the
                     // query to work
-                    ibq.add(new MatchAllDocsQuery(), BooleanClause.Occur.SHOULD);
+                    if (fields.size() == 1) {
+                        String field = fields.iterator().next();
+                        ibq.add(new TermRangeQuery(field, null, null, true, true), BooleanClause.Occur.SHOULD);
+                    } else {
+                        ibq.add(new MatchAllDocsQuery(), BooleanClause.Occur.SHOULD);
+                    }
                 }
             }
             return new LuceneRequestFacade&amp;lt;Query&amp;gt;(qs.get(0));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16222493" author="tmueller" created="Fri, 27 Oct 2017 14:53:29 +0000"  >&lt;p&gt;&lt;a href=&quot;http://svn.apache.org/r1813539&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1813539&lt;/a&gt; (test case for the current behavior)&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13117582">OAK-6926</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12735999">OAK-2050</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                            <outwardlinks description="breaks">
                                        <issuelink>
            <issuekey id="12902906">OAK-3486</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12755233" name="OAK-3371-2.patch" size="24846" author="edivad" created="Thu, 10 Sep 2015 21:28:12 +0000"/>
                            <attachment id="12755981" name="OAK-3371-3-oak-core.patch" size="16304" author="thomasm" created="Tue, 15 Sep 2015 12:20:52 +0000"/>
                            <attachment id="12761454" name="OAK-3371-4-notworking.patch" size="26398" author="edivad" created="Mon, 21 Sep 2015 16:13:10 +0000"/>
                            <attachment id="12761649" name="OAK-3371-5-notworking.patch" size="26395" author="edivad" created="Tue, 22 Sep 2015 13:44:22 +0000"/>
                            <attachment id="12761908" name="OAK-3371-6.patch" size="28150" author="edivad" created="Wed, 23 Sep 2015 15:23:34 +0000"/>
                            <attachment id="12754606" name="OAK-3371-test.diff" size="2561" author="edivad" created="Tue, 8 Sep 2015 09:45:17 +0000"/>
                            <attachment id="12755146" name="OAK-3371.patch" size="18112" author="edivad" created="Thu, 10 Sep 2015 15:06:16 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>7.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 3 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2jvq7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>