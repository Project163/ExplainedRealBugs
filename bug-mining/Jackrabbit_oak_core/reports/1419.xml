<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:50:05 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-3634] RDB/MongoDocumentStore may return stale documents</title>
                <link>https://issues.apache.org/jira/browse/OAK-3634</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;It appears that the implementations of the &lt;tt&gt;update&lt;/tt&gt; method sometimes populate the memory cache with documents that do not reflect any current or previous state in the persistence (that is, miss changes made by another node).&lt;/p&gt;

&lt;p&gt;(will attach test)&lt;/p&gt;</description>
                <environment></environment>
        <key id="12912870">OAK-3634</key>
            <summary>RDB/MongoDocumentStore may return stale documents</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mreutegg">Marcel Reutegger</assignee>
                                    <reporter username="reschke">Julian Reschke</reporter>
                        <labels>
                    </labels>
                <created>Fri, 13 Nov 2015 16:02:43 +0000</created>
                <updated>Wed, 2 Mar 2016 15:15:51 +0000</updated>
                            <resolved>Wed, 6 Jan 2016 15:41:03 +0000</resolved>
                                    <version>1.0.23</version>
                    <version>1.2.7</version>
                    <version>1.3.10</version>
                                    <fixVersion>1.0.28</fixVersion>
                    <fixVersion>1.2.11</fixVersion>
                    <fixVersion>1.3.14</fixVersion>
                    <fixVersion>1.4</fixVersion>
                                    <component>mongomk</component>
                    <component>rdbmk</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="15004176" author="reschke" created="Fri, 13 Nov 2015 16:04:08 +0000"  >&lt;p&gt;a test that demonstrates the problem&lt;/p&gt;</comment>
                            <comment id="15009058" author="reschke" created="Tue, 17 Nov 2015 17:19:38 +0000"  >&lt;p&gt;Had a closer look, with somewhat surprising results.&lt;/p&gt;

&lt;p&gt;1) The current behavior is easily understood as it&apos;s fully intentional: an &lt;tt&gt;update()&lt;/tt&gt; operation will apply the changes in memory and update the cache if it contains exactly the document that the UpdateOp was applied to. This implies that we&apos;ll put something into the cache without knowing its persisted state. (Note that RDB and Mongo behave exactly the same way here because the caching logic for RDB was copied from Mongo back then).&lt;/p&gt;

&lt;p&gt;Fixing this is trivial (ignoring performance for now): just remove the logic that attempts to update the cache and invalidate instead.&lt;/p&gt;

&lt;p&gt;But, surprise:&lt;/p&gt;

&lt;p&gt;2) We actually have a test case that &lt;b&gt;expects&lt;/b&gt; the behavior that this issue is about; &lt;tt&gt;MultiDocumentStoreTest.testInterleavedUpdate2()&lt;/tt&gt; which consequently starts failing once the DS implementation caches less aggressively.&lt;/p&gt;
</comment>
                            <comment id="15010457" author="mreutegg" created="Wed, 18 Nov 2015 08:20:33 +0000"  >&lt;p&gt;For consistency with behavior of other write operations in the DocumentStore, I would still suggest to fix/change update(). All other write operations make changes visible that happened before. This is a requirement for conflict detection. So far the conflict detection does not depend on update(), which probably means there is no urgent need to change the current implementation. A commit either uses create(), createOrUpdate() or findAndUpdate(). Those operations ensure the happens before semantics.&lt;/p&gt;</comment>
                            <comment id="15010693" author="reschke" created="Wed, 18 Nov 2015 10:23:27 +0000"  >&lt;p&gt;So how do we proceed from here?&lt;/p&gt;

&lt;p&gt;1) The aforementioned unit test checks something we intend to change (and I&apos;m guilty of writing that test). Should we fix/remove the test?&lt;/p&gt;

&lt;p&gt;2) My concern is that allowing update() to populate the cache with potentially incorrect information will make it harder to debug other caching related issues, thus I&apos;d propose to fix it right away.&lt;/p&gt;</comment>
                            <comment id="15010759" author="mreutegg" created="Wed, 18 Nov 2015 10:57:01 +0000"  >&lt;p&gt;I agree with you. Change the test and require update() to correctly reflect changes in the cache that happened before.&lt;/p&gt;</comment>
                            <comment id="15013531" author="reschke" created="Thu, 19 Nov 2015 13:27:53 +0000"  >&lt;p&gt;Updated patch: a naive way to address this by letting update() just invalidate the cache. However, this leads to new failures in Mongo-specific test cases (currently @ignored); some of these might be intentional (CacheConsistencyIT) while others might not (CacheConsistency).&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mreutegg&quot; class=&quot;user-hover&quot; rel=&quot;mreutegg&quot;&gt;mreutegg&lt;/a&gt;: once again will need your feedback...&lt;/p&gt;</comment>
                            <comment id="15081180" author="mreutegg" created="Mon, 4 Jan 2016 14:02:14 +0000"  >&lt;p&gt;Attached a patch with my proposal for a fix. The update implementations call &lt;tt&gt;invalidateCache(Iterable&amp;lt;String&amp;gt; keys)&lt;/tt&gt; after the documents have been updated in the store. For MongoDocumentStore, this will run a query for the _modCounts of the documents with the given keys and invalidate as needed. For RDBDocumentStore, the current implementation of &lt;tt&gt;invalidateCache(Iterable&amp;lt;String&amp;gt; keys)&lt;/tt&gt; simply invalidates the entire cache. The patch changes the implementation to only invalidate documents with the given keys.&lt;/p&gt;

&lt;p&gt;With these changes all existing and newly introduced tests pass.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=reschke&quot; class=&quot;user-hover&quot; rel=&quot;reschke&quot;&gt;reschke&lt;/a&gt;, WDYT?&lt;/p&gt;</comment>
                            <comment id="15083016" author="reschke" created="Tue, 5 Jan 2016 13:00:48 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mreutegg&quot; class=&quot;user-hover&quot; rel=&quot;mreutegg&quot;&gt;mreutegg&lt;/a&gt;: if I understand correctly, the change clears the cache at the end of the method call. Doesn&apos;t that mean that we still have time window in which the cache contains the incorrect entries? Shouldn&apos;t we avoid updating the cache in the first place?&lt;/p&gt;</comment>
                            <comment id="15083030" author="mreutegg" created="Tue, 5 Jan 2016 13:16:42 +0000"  >&lt;p&gt;You are right, this could still be a problem.&lt;/p&gt;</comment>
                            <comment id="15085131" author="mreutegg" created="Wed, 6 Jan 2016 07:31:53 +0000"  >&lt;p&gt;Added Julian&apos;s additional MultiDocumentStoreTest from his patch and a new test, which reproduces the issue with the temporary cache inconsistency raised yesterday. Tests are currently ignored. In trunk: &lt;a href=&quot;http://svn.apache.org/r1723241&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1723241&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15085224" author="mreutegg" created="Wed, 6 Jan 2016 08:51:12 +0000"  >&lt;p&gt;Committed fix and enabled tests in trunk: &lt;a href=&quot;http://svn.apache.org/r1723251&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1723251&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=reschke&quot; class=&quot;user-hover&quot; rel=&quot;reschke&quot;&gt;reschke&lt;/a&gt;, can you please review?&lt;/p&gt;</comment>
                            <comment id="15085462" author="reschke" created="Wed, 6 Jan 2016 11:56:10 +0000"  >&lt;p&gt;Looks good to me.&lt;/p&gt;</comment>
                            <comment id="15085475" author="reschke" created="Wed, 6 Jan 2016 12:12:49 +0000"  >&lt;p&gt;For MongoDocumentStore, the Eclipse Java compiler complains about line 907:&lt;/p&gt;

&lt;p&gt; &amp;amp;&amp;amp; (postUpdateModCount.longValue() - 1) == entry.getValue().getModCount()) {&lt;/p&gt;

&lt;p&gt;&quot;Incompatible operand types long and Number&quot;&lt;/p&gt;
</comment>
                            <comment id="15085500" author="mreutegg" created="Wed, 6 Jan 2016 12:45:26 +0000"  >&lt;p&gt;Re-opening to address the issue identified by Julian.&lt;/p&gt;</comment>
                            <comment id="15085693" author="mreutegg" created="Wed, 6 Jan 2016 15:41:03 +0000"  >&lt;p&gt;Fixed in trunk: &lt;a href=&quot;http://svn.apache.org/r1723350&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1723350&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15112156" author="edivad" created="Fri, 22 Jan 2016 09:21:10 +0000"  >&lt;p&gt;Bulk close for 1.3.14&lt;/p&gt;</comment>
                            <comment id="15142500" author="catholicon" created="Thu, 11 Feb 2016 10:05:48 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mreutegg&quot; class=&quot;user-hover&quot; rel=&quot;mreutegg&quot;&gt;mreutegg&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=reschke&quot; class=&quot;user-hover&quot; rel=&quot;reschke&quot;&gt;reschke&lt;/a&gt;, to me this seems worth porting back to 1.0 as well. Wdyt?&lt;/p&gt;</comment>
                            <comment id="15142514" author="reschke" created="Thu, 11 Feb 2016 10:15:26 +0000"  >&lt;p&gt;Yes, that&apos;s why it&apos;s labeled as 1.0 candidate &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;. If the actual change did apply without conflicts, I&apos;d go ahead with the change right now, but they do not, so this needs a bit of tuning the individual changes...&lt;/p&gt;</comment>
                            <comment id="15142612" author="catholicon" created="Thu, 11 Feb 2016 11:28:25 +0000"  >&lt;p&gt;If &quot;http://svn.apache.org/r1725938 &lt;a href=&quot;http://svn.apache.org/r1725919&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1725919&lt;/a&gt;&quot; these are the only changes that are required, I can try to put up a patch at 1.0 branch. I haven&apos;t followed this issue closely, so not sure of the what exact changes were required.&lt;/p&gt;</comment>
                            <comment id="15142623" author="reschke" created="Thu, 11 Feb 2016 11:39:25 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=catholicon&quot; class=&quot;user-hover&quot; rel=&quot;catholicon&quot;&gt;catholicon&lt;/a&gt; I&apos;d like to try to backport other earlier changes before, so that merging stays simple. Let me try to start with &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-3649&quot; title=&quot;Extract node document cache from Mongo and RDB document stores&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-3649&quot;&gt;&lt;del&gt;OAK-3649&lt;/del&gt;&lt;/a&gt; first...&lt;/p&gt;</comment>
                            <comment id="15142624" author="catholicon" created="Thu, 11 Feb 2016 11:41:30 +0000"  >&lt;p&gt;Ack.&lt;/p&gt;</comment>
                            <comment id="15144210" author="reschke" created="Fri, 12 Feb 2016 07:32:01 +0000"  >&lt;p&gt;trunk: &lt;a href=&quot;http://svn.apache.org/r1723350&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1723350&lt;/a&gt; &lt;a href=&quot;http://svn.apache.org/r1723251&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1723251&lt;/a&gt; &lt;a href=&quot;http://svn.apache.org/r1723241&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1723241&lt;/a&gt;&lt;br/&gt;
1.2: &lt;a href=&quot;http://svn.apache.org/r1725938&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1725938&lt;/a&gt; &lt;a href=&quot;http://svn.apache.org/r1725919&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1725919&lt;/a&gt;&lt;br/&gt;
1.0: &lt;a href=&quot;http://svn.apache.org/r1729947&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1729947&lt;/a&gt; &lt;a href=&quot;http://svn.apache.org/r1729879&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1729879&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="12914223">OAK-3653</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is blocked by">
                                        <issuelink>
            <issuekey id="12928018">OAK-3841</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12845194">OAK-3103</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12773239" name="OAK-3634.diff" size="16360" author="reschke" created="Thu, 19 Nov 2015 13:27:53 +0000"/>
                            <attachment id="12772223" name="OAK-3634.diff" size="2192" author="reschke" created="Fri, 13 Nov 2015 16:04:08 +0000"/>
                            <attachment id="12780314" name="OAK-3634.patch" size="9397" author="mreutegg" created="Mon, 4 Jan 2016 14:02:14 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 40 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2od7z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>