<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:48:20 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-3099] Revision GC fails when split documents with very long paths are present</title>
                <link>https://issues.apache.org/jira/browse/OAK-3099</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;My company is using the MongoDB microkernel with Oak, and we&apos;ve noticed that the daily revision GC is failing with errors like this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;13.07.2015 13:06:16.261 *ERROR* [pool-7-thread-1-Maintenance Queue(com/adobe/granite/maintenance/job/RevisionCleanupTask)] org.apache.jackrabbit.oak.management.ManagementOperation Revision garbage collection failed
java.lang.IllegalArgumentException: 13:h113f9d0fe7ac0f87fa06397c37b9ffd4b372eeb1ec93e0818bb4024a32587820
at org.apache.jackrabbit.oak.plugins.document.Revision.fromString(Revision.java:236)
at org.apache.jackrabbit.oak.plugins.document.SplitDocumentCleanUp.disconnect(SplitDocumentCleanUp.java:84)
at org.apache.jackrabbit.oak.plugins.document.SplitDocumentCleanUp.disconnect(SplitDocumentCleanUp.java:56)
at org.apache.jackrabbit.oak.plugins.document.VersionGCSupport.deleteSplitDocuments(VersionGCSupport.java:53)
at org.apache.jackrabbit.oak.plugins.document.VersionGarbageCollector.collectSplitDocuments(VersionGarbageCollector.java:117)
at org.apache.jackrabbit.oak.plugins.document.VersionGarbageCollector.gc(VersionGarbageCollector.java:105)
at org.apache.jackrabbit.oak.plugins.document.DocumentNodeStoreService$2.run(DocumentNodeStoreService.java:511)
at org.apache.jackrabbit.oak.spi.state.RevisionGC$1.call(RevisionGC.java:68)
at org.apache.jackrabbit.oak.spi.state.RevisionGC$1.call(RevisionGC.java:64)
at java.util.concurrent.FutureTask.run(FutureTask.java:262)
at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)
at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I&apos;ve narrowed the issue down to the disconnect(NodeDocument) method of the &lt;a href=&quot;https://svn.apache.org/repos/asf/jackrabbit/oak/trunk/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/SplitDocumentCleanUp.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;SplitDocumentCleanUp class&lt;/a&gt;. The method always tries to extract the path of the node from its ID, but this won&apos;t work for documents whose path is very long because those documents will have the hash of their path in the ID.&lt;/p&gt;

&lt;p&gt;I believe this code should fix the issue, but I haven&apos;t had a chance to actually try it:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void disconnect(NodeDocument splitDoc) {
        &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; mainId = Utils.getIdFromPath(splitDoc.getMainPath());
        NodeDocument doc = store.find(NODES, mainId);
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (doc == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
            LOG.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;Main document {} already removed. Split document is {}&quot;&lt;/span&gt;,
                    mainId, splitId);
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
        }
        &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; path = splitDoc.getPath();
        &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; slashIdx = path.lastIndexOf(&lt;span class=&quot;code-quote&quot;&gt;&apos;/&apos;&lt;/span&gt;);
        &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; height = &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;.parseInt(path.substring(slashIdx + 1));
        Revision rev = Revision.fromString(
                path.substring(path.lastIndexOf(&lt;span class=&quot;code-quote&quot;&gt;&apos;/&apos;&lt;/span&gt;, slashIdx - 1) + 1, slashIdx));
        doc = doc.findPrevReferencingDoc(rev, height);
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (doc == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
            LOG.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;Split document {} not referenced anymore. Main document is {}&quot;&lt;/span&gt;,
                    splitId, mainId);
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
        }
        &lt;span class=&quot;code-comment&quot;&gt;// remove reference
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (doc.getSplitDocType() == INTERMEDIATE) {
            disconnectFromIntermediate(doc, rev);
        } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
            markStaleOnMain(doc, rev, height);
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;By using getPath(), the code should automatically use either the ID or the _path property, whichever is right for the document.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12844910">OAK-3099</key>
            <summary>Revision GC fails when split documents with very long paths are present</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="amitjain">Amit Jain</assignee>
                                    <reporter username="Csaba Varga">Csaba Varga</reporter>
                        <labels>
                    </labels>
                <created>Tue, 14 Jul 2015 08:58:22 +0000</created>
                <updated>Wed, 2 Mar 2016 11:55:54 +0000</updated>
                            <resolved>Thu, 16 Jul 2015 04:08:26 +0000</resolved>
                                    <version>1.0.13</version>
                                    <fixVersion>1.0.18</fixVersion>
                    <fixVersion>1.2.3</fixVersion>
                    <fixVersion>1.3.3</fixVersion>
                    <fixVersion>1.4</fixVersion>
                                    <component>mongomk</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="14626072" author="csaba varga" created="Tue, 14 Jul 2015 09:10:00 +0000"  >&lt;p&gt;Attaching the Java code I&apos;ve used to generate the problematic split documents. It&apos;s a simple OSGi component since that was the easiest way to introduce code to a &quot;clean&quot; AEM environment, but it may be a good starting point for a unit test.&lt;/p&gt;

&lt;p&gt;To reproduce the issue, you need to set your system clock ahead at least 24 hours after running the generator code. Revision GC doesn&apos;t try to clean up documents younger than 24 hours by default, so you need to manipulate the clock to trigger the issue quickly.&lt;/p&gt;</comment>
                            <comment id="14627912" author="amitjain" created="Wed, 15 Jul 2015 11:31:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mreutegg&quot; class=&quot;user-hover&quot; rel=&quot;mreutegg&quot;&gt;mreutegg&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chetanm&quot; class=&quot;user-hover&quot; rel=&quot;chetanm&quot;&gt;chetanm&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Could you please review the patch which incorporates the test and fix provided by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Csaba+Varga&quot; class=&quot;user-hover&quot; rel=&quot;Csaba Varga&quot;&gt;Csaba Varga&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="14627963" author="mreutegg" created="Wed, 15 Jul 2015 12:30:33 +0000"  >&lt;p&gt;+1, patch looks good to me.&lt;/p&gt;</comment>
                            <comment id="14629151" author="amitjain" created="Thu, 16 Jul 2015 04:08:27 +0000"  >&lt;p&gt;Committed the patch&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;trunk -  &lt;a href=&quot;http://svn.apache.org/r1691307&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1691307&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;1.2 - &lt;a href=&quot;http://svn.apache.org/r1691313&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1691313&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;1.0 - &lt;a href=&quot;http://svn.apache.org/r1691314&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1691314&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14638848" author="edivad" created="Thu, 23 Jul 2015 14:08:44 +0000"  >&lt;p&gt;Bulk closing for 1.3.3.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12745427" name="OAK-3099.patch" size="5064" author="amitjain" created="Wed, 15 Jul 2015 11:31:47 +0000"/>
                            <attachment id="12745222" name="SplitDocumentGenerator.java" size="1794" author="Csaba Varga" created="Tue, 14 Jul 2015 09:10:00 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 17 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2h853:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>