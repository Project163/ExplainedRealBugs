<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:52:42 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-5947] Allowing non-admin user to set repository permissions fails</title>
                <link>https://issues.apache.org/jira/browse/OAK-5947</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;Given a user principal &lt;tt&gt;testUser&lt;/tt&gt; is granted &lt;tt&gt;jcr:readAccessControl&lt;/tt&gt; and &lt;tt&gt;jcr:modifyAccessControl&lt;/tt&gt; on the repository (&lt;tt&gt;rep:repoPolicy&lt;/tt&gt;), I would expect that this user can e.g. allow &lt;tt&gt;everyone&lt;/tt&gt; the &lt;tt&gt;jcr:namespaceManagement&lt;/tt&gt; permission on the repository.&lt;/p&gt;

&lt;p&gt;Currently this fails with the following exception:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;javax.jcr.PathNotFoundException: No tree at null
	at org.apache.jackrabbit.oak.spi.security.authorization.accesscontrol.AbstractAccessControlManager.getTree(AbstractAccessControlManager.java:163)
	at org.apache.jackrabbit.oak.security.authorization.accesscontrol.AccessControlManagerImpl.getApplicablePolicies(AccessControlManagerImpl.java:184)
	at org.apache.jackrabbit.oak.jcr.delegate.AccessControlManagerDelegator$7.perform(AccessControlManagerDelegator.java:121)
	at org.apache.jackrabbit.oak.jcr.delegate.AccessControlManagerDelegator$7.perform(AccessControlManagerDelegator.java:117)
	at org.apache.jackrabbit.oak.jcr.delegate.SessionDelegate.perform(SessionDelegate.java:208)
	at org.apache.jackrabbit.oak.jcr.delegate.AccessControlManagerDelegator.getApplicablePolicies(AccessControlManagerDelegator.java:117)
	at org.apache.jackrabbit.oak.jcr.delegate.JackrabbitAccessControlManagerDelegator.getApplicablePolicies(JackrabbitAccessControlManagerDelegator.java:147)
	at org.apache.jackrabbit.commons.jackrabbit.authorization.AccessControlUtils.getAccessControlList(AccessControlUtils.java:128)
	at org.apache.jackrabbit.oak.jcr.SetRepoPolicyPermissionsTest.setRepositoryPermissions(SetRepoPolicyPermissionsTest.java:85)
        ....
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;or after granting &lt;tt&gt;jcr:read&lt;/tt&gt; on &lt;tt&gt;/&lt;/tt&gt;:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;javax.jcr.AccessDeniedException
	at org.apache.jackrabbit.oak.util.NodeUtil.addChild(NodeUtil.java:113)
	at org.apache.jackrabbit.oak.security.authorization.accesscontrol.AccessControlManagerImpl.setNodeBasedAcl(AccessControlManagerImpl.java:289)
	at org.apache.jackrabbit.oak.security.authorization.accesscontrol.AccessControlManagerImpl.setPolicy(AccessControlManagerImpl.java:220)
	at org.apache.jackrabbit.oak.jcr.delegate.AccessControlManagerDelegator$8.performVoid(AccessControlManagerDelegator.java:132)
	at org.apache.jackrabbit.oak.jcr.delegate.SessionDelegate.performVoid(SessionDelegate.java:274)
	at org.apache.jackrabbit.oak.jcr.delegate.AccessControlManagerDelegator.setPolicy(AccessControlManagerDelegator.java:129)
	at org.apache.jackrabbit.oak.jcr.delegate.JackrabbitAccessControlManagerDelegator.setPolicy(JackrabbitAccessControlManagerDelegator.java:152)
	at org.apache.jackrabbit.oak.jcr.SetRepoPolicyPermissionsTest.setRepositoryPermissions(SetRepoPolicyPermissionsTest.java:90)
        ....
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13057532">OAK-5947</key>
            <summary>Allowing non-admin user to set repository permissions fails</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="angela">Angela Schreiber</assignee>
                                    <reporter username="jsedding">Julian Sedding</reporter>
                        <labels>
                    </labels>
                <created>Mon, 20 Mar 2017 13:48:07 +0000</created>
                <updated>Tue, 30 May 2017 08:38:53 +0000</updated>
                            <resolved>Wed, 3 May 2017 13:56:55 +0000</resolved>
                                    <version>1.0</version>
                    <version>1.2</version>
                    <version>1.4.0</version>
                    <version>1.6.0</version>
                                    <fixVersion>1.7.0</fixVersion>
                    <fixVersion>1.8.0</fixVersion>
                                    <component>core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="15932656" author="jsedding" created="Mon, 20 Mar 2017 13:54:09 +0000"  >&lt;p&gt;Attached is a &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12859587/12859587_SetRepoPolicyTest.patch&quot; title=&quot;SetRepoPolicyTest.patch attached to OAK-5947&quot;&gt;patch with a test case&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=anchela&quot; class=&quot;user-hover&quot; rel=&quot;anchela&quot;&gt;anchela&lt;/a&gt;, could you please take a look&lt;/p&gt;

&lt;p&gt;1. to see if my code is correct and should work&lt;br/&gt;
2. (assuming the test is correct) if you can identify the root cause&lt;/p&gt;

&lt;p&gt;I debugged the issue and I am under the impression that a &lt;tt&gt;SecureNodeBuilder&lt;/tt&gt; causes reads and writes to &lt;tt&gt;/rep:repoPolicy&lt;/tt&gt; to be handled like normal repository reads/writes. However, adding an ACEs there should not require such privileges.&lt;/p&gt;

&lt;p&gt;PS: please excuse and correct in case I got some of the security terminology wrong.&lt;/p&gt;</comment>
                            <comment id="15935889" author="anchela" created="Wed, 22 Mar 2017 07:56:10 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jsedding&quot; class=&quot;user-hover&quot; rel=&quot;jsedding&quot;&gt;jsedding&lt;/a&gt;, IMHO the initial &lt;tt&gt;PathNotFoundException&lt;/tt&gt; when the user doesn&apos;t have read permission on the target node is to be expected according to JCR specification and the JavaDoc, which states for &lt;tt&gt;AccessControlManager.getPolicies&lt;/tt&gt; and &lt;tt&gt;AccessControlManager.getApplicablePolicies&lt;/tt&gt;:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;PathNotFoundException if no node at &amp;lt;code&amp;gt;absPath&amp;lt;/code&amp;gt; exists or the session does not have sufficient access to retrieve a node at that location.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;While this doesn&apos;t explicitly specified how the &lt;tt&gt;null&lt;/tt&gt; path argument should be handled, I decided to used the root path to attach the corresponding policy and thus the root node must be readable.&lt;/p&gt;

&lt;p&gt;That&apos;s the first part. Let me take a look at the second part...&lt;/p&gt;</comment>
                            <comment id="15936027" author="anchela" created="Wed, 22 Mar 2017 10:28:46 +0000"  >&lt;p&gt;As far as the &lt;tt&gt;AccessDeniedException&lt;/tt&gt; is concerned this actually seems to be a bug: while the &lt;tt&gt;AccessControlManager&lt;/tt&gt; checks for read/modify-access-control being granted on the &lt;tt&gt;null&lt;/tt&gt; path upon get/set of policies, the subsequent code writing down the new/modified &lt;tt&gt;rep:repoPolicy&lt;/tt&gt; relies on the regular permission evaluation, which doesn&apos;t treat the &lt;tt&gt;rep:repoPolicy&lt;/tt&gt; node specially and thus evaluates permissions of the root node instead of looking at the permission of the &lt;tt&gt;null&lt;/tt&gt; code. The actually issue is not located in the &lt;tt&gt;SecureNodeBuilder&lt;/tt&gt;, which must not know anything about a given authorization model but rather in the &lt;tt&gt;TreePermissions&lt;/tt&gt; implementation of the default model. that one identifies the subtree defined by &lt;tt&gt;rep:repoPolicy&lt;/tt&gt; as access control content but doesn&apos;t handle it as repo-level access control.&lt;/p&gt;

&lt;p&gt;I added a modified (and enhanced) test-case in the oak-core module at revision 1788080 illustrating the checks and expected exception raised by &lt;tt&gt;AccessControlManagerImpl&lt;/tt&gt; (see above) as well as the bug. The latter is currently marked ignored.&lt;/p&gt;</comment>
                            <comment id="15936028" author="anchela" created="Wed, 22 Mar 2017 10:31:13 +0000"  >&lt;p&gt;btw: the issue not only affects 1.6.1 but has been present since 1.0.&lt;/p&gt;

&lt;p&gt;workaround for the issue would be to additionally grant &lt;tt&gt;jcr:readAccessControl&lt;/tt&gt; and &lt;tt&gt;jcr:modifyAccessControl&lt;/tt&gt; privilege at the root-path and limit the effect to the &lt;tt&gt;rep:repoPolicy&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="15936164" author="jsedding" created="Wed, 22 Mar 2017 11:42:03 +0000"  >&lt;p&gt;Thanks for your analysis &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=anchela&quot; class=&quot;user-hover&quot; rel=&quot;anchela&quot;&gt;anchela&lt;/a&gt; and clarifying what is expected behaviour and what is a bug. The test case is much easier to read now, should have noticed that all the methods I needed were already present &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="15992498" author="anchela" created="Tue, 2 May 2017 07:48:54 +0000"  >&lt;p&gt;proposed fix in &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-5947&quot; title=&quot;Allowing non-admin user to set repository permissions fails&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-5947&quot;&gt;&lt;del&gt;OAK-5947&lt;/del&gt;&lt;/a&gt;.patch&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=alexparvulescu&quot; class=&quot;user-hover&quot; rel=&quot;alexparvulescu&quot;&gt;alexparvulescu&lt;/a&gt;, i would appreciate if you could review the proposed fix. will continue to write additional tests for the additional permission-eval calls for the repository level.&lt;/p&gt;</comment>
                            <comment id="15994663" author="alex.parvulescu" created="Wed, 3 May 2017 11:06:28 +0000"  >&lt;p&gt;looks good to me!&lt;br/&gt;
the only (cosmetic) suggestion I have is to store the &lt;tt&gt;RepositoryPermission&lt;/tt&gt; directly in the &lt;tt&gt;RepoPolicyTreePermission&lt;/tt&gt; instead of doing &lt;tt&gt;compiledPermission.getRepositoryPermission()&lt;/tt&gt; all the time.&lt;/p&gt;</comment>
                            <comment id="15994845" author="anchela" created="Wed, 3 May 2017 13:25:27 +0000"  >&lt;p&gt;thanks for the review. will adjust the patch accordingly.&lt;/p&gt;</comment>
                            <comment id="15994922" author="anchela" created="Wed, 3 May 2017 13:56:55 +0000"  >&lt;p&gt;Committed revision 1793646.&lt;/p&gt;</comment>
                            <comment id="16029043" author="edivad" created="Tue, 30 May 2017 08:38:53 +0000"  >&lt;p&gt;Bulk close for 1.7.0&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12865906" name="OAK-5947-tests.patch" size="12210" author="angela" created="Tue, 2 May 2017 07:48:54 +0000"/>
                            <attachment id="12865905" name="OAK-5947.patch" size="6892" author="angela" created="Tue, 2 May 2017 07:48:54 +0000"/>
                            <attachment id="12859587" name="SetRepoPolicyTest.patch" size="5849" author="jsedding" created="Mon, 20 Mar 2017 16:25:13 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 24 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3cim7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>