<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:44:28 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-1865] Blob garbage collector deletes referenced blobs for Jackrabbit 2.x DataStores</title>
                <link>https://issues.apache.org/jira/browse/OAK-1865</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;Garbage collection logic deletes referenced blobs also resulting in data loss. &lt;br/&gt;
This happens because of not taking into account the referenced inlined blobs for the Jackrabbit 2.x DataStores.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12717512">OAK-1865</key>
            <summary>Blob garbage collector deletes referenced blobs for Jackrabbit 2.x DataStores</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="chetanm">Chetan Mehrotra</assignee>
                                    <reporter username="amitjain">Amit Jain</reporter>
                        <labels>
                    </labels>
                <created>Fri, 30 May 2014 12:00:42 +0000</created>
                <updated>Tue, 8 Oct 2019 15:22:09 +0000</updated>
                            <resolved>Tue, 3 Jun 2014 06:07:48 +0000</resolved>
                                    <version>1.0</version>
                                    <fixVersion>1.0.1</fixVersion>
                    <fixVersion>1.1.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14013587" author="amitjain" created="Fri, 30 May 2014 12:03:00 +0000"  >&lt;p&gt;Patch to fix the issue.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chetanm&quot; class=&quot;user-hover&quot; rel=&quot;chetanm&quot;&gt;chetanm&lt;/a&gt; can you please review the patch.&lt;/p&gt;</comment>
                            <comment id="14015283" author="chetanm" created="Mon, 2 Jun 2014 09:40:06 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=amitj_76&quot; class=&quot;user-hover&quot; rel=&quot;amitj_76&quot;&gt;amitj_76&lt;/a&gt; I have reworked the logic in &lt;tt&gt;FileLineDifferenceIterator&lt;/tt&gt; to avoid usage of a buffer which somewhat simplifies the logic and reduces edge cases. Attaching &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12647877/12647877_OAK-1865-nobuffer.patch&quot; title=&quot;OAK-1865-nobuffer.patch attached to OAK-1865&quot;&gt;updated patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=amitj_76&quot; class=&quot;user-hover&quot; rel=&quot;amitj_76&quot;&gt;amitj_76&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thomasm&quot; class=&quot;user-hover&quot; rel=&quot;thomasm&quot;&gt;thomasm&lt;/a&gt; Can you review the patch. &lt;/p&gt;

&lt;p&gt;(might be easier to just review the logic of &lt;tt&gt;FileLineDifferenceIterator&lt;/tt&gt; after applying the patch as getting the flow in diff mode is confusing)&lt;/p&gt;</comment>
                            <comment id="14015290" author="tmueller" created="Mon, 2 Jun 2014 09:50:35 +0000"  >&lt;p&gt;Sorry I don&apos;t understand this problem yet.&lt;/p&gt;

&lt;p&gt;&amp;gt; because of not taking into account the referenced inlined blobs&lt;/p&gt;

&lt;p&gt;I guess there is some misunderstanding. The term &quot;inlined blob&quot; for me means short binaries that are not actually stored in the BlobStore / DataStore, but in the reference itself. Those binaries are not actually stored externally, so garbage collection can&apos;t delete them, as GC can only delete stored binaries, not references to binaries. So according to my logic they can be ignored while running garbage collection.&lt;/p&gt;

&lt;p&gt;I patched MongoBlobGCTest (just this class) using the patches in this issue, but this test doesn&apos;t fail for me. Shouldn&apos;t the test fail when I don&apos;t also patch the MarkSweepGarbageCollector?&lt;/p&gt;</comment>
                            <comment id="14015293" author="chetanm" created="Mon, 2 Jun 2014 09:57:52 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thomasm&quot; class=&quot;user-hover&quot; rel=&quot;thomasm&quot;&gt;thomasm&lt;/a&gt; &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12647880/12647880_OAK-1865-testcase.patch&quot; title=&quot;OAK-1865-testcase.patch attached to OAK-1865&quot;&gt;Attached is a patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; which just has the testcase (with slight change to allow testcase logic to run in main class). This shows couple of failures which occur because of extra entries in marked (the inlined blobs)&lt;/p&gt;</comment>
                            <comment id="14015359" author="tmueller" created="Mon, 2 Jun 2014 13:06:12 +0000"  >&lt;p&gt;I think there is still a bug, for example for the test case:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;assertDiff(&quot;3,7&quot;, &quot;2,3,5,9&quot;, asList(&quot;2&quot;, &quot;5&quot;, &quot;9&quot;));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I got that using a randomized test:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;    @Test
    public void testRandomized() throws Exception {
        Random r = new Random(0);
        for (int i = 0; i &amp;lt; 10000; i++) {
            TreeSet&amp;lt;String&amp;gt; marked = new TreeSet&amp;lt;String&amp;gt;();
            TreeSet&amp;lt;String&amp;gt; all = new TreeSet&amp;lt;String&amp;gt;();
            TreeSet&amp;lt;String&amp;gt; diff = new TreeSet&amp;lt;String&amp;gt;();
            int size = r.nextInt(5);
            for (int a = 0; a &amp;lt; size; a++) {
                marked.add(&quot;&quot; + r.nextInt(10));
            }
            size = r.nextInt(5);
            for (int a = 0; a &amp;lt; size; a++) {
                all.add(&quot;&quot; + r.nextInt(10));
            }
            diff.addAll(all);
            diff.removeAll(marked);
            String m = marked.toString().replaceAll(&quot;[ \\[\\]]&quot;, &quot;&quot;);
            String a = all.toString().replaceAll(&quot;[ \\[\\]]&quot;, &quot;&quot;);
            assertDiff(m, a,
                    new ArrayList&amp;lt;String&amp;gt;(diff));
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14015369" author="tmueller" created="Mon, 2 Jun 2014 13:22:37 +0000"  >&lt;p&gt;I think the problem is that for each call, a new peekingIterator is created. The peekingIterator needs to be re-used for this to work.&lt;/p&gt;</comment>
                            <comment id="14015374" author="tmueller" created="Mon, 2 Jun 2014 13:30:19 +0000"  >&lt;p&gt;Updated patch with randomized test and fixed bug.&lt;/p&gt;</comment>
                            <comment id="14016227" author="chetanm" created="Tue, 3 Jun 2014 05:26:55 +0000"  >&lt;blockquote&gt;&lt;p&gt;I think the problem is that for each call, a new peekingIterator is created. The peekingIterator needs to be re-used for this to work.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;aah missed the fact that PeekingIterator would have a state which cannot be discarded. Yes it would need to be reused. Thanks Thomas !! Would apply the patch&lt;/p&gt;</comment>
                            <comment id="14016250" author="chetanm" created="Tue, 3 Jun 2014 06:07:48 +0000"  >&lt;p&gt;Applied the updated patch in trunk with &lt;a href=&quot;http://svn.apache.org/r1599416&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1599416&lt;/a&gt; and merged to 1.0 with &lt;a href=&quot;http://svn.apache.org/r1599419&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1599419&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12647897" name="OAK-1865-b.patch" size="16921" author="thomasm" created="Mon, 2 Jun 2014 13:30:19 +0000"/>
                            <attachment id="12647877" name="OAK-1865-nobuffer.patch" size="16402" author="chetanm" created="Mon, 2 Jun 2014 09:40:06 +0000"/>
                            <attachment id="12647880" name="OAK-1865-testcase.patch" size="4888" author="chetanm" created="Mon, 2 Jun 2014 09:57:52 +0000"/>
                            <attachment id="12647585" name="OAK-1865.patch" size="7383" author="amitjain" created="Fri, 30 May 2014 12:03:00 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>395716</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 24 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1w4nz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>395836</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>