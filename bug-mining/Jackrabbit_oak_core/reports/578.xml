<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:41:09 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-1250] Guard against invalid/missing checkpoints</title>
                <link>https://issues.apache.org/jira/browse/OAK-1250</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;Playing with the backup revealed a case where a checkpoint can become invalid after a manual restore of the repository. &lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt;&lt;br/&gt;
The NodeStore#retrieve apis already specify that this can return null in the case the checkpoint doesn&apos;t exist anymore, but it looks like the storage bits aren&apos;t yet prepared for that scenario.&lt;/p&gt;



&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.sling.commons.scheduler.impl.QuartzScheduler Exception during job execution of org.apache.jackrabbit.oak.plugins.index.AsyncIndexUpdate@3a6d47 : Failed to load segment 8a8b281c-1a02-4950-aad5-aad8e436a0d8
java.lang.IllegalStateException: Failed to load segment 8a8b281c-1a02-4950-aad5-aad8e436a0d8
	at org.apache.jackrabbit.oak.plugins.segment.AbstractStore.readSegment(AbstractStore.java:109) ~[na:na]
	at org.apache.jackrabbit.oak.plugins.segment.Segment.getSegment(Segment.java:189) ~[na:na]
	at org.apache.jackrabbit.oak.plugins.segment.Record.getSegment(Record.java:97) ~[na:na]
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeState.getTemplate(SegmentNodeState.java:56) ~[na:na]
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeState.getChildNode(SegmentNodeState.java:209) ~[na:na]
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeStore.retrieve(SegmentNodeStore.java:175) ~[na:na]
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeStoreService.retrieve(SegmentNodeStoreService.java:198) ~[na:na]
	at org.apache.jackrabbit.oak.plugins.index.AsyncIndexUpdate.run(AsyncIndexUpdate.java:97) ~[na:na]
	at org.apache.sling.commons.scheduler.impl.QuartzJobExecutor.execute(QuartzJobExecutor.java:105) ~[org.apache.sling.commons.scheduler-2.4.2.jar:na]
	at org.quartz.core.JobRunShell.run(JobRunShell.java:207) [org.apache.sling.commons.scheduler-2.4.2.jar:na]
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145) [na:1.7.0_40]
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615) [na:1.7.0_40]
	at java.lang.Thread.run(Thread.java:724) [na:1.7.0_40]
Caused by: java.lang.IllegalStateException: Segment 8a8b281c-1a02-4950-aad5-aad8e436a0d8 not found
	at org.apache.jackrabbit.oak.plugins.segment.file.FileStore.loadSegment(FileStore.java:184) ~[na:na]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12682147">OAK-1250</key>
            <summary>Guard against invalid/missing checkpoints</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="stillalex">Alex Deparvu</assignee>
                                    <reporter username="stillalex">Alex Deparvu</reporter>
                        <labels>
                    </labels>
                <created>Mon, 2 Dec 2013 14:57:23 +0000</created>
                <updated>Fri, 13 Dec 2013 09:01:18 +0000</updated>
                            <resolved>Tue, 3 Dec 2013 16:13:44 +0000</resolved>
                                                    <fixVersion>0.13</fixVersion>
                                    <component>segmentmk</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13836581" author="jukkaz" created="Mon, 2 Dec 2013 15:03:33 +0000"  >&lt;p&gt;Currently the &lt;tt&gt;checkpoint()&lt;/tt&gt; method just returns the raw record ID of the head revision. A better solution (which is already anticipated by the super-root node used by the &lt;tt&gt;SegmentNodeStore&lt;/tt&gt;) would be to generate a random UUID for each checkpoint, and store the latest head along with the expiration time of the checkpoint as an extra child below the super-root. Then the &lt;tt&gt;retrieve()&lt;/tt&gt; method can look up the checkpoint UUID from the super-root, and return the relevant state if it does exists. That&apos;ll also work nicely with garbage collection once we implement it for the SegmentMK.&lt;/p&gt;</comment>
                            <comment id="13836592" author="alex.parvulescu" created="Mon, 2 Dec 2013 15:12:33 +0000"  >&lt;p&gt;right, I&apos;ll tackle the missing bits, see if I can come up with something that works.&lt;/p&gt;</comment>
                            <comment id="13837732" author="alex.parvulescu" created="Tue, 3 Dec 2013 14:27:32 +0000"  >&lt;p&gt;attaching proposed draft:&lt;br/&gt;
It creates a new checkpoint under the super root node / checkpoint/uuid&lt;/p&gt;

&lt;p&gt;I can move it under the root directly but it feels like we&apos;re polluting the node, plus gc will be a lot easier this way.&lt;/p&gt;

&lt;p&gt;I&apos;m not sure about the locking mechanism, if I should have gone though the semaphore somehow (marked as a todo in the code)&lt;/p&gt;</comment>
                            <comment id="13837779" author="jukkaz" created="Tue, 3 Dec 2013 15:10:27 +0000"  >&lt;p&gt;Looks good, nice work! Some comments:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;I&apos;d rather put the checkpoint structure directly at &lt;tt&gt;/&amp;lt;uuid&amp;gt;&lt;/tt&gt; under the super-root, and have the timestamp property in &lt;tt&gt;/&amp;lt;uuid&amp;gt;/timestamp&lt;/tt&gt; and the checkpointed root node state at &lt;tt&gt;/&amp;lt;uuid&amp;gt;/root&lt;/tt&gt;. The super-root would then contain the main &lt;tt&gt;/root&lt;/tt&gt; child node and an extra &lt;tt&gt;/&amp;lt;uuid&amp;gt;&lt;/tt&gt; child node for each checkpoint.&lt;/li&gt;
	&lt;li&gt;It would be better to use &lt;tt&gt;UUID.randomUUID()&lt;/tt&gt; instead of &lt;tt&gt;newDataSegmentId()&lt;/tt&gt; to generate the checkpoint UUID. That way we&apos;ll be able to use the UUID variant field to tell the difference between the different types of UUIDs.&lt;/li&gt;
	&lt;li&gt;Yes, we should use the &lt;tt&gt;commitSemaphore&lt;/tt&gt; to guard also the checkpoint operations. You&apos;ll also need to check the return value from &lt;tt&gt;Journal.setHead()&lt;/tt&gt; and refresh/retry if &lt;tt&gt;false&lt;/tt&gt;.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13837817" author="alex.parvulescu" created="Tue, 3 Dec 2013 15:51:07 +0000"  >&lt;p&gt;thanks for the review Jukka!&lt;/p&gt;

&lt;p&gt;attaching a better version: tries up to 5 times to create the checkpoint under the semaphore lock.&lt;/p&gt;</comment>
                            <comment id="13837828" author="jukkaz" created="Tue, 3 Dec 2013 15:57:43 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13837839" author="alex.parvulescu" created="Tue, 3 Dec 2013 16:13:44 +0000"  >&lt;p&gt;awesome I think we&apos;re done here!&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://svn.apache.org/r1547453&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1547453&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13838027" author="alex.parvulescu" created="Tue, 3 Dec 2013 18:49:48 +0000"  >&lt;p&gt;I just realized that after using the semaphore lock there&apos;s no need to synchronize the &lt;em&gt;checkpoint&lt;/em&gt; method any more. What do you think Jukka?&lt;/p&gt;</comment>
                            <comment id="13838036" author="jukkaz" created="Tue, 3 Dec 2013 18:59:28 +0000"  >&lt;blockquote&gt;&lt;p&gt;no need to synchronize&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;You&apos;re right.&lt;/p&gt;</comment>
                            <comment id="13838931" author="alex.parvulescu" created="Wed, 4 Dec 2013 14:36:13 +0000"  >&lt;p&gt;I removed the &apos;synchronize&apos; with 1547806.&lt;/p&gt;</comment>
                            <comment id="13847296" author="alex.parvulescu" created="Fri, 13 Dec 2013 09:01:18 +0000"  >&lt;p&gt;bulk close for the 0.13 release&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12616800" name="OAK-1250-v2.patch" size="5765" author="stillalex" created="Tue, 3 Dec 2013 15:51:07 +0000"/>
                            <attachment id="12616784" name="OAK-1250.patch" size="5638" author="stillalex" created="Tue, 3 Dec 2013 14:27:32 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>361404</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 49 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1qas7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>361703</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>