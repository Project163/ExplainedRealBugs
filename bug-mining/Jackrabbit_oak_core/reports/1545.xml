<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:51:23 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-4937] JournalGC failing with RDB DocumentStore</title>
                <link>https://issues.apache.org/jira/browse/OAK-4937</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;Journal GC on RDB DocumentStore fails with following exception&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.jackrabbit.oak.plugins.document.DocumentStoreException: Can&apos;t insert the document: null

	at org.apache.jackrabbit.oak.plugins.document.rdb.RDBDocumentStore.internalCreateOrUpdate(RDBDocumentStore.java:1216)
	at org.apache.jackrabbit.oak.plugins.document.rdb.RDBDocumentStore.createOrUpdate(RDBDocumentStore.java:295)
	at org.apache.jackrabbit.oak.plugins.document.util.LeaseCheckDocumentStoreWrapper.createOrUpdate(LeaseCheckDocumentStoreWrapper.java:128)
	at org.apache.jackrabbit.oak.plugins.document.JournalGarbageCollector.updateTailTimestamp(JournalGarbageCollector.java:167)
	at org.apache.jackrabbit.oak.plugins.document.JournalGarbageCollector.gc(JournalGarbageCollector.java:112)
	at org.apache.jackrabbit.oak.plugins.document.JournalGCIT.journalGCSimpleInvocation(JournalGCIT.java:42)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</description>
                <environment></environment>
        <key id="13012258">OAK-4937</key>
            <summary>JournalGC failing with RDB DocumentStore</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="reschke">Julian Reschke</assignee>
                                    <reporter username="chetanm">Chetan Mehrotra</reporter>
                        <labels>
                    </labels>
                <created>Fri, 14 Oct 2016 05:55:20 +0000</created>
                <updated>Thu, 10 Nov 2016 08:44:25 +0000</updated>
                            <resolved>Fri, 14 Oct 2016 13:53:21 +0000</resolved>
                                    <version>1.4.8</version>
                    <version>1.5.6</version>
                                    <fixVersion>1.4.9</fixVersion>
                    <fixVersion>1.5.13</fixVersion>
                    <fixVersion>1.6.0</fixVersion>
                                    <component>documentmk</component>
                    <component>rdbmk</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15574351" author="chetanm" created="Fri, 14 Oct 2016 06:01:13 +0000"  >&lt;p&gt;Added ignored test at r1764814. The test passes for Memory and Mongo. However the issue does not appear to be in RDB logic. Instead the JournalGC logic is not setting in ID in UpdateOP. With simple &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12833307/12833307_OAK-4937-v1.patch&quot; title=&quot;OAK-4937-v1.patch attached to OAK-4937&quot;&gt;patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; this gets fixed&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;--- oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/JournalGarbageCollector.java
+++ oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/JournalGarbageCollector.java
@@ -164,6 +164,7 @@ &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;JournalGarbageCollector {
     &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void updateTailTimestamp(&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; gcOlderThan) {
         UpdateOp op = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; UpdateOp(JOURNAL_GC_ID, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
         op.max(TAIL_TIMESTAMP, gcOlderThan);
+        op.set(Document.ID, JOURNAL_GC_ID);
         ns.getDocumentStore().createOrUpdate(SETTINGS, op);
     }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So we need to see why this did not caused issue with MemoryDocumentStore or MongoDocumentStore. Possibly the implementation should check for id to be specified as part of UpdateOp&lt;/p&gt;
</comment>
                            <comment id="15574937" author="reschke" created="Fri, 14 Oct 2016 10:40:26 +0000"  >&lt;p&gt;(we need to check which part of the code makes an incorrect assumption)&lt;/p&gt;</comment>
                            <comment id="15574982" author="reschke" created="Fri, 14 Oct 2016 10:54:39 +0000"  >&lt;p&gt;I&apos;ll claim that the &lt;tt&gt;DocumentStore&lt;/tt&gt; implementation works as designed, but the call is wrong.&lt;/p&gt;

&lt;p&gt;Explanation: &lt;tt&gt;RDBDocumentStore&lt;/tt&gt; and &lt;tt&gt;MemoryDocumentStore&lt;/tt&gt; share the same logic and use &lt;tt&gt;UpdateUtils.applyChanges&lt;/tt&gt;, and that assumes that the ID is part of the update operations. The only difference is that while &lt;tt&gt;MemoryDocumentStore&lt;/tt&gt; silently &quot;persists&quot; a document with null key, &lt;tt&gt;RDBDocumentStore&lt;/tt&gt; fails right away.&lt;/p&gt;

&lt;p&gt;For now let&apos;s fix the invocation; I&apos;ll also create a ticket to review the contract and possibly enhance the other implementations to fail fast.&lt;/p&gt;</comment>
                            <comment id="15575402" author="reschke" created="Fri, 14 Oct 2016 13:53:37 +0000"  >&lt;p&gt;trunk: &lt;a href=&quot;http://svn.apache.org/r1764898&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;r1764898&lt;/a&gt; &lt;a href=&quot;http://svn.apache.org/r1764814&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;r1764814&lt;/a&gt;&lt;br/&gt;
1.4: &lt;a href=&quot;http://svn.apache.org/r1764904&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;r1764904&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15581351" author="chetanm" created="Mon, 17 Oct 2016 06:16:12 +0000"  >&lt;p&gt;Given that JournalGC was not passing in ID as part of UpdateOp we would need to see what impact it would have had on existing setups on Mongo where this logic worked silently.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;RDBDocumentStore and MemoryDocumentStore share the same logic and use UpdateUtils.applyChanges&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=julian.reschke%40gmx.de&quot; class=&quot;user-hover&quot; rel=&quot;julian.reschke@gmx.de&quot;&gt;julian.reschke@gmx.de&lt;/a&gt; Note that test was passing for &lt;tt&gt;MemoryDocumentStore&lt;/tt&gt;. Also current Journal test run against &lt;tt&gt;MemoryDocumentStore&lt;/tt&gt;&lt;/p&gt;</comment>
                            <comment id="15581368" author="reschke" created="Mon, 17 Oct 2016 06:25:28 +0000"  >&lt;p&gt;&lt;tt&gt;MemoryDocumentStore&lt;/tt&gt; persists the document with a null key. I noticed that the test passes, but that probably means the test is insufficient in some way.&lt;/p&gt;</comment>
                            <comment id="15604884" author="edivad" created="Tue, 25 Oct 2016 10:20:38 +0000"  >&lt;p&gt;Bulk close for 1.4.9&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                                                <inwardlinks description="is blocked by">
                                        <issuelink>
            <issuekey id="13012324">OAK-4938</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12986196">OAK-4528</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13014643">OAK-4980</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12833307" name="OAK-4937-v1.patch" size="1413" author="chetanm" created="Fri, 14 Oct 2016 05:58:50 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 3 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i34vpr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>