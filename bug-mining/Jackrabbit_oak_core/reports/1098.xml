<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:46:42 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-2192] Concurrent commit during compaction results in mixed segments</title>
                <link>https://issues.apache.org/jira/browse/OAK-2192</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;Changes that are committed during a segment store compaction run will be compacted on top of the already compacted changes. However the compactor uses the wrong before state in this case. Instead of compacting against the compacted before state it uses the un-compacted before state. The resulting state will thus contain references to un-compacted state, making those not eligible for later clean up. &lt;/p&gt;</description>
                <environment></environment>
        <key id="12748055">OAK-2192</key>
            <summary>Concurrent commit during compaction results in mixed segments</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mduerig">Michael D&#252;rig</assignee>
                                    <reporter username="mduerig">Michael D&#252;rig</reporter>
                        <labels>
                            <label>compaction</label>
                            <label>gc</label>
                    </labels>
                <created>Tue, 14 Oct 2014 15:10:26 +0000</created>
                <updated>Wed, 14 Oct 2015 09:54:27 +0000</updated>
                            <resolved>Tue, 16 Dec 2014 16:04:19 +0000</resolved>
                                                    <fixVersion>1.0.9</fixVersion>
                    <fixVersion>1.1.4</fixVersion>
                                    <component>core</component>
                    <component>segmentmk</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="14171055" author="mduerig" created="Tue, 14 Oct 2014 15:14:14 +0000"  >&lt;p&gt;Proposed patch. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=alex.parvulescu&quot; class=&quot;user-hover&quot; rel=&quot;alex.parvulescu&quot;&gt;alex.parvulescu&lt;/a&gt;, kindly review. Any idea how we could regression test this?&lt;/p&gt;</comment>
                            <comment id="14172166" author="alex.parvulescu" created="Wed, 15 Oct 2014 09:13:49 +0000"  >&lt;p&gt;attaching a possible test for this behavior. I know it doesn&apos;t really qualify as a unit test as I basically copied over those bits, but maybe it&apos;s a good start.&lt;/p&gt;

&lt;p&gt;using the same basic idea, you could build a test that boots up a store, in a separate thread starts adding content aggressively, then run the exact check: none of the initial segmentids should be present in the new store. but I find this to be inconsistent and unreliable as far as tests go.&lt;/p&gt;</comment>
                            <comment id="14172172" author="mduerig" created="Wed, 15 Oct 2014 09:24:21 +0000"  >&lt;p&gt;I&apos;d go for the thread aggressively adding content concurrently. In my manual tests this was quite reliable in creating those mixes segments. &lt;/p&gt;

&lt;p&gt;re. &lt;tt&gt;#collectSegments&lt;/tt&gt;: this is the part I was unsure about how to do it. I like this approach. Don&apos;t we also have to account for properties and binaries there though?&lt;/p&gt;</comment>
                            <comment id="14172179" author="alex.parvulescu" created="Wed, 15 Oct 2014 09:33:33 +0000"  >&lt;blockquote&gt;&lt;p&gt;Don&apos;t we also have to account for properties and binaries there though?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;hmm, maybe. If I understand the problem correctly, we might get away with putting more diverse content in the init phase and then have a background thread adding simple nodes, but then we might run into &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-2140&quot; title=&quot;Segment Compactor will not compact binaries &amp;gt; 16k&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-2140&quot;&gt;&lt;del&gt;OAK-2140&lt;/del&gt;&lt;/a&gt;. and off course collecting the segment ids would be a bit more involved.&lt;/p&gt;</comment>
                            <comment id="14172516" author="mduerig" created="Wed, 15 Oct 2014 16:10:28 +0000"  >&lt;p&gt;I committed a test case based on your idea collecting the segments from the node states. The test concurrently writes to the node store while compaction is in progress. This fails reliably for me. See &lt;a href=&quot;http://svn.apache.org/r1632104&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1632104&lt;/a&gt;. &lt;/p&gt;

&lt;p&gt;Applying the patch makes the test pass most of the time. However I still see occasional failures. To make those go away I had to add an extra &lt;tt&gt;flush()&lt;/tt&gt; call at the beginning of &lt;tt&gt;FileStore.compact()&lt;/tt&gt;. &lt;/p&gt;</comment>
                            <comment id="14172521" author="mduerig" created="Wed, 15 Oct 2014 16:17:36 +0000"  >&lt;p&gt;Turns out that flushing the current segment before compacting avoids those references to old segments. With the new patch attached I didn&apos;t see &lt;tt&gt;CompactionAndCleanupTest#testMixedSegments&lt;/tt&gt; failing any more. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=alex.parvulescu&quot; class=&quot;user-hover&quot; rel=&quot;alex.parvulescu&quot;&gt;alex.parvulescu&lt;/a&gt;, please cross check on your side. &lt;/p&gt;</comment>
                            <comment id="14178576" author="mduerig" created="Tue, 21 Oct 2014 16:14:04 +0000"  >&lt;blockquote&gt;&lt;p&gt;Turns out that flushing the current segment before compacting avoids those references&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Not true. It just makes them undetectable to the test case (due to how &lt;tt&gt;collectSegments&lt;/tt&gt;) works). &lt;/p&gt;

&lt;p&gt;In summary: &lt;tt&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-2192&quot; title=&quot;Concurrent commit during compaction results in mixed segments&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-2192&quot;&gt;&lt;del&gt;OAK-2192&lt;/del&gt;&lt;/a&gt;.patch&lt;/tt&gt; is the right thing to do as it reduces the chance of creating mixed segments. However trying to regression test this with &lt;tt&gt;CompactionAndCleanupTest#testMixedSegments&lt;/tt&gt; uncovered more code paths that could lead to mixed segments. Some of those are even undetectable to that test case. &lt;/p&gt;</comment>
                            <comment id="14179991" author="mduerig" created="Wed, 22 Oct 2014 15:00:25 +0000"  >&lt;p&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12676555/12676555_OAK-2192-poc-fix.patch&quot; title=&quot;OAK-2192-poc-fix.patch attached to OAK-2192&quot;&gt;POC patch &lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; making &lt;tt&gt;CompactionAndCleanupTest#testMixedSegments&lt;/tt&gt; pass. There are two additional source for mixed segments:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;Doing a &lt;tt&gt;FileStore.setHead()&lt;/tt&gt; in &lt;tt&gt;FileStore.compact()&lt;/tt&gt; while a &lt;tt&gt;SegmentNodeStore.merge()&lt;/tt&gt; is in progress.&lt;/li&gt;
	&lt;li&gt;Flushing the &lt;tt&gt;SegmentTracker&lt;/tt&gt;&apos;s &lt;tt&gt;SegmentWriter&lt;/tt&gt; too early or too late. It needs to be flushed atomically with the &lt;tt&gt;SegmentWriter&lt;/tt&gt; of the compactor.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;See my comments in the patch for additional details. The patch intentionally breaks all levels of encapsulation as I wanted to concentrate on the bare effects first. Once we agree that it fixes the right thing, we need to look into cleaning it up.&lt;/p&gt;</comment>
                            <comment id="14194409" author="alex.parvulescu" created="Mon, 3 Nov 2014 10:22:32 +0000"  >&lt;p&gt;attaching another draft patch.&lt;br/&gt;
this includes a lot more than this issue, so it may be a good idea to break it apart into dedicated issues once we have some consensus on the approach:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;a proposed approach for the shared semaphore problem (not a very good one unfortunately, but I couldn&apos;t come up with a nicer version)&lt;/li&gt;
	&lt;li&gt;the compaction map now keeps a history of previous states, this will allow us to properly link to the compacted state even after a few consecutive compaction runs&lt;/li&gt;
	&lt;li&gt;the segment tracker now aggressively removes all references keeping the number of refs blocking the compaction process to a bare minimum.&lt;/li&gt;
	&lt;li&gt;Compaction and cleanup test now passes with a tiny hiccup (repo size assumptions changed slightly following the aggressive cleanup approach).&lt;/li&gt;
	&lt;li&gt;a patch for &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-2140&quot; title=&quot;Segment Compactor will not compact binaries &amp;gt; 16k&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-2140&quot;&gt;&lt;del&gt;OAK-2140&lt;/del&gt;&lt;/a&gt;: a flag to control the clone behavior: full copy vs ref copy, there are tradeoffs either way, it makes sense to allow the user to control this via a flag&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;the patch currently bypasses the compaction flag setting, I did this to make testing easier, included it for now because I&apos;m lazy like that.&lt;/p&gt;




</comment>
                            <comment id="14194953" author="alex.parvulescu" created="Mon, 3 Nov 2014 19:29:31 +0000"  >&lt;p&gt;attaching v3 of the draft patch. the extra bits are the compaction strategy classes. this allows for a finer grained control over the segmentid cleanup from the segmentidtable following a compaction run.&lt;/p&gt;

&lt;p&gt;the cleanup strategy are as follows:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;em&gt;none&lt;/em&gt; which would sum-up what is happening now on trunk&lt;/li&gt;
	&lt;li&gt;&lt;em&gt;all&lt;/em&gt; the aggresive approach from v2 of this patch, this clears all segmentid refs allowing for a full GC run.&lt;/li&gt;
	&lt;li&gt;&lt;em&gt;timestamp&lt;/em&gt; this will be a timestamp based approach, meaning clear every segment older than a specific value of milliseconds.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I&apos;m also trying to do something sneaky with the _ SegmentNotFoundException_ in the SegmentIdTracker. I&apos;m logging the delta of the segmentid creation time vs the current millis, so that we can gain better knowledge of the optimal time window value for the &lt;em&gt;timestamp&lt;/em&gt; based approach (loosely based on Chetan&apos;s approach in &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-2045&quot; title=&quot;Long running JCR session prevent live cleanup in Segment FileStore&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-2045&quot;&gt;&lt;del&gt;OAK-2045&lt;/del&gt;&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;We&apos;re advancing into the realm of &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-2045&quot; title=&quot;Long running JCR session prevent live cleanup in Segment FileStore&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-2045&quot;&gt;&lt;del&gt;OAK-2045&lt;/del&gt;&lt;/a&gt;, I&apos;m wondering if it makes sense to merge the 2 issues, of move this discussion there even.&lt;/p&gt;

&lt;p&gt;The naming of these new classes is quite bland, I&apos;m open for better alternatives &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;
</comment>
                            <comment id="14195892" author="mduerig" created="Tue, 4 Nov 2014 08:51:07 +0000"  >&lt;blockquote&gt;&lt;p&gt;We&apos;re advancing into the realm of &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-2045&quot; title=&quot;Long running JCR session prevent live cleanup in Segment FileStore&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-2045&quot;&gt;&lt;del&gt;OAK-2045&lt;/del&gt;&lt;/a&gt;, I&apos;m wondering if it makes sense to merge the 2 issues. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Let&apos;s keep them separate. I added a comment to &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-2045&quot; title=&quot;Long running JCR session prevent live cleanup in Segment FileStore&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-2045&quot;&gt;&lt;del&gt;OAK-2045&lt;/del&gt;&lt;/a&gt; that most of the discussion is currently here. Once we converge towards a solution I think it makes sense to split the patch into relevant fixes for &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-2140&quot; title=&quot;Segment Compactor will not compact binaries &amp;gt; 16k&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-2140&quot;&gt;&lt;del&gt;OAK-2140&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-2045&quot; title=&quot;Long running JCR session prevent live cleanup in Segment FileStore&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-2045&quot;&gt;&lt;del&gt;OAK-2045&lt;/del&gt;&lt;/a&gt; and for this issue.&lt;/p&gt;</comment>
                            <comment id="14195957" author="mduerig" created="Tue, 4 Nov 2014 09:39:35 +0000"  >&lt;p&gt;One random thing that crossed my mind looking at the v3 patch is, could we make &lt;tt&gt;cloneLargeBinaries&lt;/tt&gt; part of the compaction strategy concept?&lt;/p&gt;</comment>
                            <comment id="14195997" author="alex.parvulescu" created="Tue, 4 Nov 2014 11:07:39 +0000"  >&lt;p&gt;v4 , I&apos;ve merge all compaction related settings into a single class. this will make it easier to expose via JMX so we can live tweak &amp;amp; test the different options. the jmx stuff is not yet included.&lt;/p&gt;</comment>
                            <comment id="14196153" author="alex.parvulescu" created="Tue, 4 Nov 2014 14:35:27 +0000"  >&lt;p&gt;attached V5. as pointed out by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mduerig&quot; class=&quot;user-hover&quot; rel=&quot;mduerig&quot;&gt;mduerig&lt;/a&gt; the timestamp approach had a bug, it used a fixed value in time instead of a ms period as a reference.&lt;/p&gt;</comment>
                            <comment id="14196183" author="mduerig" created="Tue, 4 Nov 2014 15:03:56 +0000"  >&lt;p&gt;v6 patch, include the segment id when logging not found segments&lt;/p&gt;</comment>
                            <comment id="14198372" author="alex.parvulescu" created="Wed, 5 Nov 2014 13:39:12 +0000"  >&lt;p&gt;v7 includes v6 plus:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;mbean to expose &amp;amp; allow temp tweaking of compaction settings&lt;/li&gt;
	&lt;li&gt;tests around cleanup strategies&lt;/li&gt;
	&lt;li&gt;tweaked the defaults a bit, but this can change easily later&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14198892" author="alex.parvulescu" created="Wed, 5 Nov 2014 19:14:52 +0000"  >&lt;p&gt;I think there are still places in oak-core/oak-jcr where refs to old root states are kept around, even if one calls root#refresh. See &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-2254&quot; title=&quot;Observation events accessibility check should respect session refresh settings&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-2254&quot;&gt;&lt;del&gt;OAK-2254&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-2255&quot; title=&quot;PermissionStoreImpl refresh root on flush&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-2255&quot;&gt;&lt;del&gt;OAK-2255&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="14198906" author="alex.parvulescu" created="Wed, 5 Nov 2014 19:19:41 +0000"  >&lt;p&gt;I&apos;ve potentially noticed a new issue &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-2256&quot; title=&quot;MemoryNodeBuilder NPE on base() following root refresh&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-2256&quot;&gt;&lt;del&gt;OAK-2256&lt;/del&gt;&lt;/a&gt; following the root refresh issues.&lt;/p&gt;</comment>
                            <comment id="14198923" author="alex.parvulescu" created="Wed, 5 Nov 2014 19:29:22 +0000"  >&lt;p&gt;One observation on the &lt;em&gt;timestamp&lt;/em&gt; based cleanup approach: I&apos;ve noticed that running compaction against a fresh system (cold cache, only a subset of segments are loaded) will result in loading all segmentsids with a really recent creation date (after the compaction start date) thanks to the diff performed by the compaction process itself. &lt;br/&gt;
this means that the first compaction run will double the size of the repo while not being able to clean anything as nothing falls into the cleanup filter (segments older than a specific time window).waiting for the cleanup window to pass and running compaction again will usually help.&lt;/p&gt;</comment>
                            <comment id="14203902" author="alex.parvulescu" created="Sun, 9 Nov 2014 12:40:51 +0000"  >&lt;p&gt;v8 of this patch. I see no more SNFEs, but there are quite some changes included: &lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;really add everything to the compaction map (all nodes, all binaries),&lt;/li&gt;
	&lt;li&gt;segmentid equals check needs to change, the old impl cannot work given the cleanup approaches we have now in place&lt;/li&gt;
	&lt;li&gt;tarreader cleanup will now try to take into account the compaction map in the case of binary segments. this helps with currently running diffs over the old states.&lt;br/&gt;
To explain this a bit better: the compaction map is quite efficient in linking old states to the new versions, but the only window of trouble we have now are already running diffs, where loading the current node state triggers loading a segment that may be already gone. this is where you can really see the difference between the 2 available cleanup strategies: &apos;all&apos; will cleanup everything but gives no fallback for this scenario, &apos;timestamp&apos; will allow running diffs to catchup at the cost of having to keep some garbage around for a longer time. the change on v8 is that now we take into account bulk segments already compacted and skip them to make this process more efficient.&lt;/li&gt;
	&lt;li&gt;switched the &quot;pause&quot; flag to false to allow compaction to run.&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;TODO we possibly need to remove the SNFE logs in the SegmentTracker, cleanup.&lt;/p&gt;
</comment>
                            <comment id="14204060" author="alex.parvulescu" created="Sun, 9 Nov 2014 19:04:29 +0000"  >&lt;p&gt;attaching v8 of the patch that applies cleanly to the 1.0 branch&lt;/p&gt;</comment>
                            <comment id="14232820" author="alex.parvulescu" created="Wed, 3 Dec 2014 09:39:00 +0000"  >&lt;p&gt;attaching v9 of the patch&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;I removed the segment loaded&lt;/li&gt;
	&lt;li&gt;refactored the CompactionMap so that it takes 30% less space due to making the &apos;afterSegmentIds&apos; structure more efficient&lt;/li&gt;
	&lt;li&gt;added CompactionMap weigh estimation&lt;/li&gt;
	&lt;li&gt;introduced a memory check before compaction based on the available memory (available has to be more than 5x the compaction map weight otherwise compaction won&apos;t run), this should prevent potential OOMEs&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14232866" author="alex.parvulescu" created="Wed, 3 Dec 2014 10:48:46 +0000"  >&lt;p&gt;As the v9 doesn&apos;t apply properly to 1.0, I&apos;m also attaching the 1.0 branch version.&lt;/p&gt;</comment>
                            <comment id="14244478" author="mduerig" created="Fri, 12 Dec 2014 17:31:03 +0000"  >&lt;p&gt;Attaching v10 of the patches (both for trunk and 1.0). While functionally equivalent to v9, I attempted to clean things up a bit:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Replaced the &lt;tt&gt;GCHeadGuard&lt;/tt&gt; mechanism with a call back in &lt;tt&gt;CompactionStrategy&lt;/tt&gt;. The problem with the former approach was that it wouldn&apos;t work with other &lt;tt&gt;SegmentStore&lt;/tt&gt; implementations without &lt;tt&gt;SegmentNodeStore&lt;/tt&gt; having to instance of check against all of them.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Made &lt;tt&gt;CompactionStrategy&lt;/tt&gt; into a class. I think the implementation requirement are too specific for admitting other implementations. To me the interface looks like a leftover from when we had the three implementations which are now all covered by the one class.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Moved the &lt;tt&gt;SegmentWriter.flush&lt;/tt&gt; call that followed calls to &lt;tt&gt;Compactor.compact&lt;/tt&gt; into latter method.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Moved some test cases around so long running test run as ITs and package private members could stay such.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Better usage of enums in &lt;tt&gt;CompactionStrategy&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Some renaming here and there.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14245381" author="alex.parvulescu" created="Sat, 13 Dec 2014 15:27:43 +0000"  >&lt;p&gt;looks great! awesome job!&lt;/p&gt;

&lt;p&gt;minor feedback:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;I like the callback idea, looks neat! one thing I&apos;m worried about is using the SegmentStore &amp;amp; friends outside of an OSGi env. The proper wrapping of the callback into the semaphore lock will not work then, right?&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;I&apos;m confused by the following lines (not introduced, but only surfaced by your patch) in the SegmentWriter (line 1096)
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!(before &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; SegmentNodeState) || store.containsSegment(before.getRecordId().getSegmentId())) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;last one for me personally, I introduced a bug in the SegmentNodeStoreService class trying to fix a potential deadlock in the initialization in relation to the &apos;standby&apos; flag. If you start with false, then change to true it will deadlock because of the fat synchronized block. My fix basically broke the lazy init of the custom blob store, such is OSGi support &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;blockquote&gt;&lt;p&gt;Better usage of enums in CompactionStrategy&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;thanks for cleaning that up &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14246621" author="mduerig" created="Mon, 15 Dec 2014 12:57:18 +0000"  >&lt;p&gt;Committed the v10 patch at &lt;a href=&quot;http://svn.apache.org/r1645637&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1645637&lt;/a&gt; including a fixes from Alex for the deadlock problem and the wrong constant values in &lt;tt&gt;SegmentNodeStoreService&lt;/tt&gt;. &lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;The proper wrapping of the callback into the semaphore lock will not work then, right?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;One way to enforce the setup of the callbacks is to make the respective method in &lt;tt&gt;CompactionStrategy&lt;/tt&gt; abstract. -&lt;del&gt;Will follow up on this&lt;/del&gt;-. See &lt;a href=&quot;http://svn.apache.org/r1645662&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1645662&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14246637" author="mduerig" created="Mon, 15 Dec 2014 13:19:23 +0000"  >&lt;blockquote&gt;&lt;p&gt;I&apos;m confused by the following lines (not introduced, but only surfaced by your patch) in the SegmentWriter (line 1096) &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I created &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-2356&quot; title=&quot;Logic for writing properties in SegmentWriter.writeNode looks off&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-2356&quot;&gt;&lt;del&gt;OAK-2356&lt;/del&gt;&lt;/a&gt; to track this.&lt;/p&gt;</comment>
                            <comment id="14247982" author="alex.parvulescu" created="Tue, 16 Dec 2014 09:39:22 +0000"  >&lt;p&gt;in rev &lt;a href=&quot;http://svn.apache.org/r1645888&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1645888&lt;/a&gt; I adapted the compaction test from &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-2045&quot; title=&quot;Long running JCR session prevent live cleanup in Segment FileStore&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-2045&quot;&gt;&lt;del&gt;OAK-2045&lt;/del&gt;&lt;/a&gt; and committed it as a part of this issue.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;edit&amp;#93;&lt;/span&gt; the test is failing sometimes so I loosened the constraints a bit in rev &lt;a href=&quot;http://svn.apache.org/r1645901&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1645901&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;edit 2&amp;#93;&lt;/span&gt; the test was failing on Win because the store was not getting closed, thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=reschke&quot; class=&quot;user-hover&quot; rel=&quot;reschke&quot;&gt;reschke&lt;/a&gt; to the notification. plus more debug logs. r1645966 and r1645971&lt;/p&gt;</comment>
                            <comment id="14248409" author="mduerig" created="Tue, 16 Dec 2014 16:04:19 +0000"  >&lt;p&gt;With &lt;a href=&quot;http://svn.apache.org/r1645982&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1645982&lt;/a&gt; this should be fixed in trunk and 1.0&lt;/p&gt;</comment>
                            <comment id="14255412" author="amitjain" created="Mon, 22 Dec 2014 04:10:18 +0000"  >&lt;p&gt;Bulk close for 1.0.9&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12759635">OAK-2322</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12770321">OAK-2449</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12735772">OAK-2045</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12755383">OAK-2271</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                            <outwardlinks description="depends upon">
                                        <issuelink>
            <issuekey id="12744052">OAK-2140</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12753132">OAK-2254</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12753138">OAK-2255</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12753141">OAK-2256</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12753708">OAK-2259</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is depended upon by">
                                        <issuelink>
            <issuekey id="12735772">OAK-2045</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12675024" name="OAK-2192-2.patch" size="1136" author="mduerig" created="Wed, 15 Oct 2014 16:17:36 +0000"/>
                            <attachment id="12676555" name="OAK-2192-poc-fix.patch" size="6402" author="mduerig" created="Thu, 23 Oct 2014 09:48:31 +0000"/>
                            <attachment id="12674961" name="OAK-2192-possible-test.patch" size="4104" author="stillalex" created="Wed, 15 Oct 2014 09:13:49 +0000"/>
                            <attachment id="12686884" name="OAK-2192-v10-branch-1.0.patch" size="94615" author="mduerig" created="Fri, 12 Dec 2014 17:31:03 +0000"/>
                            <attachment id="12686885" name="OAK-2192-v10.patch" size="91432" author="mduerig" created="Fri, 12 Dec 2014 17:31:03 +0000"/>
                            <attachment id="12678906" name="OAK-2192-v2.patch" size="22412" author="stillalex" created="Mon, 3 Nov 2014 10:22:32 +0000"/>
                            <attachment id="12679001" name="OAK-2192-v3.patch" size="35071" author="stillalex" created="Mon, 3 Nov 2014 19:29:31 +0000"/>
                            <attachment id="12679199" name="OAK-2192-v4.patch" size="35399" author="stillalex" created="Tue, 4 Nov 2014 11:07:39 +0000"/>
                            <attachment id="12679224" name="OAK-2192-v5.patch" size="35553" author="stillalex" created="Tue, 4 Nov 2014 14:35:27 +0000"/>
                            <attachment id="12679230" name="OAK-2192-v6.patch" size="37542" author="mduerig" created="Tue, 4 Nov 2014 15:03:56 +0000"/>
                            <attachment id="12679525" name="OAK-2192-v7.patch" size="54787" author="stillalex" created="Wed, 5 Nov 2014 13:39:12 +0000"/>
                            <attachment id="12680500" name="OAK-2192-v8-branch-1.0.patch" size="58219" author="stillalex" created="Sun, 9 Nov 2014 19:04:29 +0000"/>
                            <attachment id="12680476" name="OAK-2192-v8.patch" size="67782" author="stillalex" created="Sun, 9 Nov 2014 12:40:51 +0000"/>
                            <attachment id="12684868" name="OAK-2192-v9-branch-1.0.patch" size="70335" author="stillalex" created="Wed, 3 Dec 2014 10:48:46 +0000"/>
                            <attachment id="12684856" name="OAK-2192-v9.patch" size="81080" author="stillalex" created="Wed, 3 Dec 2014 09:39:00 +0000"/>
                            <attachment id="12674780" name="OAK-2192.patch" size="864" author="mduerig" created="Tue, 14 Oct 2014 15:14:14 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>16.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311120" key="com.pyxis.greenhopper.jira:gh-epic-link">
                        <customfieldname>Epic Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>OAK-2849</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 47 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i215pb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>