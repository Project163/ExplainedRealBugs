<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:49:02 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-3390] Avoid instanceof check in DocumentNodeStore</title>
                <link>https://issues.apache.org/jira/browse/OAK-3390</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;The instanceof MongoDocumentStore check does not work anymore when the store is wrapped with e.g. the LeaseCheckDocumentStoreWrapper.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12863054">OAK-3390</key>
            <summary>Avoid instanceof check in DocumentNodeStore</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mreutegg">Marcel Reutegger</assignee>
                                    <reporter username="mreutegg">Marcel Reutegger</reporter>
                        <labels>
                    </labels>
                <created>Thu, 10 Sep 2015 13:48:32 +0000</created>
                <updated>Wed, 2 Mar 2016 14:27:06 +0000</updated>
                            <resolved>Mon, 14 Sep 2015 14:26:52 +0000</resolved>
                                    <version>1.3.4</version>
                                    <fixVersion>1.3.7</fixVersion>
                    <fixVersion>1.4</fixVersion>
                                    <component>core</component>
                    <component>mongomk</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14738782" author="egli" created="Thu, 10 Sep 2015 13:59:33 +0000"  >&lt;p&gt;&lt;del&gt;What about introducing &lt;tt&gt;DocumentStore.unwrap()&lt;/tt&gt; which would provide the underlying documentstore should it be wrapped, or this ?&lt;/del&gt; probably better to make something generic as suggested offline by Julian&lt;/p&gt;</comment>
                            <comment id="14738787" author="reschke" created="Thu, 10 Sep 2015 14:07:19 +0000"  >&lt;p&gt;Recommendation: borrow from both &lt;a href=&quot;http://docs.oracle.com/javase/6/docs/api/java/sql/Wrapper.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://docs.oracle.com/javase/6/docs/api/java/sql/Wrapper.html&lt;/a&gt; and Sling&apos;s Adaptable.&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;checker function canAdaptTo&lt;/li&gt;
	&lt;li&gt;adapter function adaptTo, potentially returning null&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The reason for having the checker is that sometimes it can be expensive to adapt, and the caller just needs to know whether adapting would be possible.&lt;/p&gt;

&lt;p&gt;Define interface in oak-commons, and make DocumentStore implement that.&lt;/p&gt;</comment>
                            <comment id="14738798" author="egli" created="Thu, 10 Sep 2015 14:17:03 +0000"  >&lt;p&gt;or .. we could also demand DocumentStore to provide an adapter for the three cases we currently have (MissingLastRevSeeker, BlobReferenceIterator and VersionGCSupport) via a &lt;tt&gt;DocumentStore.adaptTo()&lt;/tt&gt; - we could of course generalize this in an interface but so far the use cases are very limited and known..&lt;/p&gt;</comment>
                            <comment id="14738803" author="mreutegg" created="Thu, 10 Sep 2015 14:19:07 +0000"  >&lt;p&gt;I would rather move this kind of factory method into the Builder. That way the builder can decide what BlobReferenceIterator needs to be created.&lt;/p&gt;</comment>
                            <comment id="14738814" author="reschke" created="Thu, 10 Sep 2015 14:23:47 +0000"  >&lt;p&gt;I think we shouldn&apos;t conflate the two issues. 1) is making the DS APIs powerful enough so that callers do not special-case certain implementations. 2) is the problem of wrapper classes and extension interfaces. For 1) we have Thomas&apos; proposal (&lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-3213&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/OAK-3213&lt;/a&gt;), for 2) I&apos;d prefer something like my proposal above.&lt;/p&gt;</comment>
                            <comment id="14738974" author="reschke" created="Thu, 10 Sep 2015 15:54:54 +0000"  >&lt;p&gt;Proposed interface:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;/*
 * Licensed to the Apache Software Foundation (ASF) under one or more
 * contributor license agreements.  See the NOTICE file distributed with
 * &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; work &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; additional information regarding copyright ownership.
 * The ASF licenses &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; file to You under the Apache License, Version 2.0
 * (the &lt;span class=&quot;code-quote&quot;&gt;&quot;License&quot;&lt;/span&gt;); you may not use &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; file except in compliance with
 * the License.  You may obtain a copy of the License at
 *
 *      http:&lt;span class=&quot;code-comment&quot;&gt;//www.apache.org/licenses/LICENSE-2.0
&lt;/span&gt; *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &lt;span class=&quot;code-quote&quot;&gt;&quot;AS IS&quot;&lt;/span&gt; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the specific language governing permissions and
 * limitations under the License.
 */
&lt;span class=&quot;code-keyword&quot;&gt;package&lt;/span&gt; org.apache.jackrabbit.oak.commons;

/**
 * Identifies objects which can be adapted to other types or representations of the same object.
 * &amp;lt;p&amp;gt;
 * &amp;lt;em&amp;gt;Inspired by Apache Sling&lt;span class=&quot;code-quote&quot;&gt;&apos;s Adaptable and Java SQL&apos;&lt;/span&gt;s Wrapper interfaces.&amp;lt;/em&amp;gt;
 */
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;interface&lt;/span&gt; Adaptable {

    /**
     * Checks whether the adaptable can be converted to the specified type.
     * 
     * @param type
     *            The &lt;span class=&quot;code-keyword&quot;&gt;generic&lt;/span&gt; type to check &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;
     * @&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; {@code &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;} &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; a call to {link {@link #adaptTo(&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;)}} is
     *         likely to succeed
     */
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isAdaptable(&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;&amp;lt;?&amp;gt; type);

    /**
     * Adapts the adaptable to another type.
     * &amp;lt;p&amp;gt;
     * Please note that it is explicitly left as an implementation detail
     * whether each call to &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; method with the same type yields the same
     * object or a &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; object on each call.
     * &amp;lt;p&amp;gt;
     * Implementations of &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; method should document their adapted types as
     * well as their behavior with respect to returning newly created or not
     * instance on each call.
     * 
     * @param &amp;lt;AdapterType&amp;gt;
     *            The &lt;span class=&quot;code-keyword&quot;&gt;generic&lt;/span&gt; type to which &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; object is adapted to
     * @param type
     *            The &lt;span class=&quot;code-keyword&quot;&gt;generic&lt;/span&gt; type to which &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; object is adapted to
     * @&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; The adapter target or {@code &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;} &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; the object cannot adapt to
     *         the requested type
     */
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &amp;lt;AdapterType&amp;gt; AdapterType adaptTo(&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;&amp;lt;AdapterType&amp;gt; type);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14740701" author="reschke" created="Fri, 11 Sep 2015 12:27:31 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mreutegg&quot; class=&quot;user-hover&quot; rel=&quot;mreutegg&quot;&gt;mreutegg&lt;/a&gt; note that the changes for &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-3313&quot; title=&quot;Many tests leak DocumentNodeStore instances&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-3313&quot;&gt;&lt;del&gt;OAK-3313&lt;/del&gt;&lt;/a&gt; now cause &lt;tt&gt;LastRevRecoveryAgentTest&lt;/tt&gt; to not test the Mongo variant anymore.&lt;/p&gt;</comment>
                            <comment id="14743049" author="egli" created="Mon, 14 Sep 2015 07:29:55 +0000"  >&lt;p&gt;my take on doing a generic &lt;tt&gt;Adaptable&lt;/tt&gt; is that that makes sense in a Silng Resource context since Resource is going to be very frequently used and will have many different adapter classes - while as with &lt;tt&gt;DocumentNodeStore&lt;/tt&gt; we&apos;re inside an implementation and the number of adapter classes will be very few and are mostly known beforehand.&lt;/p&gt;</comment>
                            <comment id="14743056" author="reschke" created="Mon, 14 Sep 2015 07:38:16 +0000"  >&lt;p&gt;If that was true, why do we have the current breakage then? &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14743057" author="mreutegg" created="Mon, 14 Sep 2015 07:38:40 +0000"  >&lt;p&gt;I agree with Stefan. We are talking about as single instanceof we would like to get rid of. As mentioned before my preference is to move this factory method to a place where we know what kind of backend store is used. This is currently the DocumentMK.Builder, but in the long run we should probably split it up into a generic Builder and introduce two new builders: one for MongoDB and another one for RDB.&lt;/p&gt;</comment>
                            <comment id="14743062" author="reschke" created="Mon, 14 Sep 2015 07:47:00 +0000"  >&lt;p&gt;More breakage in a different place: &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-3389&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/OAK-3389&lt;/a&gt; (and I don&apos;t believe we&apos;d want to handle that with Builder extensions). Also, we know that the multiplexing implementation will have the same problem.&lt;/p&gt;</comment>
                            <comment id="14743581" author="mreutegg" created="Mon, 14 Sep 2015 14:26:52 +0000"  >&lt;p&gt;Fixed in trunk: &lt;a href=&quot;http://svn.apache.org/r1702959&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1702959&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14743614" author="reschke" created="Mon, 14 Sep 2015 14:47:02 +0000"  >&lt;p&gt;Hmmm.&lt;/p&gt;

&lt;p&gt;1) This doesn&apos;t remove the &quot;instanceof&quot;, it just moves it into a different class.&lt;/p&gt;

&lt;p&gt;2) We still have the &quot;instanceof&quot; in LastRevRecoveryAgent.&lt;/p&gt;</comment>
                            <comment id="14744991" author="mreutegg" created="Tue, 15 Sep 2015 07:27:25 +0000"  >&lt;p&gt;This issue is specifically about the instanceof check in DocumentNodeStore which was broken because of the wrapper classes that may be present. I agree, the current fix is not the final solution, but it is a first step. As mentioned before, I think the Builder class should be split into backend specific implementations. That way the MongoDB builder implementation would override the factory method without the need to perform an instanceof check. It already knows it created a MongoDocumentStore.&lt;/p&gt;

&lt;p&gt;For the LastRevRecoveryAgent I created &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-3405&quot; title=&quot;Avoid instanceof check in LastRevRecoveryAgent&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-3405&quot;&gt;&lt;del&gt;OAK-3405&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="14939231" author="amitjain" created="Thu, 1 Oct 2015 03:35:11 +0000"  >&lt;p&gt;Bulk close for 1.3.7&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12819682">OAK-2739</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12864161">OAK-3405</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12863040">OAK-3389</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 7 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2jzwn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>