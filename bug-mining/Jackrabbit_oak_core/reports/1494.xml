<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:50:47 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-4430] DataStoreBlobStore#getAllChunkIds fetches DataRecord when not needed</title>
                <link>https://issues.apache.org/jira/browse/OAK-4430</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;DataStoreBlobStore#getAllChunkIds loads the DataRecord for checking that the lastModifiedTime criteria is satisfied against the given &lt;tt&gt;maxLastModifiedTime&lt;/tt&gt;. &lt;br/&gt;
When the &lt;tt&gt;maxLastModifiedTime&lt;/tt&gt; has a value 0 it  effectively means ignore any last modified time check (and which is the only usage currently from MarkSweepGarbageCollector). This should ignore fetching the DataRecords as this can be very expensive for e.g on calls to S3 with millions of blobs.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12975885">OAK-4430</key>
            <summary>DataStoreBlobStore#getAllChunkIds fetches DataRecord when not needed</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="amitjain">Amit Jain</assignee>
                                    <reporter username="amitjain">Amit Jain</reporter>
                        <labels>
                    </labels>
                <created>Mon, 6 Jun 2016 05:11:49 +0000</created>
                <updated>Wed, 20 Jul 2016 04:07:37 +0000</updated>
                            <resolved>Wed, 8 Jun 2016 03:52:23 +0000</resolved>
                                                    <fixVersion>1.2.17</fixVersion>
                    <fixVersion>1.4.4</fixVersion>
                    <fixVersion>1.5.4</fixVersion>
                    <fixVersion>1.6.0</fixVersion>
                                    <component>blob</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="15316317" author="amitjain" created="Mon, 6 Jun 2016 08:12:56 +0000"  >&lt;p&gt;The method &lt;tt&gt;DataStoreBlobStore#getAllChunkIds&lt;/tt&gt; also used the DataRecord fetched to encode the length in the id. Considering that this method has only one consumer i.e. the &lt;tt&gt;MarkSweepGarbageCollector&lt;/tt&gt;, we could alter this method itself to not encode the blob ids with the length and clearly specify in the javadocs. Alternately, we could add an overloaded method that returns all raw blob ids.&lt;br/&gt;
Either way this would require a method which the gc class can use to get a raw id given a length encoded id which the &quot;node store referenced blobs&quot;  collection phase would return.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chetanm&quot; class=&quot;user-hover&quot; rel=&quot;chetanm&quot;&gt;chetanm&lt;/a&gt; wdyt?&lt;/p&gt;</comment>
                            <comment id="15318072" author="amitjain" created="Tue, 7 Jun 2016 07:49:29 +0000"  >&lt;p&gt;Just for the record had an offline chat with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chetanm&quot; class=&quot;user-hover&quot; rel=&quot;chetanm&quot;&gt;chetanm&lt;/a&gt; yesterday and he suggested that since, S3 already returns the size object when doing the listing it&apos;s better we create a new overloaded method which return the DataRecord. This will help save the additional call to S3 and also not leak out abstraction related to length encoding in the blob ids.&lt;/p&gt;</comment>
                            <comment id="15319942" author="amitjain" created="Wed, 8 Jun 2016 03:52:23 +0000"  >&lt;p&gt;In trunk with &lt;a href=&quot;http://svn.apache.org/viewvc?rev=1747342&amp;amp;view=rev&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?rev=1747342&amp;amp;view=rev&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15322081" author="tmueller" created="Thu, 9 Jun 2016 07:35:09 +0000"  >&lt;p&gt;FYI I saw the following info level log message. I assume it is not a big problem and GC didn&apos;t stop because of that. Not sure if this can occur with this issue fixed&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;*INFO* [sling-oak-observation-13590] com.amazonaws.http.AmazonHttpClient Unable to execute HTTP request: 
....amazonaws.com failed to respond
org.apache.http.NoHttpResponseException: ....amazonaws.com failed to respond
 (following lines are not in the right order)
at org.apache.http.impl.AbstractHttpClientConnection.receiveResponseHeader(AbstractHttpClientConnection.java:283)
at org.apache.http.impl.client.AbstractHttpClient.doExecute(AbstractHttpClient.java:863)
at org.apache.http.impl.client.CloseableHttpClient.execute(CloseableHttpClient.java:57)
at org.apache.http.impl.client.CloseableHttpClient.execute(CloseableHttpClient.java:82)
at org.apache.http.impl.client.DefaultRequestDirector.execute(DefaultRequestDirector.java:487)
at org.apache.http.impl.client.DefaultRequestDirector.tryExecute(DefaultRequestDirector.java:685)
at org.apache.http.impl.conn.DefaultClientConnection.receiveResponseHeader(DefaultClientConnection.java:251)
at org.apache.http.impl.conn.DefaultHttpResponseParser.parseHead(DefaultHttpResponseParser.java:57)
at org.apache.http.impl.conn.DefaultHttpResponseParser.parseHead(DefaultHttpResponseParser.java:143)
at org.apache.http.impl.conn.ManagedClientConnectionImpl.receiveResponseHeader(ManagedClientConnectionImpl.java:197)
at org.apache.http.protocol.HttpRequestExecutor.execute(HttpRequestExecutor.java:123)
at com.amazonaws.http.AmazonHttpClient.execute(AmazonHttpClient.java:317)
at com.amazonaws.http.AmazonHttpClient.executeHelper(AmazonHttpClient.java:505) 
at com.amazonaws.http.AmazonHttpClient.executeOneRequest(AmazonHttpClient.java:749)
at com.amazonaws.services.s3.AmazonS3Client.invoke(AmazonS3Client.java:3595)
at com.amazonaws.services.s3.AmazonS3Client.getObjectMetadata(AmazonS3Client.java:999)
at com.google.common.collect.AbstractIterator.tryToComputeNext(AbstractIterator.java:143)
at com.google.common.collect.Iterators$7.computeNext(Iterators.java:646)
at com.google.common.collect.Iterators$8.transform(Iterators.java:794)
at org.apache.jackrabbit.oak.plugins.blob.datastore.DataStoreBlobStore$3.apply(DataStoreBlobStore.java:372)
at com.google.common.collect.TransformedIterator.next(TransformedIterator.java:48)
at org.apache.http.impl.io.AbstractMessageParser.parse(AbstractMessageParser.java:260)
at com.amazonaws.services.s3.AmazonS3Client.getObjectMetadata(AmazonS3Client.java:999)
at com.amazonaws.http.AmazonHttpClient.execute(AmazonHttpClient.java:317)
at com.amazonaws.services.s3.AmazonS3Client.getObjectMetadata(AmazonS3Client.java:977)
 (following lines should be in the right order)
at org.apache.jackrabbit.oak.blob.cloud.aws.s3.S3Backend.getLength(S3Backend.java:479)
at org.apache.jackrabbit.core.data.CachingDataStore.getLength(CachingDataStore.java:669)
at org.apache.jackrabbit.oak.plugins.blob.datastore.DataStoreBlobStore$3.apply(DataStoreBlobStore.java:367)
at com.google.common.collect.Iterators$8.transform(Iterators.java:794)
at com.google.common.collect.AbstractIterator.tryToComputeNext(AbstractIterator.java:143)
at com.google.common.collect.Iterators$7.computeNext(Iterators.java:646)
at org.apache.jackrabbit.oak.plugins.blob.datastore.DataStoreBlobStore$3.apply(DataStoreBlobStore.java:372)
at org.apache.jackrabbit.core.data.CachingDataStore.getRecord(CachingDataStore.java:467)
at org.apache.jackrabbit.oak.plugins.blob.MarkSweepGarbageCollector$BlobIdRetriever.call(MarkSweepGarbageCollector.java:619)
at com.google.common.collect.TransformedIterator.hasNext(TransformedIterator.java:43)
at org.apache.jackrabbit.oak.plugins.blob.MarkSweepGarbageCollector.sweep(MarkSweepGarbageCollector.java:377)
at org.apache.jackrabbit.oak.plugins.blob.MarkSweepGarbageCollector.collectGarbage(MarkSweepGarbageCollector.java:163)
at org.apache.jackrabbit.oak.plugins.blob.BlobGC$1.call(BlobGC.java:87)
at org.apache.jackrabbit.oak.plugins.blob.BlobGC$1.call(BlobGC.java:83)
at org.apache.jackrabbit.oak.plugins.blob.MarkSweepGarbageCollector.markAndSweep(MarkSweepGarbageCollector.java:250)
at java.util.concurrent.FutureTask.run(FutureTask.java:266)
at com.google.common.collect.AbstractIterator.hasNext(AbstractIterator.java:138)
at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
at java.lang.Thread.run(Thread.java:745)
at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15323852" author="amitjain" created="Fri, 10 Jun 2016 04:36:33 +0000"  >&lt;p&gt;Yes, the GC operation should have proceeded but would have cleared up garbage only partially. This issue can still occur if the connection fails, but with less probability of occurrence as with this fixed we only make 1 call as opposed to potentially making 4 calls to S3.&lt;/p&gt;</comment>
                            <comment id="15343773" author="tmueller" created="Wed, 22 Jun 2016 06:04:26 +0000"  >&lt;p&gt;Some new statistics, retrieving blobs is now about 240 times faster.&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;before: 8.3 blobs / second (4 min / 2k blobs)&lt;/li&gt;
	&lt;li&gt;now: 2000 blobs / second (1 sec / 2k blobs)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;See also &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-4200&quot; title=&quot;[BlobGC] Improve collection times of blobs available&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-4200&quot;&gt;&lt;del&gt;OAK-4200&lt;/del&gt;&lt;/a&gt;. before this fix, GC took around 37 hours. 99.91% of that time was &quot;retrieve of all blobs&quot; (about 2 million). Retrieving references took about 1 minute 45 seconds, and sorting and deleting took around 10 seconds. With this fix, we can estimate GC will take around 10 minutes for 2 million blobs, where retrieving blobs takes around 80% of the time (compared to 99.91% before the fix). &lt;/p&gt;</comment>
                            <comment id="15345831" author="amitjain" created="Thu, 23 Jun 2016 06:04:40 +0000"  >&lt;p&gt;Merged into 1.2 with r1749827 &amp;amp; 1.4 with r1749821&lt;/p&gt;</comment>
                            <comment id="15351142" author="edivad" created="Mon, 27 Jun 2016 14:30:19 +0000"  >&lt;p&gt;Bulk close 1.5.4&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12990990">OAK-4577</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12958484">OAK-4200</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12990637">OAK-4573</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 20 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2z0hb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>