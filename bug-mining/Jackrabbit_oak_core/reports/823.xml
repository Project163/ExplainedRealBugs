<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:43:37 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-1654] Composite index aggregates</title>
                <link>https://issues.apache.org/jira/browse/OAK-1654</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;This is a followup for what is still missing from &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-828&quot; title=&quot;Full-text support for index aggregates&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-828&quot;&gt;&lt;del&gt;OAK-828&lt;/del&gt;&lt;/a&gt;: composite aggregates.&lt;/p&gt;

&lt;p&gt;This covers 2 parts:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;when searching for 2 tokens that can be present on 2 different nodes, the common aggregated parent doesn&apos;t show up&lt;/li&gt;
	&lt;li&gt;when adding together multiple contains clauses on different hierarchy levels: now the lucene index simply returns an infinite cost.&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="12705898">OAK-1654</key>
            <summary>Composite index aggregates</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="stillalex">Alex Deparvu</assignee>
                                    <reporter username="stillalex">Alex Deparvu</reporter>
                        <labels>
                    </labels>
                <created>Tue, 1 Apr 2014 09:46:09 +0000</created>
                <updated>Mon, 20 Apr 2015 07:30:31 +0000</updated>
                            <resolved>Wed, 2 Apr 2014 13:53:51 +0000</resolved>
                                                    <fixVersion>0.20</fixVersion>
                                    <component>lucene</component>
                    <component>query</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13956327" author="alex.parvulescu" created="Tue, 1 Apr 2014 10:02:56 +0000"  >&lt;p&gt;attaching proposed patch.&lt;/p&gt;

&lt;p&gt;There are a few issues this patch introduces. First, it will break any query containing more than a single token into multiple queries and depending on the type of the constraints (&apos;and&apos;, &apos;or&apos;) it will merge the resulting sets. For the &apos;or&apos; it was easy enough, you only need to chain the iterators, but the &apos;and&apos; turned out a bit more difficult, you need to consume the entire result sets and join them afterwards.&lt;br/&gt;
And of course running more queries means the overall query is slower.&lt;/p&gt;

&lt;p&gt;Also this approach turned out to be a bit hairy when dealing with negative tokens, so I decided to not include a fix for that case yet (see #hasNegativeContains method).&lt;/p&gt;

&lt;p&gt;The last weak part is the cost. The approach was to sum the cost generated by the parts of the query. I think this is a good approach but it can fail when there are both the lucene and the aggregation index deployed on the same instance. &lt;br/&gt;
Ex. for a double token query: &apos;one&apos; and &apos;two&apos;, lucene will return 10 and the aggregator will return the double, so the lucene index will be picked up and the aggregation won&apos;t work. This can be fixed by making sure the 2 are not present at the same time, which means potentially removing the osgi annotations from the lucene index.&lt;/p&gt;

</comment>
                            <comment id="13956359" author="tmueller" created="Tue, 1 Apr 2014 10:32:46 +0000"  >&lt;p&gt;&amp;gt; cursorToSet&lt;/p&gt;

&lt;p&gt;The patch eagerly fetches the whole result using &quot;cursorToSet&quot; and puts it in a set to do &quot;Sets.intersection&quot;. There are two problems: &lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;cursorToSet only reads the path. This will break the new jcr:score() feature (see LuceneIndex.LucenePathCursor).&lt;/li&gt;
	&lt;li&gt;iterating should be done lazily while reading, in the same way as it&apos;s done elsewhere, to avoid out of memory and to speed up cases where the user only reads a part of the result.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;If you want, I can have a look at that and propose a new patch.&lt;/p&gt;

&lt;p&gt;&amp;gt; so the lucene index will be picked up and the aggregation won&apos;t work ...&lt;br/&gt;
&amp;gt; This can be fixed by making sure the 2 are not present at the same time&lt;/p&gt;

&lt;p&gt;I think that&apos;s a good idea.&lt;/p&gt;

&lt;p&gt;I think the following code should be changed:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;if (constraint == null) {
    return 10000;
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;to &lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;if (constraint == null) {
    throw new IllegalArgumentException();
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13956367" author="alex.parvulescu" created="Tue, 1 Apr 2014 10:39:54 +0000"  >&lt;blockquote&gt;&lt;p&gt;The patch eagerly fetches the whole result using &quot;cursorToSet&quot; and puts it in a set to do &quot;Sets.intersection&quot;. &lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Only in the case where you have to join the results because of &apos;and&apos; constraints. How do you join if you don&apos;t know the values of the sets? There is even no guarantee that the iteration has a order by path (it could be ordered by score).&lt;/p&gt;
</comment>
                            <comment id="13956405" author="tmueller" created="Tue, 1 Apr 2014 11:21:30 +0000"  >&lt;p&gt;&amp;gt; Only in the case where you have to join the results because of &apos;and&apos; constraints. How do you join if you don&apos;t know the values of the sets?&lt;/p&gt;

&lt;p&gt;I can create a patch. Yes, it&apos;s a bit harder to do things lazily than for the other cases we have so far (such as Cursors.newPathCursorDistinct). Still, it&apos;s possible to do it more lazily and possibly conserve memory (read until there is a match, instead of fully read both in every case; only keep entries in memory of one side). The bigger problem is that reading the paths only breaks jcr:score().&lt;/p&gt;</comment>
                            <comment id="13956460" author="alex.parvulescu" created="Tue, 1 Apr 2014 12:33:35 +0000"  >&lt;blockquote&gt;&lt;p&gt;Still, it&apos;s possible to do it more lazily and possibly conserve memory (read until there is a match, instead of fully read both in every case; only keep entries in memory of one side).&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;There can be &lt;em&gt;n&lt;/em&gt; cursors not just 2, and just reading one and traversing all of the others from the beginning to a potential match seems like a lot of inefficient work. You cannot guarantee that you use the smallest of the sets as a reference or that the sets are ordered by path, so the worst case scenario is really bad.&lt;br/&gt;
But I agree that this part needs some more work.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;The bigger problem is that reading the paths only breaks jcr:score().&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;right, I&apos;ll update the patch to include the score.&lt;/p&gt;</comment>
                            <comment id="13956484" author="tmueller" created="Tue, 1 Apr 2014 13:18:54 +0000"  >&lt;p&gt;Revision 1583658: helper class IntersectionCursor (so far only two &quot;clients&quot;)&lt;/p&gt;</comment>
                            <comment id="13956972" author="alex.parvulescu" created="Tue, 1 Apr 2014 20:13:30 +0000"  >&lt;p&gt;thanks Thomas, there were some issues with the impl so I had to tweak it a bit. Also following the example I added a new Cursor that concatenates more Cursors.&lt;br/&gt;
I managed to work around the cost issue as well now, so everything should be fine.&lt;/p&gt;

&lt;p&gt;I pushed the code in with rev &lt;a href=&quot;http://svn.apache.org/r1583771&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1583771&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;If there&apos;s anything I left out, please let me know.&lt;/p&gt;</comment>
                            <comment id="13962834" author="alex.parvulescu" created="Tue, 8 Apr 2014 12:47:17 +0000"  >&lt;p&gt;bulk close for the 0.20.0 release&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12648025">OAK-828</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12638040" name="OAK-1654.patch" size="12443" author="stillalex" created="Tue, 1 Apr 2014 10:02:56 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>384222</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 32 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1u6z3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>384490</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>