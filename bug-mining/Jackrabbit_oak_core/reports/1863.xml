<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:54:28 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-9457] Lucene index is always used over ES index when the cost is minimal</title>
                <link>https://issues.apache.org/jira/browse/OAK-9457</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;In case of suggestions and spellcheck i.e. native queries. The cost evaluation for using index comes out to be 2.0 which is smaller than even minimum cost of the indexes.&lt;/p&gt;

&lt;p&gt;This leads to non-evaluation of further index types. In this case elastic.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Minimum cost for indexes are as follows:&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Index Type&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;min cost&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;reference index&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1.0&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;property index&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;2.0&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;nodetype&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;2.05&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;luceneproperty index&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;2.1&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;elastic index:&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;2.2&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Lucene Aggregate Index&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;2.2&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Solr Aggegate Index&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;2.3&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Formulation for cost evaluation is :&lt;/p&gt;

&lt;p&gt;double c = p.getCostPerExecution() + entryCount * p.getCostPerEntry();&#160;&lt;/p&gt;

&lt;p&gt;Which for native queries is equivalent to 1.0 + 1.0 * 1.0 i.e 2.0.&lt;/p&gt;

&lt;p&gt;So make sure that index evaluation is not stopped at lucene indexes we are going to change&#160;EstimatedEntryCount to 2 from 1 which will return cost for suggestions and spellcheck as 3.0&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13383327">OAK-9457</key>
            <summary>Lucene index is always used over ES index when the cost is minimal</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mkataria">Mohit Kataria</assignee>
                                    <reporter username="mkataria">Mohit Kataria</reporter>
                        <labels>
                    </labels>
                <created>Fri, 11 Jun 2021 06:46:02 +0000</created>
                <updated>Wed, 12 Jan 2022 13:44:05 +0000</updated>
                            <resolved>Thu, 15 Jul 2021 05:35:07 +0000</resolved>
                                    <version>1.40.0</version>
                                    <fixVersion>1.42.0</fixVersion>
                                    <component>indexing</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="17361466" author="mkataria" created="Fri, 11 Jun 2021 07:03:19 +0000"  >&lt;p&gt;There is minimum cost assigned to different type of indexes:&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Index Type&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;min cost&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;reference index&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1.0&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;property index&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;2.0&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;nodetype&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;2.05&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;luceneproperty index&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;2.1&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;elastic index:&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;2.2&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Lucene Aggregate Index&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;2.2&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Solr Aggegate Index&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;2.3&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;In case the &quot;best cost&quot; from previous evaluation of any of the indexes is less than this min cost we stop further evaluation&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;.&lt;/p&gt;

&lt;p&gt;Suggestions is a special case (native query is used) and for this we use defaultPlan&#160;&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;.&lt;/p&gt;

&lt;p&gt;But here also for native queries we override estimatedEntryCount() with value 1&#160;&lt;span class=&quot;error&quot;&gt;&amp;#91;3&amp;#93;&lt;/span&gt;.&lt;/p&gt;

&lt;p&gt;(For suggestions we don&apos;t use number of documents in index to estimate cost.)&lt;/p&gt;

&lt;p&gt;Now once we have plan, cost is evaluated as&#160;&lt;span class=&quot;error&quot;&gt;&amp;#91;4&amp;#93;&lt;/span&gt;&#160;which is&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt; c = p.getCostPerExecution() + entryCount * p.getCostPerEntry(); &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;which is equivalent to 1.0 + 1.0 * 1.0 i.e 2.0 for lucene&apos;s&#160; cost for suggestions.&lt;/p&gt;

&lt;p&gt;Now as min cost of elastic index is 2.2 which is greater than 2.0 of lucene suggestions, no further evaluation happens even though for elastic final cost is 1.9 even if we decreased costPerExecution or costPerEntry for elatic index.&lt;br/&gt;
Here if we increase costPerExecution for damAssetLucene so that it is just above 2.2, will solve this for us.&lt;/p&gt;

&lt;p&gt;&#160;&#160;&lt;br/&gt;
Note: the same scenario will also be valid for spellcheck as spellcheck also uses native query&#160;&lt;span class=&quot;error&quot;&gt;&amp;#91;5&amp;#93;&lt;/span&gt;.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;:&#160;&lt;a href=&quot;https://github.com/oak-indexing/jackrabbit-oak/blob/53eaf3c849ef62adb719602d9876af35b1588ed5/oak-core/src/main/java/org/apache/jackrabbit/oak/query/QueryImpl.java#L1043&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/oak-indexing/jackrabbit-oak/blob/53eaf3c849ef62adb719602d9876af35b1588ed5/oak-core/src/main/java/org/apache/jackrabbit/oak/query/QueryImpl.java#L1043&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;:&#160;&lt;a href=&quot;https://github.com/oak-indexing/jackrabbit-oak/blob/53eaf3c849ef62adb719602d9876af35b1588ed5/oak-search/src/main/java/org/apache/jackrabbit/oak/plugins/index/search/spi/query/FulltextIndexPlanner.java#L743&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/oak-indexing/jackrabbit-oak/blob/53eaf3c849ef62adb719602d9876af35b1588ed5/oak-search/src/main/java/org/apache/jackrabbit/oak/plugins/index/search/spi/query/FulltextIndexPlanner.java#L743&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;3&amp;#93;&lt;/span&gt;:&#160;&lt;a href=&quot;https://github.com/oak-indexing/jackrabbit-oak/blob/53eaf3c849ef62adb719602d9876af35b1588ed5/oak-search/src/main/java/org/apache/jackrabbit/oak/plugins/index/search/spi/query/FulltextIndexPlanner.java#L444&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/oak-indexing/jackrabbit-oak/blob/53eaf3c849ef62adb719602d9876af35b1588ed5/oak-search/src/main/java/org/apache/jackrabbit/oak/plugins/index/search/spi/query/FulltextIndexPlanner.java#L444&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;4&amp;#93;&lt;/span&gt;:&#160;&lt;a href=&quot;https://github.com/oak-indexing/jackrabbit-oak/blob/53eaf3c849ef62adb719602d9876af35b1588ed5/oak-core/src/main/java/org/apache/jackrabbit/oak/query/QueryImpl.java#L1077&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/oak-indexing/jackrabbit-oak/blob/53eaf3c849ef62adb719602d9876af35b1588ed5/oak-core/src/main/java/org/apache/jackrabbit/oak/query/QueryImpl.java#L1077&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;5&amp;#93;&lt;/span&gt;:&#160;&lt;a href=&quot;https://github.com/oak-indexing/jackrabbit-oak/blob/53eaf3c849ef62adb719602d9876af35b1588ed5/oak-search/src/main/java/org/apache/jackrabbit/oak/plugins/index/search/spi/query/FulltextIndexPlanner.java#L426&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/oak-indexing/jackrabbit-oak/blob/53eaf3c849ef62adb719602d9876af35b1588ed5/oak-search/src/main/java/org/apache/jackrabbit/oak/plugins/index/search/spi/query/FulltextIndexPlanner.java#L426&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17366505" author="mkataria" created="Mon, 21 Jun 2021 10:19:20 +0000"  >&lt;p&gt;Current implementation is that, we skip further cost evaluation of indexes if the bestCost &amp;lt; minCost of index under consideration and we explicitly set cost of the index less than minCost of that index to achieve skipping of cost estimation.&lt;/p&gt;

&lt;p&gt;So even if two indexes have same minimum cost we will skip further evaluation (even though both are at par). This is the point of contention as next index can have less costPerExecution and hence lesser cost.&lt;/p&gt;

&lt;p&gt;Updated the condition so that we skip cost evaluation of indexes if&#160; &#160;&quot;mincost of bestIndex&quot; is &amp;lt; &quot;mincost of index for which cost is being evaluated&quot;.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13375488">OAK-9419</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 20 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0rv7k:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>