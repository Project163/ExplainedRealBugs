<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:45:36 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-1977] ContentMirrorStoreStrategy should utilize path restriction when available</title>
                <link>https://issues.apache.org/jira/browse/OAK-1977</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;Currently &lt;tt&gt;ContentStoreMirrorStrategy&lt;/tt&gt; has a mirror of content path under &lt;tt&gt;:index&lt;/tt&gt;. Yet, while &lt;tt&gt;query&lt;/tt&gt; (and &lt;tt&gt;count&lt;/tt&gt;) methods doesn&apos;t jump directly into restricted path.&lt;/p&gt;

&lt;p&gt;This would be very useful for &lt;tt&gt;PropertyIndex&lt;/tt&gt; where the queries can be optimized by supplying a path restriction along with an indexed property restriction (I don&apos;t know if queries with references would use paths so much though)&lt;/p&gt;</description>
                <environment></environment>
        <key id="12728427">OAK-1977</key>
            <summary>ContentMirrorStoreStrategy should utilize path restriction when available</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="thomasm">Thomas Mueller</assignee>
                                    <reporter username="catholicon">Vikas Saurabh</reporter>
                        <labels>
                    </labels>
                <created>Sun, 20 Jul 2014 07:34:00 +0000</created>
                <updated>Tue, 16 Feb 2021 09:53:02 +0000</updated>
                            <resolved>Wed, 10 Sep 2014 10:19:09 +0000</resolved>
                                    <version>1.0.1</version>
                                    <fixVersion>1.1.0</fixVersion>
                                    <component>query</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="14068037" author="catholicon" created="Sun, 20 Jul 2014 20:32:50 +0000"  >&lt;p&gt;&lt;del&gt;Proposed patch at &lt;a href=&quot;https://github.com/apache/jackrabbit-oak/pull/23&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/jackrabbit-oak/pull/23&lt;/a&gt; .&lt;/del&gt;&lt;br/&gt;
I&apos;ve closed this pull request (which was based on 1.0 branch and had issues). I&apos;ve attached a patch relative to trunk instead.&lt;/p&gt;</comment>
                            <comment id="14068070" author="catholicon" created="Sun, 20 Jul 2014 23:03:27 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chetanm&quot; class=&quot;user-hover&quot; rel=&quot;chetanm&quot;&gt;chetanm&lt;/a&gt;, can you please take a look?&lt;/p&gt;</comment>
                            <comment id="14069033" author="catholicon" created="Mon, 21 Jul 2014 18:51:38 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thomasm&quot; class=&quot;user-hover&quot; rel=&quot;thomasm&quot;&gt;thomasm&lt;/a&gt;, can you please review the pull request? It&apos;s currently based on 1.0 branch. I&apos;d rebase it against trunk and upload patch file to the issue by tomorrow.&lt;/p&gt;</comment>
                            <comment id="14071569" author="catholicon" created="Wed, 23 Jul 2014 09:56:47 +0000"  >&lt;p&gt;CI successful at &lt;a href=&quot;https://travis-ci.org/catholicon/jackrabbit-oak/builds/30631857&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://travis-ci.org/catholicon/jackrabbit-oak/builds/30631857&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14077475" author="catholicon" created="Tue, 29 Jul 2014 07:30:46 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thomasm&quot; class=&quot;user-hover&quot; rel=&quot;thomasm&quot;&gt;thomasm&lt;/a&gt;, can you please review the patch and mark the fixVersion(s) for issue as well? Can we please get this in 1.0 branch as well?&lt;/p&gt;</comment>
                            <comment id="14077700" author="catholicon" created="Tue, 29 Jul 2014 13:23:00 +0000"  >&lt;p&gt;Added a benchmark test for property index with path restriction (it&apos;s too specific currently... we can generalize it later similar to ordered index tests).&lt;/p&gt;

&lt;p&gt;Also, adding updated patch which updates &lt;tt&gt;PropertyIndexPlan&lt;/tt&gt; to utilize &lt;tt&gt;ContentMirrorStoreStrategy&lt;/tt&gt; in path aware fashion.&lt;/p&gt;</comment>
                            <comment id="14077702" author="catholicon" created="Tue, 29 Jul 2014 13:25:47 +0000"  >&lt;p&gt;Benchmark result with path awareness:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;# PropertyIndexQueryTest           C     min     10%     50%     90%     max       N
Oak-MongoNS                        1       0       0       1       6     478   27635
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Benchmark result without path awareness:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;# PropertyIndexQueryTest           C     min     10%     50%     90%     max       N
Oak-MongoNS                        1      20      22      26      40     508    2043
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14096782" author="tmueller" created="Thu, 14 Aug 2014 09:27:10 +0000"  >&lt;p&gt;I&apos;m currently reviewing the patch. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=catholicon&quot; class=&quot;user-hover&quot; rel=&quot;catholicon&quot;&gt;catholicon&lt;/a&gt;, what is the use case for &lt;em&gt;non&lt;/em&gt; filter-aware lookup, that is, why do we still need a ContentMirrorStoreStrategy with isFilterAware set to false? Wouldn&apos;t it be better to just &lt;em&gt;always&lt;/em&gt; use the filter if available?&lt;/p&gt;</comment>
                            <comment id="14096787" author="catholicon" created="Thu, 14 Aug 2014 09:29:32 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thomasm&quot; class=&quot;user-hover&quot; rel=&quot;thomasm&quot;&gt;thomasm&lt;/a&gt;, I don&apos;t know much of Oak&apos;s code, so I was just trying to be cautious.&lt;/p&gt;</comment>
                            <comment id="14103833" author="tmueller" created="Wed, 20 Aug 2014 12:50:50 +0000"  >&lt;p&gt;I&apos;m trying to apply the patch, but I ran into some problems. Just applying the patch would make the tests pass, but I think this is because we don&apos;t have enough tests... So I try to make the patch more generic (not use the &quot;isFilterAware&quot; / &quot;shouldDescendDirectly&quot; flags), which should work as well in &lt;em&gt;theory&lt;/em&gt;. But it doesn&apos;t work in practise. There is some unexpected behavior in PathIterator in case the shouldDescendDirectly is set, which would make some &quot;ordered index&quot; tests fail. In theory the test shouldn&apos;t fail. So I&apos;m still investigating. I&apos;m sorry for the delay!&lt;/p&gt;</comment>
                            <comment id="14105695" author="catholicon" created="Thu, 21 Aug 2014 18:08:55 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thomasm&quot; class=&quot;user-hover&quot; rel=&quot;thomasm&quot;&gt;thomasm&lt;/a&gt;, &lt;tt&gt;OrderedPropertyIndexQueryTest&lt;/tt&gt; is failing because with &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-1980&quot; title=&quot;Use index on non-root node&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-1980&quot;&gt;&lt;del&gt;OAK-1980&lt;/del&gt;&lt;/a&gt;, ordered indices support sub-root locations too. For that, it creates a &lt;tt&gt;PrefixCursor&lt;/tt&gt; instance which prepends filter&apos;s path to results returned by index. The attached patch also does the same concatenation and hence with &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-1980&quot; title=&quot;Use index on non-root node&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-1980&quot;&gt;&lt;del&gt;OAK-1980&lt;/del&gt;&lt;/a&gt;+attached patch, the result nodes&apos; paths get filter&apos;s path prefixed twice which is then discarded.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-1980&quot; title=&quot;Use index on non-root node&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-1980&quot;&gt;&lt;del&gt;OAK-1980&lt;/del&gt;&lt;/a&gt; is marked for Oak1.1 as, I believe, it&apos;s more of a feature to allow indices to be defined under a sub-tree. OTOH, I believe, this issue is a simple performance improvement which can be taken in 1.0 branch as well.&lt;/p&gt;

&lt;p&gt;About fixing the issue, I see following options:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;have &lt;tt&gt;PathIterator&lt;/tt&gt; to get currently used index&apos;s meta node&apos;s path so that it can concatenate only relevant portion &amp;#8211; I&apos;m not sure how exactly though :-/ (any pointers?)&lt;/li&gt;
	&lt;li&gt;convert PropertyIndex to AdvancedQueryIndex and have same mechanism for prefixing filter path as is being used in &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-1980&quot; title=&quot;Use index on non-root node&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-1980&quot;&gt;&lt;del&gt;OAK-1980&lt;/del&gt;&lt;/a&gt; (I think AdvancedQueryIndex is a 1.1 thing and so this would be incompatible with 1.0 branch &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;)&lt;/li&gt;
	&lt;li&gt;take the less general fix and open another issue to generalize it without &lt;tt&gt;isFilterAware&lt;/tt&gt;/&lt;tt&gt;shouldDescendDirectly&lt;/tt&gt; (where I hope the less general fix can be applied on 1.0 directly and the general one can be put on 1.1 only)&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;WDYT?&lt;/p&gt;

&lt;p&gt;(cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=edivad&quot; class=&quot;user-hover&quot; rel=&quot;edivad&quot;&gt;edivad&lt;/a&gt;)&lt;/p&gt;</comment>
                            <comment id="14128306" author="tmueller" created="Wed, 10 Sep 2014 10:17:44 +0000"  >&lt;p&gt;Revision 1623964 (trunk)&lt;/p&gt;

&lt;p&gt;This is a slightly different solution, which moves the filter logic to the PathIterator. The prefix logic is also moved there (it has to be, otherwise filtering is much more complicated). Filtering is different: instead of traversing to the required node, paths that don&apos;t match are skipped. This is slightly less efficient, but I think should work reasonably well.&lt;/p&gt;</comment>
                            <comment id="14128307" author="tmueller" created="Wed, 10 Sep 2014 10:19:09 +0000"  >&lt;p&gt;I consider it fixed. If performance is still not good enough, or if there is another problem, please reopen.&lt;/p&gt;</comment>
                            <comment id="14128511" author="catholicon" created="Wed, 10 Sep 2014 14:14:45 +0000"  >&lt;p&gt;&lt;tt&gt;N&lt;/tt&gt; using attached benchmark test reported &lt;tt&gt;27854&lt;/tt&gt; v/s &lt;tt&gt;2729&lt;/tt&gt; (tested with fix commit reverted and error level changed to &lt;tt&gt;error&lt;/tt&gt; to avoid traversal warning and have fairer comparison). So, I think perf improvement is significant enough for the issue to be considered resolved.&lt;/p&gt;

&lt;p&gt;Should we also not include the benchmark test too?&lt;/p&gt;

&lt;p&gt;Also, I noticed that there is an issue while estimating cost: cost estimation first reads an estimated count on top of index tree. If found, it returns that as estimate. But, with a path restriction, that count would be wrong &amp;#8211; should we have partial traversal based cost estimation when query has path restriction?&lt;/p&gt;</comment>
                            <comment id="14159877" author="amitjain" created="Mon, 6 Oct 2014 04:09:06 +0000"  >&lt;p&gt;Bulk close for 1.1.0&lt;/p&gt;</comment>
                            <comment id="14214562" author="karadhak" created="Mon, 17 Nov 2014 11:47:19 +0000"  >&lt;p&gt;Can this be included in the 1.0 branch? This is causing major performance issues for customer.&lt;/p&gt;</comment>
                            <comment id="14217611" author="tmueller" created="Wed, 19 Nov 2014 08:44:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=karadhak&quot; class=&quot;user-hover&quot; rel=&quot;karadhak&quot;&gt;karadhak&lt;/a&gt; would it be possible for you to test whether the solution in trunk solves the problem? Backporting the changes should be possible, but it is a bit tricky in this case. So before doing that, it would be nice to know whether it is really worth the effort.&lt;/p&gt;</comment>
                            <comment id="14620113" author="chetanm" created="Thu, 9 Jul 2015 08:26:00 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thomasm&quot; class=&quot;user-hover&quot; rel=&quot;thomasm&quot;&gt;thomasm&lt;/a&gt; It would be good if we port this to 1.0 branch. For now I have added label &lt;tt&gt;candidate_oak_1_0&lt;/tt&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13104847">OAK-6714</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310040">
                    <name>Required</name>
                                                                <inwardlinks description="is required by">
                                        <issuelink>
            <issuekey id="12748531">OAK-2202</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12658405" name="1977-benchmark.patch" size="8450" author="catholicon" created="Tue, 29 Jul 2014 13:23:00 +0000"/>
                            <attachment id="12658406" name="1977-proposed.patch" size="16085" author="catholicon" created="Tue, 29 Jul 2014 13:23:00 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>406503</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 19 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1xyav:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>406523</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>