<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:52:57 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-5355] Too eager refreshing of tree permissions in SecureNodeBuilder</title>
                <link>https://issues.apache.org/jira/browse/OAK-5355</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;&lt;tt&gt;SecureNodeBuilder.baseChanged()&lt;/tt&gt; calls &lt;tt&gt;SecureNodeBuilder.getTreePermission()&lt;/tt&gt; even though the tree permission would be calculated lazily as needed anyway. Re-calculating the tree permissions at this point bears the risk of accessing stale data from the underlying not yet fully refreshed root (when being called e.g. from &lt;tt&gt;MutableRoot.refresh()&lt;/tt&gt;. &lt;/p&gt;

&lt;p&gt;I would thus argue for removing the call to &lt;tt&gt;SecureNodeBuilder.getTreePermission()&lt;/tt&gt; from &lt;tt&gt;SecureNodeBuilder.baseChanged()&lt;/tt&gt;. &lt;/p&gt;

&lt;p&gt;See also &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-5296&quot; title=&quot;MutableRoot.refresh does not correctly refresh tree permissions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-5296&quot;&gt;&lt;del&gt;OAK-5296&lt;/del&gt;&lt;/a&gt; for an in-depth analysis. &lt;/p&gt;</description>
                <environment></environment>
        <key id="13029502">OAK-5355</key>
            <summary>Too eager refreshing of tree permissions in SecureNodeBuilder</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="angela">Angela Schreiber</assignee>
                                    <reporter username="mduerig">Michael D&#252;rig</reporter>
                        <labels>
                            <label>technical_debt</label>
                    </labels>
                <created>Tue, 20 Dec 2016 16:34:42 +0000</created>
                <updated>Tue, 30 May 2017 08:38:23 +0000</updated>
                            <resolved>Fri, 19 May 2017 08:31:30 +0000</resolved>
                                                    <fixVersion>1.7.0</fixVersion>
                    <fixVersion>1.8.0</fixVersion>
                                    <component>core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="15764606" author="mduerig" created="Tue, 20 Dec 2016 16:36:54 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=anchela&quot; class=&quot;user-hover&quot; rel=&quot;anchela&quot;&gt;anchela&lt;/a&gt;, this is the follow up to &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-5296&quot; title=&quot;MutableRoot.refresh does not correctly refresh tree permissions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-5296&quot;&gt;&lt;del&gt;OAK-5296&lt;/del&gt;&lt;/a&gt;, which turned out to be not a problem. Still I think we should improve this so I filed this issue here. &lt;/p&gt;</comment>
                            <comment id="15766745" author="anchela" created="Wed, 21 Dec 2016 10:53:35 +0000"  >&lt;p&gt;agreed... let me take another look and try to find a decent test-coverage to minimize the regression risk.&lt;/p&gt;</comment>
                            <comment id="16004744" author="anchela" created="Wed, 10 May 2017 14:16:44 +0000"  >&lt;p&gt;proposed fix with some test for &lt;tt&gt;SecurityNodeBuilder&lt;/tt&gt; and specifically for the &lt;tt&gt;SecurityNodeBuilder.baseChanged&lt;/tt&gt; specifically. For the latter I added a dummy &lt;tt&gt;PermissionProvider&lt;/tt&gt; implementation that does &lt;em&gt;not&lt;/em&gt; read from the repository itself... with that I actually get the impression that we have a bug here (not just an improvement) because the permission provider is refreshed only &lt;em&gt;after&lt;/em&gt; the &lt;tt&gt;SecureNodeBuilder.baseChanged&lt;/tt&gt; is called.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mduerig&quot; class=&quot;user-hover&quot; rel=&quot;mduerig&quot;&gt;mduerig&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=alex.parvulescu&quot; class=&quot;user-hover&quot; rel=&quot;alex.parvulescu&quot;&gt;alex.parvulescu&lt;/a&gt;, I would be glad if you could take a look to see if there some mistake in the logic or assumptions of my tests illustrating the problem. &lt;/p&gt;</comment>
                            <comment id="16010132" author="mduerig" created="Mon, 15 May 2017 08:05:31 +0000"  >&lt;p&gt;There is a problem with the setup of &lt;tt&gt;SecureNodeBuilderTest&lt;/tt&gt; that causes a &lt;tt&gt;null&lt;/tt&gt; value to be passed to the as the &lt;tt&gt;workspace&lt;/tt&gt; argument to &lt;tt&gt;AuthorizationConfiguration.getPermissionProvider()&lt;/tt&gt; from the initialisation of &lt;tt&gt;MutableRoot.permissionProvider&lt;/tt&gt;. The following patch fixes this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;--- oak-core/src/test/java/org/apache/jackrabbit/oak/core/MutableRootTest.java	(date 1494834751000)
+++ oak-core/src/test/java/org/apache/jackrabbit/oak/core/MutableRootTest.java	(revision )
@@ -74,6 +74,7 @@
         ContentSessionImpl cs = Mockito.mock(ContentSessionImpl.class);
         when(cs.toString()).thenReturn(&lt;span class=&quot;code-quote&quot;&gt;&quot;contentSession&quot;&lt;/span&gt;);
         when(cs.getAuthInfo()).thenReturn(AuthInfoImpl.EMPTY);
+        when(cs.getWorkspaceName()).thenReturn(&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;&quot;&lt;/span&gt;);
         root = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; MutableRoot(store, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; EmptyHook(), &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;&quot;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Subject(), sp, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, cs);
     }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16010138" author="mduerig" created="Mon, 15 May 2017 08:12:30 +0000"  >&lt;p&gt;Apart from above issue the patch looks good to me. &lt;tt&gt;MutableRootTest.testCommit()&lt;/tt&gt; shows that this is indeed a bug and needs to be fixed. This is the type of bug I suspected already in &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-5296&quot; title=&quot;MutableRoot.refresh does not correctly refresh tree permissions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-5296&quot;&gt;&lt;del&gt;OAK-5296&lt;/del&gt;&lt;/a&gt; but was not able to come up with a test for. &lt;/p&gt;

&lt;p&gt;I&apos;m not sure whether &lt;tt&gt;SecureNodeBuilderTest.testBaseChanged2&lt;/tt&gt; (and similar) are good tests though. This actually depends on the intended semantics of the permission provider (i.e. at which point exactly the permissions are evaluated and changes in them are seen). This tests seem to imply that such changes should be visible every time they happen. But then caching of the tree permissions is not possible as the following modification to the test demonstrates:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;===================================================================
--- oak-core/src/test/java/org/apache/jackrabbit/oak/core/SecureNodeBuilderTest.java	(date 1494834751000)
+++ oak-core/src/test/java/org/apache/jackrabbit/oak/core/SecureNodeBuilderTest.java	(revision )
@@ -181,6 +181,8 @@
         &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
             permissionProvider.denyAll = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
             assertFalse(secureNodeBuilder.exists());
+            permissionProvider.denyAll = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
+            assertTrue(secureNodeBuilder.exists());
             assertFalse(secureNodeBuilder.hasChildNode(NAME_ACCESSIBLE));
             assertFalse(secureNodeBuilder.hasProperty(&lt;span class=&quot;code-quote&quot;&gt;&quot;prop&quot;&lt;/span&gt;));
             assertFalse(secureNodeBuilder.isNew());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16010290" author="alex.parvulescu" created="Mon, 15 May 2017 10:24:56 +0000"  >&lt;p&gt;I think the patch looks good!&lt;/p&gt;

&lt;p&gt;a few minor suggestions:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;there are some duplicated tests (ie. testGetChildNodeNonExisting == testExistsNonExisting)&lt;/li&gt;
	&lt;li&gt;testGetNodeStateNonExisting should use the defined constant NAME_NON_EXISTING)&lt;/li&gt;
&lt;/ul&gt;


&lt;blockquote&gt;&lt;p&gt;There is a problem with the setup of SecureNodeBuilderTest that causes a null value to be passed to the as the workspace argument&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I agree this should be fixed for consistency, but it doesn&apos;t affect the test in any way as the &lt;tt&gt;workspace&lt;/tt&gt; argument is ignored.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I&apos;m not sure whether SecureNodeBuilderTest.testBaseChanged2 (and similar) are good tests though. This actually depends on the intended semantics of the permission provider (i.e. at which point exactly the permissions are evaluated and changes in them are seen). This tests seem to imply that such changes should be visible every time they happen. But then caching of the tree permissions is not possible as the following modification to the test demonstrates&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I think the tests capture the idea that you&apos;re only able to refresh if you call &lt;tt&gt;baseChanged()&lt;/tt&gt; (if you add this to your example diff, the test will pass). An alternative would be to mock the &lt;tt&gt;SecureNodeBuilder&lt;/tt&gt; and try to enforce calls to rebuild the &lt;tt&gt;treePermission&lt;/tt&gt;, but I don&apos;t think the result would be a lot nicer looking.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;edit&amp;#93;&lt;/span&gt; Seeing as the SecureNodeBuilder has added a new method to reduce the following&lt;br/&gt;
&lt;tt&gt;if (property != null &amp;amp;&amp;amp; property.getType() == STRING)&lt;/tt&gt; to &lt;tt&gt;getType(property) == STRING&lt;/tt&gt; why not move this type check into the new method, like so:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;    @CheckForNull
    private static boolean isType(@CheckForNull PropertyState property, Type&amp;lt;?&amp;gt; type) {
        Type&amp;lt;?&amp;gt; t = (property == null) ? null : property.getType();
        return t == type;
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</comment>
                            <comment id="16010299" author="mduerig" created="Mon, 15 May 2017 10:31:43 +0000"  >&lt;blockquote&gt;&lt;p&gt;I think the tests capture the idea that you&apos;re only able to refresh if you call baseChanged() (if you add this to your example diff, the test will pass). &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I&apos;m fine with this but I would add a comment to that respect then. &lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;An alternative would be to mock the &lt;tt&gt;SecureNodeBuilder&lt;/tt&gt;.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I wouldn&apos;t do that. &lt;/p&gt;
</comment>
                            <comment id="16012066" author="anchela" created="Tue, 16 May 2017 09:35:44 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mduerig&quot; class=&quot;user-hover&quot; rel=&quot;mduerig&quot;&gt;mduerig&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=alex.parvulescu&quot; class=&quot;user-hover&quot; rel=&quot;alex.parvulescu&quot;&gt;alex.parvulescu&lt;/a&gt; updated patch that hopefully incorporates your feedback. as far as tests for &lt;tt&gt;SecureNodeBuilder#baseChanged&lt;/tt&gt; are concerned: i dropped one and just left the test that actually reflect the real usage of this method during commit/rebase/refresh, where the permission provider is only refreshed &lt;em&gt;after&lt;/em&gt; calling &lt;tt&gt;SecureNodeBuilder#baseChanged&lt;/tt&gt;... basically that&apos;s how the too-eager refresh may end up resulting being a bug. tried to clarify the intention of the test with a comment.&lt;/p&gt;

&lt;p&gt;may I kindly ask you to take another look? thanks.&lt;/p&gt;</comment>
                            <comment id="16012226" author="mduerig" created="Tue, 16 May 2017 12:09:55 +0000"  >&lt;p&gt;The new patch LGTM!&lt;/p&gt;</comment>
                            <comment id="16012300" author="alex.parvulescu" created="Tue, 16 May 2017 12:58:17 +0000"  >&lt;p&gt;looks good!&lt;br/&gt;
I don&apos;t think &lt;tt&gt;isType&lt;/tt&gt; still requires a &lt;tt&gt;@CheckForNull&lt;/tt&gt;, that was part of my proposal and I missed this point, so apologies for the confusion there.&lt;/p&gt;</comment>
                            <comment id="16017039" author="anchela" created="Fri, 19 May 2017 08:05:52 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=alex.parvulescu&quot; class=&quot;user-hover&quot; rel=&quot;alex.parvulescu&quot;&gt;alex.parvulescu&lt;/a&gt;, no it doesn&apos;t... i removed it. &lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=alex.parvulescu&quot; class=&quot;user-hover&quot; rel=&quot;alex.parvulescu&quot;&gt;alex.parvulescu&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mduerig&quot; class=&quot;user-hover&quot; rel=&quot;mduerig&quot;&gt;mduerig&lt;/a&gt;, thanks a lot for reviewing. very much appreciated.&lt;/p&gt;</comment>
                            <comment id="16017063" author="anchela" created="Fri, 19 May 2017 08:31:30 +0000"  >&lt;p&gt;Committed revision 1795596.&lt;/p&gt;</comment>
                            <comment id="16028957" author="edivad" created="Tue, 30 May 2017 08:38:23 +0000"  >&lt;p&gt;Bulk close for 1.7.0&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13070729">OAK-6205</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13027794">OAK-5296</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12868262" name="OAK-5355-1.patch" size="33074" author="angela" created="Tue, 16 May 2017 09:35:44 +0000"/>
                            <attachment id="12867353" name="OAK-5355.patch" size="33483" author="angela" created="Wed, 10 May 2017 14:16:44 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 24 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i37u07:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>