<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:54:16 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-8710] AbstractLoginModule#logout() must not remove &apos;foreign&apos; principals/credentials </title>
                <link>https://issues.apache.org/jira/browse/OAK-8710</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;See &lt;a href=&quot;https://github.com/apache/jackrabbit-oak/blob/9569d659f0655d3ba16c1cfe1fbb5f53959f701f/oak-security-spi/src/main/java/org/apache/jackrabbit/oak/spi/security/authentication/AbstractLoginModule.java#L189:&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/jackrabbit-oak/blob/9569d659f0655d3ba16c1cfe1fbb5f53959f701f/oak-security-spi/src/main/java/org/apache/jackrabbit/oak/spi/security/authentication/AbstractLoginModule.java#L189:&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The criterion for logout() to succeed is&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;!subject.getPrincipals().isEmpty() &amp;amp;&amp;amp; !subject.getPublicCredentials(Credentials.class).isEmpty()&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This did not work in a case where the subject was created by a thread handling an authenticated JMX connection (and later passed on to other threads due to AccessControlContext inheritage).&lt;/p&gt;

&lt;p&gt;I&apos;d propose to make logout() succeed unconditionally, but I&apos;m not entirely sure about side effects.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13263801">OAK-8710</key>
            <summary>AbstractLoginModule#logout() must not remove &apos;foreign&apos; principals/credentials </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="angela">Angela Schreiber</assignee>
                                    <reporter username="baedke">Manfred Baedke</reporter>
                        <labels>
                    </labels>
                <created>Tue, 22 Oct 2019 13:12:33 +0000</created>
                <updated>Thu, 16 Jan 2020 12:38:20 +0000</updated>
                            <resolved>Thu, 28 Nov 2019 15:56:14 +0000</resolved>
                                                    <fixVersion>1.22.0</fixVersion>
                                    <component>auth-external</component>
                    <component>core</component>
                    <component>security-spi</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16957989" author="anchela" created="Wed, 23 Oct 2019 15:51:49 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=baedke&quot; class=&quot;user-hover&quot; rel=&quot;baedke&quot;&gt;baedke&lt;/a&gt;, i am not entirely sure that making logout() always succeed is correct. the javadoc of &lt;tt&gt;LoginModule.logout&lt;/tt&gt; states&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Method which logs out a Subject.
An implementation of &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; method might remove/destroy a Subject&apos;s Principals and Credentials.

Returns:
    &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; method succeeded, or &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; LoginModule should be ignored.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;can you provide a test case that illustrates the behavior you are describing?&lt;/p&gt;</comment>
                            <comment id="16958906" author="baedke" created="Thu, 24 Oct 2019 13:51:57 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=angela&quot; class=&quot;user-hover&quot; rel=&quot;angela&quot;&gt;angela&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;I&apos;ll try to come up with a test case. Not sure yet how that will go.&lt;br/&gt;
Please note &lt;a href=&quot;https://docs.oracle.com/javase/8/docs/technotes/guides/security/jaas/JAASLMDevGuide.html#logout&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://docs.oracle.com/javase/8/docs/technotes/guides/security/jaas/JAASLMDevGuide.html#logout&lt;/a&gt;, which states a different logout contract.&lt;br/&gt;
But you&apos;re right, the JavaDoc should matter, so succeeding unconditionally is not an option. Anyway, we don&apos;t implement that contract, too. Currently, the criterion for success is the presence of any principal and the presence of public credentials, which has nothing to do with the question if the Module should be ignored (actually, in the case mentioned in the description, it certainly should not, because it did the login).&lt;br/&gt;
Will we need to keep track of principals?&lt;/p&gt;

&lt;p&gt;Edit: trivial test method to be added to AbstractLoginModuleTest:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    @Test
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testLogoutAlienPrincipal() {
        Subject subject = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Subject(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, ImmutableSet.&amp;lt;Principal&amp;gt;of(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PrincipalImpl(&lt;span class=&quot;code-quote&quot;&gt;&quot;foo&quot;&lt;/span&gt;)), ImmutableSet.of(), ImmutableSet.of());
        AbstractLoginModule loginModule = initLoginModule(subject, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
        assertTrue(loginModule.logout());
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;will fail, which clearly breaks the contract (and this type of subject is what an authenticated JMX connection will give you).&lt;/p&gt;</comment>
                            <comment id="16961950" author="anchela" created="Tue, 29 Oct 2019 12:25:39 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=baedke&quot; class=&quot;user-hover&quot; rel=&quot;baedke&quot;&gt;baedke&lt;/a&gt;, but why would &lt;tt&gt;LoginModule.logout()&lt;/tt&gt; succeed if the &lt;tt&gt;login&lt;/tt&gt; step is missing altogether (as in your test) or didn&apos;t succeed? how is the JAAS configuration in the scenario you are describing? does &lt;tt&gt;LoginModule.login&lt;/tt&gt; succeed? with any of the &lt;tt&gt;Configurations&lt;/tt&gt; we ship with oak, login will fail for an unknown set of principal/credentials. what am I missing?&lt;/p&gt;</comment>
                            <comment id="16963021" author="baedke" created="Wed, 30 Oct 2019 13:39:10 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=angela&quot; class=&quot;user-hover&quot; rel=&quot;angela&quot;&gt;angela&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;There is no login of an unknown principal. I don&apos;t think that the JAAS config matters here much. The unknown principal comes from the fact that a newly created thread gets an AccessControlContext which inherits the AccessControlContext of the creating thread. This may, e.g., be  a thread handling  an authenticated JMX connection, in which case it contains a subject with a principal like &quot;JMXPrincipal: xyz&quot;.&lt;br/&gt;
So this principal will make it&apos;s way into the AccessControlContext of a thread handling a logout call. If you know a way to avoid that, please let me know.&lt;/p&gt;
</comment>
                            <comment id="16963722" author="anchela" created="Thu, 31 Oct 2019 07:16:44 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=baedke&quot; class=&quot;user-hover&quot; rel=&quot;baedke&quot;&gt;baedke&lt;/a&gt;, i am not familiar with the circumstances you describe. what i wanted to indicate was the test case you provided seems odd to me as it doesn&apos;t include the login step. however, i would appreciate if you could provide additional information that would help me understand what kind of login was associated with the scenario you are describing.&lt;/p&gt;</comment>
                            <comment id="16963967" author="baedke" created="Thu, 31 Oct 2019 12:57:09 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=angela&quot; class=&quot;user-hover&quot; rel=&quot;angela&quot;&gt;angela&lt;/a&gt;,&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;the test case you provided seems odd to me as it doesn&apos;t include the login step&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes, because it doesn&apos;t test that. Like e.g. testLogoutSuccessClearsSubject(), it&apos;s just about one single aspect of the logout behavior, namely that logout ignores unknown principals.&lt;br/&gt;
Quote from &lt;a href=&quot;https://docs.oracle.com/javase/8/docs/technotes/guides/security/jaas/JAASLMDevGuide.html#logout:&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://docs.oracle.com/javase/8/docs/technotes/guides/security/jaas/JAASLMDevGuide.html#logout:&lt;/a&gt; &lt;br/&gt;
&quot;This method removes Principals, and removes/destroys credentials associated with the Subject during the commit operation. This method should not touch those Principals or credentials previously existing in the Subject&quot;.&lt;br/&gt;
I&apos;ll send you a link to the describing the scenario where the issue happened.&lt;/p&gt;</comment>
                            <comment id="16964365" author="baedke" created="Thu, 31 Oct 2019 20:05:37 +0000"  >&lt;p&gt;I&apos;d propose to ignore all principals that are not JackrabbitPrincipals and all credentials that are not javax.jcr.Credentials.&lt;/p&gt;</comment>
                            <comment id="16964675" author="anchela" created="Fri, 1 Nov 2019 07:17:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=baedke&quot; class=&quot;user-hover&quot; rel=&quot;baedke&quot;&gt;baedke&lt;/a&gt;, I don&apos;t think this is correct. If you look at the principal interfaces defined just with Oak you will notice that not all of them are &lt;tt&gt;JackrabbitPrincipal&lt;/tt&gt;. IMO this assumption is not accurate. However, given your comment above and the given the fact that &lt;tt&gt;AbstractLoginModule&lt;/tt&gt; actually has methods for &lt;tt&gt;getCredentials&lt;/tt&gt; and &lt;tt&gt;getPrincipals&lt;/tt&gt;, we already have the basic functionality in place to actually know the credentials/principals that have been used for the login/commit. Having said that, I feel that the fix needs a bit of a broader effort, as we probably don&apos;t want to re-calculate either of them... I will think about a solution.&lt;/p&gt;

&lt;p&gt;Also, I still think the test case you provided above is not properly reflecting the scenario you are describing. So, I think there is some additional effort needed on the testing side as well.&lt;/p&gt;</comment>
                            <comment id="16967521" author="baedke" created="Tue, 5 Nov 2019 13:20:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=angela&quot; class=&quot;user-hover&quot; rel=&quot;angela&quot;&gt;angela&lt;/a&gt;,&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;has methods for getCredentials and getPrincipals, we already have the basic functionality in place to actually know the credentials/principals that have been used for the login/commit&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That makes sense.&lt;/p&gt;</comment>
                            <comment id="16967528" author="baedke" created="Tue, 5 Nov 2019 13:27:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=angela&quot; class=&quot;user-hover&quot; rel=&quot;angela&quot;&gt;angela&lt;/a&gt;,&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Also, I still think the test case you provided above is not properly reflecting the scenario you are describing.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Why?&lt;/p&gt;</comment>
                            <comment id="16967605" author="anchela" created="Tue, 5 Nov 2019 15:18:16 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=baedke&quot; class=&quot;user-hover&quot; rel=&quot;baedke&quot;&gt;baedke&lt;/a&gt;,  the complete quote from &lt;a href=&quot;https://docs.oracle.com/javase/8/docs/technotes/guides/security/jaas/JAASLMDevGuide.html#logout&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://docs.oracle.com/javase/8/docs/technotes/guides/security/jaas/JAASLMDevGuide.html#logout&lt;/a&gt; says:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;the logout method is called to log out a Subject.&lt;/p&gt;

&lt;p&gt;This method removes Principals, and removes/destroys credentials associated with the Subject during the commit operation. This method should not touch those Principals or credentials previously existing in the Subject, or those added by other LoginModules.&lt;/p&gt;

&lt;p&gt;If the Subject has been marked read-only (the Subject&apos;s isReadOnly method returns true), then this method should only destroy credentials associated with the Subject during the commit operation (removing the credentials is not possible). If the Subject has been marked as read-only and the credentials associated with the Subject during the commit operation are not destroyable (they do not implement the Destroyable interface), then this method may throw a LoginException.&lt;/p&gt;

&lt;p&gt;The logout method should return true if logout succeeds, or otherwise throw a LoginException.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;my understanding of that is:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if the login failed, commit must not update the subject and thus the logout step must not succeed&lt;/li&gt;
	&lt;li&gt;if the login succeeds and commit updats the subject, logout should remove just those credentials/principals from the subject that have been added upon commit and return true if that succeeds.&lt;/li&gt;
	&lt;li&gt;in case the login/commit steps are missing the logout cannot succeed&lt;/li&gt;
	&lt;li&gt;also we need to have a test that verifies that only those principals/credentials of that particular loginmodule are removed and foreign principals/credentials are left untouched.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16967611" author="anchela" created="Tue, 5 Nov 2019 15:25:35 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=baedke&quot; class=&quot;user-hover&quot; rel=&quot;baedke&quot;&gt;baedke&lt;/a&gt;, i will take a look how to be make use of the 2 methods and fix the logout, without cause major compatibility issues with custom sub-classes that are not under the oak umbrella.&lt;/p&gt;</comment>
                            <comment id="16968404" author="baedke" created="Wed, 6 Nov 2019 14:35:34 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=angela&quot; class=&quot;user-hover&quot; rel=&quot;angela&quot;&gt;angela&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;Re tests: I was trying to stay in line with other tests in the same test class (like testLogoutSuccessClearsSubject()), which test single aspects of the contract only and also do not login. TestLoginModule#login() doesn&apos;t do anything anyway. But yes, in view of that JAAS tech notes, that needs to be reworked.&lt;/p&gt;</comment>
                            <comment id="16968476" author="anchela" created="Wed, 6 Nov 2019 16:09:27 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=baedke&quot; class=&quot;user-hover&quot; rel=&quot;baedke&quot;&gt;baedke&lt;/a&gt;, ok. i guess what is really important for the issue at hand is that only principals/credentials that have been set by the commit of this login module get removed upon logout (or destroyed in case the subject is readonly). will ping you to review the patch (and tests) to make sure we have the same reading of the contract and to make sure the original issue reported with jmx gets actually solved.&lt;/p&gt;</comment>
                            <comment id="16969283" author="baedke" created="Thu, 7 Nov 2019 14:15:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=angela&quot; class=&quot;user-hover&quot; rel=&quot;angela&quot;&gt;angela&lt;/a&gt;,&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;ok. i guess what is really important for the issue at hand is that only principals/credentials that have been set by the commit of this login module get removed upon logout (or destroyed in case the subject is readonly&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Not quite. I&apos;ll attach a debugger screenshot where you can see that the inherited subject is readonly and there is only one principal. Maybe LoginContextProviderImpl#getSubject() is the real problem, because in this case it does not return a pre-authenticated subject created by Oak, but instead the subject from the inherited AccessControlContext.&lt;/p&gt;</comment>
                            <comment id="16969292" author="anchela" created="Thu, 7 Nov 2019 14:21:11 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=baedke&quot; class=&quot;user-hover&quot; rel=&quot;baedke&quot;&gt;baedke&lt;/a&gt;, but that would be quite a different issue, wouldn&apos;t it? let&apos;s make this issue about the logout only and not mix different issues.... after all we already had &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-8404&quot; title=&quot;AbstractLoginModule#logout() may fail for impersonated users whose subject provides admin credentials&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-8404&quot;&gt;&lt;del&gt;OAK-8404&lt;/del&gt;&lt;/a&gt;, which turned out to not properly reflect the customer reported issue.&lt;/p&gt;</comment>
                            <comment id="16969307" author="baedke" created="Thu, 7 Nov 2019 14:35:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=angela&quot; class=&quot;user-hover&quot; rel=&quot;angela&quot;&gt;angela&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;Yes, of course that&apos;s a new issue. I&apos;m sorry about the confusion, but here the root cause was just a little hard to track down.&lt;br/&gt;
I&apos;ll make a few tests and will open a new issue, if successful.&lt;/p&gt;</comment>
                            <comment id="16969340" author="anchela" created="Thu, 7 Nov 2019 15:17:32 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=baedke&quot; class=&quot;user-hover&quot; rel=&quot;baedke&quot;&gt;baedke&lt;/a&gt;, so, i will adjust the subject and components accordingly &lt;/p&gt;</comment>
                            <comment id="16969372" author="anchela" created="Thu, 7 Nov 2019 16:07:46 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=baedke&quot; class=&quot;user-hover&quot; rel=&quot;baedke&quot;&gt;baedke&lt;/a&gt;, fine with me. please ping me in the new issue. i would like this to be reviewed. thanks.&lt;/p&gt;</comment>
                            <comment id="16969384" author="anchela" created="Thu, 7 Nov 2019 16:14:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=baedke&quot; class=&quot;user-hover&quot; rel=&quot;baedke&quot;&gt;baedke&lt;/a&gt;, while working on a patch I also noticed that &lt;tt&gt;GuestLoginModule&lt;/tt&gt; doesn&apos;t adhere to the contract as described above. I will make an attempt to fix that as well.... so the issue seems pretty generic in oak. after all the broken logout in &lt;tt&gt;AbstractLoginModule&lt;/tt&gt; affects all modules present with oak: the default, the token-lm, the external-lm and separately as mentioned the guest-lm&lt;/p&gt;</comment>
                            <comment id="16970069" author="anchela" created="Fri, 8 Nov 2019 11:00:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=baedke&quot; class=&quot;user-hover&quot; rel=&quot;baedke&quot;&gt;baedke&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=reschke&quot; class=&quot;user-hover&quot; rel=&quot;reschke&quot;&gt;reschke&lt;/a&gt;, proposed patch to fix this attached. it is intended to make sure that logout will only remove those principals/credentials from the subject (or destroy the creds if subject was readonly) that have been added upon commit().&lt;/p&gt;</comment>
                            <comment id="16973084" author="anchela" created="Wed, 13 Nov 2019 07:41:06 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=baedke&quot; class=&quot;user-hover&quot; rel=&quot;baedke&quot;&gt;baedke&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=reschke&quot; class=&quot;user-hover&quot; rel=&quot;reschke&quot;&gt;reschke&lt;/a&gt;, unless you have any concerns regarding the patch, I will go ahead and commit it later today.&lt;/p&gt;</comment>
                            <comment id="16973115" author="reschke" created="Wed, 13 Nov 2019 08:19:46 +0000"  >&lt;p&gt;I have no opinion; this is outside my technical field &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16973166" author="anchela" created="Wed, 13 Nov 2019 09:24:01 +0000"  >&lt;p&gt;Committed revision 1869730.&lt;/p&gt;</comment>
                            <comment id="16973231" author="reschke" created="Wed, 13 Nov 2019 10:52:47 +0000"  >&lt;p&gt;Is this something that we need to resolve in maintenance branches? If so, a change not involving an API change might be better. (And yes, sorry for mentioning that only now).&lt;/p&gt;</comment>
                            <comment id="16973240" author="anchela" created="Wed, 13 Nov 2019 10:56:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=reschke&quot; class=&quot;user-hover&quot; rel=&quot;reschke&quot;&gt;reschke&lt;/a&gt;, i don&apos;t need it in a maintenance branch and would just fix it in 1.20.0. also it was manfred that spotted the issues and pointed to the specification... but it seems in the meantime the issue he is investigating is &lt;em&gt;not&lt;/em&gt; caused by the logout.... so, you would have to ask him.&lt;/p&gt;

&lt;p&gt;and btw: i don&apos;t think this can be fixed without API changes (except for removing AbstractLoginModule.logout altogether, which would essentially break subclasses not contained in oak)&lt;/p&gt;</comment>
                            <comment id="16973424" author="anchela" created="Wed, 13 Nov 2019 15:09:38 +0000"  >&lt;p&gt;the fix causes unexpected errors being logged with &lt;tt&gt;ContentSession.close()&lt;/tt&gt;, will revert the changes to get a precise understanding what&apos;s the reason -&amp;gt; revision 1869749.&lt;/p&gt;

&lt;p&gt;for the record: the reason for the errors was the fact that &lt;tt&gt;LoginModuleImpl&lt;/tt&gt; calls &lt;tt&gt;clearState&lt;/tt&gt; even in case the &lt;tt&gt;commit&lt;/tt&gt; succeeded in order to make sure the system-session used to lookup principals is closed, when &lt;tt&gt;clearState&lt;/tt&gt; actually is mandated to reset the state including the credentials later needed for the &lt;tt&gt;logout&lt;/tt&gt; call.&lt;/p&gt;</comment>
                            <comment id="16978577" author="anchela" created="Wed, 20 Nov 2019 16:34:45 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=baedke&quot; class=&quot;user-hover&quot; rel=&quot;baedke&quot;&gt;baedke&lt;/a&gt;, while i am working on a fix for the clear-state issue mentioned above, i would very much appreciate if you could provide a test case with a realistic oak authentication setup as it is present in the repository you took the attached screen shot (including a list of login modules associated with the given setup (you can replace that with a place-holder name in case you don&apos;t want to share adobe internal information and send me the corresponding info in the adobe-internal communication channel). the test should include the login/commit/logout that results in the scenario you took the screen-shot from. in particular i am wondering about the &lt;tt&gt;ImpersonationCredentials&lt;/tt&gt; and the fact that the impersonated user has the name of a system-user used for Adobe AEM social... one reason why I am asking about this is the following: service-user login with adobe AEM is &lt;em&gt;not&lt;/em&gt; done with impersonation and does neither use &lt;tt&gt;SimpleCredentials&lt;/tt&gt;... so i am really not sure how you got there.&lt;/p&gt;

&lt;p&gt;additional reasoning behind this: i want to make sure we actually have a reproducible integration test for the issue you are describing, that we can verify that we actually fix the issue if we commit any modifications and don&apos;t introduce regressions (as we would with the patch attached to &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-8763&quot; title=&quot;LoginContextProviderImpl uses any subject found in the AccessControlContext.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-8763&quot;&gt;&lt;del&gt;OAK-8763&lt;/del&gt;&lt;/a&gt;).&lt;/p&gt;</comment>
                            <comment id="16981510" author="baedke" created="Mon, 25 Nov 2019 12:32:08 +0000"  >&lt;p&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=angela&quot; class=&quot;user-hover&quot; rel=&quot;angela&quot;&gt;angela&lt;/a&gt;,&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;in particular i am wondering about the ImpersonationCredentials and the fact that the impersonated user has the name of a system-user used for Adobe AEM social... one reason why I am asking about this is the following: service-user login with adobe AEM is not done with impersonation and does neither use SimpleCredentials... so i am really not sure how you got there.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Good point. I&apos;ll see if I can forge a standalone test to reproduce that.&lt;/p&gt;</comment>
                            <comment id="16984509" author="anchela" created="Thu, 28 Nov 2019 15:53:40 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=baedke&quot; class=&quot;user-hover&quot; rel=&quot;baedke&quot;&gt;baedke&lt;/a&gt;, i committed an new patch to fix this at revision 1870559. characteristics as follows:&lt;/p&gt;

&lt;h3&gt;&lt;a name=&quot;%7B%7BAbstractLoginModule.logout%28%29%7D%7D&quot;&gt;&lt;/a&gt;&lt;tt&gt;AbstractLoginModule.logout()&lt;/tt&gt;&lt;/h3&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;i didn&apos;t feel comfortable to heavily modify the existing &lt;tt&gt;logout&lt;/tt&gt; function as i know for sure there are subclasses outside the scope of oak&lt;/li&gt;
	&lt;li&gt;what i did change in the logout: collection of credentials to be removed is limited to &lt;tt&gt;Credentials&lt;/tt&gt; and &lt;tt&gt;AuthInfo&lt;/tt&gt; (instead of removing all&lt;/li&gt;
	&lt;li&gt;in case of read-only subject an attempt is made to destroy that very collection of credentials (missing up to now)&lt;/li&gt;
&lt;/ul&gt;


&lt;h3&gt;&lt;a name=&quot;%7B%7BAbstractLoginModule.logout%28Set%2CSet%29%7D%7D&quot;&gt;&lt;/a&gt;&lt;tt&gt;AbstractLoginModule.logout(Set,Set)&lt;/tt&gt;&lt;/h3&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;i added a &apos;utility&apos; method to logout that takes the set of credential objects and principals computed upon login/commit&lt;/li&gt;
	&lt;li&gt;if either set is non-null the logout will succeed. if both are null it will return false&lt;/li&gt;
	&lt;li&gt;again an attempt is made to destroy credentials in case of read-only subject&lt;/li&gt;
&lt;/ul&gt;


&lt;h3&gt;&lt;a name=&quot;%7B%7BLoginModuleImpl%7D%7D%2F%7B%7BTokenLoginModule%7D%7D%2F%7B%7BExternalLoginModule%7D%7Dandothersubclassesof%7B%7BAbstractLoginModule%7D%7D&quot;&gt;&lt;/a&gt;&lt;tt&gt;LoginModuleImpl&lt;/tt&gt; / &lt;tt&gt;TokenLoginModule&lt;/tt&gt; / &lt;tt&gt;ExternalLoginModule&lt;/tt&gt; and other subclasses of &lt;tt&gt;AbstractLoginModule&lt;/tt&gt;&lt;/h3&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;i fixed all subclasses of &lt;tt&gt;AbstractLoginModule&lt;/tt&gt; in oak to use the new logout-utility, i.e. overwriting the default logout method&lt;/li&gt;
&lt;/ul&gt;


&lt;h3&gt;&lt;a name=&quot;GuestLoginModule&quot;&gt;&lt;/a&gt;GuestLoginModule&lt;/h3&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;i fixed &lt;tt&gt;GuestLoginModule.logout&lt;/tt&gt;, which also wasn&apos;t compliant.&lt;/li&gt;
&lt;/ul&gt;


&lt;h3&gt;&lt;a name=&quot;Tests&quot;&gt;&lt;/a&gt;Tests&lt;/h3&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;i expanded the existing tests to also incorporate &lt;tt&gt;logout&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;i incorporated &lt;tt&gt;testLoginLogoutPreexistingSubject&lt;/tt&gt; from the tests you added with &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-8763&quot; title=&quot;LoginContextProviderImpl uses any subject found in the AccessControlContext.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-8763&quot;&gt;&lt;del&gt;OAK-8763&lt;/del&gt;&lt;/a&gt;. this test passes with the fixes to logout&lt;/li&gt;
	&lt;li&gt;i didn&apos;t incorporate the second test, because this one is IMO not valid as it illustrates classic pre-auth login, which should not fail.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;i would kindly ask you to verify, if the issue you experienced with AEM still persists.&lt;/p&gt;</comment>
                            <comment id="16987027" author="reschke" created="Tue, 3 Dec 2019 15:56:12 +0000"  >&lt;p&gt;trunk: &lt;a href=&quot;http://svn.apache.org/r1870758&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;r1870758&lt;/a&gt; &lt;a href=&quot;http://svn.apache.org/r1870559&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;r1870559&lt;/a&gt; (1.20.0) &lt;a href=&quot;http://svn.apache.org/r1869749&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;r1869749&lt;/a&gt; &lt;a href=&quot;http://svn.apache.org/r1869730&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;r1869730&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16987029" author="reschke" created="Tue, 3 Dec 2019 15:57:47 +0000"  >&lt;p&gt;Javadoc fixed in &lt;a href=&quot;http://svn.apache.org/r1870758&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;r1870758&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                                                <inwardlinks description="is blocked by">
                                        <issuelink>
            <issuekey id="13270910">OAK-8803</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13268062">OAK-8763</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13270899">OAK-8800</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13270901">OAK-8801</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13270903">OAK-8802</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13270920">OAK-8804</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310051">
                    <name>Supercedes</name>
                                            <outwardlinks description="supercedes">
                                        <issuelink>
            <issuekey id="13239945">OAK-8404</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12985339" name="OAK-8710.patch" size="59260" author="angela" created="Fri, 8 Nov 2019 10:57:00 +0000"/>
                            <attachment id="12985222" name="logout.png" size="184768" author="baedke" created="Thu, 7 Nov 2019 14:15:22 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 49 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z07u7c:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>