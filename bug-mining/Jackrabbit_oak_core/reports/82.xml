<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:35:19 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-201] NamespaceRegistry is very slow</title>
                <link>https://issues.apache.org/jira/browse/OAK-201</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;The NamespaceRegistryImpl.getURI and getPrefix are called a lot, for example by NamePathMapperImpl.getOakName. &lt;/p&gt;

&lt;p&gt;The method doesn&apos;t do any caching, which is a problem because it has to read it each time from the repository. Even if it would do caching, it wouldn&apos;t help because it the method WorkspaceImpl.getNamespaceRegistry creates a new NamespaceRegistryImpl each time it is called. To allow caching of known mappings, the instance needs to be cached as well.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12599831">OAK-201</key>
            <summary>NamespaceRegistry is very slow</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="thomasm">Thomas Mueller</reporter>
                        <labels>
                    </labels>
                <created>Mon, 23 Jul 2012 10:31:12 +0000</created>
                <updated>Tue, 21 May 2013 11:26:15 +0000</updated>
                            <resolved>Fri, 1 Mar 2013 14:44:04 +0000</resolved>
                                                    <fixVersion>0.7</fixVersion>
                                    <component>core</component>
                    <component>jcr</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="13420546" author="jukkaz" created="Mon, 23 Jul 2012 10:38:18 +0000"  >&lt;p&gt;Before trying to optimize the NamespaceRegistryImpl, I&apos;d prefer to get rid of the &lt;tt&gt;getURI&lt;/tt&gt; and &lt;tt&gt;getPrefix&lt;/tt&gt; calls in the first place. The name mapper could avoid all namespace lookups as long as no session-local namespace remappings are in effect.&lt;/p&gt;</comment>
                            <comment id="13420553" author="reschke" created="Mon, 23 Jul 2012 10:50:42 +0000"  >&lt;blockquote&gt;&lt;p&gt;The name mapper could avoid all namespace lookups as long as no session-local namespace remappings are in effect.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I can look at that optimization, but the calls might also be caused by JCR-level calls that use expanded names.&lt;/p&gt;

&lt;p&gt;Thomas, do you have a few call stacks?&lt;/p&gt;</comment>
                            <comment id="13420578" author="tmueller" created="Mon, 23 Jul 2012 11:40:09 +0000"  >&lt;p&gt;Yes, that makes sense. &lt;/p&gt;

&lt;p&gt;It seems sometimes a one-way conversion is needed currently, for example in NodeImpl.setPrimaryType:&lt;/p&gt;

&lt;p&gt;    String jcrPrimaryType = sessionDelegate.getOakPathOrThrow(Property.JCR_PRIMARY_TYPE);&lt;/p&gt;

&lt;p&gt;Property.JCR_PRIMARY_TYPE is the expanded form (&quot;&lt;/p&gt;
{http://...}
&lt;p&gt;primaryType&quot;).&lt;/p&gt;

&lt;p&gt;I guess we could create constants with the short form (&quot;nt:primaryType&quot;), and then check if there are remappings. Or use a hardcoded list for known remappings (either just the prefixes or the complete names).&lt;/p&gt;</comment>
                            <comment id="13420579" author="jukkaz" created="Mon, 23 Jul 2012 11:41:27 +0000"  >&lt;p&gt;Here&apos;s a quick draft of what I think the name mapper for the &quot;no session-local namespace remappings&quot; case should look like:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; STANDARD_NAMES =
        ImmutableMap.&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt;builder()
        .put(NodeType.NT_BASE, &lt;span class=&quot;code-quote&quot;&gt;&quot;nt:base&quot;&lt;/span&gt;)
        .put(Property.JCR_PRIMARY_TYPE, &lt;span class=&quot;code-quote&quot;&gt;&quot;jcr:primaryType&quot;&lt;/span&gt;)
        ...
        .build();

&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; getOakName(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; jcrName) {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (jcrName.charAt(0) != &lt;span class=&quot;code-quote&quot;&gt;&apos;{&apos;&lt;/span&gt;) {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; jcrName;
    }

    &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; oakName = STANDARD_NAMES.get(jcrName);
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (oakName != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; oakName;
    }
     &lt;span class=&quot;code-comment&quot;&gt;// Fall back to normal parsing and mapping of the name
&lt;/span&gt;}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13420583" author="reschke" created="Mon, 23 Jul 2012 11:49:09 +0000"  >&lt;p&gt;That would work; but wouldn&apos;t it be simpler if we just used constants for the node type names using the known OAK prefixes? (and not use expanded names at all here)&lt;/p&gt;</comment>
                            <comment id="13420585" author="jukkaz" created="Mon, 23 Jul 2012 11:54:55 +0000"  >&lt;blockquote&gt;&lt;p&gt;and not use expanded names at all here&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The name mapper needs to work also with external clients that are using expanded names.&lt;/p&gt;

&lt;p&gt;But yes, in &lt;tt&gt;oak-jcr&lt;/tt&gt; we could well use the prefixed forms of the standard names to avoid even the hash table lookup.&lt;/p&gt;</comment>
                            <comment id="13420597" author="tmueller" created="Mon, 23 Jul 2012 12:19:28 +0000"  >&lt;p&gt;A stack trace:&lt;/p&gt;

&lt;p&gt;SessionImpl.refresh(boolean) line: 156	&lt;br/&gt;
WorkspaceImpl$1.refresh() line: 153	&lt;br/&gt;
WorkspaceImpl$1(NamespaceRegistryImpl).getURI(String) line: 162	&lt;br/&gt;
SessionImpl(AbstractSession).getNamespaceURI(String) line: 132	&lt;br/&gt;
SessionDelegate$SessionNameMapper.getOakPrefix(String) line: 453	&lt;br/&gt;
SessionDelegate$SessionNameMapper(AbstractNameMapper).getOakName(String) line: 61	&lt;br/&gt;
NamePathMapperImpl.getOakName(String) line: 46	&lt;br/&gt;
NodeTypeManagerImpl.getNodeType(String) line: 83	&lt;br/&gt;
NodeImpl.addNode(String, String) line: 217	&lt;/p&gt;

&lt;p&gt;So for each addNode(String, String), currently there is a Session.refresh(true).&lt;/p&gt;</comment>
                            <comment id="13420601" author="reschke" created="Mon, 23 Jul 2012 12:24:46 +0000"  >&lt;p&gt;OK, that&apos;s a case where we get the node type name from the caller, and where we need to support both remapped prefixes and expanded names.&lt;/p&gt;

&lt;p&gt;I&apos;ll get to the missing optimization in the name mapper for this case this afternoon.&lt;/p&gt;</comment>
                            <comment id="13454730" author="mreutegg" created="Thu, 13 Sep 2012 08:27:05 +0000"  >&lt;p&gt;What exactly is the reason the session is refreshed when a prefix is resolved? I found &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-149&quot; title=&quot;Automatic session refresh after namespace registry changes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-149&quot;&gt;&lt;del&gt;OAK-149&lt;/del&gt;&lt;/a&gt;, but it doesn&apos;t contain details about why the refresh is done.&lt;/p&gt;

&lt;p&gt;Some (most?) of the calls can be avoided as mentioned by Jukka in his first comment. The name mapper can take a short cut (do nothing) when there are no session local namespace mapping. This short cut is already in place in AbstractNameMapper.getOakName(String jcrName) but not in getJcrName(String oakName).&lt;/p&gt;

&lt;p&gt;I&apos;ll submit a patch.&lt;/p&gt;</comment>
                            <comment id="13454731" author="mreutegg" created="Thu, 13 Sep 2012 08:29:49 +0000"  >&lt;p&gt;Proposed change.&lt;/p&gt;</comment>
                            <comment id="13454747" author="mduerig" created="Thu, 13 Sep 2012 08:52:25 +0000"  >&lt;p&gt;Patch looks good to me. &lt;/p&gt;</comment>
                            <comment id="13454749" author="mreutegg" created="Thu, 13 Sep 2012 08:59:00 +0000"  >&lt;p&gt;Committed patch in revision: 1384243&lt;/p&gt;</comment>
                            <comment id="13457738" author="mreutegg" created="Tue, 18 Sep 2012 10:58:39 +0000"  >&lt;p&gt;The namespaces map in SessionImpl is not only used for session local namespace prefix re-mappings but also for caching. The code is copied from JCR Commons AbstractSession and probably implements the copy-on read as described in the JCR spec: &lt;a href=&quot;http://www.day.com/specs/jcr/2.0/3_Repository_Model.html#3.5.2%20Session-Local%20Mappings&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.day.com/specs/jcr/2.0/3_Repository_Model.html#3.5.2%20Session-Local%20Mappings&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Using the namespaces map also for the latter is problematic because hasSessionLocalMappings() depends on this map. The method currently also returns true when there are in fact no session local remappings. I think with the recent changes of &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-306&quot; title=&quot;Limit session refresh on namespace registry use&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-306&quot;&gt;&lt;del&gt;OAK-306&lt;/del&gt;&lt;/a&gt;, the namespaces map can now be used exclusively for remapped namespaces. Copy-on read is not necessary any more, because the namespace registry now reads from the same stable tree as the session.&lt;/p&gt;</comment>
                            <comment id="13457760" author="mreutegg" created="Tue, 18 Sep 2012 11:53:29 +0000"  >&lt;p&gt;Patch changing usage of namespaces map in SessionImpl to session local remappings only.&lt;/p&gt;</comment>
                            <comment id="13458481" author="mreutegg" created="Wed, 19 Sep 2012 07:42:31 +0000"  >&lt;p&gt;Committed patch in revision 1387472.&lt;/p&gt;</comment>
                            <comment id="13458486" author="mreutegg" created="Wed, 19 Sep 2012 07:49:07 +0000"  >&lt;p&gt;I think we can resolve this issue as fixed.&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;AbstractNameMapper now checks for session local mappings, reducing the number of get prefix/uri calls.&lt;/li&gt;
	&lt;li&gt;The namespaces map in SessionImpl is now only used for re-mappings.&lt;/li&gt;
	&lt;li&gt;With &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-306&quot; title=&quot;Limit session refresh on namespace registry use&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-306&quot;&gt;&lt;del&gt;OAK-306&lt;/del&gt;&lt;/a&gt; the namespace registry now uses the stable root from the session, reducing the calls to the micro kernel.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Did I miss anything?&lt;/p&gt;</comment>
                            <comment id="13590578" author="mduerig" created="Fri, 1 Mar 2013 14:44:04 +0000"  >&lt;p&gt;Cleaning up old issues. Please reopen if necessary. Consider opening a new issue for follow up work.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12544955" name="OAK-201.patch" size="744" author="mreutegg" created="Thu, 13 Sep 2012 08:29:49 +0000"/>
                            <attachment id="12545553" name="SessionImpl.patch" size="2764" author="mreutegg" created="Tue, 18 Sep 2012 11:53:29 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>259287</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 38 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0lo27:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>124548</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>