<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:46:23 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-2294] Corrupt repository after concurrent version operations</title>
                <link>https://issues.apache.org/jira/browse/OAK-2294</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;Performing version operations (checkin / checkout / addVersionLabel) concurrently can corrupt the repository. &lt;/p&gt;

&lt;p&gt;Executing the following code in parallel from multiple threads demonstrates this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Version version = versionManager.checkin(vPath);
versionManager.checkout(vPath);
&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; label = version.getName() + &lt;span class=&quot;code-quote&quot;&gt;&quot; &quot;&lt;/span&gt; + &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.currentThread().getName();
version.getContainingHistory()
    .addVersionLabel(version.getName(), label, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In my tests this eventually lead to all sorts of exceptions:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.lang.IllegalStateException: RefId &apos;85&apos; doesn&apos;t exist in data segment 0c5c0814-902c-429c-ad41-cd82aea276a2
	at org.apache.jackrabbit.oak.plugins.segment.Segment.getRefId(Segment.java:196)
	at org.apache.jackrabbit.oak.plugins.segment.Segment.internalReadRecordId(Segment.java:307)
	at org.apache.jackrabbit.oak.plugins.segment.Segment.readRecordId(Segment.java:303)
	at org.apache.jackrabbit.oak.plugins.segment.MapRecord.getBucketList(MapRecord.java:134)
	at org.apache.jackrabbit.oak.plugins.segment.MapRecord.getEntries(MapRecord.java:347)
	at org.apache.jackrabbit.oak.plugins.segment.MapRecord.getEntries(MapRecord.java:325)
	at org.apache.jackrabbit.oak.plugins.segment.MapRecord.compare(MapRecord.java:474)
	at org.apache.jackrabbit.oak.plugins.segment.MapRecord.compare(MapRecord.java:394)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeState.compareAgainstBaseState(SegmentNodeState.java:544)
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.lang.IllegalStateException: String is too long: 2159501163930351661
	at org.apache.jackrabbit.oak.plugins.segment.Segment.loadString(Segment.java:352)
	at org.apache.jackrabbit.oak.plugins.segment.Segment.readString(Segment.java:319)
	at org.apache.jackrabbit.oak.plugins.segment.Segment.readString(Segment.java:313)
	at org.apache.jackrabbit.oak.plugins.segment.Segment.loadTemplate(Segment.java:418)
	at org.apache.jackrabbit.oak.plugins.segment.Segment.readTemplate(Segment.java:367)
	at org.apache.jackrabbit.oak.plugins.segment.Segment.readTemplate(Segment.java:361)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeState.getTemplate(SegmentNodeState.java:78)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeState.compareAgainstBaseState(SegmentNodeState.java:408)
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.lang.IllegalStateException
	at com.google.common.base.Preconditions.checkState(Preconditions.java:134)
	at org.apache.jackrabbit.oak.plugins.segment.file.TarWriter.writeEntry(TarWriter.java:206)
	at org.apache.jackrabbit.oak.plugins.segment.file.TarWriter.writeEntry(TarWriter.java:200)
	at org.apache.jackrabbit.oak.plugins.segment.file.FileStore.writeSegment(FileStore.java:682)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentWriter.flush(SegmentWriter.java:228)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentWriter.prepare(SegmentWriter.java:329)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentWriter.writeTemplate(SegmentWriter.java:969)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentWriter.writeNode(SegmentWriter.java:1039)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentWriter$2.childNodeChanged(SegmentWriter.java:1062)
	at org.apache.jackrabbit.oak.plugins.memory.ModifiedNodeState.compareAgainstBaseState(ModifiedNodeState.java:395)
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Caused by: java.lang.IllegalArgumentException: Invalid type tag: 81
	at org.apache.jackrabbit.oak.api.Type.fromTag(Type.java:202)
	at org.apache.jackrabbit.oak.plugins.segment.Segment.loadTemplate(Segment.java:418)
	at org.apache.jackrabbit.oak.plugins.segment.Segment.readTemplate(Segment.java:367)
	at org.apache.jackrabbit.oak.plugins.segment.Segment.readTemplate(Segment.java:361)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeState.getTemplate(SegmentNodeState.java:78)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeState.getProperty(SegmentNodeState.java:122)
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Caused by: java.lang.IllegalStateException
	at com.google.common.base.Preconditions.checkState(Preconditions.java:134)
	at org.apache.jackrabbit.oak.plugins.segment.Segment.pos(Segment.java:178)
	at org.apache.jackrabbit.oak.plugins.segment.Segment.loadString(Segment.java:326)
	at org.apache.jackrabbit.oak.plugins.segment.Segment.readString(Segment.java:319)
	at org.apache.jackrabbit.oak.plugins.segment.Segment.readString(Segment.java:313)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentPropertyState.getValue(SegmentPropertyState.java:174)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentPropertyState.getValue(SegmentPropertyState.java:147)
	at org.apache.jackrabbit.oak.plugins.memory.AbstractPropertyState.equal(AbstractPropertyState.java:53)
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Will attach a patch with a test case shortly.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12757748">OAK-2294</key>
            <summary>Corrupt repository after concurrent version operations</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="stillalex">Alex Deparvu</assignee>
                                    <reporter username="mduerig">Michael D&#252;rig</reporter>
                        <labels>
                            <label>corruption</label>
                    </labels>
                <created>Tue, 25 Nov 2014 17:08:02 +0000</created>
                <updated>Tue, 8 Oct 2019 15:21:53 +0000</updated>
                            <resolved>Fri, 20 Feb 2015 20:51:22 +0000</resolved>
                                                    <fixVersion>1.0.12</fixVersion>
                    <fixVersion>1.1.7</fixVersion>
                                    <component>segmentmk</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="14224847" author="mduerig" created="Tue, 25 Nov 2014 17:10:14 +0000"  >&lt;p&gt;Patch with a test case demonstrating the problem. Give your VM enough heap (2G) and let it run until it breaks. For me this takes under 2 mins. &lt;/p&gt;</comment>
                            <comment id="14224850" author="mduerig" created="Tue, 25 Nov 2014 17:12:48 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mreutegg&quot; class=&quot;user-hover&quot; rel=&quot;mreutegg&quot;&gt;mreutegg&lt;/a&gt;, any idea what could be causing this from the versioning perspective?&lt;/p&gt;</comment>
                            <comment id="14225209" author="mreutegg" created="Tue, 25 Nov 2014 21:07:41 +0000"  >&lt;p&gt;Hmm, don&apos;t know. My first thought was some kind of concurrent access to shared state, but AFAICS each version operation runs with the SessionContext associated with the current session. &lt;/p&gt;

&lt;p&gt;I assume those version operations are likely to conflict because the test runs multiple sessions and they all operate on the same versionable node. Maybe those conflicts and related refreshes cause the corruption?&lt;/p&gt;</comment>
                            <comment id="14225219" author="mduerig" created="Tue, 25 Nov 2014 21:17:00 +0000"  >&lt;p&gt;I was able to further simplify the test case. Now the only operation running concurrently is &lt;tt&gt;VersionHistory#addVersionLabel&lt;/tt&gt;. See &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-2294&quot; title=&quot;Corrupt repository after concurrent version operations&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-2294&quot;&gt;&lt;del&gt;OAK-2294&lt;/del&gt;&lt;/a&gt;-2.patch&lt;/p&gt;</comment>
                            <comment id="14225249" author="mduerig" created="Tue, 25 Nov 2014 21:39:40 +0000"  >&lt;p&gt;This looks like a problem in the segment node store. Even if there were concurrency issues in the higher layers, those shouldn&apos;t cause corrupted segments. &lt;/p&gt;</comment>
                            <comment id="14226472" author="mduerig" created="Wed, 26 Nov 2014 17:12:19 +0000"  >&lt;p&gt;The root cause for this issue is a limitation of the SegmentMK that we are hitting here. Apparently the SegmentMK can&apos;t handle more than 255 property names in a template when those are spread over separate segments. So this isn&apos;t a concurrency issue after all. I was able to reproduce this within a single thread by just adding &lt;b&gt;many&lt;/b&gt; properties to the same node. The reason this is more expressed in a concurrent setting is that there the chances are higher that the property names get spread across various segments. &lt;/p&gt;

&lt;p&gt;The reason we are seeing this issue with the versioning code (while adding labels) is that labels are maintained as reference properties on the version history node. &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thomasm&quot; class=&quot;user-hover&quot; rel=&quot;thomasm&quot;&gt;thomasm&lt;/a&gt; your &lt;a href=&quot;https://github.com/apache/jackrabbit-oak/blob/trunk/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/SegmentWriter.java#L955&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;comment &lt;/a&gt; in the &lt;tt&gt;SegmentWriter&lt;/tt&gt; class was a great help in finding this. -&lt;del&gt;Could you summarise here why spreading property names across more than 255 segments doesn&apos;t work as you are stating in that comment?&lt;/del&gt;- Found it out myself: this would cause the segment containing the property names to have more than 255 references to other segments, which overflows it header.&lt;/p&gt;</comment>
                            <comment id="14226876" author="mduerig" created="Wed, 26 Nov 2014 22:11:14 +0000"  >&lt;p&gt;At &lt;a href=&quot;http://svn.apache.org/r1641950&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1641950&lt;/a&gt; I added an assertion that fails on an attempt to create more than 255 refs in a segment. This causes Oak to fail fast here instead of continuing with corrupted segments. &lt;/p&gt;</comment>
                            <comment id="14229685" author="mduerig" created="Mon, 1 Dec 2014 11:32:09 +0000"  >&lt;p&gt;At &lt;a href=&quot;http://svn.apache.org/r1642667&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1642667&lt;/a&gt; I improved prevision assertions such that respective commits would fail with a &lt;tt&gt;CommitFailedException&lt;/tt&gt; instead of the repository failing with a &lt;tt&gt;IllegalStateException&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="14231157" author="alex.parvulescu" created="Tue, 2 Dec 2014 08:23:46 +0000"  >&lt;p&gt;fyi I&apos;m seeing the SegmentOverflowException error now during compaction (usually the 2nd consecutive run, clone binaries false):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;org.apache.jackrabbit.oak.plugins.segment.SegmentOverflowException: Segment cannot have more than 255 references e9193f84-45ff-4844-a422-22524d8b5bcb
at org.apache.jackrabbit.oak.plugins.segment.SegmentWriter.getSegmentRef(SegmentWriter.java:345)
at org.apache.jackrabbit.oak.plugins.segment.SegmentWriter.writeRecordId(SegmentWriter.java:375)
at org.apache.jackrabbit.oak.plugins.segment.SegmentWriter.writeListBucket(SegmentWriter.java:451)
at org.apache.jackrabbit.oak.plugins.segment.SegmentWriter.writeList(SegmentWriter.java:650)
at org.apache.jackrabbit.oak.plugins.segment.SegmentWriter.writeLargeBlob(SegmentWriter.java:795)
at org.apache.jackrabbit.oak.plugins.segment.SegmentBlob.clone(SegmentBlob.java:187)
at org.apache.jackrabbit.oak.plugins.segment.Compactor.compact(Compactor.java:234)
at org.apache.jackrabbit.oak.plugins.segment.Compactor.compact(Compactor.java:182)
at org.apache.jackrabbit.oak.plugins.segment.Compactor.access$000(Compactor.java:49)
at org.apache.jackrabbit.oak.plugins.segment.Compactor$CompactDiff.propertyAdded(Compactor.java:112)
at org.apache.jackrabbit.oak.plugins.memory.EmptyNodeState.compareAgainstEmptyState(EmptyNodeState.java:155)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14231170" author="mduerig" created="Tue, 2 Dec 2014 08:31:18 +0000"  >&lt;p&gt;As this seems to happen in &lt;tt&gt;writeLargeBlob&lt;/tt&gt;, is there anyway we can reproduce this directly? &lt;/p&gt;

&lt;p&gt;Anyway, it seems like this being a blocker to &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-2192&quot; title=&quot;Concurrent commit during compaction results in mixed segments&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-2192&quot;&gt;&lt;del&gt;OAK-2192&lt;/del&gt;&lt;/a&gt; then...&lt;/p&gt;</comment>
                            <comment id="14231751" author="mduerig" created="Tue, 2 Dec 2014 17:04:51 +0000"  >&lt;p&gt;At &lt;a href=&quot;http://svn.apache.org/r1642954&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1642954&lt;/a&gt; I added a regression test for the assertion guarding against the repository corruption. As the test takes 35s (on my machine) I made it only run with the IT profile. &lt;/p&gt;</comment>
                            <comment id="14233186" author="mduerig" created="Wed, 3 Dec 2014 16:52:21 +0000"  >&lt;p&gt;I was quickly looking into possible ways to fix this. Fixing it for the template immediately shifts the problems to the nodes, so we have to fix it there too. In any case however, I don&apos;t see a way to fix this without changing the storage format. &lt;/p&gt;</comment>
                            <comment id="14248445" author="mduerig" created="Tue, 16 Dec 2014 16:26:23 +0000"  >&lt;p&gt;Lowering priority as my initial work prevents the repository from becoming corrupted. &lt;/p&gt;</comment>
                            <comment id="14319782" author="alex.parvulescu" created="Fri, 13 Feb 2015 09:30:09 +0000"  >&lt;p&gt;attaching a proposed fix. still WIP, based on initial work from Michael.&lt;br/&gt;
this will turn the node&apos;s properties (and templates) into a ListRecord which has the segment overflow safety enabled (it will flush the segment once it reaches the limit).&lt;br/&gt;
there are still some unresolved issues, for example backwards compatibility when reading a persisted node, also there are some code paths that need looking into that I only marked as a TODO for now.&lt;/p&gt;

&lt;p&gt;I believe &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-2498&quot; title=&quot;Root record references provide too little context for parsing a segment&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-2498&quot;&gt;&lt;del&gt;OAK-2498&lt;/del&gt;&lt;/a&gt; might help us fix the backwards compatibility issue easily. one could simply lookup the record in the table and decide how to read the persisted properties.&lt;/p&gt;</comment>
                            <comment id="14322672" author="mduerig" created="Mon, 16 Feb 2015 11:33:55 +0000"  >&lt;p&gt;Good stuff, thanks for looking into this! One minor nag: the segment overflow check in &lt;tt&gt;Segment#getRefCount&lt;/tt&gt; will never trigger as &lt;tt&gt;n &amp;amp; 0xff &amp;gt; 255&lt;/tt&gt; never holds. &lt;/p&gt;

&lt;p&gt;On a more general note, would it make sense to also explore the viability of an alternative solution where we&apos;d lift the 255 segment references limit? One way to do this would be to reserve the last slot as an &quot;extension slot&quot; pointing to more references. Really not sure whether this would be time well spent or whether we&apos;d rather go with what you did.&lt;/p&gt;

&lt;p&gt;In both cases we still need to tackle the issue with backward compatibility and migration as we are changing the storage format. Migration could be done as we go: accept the old and new format when reading and write the new format when writing. Proactive migration could then be done by running offline compaction once. What&apos;s more difficult is preventing previous Oak versions to run with the new storage format. The segment header includes a version field, which we could use. Unfortunately all current Oak versions do not check that field effectively pretending to be infinitely forward compatible &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &lt;/p&gt;
</comment>
                            <comment id="14322818" author="mduerig" created="Mon, 16 Feb 2015 14:36:14 +0000"  >&lt;p&gt;One thing we could do to introduce versions checking retroactively is to redefine the &lt;a href=&quot;http://jackrabbit.apache.org/oak/docs/nodestore/segmentmk.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;segment header format &lt;/a&gt; from:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;+--------+--------+--------+--------+--------+--------+--------+--------+
| magic bytes: &quot;0aK\n&quot; in ASCII     |version |idcount |rootcount        |
+--------+--------+--------+--------+--------+--------+--------+--------+
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;to: &lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;+--------+--------+--------+--------+--------+--------+--------+--------+
| magic bytes: &quot;0aK&quot; ASCII |version |reserved|idcount |rootcount        |
+--------+--------+--------+--------+--------+--------+--------+--------+
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;where version would be &lt;tt&gt;10&lt;/tt&gt; for the current storage format and &lt;tt&gt;11&lt;/tt&gt; for the next storage format. &lt;/p&gt;

</comment>
                            <comment id="14322825" author="alex.parvulescu" created="Mon, 16 Feb 2015 14:46:36 +0000"  >&lt;p&gt;+1 sounds cool&lt;/p&gt;</comment>
                            <comment id="14322899" author="mduerig" created="Mon, 16 Feb 2015 15:42:26 +0000"  >&lt;p&gt;I created &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-2527&quot; title=&quot;Update SegmentMK header format definition&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-2527&quot;&gt;&lt;del&gt;OAK-2527&lt;/del&gt;&lt;/a&gt; to track updating the segment header format as I think this change is prominent enough to deserve its own issue. &lt;/p&gt;</comment>
                            <comment id="14322995" author="mduerig" created="Mon, 16 Feb 2015 16:56:25 +0000"  >&lt;p&gt;Attaching &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12699131/12699131_OAK-2294-v4.patch&quot; title=&quot;OAK-2294-v4.patch attached to OAK-2294&quot;&gt;OAK-2294-v4.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;, which is the same as &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12698684/12698684_OAK-2294-v3.patch&quot; title=&quot;OAK-2294-v3.patch attached to OAK-2294&quot;&gt;OAK-2294-v3.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; but leverages the mechanism from &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-2527&quot; title=&quot;Update SegmentMK header format definition&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-2527&quot;&gt;&lt;del&gt;OAK-2527&lt;/del&gt;&lt;/a&gt; to detect the segment version.&lt;/p&gt;</comment>
                            <comment id="14324183" author="alex.parvulescu" created="Tue, 17 Feb 2015 13:53:08 +0000"  >&lt;p&gt;v5 cleaned up, almost ready to go.&lt;/p&gt;

&lt;p&gt;there are a few remarks to the old versions:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;I don&apos;t think we need to allow the option to write as V10, the segments are not going to be modified, so I see no good reason to keep these bits in place.&lt;/li&gt;
	&lt;li&gt;theres still a test failing &lt;em&gt;RecordUsageAnalyserTest#counts&lt;/em&gt;&lt;br/&gt;
The failure is a NPE on loading the segment and it may be because the mocked store doesn&apos;t reply to the &lt;em&gt;store.readSegment(id)&lt;/em&gt; method. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mduerig&quot; class=&quot;user-hover&quot; rel=&quot;mduerig&quot;&gt;mduerig&lt;/a&gt; any ideas?&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14324185" author="alex.parvulescu" created="Tue, 17 Feb 2015 13:56:05 +0000"  >&lt;p&gt;forgot one thing, V5 also contains the test from &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-2481&quot; title=&quot;IllegalStateException in TarMk with large number of properties&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-2481&quot;&gt;&lt;del&gt;OAK-2481&lt;/del&gt;&lt;/a&gt;. I&apos;m not sure what to do with there slow tests, but it looks like this patch fixes that problem too, so I would include the test here and mark &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-2481&quot; title=&quot;IllegalStateException in TarMk with large number of properties&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-2481&quot;&gt;&lt;del&gt;OAK-2481&lt;/del&gt;&lt;/a&gt; as a duplicate of this issue.&lt;/p&gt;</comment>
                            <comment id="14325634" author="alex.parvulescu" created="Wed, 18 Feb 2015 09:19:39 +0000"  >&lt;p&gt;V6 attached, V5 + the &lt;em&gt;RecordUsageAnalyser&lt;/em&gt; changes. tests pass but I&apos;d like some feedback, make sure I did not break the analyzer.&lt;/p&gt;

&lt;p&gt;TODO: as discussed offline with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mduerig&quot; class=&quot;user-hover&quot; rel=&quot;mduerig&quot;&gt;mduerig&lt;/a&gt; I&apos;ll re-add the ability to write segments with the old version so it can be used from tooling if ever needed.&lt;br/&gt;
this should also allow us to write some compatibility tests. stay tuned!&lt;/p&gt;</comment>
                            <comment id="14326269" author="alex.parvulescu" created="Wed, 18 Feb 2015 17:58:11 +0000"  >&lt;p&gt;attaching V7. as it turns out keeping both V10 and V11 read&amp;amp;write support is a bit tricky so this version is a bit more complex. I had to introduce a SegmentVersion (heavily inpired by lucene&apos;s Version class).&lt;br/&gt;
I managed to add some backwards compatibility tests (write as V10 and then read from a V11 store), and a good thing that was, I actually uncovered a bug while writing them. the question remains if they are enough or if some more node structures need to be added.&lt;/p&gt;

&lt;p&gt;this patch also fixes the record analyzer tests, but I think those parts may need closer inspection.&lt;/p&gt;

&lt;p&gt;For &lt;em&gt;SegmentReferenceLimitTestIT&lt;/em&gt; I changed the dynamic a bit, lowered the number of writes and increased the number of threads. test still fails on the old version, passes on this one but at least there&apos;s no more OOME during the IT tests.&lt;br/&gt;
Not the same can be said about &lt;em&gt;LargeNumberOfPropertiesTestIT&lt;/em&gt;. I ignored the tests so it doesn&apos;t run during ITs, I couldn&apos;t find any slimmer version of it other than increasing the heap size during the tests. I&apos;m not sure what to do here.&lt;/p&gt;

&lt;p&gt;as usual &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mduerig&quot; class=&quot;user-hover&quot; rel=&quot;mduerig&quot;&gt;mduerig&lt;/a&gt; feedback is kindly requested &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

</comment>
                            <comment id="14329100" author="mduerig" created="Fri, 20 Feb 2015 16:06:48 +0000"  >&lt;p&gt;v7 patch looks good. I committed a slightly modified version at &lt;a href=&quot;http://svn.apache.org/r1661146:&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1661146:&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;renamed some items to consistently use the term &apos; segment version&apos;&lt;/li&gt;
	&lt;li&gt;refactored &lt;tt&gt;SegmentVersion&lt;/tt&gt; a bit to pass the version number byte into its constructor&lt;/li&gt;
	&lt;li&gt;added a test to &lt;tt&gt;SegmentVersionTest&lt;/tt&gt; so we have test coverage for &lt;tt&gt;Template#getProperty&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Apart from that I think &lt;tt&gt;RecordUsageAnalyser&lt;/tt&gt; needs more updating to be inline with the v11 segment format. I created &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-2542&quot; title=&quot;Update RecordUsageAnalyser to reflect changes in segment format &quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-2542&quot;&gt;&lt;del&gt;OAK-2542&lt;/del&gt;&lt;/a&gt; for that. &lt;/p&gt;

&lt;p&gt;Furthermore I was wondering whether in &lt;tt&gt;SegmentNodeState&lt;/tt&gt; and/or &lt;tt&gt;Template&lt;/tt&gt;, at the places where the &lt;tt&gt;ListRecord&lt;/tt&gt; for the properties is instantiated, whether it might make sense to cache it!? But we should probably just keep this in mind as a possible improvement. &lt;/p&gt;</comment>
                            <comment id="14329153" author="mduerig" created="Fri, 20 Feb 2015 16:49:54 +0000"  >&lt;p&gt;&lt;a href=&quot;http://svn.apache.org/r1661158&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1661158&lt;/a&gt; avoid using &lt;tt&gt;JsopDiff&lt;/tt&gt; in the tests. &lt;/p&gt;</comment>
                            <comment id="14329531" author="alex.parvulescu" created="Fri, 20 Feb 2015 20:51:22 +0000"  >&lt;p&gt;fixed in trunk with r1661146 and r1661158, merged to 1.0 with rev r1661216&lt;/p&gt;</comment>
                            <comment id="14329579" author="mduerig" created="Fri, 20 Feb 2015 21:24:22 +0000"  >&lt;p&gt;At &lt;a href=&quot;http://svn.apache.org/r1661226&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1661226&lt;/a&gt; I added two more test cases to trunk: one for mixed segment versions and the other for migration through compaction.&lt;/p&gt;</comment>
                            <comment id="14330087" author="alex.parvulescu" created="Sat, 21 Feb 2015 08:47:42 +0000"  >&lt;p&gt;merged to 1.0 with r1661300&lt;/p&gt;</comment>
                            <comment id="14354689" author="mreutegg" created="Tue, 10 Mar 2015 10:46:07 +0000"  >&lt;p&gt;Bulk close for Oak 1.0.12.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                                                <inwardlinks description="is blocked by">
                                        <issuelink>
            <issuekey id="12775390">OAK-2527</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12773875">OAK-2498</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12776807">OAK-2545</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                                                <inwardlinks description="is depended upon by">
                                        <issuelink>
            <issuekey id="12772717">OAK-2481</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12683660" name="OAK-2294-2.patch" size="3301" author="mduerig" created="Tue, 25 Nov 2014 21:17:00 +0000"/>
                            <attachment id="12698684" name="OAK-2294-v3.patch" size="14144" author="stillalex" created="Fri, 13 Feb 2015 09:30:09 +0000"/>
                            <attachment id="12699131" name="OAK-2294-v4.patch" size="18672" author="mduerig" created="Mon, 16 Feb 2015 16:56:25 +0000"/>
                            <attachment id="12699259" name="OAK-2294-v5.patch" size="22752" author="stillalex" created="Tue, 17 Feb 2015 13:53:08 +0000"/>
                            <attachment id="12699447" name="OAK-2294-v6.patch" size="27126" author="stillalex" created="Wed, 18 Feb 2015 09:19:39 +0000"/>
                            <attachment id="12699504" name="OAK-2294-v7.patch" size="48188" author="stillalex" created="Wed, 18 Feb 2015 17:58:11 +0000"/>
                            <attachment id="12683598" name="OAK-2294.patch" size="3360" author="mduerig" created="Tue, 25 Nov 2014 17:10:14 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>7.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 36 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i22rtb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>