<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:50:45 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-4170] QueryEngine adding invalid property restriction for fulltext query</title>
                <link>https://issues.apache.org/jira/browse/OAK-4170</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;QueryEngine inserts a property restriction of &quot;is not null&quot; for any property used in fulltext constraint. For e.g. for query&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;select * from [nt:unstructured] where CONTAINS([jcr:content/metadata/comment], &apos;december&apos;)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;A property restriction would be added for &lt;tt&gt;jcr:content/metadata/comment&lt;/tt&gt;. However currently due to bug in &lt;tt&gt;FulltextSearchImpl&lt;/tt&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; the property name generated is &lt;tt&gt;comment/jcr:content/metadata&lt;/tt&gt;.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;@Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void restrict(FilterImpl f) {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (propertyName != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (f.getSelector().equals(selector)) {
                &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; p = propertyName;
                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (relativePath != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
                    p = PathUtils.concat(p, relativePath);
                }                
                p = normalizePropertyName(p);
                restrictPropertyOnFilter(p, f);
            }
        }
        f.restrictFulltextCondition(fullTextSearchExpression.currentValue().getValue(Type.STRING));
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This happens because &lt;tt&gt;relativePath&lt;/tt&gt; is passed as second param to &lt;tt&gt;PathUtils.concat&lt;/tt&gt;. It should be first param&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://github.com/apache/jackrabbit-oak/blob/1.4/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/FullTextSearchImpl.java#L275-L286&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/jackrabbit-oak/blob/1.4/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/FullTextSearchImpl.java#L275-L286&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12956043">OAK-4170</key>
            <summary>QueryEngine adding invalid property restriction for fulltext query</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="thomasm">Thomas Mueller</assignee>
                                    <reporter username="chetanm">Chetan Mehrotra</reporter>
                        <labels>
                    </labels>
                <created>Tue, 5 Apr 2016 05:33:27 +0000</created>
                <updated>Tue, 8 Oct 2019 15:21:49 +0000</updated>
                            <resolved>Wed, 8 Jun 2016 07:59:15 +0000</resolved>
                                                    <fixVersion>1.5.3</fixVersion>
                    <fixVersion>1.6.0</fixVersion>
                                    <component>query</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15225710" author="chetanm" created="Tue, 5 Apr 2016 05:36:23 +0000"  >&lt;p&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12796986/12796986_OAK-4170-v1.patch&quot; title=&quot;OAK-4170-v1.patch attached to OAK-4170&quot;&gt;patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; with testcase and simple fix. I am not yet sure wether this issue affect the final result or not&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thomasm&quot; class=&quot;user-hover&quot; rel=&quot;thomasm&quot;&gt;thomasm&lt;/a&gt; Can you have a look?&lt;/p&gt;</comment>
                            <comment id="15226009" author="edivad" created="Tue, 5 Apr 2016 10:05:01 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chetanm&quot; class=&quot;user-hover&quot; rel=&quot;chetanm&quot;&gt;chetanm&lt;/a&gt; I think we should remove the &lt;tt&gt;System.out&lt;/tt&gt; from the test and opt for a &lt;tt&gt;Logger&lt;/tt&gt; if the printing is needed for debugging purposes. It will definitely need a test coverage from a query side point of view. Something in &lt;tt&gt;LuceneIndexQueryTest&lt;/tt&gt; probably or maybe the &lt;tt&gt;sql2-fulltext.txt&lt;/tt&gt;. &lt;/p&gt;

&lt;p&gt;Does this happen for xpath as well?&lt;/p&gt;</comment>
                            <comment id="15226015" author="chetanm" created="Tue, 5 Apr 2016 10:07:37 +0000"  >&lt;blockquote&gt;&lt;p&gt;I think we should remove the System.out from the test and opt for a Logger if the printing is needed for debugging purposes. It will definitely need a test coverage from a query side point of view&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Definitely! As the property name was incorrect the sys out was just meant to highlight that. Not required for final fix&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Does this happen for xpath as well?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Should happen as xpath gets converted to sql2 and thus follows the same code path for evaluation&lt;/p&gt;</comment>
                            <comment id="15231652" author="chetanm" created="Fri, 8 Apr 2016 05:15:41 +0000"  >&lt;p&gt;Added the ignored testcase in 1738211. Did a check in LucenePropertyIndex about impact of this issue and it appears that it does not causes issue with end result. Reason being that evaluate logic does not &lt;tt&gt;enforcePropertyExistence&lt;/tt&gt; if its a relative property (though it should be safe to use relativeProperty as argument) &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; evaluate() {
        &lt;span class=&quot;code-comment&quot;&gt;// disable evaluation &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; a fulltext index is used,
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// to avoid running out of memory &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; the node is large,
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// and because we might not implement all features
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// such as index aggregation
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (selector.getIndex() &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; FulltextQueryIndex) {
            &lt;span class=&quot;code-comment&quot;&gt;// first verify &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; a property level condition exists and &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; that
&lt;/span&gt;            &lt;span class=&quot;code-comment&quot;&gt;// condition checks out, &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; takes out some extra rows from the index
&lt;/span&gt;            &lt;span class=&quot;code-comment&quot;&gt;// aggregation bits
&lt;/span&gt;            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (relativePath == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; propertyName != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; enforcePropertyExistence(propertyName, selector);
            }
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thomasm&quot; class=&quot;user-hover&quot; rel=&quot;thomasm&quot;&gt;thomasm&lt;/a&gt; Can you have a look? I see  2 options&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Fix the code and pass correct property restriction&lt;/li&gt;
	&lt;li&gt;OR do away with this check altogether. These &quot;synthetic&quot; restriction are treated like normal restriction at index level which then results in addition query constraints passed for property not null  which adds some overhead at index level (we need to create an unnecessary property index for such properties). So either mark such &quot;synthetic&quot; restriction in a special way such that indexes can ignore them or we just do away with them altogether as I do not see much benefit here&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;FWIW I got this issue while trying out various queries at &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; where due to this issue extra garbage property index entries gets created&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;http://oakutils.appspot.com/generate/index&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://oakutils.appspot.com/generate/index&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15318583" author="tmueller" created="Tue, 7 Jun 2016 14:36:28 +0000"  >&lt;p&gt;I will remove the &quot;not null&quot; condition (&quot;2&quot; on your list). But first I fixed the actual bug in &lt;a href=&quot;http://svn.apache.org/r1747245&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1747245&lt;/a&gt;, in case we want to re-add it later on for some reason.&lt;/p&gt;</comment>
                            <comment id="15320215" author="tmueller" created="Wed, 8 Jun 2016 07:59:15 +0000"  >&lt;p&gt;&lt;a href=&quot;http://svn.apache.org/r1747359&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1747359&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15324221" author="edivad" created="Fri, 10 Jun 2016 10:34:59 +0000"  >&lt;p&gt;Bulk close for 1.5.3&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12796986" name="OAK-4170-v1.patch" size="2109" author="chetanm" created="Tue, 5 Apr 2016 05:36:23 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 23 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2vn6n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>