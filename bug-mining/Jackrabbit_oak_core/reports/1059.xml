<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:46:13 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-2140] Segment Compactor will not compact binaries &gt; 16k</title>
                <link>https://issues.apache.org/jira/browse/OAK-2140</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;The compaction bit rely on the SegmentBlob#clone method in the case a binary is being processed but it looks like the #clone contract is not fully enforced for streams that are qualified as &apos;long values&apos; (&amp;gt;16k if I read the code correctly). &lt;br/&gt;
What happens is the stream is initially persisted as chunks in a ListRecord. When compaction calls #clone it will get back the original list of record ids, which will get referenced from the compacted node state &lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt;, making compaction on large binaries ineffective as the bulk segments will never move from the original location where they were created, unless the reference node gets deleted.&lt;/p&gt;

&lt;p&gt;I think the original design was setup to prevent large binaries from being copied over but looking at the size problem we have now it might be a good time to reconsider this approach.&lt;/p&gt;


&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://github.com/apache/jackrabbit-oak/blob/trunk/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/SegmentBlob.java#L75&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/jackrabbit-oak/blob/trunk/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/SegmentBlob.java#L75&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12744052">OAK-2140</key>
            <summary>Segment Compactor will not compact binaries &gt; 16k</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="stillalex">Alex Deparvu</assignee>
                                    <reporter username="stillalex">Alex Deparvu</reporter>
                        <labels>
                            <label>compaction</label>
                            <label>gc</label>
                    </labels>
                <created>Thu, 25 Sep 2014 15:21:13 +0000</created>
                <updated>Wed, 14 Oct 2015 09:56:33 +0000</updated>
                            <resolved>Sun, 9 Nov 2014 11:18:06 +0000</resolved>
                                                    <fixVersion>1.0.9</fixVersion>
                    <fixVersion>1.1.3</fixVersion>
                                    <component>core</component>
                    <component>segmentmk</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14171057" author="mduerig" created="Tue, 14 Oct 2014 15:20:06 +0000"  >&lt;p&gt;I did some test with a quick fix to the &lt;tt&gt;#clone&lt;/tt&gt; method such that it actually does a deep copy of all binaries. The behaviour seemed right as I could see the binary segments being copied instead of just new generations for them being written. However in the face of &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-2045&quot; title=&quot;Long running JCR session prevent live cleanup in Segment FileStore&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-2045&quot;&gt;&lt;del&gt;OAK-2045&lt;/del&gt;&lt;/a&gt; I also observed much bigger repository growth as now compaction also creates a copy of all binaries while the originals are held from being removed from long running sessions. &lt;/p&gt;</comment>
                            <comment id="14171058" author="mduerig" created="Tue, 14 Oct 2014 15:21:09 +0000"  >&lt;p&gt;For reference here the patch for my changes I did for said tests. &lt;/p&gt;</comment>
                            <comment id="14194416" author="alex.parvulescu" created="Mon, 3 Nov 2014 10:31:49 +0000"  >&lt;p&gt;I believe the outcome of this is quite hard to assess, so I&apos;m proposing exposing this via a flag that controls if a #clone call should by a shallow clone or a deep clone. this is only called via the compaction bits anyway, and it will allow the user to choose between the 2 options, but we&apos;ll probably have to document the impact of each choice:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;shallow clone: a more reduced repository growth during compaction itself, but a less effective cleanup after&lt;br/&gt;
    ex: using a 1G repo: first compaction, repo size is at 1.1G, second 1.2G, third 1.3G, forth back to 1Gb.&lt;br/&gt;
the example is highly subjective, and cannot be used as a reference for bigger repositories, and because of the interweaved references between segments, the size growth has been known to be a lot bigger for larger repos, and the stabilization to the original size can occur after a larger number of runs.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;deep clone: the repo size effectively doubles during compaction, but goes back to the original size after cleanup&lt;br/&gt;
    ex: 1G initial repo, during the first compaction repo size goes up to 2G, after the cleanup is done, back to 1G, the process repeats itself for the following compaction runs.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14194421" author="mduerig" created="Mon, 3 Nov 2014 10:38:41 +0000"  >&lt;p&gt;+1. I think this is the most sensible thing to do for the time being as the behaviour of compaction will also depend on the type of the repository content and its usage pattern. Furthermore this option will also have an effect on dis read/writes and disk space usage. Maybe once certain typical usage patter start to emerge we can follow up on this issue and further refine it. For the time being I&apos;d go with the configuration option. &lt;/p&gt;</comment>
                            <comment id="14203882" author="alex.parvulescu" created="Sun, 9 Nov 2014 11:18:06 +0000"  >&lt;p&gt;fixed on trunk with rev &lt;a href=&quot;http://svn.apache.org/r1637651&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1637651&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14203884" author="alex.parvulescu" created="Sun, 9 Nov 2014 11:21:12 +0000"  >&lt;p&gt;merged to 1.0 with &lt;a href=&quot;http://svn.apache.org/r1637655&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1637655&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14244323" author="edivad" created="Fri, 12 Dec 2014 16:05:46 +0000"  >&lt;p&gt;Bulk close for 1.1.3&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12735772">OAK-2045</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                                                <inwardlinks description="is depended upon by">
                                        <issuelink>
            <issuekey id="12748055">OAK-2192</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12674781" name="OAK-2140.patch" size="1285" author="mduerig" created="Tue, 14 Oct 2014 15:21:09 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311120" key="com.pyxis.greenhopper.jira:gh-epic-link">
                        <customfieldname>Epic Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>OAK-2849</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 49 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i20hev:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>