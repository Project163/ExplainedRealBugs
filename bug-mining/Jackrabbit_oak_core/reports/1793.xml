<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:53:51 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-7997] Adding restrictions to ACLs yields empty results for queries in Jackrabbit Oak</title>
                <link>https://issues.apache.org/jira/browse/OAK-7997</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;Using Jackrabbit Oak, I&apos;ve been attempting to configure security through&#160;&lt;tt&gt;SecurityProvider&lt;/tt&gt;&#160;and&#160;&lt;tt&gt;SecurityConfiguration&lt;/tt&gt; s. In particular, I&apos;ve been using the restrictions which generally works as expected. However, when dealing with JCR-SQL2}}&#160;queries, more gets filtered out than expected.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Details&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;It can be reproduced with the repository below.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
/&#160;
  node      [nt:unstructured]
&#160;   subnode [nt:unstructured]&#160;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;On&#160;&lt;tt&gt;node&lt;/tt&gt;, I add an access control entry with privilege&#160;&lt;tt&gt;JCR_ALL&lt;/tt&gt;&#160;for &quot;&lt;tt&gt;user&quot;&lt;/tt&gt;&#160;together with a restriction for&#160;&lt;tt&gt;rep:glob&lt;/tt&gt;&#160;-&amp;gt;&#160;&lt;tt&gt;&quot;&quot;&lt;/tt&gt;, such that&#160;&lt;tt&gt;user&lt;/tt&gt;&#160;do not have access to any children of&#160;&lt;tt&gt;node - in this case, only subnode&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;It works as expected when using&#160;&lt;tt&gt;session.getNode&lt;/tt&gt;:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;tt&gt;session.getNode(&quot;/node&quot;)&lt;/tt&gt;&#160;returns the node&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;session.getNode(&quot;/node/subnode&quot;)&lt;/tt&gt;&#160;throws&#160;&lt;tt&gt;PathNotFoundException&lt;/tt&gt;&#160;as expected due to the restriction.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;However, when I execute the following&#160;&lt;tt&gt;JCR-SQL2&lt;/tt&gt;&#160;query:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
SELECT * FROM [nt:unstructured]&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I get&#160;&lt;b&gt;no results back&lt;/b&gt;. Here I would have expected to get&#160;&lt;tt&gt;/node&lt;/tt&gt;, as it is otherwise available when using&#160;&lt;tt&gt;session.getNode&lt;/tt&gt;.&#160;Removing the restriction yields the expected result of both &lt;em&gt;/node&lt;/em&gt; and &lt;em&gt;/node/subnode&lt;/em&gt;.&lt;/p&gt;

&lt;p&gt;As discussed with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=anchela&quot; class=&quot;user-hover&quot; rel=&quot;anchela&quot;&gt;anchela&lt;/a&gt; on the &lt;em&gt;users&lt;/em&gt; mailing list, this may either be an actual bug, or it is a conscious decision - in which case&#160;it would be nice to have it&#160;documented for the security.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Code for reproducing:&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;The code for reproducing the error is shown below. The &quot;&lt;em&gt;restrictions&quot;&lt;/em&gt;&#160;map below seems to be the problem, as this is what results in both&#160;&lt;em&gt;/node&lt;/em&gt; and &lt;em&gt;/node/subnode&lt;/em&gt; being filtered out.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void main(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] args) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
    Repository repository = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Jcr().with(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; MySecurityProvider()).createRepository();
    Session session = repository.login(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; UserIdCredentials(&lt;span class=&quot;code-quote&quot;&gt;&quot;&quot;));    &lt;span class=&quot;code-comment&quot;&gt;// principal is &quot;&lt;/span&gt;SystemPrincipal.INSTANCE&quot;
&lt;/span&gt;
    &lt;span class=&quot;code-comment&quot;&gt;// Create nodes
&lt;/span&gt;    Node node = session.getRootNode().addNode(&lt;span class=&quot;code-quote&quot;&gt;&quot;node&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;nt:unstructured&quot;&lt;/span&gt;);
    node.addNode(&lt;span class=&quot;code-quote&quot;&gt;&quot;subnode&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;nt:unstructured&quot;&lt;/span&gt;);

    &lt;span class=&quot;code-comment&quot;&gt;// Add access control entry + restriction
&lt;/span&gt;    AccessControlManager acm = session.getAccessControlManager();
    JackrabbitAccessControlList acl = (JackrabbitAccessControlList) acm
        .getApplicablePolicies(&lt;span class=&quot;code-quote&quot;&gt;&quot;/node&quot;&lt;/span&gt;).nextAccessControlPolicy();
    Privilege[] privileges = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Privilege[]{acm.privilegeFromName(Privilege.JCR_ALL)};
    Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, Value&amp;gt; restrictions = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HashMap&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, Value&amp;gt;() {{put(&lt;span class=&quot;code-quote&quot;&gt;&quot;rep:glob&quot;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; StringValue(&quot;&quot;));}};
    acl.addEntry(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PrincipalImpl(&lt;span class=&quot;code-quote&quot;&gt;&quot;user&quot;&lt;/span&gt;), privileges, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, restrictions);
    acm.setPolicy(&lt;span class=&quot;code-quote&quot;&gt;&quot;/node&quot;&lt;/span&gt;, acl);
    session.save();

    &lt;span class=&quot;code-comment&quot;&gt;// executes query
&lt;/span&gt;    RowIterator rows = repository.login(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; UserIdCredentials(&lt;span class=&quot;code-quote&quot;&gt;&quot;user&quot;&lt;/span&gt;)).getWorkspace().getQueryManager()
        .createQuery(&lt;span class=&quot;code-quote&quot;&gt;&quot;SELECT * FROM [nt:unstructured]&quot;&lt;/span&gt;, Query.JCR_SQL2).execute().getRows();
        &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-object&quot;&gt;Number&lt;/span&gt; of rows: &quot;&lt;/span&gt; + rows.getSize());  &lt;span class=&quot;code-comment&quot;&gt;//Prints 0
&lt;/span&gt;}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;b&gt;Code for security configuration:&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;The above code makes use of &quot;MySecurityProvider&quot;. I do not suspect this to be the root cause,&#160;but please let me know if it can be helpful to have. The security provider has the configuration set to &quot;ConfigurationParameters.EMPTY&quot;, and it uses all the default implementations present within the Jackrabbit Oak project. The only exception is&#160;the &lt;em&gt;AuthenticationConfiguration&lt;/em&gt; which uses a custom implementation using pre-authentication:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;MyAuthenticationConfiguration &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; AuthenticationConfigurationImpl {
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; MyAuthenticationConfiguration(SecurityProvider securityProvider) {
        &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;(securityProvider);
    }

    @NotNull
    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; LoginContextProvider getLoginContextProvider(ContentRepository contentRepository) {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; LoginContextProvider() {
            @NotNull
            &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; LoginContext getLoginContext(Credentials credentials, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; workspaceName) {
                &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; userId = ((UserIdCredentials) credentials).getUserId();
                Set&amp;lt;Principal&amp;gt; principalSets = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HashSet&amp;lt;&amp;gt;();
                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (userId.isEmpty()) {
                    principalSets.add(SystemPrincipal.INSTANCE);
                } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
                    principalSets.add(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PrincipalImpl(userId));
                }
                Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, ? &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; Principal&amp;gt; publicPrivileges = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HashMap&amp;lt;&amp;gt;();
                AuthInfoImpl authInfoImpl = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; AuthInfoImpl(userId, publicPrivileges, principalSets);
                Subject subject = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Subject(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, principalSets, Collections.singleton(authInfoImpl), &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HashSet&amp;lt;Principal&amp;gt;());
                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PreAuthContext(subject);
            }
        };
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13210775">OAK-7997</key>
            <summary>Adding restrictions to ACLs yields empty results for queries in Jackrabbit Oak</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="angela">Angela Schreiber</assignee>
                                    <reporter username="snj">S&#248;ren Jensen</reporter>
                        <labels>
                    </labels>
                <created>Mon, 21 Jan 2019 13:48:12 +0000</created>
                <updated>Thu, 5 Dec 2019 13:55:36 +0000</updated>
                            <resolved>Wed, 6 Feb 2019 16:05:26 +0000</resolved>
                                    <version>1.10.0</version>
                    <version>1.8.10</version>
                                    <fixVersion>1.12.0</fixVersion>
                                    <component>query</component>
                    <component>security</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16748049" author="anchela" created="Mon, 21 Jan 2019 16:03:55 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=snj&quot; class=&quot;user-hover&quot; rel=&quot;snj&quot;&gt;snj&lt;/a&gt;, i extracted a test case based on your description (directly operating on oak QueryEngine and oak API for simplicity) and i added some additional variants:&lt;/p&gt;

&lt;p&gt;a) your case: single policy on /node with single entry + rep:glob restriction with empty value =&amp;gt; unexpected result&lt;br/&gt;
b) policy on /node (allow) and another policy on /node/subnode (deny) =&amp;gt; expected result (but obviously not practical in real life... just for the limited test-setup that&apos;s equivalent)&lt;/p&gt;

&lt;p&gt;and while writing the summary i noticed a potential reason for the failure in a): with the &quot;&quot;-rep:glob we not only deny access to the child node but also to all properties of /node because the glob restriction is just a simple path-matching and doesn&apos;t differentiate between child properties and child nodes. to illustrate this (and because I suspect that the query looks at jcr:primaryType property) i added yet another test case &lt;/p&gt;

&lt;p&gt;c) same as a) but additionally granting property-read at /node/jcr:primaryType =&amp;gt; expected result.&lt;/p&gt;

&lt;p&gt;that&apos;s just for an initial illustration. i don&apos;t think that extra entry should be needed because in the JCR API implementation in Oak we added some extra logic to make sure a Node and its primary type information is accessible even if the &lt;tt&gt;jcr:primaryType&lt;/tt&gt; property is not. So, with your setup &lt;tt&gt;Session.getNode(&quot;/node&quot;)&lt;/tt&gt; succeeds and I think so does  &lt;tt&gt;Session.getNode(&quot;/node&quot;).getPrimaryNodeType()&lt;/tt&gt;. but afaik &lt;tt&gt;Session.getNode(&quot;/node&quot;).getProperty(&quot;jcr:primaryType&quot;)&lt;/tt&gt; and &lt;tt&gt;Session.getProperty(&quot;/node/jcr:primaryType&quot;)&lt;/tt&gt; will fail because your test-session doesn&apos;t have the ability to read that property because of the &quot;&quot;-glob-restriction.&lt;/p&gt;

&lt;p&gt;what i didn&apos;t find out until now is where exactly the query engine misses (skips) the result and if it&apos;s really because of the primary-type property...the only thing i found was &lt;tt&gt;org.apache.jackrabbit.oak.query.index.FilterImpl.isAccessible(String path)&lt;/tt&gt; but somehow i never got there when debugging. that&apos;s what i will next (and reach out to the query team in case i get stuck)... more tomorrow.&lt;/p&gt;
</comment>
                            <comment id="16748668" author="anchela" created="Tue, 22 Jan 2019 12:22:03 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=snj&quot; class=&quot;user-hover&quot; rel=&quot;snj&quot;&gt;snj&lt;/a&gt;, discussed this with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thomasm&quot; class=&quot;user-hover&quot; rel=&quot;thomasm&quot;&gt;thomasm&lt;/a&gt; today and he told me that indeed &lt;tt&gt;org.apache.jackrabbit.oak.query.ast.SelectorImpl.evaluateTypeMatch&lt;/tt&gt; evaluates primary and mixin type information on the &lt;tt&gt;Tree&lt;/tt&gt; that has been obtained from the editing &lt;tt&gt;Root&lt;/tt&gt; and the path of the &lt;tt&gt;currentRow.getPath()&lt;/tt&gt;. What I also found in &lt;tt&gt;org.apache.jackrabbit.oak.query.ExecutionContext&lt;/tt&gt; is the following public method:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
/**
     * Used to evaluate the query (ie. read the existing node types, index
     * definitions), doesn&apos;t need to be a secured version of a node state
     * 
     * @&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; base state of the content tree against which the query runs.
     */
    @NotNull
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; NodeState getBaseState() {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; baseState;
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;But it seems that this base state (and the node states below that are target of the query) are not used for evaluation of the node type information. I will try to come up with a patch that allows the same logic to be applied both in &lt;tt&gt;NodeImpl&lt;/tt&gt; and &lt;tt&gt;SelectorImpl&lt;/tt&gt;, when it comes to reading node type names. Also I would try to write some additional tests that verifies that fix also covers queries that are run with an index (instead of the traversal as it is currently the case in the test patch) and queries that end up in the mixin-comparision.&lt;/p&gt;</comment>
                            <comment id="16748987" author="anchela" created="Tue, 22 Jan 2019 18:31:17 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thomasm&quot; class=&quot;user-hover&quot; rel=&quot;thomasm&quot;&gt;thomasm&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stillalex&quot; class=&quot;user-hover&quot; rel=&quot;stillalex&quot;&gt;stillalex&lt;/a&gt;, i attached the proposed patch including tests as &lt;em&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-7997&quot; title=&quot;Adding restrictions to ACLs yields empty results for queries in Jackrabbit Oak&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-7997&quot;&gt;&lt;del&gt;OAK-7997&lt;/del&gt;&lt;/a&gt;_2.patch&lt;/em&gt; for review. i extracted the logic from &lt;tt&gt;NodeImpl&lt;/tt&gt; to the &lt;tt&gt;TreeUtil&lt;/tt&gt; and refactored the primary/mixin loopup in &lt;tt&gt;SelectorImpl&lt;/tt&gt; accordingly. for the former I additionally move the &lt;tt&gt;LazyValue&lt;/tt&gt; utility from &lt;em&gt;oak-core&lt;/em&gt; to &lt;em&gt;oak-commons&lt;/em&gt;.&lt;/p&gt;</comment>
                            <comment id="16754813" author="alex.parvulescu" created="Tue, 29 Jan 2019 10:03:59 +0000"  >&lt;p&gt;Patch looks good to me.&lt;/p&gt;

&lt;p&gt;Some thoughts:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;I think the LazyValue refactoring is making the patch a lot harder to read&lt;/li&gt;
	&lt;li&gt;SelectorImpl#evaluateTypeMatch is calling getReadOnlyTree twice, I think you should be able to use the same variable to fully benefit the lazy init tree value&lt;/li&gt;
	&lt;li&gt;there&apos;s some subtle diffs between NodeImpl#getMixinTypeNames and SelectorImpl#evaluateTypeMatch (mixin bits) post refactoring. is that by design? (is NodeImpl&apos;s canReadMixinTypes relevant in the SelectorImpl&apos;s context? not sure)&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16758104" author="anchela" created="Fri, 1 Feb 2019 08:40:10 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stillalex&quot; class=&quot;user-hover&quot; rel=&quot;stillalex&quot;&gt;stillalex&lt;/a&gt;, i will track the &lt;tt&gt;LazyValue&lt;/tt&gt; refactoring with a separate issue before committing any changes (-&amp;gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-8018&quot; title=&quot;Move LazyValue from oak-core to oak-commons&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-8018&quot;&gt;&lt;del&gt;OAK-8018&lt;/del&gt;&lt;/a&gt;). &lt;br/&gt;
regarding the other findings:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;calling &lt;tt&gt;getReadOnlyTree&lt;/tt&gt; twice: i don&apos;t think it makes a difference but it makes the code more readable to get it once -&amp;gt; done&lt;/li&gt;
	&lt;li&gt;the &lt;tt&gt;canReadMixinTypes&lt;/tt&gt; is omitted on purpose in &lt;tt&gt;SelectorImpl&lt;/tt&gt; because i wanted the evaluation of matching node types to be independent of the access to &lt;em&gt;jcr:mixinTypes&lt;/em&gt;.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;next: will create a separate issue for the lazyvalue refactoring and update this patch afterwards (-&amp;gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-7997&quot; title=&quot;Adding restrictions to ACLs yields empty results for queries in Jackrabbit Oak&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-7997&quot;&gt;&lt;del&gt;OAK-7997&lt;/del&gt;&lt;/a&gt;_3.patch).&lt;/p&gt;</comment>
                            <comment id="16758191" author="anchela" created="Fri, 1 Feb 2019 10:32:56 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thomasm&quot; class=&quot;user-hover&quot; rel=&quot;thomasm&quot;&gt;thomasm&lt;/a&gt;, posted an updated patch addressing comments from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stillalex&quot; class=&quot;user-hover&quot; rel=&quot;stillalex&quot;&gt;stillalex&lt;/a&gt; (&lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-7997&quot; title=&quot;Adding restrictions to ACLs yields empty results for queries in Jackrabbit Oak&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-7997&quot;&gt;&lt;del&gt;OAK-7997&lt;/del&gt;&lt;/a&gt;_3.patch). Unless you have additional findings I would go ahead later today and commit the fix.&lt;/p&gt;</comment>
                            <comment id="16758311" author="alex.parvulescu" created="Fri, 1 Feb 2019 13:47:16 +0000"  >&lt;blockquote&gt;&lt;p&gt;calling getReadOnlyTree twice: i don&apos;t think it makes a difference but it makes the code more readable to get it once -&amp;gt; done&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;just for completeness, I reread the patch and you are right (you get the same &lt;tt&gt;lastReadOnlyTree&lt;/tt&gt;) &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16758480" author="anchela" created="Fri, 1 Feb 2019 16:33:54 +0000"  >&lt;p&gt;Committed revision 1852758.&lt;/p&gt;</comment>
                            <comment id="16759765" author="reschke" created="Mon, 4 Feb 2019 10:59:44 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=anchela&quot; class=&quot;user-hover&quot; rel=&quot;anchela&quot;&gt;anchela&lt;/a&gt; - does this need to be backported? ...asking because it introduced API changes...&lt;/p&gt;</comment>
                            <comment id="16760551" author="anchela" created="Tue, 5 Feb 2019 08:08:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=reschke&quot; class=&quot;user-hover&quot; rel=&quot;reschke&quot;&gt;reschke&lt;/a&gt;, i didn&apos;t intend to backport it. i don&apos;t consider this a critical bug and there are definitely ways to work around it (i.e. making sure that jcr:primaryType property is accessible).&lt;/p&gt;</comment>
                            <comment id="16760626" author="reschke" created="Tue, 5 Feb 2019 09:41:03 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=anchela&quot; class=&quot;user-hover&quot; rel=&quot;anchela&quot;&gt;anchela&lt;/a&gt; - ok - I was just a bit alarmed because it says &quot;major bug&quot;. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16760647" author="tmueller" created="Tue, 5 Feb 2019 09:54:36 +0000"  >&lt;p&gt;Reopening because some changes seem a bit risky to me (possibly a bug / hard to maintain). &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://svn.apache.org/viewvc/jackrabbit/oak/trunk/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/SelectorImpl.java?r1=1852758&amp;amp;r2=1852757&amp;amp;pathrev=1852758&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;SelectorImpl.java&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;+    private LazyValue&amp;lt;Tree&amp;gt; lastReadOnlyTree;
...
+    private LazyValue&amp;lt;Tree&amp;gt; getReadOnlyTree(@NotNull String path) {
+        if (lastReadOnlyTree == null) {
+            lastReadOnlyTree = new LazyValue&amp;lt;Tree&amp;gt;() {
+                @Override
+                protected Tree createValue() {
+                    return new ImmutableRoot(query.getExecutionContext().getBaseState()).getTree(path);
+                }
+            };
+        }
+        return lastReadOnlyTree;
+    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The lastReadOnlyTree is initialized lazily (which is fine), but how do we ensure that the path used to initialize it is the same if the method is called twice? I mean, if the method is called twice as follows, then the same LazyValue is returned:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;LazyValue&amp;lt;Tree&amp;gt; t1 = getReadOnlyTree(p1);
LazyValue&amp;lt;Tree&amp;gt; t2 = getReadOnlyTree(p2);
... now t1 == t2, even if p1 != p2 ...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;But maybe I just don&apos;t understand the logic... I didn&apos;t debug / test it.&lt;/p&gt;</comment>
                            <comment id="16760757" author="anchela" created="Tue, 5 Feb 2019 12:42:03 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thomasm&quot; class=&quot;user-hover&quot; rel=&quot;thomasm&quot;&gt;thomasm&lt;/a&gt;, i used the existing logic that is used in &lt;tt&gt;SelectorImpl&lt;/tt&gt; to retrieve the tree object. I had to read that one twice as well and found it a bit brittle but didn&apos;t want to start changing unrelated code that i don&apos;t own... instead attempted to incorporate the fix into the existing logic &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;. let me know if i should change the overall logic...&lt;/p&gt;</comment>
                            <comment id="16761570" author="anchela" created="Wed, 6 Feb 2019 08:23:35 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thomasm&quot; class=&quot;user-hover&quot; rel=&quot;thomasm&quot;&gt;thomasm&lt;/a&gt;, attached a patch for the &lt;tt&gt;SelectorImpl&lt;/tt&gt; refactoring the path/tree/readonly tree fields. feedback welcome.&lt;/p&gt;</comment>
                            <comment id="16761775" author="reschke" created="Wed, 6 Feb 2019 14:22:46 +0000"  >&lt;p&gt;I&apos;m not familiar with this part of the code, but it seems that &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thomasm&quot; class=&quot;user-hover&quot; rel=&quot;thomasm&quot;&gt;thomasm&lt;/a&gt; is right that this looks incorrect. The new patch seems to address the issue.&lt;/p&gt;</comment>
                            <comment id="16761886" author="anchela" created="Wed, 6 Feb 2019 16:05:26 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=reschke&quot; class=&quot;user-hover&quot; rel=&quot;reschke&quot;&gt;reschke&lt;/a&gt;, thanks for the review. Committed revision 1853085.&lt;/p&gt;</comment>
                            <comment id="16817780" author="edivad" created="Mon, 15 Apr 2019 09:20:02 +0000"  >&lt;p&gt;bulk close 1.12.0&lt;/p&gt;</comment>
                            <comment id="16988830" author="reschke" created="Thu, 5 Dec 2019 13:55:36 +0000"  >&lt;p&gt;trunk: (1.12.0) &lt;a href=&quot;http://svn.apache.org/r1853206&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;r1853206&lt;/a&gt; &lt;a href=&quot;http://svn.apache.org/r1853085&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;r1853085&lt;/a&gt; &lt;a href=&quot;http://svn.apache.org/r1852758&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;r1852758&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                                                <inwardlinks description="is blocked by">
                                        <issuelink>
            <issuekey id="13213259">OAK-8018</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12769289">OAK-2437</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12957732" name="OAK-7997-selectorimpl.patch" size="5799" author="angela" created="Wed, 6 Feb 2019 08:22:46 +0000"/>
                            <attachment id="12955671" name="OAK-7997.patch" size="8798" author="angela" created="Mon, 21 Jan 2019 15:43:14 +0000"/>
                            <attachment id="12955830" name="OAK-7997_2.patch" size="43580" author="angela" created="Tue, 22 Jan 2019 18:24:57 +0000"/>
                            <attachment id="12957240" name="OAK-7997_3.patch" size="37470" author="angela" created="Fri, 1 Feb 2019 10:30:47 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 49 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|yi04uo:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>