<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:47:48 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-2815] Persistent cache may block commit</title>
                <link>https://issues.apache.org/jira/browse/OAK-2815</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;The persistent cache may block a commit for a rather long time if the generation is switched during the commit. The default configuration tells the persistent cache to compact the store when it is closed. This is exactly what happens when a generation is switched.&lt;/p&gt;

&lt;p&gt;I think it would be best to disable compaction.&lt;/p&gt;

&lt;p&gt;I was able to reproduce it with the &lt;tt&gt;ContinuousRevisionGCTest&lt;/tt&gt; in oak-run with &lt;tt&gt;-DgarbageRatio=0.9&lt;/tt&gt;, but it probably also happens with the default garbage ratio of 0.5.&lt;/p&gt;

&lt;p&gt;Once the MVStore reaches 1GB, the console will show something like this:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Performed RevisionGC in 6.331 s (VersionGCStats{ignoredGCDueToCheckPoint=false, deletedDocGCCount=54054, splitDocGCCount=0, intermediateSplitDocGCCount=0, timeToCollectDeletedDocs=622.8 ms, timeTakenToDeleteDocs=5.708 s})
.................
Performed RevisionGC in 9.232 s (VersionGCStats{ignoredGCDueToCheckPoint=false, deletedDocGCCount=26026, splitDocGCCount=0, intermediateSplitDocGCCount=0, timeToCollectDeletedDocs=6.549 s, timeTakenToDeleteDocs=2.682 s})

Performed RevisionGC in 1.269 s (VersionGCStats{ignoredGCDueToCheckPoint=false, deletedDocGCCount=12012, splitDocGCCount=0, intermediateSplitDocGCCount=0, timeToCollectDeletedDocs=133.5 ms, timeTakenToDeleteDocs=1.134 s})

Performed RevisionGC in 20.49 ms (VersionGCStats{ignoredGCDueToCheckPoint=false, deletedDocGCCount=0, splitDocGCCount=0, intermediateSplitDocGCCount=0, timeToCollectDeletedDocs=19.50 ms, timeTakenToDeleteDocs=0.000 ns})
.15:19:16.682 [DocumentNodeStore background update thread] INFO  o.a.j.o.p.document.DocumentNodeStore - Background operations stats (clean:0, split:0, lock:35581, write:1, num:5)
............
Performed RevisionGC in 8.449 s (VersionGCStats{ignoredGCDueToCheckPoint=false, deletedDocGCCount=2002, splitDocGCCount=0, intermediateSplitDocGCCount=0, timeToCollectDeletedDocs=8.276 s, timeTakenToDeleteDocs=171.7 ms})
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The background update thread had to wait 35 seconds for the backgroundOperations lock, which was held by the committing thread:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;&quot;Thread-2&quot; prio=5 tid=0x00007f986b9a7800 nid=0x6803 runnable [0x0000000112780000]
   java.lang.Thread.State: RUNNABLE
	at org.h2.compress.CompressLZF.compress(CompressLZF.java:239)
	at org.h2.mvstore.Page.write(Page.java:754)
	at org.h2.mvstore.Page.writeUnsavedRecursive(Page.java:816)
	at org.h2.mvstore.Page.writeUnsavedRecursive(Page.java:822)
	at org.h2.mvstore.Page.writeUnsavedRecursive(Page.java:822)
	at org.h2.mvstore.MVStore.storeNowTry(MVStore.java:1065)
	at org.h2.mvstore.MVStore.storeNow(MVStore.java:981)
	at org.h2.mvstore.MVStore.commitAndSave(MVStore.java:970)
	- locked &amp;lt;0x00000007e15cccf0&amp;gt; (a org.h2.mvstore.MVStore)
	at org.h2.mvstore.MVStore.beforeWrite(MVStore.java:2084)
	at org.h2.mvstore.MVMap.beforeWrite(MVMap.java:1046)
	at org.h2.mvstore.MVMap.copy(MVMap.java:1231)
	at org.h2.mvstore.MVMap.copy(MVMap.java:1248)
	at org.h2.mvstore.MVMap.copy(MVMap.java:1248)
	at org.h2.mvstore.MVMap.copyFrom(MVMap.java:1218)
	at org.h2.mvstore.MVStoreTool.compact(MVStoreTool.java:493)
	at org.h2.mvstore.MVStoreTool.compact(MVStoreTool.java:458)
	at org.h2.mvstore.MVStoreTool.compact(MVStoreTool.java:404)
	at org.apache.jackrabbit.oak.plugins.document.persistentCache.PersistentCache$1.closeStore(PersistentCache.java:235)
	- locked &amp;lt;0x00000007c0c82760&amp;gt; (a org.apache.jackrabbit.oak.plugins.document.persistentCache.PersistentCache$1)
	at org.apache.jackrabbit.oak.plugins.document.persistentCache.PersistentCache.switchGenerationIfNeeded(PersistentCache.java:372)
	- locked &amp;lt;0x00000007c03a6c00&amp;gt; (a org.apache.jackrabbit.oak.plugins.document.persistentCache.PersistentCache)
	at org.apache.jackrabbit.oak.plugins.document.persistentCache.NodeCache.write(NodeCache.java:85)
	at org.apache.jackrabbit.oak.plugins.document.persistentCache.NodeCache.put(NodeCache.java:130)
	at org.apache.jackrabbit.oak.plugins.document.LocalDiffCache$1.done(LocalDiffCache.java:98)
	at org.apache.jackrabbit.oak.plugins.document.Commit.applyToCache(Commit.java:602)
	at org.apache.jackrabbit.oak.plugins.document.CommitQueue.afterTrunkCommit(CommitQueue.java:127)
	- locked &amp;lt;0x00000007c03a46f0&amp;gt; (a org.apache.jackrabbit.oak.plugins.document.CommitQueue)
	at org.apache.jackrabbit.oak.plugins.document.CommitQueue.done(CommitQueue.java:83)
	at org.apache.jackrabbit.oak.plugins.document.DocumentNodeStore.done(DocumentNodeStore.java:644)
	at org.apache.jackrabbit.oak.plugins.document.DocumentNodeStoreBranch.persist(DocumentNodeStoreBranch.java:338)
	at org.apache.jackrabbit.oak.plugins.document.DocumentNodeStoreBranch.persist(DocumentNodeStoreBranch.java:304)
	at org.apache.jackrabbit.oak.plugins.document.DocumentNodeStoreBranch.access$200(DocumentNodeStoreBranch.java:52)
	at org.apache.jackrabbit.oak.plugins.document.DocumentNodeStoreBranch$InMemory.merge(DocumentNodeStoreBranch.java:541)
	at org.apache.jackrabbit.oak.plugins.document.DocumentNodeStoreBranch.merge0(DocumentNodeStoreBranch.java:230)
	at org.apache.jackrabbit.oak.plugins.document.DocumentNodeStoreBranch.merge(DocumentNodeStoreBranch.java:171)
	at org.apache.jackrabbit.oak.plugins.document.DocumentRootBuilder.merge(DocumentRootBuilder.java:158)
	at org.apache.jackrabbit.oak.plugins.document.DocumentNodeStore.merge(DocumentNodeStore.java:1490)
	at org.apache.jackrabbit.oak.core.MutableRoot.commit(MutableRoot.java:247)
	at org.apache.jackrabbit.oak.jcr.delegate.SessionDelegate.commit(SessionDelegate.java:341)
	at org.apache.jackrabbit.oak.jcr.delegate.SessionDelegate.save(SessionDelegate.java:487)
	at org.apache.jackrabbit.oak.jcr.session.SessionImpl$8.performVoid(SessionImpl.java:424)
	at org.apache.jackrabbit.oak.jcr.delegate.SessionDelegate.performVoid(SessionDelegate.java:268)
	at org.apache.jackrabbit.oak.jcr.session.SessionImpl.save(SessionImpl.java:421)
	at org.apache.jackrabbit.oak.ContinuousRevisionGCTest$Writer.run(ContinuousRevisionGCTest.java:72)
	at java.lang.Thread.run(Thread.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12824271">OAK-2815</key>
            <summary>Persistent cache may block commit</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="thomasm">Thomas Mueller</assignee>
                                    <reporter username="mreutegg">Marcel Reutegger</reporter>
                        <labels>
                    </labels>
                <created>Mon, 27 Apr 2015 13:37:57 +0000</created>
                <updated>Tue, 8 Oct 2019 15:21:12 +0000</updated>
                            <resolved>Tue, 28 Apr 2015 09:00:01 +0000</resolved>
                                    <version>1.2</version>
                                    <fixVersion>1.0.14</fixVersion>
                    <fixVersion>1.2.2</fixVersion>
                    <fixVersion>1.3.0</fixVersion>
                    <fixVersion>1.4</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="14516548" author="mreutegg" created="Tue, 28 Apr 2015 07:00:40 +0000"  >&lt;p&gt;The attached patch changes the default for the &lt;tt&gt;compact&lt;/tt&gt; option to disabled. Disabling the (already disabled) feature in the configuration is still possible for backwards compatibility of existing configurations.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thomasm&quot; class=&quot;user-hover&quot; rel=&quot;thomasm&quot;&gt;thomasm&lt;/a&gt;, WDYT?&lt;/p&gt;</comment>
                            <comment id="14516562" author="tmueller" created="Tue, 28 Apr 2015 07:08:51 +0000"  >&lt;p&gt;Yes, it makes sense. I will test and then apply the patch, also for versions 1.2.2 and 1.0.14.&lt;/p&gt;</comment>
                            <comment id="14516618" author="mmarth" created="Tue, 28 Apr 2015 08:03:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thomasm&quot; class=&quot;user-hover&quot; rel=&quot;thomasm&quot;&gt;thomasm&lt;/a&gt;, would it be able to simply skip adding elements to the cache while the compaction is running? So that commits are not blocked. Would lead to some cache misses later, but might be a decent compromise. WDYT?&lt;/p&gt;</comment>
                            <comment id="14516656" author="tmueller" created="Tue, 28 Apr 2015 08:34:08 +0000"  >&lt;p&gt;&lt;a href=&quot;http://svn.apache.org/r1676423&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1676423&lt;/a&gt; (trunk)&lt;br/&gt;
&lt;a href=&quot;http://svn.apache.org/r1676437&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1676437&lt;/a&gt; (1.2 branch)&lt;/p&gt;</comment>
                            <comment id="14516664" author="tmueller" created="Tue, 28 Apr 2015 08:44:26 +0000"  >&lt;p&gt;&amp;gt; would it be able to simply skip adding elements to the cache while the compaction is running?&lt;/p&gt;

&lt;p&gt;This issue was found when switching the generation file, so the most urgent problem should be fixed.&lt;/p&gt;

&lt;p&gt;But yes, (if there is a lot to add) &lt;em&gt;not&lt;/em&gt; adding some entries is something I will investigate. Currently, in most cases, writing to the file happens in a background thread. However if there are many new revisions added in a short time, the writing happens in a foreground thread, to prevent out of memory.&lt;/p&gt;

&lt;p&gt;If we do skip entries, it would be best to skip those that are not important. We could use some heuristics, for example mainly skip those entries where a newer revision (of the same node) exists in the cache. Or skip those that were not requested often (measuring cache access count).&lt;/p&gt;</comment>
                            <comment id="14516681" author="tmueller" created="Tue, 28 Apr 2015 08:59:54 +0000"  >&lt;p&gt;&lt;a href=&quot;http://svn.apache.org/r1676450&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1676450&lt;/a&gt; (1.0 branch)&lt;/p&gt;</comment>
                            <comment id="14526351" author="mreutegg" created="Mon, 4 May 2015 07:23:30 +0000"  >&lt;p&gt;Bulk close for 1.2.2 release&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12770014">OAK-2444</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12820732">OAK-2761</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13113312">OAK-6887</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12728718" name="OAK-2815.patch" size="2074" author="mreutegg" created="Tue, 28 Apr 2015 07:00:40 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 28 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2dszz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>