<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:45:35 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-1768] DocumentNodeBuilder.setChildNode() runs OOM with large tree</title>
                <link>https://issues.apache.org/jira/browse/OAK-1768</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;This is a follow up issue for &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-1760&quot; title=&quot;RepositoryUpgrade leads to one large commit with DocumentNodeStore causing OOM&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-1760&quot;&gt;&lt;del&gt;OAK-1760&lt;/del&gt;&lt;/a&gt;. There we implemented a workaround in the upgrade code to prevent the OOME. For the 1.1 release we should implement a proper fix in the DocumentNodeStore as suggested by Jukka in &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-1760&quot; title=&quot;RepositoryUpgrade leads to one large commit with DocumentNodeStore causing OOM&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-1760&quot;&gt;&lt;del&gt;OAK-1760&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12710299">OAK-1768</key>
            <summary>DocumentNodeBuilder.setChildNode() runs OOM with large tree</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mreutegg">Marcel Reutegger</assignee>
                                    <reporter username="mreutegg">Marcel Reutegger</reporter>
                        <labels>
                    </labels>
                <created>Thu, 24 Apr 2014 12:44:03 +0000</created>
                <updated>Thu, 16 Jul 2015 08:33:04 +0000</updated>
                            <resolved>Thu, 25 Sep 2014 07:24:56 +0000</resolved>
                                    <version>1.0</version>
                                    <fixVersion>1.0.7</fixVersion>
                    <fixVersion>1.1.0</fixVersion>
                                    <component>core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13979922" author="jukkaz" created="Thu, 24 Apr 2014 16:33:06 +0000"  >&lt;p&gt;Attached a proposed patch based on earlier work in &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-1760&quot; title=&quot;RepositoryUpgrade leads to one large commit with DocumentNodeStore causing OOM&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-1760&quot;&gt;&lt;del&gt;OAK-1760&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;The &lt;tt&gt;NodeBuilder.setChildNode()&lt;/tt&gt; method is not very widely used so the impact of this change isn&apos;t very big. The original key use case for this method was moving and copying of subtrees, but nowadays we have separate mechanisms for those operations which leaves this method mostly used by lower-level updates in a few commit hooks.&lt;/p&gt;</comment>
                            <comment id="14126667" author="mreutegg" created="Tue, 9 Sep 2014 06:15:09 +0000"  >&lt;p&gt;The same issue happens when a large subtree is removed. The subtree is replaced with a MISSING_NODE and results in a single commit for the entire subtree.&lt;/p&gt;</comment>
                            <comment id="14127031" author="mreutegg" created="Tue, 9 Sep 2014 14:24:42 +0000"  >&lt;p&gt;Committed work in progress in &lt;a href=&quot;http://svn.apache.org/r1623827&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1623827&lt;/a&gt; &lt;/p&gt;

&lt;p&gt;remove() and setChildNode() are now applied recursively and leverage the MongoMK branch mechanism.&lt;/p&gt;

&lt;p&gt;The remaining problem is with tracking the affected paths of a branch commit. When a branch is merged, all documents for the affected paths of the merge must be updated and the _lastRev must be set to the merge commit revision. This is currently kept in memory within UnsavedModifications.&lt;/p&gt;</comment>
                            <comment id="14129806" author="mreutegg" created="Thu, 11 Sep 2014 09:07:53 +0000"  >&lt;p&gt;To tackle the remaining problem, I think we need to move more of the processing to MongoDB. So far we keep all affected paths of a branch in DocumentNodeStore. This is required because the _lastRev fields of all documents modified in a branch must be updated with the merge commit revision. At the moment this eventually happens with the background operation using UnsavedModifications with DocumentStore.update() calls. For large transactions there is not just a memory problem, but also the time to update the _lastRevs will take a long time with the current implementation. This will affect propagation of changes across cluster nodes, which is bad as well.&lt;/p&gt;

&lt;p&gt;The idea I have in mind is to make the _lastRevs update more intelligent for a branch merge. Instead of passing individual keys of documents to MongoDB to update the _lastRev, we could pass a list of branch commit revisions that identifies the documents to update. This reduces the required memory to track a branch in DocumentNodeStore significantly and would also speed up the background update.&lt;/p&gt;

&lt;p&gt;The tricky part is how to keep the existing branch checks in DocumentNodeStore and NodeDocument. It also not clear to me yet how to handle ancestors not directly affected by the branch commits. Let&apos;s say a huge tree is added unter /foo/bar/baz. A merge will have to update the _lastRev of /foo, /foo/bar and /foo/bar/baz as well even though they were not directly touched by the branch. I guess for those nodes we&apos;d still have to track the paths and _lastRevs as we do now.&lt;/p&gt;</comment>
                            <comment id="14133774" author="mreutegg" created="Mon, 15 Sep 2014 10:37:00 +0000"  >&lt;p&gt;Committed work in progress at &lt;a href=&quot;http://svn.apache.org/r1624993&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1624993&lt;/a&gt;&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Introduce different types of branch commits (regular and rebase commit) to reduce memory usage of a rebase&lt;/li&gt;
	&lt;li&gt;Better hide UnsavedModifications as an implementation detail&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14133951" author="mreutegg" created="Mon, 15 Sep 2014 14:32:12 +0000"  >&lt;p&gt;I think we can get rid of the requirement to update the _lastRevs of documents that were modified directly by a commit. For those updates the _lastRev can be calculated with the commit revision on the commit root document. This is either on the current document or the commit root document. The overhead shouldn&apos;t be too big, since we have to go through the most recent revisions anyway to read the node.&lt;/p&gt;

&lt;p&gt;This means we wouldn&apos;t have to track the _lastRevs of documents explicitly updated by the commit and only need to track _lastRev updates to ancestor documents that are not touched by the commit. This reduces the size of the UnsavedModifications significantly for cases where a large tree is added or removed. Another benefit is that we avoid redundancy. As mentioned already, in most cases the _lastRev can be calculated based on the changes on the document.&lt;/p&gt;</comment>
                            <comment id="14147511" author="mreutegg" created="Thu, 25 Sep 2014 07:24:56 +0000"  >&lt;p&gt;As a short term solution I implemented a fix that relies on MapDB and persists pending modification to the _lastRev fields to a temp file if there are too many. The fix can be disabled by setting the system property &lt;tt&gt;oak.useMemoryMapFactory&lt;/tt&gt; to true. This will revert back to the implementation that keeps the pending modifications in memory.&lt;/p&gt;

&lt;p&gt;I will open a separate issue for the remaining work to minimize the use of the _lastRev field.&lt;/p&gt;

&lt;p&gt;Fixed in trunk in &lt;a href=&quot;http://svn.apache.org/r1627470&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1627470&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14147580" author="mreutegg" created="Thu, 25 Sep 2014 09:35:40 +0000"  >&lt;p&gt;Merged into 1.0 branch in &lt;a href=&quot;http://svn.apache.org/r1627494&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1627494&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14148141" author="mreutegg" created="Thu, 25 Sep 2014 18:52:39 +0000"  >&lt;p&gt;Fixed a minor issue when the repository is shut down with a kill signal.&lt;/p&gt;

&lt;p&gt;In trunk &lt;a href=&quot;http://svn.apache.org/r1627586&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1627586&lt;/a&gt; and 1.0 branch &lt;a href=&quot;http://svn.apache.org/r1627588&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1627588&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14156165" author="mmarth" created="Thu, 2 Oct 2014 07:20:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mreutegg&quot; class=&quot;user-hover&quot; rel=&quot;mreutegg&quot;&gt;mreutegg&lt;/a&gt;, this fix did go into 1.0.6, right? (the fix version only has 1.1.0 right now)&lt;/p&gt;</comment>
                            <comment id="14156256" author="mreutegg" created="Thu, 2 Oct 2014 09:15:32 +0000"  >&lt;p&gt;The fix version should also include 1.0.7. Amit accidentally removed it when he released 1.1.0.&lt;/p&gt;</comment>
                            <comment id="14169126" author="mreutegg" created="Mon, 13 Oct 2014 09:20:44 +0000"  >&lt;p&gt;Bulk close for Oak 1.0.7&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12774656">OAK-2513</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12760146">OAK-2324</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12710003">OAK-1760</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12845515">OAK-3112</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12743958">OAK-2131</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12641747" name="0001-OAK-1768-DocumentNodeBuilder.setChildNode-runs-OOM-w.patch" size="6504" author="jukkaz" created="Thu, 24 Apr 2014 16:33:06 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>388621</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 5 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1uxyf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>388872</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>