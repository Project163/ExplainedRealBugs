<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:51:01 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-3683] BasicDocumentStore.testInterestingStrings failure on MongoDB with Java 8</title>
                <link>https://issues.apache.org/jira/browse/OAK-3683</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;On Java 8 only the following test fails:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Failed tests:   testInterestingStrings[MongoFixture: MongoDB](org.apache.jackrabbit.oak.plugins.document.BasicDocumentStoreTest): failure to round-trip brokensurrogate through MongoDB expected:&amp;lt;[?]&amp;gt; but was:&amp;lt;[&#65533;]&amp;gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;According to git bisect the commit which started showing this error was &lt;a href=&quot;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=r1715092&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;r1715092&lt;/a&gt;: &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-3651&quot; title=&quot;Remove HierarchicalCacheInvalidator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-3651&quot;&gt;&lt;del&gt;OAK-3651&lt;/del&gt;&lt;/a&gt; - Remove HierarchicalCacheInvalidator&lt;/p&gt;

&lt;p&gt;The command I used to run the tests was &lt;tt&gt;mvn -am -pl oak-core clean package -Dtest=BasicDocumentStoreTest -DfailIfNoTests=false&lt;/tt&gt;&lt;/p&gt;</description>
                <environment>&lt;p&gt;MongoDB 2.6.9, MongoDB 3.0.2&lt;br/&gt;
Java 8&lt;/p&gt;</environment>
        <key id="12916416">OAK-3683</key>
            <summary>BasicDocumentStore.testInterestingStrings failure on MongoDB with Java 8</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="rombert">Robert Munteanu</reporter>
                        <labels>
                    </labels>
                <created>Thu, 26 Nov 2015 11:20:22 +0000</created>
                <updated>Wed, 21 Feb 2018 16:54:19 +0000</updated>
                                            <version>1.0</version>
                    <version>1.2</version>
                    <version>1.4</version>
                                                    <component>mongomk</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15028590" author="chetanm" created="Thu, 26 Nov 2015 11:27:43 +0000"  >&lt;p&gt;Fails for me now also on Mongo 2.6.5 on JDK 8. Passes on JDK 7. So looks like JDK specific issue. But fails only for Mongo and passes for H2 and Memory&lt;/p&gt;</comment>
                            <comment id="15144245" author="reschke" created="Fri, 12 Feb 2016 08:08:35 +0000"  >&lt;p&gt;The test was added by me because I observed that MongoDB would roundtrip this, so (AFAIR) I had to do some extra work in RDBDocumentStore to make that happen as well (JSON serialization/deserialization).&lt;/p&gt;

&lt;p&gt;We could decide that we actually do not want to support that; in which case it would be good if all implementations rejected the value in the same way predictably.&lt;/p&gt;</comment>
                            <comment id="15309884" author="reschke" created="Wed, 1 Jun 2016 07:54:16 +0000"  >&lt;p&gt;The more people run this with JDK8, the more this will occur.&lt;/p&gt;

&lt;p&gt;My recommendation is to document that we do not support strings with broken surrogate pairs, and to actively reject them in all persistence implementations so that we have consistent behavior everywhere.&lt;/p&gt;</comment>
                            <comment id="15327275" author="reschke" created="Mon, 13 Jun 2016 12:40:42 +0000"  >&lt;p&gt;Likely caused by JDK change, see &amp;lt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-11165&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HADOOP-11165&lt;/a&gt;&amp;gt; for another victim. Seems we&apos;ll need to discuss the string property model and then make a decision that should apply to all storage backends.&lt;/p&gt;</comment>
                            <comment id="15344093" author="chetanm" created="Wed, 22 Jun 2016 10:36:23 +0000"  >&lt;p&gt;Some suggestion around supporting it with Mongo. Note that &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-4471&quot; title=&quot;More compact storage format for Documents&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-4471&quot;&gt;OAK-4471&lt;/a&gt; is somewhat related to discussion below&lt;/p&gt;

&lt;p&gt;&lt;b&gt;A - Save as Binary&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;Instead of persisting string values as string we can persist them in serialized form. So all property values would be stored as byte. &lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;Pros
	&lt;ol&gt;
		&lt;li&gt;We need not determine all problematic sequences and rely on the fact the Java String -&amp;gt; UTF-8 byte array -&amp;gt; Java String is always safe&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
	&lt;li&gt;Cons
	&lt;ol&gt;
		&lt;li&gt;Make the persisted document obscure i.e. looking at Mongo document it would not be possible to decipher the value. This can somewhat be addressed by providing some tooling but still would pose problem while analyzing data dumps via std tools like grep etc without doing any post processing&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&lt;b&gt;B - Save problematic values as base64 encoded byte array&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;Here we can modify the  &lt;tt&gt;JsonSerializer&lt;/tt&gt; to check if the value has such unicode sequence. If yes then instead of saving value as normal string value we first obtain a byte array with UTF-8 encoding and then save that in Base64 encoded format with some type hint (i.e. its encoded byte array). &lt;/p&gt;

&lt;p&gt;Then in &lt;tt&gt;DocumentPropertyState&lt;/tt&gt; if the value is found to be base64 encoded we do serialize it properly&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;Pros
	&lt;ol&gt;
		&lt;li&gt;Does not make documents obscure&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
	&lt;li&gt;Cons
	&lt;ol&gt;
		&lt;li&gt;Serialization logic would need to check in advance each value being serialized. We would need to see how much performance impact it would have. Note there is no adverse cost in read for normal string. If that becomes a concern we can fix that by having a new variant of the JsopBuilder#encode which also returns if the encoded string is &quot;safe&quot;. If it says safe then encoded value is directly passed to JsopBuilder otherwise we fallback to base64 encoded approach&lt;/li&gt;
		&lt;li&gt;We would need to know the sequence which can cause such problem and ensure all cases are covered&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;

</comment>
                            <comment id="15375247" author="mreutegg" created="Wed, 13 Jul 2016 15:55:02 +0000"  >&lt;p&gt;Disabled the test in trunk for the Java 8 &amp;amp; MongoDB combination: &lt;a href=&quot;http://svn.apache.org/r1752447&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1752447&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15376782" author="reschke" created="Thu, 14 Jul 2016 11:11:30 +0000"  >&lt;p&gt;trunk: &lt;a href=&quot;http://svn.apache.org/r1779478&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;r1779478&lt;/a&gt; &lt;a href=&quot;http://svn.apache.org/r1752616&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;r1752616&lt;/a&gt; &lt;a href=&quot;http://svn.apache.org/r1752447&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;r1752447&lt;/a&gt;&lt;br/&gt;
1.4: &lt;a href=&quot;http://svn.apache.org/r1779482&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;r1779482&lt;/a&gt; &lt;a href=&quot;http://svn.apache.org/r1752617&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;r1752617&lt;/a&gt;&lt;/p&gt;
</comment>
                            <comment id="15830040" author="reschke" created="Thu, 19 Jan 2017 14:36:27 +0000"  >&lt;p&gt;Related to Chetan&apos;s proposal: I think it would be much much simpler not to support these strings at all (and to reject them early).&lt;/p&gt;</comment>
                            <comment id="15830054" author="reschke" created="Thu, 19 Jan 2017 14:48:57 +0000"  >&lt;p&gt;See also: &lt;a href=&quot;https://jira.mongodb.org/browse/JAVA-1305&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://jira.mongodb.org/browse/JAVA-1305&lt;/a&gt; (unresolved)&lt;/p&gt;</comment>
                            <comment id="15830168" author="chetanm" created="Thu, 19 Jan 2017 16:15:29 +0000"  >&lt;blockquote&gt;&lt;p&gt;I think it would be much much simpler not to support these strings at all (and to reject them early).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Rejecting node names having such chars is probably ok. However rejecting property value does not look good. We should try to support storing any valid string as a property value&lt;/p&gt;</comment>
                            <comment id="15830212" author="reschke" created="Thu, 19 Jan 2017 16:32:30 +0000"  >&lt;p&gt;Why would we want to store a string that contains Unicode garbage?&lt;/p&gt;</comment>
                            <comment id="15831171" author="chetanm" created="Fri, 20 Jan 2017 04:21:28 +0000"  >&lt;p&gt;Okie did not realized that its for strings with broken surrogate pairs. If normal unicode strings work fine then yes it makes sense to reject such strings&lt;/p&gt;</comment>
                            <comment id="15831343" author="reschke" created="Fri, 20 Jan 2017 07:31:14 +0000"  >&lt;p&gt;Proposed next steps:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;add test coverage on the JCR layer&lt;/li&gt;
	&lt;li&gt;optionally reject broken strings early (for emergencies, we might want to add a system property to disable the check)&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16345195" author="mreutegg" created="Tue, 30 Jan 2018 15:14:23 +0000"  >&lt;p&gt;Also fails on 1.2 and 1.0 branch.&lt;/p&gt;</comment>
                            <comment id="16345223" author="mreutegg" created="Tue, 30 Jan 2018 15:27:52 +0000"  >&lt;p&gt;Merged test changes into branches:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;1.2: &lt;a href=&quot;http://svn.apache.org/r1822653&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1822653&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;1.0: &lt;a href=&quot;http://svn.apache.org/r1822655&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1822655&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13138129">OAK-7261</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13037368">OAK-5506</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 41 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2oz1r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>