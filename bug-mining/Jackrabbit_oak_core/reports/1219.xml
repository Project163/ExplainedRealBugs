<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:47:55 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-2933] AccessDenied when modifying transiently moved item with too many ACEs</title>
                <link>https://issues.apache.org/jira/browse/OAK-2933</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;If at least the following preconditions are fulfilled, saving a moved item fails with access denied:&lt;/p&gt;

&lt;p&gt;1. there are more PermissionEntries in the PermissionEntryCache than the configured EagerCacheSize&lt;br/&gt;
2. an node is moved to a location where the user has write access through a group membership&lt;br/&gt;
3. a property is added to the transiently moved item&lt;/p&gt;

&lt;p&gt;For example:&lt;br/&gt;
1. set the &lt;b&gt;eagerCacheSize&lt;/b&gt; to &apos;0&apos;&lt;br/&gt;
2. create new group &lt;b&gt;testgroup&lt;/b&gt; and user &lt;b&gt;testuser&lt;/b&gt;&lt;br/&gt;
3. make &lt;b&gt;testuser&lt;/b&gt; member of &lt;b&gt;testgroup&lt;/b&gt;&lt;br/&gt;
4. create nodes &lt;tt&gt;/testroot/a&lt;/tt&gt; and &lt;tt&gt;/testroot/a/b&lt;/tt&gt; and &lt;tt&gt;/testroot/a/c&lt;/tt&gt;&lt;br/&gt;
5. allow &lt;b&gt;testgroup&lt;/b&gt; &lt;tt&gt;rep:write&lt;/tt&gt; on &lt;tt&gt;/testroot/a&lt;/tt&gt;&lt;br/&gt;
6. as &lt;b&gt;testuser&lt;/b&gt; create &lt;tt&gt;/testroot/a/b/item&lt;/tt&gt; (to verify that the user has write access)&lt;br/&gt;
7. as &lt;b&gt;testuser&lt;/b&gt; move &lt;tt&gt;/testroot/a/b/item&lt;/tt&gt; to &lt;tt&gt;/testroot/a/c/item&lt;/tt&gt;&lt;br/&gt;
8. &lt;tt&gt;save()&lt;/tt&gt; -&amp;gt; works&lt;br/&gt;
9. as &lt;b&gt;testuser&lt;/b&gt; move &lt;tt&gt;/testroot/a/c/item&lt;/tt&gt; back to &lt;tt&gt;/testroot/a/b/item&lt;/tt&gt; AND add new property to the transient &lt;tt&gt;/testroot/a/b/item&lt;/tt&gt;&lt;br/&gt;
10. &lt;tt&gt;save()&lt;/tt&gt; -&amp;gt; access denied&lt;/p&gt;</description>
                <environment></environment>
        <key id="12833949">OAK-2933</key>
            <summary>AccessDenied when modifying transiently moved item with too many ACEs</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="angela">Angela Schreiber</assignee>
                                    <reporter username="tripod">Tobias Bocanegra</reporter>
                        <labels>
                    </labels>
                <created>Sat, 30 May 2015 05:46:54 +0000</created>
                <updated>Wed, 2 Mar 2016 11:28:48 +0000</updated>
                            <resolved>Tue, 2 Jun 2015 16:47:22 +0000</resolved>
                                    <version>1.0.13</version>
                                    <fixVersion>1.0.15</fixVersion>
                    <fixVersion>1.2.3</fixVersion>
                    <fixVersion>1.3.0</fixVersion>
                    <fixVersion>1.4</fixVersion>
                                    <component>core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="14567918" author="tripod" created="Mon, 1 Jun 2015 20:10:44 +0000"  >&lt;p&gt;this can be reproduced in oak-master by:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;setting the &lt;tt&gt;EAGER_CACHE_SIZE_PARAM&lt;/tt&gt; to 0 (or by manually set the maxSize to 0 in &lt;tt&gt;org.apache.jackrabbit.oak.security.authorization.permission.PermissionEntryProviderImpl#PermissionEntryProviderImpl&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;executing org.apache.jackrabbit.oak.jcr.security.authorization.SessionMoveTest#testMoveAndAddProperty2&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;(Note: what is the correct way to execute the JCR tests with different repository configurations?)&lt;/p&gt;</comment>
                            <comment id="14568034" author="tripod" created="Mon, 1 Jun 2015 21:20:26 +0000"  >&lt;p&gt;the problem happens in the &lt;tt&gt;PermissionValidator#checkPermissions(ImmutableTree, PropertyState, long)&lt;/tt&gt; where it checks the permission for the added property:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;     isGranted = parentPermission.isGranted(toTest, property);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;the parentPermission still holds the source tree &lt;tt&gt;/testroot/node1/node2/node3&lt;/tt&gt; which does not have add-property permissions. I think MoveAwarePermissionValidator needs to know the parentPermission of the before and after trees.&lt;/p&gt;

&lt;p&gt;The MoveAwarePermissionValidator is broken such as it does not use the correct TreePermissions.&lt;/p&gt;

&lt;p&gt;The PermissionEntryProviderImpl with cache works, because it can lookup the entries in the wrong tree. i.e. the validator checks of add_property on &lt;tt&gt;/testroot/node1/node2/node3&lt;/tt&gt; instead of &lt;tt&gt;/testroot/node2/destination&lt;/tt&gt;. coincidentally, &lt;tt&gt;/testroot/node1&lt;/tt&gt; has a rep:write but the source tree is only partially loaded, for example a &lt;tt&gt;/testroot/node1.hasChild(REP_POLICY)&lt;/tt&gt; fails.&lt;/p&gt;

&lt;p&gt;i.e the changing the following works:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;@@ -134,9 +136,7 @@ &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;PermissionEntryProviderImpl &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; PermissionEntryProvider {
             Collection&amp;lt;PermissionEntry&amp;gt; entries = pathEntryMap.get(accessControlledTree.getPath());
             &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; (entries != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) ? entries : Collections.&amp;lt;PermissionEntry&amp;gt;emptyList();
         } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
-            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; (accessControlledTree.hasChild(AccessControlConstants.REP_POLICY)) ?
-                    loadEntries(accessControlledTree.getPath()) :
-                    Collections.&amp;lt;PermissionEntry&amp;gt;emptyList();
+            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; loadEntries(accessControlledTree.getPath());
         }
     }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</comment>
                            <comment id="14568709" author="anchela" created="Tue, 2 Jun 2015 07:40:28 +0000"  >&lt;p&gt;i will look into this... my gut feeling is that it&apos;s rather a issue with the &lt;tt&gt;MoveAwarePermissionValidator&lt;/tt&gt; than with the cache.&lt;/p&gt;</comment>
                            <comment id="14569131" author="anchela" created="Tue, 2 Jun 2015 14:03:14 +0000"  >&lt;p&gt;in order to reproduce the behavior i set the eager-cache-size to 0 in &lt;tt&gt;PermissionEntryProviderImpl&lt;/tt&gt; and run &lt;tt&gt;SessionMoveTest&lt;/tt&gt;. Looking at the tests that failed in this case and debugging the permission evaluation I found that &lt;tt&gt;MoveAwarePermissionValidator#visibleValidator&lt;/tt&gt; is effectively generating empty immutable trees and that are not backed by an &lt;tt&gt;NodeState&lt;/tt&gt; because I forgot to reset the parent object while traversing from the &lt;tt&gt;beforeRoot&lt;/tt&gt;. Consequently the &lt;tt&gt;TreePermission&lt;/tt&gt; objects didn&apos;t have a tree associated that contains any data and would therefore just look at the permission present at the root (unless there is a cache entry).&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tripod&quot; class=&quot;user-hover&quot; rel=&quot;tripod&quot;&gt;tripod&lt;/a&gt;, may I kindly ask you to look at the proposed patch. I run the complete build with both cache-size set to 0 and the default value. So, that seems to be at least one piece in the problem... at least a obvious bug that seems trivial to fix.&lt;/p&gt;</comment>
                            <comment id="14569207" author="anchela" created="Tue, 2 Jun 2015 14:53:47 +0000"  >&lt;p&gt;simple test-case illustrating the problem using Oak-API by setting the cache-size to 0 in the Oak-repo setup.&lt;/p&gt;

&lt;p&gt;Note: in general it would be preferable to just run all permission-evaluation tests present with oak-jcr module with and without the cache. not sure how we could easily get there... for the time being just running 2 failing tests against oak-api directly.&lt;/p&gt;</comment>
                            <comment id="14569409" author="tripod" created="Tue, 2 Jun 2015 16:47:22 +0000"  >&lt;p&gt;fixed in r1683133 (trunk), r1683142 (1.0), r1683143 (1.2)&lt;/p&gt;</comment>
                            <comment id="14585977" author="edivad" created="Mon, 15 Jun 2015 13:45:22 +0000"  >&lt;p&gt;Bulk Close for 1.3.0&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12736843" name="OAK-2933.patch" size="1668" author="angela" created="Tue, 2 Jun 2015 14:03:14 +0000"/>
                            <attachment id="12736859" name="OAK-2933_test.patch" size="4462" author="angela" created="Tue, 2 Jun 2015 14:53:47 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 22 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2fepb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>