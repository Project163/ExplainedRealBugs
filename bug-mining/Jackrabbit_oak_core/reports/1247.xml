<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:48:15 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-3103] Stale document in MongoDocumentStore cache</title>
                <link>https://issues.apache.org/jira/browse/OAK-3103</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;In some rare cases it may happen that a stale document is put into the MongoDocumentStore cache.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12845194">OAK-3103</key>
            <summary>Stale document in MongoDocumentStore cache</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mreutegg">Marcel Reutegger</assignee>
                                    <reporter username="mreutegg">Marcel Reutegger</reporter>
                        <labels>
                    </labels>
                <created>Wed, 15 Jul 2015 07:13:50 +0000</created>
                <updated>Wed, 1 Jun 2016 13:09:04 +0000</updated>
                            <resolved>Tue, 21 Jul 2015 08:24:52 +0000</resolved>
                                    <version>1.0.17</version>
                    <version>1.2.2</version>
                    <version>1.3.3</version>
                                    <fixVersion>1.0.18</fixVersion>
                    <fixVersion>1.2.3</fixVersion>
                    <fixVersion>1.3.4</fixVersion>
                    <fixVersion>1.4</fixVersion>
                                    <component>core</component>
                    <component>mongomk</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14627701" author="mreutegg" created="Wed, 15 Jul 2015 08:10:57 +0000"  >&lt;p&gt;Added a test (currently ignored). It fails most of the time, but sometimes it even passes all 10 iterations within the test loop.&lt;/p&gt;

&lt;p&gt;In trunk: &lt;a href=&quot;http://svn.apache.org/r1691139&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1691139&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14627707" author="mreutegg" created="Wed, 15 Jul 2015 08:17:43 +0000"  >&lt;p&gt;The issue is with &lt;tt&gt;MongoDocumentStore.applyToCache()&lt;/tt&gt; called by the &lt;tt&gt;update()&lt;/tt&gt; method. Before the actual update call to MongoDB, &lt;tt&gt;update()&lt;/tt&gt; remembers all cached documents it wants to update. After the update it calls &lt;tt&gt;applyToCache()&lt;/tt&gt; for each document it saw in the cache while holding the lock for the document id. The lock makes sure it is the only thread working on the cache for the given id. In &lt;tt&gt;applyToCache()&lt;/tt&gt; it checks if the document is still in the cache. If it is not there, the cache cannot be re-populated with the cached document before the update call and the UpdateOp applied. The document could have been modified by another thread in the meantime. If the document is still cached, &lt;tt&gt;applyToCache()&lt;/tt&gt; will create a new document, based on the cached document, apply the UpdateOp and then make an attempt to &lt;a href=&quot;https://github.com/apache/jackrabbit-oak/blob/jackrabbit-oak-1.0.17/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/mongo/MongoDocumentStore.java#L1078&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;add it to the cache if it is not present&lt;/a&gt;. This is where a race condition occurs. The cached document may disappear from the cache even though the current thread holds the lock for the document id. The cache implementation may evict the document because other reads occur in the meantime. As a result &lt;tt&gt;applyToCache()&lt;/tt&gt; may put a potentially outdated document into the cache.&lt;/p&gt;</comment>
                            <comment id="14627835" author="mreutegg" created="Wed, 15 Jul 2015 10:00:40 +0000"  >&lt;p&gt;Changed MongoDocumentStore to perform an update instead of findAndModify for a conditional update and unconditionally put the document into the cache if the before document is known. This makes the test fail more likely.&lt;/p&gt;

&lt;p&gt;Done in trunk: &lt;a href=&quot;http://svn.apache.org/r1691159&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1691159&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14627955" author="mreutegg" created="Wed, 15 Jul 2015 12:17:06 +0000"  >&lt;p&gt;Fix implemented in trunk and test enabled: &lt;a href=&quot;http://svn.apache.org/r1691188&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1691188&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I renamed &lt;tt&gt;applyToCache()&lt;/tt&gt; to &lt;tt&gt;updateCache()&lt;/tt&gt; and simplified it. The method now only deals with cache updates when a caller has a previously cached document (&lt;tt&gt;oldDoc&lt;/tt&gt; must be non-null now).&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chetanm&quot; class=&quot;user-hover&quot; rel=&quot;chetanm&quot;&gt;chetanm&lt;/a&gt;, can you please review?&lt;/p&gt;</comment>
                            <comment id="14633245" author="chetanm" created="Mon, 20 Jul 2015 09:52:56 +0000"  >&lt;p&gt;After offline discussion with Marcel got better understanding of the fix. So +1&lt;/p&gt;

&lt;p&gt;For my memory - Key change here is that with new logic call to &lt;tt&gt;addToCache&lt;/tt&gt; is not performed in &lt;tt&gt;update&lt;/tt&gt; flow. &lt;tt&gt;addToCache&lt;/tt&gt; is susceptible to potential race condition (which Marcel explained above) and is only safe to be called in case of new document insert as it does not check for modCount constrained when inserting an entry to the cache and further does the operation without holding any lock. With fix the call would end up in &lt;tt&gt;updateCache&lt;/tt&gt; method which only updates the cache if any only if modCount matches!&lt;/p&gt;</comment>
                            <comment id="14634758" author="mreutegg" created="Tue, 21 Jul 2015 08:24:52 +0000"  >&lt;p&gt;Thanks for the review.&lt;/p&gt;

&lt;p&gt;Merged into 1.2 branch: &lt;a href=&quot;http://svn.apache.org/r1691949&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1691949&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;and 1.0 branch: &lt;a href=&quot;http://svn.apache.org/r1691938&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1691938&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14640494" author="edivad" created="Fri, 24 Jul 2015 14:15:27 +0000"  >&lt;p&gt;Bulk closing for 1.2.3&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12912870">OAK-3634</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12914801">OAK-3659</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 17 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2h9t3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>