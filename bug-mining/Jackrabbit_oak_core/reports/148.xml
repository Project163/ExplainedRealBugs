<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:36:00 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-410] RepositoryInitializer runs before the CommitHooks are in place</title>
                <link>https://issues.apache.org/jira/browse/OAK-410</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;The InitialContent installs a bunch of content nodes before the CommitHooks are enabled.&lt;/p&gt;

&lt;p&gt;This hurts the query indexes as they don&apos;t get notified about the initial content and cannot index/process it.&lt;br/&gt;
I&apos;m mostly referring to the Auth stuff that relies on a combo of initial content &amp;amp; queries.&lt;br/&gt;
Luckily when using the PropertyIndex it does fallback to full repository traversal, which works (albeit slowly). Unfortunately I can&apos;t say the same for the lucene index).&lt;/p&gt;


&lt;p&gt;A bit of context here &lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt;.&lt;/p&gt;


&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-403?focusedCommentId=13486763&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13486763&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/OAK-403?focusedCommentId=13486763&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13486763&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12614044">OAK-410</key>
            <summary>RepositoryInitializer runs before the CommitHooks are in place</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="stillalex">Alex Deparvu</assignee>
                                    <reporter username="stillalex">Alex Deparvu</reporter>
                        <labels>
                    </labels>
                <created>Tue, 30 Oct 2012 16:16:47 +0000</created>
                <updated>Tue, 21 May 2013 11:26:17 +0000</updated>
                            <resolved>Wed, 13 Feb 2013 09:32:49 +0000</resolved>
                                                    <fixVersion>0.7</fixVersion>
                                    <component>core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13497897" author="alex.parvulescu" created="Thu, 15 Nov 2012 10:11:14 +0000"  >&lt;p&gt;Attaching a proposed patch that triggers a reindex on the initial repo content, just before the validators&amp;amp;commit hooks are in place.&lt;/p&gt;

&lt;p&gt;It&apos;s not the best solution, maybe this can help start a conversation about how we can fix this issue.&lt;br/&gt;
With this in place we can even remove the &quot;reindex, true&quot; properties on the index definitions.&lt;/p&gt;

&lt;p&gt;Again the purpose of this is to have the initial content indexed so that the query engine can leverage defined indexes from the very beginning.&lt;/p&gt;

</comment>
                            <comment id="13500975" author="jukkaz" created="Tue, 20 Nov 2012 10:34:33 +0000"  >&lt;p&gt;Attached an alternative patch that uses the initializer itself to invoke the required index hooks. That way we can do the initial indexing as a part of the original commit instead of needing a separate reindex commit.&lt;/p&gt;</comment>
                            <comment id="13500982" author="alex.parvulescu" created="Tue, 20 Nov 2012 10:43:58 +0000"  >&lt;p&gt;wow, that is way too much oak kungfu for me &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;+1 on the patch&lt;/p&gt;</comment>
                            <comment id="13501121" author="jukkaz" created="Tue, 20 Nov 2012 11:40:15 +0000"  >&lt;p&gt;Patch committed in revision 1411623.&lt;/p&gt;</comment>
                            <comment id="13501168" author="alex.parvulescu" created="Tue, 20 Nov 2012 13:09:36 +0000"  >&lt;p&gt;It seems that we might have forgotten something.&lt;br/&gt;
The current version forces the reindex on the content added by the &lt;tt&gt;InitialContent&lt;/tt&gt;. The problem is it misses the other registered {{RepositoryInitializer}}s, like the ones that come from the security code that add the &quot;admin&quot;&amp;amp;friends users.&lt;br/&gt;
So the index will not be aware of the users, and that was the reason I wanted this code in, in the first place &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13501283" author="anchela" created="Tue, 20 Nov 2012 16:30:33 +0000"  >&lt;p&gt;i have the impression that fix broke the build... reopening.&lt;br/&gt;
for the time being i took the liberty to reverted 1411623 in revision 1411731.&lt;/p&gt;</comment>
                            <comment id="13501285" author="jukkaz" created="Tue, 20 Nov 2012 16:35:52 +0000"  >&lt;p&gt;Oops, I thought I reverted the change already but apparently forgot to commit it before being dragged to another issue. Apologies, and thanks for covering up!&lt;/p&gt;</comment>
                            <comment id="13501814" author="alex.parvulescu" created="Wed, 21 Nov 2012 09:57:54 +0000"  >&lt;p&gt;proposed patch.&lt;/p&gt;

&lt;p&gt;I&apos;ve added a new class &lt;tt&gt;OakInitializer&lt;/tt&gt; that handles the #initialize call and then the reindex.&lt;/p&gt;

&lt;p&gt;A further improvement is to merge all the #initialize calls on a single branch together with the index call. Unfortunately this is not possible now, not all the initializers can be easily refactored.&lt;br/&gt;
This improvement should be tracked separately and remains marked as a todo in the class.&lt;/p&gt;

&lt;p&gt;Another problem is the osgi init of the initializers, marked as a todo in the &lt;tt&gt;OsgiRepositoryInitializer&lt;/tt&gt; class.&lt;br/&gt;
I&apos;d like to get a reference to the current &lt;tt&gt;OsgiRepositoryInitializer&lt;/tt&gt; via the osgi mechanism and use OakInitializer to run the #initialize call.&lt;/p&gt;

&lt;p&gt;I&apos;ve also hidden &lt;tt&gt;IndexHookManager&lt;/tt&gt;&apos;s constructor to easily track down the references to it. Following the refactoring introduced by this patch, the class should rarely be used directly, everything should pass by the &lt;tt&gt;Oak#add&lt;/tt&gt; methods.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;edit&amp;#93;&lt;/span&gt; added in the &lt;tt&gt;IndexHookManager&lt;/tt&gt; bit.&lt;/p&gt;</comment>
                            <comment id="13501853" author="jukkaz" created="Wed, 21 Nov 2012 10:54:16 +0000"  >&lt;p&gt;+1 Looks good, let&apos;s start with that.&lt;/p&gt;

&lt;p&gt;I like the idea of using a branch for the initialization, and wonder if we could go even a bit further by turning the initializer into:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;interface&lt;/span&gt; RepositoryInitializer {
    NodeState initialize(NodeState state);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Things like the security initializers that depend on higher level APIs could still construct a MemoryNodeStore starting from the given base state and use that to build the returned state.&lt;/p&gt;</comment>
                            <comment id="13502675" author="alex.parvulescu" created="Thu, 22 Nov 2012 09:39:23 +0000"  >&lt;p&gt;applied the v3 patch with revision 1412468.&lt;/p&gt;</comment>
                            <comment id="13502678" author="alex.parvulescu" created="Thu, 22 Nov 2012 09:44:51 +0000"  >&lt;p&gt;attaching a tentative v4.&lt;/p&gt;

&lt;p&gt;warning: not everything compiles after applying the patch. It&apos;s just to get a feel of what the problems are if we try to further refactor the initializers.&lt;/p&gt;

&lt;p&gt;Passing a &lt;tt&gt;NodeState&lt;/tt&gt; around yields the following issues (as seen in the patch):&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;tt&gt;InitialContent&lt;/tt&gt; - not the only class that need to operate changes on a &lt;tt&gt;Root&lt;/tt&gt;: the approach was to create a MemoryNodeStore as suggested by Jukka, but that looks a bit convoluted for my taste.&lt;br/&gt;
Nevertheless it works, feedback appreciated.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;tt&gt;OsgiRepositoryInitializer&lt;/tt&gt; overall I&apos;m not sure keeping a reference to a NodeState that is stateless is the best way, but it is doable.&lt;br/&gt;
the problem is in the &lt;tt&gt;#addingService&lt;/tt&gt; method, how do we actually add the content, seeing as the &lt;tt&gt;NodeState&lt;/tt&gt; is stateless? and then index it?&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13559526" author="alex.parvulescu" created="Tue, 22 Jan 2013 10:02:25 +0000"  >&lt;p&gt;As it turns out this also affects the repository startup phase, as currently the indexer will try to reindex all of the existing content on each restart &lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt;.&lt;/p&gt;

&lt;p&gt;Attaching v5 of the patch.&lt;br/&gt;
I managed to iron out all the quirks using Jukka&apos;s suggestion, except the osgi parts.&lt;br/&gt;
The code works, tests pass, but probably we&apos;ll need to refactor the Activator bits some more.&lt;/p&gt;

&lt;p&gt;Feedback is very much needed!&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt; &lt;a href=&quot;http://markmail.org/message/ktz63uxaccdzlbk7&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://markmail.org/message/ktz63uxaccdzlbk7&lt;/a&gt;&lt;/p&gt;
</comment>
                            <comment id="13559534" author="anchela" created="Tue, 22 Jan 2013 10:28:06 +0000"  >&lt;p&gt;linking to &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-570&quot; title=&quot;Move user mgt related index definitions to security/user &quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-570&quot;&gt;&lt;del&gt;OAK-570&lt;/del&gt;&lt;/a&gt;: currently the user related index definitions are still in InitialContent, which is obviously&lt;br/&gt;
wrong as they are an implementation detail&lt;/p&gt;</comment>
                            <comment id="13560506" author="alex.parvulescu" created="Wed, 23 Jan 2013 09:22:58 +0000"  >&lt;p&gt;v5 has some merge errors now, so I&apos;ve created v6 with some tweaks so it still applies against trunk.&lt;/p&gt;</comment>
                            <comment id="13577436" author="alex.parvulescu" created="Wed, 13 Feb 2013 09:32:49 +0000"  >&lt;p&gt;fixed with rev 1445518.&lt;/p&gt;

&lt;p&gt;The osgi init part is not top shape, it will probably be revisited soon, but that will be a different topic.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12628243">OAK-570</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                                                <inwardlinks description="is depended upon by">
                                        <issuelink>
            <issuekey id="12615859">OAK-443</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12616911">OAK-456</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12554326" name="0001-OAK-410-RepositoryInitializer-runs-before-the-Commit.patch" size="2704" author="jukkaz" created="Tue, 20 Nov 2012 10:34:33 +0000"/>
                            <attachment id="12554476" name="OAK-410-v3.patch" size="18948" author="stillalex" created="Wed, 21 Nov 2012 09:57:54 +0000"/>
                            <attachment id="12554658" name="OAK-410-v4-tentative.patch" size="8430" author="stillalex" created="Thu, 22 Nov 2012 09:44:51 +0000"/>
                            <attachment id="12565927" name="OAK-410-v5.patch" size="24932" author="stillalex" created="Tue, 22 Jan 2013 10:02:25 +0000"/>
                            <attachment id="12566111" name="OAK-410-v6.patch" size="25009" author="stillalex" created="Wed, 23 Jan 2013 09:22:58 +0000"/>
                            <attachment id="12553644" name="OAK-410.patch" size="2760" author="stillalex" created="Thu, 15 Nov 2012 10:11:14 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>253168</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 40 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0dc6f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>75902</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>