<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:45:09 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-1926] UnmergedBranch state growing with empty BranchCommit leading to performance degradation</title>
                <link>https://issues.apache.org/jira/browse/OAK-1926</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;In some cluster deployment cases it has been seen that in memory state of UnmergedBranches contains large number of empty commits. For e.g. in  one of of the runs there were 750 entries in the UnmergedBranches and each Branch had empty branch commits.&lt;/p&gt;

&lt;p&gt;If there are large number of UnmergedBranches then read performance would degrade as for determining revision validity currently logic scans all branches&lt;/p&gt;

&lt;p&gt;Below is some part of UnmergedBranch state&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Branch 1
1 -&amp;gt; br146d2edb7a7-0-1 (true) (revision: &quot;br146d2edb7a7-0-1&quot;, clusterId: 1, time: &quot;2014-06-25 05:08:52.903&quot;, branch: true)
2 -&amp;gt; br146d2f0450b-0-1 (true) (revision: &quot;br146d2f0450b-0-1&quot;, clusterId: 1, time: &quot;2014-06-25 05:11:40.171&quot;, branch: true)
Branch 2
1 -&amp;gt; br146d2ef1d08-0-1 (true) (revision: &quot;br146d2ef1d08-0-1&quot;, clusterId: 1, time: &quot;2014-06-25 05:10:24.392&quot;, branch: true)
Branch 3
1 -&amp;gt; br146d2ed26ca-0-1 (true) (revision: &quot;br146d2ed26ca-0-1&quot;, clusterId: 1, time: &quot;2014-06-25 05:08:15.818&quot;, branch: true)
2 -&amp;gt; br146d2edfd0e-0-1 (true) (revision: &quot;br146d2edfd0e-0-1&quot;, clusterId: 1, time: &quot;2014-06-25 05:09:10.670&quot;, branch: true)
Branch 4
1 -&amp;gt; br146d2ecd85b-0-1 (true) (revision: &quot;br146d2ecd85b-0-1&quot;, clusterId: 1, time: &quot;2014-06-25 05:07:55.739&quot;, branch: true)
Branch 5
1 -&amp;gt; br146d2ec21a0-0-1 (true) (revision: &quot;br146d2ec21a0-0-1&quot;, clusterId: 1, time: &quot;2014-06-25 05:07:08.960&quot;, branch: true)
2 -&amp;gt; br146d2ec8eca-0-1 (true) (revision: &quot;br146d2ec8eca-0-1&quot;, clusterId: 1, time: &quot;2014-06-25 05:07:36.906&quot;, branch: true)
Branch 6
1 -&amp;gt; br146d2eaf159-1-1 (true) (revision: &quot;br146d2eaf159-1-1&quot;, clusterId: 1, time: &quot;2014-06-25 05:05:51.065&quot;, counter: 1, branch: true)
Branch 7
1 -&amp;gt; br146d2e9a513-0-1 (true) (revision: &quot;br146d2e9a513-0-1&quot;, clusterId: 1, time: &quot;2014-06-25 05:04:26.003&quot;, branch: true)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mreutegg&quot; class=&quot;user-hover&quot; rel=&quot;mreutegg&quot;&gt;mreutegg&lt;/a&gt; Suggested that these branch might be for those revision which have resulted in a collision and upon checking it indeed appears to be the case  (value true in brackets above indicate that). Further given the age of such revision it looks like they get populated upon startup itself&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Fix&lt;/b&gt;&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Need to check why we need to populate the UnermgedBranch&lt;/li&gt;
	&lt;li&gt;Possibly implement some purge job which would remove such stale entries&lt;/li&gt;
&lt;/ul&gt;

</description>
                <environment></environment>
        <key id="12724406">OAK-1926</key>
            <summary>UnmergedBranch state growing with empty BranchCommit leading to performance degradation</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="chetanm">Chetan Mehrotra</assignee>
                                    <reporter username="chetanm">Chetan Mehrotra</reporter>
                        <labels>
                    </labels>
                <created>Mon, 30 Jun 2014 09:49:13 +0000</created>
                <updated>Wed, 1 Oct 2014 13:07:57 +0000</updated>
                            <resolved>Thu, 31 Jul 2014 08:37:34 +0000</resolved>
                                    <version>1.0.1</version>
                                    <fixVersion>1.0.4</fixVersion>
                    <fixVersion>1.1.0</fixVersion>
                                    <component>mongomk</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14048798" author="mreutegg" created="Tue, 1 Jul 2014 12:09:25 +0000"  >&lt;blockquote&gt;&lt;p&gt;Need to check why we need to populate the UnermgedBranch&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;AFAIR some logic in NodeDocument relies on this at the moment. We need to review includeRevision() and isCommitted(), but I think this can be changed quite easily.&lt;/p&gt;</comment>
                            <comment id="14071411" author="chetanm" created="Wed, 23 Jul 2014 06:28:43 +0000"  >&lt;p&gt;Following notes are are based on  a discussion with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mreutegg&quot; class=&quot;user-hover&quot; rel=&quot;mreutegg&quot;&gt;mreutegg&lt;/a&gt; on this issue&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;DocumentNodeStore needs to keep track of UnmergedBranches to distinguish revisions which are part of a branch&lt;/li&gt;
	&lt;li&gt;If a process terminates with some pending UnmergedBranches then those branch info remain present in root document revision map and can only be removed if we do a garbage collection and remove all commits which were part of those branches. Without that we need to maintain the in memory state&lt;/li&gt;
	&lt;li&gt;Loading of unmerged branch was done in &lt;a href=&quot;http://svn.apache.org/viewvc/jackrabbit/oak/trunk/oak-mongomk/src/main/java/org/apache/jackrabbit/mongomk/prototype/MongoMK.java?r1=1461193&amp;amp;r2=1461192&amp;amp;pathrev=1461193&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;1461193&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;Currently there are following problems wrt unmerged branches
	&lt;ul&gt;
		&lt;li&gt;A - Check for revision being part of branch is costly - The way check is currently implemented does not distinguish between in memory alive branches and persisted unmerged branches. To simplify the check we distinguish between the two types and for persisted unmerged branch we keep a set of such rev and first do a lookup there to confirm if rev is part of unmerged branch before doing actual check&lt;/li&gt;
		&lt;li&gt;B - Tracking of branches which are not merged - An unmerged branch state would be persisted in two cases
		&lt;ul&gt;
			&lt;li&gt;Client did not merged the branch - In this case we can somehow figure out that a branch has gone out of scope (possibly via WekReference on DocumentNodeStoreBranch) and would not be merged. In such a case we know the commits done in that branch and perform a cleanup&lt;/li&gt;
			&lt;li&gt;Oak processes had a sudden exit - In this case branch commit info would be lost and we would have to resort to GC&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
		&lt;li&gt;C - Unmerged Rev GC (&lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-1981&quot; title=&quot;Implement full scale Revision GC for DocumentNodeStore&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-1981&quot;&gt;&lt;del&gt;OAK-1981&lt;/del&gt;&lt;/a&gt;) - Once we implement a full GC then such branch state can be collected in that GC&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;For now as part of this bug we would implement #A as that should reduce the performance issue and later we can go for #B and #C&lt;/p&gt;</comment>
                            <comment id="14071420" author="mreutegg" created="Wed, 23 Jul 2014 06:39:52 +0000"  >&lt;blockquote&gt;&lt;p&gt;only be removed if we do a garbage collection and remove all commits which were part of those branches&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Wouldn&apos;t it be sufficient to just remove the _revisions entries from the root document on startup? For readers those commits from branches that were never merged will appear as non-committed and will be ignored. &lt;/p&gt;</comment>
                            <comment id="14071565" author="chetanm" created="Wed, 23 Jul 2014 09:50:56 +0000"  >&lt;p&gt;Patch implementing #A above&lt;/p&gt;</comment>
                            <comment id="14071649" author="mreutegg" created="Wed, 23 Jul 2014 12:14:32 +0000"  >&lt;p&gt;Patch looks good to me.&lt;/p&gt;</comment>
                            <comment id="14079147" author="chetanm" created="Wed, 30 Jul 2014 10:17:54 +0000"  >&lt;p&gt;Patch was applied to &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;trunk - &lt;a href=&quot;http://svn.apache.org/r1612825&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1612825&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;1.0 - &lt;a href=&quot;http://svn.apache.org/r1614600&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1614600&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12657330" name="OAK-1926.patch" size="9019" author="chetanm" created="Wed, 23 Jul 2014 09:50:56 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>402589</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 16 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1xam7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>402656</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>