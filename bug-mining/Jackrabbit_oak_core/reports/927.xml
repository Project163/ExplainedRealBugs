<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:44:42 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-1894] PropertyIndex only considers the cost of a single indexed property</title>
                <link>https://issues.apache.org/jira/browse/OAK-1894</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;The existing PropertyIndex loops through the PropertyRestriction objects in the Filter and essentially only calculates the cost of the first indexed property. This isn&apos;t actually the first property in the query and Filter.propertyRestrictions is a HashMap.&lt;/p&gt;

&lt;p&gt;More confusingly, the plan for a query with multiple indexed properties outputs &lt;b&gt;all&lt;/b&gt; indexed properties, even though only the first one is used.&lt;/p&gt;

&lt;p&gt;For queries with multiple indexed properties, the cheapest property index should be used in all three relevant places: when calculating the cost, when executing the query, and when producing the plan.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12721429">OAK-1894</key>
            <summary>PropertyIndex only considers the cost of a single indexed property</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="thomasm">Thomas Mueller</assignee>
                                    <reporter username="justinedelson">Justin Edelson</reporter>
                        <labels>
                    </labels>
                <created>Mon, 16 Jun 2014 14:53:21 +0000</created>
                <updated>Tue, 8 Oct 2019 15:21:34 +0000</updated>
                            <resolved>Mon, 23 Jun 2014 11:17:07 +0000</resolved>
                                                    <fixVersion>1.0.2</fixVersion>
                    <fixVersion>1.1.0</fixVersion>
                                    <component>query</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="14032501" author="justinedelson" created="Mon, 16 Jun 2014 14:56:22 +0000"  >&lt;p&gt;Patch which calculates the cheapest property and uses it. It also outputs significantly more diagnostic information so that you can see the cost per property (even though only one of those properties, the cheapest, will be used for the actualy query).&lt;/p&gt;

&lt;p&gt;The only thing I dislike about this approach is that the cost calculation can happen multiple times per query. However, I don&apos;t see a way around this without refactoring of the API to allow indexes to return an object from getCost() which can then be passed into query() later.&lt;/p&gt;</comment>
                            <comment id="14032858" author="tmueller" created="Mon, 16 Jun 2014 19:59:03 +0000"  >&lt;p&gt;&amp;gt; without refactoring of the API to allow indexes to return an object from getCost() which can then be passed into query() later.&lt;/p&gt;

&lt;p&gt;We do have a solution for that: the interface QueryIndex.AdvancedQueryIndex, method getPlans. But property indexes don&apos;t use that API yet (only ordered indexes use it right now). So what you want might be possible, I will check.&lt;/p&gt;

&lt;p&gt;But first I will have a look at your patch.&lt;/p&gt;</comment>
                            <comment id="14032863" author="tmueller" created="Mon, 16 Jun 2014 20:03:20 +0000"  >&lt;p&gt;The patch looks good to me, but there should be more tests (specially tests with multiple indexes, where indexes have entryCount).&lt;/p&gt;</comment>
                            <comment id="14032911" author="tmueller" created="Mon, 16 Jun 2014 20:39:58 +0000"  >&lt;p&gt;A workaround for queries that have two property conditions is to use &quot;double negation&quot; as in:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;(a) where property1 = &apos;x&apos; and property2 = &apos;y&apos;
(b) where property1 = &apos;x&apos; and not not property2 = &apos;y&apos;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Those two queries are equivalent (return the same nodes), but query (a) could use an index on property2 (if there is one), while query (b) can not, because the query engine doesn&apos;t currently optimize the &quot;not not&quot; condition.&lt;/p&gt;</comment>
                            <comment id="14032934" author="justinedelson" created="Mon, 16 Jun 2014 20:55:29 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thomasm&quot; class=&quot;user-hover&quot; rel=&quot;thomasm&quot;&gt;thomasm&lt;/a&gt; I looked briefly at AdvancedQueryIndex, but the JavaDoc made it seem like that was only to be used when a query could handle sorting.&lt;/p&gt;

&lt;p&gt;Would it make more sense for me to convert PropertyIndex to implement AdvancedQueryIndex?&lt;/p&gt;</comment>
                            <comment id="14033129" author="justinedelson" created="Mon, 16 Jun 2014 22:42:23 +0000"  >&lt;p&gt;here&apos;s a different patch which uses the AdvancedQueryIndex. Related to my email to &lt;a href=&quot;http://markmail.org/message/2amhqmstxcabzyqv&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://markmail.org/message/2amhqmstxcabzyqv&lt;/a&gt;, I could&apos;t see a way of actually passing the cheapest property via the IndexPlan, so I added a new method to IndexPlan for this.&lt;/p&gt;

&lt;p&gt;Agree that more tests are a good idea; will work on that next.&lt;/p&gt;

&lt;p&gt;Interestingly, this approach exposed &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-1895&quot; title=&quot;ClassCastException can occur if the TraversalIndex is cheaper than an OrderedIndex (or a different AdvancedQueryIndex impl)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-1895&quot;&gt;&lt;del&gt;OAK-1895&lt;/del&gt;&lt;/a&gt;, which I went ahead and fixed on trunk and the 1.0 branch.&lt;/p&gt;

&lt;p&gt;Also, I figured out why the (rep:excerpt) bit went away. Prior to this change (either version), all properties were output in the plan description, with non-indexed properties in paren. I&apos;ve now changed that so that only the cheapest indexed property is output, but I should probably adjust that to output all properties, just indicating which property index was used.&lt;/p&gt;</comment>
                            <comment id="14033309" author="justinedelson" created="Tue, 17 Jun 2014 01:40:16 +0000"  >&lt;p&gt;Actually, thinking about this a bit more, there&apos;s really no point in outputting the property names for indexes which aren&apos;t used. Only the used/cheapest property should be output.&lt;/p&gt;</comment>
                            <comment id="14033333" author="empire29" created="Tue, 17 Jun 2014 02:10:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=justinedelson&quot; class=&quot;user-hover&quot; rel=&quot;justinedelson&quot;&gt;justinedelson&lt;/a&gt; I think listing all index candidate property names would be useful to help understand/make immediately clear 1) if you&apos;re missing an index for a property and 2) if certain operations (like, not) are preventing a property from being resolved to an index.&lt;/p&gt;</comment>
                            <comment id="14033501" author="tmueller" created="Tue, 17 Jun 2014 06:57:09 +0000"  >&lt;p&gt;AdvancedQueryIndex is &lt;em&gt;currently&lt;/em&gt; only used by the ordered index, but the plan is to use it for all indexes (including property index, full-text index, and traversal index) in the future. We can use it to solve this issue (&lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-1894&quot; title=&quot;PropertyIndex only considers the cost of a single indexed property&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-1894&quot;&gt;&lt;del&gt;OAK-1894&lt;/del&gt;&lt;/a&gt;), but we don&apos;t need to.&lt;/p&gt;

&lt;p&gt;&amp;gt;  I think listing all index candidate property names would be useful&lt;/p&gt;

&lt;p&gt;I agree. But it needs to be clear which restriction(s) are indexed, and which are not. For example: &quot;index on lastName=&apos;x&apos;, additional filter firstName=&apos;y&apos;&quot;.&lt;/p&gt;</comment>
                            <comment id="14033730" author="justinedelson" created="Tue, 17 Jun 2014 12:29:36 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=empire29&quot; class=&quot;user-hover&quot; rel=&quot;empire29&quot;&gt;empire29&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thomasm&quot; class=&quot;user-hover&quot; rel=&quot;thomasm&quot;&gt;thomasm&lt;/a&gt; Thanks for the feedback.&lt;/p&gt;

&lt;p&gt;In this latest patch, each property is annotated with one of `usedIndex`, `unusedIndex`, and `notIndexed`, e.g.&lt;/p&gt;

&lt;p&gt;    property usedIndex&lt;span class=&quot;error&quot;&gt;&amp;#91;indexedProperty1=baz&amp;#93;&lt;/span&gt; unusedIndex&lt;span class=&quot;error&quot;&gt;&amp;#91;jcr:uuid&amp;#93;&lt;/span&gt; notIndexed&lt;span class=&quot;error&quot;&gt;&amp;#91;nonIndexedProperty=foo&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;I &lt;em&gt;think&lt;/em&gt; this should be reasonbly easy to read.&lt;/p&gt;</comment>
                            <comment id="14033847" author="tmueller" created="Tue, 17 Jun 2014 14:25:34 +0000"  >&lt;p&gt;I&apos;m currently testing &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-1894&quot; title=&quot;PropertyIndex only considers the cost of a single indexed property&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-1894&quot;&gt;&lt;del&gt;OAK-1894&lt;/del&gt;&lt;/a&gt;.patch. &lt;/p&gt;

&lt;p&gt;Long term, I prefer &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-1894&quot; title=&quot;PropertyIndex only considers the cost of a single indexed property&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-1894&quot;&gt;&lt;del&gt;OAK-1894&lt;/del&gt;&lt;/a&gt;-advanced.diff, but it contains quite a lot of changes, plus I got a problem trying to apply the patch (some part was not applied), so right now I don&apos;t feel comfortable with it.&lt;/p&gt;</comment>
                            <comment id="14033851" author="justinedelson" created="Tue, 17 Jun 2014 14:30:36 +0000"  >&lt;p&gt;I too would prefer the advanced patch. I did find one additional failing test (where the existing property syntax was assumed). I fixed that as well as rebased my branch so that the patch should apply cleanly on trunk.&lt;/p&gt;</comment>
                            <comment id="14033867" author="justinedelson" created="Tue, 17 Jun 2014 14:46:48 +0000"  >&lt;p&gt;Please use the newly attached .patch files. They should both apply cleanly against trunk. Both include the same tests and plan formatting.&lt;/p&gt;</comment>
                            <comment id="14033875" author="tmueller" created="Tue, 17 Jun 2014 14:55:07 +0000"  >&lt;p&gt;Re-attached the old patch (because that&apos;s the one I&apos;m testing with right now).&lt;/p&gt;</comment>
                            <comment id="14035931" author="justinedelson" created="Wed, 18 Jun 2014 16:52:48 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thomasm&quot; class=&quot;user-hover&quot; rel=&quot;thomasm&quot;&gt;thomasm&lt;/a&gt; does the change to the plan description (which I think we&apos;re agreed is useful) require a corresponding change in the analyzer from &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-1884&quot; title=&quot;Query: log file analyzer tool &quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-1884&quot;&gt;&lt;del&gt;OAK-1884&lt;/del&gt;&lt;/a&gt; ?&lt;/p&gt;</comment>
                            <comment id="14040580" author="tmueller" created="Mon, 23 Jun 2014 09:51:18 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=justinedelson&quot; class=&quot;user-hover&quot; rel=&quot;justinedelson&quot;&gt;justinedelson&lt;/a&gt; yes, this would require a change in the analyzer. I suggest we track the &quot;bug&quot; (wrong index is used) and the &quot;improvement&quot; (improved query plan, plus using the AdvancedQueryIndex) separately. I will create a new issue for the improvement, and use that issue to track just the bug.&lt;/p&gt;</comment>
                            <comment id="14040634" author="tmueller" created="Mon, 23 Jun 2014 11:16:58 +0000"  >&lt;p&gt;Created &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-1908&quot; title=&quot;Improved query plan for PropertyIndex and OrderedIndex&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-1908&quot;&gt;&lt;del&gt;OAK-1908&lt;/del&gt;&lt;/a&gt; to track the improvements.&lt;/p&gt;

&lt;p&gt;Revision 1604744 and revision 1604748 (trunk)&lt;br/&gt;
Revision 1604750 (1.0 branch)&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12723094">OAK-1908</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12650810" name="OAK-1894-advanced.patch" size="28649" author="justinedelson" created="Tue, 17 Jun 2014 14:46:48 +0000"/>
                            <attachment id="12650813" name="OAK-1894-old.patch" size="7950" author="thomasm" created="Tue, 17 Jun 2014 14:55:07 +0000"/>
                            <attachment id="12650811" name="OAK-1894.patch" size="18746" author="justinedelson" created="Tue, 17 Jun 2014 14:46:48 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>399625</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 21 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1wsmf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>399734</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>