<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:46:00 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-2144] Intermittent Node not found at given revision with DocumentNodeStore</title>
                <link>https://issues.apache.org/jira/browse/OAK-2144</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;In a cluster deployment intermittent issue related to node not found at given revision are observed. Mostly such logs are coming from Onservation logic which performs diff and read node from two different revision. &lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;24.09.2014 09:11:45.513 *WARN* [pool-5-thread-5] org.apache.jackrabbit.oak.jcr.observation.ChangeProcessor Error while dispatching observation events
java.lang.NullPointerException: Node at [/var/eventing/jobs/assigned/62f1f24b-027e-4434-b1ef-a7a3c2c90e16/logouttopic/2014/9/24/15/12] not found for fromRev [r148a837accc-0-4]
	at com.google.common.base.Preconditions.checkNotNull(Preconditions.java:236)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;For the timings (all converted to UTC)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Log - 2014-09-24T16:11:45.513 UTC&lt;/li&gt;
	&lt;li&gt;Read Revision r148a837accc-0-4 - 2014-09-24T15:11:34.092 UTC (T1)&lt;/li&gt;
	&lt;li&gt;Created Revision r148a83824e4-0-2 - 2014-09-24T15:12:04.836 UTC (T2)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;As can be seen that node is actually created at time T2 &amp;gt; T1. Now DocumentNodeStore has a logic &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; which determines the revision based on prevision revision seen for a given cluster instance. Now it can happen that when some read call fetches child for a given path then it records that those child exist at given readRevision and this readRevision might be in past. Later when revision node cache gets purged and revision child node cache still retains the entry call to read node at given revision would fail.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;qa:PRIMARY&amp;gt; db.nodes.findOne({_id: &quot;11:/var/eventing/jobs/assigned/62f1f24b-027e-4434-b1ef-a7a3c2c90e16/logouttopic/2014/9/24/15/12&quot; })
{
        &quot;_id&quot; : &quot;11:/var/eventing/jobs/assigned/62f1f24b-027e-4434-b1ef-a7a3c2c90e16/logouttopic/2014/9/24/15/12&quot;,
        &quot;_lastRev&quot; : {
                &quot;r0-0-2&quot; : &quot;r148a873e2ee-0-2&quot;,
                &quot;r0-0-1&quot; : &quot;r148a8b3ffa7-0-1&quot;
        },
        &quot;jcr:primaryType&quot; : {
                &quot;r148a83824e4-0-2&quot; : &quot;\&quot;nam:sling:Folder\&quot;&quot;,
                &quot;r148a8b3ffa7-0-1&quot; : null
        },
        &quot;_commitRoot&quot; : {
                &quot;r148a83824e4-0-2&quot; : &quot;0&quot;,
                &quot;r148a8382505-0-2&quot; : &quot;0&quot;,
                &quot;r148a8b3ffa7-0-1&quot; : &quot;0&quot;
        },
        &quot;_modified&quot; : NumberLong(1411579640),
        &quot;jcr:createdBy&quot; : {
                &quot;r148a83824e4-0-2&quot; : &quot;\&quot;admin\&quot;&quot;,
                &quot;r148a8b3ffa7-0-1&quot; : null
        },
        &quot;_deleted&quot; : {
                &quot;r148a83824e4-0-2&quot; : &quot;false&quot;,
                &quot;r148a8b3ffa7-0-1&quot; : &quot;true&quot;
        },
        &quot;sling:resourceType&quot; : {
                &quot;r148a83824e4-0-2&quot; : &quot;\&quot;sling:Folder\&quot;&quot;,
                &quot;r148a8b3ffa7-0-1&quot; : null
        },
        &quot;jcr:created&quot; : {
                &quot;r148a83824e4-0-2&quot; : &quot;\&quot;dat:2014-09-24T15:12:04.825Z\&quot;&quot;,
                &quot;r148a8b3ffa7-0-1&quot; : null
        },
        &quot;_modCount&quot; : NumberLong(42),
        &quot;_children&quot; : true,
        &quot;_deletedOnce&quot; : true
}

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://github.com/apache/jackrabbit-oak/blob/trunk/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/Revision.java#L543-615&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/jackrabbit-oak/blob/trunk/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/Revision.java#L543-615&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12744244">OAK-2144</key>
            <summary>Intermittent Node not found at given revision with DocumentNodeStore</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mreutegg">Marcel Reutegger</assignee>
                                    <reporter username="chetanm">Chetan Mehrotra</reporter>
                        <labels>
                    </labels>
                <created>Fri, 26 Sep 2014 09:39:44 +0000</created>
                <updated>Mon, 13 Oct 2014 09:20:43 +0000</updated>
                            <resolved>Thu, 9 Oct 2014 11:36:58 +0000</resolved>
                                                    <fixVersion>1.0.7</fixVersion>
                    <fixVersion>1.1.1</fixVersion>
                                    <component>mongomk</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="14154671" author="chetanm" created="Wed, 1 Oct 2014 11:21:59 +0000"  >&lt;p&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12672308/12672308_OAK-2144-probable-fix.patch&quot; title=&quot;OAK-2144-probable-fix.patch attached to OAK-2144&quot;&gt;patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; with probable fix (without testcase for now). It assumes that root cause of issue is inconsistency between &lt;tt&gt;nodeCache&lt;/tt&gt; and &lt;tt&gt;nodeCacheStats&lt;/tt&gt; and tries to keep them in sync if the cache entries were considered to be &lt;em&gt;problamatic&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;This is just to put down current thoughts in code. Would work on a testcase to reproduce the issue now&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mreutegg&quot; class=&quot;user-hover&quot; rel=&quot;mreutegg&quot;&gt;mreutegg&lt;/a&gt; Can you have a look at the patch?&lt;/p&gt;</comment>
                            <comment id="14160430" author="chetanm" created="Mon, 6 Oct 2014 16:05:55 +0000"  >&lt;p&gt;Added a testcase reproducing the issue with &lt;a href=&quot;http://svn.apache.org/r1629688&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1629688&lt;/a&gt;. &lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.lang.NullPointerException: Node at [/a/c3] not found for toRev [r1c-0-2]
	at com.google.common.base.Preconditions.checkNotNull(Preconditions.java:236)
	at org.apache.jackrabbit.oak.plugins.document.DocumentNodeStore.diffFewChildren(DocumentNodeStore.java:1667)
	at org.apache.jackrabbit.oak.plugins.document.DocumentNodeStore.diffImpl(DocumentNodeStore.java:1572)
	at org.apache.jackrabbit.oak.plugins.document.DocumentNodeStore.diffChildren(DocumentNodeStore.java:1219)
	at org.apache.jackrabbit.oak.plugins.document.DocumentNodeState.compareAgainstBaseState(DocumentNodeState.java:255)
	at org.apache.jackrabbit.oak.plugins.document.ClusterTest$TrackingDiff.childNodeChanged(ClusterTest.java:455)
	at org.apache.jackrabbit.oak.plugins.document.DocumentNodeState.dispatch(DocumentNodeState.java:428)
	at org.apache.jackrabbit.oak.plugins.document.DocumentNodeState.compareAgainstBaseState(DocumentNodeState.java:255)
	at org.apache.jackrabbit.oak.plugins.document.ClusterRevisionComparisonTest.revisionComparisonMultipleClusterNode(ClusterRevisionComparisonTest.java:98)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The test passes with &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12673107/12673107_OAK-2144-2.patch&quot; title=&quot;OAK-2144-2.patch attached to OAK-2144&quot;&gt;attached patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mreutegg&quot; class=&quot;user-hover&quot; rel=&quot;mreutegg&quot;&gt;mreutegg&lt;/a&gt; Can you review the testcase and the approach taken in the patch&lt;/p&gt;</comment>
                            <comment id="14161711" author="mreutegg" created="Tue, 7 Oct 2014 10:01:30 +0000"  >&lt;p&gt;The test looks good. I would even add asserts to explicitly check if nodes still exist after the revision comparator purge. See &lt;a href=&quot;http://svn.apache.org/r1629840&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1629840&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This makes the test more strict and it will still fail with the patch you attached. If possible, I&apos;d like to fix this in a way that also makes /a/c2 and /a/c3 stable from a c1 point of view. Your patch avoids the NullPointerException, but the visibility is still not correct. The node /a/c3 is not visible anymore on c1, even though changes were pushed on c3 and picked up by c1.&lt;/p&gt;</comment>
                            <comment id="14161822" author="mreutegg" created="Tue, 7 Oct 2014 12:16:24 +0000"  >&lt;p&gt;The attached diagram that helped me to understand the test. One of the conditions for the problem to occur are the two crossed arrows.&lt;/p&gt;

&lt;p&gt;From an absolute time point of view /a/c2 is created before /a/c3, but seen at cluster node c1 the other way around. When the revision comparator is purged /a/c3 becomes invisible because absolute revision timestamps are used for comparison.&lt;/p&gt;</comment>
                            <comment id="14162010" author="mreutegg" created="Tue, 7 Oct 2014 15:38:32 +0000"  >&lt;p&gt;Added a simplified test with two cluster nodes which shows the same problem: &lt;a href=&quot;http://svn.apache.org/r1629917&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1629917&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14163151" author="chetanm" created="Wed, 8 Oct 2014 06:34:19 +0000"  >&lt;p&gt;Following change in NodeDocument get the test pass but break lots of other test &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.  As discussed in offline call for proper fix we need to align the lastRev used in a given cluster node to use revisions as &lt;em&gt;seen&lt;/em&gt; from that node. This would be tricky though!&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;+++ ../../../git/apache/jackrabbit-oak/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/NodeDocument.java	(revision )
@@ -835,6 +835,14 @@
                 lastRevision = r.asBranchRevision();
             }
         }
+
+        if (!lastRevision.isBranch()) {
+            Revision seen = nodeStore.getRevisionComparator().getRevisionSeen(lastRevision);
+            if (seen != null) {
+                lastRevision = seen;
+            }
+        }
+
         n.setLastRevision(lastRevision);
         return n;
     }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14163647" author="mreutegg" created="Wed, 8 Oct 2014 16:01:05 +0000"  >&lt;p&gt;Implemented a fix which detects ambiguous _lastRevs and uses the readRevision instead. With this fix all the tests pass.&lt;/p&gt;

&lt;p&gt;Done in &lt;a href=&quot;http://svn.apache.org/r1630156&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1630156&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14165029" author="mreutegg" created="Thu, 9 Oct 2014 11:36:58 +0000"  >&lt;p&gt;Merged into 1.0 branch in &lt;a href=&quot;http://svn.apache.org/r1630372&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1630372&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14169122" author="mreutegg" created="Mon, 13 Oct 2014 09:20:43 +0000"  >&lt;p&gt;Bulk close for Oak 1.0.7&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12744220">OAK-2143</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12673107" name="OAK-2144-2.patch" size="8716" author="chetanm" created="Mon, 6 Oct 2014 16:05:55 +0000"/>
                            <attachment id="12672308" name="OAK-2144-probable-fix.patch" size="8703" author="chetanm" created="Wed, 1 Oct 2014 11:21:59 +0000"/>
                            <attachment id="12673346" name="OAK-2144.jpg" size="212105" author="mreutegg" created="Tue, 7 Oct 2014 12:16:24 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 5 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i20ijz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>