<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:53:57 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-8054] RepMembersConflictHandler creates property with wrong type</title>
                <link>https://issues.apache.org/jira/browse/OAK-8054</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;The &lt;tt&gt;RepMembersConflictHandler&lt;/tt&gt; handler uses type &lt;tt&gt;STRING&lt;/tt&gt; instead of &lt;tt&gt;WEAKREFERENCE&lt;/tt&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt; as per the property&apos;s definition, which will trigger the type validation to fail the commit.&lt;br/&gt;
Running external login tests I see that the type fails as soon as the handler comes into play:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;WARN  o.a.j.o.s.s.a.e.i.ExternalLoginModule - User synchronization failed during commit: org.apache.jackrabbit.oak.api.CommitFailedException: OakConstraint0004: /rep:security/rep:authorizables/rep:groups/pathPrefix/g8/rep:membersList/9[[rep:MemberReferences]]: No matching property definition found for rep:members = [8e490910-17b6-30c1-8e11-6abdfa8a4ebc, 1a8e79f5-428e-39e9-88bb-2b86bd9b402e, ... ]. (attempt 10/50)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This seems to be a pretty big issue, and I&apos;m not yet sure why it wasn&apos;t caught by the existing tests.&lt;/p&gt;

&lt;p&gt;// fyi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=anchela&quot; class=&quot;user-hover&quot; rel=&quot;anchela&quot;&gt;anchela&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://github.com/apache/jackrabbit-oak/blob/trunk/oak-core/src/main/java/org/apache/jackrabbit/oak/security/user/RepMembersConflictHandler.java#L135&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/jackrabbit-oak/blob/trunk/oak-core/src/main/java/org/apache/jackrabbit/oak/security/user/RepMembersConflictHandler.java#L135&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13216010">OAK-8054</key>
            <summary>RepMembersConflictHandler creates property with wrong type</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="stillalex">Alex Deparvu</assignee>
                                    <reporter username="stillalex">Alex Deparvu</reporter>
                        <labels>
                    </labels>
                <created>Fri, 15 Feb 2019 15:06:58 +0000</created>
                <updated>Wed, 5 Jun 2019 15:59:27 +0000</updated>
                            <resolved>Tue, 19 Feb 2019 09:39:37 +0000</resolved>
                                    <version>1.8.0</version>
                    <version>1.8.1</version>
                    <version>1.8.2</version>
                    <version>1.8.3</version>
                    <version>1.8.4</version>
                    <version>1.8.5</version>
                    <version>1.8.6</version>
                    <version>1.8.7</version>
                    <version>1.8.8</version>
                    <version>1.8.9</version>
                    <version>1.8.10</version>
                    <version>1.8.11</version>
                    <version>1.8.12</version>
                                    <fixVersion>1.12.0</fixVersion>
                    <fixVersion>1.10.1</fixVersion>
                    <fixVersion>1.8.13</fixVersion>
                                    <component>core</component>
                    <component>security</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="16769407" author="anchela" created="Fri, 15 Feb 2019 15:27:55 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stillalex&quot; class=&quot;user-hover&quot; rel=&quot;stillalex&quot;&gt;stillalex&lt;/a&gt;, oh &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;  yes, that should be type weakreferences. is there any test failing when you change it to the correct type?&lt;/p&gt;</comment>
                            <comment id="16769434" author="alex.parvulescu" created="Fri, 15 Feb 2019 15:48:05 +0000"  >&lt;p&gt;for future ref, complete trace&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.jackrabbit.oak.api.CommitFailedException: OakConstraint0004: /rep:security/rep:authorizables/rep:groups/pathPrefix/g8/rep:membersList/0[[rep:MemberReferences]]: No matching property definition found for rep:members = [8b57f4b6-d38a-3352-b128-368d76d7d933, ...]
	at org.apache.jackrabbit.oak.plugins.nodetype.TypeEditor$1.onConstraintViolation(TypeEditor.java:109)
	at org.apache.jackrabbit.oak.plugins.nodetype.TypeEditor.constraintViolation(TypeEditor.java:234)
	at org.apache.jackrabbit.oak.plugins.nodetype.TypeEditor.checkPropertyTypeConstraints(TypeEditor.java:497)
	at org.apache.jackrabbit.oak.plugins.nodetype.TypeEditor.propertyChanged(TypeEditor.java:257)
	at org.apache.jackrabbit.oak.spi.commit.VisibleEditor.propertyChanged(VisibleEditor.java:73)
	at org.apache.jackrabbit.oak.spi.commit.CompositeEditor.propertyChanged(CompositeEditor.java:90)
	at org.apache.jackrabbit.oak.spi.commit.EditorDiff.propertyChanged(EditorDiff.java:92)
	at org.apache.jackrabbit.oak.segment.SegmentNodeState.compareProperties(SegmentNodeState.java:664)
	at org.apache.jackrabbit.oak.segment.SegmentNodeState.compareAgainstBaseState(SegmentNodeState.java:558)
	at org.apache.jackrabbit.oak.spi.commit.EditorDiff.childNodeChanged(EditorDiff.java:147)
	at org.apache.jackrabbit.oak.segment.SegmentNodeState.compareAgainstBaseState(SegmentNodeState.java:598)
	at org.apache.jackrabbit.oak.spi.commit.EditorDiff.childNodeChanged(EditorDiff.java:147)
	at org.apache.jackrabbit.oak.segment.SegmentNodeState.compareAgainstBaseState(SegmentNodeState.java:598)
	at org.apache.jackrabbit.oak.spi.commit.EditorDiff.childNodeChanged(EditorDiff.java:147)
	at org.apache.jackrabbit.oak.segment.MapRecord.compare(MapRecord.java:495)
	at org.apache.jackrabbit.oak.segment.SegmentNodeState.compareAgainstBaseState(SegmentNodeState.java:651)
	at org.apache.jackrabbit.oak.spi.commit.EditorDiff.childNodeChanged(EditorDiff.java:147)
	at org.apache.jackrabbit.oak.segment.SegmentNodeState.compareAgainstBaseState(SegmentNodeState.java:598)
	at org.apache.jackrabbit.oak.spi.commit.EditorDiff.childNodeChanged(EditorDiff.java:147)
	at org.apache.jackrabbit.oak.segment.MapRecord.compare(MapRecord.java:422)
	at org.apache.jackrabbit.oak.segment.SegmentNodeState.compareAgainstBaseState(SegmentNodeState.java:651)
	at org.apache.jackrabbit.oak.spi.commit.EditorDiff.childNodeChanged(EditorDiff.java:147)
	at org.apache.jackrabbit.oak.segment.SegmentNodeState.compareAgainstBaseState(SegmentNodeState.java:598)
	at org.apache.jackrabbit.oak.spi.commit.EditorDiff.childNodeChanged(EditorDiff.java:147)
	at org.apache.jackrabbit.oak.segment.MapRecord.compare(MapRecord.java:422)
	at org.apache.jackrabbit.oak.segment.SegmentNodeState.compareAgainstBaseState(SegmentNodeState.java:651)
	at org.apache.jackrabbit.oak.spi.commit.EditorDiff.process(EditorDiff.java:51)
	at org.apache.jackrabbit.oak.spi.commit.EditorHook.processCommit(EditorHook.java:54)
	at org.apache.jackrabbit.oak.spi.commit.CompositeHook.processCommit(CompositeHook.java:60)
	at org.apache.jackrabbit.oak.spi.commit.CompositeHook.processCommit(CompositeHook.java:60)
	at org.apache.jackrabbit.oak.segment.scheduler.Commit.apply(Commit.java:77)
	at org.apache.jackrabbit.oak.segment.scheduler.LockBasedScheduler.execute(LockBasedScheduler.java:250)
	at org.apache.jackrabbit.oak.segment.scheduler.LockBasedScheduler.schedule(LockBasedScheduler.java:222)
	at org.apache.jackrabbit.oak.segment.SegmentNodeStore.merge(SegmentNodeStore.java:211)
	at org.apache.jackrabbit.oak.core.MutableRoot.commit(MutableRoot.java:251)
	at org.apache.jackrabbit.oak.core.MutableRoot.commit(MutableRoot.java:262)
	at org.apache.jackrabbit.oak.spi.security.authentication.external.impl.ExternalLoginModule.syncUser(ExternalLoginModule.java:358)
	at org.apache.jackrabbit.oak.spi.security.authentication.external.impl.ExternalLoginModule.login(ExternalLoginModule.java:234)
	at sun.reflect.GeneratedMethodAccessor11.invoke(Unknown Source)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:498)
	at javax.security.auth.login.LoginContext.invoke(LoginContext.java:755)
	at javax.security.auth.login.LoginContext.access$000(LoginContext.java:195)
	at javax.security.auth.login.LoginContext$4.run(LoginContext.java:682)
	at javax.security.auth.login.LoginContext$4.run(LoginContext.java:680)
	at java.security.AccessController.doPrivileged(Native Method)
	at javax.security.auth.login.LoginContext.invokePriv(LoginContext.java:680)
	at javax.security.auth.login.LoginContext.login(LoginContext.java:587)
	at org.apache.jackrabbit.oak.core.ContentRepositoryImpl.login(ContentRepositoryImpl.java:163)
	at org.apache.jackrabbit.oak.jcr.repository.RepositoryImpl.login(RepositoryImpl.java:282)
	at org.apache.jackrabbit.oak.jcr.repository.RepositoryImpl.login(RepositoryImpl.java:250)
	at org.apache.jackrabbit.oak.benchmark.authentication.external.ExternalLoginTest.runTest(ExternalLoginTest.java:94)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16769471" author="anchela" created="Fri, 15 Feb 2019 16:17:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stillalex&quot; class=&quot;user-hover&quot; rel=&quot;stillalex&quot;&gt;stillalex&lt;/a&gt;, i created an additional test case (attached) that is just a tiny extension of the existing test, but which fills the &lt;tt&gt;rep:members&lt;/tt&gt; property and forces the creation of the member-references-list subtree... and see: since the node type defining that structure has no residual properties (in contrast to the rep:Group type), the constraint violations is trigger. nice one indeed &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16769542" author="anchela" created="Fri, 15 Feb 2019 17:48:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stillalex&quot; class=&quot;user-hover&quot; rel=&quot;stillalex&quot;&gt;stillalex&lt;/a&gt;, wrote 2 more test (for simplicity with &lt;tt&gt;GroupImplTest&lt;/tt&gt; class) to get a feeling regarding the impact of fixing this and if the property type would be fixed by adding/removing members that affect that property. that seems to looks good (apart from the fact that those tests deserve a separate class).&lt;/p&gt;</comment>
                            <comment id="16770838" author="alex.parvulescu" created="Mon, 18 Feb 2019 07:53:03 +0000"  >&lt;p&gt;thanks a lot &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=anchela&quot; class=&quot;user-hover&quot; rel=&quot;anchela&quot;&gt;anchela&lt;/a&gt; for the tests! I am taking a look now. It seems there is a big part missing from the conflict handling: the scenario where the extra nodes are created (the &lt;tt&gt;rep:membersList&lt;/tt&gt;).&lt;/p&gt;</comment>
                            <comment id="16770862" author="anchela" created="Mon, 18 Feb 2019 08:30:55 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stillalex&quot; class=&quot;user-hover&quot; rel=&quot;stillalex&quot;&gt;stillalex&lt;/a&gt;, you&apos;re welcome. let me know if there is anything else i can help you with. during the weekend i kept wondering if we should let the &lt;tt&gt;UserValdiator&lt;/tt&gt; to verify the type of the &lt;tt&gt;rep:members&lt;/tt&gt; property once the issue is fixed.... &lt;/p&gt;</comment>
                            <comment id="16770953" author="alex.parvulescu" created="Mon, 18 Feb 2019 10:06:22 +0000"  >&lt;p&gt;This is how it looks so far &lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt;.&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;integrated the provided tests and added some more for the threshold overflow scenario&lt;/li&gt;
	&lt;li&gt;I added more conflict handling code for the threshold&lt;/li&gt;
	&lt;li&gt;added handling for &lt;tt&gt;deleteDeletedProperty&lt;/tt&gt; scenario&lt;/li&gt;
	&lt;li&gt;finally I refactored the merge to keep the existing order of the values (in it&apos;s current form there&apos;s some shuffle due to usage of HashSet)&lt;br/&gt;
I think it&apos;s in pretty good shape, running the IT tests now.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://github.com/apache/jackrabbit-oak/compare/trunk...stillalex:oak-8054&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/jackrabbit-oak/compare/trunk...stillalex:oak-8054&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16771679" author="anchela" created="Tue, 19 Feb 2019 08:05:36 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stillalex&quot; class=&quot;user-hover&quot; rel=&quot;stillalex&quot;&gt;stillalex&lt;/a&gt;, without being familiar with the original code the diff is a bit hard to read. but from what i can see it looks good.&lt;/p&gt;</comment>
                            <comment id="16771763" author="alex.parvulescu" created="Tue, 19 Feb 2019 09:39:37 +0000"  >&lt;ul&gt;
	&lt;li&gt;trunk: fixed with &lt;a href=&quot;http://svn.apache.org/viewvc?rev=1853868&amp;amp;view=rev&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?rev=1853868&amp;amp;view=rev&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;1.10: &lt;a href=&quot;http://svn.apache.org/viewvc?rev=1854053&amp;amp;view=rev&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?rev=1854053&amp;amp;view=rev&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;1.8: &lt;a href=&quot;http://svn.apache.org/viewvc?rev=1856039&amp;amp;view=rev&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?rev=1856039&amp;amp;view=rev&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16798861" author="alex.parvulescu" created="Fri, 22 Mar 2019 09:52:38 +0000"  >&lt;p&gt;Just noticed another side effect of this change and I&apos;m documenting it here for future reference:&lt;br/&gt;
If a group has a conflict which gets merged with the old code, its &lt;tt&gt;rep:members&lt;/tt&gt; property effectively changes type from &lt;tt&gt;WEAKREFERENCE[]&lt;/tt&gt; to &lt;tt&gt;STRING[]&lt;/tt&gt;.&lt;br/&gt;
Chaging the type will break the &lt;tt&gt;Authorizable.memberOf()&lt;/tt&gt; call because this in turn relies on the &lt;tt&gt;reference&lt;/tt&gt; index (which will ignore the string[] property) to return the groups that an authorizable is directly a part of. Breakage here means that the LoginModule call that compiles the current session&apos;s principals will not contain all of the users&apos;s groups so it will not have a correct view on the aggregated permissions.&lt;/p&gt;

&lt;p&gt;Reindexing the &lt;tt&gt;reference&lt;/tt&gt; index will not help as long as the property&apos;s type is wrong.&lt;br/&gt;
In some cases if the group&apos;s membership changes (adds or removes members) the property&apos;s type will self-heal (type is set correctly by the update code), but due to the internal structure there can be more that one member list chunks and only the updated one will be fixed.&lt;/p&gt;

&lt;p&gt;As a workaround removing (save the changes so they trigger an update) and adding a user to the group seems to fix the problem for that specific user as it will probably get moved to a different chunk of the membership list.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12862399">OAK-3374</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12958917" name="OAK-8054-impact.patch" size="3058" author="angela" created="Fri, 15 Feb 2019 17:49:54 +0000"/>
                            <attachment id="12958908" name="OAK-8054.patch" size="4696" author="angela" created="Fri, 15 Feb 2019 16:15:01 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 34 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|yi111c:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>