<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:49:33 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-3541] VersionableState.copy doesn&apos;t respect OPV flag in the subtree</title>
                <link>https://issues.apache.org/jira/browse/OAK-3541</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;while testing my work in &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-1268&quot; title=&quot;Add support for composite authorization setup&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-1268&quot;&gt;&lt;del&gt;OAK-1268&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-2008&quot; title=&quot;authorization setup for closed user groups&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-2008&quot;&gt;&lt;del&gt;OAK-2008&lt;/del&gt;&lt;/a&gt;, i found that items with OPV IGNORE are being copied into the frozen node of a versionable node upon checkin and only the first level child nodes are being tested for the OPV flag.&lt;/p&gt;

&lt;p&gt;IMHO the OPV flag should be respected for all items in the subtree and act accordingly. The current bug might prevent versionable child nodes from being properly versioned and will copy items that are expected to be ignored (e.g. access control content) into the version store.&lt;/p&gt;

&lt;p&gt;if i am not mistaken the properties are actually tested for the their OPV flag... if that is true, we might even have a bigger issue as the content in the version store is no longer complete and valid (e.g. mandatory/protected/autocreated properties being ignored but the node still being copied over and thus being invalid)&lt;/p&gt;</description>
                <environment></environment>
        <key id="12907100">OAK-3541</key>
            <summary>VersionableState.copy doesn&apos;t respect OPV flag in the subtree</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="angela">Angela Schreiber</assignee>
                                    <reporter username="angela">Angela Schreiber</reporter>
                        <labels>
                            <label>versioning</label>
                    </labels>
                <created>Thu, 22 Oct 2015 14:40:23 +0000</created>
                <updated>Wed, 2 Mar 2016 14:47:56 +0000</updated>
                            <resolved>Mon, 26 Oct 2015 14:33:36 +0000</resolved>
                                                    <fixVersion>1.3.9</fixVersion>
                    <fixVersion>1.4</fixVersion>
                                    <component>core</component>
                    <component>jcr</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="14969320" author="anchela" created="Thu, 22 Oct 2015 15:35:52 +0000"  >&lt;p&gt;simple test case illustrating the problem (it&apos;s the second test that fails)&lt;/p&gt;</comment>
                            <comment id="14969331" author="anchela" created="Thu, 22 Oct 2015 15:44:54 +0000"  >&lt;p&gt;the attached patch solves the OPV-IGNORE issue for me. however, since i am not too familiar with the other OPV-flags i don&apos;t know if it works properly for nodes with OPV-VERSION in the subtree.&lt;/p&gt;

&lt;p&gt;one more thing: the original code used &lt;tt&gt;OPVForceCopy&lt;/tt&gt; for all properties in the subtree. calling the &lt;tt&gt;createFrozenNode&lt;/tt&gt; again for the subtree nodes (as proposed by the patch) changes this to use the anonymous inner implementation instead, which looks as follows:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; OPVProvider() {
            @Override
            &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; getAction(NodeBuilder src,
                                 NodeBuilder dest,
                                 PropertyState prop)
                    &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; RepositoryException {
                &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; propName = prop.getName();
                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (BASIC_FROZEN_PROPERTIES.contains(propName)) {
                    &lt;span class=&quot;code-comment&quot;&gt;// OAK-940: &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; not overwrite basic frozen properties
&lt;/span&gt;                    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; IGNORE;
                } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (isHiddenProperty(propName)) {
                    &lt;span class=&quot;code-comment&quot;&gt;// don&apos;t copy hidden properties except &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; :childOrder
&lt;/span&gt;                    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; IGNORE;
                }
                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; getOPV(src, prop);
            }
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;In general that looks better to me, but this definitely needs a second look as well as some test-coverage, verifying that this is really correct.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mreutegg&quot; class=&quot;user-hover&quot; rel=&quot;mreutegg&quot;&gt;mreutegg&lt;/a&gt;, wdyt?&lt;/p&gt;</comment>
                            <comment id="14970632" author="anchela" created="Fri, 23 Oct 2015 08:17:40 +0000"  >&lt;p&gt;committed proposed patch at rev. 1710135 to unblock my work on &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-1268&quot; title=&quot;Add support for composite authorization setup&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-1268&quot;&gt;&lt;del&gt;OAK-1268&lt;/del&gt;&lt;/a&gt;; however leaving this issue open as further testing especially of the other OPV flags is required. &lt;/p&gt;</comment>
                            <comment id="14974229" author="anchela" created="Mon, 26 Oct 2015 13:58:19 +0000"  >&lt;p&gt;rev. 1710599 : tests for OPV &lt;tt&gt;VERSION&lt;/tt&gt; and &lt;tt&gt;COPY&lt;/tt&gt;. &lt;br/&gt;
rev. 1710607 : tests for OPV &lt;tt&gt;ABORT&lt;/tt&gt;&lt;br/&gt;
NOTE: as far as i can see oak doesn&apos;t handle OPV &lt;tt&gt;COMPUTE&lt;/tt&gt; and &lt;tt&gt;INITIALIZE&lt;/tt&gt;, so not adding any tests for those.&lt;/p&gt;</comment>
                            <comment id="14974296" author="anchela" created="Mon, 26 Oct 2015 14:33:36 +0000"  >&lt;p&gt;with the test added for other OPV flags i am quite confident that the fix is correct (at least for OPV handling of nodes). please reopen in case i missed something.&lt;/p&gt;</comment>
                            <comment id="14982395" author="edivad" created="Fri, 30 Oct 2015 11:22:55 +0000"  >&lt;p&gt;Bulk close for 1.3.9&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="12683092">OAK-1268</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12907883">OAK-3551</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12768056" name="OAK-3541.patch" size="1811" author="angela" created="Thu, 22 Oct 2015 15:44:54 +0000"/>
                            <attachment id="12768055" name="OAK-3541_test.patch" size="4530" author="angela" created="Thu, 22 Oct 2015 15:35:52 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 3 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2ndtj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>