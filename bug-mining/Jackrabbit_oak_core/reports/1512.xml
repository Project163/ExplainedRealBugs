<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:51:02 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-4565] S3Backend fails to upload large metadata records</title>
                <link>https://issues.apache.org/jira/browse/OAK-4565</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;If a large enough metadata record is added to a S3 DS (like the list of blob references collected during the mark phase of the MarkSweepGC) the upload will fail (i.e. never start). This is caused by &lt;tt&gt;S3Backend.addMetadataRecord()&lt;/tt&gt; providing an InputStream to the S3 TransferManager without specifying the size in the Metadata. &lt;br/&gt;
A warning to this effect is logged by the AWS SDK each time you add a metadata record: &lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[s3-transfer-manager-worker-1] AmazonS3Client.java:1364 No content length specified for stream data.  Stream contents will be buffered in memory and could result in out of memory errors.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Normally this shouldn&apos;t be too big of a problem but in a repository with over 36 million blob references the list of marked refs produced by the GC is over 5GB. In this case the S3 transfer worker thread will be stuck in a seemingly endless loop where it tries to allocate the memory reading the file into memory and never finishes (although the JVM has 80GB of heap), eating away resources in the process:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;   java.lang.Thread.State: RUNNABLE
	at org.apache.http.util.ByteArrayBuffer.append(ByteArrayBuffer.java:90)
	at org.apache.http.util.EntityUtils.toByteArray(EntityUtils.java:137)
	at org.apache.http.entity.BufferedHttpEntity.&amp;lt;init&amp;gt;(BufferedHttpEntity.java:63)
	at com.amazonaws.http.HttpRequestFactory.newBufferedHttpEntity(HttpRequestFactory.java:247)
	at com.amazonaws.http.HttpRequestFactory.createHttpRequest(HttpRequestFactory.java:126)
	at com.amazonaws.http.AmazonHttpClient$ExecOneRequestParams.newApacheRequest(AmazonHttpClient.java:650)
	at com.amazonaws.http.AmazonHttpClient.executeOneRequest(AmazonHttpClient.java:730)
	at com.amazonaws.http.AmazonHttpClient.executeHelper(AmazonHttpClient.java:505)
	at com.amazonaws.http.AmazonHttpClient.execute(AmazonHttpClient.java:317)
	at com.amazonaws.services.s3.AmazonS3Client.invoke(AmazonS3Client.java:3595)
	at com.amazonaws.services.s3.AmazonS3Client.putObject(AmazonS3Client.java:1382)
	at com.amazonaws.services.s3.transfer.internal.UploadCallable.uploadInOneChunk(UploadCallable.java:131)
	at com.amazonaws.services.s3.transfer.internal.UploadCallable.call(UploadCallable.java:123)
	at com.amazonaws.services.s3.transfer.internal.UploadMonitor.call(UploadMonitor.java:139)
	at com.amazonaws.services.s3.transfer.internal.UploadMonitor.call(UploadMonitor.java:47)
	at java.util.concurrent.FutureTask.run(FutureTask.java:266)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
	at java.lang.Thread.run(Thread.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt; 

&lt;p&gt;The last log message by the GC thread will be like this:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;*INFO* [sling-oak-observation-1273] org.apache.jackrabbit.oak.plugins.blob.MarkSweepGarbageCollector Number of valid blob references marked under mark phase of Blob garbage collection [36147734]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt; 

&lt;p&gt;followed by the above AWS warning, then it will stall waiting for the transfer to finish.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12989746">OAK-4565</key>
            <summary>S3Backend fails to upload large metadata records</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="amitjain">Amit Jain</assignee>
                                    <reporter username="mwehner">Martin Wehner</reporter>
                        <labels>
                            <label>gc</label>
                            <label>s3</label>
                    </labels>
                <created>Fri, 15 Jul 2016 10:45:09 +0000</created>
                <updated>Thu, 10 Nov 2016 09:51:20 +0000</updated>
                            <resolved>Tue, 19 Jul 2016 03:56:19 +0000</resolved>
                                    <version>1.4.5</version>
                                    <fixVersion>1.2.18</fixVersion>
                    <fixVersion>1.4.6</fixVersion>
                    <fixVersion>1.5.6</fixVersion>
                    <fixVersion>1.6.0</fixVersion>
                                    <component>blob</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15379234" author="mwehner" created="Fri, 15 Jul 2016 10:59:42 +0000"  >&lt;p&gt;Attached are proposed patches (for trunk &amp;amp; 1.4) which spool the metadata record to a temporary file and hand that file over to the TransferManager. With this patch we were able to successfully run a Blob GC on our 47TB repository for the first time.&lt;br/&gt;
It&apos;s a bit unfortunate that in the GC case the file already exists on disk and has to be recreated again, but since the signature of &lt;tt&gt;SharedDatastore&lt;/tt&gt; requires an InputStream I see no other way of solving this. Also it kind of slows down the common use case of just creating 0-byte marker records, but this is so infrequent that it shouldn&apos;t be a problem.&lt;/p&gt;</comment>
                            <comment id="15383537" author="amitjain" created="Tue, 19 Jul 2016 03:56:19 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mwehner&quot; class=&quot;user-hover&quot; rel=&quot;mwehner&quot;&gt;mwehner&lt;/a&gt; for the patches. Based on your patch I went ahead and added an overloaded method which takes File an input parameter.&lt;/p&gt;

&lt;p&gt;Also, I created &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-4574&quot; title=&quot;[BlobGC] Remove adding of paths in file maintained for blob references&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-4574&quot;&gt;&lt;del&gt;OAK-4574&lt;/del&gt;&lt;/a&gt; to not add paths in the references file as for 36 million the file is already too big - 5 GB and it will keep getting bigger. Rough calculations indicate that for 36 m references the file could be a third smaller with no paths added.&lt;/p&gt;</comment>
                            <comment id="15383545" author="amitjain" created="Tue, 19 Jul 2016 04:01:21 +0000"  >&lt;p&gt;Committed on trunk with - &lt;a href=&quot;http://svn.apache.org/viewvc?rev=1753331&amp;amp;view=rev&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?rev=1753331&amp;amp;view=rev&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15391306" author="amitjain" created="Mon, 25 Jul 2016 04:17:15 +0000"  >&lt;p&gt;Bulk Close 1.5.6&lt;/p&gt;</comment>
                            <comment id="15403334" author="amitjain" created="Tue, 2 Aug 2016 04:39:21 +0000"  >&lt;p&gt;Merged into 1.4 with &lt;a href=&quot;http://svn.apache.org/viewvc?rev=1754814&amp;amp;view=rev&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?rev=1754814&amp;amp;view=rev&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15403383" author="amitjain" created="Tue, 2 Aug 2016 05:30:26 +0000"  >&lt;p&gt;Merged into 1.2 with &lt;a href=&quot;http://svn.apache.org/viewvc?rev=1754819&amp;amp;view=rev&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?rev=1754819&amp;amp;view=rev&lt;/a&gt;,  &lt;a href=&quot;http://svn.apache.org/viewvc?rev=1754820&amp;amp;view=rev&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?rev=1754820&amp;amp;view=rev&lt;/a&gt; &amp;amp; &lt;a href=&quot;http://svn.apache.org/viewvc?rev=1754821&amp;amp;view=rev&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?rev=1754821&amp;amp;view=rev&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12818145" name="OAK-4565-1.4.patch" size="2945" author="mwehner" created="Fri, 15 Jul 2016 10:59:42 +0000"/>
                            <attachment id="12818146" name="OAK-4565-TRUNK.patch" size="2832" author="mwehner" created="Fri, 15 Jul 2016 10:59:42 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10430"><![CDATA[Patch]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 15 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i310xr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>