<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:42:49 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-1545] NPE in SegmentTracker</title>
                <link>https://issues.apache.org/jira/browse/OAK-1545</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;There is a NPE happening on the SegmentTracker, on what appears to be the cache flush of bulk segments.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;java.lang.NullPointerException: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
	at org.apache.jackrabbit.oak.plugins.segment.Segment.getSegmentId(Segment.java:162)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentTracker.getSegment(SegmentTracker.java:103)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentId.getSegment(SegmentId.java:81)
	at org.apache.jackrabbit.oak.plugins.segment.Record.getSegment(Record.java:68)
	at org.apache.jackrabbit.oak.plugins.segment.BlockRecord.read(BlockRecord.java:52)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentStream.read(SegmentStream.java:156)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentStream.read(SegmentStream.java:125)
	at org.apache.commons.io.IOUtils.copyLarge(IOUtils.java:1792)
	at org.apache.commons.io.IOUtils.copyLarge(IOUtils.java:1769)
	at org.apache.commons.io.IOUtils.copy(IOUtils.java:1744)
	at org.apache.jackrabbit.vault.packaging.impl.JcrPackageImpl.getPackage(JcrPackageImpl.java:346)
	at com.day.jcr.vault.packaging.impl.JrVltJcrPackageAdapter.getPackage(JrVltJcrPackageAdapter.java:86)
	at com.adobe.granite.installer.factory.packages.impl.PackageTransformer$InstallPackageTask.execute(PackageTransformer.java:278)
	at org.apache.sling.installer.core.impl.OsgiInstallerImpl.executeTasks(OsgiInstallerImpl.java:733)
	at org.apache.sling.installer.core.impl.OsgiInstallerImpl.run(OsgiInstallerImpl.java:247)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:744)

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12701840">OAK-1545</key>
            <summary>NPE in SegmentTracker</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jukkaz">Jukka Zitting</assignee>
                                    <reporter username="stillalex">Alex Deparvu</reporter>
                        <labels>
                    </labels>
                <created>Mon, 17 Mar 2014 09:01:43 +0000</created>
                <updated>Mon, 24 Mar 2014 13:36:36 +0000</updated>
                            <resolved>Mon, 17 Mar 2014 14:19:18 +0000</resolved>
                                                    <fixVersion>0.19</fixVersion>
                                    <component>core</component>
                    <component>segmentmk</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13937575" author="alex.parvulescu" created="Mon, 17 Mar 2014 09:04:33 +0000"  >&lt;p&gt;Following javadocs it looks like the refid on the &lt;em&gt;Segment&lt;/em&gt; is null on bulk segments, so the NPE happens when the SegmentTracker tries to do something that resembles a cache eviction when it goes over the allowed size.&lt;/p&gt;

&lt;p&gt;I&apos;m not sure what the &lt;em&gt;segments&lt;/em&gt;&apos;s role is here, it looks like a cache but it is not used for reading the segments, is this maybe a WIP still?&lt;/p&gt;</comment>
                            <comment id="13937578" author="alex.parvulescu" created="Mon, 17 Mar 2014 09:08:43 +0000"  >&lt;p&gt;If I remember correctly, before this refactoring we did not use to cache bulk segments, so if I read the code correctly (assuming the &lt;em&gt;segments&lt;/em&gt; variable represents a cache), I&apos;m just going to skip adding the bulk segments to this cache. This is consistent with previous behavior and also is saves us from overloading the cache with big bulk segments which would only flush everything else.&lt;/p&gt;</comment>
                            <comment id="13937579" author="alex.parvulescu" created="Mon, 17 Mar 2014 09:10:29 +0000"  >&lt;p&gt;I pushed a temp fix based on the mentioned behavior wrt caching of the bulk segments.&lt;br/&gt;
&lt;a href=&quot;http://svn.apache.org/r1578271&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1578271&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jukkaz&quot; class=&quot;user-hover&quot; rel=&quot;jukkaz&quot;&gt;jukkaz&lt;/a&gt; could you please review?&lt;/p&gt;</comment>
                            <comment id="13937848" author="jukkaz" created="Mon, 17 Mar 2014 14:19:18 +0000"  >&lt;p&gt;Thanks for the quick fix!&lt;/p&gt;

&lt;p&gt;As noted, this is still a bit of a work in progress, I was considering removing the &lt;tt&gt;id&lt;/tt&gt; member variable entirely in favor of &lt;tt&gt;refids&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt;&lt;/tt&gt; (which contains the same identifier), but later backtracked as bulk segments don&apos;t need the &lt;tt&gt;refids&lt;/tt&gt; array for anything. The &lt;tt&gt;getSegmentId()&lt;/tt&gt; implementation got accidentally left behind. Revision 1578386 fixes that.&lt;/p&gt;

&lt;p&gt;As for caching bulk segments, the recent changes in making the &lt;tt&gt;SegmentId&lt;/tt&gt; keep a (&lt;tt&gt;volatile&lt;/tt&gt;) reference to the identified segment broke the earlier idea of not buffering bulk data in memory. We should be able to bring that idea back with some further refactorings (ideally with some more benchmarks to validate the concept), but for now in revision 1578387 I just added a simple form of scan resistance by using separate lists for bulk and data semgents.&lt;/p&gt;</comment>
                            <comment id="13945048" author="alex.parvulescu" created="Mon, 24 Mar 2014 13:36:36 +0000"  >&lt;p&gt;Bulk close for the 0.19 release.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>380180</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 34 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1ti7b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>380464</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>