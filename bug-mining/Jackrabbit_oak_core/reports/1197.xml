<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:47:43 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-2662] SegmentOverflowException in HeavyWriteIT on Jenkins</title>
                <link>https://issues.apache.org/jira/browse/OAK-2662</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;heavyWrite(org.apache.jackrabbit.oak.plugins.segment.HeavyWriteIT)  Time elapsed: 96.384 sec  &amp;lt;&amp;lt;&amp;lt; ERROR!
org.apache.jackrabbit.oak.plugins.segment.SegmentOverflowException: Segment cannot have more than 255 references 47a9dc3c-c6f9-4b5f-a61a-6711da8b68c2
	at org.apache.jackrabbit.oak.plugins.segment.SegmentWriter.getSegmentRef(SegmentWriter.java:353)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentWriter.writeRecordId(SegmentWriter.java:382)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentWriter.writeMapLeaf(SegmentWriter.java:426)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentWriter.writeMapBucket(SegmentWriter.java:484)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentWriter.writeMapBucket(SegmentWriter.java:511)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentWriter.writeMap(SegmentWriter.java:720)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentWriter.writeNode(SegmentWriter.java:1108)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentWriter$2.childNodeChanged(SegmentWriter.java:1091)
	at org.apache.jackrabbit.oak.plugins.memory.ModifiedNodeState.compareAgainstBaseState(ModifiedNodeState.java:396)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentWriter.writeNode(SegmentWriter.java:1082)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentWriter.writeNode(SegmentWriter.java:1110)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeBuilder.getNodeState(SegmentNodeBuilder.java:97)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeBuilder.updated(SegmentNodeBuilder.java:83)
	at org.apache.jackrabbit.oak.plugins.memory.MemoryNodeBuilder.updated(MemoryNodeBuilder.java:214)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeBuilder.updated(SegmentNodeBuilder.java:79)
	at org.apache.jackrabbit.oak.plugins.memory.MemoryNodeBuilder.setProperty(MemoryNodeBuilder.java:501)
	at org.apache.jackrabbit.oak.plugins.memory.MemoryNodeBuilder.setProperty(MemoryNodeBuilder.java:507)
	at org.apache.jackrabbit.oak.plugins.segment.HeavyWriteIT.createProperties(HeavyWriteIT.java:137)
	at org.apache.jackrabbit.oak.plugins.segment.HeavyWriteIT.createNodes(HeavyWriteIT.java:129)
	at org.apache.jackrabbit.oak.plugins.segment.HeavyWriteIT.createNodes(HeavyWriteIT.java:130)
	at org.apache.jackrabbit.oak.plugins.segment.HeavyWriteIT.heavyWrite(HeavyWriteIT.java:110)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;See &lt;a href=&quot;https://builds.apache.org/job/Apache%20Jackrabbit%20Oak%20matrix/35/jdk=jdk1.8.0_11,label=Ubuntu,nsfixtures=SEGMENT_MK,profile=integrationTesting/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Apache%20Jackrabbit%20Oak%20matrix/35/jdk=jdk1.8.0_11,label=Ubuntu,nsfixtures=SEGMENT_MK,profile=integrationTesting/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=alex.parvulescu&quot; class=&quot;user-hover&quot; rel=&quot;alex.parvulescu&quot;&gt;alex.parvulescu&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12783856">OAK-2662</key>
            <summary>SegmentOverflowException in HeavyWriteIT on Jenkins</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mduerig">Michael D&#252;rig</assignee>
                                    <reporter username="mduerig">Michael D&#252;rig</reporter>
                        <labels>
                            <label>CI</label>
                            <label>jenkins</label>
                    </labels>
                <created>Sat, 21 Mar 2015 12:03:42 +0000</created>
                <updated>Wed, 2 Mar 2016 11:22:42 +0000</updated>
                            <resolved>Wed, 15 Apr 2015 15:47:37 +0000</resolved>
                                                    <fixVersion>1.0.13</fixVersion>
                    <fixVersion>1.2.1</fixVersion>
                    <fixVersion>1.3.0</fixVersion>
                    <fixVersion>1.4</fixVersion>
                                    <component>segmentmk</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14390248" author="mduerig" created="Wed, 1 Apr 2015 08:57:46 +0000"  >&lt;p&gt;Also seen this from the compactor while working on &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-2713&quot; title=&quot;High memory usage of CompactionMap&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-2713&quot;&gt;&lt;del&gt;OAK-2713&lt;/del&gt;&lt;/a&gt;:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.jackrabbit.oak.plugins.segment.SegmentOverflowException: Segment cannot have more than 255 references 49ef8546-5ca5-4888-a804-f86b7cd1c63b
	at org.apache.jackrabbit.oak.plugins.segment.SegmentWriter.getSegmentRef(SegmentWriter.java:352)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentWriter.writeRecordId(SegmentWriter.java:382)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentWriter.writeListBucket(SegmentWriter.java:457)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentWriter.writeList(SegmentWriter.java:656)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentWriter.writeLargeBlob(SegmentWriter.java:801)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentBlob.clone(SegmentBlob.java:187)
	at org.apache.jackrabbit.oak.plugins.segment.Compactor.compact(Compactor.java:237)
	at org.apache.jackrabbit.oak.plugins.segment.Compactor.compact(Compactor.java:185)
	at org.apache.jackrabbit.oak.plugins.segment.Compactor.access$000(Compactor.java:49)
	at org.apache.jackrabbit.oak.plugins.segment.Compactor$CompactDiff.propertyAdded(Compactor.java:115)
	at org.apache.jackrabbit.oak.plugins.memory.EmptyNodeState.compareAgainstEmptyState(EmptyNodeState.java:156)
	at org.apache.jackrabbit.oak.plugins.segment.Compactor$CompactDiff.childNodeAdded(Compactor.java:137)
	at org.apache.jackrabbit.oak.plugins.memory.EmptyNodeState.compareAgainstEmptyState(EmptyNodeState.java:161)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeState.compareAgainstBaseState(SegmentNodeState.java:434)
	at org.apache.jackrabbit.oak.plugins.segment.Compactor.process(Compactor.java:92)
	at org.apache.jackrabbit.oak.plugins.segment.Compactor.compact(Compactor.java:97)
	at org.apache.jackrabbit.oak.plugins.segment.file.FileStore.compact(FileStore.java:703)
	at org.apache.jackrabbit.oak.plugins.segment.file.FileStore.maybeCompact(FileStore.java:466)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14390259" author="mduerig" created="Wed, 1 Apr 2015 09:11:55 +0000"  >&lt;p&gt;And again:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.jackrabbit.oak.api.CommitFailedException: OakSegment0003: Merge failed
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeStore.merge(SegmentNodeStore.java:172)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentCompactionIT.run(SegmentCompactionIT.java:127)
Caused by: org.apache.jackrabbit.oak.plugins.segment.SegmentOverflowException: Segment cannot have more than 255 references b26f7210-0e03-45ce-acc9-ef18f5420af0
	at org.apache.jackrabbit.oak.plugins.segment.SegmentWriter.getSegmentRef(SegmentWriter.java:352)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentWriter.writeRecordId(SegmentWriter.java:382)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentWriter.writeMapLeaf(SegmentWriter.java:426)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentWriter.writeMapBucket(SegmentWriter.java:484)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentWriter.writeMapBucket(SegmentWriter.java:511)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentWriter.writeMapBucket(SegmentWriter.java:520)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentWriter.writeMap(SegmentWriter.java:720)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentWriter.writeNode(SegmentWriter.java:1108)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeBuilder.getNodeState(SegmentNodeBuilder.java:100)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeStore$Commit.&amp;lt;init&amp;gt;(SegmentNodeStore.java:375)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeStore.merge(SegmentNodeStore.java:161)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14390260" author="mduerig" created="Wed, 1 Apr 2015 09:13:46 +0000"  >&lt;p&gt;Patch with the (WIP) code I ran while I encountered this. Just start the test and leave it running. It won&apos;t succeed but probably fail at some point. &lt;/p&gt;</comment>
                            <comment id="14391454" author="mduerig" created="Wed, 1 Apr 2015 21:03:08 +0000"  >&lt;p&gt;Here it is: &lt;a href=&quot;https://github.com/apache/jackrabbit-oak/blob/trunk/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/SegmentWriter.java#L356&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/jackrabbit-oak/blob/trunk/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/SegmentWriter.java#L356&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Using reference equality instead of &lt;tt&gt;equals&lt;/tt&gt; to check whether a &lt;tt&gt;SegmentId&lt;/tt&gt; is already in the segment reference table. This can cause &lt;tt&gt;SegmentId&lt;/tt&gt; s to end up multiple times in the table filling it up more rapidly than anticipated by &lt;tt&gt;prepare()&lt;/tt&gt;. So far I couldn&apos;t reproduce the &lt;tt&gt;SOE&lt;/tt&gt; after replacing with &lt;tt&gt;equals&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;As there are other places in the code where &lt;tt&gt;SegmentId&lt;/tt&gt; s are compared through reference equality I assume this is intentional. &lt;tt&gt;id1 == id2&lt;/tt&gt; iff &lt;tt&gt;id1.equals(id2)&lt;/tt&gt; was probably correct before we introduced the &lt;tt&gt;CLEANUP_OLD&lt;/tt&gt; strategy. The latter might introduce multiple instances of the same segment id. &lt;/p&gt;</comment>
                            <comment id="14391459" author="mduerig" created="Wed, 1 Apr 2015 21:05:20 +0000"  >&lt;p&gt;We probably need to review the complete SegmentMK code base and replace reference equality checks of segment ids with &lt;tt&gt;equals&lt;/tt&gt;. &lt;/p&gt;</comment>
                            <comment id="14392505" author="rombert" created="Thu, 2 Apr 2015 10:27:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://builds.apache.org/job/Apache%20Jackrabbit%20Oak%20matrix/84/findbugsResult/type.-151669862/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Apache%20Jackrabbit%20Oak%20matrix/84/findbugsResult/type.-151669862/&lt;/a&gt; should be a good start&lt;/p&gt;</comment>
                            <comment id="14487542" author="mduerig" created="Thu, 9 Apr 2015 15:43:33 +0000"  >&lt;p&gt;Test case and proposed fix: &lt;a href=&quot;https://github.com/mduerig/jackrabbit-oak/commits/OAK-2662&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/mduerig/jackrabbit-oak/commits/OAK-2662&lt;/a&gt;. &lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=alex.parvulescu&quot; class=&quot;user-hover&quot; rel=&quot;alex.parvulescu&quot;&gt;alex.parvulescu&lt;/a&gt; WDYT?&lt;/p&gt;</comment>
                            <comment id="14495792" author="mduerig" created="Wed, 15 Apr 2015 07:21:07 +0000"  >&lt;p&gt;Fixed in trunk: &lt;a href=&quot;http://svn.apache.org/r1673663&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1673663&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14495851" author="mduerig" created="Wed, 15 Apr 2015 08:31:01 +0000"  >&lt;p&gt;Fixed in 1.2 at &lt;a href=&quot;http://svn.apache.org/r1673671&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1673671&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14496279" author="mduerig" created="Wed, 15 Apr 2015 14:50:07 +0000"  >&lt;p&gt;Reopening for merging into 1.0&lt;/p&gt;</comment>
                            <comment id="14496411" author="mduerig" created="Wed, 15 Apr 2015 15:47:37 +0000"  >&lt;p&gt;Fixed in 1.0 branch at &lt;a href=&quot;http://svn.apache.org/r1673817&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1673817&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14502513" author="mreutegg" created="Mon, 20 Apr 2015 08:32:21 +0000"  >&lt;p&gt;Bulk close for 1.2.1 release.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="12787040">OAK-2713</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12708646" name="OAK-2662.patch" size="8094" author="mduerig" created="Wed, 1 Apr 2015 09:13:46 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 30 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2731r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>