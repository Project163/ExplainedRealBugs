<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:47:44 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-2723] FileStore does not scale because of precomputed graph on TarReader</title>
                <link>https://issues.apache.org/jira/browse/OAK-2723</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;The &lt;tt&gt;FileStore&lt;/tt&gt; keeps a reference to all &lt;tt&gt;TarReader&lt;/tt&gt; object, one per each file. In my test, for an ~350 Gb repository, that was ~1100 tar files, with a &lt;tt&gt;TarReader&lt;/tt&gt; for each. &lt;/p&gt;

&lt;p&gt;The problem is &lt;tt&gt;TarReader&lt;/tt&gt; keeps a reference to a precomputed &lt;em&gt;graph&lt;/em&gt; &lt;tt&gt;ByteBuffer&lt;/tt&gt;, which is not really used that much. That means that through the &lt;tt&gt;readers&lt;/tt&gt; field, there&apos;s a reference to these &lt;em&gt;graphs&lt;/em&gt;,  which means they can&apos;t be GC&apos;ed.&lt;/p&gt;

&lt;p&gt;The construction of &lt;tt&gt;FileStore&lt;/tt&gt; is from oak-run:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;FileStore store = new FileStore(directory, 256, TAR_STORAGE_MEMORY_MAPPED);&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The effect is you need more that 6GB of Ram just to instantiate the &lt;tt&gt;FileStore&lt;/tt&gt; object.&lt;/p&gt;

&lt;p&gt;The attached patch fixes this issue. &lt;/p&gt;</description>
                <environment></environment>
        <key id="12818906">OAK-2723</key>
            <summary>FileStore does not scale because of precomputed graph on TarReader</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mduerig">Michael D&#252;rig</assignee>
                                    <reporter username="andrei.dulvac">Andrei Dulvac</reporter>
                        <labels>
                    </labels>
                <created>Tue, 7 Apr 2015 12:02:59 +0000</created>
                <updated>Wed, 2 Mar 2016 11:33:17 +0000</updated>
                            <resolved>Wed, 15 Apr 2015 08:31:18 +0000</resolved>
                                    <version>1.1.8</version>
                                    <fixVersion>1.2.1</fixVersion>
                    <fixVersion>1.3.0</fixVersion>
                    <fixVersion>1.4</fixVersion>
                                    <component>core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14483072" author="andrei.dulvac" created="Tue, 7 Apr 2015 12:04:35 +0000"  >&lt;p&gt;Attached patch created with &lt;tt&gt;git format-patch HEAD~1&lt;/tt&gt;&lt;br/&gt;
Apply with &lt;tt&gt;patch -p1 -i 0001-TarReader-fix-for-precomputed-graph.patch&lt;/tt&gt;&lt;/p&gt;</comment>
                            <comment id="14483073" author="andrei.dulvac" created="Tue, 7 Apr 2015 12:05:10 +0000"  >&lt;p&gt;If you need a memory dump, I can provide that offline, it&apos;s not possible (or desirable) to attach it in jira.&lt;/p&gt;</comment>
                            <comment id="14485493" author="mduerig" created="Wed, 8 Apr 2015 16:36:33 +0000"  >&lt;p&gt;The pre computed segment graph has been introduced with &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-1780&quot; title=&quot;Faster TarMK cleanup&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-1780&quot;&gt;&lt;del&gt;OAK-1780&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="14485503" author="mduerig" created="Wed, 8 Apr 2015 16:42:06 +0000"  >&lt;p&gt;Patch looks good from a first look. However it has some performance impact on online compaction. Most likely neglectable though. I will include the patch in my testing for &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-2713&quot; title=&quot;High memory usage of CompactionMap&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-2713&quot;&gt;&lt;del&gt;OAK-2713&lt;/del&gt;&lt;/a&gt; and give it a spin. &lt;/p&gt;</comment>
                            <comment id="14495795" author="mduerig" created="Wed, 15 Apr 2015 07:25:49 +0000"  >&lt;p&gt;Fixed in trunk: &lt;a href=&quot;http://svn.apache.org/r1673664&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1673664&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14495852" author="mduerig" created="Wed, 15 Apr 2015 08:31:05 +0000"  >&lt;p&gt;Fixed in 1.2 at &lt;a href=&quot;http://svn.apache.org/r1673673&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1673673&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14502510" author="mreutegg" created="Mon, 20 Apr 2015 08:32:20 +0000"  >&lt;p&gt;Bulk close for 1.2.1 release.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12787040">OAK-2713</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12711170">OAK-1780</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12723611" name="0001-TarReader-fix-for-precomputed-graph.patch" size="2763" author="andrei.dulvac" created="Tue, 7 Apr 2015 12:04:35 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10430"><![CDATA[Patch]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 30 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2cwlb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>