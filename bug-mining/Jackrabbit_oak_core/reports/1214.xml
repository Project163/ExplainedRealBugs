<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:47:52 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-2663] Unique property index can trigger OOM during upgrade of large repository</title>
                <link>https://issues.apache.org/jira/browse/OAK-2663</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;&lt;tt&gt;PropertyIndexEditor&lt;/tt&gt; when configured for unique index maintains an in memory state of indexed property in &lt;tt&gt;keysToCheckForUniqueness&lt;/tt&gt;. This set would accumulate all the unique values being indexed.&lt;/p&gt;

&lt;p&gt;In case of upgrade where the complete upgrade is performed in single commit this state can become very large. Further later while exiting the editor validates that all such values are actually unique by iterating over all such values.&lt;/p&gt;

&lt;p&gt;We should look into other possible ways to enforce uniqueness constraint&lt;/p&gt;</description>
                <environment></environment>
        <key id="12783861">OAK-2663</key>
            <summary>Unique property index can trigger OOM during upgrade of large repository</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="thomasm">Thomas Mueller</assignee>
                                    <reporter username="chetanm">Chetan Mehrotra</reporter>
                        <labels>
                            <label>performance</label>
                            <label>resilience</label>
                    </labels>
                <created>Sat, 21 Mar 2015 12:32:52 +0000</created>
                <updated>Tue, 8 Oct 2019 15:21:34 +0000</updated>
                            <resolved>Thu, 21 May 2015 07:19:11 +0000</resolved>
                                                    <fixVersion>1.0.15</fixVersion>
                    <fixVersion>1.2.3</fixVersion>
                    <fixVersion>1.3.0</fixVersion>
                    <fixVersion>1.4</fixVersion>
                                    <component>upgrade</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="14372712" author="chetanm" created="Sat, 21 Mar 2015 12:34:50 +0000"  >&lt;p&gt;In one the upgrade (to segment) disabling the last check for uniqueness constraint saved 8 mins (time in index editor reduced from 40 min to 32 min for ~13 M nodes). I believe the saving would be higher when using Mongo&lt;/p&gt;</comment>
                            <comment id="14372865" author="alex.parvulescu" created="Sat, 21 Mar 2015 16:08:48 +0000"  >&lt;p&gt;proposed patch.&lt;/p&gt;

&lt;p&gt;The idea behind this is to apply the unique keys directly to the index on each level and at the same time record possible conflicts. this will reduce buffering of the keys by quite a lot. The possible conflicts will be rechecked at the end to filter out valid operations (like node moves). patch passes all tests.&lt;/p&gt;

&lt;p&gt;as a side note my heavy upgrade test of a 13M nodes repo (same as Chetan&apos;s) falls down from 35 mins to under 29 mins, but as mentioned gains on Mongo might be higher. cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chetanm&quot; class=&quot;user-hover&quot; rel=&quot;chetanm&quot;&gt;chetanm&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14379923" author="chetanm" created="Wed, 25 Mar 2015 14:28:32 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thomasm&quot; class=&quot;user-hover&quot; rel=&quot;thomasm&quot;&gt;thomasm&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mduerig&quot; class=&quot;user-hover&quot; rel=&quot;mduerig&quot;&gt;mduerig&lt;/a&gt; Can you review the patch. It would be helpful to have this included&lt;/p&gt;</comment>
                            <comment id="14543388" author="chetanm" created="Thu, 14 May 2015 08:36:41 +0000"  >&lt;p&gt;ping &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thomasm&quot; class=&quot;user-hover&quot; rel=&quot;thomasm&quot;&gt;thomasm&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mduerig&quot; class=&quot;user-hover&quot; rel=&quot;mduerig&quot;&gt;mduerig&lt;/a&gt; Can you have a look at the patch. This behaviour causing large memory requirement for bigger migration and also slows done the migration. So having this fixed would be helpful &lt;/p&gt;</comment>
                            <comment id="14550551" author="tmueller" created="Tue, 19 May 2015 14:43:55 +0000"  >&lt;p&gt;There was some change since the patch, but other than that it looks OK.&lt;br/&gt;
I&apos;m trying to write a special test case for it.&lt;/p&gt;</comment>
                            <comment id="14552304" author="tmueller" created="Wed, 20 May 2015 13:22:05 +0000"  >&lt;p&gt;&lt;a href=&quot;https://svn.apache.org/r1680559&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1680559&lt;/a&gt; (trunk)&lt;/p&gt;</comment>
                            <comment id="14552311" author="tmueller" created="Wed, 20 May 2015 13:27:29 +0000"  >&lt;p&gt;I made some changes to the patch, for example I split the combined method filterFailingUniques. I used a more conservative approach to detect duplicates: the node itself is checked (same as in the old code), not just the existence of the node (as in the patch). While adding entries, it is now checked that the same path is only indexed once. I made those changes because a test case showed problems with the existing approach: if an index is outdated (for example by removing nodes directly in MongoDB), then re-adding the nodes that are already indexed will result in a duplicate key exception. This is now prevented. I also removed some untested, and currently unused code (ContentMirrorStoreStrategy.exists), but added a comment to this issue if this code is ever needed.&lt;/p&gt;</comment>
                            <comment id="14552345" author="tmueller" created="Wed, 20 May 2015 13:59:46 +0000"  >&lt;p&gt;&lt;a href=&quot;https://svn.apache.org/r1680577&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1680577&lt;/a&gt; (1.2 branch)&lt;/p&gt;</comment>
                            <comment id="14553771" author="tmueller" created="Thu, 21 May 2015 07:19:00 +0000"  >&lt;p&gt;&lt;a href=&quot;https://svn.apache.org/r1680748&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1680748&lt;/a&gt; (1.0 branch) - a few changes were need to apply the patch&lt;/p&gt;</comment>
                            <comment id="14585999" author="edivad" created="Mon, 15 Jun 2015 13:45:45 +0000"  >&lt;p&gt;Bulk Close for 1.3.0&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12706169" name="OAK-2663.patch" size="6104" author="stillalex" created="Sat, 21 Mar 2015 16:08:48 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 22 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2732v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>