<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:49:47 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-2539] SQL2 query not working with filter (s.[stringa] = &apos;a&apos; OR CONTAINS(s.[stringb], &apos;b&apos;))</title>
                <link>https://issues.apache.org/jira/browse/OAK-2539</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;Create node /content/usergenerated/qtest with jcr:primaryType nt:unstrucuted.&lt;/p&gt;

&lt;p&gt;Add 2 String properties: stringa = &quot;a&quot;, stringb = &quot;b&quot;.&lt;/p&gt;

&lt;p&gt;Use query tool in CRX/DE to do SQL2 search:&lt;br/&gt;
This search will find qtest:&lt;br/&gt;
SELECT * FROM &lt;span class=&quot;error&quot;&gt;&amp;#91;nt:base&amp;#93;&lt;/span&gt; AS s WHERE ISDESCENDANTNODE(&lt;span class=&quot;error&quot;&gt;&amp;#91;/content/usergenerated/&amp;#93;&lt;/span&gt;) AND (s.&lt;span class=&quot;error&quot;&gt;&amp;#91;stringa&amp;#93;&lt;/span&gt; = &apos;a&apos; OR CONTAINS(s.&lt;span class=&quot;error&quot;&gt;&amp;#91;stringb&amp;#93;&lt;/span&gt;, &apos;b&apos;))&lt;br/&gt;
This search will find qtest:&lt;br/&gt;
SELECT * FROM &lt;span class=&quot;error&quot;&gt;&amp;#91;nt:base&amp;#93;&lt;/span&gt; AS s WHERE ISDESCENDANTNODE(&lt;span class=&quot;error&quot;&gt;&amp;#91;/content/usergenerated/&amp;#93;&lt;/span&gt;) AND (CONTAINS(s.&lt;span class=&quot;error&quot;&gt;&amp;#91;stringb&amp;#93;&lt;/span&gt;, &apos;b&apos;))&lt;br/&gt;
This search will not find qtest:&lt;br/&gt;
SELECT * FROM &lt;span class=&quot;error&quot;&gt;&amp;#91;nt:base&amp;#93;&lt;/span&gt; AS s WHERE ISDESCENDANTNODE(&lt;span class=&quot;error&quot;&gt;&amp;#91;/content/usergenerated/&amp;#93;&lt;/span&gt;) AND (s.&lt;span class=&quot;error&quot;&gt;&amp;#91;stringa&amp;#93;&lt;/span&gt; = &apos;x&apos; OR CONTAINS(s.&lt;span class=&quot;error&quot;&gt;&amp;#91;stringb&amp;#93;&lt;/span&gt;, &apos;b&apos;))&lt;/p&gt;</description>
                <environment></environment>
        <key id="12776312">OAK-2539</key>
            <summary>SQL2 query not working with filter (s.[stringa] = &apos;a&apos; OR CONTAINS(s.[stringb], &apos;b&apos;))</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="thomasm">Thomas Mueller</assignee>
                                    <reporter username="cawong">Calvin Wong</reporter>
                        <labels>
                    </labels>
                <created>Thu, 19 Feb 2015 23:33:57 +0000</created>
                <updated>Fri, 8 Dec 2017 12:48:58 +0000</updated>
                            <resolved>Fri, 20 Nov 2015 15:36:33 +0000</resolved>
                                                    <fixVersion>1.3.11</fixVersion>
                    <fixVersion>1.4</fixVersion>
                                    <component>core</component>
                    <component>query</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14576942" author="edivad" created="Mon, 8 Jun 2015 09:48:37 +0000"  >&lt;p&gt;Bulk move to 1.3.1&lt;/p&gt;</comment>
                            <comment id="14595628" author="edivad" created="Mon, 22 Jun 2015 09:46:16 +0000"  >&lt;p&gt;Bulk move to 1.3.2&lt;/p&gt;</comment>
                            <comment id="14610163" author="edivad" created="Wed, 1 Jul 2015 13:05:20 +0000"  >&lt;p&gt;Bulk move to 1.3.3.&lt;/p&gt;</comment>
                            <comment id="14633328" author="edivad" created="Mon, 20 Jul 2015 10:05:01 +0000"  >&lt;p&gt;Bulk move to 1.3.4&lt;/p&gt;</comment>
                            <comment id="14743133" author="mreutegg" created="Mon, 14 Sep 2015 08:32:12 +0000"  >&lt;p&gt;Bulk move to 1.3.7&lt;/p&gt;</comment>
                            <comment id="15013557" author="tmueller" created="Thu, 19 Nov 2015 13:45:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-1617&quot; title=&quot;Automatically convert &amp;quot;or&amp;quot; queries to &amp;quot;union&amp;quot; for SQL-2&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-1617&quot;&gt;&lt;del&gt;OAK-1617&lt;/del&gt;&lt;/a&gt; is already set to fixed, so in theory this should resolve &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-2539&quot; title=&quot;SQL2 query not working with filter (s.[stringa] = &amp;#39;a&amp;#39; OR CONTAINS(s.[stringb], &amp;#39;b&amp;#39;))&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-2539&quot;&gt;&lt;del&gt;OAK-2539&lt;/del&gt;&lt;/a&gt; as well; I will check.&lt;/p&gt;</comment>
                            <comment id="15013582" author="tmueller" created="Thu, 19 Nov 2015 14:04:11 +0000"  >&lt;p&gt;With trunk, the debug log for this query is (see below) indicates problem is solved:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;QueryEngineImpl Parsing JCR-SQL2 statement: SELECT * FROM [nt:base] AS s 
    WHERE ISDESCENDANTNODE([/content/usergenerated/]) 
    AND (s.[stringa] = &apos;a&apos; OR CONTAINS(s.[stringb], &apos;b&apos;))
QueryEngineImpl Optimised query available. select [s].[jcr:primaryType] as [s.jcr:primaryType] 
    from [nt:base] as [s] where ([s].[stringa] = &apos;a&apos;) 
    and (isdescendantnode([s], [/content/usergenerated/])) 
    union select [s].[jcr:primaryType] as [s.jcr:primaryType] 
    from [nt:base] as [s] where (contains([s].[stringb], &apos;b&apos;)) 
    and (isdescendantnode([s], [/content/usergenerated/]))
QueryEngineImpl Preparing: select [s].[jcr:primaryType] as [s.jcr:primaryType] 
    from [nt:base] as [s] where (isdescendantnode([s], [/content/usergenerated/])) 
    and ((contains([s].[stringb], &apos;b&apos;)) or ([s].[stringa] = &apos;a&apos;))
QueryImpl cost using filter Filter(query=SELECT * FROM [nt:base] AS s 
    WHERE ISDESCENDANTNODE([/content/usergenerated/]) AND (s.[stringa] = &apos;a&apos; 
    OR CONTAINS(s.[stringb], &apos;b&apos;)), path=/content/usergenerated//*)
QueryImpl cost for reference is Infinity
QueryImpl cost for property is Infinity
QueryImpl cost for nodeType is Infinity
QueryImpl cost for lucene-property is Infinity
QueryImpl cost for aggregate lucene is Infinity
QueryImpl cost for ordered is Infinity
QueryImpl cost for traverse is 2100.0
QueryEngineImpl actualCost: 2100.0 - costOverhead: 1.7976931348623157E308 - overallCost: 1.7976931348623157E308
QueryEngineImpl Preparing: select [s].[jcr:primaryType] as [s.jcr:primaryType] 
    from [nt:base] as [s] where ([s].[stringa] = &apos;a&apos;) 
    and (isdescendantnode([s], [/content/usergenerated/])) 
    union select [s].[jcr:primaryType] as [s.jcr:primaryType] 
    from [nt:base] as [s] where (contains([s].[stringb], &apos;b&apos;)) 
    and (isdescendantnode([s], [/content/usergenerated/]))
QueryImpl cost using filter Filter(query=SELECT * FROM [nt:base] AS s 
    WHERE ([s].[stringa] = &apos;a&apos;) and (isdescendantnode([s], [/content/usergenerated/])), 
    path=/content/usergenerated//*, property=[stringa=[a]])
QueryImpl cost for reference is Infinity
QueryImpl cost for property is Infinity
QueryImpl cost for nodeType is Infinity
QueryImpl cost for lucene-property is Infinity
QueryImpl cost for aggregate lucene is Infinity
QueryImpl cost for ordered is Infinity
QueryImpl cost for traverse is 2100.0
QueryImpl cost using filter Filter(query=SELECT * FROM [nt:base] AS s 
    WHERE (contains([s].[stringb], &apos;b&apos;)) and (isdescendantnode([s], [/content/usergenerated/])) 
    fullText=stringb:&quot;b&quot;, path=/content/usergenerated//*, property=[stringb=[is not null]])
QueryImpl cost for reference is Infinity
QueryImpl cost for property is Infinity
QueryImpl cost for nodeType is Infinity
QueryImpl cost for lucene-property is Infinity
QueryImpl cost for aggregate lucene is 198919.0
QueryImpl cost for ordered is Infinity
QueryImpl cost for traverse is Infinity
QueryEngineImpl actualCost: 201019.0 - costOverhead: 0.0 - overallCost: 201019.0
QueryEngineImpl Cheapest cost: 201019.0 - query: select [s].[jcr:primaryType] as [s.jcr:primaryType] 
    from [nt:base] as [s] where ([s].[stringa] = &apos;a&apos;) 
    and (isdescendantnode([s], [/content/usergenerated/])) 
    union select [s].[jcr:primaryType] as [s.jcr:primaryType] 
    from [nt:base] as [s] where (contains([s].[stringb], &apos;b&apos;)) 
    and (isdescendantnode([s], [/content/usergenerated/]))
UnionQueryImpl query union plan [nt:base] as [s] /* traverse &quot;/content/usergenerated//*&quot; 
    where ([s].[stringa] = &apos;a&apos;) and (isdescendantnode([s], [/content/usergenerated/])) */ 
    union [nt:base] as [s] /* aggregate stringb:b ft:(stringb:&quot;b&quot;) 
    where (contains([s].[stringb], &apos;b&apos;)) 
    and (isdescendantnode([s], [/content/usergenerated/])) */
QueryImpl query execute SELECT * FROM [nt:base] AS s WHERE ([s].[stringa] = &apos;a&apos;) 
    and (isdescendantnode([s], [/content/usergenerated/]))
QueryImpl query plan [nt:base] as [s] /* traverse &quot;/content/usergenerated//*&quot; 
    where ([s].[stringa] = &apos;a&apos;) and (isdescendantnode([s], [/content/usergenerated/])) */
QueryImpl query execute SELECT * FROM [nt:base] AS s WHERE (contains([s].[stringb], &apos;b&apos;)) 
    and (isdescendantnode([s], [/content/usergenerated/]))
QueryImpl query plan [nt:base] as [s] /* aggregate stringb:b ft:(stringb:&quot;b&quot;) 
    where (contains([s].[stringb], &apos;b&apos;)) 
    and (isdescendantnode([s], [/content/usergenerated/])) */
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15013596" author="tmueller" created="Thu, 19 Nov 2015 14:12:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=edivad&quot; class=&quot;user-hover&quot; rel=&quot;edivad&quot;&gt;edivad&lt;/a&gt;, the problem seems to be fixed, right?&lt;/p&gt;</comment>
                            <comment id="15013600" author="edivad" created="Thu, 19 Nov 2015 14:18:20 +0000"  >&lt;p&gt;if it returns the right resultset it is &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;By looking at the logs I can see the query engine detected a condition in the original query that is better suited with a Union even if the cost of the first is lower (see cost overhead)&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;QueryEngineImpl actualCost: 2100.0 - costOverhead: 1.7976931348623157E308 - overallCost: 1.7976931348623157E308
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;so on paper I&apos;d say it&apos;s resolved.&lt;/p&gt;</comment>
                            <comment id="15013648" author="tmueller" created="Thu, 19 Nov 2015 14:57:54 +0000"  >&lt;p&gt;I will do some minor changes to the log message, rename a method (currently named oak2660CostOverhead), and get rid of an &quot;instanceof&quot;.&lt;/p&gt;</comment>
                            <comment id="15013704" author="tmueller" created="Thu, 19 Nov 2015 15:32:04 +0000"  >&lt;p&gt;Right now, only &quot;contains&quot; full-text conditions are converted to union, but not conditions of type &quot;not contains&quot;, &quot;similar&quot;, spellcheck, suggest.&lt;/p&gt;</comment>
                            <comment id="15018025" author="tmueller" created="Fri, 20 Nov 2015 13:37:08 +0000"  >&lt;p&gt;&lt;a href=&quot;http://svn.apache.org/r1715347&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1715347&lt;/a&gt; (fixes above bugs)&lt;br/&gt;
&lt;a href=&quot;http://svn.apache.org/r1715359&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1715359&lt;/a&gt; (more fixes)&lt;/p&gt;

&lt;p&gt;Now need more test cases, and simplification.&lt;/p&gt;</comment>
                            <comment id="15018067" author="tmueller" created="Fri, 20 Nov 2015 14:15:55 +0000"  >&lt;p&gt;&lt;a href=&quot;http://svn.apache.org/r1715367&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1715367&lt;/a&gt; (get rid of the MdcAndPrepared class)&lt;/p&gt;</comment>
                            <comment id="15018161" author="tmueller" created="Fri, 20 Nov 2015 15:36:02 +0000"  >&lt;p&gt;&lt;a href=&quot;http://svn.apache.org/r1715377&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1715377&lt;/a&gt; (rename methods and the enum)&lt;/p&gt;</comment>
                            <comment id="15029389" author="amitjain" created="Fri, 27 Nov 2015 03:21:55 +0000"  >&lt;p&gt;Bulk close for 1.3.11&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13048724">OAK-5896</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12783687">OAK-2660</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12703706">OAK-1617</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 51 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i25u2f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>