<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:48:59 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-3388] Inconsistent read in cluster with clock differences</title>
                <link>https://issues.apache.org/jira/browse/OAK-3388</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;This issue is similar to &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-2929&quot; title=&quot;Parent of unseen children must not be removable&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-2929&quot;&gt;&lt;del&gt;OAK-2929&lt;/del&gt;&lt;/a&gt; but related to how the DocumentNodeStore reads a node state when there is a clock difference between multiple cluster nodes. The node state read from a NodeDocument may not be correct when there is a clock difference.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12863035">OAK-3388</key>
            <summary>Inconsistent read in cluster with clock differences</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mreutegg">Marcel Reutegger</assignee>
                                    <reporter username="mreutegg">Marcel Reutegger</reporter>
                        <labels>
                            <label>resilience</label>
                    </labels>
                <created>Thu, 10 Sep 2015 12:39:42 +0000</created>
                <updated>Wed, 2 Mar 2016 14:29:06 +0000</updated>
                            <resolved>Tue, 29 Sep 2015 14:57:05 +0000</resolved>
                                    <version>1.0</version>
                    <version>1.2</version>
                                    <fixVersion>1.0.22</fixVersion>
                    <fixVersion>1.2.7</fixVersion>
                    <fixVersion>1.3.8</fixVersion>
                    <fixVersion>1.4</fixVersion>
                                    <component>core</component>
                    <component>mongomk</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14738709" author="mreutegg" created="Thu, 10 Sep 2015 13:01:36 +0000"  >&lt;p&gt;Add a test (currently ignored): &lt;a href=&quot;http://svn.apache.org/r1702241&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1702241&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14747144" author="mreutegg" created="Wed, 16 Sep 2015 08:36:21 +0000"  >&lt;p&gt;I think there is a more fundamental problem with the current use of RevisionComparator&lt;br/&gt;
and how revisions are compared across cluster nodes.&lt;/p&gt;

&lt;p&gt;Changes from other cluster nodes are made visible in a bulk operation by adding the&lt;br/&gt;
_lastRev on the root document of another cluster to the RevisionComparator at a given&lt;br/&gt;
&apos;seenAt&apos; revision. This &apos;seenAt&apos; revision is the same for all new _lastRevs seen&lt;br/&gt;
from other cluster nodes. The problem now is when two revisions from other cluster nodes&lt;br/&gt;
are compared and they have the same &apos;seenAt&apos; revision. The RevisionComparator will simply&lt;br/&gt;
decide which revision comes first based on the clusterId. Assume we have three cluster nodes&lt;br/&gt;
A, B and C with clusterIds 1, 2 and 3 respectively. Cluster A does not write, but simply&lt;br/&gt;
observes changes done by B and C. Consider the following sequence of events:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;C adds a node N to the repository&lt;/li&gt;
	&lt;li&gt;C runs background operations&lt;/li&gt;
	&lt;li&gt;B runs background operations and sees N&lt;/li&gt;
	&lt;li&gt;B removes N&lt;/li&gt;
	&lt;li&gt;B runs background operations&lt;/li&gt;
	&lt;li&gt;A runs background operations&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;To A changes done by B and C will have the same &apos;seenAt&apos; revision and the RevisionComparator&lt;br/&gt;
will decide based on the clusterId. The comparator will tell the change done by B (removing&lt;br/&gt;
the node) happend before the change done by C (adding the node), because B has a lower&lt;br/&gt;
clusterId than C.&lt;/p&gt;

&lt;p&gt;This issue only had a minor impact so far because NodeDocument.getNodeAtRevision() uses&lt;br/&gt;
a StableRevisionComparator when it goes through the revisions of a property. It only uses&lt;br/&gt;
the RevisionComparator to decide if a change is visible or not based on a given read revision.&lt;/p&gt;

&lt;p&gt;In my view there are multiple issue to solve:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The RevisionComparator mechanism to make multiple external changes visible at a given seenAt revision is fragile because the comparison is only based on the clusterId. Taken to the extreme it means an old revision made visible via a background read or on startup may be considered newer than a current revision, just because the clusterId is higher.&lt;/li&gt;
	&lt;li&gt;The RevisionComparator allows time shifting. That is, the implementation tries to accommodate clock differences on cluster nodes and puts revisions in proper sequence as they were made visible. However, it only remembers this sequence for a one hour time frame. Older revisions are compared only based on the revision timestamp. This make the comparison unstable over time. While the comparator may say a revision R1 happened before R2 while in the one hour time frame, the comparison may later tell the opposite.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I see the following solution to these problems:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Prevent changes that happen in the past (by just looking at the revision timestamp). This is what the ignored tests added in this issue do. Due to clock differences a subsequent change has a lower revision timestamp. This is currently allowed because the RevisionComparator accommodates this difference, but it only works reliably within a one hour timeframe.&lt;/li&gt;
	&lt;li&gt;Detect clock differences in the background read operation. The background read operation must only make external changes visible that have a lower timestamp than the local clock. This is similar to the first item.&lt;/li&gt;
	&lt;li&gt;The RevisionComparator always uses the revision timestamp to compare revisions, unless a revision is not yet visible.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14904491" author="mreutegg" created="Wed, 23 Sep 2015 13:19:25 +0000"  >&lt;p&gt;Attached work-in-progress patch.&lt;/p&gt;

&lt;p&gt;These changes also resolve &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-2929&quot; title=&quot;Parent of unseen children must not be removable&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-2929&quot;&gt;&lt;del&gt;OAK-2929&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Most notable changes are:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;RevisionComparator compares based on revision time when two external revisions with the same seenAt range are compared.&lt;/li&gt;
	&lt;li&gt;Background read in DocumentNodeStore delays the operation when it detects that clocks are not in sync. This ensures revision comparison for visible changes is stable and does not change when seenAt ranges older than one hour are purged.&lt;/li&gt;
	&lt;li&gt;Clarified NodeDocument.getNewestRevision()&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Feedback welcome.&lt;/p&gt;</comment>
                            <comment id="14935048" author="mreutegg" created="Tue, 29 Sep 2015 12:02:23 +0000"  >&lt;p&gt;Updated patch. Further clarified NodeDocument.getNewestRevision() and added more tests.&lt;/p&gt;</comment>
                            <comment id="14935285" author="mreutegg" created="Tue, 29 Sep 2015 14:57:05 +0000"  >&lt;p&gt;Applied patch to trunk: &lt;a href=&quot;http://svn.apache.org/r1705871&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1705871&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14939705" author="mreutegg" created="Thu, 1 Oct 2015 11:32:12 +0000"  >&lt;p&gt;Merged into 1.0 branch: &lt;a href=&quot;http://svn.apache.org/r1706215&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1706215&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I didn&apos;t merge all changes done to NodeDocument into the 1.0 branch to reduce risk.&lt;/p&gt;</comment>
                            <comment id="14939809" author="mreutegg" created="Thu, 1 Oct 2015 13:31:34 +0000"  >&lt;p&gt;Merged into 1.2 branch: &lt;a href=&quot;http://svn.apache.org/r1706244&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1706244&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14948315" author="edivad" created="Thu, 8 Oct 2015 08:53:59 +0000"  >&lt;p&gt;Bulk close for 1.0.22&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12869387">OAK-3411</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12764232" name="OAK-3388.patch" size="37433" author="mreutegg" created="Tue, 29 Sep 2015 12:02:23 +0000"/>
                            <attachment id="12761887" name="OAK-3388.patch" size="17046" author="mreutegg" created="Wed, 23 Sep 2015 13:19:25 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311120" key="com.pyxis.greenhopper.jira:gh-epic-link">
                        <customfieldname>Epic Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>OAK-3270</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 6 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2jzs7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>