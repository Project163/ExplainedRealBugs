<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:52:59 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-6267] Version restore fails if restore would not change bundling root but changes bundled nodes</title>
                <link>https://issues.apache.org/jira/browse/OAK-6267</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;Following test case in &lt;tt&gt;VersionedDocumentBundlingTest&lt;/tt&gt; fails:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    @Test
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void restoreVersionedNode() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception{
        &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; assetParentPath = &lt;span class=&quot;code-quote&quot;&gt;&quot;/bundlingtest/par&quot;&lt;/span&gt;;
        Node asset = JcrUtils.getOrCreateByPath(assetParentPath + &lt;span class=&quot;code-quote&quot;&gt;&quot;/foo.png&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;oak:Unstructured&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;oak:Asset&quot;&lt;/span&gt;, s, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
        Node assetParent = s.getNode(assetParentPath);
        assetParent.addMixin(JcrConstants.MIX_VERSIONABLE);
        asset.addNode(&lt;span class=&quot;code-quote&quot;&gt;&quot;jcr:content&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;oak:Unstructured&quot;&lt;/span&gt;);
        s.save();

        VersionManager vm = s.getWorkspace().getVersionManager();
        Version version = vm.checkin(assetParentPath);
        vm.checkout(assetParentPath);

        asset.getNode(&lt;span class=&quot;code-quote&quot;&gt;&quot;jcr:content&quot;&lt;/span&gt;).setProperty(&lt;span class=&quot;code-quote&quot;&gt;&quot;foo1&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;bar1&quot;&lt;/span&gt;);
        s.save();

        vm.restore(version, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
    }

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The important point that needs to happen is that restore process needs to let bundle-root-node (&lt;tt&gt;/bundlingtest/par/foo.png&lt;/tt&gt;) untouched BUT needs to change a bundled node (&lt;tt&gt;/bundlingtest/par/foo.png/jcr:content&lt;/tt&gt;).&lt;/p&gt;</description>
                <environment></environment>
        <key id="13075031">OAK-6267</key>
            <summary>Version restore fails if restore would not change bundling root but changes bundled nodes</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="chetanm">Chetan Mehrotra</assignee>
                                    <reporter username="catholicon">Vikas Saurabh</reporter>
                        <labels>
                    </labels>
                <created>Fri, 26 May 2017 00:51:35 +0000</created>
                <updated>Fri, 9 Jun 2017 12:53:21 +0000</updated>
                            <resolved>Fri, 26 May 2017 11:39:03 +0000</resolved>
                                    <version>1.6.0</version>
                                    <fixVersion>1.7.1</fixVersion>
                    <fixVersion>1.6.2</fixVersion>
                    <fixVersion>1.8.0</fixVersion>
                                    <component>documentmk</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="16025618" author="catholicon" created="Fri, 26 May 2017 00:52:28 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chetanm&quot; class=&quot;user-hover&quot; rel=&quot;chetanm&quot;&gt;chetanm&lt;/a&gt;, assigning the issue to myself. Please feel free if you want it instead &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.&lt;/p&gt;</comment>
                            <comment id="16025630" author="catholicon" created="Fri, 26 May 2017 01:04:08 +0000"  >&lt;p&gt;Added ignored test (copied from description) at &lt;a href=&quot;https://svn.apache.org/r1796230&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;r1796230&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="16025880" author="chetanm" created="Fri, 26 May 2017 06:30:53 +0000"  >&lt;p&gt;Added another ignored test at 1796239. This recreates the issue with just the NodeStore API. The problem is coming when a node is recreated from within  a CommitHook. This issue comes when a bundled node is removed and recreated in same operation. In version restore the logic removes the versioned node tree and then recreates similar tree from data stored in version store. Due to this such a node is treated as a node changed scenario instead of node added scenario. &lt;/p&gt;

&lt;p&gt;A somewhat similar issue was discussed &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-1312?focusedCommentId=15434297&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-15434297&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;here&lt;/a&gt; and there the fix worked because changes were done before the merge. Due to this rebase call in DocumentNodeStoreBranch$InMemory#merge reconnect the modified state with previous state which allows the bundling logic to access the hidden bundled properties.&lt;/p&gt;

&lt;p&gt;However when such a change is done in CommitHook the rebase does not happen and the node remains disconnected from the base state and looking for hidden bundling properties fails.&lt;/p&gt;</comment>
                            <comment id="16025894" author="chetanm" created="Fri, 26 May 2017 06:51:14 +0000"  >&lt;p&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12870010/12870010_OAK-6267-v1.patch&quot; title=&quot;OAK-6267-v1.patch attached to OAK-6267&quot;&gt;patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; which resolves the issue&lt;/p&gt;

&lt;p&gt;BundlingHandler was being passed the &quot;after&quot; state in case of any change. This after state may have been reconstructed all together hence the hidden bundlor config may get lost. &lt;/p&gt;

&lt;p&gt;As a fix the BundlingHandler uses the &quot;before&quot; state now for performing the bundlor config lookup. This should be fine as bundle config is only added for newly added node and never modified for existing node. So lookup from &quot;before&quot; state should be safe&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=catholicon&quot; class=&quot;user-hover&quot; rel=&quot;catholicon&quot;&gt;catholicon&lt;/a&gt; Would be helpful if you can also review the patch&lt;/p&gt;</comment>
                            <comment id="16026166" author="catholicon" created="Fri, 26 May 2017 11:28:09 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chetanm&quot; class=&quot;user-hover&quot; rel=&quot;chetanm&quot;&gt;chetanm&lt;/a&gt;, the change lgtm. &lt;del&gt;A quick clarification though - afaiu, with this change, we won&apos;t be able to handle nodetype changes (which is still a TODO in code... ) in the future.&lt;/del&gt; Ok, checked the code once again - sure, for finding bundle context, using before state should be good enough. We do get enough info for handling primary type changes (even in future i.e.)&lt;/p&gt;</comment>
                            <comment id="16026174" author="chetanm" created="Fri, 26 May 2017 11:39:03 +0000"  >&lt;p&gt;Applied the patch with 1796278&lt;/p&gt;</comment>
                            <comment id="16032451" author="chetanm" created="Thu, 1 Jun 2017 05:09:46 +0000"  >&lt;p&gt;Merged to &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;1.6 - 1797138&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16044411" author="edivad" created="Fri, 9 Jun 2017 12:53:21 +0000"  >&lt;p&gt;Bulk close for 1.7.1&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12870010" name="OAK-6267-v1.patch" size="3954" author="chetanm" created="Fri, 26 May 2017 06:51:14 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 23 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3fhwf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>