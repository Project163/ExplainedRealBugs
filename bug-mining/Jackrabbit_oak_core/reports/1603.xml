<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:51:59 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-5179] MultiplexingNodeStoreService does not register an OSGi service for oak.api.Descriptors</title>
                <link>https://issues.apache.org/jira/browse/OAK-5179</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;When starting up Apache Sling with a MultiplexingNodeStore backend Sling&apos;s discovery mechanism fails to read the repository descriptors.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;19.11.2016 13:43:06.101 *ERROR* [discovery.connectors.common.runner.331bcf42-1d0d-4b53-bf1f-c7e9df060758.discoveryLiteCheck] org.apache.sling.discovery.oak.cluster.OakClusterViewService getLocalClusterView: repository exception: java.lang.Exception: No Descriptor value available
java.lang.Exception: No Descriptor value available
        at org.apache.sling.discovery.commons.providers.spi.base.DiscoveryLiteDescriptor.getDescriptorFrom(DiscoveryLiteDescriptor.java:45)
        at org.apache.sling.discovery.oak.cluster.OakClusterViewService.getLocalClusterView(OakClusterViewService.java:112)
        at org.apache.sling.discovery.base.commons.BaseDiscoveryService.getTopology(BaseDiscoveryService.java:77)
        at org.apache.sling.discovery.oak.OakDiscoveryService.checkForTopologyChange(OakDiscoveryService.java:657)
        at org.apache.sling.discovery.oak.pinger.OakViewChecker.discoveryLiteCheck(OakViewChecker.java:217)
        at org.apache.sling.discovery.oak.pinger.OakViewChecker.access$000(OakViewChecker.java:62)
        at org.apache.sling.discovery.oak.pinger.OakViewChecker$1.run(OakViewChecker.java:193)
        at org.apache.sling.discovery.base.commons.PeriodicBackgroundJob.safelyRun(PeriodicBackgroundJob.java:86)
        at org.apache.sling.discovery.base.commons.PeriodicBackgroundJob.run(PeriodicBackgroundJob.java:77)
        at java.lang.Thread.run(Thread.java:745)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I noticed that these descriptors are registered as OSGi services for the other stores - Segment ( &apos;old&apos; and tar ), Document.&lt;/p&gt;

&lt;p&gt;The MultiplexingNodeStoreService should register these as well.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13024014">OAK-5179</key>
            <summary>MultiplexingNodeStoreService does not register an OSGi service for oak.api.Descriptors</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tomek.rekawek">Tomek R&#281;kawek</assignee>
                                    <reporter username="rombert">Robert Munteanu</reporter>
                        <labels>
                    </labels>
                <created>Tue, 29 Nov 2016 08:58:30 +0000</created>
                <updated>Thu, 26 Sep 2019 11:43:33 +0000</updated>
                            <resolved>Tue, 6 Dec 2016 14:16:22 +0000</resolved>
                                                    <fixVersion>1.5.15</fixVersion>
                    <fixVersion>1.6.0</fixVersion>
                                    <component>core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15704758" author="rombert" created="Tue, 29 Nov 2016 09:14:16 +0000"  >&lt;p&gt;I&apos;m working on a patch for this, will post it for review later today.&lt;/p&gt;</comment>
                            <comment id="15705124" author="rombert" created="Tue, 29 Nov 2016 12:06:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stefanegli&quot; class=&quot;user-hover&quot; rel=&quot;stefanegli&quot;&gt;stefanegli&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tomek.rekawek&quot; class=&quot;user-hover&quot; rel=&quot;tomek.rekawek&quot;&gt;tomek.rekawek&lt;/a&gt; - can one of you please review?&lt;/p&gt;</comment>
                            <comment id="15705155" author="tomek.rekawek" created="Tue, 29 Nov 2016 12:16:38 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rombert&quot; class=&quot;user-hover&quot; rel=&quot;rombert&quot;&gt;rombert&lt;/a&gt;, besides from the minor formatting inconsistencies with the rest of the Oak codebase (parentheses body surrounded by spaces, an empty line at the method beginning), patch LGTM.&lt;/p&gt;</comment>
                            <comment id="15705391" author="rombert" created="Tue, 29 Nov 2016 14:10:41 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tomek.rekawek&quot; class=&quot;user-hover&quot; rel=&quot;tomek.rekawek&quot;&gt;tomek.rekawek&lt;/a&gt; - thanks for the review. Attached the second version of the patch, with the formatting fixes applied.&lt;/p&gt;</comment>
                            <comment id="15705668" author="rombert" created="Tue, 29 Nov 2016 15:50:56 +0000"  >&lt;p&gt;My patch seems to be incomplete as when testing more I see that the &lt;tt&gt;DiscoveryLiteDescriptor&lt;/tt&gt; is indeed required.&lt;/p&gt;</comment>
                            <comment id="15705688" author="rombert" created="Tue, 29 Nov 2016 16:02:36 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tomek.rekawek&quot; class=&quot;user-hover&quot; rel=&quot;tomek.rekawek&quot;&gt;tomek.rekawek&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stefanegli&quot; class=&quot;user-hover&quot; rel=&quot;stefanegli&quot;&gt;stefanegli&lt;/a&gt; - looking at the code I would think that the best place to isolate the descriptor registration would be the node store factories, e.g. &lt;tt&gt;SegmentNodeStoreFactory&lt;/tt&gt; for the &lt;tt&gt;SegmentNodeStore&lt;/tt&gt;, as these have the best knowledge of what type of repository is being registered and its role. What do you think?&lt;/p&gt;</comment>
                            <comment id="15705747" author="egli" created="Tue, 29 Nov 2016 16:23:30 +0000"  >&lt;p&gt;Currently the two &lt;tt&gt;SegmentNodeStoreService&lt;/tt&gt; and &lt;tt&gt;DocumentNodeStoreService&lt;/tt&gt; take care of registering a &lt;tt&gt;Descriptors&lt;/tt&gt; service for discovery-lite. Perhaps this can be done similarly in the &lt;tt&gt;MultiplexingNodeStoreService&lt;/tt&gt; itself? Not sure yet about how the discovery-lite should function when multiplexed - but presumably you want to run multiplexing in a documentMk cluster? In which case there would have to be a &apos;&lt;em&gt;proper&lt;/em&gt;&apos; discovery-lite impl probably integrated with the DocumentNodeStoreService one.&lt;/p&gt;</comment>
                            <comment id="15705801" author="rombert" created="Tue, 29 Nov 2016 16:42:31 +0000"  >&lt;p&gt;The &lt;tt&gt;MultiplexingNodeStoreService&lt;/tt&gt; does not have a lot of knowledge about what the node stores that it multiplexes are. And I also see that the &lt;tt&gt;SegmentDiscoveryLiteDescriptors&lt;/tt&gt; class is package-private, for good reason. &lt;/p&gt;

&lt;p&gt;I think a good rule of the thumb is that the  primary node store ( Segment or Document ) should decide what descriptors are registered, the other mount probably have nothing to say about clustering and are intended to be local and read-only. That&apos;s why I was suggesting that the component registering the primary node store service handle this. I don&apos;t think that multiplexing should expose a different descriptor for discovery, based on my limited understanding of how discovery works.&lt;/p&gt;</comment>
                            <comment id="15705812" author="rombert" created="Tue, 29 Nov 2016 16:43:46 +0000"  >&lt;p&gt;Also, regarding multiplexing in a  documentMk cluster, the idea would be for the &lt;tt&gt;global&lt;/tt&gt; mount to be shared, e.g. a MongoDB instance accessed by all Oak instances, and for the mounts to be local, either &lt;tt&gt;segment-tar&lt;/tt&gt; or a local &lt;tt&gt;H2&lt;/tt&gt; database. Hope that clarifies the expect usage a bit.&lt;/p&gt;</comment>
                            <comment id="15705855" author="egli" created="Tue, 29 Nov 2016 17:01:06 +0000"  >&lt;blockquote&gt;&lt;p&gt;I think a good rule of the thumb is that the primary node store ( Segment or Document ) should decide what descriptors are registered&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;ok, makes sense. And I think that will work fine as indeed the clustering structure is defined by that primary node store as you pointed out. So in the non-multiplexed case the descriptors is created by eg DocumentNodeStoreService - the question then I guess is how to generalize that code such that the MultiplexingNodeStoreService can trigger that. As I think you basically want to reuse the &lt;tt&gt;DocumentDiscoveryLiteService&lt;/tt&gt;&lt;/p&gt;</comment>
                            <comment id="15706726" author="rombert" created="Tue, 29 Nov 2016 22:20:29 +0000"  >&lt;p&gt;Here&apos;s the third option of the patch which actually works on Sling and AEM.&lt;/p&gt;

&lt;p&gt;The only part which I don&apos;t find particularly satisfying is that I need to expose a &apos;registerDescriptors&apos; property for the &lt;tt&gt;SegmentNodeStoreFactory&lt;/tt&gt;. This should only be set to true for the global factory, but on the other hand the role string is opaque for the factory so it can&apos;t interpret it. I &lt;em&gt;could&lt;/em&gt; expose a &lt;tt&gt;registerDescriptors&lt;/tt&gt; method on the &lt;tt&gt;NodeProvider&lt;/tt&gt; so that the &lt;tt&gt;MultiplexingNodeStore&lt;/tt&gt; can invoke it on the global instance only, but that seems to be mixing concerns a lot, so I left it as a flag on the factory.&lt;/p&gt;

&lt;p&gt;I&apos;ll be away until Monday, so please expect some delays in my replies.&lt;/p&gt;</comment>
                            <comment id="15714483" author="tomek.rekawek" created="Fri, 2 Dec 2016 08:44:34 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rombert&quot; class=&quot;user-hover&quot; rel=&quot;rombert&quot;&gt;rombert&lt;/a&gt;, I actually like the third approach (with registerDescriptors). It works and requires just one extra property in the SegmentNodeStoreFactory configuration. I prefer that over refactoring NodeProvider interface or adding new marking interfaces.&lt;/p&gt;

&lt;p&gt;Let me know if the patch is done - I&apos;ll merge it. Maybe similar property should be added to the oak-segment version of SegmentNodeStoreFactory? Right now they are mostly the same.&lt;/p&gt;</comment>
                            <comment id="15714830" author="egli" created="Fri, 2 Dec 2016 11:11:40 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rombert&quot; class=&quot;user-hover&quot; rel=&quot;rombert&quot;&gt;rombert&lt;/a&gt;, I agree with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tomek.rekawek&quot; class=&quot;user-hover&quot; rel=&quot;tomek.rekawek&quot;&gt;tomek.rekawek&lt;/a&gt; in that the registerDescriptors way is preferable over NodeProvider refactoring. I was just thinking if there&apos;s an alternative to avoid the &quot;&lt;tt&gt;Should only be done for one factory instance&lt;/tt&gt;&quot; problem. That hints to the fact that one could misconfigure when setting the registerDescriptor property on none or more than 1 node store. But the only alternative that came to mind was to introduce a separate, perhaps called &apos;DescriptorConfig&apos; config which would contain the name or role of the node store factory which should register the descriptors. But perhaps that&apos;s not making it much nicer really and your suggested 3rd approach (registerDescriptors) is more intuitive.&lt;/p&gt;</comment>
                            <comment id="15722380" author="rombert" created="Mon, 5 Dec 2016 14:18:57 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tomek.rekawek&quot; class=&quot;user-hover&quot; rel=&quot;tomek.rekawek&quot;&gt;tomek.rekawek&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stefanegli&quot; class=&quot;user-hover&quot; rel=&quot;stefanegli&quot;&gt;stefanegli&lt;/a&gt;, the patch with the &apos;register descriptors&apos; approach is uploaded at &lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12840939/0001-OAK-5179-MultiplexingNodeStoreService-does-not-regis.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12840939/0001-OAK-5179-MultiplexingNodeStoreService-does-not-regis.patch&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15723322" author="rombert" created="Mon, 5 Dec 2016 20:43:57 +0000"  >&lt;blockquote&gt;&lt;p&gt;Maybe similar property should be added to the oak-segment version of SegmentNodeStoreFactory? Right now they are mostly the same.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I am not sure that we want to do this ... AFAIU oak-segment is deprecated and given that multiplexing needs special preparation to run I don&apos;t think anyone will be using it with oak-segment but will instead use oak-segment-tar . So to reduce the support surface my suggestion is to not do this for oak-segment.&lt;/p&gt;

&lt;p&gt;&lt;em&gt;Edit&lt;/em&gt;: wording&lt;/p&gt;</comment>
                            <comment id="15725599" author="tomek.rekawek" created="Tue, 6 Dec 2016 14:16:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rombert&quot; class=&quot;user-hover&quot; rel=&quot;rombert&quot;&gt;rombert&lt;/a&gt;, makes sense. I&apos;ve committed your patch as &lt;a href=&quot;https://svn.apache.org/r1772898&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;r1772898&lt;/a&gt;. Thanks!&lt;/p&gt;</comment>
                            <comment id="15742123" author="edivad" created="Mon, 12 Dec 2016 14:36:38 +0000"  >&lt;p&gt;Bulk close for 1.5.15&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12840939" name="0001-OAK-5179-MultiplexingNodeStoreService-does-not-regis.patch" size="7030" author="rombert" created="Tue, 29 Nov 2016 22:20:29 +0000"/>
                            <attachment id="12840878" name="0001-OAK-5179-MultiplexingNodeStoreService-does-not-regis.patch" size="4687" author="rombert" created="Tue, 29 Nov 2016 14:10:11 +0000"/>
                            <attachment id="12840860" name="0001-OAK-5179-MultiplexingNodeStoreService-does-not-regis.patch" size="4763" author="rombert" created="Tue, 29 Nov 2016 12:06:44 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 48 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i36w4v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>