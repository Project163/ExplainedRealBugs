<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:45:01 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-1932] TarMK compaction can create mixed segments</title>
                <link>https://issues.apache.org/jira/browse/OAK-1932</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;As described in &lt;a href=&quot;http://markmail.org/message/ujkqdlthudaortxf&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://markmail.org/message/ujkqdlthudaortxf&lt;/a&gt;, commits that occur while the compaction operation is running can make the compacted segments contain references to older data segments, which prevents old data from being reclaimed during cleanup.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12724529">OAK-1932</key>
            <summary>TarMK compaction can create mixed segments</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jukkaz">Jukka Zitting</assignee>
                                    <reporter username="jukkaz">Jukka Zitting</reporter>
                        <labels>
                    </labels>
                <created>Mon, 30 Jun 2014 20:00:46 +0000</created>
                <updated>Wed, 1 Oct 2014 13:11:19 +0000</updated>
                            <resolved>Tue, 8 Jul 2014 01:27:55 +0000</resolved>
                                    <version>1.0.1</version>
                                    <fixVersion>1.0.2</fixVersion>
                    <fixVersion>1.1.0</fixVersion>
                                    <component>core</component>
                    <component>segmentmk</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="14051462" author="alex.parvulescu" created="Thu, 3 Jul 2014 14:03:46 +0000"  >&lt;p&gt;There&apos;s an issue with the current state of the compactor code, basically the compactor doesn&apos;t copy over state that has not changed (because the diff doesn&apos;t traverse those parts of the tree), so the &apos;after&apos; state might be incomplete to the point where passing in 2 equals states returns an empty state.&lt;/p&gt;

&lt;p&gt;I&apos;m attaching a test case to demo the problem, with a simple fix for the case where the root states are equal, but this happens on any level of the tree&lt;/p&gt;</comment>
                            <comment id="14051486" author="alex.parvulescu" created="Thu, 3 Jul 2014 14:16:57 +0000"  >&lt;p&gt;...and a proposed patch for the aforementioned issue&lt;/p&gt;</comment>
                            <comment id="14051527" author="jukkaz" created="Thu, 3 Jul 2014 14:48:48 +0000"  >&lt;p&gt;So far I only expected the compactor to always start the compaction process from the empty state, so the problem above shouldn&apos;t be an issue. But +1 on the patch, it makes it easier to adapt the code to other use cases like backup or to something like incremental compaction if we want to add a feature like that later on.&lt;/p&gt;</comment>
                            <comment id="14051534" author="alex.parvulescu" created="Thu, 3 Jul 2014 14:55:18 +0000"  >&lt;blockquote&gt;&lt;p&gt;So far I only expected the compactor to always start the compaction process from the empty state, so the problem above shouldn&apos;t be an issue.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I beg to differ &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; it could happen on normal compact operations too. &lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;thanks for the review! I&apos;ll apply the patch shortly.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://github.com/apache/jackrabbit-oak/blob/trunk/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/file/FileStore.java#L424&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/jackrabbit-oak/blob/trunk/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/file/FileStore.java#L424&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14051539" author="alex.parvulescu" created="Thu, 3 Jul 2014 14:59:26 +0000"  >&lt;p&gt;I applied the patch at rev &lt;a href=&quot;http://svn.apache.org/r1607664&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1607664&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14053694" author="jukkaz" created="Mon, 7 Jul 2014 14:21:48 +0000"  >&lt;blockquote&gt;&lt;p&gt;I beg to differ  it could happen on normal compact operations too.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;If you unroll the loop, the sequence of calls is something like this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Compactor compactor = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Compactor(...);
compactor.compact(EMPTY_NODE, B);
compactor.compact(A, B);
compactor.compact(B, C);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Since we use the same &lt;tt&gt;Compactor&lt;/tt&gt; instance, the end result is the same regardless of whether a single &lt;tt&gt;NodeBuilder&lt;/tt&gt; is used for all &lt;tt&gt;compact()&lt;/tt&gt; calls (like it used to be) or a new NodeBuilder is instantiated for each call (which is what the patch did). The attached test case uses a different call pattern, for which the class originally wasn&apos;t designed for.&lt;/p&gt;

&lt;p&gt;Anyway, as mentioned above, the change does make the &lt;tt&gt;Compactor&lt;/tt&gt; easier to reuse for other cases, so it&apos;s clearly an improvement.&lt;/p&gt;</comment>
                            <comment id="14054387" author="jukkaz" created="Tue, 8 Jul 2014 01:27:55 +0000"  >&lt;p&gt;Fixed in a sequence of commits to trunk, and merged to the 1.0 branch in revision 1608564.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="12723876">OAK-1921</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12724408">OAK-1927</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12653833" name="Compactor.java.patch" size="1397" author="stillalex" created="Thu, 3 Jul 2014 14:16:57 +0000"/>
                            <attachment id="12653832" name="CompactorTest.java.patch" size="4383" author="stillalex" created="Thu, 3 Jul 2014 14:03:46 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>402712</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 19 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1xbdb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>402779</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>