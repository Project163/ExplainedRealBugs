<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:50:00 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-3424] ClusterNodeInfo does not pick an existing entry on startup</title>
                <link>https://issues.apache.org/jira/browse/OAK-3424</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;When the &lt;tt&gt;DocumentNodeStore&lt;/tt&gt; starts up, it attempts to find an entry that matches the current instance (which is defined by something based on network interface address and the current working directory).&lt;/p&gt;

&lt;p&gt;However, an additional check is done when the cluster lease end time hasn&apos;t been reached, in which case the entry is skipped (assuming it belongs to a different instance), and the scan continues. When no other entry is found, a new one is created.&lt;/p&gt;

&lt;p&gt;So why would we &lt;b&gt;ever&lt;/b&gt; consider instances with matching instance information to be different? As far as I can tell the answer is: for unit testing.&lt;/p&gt;

&lt;p&gt;But...&lt;/p&gt;

&lt;p&gt;With the current assignment very weird things can happen, and I believe I see exactly this happening in a customer problem I&apos;m investigating. The sequence is:&lt;/p&gt;

&lt;p&gt;1) First system startup, cluster node id 1 is assigned&lt;/p&gt;

&lt;p&gt;2) System crashes or was crashed&lt;/p&gt;

&lt;p&gt;3) System restarts within the lease time (120s?), a new cluster node id is assigned&lt;/p&gt;

&lt;p&gt;4) System shuts down, and gets restarted after a longer interval: cluster id 1 is used again, and system starts &lt;tt&gt;MissingLastRevRecovery&lt;/tt&gt;, despite the previous shutdown having been clean&lt;/p&gt;

&lt;p&gt;So what we see is that the system starts up with varying cluster node ids, and recovery processes may run with no correlation to what happened before.&lt;/p&gt;

&lt;p&gt;Proposal:&lt;/p&gt;

&lt;p&gt;a) Make &lt;tt&gt;ClusterNodeInfo.createInstance()&lt;/tt&gt; much more verbose, so that the default system log contains sufficient information to understand why a certain cluster node id was picked.&lt;/p&gt;

&lt;p&gt;b) Drop the logic that skips entries with non-expired leases, so that we get a one-to-one relation between instance ids and cluster node ids. For the unit tests that currently rely on this logic, switch to APIs where the test setup picks the cluster node id.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12888777">OAK-3424</key>
            <summary>ClusterNodeInfo does not pick an existing entry on startup</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="reschke">Julian Reschke</assignee>
                                    <reporter username="reschke">Julian Reschke</reporter>
                        <labels>
                    </labels>
                <created>Sat, 19 Sep 2015 15:40:43 +0000</created>
                <updated>Tue, 16 Feb 2021 09:53:01 +0000</updated>
                            <resolved>Thu, 17 Dec 2015 14:04:52 +0000</resolved>
                                    <version>1.0.25</version>
                    <version>1.2.9</version>
                    <version>1.3.12</version>
                                    <fixVersion>1.2.10</fixVersion>
                    <fixVersion>1.3.13</fixVersion>
                    <fixVersion>1.4</fixVersion>
                                    <component>core</component>
                    <component>mongomk</component>
                    <component>rdbmk</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="14900328" author="egli" created="Mon, 21 Sep 2015 07:42:43 +0000"  >&lt;p&gt;I&apos;m assuming this has been discussed before, but just to be sure: why are we not storing eg a cluster.node.id file (somewhere in the repository) which the instance would re-use upon restart? (probably won&apos;t work for unit tests though..)&lt;/p&gt;</comment>
                            <comment id="14900396" author="reschke" created="Mon, 21 Sep 2015 08:56:14 +0000"  >&lt;p&gt;How would that help? How would it know which one to pick?&lt;/p&gt;</comment>
                            <comment id="14902167" author="egli" created="Tue, 22 Sep 2015 07:44:39 +0000"  >&lt;p&gt;I meant to say that we could store a file in the directory structure, not in the repository.. so it&apos;s only visible to one instance (but perhaps wouldn&apos;t work with tests..)&lt;/p&gt;</comment>
                            <comment id="14902200" author="reschke" created="Tue, 22 Sep 2015 08:09:42 +0000"  >&lt;p&gt;Well, that wouldn&apos;t address the case when the same instance (machineid, workingdir) is used for several nodes.&lt;/p&gt;</comment>
                            <comment id="14902219" author="egli" created="Tue, 22 Sep 2015 08:28:01 +0000"  >&lt;p&gt;is that legal to do ?&lt;/p&gt;</comment>
                            <comment id="14902358" author="tmueller" created="Tue, 22 Sep 2015 10:26:56 +0000"  >&lt;p&gt;&amp;gt; why are we not storing eg a cluster.node.id file&lt;/p&gt;

&lt;p&gt;We could do that, but there would also be some risks / complications. For example, when creating a new cluster node, someone copies the existing repository (including the cluster.node.id file). Sure, the &quot;lease&quot; mechanism would prevent that the same id is used concurrently by multiple cluster nodes; but whichever cluster nodes starts first get the id 1 in that case.&lt;/p&gt;

&lt;p&gt;&amp;gt; that wouldn&apos;t address the case when the same instance (machineid, workingdir) is used for several nodes.&lt;br/&gt;
&amp;gt; is that legal to do ?&lt;/p&gt;

&lt;p&gt;Yes, for example if the repository is started, the repository directory is deleted (which is possible, except when using Windows), and the repository is started again -&amp;gt; two processes with the same working directory.&lt;/p&gt;</comment>
                            <comment id="14904517" author="mreutegg" created="Wed, 23 Sep 2015 13:38:55 +0000"  >&lt;p&gt;I my view we should change the current behaviour and prohibit a deployment where two cluster nodes are running with the same working directory and an automatic clusterId is requested. Just this morning I unintentionally started two Oak+Sling stacks from the same working directory and the discovery bundle got disabled because it detected a duplicate sling id. I cannot really think of a reasonable use case where you would want to start two instances from the same working directory. Usually there is also some kind of logging configured, which means messages from two instances would go into the same file. Does this even work reliably?&lt;/p&gt;

&lt;p&gt;I think it would be best to match the working directory and machine id and if the lease is not expired wait for the lease end. Then there are two cases: either the starting repository can take ownership of the expired lease or it detects the lease had been updated and fails the startup with an exception that there&apos;s already a process running. &lt;/p&gt;</comment>
                            <comment id="14904539" author="mreutegg" created="Wed, 23 Sep 2015 13:50:21 +0000"  >&lt;p&gt;For tests we could still allow multiple instances, but require an explicit clusterId through the DocumentMK.Builder.&lt;/p&gt;</comment>
                            <comment id="14904670" author="reschke" created="Wed, 23 Sep 2015 15:34:23 +0000"  >&lt;p&gt;...however in that case we currently do not create ClusterNodeInfos, thus we&apos;d be testing something entirely different. So this would need to be fixed first...&lt;/p&gt;

&lt;p&gt;EDIT: this was fixed with &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-3449&quot; title=&quot;DocumentNodeStore support for predefined clusterIds should use ClusterNodeInfos&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-3449&quot;&gt;&lt;del&gt;OAK-3449&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="14904780" author="egli" created="Wed, 23 Sep 2015 16:41:02 +0000"  >&lt;blockquote&gt;&lt;p&gt;prohibit a deployment where two cluster nodes are running with the same working directory and an automatic clusterId is requested.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="15058338" author="reschke" created="Tue, 15 Dec 2015 17:06:42 +0000"  >&lt;p&gt;The behavioral change this is about will affect any unit test that attempts to instantiate multiple DocumentNodeStores without assigning cluster ids. This patch fixes just the affected tests.&lt;/p&gt;

&lt;p&gt;Note that it also removes a test which tests explicitly the behavior we would remove.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mreutegg&quot; class=&quot;user-hover&quot; rel=&quot;mreutegg&quot;&gt;mreutegg&lt;/a&gt;: feedback appreciated.&lt;/p&gt;</comment>
                            <comment id="15059993" author="reschke" created="Wed, 16 Dec 2015 13:56:08 +0000"  >&lt;p&gt;This patch passes the existing tests, and also behaves as designed in manual testing (aborting the VM during tests, manually manipulating cluster node info entries)&lt;/p&gt;</comment>
                            <comment id="15060269" author="reschke" created="Wed, 16 Dec 2015 16:39:58 +0000"  >&lt;p&gt;Patch including code change, updated old tests and one new test.&lt;/p&gt;</comment>
                            <comment id="15061748" author="mreutegg" created="Thu, 17 Dec 2015 09:01:29 +0000"  >&lt;p&gt;Patch looks good. Just one minor comment: ClusterInfoTest has an unused import statement.&lt;/p&gt;</comment>
                            <comment id="15062071" author="reschke" created="Thu, 17 Dec 2015 14:04:52 +0000"  >&lt;p&gt;trunk: &lt;a href=&quot;http://svn.apache.org/r1720500&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1720500&lt;/a&gt;&lt;br/&gt;
1.2: &lt;a href=&quot;http://svn.apache.org/r1720552&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1720552&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15087435" author="edivad" created="Thu, 7 Jan 2016 14:14:51 +0000"  >&lt;p&gt;Bulk close for 1.3.13&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                                                <inwardlinks description="is blocked by">
                                        <issuelink>
            <issuekey id="12896376">OAK-3449</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12875392">OAK-3418</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12778035" name="OAK-3424.diff" size="32362" author="reschke" created="Wed, 16 Dec 2015 16:39:58 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 45 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2l5m7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>