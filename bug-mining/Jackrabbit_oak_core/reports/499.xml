<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:40:22 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-1111] Node#setProperty(String, Calendar) doesn&apos;t take time zone in account</title>
                <link>https://issues.apache.org/jira/browse/OAK-1111</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;Node#setProperty(String, Calendar) doesn&apos;t take time zone in account.&lt;/p&gt;

&lt;p&gt;It looks the Calendar value is straightly stored as a long without take in consideration the time zone,&lt;/p&gt;

&lt;p&gt;Unit test to follow&lt;/p&gt;</description>
                <environment></environment>
        <key id="12675252">OAK-1111</key>
            <summary>Node#setProperty(String, Calendar) doesn&apos;t take time zone in account</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mduerig">Michael D&#252;rig</assignee>
                                    <reporter username="asanso">Antonio Sanso</reporter>
                        <labels>
                    </labels>
                <created>Wed, 23 Oct 2013 14:14:20 +0000</created>
                <updated>Thu, 21 Nov 2013 10:30:24 +0000</updated>
                            <resolved>Wed, 30 Oct 2013 11:31:01 +0000</resolved>
                                                    <fixVersion>0.11</fixVersion>
                                    <component>core</component>
                    <component>jcr</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="13802892" author="asanso" created="Wed, 23 Oct 2013 14:16:28 +0000"  >&lt;p&gt;attaching unit test&lt;/p&gt;</comment>
                            <comment id="13802906" author="mduerig" created="Wed, 23 Oct 2013 14:41:12 +0000"  >&lt;p&gt;I think the test expectations are to strict: the returned calendar values represent the same date, only the time zone differ. According to the JCR spec: &quot;If V1 and V2 are values of type DATE then the repository must use the semantics of java.lang.Calendar.compareTo, as described in &#167;3.6.5.1 CompareTo Semantics.&quot;&lt;/p&gt;

&lt;p&gt;Thus the assertion in the test case should read&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;assertEquals(0, cal.compareTo(root.getProperty(&lt;span class=&quot;code-quote&quot;&gt;&quot;start&quot;&lt;/span&gt;).getDate()));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13802943" author="asanso" created="Wed, 23 Oct 2013 15:27:18 +0000"  >&lt;p&gt;fair enough,&lt;/p&gt;

&lt;p&gt;FYI though Jackrabbit behaves differently. So let&apos;s make at part of &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-14&quot; title=&quot;Identify and document changes in behaviour wrt. Jackrabbit 2&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-14&quot;&gt;&lt;del&gt;OAK-14&lt;/del&gt;&lt;/a&gt; (??)&lt;/p&gt;</comment>
                            <comment id="13802952" author="mduerig" created="Wed, 23 Oct 2013 15:32:14 +0000"  >&lt;p&gt;Ack&lt;/p&gt;</comment>
                            <comment id="13802953" author="jukkaz" created="Wed, 23 Oct 2013 15:32:46 +0000"  >&lt;p&gt;Do we have a case where this would require changes in existing client code? If yes, I think it should be easy enough to change the implementation to store date values as strings instead of longs. Otherwise I&apos;d just document this in &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-14&quot; title=&quot;Identify and document changes in behaviour wrt. Jackrabbit 2&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-14&quot;&gt;&lt;del&gt;OAK-14&lt;/del&gt;&lt;/a&gt; as suggested.&lt;/p&gt;</comment>
                            <comment id="13802981" author="mduerig" created="Wed, 23 Oct 2013 16:03:34 +0000"  >&lt;blockquote&gt;&lt;p&gt;store date values as strings instead of longs&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I&apos;m a bit reluctant here since this will both increase the storage size and conversion times considerably. &lt;/p&gt;</comment>
                            <comment id="13803031" author="jukkaz" created="Wed, 23 Oct 2013 17:18:22 +0000"  >&lt;blockquote&gt;&lt;p&gt;this will both increase the storage size and conversion times&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It does, but AFAICT not considerably.&lt;/p&gt;

&lt;p&gt;The size overhead is about 20 bytes per value, which isn&apos;t much given that the vast majority of nodes (see &lt;a href=&quot;http://markmail.org/message/kxe3iy2hnodxsghe&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://markmail.org/message/kxe3iy2hnodxsghe&lt;/a&gt;) contain at most a single date property. The SegmentMK is so far the only backend that has put serious effort into reducing the storage overhead, and there we already store all non-binary properties as strings since the size overhead is insignificant in all normal cases and still reasonable even in the unlikely worst-case scenario of a large date array with no duplicate values.&lt;/p&gt;

&lt;p&gt;The extra conversion time should also be insignificant in the big picture. It&apos;s a microsecond-level operation that I can&apos;t imagine us doing often enough to make any notable difference at the application level.&lt;/p&gt;</comment>
                            <comment id="13803168" author="tripod" created="Wed, 23 Oct 2013 19:13:10 +0000"  >&lt;p&gt;can we just use &lt;tt&gt;org.apache.jackrabbit.core.persistence.util.BundleWriter#writeDate()&lt;/tt&gt; as it&apos;s a compact and fast way of storing the calendar. and it&apos;s proven to work for a long time now. &lt;/p&gt;

&lt;p&gt;Also note, that the JCR API deliberately uses Calendar (over a simple timestamp) in order to preserve the timezone information.&lt;/p&gt;</comment>
                            <comment id="13803201" author="mduerig" created="Wed, 23 Oct 2013 19:29:53 +0000"  >&lt;blockquote&gt;&lt;p&gt;&lt;tt&gt;BundleWriter#writeDate&lt;/tt&gt;&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Good point. I think we can do that but would need to refactor that code to make it independent of the JR2 particulars. Shouldn&apos;t be too hard though.&lt;/p&gt;</comment>
                            <comment id="13803219" author="jukkaz" created="Wed, 23 Oct 2013 19:43:23 +0000"  >&lt;blockquote&gt;&lt;p&gt;BundleWriter#writeDate()&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think the exact storage format is best left to the storage engine. For example the SegmentMK explicitly avoids multiple different value types so it can better avoid duplicates. For example the amortized cost of storing the same date value in 10 nodes is just about 6 bytes per value, compared to 8 bytes per value used by the BundleWriter.&lt;/p&gt;

&lt;p&gt;The main question here is whether we should keep the time zone information around with date values. I recall early discussions where, partially because of the limited data types in the JSON format used by the MicroKernel, we considered that it would be OK to drop the time zone bits and simply store date values as timestamps. So far we haven&apos;t run into cases where that would be a problem, but perhaps here we have one.&lt;/p&gt;</comment>
                            <comment id="13803300" author="tripod" created="Wed, 23 Oct 2013 20:44:49 +0000"  >&lt;blockquote&gt;&lt;p&gt;we considered that it would be OK to drop the time zone bits and simply store date values as timestamps&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;well, I think we should not break backward compatibility here. there might be a customer that relies on the timezone information.&lt;/p&gt;</comment>
                            <comment id="13803920" author="tmueller" created="Thu, 24 Oct 2013 06:51:01 +0000"  >&lt;p&gt;We need to ensure that if you open a repository in a different timezone, that the stored times are the same. Therefore, we can&apos;t just store the UTC time. We need to store time+timezone, or local time. I&apos;m not sure if storing just the local time is spec compliant, even thought the timezone was not important for 99% of all uses cases I saw.&lt;/p&gt;

&lt;p&gt;&amp;gt; BundleWriter#writeDate() as it&apos;s a compact and fast way&lt;/p&gt;

&lt;p&gt;It uses java.util.Calendar, which I would try to avoid, at least internally (for the JCR API we have to support it, but I would avoid it within oak-core as much as possible). I have seen quite many problems with java.util.Calendar, for example &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; (I logged that bug, and it took over 2 years to resolve). It is slow, daylight saving boundaries are problematic, timezones are problematic. There will be a different API in future versions of Java.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;http://bugs.sun.com/bugdatabase/view_bug.do?bug_id=6772689&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://bugs.sun.com/bugdatabase/view_bug.do?bug_id=6772689&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13804369" author="jukkaz" created="Thu, 24 Oct 2013 16:33:28 +0000"  >&lt;p&gt;Fixed in &lt;a href=&quot;http://svn.apache.org/r1535431&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1535431&lt;/a&gt; by using ISO 8601 -formatted strings for storing date values. Currently the string gets parsed every time (i.e. no memoization) a date value is accessed as a Calendar, long, double or BigDecimal. That doesn&apos;t seem to impact our existing benchmarks.&lt;/p&gt;</comment>
                            <comment id="13808955" author="mduerig" created="Wed, 30 Oct 2013 10:55:11 +0000"  >&lt;p&gt;Reopening since conversion from long to date properties does not work correctly any more.&lt;br/&gt;
Test case at &lt;a href=&quot;http://svn.apache.org/r1537036&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1537036&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13808991" author="mduerig" created="Wed, 30 Oct 2013 11:31:01 +0000"  >&lt;p&gt;Fixed at &lt;a href=&quot;http://svn.apache.org/r1537049&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1537049&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13828712" author="alex.parvulescu" created="Thu, 21 Nov 2013 10:30:24 +0000"  >&lt;p&gt;bulk close for the 0.11 release&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12609859" name="OAK-1111-test.txt" size="1427" author="asanso" created="Wed, 23 Oct 2013 14:16:28 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>354872</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1p6hb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>355161</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>