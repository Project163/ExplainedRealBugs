<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:36:41 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-548] Moving larger trees cause OutOfMemoryError</title>
                <link>https://issues.apache.org/jira/browse/OAK-548</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;&lt;tt&gt;LargeMoveTest.moveTest&lt;/tt&gt; test runs out of heap space when moving roughly 100000 nodes (128M heap):&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;java.lang.OutOfMemoryError: Java heap space
	at java.util.Arrays.copyOf(Arrays.java:2786)
	at java.lang.StringCoding.safeTrim(StringCoding.java:64)
	at java.lang.StringCoding.access$300(StringCoding.java:34)
	at java.lang.StringCoding$StringEncoder.encode(StringCoding.java:251)
	at java.lang.StringCoding.encode(StringCoding.java:272)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.getBytes(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.java:946)
	at org.apache.jackrabbit.mk.util.IOUtils.writeString(IOUtils.java:84)
	at org.apache.jackrabbit.mk.store.BinaryBinding.writeMap(BinaryBinding.java:98)
	at org.apache.jackrabbit.mk.model.ChildNodeEntriesMap.serialize(ChildNodeEntriesMap.java:196)
	at org.apache.jackrabbit.mk.model.AbstractNode.serialize(AbstractNode.java:169)
	at org.apache.jackrabbit.mk.persistence.InMemPersistence.writeNode(InMemPersistence.java:76)
	at org.apache.jackrabbit.mk.store.DefaultRevisionStore.putNode(DefaultRevisionStore.java:276)
	at org.apache.jackrabbit.mk.model.StagedNodeTree$StagedNode.persist(StagedNodeTree.java:568)
	at org.apache.jackrabbit.mk.model.StagedNodeTree$StagedNode.persist(StagedNodeTree.java:563)
	at org.apache.jackrabbit.mk.model.StagedNodeTree$StagedNode.persist(StagedNodeTree.java:563)
	at org.apache.jackrabbit.mk.model.StagedNodeTree$StagedNode.persist(StagedNodeTree.java:563)
	at org.apache.jackrabbit.mk.model.StagedNodeTree$StagedNode.persist(StagedNodeTree.java:563)
	at org.apache.jackrabbit.mk.model.StagedNodeTree$StagedNode.persist(StagedNodeTree.java:563)
	at org.apache.jackrabbit.mk.model.StagedNodeTree$StagedNode.persist(StagedNodeTree.java:563)
	at org.apache.jackrabbit.mk.model.StagedNodeTree.persist(StagedNodeTree.java:80)
	at org.apache.jackrabbit.mk.model.CommitBuilder.doCommit(CommitBuilder.java:126)
	at org.apache.jackrabbit.mk.model.CommitBuilder.doCommit(CommitBuilder.java:94)
	at org.apache.jackrabbit.mk.core.MicroKernelImpl.commit(MicroKernelImpl.java:496)
	at org.apache.jackrabbit.oak.kernel.KernelNodeStoreBranch.commit(KernelNodeStoreBranch.java:178)
	at org.apache.jackrabbit.oak.kernel.KernelNodeStoreBranch.setRoot(KernelNodeStoreBranch.java:78)
	at org.apache.jackrabbit.oak.core.RootImpl.purgePendingChanges(RootImpl.java:355)
	at org.apache.jackrabbit.oak.core.RootImpl.commit(RootImpl.java:234)
	at org.apache.jackrabbit.oak.core.LargeMoveTest.moveTest(LargeMoveTest.java:78)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This is caused by the inefficient rebase implementation in oak-core as discussed at length in &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-464&quot; title=&quot;RootImpl.rebase() doesn&amp;#39;t handle move operations correctly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-464&quot;&gt;&lt;del&gt;OAK-464&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12626967">OAK-548</key>
            <summary>Moving larger trees cause OutOfMemoryError</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mduerig">Michael D&#252;rig</assignee>
                                    <reporter username="mduerig">Michael D&#252;rig</reporter>
                        <labels>
                    </labels>
                <created>Thu, 10 Jan 2013 15:59:53 +0000</created>
                <updated>Tue, 21 May 2013 11:26:22 +0000</updated>
                            <resolved>Thu, 28 Feb 2013 11:31:27 +0000</resolved>
                                                    <fixVersion>0.7</fixVersion>
                                    <component>core</component>
                    <component>mk</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13549739" author="mduerig" created="Thu, 10 Jan 2013 16:03:21 +0000"  >&lt;p&gt;Running them same test against the &lt;a href=&quot;https://github.com/mduerig/jackrabbit-oak/commit/c12760bf9d48aedadc16ea459c3f7b2f56c5e9ae&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;POC implementation&lt;/a&gt; done for &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-464&quot; title=&quot;RootImpl.rebase() doesn&amp;#39;t handle move operations correctly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-464&quot;&gt;&lt;del&gt;OAK-464&lt;/del&gt;&lt;/a&gt;, which uses the journal for rebasing, exhibits essentially the same problem:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;java.lang.OutOfMemoryError: Java heap space
	at java.util.HashMap.&amp;lt;init&amp;gt;(HashMap.java:209)
	at org.apache.jackrabbit.mk.model.ChildNodeEntriesMap.&amp;lt;init&amp;gt;(ChildNodeEntriesMap.java:37)
	at org.apache.jackrabbit.mk.model.AbstractNode.&amp;lt;init&amp;gt;(AbstractNode.java:42)
	at org.apache.jackrabbit.mk.model.MutableNode.&amp;lt;init&amp;gt;(MutableNode.java:31)
	at org.apache.jackrabbit.mk.model.StagedNodeTree$StagedNode.&amp;lt;init&amp;gt;(StagedNodeTree.java:444)
	at org.apache.jackrabbit.mk.model.StagedNodeTree$StagedNode.add(StagedNodeTree.java:511)
	at org.apache.jackrabbit.mk.model.StagedNodeTree$StagedNode.add(StagedNodeTree.java:514)
	at org.apache.jackrabbit.mk.model.StagedNodeTree$StagedNode.add(StagedNodeTree.java:514)
	at org.apache.jackrabbit.mk.model.StagedNodeTree$StagedNode.add(StagedNodeTree.java:514)
	at org.apache.jackrabbit.mk.model.StagedNodeTree$StagedNode.add(StagedNodeTree.java:514)
	at org.apache.jackrabbit.mk.model.StagedNodeTree$StagedNode.add(StagedNodeTree.java:514)
	at org.apache.jackrabbit.mk.model.StagedNodeTree.add(StagedNodeTree.java:133)
	at org.apache.jackrabbit.mk.model.CommitBuilder$AddNode.apply(CommitBuilder.java:272)
	at org.apache.jackrabbit.mk.model.CommitBuilder.addNode(CommitBuilder.java:60)
	at org.apache.jackrabbit.mk.core.MicroKernelImpl.commit(MicroKernelImpl.java:422)
	at org.apache.jackrabbit.oak.kernel.KernelNodeStoreBranch.commit(KernelNodeStoreBranch.java:217)
	at org.apache.jackrabbit.oak.kernel.KernelNodeStoreBranch.setRoot(KernelNodeStoreBranch.java:87)
	at org.apache.jackrabbit.oak.kernel.KernelNodeStoreBranch.rebase(KernelNodeStoreBranch.java:171)
	at org.apache.jackrabbit.oak.core.RootImpl.rebase(RootImpl.java:216)
	at org.apache.jackrabbit.oak.core.RootImpl.commit(RootImpl.java:231)
	at org.apache.jackrabbit.oak.core.LargeMoveTest.moveTest(LargeMoveTest.java:78)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)
	at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:45)
	at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:15)
	at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:42)
	at org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:20)
	at org.junit.internal.runners.statements.RunBefores.evaluate(RunBefores.java:28)
	at com.intellij.junit4.JUnit4TestRunnerUtil$IgnoreIgnoredTestJUnit4ClassRunner.runChild(JUnit4TestRunnerUtil.java:256)
	at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:47)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13549741" author="mduerig" created="Thu, 10 Jan 2013 16:04:48 +0000"  >&lt;p&gt;Running them same test against the &lt;a href=&quot;https://github.com/mduerig/jackrabbit-oak/commit/14b5ee334ce51876fc5b7f462904c2cbcd5ed3e9&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;POC implementation&lt;/a&gt; done for &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-536&quot; title=&quot;Implement rebase for branches in Microkernel&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-536&quot;&gt;&lt;del&gt;OAK-536&lt;/del&gt;&lt;/a&gt;, which adds rebase functionality to the Microkernel works fine. &lt;/p&gt;</comment>
                            <comment id="13552526" author="tmueller" created="Mon, 14 Jan 2013 09:17:59 +0000"  >&lt;p&gt;I ran the test on my machine using the LogWrapper and observed the following MicroKernel calls:&lt;/p&gt;

&lt;p&gt;mk0.getHeadRevision();&lt;br/&gt;
// &quot;0000000000000450&quot;&lt;br/&gt;
mk0.branch(&quot;0000000000000450&quot;);&lt;br/&gt;
// &quot;0000000000000451&quot;&lt;br/&gt;
mk0.commit(&quot;&quot;, &quot;+\&quot;/any\&quot;:{}&quot;, &quot;0000000000000451&quot;, null);&lt;br/&gt;
// &quot;0000000000000452&quot;&lt;br/&gt;
mk0.merge(&quot;0000000000000452&quot;, null);&lt;br/&gt;
// &quot;0000000000000453&quot;&lt;br/&gt;
mk0.getHeadRevision();&lt;br/&gt;
// &quot;0000000000000453&quot;&lt;br/&gt;
mk0.branch(&quot;0000000000000450&quot;);&lt;br/&gt;
// &quot;0000000000000454&quot;&lt;br/&gt;
mk0.commit(&quot;&quot;, &quot;&amp;gt;\&quot;/tree-a\&quot;:\&quot;/tree-b/tree-a-moved\&quot;&quot;, &quot;0000000000000454&quot;, null);&lt;br/&gt;
// &quot;0000000000000455&quot;&lt;br/&gt;
mk0.getHeadRevision();&lt;br/&gt;
// &quot;0000000000000453&quot;&lt;br/&gt;
mk0.getHeadRevision();&lt;br/&gt;
// &quot;0000000000000453&quot;&lt;br/&gt;
mk0.diff(&quot;0000000000000450&quot;, &quot;0000000000000455&quot;, &quot;/tree-b&quot;);&lt;/p&gt;

&lt;p&gt;The last call returned a very large string which is not actually a move operation but a series of remove node / add node operations:&lt;/p&gt;

&lt;p&gt;// &quot;+\&quot;/tree-b/tree-a-moved\&quot;:{\&quot;n-5-0\&quot;:{\&quot;n-4-4\&quot;:{\&quot;n-3-0\&quot;:{\&quot;n-2-8\&quot;:{\&quot;n-1-6\&quot;:{},\&quot;n-1-5\&quot;:{},\&quot;n-1-4\&quot;:{},\&quot;n-1-3\&quot;:{},\&quot;n-1-9\&quot;:{},\&quot;n-1-8\&quot;:{},\&quot;n-1-7\&quot;:{},\&quot;n-1-2\&quot;:{},\&quot;n-1-1\&quot;:{},\&quot;n-1-0\&quot;:{}},\&quot;n-2-9\&quot;:{\&quot;n-1-6\&quot;:{},\&quot;n-1-5\&quot;:{},\&quot;n-1-4\&quot;:{},\&quot;n-1-3\&quot;:{},\&quot;n-1-9\&quot;:{},\&quot;n-1-8\&quot;:{},\&quot;n-1-7\&quot;:{},\&quot;n-1-2\&quot;:{},\&quot;n-1-1\&quot;:{},\&quot;n-1-0\&quot;:{}},\&quot;n-2-6\&quot;:{\&quot;n-1-6\&quot;:{},\&quot;n-1-5\&quot;:{},\&quot;n-1-4\&quot;:{},\&quot;n-1-3\&quot;:{},\&quot;n-1-9\&quot;:{},\&quot;n-1-8\&quot;:{},\&quot;n-1-7\&quot;:{},\&quot;n-1-2\&quot;:{},\&quot;n-1-1\&quot;:{},\&quot;n-1-0\&quot;:{}},\&quot;n-2-7\&quot;:{\&quot;n-1-6\&quot;:{},\&quot;n-1-5\&quot;:{},\&quot;n-1-4\&quot;:{},\&quot;n-1-3\&quot;:{},\&quot;n-1-9\&quot;:{},\&quot;n-1-8\&quot;:{},\&quot;n-1-7\&quot;:{},\&quot;n-1-2\&quot;:{},\&quot;n-1-1\&quot;:{},\&quot;n-1-0\&quot;:{}},\&quot;n-2-4\&quot;:{\&quot;n-1-6\&quot;:{},\&quot;n-1-5\&quot;:{},\&quot;n-1-4\&quot;:{},\&quot;n-1-3\&quot;:{},\&quot;n-1-9\&quot;:{},\&quot;n-1-8\&quot;:{},\&quot;n-1-7\&quot;:{},\&quot;n-1-2\&quot;:{},\&quot;n-1-1\&quot;:{},\&quot;n-1-0\&quot;:{}},\&quot;n-2-5\&quot;:{\&quot;n-1-6\&quot;:{},\&quot;n-1-5\&quot;:{},\&quot;n-1-4\&quot;:{},\&quot;n-1-3\&quot;:{},\&quot;n-1-9\&quot;:{},\&quot;n-1-8\&quot;:{},\&quot;n-1-7\&quot;:{},\&quot;n-1-2\&quot;:{},\&quot;n-1-1\&quot;:{},\&quot;n-1-0\&quot;:{}},\&quot;n-2-2\&quot;:{\&quot;n-1-6\&quot;:{},\&quot;n-1-5\&quot;:{},\&quot;n-1-4\&quot;:{},\&quot;n-1-3\&quot;:{},\&quot;n-1-9\&quot;:{},\&quot;n-1-8\&quot;:{},\&quot;n-1-7\&quot;:{},\&quot;n-1-2\&quot;...&lt;/p&gt;

&lt;p&gt;After that, oak-core tries to apply this very large commit (a commit over 1 MB).&lt;/p&gt;</comment>
                            <comment id="13552527" author="tmueller" created="Mon, 14 Jan 2013 09:21:05 +0000"  >&lt;p&gt;Sorry the diff is actually only add nodes, as the diff is run against &quot;/tree-b&quot;.&lt;br/&gt;
I wonder why it is not run against &quot;/&quot;?&lt;/p&gt;</comment>
                            <comment id="13552528" author="tmueller" created="Mon, 14 Jan 2013 09:28:55 +0000"  >&lt;p&gt;RootImpl.rebase seems to use the following algorithm currently:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;do a recursive diff (using getNodes with the &quot;:hash&quot; property if possible)&lt;/li&gt;
	&lt;li&gt;for each added or removed node, commit the changes&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;so in this case the move operations is converted to a remove node and a very large add node operation. It seems to be that this is causing out of memory.&lt;/p&gt;

&lt;p&gt;It seems the same algorithm is used also for other operations, for example for validation and index updates (not only for rebase). So it seems to me that large move operations in general are causing ouf of memory in oak-core, right?&lt;/p&gt;</comment>
                            <comment id="13552541" author="tmueller" created="Mon, 14 Jan 2013 09:57:35 +0000"  >&lt;p&gt;The diff method that results in a very large string is:&lt;/p&gt;

&lt;p&gt;mk0.diff(&quot;0000000000000450&quot;, &quot;0000000000000455&quot;, &quot;/tree-b&quot;, 0);&lt;/p&gt;

&lt;p&gt;So depth is 0 in this case. I wonder if MicroKernel.diff should really return such a large result, or if it should only return a short string with the direct child nodes. According to the MicroKernel contract:&lt;/p&gt;

&lt;p&gt;depth 0: changes affecting the properties and child node names of the node at path&lt;/p&gt;

&lt;p&gt;So I wonder if it&apos;s a bug in the MicroKernel implementation that causes such a large diff?&lt;/p&gt;</comment>
                            <comment id="13553905" author="tmueller" created="Tue, 15 Jan 2013 15:39:49 +0000"  >&lt;p&gt;This seems to be caused by a bug in MicroKernelImpl.diff&lt;/p&gt;</comment>
                            <comment id="13553918" author="tmueller" created="Tue, 15 Jan 2013 15:49:29 +0000"  >&lt;p&gt;Proposed patch:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Index: src/main/java/org/apache/jackrabbit/mk/model/tree/DiffBuilder.java
===================================================================
--- src/main/java/org/apache/jackrabbit/mk/model/tree/DiffBuilder.java	(revision 1433354)
+++ src/main/java/org/apache/jackrabbit/mk/model/tree/DiffBuilder.java	(working copy)
@@ -60,7 +60,7 @@
         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (before == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
             &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (after != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
                 buff.tag(&lt;span class=&quot;code-quote&quot;&gt;&apos;+&apos;&lt;/span&gt;).key(path).object();
-                toJson(buff, after);
+                toJson(buff, after, depth);
                 &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; buff.endObject().newline().toString();
             } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
                 &lt;span class=&quot;code-comment&quot;&gt;// path doesn&apos;t exist in the specified revisions
&lt;/span&gt;@@ -117,7 +117,7 @@
                     addedNodes.put(after, p);
                     buff.tag(&lt;span class=&quot;code-quote&quot;&gt;&apos;+&apos;&lt;/span&gt;).
                             key(p).object();
-                    toJson(buff, after);
+                    toJson(buff, after, depth);
                     buff.endObject().newline();
                 }
             }
@@ -215,7 +215,7 @@
                     &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (p.startsWith(pathFilter)) {
                         buff.tag(&lt;span class=&quot;code-quote&quot;&gt;&apos;+&apos;&lt;/span&gt;).
                                 key(p).object();
-                        toJson(buff, after);
+                        toJson(buff, after, depth);
                         buff.endObject().newline();
                     }
                 }
@@ -267,14 +267,16 @@
         &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; buff.toString();
     }
 
-    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void toJson(JsopBuilder builder, NodeState node) {
+    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void toJson(JsopBuilder builder, NodeState node, &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; depth) {
         &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (PropertyState property : node.getProperties()) {
             builder.key(property.getName()).encodedValue(property.getEncodedValue());
         }
-        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (ChildNode entry : node.getChildNodeEntries(0, -1)) {
-            builder.key(entry.getName()).object();
-            toJson(builder, entry.getNode());
-            builder.endObject();
+        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (depth &amp;gt; 0) {
+            &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (ChildNode entry : node.getChildNodeEntries(0, -1)) {
+                builder.key(entry.getName()).object();
+                toJson(builder, entry.getNode(), depth - 1);
+                builder.endObject();
+            }
         }
     }
 }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13553926" author="tmueller" created="Tue, 15 Jan 2013 15:57:25 +0000"  >&lt;p&gt;Updated patch, including a test case.&lt;/p&gt;</comment>
                            <comment id="13553933" author="tmueller" created="Tue, 15 Jan 2013 16:07:41 +0000"  >&lt;p&gt;The build ran (mvn -PintegrationTesting clean install), committed the patch in revision 1433482&lt;/p&gt;</comment>
                            <comment id="13553981" author="mduerig" created="Tue, 15 Jan 2013 16:41:49 +0000"  >&lt;p&gt;&lt;tt&gt;LargeMoveTest.moveTest&lt;/tt&gt; still throws an OOME with 128M heap as initially reported. &lt;/p&gt;</comment>
                            <comment id="13553986" author="tmueller" created="Tue, 15 Jan 2013 16:43:58 +0000"  >&lt;p&gt;The test case still throws an OOME. The remaining problem seems to be that oak-core JsopDiff accumulates the &apos;remove node&apos; and all &apos;add node&apos; operations in-memory, and then tries to commit everything in one step. As far as I see, JsopDiff is used in other areas as well, so it would probably always run out of memory on a large move operation (without calling rebase).&lt;/p&gt;

&lt;p&gt;I wonder if JsopDiff should be changed to commit from time to time, or if instead of calling MicroKernel.diff the method MicroKernel.getJournal should be called (which contains the move operation) but that would require bigger changes in oak-core.&lt;/p&gt;

&lt;p&gt;As far as I see, this problem is not related to rebase.&lt;/p&gt;</comment>
                            <comment id="13553990" author="mduerig" created="Tue, 15 Jan 2013 16:48:51 +0000"  >&lt;blockquote&gt;&lt;p&gt;As far as I see, this problem is not related to rebase.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Have a look at my work in &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-536&quot; title=&quot;Implement rebase for branches in Microkernel&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-536&quot;&gt;&lt;del&gt;OAK-536&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-464&quot; title=&quot;RootImpl.rebase() doesn&amp;#39;t handle move operations correctly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-464&quot;&gt;&lt;del&gt;OAK-464&lt;/del&gt;&lt;/a&gt; to see why and how this is related to rebase. &lt;/p&gt;

&lt;p&gt;If you want to propose changes for oak-core which could solve this, please supply a patch. &lt;/p&gt;</comment>
                            <comment id="13555014" author="tmueller" created="Wed, 16 Jan 2013 13:14:59 +0000"  >&lt;p&gt;&amp;gt; please supply a patch.&lt;/p&gt;

&lt;p&gt;Yes. My patch would be: implement rebase in oak-core, similar to how it was described by Jukka in &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-464&quot; title=&quot;RootImpl.rebase() doesn&amp;#39;t handle move operations correctly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-464&quot;&gt;&lt;del&gt;OAK-464&lt;/del&gt;&lt;/a&gt;:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; rebase(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; branchRevision, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; newBaseRevision) {
    &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; revision = mk.branch(newBaseRevision);
    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; jsop : mk.getJournal(oldBaseRevision, branchRevision)) {
        revision = mk.commit(&lt;span class=&quot;code-quote&quot;&gt;&quot;/&quot;&lt;/span&gt;, jsop, revision, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
    }
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; revision;
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;But probably we should first define how conflict handling should work in the MicroKernel. Having conflict handling in the MicroKernel.rebase only sounds like the wrong solution to me, as conflicts can also occur on commit and merge.&lt;/p&gt;</comment>
                            <comment id="13568786" author="mduerig" created="Fri, 1 Feb 2013 15:07:57 +0000"  >&lt;p&gt;Initial fix at revision 1441469&lt;/p&gt;</comment>
                            <comment id="13589456" author="mduerig" created="Thu, 28 Feb 2013 11:31:27 +0000"  >&lt;p&gt;Fixed at revision 1441469 &lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12617320">OAK-464</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12624960">OAK-536</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12564951" name="oak-548.patch" size="3339" author="thomasm" created="Tue, 15 Jan 2013 15:57:25 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>303660</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 38 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i17djb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>251162</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>