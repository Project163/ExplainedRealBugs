<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:50:42 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-4263] LIRS cache: excessive use of notifyAll</title>
                <link>https://issues.apache.org/jira/browse/OAK-4263</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;The LIRS cache tries to avoid loading the same cache entry concurrently. To notify a possible waiting thread, it uses notifyAll. This is a relatively expensive operation, and should be avoided if possible.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12960683">OAK-4263</key>
            <summary>LIRS cache: excessive use of notifyAll</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="thomasm">Thomas Mueller</assignee>
                                    <reporter username="thomasm">Thomas Mueller</reporter>
                        <labels>
                    </labels>
                <created>Thu, 21 Apr 2016 09:25:18 +0000</created>
                <updated>Thu, 10 Nov 2016 09:38:41 +0000</updated>
                            <resolved>Thu, 12 May 2016 08:40:14 +0000</resolved>
                                                    <fixVersion>1.5.2</fixVersion>
                    <fixVersion>1.6.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="15251618" author="tmueller" created="Thu, 21 Apr 2016 09:26:38 +0000"  >&lt;p&gt;Possible patch (uses an AtomicBoolean):&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;===================================================================
--- src/main/java/org/apache/jackrabbit/oak/cache/CacheLIRS.java	(revision 1738734)
+++ src/main/java/org/apache/jackrabbit/oak/cache/CacheLIRS.java	(working copy)
@@ -27,6 +27,7 @@
 import java.util.concurrent.ConcurrentHashMap;
 import java.util.concurrent.ConcurrentMap;
 import java.util.concurrent.ExecutionException;
+import java.util.concurrent.atomic.AtomicBoolean;
 import java.util.concurrent.atomic.AtomicInteger;
 
 import javax.annotation.Nonnull;
@@ -74,9 +75,13 @@
  */
 public class CacheLIRS&amp;lt;K, V&amp;gt; implements LoadingCache&amp;lt;K, V&amp;gt; {
 
-    private static final Logger LOG = LoggerFactory.getLogger(CacheLIRS.class);
+    static final Logger LOG = LoggerFactory.getLogger(CacheLIRS.class);
+    static final ThreadLocal&amp;lt;Integer&amp;gt; CURRENTLY_LOADING = new ThreadLocal&amp;lt;Integer&amp;gt;();
     private static final AtomicInteger NEXT_CACHE_ID = new AtomicInteger();
-    private static final ThreadLocal&amp;lt;Integer&amp;gt; CURRENTLY_LOADING = new ThreadLocal&amp;lt;Integer&amp;gt;();
+    
+    static {
+        LOG.info(&quot;CacheLIRS with less notifyAll&quot;);
+    }
 
     /**
      * Listener for items that are evicted from the cache. The listener
@@ -104,7 +109,7 @@
         void evicted(@Nonnull K key, @Nullable V value, @Nonnull RemovalCause cause);
     }
     
-    private final int cacheId = NEXT_CACHE_ID.getAndIncrement();
+    final int cacheId = NEXT_CACHE_ID.getAndIncrement();
 
     /**
      * The maximum memory this cache should use.
@@ -138,8 +143,8 @@
      * value to be loaded need to wait on the synchronization object. The
      * loading thread will notify all waiting threads once loading is done.
      */
-    final ConcurrentHashMap&amp;lt;K, Object&amp;gt; loadingInProgress =
-            new ConcurrentHashMap&amp;lt;K, Object&amp;gt;();
+    final ConcurrentHashMap&amp;lt;K, AtomicBoolean&amp;gt; loadingInProgress =
+            new ConcurrentHashMap&amp;lt;K, AtomicBoolean&amp;gt;();
 
     /**
      * Create a new cache with the given number of entries, and the default
@@ -952,14 +957,14 @@
                     // to prevent a deadlock, we also load the value ourselves
                     return load(key, hash, valueLoader);
                 }
-                ConcurrentHashMap&amp;lt;K, Object&amp;gt; loading = cache.loadingInProgress;
+                ConcurrentHashMap&amp;lt;K, AtomicBoolean&amp;gt; loading = cache.loadingInProgress;
                 // the object we have to wait for in case another thread loads
                 // this value
-                Object alreadyLoading;
+                AtomicBoolean alreadyLoading;
                 // synchronized on this object, even before we put it in the
                 // cache, so that all other threads that get this object can
                 // synchronized and wait for it
-                Object loadNow = new Object();
+                AtomicBoolean loadNow = new AtomicBoolean();
                 // we synchronize a bit early here, but that&apos;s fine (we don&apos;t
                 // optimize for the case where loading is extremely quick)
                 synchronized (loadNow) {
@@ -971,16 +976,20 @@
                             return load(key, hash, valueLoader);
                         } finally {
                             loading.remove(key);
-                            // notify other threads
-                            loadNow.notifyAll();
+                            if (loadNow.get()) {
+                                // notify other threads, but only if
+                                // they wait for this to be loaded
+                                loadNow.notifyAll();
+                            }
                             CURRENTLY_LOADING.remove();
                         }
                     }
                 }
                 // another thread is (or was) already loading
                 synchronized (alreadyLoading) {
+                    alreadyLoading.set(true);
                     // loading might have been finished, so check again
-                    Object alreadyLoading2 = loading.get(key);
+                    AtomicBoolean alreadyLoading2 = loading.get(key);
                     if (alreadyLoading2 != alreadyLoading) {
                         // loading has completed before we could synchronize,
                         // so we repeat

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15251619" author="tmueller" created="Thu, 21 Apr 2016 09:27:04 +0000"  >&lt;p&gt;The &quot;LOG.info(&quot;CacheLIRS with less notifyAll&quot;)&quot; is not necessary, and a test is missing.&lt;/p&gt;</comment>
                            <comment id="15281323" author="tmueller" created="Thu, 12 May 2016 08:39:53 +0000"  >&lt;p&gt;&lt;a href=&quot;http://svn.apache.org/r1743481&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1743481&lt;/a&gt; (trunk)&lt;/p&gt;

&lt;p&gt;In a microbenchmark, I didn&apos;t see much performance improvement (41 millions operations/second vs. 40 million ops/sec before). I also didn&apos;t see notifyAll() to be a problem even without the fix. Maybe this is also related to the JVM and other factors. But I have seen notifyAll to be a bottleneck in a few full thread dumps before, so I guess the patch is fine.&lt;/p&gt;</comment>
                            <comment id="15284523" author="edivad" created="Mon, 16 May 2016 13:57:16 +0000"  >&lt;p&gt;Bulk close for 1.5.2&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 26 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2wfsf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>