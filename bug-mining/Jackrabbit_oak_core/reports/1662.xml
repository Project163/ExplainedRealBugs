<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:52:39 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-5878] SplitDocumentCleanup iterates twice over splitDocGarbage</title>
                <link>https://issues.apache.org/jira/browse/OAK-5878</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;&lt;tt&gt;SplitDocumentCleanup&lt;/tt&gt; currently iterates twice over &lt;tt&gt;splitDocGarbage&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;NOTE: not the case for Mongo DB, as &lt;tt&gt;MongoVersionGCSupport&lt;/tt&gt; overwrites &lt;tt&gt;deleteSplitDocuments()&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;deleteSplitDocuments()&lt;/tt&gt; currently iterates over &lt;tt&gt;splitDocGarbage&lt;/tt&gt; to obtain the IDs of the documents to be deleted. Instead, we could just collect the IDs inside &lt;tt&gt;disconnect()&lt;/tt&gt;, the memory requirements would be the same.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13047680">OAK-5878</key>
            <summary>SplitDocumentCleanup iterates twice over splitDocGarbage</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="reschke">Julian Reschke</assignee>
                                    <reporter username="reschke">Julian Reschke</reporter>
                        <labels>
                    </labels>
                <created>Thu, 2 Mar 2017 13:40:14 +0000</created>
                <updated>Tue, 16 Feb 2021 09:53:17 +0000</updated>
                            <resolved>Tue, 7 Mar 2017 13:47:09 +0000</resolved>
                                                    <fixVersion>1.7.0</fixVersion>
                    <fixVersion>1.6.2</fixVersion>
                    <fixVersion>1.4.19</fixVersion>
                    <fixVersion>1.8.0</fixVersion>
                                    <component>documentmk</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15892394" author="reschke" created="Thu, 2 Mar 2017 15:17:09 +0000"  >&lt;p&gt;Actually, once the split document has been disconnected, and could be deleted right away, no?&lt;/p&gt;</comment>
                            <comment id="15892418" author="reschke" created="Thu, 2 Mar 2017 15:30:04 +0000"  >&lt;p&gt;Proposed patch that collects up to 100 IDs and removes them in one call.&lt;/p&gt;

&lt;p&gt;Note that this code is not active for &lt;tt&gt;MongoVersionGCSupport&lt;/tt&gt; which implements it&apos;s own deletion method &amp;#8211; it might be good to check whether that&apos;s actually better to what the new default would be.&lt;/p&gt;

&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mreutegg&quot; class=&quot;user-hover&quot; rel=&quot;mreutegg&quot;&gt;mreutegg&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15892452" author="reschke" created="Thu, 2 Mar 2017 15:56:01 +0000"  >&lt;p&gt;While working on this, I noticed that &lt;tt&gt;VersionGarbageCollectorIT.gcWithConcurrentModification()&lt;/tt&gt; bypasses persistence-specific variants, because of:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        VersionGCSupport gcSupport = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; VersionGCSupport(store.getDocumentStore()) {
            @Override
            &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; Iterable&amp;lt;NodeDocument&amp;gt; getPossiblyDeletedDocs(&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; lastModifiedTime) {
                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; filter(&lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;.getPossiblyDeletedDocs(lastModifiedTime),
                        &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Predicate&amp;lt;NodeDocument&amp;gt;() {
                            @Override
                            &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; apply(NodeDocument input) {
                                &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                                    docs.put(input);
                                } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (InterruptedException e) {
                                    &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RuntimeException(e);
                                }
                                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
                            }
                        });
            }
        };
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Is this something we need to be worried about?&lt;/p&gt;</comment>
                            <comment id="15899217" author="mreutegg" created="Tue, 7 Mar 2017 10:48:43 +0000"  >&lt;blockquote&gt;&lt;p&gt;Actually, once the split document has been disconnected, and could be deleted right away, no?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes, this will work. I think the reason why the current implementation has those two distinct phases is the optimization for the MongoDB case. As you mentioned already that implementation removes the split documents at the end with a single call.&lt;/p&gt;</comment>
                            <comment id="15899229" author="mreutegg" created="Tue, 7 Mar 2017 10:55:10 +0000"  >&lt;blockquote&gt;&lt;p&gt;VersionGarbageCollectorIT.gcWithConcurrentModification() bypasses persistence-specific variants&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It would be better if the test uses the VersionGarbageCollector provided by the DocumentNodeStore, but I guess then it would be difficult to reproduce the issue the test was written for.&lt;/p&gt;</comment>
                            <comment id="15899243" author="reschke" created="Tue, 7 Mar 2017 11:00:58 +0000"  >&lt;p&gt;So this change change will only affect RDBDocumentStore, for which it is a quick win, reducing the number of table scans for &#180;VGC from 3 to 2.&lt;/p&gt;

&lt;p&gt;Even if we do something fancier for &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-5855&quot; title=&quot;RDBDocumentStore: improve query support for VersionGC&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-5855&quot;&gt;&lt;del&gt;OAK-5855&lt;/del&gt;&lt;/a&gt;, this change will be simple to backport all the way back to 1.0.&lt;/p&gt;

&lt;p&gt;So I&apos;d propose to apply this to trunk, and gradually port it back to earlier branches...&lt;/p&gt;</comment>
                            <comment id="15899257" author="mreutegg" created="Tue, 7 Mar 2017 11:11:24 +0000"  >&lt;p&gt;+1 for the changes. Though, the patch didn&apos;t apply cleanly to trunk.&lt;/p&gt;

&lt;p&gt;I also agree that this is a good candidate for a backport.&lt;/p&gt;</comment>
                            <comment id="15899361" author="reschke" created="Tue, 7 Mar 2017 12:26:56 +0000"  >&lt;p&gt;Updated patch that applies to trunk again.&lt;/p&gt;</comment>
                            <comment id="16029046" author="edivad" created="Tue, 30 May 2017 08:38:56 +0000"  >&lt;p&gt;Bulk close for 1.7.0&lt;/p&gt;</comment>
                            <comment id="16207151" author="reschke" created="Tue, 17 Oct 2017 08:09:18 +0000"  >&lt;p&gt;trunk: &lt;a href=&quot;http://svn.apache.org/r1785838&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;r1785838&lt;/a&gt;&lt;br/&gt;
1.6: &lt;a href=&quot;http://svn.apache.org/r1785844&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;r1785844&lt;/a&gt;&lt;br/&gt;
1.4: &lt;a href=&quot;http://svn.apache.org/r1812369&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;r1812369&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12856587" name="OAK-5878-2.diff" size="4603" author="reschke" created="Tue, 7 Mar 2017 12:26:56 +0000"/>
                            <attachment id="12855641" name="OAK-5878.diff" size="4744" author="reschke" created="Thu, 2 Mar 2017 15:30:04 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311120" key="com.pyxis.greenhopper.jira:gh-epic-link">
                        <customfieldname>Epic Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>OAK-3287</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 4 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3auq7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>