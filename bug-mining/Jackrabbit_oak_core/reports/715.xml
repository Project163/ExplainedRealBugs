<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:42:29 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-1418] Read performance regression</title>
                <link>https://issues.apache.org/jira/browse/OAK-1418</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;A recent benchmark run of ReadPropertyTest shows a performance regression. The most recent run (206) was executed last night and the previous one (200) is from Feb 6th.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Oak 0.17-SNAPSHOT&lt;/p&gt;</environment>
        <key id="12694686">OAK-1418</key>
            <summary>Read performance regression</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="stillalex">Alex Deparvu</assignee>
                                    <reporter username="mreutegg">Marcel Reutegger</reporter>
                        <labels>
                    </labels>
                <created>Wed, 12 Feb 2014 08:15:45 +0000</created>
                <updated>Mon, 24 Mar 2014 13:36:45 +0000</updated>
                            <resolved>Thu, 6 Mar 2014 16:21:26 +0000</resolved>
                                                    <fixVersion>0.19</fixVersion>
                                    <component>jcr</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13898979" author="jukkaz" created="Wed, 12 Feb 2014 10:27:57 +0000"  >&lt;p&gt;Hmm, I don&apos;t see this locally:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;$ java -jar oak-run-0.17-SNAPSHOT.jar benchmark ReadPropertyTest Jackrabbit Oak-Tar
Apache Jackrabbit Oak 0.17-SNAPSHOT
# ReadPropertyTest                 C     min     10%     50%     90%     max       N
Jackrabbit                         1       3       4       4       4      40   14822
Oak-Tar                            1       5       5       6       6      43   10493
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13899060" author="mreutegg" created="Wed, 12 Feb 2014 12:31:38 +0000"  >&lt;p&gt;These are results on my hardware:&lt;/p&gt;

&lt;p&gt;With i7-720QM, Windows, Java 1.7.0_51:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Apache Jackrabbit Oak 0.17-SNAPSHOT
# ReadPropertyTest                 C     min     10%     50%     90%     max       N
Jackrabbit                         1       8       8       8       9      27    7066
Oak-Tar                            1      16      16      17      18      28    3516
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;With i7-2600S, Linux, Java 1.7.0_51:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Apache Jackrabbit Oak 0.17-SNAPSHOT
# ReadPropertyTest                 C     min     10%     50%     90%     max       N
Jackrabbit                         1       4       4       4       5      12   13976
Oak-Tar                            1       7       7       8       8      22    7503
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13916280" author="jukkaz" created="Fri, 28 Feb 2014 19:56:08 +0000"  >&lt;p&gt;Revision 1573042 contains a minor performance improvement for this case, though that change is probably not related to why the performance regressed in the first place.&lt;/p&gt;

&lt;p&gt;I profiled the benchmark to get the following breakdown of where most of the time in a Node.getProperty() call is spent:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;22% in ContentSessionImpl.checkLive()&lt;/li&gt;
	&lt;li&gt;18% in Tree.getProperty()&lt;/li&gt;
	&lt;li&gt;15% in RefreshStrategy.needsRefresh()&lt;/li&gt;
	&lt;li&gt;13% in getOakPathOrThrowNotFound(), including 10% in getSessionLocalMappings()&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Based on that breakdown it looks like we still have a lot of room for further optimization. The only thing that stands out as a possible cause of the regression would be getSessionLocalMappings() in getOakPathOrThrowNotFound(), as that&apos;s an area that I did touch earlier this month. I&apos;ll look into it.&lt;/p&gt;</comment>
                            <comment id="13920980" author="jukkaz" created="Wed, 5 Mar 2014 15:46:47 +0000"  >&lt;p&gt;A few followup changes bring the breakdown of Node.getProperty() to a more reasonable:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;40% in Tree.getProperty()&lt;/li&gt;
	&lt;li&gt;21% in RefreshStrategy.needsRefresh()&lt;/li&gt;
	&lt;li&gt;12% in getOakPathOrThrowNotFound()&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;There&apos;s still some room for improvement in needsRefresh() and getOakPath(), it would be good to have Tree.getProperty() to account for at least half the time of Node.getProperty().&lt;/p&gt;

&lt;p&gt;The numbers on my laptop (Lenowo W530, i7-3840, Windows, Java 1.7.0_40):&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Apache Jackrabbit Oak 0.19-SNAPSHOT
# ReadPropertyTest                 C     min     10%     50%     90%     max       N
Jackrabbit                         1       3       4       4       4      30   15155
Oak-Tar                            1       5       5       5       6      28   11461
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13921010" author="mduerig" created="Wed, 5 Mar 2014 16:21:12 +0000"  >&lt;p&gt;According to &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=alex.parvulescu&quot; class=&quot;user-hover&quot; rel=&quot;alex.parvulescu&quot;&gt;alex.parvulescu&lt;/a&gt; parts of the regression is do to gathering repository statistics (&lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-1337&quot; title=&quot;Implement RepositoryStatistics from Jackrabbit API&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-1337&quot;&gt;&lt;del&gt;OAK-1337&lt;/del&gt;&lt;/a&gt;). We should probably switch repository statistics (partly) off for the time being. &lt;/p&gt;</comment>
                            <comment id="13921055" author="jukkaz" created="Wed, 5 Mar 2014 17:15:33 +0000"  >&lt;p&gt;Good point about the statistics gathering. In revision 1574575 I optimized the way the various access time stamps and counters are updated, which brings us on par with Jackrabbit Classic:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Apache Jackrabbit Oak 0.19-SNAPSHOT
# ReadPropertyTest                 C     min     10%     50%     90%     max       N
Jackrabbit                         1       3       4       4       4      36   15061
Oak-Tar                            1       3       4       4       4      40   14749
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The reduced perform() overhead also shows up in slightly increased percentages of time spent in component calls:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;42% in Tree.getProperty()&lt;/li&gt;
	&lt;li&gt;22% in RefreshStrategy.needsRefresh()&lt;/li&gt;
	&lt;li&gt;13% in getOakPathOrThrowNotFound()&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13921235" author="jukkaz" created="Wed, 5 Mar 2014 19:11:41 +0000"  >&lt;p&gt;I inlined parts of needsRefresh() in revision 1574626 to further reduce the overhead in Node.getProperty(). Now the distribution of execution time across the most prominent component calls is:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;63% in Tree.getProperty(), including 47% in MemoryNodeBuilder.head() and 8% in SegmentNodeState.getProperty()&lt;/li&gt;
	&lt;li&gt;13% in getOakPathOrThrowNotFound()&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13922509" author="mduerig" created="Thu, 6 Mar 2014 13:43:26 +0000"  >&lt;p&gt;Latest numbers on my machine. With r1574801, which includes Jukka&apos;s latest optimisations we are much better than before (r1574491). The line marked with ** lists the numbers I get when disabling the read and write duration statistics. Not much difference any more.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Apache Jackrabbit Oak
# ReadPropertyTest                 C     min     10%     50%     90%     max       N
Oak-Tar r1574491                   1       9       9      10      12      36    5861
Oak-Tar r1574801                   1       6       6       7       8      33    8617
Oak-Tar **                         1       5       5       6       7      19   10150
Jackrabbit                         1       5       5       5       7      13   10761
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=alex.parvulescu&quot; class=&quot;user-hover&quot; rel=&quot;alex.parvulescu&quot;&gt;alex.parvulescu&lt;/a&gt; since you had different figures on your machine, could you validate these numbers? If the difference with disabling the read and write duration stats is similarly small for you, I suggest we resolve this issue without any additional actions. Otherwise assign it back to me please. &lt;/p&gt;</comment>
                            <comment id="13922698" author="alex.parvulescu" created="Thu, 6 Mar 2014 16:20:44 +0000"  >&lt;p&gt;Interesting, &lt;em&gt;8617&lt;/em&gt; I&apos;m a bit jealous &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &lt;/p&gt;

&lt;p&gt;Let me paste in how the numbers look on a stone-age machine:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;# ReadPropertyTest                 C     min     10%     50%     90%     max       N
Oak-Tar                            1      19      20      20      22      41    2895
Oak-Tar no stats                   1      13      14      15      16      29    3991
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The speedup is there, (this used to be around 2k), but this is also possibly related to the fact that nanoTime is OS dependent, and on some setups it can be slower.&lt;br/&gt;
I agree we can resolve this based on the already nice improvement.&lt;/p&gt;

&lt;p&gt;My setup is: &lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Ubuntu 12.04  32-bit&lt;/li&gt;
	&lt;li&gt;Intel&#174; Core&#8482; i7 CPU Q 820 @ 1.73GHz &#215; 8&lt;/li&gt;
	&lt;li&gt;java 1.7.0_40-b43&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Maybe &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mreutegg&quot; class=&quot;user-hover&quot; rel=&quot;mreutegg&quot;&gt;mreutegg&lt;/a&gt; can also paste in his numbers to compare with the original ones?&lt;/p&gt;</comment>
                            <comment id="13923093" author="jukkaz" created="Thu, 6 Mar 2014 21:30:05 +0000"  >&lt;p&gt;Given that both &lt;tt&gt;nanoTime()&lt;/tt&gt; and &lt;tt&gt;currentTimeMillis()&lt;/tt&gt; can be pretty slow on some platforms, I came up with a new &lt;tt&gt;Clock&lt;/tt&gt; mechanism that allows us to delegate the timekeeping work to a background task and thus make the time measurements in &lt;tt&gt;SessionDelegate.perform()&lt;/tt&gt; essentially instantaneous. See revision 1575050. The drawback is that the measurement accuracy is at most at millisecond level, which makes the collected statistics only useful across longer periods of time. Anyway, the result takes us beyond Jackrabbit at least on my laptop:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Apache Jackrabbit Oak 0.19-SNAPSHOT
# ReadPropertyTest                 C     min     10%     50%     90%     max       N
Jackrabbit                         1       3       4       4       4      70   14884
Oak-Tar                            1       2       3       3       4      70   19083
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13924018" author="jukkaz" created="Fri, 7 Mar 2014 16:25:03 +0000"  >&lt;p&gt;For completeness, here&apos;s also the updated profiling breakdown of the time spent in Node.getProperty():&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;62% in Tree.getProperty(), including 15% in SegmentNodeState.getProperty()&lt;/li&gt;
	&lt;li&gt;20% in getOakPathOrThrowNotFound()&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;It should be noted that at this level the profiling results are already somewhat inaccurate as the component calls take only fractions of microseconds and the locations of profiling samples may be heavily affected by JIT compilation. See &lt;a href=&quot;http://www-plan.cs.colorado.edu/klipto/mytkowicz-pldi10.pdf&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www-plan.cs.colorado.edu/klipto/mytkowicz-pldi10.pdf&lt;/a&gt; for more background.&lt;/p&gt;</comment>
                            <comment id="13930081" author="mreutegg" created="Tue, 11 Mar 2014 08:10:21 +0000"  >&lt;p&gt;Looks much better on my hardware as well. These are the current numbers on the i7-2600S, now on par with Jackrabbit:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Apache Jackrabbit Oak 0.19-SNAPSHOT
# ReadPropertyTest                 C     min     10%     50%     90%     max       N
Oak-Tar                            1       4       4       4       5      15   13647
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13945093" author="alex.parvulescu" created="Mon, 24 Mar 2014 13:36:45 +0000"  >&lt;p&gt;Bulk close for the 0.19 release.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12628453" name="ReadPropertyTest.png" size="21024" author="mreutegg" created="Wed, 12 Feb 2014 08:16:32 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>373194</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 34 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1sban:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>373495</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>