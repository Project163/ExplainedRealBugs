<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:41:15 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-1274] Wrong comparison for old Revisions</title>
                <link>https://issues.apache.org/jira/browse/OAK-1274</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;Comparing revisions may return wrong results when one of the revision is older than the oldest revision range kept in the RevisionComparator.&lt;/p&gt;

&lt;p&gt;There are multiple reasons why there is no revision range for a revision.&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The revision was created more than an hour ago and the associated range was purged from the RevisionComparator. This happens in the background thread of MongoNodeStore with a threshold of one hour.&lt;/li&gt;
	&lt;li&gt;The revision isn&apos;t actually that old, but still included in a range of the RevisionComparator because the MongoNodeStore instance was just initialized and only has ranges for recent revisions but not for those before the init.&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="12684018">OAK-1274</key>
            <summary>Wrong comparison for old Revisions</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mreutegg">Marcel Reutegger</assignee>
                                    <reporter username="mreutegg">Marcel Reutegger</reporter>
                        <labels>
                    </labels>
                <created>Wed, 11 Dec 2013 12:37:34 +0000</created>
                <updated>Mon, 13 Jan 2014 13:05:56 +0000</updated>
                            <resolved>Thu, 12 Dec 2013 15:42:00 +0000</resolved>
                                    <version>0.13</version>
                                    <fixVersion>0.14</fixVersion>
                                    <component>core</component>
                    <component>mongomk</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13845354" author="mreutegg" created="Wed, 11 Dec 2013 12:43:10 +0000"  >&lt;p&gt;Added a test in &lt;a href=&quot;http://svn.apache.org/r1550126&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1550126&lt;/a&gt; (currently ignored).&lt;/p&gt;</comment>
                            <comment id="13845462" author="tmueller" created="Wed, 11 Dec 2013 15:03:54 +0000"  >&lt;p&gt;I have a patch, but one of the tests fails now for me, and I am not sure why (the org.apache.jackrabbit.oak.plugins.mongomk.RandomizedClusterTest):&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Index: src/main/java/org/apache/jackrabbit/oak/plugins/mongomk/Revision.java
===================================================================
--- src/main/java/org/apache/jackrabbit/oak/plugins/mongomk/Revision.java	(revision 1550150)
+++ src/main/java/org/apache/jackrabbit/oak/plugins/mongomk/Revision.java	(working copy)
@@ -72,10 +72,19 @@
     /**
      * Compare the time part of two revisions. If they contain the same time,
      * the counter is compared.
+     * &amp;lt;p&amp;gt;
+     * This method requires that both revisions are from the same cluster node.
      * 
+     * @param other the other revision
      * @return -1 if this revision occurred earlier, 1 if later, 0 if equal
+     * @throws IllegalArgumentException if the cluster ids don&apos;t match
      */
     int compareRevisionTime(Revision other) {
+        if (clusterId != other.clusterId) {
+            throw new IllegalArgumentException(
+                    &quot;Trying to compare revisions of different cluster ids: &quot; + 
+                            this + &quot; and &quot; + other);
+        }
         int comp = timestamp &amp;lt; other.timestamp ? -1 : timestamp &amp;gt; other.timestamp ? 1 : 0;
         if (comp == 0) {
             comp = counter &amp;lt; other.counter ? -1 : counter &amp;gt; other.counter ? 1 : 0;
@@ -84,6 +93,35 @@
     }
     
     /**
+     * Compare the time part of two revisions. If they contain the same time,
+     * the counter is compared. If the counter is the same, the cluster ids are
+     * compared.
+     * 
+     * @param other the other revision
+     * @return -1 if this revision occurred earlier, 1 if later, 0 if equal
+     */    
+    int compareRevisionTimeThenClusterId(Revision other) {
+        int comp = timestamp &amp;lt; other.timestamp ? -1 : timestamp &amp;gt; other.timestamp ? 1 : 0;
+        if (comp == 0) {
+            comp = counter &amp;lt; other.counter ? -1 : counter &amp;gt; other.counter ? 1 : 0;
+        }
+        if (comp == 0) {
+            comp = compareClusterId(other);
+        }
+        return comp;
+    }
+    
+    /**
+     * Compare the cluster node ids of both revisions.
+     * 
+     * @param other the other revision
+     * @return -1 if this revision occurred earlier, 1 if later, 0 if equal
+     */
+    int compareClusterId(Revision other) {
+        return clusterId &amp;lt; other.clusterId ? -1 : clusterId &amp;gt; other.clusterId ? 1 : 0;
+    }
+    
+    /**
      * Create a simple revision id. The format is similar to MongoDB ObjectId.
      * 
      * @param clusterId the unique machineId + processId
@@ -427,12 +465,12 @@
             Revision range1 = getRevisionSeen(o1);
             Revision range2 = getRevisionSeen(o2);
             if (range1 == FUTURE &amp;amp;&amp;amp; range2 == FUTURE) {
-                return o1.compareRevisionTime(o2);
+                return o1.compareRevisionTimeThenClusterId(o2);
             }
             if (range1 == null || range2 == null) {
-                return o1.compareRevisionTime(o2);
+                return o1.compareRevisionTimeThenClusterId(o2);
             }
-            int comp = range1.compareRevisionTime(range2);
+            int comp = range1.compareRevisionTimeThenClusterId(range2);
             if (comp != 0) {
                 return comp;
             }
@@ -464,11 +502,12 @@
             // search from latest backward
             // (binary search could be used, but we expect most queries
             // at the end of the list)
-            Revision result = null;
             for (int i = list.size() - 1; i &amp;gt;= 0; i--) {
                 RevisionRange range = list.get(i);
                 int compare = r.compareRevisionTime(range.revision);
-                if (compare &amp;gt; 0) {
+                if (compare == 0) {
+                    return range.seenAt;
+                } else if (compare &amp;gt; 0) {
                     if (i == list.size() - 1) {
                         // newer than the newest range
                         if (r.getClusterId() == currentClusterNodeId) {
@@ -478,11 +517,10 @@
                         // happenes in the future (not visible yet)
                         return FUTURE;
                     }
-                    break;
+                    return range.seenAt;
                 }
-                result = range.seenAt;
             }
-            return result;
+            return null;
         }
         
         @Override
Index: src/main/java/org/apache/jackrabbit/oak/plugins/mongomk/StableRevisionComparator.java
===================================================================
--- src/main/java/org/apache/jackrabbit/oak/plugins/mongomk/StableRevisionComparator.java	(revision 1550150)
+++ src/main/java/org/apache/jackrabbit/oak/plugins/mongomk/StableRevisionComparator.java	(working copy)
@@ -34,10 +34,6 @@
 
     @Override
     public int compare(Revision o1, Revision o2) {
-        int comp = o1.compareRevisionTime(o2);
-        if (comp != 0) {
-            return comp;
-        }
-        return Integer.signum(o1.getClusterId() - o2.getClusterId());
+        return o1.compareRevisionTimeThenClusterId(o2);
     }
 }
Index: src/test/java/org/apache/jackrabbit/oak/plugins/mongomk/DocumentSplitTest.java
===================================================================
--- src/test/java/org/apache/jackrabbit/oak/plugins/mongomk/DocumentSplitTest.java	(revision 1550150)
+++ src/test/java/org/apache/jackrabbit/oak/plugins/mongomk/DocumentSplitTest.java	(working copy)
@@ -200,7 +200,7 @@
         Revision previous = null;
         for (Map.Entry&amp;lt;Revision, String&amp;gt; entry : revs.entrySet()) {
             if (previous != null) {
-                assertTrue(previous.compareRevisionTime(entry.getKey()) &amp;gt; 0);
+                assertTrue(previous.compareRevisionTimeThenClusterId(entry.getKey()) &amp;gt; 0);
             }
             previous = entry.getKey();
         }
Index: src/test/java/org/apache/jackrabbit/oak/plugins/mongomk/RevisionTest.java
===================================================================
--- src/test/java/org/apache/jackrabbit/oak/plugins/mongomk/RevisionTest.java	(revision 1550150)
+++ src/test/java/org/apache/jackrabbit/oak/plugins/mongomk/RevisionTest.java	(working copy)
@@ -122,6 +122,9 @@
 
         RevisionComparator comp = new RevisionComparator(0);
 
+        Revision r0c1 = new Revision(0x010, 0, 1);
+        Revision r0c2 = new Revision(0x010, 0, 2);
+        
         Revision r1c1 = new Revision(0x110, 0, 1);
         Revision r2c1 = new Revision(0x120, 0, 1);
         Revision r3c1 = new Revision(0x130, 0, 1);
@@ -142,6 +145,8 @@
                 &quot;1:\n r120-0-1:r20-0-0\n&quot; +
                 &quot;2:\n r200-0-2:r10-0-0\n&quot;, comp.toString());
 
+        assertEquals(-1, comp.compare(r0c1, r0c2));
+
         assertEquals(1, comp.compare(r1c1, r1c2));
         assertEquals(1, comp.compare(r2c1, r2c2));
         // both r3cx are still &quot;in the future&quot;
@@ -186,10 +191,6 @@
 
     }
 
-    /**
-     * OAK-1274
-     */
-    @Ignore
     @Test
     public void clusterCompare() {
         RevisionComparator comp = new RevisionComparator(1);
@@ -198,12 +199,21 @@
         Revision r1c1 = new Revision(0x10, 0, 1);
         Revision r1c2 = new Revision(0x20, 0, 2);
         Revision r2c1 = new Revision(0x30, 0, 1);
-
+        Revision r2c2 = new Revision(0x40, 0, 2);
+        
         comp.add(r1c1, new Revision(0x10, 0, 0));
         comp.add(r2c1, new Revision(0x20, 0, 0));
 
-        // there&apos;s no range for r1c2 and must
-        // be considered in the past
+        // there&apos;s no range for c2, and therefore this
+        // revision must be considered to be in the future
+        assertTrue(comp.compare(r1c2, r2c1) &amp;gt; 0);
+        
+        // add a range for r2r2
+        comp.add(r2c2, new Revision(0x30, 0, 0));
+
+        // now there is a range for c2, but the revision is old,
+        // so it must be considered to be in the past
         assertTrue(comp.compare(r1c2, r2c1) &amp;lt; 0);
     }
+    
 }

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13846164" author="mreutegg" created="Thu, 12 Dec 2013 09:04:03 +0000"  >&lt;p&gt;Thanks for the patch. I&apos;ll see what I can do.&lt;/p&gt;</comment>
                            <comment id="13846265" author="mreutegg" created="Thu, 12 Dec 2013 12:18:54 +0000"  >&lt;p&gt;I put the patch from the comment in a file and also updated the JavaDoc in RevisionComparator.getRevisionSeen() to reflect the current contract.&lt;/p&gt;

&lt;p&gt;I see the test failure as well with the patch applied.&lt;/p&gt;</comment>
                            <comment id="13846378" author="mreutegg" created="Thu, 12 Dec 2013 15:42:00 +0000"  >&lt;p&gt;The changes to the method RevisionComparator.getRevisionSeen() in the patch were actually not quite correct.&lt;/p&gt;

&lt;p&gt;Revisions not matching the lower bound of a range should return the lower bound of the next higher range, otherwise changes become visible in the past.&lt;/p&gt;

&lt;p&gt;I once more updated the JavaDoc to clarify the various cases and added more tests. To be able to write those tests I had to open up some methods and field to package private to make them visible.&lt;/p&gt;

&lt;p&gt;Fixed in &lt;a href=&quot;http://svn.apache.org/r1550438&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1550438&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13869493" author="alex.parvulescu" created="Mon, 13 Jan 2014 13:05:56 +0000"  >&lt;p&gt;bulk close for the 0.14 release&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                            <outwardlinks description="breaks">
                                        <issuelink>
            <issuekey id="12684917">OAK-1289</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12618401" name="OAK-1274.patch" size="9758" author="mreutegg" created="Thu, 12 Dec 2013 12:18:54 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>363090</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 44 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1ql67:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>363396</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>