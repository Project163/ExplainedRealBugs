<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:50:40 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-4107] NPE in MongoDocumentStore.determineServerTimeDifferenceMillis</title>
                <link>https://issues.apache.org/jira/browse/OAK-4107</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;On system startup with Mongo following exception is seen&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;07.03.2016 06:26:10.529 *WARN* [FelixStartLevel] org.apache.jackrabbit.oak.plugins.document.DocumentNodeStoreService registerNodeStore: got RuntimeException while trying to determine time difference to server: java.lang.NullPointerException
java.lang.NullPointerException: null
	at org.apache.jackrabbit.oak.plugins.document.mongo.MongoDocumentStore.determineServerTimeDifferenceMillis(MongoDocumentStore.java:1568)
	at org.apache.jackrabbit.oak.plugins.document.util.LeaseCheckDocumentStoreWrapper.determineServerTimeDifferenceMillis(LeaseCheckDocumentStoreWrapper.java:203)
	at org.apache.jackrabbit.oak.plugins.document.DocumentNodeStoreService.registerNodeStore(DocumentNodeStoreService.java:514)
	at org.apache.jackrabbit.oak.plugins.document.DocumentNodeStoreService.registerNodeStoreIfPossible(DocumentNodeStoreService.java:371)
	at org.apache.jackrabbit.oak.plugins.document.DocumentNodeStoreService.bindBlobStore(DocumentNodeStoreService.java:554)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:498)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Per code &lt;tt&gt;serverLocalTime&lt;/tt&gt; appears to be null&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Date serverLocalTime = db.command(&lt;span class=&quot;code-quote&quot;&gt;&quot;serverStatus&quot;&lt;/span&gt;).getDate(&lt;span class=&quot;code-quote&quot;&gt;&quot;localTime&quot;&lt;/span&gt;);
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; end = &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.currentTimeMillis();

        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; midPoint = (start + end) / 2;
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; serverLocalTimeMillis = serverLocalTime.getTime();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12948276">OAK-4107</key>
            <summary>NPE in MongoDocumentStore.determineServerTimeDifferenceMillis</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="stefanegli">Stefan Egli</assignee>
                                    <reporter username="chetanm">Chetan Mehrotra</reporter>
                        <labels>
                    </labels>
                <created>Wed, 9 Mar 2016 05:08:26 +0000</created>
                <updated>Tue, 5 Nov 2019 14:46:34 +0000</updated>
                            <resolved>Fri, 22 Apr 2016 08:26:31 +0000</resolved>
                                                    <fixVersion>1.5.2</fixVersion>
                    <fixVersion>1.6.0</fixVersion>
                                    <component>mongomk</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="15186752" author="egli" created="Wed, 9 Mar 2016 08:33:08 +0000"  >&lt;p&gt;sounds odd to see &lt;tt&gt;db.command(&quot;serverStatus&quot;).getDate(&quot;localTime&quot;)&lt;/tt&gt; being null .. perhaps depending on a particular mongo-os combination? a hickup of mongod? perhaps the log file would contain a hint..&lt;/p&gt;</comment>
                            <comment id="15234636" author="chetanm" created="Mon, 11 Apr 2016 07:47:08 +0000"  >&lt;p&gt;Mongo version 3.0.9&lt;/p&gt;</comment>
                            <comment id="15249455" author="egli" created="Wed, 20 Apr 2016 07:57:27 +0000"  >&lt;p&gt;we could handle this case by catching the null, issuing a log.warn and returning 0 for the time diff. that would allow things to continue normally and move the problem to seeing many log.warns in the log file (if health checks are in place).&lt;/p&gt;</comment>
                            <comment id="15251553" author="egli" created="Thu, 21 Apr 2016 08:29:46 +0000"  >&lt;p&gt;Attaching &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12799926/12799926_OAK-4107.patch&quot; title=&quot;OAK-4107.patch attached to OAK-4107&quot;&gt;OAK-4107.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; which catches, warns and returns 0 as suggested. I&apos;d suggest to go for this one and close the ticket. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chetanm&quot; class=&quot;user-hover&quot; rel=&quot;chetanm&quot;&gt;chetanm&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mreutegg&quot; class=&quot;user-hover&quot; rel=&quot;mreutegg&quot;&gt;mreutegg&lt;/a&gt;, wdyt?&lt;/p&gt;</comment>
                            <comment id="15251735" author="chetanm" created="Thu, 21 Apr 2016 11:21:30 +0000"  >&lt;p&gt;Looks fine&lt;/p&gt;</comment>
                            <comment id="15253528" author="egli" created="Fri, 22 Apr 2016 08:26:31 +0000"  >&lt;p&gt;Catching and warning done in &lt;a href=&quot;http://svn.apache.org/viewvc?rev=1740462&amp;amp;view=rev&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?rev=1740462&amp;amp;view=rev&lt;/a&gt;&lt;br/&gt;
If we&apos;ll run into many of those warns we&apos;ll have to dig further to see why mongo doesn&apos;t return a localTime in the first place&lt;/p&gt;</comment>
                            <comment id="15284525" author="edivad" created="Mon, 16 May 2016 13:57:17 +0000"  >&lt;p&gt;Bulk close for 1.5.2&lt;/p&gt;</comment>
                            <comment id="15352398" author="chetanm" created="Tue, 28 Jun 2016 05:47:25 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stefanegli&quot; class=&quot;user-hover&quot; rel=&quot;stefanegli&quot;&gt;stefanegli&lt;/a&gt; One possible explanation for this can be that command execution returned some exception but the code does not check for CommandResult being ok. So may be the code must check for command result and handle any error there. &lt;/p&gt;</comment>
                            <comment id="15352560" author="egli" created="Tue, 28 Jun 2016 08:10:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chetanm&quot; class=&quot;user-hover&quot; rel=&quot;chetanm&quot;&gt;chetanm&lt;/a&gt;, good point. I&apos;ve modified the original patch for the 1.4 branch, and added logging the exception (probably null though) and errorMessage. Attached &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12814064/12814064_OAK-4107.1_4_branch.patch&quot; title=&quot;OAK-4107.1_4_branch.patch attached to OAK-4107&quot;&gt;OAK-4107.1_4_branch.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;. wdyt?&lt;br/&gt;
(EDIT: I&apos;d also apply this additional logging to trunk as that makes sense there too of course)&lt;/p&gt;</comment>
                            <comment id="15352643" author="chetanm" created="Tue, 28 Jun 2016 09:10:15 +0000"  >&lt;p&gt;Looks good. Just minor change&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;+        	LOG.warn(&quot;determineServerTimeDifferenceMillis: db.serverStatus.localTime returned null - cannot determine time difference - assuming 0ms. &quot;
+        	        + &quot;(Result details: exception=&quot; + serverStatus.getException() + &quot;, errorMessage=&quot; + serverStatus.getErrorMessage() + &quot;)&quot;);
+        	return 0;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Instead of that have it like &lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;+        	LOG.warn(&quot;determineServerTimeDifferenceMillis: db.serverStatus.localTime returned null - cannot determine time difference - assuming 0ms. &quot;
+        	        + &quot;(Result details: server error message {}&quot;, serverStatus.getErrorMessage(), serverStatus.getException());
+        	return 0;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This would ensure the any exception stacktrace gets also dumped. Also would be better to have a new issue and fix this both on trunk and 1.4 branch&lt;/p&gt;</comment>
                            <comment id="15352655" author="egli" created="Tue, 28 Jun 2016 09:22:46 +0000"  >&lt;blockquote&gt;&lt;p&gt;Also would be better to have a new issue and fix this both on trunk and 1.4 branch&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Probably better, yes, to have this separated. Created &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-4515&quot; title=&quot;Catch NPE and log serverResult in MongoDocumentStore.determineServerTimeDifferenceMillis&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-4515&quot;&gt;&lt;del&gt;OAK-4515&lt;/del&gt;&lt;/a&gt; for that. So &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-4107&quot; title=&quot;NPE in MongoDocumentStore.determineServerTimeDifferenceMillis&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-4107&quot;&gt;&lt;del&gt;OAK-4107&lt;/del&gt;&lt;/a&gt; can stay closed as is and we can continue discussing on &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-4515&quot; title=&quot;Catch NPE and log serverResult in MongoDocumentStore.determineServerTimeDifferenceMillis&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-4515&quot;&gt;&lt;del&gt;OAK-4515&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12984304">OAK-4515</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12814064" name="OAK-4107.1_4_branch.patch" size="2031" author="stefanegli" created="Tue, 28 Jun 2016 08:10:23 +0000"/>
                            <attachment id="12799926" name="OAK-4107.patch" size="1179" author="stefanegli" created="Thu, 21 Apr 2016 08:29:46 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 20 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2udon:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>