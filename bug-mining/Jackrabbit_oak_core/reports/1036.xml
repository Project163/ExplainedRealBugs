<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:45:59 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-2147] [Ordered Index] Indexing on large content is slow</title>
                <link>https://issues.apache.org/jira/browse/OAK-2147</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;Indexing large number of ordered properties is quite slow.&lt;/p&gt;

&lt;p&gt;Explore ways of making it faster. The current skip list implementation uses 4 lanes with a probability of 10%. It should be made configurable and the defaults changed.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12744589">OAK-2147</key>
            <summary>[Ordered Index] Indexing on large content is slow</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="thomasm">Thomas Mueller</assignee>
                                    <reporter username="amitjain">Amit Jain</reporter>
                        <labels>
                    </labels>
                <created>Mon, 29 Sep 2014 05:17:00 +0000</created>
                <updated>Tue, 8 Oct 2019 15:22:12 +0000</updated>
                            <resolved>Thu, 9 Oct 2014 09:17:53 +0000</resolved>
                                                    <fixVersion>1.0.7</fixVersion>
                    <fixVersion>1.1.1</fixVersion>
                                    <component>core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14160245" author="tmueller" created="Mon, 6 Oct 2014 12:26:46 +0000"  >&lt;p&gt;Revision 1629628 (trunk): don&apos;t hardcode the number of lanes&lt;/p&gt;</comment>
                            <comment id="14163297" author="tmueller" created="Wed, 8 Oct 2014 10:19:23 +0000"  >&lt;p&gt;Patch to use 15 max lanes by default instead of 4, not store empty lanes, use probability of 0.3 instead of 0.1.&lt;/p&gt;

&lt;p&gt;The patch is for the 1.0 branch. The biggest part is changing the test cases to not use a fixed number of lanes.&lt;/p&gt;</comment>
                            <comment id="14163338" author="amitjain" created="Wed, 8 Oct 2014 11:12:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thomasm&quot; class=&quot;user-hover&quot; rel=&quot;thomasm&quot;&gt;thomasm&lt;/a&gt; I tested with random date insertions (index direction descending) and see almost a 100% performance jump at 1.3 million nodes.&lt;br/&gt;
No difference in performance if increasing dates are added (though there is some randomization for the due to indexing being async.&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;b&gt;Randomized Test&lt;/b&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;b&gt;Execution time in seconds (1.3 million)&lt;/b&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Current&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;2910&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;32 lanes - prob 0.25&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1497&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;32 lanes - prob 0.25 (w/o trimming &amp;amp; memoization&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1623&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;I have attached the change which is slightly different from the one you have. I added a little caching for &lt;tt&gt;index.getChildNode().getProperty()&lt;/tt&gt; and only creating lanes as needed.&lt;/p&gt;

&lt;p&gt;Also, I think the first condition in seek() starts by making small jumps (i.e. starts from the base lane) when in fact the search value may not be at the beginning because its a mix case and should start from the top lane. This will not be useful for indexing though. The condition I am referring to is this &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; ((direction.isAscending() &amp;amp;&amp;amp; condition &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; PredicateLessThan)
            || (direction.isDescending() &amp;amp;&amp;amp; condition &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; PredicateGreaterThan)) {
            &lt;span class=&quot;code-comment&quot;&gt;// we&apos;re asking &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; a &amp;lt;, &amp;lt;= query from ascending index or &amp;gt;, &amp;gt;= from descending
&lt;/span&gt;            &lt;span class=&quot;code-comment&quot;&gt;// we have to walk the lanes from bottom to up rather than up to bottom.&lt;/span&gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;. &lt;/p&gt;</comment>
                            <comment id="14163416" author="tmueller" created="Wed, 8 Oct 2014 12:21:48 +0000"  >&lt;p&gt;With the patch, I get about twice as fast index creation than before with 1 million nodes. The main contributor is the changed maximum number of lanes. The ch&lt;/p&gt;

&lt;p&gt;Creating the nodes: 65 seconds. &lt;br/&gt;
Creating a descending ordered index: 530 seconds (old)&lt;br/&gt;
Creating a descending ordered index: 232 seconds (new; oak.orderedIndex.prob = 1)&lt;br/&gt;
Creating a descending ordered index: 213 seconds (new)&lt;/p&gt;</comment>
                            <comment id="14163481" author="tmueller" created="Wed, 8 Oct 2014 13:39:59 +0000"  >&lt;p&gt;I have committed my patch. I will keep this bug open to compare it with the patch from Amit.&lt;/p&gt;

&lt;p&gt;Revision 1630089 (1.0 branch)&lt;br/&gt;
Revision 1630101 (trunk)&lt;/p&gt;</comment>
                            <comment id="14164939" author="tmueller" created="Thu, 9 Oct 2014 09:10:03 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-2147&quot; title=&quot;[Ordered Index] Indexing on large content is slow&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-2147&quot;&gt;&lt;del&gt;OAK-2147&lt;/del&gt;&lt;/a&gt;-benchmark.txt (in oak-jcr, not oak-run yet)&lt;/p&gt;</comment>
                            <comment id="14164946" author="tmueller" created="Thu, 9 Oct 2014 09:17:53 +0000"  >&lt;p&gt;Closing it for now to not block the release unnecessarily.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=amitj_76&quot; class=&quot;user-hover&quot; rel=&quot;amitj_76&quot;&gt;amitj_76&lt;/a&gt;, I think your patch doesn&apos;t keep the (many) lanes in memory, so I think this would be slightly better, but I don&apos;t know if the unit tests would still work without change - is it OK if we keep it as it is right now? If not, then let&apos;s open a new issue for the optimization.&lt;/p&gt;</comment>
                            <comment id="14164947" author="amitjain" created="Thu, 9 Oct 2014 09:21:07 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thomasm&quot; class=&quot;user-hover&quot; rel=&quot;thomasm&quot;&gt;thomasm&lt;/a&gt; Yes, we can close this issue for 1.0.7 and any enhancements can be taken over this change.&lt;/p&gt;</comment>
                            <comment id="14169106" author="mreutegg" created="Mon, 13 Oct 2014 09:20:39 +0000"  >&lt;p&gt;Bulk close for Oak 1.0.7&lt;/p&gt;</comment>
                            <comment id="14170873" author="edivad" created="Tue, 14 Oct 2014 12:55:13 +0000"  >&lt;p&gt;Gave a look and so far so good. thanks for the improvements. regarding&lt;br/&gt;
the unit tests I gave a run locally including integration testing and&lt;br/&gt;
all passed. The only tests I can remember which &quot;hard-code&quot; the number&lt;br/&gt;
of lanes is the&lt;br/&gt;
&lt;tt&gt;o.a.j.o./plugins/index.property.strategy.OrderedContentMirrorStorageStrategyTest&lt;/tt&gt;. In&lt;br/&gt;
this I perceive the number of lanes as a details. It should not make&lt;br/&gt;
any difference in terms of algorithm. We will add/modify tests in case&lt;br/&gt;
of errors. All other tests, as far as I remember, use the index as a&lt;br/&gt;
normal consumer not providing any details in terms of number of lanes.&lt;/p&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12673579" name="OAK-2147-Amit.patch" size="11455" author="amitjain" created="Wed, 8 Oct 2014 11:12:14 +0000"/>
                            <attachment id="12673864" name="OAK-2147-benchmark.txt" size="8442" author="thomasm" created="Thu, 9 Oct 2014 09:10:03 +0000"/>
                            <attachment id="12673572" name="OAK-2147.patch" size="75721" author="thomasm" created="Wed, 8 Oct 2014 10:19:23 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 5 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i20knb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>