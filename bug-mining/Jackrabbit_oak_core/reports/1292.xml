<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:48:44 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-3235] Deadlock when closing a concurrently used FileStore</title>
                <link>https://issues.apache.org/jira/browse/OAK-3235</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;A deadlock was detected while stopping the &lt;tt&gt;SegmentCompactionIT&lt;/tt&gt; using the exposed MBean.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Found one Java-level deadlock:
=============================
&quot;pool-1-thread-23&quot;:
  waiting to lock monitor 0x00007fa8cf1f0488 (object 0x00000007a0081e48, a org.apache.jackrabbit.oak.plugins.segment.file.FileStore),
  which is held by &quot;main&quot;
&quot;main&quot;:
  waiting to lock monitor 0x00007fa8cc015ff8 (object 0x00000007a011f750, a org.apache.jackrabbit.oak.plugins.segment.SegmentWriter),
  which is held by &quot;pool-1-thread-23&quot;

Java stack information for the threads listed above:
===================================================
&quot;pool-1-thread-23&quot;:
	at org.apache.jackrabbit.oak.plugins.segment.file.FileStore.writeSegment(FileStore.java:948)
	- waiting to lock &amp;lt;0x00000007a0081e48&amp;gt; (a org.apache.jackrabbit.oak.plugins.segment.file.FileStore)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentWriter.flush(SegmentWriter.java:228)
	- locked &amp;lt;0x00000007a011f750&amp;gt; (a org.apache.jackrabbit.oak.plugins.segment.SegmentWriter)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentWriter.prepare(SegmentWriter.java:329)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentWriter.writeListBucket(SegmentWriter.java:447)
	- locked &amp;lt;0x00000007a011f750&amp;gt; (a org.apache.jackrabbit.oak.plugins.segment.SegmentWriter)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentWriter.writeList(SegmentWriter.java:698)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentWriter.writeNode(SegmentWriter.java:1190)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentWriter$2.childNodeChanged(SegmentWriter.java:1135)
	at org.apache.jackrabbit.oak.plugins.memory.ModifiedNodeState.compareAgainstBaseState(ModifiedNodeState.java:400)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentWriter.writeNode(SegmentWriter.java:1126)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentWriter$2.childNodeChanged(SegmentWriter.java:1135)
	at org.apache.jackrabbit.oak.plugins.memory.ModifiedNodeState.compareAgainstBaseState(ModifiedNodeState.java:400)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentWriter.writeNode(SegmentWriter.java:1126)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentWriter$2.childNodeChanged(SegmentWriter.java:1135)
	at org.apache.jackrabbit.oak.plugins.memory.ModifiedNodeState.compareAgainstBaseState(ModifiedNodeState.java:400)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentWriter.writeNode(SegmentWriter.java:1126)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentWriter$2.childNodeChanged(SegmentWriter.java:1135)
	at org.apache.jackrabbit.oak.plugins.memory.ModifiedNodeState.compareAgainstBaseState(ModifiedNodeState.java:400)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentWriter.writeNode(SegmentWriter.java:1126)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentWriter$2.childNodeChanged(SegmentWriter.java:1135)
	at org.apache.jackrabbit.oak.plugins.memory.ModifiedNodeState.compareAgainstBaseState(ModifiedNodeState.java:400)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentWriter.writeNode(SegmentWriter.java:1126)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentWriter$2.childNodeChanged(SegmentWriter.java:1135)
	at org.apache.jackrabbit.oak.plugins.memory.ModifiedNodeState.compareAgainstBaseState(ModifiedNodeState.java:400)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentWriter.writeNode(SegmentWriter.java:1126)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentWriter$2.childNodeChanged(SegmentWriter.java:1135)
	at org.apache.jackrabbit.oak.plugins.memory.ModifiedNodeState.compareAgainstBaseState(ModifiedNodeState.java:400)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentWriter.writeNode(SegmentWriter.java:1126)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentWriter.writeNode(SegmentWriter.java:1154)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeBuilder.getNodeState(SegmentNodeBuilder.java:100)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeBuilder.updated(SegmentNodeBuilder.java:85)
	at org.apache.jackrabbit.oak.plugins.memory.MemoryNodeBuilder.updated(MemoryNodeBuilder.java:214)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeBuilder.updated(SegmentNodeBuilder.java:81)
	at org.apache.jackrabbit.oak.plugins.memory.MemoryNodeBuilder.setChildNode(MemoryNodeBuilder.java:346)
	at org.apache.jackrabbit.oak.spi.state.AbstractRebaseDiff.childNodeAdded(AbstractRebaseDiff.java:211)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeState.compareAgainstBaseState(SegmentNodeState.java:527)
	at org.apache.jackrabbit.oak.spi.state.AbstractRebaseDiff.childNodeChanged(AbstractRebaseDiff.java:219)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeState.compareAgainstBaseState(SegmentNodeState.java:531)
	at org.apache.jackrabbit.oak.spi.state.AbstractRebaseDiff.childNodeChanged(AbstractRebaseDiff.java:219)
	at org.apache.jackrabbit.oak.plugins.segment.MapRecord.compare(MapRecord.java:418)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeState.compareAgainstBaseState(SegmentNodeState.java:583)
	at org.apache.jackrabbit.oak.spi.state.AbstractRebaseDiff.childNodeChanged(AbstractRebaseDiff.java:219)
	at org.apache.jackrabbit.oak.plugins.segment.MapRecord.compare(MapRecord.java:418)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeState.compareAgainstBaseState(SegmentNodeState.java:583)
	at org.apache.jackrabbit.oak.spi.state.AbstractRebaseDiff.childNodeChanged(AbstractRebaseDiff.java:219)
	at org.apache.jackrabbit.oak.plugins.segment.MapRecord.compare(MapRecord.java:418)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeState.compareAgainstBaseState(SegmentNodeState.java:583)
	at org.apache.jackrabbit.oak.spi.state.AbstractRebaseDiff.childNodeChanged(AbstractRebaseDiff.java:219)
	at org.apache.jackrabbit.oak.plugins.segment.MapRecord.compare(MapRecord.java:418)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeState.compareAgainstBaseState(SegmentNodeState.java:583)
	at org.apache.jackrabbit.oak.spi.state.AbstractRebaseDiff.childNodeChanged(AbstractRebaseDiff.java:219)
	at org.apache.jackrabbit.oak.plugins.segment.MapRecord$2.childNodeChanged(MapRecord.java:404)
	at org.apache.jackrabbit.oak.plugins.segment.MapRecord.compare(MapRecord.java:488)
	at org.apache.jackrabbit.oak.plugins.segment.MapRecord.compare(MapRecord.java:394)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeState.compareAgainstBaseState(SegmentNodeState.java:583)
	at org.apache.jackrabbit.oak.spi.state.AbstractRebaseDiff.childNodeChanged(AbstractRebaseDiff.java:219)
	at org.apache.jackrabbit.oak.plugins.segment.MapRecord.compare(MapRecord.java:488)
	at org.apache.jackrabbit.oak.plugins.segment.MapRecord.compareBranch(MapRecord.java:565)
	at org.apache.jackrabbit.oak.plugins.segment.MapRecord.compare(MapRecord.java:470)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeState.compareAgainstBaseState(SegmentNodeState.java:583)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeStore$Commit.prepare(SegmentNodeStore.java:446)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeStore$Commit.optimisticMerge(SegmentNodeStore.java:471)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeStore$Commit.execute(SegmentNodeStore.java:527)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeStore.merge(SegmentNodeStore.java:205)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentCompactionIT$RandomWriter.call(SegmentCompactionIT.java:426)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentCompactionIT$RandomWriter.call(SegmentCompactionIT.java:399)
	at java.util.concurrent.FutureTask.run(FutureTask.java:266)
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
	at java.util.concurrent.FutureTask.run(FutureTask.java:266)
	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$201(ScheduledThreadPoolExecutor.java:180)
	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:293)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
	at java.lang.Thread.run(Thread.java:745)
&quot;main&quot;:
	at org.apache.jackrabbit.oak.plugins.segment.SegmentWriter.dropCache(SegmentWriter.java:850)
	- waiting to lock &amp;lt;0x00000007a011f750&amp;gt; (a org.apache.jackrabbit.oak.plugins.segment.SegmentWriter)
	at org.apache.jackrabbit.oak.plugins.segment.file.FileStore.close(FileStore.java:830)
	- locked &amp;lt;0x00000007a0081e48&amp;gt; (a org.apache.jackrabbit.oak.plugins.segment.file.FileStore)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentCompactionIT.tearDown(SegmentCompactionIT.java:266)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:497)
	at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:45)
	at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:15)
	at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:42)
	at org.junit.internal.runners.statements.RunAfters.evaluate(RunAfters.java:36)
	at org.junit.runners.ParentRunner.runLeaf(ParentRunner.java:263)
	at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:68)
	at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:47)
	at org.junit.runners.ParentRunner$3.run(ParentRunner.java:231)
	at org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:60)
	at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:229)
	at org.junit.runners.ParentRunner.access$000(ParentRunner.java:50)
	at org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:222)
	at org.junit.runners.ParentRunner.run(ParentRunner.java:300)
	at org.apache.maven.surefire.junit4.JUnit4Provider.execute(JUnit4Provider.java:252)
	at org.apache.maven.surefire.junit4.JUnit4Provider.executeTestSet(JUnit4Provider.java:141)
	at org.apache.maven.surefire.junit4.JUnit4Provider.invoke(JUnit4Provider.java:112)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:497)
	at org.apache.maven.surefire.util.ReflectionUtils.invokeMethodWithArray(ReflectionUtils.java:189)
	at org.apache.maven.surefire.booter.ProviderFactory$ProviderProxy.invoke(ProviderFactory.java:165)
	at org.apache.maven.surefire.booter.ProviderFactory.invokeProvider(ProviderFactory.java:85)
	at org.apache.maven.surefire.booter.ForkedBooter.runSuitesInProcess(ForkedBooter.java:115)
	at org.apache.maven.surefire.booter.ForkedBooter.main(ForkedBooter.java:75)

Found 1 deadlock.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12856168">OAK-3235</key>
            <summary>Deadlock when closing a concurrently used FileStore</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mduerig">Michael D&#252;rig</assignee>
                                    <reporter username="frm">Francesco Mari</reporter>
                        <labels>
                            <label>resilience</label>
                    </labels>
                <created>Fri, 14 Aug 2015 14:06:12 +0000</created>
                <updated>Thu, 24 Mar 2016 13:35:36 +0000</updated>
                            <resolved>Wed, 7 Oct 2015 07:05:57 +0000</resolved>
                                    <version>1.3.3</version>
                                    <fixVersion>1.0.30</fixVersion>
                    <fixVersion>1.2.14</fixVersion>
                    <fixVersion>1.3.8</fixVersion>
                    <fixVersion>1.4</fixVersion>
                                    <component>segmentmk</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14697205" author="frm" created="Fri, 14 Aug 2015 15:20:03 +0000"  >&lt;p&gt;The attached patch should solve the deadlock. Some additional comments on the patch:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;I also restricted the scope of the synchronized section in &lt;tt&gt;writeMapBucket()&lt;/tt&gt; which was, in my opinion, too broad for no apparent reason.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Probably the invocation to &lt;tt&gt;SegmentTracker.setSegment()&lt;/tt&gt; in &lt;tt&gt;flush()&lt;/tt&gt; can be moved out of the synchronized block, but I preferred to leave it there not to touch too many things at the same time.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Unit tests and the &lt;tt&gt;SegmentCompactionIT&lt;/tt&gt; didn&apos;t show the deadlock anymore.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mduerig&quot; class=&quot;user-hover&quot; rel=&quot;mduerig&quot;&gt;mduerig&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=alex.parvulescu&quot; class=&quot;user-hover&quot; rel=&quot;alex.parvulescu&quot;&gt;alex.parvulescu&lt;/a&gt;, can you take a look at it? The patch currently doesn&apos;t include tests. Any suggestion about how to test this?&lt;/p&gt;</comment>
                            <comment id="14706753" author="mduerig" created="Fri, 21 Aug 2015 13:51:53 +0000"  >&lt;p&gt;Patch looks good to me. I&apos;d rather not remove the synchronized from &lt;tt&gt;writeMapBucket()&lt;/tt&gt; for now though. (We can discuss doing so but lets move it out of this issue). &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=alex.parvulescu&quot; class=&quot;user-hover&quot; rel=&quot;alex.parvulescu&quot;&gt;alex.parvulescu&lt;/a&gt;, could you also have a look at this? Just to be extra sure.&lt;/p&gt;</comment>
                            <comment id="14709147" author="alex.parvulescu" created="Mon, 24 Aug 2015 12:08:09 +0000"  >&lt;p&gt;patch looks good!&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I&apos;d rather not remove the synchronized from writeMapBucket() for now though. (We can discuss doing so but lets move it out of this issue).&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;agreed, I would not introduce this change with this patch either. I would rather tackle this as a part of (a subtask of) &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-1828&quot; title=&quot;Improved SegmentWriter&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-1828&quot;&gt;&lt;del&gt;OAK-1828&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14709208" author="mduerig" created="Mon, 24 Aug 2015 12:51:51 +0000"  >&lt;p&gt;Fixed in trunk at &lt;a href=&quot;http://svn.apache.org/r1697368&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1697368&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=frm&quot; class=&quot;user-hover&quot; rel=&quot;frm&quot;&gt;frm&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=alexparvulescu&quot; class=&quot;user-hover&quot; rel=&quot;alexparvulescu&quot;&gt;alexparvulescu&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mmarth&quot; class=&quot;user-hover&quot; rel=&quot;mmarth&quot;&gt;mmarth&lt;/a&gt;, WDYT about back porting? &lt;/p&gt;</comment>
                            <comment id="14709347" author="frm" created="Mon, 24 Aug 2015 14:14:37 +0000"  >&lt;p&gt;&lt;tt&gt;SegmentWriter.flush()&lt;/tt&gt; is not so different in the 1.0 and 1.2 branches, backporting shouldn&apos;t be a problem.&lt;/p&gt;</comment>
                            <comment id="14713628" author="mduerig" created="Wed, 26 Aug 2015 15:06:55 +0000"  >&lt;p&gt;Unfortunately the fix for the deadlock seems to introduce a race condition causing a &lt;tt&gt;SNFE&lt;/tt&gt; under some circumstances. &lt;tt&gt;org.apache.jackrabbit.oak.plugins.segment.file.SegmentReferenceLimitTestIT&lt;/tt&gt; works without the fix but fails with a &lt;tt&gt;SNFE&lt;/tt&gt; every 2nd time or so with the fix: &lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.util.concurrent.ExecutionException: org.apache.jackrabbit.oak.plugins.segment.SegmentNotFoundException: Segment b114914f-1d93-4cfa-acff-197a9d0e2071 not found

	at java.util.concurrent.FutureTask.report(FutureTask.java:122)
	at java.util.concurrent.FutureTask.get(FutureTask.java:188)
	at org.apache.jackrabbit.oak.plugins.segment.file.SegmentReferenceLimitTestIT.corruption(SegmentReferenceLimitTestIT.java:102)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:606)
	at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:45)
	at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:15)
	at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:42)
	at org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:20)
	at org.junit.internal.runners.statements.RunBefores.evaluate(RunBefores.java:28)
	at org.junit.internal.runners.statements.RunAfters.evaluate(RunAfters.java:30)
	at org.junit.runners.ParentRunner.runLeaf(ParentRunner.java:263)
	at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:68)
	at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:47)
	at org.junit.runners.ParentRunner$3.run(ParentRunner.java:231)
	at org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:60)
	at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:229)
	at org.junit.runners.ParentRunner.access$000(ParentRunner.java:50)
	at org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:222)
	at org.junit.runners.ParentRunner.run(ParentRunner.java:300)
	at org.junit.runner.JUnitCore.run(JUnitCore.java:157)
	at com.intellij.junit4.JUnit4IdeaTestRunner.startRunnerWithArgs(JUnit4IdeaTestRunner.java:116)
	at com.intellij.rt.execution.junit.JUnitStarter.prepareStreamsAndStart(JUnitStarter.java:234)
	at com.intellij.rt.execution.junit.JUnitStarter.main(JUnitStarter.java:74)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:606)
	at com.intellij.rt.execution.application.AppMain.main(AppMain.java:140)
Caused by: org.apache.jackrabbit.oak.plugins.segment.SegmentNotFoundException: Segment b114914f-1d93-4cfa-acff-197a9d0e2071 not found
	at org.apache.jackrabbit.oak.plugins.segment.file.FileStore.readSegment(FileStore.java:944)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentTracker.readSegment(SegmentTracker.java:211)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentId.getSegment(SegmentId.java:149)
	at org.apache.jackrabbit.oak.plugins.segment.Record.getSegment(Record.java:82)
	at org.apache.jackrabbit.oak.plugins.segment.ListRecord.getEntry(ListRecord.java:62)
	at org.apache.jackrabbit.oak.plugins.segment.Segment.readPropsV11(Segment.java:534)
	at org.apache.jackrabbit.oak.plugins.segment.Segment.loadTemplate(Segment.java:507)
	at org.apache.jackrabbit.oak.plugins.segment.Segment.readTemplate(Segment.java:460)
	at org.apache.jackrabbit.oak.plugins.segment.Segment.readTemplate(Segment.java:454)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeState.getTemplate(SegmentNodeState.java:79)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeState.getProperty(SegmentNodeState.java:123)
	at org.apache.jackrabbit.oak.plugins.memory.MemoryNodeBuilder.getProperty(MemoryNodeBuilder.java:480)
	at org.apache.jackrabbit.oak.spi.state.AbstractRebaseDiff.propertyAdded(AbstractRebaseDiff.java:171)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeState.compareProperties(SegmentNodeState.java:592)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeState.compareAgainstBaseState(SegmentNodeState.java:491)
	at org.apache.jackrabbit.oak.spi.state.AbstractRebaseDiff.childNodeChanged(AbstractRebaseDiff.java:219)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeState.compareAgainstBaseState(SegmentNodeState.java:531)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeStore$Commit.prepare(SegmentNodeStore.java:446)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeStore$Commit.optimisticMerge(SegmentNodeStore.java:471)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeStore$Commit.execute(SegmentNodeStore.java:527)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeStore.merge(SegmentNodeStore.java:205)
	at org.apache.jackrabbit.oak.plugins.segment.file.SegmentReferenceLimitTestIT$Worker.call(SegmentReferenceLimitTestIT.java:129)
	at org.apache.jackrabbit.oak.plugins.segment.file.SegmentReferenceLimitTestIT$Worker.call(SegmentReferenceLimitTestIT.java:115)
	at java.util.concurrent.FutureTask.run(FutureTask.java:262)
	at java.lang.Thread.run(Thread.java:724)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Setting a breakpoint where the &lt;tt&gt;SNFE&lt;/tt&gt; is thrown in &lt;tt&gt;org.apache.jackrabbit.oak.plugins.segment.file.FileStore#readSegment&lt;/tt&gt; reveals that the writer actually contains the segment at this point. Apparently it didn&apos;t earlier though, which leads me to the conclusion that the fix introduces a very subtle race condition here. &lt;/p&gt;</comment>
                            <comment id="14713634" author="mduerig" created="Wed, 26 Aug 2015 15:09:30 +0000"  >&lt;p&gt;Reverted &lt;a href=&quot;http://svn.apache.org/r1697368&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1697368&lt;/a&gt; at &lt;a href=&quot;http://svn.apache.org/r1697955&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1697955&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14714206" author="mduerig" created="Wed, 26 Aug 2015 15:47:59 +0000"  >&lt;p&gt;&lt;del&gt;The &lt;tt&gt;SNFE&lt;/tt&gt; is caused by the offending segment not yet being written while it has already been removed from the writer. This can happen with the changes from the patch as &lt;tt&gt;SegmentWriter#flush&lt;/tt&gt; now calls &lt;tt&gt;SegmentStore#writeSegment&lt;/tt&gt; &lt;b&gt;after&lt;/b&gt; the segment writer already switched over to a fresh segment and &lt;b&gt;after&lt;/b&gt; given up the lock on its instance monitor. This means a concurrent call to &lt;tt&gt;FileStore#readSegment&lt;/tt&gt; doesn&apos;t find the segment in any of the readers yet and neither in the writer any more.&lt;/del&gt;&lt;/p&gt;

&lt;p&gt;The &lt;tt&gt;SNFE&lt;/tt&gt; is caused by putting the flushed segment into the cache &lt;b&gt;before&lt;/b&gt; it is written to the segment store. This make it eligible for eviction. Evicted and not yet written segments will cause a &lt;tt&gt;SNFE&lt;/tt&gt; on access. &lt;/p&gt;</comment>
                            <comment id="14945893" author="mduerig" created="Tue, 6 Oct 2015 21:48:46 +0000"  >&lt;p&gt;Updated patch: &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12765270/12765270_OAK-3235-02.patch&quot; title=&quot;OAK-3235-02.patch attached to OAK-3235&quot;&gt;OAK-3235-02.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;This patch reverses the order of writing the segment to the segment store and putting it into the cache. I did not see &lt;tt&gt;SegmentReferenceLimitTestIT&lt;/tt&gt; fail with this any more. &lt;/p&gt;

&lt;p&gt;&lt;del&gt;ITs still pending.&lt;/del&gt; ITs pass.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=frm&quot; class=&quot;user-hover&quot; rel=&quot;frm&quot;&gt;frm&lt;/a&gt;, please have a look.&lt;/p&gt;</comment>
                            <comment id="14946370" author="frm" created="Wed, 7 Oct 2015 06:49:01 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mduerig&quot; class=&quot;user-hover&quot; rel=&quot;mduerig&quot;&gt;mduerig&lt;/a&gt; it looks good to me, thanks for fixing the fix!&lt;/p&gt;</comment>
                            <comment id="14946387" author="mduerig" created="Wed, 7 Oct 2015 07:05:57 +0000"  >&lt;p&gt;Fixed at &lt;a href=&quot;http://svn.apache.org/viewvc?rev=1707189&amp;amp;view=rev&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?rev=1707189&amp;amp;view=rev&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14958624" author="edivad" created="Thu, 15 Oct 2015 10:11:18 +0000"  >&lt;p&gt;Bulk close for 1.3.8&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12902989">OAK-3493</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12750530" name="OAK-3235-01.patch" size="8490" author="frm" created="Fri, 14 Aug 2015 15:20:03 +0000"/>
                            <attachment id="12765270" name="OAK-3235-02.patch" size="10183" author="mduerig" created="Tue, 6 Oct 2015 21:48:46 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 5 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2ixh3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>