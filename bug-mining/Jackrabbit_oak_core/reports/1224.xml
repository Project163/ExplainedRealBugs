<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:47:59 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-2972] DocumentNodeStore gets initialized multiple time with RDB persistence</title>
                <link>https://issues.apache.org/jira/browse/OAK-2972</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;Depending on startup sequence it can happen that &lt;tt&gt;DocumentNodeStore&lt;/tt&gt; gets initialized multiple times. &lt;/p&gt;

&lt;p&gt;So far with Mongo &lt;tt&gt;DocumentNodeStoreService&lt;/tt&gt;  was only dependent on one external reference of &lt;tt&gt;BlobStore&lt;/tt&gt;. However with RDB there are two more external reference for &lt;tt&gt;DataSource&lt;/tt&gt; one for nodes and other for blobs. &lt;/p&gt;

&lt;p&gt;SCR (Felix Service Component Runtime) would invoke both &lt;tt&gt;bindDataSource&lt;/tt&gt; and &lt;tt&gt;bindBlobDataSource&lt;/tt&gt; and currently there is no check to avoid re initialization. &lt;/p&gt;</description>
                <environment></environment>
        <key id="12836742">OAK-2972</key>
            <summary>DocumentNodeStore gets initialized multiple time with RDB persistence</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="reschke">Julian Reschke</assignee>
                                    <reporter username="chetanm">Chetan Mehrotra</reporter>
                        <labels>
                            <label>doc-impacting</label>
                            <label>osgi</label>
                    </labels>
                <created>Wed, 10 Jun 2015 06:16:51 +0000</created>
                <updated>Wed, 2 Mar 2016 11:39:36 +0000</updated>
                            <resolved>Thu, 11 Jun 2015 13:42:26 +0000</resolved>
                                    <version>1.0.14</version>
                    <version>1.2.2</version>
                    <version>1.3.0</version>
                                    <fixVersion>1.0.15</fixVersion>
                    <fixVersion>1.2.3</fixVersion>
                    <fixVersion>1.3.1</fixVersion>
                    <fixVersion>1.4</fixVersion>
                                    <component>rdbmk</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="14580088" author="chetanm" created="Wed, 10 Jun 2015 06:18:34 +0000"  >&lt;p&gt;The bug is in the activate logic&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;--&amp;amp;&amp;amp; (dataSource == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; || (customBlobDataSource &amp;amp;&amp;amp; blobDataSource == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;))) {
++&amp;amp;&amp;amp; (dataSource == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; || blobDataSource == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;))) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;One possible fix would be to drop the check for &lt;tt&gt;customBlobDataSource&lt;/tt&gt; as in any case we want both to be initialized. If a &lt;tt&gt;customBlobDataSource&lt;/tt&gt; is not set then &lt;tt&gt;blobDataSource ==  dataSource&lt;/tt&gt;. This would ensure that initialization would be delayed untill all the required references are met.&lt;/p&gt;

&lt;p&gt;Thinking more about it we should do away with &lt;tt&gt;customBlobDataSource&lt;/tt&gt; config. If a different DataSource has to be used then admin would change the target filter for &lt;tt&gt;blobDataSource&lt;/tt&gt; and activate would delay the init untill both are defined&lt;/p&gt;</comment>
                            <comment id="14580137" author="reschke" created="Wed, 10 Jun 2015 07:00:49 +0000"  >&lt;p&gt;Note that in the log files we saw there were actually two calls to activate(), from different threads. Not sure whether this affects the fix.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;NOTE&lt;/b&gt; this may have been an error interpreting the log files&lt;/p&gt;

&lt;p&gt;Any chance that our problem is caused by &lt;b&gt;deactivation&lt;/b&gt;? In unregisterNodeStore(), if something throws early, we&apos;ll never reach mk.dispose(), right?&lt;/p&gt;</comment>
                            <comment id="14580528" author="reschke" created="Wed, 10 Jun 2015 13:31:07 +0000"  >&lt;p&gt;But the change above alone wouldn&apos;t be sufficient, right? We&apos;d also need bindDataSource() to set blobDataSource if it hasn&apos;t been set before...&lt;/p&gt;</comment>
                            <comment id="14580825" author="reschke" created="Wed, 10 Jun 2015 17:13:48 +0000"  >&lt;p&gt;So it seems that I now understand the nature of the problem, and why setting customBlobDataSource=true fixes it. I assume this is what &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chetanm&quot; class=&quot;user-hover&quot; rel=&quot;chetanm&quot;&gt;chetanm&lt;/a&gt; was trying to explain.&lt;/p&gt;

&lt;p&gt;The issue happens if:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;the DocumentNodeStoreService is activated before the data source is available&lt;/li&gt;
	&lt;li&gt;customBlobDataSource = false&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;In this case, when the data source becomes available, &lt;b&gt;both&lt;/b&gt; bindDataSource and binbBlobDataSource are called, resulting in two node store registrations. This is because from the framework&apos;s point of view, both dataSource and blobDataSource need to be bound - they have the same @Reference/target annotation.&lt;/p&gt;

&lt;p&gt;This can be checked by swapping steps 1 and 2 in DocumentNodeStoreConfigTest.testRDBDocumentStore and inspecting the unit test log; it shows that two instances of DocumentNodeStore (with two cluster node IDs) have been created.&lt;/p&gt;

&lt;p&gt;There are several ways we can fix this:&lt;/p&gt;

&lt;p&gt;1) make bindBlobDataSource a NOP when customBlobDataSource = false&lt;/p&gt;

&lt;p&gt;2) change the default @Reference/target for blobDataSource to something else&lt;/p&gt;

&lt;p&gt;3) make registerNodeStore a NOP when the node store is already registered&lt;/p&gt;

&lt;p&gt;4) remove support for customBloBDataSource until we have cleaned up the code&lt;/p&gt;</comment>
                            <comment id="14581705" author="chetanm" created="Thu, 11 Jun 2015 09:16:14 +0000"  >&lt;blockquote&gt;&lt;p&gt;1) make bindBlobDataSource a NOP when customBlobDataSource = false&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Thats tricky. As bind might be called before activate so you would not have access to the OSGi config to check if customBlobDataSource has been actually set or not&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;2) change the default @Reference/target for blobDataSource to something else&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Thats one option&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;make registerNodeStore a NOP when the node store is already registered&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;That can be done but we should still avoid such situation&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;4) remove support for customBloBDataSource until we have cleaned up the code&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;That looks best to me. When I originally added that I overlooked the fact that both DataSource have same target. If we remove &lt;tt&gt;customBlobDataSource&lt;/tt&gt; then user can still change the target for blobDataSource and activate would still wait for both reference to be not null before proceeding&lt;/p&gt;

&lt;p&gt;So I would prefer #4&lt;/p&gt;</comment>
                            <comment id="14581708" author="chetanm" created="Thu, 11 Jun 2015 09:19:57 +0000"  >&lt;blockquote&gt;&lt;p&gt;Note that in the log files we saw there were actually two calls to activate(), from different threads. Not sure whether this affects the fix.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That looks like a different scenario. Only case such thing can happen that system sees two OSGi config. But before second activate is call the first one would be asked to deactivate. Its possible that DNSS would miss the fact that deactivate is called and still proceeds to register the node store. This would cause a race conidition and something not handled in current implementation.&lt;/p&gt;
</comment>
                            <comment id="14581716" author="reschke" created="Thu, 11 Jun 2015 09:28:27 +0000"  >&lt;p&gt;updated test case demonstrating the problem&lt;/p&gt;</comment>
                            <comment id="14581722" author="reschke" created="Thu, 11 Jun 2015 09:35:12 +0000"  >&lt;p&gt;And, guess what, change 1) breaks testRDBDocumentStore_CustomBlobDataSource &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14581828" author="reschke" created="Thu, 11 Jun 2015 11:11:45 +0000"  >&lt;p&gt;Proposed patch:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;extend test cases to try different invocation sequence, making sure only one document store instance is created&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;change DocumentNodeStoreService eliminating the customBlobDataSource flag, which was redundant with blobDataSource anyway&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14581855" author="chetanm" created="Thu, 11 Jun 2015 11:56:30 +0000"  >&lt;p&gt;+1. Patch looks fine. Looking at the change done I think previous logic had a issue where blobDataSource still got used even when customBlobStore is to be used. With your fix that would also be addressed. Can you confirm?&lt;/p&gt;</comment>
                            <comment id="14581860" author="reschke" created="Thu, 11 Jun 2015 11:59:48 +0000"  >&lt;p&gt;Right; I believe this is true. Should I add a test case that tries to configure both customBlobStore &lt;b&gt;and&lt;/b&gt; blobDataSource?&lt;/p&gt;</comment>
                            <comment id="14581931" author="reschke" created="Thu, 11 Jun 2015 13:42:26 +0000"  >&lt;p&gt;wrt documentation: the config property &quot;customBlobDataSource&quot; has been removed (just specify a different blobDataSource when needed)&lt;/p&gt;</comment>
                            <comment id="14587448" author="amitjain" created="Tue, 16 Jun 2015 04:30:35 +0000"  >&lt;p&gt;Bulk close for Oak 1.0.15&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12739022" name="DocumentNodeStoreConfigTest.groovy" size="9675" author="reschke" created="Thu, 11 Jun 2015 09:28:27 +0000"/>
                            <attachment id="12739035" name="OAK-2972.diff" size="8325" author="reschke" created="Thu, 11 Jun 2015 11:11:45 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 22 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2fv47:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>