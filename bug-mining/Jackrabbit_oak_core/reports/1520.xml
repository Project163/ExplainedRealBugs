<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:51:07 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-4599] SecurityProviderRegistration fails to update config param of SecurityConfiguration(s)</title>
                <link>https://issues.apache.org/jira/browse/OAK-4599</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;h4&gt;&lt;a name=&quot;Stepstoreproduce&quot;&gt;&lt;/a&gt;Steps to reproduce&lt;/h4&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;start Oak repository in OSGi setup with additional required (custom) services that are passed to various security modules as config parameter such as e.g. &lt;tt&gt;RestrictionProvider&lt;/tt&gt;, &lt;tt&gt;UserAuthenticationFactory&lt;/tt&gt;, &lt;tt&gt;AuthorizableNodeName&lt;/tt&gt; or &lt;tt&gt;AuthorizableActionProvider&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;verify that the security setup contains the custom configurations&lt;/li&gt;
	&lt;li&gt;now, force a re-registration of the &lt;tt&gt;SecurityProvider&lt;/tt&gt; by changing a referenced/required security service, which is not associated with the custom configuration as specified in the initial setup&lt;/li&gt;
	&lt;li&gt;once completed any &lt;tt&gt;SecurityConfiguration&lt;/tt&gt;, that is associated with custom configuration params such as the examples listed above will no longer have the corresponding params set.&lt;/li&gt;
&lt;/ul&gt;


&lt;h4&gt;&lt;a name=&quot;Findingstepbystep&quot;&gt;&lt;/a&gt;Finding step by step&lt;/h4&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;tt&gt;SecurityProviderRegistration&lt;/tt&gt; waits until all configured required service  references have been registered and all non-dynamic references have been resolved.&lt;/li&gt;
	&lt;li&gt;Once everything is resolved the &lt;tt&gt;SecurityProviderRegistration&lt;/tt&gt; looks as expected including all configuration parameters&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;SecurityProviderRegistration&lt;/tt&gt; now starts creating a new &lt;tt&gt;SecurityProvider&lt;/tt&gt; instance with all the unary and required module references.&lt;/li&gt;
	&lt;li&gt;During this step it also calls &lt;tt&gt;initializeConfiguration&lt;/tt&gt; in order to have the modules populated with additional stuff from the &lt;tt&gt;SecurityProviderRegistration&lt;/tt&gt; and it&apos;s here we have IMHO a bug: The &lt;tt&gt;initializeConfiguration&lt;/tt&gt; will push the params from &lt;tt&gt;SecurityProviderRegistration&lt;/tt&gt; to the &lt;tt&gt;SecurityConfiguration&lt;/tt&gt;, while at the same time trying to merge params defined directly on the &lt;tt&gt;SecurityConfiguration&lt;/tt&gt;.&lt;/li&gt;
&lt;/ul&gt;


&lt;h4&gt;&lt;a name=&quot;Explanation&quot;&gt;&lt;/a&gt;Explanation&lt;/h4&gt;

&lt;p&gt;In a plain Java setup as it was initial designed for the &lt;tt&gt;SecurityProviderImpl&lt;/tt&gt;: The &apos;local&apos; params from &lt;tt&gt;SecurityConfiguration&lt;/tt&gt; need to take precedence over those present in &lt;tt&gt;SecurityProvider&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;However, In our new, pure Osgi setup, where there is no such mixed-param-setup, we would need a mandatory overwrite of e.g. &lt;tt&gt;RestrictionProvider&lt;/tt&gt; (s) or &lt;tt&gt;AuthorizableActionProvider&lt;/tt&gt; (s), because the &lt;em&gt;old&lt;/em&gt; values in the &lt;tt&gt;SecurityConfiguration&lt;/tt&gt; had not been provided by it&apos;s own config but as a matter of fact refer to the old values of the &lt;tt&gt;SecurityProviderRegistration&lt;/tt&gt;, which got unregistered and thus are stale service references.&lt;/p&gt;

&lt;h4&gt;&lt;a name=&quot;PotentialFixes&quot;&gt;&lt;/a&gt;Potential Fixes&lt;/h4&gt;

&lt;p&gt;In any case we must have a unit-test that illustrates the problem and allows us to verify that whatever fix we apply actually addresses the problem. I will try to provide that today.&lt;/p&gt;

&lt;h5&gt;&lt;a name=&quot;Variant1&quot;&gt;&lt;/a&gt;Variant 1&lt;/h5&gt;
&lt;p&gt;Looking back my feeling is, that we should have moved all those extra-params that get pushed to the &lt;tt&gt;SecurityConfiguration&lt;/tt&gt; as references to the modules. Not sure if/how that is feasible at the current state without risking too many compatibility issues and regressions.&lt;/p&gt;

&lt;h5&gt;&lt;a name=&quot;Variant2&quot;&gt;&lt;/a&gt;Variant 2&lt;/h5&gt;
&lt;p&gt;Since we no longer have a mixed java/osgi setup since the introduction of the &lt;tt&gt;SecurityProviderRegistration&lt;/tt&gt; and removed the OSGi-annotations from the old (now pure java) &lt;tt&gt;SecurityProviderImpl&lt;/tt&gt;, we might consider just changing the following call in &lt;tt&gt;SecurityProviderRegistration&lt;/tt&gt; from:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;base.setParameters(ConfigurationParameters.of(parameters, base.getParameters()));&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;to &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;base.setParameters(ConfigurationParameters.of(base.getParameters(), parameters));&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;and thus actually doing what we intend to do: replace the existing entries in the &lt;tt&gt;SecurityConfiguration&lt;/tt&gt; by the new ones.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12992512">OAK-4599</key>
            <summary>SecurityProviderRegistration fails to update config param of SecurityConfiguration(s)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="angela">Angela Schreiber</assignee>
                                    <reporter username="angela">Angela Schreiber</reporter>
                        <labels>
                    </labels>
                <created>Tue, 26 Jul 2016 08:24:08 +0000</created>
                <updated>Thu, 10 Nov 2016 09:55:52 +0000</updated>
                            <resolved>Thu, 4 Aug 2016 13:28:28 +0000</resolved>
                                    <version>1.0.32</version>
                    <version>1.1.8</version>
                    <version>1.2.16</version>
                    <version>1.4.5</version>
                    <version>1.5.6</version>
                                    <fixVersion>1.2.18</fixVersion>
                    <fixVersion>1.4.6</fixVersion>
                    <fixVersion>1.5.8</fixVersion>
                    <fixVersion>1.6.0</fixVersion>
                                    <component>core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15395369" author="anchela" created="Wed, 27 Jul 2016 10:14:05 +0000"  >&lt;p&gt;proposed next steps:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;unit tests illustrating the issue in OSGi setup; to be provided either in &lt;tt&gt;oak-core&lt;/tt&gt; using some OSGi-mock or in &lt;tt&gt;oak-pojosr&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;discussion of potential alternatives for a fix&lt;/li&gt;
	&lt;li&gt;implementing fix in trunk&lt;/li&gt;
	&lt;li&gt;backporting tests and fix to brances&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="15398835" author="anchela" created="Fri, 29 Jul 2016 06:51:05 +0000"  >&lt;h4&gt;&lt;a name=&quot;1Testing&quot;&gt;&lt;/a&gt;1 Testing&lt;/h4&gt;

&lt;h5&gt;&lt;a name=&quot;TestA&quot;&gt;&lt;/a&gt;Test A&lt;/h5&gt;
&lt;p&gt;with the attached groovy tests I was able to reproduce this &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/help_16.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; issue in the Oak 1.2 and Oak 1.4 branch but not in Oak trunk. This means that the mentioned &lt;tt&gt;setParameters&lt;/tt&gt; call might not be the single root cause for the issue. &lt;br/&gt;
Moving forward we first need to understand if the test actually spots the right issue and which changes between Oak 1.2/1.4 and trunk are responsible for the apparent &apos;fix&apos; of the issue, which might equally just be disguised by some other changes that affect the OSGi setup.&lt;br/&gt;
Once this is completed we can re-evaluated the options for fixing the issue.&lt;/p&gt;

&lt;p&gt;NOTE: surprisingly applying Variant 2 mentioned above didn&apos;t make the tests pass on Oak 1.2/1.4. looking of any potential difference i notices an improvement which is only present in trunk (see r1743653 and &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-4365&quot; title=&quot;Redundant Action Class Lookup in DefaultAuthorizableActionProvider&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-4365&quot;&gt;&lt;del&gt;OAK-4365&lt;/del&gt;&lt;/a&gt;). i will verify that again... but at a first glance seems that these initial tests are not suited to reproduce the reported issue. additional tests would be needed in this case.&lt;/p&gt;</comment>
                            <comment id="15404099" author="anchela" created="Tue, 2 Aug 2016 14:37:53 +0000"  >&lt;p&gt;Since I didn&apos;t manage to reproduce the issue with the OSGi test setup present in Oak trunk, here an alternative approach:&lt;/p&gt;

&lt;h5&gt;&lt;a name=&quot;TestB&quot;&gt;&lt;/a&gt;Test B&lt;/h5&gt;
&lt;p&gt;Alternative approach to illustrate the described behavior by refactoring the configuration-initialization into a separate class included tests. Tests relying on &apos;parameters&apos; replacing the entries in the &lt;tt&gt;ConfigurationBase&lt;/tt&gt; will fail without a fix, which for simplicity is included in the patch as well.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=frm&quot; class=&quot;user-hover&quot; rel=&quot;frm&quot;&gt;frm&lt;/a&gt;, what do you think? Maybe you see a way to &lt;em&gt;properly&lt;/em&gt; reproduce it with an OSGi setup?&lt;/p&gt;</comment>
                            <comment id="15404112" author="frm" created="Tue, 2 Aug 2016 14:44:28 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=anchela&quot; class=&quot;user-hover&quot; rel=&quot;anchela&quot;&gt;anchela&lt;/a&gt;, I didn&apos;t find any better way of writing a test against a full OSGi deployment. I recognize that testing a very specific section of code buried under dozens of line of OSGi-related code can be problematic at best, so I strongly approve the approach of your latest patch. If something is hard to test precisely, it&apos;s way better to factor it out and make it more test-friendly.&lt;/p&gt;</comment>
                            <comment id="15404130" author="anchela" created="Tue, 2 Aug 2016 14:55:54 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=frm&quot; class=&quot;user-hover&quot; rel=&quot;frm&quot;&gt;frm&lt;/a&gt;, not that i would like that but i really don&apos;t see another way to reproduce the issue in oak. May I kindly ask you to review the proposed refactoring... once we are good here, I think step 2 is somewhat redundant as we can&apos;t discuss alternative approaches to fixes this if we cannot reproduce the original issue... so only 3 and 4 would be left.&lt;/p&gt;</comment>
                            <comment id="15404139" author="frm" created="Tue, 2 Aug 2016 15:02:55 +0000"  >&lt;p&gt;I looked at your first two patches and I didn&apos;t see anything that I would do differently. They both look good approaches to me, and it&apos;s kind of strange that they are not able to reproduce this issue. Maybe &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chetanm&quot; class=&quot;user-hover&quot; rel=&quot;chetanm&quot;&gt;chetanm&lt;/a&gt; can help a bit more with the patch targeting &lt;tt&gt;oak-pojosr&lt;/tt&gt;? The third patch, the one with the refactoring, looks good to me.&lt;/p&gt;</comment>
                            <comment id="15405970" author="anchela" created="Wed, 3 Aug 2016 14:15:30 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chetanm&quot; class=&quot;user-hover&quot; rel=&quot;chetanm&quot;&gt;chetanm&lt;/a&gt;, I would appreciate if you could take a look at the very first patch against &lt;tt&gt;oak-pojosr&lt;/tt&gt;... maybe you see a compelling reason why we don&apos;t manage to reproduce the issue in an OSGi-based setup?&lt;/p&gt;</comment>
                            <comment id="15406264" author="chetanm" created="Wed, 3 Aug 2016 17:25:44 +0000"  >&lt;p&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12821868/12821868_OAK-4599-v3.patch&quot; title=&quot;OAK-4599-v3.patch attached to OAK-4599&quot;&gt;updated testcase patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; which seems to reproduce the issue. Key thing here is that we need to keep a dummy reference to &lt;tt&gt;UserConfiguration&lt;/tt&gt;. Otherwise &lt;tt&gt;SecurityProviderRegistration&lt;/tt&gt; would have the only reference to UserConfiguration and when it gets deactivated (say upon AuthenticationConfiguration change) then SCR would also deactivate &lt;tt&gt;UserConfiguration&lt;/tt&gt; as it sees no other component is referring it. This nullifies the test expectation as the internal state of &lt;tt&gt;UserConfiguration&lt;/tt&gt; gets reset and entry for action provider gets removed&lt;/p&gt;

&lt;p&gt;Once we keep a reference to it in testcase then it would not get deactivated and retain the state which brings out the failure scenario.&lt;/p&gt;

&lt;p&gt;Now with this case and applying your fix the testcase passes&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=anchela&quot; class=&quot;user-hover&quot; rel=&quot;anchela&quot;&gt;anchela&lt;/a&gt; Can you have a look and see if test assertions are valid&lt;/p&gt;</comment>
                            <comment id="15407440" author="anchela" created="Thu, 4 Aug 2016 08:52:17 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chetanm&quot; class=&quot;user-hover&quot; rel=&quot;chetanm&quot;&gt;chetanm&lt;/a&gt;, that was the missing piece! confirming that this indeed shows the issue. to be really sure I added and ran a variant that changes the &lt;tt&gt;AuthorizableActionProvider&lt;/tt&gt; config &lt;em&gt;before&lt;/em&gt; disabling the unary configuration. Thanks so much for looking into this, very much appreciated.&lt;/p&gt;
</comment>
                            <comment id="15407595" author="anchela" created="Thu, 4 Aug 2016 11:32:59 +0000"  >&lt;p&gt;Fixed in trunk: r1755157&lt;br/&gt;
Fixed in 1.4: r1755172 (NOTE: due to improvements made with &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-4365&quot; title=&quot;Redundant Action Class Lookup in DefaultAuthorizableActionProvider&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-4365&quot;&gt;&lt;del&gt;OAK-4365&lt;/del&gt;&lt;/a&gt; the groovy tests needed some refactoring)&lt;br/&gt;
Fixed in 1.2: r1755182 (NOTE: merging from trunk was not possible. had to manually rebuild the fix; in particular the groovy test failed for unrelated reasons when only adding the new tests).&lt;/p&gt;

&lt;p&gt;NOTE: the state of the 1.0 branch is so much behind the recent development that back-porting this issue including providing proper test coverage is not feasible with reasonable effort. Since there restarting the affected &lt;tt&gt;SecurityConfiguration&lt;/tt&gt; components (in particular &lt;tt&gt;AuthorizationConfiguration&lt;/tt&gt; and &lt;tt&gt;UserConfiguration&lt;/tt&gt;) helps working around the issue, I decided not to fix it pro-actively in the 1.0 branch. Do so requires backporting 2 years of development of the &lt;tt&gt;pojosr-module&lt;/tt&gt;, which in 1.0 doesn&apos;t contain any groovy tests.&lt;/p&gt;</comment>
                            <comment id="15407764" author="anchela" created="Thu, 4 Aug 2016 13:28:28 +0000"  >&lt;p&gt;resolving issue in order to prevent fixed versions to be modified&lt;/p&gt;</comment>
                            <comment id="15418802" author="edivad" created="Fri, 12 Aug 2016 13:17:01 +0000"  >&lt;p&gt;Bulk close for 1.4.6&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12821868" name="OAK-4599-v3.patch" size="5183" author="chetanm" created="Wed, 3 Aug 2016 17:25:44 +0000"/>
                            <attachment id="12820895" name="OAK-4599_test_1_2.patch" size="8560" author="angela" created="Fri, 29 Jul 2016 06:51:05 +0000"/>
                            <attachment id="12820894" name="OAK-4599_test_trunk.patch" size="7944" author="angela" created="Fri, 29 Jul 2016 06:51:05 +0000"/>
                            <attachment id="12821618" name="OAK-4599_trunk_var2.patch" size="16195" author="angela" created="Tue, 2 Aug 2016 14:37:53 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 14 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i31hzz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>