<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:40:32 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-1143] [scala] Repository init throws &quot;illegal cyclic reference involving class ChangeDispatcher&quot;</title>
                <link>https://issues.apache.org/jira/browse/OAK-1143</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;I&apos;ve been playing with Oak on Scala a bit and it looks like the latest changes introduced a problem that makes Oak unusable.&lt;/p&gt;

&lt;p&gt;Basically trying to setup a repo throws the following error:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;OakRepository.scala:65: error: illegal cyclic reference involving class ChangeDispatcher
[ERROR]     new Oak(new SegmentNodeStore(new FileStore(new File(fname), 268435456, true)))
[ERROR]                 ^
[ERROR] one error found
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I&apos;ve simplified the code down to the most basic barebone repo init to make it easier to digest &lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt;.&lt;/p&gt;

&lt;p&gt;This is a Scala bug, but my point is that this used to work prior to the changedispacher changes, so I&apos;m thinking we could move some bits around to get it working from Scala again.&lt;/p&gt;



&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://github.com/alexparvulescu/soak/blob/master/src/main/scala/com/pfalabs/soak/OakRepository.scala#L65&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/alexparvulescu/soak/blob/master/src/main/scala/com/pfalabs/soak/OakRepository.scala#L65&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12677329">OAK-1143</key>
            <summary>[scala] Repository init throws &quot;illegal cyclic reference involving class ChangeDispatcher&quot;</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="stillalex">Alex Deparvu</reporter>
                        <labels>
                            <label>observation</label>
                    </labels>
                <created>Mon, 4 Nov 2013 09:48:46 +0000</created>
                <updated>Thu, 21 Nov 2013 10:30:49 +0000</updated>
                            <resolved>Tue, 12 Nov 2013 12:50:08 +0000</resolved>
                                                    <fixVersion>0.11</fixVersion>
                                    <component>core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13812808" author="mduerig" created="Mon, 4 Nov 2013 12:57:00 +0000"  >&lt;p&gt;In a recent chat with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jukkaz&quot; class=&quot;user-hover&quot; rel=&quot;jukkaz&quot;&gt;jukkaz&lt;/a&gt; he argued for removing the dependency from the &lt;tt&gt;NodeStore&lt;/tt&gt; implementations to the &lt;tt&gt;ChangeDispatcher&lt;/tt&gt; by reversing the logic. We didn&apos;t consider this too important though. Maybe this issue bumps the priority a bit. &lt;/p&gt;

&lt;p&gt;Jukka, could you quickly resume what you envisioned for this?&lt;/p&gt;</comment>
                            <comment id="13812980" author="jukkaz" created="Mon, 4 Nov 2013 16:36:59 +0000"  >&lt;p&gt;So my basic idea was to change the &lt;tt&gt;Observer.contentChanged()&lt;/tt&gt; method to:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    /**
     * Observes a content change. The implementation might &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; example
     * use &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; information to update caches, trigger JCR-level observation
     * events or otherwise record the change.
     * &amp;lt;p&amp;gt;
     * Content changes are observed &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; both commits made locally against
     * the repository instance to which the hook is registered and any
     * other changes committed by other repository instances in the same
     * cluster. Extra commit information in the {@link CommitInfo} argument
     * is available &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; local commits; &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; external changes the argument is
     * {@code &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;}.
     * &amp;lt;p&amp;gt;
     * Each observer instance is guaranteed a linear sequence of observations.
     * In other words &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; method will not be called concurrently from multiple
     * threads and successive calls to &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; method represent a logical sequence
     * of repository states, i.e. the root state passed to one call is guaranteed to
     * be a base state of the root state passed to the next call. The observer is
     * expected to keep track of the previously observed state &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; it wants to use
     * a content diff to determine what exactly changed between two states.
     *
     * @param root root state of the repository
     * @param info local commit information, or {@code &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;}
     */
    void contentChanged(NodeState root, CommitInfo info);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This should allow us to split the &lt;tt&gt;ChangeDispatcher&lt;/tt&gt; functionality to a) the &lt;tt&gt;NodeStore&lt;/tt&gt;-specific bits that generates these callbacks based on the actual commits and updates from other parts of the cluster, and b) an &lt;tt&gt;Observer&lt;/tt&gt; implementation that uses event queues to decouple the event producer from the registered event consumers. The a) part would essentially consist of the &lt;tt&gt;beforeCommit&lt;/tt&gt;, &lt;tt&gt;localCommit&lt;/tt&gt;, &lt;tt&gt;afterCommit&lt;/tt&gt; and &lt;tt&gt;externalCommit&lt;/tt&gt; methods, and the &lt;tt&gt;add&lt;/tt&gt; method would be replaced by a call to the &lt;tt&gt;Observer&lt;/tt&gt; of part b). That observer would keep track of all registered normal observers, with an event queue and a dedicated listener thread for each of them. On &lt;tt&gt;contentChanged()&lt;/tt&gt; it would push a copy the observed change to each of the event queues, and the listener threads would take care of duplicating that &lt;tt&gt;contentChange&lt;/tt&gt; call to each of the registered observers.&lt;/p&gt;

&lt;p&gt;That way the NodeStore implementations would only need the part a) functionality (which could well be inlined) and a single &lt;tt&gt;Observer&lt;/tt&gt; reference (&lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-1131&quot; title=&quot;Provide a way to inject Observer instances into NodeStore implementations &quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-1131&quot;&gt;&lt;del&gt;OAK-1131&lt;/del&gt;&lt;/a&gt;), thus breaking the dependency to the more complex functionality now included in &lt;tt&gt;ChangeDispatcher&lt;/tt&gt;. And since the composite &lt;tt&gt;Observer&lt;/tt&gt; from part b) is dependant on neither the &lt;tt&gt;NodeStore&lt;/tt&gt; nor any higher level code (it just deals with observers, event queues and background threads), we can inject it both to the underlying &lt;tt&gt;NodeStore&lt;/tt&gt; and to the observation managers in &lt;tt&gt;oak-jcr&lt;/tt&gt;, thus eliminating the need for &lt;tt&gt;ContentSessionImpl&lt;/tt&gt; to be &lt;tt&gt;Observable&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;With these changes in place, we would also be able to turn the &lt;tt&gt;ChangeProcessor&lt;/tt&gt; class to a normal &lt;tt&gt;Observer&lt;/tt&gt;, attached to one of those event queues. This would make JCR observation just one observer plugin among others, and would allow us to extend the rate-limiting / background thread functionality to all observers. That in turn would for example allow us to turn the asynchronous indexer mechanism to an observer instead of it having to explicitly poll the repository for changes.&lt;/p&gt;</comment>
                            <comment id="13815006" author="mduerig" created="Wed, 6 Nov 2013 16:26:47 +0000"  >&lt;p&gt;At &lt;a href=&quot;http://svn.apache.org/r1539363&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1539363&lt;/a&gt; and &lt;a href=&quot;http://svn.apache.org/r1539379&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1539379&lt;/a&gt; I implemented parts of this: &lt;tt&gt;Observable&lt;/tt&gt; instances now allow for registration of &lt;tt&gt;Observer&lt;/tt&gt; instances and asynchronously notify them about changes in the associated &lt;tt&gt;NodeStore&lt;/tt&gt;. &lt;tt&gt;ChangeProcessor&lt;/tt&gt; (and thus observation) is now just an &lt;tt&gt;Observer&lt;/tt&gt;. &lt;tt&gt;Observable&lt;/tt&gt; is currently implemented by &lt;tt&gt;ContentSession&lt;/tt&gt;, all of our &lt;tt&gt;NodeStore&lt;/tt&gt; implementations and by &lt;tt&gt;ChangeDispatcher&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Not sure whether it is desirable to get rid of the &lt;tt&gt;Observable&lt;/tt&gt; on &lt;tt&gt;ContentSession&lt;/tt&gt; at all. If we want to do that, we need to get rid of the &lt;tt&gt;NodeStore&lt;/tt&gt; dependency of &lt;tt&gt;ChangeDispatcher&lt;/tt&gt;. The problem with that is, that we need the node store to poll for external changes in the case where there are now other pending changes. Without this a passive cluster node would never see any cluster external change. On solution here would be to push such external changes using a scheduled action instead of polling for them. &lt;/p&gt;</comment>
                            <comment id="13818552" author="jukkaz" created="Sun, 10 Nov 2013 21:25:26 +0000"  >&lt;p&gt;In &lt;a href=&quot;http://svn.apache.org/r1540548&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1540548&lt;/a&gt; I added a few generic &lt;tt&gt;Observer&lt;/tt&gt; classes that should be useful in further decoupling the various responsibilities here.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Not sure whether it is desirable to get rid of the Observable on ContentSession at all. If we want to do that, we need to get rid of the NodeStore dependency of ChangeDispatcher.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think we should do that, and vice versa (i.e. remove the ChangeDispatcher dependency in NodeStores).&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;The problem with that is, that we need the node store to poll for external changes in the case where there are now other pending changes.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;A node store in any case needs to become aware of external changes. That currently happens lazily in &lt;tt&gt;getRoot()&lt;/tt&gt; (which &lt;tt&gt;ChangeDispatcher&lt;/tt&gt; also calls), but nothing prevents a &lt;tt&gt;NodeStore&lt;/tt&gt; from proactively checking the backend for more changes and informing the observers (like you mention). Doing so would be beneficial also for other reasons, as it would remove the potentially expensive backend polling from the frequently accessed &lt;tt&gt;getRoot()&lt;/tt&gt; method. Or as a simpler alternative we could just add a timed task that simply calls &lt;tt&gt;getRoot()&lt;/tt&gt; once per second to guarantee timely observation of external content changes.&lt;/p&gt;</comment>
                            <comment id="13818917" author="mduerig" created="Mon, 11 Nov 2013 12:31:36 +0000"  >&lt;p&gt;At &lt;a href=&quot;http://svn.apache.org/r1540692&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1540692&lt;/a&gt; I went ahead and removed the &lt;tt&gt;NodeStore&lt;/tt&gt; dependency from &lt;tt&gt;ChangeDispatcher&lt;/tt&gt; along with the &lt;tt&gt;getExternalChanges()&lt;/tt&gt; call, which polled the node store for cluster external changes. Latter call was prone to deadlocks anyhow due its reverse direction of information flow (i.e. poll instead of push). As a result &quot;passive&quot; cluster nodes will currently not be notified about cluster external changes. &lt;/p&gt;

&lt;p&gt;Overall this paves the way of implementing/replacing &lt;tt&gt;ChangeDispatcher&lt;/tt&gt; with the new generic &lt;tt&gt;Obserer&lt;/tt&gt; implementations. &lt;/p&gt;</comment>
                            <comment id="13819955" author="mduerig" created="Tue, 12 Nov 2013 09:36:14 +0000"  >&lt;ul&gt;
	&lt;li&gt;At &lt;a href=&quot;http://svn.apache.org/r1540981&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1540981&lt;/a&gt; I implemented &lt;tt&gt;ChangeDispatcher&lt;/tt&gt; through a &lt;tt&gt;CompositeObserver&lt;/tt&gt; of &lt;tt&gt;BackgroundObserver&lt;/tt&gt;.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;At &lt;a href=&quot;http://svn.apache.org/r1540983&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1540983&lt;/a&gt; I made &lt;tt&gt;ChangeDispatcher&lt;/tt&gt; implement &lt;tt&gt;Observer&lt;/tt&gt; and use the latter&apos;s &lt;tt&gt;contentChanged&lt;/tt&gt; method for reporting changes instead of the separate &lt;tt&gt;beforeCommit&lt;/tt&gt;, &lt;tt&gt;localCommit&lt;/tt&gt; and &lt;tt&gt;afterCommit&lt;/tt&gt;&#160;methods we had before.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13820030" author="mduerig" created="Tue, 12 Nov 2013 11:34:05 +0000"  >&lt;p&gt;The latest changes should solve the &quot;illegal cyclic reference&quot; problem. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=alex.parvulescu&quot; class=&quot;user-hover&quot; rel=&quot;alex.parvulescu&quot;&gt;alex.parvulescu&lt;/a&gt; could you double check and resolve?&lt;/p&gt;</comment>
                            <comment id="13820065" author="alex.parvulescu" created="Tue, 12 Nov 2013 12:50:08 +0000"  >&lt;p&gt;yes indeed, the problems are now gone.&lt;br/&gt;
thanks a lot Michael!&lt;/p&gt;</comment>
                            <comment id="13828779" author="alex.parvulescu" created="Thu, 21 Nov 2013 10:30:49 +0000"  >&lt;p&gt;bulk close for the 0.11 release&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>356704</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1phrr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>356994</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>