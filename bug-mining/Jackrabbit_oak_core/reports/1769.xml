<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:53:39 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-7131] xpath to sql2 conversion drops order by clause for some cases</title>
                <link>https://issues.apache.org/jira/browse/OAK-7131</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;When xpath has OR-ed primary type and a couple of OR-ed property constraint (e.g. [0]), the converted sql statement doesn&apos;t get ordering clause.&lt;/p&gt;

&lt;p&gt;[0]:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;//(element(*, type1) | element(*, type2))[@a=&apos;b&apos; or @c=&apos;d&apos;] order by @foo
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13129657">OAK-7131</key>
            <summary>xpath to sql2 conversion drops order by clause for some cases</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="thomasm">Thomas Mueller</assignee>
                                    <reporter username="catholicon">Vikas Saurabh</reporter>
                        <labels>
                    </labels>
                <created>Tue, 9 Jan 2018 20:44:39 +0000</created>
                <updated>Tue, 8 Oct 2019 15:21:14 +0000</updated>
                            <resolved>Thu, 18 Jan 2018 13:44:19 +0000</resolved>
                                    <version>1.6.0</version>
                    <version>1.8.0</version>
                                    <fixVersion>1.9.0</fixVersion>
                    <fixVersion>1.10.0</fixVersion>
                    <fixVersion>1.8.1</fixVersion>
                    <fixVersion>1.6.9</fixVersion>
                                    <component>query</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="16319118" author="catholicon" created="Tue, 9 Jan 2018 20:53:47 +0000"  >&lt;p&gt;Added an ignored test case at &lt;a href=&quot;https://svn.apache.org/r1820700&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;r1820700&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thomasm&quot; class=&quot;user-hover&quot; rel=&quot;thomasm&quot;&gt;thomasm&lt;/a&gt;, I&apos;ve assigned the issue to you and scheduled it for 1.10. Imo, btw, this is very critical and we should backport it to 1.8 branch too.&lt;/p&gt;</comment>
                            <comment id="16319948" author="tmueller" created="Wed, 10 Jan 2018 09:23:33 +0000"  >&lt;p&gt;I agree, this is serious. Another example is:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;/jcr:root/(content | dam)[@a=1 or @b=2] order by @foo
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It looks like the bug occurs if both &quot;xpath union&quot; and &quot;order by&quot; is used at the same time.&lt;/p&gt;</comment>
                            <comment id="16327001" author="tmueller" created="Tue, 16 Jan 2018 10:56:50 +0000"  >&lt;p&gt;Possible patch (to be tested). I think query options are affected as well (needs more tests):&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Index: oak-core/src/main/java/org/apache/jackrabbit/oak/query/xpath/Statement.java
===================================================================
--- oak-core/src/main/java/org/apache/jackrabbit/oak/query/xpath/Statement.java	(revision 1817341)
+++ oak-core/src/main/java/org/apache/jackrabbit/oak/query/xpath/Statement.java	(working copy)
@@ -301,7 +301,13 @@
                 // no change
                 return this;
             }
-            return new UnionStatement(s1b, s2b);
+            UnionStatement union = new UnionStatement(s1b, s2b);
+            union.explain = explain;
+            union.measure = measure;
+            union.orderList = orderList;
+            union.queryOptions = queryOptions;
+            union.xpathQuery = xpathQuery;
+            return union;
         }
         
         @Override
Index: oak-core/src/main/java/org/apache/jackrabbit/oak/query/xpath/XPathToSQL2Converter.java
===================================================================
--- oak-core/src/main/java/org/apache/jackrabbit/oak/query/xpath/XPathToSQL2Converter.java	(revision 1817341)
+++ oak-core/src/main/java/org/apache/jackrabbit/oak/query/xpath/XPathToSQL2Converter.java	(working copy)
@@ -1150,6 +1150,7 @@
         Statement result = null;
         ArrayList&amp;lt;Order&amp;gt; orderList = null;
         QueryOptions queryOptions = null;
+        String xpathQuery = null;
         for(String p : parts) {
             String q = begin + p + end;
             converter = new XPathToSQL2Converter();
@@ -1156,11 +1157,13 @@
             Statement stat = converter.convertToStatement(q);
             orderList = stat.orderList;
             queryOptions = stat.queryOptions;
+            xpathQuery = stat.xpathQuery;
             // reset fields that are used in the union,
             // but no longer in the individual statements
             // (can not use clear, because it is shared)
             stat.orderList = new ArrayList&amp;lt;Order&amp;gt;();
             stat.queryOptions = null;
+            stat.xpathQuery = null;
             if (result == null) {
                 result = stat;
             } else {
@@ -1172,6 +1175,7 @@
         result.queryOptions = queryOptions;
         result.setExplain(statement.explain);
         result.setMeasure(statement.measure);
+        result.xpathQuery = xpathQuery;
         return result;
     }
 
Index: oak-core/src/test/resources/org/apache/jackrabbit/oak/query/xpath.txt
===================================================================
--- oak-core/src/test/resources/org/apache/jackrabbit/oak/query/xpath.txt	(revision 1817341)
+++ oak-core/src/test/resources/org/apache/jackrabbit/oak/query/xpath.txt	(working copy)
@@ -26,6 +26,54 @@
 
 # OAK-6792
 
+xpath2sql /jcr:root/content[@a=1 or @b=2] order by @foo
+select [jcr:path], [jcr:score], *
+  from [nt:base] as a
+  where issamenode(a, &apos;/content&apos;)
+  and [a] = 1
+  union select [jcr:path], [jcr:score], *
+  from [nt:base] as a
+  where issamenode(a, &apos;/content&apos;)
+  and [b] = 2
+  order by [foo]
+  /* xpath ... */
+
+xpath2sql /jcr:root/(content | dam)[@a=1 or @b=2] order by @foo
+select [jcr:path], [jcr:score], *
+  from [nt:base] as a
+  where issamenode(a, &apos;/content&apos;)
+  and [a] = 1
+  union select [jcr:path], [jcr:score], *
+  from [nt:base] as a
+  where issamenode(a, &apos;/content&apos;)
+  and [b] = 2
+  union select [jcr:path], [jcr:score], *
+  from [nt:base] as a
+  where issamenode(a, &apos;/dam&apos;)
+  and [a] = 1
+  union select [jcr:path], [jcr:score], *
+  from [nt:base] as a
+  where issamenode(a, &apos;/dam&apos;)
+  and [b] = 2
+  order by [foo]
+  /* xpath ... */
+
+xpath2sql //(element(*, type1) | element(*, type2))[@a=&apos;b&apos; or @c=&apos;d&apos;] order by @foo
+select [jcr:path], [jcr:score], *
+  from [type1] as a
+  where [a] = &apos;b&apos;
+  union select [jcr:path], [jcr:score], *
+  from [type1] as a
+  where [c] = &apos;d&apos;
+  union select [jcr:path], [jcr:score], *
+  from [type2] as a
+  where [a] = &apos;b&apos;
+  union select [jcr:path], [jcr:score], *
+  from [type2] as a
+  where [c] = &apos;d&apos;
+  order by [foo]
+  /* xpath ... */
+
 xpath2sql /jcr:root//*/(rep:facet(jcr:data/jcr:createdBy))
 select [jcr:path], [jcr:score], [rep:facet(jcr:data/jcr:createdBy)]
   from [nt:base] as a
@@ -45,12 +93,18 @@
 explain select [jcr:path], [jcr:score], *
   from [acme:Asset] as a
   where isdescendantnode(a, &apos;/content/activities&apos;)
+  union select [jcr:path], [jcr:score], *
+  from [acme:Asset] as a
+  where isdescendantnode(a, &apos;/content/people&apos;)
   /* xpath ... */
- 
+
 xpath2sql explain measure /jcr:root/content/(activities|people)//element(*, acme:Asset)
 explain measure select [jcr:path], [jcr:score], *
   from [acme:Asset] as a
   where isdescendantnode(a, &apos;/content/activities&apos;)
+  union select [jcr:path], [jcr:score], *
+  from [acme:Asset] as a
+  where isdescendantnode(a, &apos;/content/people&apos;)
   /* xpath ... */
 
 # OAK-937
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16327004" author="catholicon" created="Tue, 16 Jan 2018 10:58:54 +0000"  >&lt;p&gt;Oops... sorry, I think I assigned the issue to myself by mistake. Passing the baton back to Thomas.&lt;/p&gt;</comment>
                            <comment id="16327016" author="catholicon" created="Tue, 16 Jan 2018 11:09:07 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thomasm&quot; class=&quot;user-hover&quot; rel=&quot;thomasm&quot;&gt;thomasm&lt;/a&gt;,&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;+            union.orderList = orderList;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I was also thinking the same but got confused about &quot;is it ok to assume that we would never support individual statements in a UNION to have their own ORDER BY&quot;. Btw, I don&apos;t mean that we should not fix it this way - but I would probably want to add some way to indicate that we need to update propogation of orderlist if we ever support different order list for sub-statements (btw, since this code path only gets hit during optimize - so, this whole concern could very well be a figment of my imagination).&lt;/p&gt;</comment>
                            <comment id="16327091" author="tmueller" created="Tue, 16 Jan 2018 13:03:11 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=catholicon&quot; class=&quot;user-hover&quot; rel=&quot;catholicon&quot;&gt;catholicon&lt;/a&gt; I don&apos;t see a case where order for sub-statements (sub-queries of a union) should be different than the order of the union. In theory it&apos;s possible to have different orders, but I don&apos;t think we have that case now: assuming the user wants to order by x, y, and x needs to be in (1, 2), then we could rewrite as follows:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;(select * from ... where x = 1 order by y)
union all
(select * from ... where x = 2 order by y)
order by x, y
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16327903" author="catholicon" created="Tue, 16 Jan 2018 22:24:14 +0000"  >&lt;p&gt;well, I don&apos;t think that rewriting by enumerating different values of a column is practical - but, I agree, let&apos;s not ponder on that case for now.&lt;/p&gt;</comment>
                            <comment id="16328726" author="tmueller" created="Wed, 17 Jan 2018 13:03:10 +0000"  >&lt;p&gt;&lt;a href=&quot;http://svn.apache.org/r1821358&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1821358&lt;/a&gt; (trunk)&lt;/p&gt;</comment>
                            <comment id="16330494" author="tmueller" created="Thu, 18 Jan 2018 13:14:38 +0000"  >&lt;p&gt;&lt;a href=&quot;http://svn.apache.org/r1821488&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1821488&lt;/a&gt; (1.8 branch)&lt;/p&gt;</comment>
                            <comment id="16330526" author="tmueller" created="Thu, 18 Jan 2018 13:44:00 +0000"  >&lt;p&gt;&lt;a href=&quot;http://svn.apache.org/r1821493&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1821493&lt;/a&gt; (1.6 branch)&lt;/p&gt;</comment>
                            <comment id="16340863" author="edivad" created="Fri, 26 Jan 2018 10:15:31 +0000"  >&lt;p&gt;Bulk close 1.8.1&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 42 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3opgn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>