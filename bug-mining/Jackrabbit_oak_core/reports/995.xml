<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:45:29 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-2039] SegmentNodeStore might not create a checkpoint</title>
                <link>https://issues.apache.org/jira/browse/OAK-2039</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;As per &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=edivad&quot; class=&quot;user-hover&quot; rel=&quot;edivad&quot;&gt;edivad&lt;/a&gt; in the &lt;tt&gt;SegmentNodeStore.checkpoint(long)&lt;/tt&gt; the invocation might return a checkpoint even though it has not been created&lt;/p&gt;

&lt;p&gt;Starting from &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;AsyncIndexUpdate.java#235&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-comment&quot;&gt;// there are some recent changes, so let&apos;s create a &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; checkpoint
&lt;/span&gt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; afterCheckpoint = store.checkpoint(lifetime);
NodeState after = store.retrieve(afterCheckpoint);
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (after == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
    log.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;Unable to retrieve newly created checkpoint {},&quot;&lt;/span&gt;
            + &lt;span class=&quot;code-quote&quot;&gt;&quot; skipping the {} index update&quot;&lt;/span&gt;, afterCheckpoint, name);
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
}

&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; checkpointToRelease = afterCheckpoint;
&lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
    updateIndex(before, beforeCheckpoint, after, afterCheckpoint);

    &lt;span class=&quot;code-comment&quot;&gt;// the update succeeded, i.e. it no longer fails&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;and then&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;SegmentNodeStore.java#205&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; checkpoint(&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; lifetime) {
    checkArgument(lifetime &amp;gt; 0);
    &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; name = UUID.randomUUID().toString();
    &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; now = &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.currentTimeMillis();

    &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; 5 times
&lt;/span&gt;    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; 5; i++) {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (commitSemaphore.tryAcquire()) { 
            &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                refreshHead();

                SegmentNodeState state = head.get();
                SegmentNodeBuilder builder = state.builder();

                NodeBuilder checkpoints = builder.child(&lt;span class=&quot;code-quote&quot;&gt;&quot;checkpoints&quot;&lt;/span&gt;);
                &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; n : checkpoints.getChildNodeNames()) {
                    NodeBuilder cp = checkpoints.getChildNode(n);
                    PropertyState ts = cp.getProperty(&lt;span class=&quot;code-quote&quot;&gt;&quot;timestamp&quot;&lt;/span&gt;);
                    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (ts == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
                            || ts.getType() != Type.LONG
                            || now &amp;gt; ts.getValue(Type.LONG)) {
                        cp.remove();
                    }
                }

                NodeBuilder cp = checkpoints.child(name);
                cp.setProperty(&lt;span class=&quot;code-quote&quot;&gt;&quot;timestamp&quot;&lt;/span&gt;,  now + lifetime);
                cp.setChildNode(ROOT, state.getChildNode(ROOT));

                SegmentNodeState newState = builder.getNodeState();
                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (store.setHead(state, newState)) {
                    refreshHead();
                    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; name;
                }

            } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
                commitSemaphore.release();
            }
        }
    }

    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; name;
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;we can see that it always return a checkpoint name even if it fails to create it (as by &lt;tt&gt;@Nonnull&lt;/tt&gt; contract I would say). But if it fails to acquire lock for 5 times (no sleep in the meanwhile?) it does it silently and thus return a checkpoint which is not valid.&lt;/p&gt;

&lt;p&gt;This might cause indexing to not work properly as it relies on the fact that it can access previous version of content through the returned checkpoint&lt;/p&gt;</description>
                <environment></environment>
        <key id="12734699">OAK-2039</key>
            <summary>SegmentNodeStore might not create a checkpoint</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="stillalex">Alex Deparvu</assignee>
                                    <reporter username="chetanm">Chetan Mehrotra</reporter>
                        <labels>
                    </labels>
                <created>Mon, 18 Aug 2014 06:27:58 +0000</created>
                <updated>Wed, 1 Oct 2014 13:06:04 +0000</updated>
                            <resolved>Fri, 22 Aug 2014 14:34:10 +0000</resolved>
                                                    <fixVersion>1.0.5</fixVersion>
                    <fixVersion>1.1.0</fixVersion>
                                    <component>segmentmk</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="14100346" author="chetanm" created="Mon, 18 Aug 2014 06:30:51 +0000"  >&lt;p&gt;Attaching a &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12662436/12662436_OAK-2039-alex.patch&quot; title=&quot;OAK-2039-alex.patch attached to OAK-2039&quot;&gt;patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=alexparvulescu&quot; class=&quot;user-hover&quot; rel=&quot;alexparvulescu&quot;&gt;alexparvulescu&lt;/a&gt; which adds debug/warn logging when such an issue occurs&lt;/p&gt;</comment>
                            <comment id="14106887" author="alex.parvulescu" created="Fri, 22 Aug 2014 14:22:08 +0000"  >&lt;p&gt;This started from the warnings issues by the async indexer. Just to clarify, there is no data loss, the async indexer will pick up all the changes on the next run cycle (5 seconds currently).&lt;br/&gt;
I&apos;ve now added some warning logs to the SegmentNodeStore to try to figure out if this is simply a system-load problem (current design is: it will try 5 times to grab the commit lock, then give up) or something more profound.&lt;/p&gt;</comment>
                            <comment id="14106900" author="alex.parvulescu" created="Fri, 22 Aug 2014 14:34:10 +0000"  >&lt;p&gt;rev 1619815, merged to 1.0 with rev 1619819&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12662436" name="OAK-2039-alex.patch" size="1760" author="chetanm" created="Mon, 18 Aug 2014 06:30:51 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>412639</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 13 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1yzif:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>412625</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>