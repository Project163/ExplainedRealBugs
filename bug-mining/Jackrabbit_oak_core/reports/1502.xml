<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:50:52 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-4494] Stale documents after revision GC in cluster</title>
                <link>https://issues.apache.org/jira/browse/OAK-4494</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;Implement additional tests for revision GC in a cluster.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12981835">OAK-4494</key>
            <summary>Stale documents after revision GC in cluster</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="reschke">Julian Reschke</assignee>
                                    <reporter username="mreutegg">Marcel Reutegger</reporter>
                        <labels>
                    </labels>
                <created>Wed, 22 Jun 2016 09:58:42 +0000</created>
                <updated>Mon, 11 Jul 2016 12:42:41 +0000</updated>
                            <resolved>Tue, 28 Jun 2016 15:54:33 +0000</resolved>
                                                    <fixVersion>1.0.32</fixVersion>
                    <fixVersion>1.2.17</fixVersion>
                    <fixVersion>1.4.5</fixVersion>
                    <fixVersion>1.5.5</fixVersion>
                    <fixVersion>1.6.0</fixVersion>
                                    <component>core</component>
                    <component>documentmk</component>
                    <component>mongomk</component>
                    <component>rdbmk</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15344071" author="mreutegg" created="Wed, 22 Jun 2016 10:11:42 +0000"  >&lt;p&gt;Added ResurrectNodeAfterRevisionGCTest to trunk (currently ignored): &lt;a href=&quot;http://svn.apache.org/r1749645&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1749645&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15346006" author="mreutegg" created="Thu, 23 Jun 2016 07:55:19 +0000"  >&lt;p&gt;Changed issue type. It turns out this is a problem for both DocumentStore backends.&lt;/p&gt;</comment>
                            <comment id="15346201" author="mreutegg" created="Thu, 23 Jun 2016 09:59:31 +0000"  >&lt;p&gt;Proposed changes for MongoDocumentStore.&lt;/p&gt;

&lt;p&gt;The patch introduces a ModificationStamp, which is a simple struct that consists of the modCount and the modified timestamp with 5 seconds resolution. It replaces the modCount parameter when the cache is invalidated.&lt;/p&gt;

&lt;p&gt;An alternative approach was discussed offline as well. The modCount could be initialized with a value that e.g. equals the current time millis. With MongoDB this is not easily possible and would require additional calls when MongoDocumentStore attempts to create documents. Initializing the modCount with a timestamp also has the downside of loosing information how many times the document was modified since it was created.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=reschke&quot; class=&quot;user-hover&quot; rel=&quot;reschke&quot;&gt;reschke&lt;/a&gt; &amp;amp; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=catholicon&quot; class=&quot;user-hover&quot; rel=&quot;catholicon&quot;&gt;catholicon&lt;/a&gt;, WDYT?&lt;/p&gt;</comment>
                            <comment id="15346213" author="reschke" created="Thu, 23 Jun 2016 10:10:16 +0000"  >&lt;p&gt;Sounds like a good plan; I&apos;ll see whether I can get that to work in RDBDocumentStore as well.&lt;/p&gt;</comment>
                            <comment id="15346228" author="catholicon" created="Thu, 23 Jun 2016 10:22:33 +0000"  >&lt;p&gt;Yup, sounds fine.&lt;/p&gt;

&lt;p&gt;btw, &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;             &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt; modCount = Utils.asLong((&lt;span class=&quot;code-object&quot;&gt;Number&lt;/span&gt;) obj.get(Document.MOD_COUNT));
-            modCounts.put(id, modCount);
+            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (modCount == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
+                modCount = -1L;
+            }
+            &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt; modified = Utils.asLong((&lt;span class=&quot;code-object&quot;&gt;Number&lt;/span&gt;) obj.get(Document.MOD_COUNT));
+            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (modified == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
+                modified = -1L;
+            }
+            modCounts.put(id, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ModificationStamp(modCount, modified));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I think the second obj.get was supposed to be done on MODIFIED_IN_SECS.&lt;/p&gt;

&lt;p&gt;I think the tests pass because duplicated modCount was different than cached modified value (which, imo, is a good sign... as it marks that we just need some marker which could differentiate)... but, should we worry that the tests didn&apos;t catch it?&lt;/p&gt;</comment>
                            <comment id="15346239" author="mreutegg" created="Thu, 23 Jun 2016 10:34:58 +0000"  >&lt;p&gt;Oops, good catch.&lt;/p&gt;

&lt;p&gt;When I change it to MODIFIED_IN_SECS the test fails because the modified timestamp does not change in the test. There is a virtual clock, but it is not used by the Revision in the test.&lt;/p&gt;

&lt;p&gt;I think it would be good to also ensure the revision GC runs with a maxRevisionAge that does not result in resurrected documents with the same modified timestamp. I&apos;ll open a separate issue about that.&lt;/p&gt;</comment>
                            <comment id="15346241" author="mreutegg" created="Thu, 23 Jun 2016 10:37:08 +0000"  >&lt;p&gt;Updated patch based on &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=catholicon&quot; class=&quot;user-hover&quot; rel=&quot;catholicon&quot;&gt;catholicon&lt;/a&gt; feedback. Thanks again!&lt;/p&gt;</comment>
                            <comment id="15346376" author="mreutegg" created="Thu, 23 Jun 2016 12:54:36 +0000"  >&lt;p&gt;Applied the patch to trunk: &lt;a href=&quot;http://svn.apache.org/r1749875&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1749875&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15346402" author="mreutegg" created="Thu, 23 Jun 2016 13:10:34 +0000"  >&lt;p&gt;Merged ignored test to branches:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;1.4: &lt;a href=&quot;http://svn.apache.org/r1749879&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1749879&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;1.2: &lt;a href=&quot;http://svn.apache.org/r1749880&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1749880&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;1.0: &lt;a href=&quot;http://svn.apache.org/r1749881&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1749881&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15346534" author="mreutegg" created="Thu, 23 Jun 2016 14:42:22 +0000"  >&lt;p&gt;Merged MongoDocumentStore fix to branches:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;1.4: &lt;a href=&quot;http://svn.apache.org/r1749890&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1749890&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;1.2: &lt;a href=&quot;http://svn.apache.org/r1749893&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1749893&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;1.0: &lt;a href=&quot;http://svn.apache.org/r1749905&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1749905&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15346538" author="mreutegg" created="Thu, 23 Jun 2016 14:43:35 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=reschke&quot; class=&quot;user-hover&quot; rel=&quot;reschke&quot;&gt;reschke&lt;/a&gt;, assigning to you for the RDBDocumentStore part.&lt;/p&gt;</comment>
                            <comment id="15346588" author="reschke" created="Thu, 23 Jun 2016 15:15:34 +0000"  >&lt;p&gt;yup, looking at it right now...&lt;/p&gt;</comment>
                            <comment id="15348341" author="reschke" created="Fri, 24 Jun 2016 14:24:48 +0000"  >&lt;p&gt;I&apos;m trying to match &lt;tt&gt;_MODIFIED&lt;/tt&gt; as well, but the code in &lt;tt&gt;resurrectInvalidate&lt;/tt&gt; doesn&apos;t even set it, so &lt;tt&gt;RDBDocumentStore&lt;/tt&gt; sees two entries with value 0. Why does this work for &lt;tt&gt;MongoDocumentStore&lt;/tt&gt;?&lt;/p&gt;

&lt;p&gt;EDIT: it&apos;s because &lt;tt&gt;stamp.modified&lt;/tt&gt; is a &lt;tt&gt;long&lt;/tt&gt; that gets set to -1 if &lt;tt&gt;_modified&lt;/tt&gt; is not set. Thus &lt;tt&gt;Objects.equal()&lt;/tt&gt; will return &lt;tt&gt;false&lt;/tt&gt; when comparing to the &lt;tt&gt;null&lt;/tt&gt; returned by the &lt;tt&gt;NodeDocument&lt;/tt&gt;. I can match that behavior in &lt;tt&gt;RDBDocumentStore&lt;/tt&gt;, but this looks a bit as if this wasn&apos;t really intentional. Furthermore, the test doesn&apos;t really test what it should test, right?&lt;/p&gt;</comment>
                            <comment id="15350507" author="mreutegg" created="Mon, 27 Jun 2016 07:20:28 +0000"  >&lt;p&gt;The tests are intentional, because they check if invalidation works even in the most basic case when no _modified is present. But you are right, it would be better to have additional tests that do the same with a _modified value set. I&apos;ll take care of that.&lt;/p&gt;</comment>
                            <comment id="15350542" author="mreutegg" created="Mon, 27 Jun 2016 07:54:09 +0000"  >&lt;p&gt;Added more tests with documents that have a _modified value set.&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;trunk: &lt;a href=&quot;http://svn.apache.org/r1750287&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1750287&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;1.4: &lt;a href=&quot;http://svn.apache.org/r1750292&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1750292&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;1.2: &lt;a href=&quot;http://svn.apache.org/r1750293&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1750293&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;1.0: &lt;a href=&quot;http://svn.apache.org/r1750294&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1750294&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15352703" author="reschke" created="Tue, 28 Jun 2016 09:55:03 +0000"  >&lt;p&gt;Proposed patch for RDB - this adds additional checks for a matching lastmodified value (this is sufficient to make the new test pass, but we probably need to review the code for other places where we rely solely on MODCOUNT).&lt;/p&gt;</comment>
                            <comment id="15352916" author="reschke" created="Tue, 28 Jun 2016 12:34:23 +0000"  >&lt;p&gt;Aggregated changes:&lt;/p&gt;

&lt;p&gt;trunk: &lt;a href=&quot;http://svn.apache.org/r1750495&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1750495&lt;/a&gt; &lt;a href=&quot;http://svn.apache.org/r1750287&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1750287&lt;/a&gt; &lt;a href=&quot;http://svn.apache.org/r1749875&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1749875&lt;/a&gt; &lt;a href=&quot;http://svn.apache.org/r1749645&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1749645&lt;/a&gt;&lt;br/&gt;
1.4: &lt;a href=&quot;http://svn.apache.org/r1750512&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1750512&lt;/a&gt; &lt;a href=&quot;http://svn.apache.org/r1750292&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1750292&lt;/a&gt; &lt;a href=&quot;http://svn.apache.org/r1749890&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1749890&lt;/a&gt; &lt;a href=&quot;http://svn.apache.org/r1749879&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1749879&lt;/a&gt;&lt;br/&gt;
1.2: &lt;a href=&quot;http://svn.apache.org/r1750537&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1750537&lt;/a&gt; &lt;a href=&quot;http://svn.apache.org/r1750293&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1750293&lt;/a&gt; &lt;a href=&quot;http://svn.apache.org/r1749893&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1749893&lt;/a&gt; &lt;a href=&quot;http://svn.apache.org/r1749880&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1749880&lt;/a&gt;&lt;br/&gt;
1.0: &lt;a href=&quot;http://svn.apache.org/r1750542&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1750542&lt;/a&gt; &lt;a href=&quot;http://svn.apache.org/r1750294&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1750294&lt;/a&gt; &lt;a href=&quot;http://svn.apache.org/r1749905&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1749905&lt;/a&gt; &lt;a href=&quot;http://svn.apache.org/r1749881&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1749881&lt;/a&gt;&lt;/p&gt;
</comment>
                            <comment id="15352936" author="reschke" created="Tue, 28 Jun 2016 12:52:20 +0000"  >&lt;p&gt;proposed RDB patch for 1.4&lt;/p&gt;</comment>
                            <comment id="15370677" author="dominique.jaeggi" created="Mon, 11 Jul 2016 12:42:41 +0000"  >&lt;p&gt;bulk close after 1.5.5 release&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                                                <inwardlinks description="is blocked by">
                                        <issuelink>
            <issuekey id="12983754">OAK-4514</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12982288">OAK-4498</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12982717">OAK-4509</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12814110" name="OAK-4494-RDB-1.4.diff" size="5749" author="reschke" created="Tue, 28 Jun 2016 12:52:20 +0000"/>
                            <attachment id="12814081" name="OAK-4494-RDB.diff" size="5644" author="reschke" created="Tue, 28 Jun 2016 09:55:03 +0000"/>
                            <attachment id="12812791" name="OAK-4494.patch" size="10672" author="mreutegg" created="Thu, 23 Jun 2016 10:37:08 +0000"/>
                            <attachment id="12812777" name="OAK-4494.patch" size="10156" author="mreutegg" created="Thu, 23 Jun 2016 09:59:31 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 18 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2zw87:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>