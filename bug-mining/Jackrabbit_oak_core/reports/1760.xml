<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:53:32 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-5173] Path in uniqueness constraint violation exception is always the root</title>
                <link>https://issues.apache.org/jira/browse/OAK-5173</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-1997&quot; title=&quot;Improve the message in UniquenessConstraintViolation exception to provide more details&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-1997&quot;&gt;&lt;del&gt;OAK-1997&lt;/del&gt;&lt;/a&gt; added a (single) path to the uniqueness constraint exception message in the PropertyIndexEditor to point out where the duplicate came from, but it is always the root:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;OakConstraint0030: Uniqueness constraint violated at path [/] for one of the property in [rep:externalId] having value xyz1234
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;That is because it &lt;a href=&quot;https://github.com/apache/jackrabbit-oak/blob/3a88b23d51beae4798e9b29c4deaba81c81fb427/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/index/property/PropertyIndexEditor.java#L315-L318&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;uses getPath()&lt;/a&gt; of the index editor itself and the uniqueness check always &lt;a href=&quot;https://github.com/apache/jackrabbit-oak/blob/3a88b23d51beae4798e9b29c4deaba81c81fb427/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/index/property/PropertyIndexEditor.java#L303&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;happens at the root level&lt;/a&gt; at the end.&lt;/p&gt;

&lt;p&gt;It probably has to read from the index to find out the 2 or more paths with the same property value (just printing one path is not enough information for duplicates).&lt;/p&gt;</description>
                <environment></environment>
        <key id="13023901">OAK-5173</key>
            <summary>Path in uniqueness constraint violation exception is always the root</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="thomasm">Thomas Mueller</assignee>
                                    <reporter username="alexander.klimetschek">Alexander Klimetschek</reporter>
                        <labels>
                    </labels>
                <created>Mon, 28 Nov 2016 23:07:33 +0000</created>
                <updated>Tue, 8 Oct 2019 15:21:42 +0000</updated>
                            <resolved>Fri, 1 Dec 2017 07:57:23 +0000</resolved>
                                    <version>1.4.10</version>
                    <version>1.5.14</version>
                                    <fixVersion>1.7.12</fixVersion>
                    <fixVersion>1.8.0</fixVersion>
                                    <component>core</component>
                    <component>property-index</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15703589" author="alexander.klimetschek" created="Mon, 28 Nov 2016 23:45:15 +0000"  >&lt;p&gt;Also, in case there are multiple keys each with duplicates, only the first one gets reported.&lt;/p&gt;

&lt;p&gt;I think something along those lines could be done (and replacing the &lt;tt&gt;getFirstDuplicate()&lt;/tt&gt; method). Beware, untested. Open points marked with ???.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void checkUniquenessConstraints() {
    &lt;span class=&quot;code-comment&quot;&gt;//...
&lt;/span&gt;    StringBuilder failedMsg = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; StringBuilder();
    NodeState indexMeta = definition.getNodeState();
    &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; indexName = definition.getName(); &lt;span class=&quot;code-comment&quot;&gt;// ???
&lt;/span&gt;    &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; firstKey = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; key : keysToCheckForUniqueness) {
        &lt;span class=&quot;code-comment&quot;&gt;// quick uniqueness check
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (isNotUnique(key, indexMeta)) {
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (firstKey) {
                firstKey = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
            } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
                failedMsg.add(&lt;span class=&quot;code-quote&quot;&gt;&quot;; &quot;&lt;/span&gt;);
            }
            failedMsg.add(&lt;span class=&quot;code-quote&quot;&gt;&quot;value &lt;span class=&quot;code-quote&quot;&gt;&apos;&quot;&lt;/span&gt;).add(key).add(&lt;span class=&quot;code-quote&quot;&gt;&quot;&apos;&lt;/span&gt; present at [&quot;&lt;/span&gt;);
            &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; firstPath = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
            &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; failed, retrieve all values and add to message
&lt;/span&gt;            &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (IndexStoreStrategy s : getStrategies(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)) {
                &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; path : s.query(&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &lt;span class=&quot;code-comment&quot;&gt;/* ??? */&lt;/span&gt;, indexName, indexMeta, singleton(key))) {
                    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (firstPath) {
                        firstPath = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
                    } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
                        failedMsg.add(&lt;span class=&quot;code-quote&quot;&gt;&quot;, &quot;&lt;/span&gt;);
                    }
                    failedMsg.add(path);
                }
            }
            failedMsg.add(&lt;span class=&quot;code-quote&quot;&gt;&quot;]&quot;&lt;/span&gt;);
        }
    }
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (failedMsg.length() &amp;gt; 0) {
        &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; msg = &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.format(
                &lt;span class=&quot;code-quote&quot;&gt;&quot;Uniqueness constraint violated &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; index %s of properties %s: %s&quot;&lt;/span&gt;,
                indexName, propertyNames, failedMsg);
        &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CommitFailedException(CONSTRAINT, 30, msg);        
    }
}

&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isNotUnique(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; key, NodeState indexMeta) {
    &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; count = 0;
    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (IndexStoreStrategy s : getStrategies(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)) {
        count += s.count(root, indexMeta, singleton(key), 2);
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (count &amp;gt; 1) {
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
        }
    }
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This should give something like this:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Uniqueness constraint violated for index MyIndex of properties [foobar]: value &apos;xyz&apos; present at [/path/one, /path/two]; value &apos;123&apos; present at [/content/alpha, /content/beta, /content/gamma]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16101235" author="chetanm" created="Wed, 26 Jul 2017 06:45:57 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thomasm&quot; class=&quot;user-hover&quot; rel=&quot;thomasm&quot;&gt;thomasm&lt;/a&gt; This error message has confused people few times. Can you have a look at proposed approach by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=alexander.klimetschek&quot; class=&quot;user-hover&quot; rel=&quot;alexander.klimetschek&quot;&gt;alexander.klimetschek&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16101250" author="tmueller" created="Wed, 26 Jul 2017 07:00:59 +0000"  >&lt;p&gt;Yes, I will try to fix this (and if the fix is easy, maybe backport it). But I can&apos;t say whether this will go in 1.7.5 yet.&lt;/p&gt;</comment>
                            <comment id="16153554" author="rombert" created="Tue, 5 Sep 2017 12:21:28 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-6578&quot; title=&quot;Enhance the UniqueEntryStoreStrategy to return list of matching values and paths&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-6578&quot;&gt;&lt;del&gt;OAK-6578&lt;/del&gt;&lt;/a&gt; might make this easier, as pointed out by Chetan on that issue.&lt;/p&gt;</comment>
                            <comment id="16274080" author="tmueller" created="Fri, 1 Dec 2017 07:57:23 +0000"  >&lt;p&gt;&lt;a href=&quot;http://svn.apache.org/r1816801&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1816801&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16283631" author="edivad" created="Fri, 8 Dec 2017 14:24:02 +0000"  >&lt;p&gt;Bulk close 1.7.12&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311120" key="com.pyxis.greenhopper.jira:gh-epic-link">
                        <customfieldname>Epic Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>OAK-5544</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 49 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1zjmp:r</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310921" key="com.pyxis.greenhopper.jira:gh-sprint">
                        <customfieldname>Sprint</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="312">L15</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>