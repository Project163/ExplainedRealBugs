<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:53:44 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-7686] Partial migration doesn&apos;t update Lucene indexing data</title>
                <link>https://issues.apache.org/jira/browse/OAK-7686</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;It seems that the LuceneIndexProvider is missing in the RepositorySidegrade index provider list. As a result, for the partial migration, the lucene indexing data is not updated for the copied content:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;25.07.2018 00:19:47.008 [main] *WARN*  org.apache.jackrabbit.oak.plugins.index.IndexUpdate - Missing index provider of type [lucene], requesting reindex on [/oak:index/slingeventJob]
25.07.2018 00:19:47.580 [main] *WARN*  org.apache.jackrabbit.oak.plugins.index.IndexUpdate - Missing index provider of type [lucene], requesting reindex on [/oak:index/ntBaseLucene]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13177323">OAK-7686</key>
            <summary>Partial migration doesn&apos;t update Lucene indexing data</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="catholicon">Vikas Saurabh</assignee>
                                    <reporter username="tomek.rekawek">Tomek R&#281;kawek</reporter>
                        <labels>
                    </labels>
                <created>Tue, 7 Aug 2018 08:26:51 +0000</created>
                <updated>Tue, 8 Oct 2019 15:22:14 +0000</updated>
                            <resolved>Wed, 8 Aug 2018 22:18:00 +0000</resolved>
                                                    <fixVersion>1.10.0</fixVersion>
                    <fixVersion>1.9.7</fixVersion>
                    <fixVersion>1.6.14</fixVersion>
                    <fixVersion>1.8.7</fixVersion>
                                    <component>upgrade</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16571419" author="tmueller" created="Tue, 7 Aug 2018 10:23:20 +0000"  >&lt;p&gt;To me it soundsl ike the subject is incorrect, you wrote &quot;Partial migration doesn&apos;t update Lucene indexing data&quot;. But the log message says &quot;requesting reindex on&quot;, which is a lot worse than just not updating the index... Or maybe the log message is incorrect?&lt;/p&gt;</comment>
                            <comment id="16571690" author="catholicon" created="Tue, 7 Aug 2018 13:57:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thomasm&quot; class=&quot;user-hover&quot; rel=&quot;thomasm&quot;&gt;thomasm&lt;/a&gt;, I think both title and log message are correct in their own contexts. I haven&apos;t checked in code, but as &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tomek.rekawek&quot; class=&quot;user-hover&quot; rel=&quot;tomek.rekawek&quot;&gt;tomek.rekawek&lt;/a&gt; mentioned that partial migration of content doesn&apos;t seem to be registering &lt;tt&gt;LuceneIndexProvider&lt;/tt&gt; and hence the system doesn&apos;t know what to do with content getting ingested while there&apos;s no one which can update index data for &lt;tt&gt;type=&quot;lucene&quot;&lt;/tt&gt; indexes... thus resulting in setting &lt;tt&gt;reindex=true&lt;/tt&gt; for those indexes (as there&apos;s no other way to index data which got ingested while LIP was missing.&lt;/p&gt;

&lt;p&gt;That said, I think there&apos;s probably a bit more to the issue that it seems on the surface. &quot;lucene&quot; indexes are &quot;async&quot;, so, they get called to be updated only due to &lt;tt&gt;AsyncIndexUpdate&lt;/tt&gt; - which doesn&apos;t seem to be the case from logs in description (thread name is &lt;tt&gt;main&lt;/tt&gt; ). The only other thing is that maybe, &lt;tt&gt;IndexUpdate&lt;/tt&gt; is calling into these indexes for &quot;nrt&quot; and &quot;sync&quot; updates and since LIP is missing, it is getting confused that it should set &quot;reindex=true&quot;.&lt;/p&gt;

&lt;p&gt;While, all that is hypothesis, I think it&apos;s quite reasonable. If that really turns out to be the case, I think the fix for the issue should be to remove &lt;tt&gt;IndexUpdate&lt;/tt&gt; confusion over &lt;tt&gt;async=&quot;sync,async&quot;&lt;/tt&gt; or &lt;tt&gt;async=&quot;nrt,async&quot;&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;We can probably &quot;want&quot; that maybe we can configure LIP and schedule AsyncIndexUpdate runs - but imo that&apos;s solving a separate concern (update async indexes during side-grade).&lt;/p&gt;</comment>
                            <comment id="16571840" author="tomek.rekawek" created="Tue, 7 Aug 2018 15:29:17 +0000"  >&lt;p&gt;OK, let me elaborate a bit. The partial migration (eg. the one copying only /content/mysite/xyz from repo A to repo B) performed with oak-upgrade ends with a repoB.merge() invocation. The commit hooks passed to this invocation includes &lt;tt&gt;CompositeIndexEditorProvider&lt;/tt&gt; that consists of two IndexEditorProviders:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;ReferenceEditorProvider&lt;/li&gt;
	&lt;li&gt;PropertyIndexEditorProvider&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;See the following methods for more details:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/jackrabbit-oak/blob/9db5053c83cb4cbe3ab5516c87364e057ec3c8ef/oak-upgrade/src/main/java/org/apache/jackrabbit/oak/upgrade/RepositorySidegrade.java#L434-L438&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;RepositorySidegrade#migrateWithoutCheckpoints&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/jackrabbit-oak/blob/9db5053c83cb4cbe3ab5516c87364e057ec3c8ef/oak-upgrade/src/main/java/org/apache/jackrabbit/oak/upgrade/RepositoryUpgrade.java#L615-L643&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;RepositoryUpgrade#createIndexEditorProvider&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Because there&apos;s no LuceneIndexEditorProvider included there, some index definitions can&apos;t be processed, producing an log message &lt;tt&gt;Missing index provider of type &lt;span class=&quot;error&quot;&gt;&amp;#91;lucene&amp;#93;&lt;/span&gt;&lt;/tt&gt;. This log message is displayed during the migration. Apparently, the fallback for such case is requesting a full reindexing on given index, which is something we&apos;d like to avoid.&lt;/p&gt;

&lt;p&gt;I think that including the LuceneIndexEditorProvider would be enough to fix this. WDYT?&lt;/p&gt;</comment>
                            <comment id="16572179" author="catholicon" created="Tue, 7 Aug 2018 19:09:20 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tomek.rekawek&quot; class=&quot;user-hover&quot; rel=&quot;tomek.rekawek&quot;&gt;tomek.rekawek&lt;/a&gt;&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Because there&apos;s no LuceneIndexEditorProvider included there, some index definitions can&apos;t be processed, producing an log message Missing index provider of type &lt;span class=&quot;error&quot;&gt;&amp;#91;lucene&amp;#93;&lt;/span&gt;.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Since &quot;lucene&quot; indexes have &lt;tt&gt;async=XYZ&lt;/tt&gt;, I think &lt;tt&gt;IndexUpdate&lt;/tt&gt; [0] instantiated with async=null would care about them. The only reason I could think of &lt;tt&gt;IndexUpdate&lt;/tt&gt; caring about lucene indexes is if they have &quot;sync&quot; or &quot;nrt&quot; configured in &quot;async&quot; property.&lt;/p&gt;

&lt;p&gt;A simple test for this is that the indexes that log the warning in description won&apos;t have any index with simple &lt;tt&gt;async=&lt;span class=&quot;error&quot;&gt;&amp;#91;&amp;quot;async&amp;quot;&amp;#93;&lt;/span&gt;&lt;/tt&gt; (e.g. most likely /oak:index/lucene). (&lt;b&gt;EDIT&lt;/b&gt;: sample log from a partial sidegrade on an AEM repository [1] which doesn&apos;t set reindex on /oak:index/lucene)&lt;/p&gt;

&lt;p&gt;If that &quot;guess&quot; turns out to be true, the I think the right solution would be that &lt;tt&gt;IndexUpdate&lt;/tt&gt; shouldn&apos;t try to set &quot;reindex=true&quot; for updates it&apos;s trying for &quot;nrt&quot;/&quot;sync&quot;.&lt;/p&gt;

&lt;p&gt;About up/sidegrade indeed updating lucene indexes should be a separate issue imo.&lt;/p&gt;

&lt;p&gt;[0]: &lt;a href=&quot;https://github.com/apache/jackrabbit-oak/blob/9db5053c83cb4cbe3ab5516c87364e057ec3c8ef/oak-upgrade/src/main/java/org/apache/jackrabbit/oak/upgrade/RepositoryUpgrade.java#L624&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/jackrabbit-oak/blob/9db5053c83cb4cbe3ab5516c87364e057ec3c8ef/oak-upgrade/src/main/java/org/apache/jackrabbit/oak/upgrade/RepositoryUpgrade.java#L624&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;[1]:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;....
....
22.07.2018 19:30:41.093 [main] *INFO*  org.apache.jackrabbit.oak.upgrade.RepositoryUpgrade - Processing commit via EditorHook : (CompositeEditorProvider : ([TypeEditorProvider, IndexEditorProvider]))
22.07.2018 19:30:41.105 [main] *WARN*  org.apache.jackrabbit.oak.plugins.index.IndexUpdate - Missing index provider of type [lucene], requesting reindex on [/oak:index/workflowDataLucene]
22.07.2018 19:30:41.105 [main] *WARN*  org.apache.jackrabbit.oak.plugins.index.IndexUpdate - Missing index provider of type [lucene], requesting reindex on [/oak:index/slingeventJob]
22.07.2018 19:30:41.106 [main] *WARN*  org.apache.jackrabbit.oak.plugins.index.IndexUpdate - Missing index provider of type [lucene], requesting reindex on [/oak:index/versionStoreIndex]
22.07.2018 19:30:41.106 [main] *WARN*  org.apache.jackrabbit.oak.plugins.index.IndexUpdate - Missing index provider of type [lucene], requesting reindex on [/oak:index/commerceLucene]
22.07.2018 19:30:41.106 [main] *WARN*  org.apache.jackrabbit.oak.plugins.index.IndexUpdate - Missing index provider of type [lucene], requesting reindex on [/oak:index/authorizables]
22.07.2018 19:30:41.106 [main] *WARN*  org.apache.jackrabbit.oak.plugins.index.IndexUpdate - Missing index provider of type [lucene], requesting reindex on [/oak:index/cqProjectLucene]
22.07.2018 19:30:41.107 [main] *WARN*  org.apache.jackrabbit.oak.plugins.index.IndexUpdate - Missing index provider of type [lucene], requesting reindex on [/oak:index/ntBaseLucene]
22.07.2018 19:30:41.108 [main] *WARN*  org.apache.jackrabbit.oak.plugins.index.IndexUpdate - Missing index provider of type [lucene], requesting reindex on [/oak:index/cqTagLucene]
22.07.2018 19:30:41.108 [main] *WARN*  org.apache.jackrabbit.oak.plugins.index.IndexUpdate - Missing index provider of type [lucene], requesting reindex on [/oak:index/cqPageLucene]
22.07.2018 19:30:41.113 [main] *INFO*  org.apache.jackrabbit.oak.upgrade.RepositoryUpgrade - Updating indexes   __        __
....
....
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16572437" author="catholicon" created="Tue, 7 Aug 2018 22:30:03 +0000"  >&lt;p&gt;Attaching &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12934729/12934729_OAK-7686.patch&quot; title=&quot;OAK-7686.patch attached to OAK-7686&quot;&gt;OAK-7686.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; which represents the fix I was suggesting above. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thomasm&quot; class=&quot;user-hover&quot; rel=&quot;thomasm&quot;&gt;thomasm&lt;/a&gt;, can you also please review it once?&lt;/p&gt;</comment>
                            <comment id="16572823" author="tomek.rekawek" created="Wed, 8 Aug 2018 07:40:36 +0000"  >&lt;p&gt;Thanks for the patch &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=catholicon&quot; class=&quot;user-hover&quot; rel=&quot;catholicon&quot;&gt;catholicon&lt;/a&gt;! After checking the oak-upgrade code, I think it&apos;d be hard to include the LuceneIndexEditorProvider, as it depends on the recent lucene-core, while the oak-upgrade already includes Jackrabbit Core, which depends on lucene-core 3.6.0.&lt;/p&gt;

&lt;p&gt;So, postponing the indexing to the instance runtime, without triggering the full reindexing indeed seems like the best option we have.&lt;/p&gt;</comment>
                            <comment id="16573298" author="tmueller" created="Wed, 8 Aug 2018 14:41:26 +0000"  >&lt;p&gt;The problem is, with the current patch breaks the contract of hybrid v2 indexes (synchronous properties,... specially unique properties).&lt;/p&gt;

&lt;p&gt;I&apos;m fine with the patch, if it logs a big fat warning that the index is not up to date.&lt;/p&gt;

&lt;p&gt;The right solution (in my view) would be to add oak-lucene to oak-upgrade, even if that means we need to &quot;split&quot; oak-upgrade so we can get rid of Jackrabbit Core / old Lucene in one of the cases.&lt;/p&gt;</comment>
                            <comment id="16573937" author="catholicon" created="Wed, 8 Aug 2018 21:52:17 +0000"  >&lt;p&gt;Thanks for the review &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thomasm&quot; class=&quot;user-hover&quot; rel=&quot;thomasm&quot;&gt;thomasm&lt;/a&gt;. I&apos;ve opened &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-7696&quot; title=&quot;oak-upgrade should include LuceneIndexProvider&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-7696&quot;&gt;OAK-7696&lt;/a&gt; for the right solution you mentioned (actually I&apos;ve diverged a bit... but the idea is towards &quot;oak-upgrade, instead of avoiding missing-provider-error, should at least do hybridV2 indexing&quot;&lt;/p&gt;

&lt;p&gt;That said, since what we&apos;re discussing is kind of an edge case and can be warned against, I&apos;m going to change &lt;tt&gt;log.debug&lt;/tt&gt; to &lt;tt&gt;log.warn&lt;/tt&gt; in my patch (and probably re-word it) and commit it for quick resolution of this issue.&lt;/p&gt;</comment>
                            <comment id="16573963" author="catholicon" created="Wed, 8 Aug 2018 22:18:00 +0000"  >&lt;p&gt;Committed the attached patch on trunk at &lt;a href=&quot;https://svn.apache.org/r1837676&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;r1837676&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="16574456" author="tomek.rekawek" created="Thu, 9 Aug 2018 08:06:18 +0000"  >&lt;p&gt;Backported to 1.8 in &lt;a href=&quot;https://svn.apache.org/r1837695&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;r1837695&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="16574481" author="tomek.rekawek" created="Thu, 9 Aug 2018 08:38:32 +0000"  >&lt;p&gt;Backported to 1.6 in &lt;a href=&quot;https://svn.apache.org/r1837700&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;r1837700&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="16583648" author="edivad" created="Fri, 17 Aug 2018 09:03:10 +0000"  >&lt;p&gt;bulk close 1.9.7&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13177324">OAK-7687</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13177801">OAK-7696</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12934729" name="OAK-7686.patch" size="6770" author="catholicon" created="Tue, 7 Aug 2018 22:28:57 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 13 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3wrof:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>