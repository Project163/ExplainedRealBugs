<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:48:19 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-3007] SegmentStore cache does not take &quot;string&quot; map into account</title>
                <link>https://issues.apache.org/jira/browse/OAK-3007</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;The SegmentStore cache size calculation ignores the size of the field Segment.string (a concurrent hash map). It looks like a regular segment in a memory mapped file has the size 1024, no matter how many strings are loaded in memory. This can lead to out of memory. There seems to be no way to limit (configure) the amount of memory used by strings. In one example, 100&apos;000 segments are loaded in memory, and 5 GB are used for Strings in that map.&lt;/p&gt;

&lt;p&gt;We need a way to configure the amount of memory used for that. This seems to be basically a cache. &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-2688&quot; title=&quot;Segment.readString optimization&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-2688&quot;&gt;&lt;del&gt;OAK-2688&lt;/del&gt;&lt;/a&gt; does this, but it would be better to have one cache with a configurable size limit.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12838792">OAK-3007</key>
            <summary>SegmentStore cache does not take &quot;string&quot; map into account</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mduerig">Michael D&#252;rig</assignee>
                                    <reporter username="thomasm">Thomas Mueller</reporter>
                        <labels>
                            <label>doc-impacting</label>
                            <label>resilience</label>
                            <label>scalability</label>
                    </labels>
                <created>Thu, 18 Jun 2015 13:40:24 +0000</created>
                <updated>Tue, 16 Feb 2021 09:52:48 +0000</updated>
                            <resolved>Wed, 15 Jul 2015 14:08:04 +0000</resolved>
                                                    <fixVersion>1.2.16</fixVersion>
                    <fixVersion>1.3.3</fixVersion>
                    <fixVersion>1.4</fixVersion>
                                    <component>segmentmk</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14591904" author="tmueller" created="Thu, 18 Jun 2015 14:38:52 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-3007&quot; title=&quot;SegmentStore cache does not take &amp;quot;string&amp;quot; map into account&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-3007&quot;&gt;&lt;del&gt;OAK-3007&lt;/del&gt;&lt;/a&gt;.patch (potential patch, not fully tested yet)&lt;/p&gt;</comment>
                            <comment id="14595690" author="edivad" created="Mon, 22 Jun 2015 09:47:09 +0000"  >&lt;p&gt;Bulk move to 1.3.2&lt;/p&gt;</comment>
                            <comment id="14609778" author="mduerig" created="Wed, 1 Jul 2015 08:57:28 +0000"  >&lt;p&gt;Slightly edited version of Tomas&apos; patch retaining encapsulation. &lt;/p&gt;</comment>
                            <comment id="14609783" author="mduerig" created="Wed, 1 Jul 2015 08:59:22 +0000"  >&lt;p&gt;I think this approach makes a lot of sense and we should give it a spin. &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thomasm&quot; class=&quot;user-hover&quot; rel=&quot;thomasm&quot;&gt;thomasm&lt;/a&gt;, could you also add a unit test for &lt;tt&gt;StringCache&lt;/tt&gt;?&lt;/p&gt;</comment>
                            <comment id="14610147" author="edivad" created="Wed, 1 Jul 2015 13:05:17 +0000"  >&lt;p&gt;Bulk move to 1.3.3.&lt;/p&gt;</comment>
                            <comment id="14614846" author="alex.parvulescu" created="Mon, 6 Jul 2015 10:37:54 +0000"  >&lt;p&gt;I believe that the root cause for the compaction case filling up the cache is is &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-3075&quot; title=&quot;Compaction Estimation should type check binary properties&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-3075&quot;&gt;&lt;del&gt;OAK-3075&lt;/del&gt;&lt;/a&gt;. but this patch should be applied nonetheless.&lt;/p&gt;</comment>
                            <comment id="14616304" author="tmueller" created="Tue, 7 Jul 2015 07:16:04 +0000"  >&lt;p&gt;&amp;gt; Thomas Mueller, could you also add a unit test for StringCache?&lt;/p&gt;

&lt;p&gt;Sure.&lt;/p&gt;

&lt;p&gt;&amp;gt; I believe that the root cause for the compaction case filling up the cache is is &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-3075&quot; title=&quot;Compaction Estimation should type check binary properties&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-3075&quot;&gt;&lt;del&gt;OAK-3075&lt;/del&gt;&lt;/a&gt;. but this patch should be applied nonetheless.&lt;/p&gt;

&lt;p&gt;As far as I understand, &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-3075&quot; title=&quot;Compaction Estimation should type check binary properties&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-3075&quot;&gt;&lt;del&gt;OAK-3075&lt;/del&gt;&lt;/a&gt; is not the reason, but yes I understand that some other issue caused that this many strings are loaded. It would be nice to find the root cause. In order to find the root cause, the patch here (&lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-3007&quot; title=&quot;SegmentStore cache does not take &amp;quot;string&amp;quot; map into account&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-3007&quot;&gt;&lt;del&gt;OAK-3007&lt;/del&gt;&lt;/a&gt;) could be applied and the compaction test could be re-run. That should no longer result in out-of-memory in SegmentStore cache, but in slow compaction, which in turn can be analyzed using a profiler. Or in yet another out-of-memory (but in a different place), which in turn can be analyzed... So the current patch of &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-3007&quot; title=&quot;SegmentStore cache does not take &amp;quot;string&amp;quot; map into account&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-3007&quot;&gt;&lt;del&gt;OAK-3007&lt;/del&gt;&lt;/a&gt; should help to understand the &lt;em&gt;real&lt;/em&gt; problem.&lt;/p&gt;

&lt;p&gt;&amp;gt; but this patch should be applied nonetheless.&lt;/p&gt;

&lt;p&gt;Yes, I think applying this patch eventually to trunk (after writing more unit tests) would be good. Backporting it might not be all that urgent I guess.&lt;/p&gt;
</comment>
                            <comment id="14616306" author="mduerig" created="Tue, 7 Jul 2015 07:22:22 +0000"  >&lt;p&gt;A problem I encountered with the patch is &lt;tt&gt;FileStore#FileStore(File, NodeState, int)&lt;/tt&gt; throwing an &lt;tt&gt;IAE&lt;/tt&gt;. That constructor should create a &lt;tt&gt;FileStore&lt;/tt&gt; without cache. So far it did so by specifying a cache size of 0 to the &lt;tt&gt;SegmentTracker&lt;/tt&gt;. With the LIRS cache this stopped working. &lt;br/&gt;
Just run &lt;tt&gt;CompactionAndCleanupTest#propertyRetention&lt;/tt&gt; to see this. &lt;/p&gt;</comment>
                            <comment id="14616318" author="mduerig" created="Tue, 7 Jul 2015 07:30:14 +0000"  >&lt;p&gt;In some ad-hoc testing this patch together with the one from &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-3055&quot; title=&quot;Improve segment cache in SegmentTracker&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-3055&quot;&gt;&lt;del&gt;OAK-3055&lt;/del&gt;&lt;/a&gt; proved beneficial. Pending the failing ITs and your review of &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-3055&quot; title=&quot;Improve segment cache in SegmentTracker&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-3055&quot;&gt;&lt;del&gt;OAK-3055&lt;/del&gt;&lt;/a&gt; I think we should apply the patches to trunk. As soon as we have enough longevity coverage we should also merge them to the branches. &lt;/p&gt;</comment>
                            <comment id="14618694" author="tmueller" created="Wed, 8 Jul 2015 14:33:47 +0000"  >&lt;p&gt;While writing tests, I found and fixed some issues and changed the API a bit to simplify testing. Still working on this.&lt;/p&gt;</comment>
                            <comment id="14620401" author="tmueller" created="Thu, 9 Jul 2015 12:12:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-3007&quot; title=&quot;SegmentStore cache does not take &amp;quot;string&amp;quot; map into account&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-3007&quot;&gt;&lt;del&gt;OAK-3007&lt;/del&gt;&lt;/a&gt;-3.patch: new patch with slightly changed API to simplify testing (making the StringCache independent on the Segment class).&lt;/p&gt;

&lt;p&gt;I run some benchmarks and got slightly lower numbers, but the numbers varied quite a bit so I&apos;m not sure if this is really related to my changes. Profiling does not show this code anywhere in the critical path. However, Segment.readTemplate is in the critical path, and I wonder if we should use a faster array-based cache there as well (similar to the StringCache.FastCache), in addition to the (unlimited size) concurrent hash map. I guess there are not that many templates typically so that this is not such a big risk to run out of memory with many templates, except in some exotic use cases (randomly generated property names for example).&lt;/p&gt;</comment>
                            <comment id="14620405" author="tmueller" created="Thu, 9 Jul 2015 12:14:31 +0000"  >&lt;p&gt;For future reference, a benchmark I ran was:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java -Dwarmup=5 -Druntime=2 -Dprofile=true -jar target/oak-run-1.4-SNAPSHOT.jar 
    benchmark ReadPropertyTest Oak-Tar | grep &quot;Segment.read&quot;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This does not show readString, but many readTemplate calls. Possibly the following tests could be run as well:&lt;/p&gt;


&lt;p&gt;ReadDeepTreeTest&lt;br/&gt;
ConcurrentReadDeepTreeTest&lt;br/&gt;
ConcurrentReadRandomNodeAndItsPropertiesTest&lt;br/&gt;
ConcurrentReadTest&lt;br/&gt;
ConcurrentTraversalTest&lt;br/&gt;
DescendantSearchTest&lt;br/&gt;
GetDeepNodeTest&lt;br/&gt;
GetNodeWithAdmin&lt;br/&gt;
ReadPropertyTest&lt;br/&gt;
SQL2DescendantSearchTest&lt;br/&gt;
SQL2SearchTest&lt;br/&gt;
SimpleSearchTest&lt;/p&gt;</comment>
                            <comment id="14628094" author="mduerig" created="Wed, 15 Jul 2015 14:08:04 +0000"  >&lt;p&gt;Committed &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-3007&quot; title=&quot;SegmentStore cache does not take &amp;quot;string&amp;quot; map into account&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-3007&quot;&gt;&lt;del&gt;OAK-3007&lt;/del&gt;&lt;/a&gt;-3.patch at with slight modification. In addition &lt;a href=&quot;http://svn.apache.org/r1691218&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1691218&lt;/a&gt; also exposes the CacheStatsMBean for the string cache. &lt;/p&gt;

&lt;p&gt;I can confirm that this in conjunction with &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-3055&quot; title=&quot;Improve segment cache in SegmentTracker&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-3055&quot;&gt;&lt;del&gt;OAK-3055&lt;/del&gt;&lt;/a&gt; considerably reduces the observer lock contention. &lt;/p&gt;</comment>
                            <comment id="14638858" author="edivad" created="Thu, 23 Jul 2015 14:08:45 +0000"  >&lt;p&gt;Bulk closing for 1.3.3.&lt;/p&gt;</comment>
                            <comment id="15299717" author="alex.parvulescu" created="Wed, 25 May 2016 09:11:54 +0000"  >&lt;p&gt;Merged to 1.2 branch with r1745461.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12785898">OAK-2688</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12845245">OAK-3109</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12842854">OAK-3075</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12932111">OAK-3889</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12843846">OAK-3089</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12841717">OAK-3055</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12743023" name="OAK-3007-2.patch" size="12584" author="mduerig" created="Wed, 1 Jul 2015 08:57:28 +0000"/>
                            <attachment id="12744476" name="OAK-3007-3.patch" size="15863" author="thomasm" created="Thu, 9 Jul 2015 12:12:23 +0000"/>
                            <attachment id="12740405" name="OAK-3007.patch" size="9071" author="thomasm" created="Thu, 18 Jun 2015 14:38:52 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 25 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2g7j3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>