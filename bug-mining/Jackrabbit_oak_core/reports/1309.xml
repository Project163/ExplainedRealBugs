<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:48:55 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-3313] Many tests leak DocumentNodeStore instances</title>
                <link>https://issues.apache.org/jira/browse/OAK-3313</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;Many tests use the &lt;tt&gt;DocumentMK.Builder&lt;/tt&gt; to create &lt;tt&gt;DocumentNodeStore&lt;/tt&gt; instances in tests. The cleanup is manual, either in an &lt;tt&gt;@After&lt;/tt&gt; method or in the test method. The problems arise when the cleanup is forgotten or not done in a finally block. The problem appears when too many threads are started but not stopped and hit machine resource limitations.&lt;/p&gt;

&lt;p&gt;To solve this problem I propose using a JUnit &lt;tt&gt;@Rule&lt;/tt&gt; which returns a custom &lt;tt&gt;DocumentMK.Builder&lt;/tt&gt; instance which shuts down the &lt;tt&gt;DocumentNodeStore&lt;/tt&gt; that it has created when the test method is finished.&lt;/p&gt;

&lt;p&gt;I was able to replace most of the leaks by using the &lt;tt&gt;DocumentMkBuilderProvider&lt;/tt&gt; rule, as follows:&lt;/p&gt;

&lt;p&gt;Before:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;@Test
 &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void someTest() {
      DocumentNodeStore = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; DocumentMK.Builder().getNodeStore();
      &lt;span class=&quot;code-comment&quot;&gt;// test code
&lt;/span&gt;     store.dispose();
  }&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;After:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;@Rule
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; DocumentMkBuilderProvider builderProvider = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; DocumentMkBuilderProvider();
@Test
 &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void someTest() {
      DocumentNodeStore = builderProvider.newBuilder().getNodeStore();
      &lt;span class=&quot;code-comment&quot;&gt;// test code
&lt;/span&gt;  }&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I haven&apos;t touched tests which did not leak DocumentNodeStore instances.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12859899">OAK-3313</key>
            <summary>Many tests leak DocumentNodeStore instances</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mreutegg">Marcel Reutegger</assignee>
                                    <reporter username="rombert">Robert Munteanu</reporter>
                        <labels>
                    </labels>
                <created>Fri, 28 Aug 2015 11:41:59 +0000</created>
                <updated>Wed, 2 Mar 2016 12:14:29 +0000</updated>
                            <resolved>Mon, 7 Sep 2015 13:26:25 +0000</resolved>
                                                    <fixVersion>1.0.21</fixVersion>
                    <fixVersion>1.2.6</fixVersion>
                    <fixVersion>1.3.6</fixVersion>
                    <fixVersion>1.4</fixVersion>
                                    <component>core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="14718394" author="rombert" created="Fri, 28 Aug 2015 11:48:38 +0000"  >&lt;p&gt;For the record I used the following snippet to detect unclosed instances:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;diff --git a/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/DocumentNodeStore.java b/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/DocumentNodeStore.java
index 2c5bffd..b1ebda1 100644
--- a/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/DocumentNodeStore.java
+++ b/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/DocumentNodeStore.java
@@ -410,8 +410,11 @@ &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;DocumentNodeStore
     &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; PersistentCache persistentCache;
 
     &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; DocumentNodeStoreMBean mbean;
+    
+    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Throwable creator;
 
     &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; DocumentNodeStore(DocumentMK.Builder builder) {
+        creator = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Throwable().fillInStackTrace();
         &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.blobStore = builder.getBlobStore();
         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (builder.isUseSimpleRevision()) {
             &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.simpleRevisionCounter = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; AtomicInteger(0);
@@ -599,6 +602,14 @@ &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;DocumentNodeStore
         }
         LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Disposed DocumentNodeStore with clusterNodeId: {}&quot;&lt;/span&gt;, clusterId);
     }
+    
+    &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; void finalize() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Throwable {
+        
+        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; ( !isDisposed.get()) {
+            LOG.warn(getClass().getSimpleName() + &lt;span class=&quot;code-quote&quot;&gt;&quot; instance not properly disposed. Creation stack trace follows&quot;&lt;/span&gt;, creator);
+        }
+        
+    };
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14733531" author="rombert" created="Mon, 7 Sep 2015 10:47:24 +0000"  >&lt;p&gt;Ping? Would be great is someone reviewed this patch, it makes the test suite more stable for me and presumably in other restrained environments ( like CI )&lt;/p&gt;</comment>
                            <comment id="14733699" author="mreutegg" created="Mon, 7 Sep 2015 13:26:08 +0000"  >&lt;p&gt;Thanks for the patch. Looks very useful.&lt;/p&gt;

&lt;p&gt;I committed a slightly modified version of your patch:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Renamed &lt;tt&gt;DocumentMkBuilderProvider&lt;/tt&gt; to &lt;tt&gt;DocumentMKBuilderProvider&lt;/tt&gt; and added a license header&lt;/li&gt;
	&lt;li&gt;Added a DocumentStoreWrapper class to address the shutdown issue with multiple DocumentNodeStore instances sharing the same DocumentStore.&lt;/li&gt;
	&lt;li&gt;Reverted changes to &lt;tt&gt;ValueMapTest&lt;/tt&gt;. AFAICS the store is properly disposed at the end of the test.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Applied to trunk: &lt;a href=&quot;http://svn.apache.org/r1701619&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1701619&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14733744" author="mreutegg" created="Mon, 7 Sep 2015 14:02:49 +0000"  >&lt;p&gt;Merged into 1.2 branch: &lt;a href=&quot;http://svn.apache.org/r1701622&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1701622&lt;/a&gt; and 1.0 branch: &lt;a href=&quot;http://svn.apache.org/r1701627&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1701627&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14902112" author="mreutegg" created="Tue, 22 Sep 2015 07:19:42 +0000"  >&lt;p&gt;Bulk close for Oak 1.3.6 release.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12752984" name="0001-OAK-3313-Many-tests-leak-DocumentNodeStore-instances.patch" size="76964" author="rombert" created="Fri, 28 Aug 2015 11:45:03 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 8 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2jhw7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>