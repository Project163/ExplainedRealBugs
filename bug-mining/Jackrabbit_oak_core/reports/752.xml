<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:42:52 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-1530] TarMK thread logs warning</title>
                <link>https://issues.apache.org/jira/browse/OAK-1530</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;From time to time I see warnings from the TarMK flush thread. I&apos;m not sure if this is caused by my environment. In any case it would be good to at least know why it happens and then fix or document it.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;12.03.2014 10:54:45.752 *WARN* [TarMK flush thread: repository] org.apache.jackrabbit.oak.plugins.segment.file.FileStore
Failed to flush the TarMK at repository
java.io.IOException: The process cannot access the file because another process has locked a portion of the file
        at java.nio.MappedByteBuffer.force0(Native Method)
        at java.nio.MappedByteBuffer.force(MappedByteBuffer.java:203)
        at org.apache.jackrabbit.oak.plugins.segment.file.MappedAccess.flush(MappedAccess.java:73)
        at org.apache.jackrabbit.oak.plugins.segment.file.TarFile.flush(TarFile.java:181)
        at org.apache.jackrabbit.oak.plugins.segment.file.FileStore.flush(FileStore.java:225)
        at org.apache.jackrabbit.oak.plugins.segment.file.FileStore$1.run(FileStore.java:196)
        at java.lang.Thread.run(Thread.java:744)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>&lt;p&gt;Windows 7, JDK 1.7.0_51 64 Bit&lt;/p&gt;</environment>
        <key id="12700924">OAK-1530</key>
            <summary>TarMK thread logs warning</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jukkaz">Jukka Zitting</assignee>
                                    <reporter username="mreutegg">Marcel Reutegger</reporter>
                        <labels>
                    </labels>
                <created>Wed, 12 Mar 2014 10:01:17 +0000</created>
                <updated>Mon, 24 Mar 2014 13:36:45 +0000</updated>
                            <resolved>Tue, 18 Mar 2014 19:30:02 +0000</resolved>
                                    <version>0.18</version>
                                    <fixVersion>0.19</fixVersion>
                                    <component>core</component>
                    <component>segmentmk</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="13938982" author="amitgupt" created="Tue, 18 Mar 2014 09:10:02 +0000"  >&lt;p&gt;I saw this with JDK 6 and windows 7 on my laptop as well&lt;br/&gt;
18.03.2014 14:28:50.670 &lt;b&gt;WARN&lt;/b&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;TarMK flush thread: C:\X\repository\segmentstore&amp;#93;&lt;/span&gt; org.apache.jackrabbit.oak.plugins.segment.file.FileStore Failed to flush the TarMK atC:\X\repository\segmentstore&lt;br/&gt;
java.io.IOException: null&lt;br/&gt;
	at java.nio.MappedByteBuffer.force0(Native Method)&lt;br/&gt;
	at java.nio.MappedByteBuffer.force(MappedByteBuffer.java:154)&lt;br/&gt;
	at org.apache.jackrabbit.oak.plugins.segment.file.MappedAccess.flush(MappedAccess.java:73)&lt;br/&gt;
	at org.apache.jackrabbit.oak.plugins.segment.file.TarFile.flush(TarFile.java:181)&lt;br/&gt;
	at org.apache.jackrabbit.oak.plugins.segment.file.FileStore.flush(FileStore.java:209)&lt;br/&gt;
	at org.apache.jackrabbit.oak.plugins.segment.file.FileStore$1.run(FileStore.java:180)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:662)&lt;/p&gt;
</comment>
                            <comment id="13939269" author="jukkaz" created="Tue, 18 Mar 2014 14:24:48 +0000"  >&lt;p&gt;Is it possible for this to be caused by an on-access virus scanner, or some other external process that&apos;s inspecting the files while they&apos;re being used?&lt;/p&gt;</comment>
                            <comment id="13939310" author="mreutegg" created="Tue, 18 Mar 2014 14:52:56 +0000"  >&lt;p&gt;Yes, in my case that&apos;s possible.&lt;/p&gt;</comment>
                            <comment id="13939379" author="amitgupt" created="Tue, 18 Mar 2014 15:31:48 +0000"  >&lt;p&gt;It is quite possible... since it was consistently reproducible today with different fresh startups, I will try with virus scan disabled and update it&lt;/p&gt;</comment>
                            <comment id="13939383" author="jukkaz" created="Tue, 18 Mar 2014 15:36:32 +0000"  >&lt;p&gt;OK, thanks for the info, such external access seems like the best explanation for these warnings. I guess we should catch such exceptions and retry the &lt;tt&gt;force()&lt;/tt&gt; call a bit later.&lt;/p&gt;</comment>
                            <comment id="13939446" author="chetanm" created="Tue, 18 Mar 2014 16:30:05 +0000"  >&lt;p&gt;There is bug &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; open on JDK where the force method might throw such IOException under different case. In that case it was due to NTFS log being full. So best we can do is to catch the exception , log it and retry later&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;http://bugs.java.com/bugdatabase/view_bug.do?bug_id=6539707&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://bugs.java.com/bugdatabase/view_bug.do?bug_id=6539707&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13939683" author="jukkaz" created="Tue, 18 Mar 2014 19:30:02 +0000"  >&lt;p&gt;Thanks for the JVM bug link! That seems a more likely cause of this problem.&lt;/p&gt;

&lt;p&gt;In revision 1579024 I added an workaround that explicitly catches these exceptions and logs only a milder warning with a reference to the JVM issue.&lt;/p&gt;</comment>
                            <comment id="13941533" author="tmueller" created="Thu, 20 Mar 2014 09:10:20 +0000"  >&lt;p&gt;Would it make sense to lock the file? Also to protect against running multiple TarMKs against the same file.&lt;/p&gt;</comment>
                            <comment id="13941540" author="tmueller" created="Thu, 20 Mar 2014 09:18:05 +0000"  >&lt;p&gt;(I forgot to write, locking a file doesn&apos;t work well for NFS, but I assume we don&apos;t target NFS). Patch (untested):&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Index: MappedAccess.java
===================================================================
--- MappedAccess.java	(revision 1579559)
+++ MappedAccess.java	(working copy)
@@ -22,22 +22,42 @@
 import java.io.RandomAccessFile;
 import java.nio.ByteBuffer;
 import java.nio.MappedByteBuffer;
+import java.nio.channels.ClosedChannelException;
+import java.nio.channels.FileChannel;
+import java.nio.channels.FileLock;
 
 class MappedAccess implements FileAccess {
 
     private final MappedByteBuffer buffer;
+    
+    private final FileLock fileLock;
 
     private boolean updated = false;
 
     MappedAccess(RandomAccessFile file, int length) throws IOException {
+        FileLock lock = null;
+        boolean success = false;
         try {
             long l = file.length();
             if (l == 0) { // it&apos;s a new file
                 l = length;
                 updated = true;
             }
-            buffer = file.getChannel().map(READ_WRITE, 0, l);
+            FileChannel c = file.getChannel();
+            lock = c.lock();
+            buffer = c.map(READ_WRITE, 0, l);
+            fileLock = lock;
+            success = true;
         } finally {
+            if (!success &amp;amp;&amp;amp; lock != null) {
+                try {
+                    lock.release();
+                } catch (ClosedChannelException e) {
+                    // ignore
+                } catch (IOException e) {
+                    // ignore
+                }
+            }
             file.close();
         }
     }
@@ -76,6 +96,7 @@
     @Override
     public void close() throws IOException {
         flush();
+        fileLock.release();
     }
 
 }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13945089" author="alex.parvulescu" created="Mon, 24 Mar 2014 13:36:45 +0000"  >&lt;p&gt;Bulk close for the 0.19 release.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>379270</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 34 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1tcnb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>379562</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>