<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:44:23 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-1817] NPE in MarkSweepGarbageCollector.saveBatchToFile during Datastore GC with FileDataStore</title>
                <link>https://issues.apache.org/jira/browse/OAK-1817</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;During running a datastore garbage collection on a Jackrabbit 2 FileDataStore (org.apache.jackrabbit.oak.plugins.blob.datastore.FileDataStore, see &lt;a href=&quot;http://jackrabbit.apache.org/oak/docs/osgi_config.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://jackrabbit.apache.org/oak/docs/osgi_config.html&lt;/a&gt;) an NPE is thrown&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;13.05.2014 17:50:16.944 *ERROR* [qtp1416657193-147] org.apache.jackrabbit.oak.management.ManagementOperation Blob garbage collection failed
java.lang.RuntimeException: Error in retrieving references
	at org.apache.jackrabbit.oak.plugins.blob.MarkSweepGarbageCollector$1.addReference(MarkSweepGarbageCollector.java:395)
	at org.apache.jackrabbit.oak.plugins.segment.Segment.collectBlobReferences(Segment.java:248)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentTracker.collectBlobReferences(SegmentTracker.java:178)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentBlobReferenceRetriever.collectReferences(SegmentBlobReferenceRetriever.java:38)
	at org.apache.jackrabbit.oak.plugins.blob.MarkSweepGarbageCollector.iterateNodeTree(MarkSweepGarbageCollector.java:361)
	at org.apache.jackrabbit.oak.plugins.blob.MarkSweepGarbageCollector.mark(MarkSweepGarbageCollector.java:201)
	at org.apache.jackrabbit.oak.plugins.blob.MarkSweepGarbageCollector.markAndSweep(MarkSweepGarbageCollector.java:173)
	at org.apache.jackrabbit.oak.plugins.blob.MarkSweepGarbageCollector.collectGarbage(MarkSweepGarbageCollector.java:149)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeStoreService$2.collectGarbage(SegmentNodeStoreService.java:185)
	at org.apache.jackrabbit.oak.plugins.blob.BlobGC$1.call(BlobGC.java:68)
	at org.apache.jackrabbit.oak.plugins.blob.BlobGC$1.call(BlobGC.java:64)
	at java.util.concurrent.FutureTask.run(FutureTask.java:262)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
Caused by: java.lang.NullPointerException: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
	at com.google.common.base.Preconditions.checkNotNull(Preconditions.java:192)
	at com.google.common.base.Joiner.toString(Joiner.java:436)
	at com.google.common.base.Joiner.appendTo(Joiner.java:108)
	at com.google.common.base.Joiner.appendTo(Joiner.java:152)
	at com.google.common.base.Joiner.join(Joiner.java:193)
	at com.google.common.base.Joiner.join(Joiner.java:183)
	at org.apache.jackrabbit.oak.plugins.blob.MarkSweepGarbageCollector.saveBatchToFile(MarkSweepGarbageCollector.java:317)
	at org.apache.jackrabbit.oak.plugins.blob.MarkSweepGarbageCollector$1.addReference(MarkSweepGarbageCollector.java:391)
	... 14 common frames omitted
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Attached you find the OSGi config for both the nodestore and the datastore.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12713933">OAK-1817</key>
            <summary>NPE in MarkSweepGarbageCollector.saveBatchToFile during Datastore GC with FileDataStore</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="chetanm">Chetan Mehrotra</assignee>
                                    <reporter username="kwin">Konrad Windszus</reporter>
                        <labels>
                    </labels>
                <created>Tue, 13 May 2014 15:54:39 +0000</created>
                <updated>Wed, 1 Oct 2014 13:14:08 +0000</updated>
                            <resolved>Wed, 21 May 2014 10:34:32 +0000</resolved>
                                    <version>0.20</version>
                                    <fixVersion>1.0.1</fixVersion>
                    <fixVersion>1.1.0</fixVersion>
                                    <component>blob</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="13998461" author="amitjain" created="Thu, 15 May 2014 05:47:42 +0000"  >&lt;p&gt;Can you please verify this on the latest build (1.0.0). There have been quite a few fixes after .20 in this area.&lt;/p&gt;</comment>
                            <comment id="13998714" author="kwin" created="Thu, 15 May 2014 12:13:27 +0000"  >&lt;p&gt;This is not easily feasible, as I was testing with an AEM6 beta (load21a). &lt;/p&gt;</comment>
                            <comment id="14003025" author="kwin" created="Tue, 20 May 2014 09:54:08 +0000"  >&lt;p&gt;Ok, I tested now with 1.0.0 and the same exception occurs:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;20.05.2014 11:51:24.017 *ERROR* [qtp324133671-421] org.apache.jackrabbit.oak.management.ManagementOperation Blob garbage collection failed
java.lang.RuntimeException: Error in retrieving references
	at org.apache.jackrabbit.oak.plugins.blob.MarkSweepGarbageCollector$1.addReference(MarkSweepGarbageCollector.java:395)
	at org.apache.jackrabbit.oak.plugins.segment.Segment.collectBlobReferences(Segment.java:248)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentTracker.collectBlobReferences(SegmentTracker.java:178)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentBlobReferenceRetriever.collectReferences(SegmentBlobReferenceRetriever.java:38)
	at org.apache.jackrabbit.oak.plugins.blob.MarkSweepGarbageCollector.iterateNodeTree(MarkSweepGarbageCollector.java:361)
	at org.apache.jackrabbit.oak.plugins.blob.MarkSweepGarbageCollector.mark(MarkSweepGarbageCollector.java:201)
	at org.apache.jackrabbit.oak.plugins.blob.MarkSweepGarbageCollector.markAndSweep(MarkSweepGarbageCollector.java:173)
	at org.apache.jackrabbit.oak.plugins.blob.MarkSweepGarbageCollector.collectGarbage(MarkSweepGarbageCollector.java:149)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeStoreService$2.collectGarbage(SegmentNodeStoreService.java:185)
	at org.apache.jackrabbit.oak.plugins.blob.BlobGC$1.call(BlobGC.java:68)
	at org.apache.jackrabbit.oak.plugins.blob.BlobGC$1.call(BlobGC.java:64)
	at java.util.concurrent.FutureTask.run(FutureTask.java:262)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
Caused by: java.lang.NullPointerException: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
	at com.google.common.base.Preconditions.checkNotNull(Preconditions.java:192)
	at com.google.common.base.Joiner.toString(Joiner.java:436)
	at com.google.common.base.Joiner.appendTo(Joiner.java:108)
	at com.google.common.base.Joiner.appendTo(Joiner.java:152)
	at com.google.common.base.Joiner.join(Joiner.java:193)
	at com.google.common.base.Joiner.join(Joiner.java:183)
	at org.apache.jackrabbit.oak.plugins.blob.MarkSweepGarbageCollector.saveBatchToFile(MarkSweepGarbageCollector.java:317)
	at org.apache.jackrabbit.oak.plugins.blob.MarkSweepGarbageCollector$1.addReference(MarkSweepGarbageCollector.java:391)
	... 14 common frames omitted
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14003154" author="amitjain" created="Tue, 20 May 2014 12:31:21 +0000"  >&lt;p&gt;Patch attached to fix the issue.&lt;/p&gt;

&lt;p&gt;This is a problem because for inlined blobs the call &lt;tt&gt;SegmentBlob#getBlobId&lt;/tt&gt; returns null.&lt;/p&gt;</comment>
                            <comment id="14003238" author="chetanm" created="Tue, 20 May 2014 13:42:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=amitj_76&quot; class=&quot;user-hover&quot; rel=&quot;amitj_76&quot;&gt;amitj_76&lt;/a&gt; I tried to reproduce the issue with testcase committed in &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; but testcase passes. Can you recreate the issue&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;http://svn.apache.org/r1596241&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1596241&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14003394" author="amitjain" created="Tue, 20 May 2014 14:52:01 +0000"  >&lt;p&gt;The blob gc passes after making the change as in the patch.&lt;/p&gt;

&lt;p&gt;As for the test case it strangely passes.&lt;br/&gt;
The following code snippet passes, which means that the blobId returned is null.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Blob b1 = testCreateAndRead(createBlob(fds.getMinRecordLength()));
assertTrue(b1 &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; SegmentBlob);
assertNull(((SegmentBlob) b1).getBlobId());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;But when collecting blob references (after adding the same blob as above),  in the &lt;tt&gt;Segment#collectBlobReferences&lt;/tt&gt;, blobrefcount comes out to be 0, because of which it does not go into the loop. Looks like there is some edge case missing here.&lt;/p&gt;</comment>
                            <comment id="14004377" author="chetanm" created="Wed, 21 May 2014 05:45:18 +0000"  >&lt;p&gt;I have updated the testcase (currently ignored) with &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;. Seems like the blob ref accounting logic has some issue if no of blob are large in a segment. For e.g. in testcase creating 4000 blobs leads to NPE. Ideally the ReferenceCollector would not be passed a null ref as per Segment logic&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jukkaz&quot; class=&quot;user-hover&quot; rel=&quot;jukkaz&quot;&gt;jukkaz&lt;/a&gt; Do you forsee any issue with the blob ref accounting logic&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;http://svn.apache.org/r1596474&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1596474&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14004556" author="jukkaz" created="Wed, 21 May 2014 10:31:19 +0000"  >&lt;p&gt;It looks like the bug here is in the way the SegmentWriter keeps recently flushed segments cached in memory. In some cases those segments are cached using the full 256kB byte buffer even if the segment size is slightly smaller than that. In those cases the segment still works correctly for normal access, but the blobref entries are not accessible, which I believe is causing the NPE here.&lt;/p&gt;</comment>
                            <comment id="14004559" author="jukkaz" created="Wed, 21 May 2014 10:34:32 +0000"  >&lt;p&gt;Fixed in revision 1596534.&lt;/p&gt;</comment>
                            <comment id="14006040" author="mmarth" created="Thu, 22 May 2014 15:42:42 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jukkaz&quot; class=&quot;user-hover&quot; rel=&quot;jukkaz&quot;&gt;jukkaz&lt;/a&gt;, should we backport this to 1.0 branch?&lt;/p&gt;</comment>
                            <comment id="14017756" author="kwin" created="Wed, 4 Jun 2014 15:16:39 +0000"  >&lt;p&gt;Please consider for 1.0.1, because otherwise running the datastore GC is not possible at all!&lt;/p&gt;</comment>
                            <comment id="14018624" author="chetanm" created="Thu, 5 Jun 2014 09:36:55 +0000"  >&lt;p&gt;Merged to 1.0.1 in &lt;a href=&quot;http://svn.apache.org/r1600576&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1600576&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12644633" name="NodeAndDataStoreOsgiConfig.zip" size="1485" author="kwin" created="Tue, 13 May 2014 15:56:05 +0000"/>
                            <attachment id="12645780" name="OAK-1817.patch" size="1328" author="amitjain" created="Tue, 20 May 2014 12:31:21 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>392246</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 24 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1vjtj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>392436</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>