<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:40:09 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-1083] Query with descendent node and access control fails to return result</title>
                <link>https://issues.apache.org/jira/browse/OAK-1083</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;The scenario is bit complex. Running a query with following condition does not give any result&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Node path is like &lt;tt&gt;/home/users/geometrixx-outdoors/emily.andrews@mailinator.com/social/relationships/following/aaron.mcdonald@mailinator.com&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;It has a Glob jcr:read for everyone at &lt;tt&gt;&amp;#42;/social/relationships/following/&amp;#42;&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;The query is like
&lt;blockquote&gt;&lt;p&gt;/jcr:root/home//social/relationships/following//*&lt;span class=&quot;error&quot;&gt;&amp;#91;id=&amp;#39;aaron.mcdonald@mailinator.com&amp;#39;&amp;#93;&lt;/span&gt;&lt;/p&gt;&lt;/blockquote&gt;&lt;/li&gt;
	&lt;li&gt;The query is executed with anonymous session&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;On JR2 it returns expected result while on Oak it does not give any result&lt;/p&gt;</description>
                <environment></environment>
        <key id="12672808">OAK-1083</key>
            <summary>Query with descendent node and access control fails to return result</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="thomasm">Thomas Mueller</assignee>
                                    <reporter username="chetanm">Chetan Mehrotra</reporter>
                        <labels>
                            <label>compatibility</label>
                    </labels>
                <created>Tue, 8 Oct 2013 12:57:15 +0000</created>
                <updated>Thu, 30 Jan 2014 09:06:19 +0000</updated>
                            <resolved>Mon, 21 Oct 2013 12:30:17 +0000</resolved>
                                    <version>0.9</version>
                                    <fixVersion>0.11</fixVersion>
                                    <component>core</component>
                    <component>security</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13789177" author="chetanm" created="Tue, 8 Oct 2013 13:03:08 +0000"  >&lt;p&gt;Testcase which demonstrates the issue. The testcase passes on JR2 and fails with Oak&lt;/p&gt;

&lt;p&gt;Couple of notes&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;The testcase would pass if admin session is used&lt;/li&gt;
	&lt;li&gt;The GlobPattern passes while query result is fetched for the test path but then somehow the Query restriction fails&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13789266" author="alex.parvulescu" created="Tue, 8 Oct 2013 15:03:07 +0000"  >&lt;p&gt;this is the sql2 query:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;select d.[jcr:path] as [jcr:path], d.[jcr:score] as [jcr:score], d.* from [nt:base] as a 
&lt;span class=&quot;code-keyword&quot;&gt;inner&lt;/span&gt; join [nt:base] as b on ischildnode(b, a) 
&lt;span class=&quot;code-keyword&quot;&gt;inner&lt;/span&gt; join [nt:base] as c on ischildnode(c, b) 
&lt;span class=&quot;code-keyword&quot;&gt;inner&lt;/span&gt; join [nt:base] as d on isdescendantnode(d, c) 
where 
name(a) = &lt;span class=&quot;code-quote&quot;&gt;&apos;social&apos;&lt;/span&gt; and 
isdescendantnode(a, &lt;span class=&quot;code-quote&quot;&gt;&apos;/home&apos;&lt;/span&gt;) and 
name(b) = &lt;span class=&quot;code-quote&quot;&gt;&apos;relationships&apos;&lt;/span&gt; and 
name(c) = &lt;span class=&quot;code-quote&quot;&gt;&apos;following&apos;&lt;/span&gt; and 
d.[id/*] = &lt;span class=&quot;code-quote&quot;&gt;&apos;aaron.mcdonald@mailinator.com&apos;&lt;/span&gt; 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;&lt;p&gt;The GlobPattern passes while query result is fetched for the test path but then somehow the Query restriction fails&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;let&apos;s dig deeper into this a bit:&lt;br/&gt;
checking with the anonymous session, it doesn&apos;t seem like you can read _ /home/users/geometrixx-outdoors/emily.andrews@mailinator.com/social/relationships/following_, &lt;em&gt;/home/users/geometrixx-outdoors/emily.andrews@mailinator.com/social/relationships&lt;/em&gt;, &lt;em&gt;/home/users/geometrixx-outdoors/emily.andrews@mailinator.com/social&lt;/em&gt;&lt;br/&gt;
but you can read &lt;em&gt;/home/users/geometrixx-outdoors/emily.andrews@mailinator.com/social/relationships/following/aaron.mcdonald@mailinator.com&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;the way this is supposed to work is the &apos;a&apos; selector should be able to read the &apos;social&apos; node, allowing the other selectors to read the next level and so on, drilling down to the 4th level where the &apos;id&apos; condition is checked. this fails at the &lt;em&gt;Tree tree = getTree(currentRow.getPath()); if (tree == null || !tree.exists()) {&lt;/em&gt; part when the selector doesn&apos;t have enough read rights.&lt;/p&gt;

&lt;p&gt;what you notice debugging is in fact the &apos;a&apos; selector reading the &lt;em&gt;/home/users/geometrixx-outdoors/emily.andrews@mailinator.com/social/relationships/following/aaron.mcdonald@mailinator.com&lt;/em&gt; row, but unfortunately the query engine will check the 4th level deep child node for the &apos;id&apos; property which will effectively fail.&lt;/p&gt;

&lt;p&gt;there was a security related issue filed against JR that showed you could use joins to guess the content structure that you can&apos;t see (don&apos;t have read access to), so I guess this issue falls under the same category now (thanks to the automatic xpath to sql2 transformation).&lt;/p&gt;</comment>
                            <comment id="13790112" author="chetanm" created="Wed, 9 Oct 2013 07:13:05 +0000"  >&lt;p&gt;Thanks for the background details Alex!!&lt;/p&gt;

&lt;p&gt;It might be better if we move the access check a layer above and not mix it as part of query execution i.e. filter the result after a cursor result satisfies the constraints. It might also help in faster execution as in current Traversing Cursor implementation each node would have to be check for access control (and such checks over large number of nodes would be costly). If we move access check to later part then we would only have to perform such checks for fewer number of nodes.&lt;/p&gt;

&lt;p&gt;Not sure how this would effect pagination though&lt;/p&gt;</comment>
                            <comment id="13790154" author="tmueller" created="Wed, 9 Oct 2013 08:13:24 +0000"  >&lt;p&gt;&amp;gt; It might be better if we move the access check a layer above and not mix it as part of query execution i.e. filter the result after a cursor result satisfies the constraints&lt;/p&gt;

&lt;p&gt;Well, that way you could bypass security checks. For example, let&apos;s assume you have a content structure as follows, where a user can only read the nodes /user/a and /user/b, but not /user/.../content. You could use a join of the form:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;select a.* from a &lt;span class=&quot;code-keyword&quot;&gt;inner&lt;/span&gt; join b on (b is child of a) where b.password like &lt;span class=&quot;code-quote&quot;&gt;&apos;x%&apos;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Because the query only potentially reads /user/a and /user/b nodes, it would work. But it would internally read /user/.../content, which is not allowed. And even thought the query result doesn&apos;t contain the node with the password directly, it would be relatively simple to figure out what the password is, by running multiple queries (password like &apos;a%&apos;, &apos;b%&apos;, &apos;c%&apos;, &apos;ca%&apos;, &apos;cb%&apos;,...)&lt;/p&gt;</comment>
                            <comment id="13790163" author="tmueller" created="Wed, 9 Oct 2013 08:35:25 +0000"  >&lt;p&gt;The query above (&lt;tt&gt;/jcr:root/home//social/relationships/following//*...&lt;/tt&gt;) is a bit different. It doesn&apos;t read any property from the node &apos;social&apos;, or from &apos;relationships&apos; or &apos;following&apos;. So I wonder whether we would be allowed to not check if the session can read those nodes.&lt;/p&gt;</comment>
                            <comment id="13793988" author="tmueller" created="Mon, 14 Oct 2013 08:34:46 +0000"  >&lt;p&gt;This is a bit tricky. When I patch the query engine like this (making the above test case work):&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;--- src/main/java/org/apache/jackrabbit/oak/query/ast/SelectorImpl.java	(revision 1531812)
+++ src/main/java/org/apache/jackrabbit/oak/query/ast/SelectorImpl.java	(working copy)
@@ -266,11 +266,7 @@
         &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (cursor != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; cursor.hasNext()) {
             scanCount++;
             currentRow = cursor.next();
-            Tree tree = getTree(currentRow.getPath());
-            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (tree == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; || !tree.exists()) {
-                &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;;
-            }
-            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!matchesAllTypes &amp;amp;&amp;amp; !evaluateTypeMatch(tree)) {
+            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!matchesAllTypes &amp;amp;&amp;amp; !evaluateTypeMatch()) {
                 &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;;
             }
             &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (selectorCondition != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; !selectorCondition.evaluate()) {
@@ -286,7 +282,11 @@
         &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
     }
 
-    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; evaluateTypeMatch(Tree tree) {
+    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; evaluateTypeMatch() {
+        Tree tree = getTree(currentRow.getPath());
+        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (tree == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; || !tree.exists()) {
+            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
+        }
         PropertyState primary = tree.getProperty(JCR_PRIMARYTYPE);
         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (primary != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; primary.getType() == NAME) {
             &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; name = primary.getValue(NAME);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;then the following QueryTest fails:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        &lt;span class=&quot;code-comment&quot;&gt;// verify we can not deduce existence of the invisible node
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// using a join
&lt;/span&gt;        q = testSession.getWorkspace().getQueryManager().createQuery(
                &lt;span class=&quot;code-quote&quot;&gt;&quot;select a.* from [nt:base] as a &quot;&lt;/span&gt; +
                &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;inner&lt;/span&gt; join [nt:base] as b on isdescendantnode(b, a) &quot;&lt;/span&gt; +
                &lt;span class=&quot;code-quote&quot;&gt;&quot;where a.[jcr:path]=$path&quot;&lt;/span&gt;, Query.JCR_SQL2);
        q.bindValue(&lt;span class=&quot;code-quote&quot;&gt;&quot;path&quot;&lt;/span&gt;, vf.createValue(visible.getPath()));
        r = q.execute();
        assertFalse(r.getNodes().hasNext());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13800599" author="tmueller" created="Mon, 21 Oct 2013 12:30:03 +0000"  >&lt;p&gt;Revision 1534126&lt;/p&gt;

&lt;p&gt;Now the parent node of a join is not checked for read access (because doing that would break the attached test). However read access is checked on the child node, because not doing that would break other tests.&lt;/p&gt;</comment>
                            <comment id="13828707" author="alex.parvulescu" created="Thu, 21 Nov 2013 10:30:22 +0000"  >&lt;p&gt;bulk close for the 0.11 release&lt;/p&gt;</comment>
                            <comment id="13886428" author="tmueller" created="Thu, 30 Jan 2014 09:05:20 +0000"  >&lt;p&gt;The query is missing a @, it should be @id=&apos;aaron.mcdonald@mailinator.com&apos;&lt;/p&gt;</comment>
                            <comment id="13886430" author="tmueller" created="Thu, 30 Jan 2014 09:06:19 +0000"  >&lt;p&gt;Test case fixed in revision 1562736&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12607360" name="OAK-1083-testcase.patch" size="3913" author="chetanm" created="Tue, 8 Oct 2013 13:14:17 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>352431</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 42 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1orhb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>352718</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>