<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:50:09 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-3872] [RDB] Updated blob still deleted even if deletion interval lower</title>
                <link>https://issues.apache.org/jira/browse/OAK-3872</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;If an existing blob is uploaded again, the timestamp of the existing entry is updated in the meta table. Subsequently if a call to delete (RDBBlobStore#countDeleteChunks) is made with &lt;tt&gt;maxLastModifiedTime&lt;/tt&gt; parameter of less than the updated time above, the entry in the meta table is not touched but the data table entry is wiped out. &lt;/p&gt;

&lt;p&gt;Refer &lt;a href=&quot;https://github.com/apache/jackrabbit-oak/blob/trunk/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/rdb/RDBBlobStore.java#L510&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/jackrabbit-oak/blob/trunk/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/rdb/RDBBlobStore.java#L510&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12929702">OAK-3872</key>
            <summary>[RDB] Updated blob still deleted even if deletion interval lower</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="reschke">Julian Reschke</assignee>
                                    <reporter username="amitjain">Amit Jain</reporter>
                        <labels>
                    </labels>
                <created>Wed, 13 Jan 2016 05:24:06 +0000</created>
                <updated>Mon, 14 Mar 2016 16:58:45 +0000</updated>
                            <resolved>Thu, 14 Jan 2016 17:40:01 +0000</resolved>
                                    <version>1.0.25</version>
                    <version>1.2.9</version>
                    <version>1.3.13</version>
                                    <fixVersion>1.0.26</fixVersion>
                    <fixVersion>1.2.10</fixVersion>
                    <fixVersion>1.3.14</fixVersion>
                    <fixVersion>1.4</fixVersion>
                                    <component>blob</component>
                    <component>rdbmk</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15095637" author="amitjain" created="Wed, 13 Jan 2016 05:34:49 +0000"  >&lt;p&gt;A simple test and a possible fix is attached. All tests pass with the fix.&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=julian.reschke%40gmx.de&quot; class=&quot;user-hover&quot; rel=&quot;julian.reschke@gmx.de&quot;&gt;julian.reschke@gmx.de&lt;/a&gt; Can you please review the patch.&lt;br/&gt;
The above is a strong possibility during the concurrent run of blob gc and async index update as there is a likelihood that an older lucene blob gets recreated which is marked for GC. Since, it would have been updated it should not be deleted.&lt;/p&gt;</comment>
                            <comment id="15095786" author="tmueller" created="Wed, 13 Jan 2016 07:50:40 +0000"  >&lt;p&gt;The patch looks good to me. I think the bug in the original code was that the comparison was wrong:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;// correct:
// delete only if the last modified is older than x
metaStatement.append(&quot; and LASTMOD &amp;lt;= ?&quot;);

// wrong:
// delete only if there is NO entry where the last modified of the meta is older than x
dataStatement.append(&quot; and not exists(select * from &quot; + this.tnMeta + &quot; m where ID = m.ID and m.LASTMOD &amp;lt;= ?)&quot;);

// correct would also be:
// delete if there is NO entry where the last modified of the meta is YOUNGER than x
dataStatement.append(&quot; and not exists(select * from &quot; + this.tnMeta + &quot; m where ID = m.ID and m.LASTMOD &amp;gt; ?)&quot;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;But the patch is also fine. The logic is a bit different: delete if there is no meta record. This is correct if the meta record is removed before the data record. Please note it would not be correct if the data record is removed before the meta record. But that&apos;s not the case:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;count += prepMeta.executeUpdate();
prepData.execute();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I guess it would be good to add comments in the code, to avoid adding bugs later on.&lt;/p&gt;</comment>
                            <comment id="15096125" author="reschke" created="Wed, 13 Jan 2016 12:40:12 +0000"  >&lt;p&gt;(re-attaching Amit&apos;s patch; sorry for the noise)&lt;/p&gt;</comment>
                            <comment id="15098483" author="reschke" created="Thu, 14 Jan 2016 17:40:01 +0000"  >&lt;p&gt;trunk: &lt;a href=&quot;http://svn.apache.org/r1724423&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1724423&lt;/a&gt;&lt;br/&gt;
1.2: &lt;a href=&quot;http://svn.apache.org/r1724632&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1724632&lt;/a&gt;&lt;br/&gt;
1.0: &lt;a href=&quot;http://svn.apache.org/r1725281&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1725281&lt;/a&gt; &lt;a href=&quot;http://svn.apache.org/r1724659&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1724659&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;(the backport to 1.0 was a bit painful because of other changes not being backported; sigh)&lt;/p&gt;</comment>
                            <comment id="15112159" author="edivad" created="Fri, 22 Jan 2016 09:21:11 +0000"  >&lt;p&gt;Bulk close for 1.3.14&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12949943">OAK-4125</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12782046" name="OAK_3872.patch" size="3188" author="reschke" created="Wed, 13 Jan 2016 12:40:12 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 43 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2r7z3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>