<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:39:41 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-992] NPE when running FlatTreeWithAceForSamePrincipalTest on MongoMK</title>
                <link>https://issues.apache.org/jira/browse/OAK-992</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;Running &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;benchmark FlatTreeWithAceForSamePrincipalTest Oak-Mongo
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;results in a NPE &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; after a couple of minutes.&lt;/p&gt;

&lt;p&gt;My initial analysis showed that &lt;tt&gt;MicroKernel.getNodes()&lt;/tt&gt; returns &lt;tt&gt;null&lt;/tt&gt; in &lt;tt&gt;KernelNodeState.init()&lt;/tt&gt;. The requested revision was &lt;tt&gt;br140e35028e6-0-1&lt;/tt&gt;, AFAICS a branch revision that doesn&apos;t exist any more.&lt;/p&gt;

&lt;p&gt;Looking at the base state in &lt;tt&gt;KernelNodeStoreBranch.InMemory.merge()&lt;/tt&gt; a couple of stack frames below I found the following:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;base = /@r140e350df05-0-1 children: 5 id: /@r140e350df05-0-1 ...
base.getChildNode(&lt;span class=&quot;code-quote&quot;&gt;&quot;a&quot;&lt;/span&gt;) = /a@r140e350df05-0-1 children: 9223372036854775807 id: /a@r140e350df05-0-1 ...
base.getChildNode(&lt;span class=&quot;code-quote&quot;&gt;&quot;a&quot;&lt;/span&gt;).getChildNode(&lt;span class=&quot;code-quote&quot;&gt;&quot;node9285&quot;&lt;/span&gt;) = /a/node9285@br140e35028e6-0-1 children: 1 id: /a/node9285@r140e34fdff7-0-1 ...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Obviously obtaining child &lt;tt&gt;node9285&lt;/tt&gt; from &lt;tt&gt;/a&lt;/tt&gt; switches from a trunk revision to a branch revision. This look suspicious.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;java.lang.NullPointerException
	at org.apache.jackrabbit.mk.json.JsopTokenizer.&amp;lt;init&amp;gt;(JsopTokenizer.java:41)
	at org.apache.jackrabbit.mk.json.JsopTokenizer.&amp;lt;init&amp;gt;(JsopTokenizer.java:47)
	at org.apache.jackrabbit.oak.kernel.KernelNodeState.init(KernelNodeState.java:160)
	at org.apache.jackrabbit.oak.kernel.KernelNodeState.getProperty(KernelNodeState.java:251)
	at org.apache.jackrabbit.oak.spi.state.AbstractNodeState.getName(AbstractNodeState.java:88)
	at org.apache.jackrabbit.oak.plugins.index.property.PropertyIndexEditor.isOfMatchingType(PropertyIndexEditor.java:165)
	at org.apache.jackrabbit.oak.plugins.index.property.PropertyIndexEditor.enter(PropertyIndexEditor.java:189)
	at org.apache.jackrabbit.oak.spi.commit.VisibleEditor.enter(VisibleEditor.java:58)
	at org.apache.jackrabbit.oak.spi.commit.CompositeEditor.enter(CompositeEditor.java:66)
	at org.apache.jackrabbit.oak.spi.commit.EditorDiff.process(EditorDiff.java:49)
	at org.apache.jackrabbit.oak.spi.commit.EditorDiff.childNodeDeleted(EditorDiff.java:141)
	at org.apache.jackrabbit.oak.plugins.memory.EmptyNodeState.compareAgainstBaseState(EmptyNodeState.java:139)
	at org.apache.jackrabbit.oak.spi.commit.EditorDiff.process(EditorDiff.java:52)
	at org.apache.jackrabbit.oak.spi.commit.EditorDiff.childNodeDeleted(EditorDiff.java:141)
	at org.apache.jackrabbit.oak.plugins.memory.EmptyNodeState.compareAgainstBaseState(EmptyNodeState.java:139)
	at org.apache.jackrabbit.oak.spi.commit.EditorDiff.process(EditorDiff.java:52)
	at org.apache.jackrabbit.oak.spi.commit.EditorDiff.childNodeDeleted(EditorDiff.java:141)
	at org.apache.jackrabbit.oak.plugins.memory.ModifiedNodeState.compareAgainstBaseState(ModifiedNodeState.java:380)
	at org.apache.jackrabbit.oak.spi.commit.EditorDiff.process(EditorDiff.java:52)
	at org.apache.jackrabbit.oak.spi.commit.EditorHook.processCommit(EditorHook.java:50)
	at org.apache.jackrabbit.oak.spi.commit.CompositeHook.processCommit(CompositeHook.java:59)
	at org.apache.jackrabbit.oak.spi.commit.CompositeHook.processCommit(CompositeHook.java:59)
	at org.apache.jackrabbit.oak.kernel.KernelNodeStoreBranch$InMemory.merge(KernelNodeStoreBranch.java:287)
	at org.apache.jackrabbit.oak.kernel.KernelNodeStoreBranch.merge(KernelNodeStoreBranch.java:136)
	at org.apache.jackrabbit.oak.core.AbstractRoot$2.run(AbstractRoot.java:245)
	at org.apache.jackrabbit.oak.core.AbstractRoot$2.run(AbstractRoot.java:241)
	at java.security.AccessController.doPrivileged(Native Method)
	at javax.security.auth.Subject.doAs(Subject.java:337)
	at org.apache.jackrabbit.oak.core.AbstractRoot.commit(AbstractRoot.java:240)
	at org.apache.jackrabbit.oak.jcr.delegate.SessionDelegate.save(SessionDelegate.java:281)
	at org.apache.jackrabbit.oak.jcr.SessionImpl$8.perform(SessionImpl.java:394)
	at org.apache.jackrabbit.oak.jcr.SessionImpl$8.perform(SessionImpl.java:391)
	at org.apache.jackrabbit.oak.jcr.delegate.SessionDelegate.perform(SessionDelegate.java:117)
	at org.apache.jackrabbit.oak.jcr.SessionImpl.perform(SessionImpl.java:117)
	at org.apache.jackrabbit.oak.jcr.SessionImpl.save(SessionImpl.java:391)
	at org.apache.jackrabbit.oak.benchmark.FlatTreeWithAceForSamePrincipalTest.afterSuite(FlatTreeWithAceForSamePrincipalTest.java:89)
	at org.apache.jackrabbit.oak.benchmark.AbstractTest.tearDown(AbstractTest.java:165)
	at org.apache.jackrabbit.oak.benchmark.FlatTreeWithAceForSamePrincipalTest.tearDown(FlatTreeWithAceForSamePrincipalTest.java:31)
	at org.apache.jackrabbit.oak.benchmark.AbstractTest.runTest(AbstractTest.java:130)
	at org.apache.jackrabbit.oak.benchmark.AbstractTest.run(AbstractTest.java:91)
	at org.apache.jackrabbit.oak.benchmark.FlatTreeWithAceForSamePrincipalTest.run(FlatTreeWithAceForSamePrincipalTest.java:31)
	at org.apache.jackrabbit.oak.benchmark.BenchmarkRunner.main(BenchmarkRunner.java:126)
	at org.apache.jackrabbit.oak.run.Main.main(Main.java:61)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12666683">OAK-992</key>
            <summary>NPE when running FlatTreeWithAceForSamePrincipalTest on MongoMK</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mreutegg">Marcel Reutegger</assignee>
                                    <reporter username="mduerig">Michael D&#252;rig</reporter>
                        <labels>
                    </labels>
                <created>Tue, 3 Sep 2013 11:57:07 +0000</created>
                <updated>Fri, 20 Sep 2013 07:01:38 +0000</updated>
                            <resolved>Thu, 12 Sep 2013 08:35:29 +0000</resolved>
                                    <version>0.8</version>
                                    <fixVersion>0.9</fixVersion>
                                    <component>core</component>
                    <component>mongomk</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13756547" author="mduerig" created="Tue, 3 Sep 2013 12:14:17 +0000"  >&lt;p&gt;Seems like the &lt;tt&gt;NodeState&lt;/tt&gt; cache gets somehow corrupted:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;base.getChildNode(&lt;span class=&quot;code-quote&quot;&gt;&quot;a&quot;&lt;/span&gt;).cache.getIfPresent(&lt;span class=&quot;code-quote&quot;&gt;&quot;r140e350df05-0-1/a/node9285&quot;&lt;/span&gt;) = /a/node9285@br140e35028e6-0-1 children: 1 id: /a/node9285@r140e34fdff7-0-1 ...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;That is, the revision of the node state in the cache differs from its key.&lt;/p&gt;</comment>
                            <comment id="13756550" author="mduerig" created="Tue, 3 Sep 2013 12:18:05 +0000"  >&lt;p&gt;I remember overhearing a discussion that the MongoMK internally &quot;reuses&quot; branch revisions as real revisions after a merge somehow transmogrifying them along the way. Could this be causing the observed cache corruption?&lt;/p&gt;</comment>
                            <comment id="13764222" author="mreutegg" created="Wed, 11 Sep 2013 11:35:04 +0000"  >&lt;p&gt;The state of branch commit revisions are indeed changed on merge. This was introduced with &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-893&quot; title=&quot;MongoMK may fail with MicroKernelException under concurrent commits&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-893&quot;&gt;&lt;del&gt;OAK-893&lt;/del&gt;&lt;/a&gt;. This issue also describes in more detail how it works. The problem now is that the branch commits become invalid from a branch point of view after the merge.&lt;/p&gt;

&lt;p&gt;I added a simple test case in &lt;a href=&quot;http://svn.apache.org/r1521805&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1521805&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13764231" author="mduerig" created="Wed, 11 Sep 2013 11:49:27 +0000"  >&lt;blockquote&gt;&lt;p&gt;The problem now is that the branch commits become invalid from a branch point of view after the merge.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I don&apos;t think this is a problem per se. So far we didn&apos;t state anything about the life time of branch revisions and having them disappear after a merge sounds reasonable. However, if we decide to go with that, we need to fix code relying on stable cache revisions (e.g. the node state cache).&lt;/p&gt;</comment>
                            <comment id="13765277" author="mreutegg" created="Thu, 12 Sep 2013 08:35:29 +0000"  >&lt;p&gt;Fixed in &lt;a href=&quot;http://svn.apache.org/r1522482&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1522482&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13772770" author="alex.parvulescu" created="Fri, 20 Sep 2013 07:01:38 +0000"  >&lt;p&gt;Bulk close for the 0.9 release&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>346621</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 9 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1nrrz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>346922</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>