<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:53:08 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-3374] Concurrent Updates of Group&apos;s Membership Results in Conflict</title>
                <link>https://issues.apache.org/jira/browse/OAK-3374</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;when concurrently updating the &lt;em&gt;rep:members&lt;/em&gt; property of a group principal, a merge conflict occurs:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Caused by: org.apache.jackrabbit.oak.api.CommitFailedException: OakState0001: Unresolved conflicts in /home/groups/a/administrators
	at org.apache.jackrabbit.oak.plugins.commit.ConflictValidator.failOnMergeConflict(ConflictValidator.java:84)
	at org.apache.jackrabbit.oak.plugins.commit.ConflictValidator.propertyChanged(ConflictValidator.java:60)
	at org.apache.jackrabbit.oak.spi.commit.CompositeEditor.propertyChanged(CompositeEditor.java:91)
	at org.apache.jackrabbit.oak.spi.commit.EditorDiff.propertyChanged(EditorDiff.java:93)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeState.compareProperties(SegmentNodeState.java:596)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeState.compareAgainstBaseState(SegmentNodeState.java:456)
	at org.apache.jackrabbit.oak.spi.commit.EditorDiff.childNodeChanged(EditorDiff.java:148)
	at org.apache.jackrabbit.oak.plugins.segment.MapRecord.compare(MapRecord.java:418)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeState.compareAgainstBaseState(SegmentNodeState.java:583)
	at org.apache.jackrabbit.oak.spi.commit.EditorDiff.childNodeChanged(EditorDiff.java:148)
	at org.apache.jackrabbit.oak.plugins.segment.MapRecord.compare(MapRecord.java:418)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeState.compareAgainstBaseState(SegmentNodeState.java:583)
	at org.apache.jackrabbit.oak.spi.commit.EditorDiff.childNodeChanged(EditorDiff.java:148)
	at org.apache.jackrabbit.oak.plugins.segment.MapRecord.compare(MapRecord.java:418)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeState.compareAgainstBaseState(SegmentNodeState.java:583)
	at org.apache.jackrabbit.oak.spi.commit.EditorDiff.childNodeChanged(EditorDiff.java:148)
	at org.apache.jackrabbit.oak.plugins.segment.MapRecord.compare(MapRecord.java:487)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeState.compareAgainstBaseState(SegmentNodeState.java:583)
	at org.apache.jackrabbit.oak.spi.commit.EditorDiff.process(EditorDiff.java:52)
	at org.apache.jackrabbit.oak.spi.commit.EditorHook.processCommit(EditorHook.java:54)
	at org.apache.jackrabbit.oak.spi.commit.CompositeHook.processCommit(CompositeHook.java:61)
	at org.apache.jackrabbit.oak.spi.commit.CompositeHook.processCommit(CompositeHook.java:61)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeStore$Commit.prepare(SegmentNodeStore.java:405)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeStore$Commit.optimisticMerge(SegmentNodeStore.java:428)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeStore$Commit.execute(SegmentNodeStore.java:484)
	at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeStore.merge(SegmentNodeStore.java:162)
	at org.apache.jackrabbit.oak.spi.state.ProxyNodeStore.merge(ProxyNodeStore.java:43)
	at org.apache.jackrabbit.oak.core.MutableRoot.commit(MutableRoot.java:247)
	at org.apache.jackrabbit.oak.jcr.delegate.SessionDelegate.commit(SessionDelegate.java:313)
	at org.apache.jackrabbit.oak.jcr.delegate.SessionDelegate.save(SessionDelegate.java:459)
	... 77 common frames omitted
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12862399">OAK-3374</key>
            <summary>Concurrent Updates of Group&apos;s Membership Results in Conflict</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="stillalex">Alex Deparvu</assignee>
                                    <reporter username="dominique.jaeggi">Dominique J&#228;ggi</reporter>
                        <labels>
                    </labels>
                <created>Tue, 8 Sep 2015 12:28:34 +0000</created>
                <updated>Fri, 15 Feb 2019 15:13:03 +0000</updated>
                            <resolved>Wed, 28 Jun 2017 15:04:47 +0000</resolved>
                                    <version>1.3.5</version>
                                    <fixVersion>1.7.3</fixVersion>
                    <fixVersion>1.8.0</fixVersion>
                                    <component>core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="14734730" author="dominique.jaeggi" created="Tue, 8 Sep 2015 12:30:16 +0000"  >&lt;p&gt;i will implement a test case and a conflict handler for this particular use-case&lt;/p&gt;</comment>
                            <comment id="14734933" author="dominique.jaeggi" created="Tue, 8 Sep 2015 14:54:53 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mreutegg&quot; class=&quot;user-hover&quot; rel=&quot;mreutegg&quot;&gt;mreutegg&lt;/a&gt;, could you kindly review this patch, as discussed?&lt;/p&gt;</comment>
                            <comment id="14734956" author="dominique.jaeggi" created="Tue, 8 Sep 2015 15:06:04 +0000"  >&lt;p&gt;replaced broken patch&lt;/p&gt;</comment>
                            <comment id="14735771" author="alexander.klimetschek" created="Tue, 8 Sep 2015 22:44:09 +0000"  >&lt;p&gt;The case where this easily occurs is when different threads/requests are adding users to the same group at the same time (for example, onboarding users from an external system via oauth, and putting them into some application group).&lt;/p&gt;

&lt;p&gt;The current patch&apos;s conflict handler is conservative and will only keep members that are in both sets (from all I can see, just looked at the code, haven&apos;t tested it). This means that if in the above case 2 requests conflict (with 2 different users added), these 2 users would NOT become members after the conflict resolution, since each request = session state does not have the other&apos;s request member. This would not be good for the use case &#8211; currently, the session save fails due to the conflict, so this issue is visible, with such a conflict handler it would silently get dropped and all you see is that membership updates never came through.&lt;/p&gt;

&lt;p&gt;One would need a three-way merge with a common baseline, so it&apos;s obvious each request does an ADD compared to the baseline (with a different user) and they can be clearly separated from an (ADD userA) and (ADD userB + DELETE userA) case (which should end up with the &quot;safe&quot; state of userB not being a member). But I don&apos;t really know how the oak conflict handlers work...&lt;/p&gt;</comment>
                            <comment id="14736669" author="dominique.jaeggi" created="Wed, 9 Sep 2015 11:06:54 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=alexander.klimetschek&quot; class=&quot;user-hover&quot; rel=&quot;alexander.klimetschek&quot;&gt;alexander.klimetschek&lt;/a&gt;, yes, a three-way merge would be ideal for change-change situations. unfortunately oak does not yet provide common ancestor information to &lt;em&gt;ConflictHandlers&lt;/em&gt;. see &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-3381&quot; title=&quot;Provide Common Ancestor To ConflictHandler&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-3381&quot;&gt;&lt;del&gt;OAK-3381&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14737169" author="alexander.klimetschek" created="Wed, 9 Sep 2015 16:46:10 +0000"  >&lt;p&gt;Do we have an alternative? Synchronizing membership updates, at the cost of concurrent write performance?&lt;/p&gt;</comment>
                            <comment id="14904658" author="anchela" created="Wed, 23 Sep 2015 15:26:17 +0000"  >&lt;p&gt;that seems like the proper way to go anyway. it&apos;s not limited to group membership but might occur with any other multivalue property (thinking of &lt;tt&gt;jcr:successors&lt;/tt&gt; or &lt;tt&gt;jcr:predecessors&lt;/tt&gt; in versioning, &lt;tt&gt;:childOrder&lt;/tt&gt; used to keep track of order of orderable child nodes; the latter being particularly nasty as it is not even visible on the JCR/Oak API).&lt;/p&gt;</comment>
                            <comment id="16055370" author="alex.parvulescu" created="Tue, 20 Jun 2017 08:42:06 +0000"  >&lt;p&gt;I have updated the rep:members patch to match &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-3381&quot; title=&quot;Provide Common Ancestor To ConflictHandler&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-3381&quot;&gt;&lt;del&gt;OAK-3381&lt;/del&gt;&lt;/a&gt;, wip branch can be seen here &lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://github.com/apache/jackrabbit-oak/compare/trunk...stillalex:oak-3374&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/jackrabbit-oak/compare/trunk...stillalex:oak-3374&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16062780" author="alex.parvulescu" created="Mon, 26 Jun 2017 08:39:02 +0000"  >&lt;p&gt;attaching final patch. @anchela, feedback appreciated whenever you have some spare cycles!&lt;/p&gt;</comment>
                            <comment id="16063337" author="anchela" created="Mon, 26 Jun 2017 16:15:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stillalex&quot; class=&quot;user-hover&quot; rel=&quot;stillalex&quot;&gt;stillalex&lt;/a&gt;, sorry... missed it as the mentioning didn&apos;t seem to work above. will look at it tomorrow.&lt;/p&gt;</comment>
                            <comment id="16064730" author="anchela" created="Tue, 27 Jun 2017 12:16:45 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stillalex&quot; class=&quot;user-hover&quot; rel=&quot;stillalex&quot;&gt;stillalex&lt;/a&gt;, while the &lt;tt&gt;RepMembersConflictHandler&lt;/tt&gt; looks very good to me, I don&apos;t think that hardcoding the handler of a given user management implementation with the &lt;tt&gt;JcrConflictHandler&lt;/tt&gt; is desirable....  if we had oak-core properly modularized at this point the &lt;tt&gt;JcrConflictHandler&lt;/tt&gt; would not be able to see it anyway... &lt;/p&gt;

&lt;p&gt;So, I would rather suggest that we extend the &lt;tt&gt;SecurityConfiguration&lt;/tt&gt; interface such that it allows a given security module to define it&apos;s own &lt;tt&gt;ConflictHandler&lt;/tt&gt; implementations. The &lt;tt&gt;SecurityConfiguration.Default&lt;/tt&gt; could provide an &apos;empty&apos; version, such that we only had to touch the &lt;tt&gt;UserConfigurationImpl&lt;/tt&gt; and expose the new &lt;tt&gt;RepMembersConflictHandler&lt;/tt&gt; there. I didn&apos;t check where the security-conflict-handlers would be grabbed and merged together with the other conflict handlers... gut feeling would be that this happens where the commithooks are collected upon &lt;tt&gt;Root.commit&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;wdyt?&lt;/p&gt;</comment>
                            <comment id="16066498" author="anchela" created="Wed, 28 Jun 2017 13:44:54 +0000"  >&lt;p&gt;updated patch containing the proposed extension of the &lt;tt&gt;SecurityConfiguration&lt;/tt&gt;. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stillalex&quot; class=&quot;user-hover&quot; rel=&quot;stillalex&quot;&gt;stillalex&lt;/a&gt;, i managed to adjust &lt;tt&gt;Oak&lt;/tt&gt; utility such that all tests pass, but i still have a somewhat bad feeling regarding the {{Conflicthandler}}s that apparently needed to be &lt;em&gt;inserted&lt;/em&gt; at the right point in the Oak setup.&lt;/p&gt;</comment>
                            <comment id="16066570" author="alex.parvulescu" created="Wed, 28 Jun 2017 14:22:57 +0000"  >&lt;blockquote&gt;&lt;p&gt;updated patch containing the proposed extension of the SecurityConfiguration&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;+1 looks good!&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;but i still have a somewhat bad feeling regarding the {{Conflicthandler}}s that apparently needed to be inserted at the right point in the Oak setup.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;yes, I think we&apos;ll have to clarify that as a part of &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-3382&quot; title=&quot;Improve Registration Of ConflictHandlers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-3382&quot;&gt;OAK-3382&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16066639" author="alex.parvulescu" created="Wed, 28 Jun 2017 15:04:47 +0000"  >&lt;p&gt;I applied &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=anchela&quot; class=&quot;user-hover&quot; rel=&quot;anchela&quot;&gt;anchela&lt;/a&gt;&apos;s patch with &lt;a href=&quot;http://svn.apache.org/viewvc?rev=1800179&amp;amp;view=rev&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?rev=1800179&amp;amp;view=rev&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16076713" author="edivad" created="Thu, 6 Jul 2017 15:34:04 +0000"  >&lt;p&gt;Bulk close for 1.7.3&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                                                <inwardlinks description="is blocked by">
                                        <issuelink>
            <issuekey id="12862727">OAK-3381</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12739114">OAK-2076</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12739114">OAK-2076</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12862728">OAK-3382</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13216010">OAK-8054</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12874874" name="OAK-3374-2.patch" size="33484" author="angela" created="Wed, 28 Jun 2017 13:43:07 +0000"/>
                            <attachment id="12874452" name="OAK-3374.patch" size="17861" author="stillalex" created="Mon, 26 Jun 2017 08:38:06 +0000"/>
                            <attachment id="12754655" name="OAK-3374_-_Concurrent_Updates_of_Group_s_Membership_Results_in_Conflict.patch" size="15351" author="dominique.jaeggi" created="Tue, 8 Sep 2015 15:06:04 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 19 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2jvx3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>