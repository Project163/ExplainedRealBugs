<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:51:50 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-4912] MongoDB: ReadPreferenceIT.testMongoReadPreferencesForLocalChanges() occasionally fails</title>
                <link>https://issues.apache.org/jira/browse/OAK-4912</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;testMongoReadPreferencesForLocalChanges(org.apache.jackrabbit.oak.plugins.document.mongo.ReadPreferenceIT)  Time elapsed: 0.024 sec  &amp;lt;&amp;lt;&amp;lt; FAILURE!
java.lang.AssertionError: expected:&amp;lt;secondary&amp;gt; but was:&amp;lt;primary&amp;gt;
        at org.junit.Assert.fail(Assert.java:88)
        at org.junit.Assert.failNotEquals(Assert.java:834)
        at org.junit.Assert.assertEquals(Assert.java:118)
        at org.junit.Assert.assertEquals(Assert.java:144)
        at org.apache.jackrabbit.oak.plugins.document.mongo.ReadPreferenceIT.testMongoReadPreferencesForLocalChanges(ReadPreferenceIT.java:195)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13011012">OAK-4912</key>
            <summary>MongoDB: ReadPreferenceIT.testMongoReadPreferencesForLocalChanges() occasionally fails</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tomek.rekawek">Tomek R&#281;kawek</assignee>
                                    <reporter username="reschke">Julian Reschke</reporter>
                        <labels>
                    </labels>
                <created>Mon, 10 Oct 2016 12:15:52 +0000</created>
                <updated>Mon, 12 Dec 2016 14:36:59 +0000</updated>
                            <resolved>Fri, 25 Nov 2016 10:19:13 +0000</resolved>
                                    <version>1.5.5</version>
                                    <fixVersion>1.5.15</fixVersion>
                    <fixVersion>1.6.0</fixVersion>
                                    <component>core</component>
                    <component>mongomk</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15632357" author="tomek.rekawek" created="Thu, 3 Nov 2016 10:48:24 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=reschke&quot; class=&quot;user-hover&quot; rel=&quot;reschke&quot;&gt;reschke&lt;/a&gt;, I&apos;ve run this test in a loop on a Windows machine, but wasn&apos;t able to reproduce the issue. Could you share the details about the Mongo server and the Java version?&lt;/p&gt;</comment>
                            <comment id="15632640" author="reschke" created="Thu, 3 Nov 2016 12:51:43 +0000"  >&lt;p&gt;Currently it doesn&apos;t seem to fail.&lt;/p&gt;

&lt;p&gt;My setup hasn&apos;t changed, though: Java 1.7.0_80, Mongo db version v2.6.11&lt;/p&gt;</comment>
                            <comment id="15632925" author="tomek.rekawek" created="Thu, 3 Nov 2016 14:41:39 +0000"  >&lt;p&gt;Too bad we can&apos;t reproduce it. Resolving for now, feel free to re-open the issue if the bug appears again.&lt;/p&gt;</comment>
                            <comment id="15632994" author="reschke" created="Thu, 3 Nov 2016 15:00:16 +0000"  >&lt;p&gt;ok.&lt;/p&gt;</comment>
                            <comment id="15683219" author="reschke" created="Mon, 21 Nov 2016 11:04:47 +0000"  >&lt;p&gt;(it just recurred for me)&lt;/p&gt;</comment>
                            <comment id="15694519" author="catholicon" created="Fri, 25 Nov 2016 00:56:00 +0000"  >&lt;p&gt;Btw, here&apos;s a hint (sorry couldn&apos;t investigate further). Doing this&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;diff --git a/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/mongo/replica/ReplicaSetInfo.java b/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/mongo/replica/ReplicaSetInfo.java
index abeba8a..4f95691 100644
--- a/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/mongo/replica/ReplicaSetInfo.java
+++ b/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/mongo/replica/ReplicaSetInfo.java
@@ -158,6 +158,10 @@ public class ReplicaSetInfo implements Runnable {
                     break;
                 }
             }
+            try {
+                Thread.sleep(100);
+            } catch (InterruptedException e) {
+            }
         }
         LOG.debug(&quot;Stopping the replica set info&quot;);
         nodeCollections.close();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;made the test for me once (and the test was excruciatingly slow). Subsequently, for some reason, it seemed that sleep wasn&apos;t working anymore. So, I added a breakpoint at Thread.sleep to almost immediately continue it and the thread failed every time.&lt;/p&gt;

&lt;p&gt;I know this is very hacky but probably does indeed show some dependence on thread scheduling. Hope it helps though.&lt;/p&gt;</comment>
                            <comment id="15695485" author="tomek.rekawek" created="Fri, 25 Nov 2016 10:19:01 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vikas&quot; class=&quot;user-hover&quot; rel=&quot;vikas&quot;&gt;vikas&lt;/a&gt;, thanks for investigating this! Your comment helped me find the root cause - if the background read happens before the last assert in testMongoReadPreferencesForLocalChanges, it updates the &lt;tt&gt;MongoDocumentStore#mostRecentAccessedRevisions&lt;/tt&gt; with the revision numbers taken from the second DocumentMK instance. They were not present in the simulated replica set and hence the error.&lt;/p&gt;

&lt;p&gt;I&apos;ve made the problem fully reproducible (by putting the offending assert in a loop with 5 millis delay between iterations) and fixed it by adding second DocumentMK revisions to the simulated replica set info.&lt;/p&gt;

&lt;p&gt;Fixed in &lt;a href=&quot;https://svn.apache.org/r1771274&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;r1771274&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="15742160" author="edivad" created="Mon, 12 Dec 2016 14:36:58 +0000"  >&lt;p&gt;Bulk close for 1.5.15&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                                                <inwardlinks description="is broken by">
                                        <issuelink>
            <issuekey id="12929498">OAK-3865</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 48 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i34o1z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>