<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:52:25 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-5601] documentMk backgroundRead should handle missing journal entries</title>
                <link>https://issues.apache.org/jira/browse/OAK-5601</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;The following exception has been encountered:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;03.02.2017 02:39:08.068 *WARN* [DocumentNodeStore background read thread (1)] org.apache.jackrabbit.oak.plugins.document.DocumentNodeStore Background operation failed: java.lang.IllegalStateException: M
issing external change for branch revision: b3-00000159f839b963-00000000
java.lang.IllegalStateException: Missing external change for branch revision: b3-00000159f839b963-00000000
        at org.apache.jackrabbit.oak.plugins.document.JournalEntry$3$1.computeNext(JournalEntry.java:321)
        at org.apache.jackrabbit.oak.plugins.document.JournalEntry$3$1.computeNext(JournalEntry.java:309)
        at com.google.common.collect.AbstractIterator.tryToComputeNext(AbstractIterator.java:143)
        at com.google.common.collect.AbstractIterator.hasNext(AbstractIterator.java:138)
        at org.apache.jackrabbit.oak.plugins.document.JournalEntry.addTo(JournalEntry.java:287)
        at org.apache.jackrabbit.oak.plugins.document.JournalEntry.fillExternalChanges(JournalEntry.java:210)
        at org.apache.jackrabbit.oak.plugins.document.DocumentNodeStore.backgroundRead(DocumentNodeStore.java:1813)
        at org.apache.jackrabbit.oak.plugins.document.DocumentNodeStore.internalRunBackgroundReadOperations(DocumentNodeStore.java:1702)
        at org.apache.jackrabbit.oak.plugins.document.DocumentNodeStore.runBackgroundReadOperations(DocumentNodeStore.java:1687)
        at org.apache.jackrabbit.oak.plugins.document.DocumentNodeStore$BackgroundReadOperation.execute(DocumentNodeStore.java:2633)
        at org.apache.jackrabbit.oak.plugins.document.DocumentNodeStore$NodeStoreTask.run(DocumentNodeStore.java:2592)
        at java.lang.Thread.run(Thread.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;That revision b3-00000159f839b963-00000000 corresponds to 1485928249699ns == 2017-02-01T05:50:49+00:00, which means the revision that the backgroundRead is trying to read here is 21 hours old.&lt;/p&gt;

&lt;p&gt;The default journal GC maxAge is 6 hours though.&lt;/p&gt;

&lt;p&gt;When it tries to read an old revision that is already deleted it &lt;a href=&quot;https://github.com/apache/jackrabbit-oak/blob/jackrabbit-oak-1.4.1/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/JournalEntry.java#L321&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;throws an IllegalStateException&lt;/a&gt;. That one is not caught properly, except in &lt;a href=&quot;https://github.com/apache/jackrabbit-oak/blob/jackrabbit-oak-1.4.1/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/DocumentNodeStore.java#L2593&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;NodeStoreTask.run&lt;/a&gt;. &lt;/p&gt;

&lt;p&gt;This means the backgroundRead has failed, with a warn, and will be retried 1 second later. Just that nothing has changed, the journal entry can still not be found, so the same warning is issued. &lt;/p&gt;

&lt;p&gt;Resulting in the situation that the backgroundRead will never recover.&lt;/p&gt;

&lt;p&gt;That &lt;tt&gt;IllegalStateException&lt;/tt&gt; should be caught &lt;a href=&quot;https://github.com/apache/jackrabbit-oak/blob/jackrabbit-oak-1.4.1/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/DocumentNodeStore.java#L1814&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;when calling fillExternalChanges&lt;/a&gt;, resulting in a fall-back to not reading from the journal but going the old route.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13041335">OAK-5601</key>
            <summary>documentMk backgroundRead should handle missing journal entries</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="stefanegli">Stefan Egli</assignee>
                                    <reporter username="stefanegli">Stefan Egli</reporter>
                        <labels>
                    </labels>
                <created>Wed, 8 Feb 2017 09:50:01 +0000</created>
                <updated>Wed, 22 Feb 2017 09:52:04 +0000</updated>
                            <resolved>Wed, 8 Feb 2017 15:27:07 +0000</resolved>
                                    <version>1.0.36</version>
                    <version>1.2.23</version>
                    <version>1.4.1</version>
                    <version>1.6.0</version>
                                    <fixVersion>1.0.37</fixVersion>
                    <fixVersion>1.2.24</fixVersion>
                    <fixVersion>1.4.14</fixVersion>
                    <fixVersion>1.7.0</fixVersion>
                    <fixVersion>1.6.1</fixVersion>
                    <fixVersion>1.8.0</fixVersion>
                                    <component>core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15857740" author="egli" created="Wed, 8 Feb 2017 09:50:44 +0000"  >&lt;p&gt;/fyi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mreutegg&quot; class=&quot;user-hover&quot; rel=&quot;mreutegg&quot;&gt;mreutegg&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chetanm&quot; class=&quot;user-hover&quot; rel=&quot;chetanm&quot;&gt;chetanm&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=catholicon&quot; class=&quot;user-hover&quot; rel=&quot;catholicon&quot;&gt;catholicon&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=reschke&quot; class=&quot;user-hover&quot; rel=&quot;reschke&quot;&gt;reschke&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15857748" author="egli" created="Wed, 8 Feb 2017 09:56:57 +0000"  >&lt;p&gt;Attached a suggested patch: &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12851600/12851600_OAK-5601.patch&quot; title=&quot;OAK-5601.patch attached to OAK-5601&quot;&gt;OAK-5601.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; (based on trunk)&lt;/p&gt;</comment>
                            <comment id="15857752" author="mreutegg" created="Wed, 8 Feb 2017 10:03:52 +0000"  >&lt;p&gt;+1 for the patch. Can you please also open an issue for the missing journal entry?&lt;/p&gt;</comment>
                            <comment id="15857755" author="egli" created="Wed, 8 Feb 2017 10:04:53 +0000"  >&lt;p&gt;Looking into a test case next.&lt;/p&gt;</comment>
                            <comment id="15857761" author="egli" created="Wed, 8 Feb 2017 10:08:28 +0000"  >&lt;blockquote&gt;&lt;p&gt;Can you please also open an issue for the missing journal entry?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mreutegg&quot; class=&quot;user-hover&quot; rel=&quot;mreutegg&quot;&gt;mreutegg&lt;/a&gt;, what did you have in mind there? At least in this case that IllegalStateExeption seems legitimate. Or did you want to avoid throwing the exception in general?&lt;/p&gt;</comment>
                            <comment id="15857777" author="mreutegg" created="Wed, 8 Feb 2017 10:17:23 +0000"  >&lt;p&gt;I think the implementation shouldn&apos;t get into a situation where it doesn&apos;t find journal entries that are still referenced. So, the question is, how can we avoid this situation? Maybe the JournalGC needs an improvement. This is what I would like to discuss in the new issue.&lt;/p&gt;</comment>
                            <comment id="15857791" author="egli" created="Wed, 8 Feb 2017 10:23:28 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mreutegg&quot; class=&quot;user-hover&quot; rel=&quot;mreutegg&quot;&gt;mreutegg&lt;/a&gt; good point, and I think we had this already in mind actually. I&apos;ve created &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-5602&quot; title=&quot;Avoid missing journal entries&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-5602&quot;&gt;&lt;del&gt;OAK-5602&lt;/del&gt;&lt;/a&gt; for this.&lt;/p&gt;</comment>
                            <comment id="15857858" author="catholicon" created="Wed, 8 Feb 2017 11:32:57 +0000"  >&lt;p&gt;While I see that we need to handle the situation gracefully, but I was wondering how did the setup get to this state - backgroundRead lagging by ~21hours. Is that expected? Imo, that case itself is a sign of something awful going on in the setup.&lt;/p&gt;

&lt;p&gt;+1 for the patch to safe-guard here.&lt;/p&gt;

&lt;p&gt;Btw, may be we should also see that &lt;tt&gt;JournalDiffLoader&lt;/tt&gt; (&lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-4528&quot; title=&quot;diff calculation in DocumentNodeStore should try to re-use journal info on diff cache miss&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-4528&quot;&gt;&lt;del&gt;OAK-4528&lt;/del&gt;&lt;/a&gt;) is ok in this case (it&apos;d likely be... but worth to check I guess).&lt;/p&gt;</comment>
                            <comment id="15857883" author="egli" created="Wed, 8 Feb 2017 11:51:27 +0000"  >&lt;blockquote&gt;&lt;p&gt;how did the setup get to this state - backgroundRead lagging by ~21hours.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;it&apos;s a branch commit, so what might happen is that it was a transaction that was open for around 21 hours?&lt;/p&gt;</comment>
                            <comment id="15857917" author="catholicon" created="Wed, 8 Feb 2017 12:20:23 +0000"  >&lt;blockquote&gt;&lt;p&gt;... so what might happen is that it was a transaction that was open for around 21 hours?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Wow!... although, I still feel that there&apos;s some issue to handle such cases - afaics, there&apos;s no/little hope for such a branch commit to work out. It&apos;d likely spend its life in commit-conflict-refresh-rinse-repeat. But, yeah, that&apos;s digression (another issue maybe??). I&apos;m +1 for this change - any external w/f shouldn&apos;t hamper core methods.&lt;/p&gt;</comment>
                            <comment id="15858036" author="egli" created="Wed, 8 Feb 2017 14:15:17 +0000"  >&lt;p&gt;added a (currently ignored) test case that reproduces this issue:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;to trunk: &lt;a href=&quot;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1782178&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;1782178&lt;/a&gt; and &lt;a href=&quot;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1782179&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;1782179&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;to 1.6-branch: &lt;a href=&quot;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1782186&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;1782186&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;to 1.4-branch: &lt;a href=&quot;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1782185&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;1782185&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15858123" author="egli" created="Wed, 8 Feb 2017 15:27:07 +0000"  >&lt;p&gt;fixed:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;in &lt;a href=&quot;http://svn.apache.org/viewvc?rev=1782207&amp;amp;view=rev&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;in &lt;a href=&quot;http://svn.apache.org/viewvc?rev=1782208&amp;amp;view=rev&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;1.6 branch&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;in &lt;a href=&quot;http://svn.apache.org/viewvc?rev=1782210&amp;amp;view=rev&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;1.4 branch&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15858218" author="egli" created="Wed, 8 Feb 2017 16:51:21 +0000"  >&lt;ul&gt;
	&lt;li&gt;added ignored test case to 1.2-branch: &lt;a href=&quot;http://svn.apache.org/viewvc?rev=1782216&amp;amp;view=rev&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;1782216&lt;/a&gt; (plus added missing license header &lt;a href=&quot;http://svn.apache.org/viewvc?rev=1782220&amp;amp;view=rev&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;1782220&lt;/a&gt;)&lt;/li&gt;
	&lt;li&gt;fixed in 1.2-branch: &lt;a href=&quot;http://svn.apache.org/viewvc?rev=1782218&amp;amp;view=rev&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;1782218&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15858272" author="egli" created="Wed, 8 Feb 2017 17:25:14 +0000"  >&lt;ul&gt;
	&lt;li&gt;added ignored test case to 1.0-branch: &lt;a href=&quot;http://svn.apache.org/viewvc?rev=1782221&amp;amp;view=rev&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;1782221&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;fixed in 1.0-branch: &lt;a href=&quot;http://svn.apache.org/viewvc?rev=1782223&amp;amp;view=rev&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;1782223&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15877877" author="dominique.jaeggi" created="Wed, 22 Feb 2017 09:52:04 +0000"  >&lt;p&gt;bulk close 1.0.37&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13041346">OAK-5602</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12851600" name="OAK-5601.patch" size="1256" author="stefanegli" created="Wed, 8 Feb 2017 09:56:57 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 38 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i39s8f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>