<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:52:01 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-5223] SegmentNodeStoreService components don&apos;t unregister with the blobstore</title>
                <link>https://issues.apache.org/jira/browse/OAK-5223</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;There are a few components in the SegmentNodeStoreService (&lt;tt&gt;store&lt;/tt&gt;, &lt;tt&gt;segmentNodeStore&lt;/tt&gt;, &lt;tt&gt;gcMonitor&lt;/tt&gt; and &lt;tt&gt;observerTracker&lt;/tt&gt;) that aren&apos;t unregistered when the blobStore unregisters. So in the case of a blobStore unregister/register situation, they will be recreated but the old ones will not be closed properly.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;edit&amp;#93;&lt;/span&gt; added all components that have a leak problem when the blob store binds/unbinds.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13025598">OAK-5223</key>
            <summary>SegmentNodeStoreService components don&apos;t unregister with the blobstore</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="frm">Francesco Mari</assignee>
                                    <reporter username="stillalex">Alex Deparvu</reporter>
                        <labels>
                    </labels>
                <created>Mon, 5 Dec 2016 10:46:09 +0000</created>
                <updated>Mon, 12 Dec 2016 14:36:41 +0000</updated>
                            <resolved>Wed, 7 Dec 2016 09:53:16 +0000</resolved>
                                                    <fixVersion>1.5.15</fixVersion>
                    <fixVersion>1.6.0</fixVersion>
                                    <component>segment-tar</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15721963" author="alex.parvulescu" created="Mon, 5 Dec 2016 10:59:18 +0000"  >&lt;p&gt;Had a chat with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=frm&quot; class=&quot;user-hover&quot; rel=&quot;frm&quot;&gt;frm&lt;/a&gt; and we cam to the conclusion that this comes from the fact that the reference to the &lt;tt&gt;blobStore&lt;/tt&gt; is dynamic, when it doesn&apos;t really need to be &lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt;, so one very good option is to make it a static reference, to force the entire service to shutdown and activate properly.&lt;/p&gt;


&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://github.com/apache/jackrabbit-oak/blob/trunk/oak-segment-tar/src/main/java/org/apache/jackrabbit/oak/segment/SegmentNodeStoreService.java#L281&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/jackrabbit-oak/blob/trunk/oak-segment-tar/src/main/java/org/apache/jackrabbit/oak/segment/SegmentNodeStoreService.java#L281&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15721997" author="alex.parvulescu" created="Mon, 5 Dec 2016 11:14:47 +0000"  >&lt;p&gt;Spoke to &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chetanm&quot; class=&quot;user-hover&quot; rel=&quot;chetanm&quot;&gt;chetanm&lt;/a&gt;, it seems the better fix is to call &lt;tt&gt;deactivate&lt;/tt&gt; from &lt;tt&gt;unbindBlobStore&lt;/tt&gt;, messing with the reference properties would break the wiring bits and the SegmentNodeStoreService component would not get the blobStore reference once it comes online.&lt;/p&gt;</comment>
                            <comment id="15722383" author="alex.parvulescu" created="Mon, 5 Dec 2016 14:20:03 +0000"  >&lt;p&gt;proposed patch, a very basic approach to move the affected components into the &lt;tt&gt;unregisterNodeStore&lt;/tt&gt; method. I&apos;d prefer to have the entire &lt;tt&gt;unregisterNodeStore&lt;/tt&gt; method synchronized, but I fear we&apos;d be reintroducing deadlocks on deactivation, so I guess this is the safest approach.&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=frm&quot; class=&quot;user-hover&quot; rel=&quot;frm&quot;&gt;frm&lt;/a&gt; feedback appreciated!&lt;/p&gt;</comment>
                            <comment id="15722502" author="frm" created="Mon, 5 Dec 2016 15:13:06 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=alex.parvulescu&quot; class=&quot;user-hover&quot; rel=&quot;alex.parvulescu&quot;&gt;alex.parvulescu&lt;/a&gt;, moving that code to the &lt;tt&gt;unregisterNodeStore&lt;/tt&gt; method is not a bad idea at all. Talking about synchronization, the current implementation is not really following the best practice of not calling into the OSGi framework while holding a lock. I reworked the patch a bit to make it clear what I mean.&lt;/p&gt;

&lt;p&gt;Before calling into the framework - e.g.. directly via &lt;tt&gt;org.osgi.framework.ServiceRegistration#unregister&lt;/tt&gt; or indirectly via &lt;tt&gt;org.apache.jackrabbit.oak.spi.whiteboard.AbstractServiceTracker#stop&lt;/tt&gt; - I copy every item I have to finalize into a stack variable and update the state of the component atomically. Finalization code is then invoked on the thread calling &lt;tt&gt;unregisterNodeStore&lt;/tt&gt; without any lock held.&lt;/p&gt;

&lt;p&gt;The most immediate improvement of this code would be to encapsulate every &lt;tt&gt;unregister&lt;/tt&gt;, &lt;tt&gt;stop&lt;/tt&gt; and &lt;tt&gt;close&lt;/tt&gt; method into its own &lt;tt&gt;Closeable&lt;/tt&gt;, and delegate the cleanup to a &lt;tt&gt;com.google.common.io.Closer&lt;/tt&gt; to make sure that every resource is released properly even in case of error.&lt;/p&gt;</comment>
                            <comment id="15722550" author="alex.parvulescu" created="Mon, 5 Dec 2016 15:33:41 +0000"  >&lt;p&gt;patch looks good! the only aspect we need to clarify is &lt;em&gt;if&lt;/em&gt; we can have concurrent calls to &lt;em&gt;unregisterNodeStore&lt;/em&gt;  and _ registerNodeStore_ (which would mean the fileStore would &lt;tt&gt;close&lt;/tt&gt; and &lt;tt&gt;init&lt;/tt&gt; concurrently on the same path) caused by the blobStore component. it&apos;s unlikely that this is the case, but to be on the safe side, I mention it anyway.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;The most immediate improvement of this code would be to encapsulate every unregister, stop and close method into its own Closeable, and delegate the cleanup to a com.google.common.io.Closer to make sure that every resource is released properly even in case of error.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;good point, let&apos;s do that as a part of &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-5224&quot; title=&quot;SegmentNodeStoreService  should always use the whiteboard to register services&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-5224&quot;&gt;&lt;del&gt;OAK-5224&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15725010" author="frm" created="Tue, 6 Dec 2016 10:12:44 +0000"  >&lt;p&gt;While playing with the patch in a live OSGi deployment, I figured out that setting &lt;tt&gt;segmentNodeStore&lt;/tt&gt; to &lt;tt&gt;null&lt;/tt&gt; immediately before unregistering every service may be problematic.&lt;/p&gt;

&lt;p&gt;The problem is that &lt;tt&gt;SegmentNodeStoreService&lt;/tt&gt; acts as a middleman when a &lt;tt&gt;NodeStore&lt;/tt&gt; or an &lt;tt&gt;Observable&lt;/tt&gt; service is needed. The third version of the patch removes this indirection and registers &lt;tt&gt;segmentNodeStore&lt;/tt&gt; directly: this way the reference to the &lt;tt&gt;NodeStore&lt;/tt&gt; is maintained for the whole lifetime of the registered services.&lt;/p&gt;

&lt;p&gt;For uniformity, I also avoided to use &lt;tt&gt;SegmentNodeStoreService&lt;/tt&gt; as a middleman for &lt;tt&gt;SegmentStoreProvider&lt;/tt&gt;. A &lt;tt&gt;DefaultSegmentStoreProvider&lt;/tt&gt; is created to maintained the reference to a &lt;tt&gt;SegmentStore&lt;/tt&gt; for the lifetime of the &lt;tt&gt;SegmentStoreProvider&lt;/tt&gt; service.&lt;/p&gt;

&lt;p&gt;IMO this makes the implementation of the aforementioned services easier to understand, since we don&apos;t need to track the nullability of the instance variables of &lt;tt&gt;SegmentNodeStoreService&lt;/tt&gt; to understand what they expose and when.&lt;/p&gt;</comment>
                            <comment id="15725014" author="jsedding" created="Tue, 6 Dec 2016 10:14:38 +0000"  >&lt;blockquote&gt;&lt;p&gt;[...] would break the wiring bits and the SegmentNodeStoreService component would not get the blobStore reference once it comes online.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think this is independent of &quot;static&quot; vs &quot;dynamic&quot;, but is rather related to the &quot;policy-option&quot;, which is &quot;reluctant&quot; by default, but can be set to &quot;greedy&quot;, in which case it will bind to a newly available blob store (by first deactivating and then (re)activating the component).&lt;/p&gt;

&lt;p&gt;From the OSGi Compendium Spec R6, 112.3.6.1 Static Reference Policy:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;If the policy-option is greedy then the component configuration must be reactivated when new applicable services be- come available.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Under the circumstances, I would go with a greedy static reference and keep the implementation simple.&lt;/p&gt;</comment>
                            <comment id="15725271" author="frm" created="Tue, 6 Dec 2016 11:55:11 +0000"  >&lt;p&gt;Why would this be a better solution than making the reference static? This reference is not supposed to change often - or at all - since this kind of choice is part of the deployment choices for the &lt;tt&gt;FileStore&lt;/tt&gt;. I argue that having the reference static would simplify our mental model of the &lt;tt&gt;SegmentNodeStoreService&lt;/tt&gt; without having any noticeable impact on the codebase.&lt;/p&gt;</comment>
                            <comment id="15725273" author="frm" created="Tue, 6 Dec 2016 11:56:01 +0000"  >&lt;p&gt;See my comment above. I fully agree.&lt;/p&gt;</comment>
                            <comment id="15725381" author="alex.parvulescu" created="Tue, 6 Dec 2016 12:43:24 +0000"  >&lt;p&gt;Interesting, so this means we can make the reference &lt;em&gt;static&lt;/em&gt;, so the component will be deactivated/reactivated, and also &lt;em&gt;greedy&lt;/em&gt; so it will not ignore blobstores coming online at a later phase. This covers all the cases, and has a bunch of benefits, I like the proposal!&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=frm&quot; class=&quot;user-hover&quot; rel=&quot;frm&quot;&gt;frm&lt;/a&gt; since you are more knowledgeable here, do you mind including the above in your patch and applying it?&lt;/p&gt;</comment>
                            <comment id="15725395" author="frm" created="Tue, 6 Dec 2016 12:46:23 +0000"  >&lt;p&gt;No problem. I will propose another patch for review.&lt;/p&gt;</comment>
                            <comment id="15725595" author="frm" created="Tue, 6 Dec 2016 14:14:24 +0000"  >&lt;p&gt;The fourth version of the patch uses an optional, static, greedy reference for the &lt;tt&gt;BlobStore&lt;/tt&gt;. This allowed me to simplify a bit the code for the &lt;tt&gt;SegmentNodeStoreService&lt;/tt&gt;. &lt;/p&gt;

&lt;p&gt;There is only one caveat. OSGi Mocks, that we use to test the &lt;tt&gt;SegmentNodeStoreService&lt;/tt&gt;, doesn&apos;t seem to play well with static, greedy references. As such, I had to change a couple of tests in oak-core and oak-segment-tar.&lt;/p&gt;</comment>
                            <comment id="15725670" author="alex.parvulescu" created="Tue, 6 Dec 2016 14:33:18 +0000"  >&lt;blockquote&gt;&lt;p&gt;I had to change a couple of tests in oak-core and oak-segment-tar.&lt;/p&gt;&lt;/blockquote&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;     @Test
     public void registerBlobTrackingStore() throws Exception {
+        registerTrackingBlobStore();
         registerNodeStoreService();
-        assertServiceNotActivated();
-        registerTrackingBlobStore();
         assertServiceActivated();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;If I&apos;m not mistaken, even with the new reference binding option, this is still a case we need to support (blobstore coming online after the nodestore). this change looks dangerous to me, even if it&apos;s a OSGi Mocks-related problem, removing the current test means we&apos;re at zero coverage for this scenario (same applies to {SegmentNodeStoreServiceTest}}). what other options do we have?&lt;/p&gt;</comment>
                            <comment id="15725866" author="frm" created="Tue, 6 Dec 2016 15:49:29 +0000"  >&lt;p&gt;This use case still works, but it&apos;s not possible to automatically test it via OSGi Mocks. I verified those cases on a running Felix framework.&lt;/p&gt;</comment>
                            <comment id="15725883" author="alex.parvulescu" created="Tue, 6 Dec 2016 15:55:59 +0000"  >&lt;blockquote&gt;&lt;p&gt;This use case still works, but it&apos;s not possible to automatically test it via OSGi Mocks. I verified those cases on a running Felix framework.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;yes, we agree on that part &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; the point is what can we do to replace those tests with better ones, not simply drop them.&lt;/p&gt;</comment>
                            <comment id="15728085" author="jsedding" created="Wed, 7 Dec 2016 08:13:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=frm&quot; class=&quot;user-hover&quot; rel=&quot;frm&quot;&gt;frm&lt;/a&gt; could you please log a Sling issue for an improvement of OSGi Mocks? I don&apos;t know what the impact would be, but &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sseifert%40pro-vision.de&quot; class=&quot;user-hover&quot; rel=&quot;sseifert@pro-vision.de&quot;&gt;sseifert@pro-vision.de&lt;/a&gt; should be able to assess whether that can be done without major refactoring.&lt;/p&gt;</comment>
                            <comment id="15728136" author="frm" created="Wed, 7 Dec 2016 08:40:22 +0000"  >&lt;p&gt;I logged &lt;a href=&quot;https://issues.apache.org/jira/browse/SLING-6372&quot; title=&quot;OSGi Mocks - Correctly handle static, greedy references&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SLING-6372&quot;&gt;&lt;del&gt;SLING-6372&lt;/del&gt;&lt;/a&gt; tracking this.&lt;/p&gt;</comment>
                            <comment id="15728188" author="alex.parvulescu" created="Wed, 7 Dec 2016 09:06:13 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jsedding&quot; class=&quot;user-hover&quot; rel=&quot;jsedding&quot;&gt;jsedding&lt;/a&gt;! Given the latest developments, I would propose to apply the patch as is and create a new issue (that depends on a proper release of &lt;a href=&quot;https://issues.apache.org/jira/browse/SLING-6372&quot; title=&quot;OSGi Mocks - Correctly handle static, greedy references&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SLING-6372&quot;&gt;&lt;del&gt;SLING-6372&lt;/del&gt;&lt;/a&gt; ) to reintroduce the tests we removed here.&lt;/p&gt;</comment>
                            <comment id="15728197" author="frm" created="Wed, 7 Dec 2016 09:09:04 +0000"  >&lt;p&gt;I have another patch brewing with a new test in oak-pojosr to test the use case that is problematic with OSGi Mocks. The patch should be read in a few minutes.&lt;/p&gt;</comment>
                            <comment id="15728244" author="frm" created="Wed, 7 Dec 2016 09:26:23 +0000"  >&lt;p&gt;The fifth version of the patch is equivalent to the fourth, with the addition of a test case in oak-pojosr asserting the behaviour of &lt;tt&gt;SegmentNodeStoreService&lt;/tt&gt; when an external &lt;tt&gt;BlobStore&lt;/tt&gt; is configured.&lt;/p&gt;</comment>
                            <comment id="15728281" author="alex.parvulescu" created="Wed, 7 Dec 2016 09:40:37 +0000"  >&lt;p&gt;+1 looks good&lt;/p&gt;</comment>
                            <comment id="15728293" author="jsedding" created="Wed, 7 Dec 2016 09:45:08 +0000"  >&lt;p&gt;+1 nice&lt;/p&gt;</comment>
                            <comment id="15728312" author="frm" created="Wed, 7 Dec 2016 09:53:18 +0000"  >&lt;p&gt;Fixed at r1773038.&lt;/p&gt;</comment>
                            <comment id="15742130" author="edivad" created="Mon, 12 Dec 2016 14:36:41 +0000"  >&lt;p&gt;Bulk close for 1.5.15&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="13014252">OAK-4978</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13027428">OAK-5273</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12841759" name="OAK-5223-02.patch" size="3119" author="frm" created="Mon, 5 Dec 2016 15:13:06 +0000"/>
                            <attachment id="12841927" name="OAK-5223-03.patch" size="8958" author="frm" created="Tue, 6 Dec 2016 10:12:44 +0000"/>
                            <attachment id="12841962" name="OAK-5223-04.patch" size="23263" author="frm" created="Tue, 6 Dec 2016 14:14:24 +0000"/>
                            <attachment id="12842127" name="OAK-5223-05.patch" size="28622" author="frm" created="Wed, 7 Dec 2016 09:26:23 +0000"/>
                            <attachment id="12841755" name="OAK-5223.patch" size="1487" author="stillalex" created="Mon, 5 Dec 2016 14:20:03 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 48 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i375wv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>