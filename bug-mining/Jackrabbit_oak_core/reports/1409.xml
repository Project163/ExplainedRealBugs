<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:49:58 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-3733] Sometimes hierarchy conflict between concurrent add/delete isn&apos;t detected</title>
                <link>https://issues.apache.org/jira/browse/OAK-3733</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;I&apos;m not sure of exact set of event that led to an incident on one of our test clusters. The cluster is running 3 AEM instances based on oak build at 1.3.10.r1713699 backed by a single mongo 3 instance.&lt;/p&gt;

&lt;p&gt;Unfortunately, we found the issue too late and logs had rolled over. Here&apos;s the exception that showed over and over as workflow jobs were (trying to) being processed:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;....
        at java.lang.Thread.run(Thread.java:745)
Caused by: javax.jcr.InvalidItemStateException: OakMerge0004: OakMerge0004: The node 8:/oak:index/event.job.topic/:index/com%2Fadobe%2Fgranite%2Fworkflow%2Ftransient%2Fjob%2Fetc%2Fworkflow%2Fmodels%2Fdam-xmp-writeback%2Fjcr_content%2Fmodel/var/eventing/jobs/assigned was already added in revision
r151233e54e1-0-4, before
r15166378b6a-0-2 (retries 5, 6830 ms)
        at org.apache.jackrabbit.oak.api.CommitFailedException.asRepositoryException(CommitFailedException.java:239)
        at org.apache.jackrabbit.oak.api.CommitFailedException.asRepositoryException(CommitFailedException.java:212)
        at org.apache.jackrabbit.oak.jcr.delegate.SessionDelegate.newRepositoryException(SessionDelegate.java:669)
        at org.apache.jackrabbit.oak.jcr.delegate.SessionDelegate.save(SessionDelegate.java:495)
        at org.apache.jackrabbit.oak.jcr.session.SessionImpl$8.performVoid(SessionImpl.java:419)
        at org.apache.jackrabbit.oak.jcr.delegate.SessionDelegate.performVoid(SessionDelegate.java:273)
        at org.apache.jackrabbit.oak.jcr.session.SessionImpl.save(SessionImpl.java:416)
        at org.apache.sling.jcr.resource.internal.helper.jcr.JcrResourceProvider.commit(JcrResourceProvider.java:634)
        ... 16 common frames omitted
Caused by: org.apache.jackrabbit.oak.api.CommitFailedException: OakMerge0004: OakMerge0004: The node 8:/oak:index/event.job.topic/:index/com%2Fadobe%2Fgranite%2Fworkflow%2Ftransient%2Fjob%2Fetc%2Fworkflow%2Fmodels%2Fdam-xmp-writeback%2Fjcr_content%2Fmodel/var/eventing/jobs/assigned was already added in revision
r151233e54e1-0-4, before
r15166378b6a-0-2 (retries 5, 6830 ms)
        at org.apache.jackrabbit.oak.plugins.document.DocumentNodeStoreBranch.merge0(DocumentNodeStoreBranch.java:200)
        at org.apache.jackrabbit.oak.plugins.document.DocumentNodeStoreBranch.merge(DocumentNodeStoreBranch.java:123)
        at org.apache.jackrabbit.oak.plugins.document.DocumentRootBuilder.merge(DocumentRootBuilder.java:158)
        at org.apache.jackrabbit.oak.plugins.document.DocumentNodeStore.merge(DocumentNodeStore.java:1497)
        at org.apache.jackrabbit.oak.core.MutableRoot.commit(MutableRoot.java:247)
        at org.apache.jackrabbit.oak.jcr.delegate.SessionDelegate.commit(SessionDelegate.java:346)
        at org.apache.jackrabbit.oak.jcr.delegate.SessionDelegate.save(SessionDelegate.java:493)
        ... 20 common frames omitted
Caused by: org.apache.jackrabbit.oak.plugins.document.ConflictException: The node 8:/oak:index/event.job.topic/:index/com%2Fadobe%2Fgranite%2Fworkflow%2Ftransient%2Fjob%2Fetc%2Fworkflow%2Fmodels%2Fdam-xmp-writeback%2Fjcr_content%2Fmodel/var/eventing/jobs/assigned was already added in revision
r151233e54e1-0-4, before
r15166378b6a-0-2
        at org.apache.jackrabbit.oak.plugins.document.Commit.checkConflicts(Commit.java:582)
        at org.apache.jackrabbit.oak.plugins.document.Commit.createOrUpdateNode(Commit.java:487)
        at org.apache.jackrabbit.oak.plugins.document.Commit.applyToDocumentStore(Commit.java:371)
        at org.apache.jackrabbit.oak.plugins.document.Commit.applyToDocumentStore(Commit.java:265)
        at org.apache.jackrabbit.oak.plugins.document.Commit.applyInternal(Commit.java:234)
        at org.apache.jackrabbit.oak.plugins.document.Commit.apply(Commit.java:219)
        at org.apache.jackrabbit.oak.plugins.document.DocumentNodeStoreBranch.persist(DocumentNodeStoreBranch.java:290)
        at org.apache.jackrabbit.oak.plugins.document.DocumentNodeStoreBranch.persist(DocumentNodeStoreBranch.java:260)
        at org.apache.jackrabbit.oak.plugins.document.DocumentNodeStoreBranch.access$300(DocumentNodeStoreBranch.java:54)
        at org.apache.jackrabbit.oak.plugins.document.DocumentNodeStoreBranch$InMemory.merge(DocumentNodeStoreBranch.java:498)
        at org.apache.jackrabbit.oak.plugins.document.DocumentNodeStoreBranch.merge0(DocumentNodeStoreBranch.java:180)
        ... 26 common frames omitted
....
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Doing following removed repo corruption and restored w/f processing:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;oak.removeDescendantsAndSelf(&quot;/oak:index/event.job.topic/:index/com%2Fadobe%2Fgranite%2Fworkflow%2Ftransient%2Fjob%2Fetc%2Fworkflow%2Fmodels%2Fdam-xmp-writeback%2Fjcr_content%2Fmodel/var/eventing/jobs/assigned&quot;)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Attaching &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12776000/12776000_mongoexport.zip&quot; title=&quot;mongoexport.zip attached to OAK-3733&quot;&gt;mongoexport output&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; for &lt;tt&gt;/oak:index/event.job.topic/:index/com%2Fadobe%2Fgranite%2Fworkflow%2Ftransient%2Fjob%2Fetc%2Fworkflow%2Fmodels%2Fdam-xmp-writeback%2Fjcr_content%2Fmodel/var/eventing/jobs/assigned/6a389a6a-a8bf-4038-b57b-cb441c6ac557/com.adobe.granite.workflow.transient.job.etc.workflow.models.dam-xmp-writeback.jcr_content.model/2015/11/19/23/54/6a389a6a-a8bf-4038-b57b-cb441c6ac557_10&lt;/tt&gt; (the hierarchy created at &lt;tt&gt;r151233e54e1-0-4&lt;/tt&gt;). I&apos;ve renamed a few path elements to make it more reable though (e.g. &lt;tt&gt;:index/com%2Fadobe%2Fgranite%2Fworkflow%2Ftransient%2Fjob%2Fetc%2Fworkflow%2Fmodels%2Fdam-xmp-writeback%2Fjcr_content%2Fmodel&lt;/tt&gt; -&amp;gt; &lt;tt&gt;enc_value&lt;/tt&gt;).&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mreutegg&quot; class=&quot;user-hover&quot; rel=&quot;mreutegg&quot;&gt;mreutegg&lt;/a&gt;, I&apos;m assigning it to myself for now, but I think this would require your expertise all the way &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12919515">OAK-3733</key>
            <summary>Sometimes hierarchy conflict between concurrent add/delete isn&apos;t detected</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mreutegg">Marcel Reutegger</assignee>
                                    <reporter username="catholicon">Vikas Saurabh</reporter>
                        <labels>
                    </labels>
                <created>Sun, 6 Dec 2015 16:15:35 +0000</created>
                <updated>Wed, 2 Mar 2016 15:09:36 +0000</updated>
                            <resolved>Wed, 16 Dec 2015 13:38:58 +0000</resolved>
                                                    <fixVersion>1.0.26</fixVersion>
                    <fixVersion>1.2.10</fixVersion>
                    <fixVersion>1.3.13</fixVersion>
                    <fixVersion>1.4</fixVersion>
                                    <component>core</component>
                    <component>documentmk</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15043966" author="catholicon" created="Sun, 6 Dec 2015 17:41:29 +0000"  >&lt;p&gt;The interesting revisions are:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;&lt;tt&gt;r151233e54e1-0-4&lt;/tt&gt; (the conflicting rev) - it&apos;s marked committed at &lt;tt&gt;2&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/tongue.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;/r1512340e9c1-0-4/0&lt;/tt&gt;. The revision marked _deleted=false starting from &lt;tt&gt;9:/oak:index/event.job.topic/:index/enc_value/var/eventing/jobs/assigned/server_uuid&lt;/tt&gt; (and downwards). The revision was marked correctly for _commitRoot for the parent of created hierarchy - &lt;tt&gt;assigned&lt;/tt&gt; node.&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;r151233e5114-0-2&lt;/tt&gt; (the rev which deleted the one of the parent and remained undetected OR didn&apos;t detect hierarchy change mentioned above) - it&apos;s marked committed at &lt;tt&gt;2&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/tongue.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;/r151233e5114-0-2/0&lt;/tt&gt;. The revision marked _deleted=true starting from &lt;tt&gt;5:/oak:index/event.job.topic/:index/enc_value/var&lt;/tt&gt;  upto &lt;tt&gt;8:/oak:index/event.job.topic/:index/enc_value/var/eventing/jobs/assigned&lt;/tt&gt; (and most probably a sibling hierarchy that I didn&apos;t capture in mongoexport).&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Depending upon which session got to get committed first, either #1 or #2 should have detected a conflict due to changes on &lt;tt&gt;assigned&lt;/tt&gt; node. Given, the revision timestamps are milliseconds apart - most probably both cluster id 2 and 4 would have treated the other rev as being from future.&lt;/p&gt;</comment>
                            <comment id="15044004" author="catholicon" created="Sun, 6 Dec 2015 18:23:13 +0000"  >&lt;p&gt;Note, the cluster has fixes for &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-3028&quot; title=&quot;Hierarchy conflict detection broken&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-3028&quot;&gt;&lt;del&gt;OAK-3028&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-2929&quot; title=&quot;Parent of unseen children must not be removable&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-2929&quot;&gt;&lt;del&gt;OAK-2929&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-3388&quot; title=&quot;Inconsistent read in cluster with clock differences&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-3388&quot;&gt;&lt;del&gt;OAK-3388&lt;/del&gt;&lt;/a&gt;, and &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-3411&quot; title=&quot;Inconsistent read on DocumentNodeStore startup&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-3411&quot;&gt;&lt;del&gt;OAK-3411&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
Afaict, all 3 cluster nodes in the issue have fairly synced clock (least count due to my ability to switch tabs and press enter). Note sure, if that was the case at the time when the issue happened.&lt;/p&gt;</comment>
                            <comment id="15044545" author="mreutegg" created="Mon, 7 Dec 2015 08:15:11 +0000"  >&lt;p&gt;This issue may be related to &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-3646&quot; title=&quot;Inconsistent read of hierarchy &quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-3646&quot;&gt;&lt;del&gt;OAK-3646&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="15044549" author="catholicon" created="Mon, 7 Dec 2015 08:18:37 +0000"  >&lt;p&gt;I thought &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-3646&quot; title=&quot;Inconsistent read of hierarchy &quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-3646&quot;&gt;&lt;del&gt;OAK-3646&lt;/del&gt;&lt;/a&gt; affects revisions which get older than an hour. The contentious revisions for 8:/ document (and even the nearby revisions which affected it) didn&apos;t seem so far out.&lt;/p&gt;</comment>
                            <comment id="15059732" author="mreutegg" created="Wed, 16 Dec 2015 09:18:27 +0000"  >&lt;p&gt;While testing my changes for &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-3646&quot; title=&quot;Inconsistent read of hierarchy &quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-3646&quot;&gt;&lt;del&gt;OAK-3646&lt;/del&gt;&lt;/a&gt; I experienced a similar problem and was able to (partially) track down the root cause.&lt;/p&gt;

&lt;p&gt;In my case the problem was triggered because first &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-3653&quot; title=&quot;Incorrect last revision of cached node state&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-3653&quot;&gt;&lt;del&gt;OAK-3653&lt;/del&gt;&lt;/a&gt; seemed to happen and then the DocumentNodeStore incorrectly tried to create a node that didn&apos;t exist anymore. The conflict detection should fail the commit in this case, but it may happen that such a commit goes through.&lt;/p&gt;

&lt;p&gt;I will create a test to reproduce the issue.&lt;/p&gt;</comment>
                            <comment id="15059936" author="mreutegg" created="Wed, 16 Dec 2015 12:41:31 +0000"  >&lt;p&gt;Added test (currently ignored): &lt;a href=&quot;http://svn.apache.org/r1720350&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1720350&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15059977" author="mreutegg" created="Wed, 16 Dec 2015 13:38:58 +0000"  >&lt;p&gt;Fixed in trunk: &lt;a href=&quot;http://svn.apache.org/r1720354&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1720354&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15068053" author="catholicon" created="Tue, 22 Dec 2015 12:27:25 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mreutegg&quot; class=&quot;user-hover&quot; rel=&quot;mreutegg&quot;&gt;mreutegg&lt;/a&gt;, I think we should backport this issue to 1.2 (and probably to 1.0 as well). Wdyt?&lt;/p&gt;</comment>
                            <comment id="15080841" author="mreutegg" created="Mon, 4 Jan 2016 08:47:58 +0000"  >&lt;p&gt;Yes, makes sense. I&apos;ll backport the fix.&lt;/p&gt;</comment>
                            <comment id="15080916" author="mreutegg" created="Mon, 4 Jan 2016 10:03:57 +0000"  >&lt;p&gt;Merged into 1.2 branch: &lt;a href=&quot;http://svn.apache.org/r1722809&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1722809&lt;/a&gt; and 1.0 branch: &lt;a href=&quot;http://svn.apache.org/r1722818&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1722818&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15087423" author="edivad" created="Thu, 7 Jan 2016 14:14:48 +0000"  >&lt;p&gt;Bulk close for 1.3.13&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12840055">OAK-3028</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12833670">OAK-2929</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12776000" name="mongoexport.zip" size="1977456" author="catholicon" created="Sun, 6 Dec 2015 16:16:43 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 45 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2pi5r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>