<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:36:37 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-343] Session.getNodeByUUID requires save call</title>
                <link>https://issues.apache.org/jira/browse/OAK-343</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;while adding mix:referenceable to a new node immediately assigns a &lt;br/&gt;
uuid and makes the node referenceable, session.getNodeByUUID only works&lt;br/&gt;
after saving the changes.&lt;/p&gt;

&lt;p&gt;the following test illustrates this behavior:&lt;/p&gt;

&lt;p&gt;@Test&lt;br/&gt;
public void getNodeByUUID() throws RepositoryException {&lt;br/&gt;
   Node node = getNode(&quot;/foo&quot;).addNode(&quot;boo&quot;);&lt;br/&gt;
   node.addMixin(JcrConstants.MIX_REFERENCEABLE);&lt;/p&gt;

&lt;p&gt;   assertTrue(node.isNodeType(JcrConstants.MIX_REFERENCEABLE));&lt;br/&gt;
   String uuid = node.getUUID();&lt;br/&gt;
   assertNotNull(uuid);&lt;br/&gt;
   assertEquals(uuid, node.getIdentifier());&lt;/p&gt;

&lt;p&gt;   Node nAgain = node.getSession().getNodeByUUID(uuid);&lt;br/&gt;
   assertTrue(nAgain.isSame(node));&lt;br/&gt;
   assertTrue(nAgain.isSame(node.getSession().getNodeByIdentifier(uuid)));&lt;br/&gt;
}&lt;/p&gt;</description>
                <environment></environment>
        <key id="12609204">OAK-343</key>
            <summary>Session.getNodeByUUID requires save call</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="thomasm">Thomas Mueller</assignee>
                                    <reporter username="angela">Angela Schreiber</reporter>
                        <labels>
                    </labels>
                <created>Wed, 26 Sep 2012 09:39:05 +0000</created>
                <updated>Tue, 21 May 2013 11:26:18 +0000</updated>
                            <resolved>Fri, 1 Mar 2013 15:04:58 +0000</resolved>
                                                    <fixVersion>0.7</fixVersion>
                                    <component>core</component>
                    <component>jcr</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="13463663" author="anchela" created="Wed, 26 Sep 2012 09:43:33 +0000"  >&lt;p&gt;the same applies to IdentifierManager#getTree and main issue behind is that uuid/identifier resolutions uses&lt;br/&gt;
the query which relies on an index that is only populated after changes have been saved.&lt;/p&gt;</comment>
                            <comment id="13463697" author="jukkaz" created="Wed, 26 Sep 2012 10:34:41 +0000"  >&lt;p&gt;Do we need the UUIDs to be present and usable before a save()? The &lt;a href=&quot;http://www.day.com/specs/jcr/2.0/3_Repository_Model.html#3.3.1%20Identifier%20Assignment&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;relevant part&lt;/a&gt; of the JCR 2.0 spec says:  &lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;The identifier must be assigned at the latest when the node is first persisted, though it may be assigned earlier, when the node is first created in transient storage in the session.&lt;/p&gt;&lt;/blockquote&gt;</comment>
                            <comment id="13463745" author="anchela" created="Wed, 26 Sep 2012 12:21:39 +0000"  >&lt;p&gt;well, since the uuid is created immediately and the node is referenceable as well,&lt;br/&gt;
i would expect that i could also get it by uuid.&lt;/p&gt;

&lt;p&gt;second we have an issue with a backwards compatible user mgt implementation:&lt;br/&gt;
a NEW user used to be accessible by for the editing session even before commiting&lt;br/&gt;
it. second, since the tree object isn&apos;t stable it needs to be re-accessed during&lt;br/&gt;
the life-time of a user object. searching isn&apos;t possible but i would expect that&lt;br/&gt;
lookup be id was possible.&lt;/p&gt;</comment>
                            <comment id="13463749" author="anchela" created="Wed, 26 Sep 2012 12:25:53 +0000"  >&lt;p&gt;regarding the user mgt: i realized that when looking at failing test&lt;br/&gt;
that were originally written for jackrabbit and which i would expect&lt;br/&gt;
to pass (as long as the tests are not obviously buggy)&lt;/p&gt;</comment>
                            <comment id="13463852" author="jukkaz" created="Wed, 26 Sep 2012 14:29:28 +0000"  >&lt;p&gt;Marcel brought up the good idea that there&apos;s no need for us to wait for the save() or the commit hook until the jcr:uuid index used by the getNodeByUUID() method gets updated. Instead we could update that index already in the transient space as soon as the UUID is assigned to a new, transient node. The index lookup then just needs to be done against the transient state of the tree instead of the persisted one.&lt;/p&gt;</comment>
                            <comment id="13504643" author="reschke" created="Tue, 27 Nov 2012 14:38:33 +0000"  >&lt;p&gt;Spec lawyering question: does the JCR spec allow an implementation to assign the identifier early but then fail getNodeByIdentifier()? It it&apos;s silent on that, we may want to clarify that in JSR 333.&lt;/p&gt;</comment>
                            <comment id="13527999" author="baedke" created="Mon, 10 Dec 2012 15:32:21 +0000"  >&lt;p&gt;As suggested by Thomas and Angela, this can be solved by keeping track of the UUIDs of newly created nodes using a mapping in RootImpl. If noone objects, I&apos;m going to implement this. &lt;/p&gt;</comment>
                            <comment id="13528089" author="baedke" created="Mon, 10 Dec 2012 17:36:59 +0000"  >&lt;p&gt;I looked into it and found that it should be possible to wrap the RootImpl.indexProvider in order to add a QueryIndex that contains our transient map and takes care of the UUID lookup. &lt;br/&gt;
Straightforward approaches using a Map that is aggregated by RootImpl would require a change to the Root interface, and I suppose that we do not want that.&lt;/p&gt;</comment>
                            <comment id="13528835" author="mduerig" created="Tue, 11 Dec 2012 09:24:49 +0000"  >&lt;blockquote&gt;&lt;p&gt;wrap the RootImpl.indexProvider &lt;span class=&quot;error&quot;&gt;&amp;#91;...&amp;#93;&lt;/span&gt;&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I&apos;d prefer this approach.&lt;/p&gt;</comment>
                            <comment id="13529070" author="baedke" created="Tue, 11 Dec 2012 15:51:52 +0000"  >&lt;p&gt;Following Jukkas hint to use NodeStateDiffs instead of a Map to lookup the transient nodes, I created a solution proposal using an additional QueryIndex (see attached oak-343-patch).&lt;/p&gt;</comment>
                            <comment id="13529084" author="baedke" created="Tue, 11 Dec 2012 16:09:59 +0000"  >&lt;p&gt;As expected, immediately after uploading the patch I realized that it&apos;s not going to work properly, because descendants of transient nodes will not be found. &lt;br/&gt;
I will uploaded a better version soon.&lt;/p&gt;</comment>
                            <comment id="13529105" author="tmueller" created="Tue, 11 Dec 2012 16:38:32 +0000"  >&lt;p&gt;This is a very interesting approach. It should work and is quite elegant. The query is actually executed in the getCost method, that&apos;s a bit outside of what I thought getCost should do, but I&apos;m sure we can solve that (either change documentation or change the behavior a bit).&lt;/p&gt;

&lt;p&gt;Maybe we could use a similar mechanism for other problems as well, for example to allow other queries to see the latest (transient) state of the repository, even if the index implementation itself doesn&apos;t support that directly. This is a feature quite commonly requested, but is relatively hard to solve in another way. But there is a cost to it (even if it&apos;s only in-memory operation), so I guess it shouldn&apos;t be done by default. Maybe with an extension in the query syntax? (&quot;select ... including transient&quot; or so) Instead of &apos;only&apos; using this special transient index, I wonder if the normal index and the transient index should be combined, so that the query doesn&apos;t need to be executed in getCost. A similar mechanism to overlay / combine indexes is already used in the NodeType index, and one is planned to speed up queries of type &quot;a=1 and b=2&quot;. I will propose a solution for that, but I guess it&apos;s not urgent.&lt;/p&gt;
</comment>
                            <comment id="13529108" author="mduerig" created="Tue, 11 Dec 2012 16:41:12 +0000"  >&lt;p&gt;Thanks for the patch. A few comments&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Please use Guava instead of commons collections. See Oak-200.&lt;/li&gt;
	&lt;li&gt;Don&apos;t use start imports, import each class/member explicitly.&lt;/li&gt;
	&lt;li&gt;I&apos;d rename &lt;tt&gt;InternalIndexProvider&lt;/tt&gt; to &lt;tt&gt;UUIDIndexProvider&lt;/tt&gt; and move the implementation to the end of the file.&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;UUIDQueryIndex.query()&lt;/tt&gt; relies on the side effects of a prior call to &lt;tt&gt;UUIDQueryIndex.getCost()&lt;/tt&gt;. Can we really rely of &lt;tt&gt;getCost()&lt;/tt&gt; having been called at the point when &lt;tt&gt;query()&lt;/tt&gt; is called? If so &lt;tt&gt;QueryIndexProvider&lt;/tt&gt; should clearly state this in its contract. Otherwise it might be better to use a memoisation pattern for &lt;tt&gt;UUIDQueryIndex.path&lt;/tt&gt; and explicitly calculate it if it wasn&apos;t calculated before.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13529136" author="baedke" created="Tue, 11 Dec 2012 17:15:50 +0000"  >&lt;p&gt;Added recursion, works better now.&lt;br/&gt;
@Michael: Thank you, I will make the according changes tomorrow and ask Thomas about the reliability of the getCost()-call.&lt;/p&gt;</comment>
                            <comment id="13529744" author="tmueller" created="Wed, 12 Dec 2012 08:29:32 +0000"  >&lt;p&gt;For me it&apos;s not actually about that getCost() gets called first, but in general that getCost() is supposed to just calculate the cost, without side effects. Even if this side effect is within the specification, it&apos;s just unusual and unexpected. I would rather have a solution where getCost() only calculates the cost &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; and the lookup is done within query(). I think we can find a solution. It&apos;s also problematic that getCost() returns 0 so that the cost is smaller than the cost of the regular jcr:uuid index. It does solve the problem, true, but it&apos;s not what I had in mind originally.&lt;/p&gt;

&lt;p&gt;About naming: I would probably call it &quot;TransientUUIDIndex&quot; because it operates on the transient space. Later on, if we want to make it more generic, we could call it &quot;TransientIndex&quot;.&lt;/p&gt;

&lt;p&gt;What about making it explicit in the query that the result should include transient changes? So the query would be changed to &quot;select ... from ... where &lt;span class=&quot;error&quot;&gt;&amp;#91;jcr:uuid&amp;#93;&lt;/span&gt; = $id including transient&quot;. Then the QueryIndex interface would be extended with a new method &quot;boolean includesTransient&quot;. That way, if the query is &quot;including transient&quot;, the query engine would only use indexes that do support transient changes.&lt;/p&gt;

&lt;p&gt;I&apos;m OK to all those changes myself later on, as I don&apos;t think they are urgent.&lt;/p&gt;

&lt;p&gt;I wonder if both the NodeState and Root given to the query actually include the node?&lt;/p&gt;
</comment>
                            <comment id="13529763" author="jukkaz" created="Wed, 12 Dec 2012 08:57:30 +0000"  >&lt;p&gt;I&apos;m not too excited about using the QueryIndex mechanism for this, as it modifies the contract as outlined by Thomas. What I had in mind originally was for IdentifierManager.resolveUUID() to do the transient diff directly before falling back to a query.&lt;/p&gt;</comment>
                            <comment id="13529767" author="tmueller" created="Wed, 12 Dec 2012 09:02:24 +0000"  >&lt;p&gt;&amp;gt; What I had in mind originally was for IdentifierManager.resolveUUID() to do the transient diff directly&lt;/p&gt;

&lt;p&gt;If that&apos;s simpler, then we could do that. &lt;/p&gt;

&lt;p&gt;We can extend the query engine to support transient changes later on, if it turns out it&apos;s a useful feature in other areas.&lt;/p&gt;</comment>
                            <comment id="13529769" author="baedke" created="Wed, 12 Dec 2012 09:06:45 +0000"  >&lt;p&gt;We can do that, but then we have to change the Root interface, what&apos;s exactly what I tried to avoid.&lt;/p&gt;</comment>
                            <comment id="13529775" author="baedke" created="Wed, 12 Dec 2012 09:34:03 +0000"  >&lt;p&gt;Btw: I admittedly overstretched the contract of the QueryIndex API here, but in a way that might turn out useful if formalized - as Thomas already pointed out.&lt;br/&gt;
Currently the QueryIndexProvider has one single collection of QueryIndexes, choosing one of them depending on the costs. Alternatively we could have multiple collections of QueryIndexes which could be combined by logical operations (As Thomas mentioned, we could also write container QueryIndexes that combine other QueryIndexes by logical operations. That could be done without changing the API).&lt;/p&gt;</comment>
                            <comment id="13529779" author="mduerig" created="Wed, 12 Dec 2012 09:45:09 +0000"  >&lt;blockquote&gt;&lt;p&gt;but then we have to change the Root interface&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;On a second thought, this might not be a bad thing: retrieving nodes by their id is an integral part of JCR. So exposing the corresponding functionality directly in the Oak API seems like a good idea and &lt;tt&gt;Root&lt;/tt&gt; seems like a good place. OTOH the indexing approach - while very elegant - kind of exposes implementation details of a certain way to resolve ids to nodes. &lt;/p&gt;</comment>
                            <comment id="13529790" author="jukkaz" created="Wed, 12 Dec 2012 10:01:13 +0000"  >&lt;p&gt;Yeah, having this exposed in Root is a bit troublesome as we&apos;ve tried to avoid pushing too many JCR semantics down to the Oak API. Though in this case I think doing so is the lesser evil compared to changing the query semantics.&lt;/p&gt;

&lt;p&gt;Could we do this in a generic manner by extending the &lt;tt&gt;Root.getTree()&lt;/tt&gt; semantics to allow also identifier paths, and by adding an extension interface for pluggable identifier lookups?&lt;/p&gt;</comment>
                            <comment id="13529796" author="mduerig" created="Wed, 12 Dec 2012 10:14:57 +0000"  >&lt;blockquote&gt;&lt;p&gt;Could we do this in a generic manner by extending the Root.getTree() &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This would go very well with the solution I proposed for &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-426&quot; title=&quot;OAK-API: Deal with names and relativePaths consisting/containing &amp;quot;.&amp;quot; and &amp;quot;..&amp;quot;&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-426&quot;&gt;&lt;del&gt;OAK-426&lt;/del&gt;&lt;/a&gt;, which was vetoed though.&lt;/p&gt;</comment>
                            <comment id="13529922" author="baedke" created="Wed, 12 Dec 2012 12:49:17 +0000"  >&lt;p&gt;I uploaded a new version of the QueryIndex solution (oak-343-QueryIndex.patch) containing the changes suggested by Michael and Thomas. Later I will upload another patch which doesn&apos;t (ab)use a QueryIndex but instead changes the Root interface.&lt;br/&gt;
Since the QueryIndex solution works and doesn&apos;t change any interfaces, maybe we can use it as a temporary solution until we have a final one. That would be nice because this issue is blocking stuff.&lt;/p&gt;</comment>
                            <comment id="13529923" author="baedke" created="Wed, 12 Dec 2012 12:53:34 +0000"  >&lt;p&gt;@Angela: Note that I had to change a test case in UserManagementTest which fails after applying the patch. I think that indeed the test case was broken, but you might want to review it.&lt;/p&gt;</comment>
                            <comment id="13529999" author="jukkaz" created="Wed, 12 Dec 2012 14:45:09 +0000"  >&lt;blockquote&gt;&lt;p&gt;Since the QueryIndex solution works and doesn&apos;t change any interfaces, maybe we can use it as a temporary solution until we have a final one. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;+1 Incremental improvements FTW.&lt;/p&gt;</comment>
                            <comment id="13546990" author="baedke" created="Tue, 8 Jan 2013 16:36:36 +0000"  >&lt;p&gt;Updated patch to use Double.POSITIVE_INFINITY and Double.NEGATIVE_INFINITY as index cost values.&lt;/p&gt;</comment>
                            <comment id="13547729" author="tmueller" created="Wed, 9 Jan 2013 07:42:02 +0000"  >&lt;p&gt;The patch looks good to me. It&apos;s not the final solution, there are still a few things to be changed (lookup in getCost instead of query for example), but those can be solved later on as well.&lt;/p&gt;</comment>
                            <comment id="13561539" author="tmueller" created="Thu, 24 Jan 2013 10:18:48 +0000"  >&lt;p&gt;I will work on this. I will try to integrate (maybe slightly change) the patch from Manfred Baedke and commit it. Later on we might want to find a different solution if it turns out to be problematic.&lt;/p&gt;</comment>
                            <comment id="13561616" author="baedke" created="Thu, 24 Jan 2013 13:26:53 +0000"  >&lt;p&gt;Very good.&lt;/p&gt;</comment>
                            <comment id="13561652" author="alex.parvulescu" created="Thu, 24 Jan 2013 14:44:54 +0000"  >&lt;p&gt;I took the patch for a spin, here&apos;s an updated version.&lt;/p&gt;

&lt;p&gt;I took the liberty of extracting the diff mechanism into its dedicated class (and adding some tests to that), next the index just passes on the filter and based on that, the matching nodes are extracted from the diff.&lt;/p&gt;


&lt;p&gt;feedback welcome!&lt;/p&gt;</comment>
                            <comment id="13562564" author="alex.parvulescu" created="Fri, 25 Jan 2013 09:56:21 +0000"  >&lt;p&gt;I pushed the patch with rev 1438403.&lt;/p&gt;

&lt;p&gt;There was a small bug, Thomas pointed it out which is now fixed - the UUIDDiffIndexProviderWrapper would always return an empty list.&lt;br/&gt;
Interestingly enough, being an empty list the Query would fallback to the Traversing index so the test would still not fail (at least I think that was the reason)&lt;br/&gt;
Anyway, the code is in, the tests pass.&lt;/p&gt;

&lt;p&gt;The score and the plan are still not properly put in place. That is not a big deal, but it is the reason I&apos;m not marking this issue as resolved.&lt;br/&gt;
I&apos;ll also have to add some documentation to the code &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;
</comment>
                            <comment id="13562578" author="tmueller" created="Fri, 25 Jan 2013 10:18:23 +0000"  >&lt;p&gt;OK, great, thanks a lot! I will take over from here. There are a few changes I would like to implement, for example avoiding to read too much data in the getCost method.&lt;/p&gt;

&lt;p&gt;But this should no longer block other features.&lt;/p&gt;</comment>
                            <comment id="13562579" author="tmueller" created="Fri, 25 Jan 2013 10:18:55 +0000"  >&lt;p&gt;Removed block for &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-50&quot; title=&quot;Implement User Management&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-50&quot;&gt;&lt;del&gt;OAK-50&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13562646" author="alex.parvulescu" created="Fri, 25 Jan 2013 13:06:31 +0000"  >&lt;p&gt;&amp;gt; I will take over from here. There are a few changes I would like to implement, for example avoiding to read too much data in the getCost method.&lt;/p&gt;

&lt;p&gt;perfect, thanks!&lt;/p&gt;

&lt;p&gt;There are still issues with this fix.&lt;br/&gt;
The tests marked as failing because of &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-343&quot; title=&quot;Session.getNodeByUUID requires save call&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-343&quot;&gt;&lt;del&gt;OAK-343&lt;/del&gt;&lt;/a&gt; in oak-jcr (pom.xml under &quot;known.issues&quot;) are still failing unfortunately.&lt;br/&gt;
The problem is they also fail using the original patch, so probably the problem goes deeper.&lt;/p&gt;

&lt;p&gt;It would seem that the UUID query is looking for a node that is neither in the transient space (in the diff between rootTree.getNodeState() -&amp;gt; getBaseState) nor the property index. (I am seeing the nodes in the base state NodeState, but not in the property index)&lt;br/&gt;
I&apos;ll try to look into this a bit.&lt;/p&gt;</comment>
                            <comment id="13562684" author="alex.parvulescu" created="Fri, 25 Jan 2013 13:49:48 +0000"  >&lt;p&gt;Interesting, I was looking at a different test &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
For FindAuthorizablesTest#testFindAuthorizableByAddedProperty it seemes like the diff doesn&apos;t go deep enough.&lt;/p&gt;

&lt;p&gt;The node hierarchy looks like &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;rep:security
  /rep:authorizables
    /rep:groups
      /t
        /te
           /testPrincipal_4e6b704e &amp;lt;-- with the jcr:uuid I&apos;m interested in
           /testGroup_1c22a39f
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;And everything under /rep:groups is new content that apparently doesn&apos;t get picked up by the diff at all.&lt;/p&gt;</comment>
                            <comment id="13562692" author="alex.parvulescu" created="Fri, 25 Jan 2013 13:56:03 +0000"  >&lt;blockquote&gt;&lt;p&gt;UserManagerTest.testGetNewAuthorizable()&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;right, I&apos;m seeing the same thing. Apparently the query uses the property index, and it resolved to a (probably) non existent path.&lt;/p&gt;</comment>
                            <comment id="13562702" author="alex.parvulescu" created="Fri, 25 Jan 2013 14:10:17 +0000"  >&lt;p&gt;I took a closer look at UserManagerTest.testGetNewAuthorizable() and the test actually fails at&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  assertNotNull(userMgr.getAuthorizable(uid));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;and then offcourse in the finally block wen it tries to cleanup.&lt;br/&gt;
So the UUID resolution needs more work &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13562708" author="baedke" created="Fri, 25 Jan 2013 14:14:19 +0000"  >&lt;p&gt;Yes, just made the same observation. Sorry for the confusion &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13562735" author="baedke" created="Fri, 25 Jan 2013 14:44:17 +0000"  >&lt;p&gt;Found it. The childNodeChanged() implementation stops recursion if the childNodeCount did not change, which is of course nonsense.&lt;/p&gt;</comment>
                            <comment id="13562756" author="alex.parvulescu" created="Fri, 25 Jan 2013 15:13:14 +0000"  >&lt;blockquote&gt;&lt;p&gt;Found it. The childNodeChanged() implementation stops recursion if the childNodeCount did not change, which is of course nonsense.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Right, I&apos;ve pushed a fix for this issue. The diff acts now like the other diffs used in indexing (see Property2IndexDiff).&lt;/p&gt;</comment>
                            <comment id="13562757" author="alex.parvulescu" created="Fri, 25 Jan 2013 15:14:46 +0000"  >&lt;p&gt;first good news: UserManagerTest.testGetNewAuthorizable() passes!&lt;br/&gt;
Manfred, do you see the same thing?&lt;/p&gt;

&lt;p&gt;I&apos;ll look at the other ones next &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13562761" author="baedke" created="Fri, 25 Jan 2013 15:17:48 +0000"  >&lt;p&gt;Only two remaining failures: UserManagerTest.testGroupCreateWithExistingPrincipal2() and UserManagerTest.testGroupCreateWithExistingPrincipal3().&lt;br/&gt;
I suspect that these fail for a bug that has nothing to do with this issue.&lt;/p&gt;</comment>
                            <comment id="13562773" author="alex.parvulescu" created="Fri, 25 Jan 2013 15:30:11 +0000"  >&lt;p&gt;Thanks for the help Manfred.&lt;/p&gt;

&lt;p&gt;I think we need now Angela&apos;s input on the failing tests to see if there are still issues in the fix or not.&lt;/p&gt;</comment>
                            <comment id="13562778" author="baedke" created="Fri, 25 Jan 2013 15:35:06 +0000"  >&lt;p&gt;And GroupTest.testCyclicGroups() and FindAuthorizables.testFindAuthorizableByRelativePath() are also failing.&lt;br/&gt;
I&apos;ll take a quick look at these.&lt;/p&gt;</comment>
                            <comment id="13562792" author="baedke" created="Fri, 25 Jan 2013 15:49:09 +0000"  >&lt;p&gt;So far, I tested on my own fork with the initial patch. On the public repository, I now see additional failures in RepositoryTest.&lt;/p&gt;</comment>
                            <comment id="13562802" author="alex.parvulescu" created="Fri, 25 Jan 2013 16:04:15 +0000"  >&lt;p&gt;yes, I fixed it again &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
The diff mechanism is not obvious sometimes, (this time I forgot to include the new nodes).&lt;/p&gt;

&lt;p&gt;Remaining failing auth related tests:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;testFindAuthorizableByRelativePath(org.apache.jackrabbit.oak.jcr.security.user.FindAuthorizablesTest): expected result
  testCreateGroupWithExistingPrincipal2(org.apache.jackrabbit.oak.jcr.security.user.UserManagerTest): Principal testPrincipal_dabdf591-e632-4d8a-ba20-387d7171f419 is already in use -&amp;gt; must &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; AuthorizableExistsException.
  testCreateGroupWithExistingPrincipal3(org.apache.jackrabbit.oak.jcr.security.user.UserManagerTest): Principal testPrincipal_6f98fd44-854c-47e4-b1a1-e0a2f7808a18 is already in use -&amp;gt; must &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; AuthorizableExistsException.
  testCyclicGroups(org.apache.jackrabbit.oak.jcr.security.user.GroupTest)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13562813" author="baedke" created="Fri, 25 Jan 2013 16:25:34 +0000"  >&lt;p&gt;FindAuthorizablesTest.testFindAuthorizableByRelativePath() fails because it expects the XPATH query &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;/jcr:root/rep:security/rep:authorizables&lt;span class=&quot;code-comment&quot;&gt;//element(*)[@prop1=&lt;span class=&quot;code-quote&quot;&gt;&apos;v1&apos;&lt;/span&gt;]&lt;/span&gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; to match transient nodes, so that also seems to be a different issue (just a broken test case?).&lt;br/&gt;
I think you&apos;re right and Angela should take a look, if she finds the time.&lt;/p&gt;</comment>
                            <comment id="13562823" author="baedke" created="Fri, 25 Jan 2013 16:47:45 +0000"  >&lt;p&gt;Finally, GroupTest.testCyclicGroups() relies on&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;SELECT * FROM [nt:base] WHERE PROPERTY([rep:members], &lt;span class=&quot;code-quote&quot;&gt;&apos;WeakReference&apos;&lt;/span&gt;) = $uuid&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;to match transient nodes.&lt;/p&gt;</comment>
                            <comment id="13573588" author="anchela" created="Thu, 7 Feb 2013 15:25:32 +0000"  >&lt;p&gt;i resolved most remaining TODOs related to &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-343&quot; title=&quot;Session.getNodeByUUID requires save call&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-343&quot;&gt;&lt;del&gt;OAK-343&lt;/del&gt;&lt;/a&gt; and fixed the testCreateGroupWithExistingPrincipal* test.&lt;br/&gt;
regarding testFindAuthorizableByRelativePath and testCyclicGroups i need to have a closer look again... as manfred suspected there are save() calls missing but adding those doesn&apos;t seems to solve the issue.&lt;/p&gt;</comment>
                            <comment id="13573624" author="anchela" created="Thu, 7 Feb 2013 16:05:53 +0000"  >&lt;p&gt;the testCyclicGroups is fine and just needed the save calls to be placed property (see &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-615&quot; title=&quot;UserValidator should check for cyclic group membership&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-615&quot;&gt;&lt;del&gt;OAK-615&lt;/del&gt;&lt;/a&gt; for another issue that i detected by fixing)&lt;/p&gt;</comment>
                            <comment id="13573679" author="anchela" created="Thu, 7 Feb 2013 17:11:59 +0000"  >&lt;p&gt;testFindAuthorizableByRelativePath is caused by a bug in the code &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
so, i hope that answers all the remaining questions. &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12566314" name="OAK-343-v2.patch" size="17550" author="stillalex" created="Thu, 24 Jan 2013 14:44:54 +0000"/>
                            <attachment id="12563774" name="oak-343-QueryIndex.patch" size="11762" author="baedke" created="Tue, 8 Jan 2013 16:33:05 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>292364</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 41 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0rxgv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>161066</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>