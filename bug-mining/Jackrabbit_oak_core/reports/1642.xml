<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:52:23 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-5587] Node counter index estimates must not be used before first async index cycle</title>
                <link>https://issues.apache.org/jira/browse/OAK-5587</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;Oak traversing index returns a very low estimate when first async index cycle hasn&apos;t completed yet, so that the wrong index can be used on first startup.&lt;/p&gt;

&lt;p&gt;NodeCounter#getCombinedCost() should treat non-existing /oak:index/counter/:index same as /oak:index/counter not existing.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13040565">OAK-5587</key>
            <summary>Node counter index estimates must not be used before first async index cycle</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="thomasm">Thomas Mueller</assignee>
                                    <reporter username="thomasm">Thomas Mueller</reporter>
                        <labels>
                    </labels>
                <created>Mon, 6 Feb 2017 08:52:11 +0000</created>
                <updated>Tue, 8 Oct 2019 15:21:43 +0000</updated>
                            <resolved>Tue, 7 Feb 2017 15:40:44 +0000</resolved>
                                                    <fixVersion>1.6.1</fixVersion>
                    <fixVersion>1.8.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15855750" author="tmueller" created="Tue, 7 Feb 2017 10:55:15 +0000"  >&lt;p&gt;We can check if the hidden node &quot;/oak:index/counter/:index&quot; data exists. There are 3 cases where the node doesn&apos;t exist:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;a) The index update was never run so far (at first startup, before the index update was run)&lt;/li&gt;
	&lt;li&gt;b) There are very few nodes in the repository (unlikely)&lt;/li&gt;
	&lt;li&gt;c) The node counter index was removed (unlikely)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;For cases a) and c), the node counter needs to report that the number of nodes is unknown. For case b), it would be best if the estimated number of nodes is low, however it is hard or impossible to distinguish that case. So my patch will also return &quot;unknown&quot; in that case; I don&apos;t think this is a problem.&lt;/p&gt;</comment>
                            <comment id="15855763" author="tmueller" created="Tue, 7 Feb 2017 11:04:16 +0000"  >&lt;p&gt;Proposed patch. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=catholicon&quot; class=&quot;user-hover&quot; rel=&quot;catholicon&quot;&gt;catholicon&lt;/a&gt; could you please review?&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;--- src/main/java/org/apache/jackrabbit/oak/plugins/index/counter/jmx/NodeCounter.java	(revision 1781976)
+++ src/main/java/org/apache/jackrabbit/oak/plugins/index/counter/jmx/NodeCounter.java	(working copy)
@@ -123,6 +123,10 @@
             return -1;
         }
         s = child(s, NodeCounterEditor.DATA_NODE_NAME);
+        if (!s.exists()) {
+            // no index data (not yet indexed, or very few nodes)
+            return -1;
+        }        
         s = child(s, PathUtils.elements(path));
         if (s == null || !s.exists()) {
             // we have an index, but no data
@@ -164,6 +168,10 @@
             return -1;
         }
         s = child(s, NodeCounterEditor.DATA_NODE_NAME);
+        if (!s.exists()) {
+            // no index data (not yet indexed, or very few nodes)
+            return -1;
+        }
         s = child(s, PathUtils.elements(path));
         if (s != null &amp;amp;&amp;amp; s.exists()) {
             value = getCombinedCountIfAvailable(s);
Index: src/test/java/org/apache/jackrabbit/oak/plugins/index/counter/NodeCounterIndexTest.java
===================================================================
--- src/test/java/org/apache/jackrabbit/oak/plugins/index/counter/NodeCounterIndexTest.java	(revision 0)
+++ src/test/java/org/apache/jackrabbit/oak/plugins/index/counter/NodeCounterIndexTest.java	(working copy)
@@ -0,0 +1,150 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one or more
+ * contributor license agreements.  See the NOTICE file distributed with
+ * this work for additional information regarding copyright ownership.
+ * The ASF licenses this file to You under the Apache License, Version 2.0
+ * (the &quot;License&quot;); you may not use this file except in compliance with
+ * the License.  You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package org.apache.jackrabbit.oak.plugins.index.counter;
+
+import static org.apache.jackrabbit.oak.api.QueryEngine.NO_MAPPINGS;
+import static org.junit.Assert.assertFalse;
+import static org.junit.Assert.assertNotNull;
+import static org.junit.Assert.assertTrue;
+
+import java.text.ParseException;
+import java.util.concurrent.TimeUnit;
+
+import javax.annotation.Nullable;
+
+import org.apache.jackrabbit.oak.Oak;
+import org.apache.jackrabbit.oak.api.ContentRepository;
+import org.apache.jackrabbit.oak.api.ContentSession;
+import org.apache.jackrabbit.oak.api.PropertyValue;
+import org.apache.jackrabbit.oak.api.QueryEngine;
+import org.apache.jackrabbit.oak.api.Result;
+import org.apache.jackrabbit.oak.api.ResultRow;
+import org.apache.jackrabbit.oak.api.Root;
+import org.apache.jackrabbit.oak.plugins.index.AsyncIndexUpdate;
+import org.apache.jackrabbit.oak.plugins.index.property.PropertyIndexEditorProvider;
+import org.apache.jackrabbit.oak.plugins.memory.MemoryNodeStore;
+import org.apache.jackrabbit.oak.plugins.nodetype.write.InitialContent;
+import org.apache.jackrabbit.oak.spi.security.OpenSecurityProvider;
+import org.apache.jackrabbit.oak.spi.state.NodeStateUtils;
+import org.apache.jackrabbit.oak.spi.state.NodeStore;
+import org.apache.jackrabbit.oak.spi.whiteboard.Whiteboard;
+import org.apache.jackrabbit.oak.spi.whiteboard.WhiteboardUtils;
+import org.junit.Before;
+import org.junit.Test;
+
+import com.google.common.base.Predicate;
+
+public class NodeCounterIndexTest {
+
+    Whiteboard wb;
+    NodeStore nodeStore;
+    Root root;
+    QueryEngine qe;
+    ContentSession session;
+    
+    @Before
+    public void before() throws Exception {
+        session = createRepository().login(null, null);
+        root = session.getLatestRoot();
+        qe = root.getQueryEngine();
+    }
+    
+    @Test
+    public void testNotUsedBeforeValid() throws Exception {
+        // no index data before indexing
+        assertFalse(nodeExists(&quot;oak:index/counter/:index&quot;));
+        // so, cost for traversal is high
+        assertTrue(getCost(&quot;/jcr:root//*&quot;) &amp;gt;= 1.0E8);
+        
+        runAsyncIndex();
+        // sometimes, the :index node doesn&apos;t exist because there are very few
+        // nodes (randomly, because the seed value of the node counter is random
+        // by design) - so we create nodes until the index exists
+        // (we could use a fixed seed to ensure this is not the case,
+        // but creating nodes has the same effect)
+        root.getTree(&quot;/&quot;).addChild(&quot;test&quot;);
+        for (int i = 0; !nodeExists(&quot;oak:index/counter/:index&quot;); i++) {
+            assertTrue(&quot;index not ready after 1 million nodes&quot;, i &amp;lt; 1000000);
+            root.getTree(&quot;/test&quot;).addChild(&quot;n&quot; + i);
+            if (i % 1000 == 0) {
+                root.commit();
+                runAsyncIndex();
+            }
+        }
+
+        // because we do have node counter data,
+        // cost for traversal is low
+        assertTrue(getCost(&quot;/jcr:root//*&quot;) &amp;lt; 1.0E8);
+
+        // remove the counter index
+        root.getTree(&quot;/oak:index/counter&quot;).remove();
+        root.commit();
+        assertFalse(nodeExists(&quot;oak:index/counter&quot;));
+        // so, cost for traversal is high again
+        assertTrue(getCost(&quot;/jcr:root//*&quot;) &amp;gt;= 1.0E8);
+    }
+    
+    private double getCost(String xpath) throws ParseException {
+        String plan = executeXPathQuery(&quot;explain measure &quot; + xpath);
+        String cost = plan.substring(plan.lastIndexOf(&quot;cost:&quot;) + &quot;cost:&quot;.length());
+        cost = cost.substring(cost.indexOf(&quot;:&quot;) + 1, cost.indexOf(&quot;}&quot;)).trim();
+        return Double.parseDouble(cost);
+    }
+    
+    private boolean nodeExists(String path) {
+        return NodeStateUtils.getNode(nodeStore.getRoot(), path).exists();
+    }
+    
+    protected String executeXPathQuery(String statement) throws ParseException {
+        Result result = qe.executeQuery(statement, &quot;xpath&quot;, null, NO_MAPPINGS);
+        StringBuilder buff = new StringBuilder();
+        for (ResultRow row : result.getRows()) {
+            for(PropertyValue v : row.getValues()) {
+                buff.append(v);
+            }
+        }
+        return buff.toString();
+    }
+    
+    protected ContentRepository createRepository() {
+        nodeStore = new MemoryNodeStore();
+        Oak oak = new Oak(nodeStore)
+                .with(new InitialContent())
+                .with(new OpenSecurityProvider())
+                .with(new PropertyIndexEditorProvider())
+                .with(new NodeCounterEditorProvider())
+                //Effectively disable async indexing auto run
+                //such that we can control run timing as per test requirement
+                .withAsyncIndexing(&quot;async&quot;, TimeUnit.DAYS.toSeconds(1));
+
+        wb = oak.getWhiteboard();
+        return oak.createContentRepository();
+    }
+    
+    private void runAsyncIndex() {
+        Runnable async = WhiteboardUtils.getService(wb, Runnable.class, new Predicate&amp;lt;Runnable&amp;gt;() {
+            @Override
+            public boolean apply(@Nullable Runnable input) {
+                return input instanceof AsyncIndexUpdate;
+            }
+        });
+        assertNotNull(async);
+        async.run();
+        root.refresh();
+    }
+
+}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15855801" author="catholicon" created="Tue, 7 Feb 2017 11:31:20 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thomasm&quot; class=&quot;user-hover&quot; rel=&quot;thomasm&quot;&gt;thomasm&lt;/a&gt;, fix lgtm. I&apos;ve a bit of concern about the length of test though (as it&apos;s creating a lot of nodes to hit counter probabilities). Would it be possible to increase the chances of updating counter in test instead of putting in a lot of nodes?&lt;/p&gt;</comment>
                            <comment id="15855806" author="tmueller" created="Tue, 7 Feb 2017 11:36:11 +0000"  >&lt;p&gt;Still working on this, as the change breaks some tests (for good, because the tests assume the counter index is up-to-date, without verifying it): oak-jcr QueryPlanTest.nodeType and QueryTest.approxCount.&lt;/p&gt;</comment>
                            <comment id="15855917" author="tmueller" created="Tue, 7 Feb 2017 12:45:44 +0000"  >&lt;p&gt;&amp;gt;  I&apos;ve a bit of concern about the length of test though&lt;/p&gt;

&lt;p&gt;The loop only runs rarely (about one of 10 test runs), and in most cases it only creates 5000 nodes or so. But you are right, it&apos;s unfortunate that so many nodes are needed. I will change the resolution of the counter index to 100, so that the probability of this loop is much lower.&lt;/p&gt;</comment>
                            <comment id="15856089" author="tmueller" created="Tue, 7 Feb 2017 14:30:54 +0000"  >&lt;p&gt;&lt;a href=&quot;http://svn.apache.org/r1782000&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1782000&lt;/a&gt; (trunk)&lt;/p&gt;

&lt;p&gt;The actual change is very small; most of the changes are about testing. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=catholicon&quot; class=&quot;user-hover&quot; rel=&quot;catholicon&quot;&gt;catholicon&lt;/a&gt; I believe your concerns are addressed, but could you verify before I commit to the 1.6 branch?&lt;/p&gt;</comment>
                            <comment id="15856118" author="catholicon" created="Tue, 7 Feb 2017 14:43:58 +0000"  >&lt;p&gt;Yes, the change lgtm. Also, I like the tests too now with resolution at 100 &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.&lt;/p&gt;</comment>
                            <comment id="15856190" author="tmueller" created="Tue, 7 Feb 2017 15:21:15 +0000"  >&lt;p&gt;Thanks!&lt;br/&gt;
&lt;a href=&quot;http://svn.apache.org/r1782011&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1782011&lt;/a&gt; (1.6 branch)&lt;/p&gt;</comment>
                            <comment id="15897332" author="edivad" created="Mon, 6 Mar 2017 13:51:20 +0000"  >&lt;p&gt;Bulk close for 1.6.1&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 36 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i39nhb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>