<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:53:35 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-7070] rep:excerpt selector broken as regression of OAK-6750</title>
                <link>https://issues.apache.org/jira/browse/OAK-7070</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;The change made here:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/jackrabbit-oak/commit/00c94b71293abcae6d76bb162c3f55c7d09b702e#diff-d4bdf443c61f24b634f33aab607e2114&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/jackrabbit-oak/commit/00c94b71293abcae6d76bb162c3f55c7d09b702e#diff-d4bdf443c61f24b634f33aab607e2114&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;breaks the logic in line 676:&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;else if (oakPropertyName.equals(QueryConstants.REP_EXCERPT + &quot;(&quot;))&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;This statement doesn&apos;t make much sense considering a query like &lt;tt&gt;select [rep:excerpt] from [test:Page] as page where contains(&amp;#42;, &apos;term&amp;#42;&apos;)&lt;/tt&gt; or even &lt;tt&gt;select [rep:excerpt(text)] from [test:Page] as page where contains(page.[text], &apos;term&amp;#42;&apos;)&lt;/tt&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13125455">OAK-7070</key>
            <summary>rep:excerpt selector broken as regression of OAK-6750</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="catholicon">Vikas Saurabh</assignee>
                                    <reporter username="diru">Dirk Rudolph</reporter>
                        <labels>
                            <label>excerpt</label>
                    </labels>
                <created>Sun, 17 Dec 2017 09:41:15 +0000</created>
                <updated>Sat, 30 Dec 2017 09:05:54 +0000</updated>
                            <resolved>Tue, 19 Dec 2017 10:13:21 +0000</resolved>
                                    <version>1.6.7</version>
                    <version>1.8.0</version>
                                    <fixVersion>1.7.14</fixVersion>
                    <fixVersion>1.4.19</fixVersion>
                    <fixVersion>1.6.8</fixVersion>
                    <fixVersion>1.8.0</fixVersion>
                                    <component>lucene</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="16294060" author="diru" created="Sun, 17 Dec 2017 09:56:27 +0000"  >&lt;p&gt;As far as I can see there are the following selectors in sql2 queries for excerpts supported:&lt;/p&gt;

&lt;p&gt;1) &lt;span class=&quot;error&quot;&gt;&amp;#91;rep:excerpt&amp;#93;&lt;/span&gt;&lt;br/&gt;
2) &lt;span class=&quot;error&quot;&gt;&amp;#91;rep:excerpt(.)&amp;#93;&lt;/span&gt;&lt;br/&gt;
3) &lt;span class=&quot;error&quot;&gt;&amp;#91;rep:excerpt(propertyName)&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;The expression previous to &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-6750&quot; title=&quot;Lucene facets don&amp;#39;t work with relative properties&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-6750&quot;&gt;&lt;del&gt;OAK-6750&lt;/del&gt;&lt;/a&gt; includes only 1), where as a change to &lt;tt&gt;startsWith&lt;/tt&gt; with trailing opening bracket (similar as to the facets) would only include 2) and 3). Though without the trailing opening bracket a bit to much might get consumed there so my suggestion is to use a disjunction of the both above. &lt;/p&gt;</comment>
                            <comment id="16294062" author="catholicon" created="Sun, 17 Dec 2017 09:59:49 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=diru&quot; class=&quot;user-hover&quot; rel=&quot;diru&quot;&gt;diru&lt;/a&gt;, do you have a test case which fails? Afair, there already are tests which pass even with the change you mentioned in the description.&lt;/p&gt;</comment>
                            <comment id="16294063" author="diru" created="Sun, 17 Dec 2017 10:06:45 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=catholicon&quot; class=&quot;user-hover&quot; rel=&quot;catholicon&quot;&gt;catholicon&lt;/a&gt; see the case in &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-6597&quot; title=&quot;rep:excerpt not working for content indexed by aggregation in lucene&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-6597&quot;&gt;OAK-6597&lt;/a&gt; (i&apos;&apos;m currently working on) - it links to a ticket where a (currently disabled) test was added which was ok for 1 of the cases but failing for the second one. Now its failing for both. Though thats not 100% related so let me propose one.&lt;/p&gt;

&lt;p&gt;Which test case are you referring to?&lt;/p&gt;</comment>
                            <comment id="16294065" author="catholicon" created="Sun, 17 Dec 2017 10:12:23 +0000"  >&lt;p&gt;one example case is &lt;tt&gt;LucenePropertyIndexTest#longRepExcerpt&lt;/tt&gt; [0]. A quick search showed that some oak-jcr tests do test excerpt on a property too using xpath (I haven&apos;t checked how the converted sql looks like in those cases though).&lt;/p&gt;

&lt;p&gt;[0]: &lt;a href=&quot;https://github.com/apache/jackrabbit-oak/blob/trunk/oak-lucene/src/test/java/org/apache/jackrabbit/oak/plugins/index/lucene/LucenePropertyIndexTest.java#L2418&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/jackrabbit-oak/blob/trunk/oak-lucene/src/test/java/org/apache/jackrabbit/oak/plugins/index/lucene/LucenePropertyIndexTest.java#L2418&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16294066" author="diru" created="Sun, 17 Dec 2017 10:12:42 +0000"  >&lt;p&gt;To answer my own question: there is &lt;a href=&quot;https://github.com/apache/jackrabbit-oak/blob/trunk/oak-lucene/src/test/java/org/apache/jackrabbit/oak/plugins/index/lucene/LucenePropertyIndexTest.java#L2394&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;longRepExcerpt test&lt;/a&gt; which queries for for &lt;span class=&quot;error&quot;&gt;&amp;#91;rep:excerpt&amp;#93;&lt;/span&gt; but doesn&apos;t asserts its value from the result. &lt;/p&gt;

&lt;p&gt;The issue caused by that is that the rep:except in the result is null, not that the query is failing.&lt;/p&gt;

&lt;p&gt;... this is because executeQuery(java.lang.String, java.lang.String, boolean, boolean) is called with pathsOnly.&lt;/p&gt;</comment>
                            <comment id="16294068" author="catholicon" created="Sun, 17 Dec 2017 10:15:31 +0000"  >&lt;p&gt;Ah!... ok... got it. Assigning this issue to myself.&lt;/p&gt;</comment>
                            <comment id="16294069" author="diru" created="Sun, 17 Dec 2017 10:16:46 +0000"  >&lt;p&gt;I have a PR almost ready (fixing the Test and the issue) - If you want to?&lt;/p&gt;</comment>
                            <comment id="16294070" author="catholicon" created="Sun, 17 Dec 2017 10:20:35 +0000"  >&lt;p&gt;Yup, pr would be most welcome. Also, please add at least one test so that this doesn&apos;t get messed up again. If you can cover the three cases you mentioned, then that would be awesome.&lt;/p&gt;

&lt;p&gt;BTW, I would not be able to take a look at pr today.&lt;/p&gt;</comment>
                            <comment id="16294082" author="diru" created="Sun, 17 Dec 2017 11:00:45 +0000"  >&lt;p&gt;Ok in the query parsing there is a different issue: &lt;/p&gt;

&lt;p&gt;The SQL2Parser doesn&apos;t properly parse rep:excerpt(.) and rep:excerpt(propertyName), but expects EXCERPT as keyword, see &lt;a href=&quot;https://github.com/apache/jackrabbit-oak/blob/trunk/oak-core/src/main/java/org/apache/jackrabbit/oak/query/SQL2Parser.java#L902&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;SQL2Parser.java#L902&lt;/a&gt;. So for example rep:excerpt(.) is interpreted as normal propertyName and goes to &lt;a href=&quot;https://github.com/apache/jackrabbit-oak/blob/trunk/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/SelectorImpl.java#L392&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;SelectorImpl.java#L392&lt;/a&gt; where its not taken into account due to checking for equality. &lt;/p&gt;

&lt;p&gt;I cannot find anything about the EXCERPT in the jcr-sql2 specs, but for facets there is nothing special in the SQL2Parser, so I assume we keep it like that as it is and adapt the SelectorImpl further instead. &lt;/p&gt;</comment>
                            <comment id="16294092" author="diru" created="Sun, 17 Dec 2017 11:24:24 +0000"  >&lt;p&gt;Following up with &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-4401&quot; title=&quot;Excerpt Highlighting for a property is not correct &quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-4401&quot;&gt;&lt;del&gt;OAK-4401&lt;/del&gt;&lt;/a&gt; it looks like rep:excerpt(propertyName) and rep:excerpt(.) are not meant to be used as columns in jcr-sql2 but to get an excerpt based on a result row. &lt;/p&gt;

&lt;p&gt;This is at least also the same behaviour as implemented in &lt;a href=&quot;https://github.com/apache/jackrabbit-oak/blob/trunk/oak-core/src/main/java/org/apache/jackrabbit/oak/query/xpath/XPathToSQL2Converter.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;XPathToSQL2Converter.java&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16294104" author="diru" created="Sun, 17 Dec 2017 11:35:00 +0000"  >&lt;p&gt;I opened a PR here: &lt;a href=&quot;https://github.com/apache/jackrabbit-oak/pull/75&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/jackrabbit-oak/pull/75&lt;/a&gt;. It would be great to get that applied to 1.6 and 1.7 branches as well (for backward compatibility in AEM 6.3)&lt;/p&gt;</comment>
                            <comment id="16296541" author="catholicon" created="Tue, 19 Dec 2017 09:35:24 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=diru&quot; class=&quot;user-hover&quot; rel=&quot;diru&quot;&gt;diru&lt;/a&gt;, afaiu, the reason you opened the issue is that for a query like - &lt;tt&gt;SELECT &lt;span class=&quot;error&quot;&gt;&amp;#91;jcr:path&amp;#93;&lt;/span&gt;,&lt;span class=&quot;error&quot;&gt;&amp;#91;rep:excerpt&amp;#93;&lt;/span&gt; from &lt;span class=&quot;error&quot;&gt;&amp;#91;nt:base&amp;#93;&lt;/span&gt; WHERE CONTAINS(&amp;#42;, &apos;ipsum&apos;)&lt;/tt&gt;, doing &lt;tt&gt;resultRow.getValue(&quot;rep:excerpt&quot;)&lt;/tt&gt; doesn&apos;t work anymore (while &lt;tt&gt;getValue(&quot;rep:ecerpt(.)&quot;)&lt;/tt&gt; and &lt;tt&gt;getValue(&quot;rep:excerpt(bar)&quot;)&lt;/tt&gt; still works.&lt;/p&gt;

&lt;p&gt;Is that understanding correct? I&apos;d apply you patch to trunk in a bit... but, I&apos;m not sure about the bug being &quot;Major&quot; and if we should backport it.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;There is still the risk, that duplication appear in the excerpt because there is a highlighting hit in :fulltext and one for example in full:bar. To prevent that, it probably makes sense to first do the highlighting on :fulltext fields when analyzeFulltext is enabled and only if that hasn&apos;t been success full we fallback to the logic of highlighting full: fields. wdyt?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I&apos;m guessing you meant to put that comment on &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-6597&quot; title=&quot;rep:excerpt not working for content indexed by aggregation in lucene&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-6597&quot;&gt;OAK-6597&lt;/a&gt; instead!?&lt;/p&gt;</comment>
                            <comment id="16296560" author="diru" created="Tue, 19 Dec 2017 09:50:40 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=catholicon&quot; class=&quot;user-hover&quot; rel=&quot;catholicon&quot;&gt;catholicon&lt;/a&gt; Your understanding is correct. And yes, I will move the comment to &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-6597&quot; title=&quot;rep:excerpt not working for content indexed by aggregation in lucene&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-6597&quot;&gt;OAK-6597&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;To give a bit more context: I&apos;m working currently on an AEM 6.3 project implementing fulltext search and we recently upgraded to 1.6.7 to make use of the changes in &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-6750&quot; title=&quot;Lucene facets don&amp;#39;t work with relative properties&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-6750&quot;&gt;&lt;del&gt;OAK-6750&lt;/del&gt;&lt;/a&gt;. Though our requirements also ask for excerpts and that&apos;s why I investigated in &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-6597&quot; title=&quot;rep:excerpt not working for content indexed by aggregation in lucene&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-6597&quot;&gt;OAK-6597&lt;/a&gt; as well and asked there for a backport it to 1.6. As this is blocking &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-6597&quot; title=&quot;rep:excerpt not working for content indexed by aggregation in lucene&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-6597&quot;&gt;OAK-6597&lt;/a&gt; and if we agree on making &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-6597&quot; title=&quot;rep:excerpt not working for content indexed by aggregation in lucene&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-6597&quot;&gt;OAK-6597&lt;/a&gt; available in 1.6 I would still like to backport it. The risk should be minimal and afaik I applied those changes to my for of 1.6 without any problems. Don&apos;t doing so opens the risk for us to use an unoffical port of oak for our project - or rejecting some of the customers requirements. This also comes together with &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-7078&quot; title=&quot;NullPointerException in FilteredSortedSetDocValuesFacetCounts during query evaluation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-7078&quot;&gt;&lt;del&gt;OAK-7078&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-7071&quot; title=&quot;PostingsHighlighter, Highlighter and SimpleExcerptProvider return all different formats for excerpts&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-7071&quot;&gt;OAK-7071&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="16296590" author="catholicon" created="Tue, 19 Dec 2017 10:13:21 +0000"  >&lt;p&gt;Fixed in trunk at &lt;a href=&quot;https://svn.apache.org/r1818645&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;r1818645&lt;/a&gt;, 1.6 at &lt;a href=&quot;https://svn.apache.org/r1818652&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;r1818652&lt;/a&gt; and on 1.4 at &lt;a href=&quot;https://svn.apache.org/r1818657&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;r1818657&lt;/a&gt;.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="13098388">OAK-6597</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                                                <inwardlinks description="is broken by">
                                        <issuelink>
            <issuekey id="13106272">OAK-6750</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 47 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3nznb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>