<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:50:44 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-4358] Stale cluster ids can potentially lead to lots of previous docs traversal in NodeDocument.getNewestRevision</title>
                <link>https://issues.apache.org/jira/browse/OAK-4358</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;When some (actual test case and conditions still being investigated) of the following conditions are met:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;There are property value changes from different cluster id&lt;/li&gt;
	&lt;li&gt;There are very old and stale cluster id (probably older incarnations of current node itself)&lt;/li&gt;
	&lt;li&gt;A parallel background split removes all _commitRoot, _revision entries such that the latest one (which is less that baseRev) is very old&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;, finding newest revision traverses a lot of previous docs. Since root document gets split a lot and is a very common commitRoot (thus participating during checkConflicts in lot of commits), the issue can slow down commits by a lot&lt;/p&gt;</description>
                <environment></environment>
        <key id="12967340">OAK-4358</key>
            <summary>Stale cluster ids can potentially lead to lots of previous docs traversal in NodeDocument.getNewestRevision</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mreutegg">Marcel Reutegger</assignee>
                                    <reporter username="catholicon">Vikas Saurabh</reporter>
                        <labels>
                    </labels>
                <created>Wed, 11 May 2016 09:09:46 +0000</created>
                <updated>Thu, 10 Nov 2016 09:44:55 +0000</updated>
                            <resolved>Tue, 31 May 2016 21:05:51 +0000</resolved>
                                    <version>1.4.0</version>
                                    <fixVersion>1.4.4</fixVersion>
                    <fixVersion>1.5.3</fixVersion>
                    <fixVersion>1.6.0</fixVersion>
                                    <component>documentmk</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="15283355" author="catholicon" created="Sat, 14 May 2016 01:15:56 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mreutegg&quot; class=&quot;user-hover&quot; rel=&quot;mreutegg&quot;&gt;mreutegg&lt;/a&gt;, As discussed, I was trying to do optimized iteration in getChanges(prop, minRev) to then change the logic in getNewestRevision to do max(getChanges(_revision), getChanges(_commitRoot)). Here&apos;s a test that I was working with (adaptation of existing &lt;tt&gt;getChangesMixedClusterIds&lt;/tt&gt;):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;@Test
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void getChangesMixedClusterIdsTooManyPrevDocsRead() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; numChanges = 200;
    Random random = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Random();
    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; List&amp;lt;RevisionVector&amp;gt; splitHeads = Lists.newArrayList();
    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; SPLIT_DOC_IDX = 4;&lt;span class=&quot;code-comment&quot;&gt;//the test fails &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; 0 too... I&apos;m just being conservative though!
&lt;/span&gt;    MemoryDocumentStore store = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; MemoryDocumentStore() {
        @Override
        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &amp;lt;T &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; Document&amp;gt; T find(Collection&amp;lt;T&amp;gt; collection,
                                           &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; key) {
            &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; path = Utils.getPathFromId(key);
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (path.startsWith(&lt;span class=&quot;code-quote&quot;&gt;&quot;p&quot;&lt;/span&gt;)) {
                RevisionVector minRevBeingRead = splitHeads.get(splitHeads.size() - SPLIT_DOC_IDX - 1);
                &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; maxRevStrInSplitTree = path.substring(2, path.length()-2);
                Revision maxRevInSplitTree = Revision.fromString(maxRevStrInSplitTree);
                assertFalse(&lt;span class=&quot;code-quote&quot;&gt;&quot;Previous doc (&quot;&lt;/span&gt; + key + &lt;span class=&quot;code-quote&quot;&gt;&quot;) read &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; min rev &quot;&lt;/span&gt; + minRevBeingRead
                    , !minRevBeingRead.isRevisionNewer(maxRevInSplitTree));
            }
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;.find(collection, key);
        }
    };
    DocumentNodeStore ns1 = createTestStore(store, 1, 0);
    DocumentNodeStore ns2 = createTestStore(store, 2, 0);
    List&amp;lt;DocumentNodeStore&amp;gt; nodeStores = Lists.newArrayList(ns1, ns2);

    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; numChanges; i++) {
        DocumentNodeStore ns = nodeStores.get(random.nextInt(nodeStores.size()));
        ns.runBackgroundOperations();
        NodeBuilder builder = ns.getRoot().builder();
        builder.setProperty(&lt;span class=&quot;code-quote&quot;&gt;&quot;p&quot;&lt;/span&gt;, i);
        merge(ns, builder);
        ns.runBackgroundOperations();
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (random.nextDouble() &amp;lt; 0.2) {
            RevisionVector splitHead = ns.getHeadRevision();
            splitHeads.add(splitHead);
            &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (UpdateOp op : SplitOperations.forDocument(
                    getRootDocument(store), ns, splitHead,
                    Predicates.&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt;alwaysFalse(), 2)) {
                store.createOrUpdate(NODES, op);
            }
        }
    }

    NodeDocument doc = getRootDocument(store);

    RevisionVector minRevBeingRead = splitHeads.get(splitHeads.size() - SPLIT_DOC_IDX - 1);
    Lists.newArrayList(doc.getChanges(&lt;span class=&quot;code-quote&quot;&gt;&quot;p&quot;&lt;/span&gt;, minRevBeingRead));

    ns1.dispose();
    ns2.dispose();
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I think the assertion that NO previous doc should be read which is strictly older than minRevVector got a little bit too strict (as fixing that seemed like we&apos;d need to introduce some min concept in reading &lt;tt&gt;PropertyHistory&lt;/tt&gt;).&lt;/p&gt;

&lt;p&gt;In the end, I think it&apos;d be beyond my comfort level to fix the issue. If the test seems fine, I can post similar one for getNewestRevision as well. Assigning the issue to you though (would be trying some stuff anyway in the mean time)&lt;/p&gt;</comment>
                            <comment id="15308611" author="mreutegg" created="Tue, 31 May 2016 21:00:02 +0000"  >&lt;p&gt;Added a test (currently ignored): &lt;a href=&quot;http://svn.apache.org/r1746342&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1746342&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15308618" author="mreutegg" created="Tue, 31 May 2016 21:05:31 +0000"  >&lt;p&gt;Implemented fix and enabled test: &lt;a href=&quot;http://svn.apache.org/r1746345&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1746345&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=catholicon&quot; class=&quot;user-hover&quot; rel=&quot;catholicon&quot;&gt;catholicon&lt;/a&gt;, can you please review?&lt;/p&gt;</comment>
                            <comment id="15308672" author="mreutegg" created="Tue, 31 May 2016 21:35:21 +0000"  >&lt;p&gt;Merged ignored test into 1.4 branch: &lt;a href=&quot;http://svn.apache.org/r1746353&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1746353&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15309390" author="catholicon" created="Wed, 1 Jun 2016 06:36:20 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mreutegg&quot; class=&quot;user-hover&quot; rel=&quot;mreutegg&quot;&gt;mreutegg&lt;/a&gt;, lgtm. I&apos;d work a bit to add some tests for getChanges() too.&lt;/p&gt;</comment>
                            <comment id="15324225" author="edivad" created="Fri, 10 Jun 2016 10:35:00 +0000"  >&lt;p&gt;Bulk close for 1.5.3&lt;/p&gt;</comment>
                            <comment id="15329629" author="mreutegg" created="Tue, 14 Jun 2016 15:03:34 +0000"  >&lt;p&gt;Merged change into 1.4 branch: &lt;a href=&quot;http://svn.apache.org/r1748428&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1748428&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 22 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2xk7j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>