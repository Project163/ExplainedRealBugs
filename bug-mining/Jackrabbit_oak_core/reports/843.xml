<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:43:46 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-1696] Repository  fails to restart on Windows</title>
                <link>https://issues.apache.org/jira/browse/OAK-1696</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;Restarting an application running Oak/SegmentMK/Memory Mapped files fails to restart with following exception&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;07.04.2014 16:50:22.679 ERROR [FelixStartLevel] org.apache.jackrabbit.oak-core [org.apache.jackrabbit.oak.plugins.segment.SegmentNodeStoreService(46)] The activate method has thrown an exception (java.io.IOException: Could not backup tar file E:\CQ_6.0\author\crx-quickstart\repository\segmentstore\data00003a.tar)
java.io.IOException: Could not backup tar file E:\CQ_6.0\author\crx-quickstart\repository\segmentstore\data00003a.tar
at org.apache.jackrabbit.oak.plugins.segment.file.TarReader.open(TarReader.java:109)
at org.apache.jackrabbit.oak.plugins.segment.file.FileStore.&amp;lt;init&amp;gt;(FileStore.java:172)
at org.apache.jackrabbit.oak.plugins.segment.file.FileStore.&amp;lt;init&amp;gt;(FileStore.java:134)
at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeStoreService.registerNodeStore(SegmentNodeStoreService.java:151)
at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeStoreService.activate(SegmentNodeStoreService.java:119)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>&lt;p&gt;Windows&lt;/p&gt;</environment>
        <key id="12707131">OAK-1696</key>
            <summary>Repository  fails to restart on Windows</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jukkaz">Jukka Zitting</assignee>
                                    <reporter username="chetanm">Chetan Mehrotra</reporter>
                        <labels>
                    </labels>
                <created>Tue, 8 Apr 2014 08:24:19 +0000</created>
                <updated>Mon, 23 Mar 2015 16:00:15 +0000</updated>
                            <resolved>Mon, 14 Apr 2014 03:57:40 +0000</resolved>
                                    <version>0.20</version>
                                    <fixVersion>1.0</fixVersion>
                                    <component>segmentmk</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13962706" author="chetanm" created="Tue, 8 Apr 2014 08:37:26 +0000"  >&lt;p&gt;The failure happens while renaming the tar file for backup at &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;. Before the rename the file was open with memory mapping and data was read from that. Looks like on Windows renaming a file which has been opened in memory mapped causes issues &lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;.&lt;/p&gt;

&lt;p&gt;We can do one of the possible things&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Unmap the file upon close - By default Java does not allow unmapping a mapped file &lt;span class=&quot;error&quot;&gt;&amp;#91;3&amp;#93;&lt;/span&gt;, &lt;span class=&quot;error&quot;&gt;&amp;#91;6&amp;#93;&lt;/span&gt;. The file handles are only closed upon GC. There is workaround for Oracle/Sun JDK where you can do that via reflection but that is not advisable. Though quite a few OS libraries use that &lt;span class=&quot;error&quot;&gt;&amp;#91;4&amp;#93;&lt;/span&gt; its still not safe&lt;/li&gt;
	&lt;li&gt;Use memory mapping when a file is to be opened for longer time. For all other case use RandomAccessFile&lt;/li&gt;
	&lt;li&gt;Do away with memory mapped files for Windows all together.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Probably as a short term sol (for 1.0) we can disable memory mapping for Windows and enable it only for Unix env&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://github.com/apache/jackrabbit-oak/blob/trunk/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/file/TarReader.java#L101-101&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/jackrabbit-oak/blob/trunk/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/file/TarReader.java#L101-101&lt;/a&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://bugs.openjdk.java.net/browse/JDK-8028683&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://bugs.openjdk.java.net/browse/JDK-8028683&lt;/a&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;3&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://bugs.openjdk.java.net/browse/JDK-4724038&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://bugs.openjdk.java.net/browse/JDK-4724038&lt;/a&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;4&amp;#93;&lt;/span&gt; &lt;a href=&quot;http://lucene.apache.org/core/3_5_0/api/all/org/apache/lucene/store/MMapDirectory.html#setUseUnmap%28boolean%29&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://lucene.apache.org/core/3_5_0/api/all/org/apache/lucene/store/MMapDirectory.html#setUseUnmap%28boolean%29&lt;/a&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;6&amp;#93;&lt;/span&gt; bugs.sun.com/bugdatabase/view_bug.do?bug_id=4724038&lt;/p&gt;</comment>
                            <comment id="13963093" author="jukkaz" created="Tue, 8 Apr 2014 15:43:41 +0000"  >&lt;p&gt;I don&apos;t think this has to do with memory mapping, assuming the restart involves stopping and starting the full JVM. In that case all memory mappings should in any case have been released when the JVM was closed. It seems more likely that the rename operation would be prevented by something else, like an on-access virus scanner.&lt;/p&gt;</comment>
                            <comment id="13963111" author="jukkaz" created="Tue, 8 Apr 2014 15:55:04 +0000"  >&lt;p&gt;Alternatively, perhaps the original JVM is still running? The stack trace suggests that the repository wasn&apos;t cleanly stopped, which might indicate that the earlier instance is still running. I guess we should use file locking to prevent such cases.&lt;/p&gt;</comment>
                            <comment id="13963122" author="jukkaz" created="Tue, 8 Apr 2014 16:07:24 +0000"  >&lt;p&gt;Hmm, as noted by Chetan, the code in TarReader.open() actually does memory-map the files &lt;em&gt;before&lt;/em&gt; trying the rename. That&apos;s an oversight, as my original design was to do the memory mapping only after the presence of a valid tar index is verified, specifically to avoid this problem. Unfortunately it looks like I forgot that constraint in subsequent refactoring.&lt;/p&gt;</comment>
                            <comment id="13968051" author="jukkaz" created="Mon, 14 Apr 2014 03:57:40 +0000"  >&lt;p&gt;Fixed in revisions 1586364 and 1586372 by postponing memory-mapping to only after the possible recovery operations.&lt;/p&gt;

&lt;p&gt;Also in revision 1587130 I added explicit file locking to prevent the repository from being reopened before it has been shut down (cleanly or not), which might be what happened in this case.&lt;/p&gt;

&lt;p&gt;Merged the above changes to the 1.0 branch in revision 1587135.&lt;/p&gt;

&lt;p&gt;Resolving as fixed.&lt;/p&gt;</comment>
                            <comment id="14017542" author="alex.parvulescu" created="Wed, 4 Jun 2014 10:16:41 +0000"  >&lt;p&gt;bulk close for the 1.0 release&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12784856">OAK-2670</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>385454</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 24 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1uejb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>385721</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>