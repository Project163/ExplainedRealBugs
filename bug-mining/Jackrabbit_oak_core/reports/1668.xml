<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:52:41 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-4529] DocumentNodeStore does not have a repository software version range check</title>
                <link>https://issues.apache.org/jira/browse/OAK-4529</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;DocumentNodeStore does not currently check which software version the persisted repository it is connecting to was created with or last updated. There is a risk that if the versions are incompatible the repository may be damaged.&lt;/p&gt;

&lt;p&gt;Somewhere in the repository, the version of the software that created it, and the versions that written to it should be stored. In the case of TarMK this information could be on local disk near the TarMK files. In the case of a DocumentMK implementation, the information should be stored in the &quot;database&quot; itself.&lt;/p&gt;

&lt;p&gt;When a DocumentNodeStore instance connects it should: check the versions stored in the repository then check the versions are within a compatible range and refuse to start if not.&lt;/p&gt;

&lt;p&gt;When a DocumentNodeStore writes to a repository, it should add its version to the list of versions that have updated the repository.&lt;/p&gt;

&lt;p&gt;This check behaviour should be active in full Oak or any utilities (eg oak-run).&lt;/p&gt;</description>
                <environment></environment>
        <key id="12986558">OAK-4529</key>
            <summary>DocumentNodeStore does not have a repository software version range check</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mreutegg">Marcel Reutegger</assignee>
                                    <reporter username="ianeboston">Ian Boston</reporter>
                        <labels>
                    </labels>
                <created>Mon, 4 Jul 2016 09:13:38 +0000</created>
                <updated>Wed, 24 Jul 2019 14:01:02 +0000</updated>
                            <resolved>Tue, 21 Mar 2017 10:44:24 +0000</resolved>
                                    <version>1.0.31</version>
                    <version>1.2.14</version>
                    <version>1.4.4</version>
                    <version>1.5.4</version>
                                    <fixVersion>1.7.0</fixVersion>
                    <fixVersion>1.8.0</fixVersion>
                                    <component>core</component>
                    <component>documentmk</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15361122" author="catholicon" created="Mon, 4 Jul 2016 10:08:40 +0000"  >&lt;blockquote&gt;&lt;p&gt;check the versions stored in the repository then check the versions are within a compatible range and refuse to start if not.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think utilities like oak-run are always able to read an old format. The issue, of course is that once they write out some data using a potentially new format then the oak version (presumably old) which was using the repo might get confused (e.g. oak-run at trunk would write out revision vectors for checkpoints which would confuse old oak at 1.0 or 1.2).&lt;/p&gt;

&lt;p&gt;So, I think what&apos;s more important is for &lt;del&gt;DNS&lt;/del&gt; DocumentNodeStore instance to be initialized with the fact that the repository needs to be accessible by an older version of oak after any writes that this one does.&lt;/p&gt;</comment>
                            <comment id="15361159" author="ianeboston" created="Mon, 4 Jul 2016 10:58:08 +0000"  >&lt;p&gt;The situation that this issue is trying to protect against is something like this:&lt;/p&gt;

&lt;p&gt;1. Oak production running at 1.0.x&lt;br/&gt;
2. Production JVM stopped&lt;br/&gt;
3. oak-run 1.4 mistakenly used to perform some maintenance. (should have been oak-run 1.0.x)&lt;br/&gt;
4. Production JVM wont start.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;So, I think what&apos;s more important is for DNS instance to be initialized with the fact that the repository needs to be accessible by an older version of oak after any writes that this one does.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think that will cause the issue, not prevent it ?&lt;/p&gt;

&lt;p&gt;imho, Oak should refuse to write to an older repository, where those writes would break that repository for older versions of Oak listed as in use in the repository, unless some form of override is provided eg (eg -Doak.allowRepositoryUpgrade=true), or the versions are removed from the active list in the repository.&lt;/p&gt;

&lt;p&gt;If later versions of Oak cant read older repositories, they should refuse to start, hence the suggestion that DocumentNodeStore should use a range of version to determine what is safe.&lt;/p&gt;

&lt;p&gt;BTW. Perhaps its best not to use DNS when talking about DocumentNodeStore as DNS is widely accepted to mean &lt;a href=&quot;https://en.wikipedia.org/wiki/Domain_Name_System&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://en.wikipedia.org/wiki/Domain_Name_System&lt;/a&gt; and could cause confusion in without context.&lt;/p&gt;

</comment>
                            <comment id="15361244" author="catholicon" created="Mon, 4 Jul 2016 12:29:38 +0000"  >&lt;p&gt;What I meant earlier was that sure, DocumentNodeStore should allow a flag to NOT write to a repo with older version - but the usage of flag should be due to the fact of intent while DocumentNodeStore is being initialized.&lt;br/&gt;
e.g. oak-run must always initialize DocumentNodeStore with this &lt;tt&gt;cautionDontWriteToOld=true&lt;/tt&gt; flag. Otoh, default remains the same (i.e it&apos;s ok to read the repo if you can &amp;#8211; may be we can check based on version too whether we can read the repo.. but that would probably be just a side-use-case of stored written versions)&lt;/p&gt;

&lt;p&gt;I think it&apos;s surely useful to know which version (versions??? why?) wrote to repo. But, the usage of that persisted version is an act of courtesy from later version of oak (since it &apos;can&apos; read... but it chooses not to do so).&lt;/p&gt;

&lt;p&gt;Afaics, the argument is about what should be the default value of &lt;tt&gt;cautionDontWriteToOld&lt;/tt&gt; be? Imho, it should derived from the intent with default being allowed to read if it can - oak-run should instruct DocumentNodeStore accordingly while other initializers remain oblivious to the fact. Moreover, I think upgrades shouldn&apos;t require explicit flag ... handling inconsistencies, if any, should be oak (default initialization or oak-run) internal detail.&lt;/p&gt;</comment>
                            <comment id="15361577" author="ianeboston" created="Mon, 4 Jul 2016 16:44:45 +0000"  >&lt;p&gt;The default behavior should be safe and do no damage, as a user of oak-run or other utilities will not know they are about to corrupt the repository, and when they do, it will be too late. ie safe by default. &lt;br/&gt;
It should be possible to override the default behaviour to allow an upgrade to be performed.&lt;/p&gt;</comment>
                            <comment id="15361765" author="catholicon" created="Mon, 4 Jul 2016 20:25:44 +0000"  >&lt;p&gt;I meant that oak-run should take the responsibility to tell DocumentNodeStore that it shouldn&apos;t write to old repos. End user (of AEM, oak, oak-run, any other tool) shouldn&apos;t have to worry about such flag (at least on the best effort basis).&lt;/p&gt;</comment>
                            <comment id="15818375" author="tmueller" created="Wed, 11 Jan 2017 13:44:29 +0000"  >&lt;p&gt;It might be possible to open the repository in read-only mode; for that, then a &quot;read&quot; and a &quot;write&quot; version could be used, as this is done in SQLite for example (&lt;a href=&quot;https://www.sqlite.org/fileformat.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://www.sqlite.org/fileformat.html&lt;/a&gt; - File Format Version Numbers). So that it&apos;s possible to open a repository in read-only mode, if the read-version is the same. (copied from mail thread &quot;issues introducing non-reversible changes in the repository&quot;)&lt;/p&gt;</comment>
                            <comment id="15899462" author="mreutegg" created="Tue, 7 Mar 2017 13:52:26 +0000"  >&lt;p&gt;Attached a work-in-progress patch. It introduces a new document in the settings collection that contains a format version. Reading the current and older versions is possible, but the DocumentNodeStore will fail to start when it detects a newer format than itself. A DocumentNodeStore can only write to a store with the same format version. An upgrade to a newer version must be &apos;unlocked&apos; first with an oak-run command. This only works when there are no active cluster nodes and the format to set is newer than the current one.&lt;/p&gt;

&lt;p&gt;I would like to backport this to the branches as well, which means they would eventually also get protection against unintended upgrades or mixed (minor) version deployments that can corrupt the repository.&lt;/p&gt;</comment>
                            <comment id="15932876" author="mreutegg" created="Mon, 20 Mar 2017 15:52:02 +0000"  >&lt;p&gt;Committed the first part of the patch in oak-core: &lt;a href=&quot;http://svn.apache.org/r1787796&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1787796&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15934422" author="mreutegg" created="Tue, 21 Mar 2017 10:43:40 +0000"  >&lt;p&gt;The format version is now logged on startup and shut down as part of the ClusterNodeInfo string: &lt;a href=&quot;http://svn.apache.org/r1787925&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1787925&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Committed the new &lt;tt&gt;unlockUpgrade&lt;/tt&gt; command with documentation: &lt;a href=&quot;http://svn.apache.org/r1787931&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1787931&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15934439" author="mreutegg" created="Tue, 21 Mar 2017 10:51:30 +0000"  >&lt;p&gt;I&apos;m not sure how far back this should be backported. In my view it would be useful to have in all branches back to 1.0, but that may introduce strange behaviour for some upgrade paths. Consider the following sequence:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Initial repository was created with Oak 1.4.8&lt;/li&gt;
	&lt;li&gt;Repository is updated to hypothetical Oak 1.4.99, which contains the format version check and stores the current format as 1.4.0&lt;/li&gt;
	&lt;li&gt;Repository is upgraded to Oak 1.6.0. The upgrade will not touch the stored format version because it is ignored.&lt;/li&gt;
	&lt;li&gt;Repository is upgraded to an Oak 1.6.x version that contains the format version check. Now a micro version Oak update will complain about the format and require an &lt;tt&gt;unlockUpgrade&lt;/tt&gt;.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16029006" author="edivad" created="Tue, 30 May 2017 08:38:41 +0000"  >&lt;p&gt;Bulk close for 1.7.0&lt;/p&gt;</comment>
                            <comment id="16886972" author="reschke" created="Wed, 17 Jul 2019 11:56:29 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mreutegg&quot; class=&quot;user-hover&quot; rel=&quot;mreutegg&quot;&gt;mreutegg&lt;/a&gt; - do we need this in the next release?&lt;/p&gt;</comment>
                            <comment id="16891874" author="mreutegg" created="Wed, 24 Jul 2019 14:01:02 +0000"  >&lt;p&gt;No, I don&apos;t think this should be back-ported, for the reasons stated above. I removed the candidate label.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="12858604">OAK-3287</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13177877">OAK-7703</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12856601" name="OAK-4529.patch" size="28551" author="mreutegg" created="Tue, 7 Mar 2017 13:52:26 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 16 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i30hsn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>