<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:46:30 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-2301] QueryEngine should not tokenize fulltext expression by default</title>
                <link>https://issues.apache.org/jira/browse/OAK-2301</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;QueryEngine currently parses the fulltext expression on its own. This would cause issue with index implementation like Lucene which use a different analysis logic. For fulltext search to work properly it should be possible for LuceneIndex to get access to non tokenized text&lt;/p&gt;

&lt;p&gt;For more details refer to &lt;a href=&quot;http://markmail.org/thread/syoha44std3fm4j2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://markmail.org/thread/syoha44std3fm4j2&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12758142">OAK-2301</key>
            <summary>QueryEngine should not tokenize fulltext expression by default</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="chetanm">Chetan Mehrotra</assignee>
                                    <reporter username="chetanm">Chetan Mehrotra</reporter>
                        <labels>
                    </labels>
                <created>Thu, 27 Nov 2014 06:34:52 +0000</created>
                <updated>Tue, 7 Apr 2015 09:09:43 +0000</updated>
                            <resolved>Thu, 19 Mar 2015 09:03:38 +0000</resolved>
                                                    <fixVersion>1.1.8</fixVersion>
                                    <component>query</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="14237591" author="tmueller" created="Mon, 8 Dec 2014 08:07:52 +0000"  >&lt;p&gt;In theory this information is already available using:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Filter.getSelector().getSelectorConstraints()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;but I&apos;m not sure if that&apos;s the right approach.&lt;/p&gt;

&lt;p&gt;I guess the question is, do we need to distinguish between&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;(a) contains(., &apos;fox is running&apos;)
(b) contains(., &apos;fox is&apos;) and contains(., &apos;running&apos;)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Right now, both results in +fox +is +running. To get +&quot;fox is running&quot;, one has to use:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;(c) contains(., &apos;&quot;fox is running&quot;&apos;)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14237641" author="tmueller" created="Mon, 8 Dec 2014 08:58:28 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mreutegg&quot; class=&quot;user-hover&quot; rel=&quot;mreutegg&quot;&gt;mreutegg&lt;/a&gt; had the following idea: add a new class FullTextContains to the list of FullTextExpression subclasses. This class contains the original (unparsed) expression. That way, full-text expressions are still parsed, but the &quot;contains(...)&quot; grouping is still available to the consumer. Prototype (untested, incomplete):&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;public class FullTextContains extends FullTextExpression {
    
    private final String propertyName;
    private final String rawText;
    private final FullTextExpression base;
    
    FullTextContains(String propertyName, String rawText, FullTextExpression base) {
        this.propertyName = propertyName;
        this.rawText = rawText;
        this.base = base;
    }

    @Override
    public int getPrecedence() {
        return base.getPrecedence();
    }

    @Override
    public boolean evaluate(String value) {
        return base.evaluate(value);
    }

    @Override
    FullTextExpression simplify() {
        FullTextExpression s = base.simplify();
        if (s == base) {
            return this;
        }
        return new FullTextContains(propertyName, rawText, s);
    }

    @Override
    public String toString() {
        return base.toString();
    }

    @Override
    public boolean accept(FullTextVisitor v) {
        return v.visit(this);
    }
    
    public FullTextExpression getBase() {
        return base;
    }

    public String getPropertyName() {
        return propertyName;
    }

    public String getRawText() {
        return rawText;
    }

}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14237647" author="tmueller" created="Mon, 8 Dec 2014 09:08:21 +0000"  >&lt;p&gt;Proposed patch (tested, but not yet fully analyzed)&lt;/p&gt;</comment>
                            <comment id="14237775" author="chetanm" created="Mon, 8 Dec 2014 11:16:50 +0000"  >&lt;p&gt;Had to tweak it a bit to work for me&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Changed the default impl in FullTextVisitorBase. Otherwise would get a stckoverflow unless I override the method in places where I extend &lt;tt&gt;FullTextVisitorBase&lt;/tt&gt;. This also makes the change backward compatible for existing users. Only code which wants to make use of new support would override this vistor callback
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        @Override
        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; visit(FullTextContains contains) {
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; contains.getBase().accept(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;);
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
	&lt;li&gt;In most cases we would need to convert a FullTextContains to FullTextTerm as same code is to be invoked. So added a method to FullTextContains. One thing I was not sure about was the isNot flag
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; FullTextTerm getAsFullTextTerm(){
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; FullTextTerm(propertyName, rawText, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;With this following test case would pass in &lt;tt&gt;LucenePropertyIndexTest&lt;/tt&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    @Test
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void fulltextSearchWithCustomAnalyzer() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception{
        Tree idx = createFulltextIndex(root.getTree(&lt;span class=&quot;code-quote&quot;&gt;&quot;/&quot;&lt;/span&gt;), &lt;span class=&quot;code-quote&quot;&gt;&quot;test&quot;&lt;/span&gt;);
        TestUtil.useV2(idx);

        Tree anl = idx.addChild(ANALYZERS).addChild(ANL_DEFAULT);
        anl.addChild(ANL_TOKENIZER).setProperty(ANL_NAME, &lt;span class=&quot;code-quote&quot;&gt;&quot;whitespace&quot;&lt;/span&gt;);
        anl.addChild(ANL_FILTERS).addChild(&lt;span class=&quot;code-quote&quot;&gt;&quot;stop&quot;&lt;/span&gt;);

        Tree test = root.getTree(&lt;span class=&quot;code-quote&quot;&gt;&quot;/&quot;&lt;/span&gt;).addChild(&lt;span class=&quot;code-quote&quot;&gt;&quot;test&quot;&lt;/span&gt;);
        test.setProperty(&lt;span class=&quot;code-quote&quot;&gt;&quot;foo&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;fox jumping&quot;&lt;/span&gt;);
        root.commit();

        assertQuery(&lt;span class=&quot;code-quote&quot;&gt;&quot;select * from [nt:base] where CONTAINS(*, &lt;span class=&quot;code-quote&quot;&gt;&apos;fox was jumping&apos;&lt;/span&gt;)&quot;&lt;/span&gt;, asList(&lt;span class=&quot;code-quote&quot;&gt;&quot;/test&quot;&lt;/span&gt;));
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;However faced another issue. If the original text which was indexed had &lt;em&gt;fox is jumping&lt;/em&gt; and text I pass for test is &lt;em&gt;fox was jumping&lt;/em&gt; then test was failing. I expected that stop word should work both ways. However currently &lt;tt&gt;LuceneIndex&lt;/tt&gt; creates a &lt;tt&gt;PhraseQuery&lt;/tt&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; for all cases. I think it should create a phrase query only if original text was quoted. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=alex.parvulescu&quot; class=&quot;user-hover&quot; rel=&quot;alex.parvulescu&quot;&gt;alex.parvulescu&lt;/a&gt; Thoughts?&lt;/p&gt;


&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://github.com/apache/jackrabbit-oak/blob/trunk/oak-lucene/src/main/java/org/apache/jackrabbit/oak/plugins/index/lucene/LucenePropertyIndex.java#L913&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/jackrabbit-oak/blob/trunk/oak-lucene/src/main/java/org/apache/jackrabbit/oak/plugins/index/lucene/LucenePropertyIndex.java#L913&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14239403" author="chetanm" created="Tue, 9 Dec 2014 13:47:12 +0000"  >&lt;blockquote&gt;&lt;p&gt;However faced another issue. If the original text which was indexed had fox is jumping and text I pass for test is fox was jumping then test was failing. I expected that stop word should work both ways. However currently LuceneIndex creates a PhraseQuery &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; for all cases. I think it should create a phrase query only if original text was quoted. Alex Parvulescu Thoughts?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Looking further I realized that we would be better of to use the Lucene&apos;s QueryParser. Opened &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-2329&quot; title=&quot;Use LuceneQuery parser to create query from fulltext string&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-2329&quot;&gt;&lt;del&gt;OAK-2329&lt;/del&gt;&lt;/a&gt; for that&lt;/p&gt;</comment>
                            <comment id="14242527" author="tmueller" created="Thu, 11 Dec 2014 13:44:51 +0000"  >&lt;p&gt;A new patch. With this, some of the Lucene tests fail, but so far I don&apos;t know why.&lt;/p&gt;</comment>
                            <comment id="14242634" author="tmueller" created="Thu, 11 Dec 2014 14:51:16 +0000"  >&lt;p&gt;Fixed in revision 1644659 (trunk). The new unit test is there but commented, because I couldn&apos;t compile it (I couldn&apos;t find ANL_DEFAULT and so on)&lt;/p&gt;</comment>
                            <comment id="14242636" author="tmueller" created="Thu, 11 Dec 2014 14:52:44 +0000"  >&lt;p&gt;So, the FullTextContains is there, but it is not really used so far in the index. That needs to be done, plus unit tests.&lt;/p&gt;

&lt;p&gt;I unassigned it, as I&apos;m not currently working on it.&lt;/p&gt;</comment>
                            <comment id="14368720" author="chetanm" created="Thu, 19 Mar 2015 09:03:38 +0000"  >&lt;p&gt;We can consider this as fixed as Lucene index is able to make use of unparsed text. Should QE not do parsing at all would have to be looked into later&lt;/p&gt;</comment>
                            <comment id="14482851" author="edivad" created="Tue, 7 Apr 2015 09:09:43 +0000"  >&lt;p&gt;Bulk closing for 1.1.8&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="12747612">OAK-2177</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12686587" name="OAK-2301-b.patch" size="14029" author="thomasm" created="Thu, 11 Dec 2014 13:44:51 +0000"/>
                            <attachment id="12685714" name="OAK-2301.patch" size="7049" author="thomasm" created="Mon, 8 Dec 2014 09:08:21 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 32 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i22u6f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>