<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:48:25 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-3130] ReferenceEditor may not enforce referential integrity</title>
                <link>https://issues.apache.org/jira/browse/OAK-3130</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;VersionHistory.removeVersion() allows to remove a version of a checked in node still referencing that version. This results in a dangling base version.&lt;/p&gt;

&lt;p&gt;This is caused by a more general issue in the ReferenceEditor, which does not enforce referential integrity in some cases.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12846535">OAK-3130</key>
            <summary>ReferenceEditor may not enforce referential integrity</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mreutegg">Marcel Reutegger</assignee>
                                    <reporter username="mreutegg">Marcel Reutegger</reporter>
                        <labels>
                    </labels>
                <created>Tue, 21 Jul 2015 14:26:21 +0000</created>
                <updated>Wed, 2 Mar 2016 12:01:37 +0000</updated>
                            <resolved>Thu, 23 Jul 2015 12:49:58 +0000</resolved>
                                    <version>1.0.17</version>
                    <version>1.2.3</version>
                    <version>1.3.3</version>
                                    <fixVersion>1.0.18</fixVersion>
                    <fixVersion>1.2.4</fixVersion>
                    <fixVersion>1.3.4</fixVersion>
                    <fixVersion>1.4</fixVersion>
                                    <component>jcr</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="14635296" author="mreutegg" created="Tue, 21 Jul 2015 15:56:11 +0000"  >&lt;p&gt;Added a test to trunk: &lt;a href=&quot;http://svn.apache.org/r1692156&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1692156&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The test succeeds unless the call to vMgr.checkout() is commented out. I looks like the ReferenceEditor does not add a reference entry for the jcr:baseVersion reference on checkin().&lt;/p&gt;</comment>
                            <comment id="14636657" author="mreutegg" created="Wed, 22 Jul 2015 10:24:31 +0000"  >&lt;p&gt;Turns out this is actually a more general issue with the ReferenceEditor. Updated the title of this issue accordingly.&lt;/p&gt;

&lt;p&gt;Added more tests to trunk: &lt;a href=&quot;http://svn.apache.org/r1692250&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1692250&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;As can be seen from the test, the ReferenceEditor fails to enforce referential integrity when a referenceable node is removed together with a reference pointing to it and there are other existing references still pointing to the referenceable node.&lt;/p&gt;</comment>
                            <comment id="14638625" author="mreutegg" created="Thu, 23 Jul 2015 10:36:24 +0000"  >&lt;p&gt;Attached patch with proposed fix.&lt;/p&gt;

&lt;p&gt;I removed quite a bit of code in ReferenceEditor.&lt;/p&gt;

&lt;p&gt;The editor now ignores references from the version storage, which is IMO according to the spec and compatible with Jackrabbit 2.x. The spec says in &lt;a href=&quot;http://www.day.com/specs/jcr/2.0/3_Repository_Model.html#3.13.4.6 References in a Frozen Node&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.13.4.6 References in a Frozen Node&lt;/a&gt;:&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;A REFERENCE property stored in the frozen node of a version does not enforce referential integrity. Under simple versioning this follows from the fact that a REFERENCE within a frozen node does not appear within the workspace in any case, it only appears when the frozen node is explicitly retrieved through the Version object (see &#167;15.2.1 Version Object). Under full versioning a REFERENCE within a frozen node will appear in the workspace within the read-only version storage (see &#167;3.13.8 Version Storage) so the referential integrity requirement must be lifted as a special case.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It does not mention inter version references like &lt;tt&gt;jcr:successors&lt;/tt&gt; and &lt;tt&gt;jcr:predecessors&lt;/tt&gt;, but in &lt;a href=&quot;http://www.day.com/specs/jcr/2.0/5_Reading.html#5.10.7 Backtracking References&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;5.10.7 Backtracking References&lt;/a&gt; it says:&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Note that access control and other implementation-specific limitations my mean that some references within the workspace are not accessible.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Jackrabbit 2.x also does not return references from within the version storage. So, I think for compatibility Oak should not return them either. This was also previously decided in &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-1196&quot; title=&quot;Node.getReferences() should not show references in version storage&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-1196&quot;&gt;&lt;del&gt;OAK-1196&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;The ReferenceEditor does not track discardedIds anymore for node that changed their UUID. Instead it remembers them in &lt;tt&gt;rmIds&lt;/tt&gt; and &lt;tt&gt;newIds&lt;/tt&gt; to check referential integrity at the end.&lt;/p&gt;

&lt;p&gt;The patch also removes all the &lt;tt&gt;rmIds.contains(uuid)&lt;/tt&gt; checks in the &lt;tt&gt;leave()&lt;/tt&gt; method. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=alexparvulescu&quot; class=&quot;user-hover&quot; rel=&quot;alexparvulescu&quot;&gt;alexparvulescu&lt;/a&gt;, do you remember why those were added?&lt;/p&gt;

&lt;p&gt;All tests pass with the patch, also some new ones I added.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=alexparvulescu&quot; class=&quot;user-hover&quot; rel=&quot;alexparvulescu&quot;&gt;alexparvulescu&lt;/a&gt;, can you please review?&lt;/p&gt;

&lt;p&gt;I&apos;m also wondering if the current implementation potentially leaves garbage in the reference index, which may become a problem with the new reference check based on the index. Maybe the fix should also include an step during the integrity check if the references still exist.&lt;/p&gt;</comment>
                            <comment id="14638719" author="alex.parvulescu" created="Thu, 23 Jul 2015 12:16:43 +0000"  >&lt;p&gt;patch looks very good! it&apos;s always refreshing to make the code correct by reducing the complexity, thanks a lot Marcel!&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;+        &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(rootVersion);
+        &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(v);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;The patch also removes all the rmIds.contains(uuid) checks in the leave() method. Alex Parvulescu, do you remember why those were added?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I think this was bookkeeping for the moved nodes which from the editor&apos;s pov is a change in ids, but your simplification fixes this issue.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I&apos;m also wondering if the current implementation potentially leaves garbage in the reference index&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I don&apos;t see the point, wouldn&apos;t pruning take care of cleanup, so that the count method would always yield correct results?&lt;/p&gt;</comment>
                            <comment id="14638750" author="mreutegg" created="Thu, 23 Jul 2015 12:49:43 +0000"  >&lt;p&gt;Thanks for the review. Applied the patch without the System.out.println() &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; Thanks for spotting!&lt;/p&gt;

&lt;p&gt;Fixed in trunk: &lt;a href=&quot;http://svn.apache.org/r1692382&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1692382&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14644094" author="alex.parvulescu" created="Tue, 28 Jul 2015 09:13:14 +0000"  >&lt;p&gt;merged to 1.2 with &lt;a href=&quot;http://svn.apache.org/r1693042&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1693042&lt;/a&gt;, and to 1.0 with &lt;a href=&quot;http://svn.apache.org/r1693049&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1693049&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12746770" name="OAK-3130.patch" size="17440" author="mreutegg" created="Thu, 23 Jul 2015 10:36:24 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 16 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2hhun:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>