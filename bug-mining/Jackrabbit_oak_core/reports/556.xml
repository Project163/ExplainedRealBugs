<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:40:54 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-1130] Performance issues with MutableTree</title>
                <link>https://issues.apache.org/jira/browse/OAK-1130</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;Benchmarks show that simple queries are slower in Oak than in Jackrabbit 2.x. The profiling data shows that most time is spent in the MemoryNodeBuilder (see below), called from MutableTree, even thought the query engine internally doesn&apos;t need mutable trees.&lt;/p&gt;

&lt;p&gt;It would be nice if creating a tree is faster (MemoryNodeBuilder, MutableTree and related). Many components would benefit from that. Unfortunately, the code is quite complex (meaning, I don&apos;t understand it).&lt;/p&gt;

&lt;p&gt;I found two alternatives to speed up queries:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Not use MutableTree within the query engine, but instead use ImmutableTree. This gave a small performance boost (maybe 15%)&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Cache trees in the query engine, to avoid creating the same tree multiple times. This gave a speedup of about 50% (twice as fast) for some tests.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Package summary and top stack trace as reported by the profiler.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;summary:
65%: org.apache.jackrabbit.oak.plugins.memory
9%: org.apache.jackrabbit.oak.plugins.segment
4%: org.apache.jackrabbit.oak.jcr.session.operation
3%: org.apache.jackrabbit.oak.query
2%: com.google.common.collect
2%: org.apache.jackrabbit.oak.namepath

341/3234 (10%):
org.apache.jackrabbit.oak.plugins.memory.MemoryNodeBuilder$ConnectedHead.getCurrentNodeState(MemoryNodeBuilder.java:601)
org.apache.jackrabbit.oak.plugins.memory.MemoryNodeBuilder$UnconnectedHead.update(MemoryNodeBuilder.java:535)
org.apache.jackrabbit.oak.plugins.memory.MemoryNodeBuilder.head(MemoryNodeBuilder.java:152)
org.apache.jackrabbit.oak.plugins.memory.MemoryNodeBuilder.exists(MemoryNodeBuilder.java:254)
org.apache.jackrabbit.oak.core.SecureNodeBuilder.getChildNode(SecureNodeBuilder.java:299)
org.apache.jackrabbit.oak.core.MutableTree.&amp;lt;init&amp;gt;(MutableTree.java:76)
org.apache.jackrabbit.oak.core.MutableTree.createChild(MutableTree.java:86)
org.apache.jackrabbit.oak.core.MutableTree.getChild(MutableTree.java:222)
org.apache.jackrabbit.oak.util.TreeUtil.getTree(TreeUtil.java:169)
org.apache.jackrabbit.oak.query.QueryImpl.getTree(QueryImpl.java:604)
org.apache.jackrabbit.oak.query.ast.AstElement.getTree(AstElement.java:126)
org.apache.jackrabbit.oak.query.ast.SelectorImpl.currentTree(SelectorImpl.java:351)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Some benchmark results for the oak-run SimpleSearchTest with combination of changes (patch will follow). Just &quot;N&quot;, meaning number of iterations within 10 seconds (higher is better), using Oak-Tar:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;old (mutable tree, no cache): 36&lt;/li&gt;
	&lt;li&gt;immutable tree only: 42&lt;/li&gt;
	&lt;li&gt;cache only: 65&lt;/li&gt;
	&lt;li&gt;cache+immutable: 76&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="12676645">OAK-1130</key>
            <summary>Performance issues with MutableTree</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jukkaz">Jukka Zitting</assignee>
                                    <reporter username="thomasm">Thomas Mueller</reporter>
                        <labels>
                    </labels>
                <created>Wed, 30 Oct 2013 14:31:19 +0000</created>
                <updated>Thu, 28 Nov 2013 14:34:12 +0000</updated>
                            <resolved>Mon, 25 Nov 2013 13:55:07 +0000</resolved>
                                                    <fixVersion>0.12</fixVersion>
                                    <component>core</component>
                    <component>query</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="13809152" author="tmueller" created="Wed, 30 Oct 2013 14:33:22 +0000"  >&lt;p&gt;Proposed patch. Changes in the AbstractRoot: use ImmutableTree instead of mutable. Changes in AstElement: cache the used last tree.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Index: src/main/java/org/apache/jackrabbit/oak/core/AbstractRoot.java
===================================================================
--- src/main/java/org/apache/jackrabbit/oak/core/AbstractRoot.java	(revision 1537076)
+++ src/main/java/org/apache/jackrabbit/oak/core/AbstractRoot.java	(working copy)
@@ -329,7 +329,11 @@
             @Override
             &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; ExecutionContext getExecutionContext() {
                 NodeState rootState = AbstractRoot.&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.getRootState();
-                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ExecutionContext(rootState, rootTree, getIndexProvider(rootState));
+                Context c = securityProvider.getConfiguration(AuthorizationConfiguration.class).getContext();
+                PermissionProvider pp = permissionProvider.get();
+                SecureNodeState s = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SecureNodeState(rootState, pp, c);
+                ImmutableTree t = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ImmutableTree(s);
+                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ExecutionContext(rootState, t, getIndexProvider(rootState));
             }
 
             &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; QueryIndexProvider getIndexProvider(NodeState rootState) {
Index: src/main/java/org/apache/jackrabbit/oak/query/ast/AstElement.java
===================================================================
--- src/main/java/org/apache/jackrabbit/oak/query/ast/AstElement.java	(revision 1537076)
+++ src/main/java/org/apache/jackrabbit/oak/query/ast/AstElement.java	(working copy)
@@ -30,6 +30,8 @@
 &lt;span class=&quot;code-keyword&quot;&gt;abstract&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;AstElement {
 
     &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; QueryImpl query;
+    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; Tree lastTree;
+    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; lastPath;
 
     &lt;span class=&quot;code-keyword&quot;&gt;abstract&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; accept(AstVisitor v);
 
@@ -123,7 +125,11 @@
     }
 
     &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; Tree getTree(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; path) {
-        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; query.getTree(path);
+        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (lastPath == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; || !path.equals(lastPath)) {
+            lastTree = query.getTree(path);
+            lastPath = path;
+        }
+        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; lastTree;
     }
 
 }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13809173" author="mduerig" created="Wed, 30 Oct 2013 14:52:32 +0000"  >&lt;p&gt;Generally +1 for not using the mutable variant here. I remember having this discussed with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=alexparvulescu&quot; class=&quot;user-hover&quot; rel=&quot;alexparvulescu&quot;&gt;alexparvulescu&lt;/a&gt; a while back and we came to the conclusion that the only reason for having the mutable tree in the execution context is the need for access control evaluation. Looking at your patch I see you came to the same conclusion. So talking this further, couldn&apos;t we do away completely with the tree as the second argument to the &lt;tt&gt;ExecutionContext&lt;/tt&gt; constructor and pass the secure node state instead? The constructor would thus become&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; ExecutionContext(NodeState rootState, NodeState secureRootState,
            QueryIndexProvider indexProvider) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13809260" author="jukkaz" created="Wed, 30 Oct 2013 15:54:48 +0000"  >&lt;p&gt;I think we&apos;re looking the issue the wrong way here.&lt;/p&gt;

&lt;p&gt;The problem seems to be the large number of &lt;tt&gt;AstElement.getTree()&lt;/tt&gt; calls (I count at least 5 repeated calls per row). Instead of caching the result at the &lt;tt&gt;AstElement&lt;/tt&gt; level, I think it would be better to refactor the code so that we only look up the Tree(s) of a result row already in &lt;tt&gt;SourceImpl.next()&lt;/tt&gt;, and then pass the row as context when evaluating individual &lt;tt&gt;AstElements&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;This way we should only need a single path lookup per selector for each result row, and there should be no need for caching at the &lt;tt&gt;AstElement&lt;/tt&gt; level.&lt;/p&gt;</comment>
                            <comment id="13810278" author="tmueller" created="Thu, 31 Oct 2013 14:17:49 +0000"  >&lt;p&gt;&amp;gt; pass the secure node state instead?&lt;/p&gt;

&lt;p&gt;That might work (needs further investigation).&lt;/p&gt;

&lt;p&gt;&amp;gt; the large number of AstElement.getTree() calls&lt;/p&gt;

&lt;p&gt;The large number of AstElement.getTree() calls isn&apos;t actually a performance problem, if the tree is re-used. That&apos;s why patch doubles the performance. After caching the last used tree AstElement.getTree() does not appear in the profiling data anywhere. That means  the problem is that creating the tree is relatively slow. Improving that would help Oak in general (not just the query engine).&lt;/p&gt;

&lt;p&gt;&amp;gt; we only look up the Tree(s) of a result row already in SourceImpl.next()&lt;/p&gt;

&lt;p&gt;This works, but not for all cases (relative properties). But I see now that getTree shouldn&apos;t be in AstElement, but in the SelectorImpl.&lt;/p&gt;

&lt;p&gt;I will apply part of the patch (the part that caches the last used tree), and we can go further from there.&lt;/p&gt;</comment>
                            <comment id="13810291" author="jukkaz" created="Thu, 31 Oct 2013 14:27:58 +0000"  >&lt;p&gt;See the attached patch for a quick draft of preloading the Tree in the selector when advancing to a new row. That way all parts of the query that reference that selector can use the already loaded Tree without having to do repeated path lookups. The result:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;# SimpleSearchTest                 C     min     10%     50%     90%     max
Oak-Tar (before)                   1     239     243     248     268     424
Oak-Tar (after)                    1     126     128     131     141     299
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13810333" author="tmueller" created="Thu, 31 Oct 2013 15:23:21 +0000"  >&lt;p&gt;Meanwhile, I have committed a similar change, I guess with the same speedup.&lt;br/&gt;
Revision 1537503&lt;/p&gt;

&lt;p&gt;I will try to integrate your patch as well.&lt;/p&gt;</comment>
                            <comment id="13810352" author="jukkaz" created="Thu, 31 Oct 2013 15:43:47 +0000"  >&lt;p&gt;OK, cool! It occurs to me that if/when we preload the Tree in the selector, it should also be possible to add a &lt;tt&gt;ResultRow.getTree(String selectorName)&lt;/tt&gt; method, and thus avoid the extra path lookups in oak-jcr&apos;s &lt;tt&gt;QueryResultImpl&lt;/tt&gt; and &lt;tt&gt;RowImpl&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="13831473" author="jukkaz" created="Mon, 25 Nov 2013 13:55:07 +0000"  >&lt;p&gt;In revision 1545283 I removed the extra path lookups in query results; instead we use the Tree instances that were already loaded for the selectors. This results in some added performance boost:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;# SimpleSearchTest        C     min     10%     50%     90%     max       N
Oak-Tar (before)          1      93      94      96      98     146     624
Oak-Tar (after)           1      77      78      79      80     115     760
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I guess we can resolve this as fixed.&lt;/p&gt;</comment>
                            <comment id="13834876" author="alex.parvulescu" created="Thu, 28 Nov 2013 14:34:12 +0000"  >&lt;p&gt;bulk close for the 0.12 release&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12611396" name="0001-OAK-1130-Performance-issues-with-MutableTree.patch" size="6975" author="jukkaz" created="Thu, 31 Oct 2013 14:27:58 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>356077</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 51 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1pdwn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>356365</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>