<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:40:40 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-1170] Inconsistent reads with concurrent benchmark tests</title>
                <link>https://issues.apache.org/jira/browse/OAK-1170</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;Running concurrent benchmark tests with multiple Oak+MongoMK instances may lead to inconsistent reads. It may happen that a MongoMK instance reads child nodes at a given revision and then later finds out some of those children do not exist anymore at the same revision.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12678803">OAK-1170</key>
            <summary>Inconsistent reads with concurrent benchmark tests</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mreutegg">Marcel Reutegger</assignee>
                                    <reporter username="mreutegg">Marcel Reutegger</reporter>
                        <labels>
                    </labels>
                <created>Tue, 12 Nov 2013 13:51:20 +0000</created>
                <updated>Thu, 21 Nov 2013 10:30:53 +0000</updated>
                            <resolved>Thu, 14 Nov 2013 14:29:24 +0000</resolved>
                                                    <fixVersion>0.11</fixVersion>
                                    <component>core</component>
                    <component>mongomk</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="13820114" author="mreutegg" created="Tue, 12 Nov 2013 14:06:16 +0000"  >&lt;p&gt;Added a test (currently ignored) that shows the problem: &lt;a href=&quot;http://svn.apache.org/r1541068&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1541068&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13821331" author="mreutegg" created="Wed, 13 Nov 2013 13:42:09 +0000"  >&lt;p&gt;From what I can see MongoMK and tests currently make various assumptions about visibility of changes across cluster node instances, which are not in accordance with the MVCC model in Oak.&lt;/p&gt;

&lt;p&gt;MongoNodeStore.publishRevision() is called when a committing thread encounters a revision, which is newer than the current commit revision. A foreign newer revision is then published to the RevisionComparator with a causual relationship (happened-before denoted by -&amp;gt;): current-head-revision -&amp;gt; foreign-revision -&amp;gt; new-commit-revision. At the end publishRevision() makes the foreign revision visible by setting a new head revision (actually newer than new-commit-revision). Later when the commit finishes, the head revision is set to the new-commit-revision. This means the the head is set to an older revision again.&lt;/p&gt;

&lt;p&gt;I think is is also questionable if the foreign revision should be made visible at all at the point. The _lastRev values of foreign cluster nodes are likely not yet written back and not in sync with the foreign-revision. This may lead to situations where a foreign revision is visible but not reflected in _lastRev. I think it would be better to solely rely on the background operations to make foreign changes visible. This however means one assumption we currently make in some of the tests must be revised. Every now and then we expect that a foreign change becomes visible after a conflict is detected. While this works for the isolated case of single node, it does not work well looking at the whole hierarchy. Again, foreign _lastRev may not be consistent with revisions visible to the current MongoMK instance.&lt;/p&gt;

&lt;p&gt;IMO, foreign (external) changes should only become visible with background operations. This ensures a strict separation of changes done by the local MongoMK instance and external changes. This is also a requirement we have from the observation part in Oak.&lt;/p&gt;

&lt;p&gt;The tricky part is how this affects conflict handling. A change may not succeed on one cluster node because external changes are not yet visible. Though, the same changes may succeed on the cluster node where the external changes were done, because these are already visible. I don&apos;t think we can do much about this.&lt;/p&gt;

&lt;p&gt;To be more specific, here&apos;s what I propose:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Do not publish newer foreign revisions to the RevisionComparator, but treat them as FUTURE Revisions. These are always newer than the current head revision. Thus, not visible. This avoid inconsistencies between visible revisions and _lastRev values.&lt;/li&gt;
	&lt;li&gt;External changes do not become visible anymore when a conflict is detected. External changes only become visible with background operations. This avoids updates of the head revision while commits are in progress and guarantees external changes are not intermingled with local changes.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13822476" author="mreutegg" created="Thu, 14 Nov 2013 14:29:24 +0000"  >&lt;p&gt;Fixed in &lt;a href=&quot;http://svn.apache.org/r1541915&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1541915&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Changes:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;make external changes only visible in background read, based on _lastRev available on root document&lt;/li&gt;
	&lt;li&gt;remove MongoNodeStore.publishRevision()&lt;/li&gt;
	&lt;li&gt;adjust some tests because the implementation doesn&apos;t try to make external changes visible anymore on a conflict&lt;/li&gt;
	&lt;li&gt;enable test added for this issue&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13828792" author="alex.parvulescu" created="Thu, 21 Nov 2013 10:30:53 +0000"  >&lt;p&gt;bulk close for the 0.11 release&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="12678581">OAK-1167</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>358170</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1pqsn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>358460</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>