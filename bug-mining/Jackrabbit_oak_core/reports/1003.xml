<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:45:34 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-1641] Mongo: Un-/CheckedExecutionException on replica-primary crash</title>
                <link>https://issues.apache.org/jira/browse/OAK-1641</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;Testing with a mongo replicaSet setup: 1 primary, 1 secondary and 1 secondary-arbiter-only.&lt;/p&gt;

&lt;p&gt;Running a simple test which has 2 threads: a writer thread and a reader thread.&lt;/p&gt;

&lt;p&gt;The following exception occurs when crashing mongo primary&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;com.google.common.util.concurrent.UncheckedExecutionException: com.google.common.util.concurrent.UncheckedExecutionException: com.mongodb.MongoException$Network: Read operation to server localhost/127.0.0.1:12322 failed on database resilienceTest
	at com.google.common.cache.LocalCache$Segment.get(LocalCache.java:2199)
	at com.google.common.cache.LocalCache.get(LocalCache.java:3932)
	at com.google.common.cache.LocalCache$LocalManualCache.get(LocalCache.java:4721)
	at org.apache.jackrabbit.oak.plugins.document.DocumentNodeStore.getNode(DocumentNodeStore.java:593)
	at org.apache.jackrabbit.oak.plugins.document.DocumentNodeState.hasChildNode(DocumentNodeState.java:164)
	at org.apache.jackrabbit.oak.plugins.memory.MemoryNodeBuilder.hasChildNode(MemoryNodeBuilder.java:301)
	at org.apache.jackrabbit.oak.core.SecureNodeBuilder.hasChildNode(SecureNodeBuilder.java:299)
	at org.apache.jackrabbit.oak.plugins.tree.AbstractTree.hasChild(AbstractTree.java:267)
	at org.apache.jackrabbit.oak.core.MutableTree.getChild(MutableTree.java:147)
	at org.apache.jackrabbit.oak.util.TreeUtil.getTree(TreeUtil.java:171)
	at org.apache.jackrabbit.oak.jcr.delegate.NodeDelegate.getTree(NodeDelegate.java:865)
	at org.apache.jackrabbit.oak.jcr.delegate.NodeDelegate.getChild(NodeDelegate.java:339)
	at org.apache.jackrabbit.oak.jcr.session.NodeImpl$5.perform(NodeImpl.java:274)
	at org.apache.jackrabbit.oak.jcr.session.NodeImpl$5.perform(NodeImpl.java:1)
	at org.apache.jackrabbit.oak.jcr.delegate.SessionDelegate.perform(SessionDelegate.java:308)
	at org.apache.jackrabbit.oak.jcr.session.ItemImpl.perform(ItemImpl.java:113)
	at org.apache.jackrabbit.oak.jcr.session.NodeImpl.addNode(NodeImpl.java:253)
	at org.apache.jackrabbit.oak.jcr.session.NodeImpl.addNode(NodeImpl.java:238)
	at org.apache.jackrabbit.oak.run.ReplicaCrashResilienceTest$1.run(ReplicaCrashResilienceTest.java:103)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:695)
Caused by: com.google.common.util.concurrent.UncheckedExecutionException: com.mongodb.MongoException$Network: Read operation to server localhost/127.0.0.1:12322 failed on database resilienceTest
	at com.google.common.cache.LocalCache$Segment.get(LocalCache.java:2199)
	at com.google.common.cache.LocalCache.get(LocalCache.java:3932)
	at com.google.common.cache.LocalCache$LocalManualCache.get(LocalCache.java:4721)
	at org.apache.jackrabbit.oak.plugins.document.mongo.MongoDocumentStore.find(MongoDocumentStore.java:267)
	at org.apache.jackrabbit.oak.plugins.document.mongo.MongoDocumentStore.find(MongoDocumentStore.java:234)
	at org.apache.jackrabbit.oak.plugins.document.DocumentNodeStore.readNode(DocumentNodeStore.java:802)
	at org.apache.jackrabbit.oak.plugins.document.DocumentNodeStore$3.call(DocumentNodeStore.java:596)
	at org.apache.jackrabbit.oak.plugins.document.DocumentNodeStore$3.call(DocumentNodeStore.java:1)
	at com.google.common.cache.LocalCache$LocalManualCache$1.load(LocalCache.java:4724)
	at com.google.common.cache.LocalCache$LoadingValueReference.loadFuture(LocalCache.java:3522)
	at com.google.common.cache.LocalCache$Segment.loadSync(LocalCache.java:2315)
	at com.google.common.cache.LocalCache$Segment.lockedGetOrLoad(LocalCache.java:2278)
	at com.google.common.cache.LocalCache$Segment.get(LocalCache.java:2193)
	... 19 more
Caused by: com.mongodb.MongoException$Network: Read operation to server localhost/127.0.0.1:12322 failed on database resilienceTest
	at com.mongodb.DBTCPConnector.innerCall(DBTCPConnector.java:253)
	at com.mongodb.DBTCPConnector.innerCall(DBTCPConnector.java:264)
	at com.mongodb.DBTCPConnector.innerCall(DBTCPConnector.java:264)
	at com.mongodb.DBTCPConnector.call(DBTCPConnector.java:216)
	at com.mongodb.DBApiLayer$MyCollection.__find(DBApiLayer.java:288)
	at com.mongodb.DBApiLayer$MyCollection.__find(DBApiLayer.java:273)
	at com.mongodb.DBCollection.findOne(DBCollection.java:728)
	at com.mongodb.DBCollection.findOne(DBCollection.java:670)
	at org.apache.jackrabbit.oak.plugins.document.mongo.MongoDocumentStore.findUncached(MongoDocumentStore.java:304)
	at org.apache.jackrabbit.oak.plugins.document.mongo.MongoDocumentStore$1.call(MongoDocumentStore.java:270)
	at org.apache.jackrabbit.oak.plugins.document.mongo.MongoDocumentStore$1.call(MongoDocumentStore.java:1)
	at com.google.common.cache.LocalCache$LocalManualCache$1.load(LocalCache.java:4724)
	at com.google.common.cache.LocalCache$LoadingValueReference.loadFuture(LocalCache.java:3522)
	at com.google.common.cache.LocalCache$Segment.loadSync(LocalCache.java:2315)
	at com.google.common.cache.LocalCache$Segment.lockedGetOrLoad(LocalCache.java:2278)
	at com.google.common.cache.LocalCache$Segment.get(LocalCache.java:2193)
	... 31 more
Caused by: java.net.ConnectException: Connection refused
	at java.net.PlainSocketImpl.socketConnect(Native Method)
	at java.net.PlainSocketImpl.doConnect(PlainSocketImpl.java:382)
	at java.net.PlainSocketImpl.connectToAddress(PlainSocketImpl.java:241)
	at java.net.PlainSocketImpl.connect(PlainSocketImpl.java:228)
	at java.net.SocksSocketImpl.connect(SocksSocketImpl.java:431)
	at java.net.Socket.connect(Socket.java:527)
	at com.mongodb.DBPort._open(DBPort.java:223)
	at com.mongodb.DBPort.go(DBPort.java:125)
	at com.mongodb.DBPort.call(DBPort.java:92)
	at com.mongodb.DBTCPConnector.innerCall(DBTCPConnector.java:244)
	... 46 more&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>&lt;p&gt;0.20-SNAPSHOT as of March 28, 2014&lt;/p&gt;</environment>
        <key id="12704259">OAK-1641</key>
            <summary>Mongo: Un-/CheckedExecutionException on replica-primary crash</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mreutegg">Marcel Reutegger</assignee>
                                    <reporter username="stefanegli">Stefan Egli</reporter>
                        <labels>
                    </labels>
                <created>Fri, 28 Mar 2014 14:38:58 +0000</created>
                <updated>Tue, 7 Apr 2015 09:09:44 +0000</updated>
                            <resolved>Mon, 9 Mar 2015 09:39:37 +0000</resolved>
                                    <version>0.19</version>
                                    <fixVersion>1.1.8</fixVersion>
                                    <component>mongomk</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13950831" author="egli" created="Fri, 28 Mar 2014 15:01:10 +0000"  >&lt;p&gt;Another variant of this unchecked exception is during failover, when the mongo client realizes the peer is crashed but before it can move to the newly promoted primary. &lt;/p&gt;

&lt;p&gt;Maybe this requires different handling from above though - but still adding to this ticket.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Caused by: com.google.common.util.concurrent.UncheckedExecutionException: com.mongodb.MongoException: No replica set members available in [ { address:&lt;span class=&quot;code-quote&quot;&gt;&apos;localhost/127.0.0.1:12321&apos;&lt;/span&gt;, ok:&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, ping:0.41101766, isMaster:&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, isSecondary:&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, setName:testy, maxBsonObjectSize:16777216, },{ address:&lt;span class=&quot;code-quote&quot;&gt;&apos;localhost/127.0.0.1:12322&apos;&lt;/span&gt;, ok:&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, ping:0.71037495, isMaster:&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, isSecondary:&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, setName:testy, maxBsonObjectSize:16777216, } ] &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; { &lt;span class=&quot;code-quote&quot;&gt;&quot;mode&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;primary&quot;&lt;/span&gt;}
	at com.google.common.cache.LocalCache$Segment.get(LocalCache.java:2199)
	at com.google.common.cache.LocalCache.get(LocalCache.java:3932)
	at com.google.common.cache.LocalCache$LocalManualCache.get(LocalCache.java:4721)
	at org.apache.jackrabbit.oak.plugins.document.mongo.MongoDocumentStore.find(MongoDocumentStore.java:267)
	at org.apache.jackrabbit.oak.plugins.document.mongo.MongoDocumentStore.find(MongoDocumentStore.java:234)
	at org.apache.jackrabbit.oak.plugins.document.DocumentNodeStore.readNode(DocumentNodeStore.java:802)
	at org.apache.jackrabbit.oak.plugins.document.DocumentNodeStore$3.call(DocumentNodeStore.java:596)
	at org.apache.jackrabbit.oak.plugins.document.DocumentNodeStore$3.call(DocumentNodeStore.java:1)
	at com.google.common.cache.LocalCache$LocalManualCache$1.load(LocalCache.java:4724)
	at com.google.common.cache.LocalCache$LoadingValueReference.loadFuture(LocalCache.java:3522)
	at com.google.common.cache.LocalCache$Segment.loadSync(LocalCache.java:2315)
	at com.google.common.cache.LocalCache$Segment.lockedGetOrLoad(LocalCache.java:2278)
	at com.google.common.cache.LocalCache$Segment.get(LocalCache.java:2193)
	... 19 more
Caused by: com.mongodb.MongoException: No replica set members available in [ { address:&lt;span class=&quot;code-quote&quot;&gt;&apos;localhost/127.0.0.1:12321&apos;&lt;/span&gt;, ok:&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, ping:0.41101766, isMaster:&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, isSecondary:&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, setName:testy, maxBsonObjectSize:16777216, },{ address:&lt;span class=&quot;code-quote&quot;&gt;&apos;localhost/127.0.0.1:12322&apos;&lt;/span&gt;, ok:&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, ping:0.71037495, isMaster:&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, isSecondary:&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, setName:testy, maxBsonObjectSize:16777216, } ] &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; { &lt;span class=&quot;code-quote&quot;&gt;&quot;mode&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;primary&quot;&lt;/span&gt;}
	at com.mongodb.DBTCPConnector$MyPort.get(DBTCPConnector.java:411)
	at com.mongodb.DBTCPConnector.innerCall(DBTCPConnector.java:238)
	at com.mongodb.DBTCPConnector.call(DBTCPConnector.java:216)
	at com.mongodb.DBApiLayer$MyCollection.__find(DBApiLayer.java:288)
	at com.mongodb.DBApiLayer$MyCollection.__find(DBApiLayer.java:273)
	at com.mongodb.DBCollection.findOne(DBCollection.java:728)
	at com.mongodb.DBCollection.findOne(DBCollection.java:670)
	at org.apache.jackrabbit.oak.plugins.document.mongo.MongoDocumentStore.findUncached(MongoDocumentStore.java:304)
	at org.apache.jackrabbit.oak.plugins.document.mongo.MongoDocumentStore$1.call(MongoDocumentStore.java:270)
	at org.apache.jackrabbit.oak.plugins.document.mongo.MongoDocumentStore$1.call(MongoDocumentStore.java:1)
	at com.google.common.cache.LocalCache$LocalManualCache$1.load(LocalCache.java:4724)
	at com.google.common.cache.LocalCache$LoadingValueReference.loadFuture(LocalCache.java:3522)
	at com.google.common.cache.LocalCache$Segment.loadSync(LocalCache.java:2315)
	at com.google.common.cache.LocalCache$Segment.lockedGetOrLoad(LocalCache.java:2278)
	at com.google.common.cache.LocalCache$Segment.get(LocalCache.java:2193)
	... 31 more&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13950843" author="egli" created="Fri, 28 Mar 2014 15:07:16 +0000"  >&lt;p&gt;attaching patch which extends the OakFixture to support plain mongoUrl too (besides the host,port,db triple)&lt;/p&gt;</comment>
                            <comment id="13950847" author="egli" created="Fri, 28 Mar 2014 15:08:37 +0000"  >&lt;p&gt;Attached a work-in-progress version of the ReplicaCrashResiliencetest with which the exceptions shown in this ticket were generated.&lt;/p&gt;</comment>
                            <comment id="13950873" author="chetanm" created="Fri, 28 Mar 2014 15:19:55 +0000"  >&lt;p&gt;Probably we need to look for exception error code and do a retry if ReplicaSet is in progress &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;. Time for some form of MongoTemplate to be introduced!! The Java driver behaviour in case of master getting reelected is documented at &lt;a href=&quot;https://jira.mongodb.org/browse/DOCS-581&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;DOCS-581&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;http://stackoverflow.com/questions/17988394/how-can-mongodb-java-driver-determine-if-replica-set-is-in-the-process-of-automa&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://stackoverflow.com/questions/17988394/how-can-mongodb-java-driver-determine-if-replica-set-is-in-the-process-of-automa&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13950923" author="egli" created="Fri, 28 Mar 2014 15:50:14 +0000"  >&lt;p&gt;Slightly updated version of ReplicaCrashResilienceTest which runs full-speed and accepts missing writes&lt;/p&gt;</comment>
                            <comment id="13955112" author="egli" created="Mon, 31 Mar 2014 11:42:03 +0000"  >&lt;p&gt;PS: Also had a &lt;b&gt;checked exception&lt;/b&gt; being thrown in this case:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; e=org.apache.jackrabbit.mk.api.MicroKernelException: com.mongodb.MongoException$Network: Read operation to server localhost/127.0.0.1:12322 failed on database resilienceLargeTxTest2
org.apache.jackrabbit.mk.api.MicroKernelException: com.mongodb.MongoException$Network: Read operation to server localhost/127.0.0.1:12322 failed on database resilienceLargeTxTest2
	at org.apache.jackrabbit.oak.plugins.document.mongo.MongoDocumentStore.findAndModify(MongoDocumentStore.java:483)
	at org.apache.jackrabbit.oak.plugins.document.mongo.MongoDocumentStore.findAndUpdate(MongoDocumentStore.java:504)
	at org.apache.jackrabbit.oak.plugins.document.Commit.rollback(Commit.java:429)
	at org.apache.jackrabbit.oak.plugins.document.Commit.applyToDocumentStore(Commit.java:377)
	at org.apache.jackrabbit.oak.plugins.document.Commit.prepare(Commit.java:212)
	at org.apache.jackrabbit.oak.plugins.document.Commit.apply(Commit.java:181)
	at org.apache.jackrabbit.oak.plugins.document.DocumentNodeStoreBranch.persist(DocumentNodeStoreBranch.java:172)
	at org.apache.jackrabbit.oak.plugins.document.DocumentNodeStoreBranch.persist(DocumentNodeStoreBranch.java:85)
	at org.apache.jackrabbit.oak.plugins.document.DocumentNodeStoreBranch.persist(DocumentNodeStoreBranch.java:1)
	at org.apache.jackrabbit.oak.spi.state.AbstractNodeStoreBranch$Persisted.persistTransientHead(AbstractNodeStoreBranch.java:598)
	at org.apache.jackrabbit.oak.spi.state.AbstractNodeStoreBranch$Persisted.setRoot(AbstractNodeStoreBranch.java:547)
	at org.apache.jackrabbit.oak.spi.state.AbstractNodeStoreBranch.setRoot(AbstractNodeStoreBranch.java:208)
	at org.apache.jackrabbit.oak.plugins.document.DocumentRootBuilder.purge(DocumentRootBuilder.java:188)
	at org.apache.jackrabbit.oak.plugins.document.DocumentRootBuilder.updated(DocumentRootBuilder.java:99)
	at org.apache.jackrabbit.oak.plugins.memory.MemoryNodeBuilder.updated(MemoryNodeBuilder.java:205)
	at org.apache.jackrabbit.oak.plugins.memory.MemoryNodeBuilder.setProperty(MemoryNodeBuilder.java:489)
	at org.apache.jackrabbit.oak.core.SecureNodeBuilder.setProperty(SecureNodeBuilder.java:260)
	at org.apache.jackrabbit.oak.core.MutableTree.setProperty(MutableTree.java:261)
	at org.apache.jackrabbit.oak.jcr.delegate.NodeDelegate.setProperty(NodeDelegate.java:537)
	at org.apache.jackrabbit.oak.jcr.session.NodeImpl$35.perform(NodeImpl.java:1306)
	at org.apache.jackrabbit.oak.jcr.session.NodeImpl$35.perform(NodeImpl.java:1)
	at org.apache.jackrabbit.oak.jcr.delegate.SessionDelegate.perform(SessionDelegate.java:308)
	at org.apache.jackrabbit.oak.jcr.session.ItemImpl.perform(ItemImpl.java:113)
	at org.apache.jackrabbit.oak.jcr.session.NodeImpl.internalSetProperty(NodeImpl.java:1294)
	at org.apache.jackrabbit.oak.jcr.session.NodeImpl.setProperty(NodeImpl.java:495)
	at org.apache.jackrabbit.oak.run.ReplicaCrashResilienceLargeTxWithReaderTest$1.run(ReplicaCrashResilienceLargeTxWithReaderTest.java:119)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:695)
Caused by: com.mongodb.MongoException$Network: Read operation to server localhost/127.0.0.1:12322 failed on database resilienceLargeTxTest2
	at com.mongodb.DBTCPConnector.innerCall(DBTCPConnector.java:253)
	at com.mongodb.DBTCPConnector.call(DBTCPConnector.java:216)
	at com.mongodb.DBApiLayer$MyCollection.__find(DBApiLayer.java:288)
	at com.mongodb.DB.command(DB.java:262)
	at com.mongodb.DB.command(DB.java:244)
	at com.mongodb.DB.command(DB.java:301)
	at com.mongodb.DB.command(DB.java:199)
	at com.mongodb.DBCollection.findAndModify(DBCollection.java:392)
	at org.apache.jackrabbit.oak.plugins.document.mongo.MongoDocumentStore.findAndModify(MongoDocumentStore.java:456)
	... 26 more
Caused by: java.net.ConnectException: Connection refused
	at java.net.PlainSocketImpl.socketConnect(Native Method)
	at java.net.PlainSocketImpl.doConnect(PlainSocketImpl.java:382)
	at java.net.PlainSocketImpl.connectToAddress(PlainSocketImpl.java:241)
	at java.net.PlainSocketImpl.connect(PlainSocketImpl.java:228)
	at java.net.SocksSocketImpl.connect(SocksSocketImpl.java:431)
	at java.net.Socket.connect(Socket.java:527)
	at com.mongodb.DBPort._open(DBPort.java:223)
	at com.mongodb.DBPort.go(DBPort.java:125)
	at com.mongodb.DBPort.call(DBPort.java:92)
	at com.mongodb.DBTCPConnector.innerCall(DBTCPConnector.java:244)
	... 34 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14055947" author="mreutegg" created="Wed, 9 Jul 2014 07:21:52 +0000"  >&lt;p&gt;While working on &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-1650&quot; title=&quot;NPE and MicroKernelException: The node .. does not exist, on replica primary crash during save&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-1650&quot;&gt;&lt;del&gt;OAK-1650&lt;/del&gt;&lt;/a&gt;, I once in a while also saw these execution exceptions. I think it would be good to at least unwrap the execution exception and if possible make them appear as RepositoryException on the JCR level.&lt;/p&gt;</comment>
                            <comment id="14056146" author="mreutegg" created="Wed, 9 Jul 2014 11:58:45 +0000"  >&lt;p&gt;There are various things we should improve here.&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;get rid of the execution exception and re-throw the cause&lt;/li&gt;
	&lt;li&gt;clarify propagation of runtime exception from backends&lt;/li&gt;
	&lt;li&gt;implement retry logic in MongoMK where appropriate&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14056414" author="mreutegg" created="Wed, 9 Jul 2014 16:19:02 +0000"  >&lt;p&gt;Execution exceptions are now properly unwrapped: &lt;a href=&quot;http://svn.apache.org/r1609222&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1609222&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14060396" author="mreutegg" created="Mon, 14 Jul 2014 07:16:22 +0000"  >&lt;p&gt;Some notes running the test again with the current oak code base:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;every now and then I see messages like these from the test:
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Reader: NOT FOUND: level1=40, level2=686
Reader: Reverifying once...
Reader: not found: level1=40, level2=686
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I think, the reason for this is the TODO in MongoDocumentStore.getMongoReadPreference(). The default read preference is primaryPreferred for PREFER_SECONDARY_IF_OLD_ENOUGH. I suspect, on failover MongoMK reads from a stale secondary because now primary is available at that time. The retry in the test does not help because the stale document is cached.&lt;/p&gt;</comment>
                            <comment id="14113464" author="mreutegg" created="Thu, 28 Aug 2014 07:19:37 +0000"  >&lt;p&gt;Finally had a chance to look into this again and I still think the TODO in &lt;tt&gt;getMongoReadPreference()&lt;/tt&gt; must be addressed. It is fine to read from a secondary, but for PREFER_SECONDARY_IF_OLD_ENOUGH only when the revision is indeed old enough. However the default is currently &lt;tt&gt;primaryPreferred()&lt;/tt&gt;, which may result in stale reads from a secondary when there is no primary during failover. I&apos;d rather ensure consistent reads at the cost of blocking the call for a couple of seconds until a new primary is elected. Stale data may require a restart of the repository, which is exactly what we want to avoid in a high availability scenario.&lt;/p&gt;</comment>
                            <comment id="14113482" author="chetanm" created="Thu, 28 Aug 2014 07:33:25 +0000"  >&lt;blockquote&gt;&lt;p&gt;I&apos;d rather ensure consistent reads at the cost of blocking the call for a couple of seconds until a new primary is elected.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Makes sense to be safer there in terms of consistency. For now we can switch readPreference to primary per default. And then see how we can add waits for handling the case when switch over is in progress&lt;/p&gt;</comment>
                            <comment id="14113504" author="mreutegg" created="Thu, 28 Aug 2014 07:47:26 +0000"  >&lt;p&gt;After changing the default for PREFER_SECONDARY_IF_OLD_ENOUGH to &lt;tt&gt;primary()&lt;/tt&gt; things improved, but I still see &apos;NOT FOUND&apos; messages. I can see successful calls from Oak to MongoDB, but on failover some of the changes are not present on the new primary. This is expected with the default write concern (ACKNOWLEDGED). But even with &apos;w=2&apos; (REPLICA_ACKNOWLEDGED) successful changes done by Oak are sometimes not completely present on a new primary. This may have to do with the findAndModify() command we use. It is not possible to pass a write concern and the &lt;a href=&quot;http://docs.mongodb.org/manual/reference/method/db.collection.findAndModify/#comparisons-with-the-update-method&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;docs&lt;/a&gt; say the default write concern is used. I&apos;m not sure if this refers to the default in general (ACKNOWLEDGED) or the current default set on the collection in the driver. AFAICS the Java driver does not pick up the current write concern of the collection when it executes a command.&lt;/p&gt;</comment>
                            <comment id="14113513" author="mreutegg" created="Thu, 28 Aug 2014 07:55:05 +0000"  >&lt;blockquote&gt;&lt;p&gt;add waits for handling the case when switch over is in progress&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;AFAICS this is not necessary. The Java driver has a connectTimoutMS setting, which controls how long the built in connection mechanism will wait for an appropriate connection. If a call to the primary is requested (e.g. a write or a read with primary preference), then per default the driver will wait up to 10 seconds for a new primary to be elected.&lt;/p&gt;

&lt;p&gt;We should cover the case when an operation fails because the mongod process crashes or is otherwise unavailable. A read will currently just fail with an exception. I think this should be detected and the operation should be retried.&lt;/p&gt;</comment>
                            <comment id="14113526" author="chetanm" created="Thu, 28 Aug 2014 08:08:48 +0000"  >&lt;blockquote&gt;&lt;p&gt;This may have to do with the findAndModify() command we use. It is not possible to pass a write concern and the docs say the default write concern is used. I&apos;m not sure if this refers to the default in general (ACKNOWLEDGED) or the current default set on the collection in the driver. AFAICS the Java driver does not pick up the current write concern of the collection when it executes a command.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes that appears to be the case &lt;a href=&quot;https://jira.mongodb.org/browse/SERVER-6558&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;SERVER-6558&lt;/a&gt; and &lt;a href=&quot;https://groups.google.com/forum/#!topic/mongodb-user/bxeLmARsupk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. And from &lt;a href=&quot;http://stackoverflow.com/questions/23475081/mongodb-findandmodify-with-writeconcern&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;SO&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;The MongoDB Java Driver is a Wrapper to access the MongoDB shell commands from inside of your java code. DBCollection#findAndModify does not provide a flag to force a WriteConcern for a single operation. &lt;b&gt;So this Operation uses the default setting of the mongod instance it is writing to.&lt;/b&gt;&lt;/p&gt;&lt;/blockquote&gt;</comment>
                            <comment id="14119531" author="mreutegg" created="Wed, 3 Sep 2014 08:19:42 +0000"  >&lt;p&gt;In the meantime I tried to &lt;a href=&quot;http://docs.mongodb.org/manual/core/replica-set-write-concern/#modify-default-write-concern&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;set the write concern on the replica set&lt;/a&gt;. But even with this change, I still see successful changes by findAndModify() disappear when I crash the primary.&lt;/p&gt;</comment>
                            <comment id="14119960" author="mreutegg" created="Wed, 3 Sep 2014 15:25:50 +0000"  >&lt;p&gt;In a first step I changed the default read preference for PREFER_SECONDARY_IF_OLD_ENOUGH to primary(), as discussed.&lt;/p&gt;

&lt;p&gt;I also introduced a retry when find calls fail because of a crash of the primary.&lt;/p&gt;

&lt;p&gt;Done in revision &lt;a href=&quot;http://svn.apache.org/r1622239&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1622239&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14352718" author="mreutegg" created="Mon, 9 Mar 2015 09:39:37 +0000"  >&lt;p&gt;The initially reported issue is resolved. The remaining issue with the write concern is tracked with &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-2592&quot; title=&quot;Commit does not ensure w:majority&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-2592&quot;&gt;&lt;del&gt;OAK-2592&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="14482855" author="edivad" created="Tue, 7 Apr 2015 09:09:44 +0000"  >&lt;p&gt;Bulk closing for 1.1.8&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="12696528">OAK-1453</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12637430" name="ReplicaCrashResilienceTest.java" size="11353" author="stefanegli" created="Fri, 28 Mar 2014 15:50:14 +0000"/>
                            <attachment id="12637419" name="ReplicaCrashResilienceTest.java" size="9891" author="stefanegli" created="Fri, 28 Mar 2014 15:08:37 +0000"/>
                            <attachment id="12637418" name="mongoUrl_fixture_patch_oak1641.diff" size="4097" author="stefanegli" created="Fri, 28 Mar 2014 15:07:16 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>382593</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 32 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1twwv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>382861</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>