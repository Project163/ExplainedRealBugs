diff --git a/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/CompactionMap.java b/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/CompactionMap.java
index 000b22db62..e1bfef4e17 100644
--- a/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/CompactionMap.java
+++ b/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/CompactionMap.java
@@ -103,26 +103,25 @@ public class CompactionMap {
      * @param uuids  uuids of the keys to remove
      */
     public void remove(@Nonnull Set<UUID> uuids) {
-        List<PartialCompactionMap> remove = newArrayList();
         for (PartialCompactionMap map : maps) {
             map.remove(uuids);
-            if (map.getSegmentCount() == 0) {
-                remove.add(map);
-            }
         }
-        maps.removeAll(remove);
     }
 
     /**
      * Create a new {@code CompactionMap} containing all maps
-     * of this instances and additional the passed {@code map}.
-     * @param map
+     * of this instances and additional the passed map {@code head}.
+     * @param head
      * @return a new {@code CompactionMap} instance
      */
     @Nonnull
-    public CompactionMap cons(@Nonnull PartialCompactionMap map) {
-        List<PartialCompactionMap> maps = newArrayList(map);
-        maps.addAll(this.maps);
+    public CompactionMap cons(@Nonnull PartialCompactionMap head) {
+        List<PartialCompactionMap> maps = newArrayList(head);
+        for (PartialCompactionMap map : this.maps) {
+            if (!map.isEmpty()) {
+                maps.add(map);
+            }
+        }
         return new CompactionMap(maps);
     }
 
diff --git a/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/InMemoryCompactionMap.java b/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/InMemoryCompactionMap.java
index 42d50f48f5..959b88d16f 100644
--- a/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/InMemoryCompactionMap.java
+++ b/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/InMemoryCompactionMap.java
@@ -185,6 +185,11 @@ public class InMemoryCompactionMap implements PartialCompactionMap {
         return afterOffsets.length;
     }
 
+    @Override
+    public boolean isEmpty() {
+        return afterOffsets.length == 0 && recent.isEmpty();
+    }
+
     private void compress(@Nonnull Set<UUID> removed) {
         if (recent.isEmpty() && removed.isEmpty()) {
             // no-op
diff --git a/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/PartialCompactionMap.java b/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/PartialCompactionMap.java
index a182a51fba..5a5269d746 100644
--- a/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/PartialCompactionMap.java
+++ b/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/PartialCompactionMap.java
@@ -96,6 +96,12 @@ public interface PartialCompactionMap {
      */
     long getRecordCount();
 
+    /**
+     * Determine whether this map contains keys at all.
+     * @return  {@code true} iff this map is empty
+     */
+    boolean isEmpty();
+
     /**
      * The weight of the compaction map is its heap memory consumption in bytes.
      * @return  Estimated weight of the compaction map
diff --git a/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/PersistedCompactionMap.java b/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/PersistedCompactionMap.java
index 312b540586..22b092c000 100644
--- a/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/PersistedCompactionMap.java
+++ b/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/PersistedCompactionMap.java
@@ -66,7 +66,6 @@ public class PersistedCompactionMap implements PartialCompactionMap {
 
     private final FileStore store;
 
-    private int recentCount;
     private long recordCount;
     private MapRecord entries;
 
@@ -144,8 +143,7 @@ public class PersistedCompactionMap implements PartialCompactionMap {
         }
         entry.put(encode(before.getOffset()), after);
 
-        if (++recentCount > COMPRESS_INTERVAL) {
-            recentCount = 0;
+        if (recent.size() > COMPRESS_INTERVAL) {
             compress();
         }
     }
@@ -170,6 +168,11 @@ public class PersistedCompactionMap implements PartialCompactionMap {
         return recordCount;
     }
 
+    @Override
+    public boolean isEmpty() {
+        return recent.size() + recordCount == 0;
+    }
+
     private void compress(@Nonnull Set<UUID> removed) {
         if (recent.isEmpty() && removed.isEmpty()) {
             return;
diff --git a/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/package-info.java b/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/package-info.java
index 3b1fc1641b..4a185ed048 100644
--- a/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/package-info.java
+++ b/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/package-info.java
@@ -14,7 +14,7 @@
  * See the License for the specific language governing permissions and
  * limitations under the License.
  */
-@Version("4.1.0")
+@Version("5.0.0")
 @Export(optional = "provide:=true")
 package org.apache.jackrabbit.oak.plugins.segment;
 
diff --git a/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/segment/CompactionMapTest.java b/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/segment/CompactionMapTest.java
index 21fcbd2928..36e9dbfaf4 100644
--- a/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/segment/CompactionMapTest.java
+++ b/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/segment/CompactionMapTest.java
@@ -173,7 +173,10 @@ public class CompactionMapTest {
                 removedUUIDs.add(key.asUUID());
             }
             compactionMap.remove(removedUUIDs);
-            assertEquals(--expectedDepth, compactionMap.getDepth());
+            expectedDepth--;
+            // Effect of removed generation is only seen after subsequent cons. See OAK-3317
+            CompactionMap consed = compactionMap.cons(compactionMap1);
+            assertEquals(expectedDepth + 1, consed.getDepth());
             expectedSize -= removedUUIDs.size();
             assertEquals(expectedSize, sum(compactionMap.getSegmentCounts()));
         }
