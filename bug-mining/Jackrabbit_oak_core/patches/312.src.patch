diff --git a/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/AndImpl.java b/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/AndImpl.java
index f740e01d48..905654766b 100644
--- a/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/AndImpl.java
+++ b/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/AndImpl.java
@@ -18,8 +18,12 @@
  */
 package org.apache.jackrabbit.oak.query.ast;
 
+import java.util.Set;
+
 import org.apache.jackrabbit.oak.query.index.FilterImpl;
 
+import com.google.common.collect.Sets;
+
 /**
  * An AND condition.
  */
@@ -39,6 +43,15 @@ public class AndImpl extends ConstraintImpl {
     public ConstraintImpl getConstraint2() {
         return constraint2;
     }
+    
+    @Override
+    public Set<PropertyExistenceImpl> getPropertyExistenceConditions() {
+        Set<PropertyExistenceImpl> s1 = constraint1.getPropertyExistenceConditions();
+        Set<PropertyExistenceImpl> s2 = constraint2.getPropertyExistenceConditions();
+        Set<PropertyExistenceImpl> result = Sets.newHashSet(s1);
+        result.addAll(s2);
+        return result;
+    }
 
     @Override
     public boolean evaluate() {
diff --git a/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/ChildNodeImpl.java b/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/ChildNodeImpl.java
index 0789238a6c..6870b5d3e9 100644
--- a/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/ChildNodeImpl.java
+++ b/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/ChildNodeImpl.java
@@ -18,6 +18,9 @@
  */
 package org.apache.jackrabbit.oak.query.ast;
 
+import java.util.Collections;
+import java.util.Set;
+
 import org.apache.jackrabbit.oak.commons.PathUtils;
 import org.apache.jackrabbit.oak.query.index.FilterImpl;
 import org.apache.jackrabbit.oak.spi.query.Filter;
@@ -49,6 +52,11 @@ public class ChildNodeImpl extends ConstraintImpl {
     public void bindSelector(SourceImpl source) {
         selector = source.getExistingSelector(selectorName);
     }
+    
+    @Override
+    public Set<PropertyExistenceImpl> getPropertyExistenceConditions() {
+        return Collections.emptySet();
+    }
 
     @Override
     public boolean evaluate() {
diff --git a/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/ComparisonImpl.java b/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/ComparisonImpl.java
index 5dab9b92b4..9c12360bc4 100644
--- a/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/ComparisonImpl.java
+++ b/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/ComparisonImpl.java
@@ -18,6 +18,9 @@
  */
 package org.apache.jackrabbit.oak.query.ast;
 
+import java.util.Collections;
+import java.util.Set;
+
 import javax.jcr.PropertyType;
 
 import org.apache.jackrabbit.oak.api.PropertyValue;
@@ -58,6 +61,15 @@ public class ComparisonImpl extends ConstraintImpl {
         }
         return ifUnknown;
     }
+    
+    @Override
+    public Set<PropertyExistenceImpl> getPropertyExistenceConditions() {
+        PropertyExistenceImpl p = operand1.getPropertyExistence();
+        if (p == null) {
+            Collections.emptySet();
+        }
+        return Collections.singleton(p);
+    }
 
     @Override
     public boolean evaluate() {
diff --git a/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/ConstraintImpl.java b/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/ConstraintImpl.java
index 073eac6ea2..235862a3ce 100644
--- a/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/ConstraintImpl.java
+++ b/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/ConstraintImpl.java
@@ -16,6 +16,8 @@
  */
 package org.apache.jackrabbit.oak.query.ast;
 
+import java.util.Set;
+
 import org.apache.jackrabbit.oak.query.index.FilterImpl;
 
 /**
@@ -29,6 +31,17 @@ public abstract class ConstraintImpl extends AstElement {
      * @return true if the constraint matches
      */
     public abstract boolean evaluate();
+    
+    /**
+     * Get the set of property existence conditions that can be derived for this
+     * condition. For example, for the condition "x=1 or x=2", the property
+     * existence condition is "x is not null". For the condition "x=1 or y=2",
+     * there is no such condition. For the condition "x=1 and y=1", there are
+     * two (x is not null, and y is not null).
+     * 
+     * @return the common property existence condition (possibly empty)
+     */
+    public abstract Set<PropertyExistenceImpl> getPropertyExistenceConditions();
 
     /**
      * Apply the condition to the filter, further restricting the filter if
diff --git a/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/DescendantNodeImpl.java b/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/DescendantNodeImpl.java
index ad1f53ff00..527448094a 100644
--- a/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/DescendantNodeImpl.java
+++ b/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/DescendantNodeImpl.java
@@ -18,6 +18,9 @@
  */
 package org.apache.jackrabbit.oak.query.ast;
 
+import java.util.Collections;
+import java.util.Set;
+
 import org.apache.jackrabbit.oak.commons.PathUtils;
 import org.apache.jackrabbit.oak.query.index.FilterImpl;
 import org.apache.jackrabbit.oak.spi.query.Filter;
@@ -35,6 +38,11 @@ public class DescendantNodeImpl extends ConstraintImpl {
         this.selectorName = selectorName;
         this.ancestorPath = ancestorPath;
     }
+    
+    @Override
+    public Set<PropertyExistenceImpl> getPropertyExistenceConditions() {
+        return Collections.emptySet();
+    }
 
     @Override
     public boolean evaluate() {
diff --git a/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/DynamicOperandImpl.java b/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/DynamicOperandImpl.java
index 4197a2cb0a..1d32ec1be7 100644
--- a/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/DynamicOperandImpl.java
+++ b/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/DynamicOperandImpl.java
@@ -45,4 +45,12 @@ public abstract class DynamicOperandImpl extends AstElement {
 
     abstract int getPropertyType();
 
+    /**
+     * Get the property existence condition for this operand, if this operand is
+     * used as part of a condition.
+     * 
+     * @return the property existence condition, or null if none
+     */
+    public abstract PropertyExistenceImpl getPropertyExistence();
+
 }
diff --git a/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/FullTextSearchImpl.java b/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/FullTextSearchImpl.java
index fd22f6d4f1..c091f867c0 100644
--- a/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/FullTextSearchImpl.java
+++ b/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/FullTextSearchImpl.java
@@ -23,6 +23,8 @@ import static org.apache.jackrabbit.oak.api.Type.STRINGS;
 
 import java.text.ParseException;
 import java.util.ArrayList;
+import java.util.Collections;
+import java.util.Set;
 
 import org.apache.jackrabbit.oak.api.PropertyState;
 import org.apache.jackrabbit.oak.api.PropertyValue;
@@ -98,6 +100,14 @@ public class FullTextSearchImpl extends ConstraintImpl {
         builder.append(')');
         return builder.toString();
     }
+    
+    @Override
+    public Set<PropertyExistenceImpl> getPropertyExistenceConditions() {
+        if (propertyName == null) {
+            return Collections.emptySet();
+        }
+        return Collections.singleton(new PropertyExistenceImpl(selector, selectorName, propertyName));
+    }
 
     @Override
     public boolean evaluate() {
diff --git a/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/FullTextSearchScoreImpl.java b/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/FullTextSearchScoreImpl.java
index d47e6be0d5..c100f7d76c 100644
--- a/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/FullTextSearchScoreImpl.java
+++ b/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/FullTextSearchScoreImpl.java
@@ -46,6 +46,11 @@ public class FullTextSearchScoreImpl extends DynamicOperandImpl {
     public String toString() {
         return "score(" + quote(selectorName) + ')';
     }
+    
+    @Override
+    public PropertyExistenceImpl getPropertyExistence() {
+        return null;
+    }
 
     @Override
     public PropertyValue currentProperty() {
diff --git a/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/LengthImpl.java b/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/LengthImpl.java
index dc69547e43..6353dba447 100644
--- a/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/LengthImpl.java
+++ b/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/LengthImpl.java
@@ -48,6 +48,11 @@ public class LengthImpl extends DynamicOperandImpl {
     public String toString() {
         return "length(" + propertyValue + ')';
     }
+    
+    @Override
+    public PropertyExistenceImpl getPropertyExistence() {
+        return propertyValue.getPropertyExistence();
+    }
 
     @Override
     public PropertyValue currentProperty() {
diff --git a/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/LowerCaseImpl.java b/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/LowerCaseImpl.java
index 91bc61acb8..34470a05ad 100644
--- a/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/LowerCaseImpl.java
+++ b/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/LowerCaseImpl.java
@@ -50,6 +50,11 @@ public class LowerCaseImpl extends DynamicOperandImpl {
     public String toString() {
         return "lower(" + operand + ')';
     }
+    
+    @Override
+    public PropertyExistenceImpl getPropertyExistence() {
+        return operand.getPropertyExistence();
+    }
 
     @Override
     public PropertyValue currentProperty() {
diff --git a/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/NodeLocalNameImpl.java b/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/NodeLocalNameImpl.java
index 01f7d2785f..1adf7985c5 100644
--- a/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/NodeLocalNameImpl.java
+++ b/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/NodeLocalNameImpl.java
@@ -51,6 +51,11 @@ public class NodeLocalNameImpl extends DynamicOperandImpl {
     public void bindSelector(SourceImpl source) {
         selector = source.getExistingSelector(selectorName);
     }
+    
+    @Override
+    public PropertyExistenceImpl getPropertyExistence() {
+        return null;
+    }
 
     @Override
     public PropertyValue currentProperty() {
diff --git a/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/NodeNameImpl.java b/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/NodeNameImpl.java
index 9a3e7b875d..3cd74931f0 100644
--- a/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/NodeNameImpl.java
+++ b/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/NodeNameImpl.java
@@ -58,6 +58,11 @@ public class NodeNameImpl extends DynamicOperandImpl {
     public boolean supportsRangeConditions() {
         return false;
     }
+    
+    @Override
+    public PropertyExistenceImpl getPropertyExistence() {
+        return null;
+    }
 
     @Override
     public PropertyValue currentProperty() {
diff --git a/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/NotImpl.java b/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/NotImpl.java
index a08840d693..ea7a576e68 100644
--- a/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/NotImpl.java
+++ b/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/NotImpl.java
@@ -18,6 +18,9 @@
  */
 package org.apache.jackrabbit.oak.query.ast;
 
+import java.util.Collections;
+import java.util.Set;
+
 import org.apache.jackrabbit.oak.query.index.FilterImpl;
 
 /**
@@ -39,6 +42,11 @@ public class NotImpl extends ConstraintImpl {
     public boolean evaluate() {
         return !constraint.evaluate();
     }
+    
+    @Override
+    public Set<PropertyExistenceImpl> getPropertyExistenceConditions() {
+        return Collections.emptySet();
+    }
 
     @Override
     boolean accept(AstVisitor v) {
diff --git a/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/OrImpl.java b/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/OrImpl.java
index 3ccbcd0884..427c2dd4e5 100644
--- a/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/OrImpl.java
+++ b/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/OrImpl.java
@@ -18,8 +18,12 @@
  */
 package org.apache.jackrabbit.oak.query.ast;
 
+import java.util.Set;
+
 import org.apache.jackrabbit.oak.query.index.FilterImpl;
 
+import com.google.common.collect.Sets;
+
 /**
  * An "or" condition.
  */
@@ -40,6 +44,19 @@ public class OrImpl extends ConstraintImpl {
     public ConstraintImpl getConstraint2() {
         return constraint2;
     }
+    
+    @Override
+    public Set<PropertyExistenceImpl> getPropertyExistenceConditions() {
+        Set<PropertyExistenceImpl> s1 = constraint1.getPropertyExistenceConditions();
+        if (s1.isEmpty()) {
+            return s1;
+        }
+        Set<PropertyExistenceImpl> s2 = constraint2.getPropertyExistenceConditions();
+        if (s2.isEmpty()) {
+            return s2;
+        }
+        return Sets.intersection(s1, s2);
+    }
 
     @Override
     public boolean evaluate() {
@@ -58,8 +75,13 @@ public class OrImpl extends ConstraintImpl {
 
     @Override
     public void restrict(FilterImpl f) {
-        // ignore
-        // TODO convert OR conditions to UNION
+        Set<PropertyExistenceImpl> set = getPropertyExistenceConditions();
+        if (set.isEmpty()) {
+            return;
+        }
+        for (PropertyExistenceImpl p : set) {
+            p.restrict(f);
+        }
     }
 
     @Override
diff --git a/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/PropertyExistenceImpl.java b/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/PropertyExistenceImpl.java
index f2261c9ecc..74cac3aa63 100644
--- a/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/PropertyExistenceImpl.java
+++ b/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/PropertyExistenceImpl.java
@@ -18,6 +18,9 @@
  */
 package org.apache.jackrabbit.oak.query.ast;
 
+import java.util.Collections;
+import java.util.Set;
+
 import org.apache.jackrabbit.oak.query.index.FilterImpl;
 
 /**
@@ -29,6 +32,12 @@ public class PropertyExistenceImpl extends ConstraintImpl {
     private final String propertyName;
     private SelectorImpl selector;
 
+    public PropertyExistenceImpl(SelectorImpl selector, String selectorName, String propertyName) {
+        this.selector = selector;
+        this.selectorName = selectorName;
+        this.propertyName = propertyName;
+    }
+    
     public PropertyExistenceImpl(String selectorName, String propertyName) {
         this.selectorName = selectorName;
         this.propertyName = propertyName;
@@ -39,6 +48,11 @@ public class PropertyExistenceImpl extends ConstraintImpl {
         return selector.currentProperty(propertyName) != null;
     }
 
+    @Override
+    public Set<PropertyExistenceImpl> getPropertyExistenceConditions() {
+        return Collections.singleton(this);
+    }
+
     @Override
     boolean accept(AstVisitor v) {
         return v.visit(this);
@@ -66,5 +80,27 @@ public class PropertyExistenceImpl extends ConstraintImpl {
             s.restrictSelector(this);
         }
     }
+    
+    @Override
+    public int hashCode() {
+        return ((selectorName == null) ? 0 : selectorName.hashCode()) * 31 +
+                ((propertyName == null) ? 0 : propertyName.hashCode());
+    }
+
+    @Override
+    public boolean equals(Object obj) {
+        if (this == obj) {
+            return true;
+        } else if (obj == null || getClass() != obj.getClass()) {
+            return false;
+        }
+        PropertyExistenceImpl other = (PropertyExistenceImpl) obj;
+        return equalsStrings(selectorName, other.selectorName) &&
+                equalsStrings(propertyName, other.propertyName);
+    }
+    
+    private static boolean equalsStrings(String a, String b) {
+        return a == null || b == null ? a == b : a.equals(b);
+    }
 
 }
diff --git a/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/PropertyValueImpl.java b/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/PropertyValueImpl.java
index 7bf369e18d..a8ad74cc84 100644
--- a/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/PropertyValueImpl.java
+++ b/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/PropertyValueImpl.java
@@ -89,6 +89,14 @@ public class PropertyValueImpl extends DynamicOperandImpl {
         // expressions that would result in incorrect results (/test[1] for example)
         return !propertyName.equals(Query.JCR_PATH);
     }
+    
+    @Override
+    public PropertyExistenceImpl getPropertyExistence() {
+        if (propertyName.equals("*")) {
+            return null;
+        }
+        return new PropertyExistenceImpl(selector, selectorName, propertyName);
+    }
 
     @Override
     public PropertyValue currentProperty() {
diff --git a/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/SameNodeImpl.java b/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/SameNodeImpl.java
index e93c0a2c1f..e272bd9f61 100644
--- a/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/SameNodeImpl.java
+++ b/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/SameNodeImpl.java
@@ -18,6 +18,9 @@
  */
 package org.apache.jackrabbit.oak.query.ast;
 
+import java.util.Collections;
+import java.util.Set;
+
 import org.apache.jackrabbit.oak.query.index.FilterImpl;
 import org.apache.jackrabbit.oak.spi.query.Filter;
 
@@ -41,6 +44,11 @@ public class SameNodeImpl extends ConstraintImpl {
         // TODO normalize paths
         return selector.currentPath().equals(p);
     }
+    
+    @Override
+    public Set<PropertyExistenceImpl> getPropertyExistenceConditions() {
+        return Collections.emptySet();
+    }
 
     @Override
     boolean accept(AstVisitor v) {
diff --git a/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/UpperCaseImpl.java b/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/UpperCaseImpl.java
index a07460d38b..09bf343158 100644
--- a/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/UpperCaseImpl.java
+++ b/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/UpperCaseImpl.java
@@ -50,6 +50,11 @@ public class UpperCaseImpl extends DynamicOperandImpl {
     public String toString() {
         return "upper(" + operand + ')';
     }
+    
+    @Override
+    public PropertyExistenceImpl getPropertyExistence() {
+        return operand.getPropertyExistence();
+    }
 
     @Override
     public PropertyValue currentProperty() {
diff --git a/oak-core/src/test/resources/org/apache/jackrabbit/oak/query/sql2_index.txt b/oak-core/src/test/resources/org/apache/jackrabbit/oak/query/sql2_index.txt
index 668ed32c0c..21c19dc86b 100644
--- a/oak-core/src/test/resources/org/apache/jackrabbit/oak/query/sql2_index.txt
+++ b/oak-core/src/test/resources/org/apache/jackrabbit/oak/query/sql2_index.txt
@@ -25,6 +25,18 @@
 
 # property type (value prefix) index
 
+explain select * from [nt:base] where [jcr:uuid]=1 or [b]=2
+[nt:base] as [nt:base] /* traverse "*" */
+
+explain select * from [nt:base] where length([jcr:uuid])=1 or upper([jcr:uuid])='1' or lower([jcr:uuid])='3'
+[nt:base] as [nt:base] /* property jcr:uuid */
+
+explain select * from [nt:base] where [jcr:uuid] = '1' or ([jcr:uuid] = '2' and [b] = '3')
+[nt:base] as [nt:base] /* property jcr:uuid */
+
+explain select * from [nt:base] where [jcr:uuid] = '1' or [jcr:uuid] = '2'
+[nt:base] as [nt:base] /* property jcr:uuid */
+
 explain select * from [nt:base] where [jcr:uuid] = '123'
 [nt:base] as [nt:base] /* property jcr:uuid=123 where [nt:base].[jcr:uuid] = cast('123' as string) */
 
