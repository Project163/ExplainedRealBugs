diff --git a/oak-core/src/main/java/org/apache/jackrabbit/oak/security/user/PasswordHistory.java b/oak-core/src/main/java/org/apache/jackrabbit/oak/security/user/PasswordHistory.java
index e6e2d3c8d2..c473021669 100644
--- a/oak-core/src/main/java/org/apache/jackrabbit/oak/security/user/PasswordHistory.java
+++ b/oak-core/src/main/java/org/apache/jackrabbit/oak/security/user/PasswordHistory.java
@@ -65,8 +65,7 @@ final class PasswordHistory implements UserConstants {
         boolean updated = false;
         if (isEnabled) {
             checkPasswordInHistory(userTree, password);
-            shiftPasswordHistory(userTree);
-            updated = true;
+            updated = shiftPasswordHistory(userTree);
         }
         return updated;
     }
@@ -76,10 +75,11 @@ final class PasswordHistory implements UserConstants {
      * and trim the list of hashes in the list according to the configured maxSize.
      *
      * @param userTree The user tree.
+     * @return true if the history was successfully adjusted, false otherwise
      * @throws AccessDeniedException If the editing session cannot access or
      * create the rep:pwd node.
      */
-    private void shiftPasswordHistory(@NotNull Tree userTree) throws AccessDeniedException {
+    private boolean shiftPasswordHistory(@NotNull Tree userTree) throws AccessDeniedException {
         String currentPasswordHash = TreeUtil.getString(userTree, UserConstants.REP_PASSWORD);
         if (currentPasswordHash != null) {
             Tree passwordTree = getPasswordTree(userTree, true);
@@ -97,6 +97,9 @@ final class PasswordHistory implements UserConstants {
             }
 
             passwordTree.setProperty(UserConstants.REP_PWD_HISTORY, historyEntries, Type.STRINGS);
+            return true;
+        } else {
+            return false;
         }
     }
 
diff --git a/oak-core/src/test/java/org/apache/jackrabbit/oak/security/user/PasswordHistoryTest.java b/oak-core/src/test/java/org/apache/jackrabbit/oak/security/user/PasswordHistoryTest.java
index b661d173e4..fc16ba31a6 100644
--- a/oak-core/src/test/java/org/apache/jackrabbit/oak/security/user/PasswordHistoryTest.java
+++ b/oak-core/src/test/java/org/apache/jackrabbit/oak/security/user/PasswordHistoryTest.java
@@ -307,4 +307,11 @@ public class PasswordHistoryTest extends AbstractSecurityTest implements UserCon
         assertTrue(pwdNode.getProperty(REP_PWD_HISTORY).isArray());
         assertTrue(pwdNode.getProperty(REP_PWD_HISTORY).getType().isArray());
     }
+
+    @Test
+    public void testUpdateMissingPwHash() throws Exception {
+        User u = getUserManager(root).createUser("uid", null);
+        PasswordHistory ph = new PasswordHistory(ConfigurationParameters.of(UserConstants.PARAM_PASSWORD_HISTORY_SIZE, UserConstants.PASSWORD_HISTORY_DISABLED_SIZE+1));
+        assertFalse(ph.updatePasswordHistory(root.getTree(u.getPath()), "pw"));
+    }
 }
