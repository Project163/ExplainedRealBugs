diff --git a/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/NodeLocalNameImpl.java b/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/NodeLocalNameImpl.java
index 39097bd3dc..5569073b65 100644
--- a/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/NodeLocalNameImpl.java
+++ b/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/NodeLocalNameImpl.java
@@ -68,7 +68,11 @@ public class NodeLocalNameImpl extends DynamicOperandImpl {
 
     @Override
     public PropertyValue currentProperty() {
-        String name = PathUtils.getName(selector.currentPath());
+        String path = selector.currentPath();
+        if (path == null) {
+            return null;
+        }
+        String name = PathUtils.getName(path);
         String localName = getLocalName(name);
         // TODO reverse namespace remapping?
         return PropertyValues.newString(localName);
diff --git a/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/NodeNameImpl.java b/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/NodeNameImpl.java
index 2a18f4e217..6cd0aebc14 100644
--- a/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/NodeNameImpl.java
+++ b/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/NodeNameImpl.java
@@ -78,6 +78,9 @@ public class NodeNameImpl extends DynamicOperandImpl {
     @Override
     public PropertyValue currentProperty() {
         String path = selector.currentPath();
+        if (path == null) {
+            return null;
+        }
         String name = PathUtils.getName(path);
         // TODO reverse namespace remapping?
         return PropertyValues.newName(name);
diff --git a/oak-core/src/test/resources/org/apache/jackrabbit/oak/query/sql2.txt b/oak-core/src/test/resources/org/apache/jackrabbit/oak/query/sql2.txt
index f1e015a090..96ee6efc67 100644
--- a/oak-core/src/test/resources/org/apache/jackrabbit/oak/query/sql2.txt
+++ b/oak-core/src/test/resources/org/apache/jackrabbit/oak/query/sql2.txt
@@ -29,6 +29,18 @@
 
 commit / + "test": { "a": { "name": "Hello" }, "b": { "name" : "World" }}
 
+# OAK-4658
+select a.[jcr:path] from [nt:base] as a 
+  left outer join [nt:base] as b on ischildnode(b, a)
+  where name(b) = 'b'
+/test  
+
+# OAK-4658
+select a.[jcr:path] from [nt:base] as a 
+  left outer join [nt:base] as b on ischildnode(b, a)
+  where localname(b) = 'b'
+/test  
+
 select * from [nt:base]
   where [a] = 1 and [b] = 2 and [b] = 3 or [c] = 4
 
