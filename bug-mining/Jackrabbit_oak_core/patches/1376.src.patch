diff --git a/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/document/ClusterRevisionComparisonTest.java b/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/document/ClusterRevisionComparisonTest.java
index 8d0efce25c..ea0aa890f7 100644
--- a/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/document/ClusterRevisionComparisonTest.java
+++ b/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/document/ClusterRevisionComparisonTest.java
@@ -104,7 +104,7 @@ public class ClusterRevisionComparisonTest {
 
         //Trigger a diff. With OAK-2144 an exception would be thrown as diff traverses
         //the /a children
-        c1ns1.compareAgainstBaseState(c1ns2, new ClusterTest.TrackingDiff());
+        c1ns1.compareAgainstBaseState(c1ns2, new TrackingDiff());
     }
 
     @Test
diff --git a/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/document/ClusterTest.java b/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/document/ClusterTest.java
index e386b406d3..af1abefe4e 100644
--- a/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/document/ClusterTest.java
+++ b/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/document/ClusterTest.java
@@ -16,8 +16,6 @@
  */
 package org.apache.jackrabbit.oak.plugins.document;
 
-import static org.apache.jackrabbit.oak.plugins.memory.EmptyNodeState.EMPTY_NODE;
-import static org.apache.jackrabbit.oak.plugins.memory.EmptyNodeState.MISSING_NODE;
 import static org.junit.Assert.assertEquals;
 import static org.junit.Assert.assertFalse;
 import static org.junit.Assert.assertNotNull;
@@ -26,7 +24,6 @@ import static org.junit.Assert.fail;
 
 import java.util.HashSet;
 import java.util.List;
-import java.util.Set;
 
 import javax.annotation.Nonnull;
 import javax.annotation.Nullable;
@@ -44,7 +41,6 @@ import org.apache.jackrabbit.oak.spi.commit.CommitInfo;
 import org.apache.jackrabbit.oak.spi.commit.EmptyHook;
 import org.apache.jackrabbit.oak.spi.commit.Observer;
 import org.apache.jackrabbit.oak.spi.state.ChildNodeEntry;
-import org.apache.jackrabbit.oak.spi.state.DefaultNodeStateDiff;
 import org.apache.jackrabbit.oak.spi.state.NodeBuilder;
 import org.apache.jackrabbit.oak.spi.state.NodeState;
 import org.apache.jackrabbit.oak.spi.state.NodeStore;
@@ -463,52 +459,4 @@ public class ClusterTest {
             traverse(child.getNodeState(), PathUtils.concat(path, child.getName()));
         }
     }
-
-    static class TrackingDiff extends DefaultNodeStateDiff {
-
-        final String path;
-        final Set<String> added;
-        final Set<String> deleted;
-        final Set<String> modified;
-
-        TrackingDiff() {
-            this("/", new HashSet<String>(),
-                    new HashSet<String>(), new HashSet<String>());
-        }
-
-        private TrackingDiff(String path,
-                             Set<String> added,
-                             Set<String> deleted,
-                             Set<String> modified) {
-            this.path = path;
-            this.added = added;
-            this.deleted = deleted;
-            this.modified = modified;
-        }
-
-        @Override
-        public boolean childNodeAdded(String name, NodeState after) {
-            String p = PathUtils.concat(path, name);
-            added.add(p);
-            return after.compareAgainstBaseState(EMPTY_NODE,
-                    new TrackingDiff(p, added, deleted, modified));
-        }
-
-        @Override
-        public boolean childNodeChanged(String name,
-                                        NodeState before,
-                                        NodeState after) {
-            String p = PathUtils.concat(path, name);
-            modified.add(p);
-            return after.compareAgainstBaseState(before,
-                    new TrackingDiff(p, added, deleted, modified));
-        }
-
-        @Override
-        public boolean childNodeDeleted(String name, NodeState before) {
-            String p = PathUtils.concat(path, name);
-            deleted.add(p);
-            return MISSING_NODE.compareAgainstBaseState(before, new TrackingDiff(p, added, deleted, modified));
-        }
-    }
 }
diff --git a/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/document/DocumentNodeStoreTest.java b/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/document/DocumentNodeStoreTest.java
index 59578e81c7..02b012487a 100644
--- a/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/document/DocumentNodeStoreTest.java
+++ b/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/document/DocumentNodeStoreTest.java
@@ -98,6 +98,7 @@ import org.apache.jackrabbit.oak.spi.state.NodeState;
 import org.apache.jackrabbit.oak.spi.state.NodeStore;
 import org.apache.jackrabbit.oak.stats.Clock;
 import org.junit.After;
+import org.junit.Ignore;
 import org.junit.Rule;
 import org.junit.Test;
 import org.slf4j.Logger;
@@ -631,7 +632,7 @@ public class DocumentNodeStoreTest {
         assertTrue(found);
 
         // diff must report '/test' modified and '/test/foo' added
-        ClusterTest.TrackingDiff diff = new ClusterTest.TrackingDiff();
+        TrackingDiff diff = new TrackingDiff();
         r2.compareAgainstBaseState(r1, diff);
         assertEquals(1, diff.modified.size());
         assertTrue(diff.modified.contains("/test"));
@@ -2362,6 +2363,55 @@ public class DocumentNodeStoreTest {
         assertEquals(0, numPreviousFinds.get());
     }
 
+    // OAK-3608
+    @Ignore("OAK-3608")
+    @Test
+    public void compareOnBranch() throws Exception {
+        long modifiedResMillis = SECONDS.toMillis(MODIFIED_IN_SECS_RESOLUTION);
+        Clock clock = new Clock.Virtual();
+        clock.waitUntil(System.currentTimeMillis());
+        Revision.setClock(clock);
+        DocumentNodeStore ns = builderProvider.newBuilder()
+                .clock(clock)
+                .setAsyncDelay(0).getNodeStore();
+        // initial state
+        NodeBuilder builder = ns.getRoot().builder();
+        NodeBuilder p = builder.child("parent");
+        for (int i = 0; i < DocumentMK.MANY_CHILDREN_THRESHOLD * 2; i++) {
+            p.child("node-" + i);
+        }
+        p.child("node-x").child("child");
+        merge(ns, builder);
+        ns.runBackgroundOperations();
+
+        // wait until modified timestamp changes
+        clock.waitUntil(clock.getTime() + modifiedResMillis * 2);
+        // force new head revision with this different modified timestamp
+        builder = ns.getRoot().builder();
+        builder.child("a");
+        merge(ns, builder);
+
+        DocumentNodeState root = ns.getRoot();
+        final DocumentNodeStoreBranch b = ns.createBranch(root);
+        // branch state is now Unmodified
+        builder = root.builder();
+        builder.child("parent").child("node-x").child("child").child("x");
+        b.setRoot(builder.getNodeState());
+        // branch state is now InMemory
+        builder.child("b");
+        b.setRoot(builder.getNodeState());
+        // branch state is now Persisted
+        builder.child("c");
+        b.setRoot(builder.getNodeState());
+        // branch state is Persisted
+
+        // create a diff between base and head state of branch
+        DocumentNodeState head = asDocumentNodeState(b.getHead());
+        TrackingDiff diff = new TrackingDiff();
+        head.compareAgainstBaseState(root, diff);
+        assertTrue(diff.modified.contains("/parent/node-x/child"));
+    }
+
     private static DocumentNodeState asDocumentNodeState(NodeState state) {
         if (!(state instanceof DocumentNodeState)) {
             throw new IllegalArgumentException("Not a DocumentNodeState");
diff --git a/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/document/TrackingDiff.java b/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/document/TrackingDiff.java
new file mode 100644
index 0000000000..dd10ad4f89
--- /dev/null
+++ b/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/document/TrackingDiff.java
@@ -0,0 +1,72 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one or more
+ * contributor license agreements.  See the NOTICE file distributed with
+ * this work for additional information regarding copyright ownership.
+ * The ASF licenses this file to You under the Apache License, Version 2.0
+ * (the "License"); you may not use this file except in compliance with
+ * the License.  You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package org.apache.jackrabbit.oak.plugins.document;
+
+import java.util.HashSet;
+import java.util.Set;
+
+import org.apache.jackrabbit.oak.commons.PathUtils;
+import org.apache.jackrabbit.oak.spi.state.DefaultNodeStateDiff;
+import org.apache.jackrabbit.oak.spi.state.NodeState;
+
+import static org.apache.jackrabbit.oak.plugins.memory.EmptyNodeState.EMPTY_NODE;
+import static org.apache.jackrabbit.oak.plugins.memory.EmptyNodeState.MISSING_NODE;
+
+class TrackingDiff extends DefaultNodeStateDiff {
+
+    final String path;
+    final Set<String> added;
+    final Set<String> deleted;
+    final Set<String> modified;
+
+    TrackingDiff() {
+        this("/", new HashSet<String>(), new HashSet<String>(), new HashSet<String>());
+    }
+
+    private TrackingDiff(String path,
+                         Set<String> added,
+                         Set<String> deleted,
+                         Set<String> modified) {
+        this.path = path;
+        this.added = added;
+        this.deleted = deleted;
+        this.modified = modified;
+    }
+
+    @Override
+    public boolean childNodeAdded(String name, NodeState after) {
+        String p = PathUtils.concat(path, name);
+        added.add(p);
+        return after.compareAgainstBaseState(EMPTY_NODE, new TrackingDiff(p, added, deleted, modified));
+    }
+
+    @Override
+    public boolean childNodeChanged(String name,
+                                    NodeState before,
+                                    NodeState after) {
+        String p = PathUtils.concat(path, name);
+        modified.add(p);
+        return after.compareAgainstBaseState(before, new TrackingDiff(p, added, deleted, modified));
+    }
+
+    @Override
+    public boolean childNodeDeleted(String name, NodeState before) {
+        String p = PathUtils.concat(path, name);
+        deleted.add(p);
+        return MISSING_NODE.compareAgainstBaseState(before, new TrackingDiff(p, added, deleted, modified));
+    }
+}
