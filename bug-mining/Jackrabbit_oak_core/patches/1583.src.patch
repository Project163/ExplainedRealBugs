diff --git a/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/AndImpl.java b/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/AndImpl.java
index 9d7ffa004f..8486fd6816 100644
--- a/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/AndImpl.java
+++ b/oak-core/src/main/java/org/apache/jackrabbit/oak/query/ast/AndImpl.java
@@ -254,11 +254,12 @@ public class AndImpl extends ConstraintImpl {
         if (getLastConstraint() instanceof OrImpl) {
             return this;
         }
-        for (int i = 0; i < constraints.size() - 1; i++) {
-            ConstraintImpl c = constraints.get(i);
+        ArrayList<ConstraintImpl> andList = getAllAndConditions();
+        for (int i = 0; i < andList.size() - 1; i++) {
+            ConstraintImpl c = andList.get(i);
             if (c instanceof OrImpl) {
                 ArrayList<ConstraintImpl> list = new ArrayList<ConstraintImpl>();
-                list.addAll(constraints);
+                list.addAll(andList);
                 list.remove(i);
                 list.add(c);
                 return new AndImpl(list);
@@ -266,6 +267,18 @@ public class AndImpl extends ConstraintImpl {
         }
         return this;
     }
+    
+    private ArrayList<ConstraintImpl> getAllAndConditions() {
+        ArrayList<ConstraintImpl> list = new ArrayList<ConstraintImpl>();
+        for(ConstraintImpl c : constraints) {
+            if (c instanceof AndImpl) {
+                list.addAll(((AndImpl) c).getAllAndConditions());
+            } else {
+                list.add(c);
+            }
+        }
+        return list;
+    }    
 
     @Override
     public Set<ConstraintImpl> convertToUnion() {
diff --git a/oak-core/src/test/java/org/apache/jackrabbit/oak/query/SQL2OptimiseQueryTest.java b/oak-core/src/test/java/org/apache/jackrabbit/oak/query/SQL2OptimiseQueryTest.java
index bb5d8044d6..ea023e51be 100644
--- a/oak-core/src/test/java/org/apache/jackrabbit/oak/query/SQL2OptimiseQueryTest.java
+++ b/oak-core/src/test/java/org/apache/jackrabbit/oak/query/SQL2OptimiseQueryTest.java
@@ -234,6 +234,14 @@ public class SQL2OptimiseQueryTest extends  AbstractQueryTest {
      */
     @Test
     public void optimiseAndOrAnd() throws ParseException {
+        optimiseAndOrAnd(
+                "select * from [nt:unstructured] as [c] " + 
+                "where isdescendantnode('/tmp') " + 
+                "and ([a]=1 or [b]=2) and ([c]=3 or [d]=4)",
+                "(isdescendantnode(c, /tmp)) and (d = 4) and (b = 2), " + 
+                "(isdescendantnode(c, /tmp)) and (d = 4) and (a = 1), " + 
+                "(isdescendantnode(c, /tmp)) and (c = 3) and (b = 2), " + 
+                "(isdescendantnode(c, /tmp)) and (c = 3) and (a = 1)");
         optimiseAndOrAnd(
                 "select * from [nt:unstructured] as [c] " + 
                 "where ([a]=1 or [b]=2) and ([x]=3 or [y]=4)",
