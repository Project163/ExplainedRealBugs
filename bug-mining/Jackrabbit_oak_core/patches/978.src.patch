diff --git a/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/Compactor.java b/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/Compactor.java
index a232b82758..c7a534f4fc 100644
--- a/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/Compactor.java
+++ b/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/Compactor.java
@@ -120,14 +120,16 @@ public class Compactor {
                 }
             }
 
-            NodeBuilder child = builder.setChildNode(name);
-            boolean success = EmptyNodeState.compareAgainstEmptyState(
-                    after, new CompactDiff(child));
-
-            if (success && id != null && child.getChildNodeCount(2) > 1) {
-                RecordId compactedId =
-                        writer.writeNode(child.getNodeState()).getRecordId();
-                map.put(id, compactedId);
+            NodeBuilder child = EmptyNodeState.EMPTY_NODE.builder();
+            boolean success = EmptyNodeState.compareAgainstEmptyState(after,
+                    new CompactDiff(child));
+
+            if (success) {
+                SegmentNodeState state = writer.writeNode(child.getNodeState());
+                builder.setChildNode(name, state);
+                if (id != null && state.getChildNodeCount(2) > 1) {
+                    map.put(id, state.getRecordId());
+                }
             }
 
             return success;
@@ -207,7 +209,8 @@ public class Compactor {
                 List<RecordId> ids = binaries.get(key);
                 if (ids != null) {
                     for (RecordId duplicateId : ids) {
-                        if (new SegmentBlob(duplicateId).equals(blob)) {
+                        if (new SegmentBlob(duplicateId).equals(sb)) {
+                            map.put(id, duplicateId);
                             return new SegmentBlob(duplicateId);
                         }
                     }
@@ -224,7 +227,7 @@ public class Compactor {
 
                 return sb;
             } catch (IOException e) {
-                log.warn("Failed to compcat a blob", e);
+                log.warn("Failed to compact a blob", e);
                 // fall through
             }
         }
diff --git a/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/file/FileStore.java b/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/file/FileStore.java
index 14213f3146..a1ab6e4980 100644
--- a/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/file/FileStore.java
+++ b/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/file/FileStore.java
@@ -355,15 +355,15 @@ public class FileStore implements SegmentStore {
                         cleanup();
                     }
                 }
-
-                // remove all obsolete tar generations
-                Iterator<File> iterator = toBeRemoved.iterator();
-                while (iterator.hasNext()) {
-                    File file = iterator.next();
-                    if (!file.exists() || file.delete()) {
-                        log.debug("TarMK GC: Removed old file {}", file);
-                        iterator.remove();
-                    }
+            }
+            // remove all obsolete tar generations
+            Iterator<File> iterator = toBeRemoved.iterator();
+            while (iterator.hasNext()) {
+                File file = iterator.next();
+                log.debug("TarMK GC: Attempting to remove old file {}", file);
+                if (!file.exists() || file.delete()) {
+                    log.debug("TarMK GC: Removed old file {}", file);
+                    iterator.remove();
                 }
             }
         }
