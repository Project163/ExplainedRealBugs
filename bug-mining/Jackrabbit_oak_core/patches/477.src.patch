diff --git a/oak-core/src/main/java/org/apache/jackrabbit/oak/core/AbstractRoot.java b/oak-core/src/main/java/org/apache/jackrabbit/oak/core/AbstractRoot.java
index 97f87a946f..ae6a2ca7bb 100644
--- a/oak-core/src/main/java/org/apache/jackrabbit/oak/core/AbstractRoot.java
+++ b/oak-core/src/main/java/org/apache/jackrabbit/oak/core/AbstractRoot.java
@@ -47,7 +47,6 @@ import org.apache.jackrabbit.oak.spi.commit.CompositeEditorProvider;
 import org.apache.jackrabbit.oak.spi.commit.CompositeHook;
 import org.apache.jackrabbit.oak.spi.commit.EditorHook;
 import org.apache.jackrabbit.oak.spi.commit.EmptyHook;
-import org.apache.jackrabbit.oak.spi.commit.PostCommitHook;
 import org.apache.jackrabbit.oak.spi.commit.PostValidationHook;
 import org.apache.jackrabbit.oak.spi.commit.ValidatorProvider;
 import org.apache.jackrabbit.oak.spi.query.QueryIndexProvider;
@@ -70,8 +69,6 @@ public abstract class AbstractRoot implements Root {
 
     private final CommitHook hook;
 
-    private final PostCommitHook postHook;
-
     private final String workspaceName;
 
     private final Subject subject;
@@ -129,14 +126,12 @@ public abstract class AbstractRoot implements Root {
      */
     protected AbstractRoot(NodeStore store,
             CommitHook hook,
-            PostCommitHook postHook,
             String workspaceName,
             Subject subject,
             SecurityProvider securityProvider,
             QueryIndexProvider indexProvider) {
         this.store = checkNotNull(store);
         this.hook = checkNotNull(hook);
-        this.postHook = postHook;
         this.workspaceName = checkNotNull(workspaceName);
         this.subject = checkNotNull(subject);
         this.securityProvider = checkNotNull(securityProvider);
@@ -245,7 +240,7 @@ public abstract class AbstractRoot implements Root {
     @Override
     public void commit(final CommitHook... hooks) throws CommitFailedException {
         checkLive();
-        base = store.merge(builder, getCommitHook(hooks), postHook);
+        base = store.merge(builder, getCommitHook(hooks));
         secureBuilder.baseChanged();
         modCount = 0;
         if (permissionProvider.hasValue()) {
diff --git a/oak-core/src/main/java/org/apache/jackrabbit/oak/core/AbstractTree.java b/oak-core/src/main/java/org/apache/jackrabbit/oak/core/AbstractTree.java
index 8a91c63552..2a7e30321a 100644
--- a/oak-core/src/main/java/org/apache/jackrabbit/oak/core/AbstractTree.java
+++ b/oak-core/src/main/java/org/apache/jackrabbit/oak/core/AbstractTree.java
@@ -19,7 +19,18 @@
 
 package org.apache.jackrabbit.oak.core;
 
+import static com.google.common.base.Preconditions.checkNotNull;
+import static com.google.common.collect.Iterables.filter;
+import static com.google.common.collect.Iterables.size;
+import static com.google.common.collect.Iterables.transform;
+import static org.apache.jackrabbit.oak.api.Tree.Status.EXISTING;
+import static org.apache.jackrabbit.oak.api.Tree.Status.MODIFIED;
+import static org.apache.jackrabbit.oak.api.Tree.Status.NEW;
+import static org.apache.jackrabbit.oak.api.Type.STRING;
+import static org.apache.jackrabbit.oak.spi.state.NodeStateUtils.isHidden;
+
 import java.util.Iterator;
+
 import javax.annotation.Nonnull;
 
 import com.google.common.base.Function;
@@ -28,19 +39,10 @@ import org.apache.jackrabbit.mk.api.MicroKernel;
 import org.apache.jackrabbit.oak.api.PropertyState;
 import org.apache.jackrabbit.oak.api.Tree;
 import org.apache.jackrabbit.oak.plugins.index.IndexConstants;
+import org.apache.jackrabbit.oak.plugins.observation.CommitInfoEditorProvider;
 import org.apache.jackrabbit.oak.spi.state.NodeBuilder;
 import org.apache.jackrabbit.oak.spi.state.NodeState;
 
-import static com.google.common.base.Preconditions.checkNotNull;
-import static com.google.common.collect.Iterables.filter;
-import static com.google.common.collect.Iterables.size;
-import static com.google.common.collect.Iterables.transform;
-import static org.apache.jackrabbit.oak.api.Tree.Status.EXISTING;
-import static org.apache.jackrabbit.oak.api.Tree.Status.MODIFIED;
-import static org.apache.jackrabbit.oak.api.Tree.Status.NEW;
-import static org.apache.jackrabbit.oak.api.Type.STRING;
-import static org.apache.jackrabbit.oak.spi.state.NodeStateUtils.isHidden;
-
 /**
  * {@code AbstractTree} provides default implementations for most
  * read methods of {@code Tree}. Furthermore it handles the
@@ -55,7 +57,9 @@ public abstract class AbstractTree implements Tree {
     public static final String OAK_CHILD_ORDER = ":childOrder";
 
     // TODO: make this configurable
-    private static final String[] INTERNAL_NODE_NAMES = {IndexConstants.INDEX_CONTENT_NODE_NAME, MicroKernel.CONFLICT_NAME};
+    private static final String[] INTERNAL_NODE_NAMES = {
+            IndexConstants.INDEX_CONTENT_NODE_NAME,
+            MicroKernel.CONFLICT_NAME, CommitInfoEditorProvider.COMMIT_INFO};
 
     /**
      * Name of this tree
diff --git a/oak-core/src/main/java/org/apache/jackrabbit/oak/core/ContentRepositoryImpl.java b/oak-core/src/main/java/org/apache/jackrabbit/oak/core/ContentRepositoryImpl.java
index 7805f8f2d7..57e8cf0be0 100644
--- a/oak-core/src/main/java/org/apache/jackrabbit/oak/core/ContentRepositoryImpl.java
+++ b/oak-core/src/main/java/org/apache/jackrabbit/oak/core/ContentRepositoryImpl.java
@@ -26,7 +26,6 @@ import javax.security.auth.login.LoginException;
 
 import org.apache.jackrabbit.oak.api.ContentRepository;
 import org.apache.jackrabbit.oak.api.ContentSession;
-import org.apache.jackrabbit.oak.plugins.observation.ChangeDispatcher;
 import org.apache.jackrabbit.oak.spi.commit.CommitHook;
 import org.apache.jackrabbit.oak.spi.query.CompositeQueryIndexProvider;
 import org.apache.jackrabbit.oak.spi.query.QueryIndexProvider;
@@ -47,7 +46,6 @@ public class ContentRepositoryImpl implements ContentRepository {
     private final String defaultWorkspaceName;
     private final SecurityProvider securityProvider;
     private final QueryIndexProvider indexProvider;
-    private final ChangeDispatcher changeDispatcher;
 
     /**
      * Creates an content repository instance based on the given, already
@@ -69,7 +67,6 @@ public class ContentRepositoryImpl implements ContentRepository {
         this.defaultWorkspaceName = checkNotNull(defaultWorkspaceName);
         this.securityProvider = checkNotNull(securityProvider);
         this.indexProvider = indexProvider != null ? indexProvider : new CompositeQueryIndexProvider();
-        this.changeDispatcher = new ChangeDispatcher(nodeStore);
     }
 
     @Nonnull
@@ -89,8 +86,8 @@ public class ContentRepositoryImpl implements ContentRepository {
         LoginContext loginContext = lcProvider.getLoginContext(credentials, workspaceName);
         loginContext.login();
 
-        return new ContentSessionImpl(loginContext, securityProvider, workspaceName,
-                nodeStore, commitHook, changeDispatcher, indexProvider);
+        return new ContentSessionImpl(loginContext, securityProvider, workspaceName, nodeStore,
+                commitHook, indexProvider);
     }
 
     public NodeStore getNodeStore() {
diff --git a/oak-core/src/main/java/org/apache/jackrabbit/oak/core/ContentSessionImpl.java b/oak-core/src/main/java/org/apache/jackrabbit/oak/core/ContentSessionImpl.java
index c84398d52a..96db894ee4 100644
--- a/oak-core/src/main/java/org/apache/jackrabbit/oak/core/ContentSessionImpl.java
+++ b/oak-core/src/main/java/org/apache/jackrabbit/oak/core/ContentSessionImpl.java
@@ -16,6 +16,7 @@
  */
 package org.apache.jackrabbit.oak.core;
 
+import static com.google.common.base.Preconditions.checkArgument;
 import static com.google.common.base.Preconditions.checkState;
 
 import java.io.IOException;
@@ -28,10 +29,12 @@ import javax.security.auth.login.LoginException;
 import org.apache.jackrabbit.oak.api.AuthInfo;
 import org.apache.jackrabbit.oak.api.ContentSession;
 import org.apache.jackrabbit.oak.api.Root;
-import org.apache.jackrabbit.oak.plugins.observation.ChangeDispatcher;
 import org.apache.jackrabbit.oak.plugins.observation.ChangeDispatcher.Listener;
+import org.apache.jackrabbit.oak.plugins.observation.CommitInfoEditorProvider;
 import org.apache.jackrabbit.oak.plugins.observation.Observable;
 import org.apache.jackrabbit.oak.spi.commit.CommitHook;
+import org.apache.jackrabbit.oak.spi.commit.CompositeHook;
+import org.apache.jackrabbit.oak.spi.commit.EditorHook;
 import org.apache.jackrabbit.oak.spi.query.QueryIndexProvider;
 import org.apache.jackrabbit.oak.spi.security.SecurityProvider;
 import org.apache.jackrabbit.oak.spi.security.authentication.LoginContext;
@@ -56,7 +59,6 @@ class ContentSessionImpl implements ContentSession, Observable {
     private final String workspaceName;
     private final NodeStore store;
     private final CommitHook hook;
-    private final ChangeDispatcher changeDispatcher;
     private final QueryIndexProvider indexProvider;
     private final String sessionName;
 
@@ -67,14 +69,13 @@ class ContentSessionImpl implements ContentSession, Observable {
                               @Nonnull String workspaceName,
                               @Nonnull NodeStore store,
                               @Nonnull CommitHook hook,
-                              @Nonnull ChangeDispatcher changeDispatcher,
                               @Nonnull QueryIndexProvider indexProvider) {
+        checkArgument(store instanceof Observable);
         this.loginContext = loginContext;
         this.securityProvider = securityProvider;
         this.workspaceName = workspaceName;
         this.store = store;
         this.hook = hook;
-        this.changeDispatcher = changeDispatcher;
         this.indexProvider = indexProvider;
         this.sessionName = "session-" + SESSION_COUNTER.incrementAndGet();
     }
@@ -105,8 +106,12 @@ class ContentSessionImpl implements ContentSession, Observable {
     @Override
     public Root getLatestRoot() {
         checkLive();
-        return new AbstractRoot(store, hook, changeDispatcher.newHook(ContentSessionImpl.this), workspaceName,
-                loginContext.getSubject(), securityProvider, indexProvider) {
+
+        EditorHook commitInfoEditor = new EditorHook(
+                new CommitInfoEditorProvider(sessionName, getAuthInfo().getUserID()));
+
+        return new AbstractRoot(store, new CompositeHook(hook, commitInfoEditor),
+                workspaceName, loginContext.getSubject(), securityProvider, indexProvider) {
             @Override
             protected void checkLive() {
                 ContentSessionImpl.this.checkLive();
@@ -121,7 +126,7 @@ class ContentSessionImpl implements ContentSession, Observable {
 
     @Override
     public Listener newListener() {
-        return changeDispatcher.newListener();
+        return ((Observable) store).newListener();
     }
 
     //-----------------------------------------------------------< Closable >---
@@ -139,4 +144,5 @@ class ContentSessionImpl implements ContentSession, Observable {
     public String toString() {
         return sessionName;
     }
+
 }
diff --git a/oak-core/src/main/java/org/apache/jackrabbit/oak/core/SystemRoot.java b/oak-core/src/main/java/org/apache/jackrabbit/oak/core/SystemRoot.java
index 0792ab6174..08d0a15b3f 100644
--- a/oak-core/src/main/java/org/apache/jackrabbit/oak/core/SystemRoot.java
+++ b/oak-core/src/main/java/org/apache/jackrabbit/oak/core/SystemRoot.java
@@ -23,7 +23,6 @@ import org.apache.jackrabbit.oak.api.Root;
 import org.apache.jackrabbit.oak.security.authentication.SystemSubject;
 import org.apache.jackrabbit.oak.spi.commit.CommitHook;
 import org.apache.jackrabbit.oak.spi.commit.EmptyHook;
-import org.apache.jackrabbit.oak.spi.commit.PostCommitHook;
 import org.apache.jackrabbit.oak.spi.query.CompositeQueryIndexProvider;
 import org.apache.jackrabbit.oak.spi.query.QueryIndexProvider;
 import org.apache.jackrabbit.oak.spi.security.OpenSecurityProvider;
@@ -41,8 +40,7 @@ public class SystemRoot extends AbstractRoot {
     public SystemRoot(final NodeStore store, final CommitHook hook, final String workspaceName,
             final SecurityProvider securityProvider, final QueryIndexProvider indexProvider) {
 
-        super(store, hook, PostCommitHook.EMPTY, workspaceName,
-                SystemSubject.INSTANCE, securityProvider, indexProvider);
+        super(store, hook, workspaceName, SystemSubject.INSTANCE, securityProvider, indexProvider);
 
         contentSession = new ContentSession() {
             private final AuthInfoImpl authInfo = new AuthInfoImpl(
diff --git a/oak-core/src/main/java/org/apache/jackrabbit/oak/kernel/KernelNodeStore.java b/oak-core/src/main/java/org/apache/jackrabbit/oak/kernel/KernelNodeStore.java
index 1b0fe64085..f183f2cc2f 100644
--- a/oak-core/src/main/java/org/apache/jackrabbit/oak/kernel/KernelNodeStore.java
+++ b/oak-core/src/main/java/org/apache/jackrabbit/oak/kernel/KernelNodeStore.java
@@ -38,10 +38,12 @@ import org.apache.jackrabbit.mk.api.MicroKernelException;
 import org.apache.jackrabbit.oak.api.CommitFailedException;
 import org.apache.jackrabbit.oak.cache.CacheLIRS;
 import org.apache.jackrabbit.oak.cache.CacheStats;
+import org.apache.jackrabbit.oak.plugins.observation.ChangeDispatcher;
+import org.apache.jackrabbit.oak.plugins.observation.ChangeDispatcher.Listener;
+import org.apache.jackrabbit.oak.plugins.observation.Observable;
 import org.apache.jackrabbit.oak.spi.commit.CommitHook;
 import org.apache.jackrabbit.oak.spi.commit.EmptyObserver;
 import org.apache.jackrabbit.oak.spi.commit.Observer;
-import org.apache.jackrabbit.oak.spi.commit.PostCommitHook;
 import org.apache.jackrabbit.oak.spi.state.NodeBuilder;
 import org.apache.jackrabbit.oak.spi.state.NodeState;
 import org.apache.jackrabbit.oak.spi.state.NodeStore;
@@ -50,7 +52,7 @@ import org.apache.jackrabbit.oak.spi.state.NodeStoreBranch;
 /**
  * {@code NodeStore} implementations against {@link MicroKernel}.
  */
-public class KernelNodeStore implements NodeStore {
+public class KernelNodeStore implements NodeStore, Observable {
 
     private static final long DEFAULT_CACHE_SIZE = 16 * 1024 * 1024;
 
@@ -74,6 +76,8 @@ public class KernelNodeStore implements NodeStore {
      */
     private final Lock mergeLock = new ReentrantLock();
 
+    private final ChangeDispatcher changeDispatcher;
+
     /**
      * State of the current root node.
      */
@@ -120,6 +124,7 @@ public class KernelNodeStore implements NodeStore {
         } catch (Exception e) {
             throw new RuntimeException(e);
         }
+        changeDispatcher = new ChangeDispatcher(this);
     }
 
     public KernelNodeStore(MicroKernel kernel) {
@@ -143,6 +148,13 @@ public class KernelNodeStore implements NodeStore {
         return getRoot().toString();
     }
 
+    //------------------------------------------------------------< Observable >---
+
+    @Override
+    public Listener newListener() {
+        return changeDispatcher.newListener();
+    }
+
     //----------------------------------------------------------< NodeStore >---
 
     @Override
@@ -157,15 +169,15 @@ public class KernelNodeStore implements NodeStore {
     }
 
     /**
-     * This implementation delegates to {@link KernelRootBuilder#merge(CommitHook, PostCommitHook)}
+     * This implementation delegates to {@link KernelRootBuilder#merge(CommitHook)}
      * if {@code builder} is a {@link KernelNodeBuilder} instance. Otherwise it throws
      * an {@code IllegalArgumentException}.
      */
     @Override
-    public NodeState merge(@Nonnull NodeBuilder builder, @Nonnull CommitHook commitHook,
-            PostCommitHook committed) throws CommitFailedException {
+    public NodeState merge(@Nonnull NodeBuilder builder, @Nonnull CommitHook commitHook)
+            throws CommitFailedException {
         checkArgument(builder instanceof KernelRootBuilder);
-        return ((KernelRootBuilder) builder).merge(commitHook, committed);
+        return ((KernelRootBuilder) builder).merge(commitHook);
     }
 
     /**
@@ -265,4 +277,16 @@ public class KernelNodeStore implements NodeStore {
         return getRootState(kernel.merge(branchHead.getRevision(), null));
     }
 
+    void beforeCommit(NodeState root) {
+        changeDispatcher.beforeCommit(root);
+    }
+
+    void localCommit(NodeState root) {
+        changeDispatcher.localCommit(root);
+    }
+
+    void afterCommit(NodeState root) {
+        changeDispatcher.afterCommit(root);
+    }
+
 }
diff --git a/oak-core/src/main/java/org/apache/jackrabbit/oak/kernel/KernelNodeStoreBranch.java b/oak-core/src/main/java/org/apache/jackrabbit/oak/kernel/KernelNodeStoreBranch.java
index 7d29d7f3ee..05fffcdd31 100644
--- a/oak-core/src/main/java/org/apache/jackrabbit/oak/kernel/KernelNodeStoreBranch.java
+++ b/oak-core/src/main/java/org/apache/jackrabbit/oak/kernel/KernelNodeStoreBranch.java
@@ -30,7 +30,6 @@ import org.apache.jackrabbit.mk.api.MicroKernelException;
 import org.apache.jackrabbit.oak.api.CommitFailedException;
 import org.apache.jackrabbit.oak.commons.PathUtils;
 import org.apache.jackrabbit.oak.spi.commit.CommitHook;
-import org.apache.jackrabbit.oak.spi.commit.PostCommitHook;
 import org.apache.jackrabbit.oak.spi.state.ConflictAnnotatingRebaseDiff;
 import org.apache.jackrabbit.oak.spi.state.NodeBuilder;
 import org.apache.jackrabbit.oak.spi.state.NodeState;
@@ -132,8 +131,8 @@ class KernelNodeStoreBranch implements NodeStoreBranch {
 
     @Nonnull
     @Override
-    public NodeState merge(@Nonnull CommitHook hook, PostCommitHook committed) throws CommitFailedException {
-        return branchState.merge(checkNotNull(hook), checkNotNull(committed));
+    public NodeState merge(@Nonnull CommitHook hook) throws CommitFailedException {
+        return branchState.merge(checkNotNull(hook));
     }
 
     @Override
@@ -181,7 +180,7 @@ class KernelNodeStoreBranch implements NodeStoreBranch {
         abstract void rebase();
 
         @Nonnull
-        abstract NodeState merge(@Nonnull CommitHook hook, PostCommitHook committed) throws CommitFailedException;
+        abstract NodeState merge(@Nonnull CommitHook hook) throws CommitFailedException;
     }
 
     /**
@@ -191,7 +190,7 @@ class KernelNodeStoreBranch implements NodeStoreBranch {
      * <ul>
      *     <li>{@link InMemory} on {@link #setRoot(NodeState)} if the new root differs
      *         from the current base</li>.
-     *     <li>{@link Merged} on {@link #merge(CommitHook, PostCommitHook)}</li>
+     *     <li>{@link Merged} on {@link #merge(CommitHook)}</li>
      * </ul>
      */
     private class Unmodified extends BranchState {
@@ -222,7 +221,7 @@ class KernelNodeStoreBranch implements NodeStoreBranch {
         }
 
         @Override
-        NodeState merge(CommitHook hook, PostCommitHook committed) throws CommitFailedException {
+        NodeState merge(CommitHook hook) throws CommitFailedException {
             branchState = new Merged(base);
             return base;
         }
@@ -237,7 +236,7 @@ class KernelNodeStoreBranch implements NodeStoreBranch {
      *     <li>{@link Unmodified} on {@link #setRoot(NodeState)} if the new root is the same
      *         as the base of this branch or
      *     <li>{@link Persisted} otherwise.
-     *     <li>{@link Merged} on {@link #merge(CommitHook, PostCommitHook)}</li>
+     *     <li>{@link Merged} on {@link #merge(CommitHook)}</li>
      * </ul>
      */
     private class InMemory extends BranchState {
@@ -279,15 +278,16 @@ class KernelNodeStoreBranch implements NodeStoreBranch {
         }
 
         @Override
-        NodeState merge(CommitHook hook, PostCommitHook committed) throws CommitFailedException {
+        NodeState merge(CommitHook hook) throws CommitFailedException {
             mergeLock.lock();
             try {
                 rebase();
+                store.beforeCommit(base);
                 NodeState toCommit = checkNotNull(hook).processCommit(base, head);
                 JsopDiff diff = new JsopDiff(store);
                 toCommit.compareAgainstBaseState(base, diff);
                 NodeState newHead = store.commit(diff.toString(), base);
-                committed.contentChanged(base, newHead);
+                store.localCommit(newHead);
                 branchState = new Merged(base);
                 return newHead;
             } catch (MicroKernelException e) {
@@ -295,6 +295,7 @@ class KernelNodeStoreBranch implements NodeStoreBranch {
                         "Kernel", 1,
                         "Failed to merge changes to the underlying MicroKernel", e);
             } finally {
+                store.afterCommit(store.getRoot());
                 mergeLock.unlock();
             }
         }
@@ -308,7 +309,7 @@ class KernelNodeStoreBranch implements NodeStoreBranch {
      * <ul>
      *     <li>{@link Unmodified} on {@link #setRoot(NodeState)} if the new root is the same
      *         as the base of this branch.
-     *     <li>{@link Merged} on {@link #merge(CommitHook, PostCommitHook)}</li>
+     *     <li>{@link Merged} on {@link #merge(CommitHook)}</li>
      * </ul>
      */
     private class Persisted extends BranchState {
@@ -361,13 +362,13 @@ class KernelNodeStoreBranch implements NodeStoreBranch {
         }
 
         @Override
-        NodeState merge(CommitHook hook, PostCommitHook committed) throws CommitFailedException {
+        NodeState merge(CommitHook hook) throws CommitFailedException {
             mergeLock.lock();
             try {
                 rebase();
+                store.beforeCommit(base);
                 NodeState toCommit = checkNotNull(hook).processCommit(base, head);
                 if (toCommit.equals(base)) {
-                    committed.contentChanged(base, base);
                     branchState = new Merged(base);
                     return base;
                 } else {
@@ -375,7 +376,7 @@ class KernelNodeStoreBranch implements NodeStoreBranch {
                     toCommit.compareAgainstBaseState(head, diff);
                     commit(diff.toString());
                     NodeState newRoot = store.merge(head);
-                    committed.contentChanged(base, newRoot);
+                    store.localCommit(newRoot);
                     branchState = new Merged(base);
                     return newRoot;
                 }
@@ -384,6 +385,7 @@ class KernelNodeStoreBranch implements NodeStoreBranch {
                         "Kernel", 1,
                         "Failed to merge changes to the underlying MicroKernel", e);
             } finally {
+                store.afterCommit(store.getRoot());
                 mergeLock.unlock();
             }
         }
@@ -429,7 +431,7 @@ class KernelNodeStoreBranch implements NodeStoreBranch {
         }
 
         @Override
-        NodeState merge(CommitHook hook, PostCommitHook committed) throws CommitFailedException {
+        NodeState merge(CommitHook hook) throws CommitFailedException {
             throw new IllegalStateException("Branch has already been merged");
         }
     }
diff --git a/oak-core/src/main/java/org/apache/jackrabbit/oak/kernel/KernelRootBuilder.java b/oak-core/src/main/java/org/apache/jackrabbit/oak/kernel/KernelRootBuilder.java
index 7a9e3431c5..91a536bc6d 100644
--- a/oak-core/src/main/java/org/apache/jackrabbit/oak/kernel/KernelRootBuilder.java
+++ b/oak-core/src/main/java/org/apache/jackrabbit/oak/kernel/KernelRootBuilder.java
@@ -21,7 +21,6 @@ import static com.google.common.base.Preconditions.checkNotNull;
 import org.apache.jackrabbit.oak.api.CommitFailedException;
 import org.apache.jackrabbit.oak.plugins.memory.MemoryNodeBuilder;
 import org.apache.jackrabbit.oak.spi.commit.CommitHook;
-import org.apache.jackrabbit.oak.spi.commit.PostCommitHook;
 import org.apache.jackrabbit.oak.spi.state.NodeState;
 import org.apache.jackrabbit.oak.spi.state.NodeStoreBranch;
 
@@ -132,9 +131,9 @@ class KernelRootBuilder extends MemoryNodeBuilder implements FastCopyMove {
     /**
      * Merge all changes tracked in this builder into the underlying store.
      */
-    NodeState merge(CommitHook hook, PostCommitHook committed) throws CommitFailedException {
+    NodeState merge(CommitHook hook) throws CommitFailedException {
         purge();
-        branch.merge(hook, committed);
+        branch.merge(hook);
         return reset();
     }
 
diff --git a/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/index/AsyncIndexUpdate.java b/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/index/AsyncIndexUpdate.java
index 4d756a47d8..085a354abf 100644
--- a/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/index/AsyncIndexUpdate.java
+++ b/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/index/AsyncIndexUpdate.java
@@ -26,21 +26,19 @@ import java.util.concurrent.TimeUnit;
 
 import javax.annotation.Nonnull;
 
+import com.google.common.base.Objects;
 import org.apache.jackrabbit.oak.api.CommitFailedException;
 import org.apache.jackrabbit.oak.api.PropertyState;
 import org.apache.jackrabbit.oak.api.Type;
 import org.apache.jackrabbit.oak.spi.commit.CommitHook;
 import org.apache.jackrabbit.oak.spi.commit.EditorDiff;
 import org.apache.jackrabbit.oak.spi.commit.EmptyHook;
-import org.apache.jackrabbit.oak.spi.commit.PostCommitHook;
 import org.apache.jackrabbit.oak.spi.state.NodeBuilder;
 import org.apache.jackrabbit.oak.spi.state.NodeState;
 import org.apache.jackrabbit.oak.spi.state.NodeStore;
 import org.slf4j.Logger;
 import org.slf4j.LoggerFactory;
 
-import com.google.common.base.Objects;
-
 public class AsyncIndexUpdate implements Runnable {
 
     private static final Logger log = LoggerFactory
@@ -119,7 +117,7 @@ public class AsyncIndexUpdate implements Runnable {
                             throw CONCURRENT_UPDATE;
                         }
                     }
-                }, PostCommitHook.EMPTY);
+                });
             } catch (CommitFailedException e) {
                 if (e != CONCURRENT_UPDATE) {
                     exception = e;
@@ -144,7 +142,7 @@ public class AsyncIndexUpdate implements Runnable {
         NodeBuilder builder = store.getRoot().builder();
         preAsyncRunStatus(builder);
         try {
-            store.merge(builder, EmptyHook.INSTANCE, PostCommitHook.EMPTY);
+            store.merge(builder, EmptyHook.INSTANCE);
         } catch (CommitFailedException e) {
             log.warn("Index status update {} failed", name, e);
         }
diff --git a/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/memory/MemoryNodeStore.java b/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/memory/MemoryNodeStore.java
index f74d842f64..03cdf663fa 100644
--- a/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/memory/MemoryNodeStore.java
+++ b/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/memory/MemoryNodeStore.java
@@ -33,7 +33,6 @@ import javax.annotation.Nonnull;
 import com.google.common.io.ByteStreams;
 import org.apache.jackrabbit.oak.api.CommitFailedException;
 import org.apache.jackrabbit.oak.spi.commit.CommitHook;
-import org.apache.jackrabbit.oak.spi.commit.PostCommitHook;
 import org.apache.jackrabbit.oak.spi.state.ConflictAnnotatingRebaseDiff;
 import org.apache.jackrabbit.oak.spi.state.NodeBuilder;
 import org.apache.jackrabbit.oak.spi.state.NodeState;
@@ -75,21 +74,20 @@ public class MemoryNodeStore implements NodeStore {
      * new branch and immediately merging it back.
      * @param builder  the builder whose changes to apply
      * @param commitHook the commit hook to apply while merging changes
-     * @param committed  the pos commit hook
      * @return the node state resulting from the merge.
      * @throws CommitFailedException
      * @throws IllegalArgumentException if the builder is not acquired from a root state of
      *                                  this store
      */
     @Override
-    public synchronized NodeState merge(@Nonnull NodeBuilder builder, @Nonnull CommitHook commitHook,
-            PostCommitHook committed) throws CommitFailedException {
+    public synchronized NodeState merge(@Nonnull NodeBuilder builder, @Nonnull CommitHook commitHook)
+            throws CommitFailedException {
         checkArgument(builder instanceof MemoryNodeBuilder);
         checkNotNull(commitHook);
         rebase(checkNotNull(builder));
         NodeStoreBranch branch = new MemoryNodeStoreBranch(this, getRoot());
         branch.setRoot(builder.getNodeState());
-        NodeState merged = branch.merge(commitHook, committed);
+        NodeState merged = branch.merge(commitHook);
         ((MemoryNodeBuilder) builder).reset(merged);
         return merged;
     }
@@ -198,16 +196,12 @@ public class MemoryNodeStore implements NodeStore {
         }
 
         @Override
-        public NodeState merge(CommitHook hook, PostCommitHook committed) throws CommitFailedException {
+        public NodeState merge(CommitHook hook) throws CommitFailedException {
             // TODO: rebase();
             checkNotMerged();
             NodeState merged = ModifiedNodeState.squeeze(checkNotNull(hook).processCommit(base, root));
-            synchronized (this) {
-                // FIXME temporarily synchronized to work around the race described in OAK-1055
-                store.root.set(merged);
-                root = null; // Mark as merged
-                committed.contentChanged(base, merged);
-            }
+            store.root.set(merged);
+            root = null; // Mark as merged
             return merged;
         }
 
diff --git a/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/mongomk/MongoNodeStore.java b/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/mongomk/MongoNodeStore.java
index 326ddd7f7c..b92279087e 100644
--- a/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/mongomk/MongoNodeStore.java
+++ b/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/mongomk/MongoNodeStore.java
@@ -16,6 +16,9 @@
  */
 package org.apache.jackrabbit.oak.plugins.mongomk;
 
+import static com.google.common.base.Preconditions.checkNotNull;
+import static com.google.common.base.Preconditions.checkState;
+
 import java.io.IOException;
 import java.io.InputStream;
 import java.lang.ref.WeakReference;
@@ -37,6 +40,10 @@ import java.util.concurrent.atomic.AtomicInteger;
 import javax.annotation.CheckForNull;
 import javax.annotation.Nonnull;
 
+import com.google.common.base.Function;
+import com.google.common.cache.Cache;
+import com.google.common.collect.Iterables;
+import com.google.common.collect.Maps;
 import org.apache.jackrabbit.mk.api.MicroKernelException;
 import org.apache.jackrabbit.oak.api.Blob;
 import org.apache.jackrabbit.oak.api.CommitFailedException;
@@ -46,21 +53,12 @@ import org.apache.jackrabbit.oak.plugins.mongomk.util.LoggingDocumentStoreWrappe
 import org.apache.jackrabbit.oak.plugins.mongomk.util.TimingDocumentStoreWrapper;
 import org.apache.jackrabbit.oak.plugins.mongomk.util.Utils;
 import org.apache.jackrabbit.oak.spi.commit.CommitHook;
-import org.apache.jackrabbit.oak.spi.commit.PostCommitHook;
 import org.apache.jackrabbit.oak.spi.state.NodeBuilder;
 import org.apache.jackrabbit.oak.spi.state.NodeState;
 import org.apache.jackrabbit.oak.spi.state.NodeStore;
 import org.slf4j.Logger;
 import org.slf4j.LoggerFactory;
 
-import com.google.common.base.Function;
-import com.google.common.cache.Cache;
-import com.google.common.collect.Iterables;
-import com.google.common.collect.Maps;
-
-import static com.google.common.base.Preconditions.checkNotNull;
-import static com.google.common.base.Preconditions.checkState;
-
 /**
  * Implementation of a NodeStore on MongoDB.
  */
@@ -664,8 +662,7 @@ public final class MongoNodeStore implements NodeStore, RevisionContext {
     @Nonnull
     @Override
     public NodeState merge(@Nonnull NodeBuilder builder,
-                           @Nonnull CommitHook commitHook,
-                           PostCommitHook committed)
+                           @Nonnull CommitHook commitHook)
             throws CommitFailedException {
         // TODO: implement
         return null;
diff --git a/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/observation/ChangeDispatcher.java b/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/observation/ChangeDispatcher.java
index a8dcec6e34..fdadca7809 100644
--- a/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/observation/ChangeDispatcher.java
+++ b/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/observation/ChangeDispatcher.java
@@ -20,18 +20,21 @@ package org.apache.jackrabbit.oak.plugins.observation;
 
 import static com.google.common.base.Objects.toStringHelper;
 import static com.google.common.base.Preconditions.checkNotNull;
-import static org.apache.jackrabbit.oak.plugins.observation.ObservationConstants.OAK_UNKNOWN;
+import static com.google.common.base.Preconditions.checkState;
+import static org.apache.jackrabbit.oak.api.Type.LONG;
+import static org.apache.jackrabbit.oak.api.Type.STRING;
 
 import java.util.Queue;
 import java.util.Set;
+import java.util.concurrent.atomic.AtomicLong;
 
 import javax.annotation.CheckForNull;
 import javax.annotation.Nonnull;
 
+import com.google.common.base.Objects;
 import com.google.common.collect.Queues;
 import com.google.common.collect.Sets;
-import org.apache.jackrabbit.oak.api.ContentSession;
-import org.apache.jackrabbit.oak.spi.commit.PostCommitHook;
+import org.apache.jackrabbit.oak.api.PropertyState;
 import org.apache.jackrabbit.oak.spi.state.NodeState;
 import org.apache.jackrabbit.oak.spi.state.NodeStore;
 
@@ -39,19 +42,27 @@ import org.apache.jackrabbit.oak.spi.state.NodeStore;
  * A {@code ChangeDispatcher} instance records changes to a {@link NodeStore}
  * and dispatches them to interested parties.
  * <p>
- * The {@link #newHook(ContentSession)} method registers a hook for
- * reporting changes. Actual changes are reported by calling
- * {@link Hook#contentChanged(NodeState, NodeState)}. Such changes are considered
- * to have occurred on the local cluster node and are recorded as such. Changes
- * that occurred in-between calls to any hook registered with a change processor
- * are considered to have occurred on a different cluster node and are recorded as such.
+ * Actual changes are reported by calling {@link #beforeCommit(NodeState)},
+ * {@link #localCommit(NodeState)} and {@link #afterCommit(NodeState)} in that order:
+ * <pre>
+      NodeState root = store.getRoot();
+      branch.rebase();
+      changeDispatcher.beforeCommit(root);
+      try {
+          NodeState head = branch.getHead();
+          branch.merge();
+          changeDispatcher.localCommit(head);
+      } finally {
+          changeDispatcher.afterCommit(store.getRoot());
+      }
+ * </pre>
  * <p>
- * The {@link #newListener()} registers a listener for receiving changes reported
- * into a change dispatcher by any of its hooks.
+ * The {@link #newListener()} method registers a listener for receiving changes reported
+ * into a change dispatcher.
  */
 public class ChangeDispatcher {
-    private final NodeStore store;
     private final Set<Listener> listeners = Sets.newHashSet();
+    private final NodeStore store;
 
     private NodeState previousRoot;
 
@@ -64,20 +75,6 @@ public class ChangeDispatcher {
         previousRoot = checkNotNull(store.getRoot());
     }
 
-    /**
-     * Create a new {@link Hook} for reporting changes occurring in the
-     * passed {@code contentSession}. The content session is used to
-     * determine the user associated with the changes recorded through this
-     * hook and to determine the originating session of changes.
-     * @param contentSession  session which will be associated with any changes reported
-     *                        through this hook.
-     * @return a new {@code Hook} instance
-     */
-    @Nonnull
-    public Hook newHook(ContentSession contentSession) {
-        return new Hook(contentSession);
-    }
-
     /**
      * Create a new {@link Listener} for receiving changes reported into
      * this change dispatcher. Listeners need to be {@link Listener#dispose() disposed}
@@ -91,21 +88,83 @@ public class ChangeDispatcher {
         return listener;
     }
 
-    private synchronized void contentChanged(@Nonnull NodeState before, @Nonnull NodeState after,
-            ContentSession contentSession) {
-        externalChange(checkNotNull(before));
-        internalChange(checkNotNull(after), contentSession);
+    private final AtomicLong changeCount = new AtomicLong(0);
+
+    private boolean inLocalCommit() {
+        return changeCount.get() % 2 == 1;
+    }
+
+    /**
+     * Call with the latest persisted root node state right before persisting further changes.
+     * Calling this method marks this instance to be inside a local commit.
+     * <p>
+     * The differences from the root node state passed to the last call to
+     * {@link #afterCommit(NodeState)} to {@code root} are reported as cluster external
+     * changes to any listener.
+     *
+     * @param root  latest persisted root node state.
+     * @throws IllegalStateException  if inside a local commit
+     */
+    public synchronized void beforeCommit(@Nonnull NodeState root) {
+        checkState(!inLocalCommit());
+        changeCount.incrementAndGet();
+        externalChange(checkNotNull(root));
+    }
+
+    /**
+     * Call right after changes have been successfully persisted passing the new root
+     * node state resulting from the persist operation.
+     * <p>
+     * The differences from the root node state passed to the last call to
+     * {@link #beforeCommit(NodeState)} to {@code root} are reported as cluster local
+     * changes to any listener.
+
+     * @param root  root node state just persisted
+     * @throws IllegalStateException  if not inside a local commit
+     */
+    public synchronized void localCommit(@Nonnull NodeState root) {
+        checkState(inLocalCommit());
+        internalChange(checkNotNull(root));
+    }
+
+    /**
+     * Call to mark the end of a persist operation passing the latest persisted root node state.
+     * Calling this method marks this instance to not be inside a local commit.
+     * <p>
+     * The difference from the root node state passed to the las call to
+     * {@link #localCommit(NodeState)} to {@code root} are reported as cluster external
+     * changes to any listener.
+
+     * @param root  latest persisted root node state.
+     * @throws IllegalStateException  if not inside a local commit
+     */
+    public synchronized void afterCommit(@Nonnull NodeState root) {
+        checkState(inLocalCommit());
+        externalChange(checkNotNull(root));
+        changeCount.incrementAndGet();
+    }
+
+    private void externalChange() {
+        if (!inLocalCommit()) {
+            long c = changeCount.get();
+            NodeState root = store.getRoot();  // Need to get root outside sync. See OAK-959
+            synchronized (this) {
+                if (c == changeCount.get() && !inLocalCommit()) {
+                    externalChange(root);
+                }
+            }
+        }
     }
 
     private synchronized void externalChange(NodeState root) {
         if (!root.equals(previousRoot)) {
-            add(ChangeSet.external(previousRoot, root));
+            add(new ChangeSet(previousRoot, root, true));
             previousRoot = root;
         }
     }
 
-    private synchronized void internalChange(NodeState root, ContentSession contentSession) {
-        add(ChangeSet.local(previousRoot, root, contentSession));
+    private synchronized void internalChange(NodeState root) {
+        add(new ChangeSet(previousRoot, root, false));
         previousRoot = root;
     }
 
@@ -133,28 +192,6 @@ public class ChangeDispatcher {
         }
     }
 
-    //------------------------------------------------------------< Sink >---
-
-    /**
-     * Hook for reporting changes. Actual changes are reported by calling
-     * {@link Hook#contentChanged(NodeState, NodeState)}. Such changes are considered
-     * to have occurred on the local cluster node and are recorded as such. Changes
-     * that occurred in-between calls to any hook registered with a change processor
-     * are considered to have occurred on a different cluster node and are recorded as such.
-     */
-    public class Hook implements PostCommitHook {
-        private final ContentSession contentSession;
-
-        private Hook(ContentSession contentSession) {
-            this.contentSession = contentSession;
-        }
-
-        @Override
-        public void contentChanged(@Nonnull NodeState before, @Nonnull NodeState after) {
-            ChangeDispatcher.this.contentChanged(before, after, contentSession);
-        }
-    }
-
     //------------------------------------------------------------< Listener >---
 
     /**
@@ -177,6 +214,10 @@ public class ChangeDispatcher {
          */
         @CheckForNull
         public ChangeSet getChanges() {
+            if (changeSets.isEmpty()) {
+                externalChange();
+            }
+
             return changeSets.isEmpty() ? null : changeSets.remove();
         }
 
@@ -193,55 +234,45 @@ public class ChangeDispatcher {
      * on the local cluster node, the user causing the changes and the date the changes
      * where persisted.
      */
-    public abstract static class ChangeSet {
+    public static class ChangeSet {
         private final NodeState before;
         private final NodeState after;
+        private final boolean isExternal;
 
-        static ChangeSet local(NodeState base, NodeState head, ContentSession contentSession) {
-            return new InternalChangeSet(base, head, contentSession, System.currentTimeMillis());
+        ChangeSet(NodeState before, NodeState after, boolean isExternal) {
+            this.before = before;
+            this.after = after;
+            this.isExternal = isExternal;
         }
 
-        static ChangeSet external(NodeState base, NodeState head) {
-            return new ExternalChangeSet(base, head);
+        public boolean isExternal() {
+            return isExternal;
         }
 
-        protected ChangeSet(NodeState before, NodeState after) {
-            this.before = before;
-            this.after = after;
+        public boolean isLocal(String sessionId) {
+            return Objects.equal(getSessionId(), sessionId);
         }
 
-        /**
-         * Determine whether these changes originate from the local cluster node
-         * or an external cluster node.
-         * @return  {@code true} iff the changes originate from a remote cluster node.
-         */
-        public abstract boolean isExternal();
-
-        /**
-         * Determine whether these changes where caused by the passed content
-         * session.
-         * @param contentSession  content session to test for
-         * @return  {@code true} iff these changes where cause by the passed content session.
-         *          Always {@code false} if {@link #isExternal()} is {@code true}.
-         */
-        public abstract boolean isLocal(ContentSession contentSession);
+        @CheckForNull
+        public String getSessionId() {
+            return getStringOrNull(getCommitInfo(after), CommitInfoEditorProvider.SESSION_ID);
+        }
 
-        /**
-         * Determine the user associated with these changes.
-         * @return  user id or {@link ObservationConstants#OAK_UNKNOWN} if {@link #isExternal()} is {@code true}.
-         */
-        public abstract String getUserId();
+        @CheckForNull
+        public String getUserId() {
+            return getStringOrNull(getCommitInfo(after), CommitInfoEditorProvider.USER_ID);
+        }
 
-        /**
-         * Determine the date when these changes where persisted.
-         * @return  date or {@code 0} if {@link #isExternal()} is {@code true}.
-         */
-        public abstract long getDate();
+        public long getDate() {
+            PropertyState property = getCommitInfo(after).getProperty(CommitInfoEditorProvider.TIME_STAMP);
+            return property == null ? 0 : property.getValue(LONG);
+        }
 
         /**
          * State before the change
          * @return  before state
          */
+        @Nonnull
         public NodeState getBeforeState() {
             return before;
         }
@@ -250,6 +281,7 @@ public class ChangeDispatcher {
          * State after the change
          * @return  after state
          */
+        @Nonnull
         public NodeState getAfterState() {
             return after;
         }
@@ -259,8 +291,10 @@ public class ChangeDispatcher {
             return toStringHelper(this)
                 .add("base", before)
                 .add("head", after)
-                .add("userId", getUserId())
-                .add("date", getDate())
+                .add(CommitInfoEditorProvider.USER_ID, getUserId())
+                .add(CommitInfoEditorProvider.TIME_STAMP, getDate())
+                .add(CommitInfoEditorProvider.SESSION_ID, getSessionId())
+                .add("external", isExternal)
                 .toString();
         }
 
@@ -274,7 +308,8 @@ public class ChangeDispatcher {
             }
 
             ChangeSet that = (ChangeSet) other;
-            return before.equals(that.before) && after.equals(that.after);
+            return before.equals(that.before) && after.equals(that.after) &&
+                    isExternal == that.isExternal;
         }
 
         @Override
@@ -282,73 +317,13 @@ public class ChangeDispatcher {
             return 31 * before.hashCode() + after.hashCode();
         }
 
-        private static class InternalChangeSet extends ChangeSet {
-            private final ContentSession contentSession;
-            private final String userId;
-            private final long date;
-
-            InternalChangeSet(NodeState base, NodeState head, ContentSession contentSession, long date) {
-                super(base, head);
-                this.contentSession = contentSession;
-                this.userId = contentSession.getAuthInfo().getUserID();
-                this.date = date;
-            }
-
-            @Override
-            public boolean isExternal() {
-                return false;
-            }
-
-            @Override
-            public boolean isLocal(ContentSession contentSession) {
-                return this.contentSession == contentSession;
-            }
-
-            @Override
-            public String getUserId() {
-                return userId;
-            }
-
-            @Override
-            public long getDate() {
-                return date;
-            }
-
-            @Override
-            public boolean equals(Object other) {
-                if (!super.equals(other)) {
-                    return false;
-                }
-
-                InternalChangeSet that = (InternalChangeSet) other;
-                return date == that.date && contentSession == that.contentSession;
-            }
+        private static String getStringOrNull(NodeState commitInfo, String name) {
+            PropertyState property = commitInfo.getProperty(name);
+            return property == null ? null : property.getValue(STRING);
         }
 
-        private static class ExternalChangeSet extends ChangeSet {
-            ExternalChangeSet(NodeState base, NodeState head) {
-                super(base, head);
-            }
-
-            @Override
-            public boolean isExternal() {
-                return true;
-            }
-
-            @Override
-            public boolean isLocal(ContentSession contentSession) {
-                return false;
-            }
-
-            @Override
-            public String getUserId() {
-                return OAK_UNKNOWN;
-            }
-
-            @Override
-            public long getDate() {
-                return 0;
-            }
+        private static NodeState getCommitInfo(NodeState after) {
+            return after.getChildNode(CommitInfoEditorProvider.COMMIT_INFO);
         }
 
     }
diff --git a/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/observation/ChangeProcessor.java b/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/observation/ChangeProcessor.java
index d82f7df6bf..d1fe07f469 100644
--- a/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/observation/ChangeProcessor.java
+++ b/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/observation/ChangeProcessor.java
@@ -18,10 +18,22 @@
  */
 package org.apache.jackrabbit.oak.plugins.observation;
 
+import static com.google.common.base.Preconditions.checkArgument;
+import static com.google.common.base.Preconditions.checkState;
+import static com.google.common.collect.Iterators.emptyIterator;
+import static com.google.common.collect.Iterators.singletonIterator;
+import static com.google.common.collect.Iterators.transform;
+import static javax.jcr.observation.Event.NODE_ADDED;
+import static javax.jcr.observation.Event.NODE_REMOVED;
+import static javax.jcr.observation.Event.PROPERTY_ADDED;
+import static javax.jcr.observation.Event.PROPERTY_REMOVED;
+import static org.apache.jackrabbit.oak.plugins.identifier.IdentifierManager.getIdentifier;
+
 import java.util.ArrayList;
 import java.util.Iterator;
 import java.util.List;
 import java.util.concurrent.atomic.AtomicReference;
+
 import javax.annotation.Nonnull;
 import javax.jcr.observation.Event;
 import javax.jcr.observation.EventListener;
@@ -50,17 +62,6 @@ import org.apache.jackrabbit.oak.spi.whiteboard.WhiteboardUtils;
 import org.slf4j.Logger;
 import org.slf4j.LoggerFactory;
 
-import static com.google.common.base.Preconditions.checkArgument;
-import static com.google.common.base.Preconditions.checkState;
-import static com.google.common.collect.Iterators.emptyIterator;
-import static com.google.common.collect.Iterators.singletonIterator;
-import static com.google.common.collect.Iterators.transform;
-import static javax.jcr.observation.Event.NODE_ADDED;
-import static javax.jcr.observation.Event.NODE_REMOVED;
-import static javax.jcr.observation.Event.PROPERTY_ADDED;
-import static javax.jcr.observation.Event.PROPERTY_REMOVED;
-import static org.apache.jackrabbit.oak.plugins.identifier.IdentifierManager.getIdentifier;
-
 /**
  * A {@code ChangeProcessor} generates observation {@link javax.jcr.observation.Event}s
  * based on a {@link EventFilter} and delivers them to an {@link javax.jcr.observation.EventListener}.
@@ -189,7 +190,9 @@ public class ChangeProcessor implements Runnable {
             ChangeSet changes = changeListener.getChanges();
             while (!stopping && changes != null) {
                 EventFilter filter = filterRef.get();
-                if (!(filter.excludeLocal() && changes.isLocal(contentSession))) {
+                // FIXME don't rely on toString for session id
+                // FIXME make cluster node id part of session id
+                if (!(filter.excludeLocal() && changes.isLocal(contentSession.toString()))) {
                     String path = namePathMapper.getOakPath(filter.getPath());
                     ImmutableTree beforeTree = getTree(changes.getBeforeState(), path);
                     ImmutableTree afterTree = getTree(changes.getAfterState(), path);
diff --git a/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/observation/CommitInfoEditorProvider.java b/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/observation/CommitInfoEditorProvider.java
new file mode 100644
index 0000000000..f586892462
--- /dev/null
+++ b/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/observation/CommitInfoEditorProvider.java
@@ -0,0 +1,69 @@
+package org.apache.jackrabbit.oak.plugins.observation;
+
+import static com.google.common.base.Preconditions.checkNotNull;
+
+import javax.annotation.Nonnull;
+
+import org.apache.jackrabbit.oak.spi.commit.DefaultEditor;
+import org.apache.jackrabbit.oak.spi.commit.Editor;
+import org.apache.jackrabbit.oak.spi.commit.EditorProvider;
+import org.apache.jackrabbit.oak.spi.state.NodeBuilder;
+import org.apache.jackrabbit.oak.spi.state.NodeState;
+
+/**
+ * Provider for a {@link Editor} that amends each commit with
+ * a commit info record. That record is stored in a child node
+ * named {@link #COMMIT_INFO} of the root node.
+ */
+public class CommitInfoEditorProvider implements EditorProvider {
+
+    /**
+     * Node name for the commit info record
+     */
+    public static final String COMMIT_INFO = ":commit-info";
+
+    /**
+     * Name of the property containing the id of the session that committed
+     * this revision.
+     * <p>
+     * In a clustered environment this property might contain a synthesised
+     * value if the respective revision is the result of a cluster sync.
+     */
+    public static final String SESSION_ID = "session-id";
+
+    /**
+     * Name of the property containing the id of the user that committed
+     * this revision.
+     * <p>
+     * In a clustered environment this property might contain a synthesised
+     * value if the respective revision is the result of a cluster sync.
+     */
+    public static final String USER_ID = "user-id";
+
+    /**
+     * Name of the property containing the time stamp when this revision was
+     * committed.
+     */
+    public static final String TIME_STAMP = "time-stamp";
+
+    private final String sessionId;
+    private final String userId;
+
+    public CommitInfoEditorProvider(@Nonnull String sessionId, String userID) {
+        this.sessionId = checkNotNull(sessionId);
+        this.userId = userID;
+    }
+
+    @Override
+    public Editor getRootEditor(NodeState before, NodeState after, final NodeBuilder builder) {
+        return new DefaultEditor() {
+            @Override
+            public void enter(NodeState before, NodeState after) {
+                NodeBuilder commitInfo = builder.setChildNode(COMMIT_INFO);
+                commitInfo.setProperty(USER_ID, String.valueOf(userId));
+                commitInfo.setProperty(SESSION_ID, sessionId);
+                commitInfo.setProperty(TIME_STAMP, System.currentTimeMillis());
+            }
+        };
+    }
+}
diff --git a/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/observation/Observable.java b/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/observation/Observable.java
index b5b7079e9b..cc87f2d9e3 100644
--- a/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/observation/Observable.java
+++ b/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/observation/Observable.java
@@ -23,14 +23,15 @@ import org.apache.jackrabbit.oak.plugins.observation.ChangeDispatcher.Listener;
 
 /**
  * An {@code Observable} supports attaching {@link Listener} instances for
- * listening to changes in a {@code ContentSession}.
+ * listening to content changes.
+ *
  * @see ChangeDispatcher
  */
 public interface Observable {
 
     /**
      * Register a new {@code Listener}. Clients need to call
-     * {@link ChangeDispatcher.Listener#dispose()} when to free
+     * {@link ChangeDispatcher.Listener#dispose()} to free
      * up any resources associated with the listener when done.
      * @return a fresh {@code Listener} instance.
      */
diff --git a/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/SegmentNodeStore.java b/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/SegmentNodeStore.java
index 84c1146598..bfe2f300fc 100644
--- a/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/SegmentNodeStore.java
+++ b/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/SegmentNodeStore.java
@@ -29,16 +29,18 @@ import javax.annotation.Nonnull;
 
 import org.apache.jackrabbit.oak.api.Blob;
 import org.apache.jackrabbit.oak.api.CommitFailedException;
+import org.apache.jackrabbit.oak.plugins.observation.ChangeDispatcher;
+import org.apache.jackrabbit.oak.plugins.observation.ChangeDispatcher.Listener;
+import org.apache.jackrabbit.oak.plugins.observation.Observable;
 import org.apache.jackrabbit.oak.spi.commit.CommitHook;
 import org.apache.jackrabbit.oak.spi.commit.EmptyObserver;
 import org.apache.jackrabbit.oak.spi.commit.Observer;
-import org.apache.jackrabbit.oak.spi.commit.PostCommitHook;
 import org.apache.jackrabbit.oak.spi.state.ConflictAnnotatingRebaseDiff;
 import org.apache.jackrabbit.oak.spi.state.NodeBuilder;
 import org.apache.jackrabbit.oak.spi.state.NodeState;
 import org.apache.jackrabbit.oak.spi.state.NodeStore;
 
-public class SegmentNodeStore implements NodeStore {
+public class SegmentNodeStore implements NodeStore, Observable {
 
     static final String ROOT = "root";
 
@@ -48,6 +50,8 @@ public class SegmentNodeStore implements NodeStore {
 
     private final Observer observer;
 
+    private final ChangeDispatcher changeDispatcher;
+
     private SegmentNodeState head;
 
     private long maximumBackoff = MILLISECONDS.convert(10, SECONDS);
@@ -58,6 +62,7 @@ public class SegmentNodeStore implements NodeStore {
         this.observer = EmptyObserver.INSTANCE;
         this.head = new SegmentNodeState(
                 store.getWriter().getDummySegment(), this.journal.getHead());
+        this.changeDispatcher = new ChangeDispatcher(this);
     }
 
     public SegmentNodeStore(SegmentStore store) {
@@ -78,7 +83,22 @@ public class SegmentNodeStore implements NodeStore {
     }
 
     boolean setHead(SegmentNodeState base, SegmentNodeState head) {
-        return journal.setHead(base.getRecordId(), head.getRecordId());
+        changeDispatcher.beforeCommit(base.getChildNode(ROOT));
+        try {
+            if (journal.setHead(base.getRecordId(), head.getRecordId())) {
+                changeDispatcher.localCommit(head.getChildNode(ROOT));
+                return true;
+            } else {
+                return false;
+            }
+        } finally {
+            changeDispatcher.afterCommit(getRoot());
+        }
+    }
+
+    @Override
+    public Listener newListener() {
+        return changeDispatcher.newListener();
     }
 
     @Override @Nonnull
@@ -89,7 +109,7 @@ public class SegmentNodeStore implements NodeStore {
     @Override
     public synchronized NodeState merge(
             @Nonnull NodeBuilder builder,
-            @Nonnull CommitHook commitHook, PostCommitHook committed)
+            @Nonnull CommitHook commitHook)
             throws CommitFailedException {
         checkArgument(builder instanceof SegmentNodeBuilder);
         checkNotNull(commitHook);
@@ -98,7 +118,7 @@ public class SegmentNodeStore implements NodeStore {
         SegmentNodeStoreBranch branch = new SegmentNodeStoreBranch(
                 this, store.getWriter(), head, maximumBackoff);
         branch.setRoot(builder.getNodeState());
-        NodeState merged = branch.merge(commitHook, committed);
+        NodeState merged = branch.merge(commitHook);
         ((SegmentNodeBuilder) builder).reset(merged);
         return merged;
     }
@@ -147,5 +167,4 @@ public class SegmentNodeStore implements NodeStore {
                 new SegmentNodeState(store.getWriter().getDummySegment(), id);
         return root.getChildNode(ROOT);
     }
-
 }
diff --git a/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/SegmentNodeStoreBranch.java b/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/SegmentNodeStoreBranch.java
index 92b891a6bd..72122207c6 100644
--- a/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/SegmentNodeStoreBranch.java
+++ b/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/SegmentNodeStoreBranch.java
@@ -28,7 +28,6 @@ import javax.annotation.Nonnull;
 import org.apache.jackrabbit.oak.api.CommitFailedException;
 import org.apache.jackrabbit.oak.commons.PathUtils;
 import org.apache.jackrabbit.oak.spi.commit.CommitHook;
-import org.apache.jackrabbit.oak.spi.commit.PostCommitHook;
 import org.apache.jackrabbit.oak.spi.state.ConflictAnnotatingRebaseDiff;
 import org.apache.jackrabbit.oak.spi.state.NodeBuilder;
 import org.apache.jackrabbit.oak.spi.state.NodeState;
@@ -88,7 +87,7 @@ class SegmentNodeStoreBranch implements NodeStoreBranch {
         }
     }
 
-    private synchronized long optimisticMerge(CommitHook hook, PostCommitHook committed)
+    private synchronized long optimisticMerge(CommitHook hook)
             throws CommitFailedException, InterruptedException {
         long timeout = 1;
 
@@ -111,10 +110,8 @@ class SegmentNodeStoreBranch implements NodeStoreBranch {
                 // someone else has a pessimistic lock on the journal,
                 // so we should not try to commit anything
             } else if (store.setHead(base, newHead)) {
-                NodeState previousBase = base;
                 base = newHead;
                 head = newHead;
-                committed.contentChanged(previousBase.getChildNode(ROOT), newHead.getChildNode(ROOT));
                 return -1;
             }
 
@@ -136,7 +133,7 @@ class SegmentNodeStoreBranch implements NodeStoreBranch {
         return MILLISECONDS.convert(timeout, NANOSECONDS);
     }
 
-    private synchronized void pessimisticMerge(CommitHook hook, PostCommitHook committed, long timeout)
+    private synchronized void pessimisticMerge(CommitHook hook, long timeout)
             throws CommitFailedException {
         while (true) {
             SegmentNodeState before = store.getHead();
@@ -168,10 +165,8 @@ class SegmentNodeStoreBranch implements NodeStoreBranch {
                     SegmentNodeState newHead =
                             writer.writeNode(builder.getNodeState());
                     if (store.setHead(after, newHead)) {
-                        NodeState previousBase = base;
                         base = newHead;
                         head = newHead;
-                        committed.contentChanged(previousBase.getChildNode(ROOT), newHead.getChildNode(ROOT));
                         return;
                     } else {
                         // something else happened, perhaps a timeout, so
@@ -185,13 +180,13 @@ class SegmentNodeStoreBranch implements NodeStoreBranch {
     }
 
     @Override @Nonnull
-    public synchronized NodeState merge(CommitHook hook, PostCommitHook committed)
+    public synchronized NodeState merge(CommitHook hook)
             throws CommitFailedException {
         if (base != head) {
             try {
-                long timeout = optimisticMerge(hook, committed);
+                long timeout = optimisticMerge(hook);
                 if (timeout >= 0) {
-                    pessimisticMerge(hook, committed, timeout);
+                    pessimisticMerge(hook, timeout);
                 }
             } catch (InterruptedException e) {
                 throw new CommitFailedException(
diff --git a/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/SegmentNodeStoreService.java b/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/SegmentNodeStoreService.java
index b48dd817dc..f3fbf8b2b9 100644
--- a/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/SegmentNodeStoreService.java
+++ b/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/SegmentNodeStoreService.java
@@ -24,6 +24,7 @@ import java.util.Dictionary;
 import javax.annotation.CheckForNull;
 import javax.annotation.Nonnull;
 
+import com.google.common.base.Preconditions;
 import com.mongodb.Mongo;
 import org.apache.felix.scr.annotations.Activate;
 import org.apache.felix.scr.annotations.Component;
@@ -33,10 +34,11 @@ import org.apache.felix.scr.annotations.Property;
 import org.apache.felix.scr.annotations.Service;
 import org.apache.jackrabbit.oak.api.Blob;
 import org.apache.jackrabbit.oak.api.CommitFailedException;
+import org.apache.jackrabbit.oak.plugins.observation.ChangeDispatcher.Listener;
+import org.apache.jackrabbit.oak.plugins.observation.Observable;
 import org.apache.jackrabbit.oak.plugins.segment.file.FileStore;
 import org.apache.jackrabbit.oak.plugins.segment.mongo.MongoStore;
 import org.apache.jackrabbit.oak.spi.commit.CommitHook;
-import org.apache.jackrabbit.oak.spi.commit.PostCommitHook;
 import org.apache.jackrabbit.oak.spi.state.NodeBuilder;
 import org.apache.jackrabbit.oak.spi.state.NodeState;
 import org.apache.jackrabbit.oak.spi.state.NodeStore;
@@ -44,7 +46,7 @@ import org.osgi.service.component.ComponentContext;
 
 @Component(policy = ConfigurationPolicy.REQUIRE)
 @Service(NodeStore.class)
-public class SegmentNodeStoreService implements NodeStore {
+public class SegmentNodeStoreService implements NodeStore, Observable {
 
     @Property(description="The unique name of this instance")
     public static final String NAME = "name";
@@ -145,6 +147,15 @@ public class SegmentNodeStoreService implements NodeStore {
         }
     }
 
+    //------------------------------------------------------------< Observable >---
+
+    @Override
+    public Listener newListener() {
+        Preconditions.checkState(delegate instanceof Observable);
+        return ((Observable) getDelegate()).newListener();
+    }
+
+
     //---------------------------------------------------------< NodeStore >--
 
     @Override @Nonnull
@@ -154,9 +165,9 @@ public class SegmentNodeStoreService implements NodeStore {
 
     @Nonnull
     @Override
-    public NodeState merge(@Nonnull NodeBuilder builder, @Nonnull CommitHook commitHook,
-            PostCommitHook committed) throws CommitFailedException {
-        return getDelegate().merge(builder, commitHook, committed);
+    public NodeState merge(@Nonnull NodeBuilder builder, @Nonnull CommitHook commitHook)
+            throws CommitFailedException {
+        return getDelegate().merge(builder, commitHook);
     }
 
     @Override
diff --git a/oak-core/src/main/java/org/apache/jackrabbit/oak/spi/commit/PostCommitHook.java b/oak-core/src/main/java/org/apache/jackrabbit/oak/spi/commit/PostCommitHook.java
deleted file mode 100644
index 0ce5c3eeef..0000000000
--- a/oak-core/src/main/java/org/apache/jackrabbit/oak/spi/commit/PostCommitHook.java
+++ /dev/null
@@ -1,50 +0,0 @@
-/*
- * Licensed to the Apache Software Foundation (ASF) under one
- * or more contributor license agreements.  See the NOTICE file
- * distributed with this work for additional information
- * regarding copyright ownership.  The ASF licenses this file
- * to you under the Apache License, Version 2.0 (the
- * "License"); you may not use this file except in compliance
- * with the License.  You may obtain a copy of the License at
- *
- *   http://www.apache.org/licenses/LICENSE-2.0
- *
- * Unless required by applicable law or agreed to in writing,
- * software distributed under the License is distributed on an
- * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
- * KIND, either express or implied.  See the License for the
- * specific language governing permissions and limitations
- * under the License.
- */
-
-package org.apache.jackrabbit.oak.spi.commit;
-
-import javax.annotation.Nonnull;
-
-import org.apache.jackrabbit.oak.spi.state.NodeState;
-
-/**
- * Extension point for observing content changes of an Oak
- * {@link org.apache.jackrabbit.oak.api.Root}. Content changes are
- * reported by passing the <em>before</em> and <em>after</em> state of the content
- * tree to the {@link #contentChanged(NodeState, NodeState)} callback
- * method.
- */
-public interface PostCommitHook {
-    PostCommitHook EMPTY = new PostCommitHook() {
-        @Override
-        public void contentChanged(@Nonnull NodeState before, @Nonnull NodeState after) { }
-    };
-
-    /**
-     * Observes a content change on the associated {@link org.apache.jackrabbit.oak.api.Root}.
-     * <p>
-     * Post-commit hooks are executed synchronously within the context of
-     * a repository instance, so to prevent delaying access to latest changes
-     * the after-commit hooks should avoid any potentially blocking operations.
-     *
-     * @param before content tree before the commit
-     * @param after content tree after the commit
-     */
-    void contentChanged(@Nonnull NodeState before, @Nonnull NodeState after);
-}
diff --git a/oak-core/src/main/java/org/apache/jackrabbit/oak/spi/lifecycle/OakInitializer.java b/oak-core/src/main/java/org/apache/jackrabbit/oak/spi/lifecycle/OakInitializer.java
index b30ec3f2bd..a4659742c4 100644
--- a/oak-core/src/main/java/org/apache/jackrabbit/oak/spi/lifecycle/OakInitializer.java
+++ b/oak-core/src/main/java/org/apache/jackrabbit/oak/spi/lifecycle/OakInitializer.java
@@ -21,11 +21,10 @@ package org.apache.jackrabbit.oak.spi.lifecycle;
 import javax.annotation.Nonnull;
 
 import org.apache.jackrabbit.oak.api.CommitFailedException;
-import org.apache.jackrabbit.oak.plugins.index.IndexUpdateProvider;
 import org.apache.jackrabbit.oak.plugins.index.IndexEditorProvider;
+import org.apache.jackrabbit.oak.plugins.index.IndexUpdateProvider;
 import org.apache.jackrabbit.oak.spi.commit.CommitHook;
 import org.apache.jackrabbit.oak.spi.commit.EditorHook;
-import org.apache.jackrabbit.oak.spi.commit.PostCommitHook;
 import org.apache.jackrabbit.oak.spi.query.QueryIndexProvider;
 import org.apache.jackrabbit.oak.spi.state.NodeBuilder;
 import org.apache.jackrabbit.oak.spi.state.NodeStore;
@@ -43,8 +42,7 @@ public final class OakInitializer {
             initializer.initialize(builder);
             store.merge(
                     builder,
-                    new EditorHook(new IndexUpdateProvider(indexEditor)),
-                    PostCommitHook.EMPTY);
+                    new EditorHook(new IndexUpdateProvider(indexEditor)));
         } catch (CommitFailedException e) {
             throw new RuntimeException(e);
         }
@@ -63,8 +61,7 @@ public final class OakInitializer {
         try {
             store.merge(
                     builder,
-                    new EditorHook(new IndexUpdateProvider(indexEditor)),
-                    PostCommitHook.EMPTY);
+                    new EditorHook(new IndexUpdateProvider(indexEditor)));
         } catch (CommitFailedException e) {
             throw new RuntimeException(e);
         }
diff --git a/oak-core/src/main/java/org/apache/jackrabbit/oak/spi/state/NodeStore.java b/oak-core/src/main/java/org/apache/jackrabbit/oak/spi/state/NodeStore.java
index 8dc426d5f5..9487ed733b 100644
--- a/oak-core/src/main/java/org/apache/jackrabbit/oak/spi/state/NodeStore.java
+++ b/oak-core/src/main/java/org/apache/jackrabbit/oak/spi/state/NodeStore.java
@@ -25,7 +25,6 @@ import javax.annotation.Nonnull;
 import org.apache.jackrabbit.oak.api.Blob;
 import org.apache.jackrabbit.oak.api.CommitFailedException;
 import org.apache.jackrabbit.oak.spi.commit.CommitHook;
-import org.apache.jackrabbit.oak.spi.commit.PostCommitHook;
 
 /**
  * Storage abstraction for trees. At any given point in time the stored
@@ -51,15 +50,14 @@ public interface NodeStore {
      *
      * @param builder  the builder whose changes to apply
      * @param commitHook the commit hook to apply while merging changes
-     * @param committed  the post commit hook
      * @return the node state resulting from the merge.
      * @throws CommitFailedException if the merge failed
      * @throws IllegalArgumentException if the builder is not acquired
      *                                  from a root state of this store
      */
     @Nonnull
-    NodeState merge(@Nonnull NodeBuilder builder, @Nonnull CommitHook commitHook,
-            PostCommitHook committed) throws CommitFailedException;
+    NodeState merge(@Nonnull NodeBuilder builder, @Nonnull CommitHook commitHook)
+            throws CommitFailedException;
 
     /**
      * Rebase the changes in the passed {@code builder} on top of the current root state.
@@ -114,5 +112,4 @@ public interface NodeStore {
      */
     @CheckForNull
     NodeState retrieve(@Nonnull String checkpoint);
-
 }
diff --git a/oak-core/src/main/java/org/apache/jackrabbit/oak/spi/state/NodeStoreBranch.java b/oak-core/src/main/java/org/apache/jackrabbit/oak/spi/state/NodeStoreBranch.java
index 4a6a18158d..784aab3c96 100644
--- a/oak-core/src/main/java/org/apache/jackrabbit/oak/spi/state/NodeStoreBranch.java
+++ b/oak-core/src/main/java/org/apache/jackrabbit/oak/spi/state/NodeStoreBranch.java
@@ -20,7 +20,6 @@ import javax.annotation.Nonnull;
 
 import org.apache.jackrabbit.oak.api.CommitFailedException;
 import org.apache.jackrabbit.oak.spi.commit.CommitHook;
-import org.apache.jackrabbit.oak.spi.commit.PostCommitHook;
 
 /**
  * An instance of this class represents a private branch of the tree in a
@@ -86,13 +85,12 @@ public interface NodeStoreBranch {
      * the current head revision followed by a fast forward merge.
      *
      * @param hook the commit hook to apply while merging changes
-     * @param committed the post commit hook to call after a successful merge
      * @return the node state resulting from the merge.
      * @throws CommitFailedException if the merge failed
      * @throws IllegalStateException if the branch is already merged
      */
     @Nonnull
-    NodeState merge(@Nonnull CommitHook hook, PostCommitHook committed) throws CommitFailedException;
+    NodeState merge(@Nonnull CommitHook hook) throws CommitFailedException;
 
     /**
      * Rebase the changes from this branch on top of the current
diff --git a/oak-core/src/test/java/org/apache/jackrabbit/oak/kernel/KernelNodeBuilderTest.java b/oak-core/src/test/java/org/apache/jackrabbit/oak/kernel/KernelNodeBuilderTest.java
index d986e5d7e8..1ce4e51dfa 100644
--- a/oak-core/src/test/java/org/apache/jackrabbit/oak/kernel/KernelNodeBuilderTest.java
+++ b/oak-core/src/test/java/org/apache/jackrabbit/oak/kernel/KernelNodeBuilderTest.java
@@ -26,10 +26,8 @@ import org.apache.jackrabbit.mk.core.MicroKernelImpl;
 import org.apache.jackrabbit.oak.api.CommitFailedException;
 import org.apache.jackrabbit.oak.plugins.memory.MemoryNodeStore;
 import org.apache.jackrabbit.oak.spi.commit.EmptyHook;
-import org.apache.jackrabbit.oak.spi.commit.PostCommitHook;
 import org.apache.jackrabbit.oak.spi.state.NodeBuilder;
 import org.apache.jackrabbit.oak.spi.state.NodeStore;
-import org.apache.jackrabbit.oak.spi.state.NodeStoreBranch;
 import org.junit.Test;
 
 public class KernelNodeBuilderTest {
@@ -51,7 +49,7 @@ public class KernelNodeBuilderTest {
     private static void init(NodeStore store) throws CommitFailedException {
         NodeBuilder builder = store.getRoot().builder();
         builder.child("x").child("y").child("z");
-        store.merge(builder, EmptyHook.INSTANCE, PostCommitHook.EMPTY);
+        store.merge(builder, EmptyHook.INSTANCE);
     }
 
     private static void run(NodeStore store) throws CommitFailedException {
@@ -73,7 +71,7 @@ public class KernelNodeBuilderTest {
         assertFalse("child node x/y/z not should not be present", builder
                 .child("x").child("y").hasChildNode("z"));
 
-        store.merge(builder, EmptyHook.INSTANCE, PostCommitHook.EMPTY);
+        store.merge(builder, EmptyHook.INSTANCE);
     }
 
 }
diff --git a/oak-core/src/test/java/org/apache/jackrabbit/oak/kernel/KernelNodeStateTest.java b/oak-core/src/test/java/org/apache/jackrabbit/oak/kernel/KernelNodeStateTest.java
index a05c6adb82..6a4a1253d1 100644
--- a/oak-core/src/test/java/org/apache/jackrabbit/oak/kernel/KernelNodeStateTest.java
+++ b/oak-core/src/test/java/org/apache/jackrabbit/oak/kernel/KernelNodeStateTest.java
@@ -33,7 +33,6 @@ import org.apache.jackrabbit.mk.core.MicroKernelImpl;
 import org.apache.jackrabbit.oak.api.CommitFailedException;
 import org.apache.jackrabbit.oak.api.PropertyState;
 import org.apache.jackrabbit.oak.spi.commit.EmptyHook;
-import org.apache.jackrabbit.oak.spi.commit.PostCommitHook;
 import org.apache.jackrabbit.oak.spi.state.ChildNodeEntry;
 import org.apache.jackrabbit.oak.spi.state.NodeBuilder;
 import org.apache.jackrabbit.oak.spi.state.NodeState;
@@ -58,7 +57,8 @@ public class KernelNodeStateTest {
         builder.child("y");
         builder.child("z");
 
-        state = store.merge(builder, EmptyHook.INSTANCE, PostCommitHook.EMPTY);
+        state = store.merge(builder, EmptyHook.INSTANCE);
+        state = store.merge(builder, EmptyHook.INSTANCE);
     }
 
     @After
diff --git a/oak-core/src/test/java/org/apache/jackrabbit/oak/kernel/KernelNodeStoreCacheTest.java b/oak-core/src/test/java/org/apache/jackrabbit/oak/kernel/KernelNodeStoreCacheTest.java
index 2a27f9977e..552f76a259 100644
--- a/oak-core/src/test/java/org/apache/jackrabbit/oak/kernel/KernelNodeStoreCacheTest.java
+++ b/oak-core/src/test/java/org/apache/jackrabbit/oak/kernel/KernelNodeStoreCacheTest.java
@@ -29,7 +29,6 @@ import org.apache.jackrabbit.mk.api.MicroKernel;
 import org.apache.jackrabbit.mk.api.MicroKernelException;
 import org.apache.jackrabbit.mk.core.MicroKernelImpl;
 import org.apache.jackrabbit.oak.spi.commit.EmptyHook;
-import org.apache.jackrabbit.oak.spi.commit.PostCommitHook;
 import org.apache.jackrabbit.oak.spi.state.ChildNodeEntry;
 import org.apache.jackrabbit.oak.spi.state.NodeBuilder;
 import org.apache.jackrabbit.oak.spi.state.NodeState;
@@ -61,7 +60,7 @@ public class KernelNodeStoreCacheTest {
         b.child("c");
         b.child("d");
         b.child("e");
-        store.merge(builder, EmptyHook.INSTANCE, PostCommitHook.EMPTY);
+        store.merge(builder, EmptyHook.INSTANCE);
     }
 
     /**
@@ -138,7 +137,7 @@ public class KernelNodeStoreCacheTest {
     private void modifyContent() throws Exception {
         NodeBuilder builder = store.getRoot().builder();
         builder.child("a").setProperty("foo", "bar");
-        store.merge(builder, EmptyHook.INSTANCE, PostCommitHook.EMPTY);
+        store.merge(builder, EmptyHook.INSTANCE);
     }
 
     private void readTree(NodeState root) {
diff --git a/oak-core/src/test/java/org/apache/jackrabbit/oak/kernel/LargeKernelNodeStateTest.java b/oak-core/src/test/java/org/apache/jackrabbit/oak/kernel/LargeKernelNodeStateTest.java
index 9b080e3768..ee3a5adaa9 100644
--- a/oak-core/src/test/java/org/apache/jackrabbit/oak/kernel/LargeKernelNodeStateTest.java
+++ b/oak-core/src/test/java/org/apache/jackrabbit/oak/kernel/LargeKernelNodeStateTest.java
@@ -25,7 +25,6 @@ import static junit.framework.Assert.assertTrue;
 import org.apache.jackrabbit.mk.core.MicroKernelImpl;
 import org.apache.jackrabbit.oak.api.CommitFailedException;
 import org.apache.jackrabbit.oak.spi.commit.EmptyHook;
-import org.apache.jackrabbit.oak.spi.commit.PostCommitHook;
 import org.apache.jackrabbit.oak.spi.state.ChildNodeEntry;
 import org.apache.jackrabbit.oak.spi.state.NodeBuilder;
 import org.apache.jackrabbit.oak.spi.state.NodeState;
@@ -50,7 +49,7 @@ public class LargeKernelNodeStateTest {
             builder.child("x" + i);
         }
 
-        state = store.merge(builder, EmptyHook.INSTANCE, PostCommitHook.EMPTY);
+        state = store.merge(builder, EmptyHook.INSTANCE);
     }
 
     @After
diff --git a/oak-core/src/test/java/org/apache/jackrabbit/oak/kernel/NodeStoreTest.java b/oak-core/src/test/java/org/apache/jackrabbit/oak/kernel/NodeStoreTest.java
index 3891884996..04e3190da2 100644
--- a/oak-core/src/test/java/org/apache/jackrabbit/oak/kernel/NodeStoreTest.java
+++ b/oak-core/src/test/java/org/apache/jackrabbit/oak/kernel/NodeStoreTest.java
@@ -31,8 +31,6 @@ import java.util.Arrays;
 import java.util.Collection;
 import java.util.List;
 
-import javax.annotation.Nonnull;
-
 import org.apache.jackrabbit.oak.NodeStoreFixture;
 import org.apache.jackrabbit.oak.api.CommitFailedException;
 import org.apache.jackrabbit.oak.api.PropertyState;
@@ -40,12 +38,10 @@ import org.apache.jackrabbit.oak.plugins.memory.MultiStringPropertyState;
 import org.apache.jackrabbit.oak.spi.commit.CommitHook;
 import org.apache.jackrabbit.oak.spi.commit.EmptyHook;
 import org.apache.jackrabbit.oak.spi.commit.Observer;
-import org.apache.jackrabbit.oak.spi.commit.PostCommitHook;
 import org.apache.jackrabbit.oak.spi.state.DefaultNodeStateDiff;
 import org.apache.jackrabbit.oak.spi.state.NodeBuilder;
 import org.apache.jackrabbit.oak.spi.state.NodeState;
 import org.apache.jackrabbit.oak.spi.state.NodeStore;
-import org.apache.jackrabbit.oak.spi.state.NodeStoreBranch;
 import org.junit.After;
 import org.junit.Before;
 import org.junit.Test;
@@ -86,7 +82,8 @@ public class NodeStoreTest {
         test.child("x");
         test.child("y");
         test.child("z");
-        root = store.merge(builder, EmptyHook.INSTANCE, PostCommitHook.EMPTY);
+        root = store.merge(builder, EmptyHook.INSTANCE);
+        root = store.merge(builder, EmptyHook.INSTANCE);
     }
 
     @After
@@ -129,7 +126,7 @@ public class NodeStoreTest {
         assertFalse(testState.getChildNode("newNode").exists());
         assertTrue(testState.getChildNode("x").exists());
 
-        store.merge(rootBuilder, EmptyHook.INSTANCE, PostCommitHook.EMPTY);
+        store.merge(rootBuilder, EmptyHook.INSTANCE);
 
         // Assert changes are present in the trunk
         testState = store.getRoot().getChildNode("test");
@@ -160,7 +157,7 @@ public class NodeStoreTest {
 
         testBuilder.getChildNode("a").remove();
 
-        store.merge(rootBuilder, EmptyHook.INSTANCE, PostCommitHook.EMPTY);
+        store.merge(rootBuilder, EmptyHook.INSTANCE);
         NodeState newRoot = store.getRoot(); // triggers the observer
 
         NodeState before = states[0];
@@ -194,7 +191,7 @@ public class NodeStoreTest {
                 testBuilder.child("fromHook");
                 return rootBuilder.getNodeState();
             }
-        }, PostCommitHook.EMPTY);
+        });
 
         NodeState test = store.getRoot().getChildNode("test");
         assertTrue(test.getChildNode("newNode").exists());
@@ -211,13 +208,13 @@ public class NodeStoreTest {
         for (int i = 0; i <= KernelNodeState.MAX_CHILD_NODE_NAMES; i++) {
             parent.child("child-" + i);
         }
-        store.merge(root, EmptyHook.INSTANCE, PostCommitHook.EMPTY);
+        store.merge(root, EmptyHook.INSTANCE);
 
         NodeState base = store.getRoot();
         root = base.builder();
         parent = root.child("parent");
         parent.child("child-new");
-        store.merge(root, EmptyHook.INSTANCE, PostCommitHook.EMPTY);
+        store.merge(root, EmptyHook.INSTANCE);
 
         Diff diff = new Diff();
         store.getRoot().compareAgainstBaseState(base, diff);
@@ -230,7 +227,7 @@ public class NodeStoreTest {
         root = base.builder();
         parent = root.getChildNode("parent");
         parent.getChildNode("child-new").moveTo(parent, "child-moved");
-        store.merge(root, EmptyHook.INSTANCE, PostCommitHook.EMPTY);
+        store.merge(root, EmptyHook.INSTANCE);
 
         diff = new Diff();
         store.getRoot().compareAgainstBaseState(base, diff);
@@ -246,7 +243,7 @@ public class NodeStoreTest {
         parent.child("child-moved").setProperty("foo", "value");
         parent.child("child-moved").setProperty(
                 new MultiStringPropertyState("bar", Arrays.asList("value")));
-        store.merge(root, EmptyHook.INSTANCE, PostCommitHook.EMPTY);
+        store.merge(root, EmptyHook.INSTANCE);
 
         diff = new Diff();
         store.getRoot().compareAgainstBaseState(base, diff);
@@ -263,7 +260,7 @@ public class NodeStoreTest {
         parent.setProperty("foo", "value");
         parent.setProperty(new MultiStringPropertyState(
                 "bar", Arrays.asList("value")));
-        store.merge(root, EmptyHook.INSTANCE, PostCommitHook.EMPTY);
+        store.merge(root, EmptyHook.INSTANCE);
 
         diff = new Diff();
         store.getRoot().compareAgainstBaseState(base, diff);
@@ -278,7 +275,7 @@ public class NodeStoreTest {
         root = base.builder();
         parent = root.child("parent");
         parent.getChildNode("child-moved").remove();
-        store.merge(root, EmptyHook.INSTANCE, PostCommitHook.EMPTY);
+        store.merge(root, EmptyHook.INSTANCE);
 
         diff = new Diff();
         store.getRoot().compareAgainstBaseState(base, diff);
@@ -311,7 +308,7 @@ public class NodeStoreTest {
     private static NodeStore init(NodeStore store) throws CommitFailedException {
         NodeBuilder builder = store.getRoot().builder();
         builder.setChildNode("root");
-        store.merge(builder, EmptyHook.INSTANCE, PostCommitHook.EMPTY);
+        store.merge(builder, EmptyHook.INSTANCE);
         return store;
     }
 
@@ -325,27 +322,11 @@ public class NodeStoreTest {
         builder1.setChildNode("node1");
         builder2.setChildNode("node2");
 
-        store.merge(builder1, EmptyHook.INSTANCE, new PostCommitHook() {
-            @Override
-            public void contentChanged(@Nonnull NodeState before, @Nonnull NodeState after) {
-                assertFalse(before.hasChildNode("node1"));
-                assertFalse(before.hasChildNode("node2"));
-                assertTrue(after.hasChildNode("node1"));
-                assertFalse(after.hasChildNode("node2"));
-            }
-        });
+        store.merge(builder1, EmptyHook.INSTANCE);
         assertTrue(store.getRoot().hasChildNode("node1"));
         assertFalse(store.getRoot().hasChildNode("node2"));
 
-        store.merge(builder2, EmptyHook.INSTANCE, new PostCommitHook() {
-            @Override
-            public void contentChanged(@Nonnull NodeState before, @Nonnull NodeState after) {
-                assertTrue(before.hasChildNode("node1"));
-                assertFalse(before.hasChildNode("node2"));
-                assertTrue(after.hasChildNode("node1"));
-                assertTrue(after.hasChildNode("node2"));
-            }
-        });
+        store.merge(builder2, EmptyHook.INSTANCE);
         assertTrue(store.getRoot().hasChildNode("node1"));
         assertTrue(store.getRoot().hasChildNode("node2"));
     }
@@ -373,7 +354,7 @@ public class NodeStoreTest {
         }
 
         builder.child("foo").child(":bar").child("quz").setProperty("p", "v");
-        store.merge(builder, EmptyHook.INSTANCE, PostCommitHook.EMPTY);
+        store.merge(builder, EmptyHook.INSTANCE);
 
         NodeState after = store.getRoot();
         Diff diff = new Diff();
diff --git a/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/index/AsyncIndexUpdateTest.java b/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/index/AsyncIndexUpdateTest.java
index 1bb8968873..fb9157ecf6 100644
--- a/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/index/AsyncIndexUpdateTest.java
+++ b/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/index/AsyncIndexUpdateTest.java
@@ -17,28 +17,26 @@
 package org.apache.jackrabbit.oak.plugins.index;
 
 import static org.apache.jackrabbit.oak.plugins.index.IndexConstants.ASYNC_PROPERTY_NAME;
-import static org.apache.jackrabbit.oak.plugins.index.IndexConstants.INDEX_DEFINITIONS_NAME;
 import static org.apache.jackrabbit.oak.plugins.index.IndexConstants.INDEX_CONTENT_NODE_NAME;
+import static org.apache.jackrabbit.oak.plugins.index.IndexConstants.INDEX_DEFINITIONS_NAME;
 import static org.apache.jackrabbit.oak.plugins.index.IndexUtils.createIndexDefinition;
 import static org.junit.Assert.assertEquals;
 import static org.junit.Assert.assertTrue;
 
 import java.util.Set;
 
+import com.google.common.collect.ImmutableSet;
+import com.google.common.collect.Sets;
 import org.apache.jackrabbit.oak.plugins.index.property.PropertyIndexEditorProvider;
 import org.apache.jackrabbit.oak.plugins.index.property.PropertyIndexLookup;
 import org.apache.jackrabbit.oak.plugins.memory.MemoryNodeStore;
 import org.apache.jackrabbit.oak.spi.commit.EmptyHook;
-import org.apache.jackrabbit.oak.spi.commit.PostCommitHook;
 import org.apache.jackrabbit.oak.spi.query.PropertyValues;
 import org.apache.jackrabbit.oak.spi.state.NodeBuilder;
 import org.apache.jackrabbit.oak.spi.state.NodeState;
 import org.apache.jackrabbit.oak.spi.state.NodeStore;
 import org.junit.Test;
 
-import com.google.common.collect.ImmutableSet;
-import com.google.common.collect.Sets;
-
 public class AsyncIndexUpdateTest {
 
     // TODO test index config deletes
@@ -79,7 +77,7 @@ public class AsyncIndexUpdateTest {
         builder.child("testRoot").setProperty("foo", "abc");
 
         // merge it back in
-        store.merge(builder, EmptyHook.INSTANCE, PostCommitHook.EMPTY);
+        store.merge(builder, EmptyHook.INSTANCE);
 
         AsyncIndexUpdate async = new AsyncIndexUpdate("async", store, provider);
         async.run();
@@ -120,7 +118,7 @@ public class AsyncIndexUpdateTest {
         builder.child("testSecond").setProperty("bar", "ghi");
 
         // merge it back in
-        store.merge(builder, EmptyHook.INSTANCE, PostCommitHook.EMPTY);
+        store.merge(builder, EmptyHook.INSTANCE);
 
         AsyncIndexUpdate async = new AsyncIndexUpdate("async", store, provider);
         async.run();
@@ -172,7 +170,7 @@ public class AsyncIndexUpdateTest {
                 .setProperty("foo", "xyz");
 
         // merge it back in
-        store.merge(builder, EmptyHook.INSTANCE, PostCommitHook.EMPTY);
+        store.merge(builder, EmptyHook.INSTANCE);
 
         AsyncIndexUpdate async = new AsyncIndexUpdate("async", store, provider);
         async.run();
diff --git a/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/index/nodetype/NodeTypeIndexTest.java b/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/index/nodetype/NodeTypeIndexTest.java
index f706034715..80073d68ec 100644
--- a/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/index/nodetype/NodeTypeIndexTest.java
+++ b/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/index/nodetype/NodeTypeIndexTest.java
@@ -41,7 +41,6 @@ import org.apache.jackrabbit.oak.plugins.nodetype.write.InitialContent;
 import org.apache.jackrabbit.oak.query.ast.SelectorImpl;
 import org.apache.jackrabbit.oak.query.index.FilterImpl;
 import org.apache.jackrabbit.oak.spi.commit.EditorHook;
-import org.apache.jackrabbit.oak.spi.commit.PostCommitHook;
 import org.apache.jackrabbit.oak.spi.lifecycle.OakInitializer;
 import org.apache.jackrabbit.oak.spi.query.Cursor;
 import org.apache.jackrabbit.oak.spi.query.Cursors;
@@ -79,7 +78,7 @@ public class NodeTypeIndexTest {
         addFile(root, "file-1");
 
         store.merge(root, new EditorHook(new IndexUpdateProvider(
-                new PropertyIndexEditorProvider())), PostCommitHook.EMPTY);
+                new PropertyIndexEditorProvider())));
 
         NodeState rootState = store.getRoot();
         NodeTypeIndex index = new NodeTypeIndex();
diff --git a/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/segment/JournalTest.java b/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/segment/JournalTest.java
index d096df3d85..9956034f7a 100644
--- a/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/segment/JournalTest.java
+++ b/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/segment/JournalTest.java
@@ -22,7 +22,6 @@ import org.apache.jackrabbit.oak.api.CommitFailedException;
 import org.apache.jackrabbit.oak.api.Type;
 import org.apache.jackrabbit.oak.plugins.segment.memory.MemoryStore;
 import org.apache.jackrabbit.oak.spi.commit.EmptyHook;
-import org.apache.jackrabbit.oak.spi.commit.PostCommitHook;
 import org.apache.jackrabbit.oak.spi.state.NodeBuilder;
 import org.apache.jackrabbit.oak.spi.state.NodeState;
 import org.junit.Test;
@@ -47,7 +46,7 @@ public class JournalTest {
         builder.setProperty("foo", "bar");
         NodeState newState = builder.getNodeState();
 
-        root.merge(builder, EmptyHook.INSTANCE, PostCommitHook.EMPTY);
+        root.merge(builder, EmptyHook.INSTANCE);
 
         assertEquals(newState, root.getRoot());
         assertEquals(oldState, left.getRoot());
@@ -74,7 +73,7 @@ public class JournalTest {
         builder.setProperty("foo", "bar");
         NodeState newState = builder.getNodeState();
 
-        left.merge(builder, EmptyHook.INSTANCE, PostCommitHook.EMPTY);
+        left.merge(builder, EmptyHook.INSTANCE);
 
         assertEquals(oldState, root.getRoot());
         assertEquals(newState, left.getRoot());
@@ -101,7 +100,7 @@ public class JournalTest {
         leftBuilder.setProperty("foo", "bar");
         NodeState leftState = leftBuilder.getNodeState();
 
-        left.merge(leftBuilder, EmptyHook.INSTANCE, PostCommitHook.EMPTY);
+        left.merge(leftBuilder, EmptyHook.INSTANCE);
 
         assertEquals(oldState, root.getRoot());
         assertEquals(leftState, left.getRoot());
@@ -115,7 +114,7 @@ public class JournalTest {
         NodeBuilder rightBuilder = oldState.builder();
         rightBuilder.setProperty("bar", "foo");
 
-        right.merge(rightBuilder, EmptyHook.INSTANCE, PostCommitHook.EMPTY);
+        right.merge(rightBuilder, EmptyHook.INSTANCE);
 
         store.getJournal("right").merge();
         NodeState newState = root.getRoot();
diff --git a/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/segment/MergeTest.java b/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/segment/MergeTest.java
index 1014b7947d..b9506aa33d 100644
--- a/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/segment/MergeTest.java
+++ b/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/segment/MergeTest.java
@@ -29,7 +29,6 @@ import org.apache.jackrabbit.oak.api.CommitFailedException;
 import org.apache.jackrabbit.oak.plugins.segment.memory.MemoryStore;
 import org.apache.jackrabbit.oak.spi.commit.CommitHook;
 import org.apache.jackrabbit.oak.spi.commit.EmptyHook;
-import org.apache.jackrabbit.oak.spi.commit.PostCommitHook;
 import org.apache.jackrabbit.oak.spi.state.NodeBuilder;
 import org.apache.jackrabbit.oak.spi.state.NodeState;
 import org.apache.jackrabbit.oak.spi.state.NodeStore;
@@ -46,14 +45,14 @@ public class MergeTest {
 
         NodeBuilder a = store.getRoot().builder();
         a.setProperty("foo", "abc");
-        store.merge(a, EmptyHook.INSTANCE, PostCommitHook.EMPTY);
+        store.merge(a, EmptyHook.INSTANCE);
 
         assertTrue(store.getRoot().hasProperty("foo"));
         assertFalse(store.getRoot().hasProperty("bar"));
 
         NodeBuilder b = store.getRoot().builder();
         b.setProperty("bar", "xyz");
-        store.merge(b, EmptyHook.INSTANCE, PostCommitHook.EMPTY);
+        store.merge(b, EmptyHook.INSTANCE);
 
         assertTrue(store.getRoot().hasProperty("foo"));
         assertTrue(store.getRoot().hasProperty("bar"));
@@ -72,12 +71,12 @@ public class MergeTest {
         assertFalse(store.getRoot().hasProperty("foo"));
         assertFalse(store.getRoot().hasProperty("bar"));
 
-        store.merge(a, EmptyHook.INSTANCE, PostCommitHook.EMPTY);
+        store.merge(a, EmptyHook.INSTANCE);
 
         assertTrue(store.getRoot().hasProperty("foo"));
         assertFalse(store.getRoot().hasProperty("bar"));
 
-        store.merge(b, EmptyHook.INSTANCE, PostCommitHook.EMPTY);
+        store.merge(b, EmptyHook.INSTANCE);
 
         assertTrue(store.getRoot().hasProperty("foo"));
         assertTrue(store.getRoot().hasProperty("bar"));
@@ -96,7 +95,7 @@ public class MergeTest {
                     try {
                         NodeBuilder a = store.getRoot().builder();
                         a.setProperty("foo", "abc" + i);
-                        store.merge(a, EmptyHook.INSTANCE, PostCommitHook.EMPTY);
+                        store.merge(a, EmptyHook.INSTANCE);
                         semaphore.release();
                     } catch (CommitFailedException e) {
                         fail();
@@ -125,7 +124,7 @@ public class MergeTest {
                 }
                 return after;
             }
-        }, PostCommitHook.EMPTY);
+        });
 
         assertTrue(store.getRoot().hasProperty("foo"));
         assertTrue(store.getRoot().hasProperty("bar"));
