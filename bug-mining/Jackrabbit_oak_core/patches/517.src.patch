diff --git a/oak-core/src/main/java/org/apache/jackrabbit/oak/query/Query.java b/oak-core/src/main/java/org/apache/jackrabbit/oak/query/Query.java
index 60973341e3..d53f4d59f7 100644
--- a/oak-core/src/main/java/org/apache/jackrabbit/oak/query/Query.java
+++ b/oak-core/src/main/java/org/apache/jackrabbit/oak/query/Query.java
@@ -22,7 +22,6 @@ import org.apache.jackrabbit.oak.api.Tree;
 import org.apache.jackrabbit.oak.namepath.NamePathMapper;
 import org.apache.jackrabbit.oak.query.ast.ColumnImpl;
 import org.apache.jackrabbit.oak.query.ast.OrderingImpl;
-import org.apache.jackrabbit.oak.spi.query.QueryIndexProvider;
 
 /**
  * A "select" or "union" query.
@@ -43,7 +42,7 @@ public interface Query {
 
     void bindValue(String key, PropertyValue value);
 
-    void setIndexProvider(QueryIndexProvider indexProvider);
+    void setTraversalFallback(boolean traversal);
 
     void prepare();
 
@@ -52,7 +51,7 @@ public interface Query {
     List<String> getBindVariableNames();
 
     ColumnImpl[] getColumns();
-    
+
     int getColumnIndex(String columnName);
 
     String[] getSelectorNames();
diff --git a/oak-core/src/main/java/org/apache/jackrabbit/oak/query/QueryEngineImpl.java b/oak-core/src/main/java/org/apache/jackrabbit/oak/query/QueryEngineImpl.java
index d09fa75978..fcb8f7f1a9 100644
--- a/oak-core/src/main/java/org/apache/jackrabbit/oak/query/QueryEngineImpl.java
+++ b/oak-core/src/main/java/org/apache/jackrabbit/oak/query/QueryEngineImpl.java
@@ -21,23 +21,16 @@ import static org.apache.jackrabbit.JcrConstants.JCR_SYSTEM;
 import static org.apache.jackrabbit.oak.plugins.nodetype.NodeTypeConstants.JCR_NODE_TYPES;
 
 import java.text.ParseException;
-import java.util.ArrayList;
 import java.util.List;
 import java.util.Map;
 import java.util.Map.Entry;
 import java.util.Set;
 
-import javax.annotation.Nonnull;
-
 import org.apache.jackrabbit.oak.api.PropertyValue;
 import org.apache.jackrabbit.oak.api.QueryEngine;
 import org.apache.jackrabbit.oak.api.Result;
 import org.apache.jackrabbit.oak.namepath.NamePathMapper;
-import org.apache.jackrabbit.oak.query.index.TraversingIndex;
 import org.apache.jackrabbit.oak.query.xpath.XPathToSQL2Converter;
-import org.apache.jackrabbit.oak.spi.query.Filter;
-import org.apache.jackrabbit.oak.spi.query.QueryIndex;
-import org.apache.jackrabbit.oak.spi.query.QueryIndexProvider;
 import org.apache.jackrabbit.oak.spi.state.NodeState;
 import org.slf4j.Logger;
 import org.slf4j.LoggerFactory;
@@ -149,51 +142,13 @@ public abstract class QueryEngineImpl implements QueryEngine {
                 q.bindValue(e.getKey(), e.getValue());
             }
         }
-        q.setIndexProvider(getIndexProvider(context.getIndexProvider(), traversalFallback));
+        q.setTraversalFallback(traversalFallback);
         q.prepare();
         return q.executeQuery();
     }
 
-    private static QueryIndexProvider getIndexProvider(final QueryIndexProvider indexProvider,
-            boolean traversalFallback) {
-        if (traversalFallback) {
-            return new QueryIndexProvider() {
-                @Nonnull
-                @Override
-                public List<? extends QueryIndex> getQueryIndexes(NodeState nodeState) {
-                    List<QueryIndex> indexes = new ArrayList<QueryIndex>(indexProvider.getQueryIndexes(nodeState));
-                    indexes.add(new TraversingIndex());
-                    return indexes;
-                }
-            };
-        } else {
-            return indexProvider;
-        }
-    }
-
     protected void setTraversalFallback(boolean traversal) {
         this.traversalFallback = traversal;
     }
 
-    public static QueryIndex getBestIndex(NodeState rootState, Filter filter,
-            QueryIndexProvider indexProvider) {
-        QueryIndex best = null;
-        if (LOG.isDebugEnabled()) {
-            LOG.debug("cost using filter " + filter);
-        }
-
-        double bestCost = Double.POSITIVE_INFINITY;
-        for (QueryIndex index : indexProvider.getQueryIndexes(rootState)) {
-            double cost = index.getCost(filter, rootState);
-            if (LOG.isDebugEnabled()) {
-                LOG.debug("cost for " + index.getIndexName() + " is " + cost);
-            }
-            if (cost < bestCost) {
-                bestCost = cost;
-                best = index;
-            }
-        }
-        return best;
-    }
-
 }
diff --git a/oak-core/src/main/java/org/apache/jackrabbit/oak/query/QueryImpl.java b/oak-core/src/main/java/org/apache/jackrabbit/oak/query/QueryImpl.java
index c9b006c8da..dc64dd8524 100644
--- a/oak-core/src/main/java/org/apache/jackrabbit/oak/query/QueryImpl.java
+++ b/oak-core/src/main/java/org/apache/jackrabbit/oak/query/QueryImpl.java
@@ -55,6 +55,7 @@ import org.apache.jackrabbit.oak.query.ast.SameNodeJoinConditionImpl;
 import org.apache.jackrabbit.oak.query.ast.SelectorImpl;
 import org.apache.jackrabbit.oak.query.ast.SourceImpl;
 import org.apache.jackrabbit.oak.query.ast.UpperCaseImpl;
+import org.apache.jackrabbit.oak.query.index.TraversingIndex;
 import org.apache.jackrabbit.oak.spi.query.Filter;
 import org.apache.jackrabbit.oak.spi.query.PropertyValues;
 import org.apache.jackrabbit.oak.spi.query.QueryIndex;
@@ -93,8 +94,14 @@ public class QueryImpl implements Query {
     final HashMap<String, Integer> selectorIndexes = new HashMap<String, Integer>();
     final ArrayList<SelectorImpl> selectors = new ArrayList<SelectorImpl>();
     ConstraintImpl constraint;
-    
-    private QueryIndexProvider indexProvider;
+
+    /**
+     * Whether fallback to the traversing index is supported if no other index
+     * is available. This is enabled by default and can be disabled for testing
+     * purposes.
+     */
+    private boolean traversalFallback = true;
+
     private OrderingImpl[] orderings;
     private ColumnImpl[] columns;
     private boolean explain, measure;
@@ -581,13 +588,38 @@ public class QueryImpl implements Query {
     }
 
     @Override
-    public void setIndexProvider(QueryIndexProvider indexProvider) {
-        this.indexProvider = indexProvider;
+    public void setTraversalFallback(boolean traversal) {
+        this.traversalFallback = traversal;
     }
 
     public QueryIndex getBestIndex(Filter filter) {
-        return QueryEngineImpl.getBestIndex(context.getRootState(), filter,
-                indexProvider);
+        return getBestIndex(context.getRootState(), filter,
+                context.getIndexProvider(), traversalFallback);
+    }
+
+    private static QueryIndex getBestIndex(NodeState rootState, Filter filter,
+            QueryIndexProvider indexProvider, boolean traversalFallback) {
+        QueryIndex best = null;
+        if (LOG.isDebugEnabled()) {
+            LOG.debug("cost using filter " + filter);
+        }
+
+        double bestCost = Double.POSITIVE_INFINITY;
+        for (QueryIndex index : indexProvider.getQueryIndexes(rootState)) {
+            double cost = index.getCost(filter, rootState);
+            if (LOG.isDebugEnabled()) {
+                LOG.debug("cost for " + index.getIndexName() + " is " + cost);
+            }
+            if (cost < bestCost) {
+                bestCost = cost;
+                best = index;
+            }
+        }
+
+        if (bestCost == Double.POSITIVE_INFINITY && traversalFallback) {
+            best = new TraversingIndex();
+        }
+        return best;
     }
 
     @Override
diff --git a/oak-core/src/main/java/org/apache/jackrabbit/oak/query/UnionQueryImpl.java b/oak-core/src/main/java/org/apache/jackrabbit/oak/query/UnionQueryImpl.java
index e46dd5869e..5428646ca0 100644
--- a/oak-core/src/main/java/org/apache/jackrabbit/oak/query/UnionQueryImpl.java
+++ b/oak-core/src/main/java/org/apache/jackrabbit/oak/query/UnionQueryImpl.java
@@ -27,7 +27,6 @@ import org.apache.jackrabbit.oak.namepath.NamePathMapper;
 import org.apache.jackrabbit.oak.query.ast.ColumnImpl;
 import org.apache.jackrabbit.oak.query.ast.OrderingImpl;
 import org.apache.jackrabbit.oak.spi.query.PropertyValues;
-import org.apache.jackrabbit.oak.spi.query.QueryIndexProvider;
 import org.slf4j.Logger;
 import org.slf4j.LoggerFactory;
 
@@ -104,9 +103,9 @@ public class UnionQueryImpl implements Query {
     }
 
     @Override
-    public void setIndexProvider(QueryIndexProvider indexProvider) {
-        left.setIndexProvider(indexProvider);
-        right.setIndexProvider(indexProvider);
+    public void setTraversalFallback(boolean traversal) {
+        left.setTraversalFallback(traversal);
+        right.setTraversalFallback(traversal);
     }
 
     @Override
