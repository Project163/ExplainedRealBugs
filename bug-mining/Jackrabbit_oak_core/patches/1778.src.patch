diff --git a/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/migration/AbstractDecoratedNodeState.java b/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/migration/AbstractDecoratedNodeState.java
index f39032321b..936aef02e5 100644
--- a/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/migration/AbstractDecoratedNodeState.java
+++ b/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/migration/AbstractDecoratedNodeState.java
@@ -37,6 +37,8 @@ import javax.annotation.Nullable;
 import java.util.ArrayList;
 import java.util.Collection;
 import java.util.Collections;
+import java.util.HashSet;
+import java.util.Set;
 
 import static com.google.common.base.Predicates.notNull;
 import static org.apache.jackrabbit.oak.plugins.tree.TreeConstants.OAK_CHILD_ORDER;
@@ -45,8 +47,11 @@ public abstract class AbstractDecoratedNodeState extends AbstractNodeState {
 
     protected final NodeState delegate;
 
-    protected AbstractDecoratedNodeState(@Nonnull final NodeState delegate) {
+    private final boolean useNativeEquals;
+
+    protected AbstractDecoratedNodeState(@Nonnull final NodeState delegate, boolean useNativeEquals) {
         this.delegate = delegate;
+        this.useNativeEquals = useNativeEquals;
     }
 
     public NodeState getDelegate() {
@@ -198,21 +203,57 @@ public abstract class AbstractDecoratedNodeState extends AbstractNodeState {
      */
     @Override
     public boolean equals(final Object other) {
-        if (other == null) {
+        if (!(other instanceof NodeState)) {
             return false;
         }
 
-        if (this.getClass() == other.getClass()) {
-            final AbstractDecoratedNodeState o = (AbstractDecoratedNodeState) other;
-            return delegate.equals(o.delegate);
+        if (useNativeEquals) {
+            if (this.getClass() == other.getClass()) {
+                final AbstractDecoratedNodeState o = (AbstractDecoratedNodeState) other;
+                return delegate.equals(o.delegate);
+            }
         }
 
-        return delegate.equals(other);
+        return AbstractDecoratedNodeState.equals(this, (NodeState) other);
     }
 
     @Override
     public boolean compareAgainstBaseState(final NodeState base, final NodeStateDiff diff) {
-        return AbstractNodeState.compareAgainstBaseState(this, base, new DecoratingDiff(diff, this));
+        NodeStateDiff decoratingDiff = new DecoratingDiff(diff, this);
+
+        if (!comparePropertiesAgainstBaseState(this, base, decoratingDiff)) {
+            return false;
+        }
+
+        Set<String> baseChildNodes = new HashSet<String>();
+        for (ChildNodeEntry beforeCNE : base.getChildNodeEntries()) {
+            String name = beforeCNE.getName();
+            NodeState beforeChild = beforeCNE.getNodeState();
+            NodeState afterChild = this.getChildNode(name);
+            if (!afterChild.exists()) {
+                if (!decoratingDiff.childNodeDeleted(name, beforeChild)) {
+                    return false;
+                }
+            } else {
+                baseChildNodes.add(name);
+                if (!afterChild.equals(beforeChild)) { // TODO: fastEquals?
+                    if (!decoratingDiff.childNodeChanged(name, beforeChild, afterChild)) {
+                        return false;
+                    }
+                }
+            }
+        }
+
+        for (ChildNodeEntry afterChild : this.getChildNodeEntries()) {
+            String name = afterChild.getName();
+            if (!baseChildNodes.contains(name)) {
+                if (!decoratingDiff.childNodeAdded(name, afterChild.getNodeState())) {
+                    return false;
+                }
+            }
+        }
+
+        return true;
     }
 
     private static class DecoratingDiff implements NodeStateDiff {
diff --git a/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/migration/FilteringNodeState.java b/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/migration/FilteringNodeState.java
index fe9b74c053..4b8ed16504 100644
--- a/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/migration/FilteringNodeState.java
+++ b/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/migration/FilteringNodeState.java
@@ -110,7 +110,7 @@ public class FilteringNodeState extends AbstractDecoratedNodeState {
             @Nonnull final Set<String> fragmentPaths,
             @Nonnull final Set<String> excludedFragments
     ) {
-        super(delegate);
+        super(delegate, false);
         this.path = path;
         this.includedPaths = includedPaths;
         this.excludedPaths = excludedPaths;
diff --git a/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/migration/report/ReportingNodeState.java b/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/migration/report/ReportingNodeState.java
index af3312f67b..050844238b 100644
--- a/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/migration/report/ReportingNodeState.java
+++ b/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/migration/report/ReportingNodeState.java
@@ -77,7 +77,7 @@ public class ReportingNodeState extends AbstractDecoratedNodeState {
     }
 
     private ReportingNodeState(ReportingNodeState parent, String name, NodeState delegate, Reporter reporter) {
-        super(delegate);
+        super(delegate, true);
         this.parent = parent;
         this.name = name;
         this.reporter = reporter;
