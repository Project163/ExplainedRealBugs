{"url":"https://api.github.com/repos/smartrics/RestFixture/issues/1","repository_url":"https://api.github.com/repos/smartrics/RestFixture","labels_url":"https://api.github.com/repos/smartrics/RestFixture/issues/1/labels{/name}","comments_url":"https://api.github.com/repos/smartrics/RestFixture/issues/1/comments","events_url":"https://api.github.com/repos/smartrics/RestFixture/issues/1/events","html_url":"https://github.com/smartrics/RestFixture/issues/1","id":738402,"node_id":"MDU6SXNzdWU3Mzg0MDI=","number":1,"title":"Regex Support In JSONBodyTypeAdapter","user":{"login":"naglafar","id":713403,"node_id":"MDQ6VXNlcjcxMzQwMw==","avatar_url":"https://avatars.githubusercontent.com/u/713403?v=4","gravatar_id":"","url":"https://api.github.com/users/naglafar","html_url":"https://github.com/naglafar","followers_url":"https://api.github.com/users/naglafar/followers","following_url":"https://api.github.com/users/naglafar/following{/other_user}","gists_url":"https://api.github.com/users/naglafar/gists{/gist_id}","starred_url":"https://api.github.com/users/naglafar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/naglafar/subscriptions","organizations_url":"https://api.github.com/users/naglafar/orgs","repos_url":"https://api.github.com/users/naglafar/repos","events_url":"https://api.github.com/users/naglafar/events{/privacy}","received_events_url":"https://api.github.com/users/naglafar/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2011-04-06T16:08:09Z","updated_at":"2014-04-02T11:35:03Z","closed_at":"2011-04-07T00:17:31Z","author_association":"NONE","active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Yo,\n\nIve modified your JSONBodyTypeAdapter to allow regex support if the keyword 'REGEX:' is inserted into the expected column for the fixture. Created a few tests too for it.\n\nthough you might want to add this feature as the xpath evaluation doesn't work for complicated json strings at all. \n\nSo the workings are if in the expected string the prefix 'REGEX:' is used them the regex evaluator is invoked otherwise xpath is invoked. \n\nJSONBodyTypeAdapter.java:\n /\\*  Copyright 2008 Fabrizio Cannizzo\n *\n-  This file is part of RestFixture.\n  *\n-  RestFixture (http://code.google.com/p/rest-fixture/) is free software:\n-  you can redistribute it and/or modify it under the terms of the\n-  GNU Lesser General Public License as published by the Free Software Foundation,\n-  either version 3 of the License, or (at your option) any later version.\n  *\n-  RestFixture is distributed in the hope that it will be useful,\n-  but WITHOUT ANY WARRANTY; without even the implied warranty of\n-  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n-  GNU Lesser General Public License for more details.\n  *\n-  You should have received a copy of the GNU Lesser General Public License\n-  along with RestFixture.  If not, see http://www.gnu.org/licenses/.\n  *\n-  If you want to contact the author please leave a comment here\n-  http://smartrics.blogspot.com/2008/08/get-fitnesse-with-some-rest.html\n  */\n  package smartrics.rest.fitnesse.fixture.support;\n\nimport java.util.List;\n\npublic class JSONBodyTypeAdapter extends XPathBodyTypeAdapter {\n\n```\n@Override\nprotected boolean eval(String expr, String json) {\n    String xml = Tools.fromJSONtoXML(json);\n    return super.eval(expr, xml);\n}\n\n@Override\npublic String toString(Object obj) {\n    if (obj == null || obj.toString().trim().equals(\"\"))\n        return \"no-body\";\n    // the actual value is passed as an xml string\n    // todo: pretty print?\n    return Tools.toJSON(obj.toString());\n}\n\n@Override\npublic String toXmlString(String content) {\n    return Tools.fromJSONtoXML(content);\n}\n\n@Override\npublic boolean equals(Object expected, Object actual) {\n    if (checkNoBody(expected)) {\n        return checkNoBody(actual);\n    }\n    if (checkNoBody(actual)) {\n        return checkNoBody(expected);\n    }\n\n    @SuppressWarnings(\"unchecked\")\n    List<String> expressions = (List<String>) expected;\n    for (String expr : expressions) {\n\n        if (expr != null && expr.substring(0, 6).equals(\"REGEX:\")) {\n            boolean b = evalRegex(expr, actual.toString());\n            if (!b) {\n                addError(\"REGEX failed match '\" + expr.substring(6) + \"'\");\n            }\n        } else {\n            try {\n                boolean b = eval(expr, actual.toString());\n                if (!b) {\n                    addError(\"not found: '\" + expr + \"'\");\n                }\n            } catch (Exception e) {\n                throw new IllegalArgumentException(\"Cannot extract xpath '\"\n                        + expr + \"' from document \" + actual.toString(), e);\n            }\n        }\n    }\n    return getErrors().size() == 0;\n}\n\nprivate boolean evalRegex(String expr, String actual) { \n    String regex = expr.substring(6);       \n    return actual.matches(regex);\n}\n```\n\n}\n\nJSONBodyTypeAdapterTest.java\n\n/\\*  Copyright 2008 Andrew Ochsner and Fabrizio Cannizzo\n *\n-  This file is part of RestFixture.\n  *\n-  RestFixture (http://code.google.com/p/rest-fixture/) is free software:\n-  you can redistribute it and/or modify it under the terms of the\n-  GNU Lesser General Public License as published by the Free Software Foundation,\n-  either version 3 of the License, or (at your option) any later version.\n  *\n-  RestFixture is distributed in the hope that it will be useful,\n-  but WITHOUT ANY WARRANTY; without even the implied warranty of\n-  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n-  GNU Lesser General Public License for more details.\n  *\n-  You should have received a copy of the GNU Lesser General Public License\n-  along with RestFixture.  If not, see http://www.gnu.org/licenses/.\n  *\n-  If you want to contact the author please leave a comment here\n-  http://smartrics.blogspot.com/2008/08/get-fitnesse-with-some-rest.html\n  */\n  package smartrics.rest.fitnesse.fixture.support;\n\nimport static org.junit.Assert.assertEquals;\nimport static org.junit.Assert.assertFalse;\nimport static org.junit.Assert.assertTrue;\nimport static org.junit.Assert.fail;\n\nimport java.util.Arrays;\nimport java.util.List;\nimport java.util.Vector;\n\nimport org.junit.Test;\n\npublic class JSONBodyTypeAdapterTest {\n    private final BodyTypeAdapter adapter = new JSONBodyTypeAdapter();\n    private final static String json0 = \"{\\\"a\\\": { b: [\\\"12\\\",\\\"23\\\"], \\\"c\\\": \\\"XY\\\" } }\";\n    private final static String json1 = \"{\\\"a\\\": \\\" 1&\\\"}\";\n    private final static List<String> xPaths = Arrays.asList(\"/a\", \"//b\");\n    private final static String xPathsAsString = \"/a<br/>//b\";\n    private final static String complicatedJson =   \"{\\\"response\\\":{\\\"metaData\\\":{\\\"resultsAvailable\\\":1,\\\"resultsReturned\\\":1, \\\"firstResult\\\":1,\\\"lastResult\\\":1,\\\"columns\\\":[{\\\"name\\\":\\\"productId\\\", \\\"sortable\\\":true,\\\"filterable\\\":true,\\\"groupable\\\":false, \\\"reportDataType\\\":\\\"INTEGER\\\",\\\"referenceData\\\":[\\\"productNames\\\", \\\"productSkus\\\",\\\"productOptionsValueList\\\"],\\\"excludeFromQuery\\\": false,\\\"required\\\":false},{\\\"name\\\":\\\"warehouseId\\\",\\\"sortable\\\":true, \\\"filterable\\\":true,\\\"groupable\\\":false,\\\"reportDataType\\\":\\\"INTEGER\\\", \\\"referenceData\\\":[\\\"warehouseNames\\\"],\\\"excludeFromQuery\\\":false, \\\"required\\\":false},{\\\"name\\\":\\\"currencyCode\\\",\\\"sortable\\\":false, \\\"filterable\\\":false,\\\"groupable\\\":false,\\\"reportDataType\\\":\\\"STRING\\\", \\\"excludeFromQuery\\\":false,\\\"required\\\":false},{\\\"name\\\":\\\"price\\\", \\\"sortable\\\":true,\\\"filterable\\\":false,\\\"groupable\\\":false, \\\"reportDataType\\\":\\\"STRING\\\",\\\"excludeFromQuery\\\":false,\\\"required\\\": false},{\\\"name\\\":\\\"quantity\\\",\\\"sortable\\\":true,\\\"filterable\\\":false, \\\"groupable\\\":false,\\\"reportDataType\\\":\\\"INTEGER\\\",\\\"excludeFromQuery\\\": false,\\\"required\\\":false}],\\\"sorting\\\":[{\\\"filterable\\\":{\\\"name\\\":\\\"sku\\\", \\\"reportDataType\\\":\\\"SEARCH_STRING\\\",\\\"sortable\\\":true,\\\"required\\\": false},\\\"direction\\\":\\\"ASC\\\"}]},\\\"results\\\":[[1002,3,\\\"GBP\\\",\\\"10.5000\\\", 10]]},\\\"reference\\\":{\\\"warehouseNames\\\":{\\\"3\\\":\\\"New Warehouse\\\"}, \\\"productNames\\\":{\\\"1002\\\":\\\"Labour time\\\"},\\\"productSkus\\\":{\\\"1002\\\":\\\"\\\"}, \\\"productOptionsValueList\\\":{}}}\";\n\n```\n@Test\npublic void shouldIdentifyContentObjectsWithNoBodyAsBeingEqual() {\n    assertTrue(adapter.equals(\"no-body\", \"no-body\"));\n    assertTrue(adapter.equals(\"no-body\", \"\"));\n    assertTrue(adapter.equals(\"no-body\", null));\n    assertFalse(adapter.equals(\"/a\", null));\n    assertFalse(adapter.equals(\"no-body\", json0));\n}\n\n@Test\npublic void shouldIdentifyAsEqualsIfExpectedObjectIsAListOfXPathsAvailableInActual() {\n    assertTrue(\"not found simple nodelist xpath\", adapter.equals(Arrays.asList(\"/a/b[text()='12']\"), json0));\n    assertTrue(\"not found two nodelist xpaths\", adapter.equals(Arrays.asList(\"/a/b[text()='12']\", \"/a/c[text()='XY']\"), json0));\n    assertTrue(\"not found two boolean xpath\", adapter.equals(Arrays.asList(\"count(/a/b)=2\", \"count(/a/c)=1\"), json0));\n    assertTrue(\"not found two boolean xpath and two nodelist xpaths\",\n            adapter.equals(Arrays.asList(\"count(/a/b)=2\", \"count(/a/c)=1\", \"/a/b[text()='12']\", \"/a/c[text()='XY']\"), json0));\n}\n\n@Test\npublic void shouldStoreNotFoundMessageForEveryExpressionNotFoundForEqualityCheck() {\n    assertFalse(adapter.equals(Arrays.asList(\"/a/b[text()='zzz']\", \"/a/d[text()='next']\", \"/a/c[text()='XY']\"), json0));\n    assertEquals(2, adapter.getErrors().size());\n    assertEquals(\"not found: '/a/b[text()='zzz']'\", adapter.getErrors().get(0));\n    assertEquals(\"not found: '/a/d[text()='next']'\", adapter.getErrors().get(1));\n}\n\n@Test(expected = IllegalArgumentException.class)\npublic void shouldFailEqualityCheckIfAnyExpressionIsInvalid() {\n    adapter.equals(Arrays.asList(\"invalid xpath\", \"/a/c[text()='XY']\"), json0);\n}\n\n@Test\npublic void shouldReturnItsStringRepresentationAsPrintableHTML() {\n    assertEquals(json1, adapter.toString(json1));\n}\n\n@Test\npublic void shouldReturnItsStringRepresentationAsPrintableHTMLEvenWhenEmpty() {\n    assertEquals(\"no-body\", adapter.toString(\"\"));\n}\n\n@Test\npublic void shoudlParseStringWithXPathInHtmlIntoAProperList() {\n    try {\n        // just make sure we have the right fata\n        assertTrue(xPathsAsString.indexOf(\"<br/>\") > -1);\n        assertEquals(xPaths, adapter.parse(xPathsAsString));\n    } catch (Exception e) {\n        fail(\"should have not raised an exception\");\n    }\n}\n\n@Test\npublic void shoudlParseNoJsonIntoAnEmptyList() {\n    try {\n        // just make sure we have the right fata\n        assertEquals(new Vector<String>(), adapter.parse(null));\n        assertEquals(new Vector<String>(), adapter.parse(\"no-body\"));\n        assertEquals(new Vector<String>(), adapter.parse(\"\"));\n    } catch (Exception e) {\n        fail(\"should have not raised an exception\");\n    }\n}\n\n@Test\npublic void regexTests(){\n     assertTrue(\"REGEX shoudld match\", adapter.equals(Arrays.asList(\"REGEX:(.)*(results\\\":\\\\[\\\\[1002,3,\\\"GBP\\\",\\\"10.5000\\\", 10\\\\]\\\\])+(.)*\"), complicatedJson));\n     assertFalse(\"REGEX shouldn't match\",adapter.equals(Arrays.asList(\"REGEX:[^/]*ATOTALLOADOFRUBISHWICHISN'TINJSONSTRING[.]*\"), complicatedJson));\n}\n```\n\n}\n","closed_by":{"login":"smartrics","id":140858,"node_id":"MDQ6VXNlcjE0MDg1OA==","avatar_url":"https://avatars.githubusercontent.com/u/140858?v=4","gravatar_id":"","url":"https://api.github.com/users/smartrics","html_url":"https://github.com/smartrics","followers_url":"https://api.github.com/users/smartrics/followers","following_url":"https://api.github.com/users/smartrics/following{/other_user}","gists_url":"https://api.github.com/users/smartrics/gists{/gist_id}","starred_url":"https://api.github.com/users/smartrics/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/smartrics/subscriptions","organizations_url":"https://api.github.com/users/smartrics/orgs","repos_url":"https://api.github.com/users/smartrics/repos","events_url":"https://api.github.com/users/smartrics/events{/privacy}","received_events_url":"https://api.github.com/users/smartrics/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/smartrics/RestFixture/issues/1/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/smartrics/RestFixture/issues/1/timeline","performed_via_github_app":null,"state_reason":"completed"}