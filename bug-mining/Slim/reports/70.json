{"url":"https://api.github.com/repos/slimphp/Slim/issues/2005","repository_url":"https://api.github.com/repos/slimphp/Slim","labels_url":"https://api.github.com/repos/slimphp/Slim/issues/2005/labels{/name}","comments_url":"https://api.github.com/repos/slimphp/Slim/issues/2005/comments","events_url":"https://api.github.com/repos/slimphp/Slim/issues/2005/events","html_url":"https://github.com/slimphp/Slim/issues/2005","id":180715125,"node_id":"MDU6SXNzdWUxODA3MTUxMjU=","number":2005,"title":"HTTP method outside whitelist causes 500","user":{"login":"iansltx","id":472804,"node_id":"MDQ6VXNlcjQ3MjgwNA==","avatar_url":"https://avatars.githubusercontent.com/u/472804?v=4","gravatar_id":"","url":"https://api.github.com/users/iansltx","html_url":"https://github.com/iansltx","followers_url":"https://api.github.com/users/iansltx/followers","following_url":"https://api.github.com/users/iansltx/following{/other_user}","gists_url":"https://api.github.com/users/iansltx/gists{/gist_id}","starred_url":"https://api.github.com/users/iansltx/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/iansltx/subscriptions","organizations_url":"https://api.github.com/users/iansltx/orgs","repos_url":"https://api.github.com/users/iansltx/repos","events_url":"https://api.github.com/users/iansltx/events{/privacy}","received_events_url":"https://api.github.com/users/iansltx/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":15,"created_at":"2016-10-03T18:45:06Z","updated_at":"2017-02-06T09:00:45Z","closed_at":"2017-02-06T08:34:55Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"# (picking up from the Slack discussion earlier)\n\nIf an incoming HTTP request has a verb other than something in Request::$validMethods (e.g. LINK/UNLINK...or CHECKIN...or CHICKEN), Request::filterMethod() throws an InvalidArgumentException on request create from env (which happens on App::run()). This isn't caught anywhere, so it bubbles up to a 500. This happens both with and without a route declared for that URL, that method (yep, the router will let you match on CHICKEN), or neither/both.\n\nBy contrast, a verb in $validMethods, but unassigned for a route, will call the notAllowedHandler, which seems like the more proper way of handling the above. Likewise, if you don't have a route for that verb, probably better to call notFoundHandler.\n\nThere are a couple catches here:\n1. notAllowedHandler assumes you've matched with a route before calling. Which needs a request. The only way I can think of to handle this properly is to set up an exception that builds the request anyway, then throws something that extends \\InvalidArgumentException and includes the request along with it. That gets thrown into the router, then we decide how to treat the error (we'll always be erroring out) based on what the router gives us back. A little convoluted, but should give us the behavior we're looking for.\n2. The router doesn't enforce the allowed methods array at all, so if we take the above fix then we'll end up with an even more confusing error message (LINK not allowed, please use one of [GET, PUT, POST, LINK]) if someone matches to an unsupported verb. So we'd want to tweak the router to throw an InvalidArgumentException (which _should_ throw us into a 500) when someone throws a verb in there that doesn't make sense.\n\nDoes the above concern make sense to someone other than me, and do the miticgations I'm suggesting also make sense? Maybe fully supporting this corner case at the cost of N operations per verb per route match() call doesn't make sense perf-wise, but I'd argue that having a really easy way to make a Slim app 500 is odd too.\n\nIf everything makes sense, thumbs-up this and I'll work on a PR.\n","closed_by":{"login":"akrabat","id":33135,"node_id":"MDQ6VXNlcjMzMTM1","avatar_url":"https://avatars.githubusercontent.com/u/33135?v=4","gravatar_id":"","url":"https://api.github.com/users/akrabat","html_url":"https://github.com/akrabat","followers_url":"https://api.github.com/users/akrabat/followers","following_url":"https://api.github.com/users/akrabat/following{/other_user}","gists_url":"https://api.github.com/users/akrabat/gists{/gist_id}","starred_url":"https://api.github.com/users/akrabat/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/akrabat/subscriptions","organizations_url":"https://api.github.com/users/akrabat/orgs","repos_url":"https://api.github.com/users/akrabat/repos","events_url":"https://api.github.com/users/akrabat/events{/privacy}","received_events_url":"https://api.github.com/users/akrabat/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/slimphp/Slim/issues/2005/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/slimphp/Slim/issues/2005/timeline","performed_via_github_app":null,"state_reason":"completed"}