<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:31:20 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[IMAGING-319] updateExifMetadataLossless lost the first character of a String</title>
                <link>https://issues.apache.org/jira/browse/IMAGING-319</link>
                <project id="12313421" key="IMAGING">Commons Imaging</project>
                    <description>&lt;p&gt;I try to use TiffOutputSet to generate a new image. However, if a tag that contains String, the program may miss the first character of the String.&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;package org.apache.commons.imaging;

import org.apache.commons.imaging.common.ImageMetadata;
import org.apache.commons.imaging.formats.jpeg.JpegImageMetadata;
import org.apache.commons.imaging.formats.jpeg.exif.ExifRewriter;
import org.apache.commons.imaging.formats.tiff.TiffImageMetadata;
import org.apache.commons.imaging.formats.tiff.write.TiffOutputSet;

import java.io.BufferedOutputStream;
import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;

public class LibraryTest {

    public static void main(String[] args) throws ImagingException, IOException {
        File source = new File(&quot;/home/kinow/Desktop/iPhone12-geotag.JPG&quot;);
        File result = new File(&quot;/home/kinow/Desktop/editted-iPhone12-geotag.JPG&quot;);
        final ImageMetadata metadata = Imaging.getMetadata(source);
        final JpegImageMetadata jpegMetadata = (JpegImageMetadata) metadata;
        final TiffImageMetadata exif = jpegMetadata.getExif();
        TiffOutputSet outputSet = exif.getOutputSet();
        BufferedOutputStream bufferedOutputStream = new BufferedOutputStream(new FileOutputStream(result));
        new ExifRewriter().updateExifMetadataLossless(source, bufferedOutputStream, outputSet);
    }
}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This is the sample code.&lt;/p&gt;

&lt;p&gt;Tag value in original image&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://issues.apache.org/jira/images/icons/attach/noimage.png&quot; imagetext=&quot;image-2021-11-26-16-01-58-645.png&quot; align=&quot;absmiddle&quot; border=&quot;0&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Tag value in output image&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://issues.apache.org/jira/images/icons/attach/noimage.png&quot; imagetext=&quot;image-2021-11-26-16-04-12-185.png&quot; align=&quot;absmiddle&quot; border=&quot;0&quot; /&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13414056">IMAGING-319</key>
            <summary>updateExifMetadataLossless lost the first character of a String</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kinow">Bruno P. Kinoshita</assignee>
                                    <reporter username="yangsicheng">Sicheng Yang</reporter>
                        <labels>
                    </labels>
                <created>Fri, 26 Nov 2021 22:05:14 +0000</created>
                <updated>Tue, 1 Oct 2024 21:34:23 +0000</updated>
                            <resolved>Sat, 13 Apr 2024 23:24:07 +0000</resolved>
                                    <version>1.0-alpha2</version>
                                    <fixVersion>1.0.0-alpha5</fixVersion>
                                    <component>Format: JPEG</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>5</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="2400">40m</timespent>
                                <comments>
                            <comment id="17490983" author="gwlucas" created="Fri, 11 Feb 2022 15:30:19 +0000"  >&lt;p&gt;I haven&apos;t figured this out yet, but I&apos;ve narrowed down the cause to TiffImageWriterLossless.&#160; There is a method that attempts to update the file positions (offsets) of the various EXIF tags.&#160; &#160;It&apos;s called updateOffsetsSteps().&lt;/p&gt;

&lt;p&gt;The code is very confusing.&#160; As far as I can tell, at some point some of the space in the output file is determined to be &quot;unused&quot; and updateOffsetSteps() attempts to reuse it by finding available space and setting the tag output position to the available space.&#160; If you bypass this operation by adding a diagnostic call to&#160; unusedElements.clear() right after the unusedElements list is established, everything works fine.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17491005" author="gwlucas" created="Fri, 11 Feb 2022 16:02:13 +0000"  >&lt;p&gt;Okay, found it.&lt;/p&gt;

&lt;p&gt;In the code below, the method looped through all the available free elements and found one it calls &quot;bestFit&quot;.&#160; It is going to store the new data into the available space.&#160; But TIFF files have a rule that the offsets have to be an even multiple of 2.&#160; So there&apos;s a check to see if the offset is odd and, if it is, the code advances the offset forward one.&#160; The problem is that it doesn&apos;t recognize that by advancing the offset, it&apos;s reduced the amount of available space (bestFit.length).&#160; So, the &quot;excessLength&quot; computation below will be incorrect.&#160; If some subsequent element is an exact match for the incorrect excessLength value, it will overwrite the unused space and clobber whatever follows.&#160; &#160;In this case, the thing that got clobbered was the first byte of EXIF tag 0x9010.&lt;/p&gt;

&lt;p&gt;The probability of this happening is small, but non-zero.&#160; It is just luck that Sicheng Yang&apos;s data sample triggered the issue.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
                &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; offset = bestFit.offset;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; ((offset &amp;amp; 1L) != 0) {
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; offset += 1;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; }
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; outputItem.setOffset(offset);
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; unusedElements.remove(bestFit);

&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (bestFit.length &amp;gt; outputItemLength) {
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// not a perfect fit.
&lt;/span&gt;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; excessOffset = bestFit.offset + outputItemLength;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; excessLength = bestFit.length - outputItemLength;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; unusedElements.add(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TiffElement.Stub(excessOffset,
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; excessLength));
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// make sure the &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; element is in the correct order.
&lt;/span&gt;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; unusedElements.sort(ELEMENT_SIZE_COMPARATOR);
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; Collections.reverse(unusedElements);
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; }

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160; &#160;&lt;br/&gt;
I re-wrote the code as follows.&#160; It works.&#160; Writing a JUnit test for this is going to be extremely difficult unless we want to include the large test file in our code distribution (which I think would be a bad idea).&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; offset = bestFit.offset;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; length = bestFit.length;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; ((offset &amp;amp; 1L) != 0) {
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// offsets have to be at a multiple of 2
&lt;/span&gt;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; offset += 1;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; length -=1;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; }
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; outputItem.setOffset(offset);
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; unusedElements.remove(bestFit);

&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (length &amp;gt; outputItemLength) {
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// not a perfect fit.
&lt;/span&gt;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; excessOffset = offset + outputItemLength;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; excessLength = length - outputItemLength;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; unusedElements.add(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TiffElement.Stub(excessOffset,
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; excessLength));
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// make sure the &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; element is in the correct order.
&lt;/span&gt;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; unusedElements.sort(ELEMENT_SIZE_COMPARATOR);
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; Collections.reverse(unusedElements);
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17720690" author="garydgregory" created="Mon, 8 May 2023 22:18:13 +0000"  >&lt;p&gt;Unit test &lt;a href=&quot;https://github.com/apache/commons-imaging/pull/275&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/commons-imaging/pull/275&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17720695" author="garydgregory" created="Mon, 8 May 2023 22:24:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gwlucas&quot; class=&quot;user-hover&quot; rel=&quot;gwlucas&quot;&gt;gwlucas&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;Would you please try &lt;tt&gt;org.apache.commons.imaging.formats.jpeg.exif.ExifRewriterRoundtripTest&lt;/tt&gt; with your fix? It does not pass for me. Either I applied the fix incorrectly, the fix is incomplete, or the test is wrong.&lt;/p&gt;</comment>
                            <comment id="17720904" author="gwlucas" created="Tue, 9 May 2023 11:44:09 +0000"  >&lt;p&gt;I will take a look.  I&apos;ve been away from Commons Imaging for awhile, so it&apos;s going to take some time to get set up again.&lt;/p&gt;

&lt;p&gt;As I recall, the code fix worked for the sample submitted by the original author.  Perhaps something has shifted in the code base since then.   I&apos;ll also look at pull 275.&lt;/p&gt;

&lt;p&gt;If you have any recommendations, please let me know.&lt;/p&gt;</comment>
                            <comment id="17720910" author="garydgregory" created="Tue, 9 May 2023 11:58:40 +0000"  >&lt;p&gt;I pulled in the unit test from the PR and annotated it with &amp;#64;Disabled.&lt;/p&gt;</comment>
                            <comment id="17724572" author="gwlucas" created="Sun, 21 May 2023 00:16:16 +0000"  >&lt;p&gt;I am looking at this now.  One thing I&apos;ve noticed is that the code contains a block described as &quot;search for the smallest possible element large enough to hold the item&quot;.   But it is actually a &quot;first-fit&quot; approach rather than a &quot;best-fit&quot; approach.   Does anyone see a motivation for refactoring this to actually use a best-fit criteria?  Or should I just correct the comments?  I seem to recall, from a long time ago, reading an article that claimed that malloc() uses a first-fit approach because best-fit leads to fragmented memory... but I don&apos;t recall any kind of proof or analysis for that claim.&lt;/p&gt;

&lt;p&gt;Here&apos;s the code in question.  It starts at line 194 of TiffImageWriterLossless.java&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
      &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; TiffOutputItem outputItem = unplacedItems.remove(0);
            &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; outputItemLength = outputItem.getItemLength();
            &lt;span class=&quot;code-comment&quot;&gt;// search &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the smallest possible element large enough to hold the
&lt;/span&gt;            &lt;span class=&quot;code-comment&quot;&gt;// item.
&lt;/span&gt;            TiffElement bestFit = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
            &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; TiffElement element : unusedElements) {
                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (element.length &amp;lt; outputItemLength) {
                    &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
                }
                bestFit = element;
            }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17724573" author="garydgregory" created="Sun, 21 May 2023 00:42:56 +0000"  >&lt;p&gt;I&apos;d say do what you think is best since you know the code better.&lt;/p&gt;</comment>
                            <comment id="17724579" author="gwlucas" created="Sun, 21 May 2023 01:59:16 +0000"  >&lt;p&gt;On further review, it appears that the section of the code that looks for best-fit is actually correct...&#160; It&apos;s just confusing.&#160; So I will be adding comments to clarify what it does.&#160;&lt;/p&gt;

&lt;p&gt;The reason that it works is that the unclaimed-memory elements are kept in sorted order, from largest to smallest.&lt;/p&gt;

&lt;p&gt;However, the logic related to the element length is still wrong.&#160; I am implementing a fix and will activate thr JUnit test ExifRewriterRoundtripTest once I get things working.&lt;/p&gt;</comment>
                            <comment id="17724643" author="garydgregory" created="Sun, 21 May 2023 12:30:38 +0000"  >&lt;p&gt;&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/thumbs_up.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="17771983" author="JIRAUSER280851" created="Wed, 4 Oct 2023 20:13:15 +0000"  >&lt;p&gt;It is glad to see that the bug is fixed. I really appreciate that my effort is noticed. You guys debug process also benefits me a lot. Have a nice day!&lt;/p&gt;</comment>
                            <comment id="17832282" author="JIRAUSER303312" created="Fri, 29 Mar 2024 18:21:42 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yangsicheng&quot; class=&quot;user-hover&quot; rel=&quot;yangsicheng&quot;&gt;yangsicheng&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;we have a fix for the problem, but we haven&apos;t it commited to the sources as we lack a test image for the unit tests.&lt;/p&gt;

&lt;p&gt;Is the image you attached to this ticket yours? Do you own the rights to it? If so, would you allow us to add it to the projects sources (for unit tests) under Apache 2 license?&lt;/p&gt;

&lt;p&gt;@&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kinow&quot; class=&quot;user-hover&quot; rel=&quot;kinow&quot;&gt;kinow&lt;/a&gt; FYI&lt;/p&gt;</comment>
                            <comment id="17836844" author="kinow" created="Sat, 13 Apr 2024 18:05:54 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yangsicheng&quot; class=&quot;user-hover&quot; rel=&quot;yangsicheng&quot;&gt;yangsicheng&lt;/a&gt; , your code and instructions were very clear, thank you very much.&lt;/p&gt;

&lt;p&gt;I followed the instructions (updated code example with `noformat` for JIRA) and then used `exiftool` + `diff`:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;kinow@ranma:~/Desktop$ diff &amp;lt;(exiftool --dump iPhone12-geotag.JPG) &amp;lt;(exiftool editted-iPhone12-geotag.JPG)
2c2
&amp;lt; File Name &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; : iPhone12-geotag.JPG
---
&amp;gt; File Name &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; : editted-iPhone12-geotag.JPG
5,7c5,7
&amp;lt; File Modification Date/Time &#160; &#160; : 2024:04:13 19:45:28+02:00
&amp;lt; File Access Date/Time &#160; &#160; &#160; &#160; &#160; : 2024:04:13 19:46:21+02:00
&amp;lt; File Inode Change Date/Time &#160; &#160; : 2024:04:13 19:45:28+02:00
---
&amp;gt; File Modification Date/Time &#160; &#160; : 2024:04:13 19:57:02+02:00
&amp;gt; File Access Date/Time &#160; &#160; &#160; &#160; &#160; : 2024:04:13 19:57:02+02:00
&amp;gt; File Inode Change Date/Time &#160; &#160; : 2024:04:13 19:57:02+02:00
77c77
&amp;lt; Thumbnail Offset &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;: 2642
---
&amp;gt; Thumbnail Offset &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;: 2192 &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;So the offset field is really incorrect (as pointed in earlier comments). I&apos;m slowly trying to understand what&apos;s happening here, while reviewing the PR &lt;a href=&quot;https://github.com/apache/commons-imaging/pull/359&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/commons-imaging/pull/359&lt;/a&gt; too.&lt;/p&gt;</comment>
                            <comment id="17836846" author="kinow" created="Sat, 13 Apr 2024 18:53:57 +0000"  >&lt;p&gt;Hmmm, even though the Thumbnail Offset is different, the Offset time seems to be correct in both cases&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;kinow@ranma:~/Desktop$ exiftool iPhone12-geotag.JPG | grep &quot;Offset Time&quot;
Offset Time &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; : -05:00
Offset Time Original &#160; &#160; &#160; &#160; &#160; &#160;: -05:00
Offset Time Digitized &#160; &#160; &#160; &#160; &#160; : -05:00 &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;kinow@ranma:~/Desktop$ exiftool editted-iPhone12-geotag.JPG | grep &quot;Offset Time&quot;
Offset Time &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; : -05:00
Offset Time Original &#160; &#160; &#160; &#160; &#160; &#160;: -05:00
Offset Time Digitized &#160; &#160; &#160; &#160; &#160; : -05:00
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I will try to reproduce the &quot;-05:00&quot; -&amp;gt; &quot;05:00&quot; as reported by the user using the alpha tags.&lt;/p&gt;</comment>
                            <comment id="17836848" author="kinow" created="Sat, 13 Apr 2024 19:00:15 +0000"  >&lt;p&gt;My bad, I think I forgot to re-build the project after changing the code.&lt;/p&gt;

&lt;p&gt;With `commons-imaging-1.0-alpha3-RC2` (no Offset Time ?):&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt; kinow@ranma:~/Desktop$ exiftool editted-iPhone12-geotag.JPG | grep &quot;Offset Time&quot;
Offset Time &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; :&#160;
Offset Time Original &#160; &#160; &#160; &#160; &#160; &#160;: -05:00
Offset Time Digitized &#160; &#160; &#160; &#160; &#160; : -05:00
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;With `rel/commons-imaging-1.0.0-alpha4` (same):&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;kinow@ranma:~/Desktop$ exiftool editted-iPhone12-geotag.JPG | grep &quot;Offset Time&quot;
Offset Time &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; :&#160;
Offset Time Original &#160; &#160; &#160; &#160; &#160; &#160;: -05:00
Offset Time Digitized &#160; &#160; &#160; &#160; &#160; : -05:00
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;With `master`, commit `6fb8d7bf42d58b6b343e9059a8657c8ed2abe54d`:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;kinow@ranma:~/Desktop$ exiftool editted-iPhone12-geotag.JPG | grep &quot;Offset Time&quot;
Offset Time &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; :&#160;
Offset Time Original &#160; &#160; &#160; &#160; &#160; &#160;: -05:00
Offset Time Digitized &#160; &#160; &#160; &#160; &#160; : -05:00
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;With the branch of the PR by Stefan:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;kinow@ranma:~/Desktop$ exiftool editted-iPhone12-geotag.JPG | grep &quot;Offset Time&quot;
Offset Time &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; : -05:00
Offset Time Original &#160; &#160; &#160; &#160; &#160; &#160;: -05:00
Offset Time Digitized &#160; &#160; &#160; &#160; &#160; : -05:00 &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17836850" author="kinow" created="Sat, 13 Apr 2024 19:39:37 +0000"  >&lt;p&gt;Hmm, odd. I have a photo I took with my Samsung phone in New Zealand, where Offset Time is +12:00 in exiftool. When I run the example code, it works fine with the old and the new code. Might be some other field in my test image, or negative/positive sign.&lt;/p&gt;</comment>
                            <comment id="17836851" author="kinow" created="Sat, 13 Apr 2024 19:48:07 +0000"  >&lt;p&gt;Tried with an image taken in Brazil, -03:00 Time Offset, couldn&apos;t reproduce the issue. Might be some other field or combination/order of fields. Tricky to find a good image to test the pull request.&lt;/p&gt;</comment>
                            <comment id="17836853" author="JIRAUSER303312" created="Sat, 13 Apr 2024 19:57:07 +0000"  >&lt;p&gt;It&apos;s not a problem with this specific field. The test image I attached to my PR fails on a different field.&lt;/p&gt;

&lt;p&gt;What happens is that Commons Imaging does not write the fields in the same order as the original. It sorts the fields by size. In the code it&apos;s called &quot;best-fit&quot;. &lt;/p&gt;

&lt;p&gt;Tiff offsets have to be at a multiple of 2. In rare cases it can happen that after the the re-ordering they are not at a multiple of 2. The original code already checked for this case, but it did not adapt the length after this offset shift change. That&apos;s the bug.&lt;/p&gt;

&lt;p&gt;Without re-ordering this bug may not affect this file. But it still could affect other files when the content length of them change in a way, that the field following it gets an odd offset.&lt;/p&gt;</comment>
                            <comment id="17836857" author="JIRAUSER303312" created="Sat, 13 Apr 2024 20:21:51 +0000"  >&lt;p&gt;It&apos;s really hard to reproduce a problematic file. I tried copying the tags over using exiftool, but that does result in another file. Manually adding tags to a new file to enforce this bug also did not work out.&lt;/p&gt;

&lt;p&gt;The file needs to be in a very specific problematic condition to trigger the bug.&lt;/p&gt;</comment>
                            <comment id="17836866" author="kinow" created="Sat, 13 Apr 2024 21:05:21 +0000"  >&lt;p&gt;Couldn&apos;t find any images on my local disk, nor on public domain images. But just to record the test code somewhere:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt; package org.apache.commons.imaging;

import org.apache.commons.imaging.common.ImageMetadata;
import org.apache.commons.imaging.formats.jpeg.JpegImageMetadata;
import org.apache.commons.imaging.formats.jpeg.exif.ExifRewriter;
import org.apache.commons.imaging.formats.tiff.TiffImageMetadata;
import org.apache.commons.imaging.formats.tiff.write.TiffOutputSet;
import org.apache.commons.io.IOUtils;

import java.io.BufferedOutputStream;
import java.io.File;
import java.io.IOException;
import java.nio.charset.Charset;
import java.nio.file.Files;
import java.util.Objects;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

/**
 * Search for images that cause the bug in IMAGING-319.
 */
public class LibraryTest {

    public static void main(String[] args) throws ImagingException, IOException, InterruptedException {
        File path = new File(&quot;/home/kinow/Desktop/haystack/&quot;);
        String needle = &quot;Offset Time\\s+:\\s+&quot;;
        Pattern pattern = Pattern.compile(String.format(&quot;^%s$&quot;, needle), Pattern.MULTILINE);
        for (File source : Objects.requireNonNull(path.listFiles(s -&amp;gt; s.getName().toLowerCase().endsWith(&quot;.jpg&quot;)))) {
            File result = Files.createTempFile(&quot;test_&quot;, &quot;.jpg&quot;).toFile();
            try {
                final ImageMetadata metadata = Imaging.getMetadata(source);
                final JpegImageMetadata jpegMetadata = (JpegImageMetadata) metadata;
                if (jpegMetadata != null) {
                    final TiffImageMetadata exif = jpegMetadata.getExif();
                    if (exif != null) {
                        TiffOutputSet outputSet = exif.getOutputSet();
                        BufferedOutputStream bufferedOutputStream = new BufferedOutputStream(Files.newOutputStream(result.toPath()));
                        new ExifRewriter().updateExifMetadataLossless(source, bufferedOutputStream, outputSet);

                        String[] cmd = {
                                &quot;/bin/sh&quot;,
                                &quot;-c&quot;,
                                String.format(&quot;exiftool %s | grep \&quot;Offset Time\&quot;&quot;, result.getAbsolutePath())
                        };
                        Process process = Runtime.getRuntime().exec(cmd);
                        process.waitFor();
                        String output = IOUtils.toString(process.getInputStream(), Charset.defaultCharset());
                        // System.out.println(output);

                        Matcher m = pattern.matcher(output);
                        if (m.find()) {
                            System.out.printf(&quot;Bug detected in %s%n&quot;, source.getAbsolutePath());
                        }
                    }
                }
            } catch (RuntimeException|ImagingException ignore) {
                ignore.printStackTrace();
            } // invalid metadata or bad format
        }
    }
}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Looks like the best option will be to craft a test image (or mock some test code...)&lt;/p&gt;</comment>
                            <comment id="17886279" author="JIRAUSER280851" created="Tue, 1 Oct 2024 21:27:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stefanoltmann&quot; class=&quot;user-hover&quot; rel=&quot;stefanoltmann&quot;&gt;stefanoltmann&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kinow&quot; class=&quot;user-hover&quot; rel=&quot;kinow&quot;&gt;kinow&lt;/a&gt;&#160; Hi! Sorry I was really busy these days. I own all the materials, including code and images, feel free to share to anyone if it can helps you all to fix the code. In the end, I really appreciate your all&apos;s library. It helps me a lot 4 years ago! I am glad that I can make minor contribution to this project.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13036665" name="Screen Shot 2021-11-26 at 4.01.06 PM-1.png" size="4831" author="yangsicheng" created="Fri, 26 Nov 2021 22:03:47 +0000"/>
                            <attachment id="13036666" name="Screen Shot 2021-11-26 at 4.01.21 PM-1.png" size="4916" author="yangsicheng" created="Fri, 26 Nov 2021 22:03:08 +0000"/>
                            <attachment id="13036664" name="iPhone12-geotag.JPG" size="5270465" author="yangsicheng" created="Fri, 26 Nov 2021 22:05:10 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 5 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0x4jc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>