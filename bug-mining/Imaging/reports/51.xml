<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:30:23 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[IMAGING-205] Imaging (Apache Sanselan) produces &quot;odd offsets&quot; in (EXIF) metadata</title>
                <link>https://issues.apache.org/jira/browse/IMAGING-205</link>
                <project id="12313421" key="IMAGING">Commons Imaging</project>
                    <description>&lt;p&gt;I&apos;m using the &quot;last stable version&quot; of Apache Sanselan 0.97 in an Android project (app). I have not upgraded to Commons Imaging yet, since the website says there is no stable release yet. Meanwhile, there are bugs in Sanselan. &lt;/p&gt;

&lt;p&gt;If I run the &lt;a href=&quot;http://svn.apache.org/repos/asf/commons/proper/sanselan/trunk/src/test/java/org/apache/sanselan/sampleUsage/WriteExifMetadataExample.java?p=820841&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;sample code method WriteExifMetadataExample.changeExifMetadata&lt;/a&gt; on an image, which updates the Apterture and GPS tags, the resulting image fails to validate (through Phil Harvey&apos;s &lt;a href=&quot;https://sno.phy.queensu.ca/~phil/exiftool/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;ExifTool software&lt;/a&gt;):&lt;/p&gt;


&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;&amp;gt; exiftool.exe -validate -error -warning -a &quot;..\20171030_21481_COPY.jpg&quot;
Validate                        : 19 Warnings (17 minor)
Warning                         : [minor] Odd offset for IFD0 tag 0x010f
Warning                         : [minor] Odd offset for IFD0 tag 0x011a
Warning                         : [minor] Odd offset for IFD0 tag 0x011b
Warning                         : [minor] Odd offset for IFD0 tag 0x0131
Warning                         : [minor] Odd offset for IFD0 tag 0x0132
Warning                         : [minor] Odd offset for ExifIFD tag 0x829a
Warning                         : [minor] Odd offset for ExifIFD tag 0x829d
Warning                         : [minor] Odd offset for ExifIFD tag 0x9003
Warning                         : [minor] Odd offset for ExifIFD tag 0x9004
Warning                         : [minor] Odd offset for ExifIFD tag 0x9202
Warning                         : [minor] Odd offset for ExifIFD tag 0x9205
Warning                         : [minor] Odd offset for ExifIFD tag 0x920a
Warning                         : [minor] Odd offset for ExifIFD tag 0x9286
Warning                         : Non-standard count (1) for GPS tag 0x0001 GPSLatitudeRef
Warning                         : [minor] Odd offset for GPS tag 0x0002
Warning                         : Non-standard count (1) for GPS tag 0x0003 GPSLongitudeRef
Warning                         : [minor] Odd offset for GPS tag 0x0004
Warning                         : [minor] Odd offset for IFD1 tag 0x011a
Warning                         : [minor] Odd offset for IFD1 tag 0x011b
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;I need some advice on how to proceed here. Since Sanselan does not appear to do what it should (even on very basic metadata editing), am I correct to assume that the current version of Commons Imaging does a better job? &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;
</description>
                <environment></environment>
        <key id="13113136">IMAGING-205</key>
            <summary>Imaging (Apache Sanselan) produces &quot;odd offsets&quot; in (EXIF) metadata</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kinow">Bruno P. Kinoshita</assignee>
                                    <reporter username="joakimk">Joakim Knudsen</reporter>
                        <labels>
                    </labels>
                <created>Mon, 30 Oct 2017 20:06:11 +0000</created>
                <updated>Fri, 7 Aug 2020 04:32:05 +0000</updated>
                            <resolved>Thu, 7 Dec 2017 12:01:17 +0000</resolved>
                                                    <fixVersion>1.0-alpha1</fixVersion>
                                    <component>imaging.*</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="16225820" author="joakimk" created="Mon, 30 Oct 2017 22:02:06 +0000"  >&lt;p&gt;I have attached the file producing the output from above.&lt;/p&gt;</comment>
                            <comment id="16225827" author="joakimk" created="Mon, 30 Oct 2017 22:05:01 +0000"  >&lt;p&gt;Also, see the &lt;a href=&quot;http://u88.n24.queensu.ca/exiftool/forum/index.php/topic,8642.msg44434.html#msg44434&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;following discussion&lt;/a&gt;, from the ExifTool forum.&lt;/p&gt;</comment>
                            <comment id="16251061" author="kinow" created="Tue, 14 Nov 2017 08:14:05 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=joakimk&quot; class=&quot;user-hover&quot; rel=&quot;joakimk&quot;&gt;joakimk&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;Thanks for the detailed report, and the link to the forum discussion. Comparing the output of the exiftool&apos;s htmldump, from a normal JPEG and another image created with WriteExifMetadataExample.changeExifMetadata (not quite the one you used, but from Commons Imaging tests), I can confirm there are odd offsets and also markers that were changed.&lt;/p&gt;

&lt;p&gt;Going to add a sample before, and another after. Plus the code, and the output HTML files for posterity and for working on this issue.&lt;/p&gt;</comment>
                            <comment id="16251063" author="kinow" created="Tue, 14 Nov 2017 08:17:54 +0000"  >&lt;p&gt;Attaching original file from &lt;a href=&quot;https://en.wikipedia.org/wiki/Talk%3ABox_jellyfish#/media/File:Gaboxjellyfish.jpg&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://en.wikipedia.org/wiki/Talk%3ABox_jellyfish#/media/File:Gaboxjellyfish.jpg&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;First HTML dump generated with `exiftool -validate -error -warning -a -G1 -htmldump Gaboxjellyfish.jpg &amp;gt; before.html`. Second file generated with `exiftool -validate -error -warning -a -G1 -htmldump Gaboxjellyfish-changedexifmetadata.jpg &amp;gt; after.html`.&lt;/p&gt;</comment>
                            <comment id="16251064" author="kinow" created="Tue, 14 Nov 2017 08:19:15 +0000"  >&lt;p&gt;Here&apos;s the code to reproduce the issue:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void main(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] args) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
        WriteExifMetadataExample example = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; WriteExifMetadataExample();
        &lt;span class=&quot;code-comment&quot;&gt;// This is broken
&lt;/span&gt;        example.changeExifMetadata(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; File(&lt;span class=&quot;code-quote&quot;&gt;&quot;/home/kinow/Downloads/Gaboxjellyfish.jpg&quot;&lt;/span&gt;),
                &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; File(&lt;span class=&quot;code-quote&quot;&gt;&quot;/home/kinow/Downloads/Gaboxjellyfish-changedexifmetadata.jpg&quot;&lt;/span&gt;));
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The `WriteExifMetadataExample` class is in the test src folder.&lt;/p&gt;

&lt;p&gt;Not sure if its implementation is correct. Could be that it simply needs updating to latest changes. Or may be a real bug.&lt;/p&gt;</comment>
                            <comment id="16251090" author="kinow" created="Tue, 14 Nov 2017 08:31:31 +0000"  >&lt;p&gt;Had a bit more of time. So removed the code in the example that changes the the metadata (aperture, GPS). The changed code simply retrieved the TIFF metadata, and then called a code as below:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ExifRewriter().updateExifMetadataLossless(jpegImageFile, os,
                    outputSet);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And the output still presents the issue. So looks like we can focus on the ExifRewriter method call and onwards.&lt;/p&gt;</comment>
                            <comment id="16251429" author="joakimk" created="Tue, 14 Nov 2017 14:16:47 +0000"  >&lt;p&gt;Thanks for looking into this! I have checked the current snapshot of Commons Imaging, and the bug does not seem to be present there. As Damjan Jovanovic pointed out to me, this has been fixed somewhere along the way. However, I need a version which will run on Android, and, as far as I can tell (though I haven&apos;t tried), the current version of the library won&apos;t/can&apos;t run on Android.&lt;/p&gt;</comment>
                            <comment id="16252254" author="kinow" created="Tue, 14 Nov 2017 21:55:34 +0000"  >&lt;p&gt;Are you using the latest snapshot of Apache Commons Imaging? Or of Apache Sanselan? I tested the latest code from Git for Apache Commons Imaging, and the odd offsets were present in the generated image.&lt;/p&gt;</comment>
                            <comment id="16252539" author="joakimk" created="Tue, 14 Nov 2017 22:20:44 +0000"  >&lt;p&gt;I&apos;m using Sanselan 0.97 for my project, since this is an Android app. The details in this bug report, and the discussion at the Exiftool forum, all relate to Sanselan. The main concern with the generated image (as attached in this report) is that it corrupts the Maker Notes, and that it completely restructures the metadata (compared to the original image). The odd offsets are also a problem, but a relatively minor one. &lt;/p&gt;

&lt;p&gt;I have also tested with Commons Imaging (in a separate, small test project) and although the image still contains the odd offsets, it does look a lot better than the one produced by Sanselan. &lt;/p&gt;

&lt;p&gt;However, since I am dependant on an Android compatible library, I am hoping this bug might be fixed in the Sanselan library. If that is not possible, I&apos;d like to know the status of making Commons Imaging available for Android? &lt;/p&gt;

&lt;p&gt;Thanks again, and sorry for the confusion!&lt;/p&gt;</comment>
                            <comment id="16252548" author="kinow" created="Tue, 14 Nov 2017 22:25:10 +0000"  >&lt;p&gt;No confusion at all. I&apos;ve started to learn the code base and get myself used to the library recently. If I recall correctly, the development on Sanselan stopped, and it was since then moved to Apache Commons Imaging.&lt;/p&gt;

&lt;p&gt;Not sure what are the requirements for Commons Imaging to be available for Android. Perhaps building the current sources into a jar would work?&lt;/p&gt;

&lt;p&gt;There are a few blockers for a 1.0 release. But we could still try to release alpha/beta versions before that. In case having the JAR in a Maven repository is a requirement for you, and an -alpha or -beta works for you too. Even easier if you could use a -SNAPSHOT version.&lt;/p&gt;</comment>
                            <comment id="16252983" author="joakimk" created="Wed, 15 Nov 2017 05:56:10 +0000"  >&lt;p&gt;Well, I could certainly give it a try! I haven&apos;t tried compiling for Android because I read online that Android does not support java.awt (which is required for Imaging).&lt;/p&gt;

&lt;p&gt;However, the Android release of Sanselan was apparently made by removing the parts of the code which relied on awt &amp;#8211; perhaps this can also be done for Imaging? &lt;br/&gt;
&lt;a href=&quot;https://stackoverflow.com/a/24147677/2736813&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://stackoverflow.com/a/24147677/2736813&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16254337" author="joakimk" created="Wed, 15 Nov 2017 22:26:10 +0000"  >&lt;p&gt;I&apos;ve been seeing various sets of error messages (from ExifTool) when validating the images run through the same (sample) code, and it seems the output depends on the input. Maybe that&apos;s not surprising? What I mean is, when I started this bug report, the JPEG I was testing on (20171030_24812.JPG &amp;#8211; attached) was taken by a Samsung Galaxy Note 8.0. The sample Sanselan code (WriteExifMetadataExample, which sets Aperture and GPS tags) resulted in various odd offsets, and some warnings on &quot;non-standard count&quot; on the GPS coordinates.&lt;/p&gt;

&lt;p&gt;However &amp;#8211; and this is why I&apos;ve been so confused &amp;#8211; JPEGs taken with my Sony Xperia Z5 Compact, when run through the very same sample code, produce more severe (AFAIK) errors. Note the Maker Notes error below &amp;#8211; this does not occur on the Samsung input file. I&apos;ve added these two original JPEGs, and their &quot;copy_desktop&quot; versions after Sanselan processing.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;$ ./exiftool.exe -validate -warning -error -a DSC_5506_copy_desktop.JPG
Validate                        : 16 Warnings (14 minor)
Warning                         : [minor] Odd offset for IFD0 tag 0x011a
Warning                         : [minor] Odd offset for IFD0 tag 0x011b
Warning                         : [minor] Odd offset for ExifIFD tag 0x829a
Warning                         : [minor] Odd offset for ExifIFD tag 0x829d
Warning                         : [minor] Odd offset for ExifIFD tag 0x9201
Warning                         : [minor] Odd offset for ExifIFD tag 0x9202
Warning                         : [minor] Odd offset for ExifIFD tag 0x9204
Warning                         : [minor] Odd offset for ExifIFD tag 0x920a
Warning                         : [minor] Possibly incorrect maker notes offsets (fix by -628?)
Warning                         : [minor] Odd offset for ExifIFD tag 0x9290
Warning                         : [minor] Odd offset for ExifIFD tag 0x9292
Warning                         : [minor] Odd offset for ExifIFD tag 0xa404
Warning                         : Non-standard count (1) for GPS tag 0x0001 GPSLatitudeRef
Warning                         : Non-standard count (1) for GPS tag 0x0003 GPSLongitudeRef
Warning                         : [minor] Odd offset for IFD1 tag 0x011a
Warning                         : [minor] Odd offset for IFD1 tag 0x011b
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;$ ./exiftool.exe -validate -warning -error -a 20171030_214812_copy_desktop.JPG
Validate                        : 19 Warnings (17 minor)
Warning                         : [minor] Odd offset for IFD0 tag 0x010f
Warning                         : [minor] Odd offset for IFD0 tag 0x011a
Warning                         : [minor] Odd offset for IFD0 tag 0x011b
Warning                         : [minor] Odd offset for IFD0 tag 0x0131
Warning                         : [minor] Odd offset for IFD0 tag 0x0132
Warning                         : [minor] Odd offset for ExifIFD tag 0x829a
Warning                         : [minor] Odd offset for ExifIFD tag 0x829d
Warning                         : [minor] Odd offset for ExifIFD tag 0x9003
Warning                         : [minor] Odd offset for ExifIFD tag 0x9004
Warning                         : [minor] Odd offset for ExifIFD tag 0x9202
Warning                         : [minor] Odd offset for ExifIFD tag 0x9205
Warning                         : [minor] Odd offset for ExifIFD tag 0x920a
Warning                         : [minor] Odd offset for ExifIFD tag 0x9286
Warning                         : Non-standard count (1) for GPS tag 0x0001 GPSLatitudeRef
Warning                         : [minor] Odd offset for GPS tag 0x0002
Warning                         : Non-standard count (1) for GPS tag 0x0003 GPSLongitudeRef
Warning                         : [minor] Odd offset for GPS tag 0x0004
Warning                         : [minor] Odd offset for IFD1 tag 0x011a
Warning                         : [minor] Odd offset for IFD1 tag 0x011b
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16254342" author="joakimk" created="Wed, 15 Nov 2017 22:27:56 +0000"  >&lt;p&gt;New example files, from two different sources. The problems vary according to the input file. &lt;/p&gt;</comment>
                            <comment id="16257653" author="joakimk" created="Fri, 17 Nov 2017 22:08:53 +0000"  >&lt;p&gt;Are you able to reproduce/verify the differences in the two jpeg files (from different manufacturers)? It would be interesting to run the two image files through Commons Imaging, too (as opposed to Sanselan 0.97 which I experiments with), and see if the warnings in the output still varies. Perhaps it is to be expected that different camera makers and different vendor OS will produce differently structured JPEG metadata? But, as long as it&apos;s according to standards (validates OK) this library should be able to handle the differences. &lt;/p&gt;</comment>
                            <comment id="16257674" author="kinow" created="Fri, 17 Nov 2017 22:21:36 +0000"  >&lt;p&gt;&amp;gt;Are you able to reproduce/verify the differences in the two jpeg files&lt;/p&gt;

&lt;p&gt;Let me try it.&lt;/p&gt;

&lt;p&gt;&amp;gt;Perhaps it is to be expected that different camera makers and different vendor OS will produce differently structured JPEG metadata?&lt;/p&gt;

&lt;p&gt;Yup, that seems to be quite normal. It increases the complexity for troubleshooting some issues, so thanks heaps for attaching the examples from different cameras.&lt;/p&gt;</comment>
                            <comment id="16257909" author="kinow" created="Sat, 18 Nov 2017 03:51:40 +0000"  >&lt;p&gt;I can reproduce it. Though a bit different, the result.&lt;/p&gt;

&lt;p&gt;I used 20171030_214812.jpg, and the code I posted before. Got odd offsets, but for GPSLongitude and Model only. The rest of the data seems to be good.&lt;/p&gt;

&lt;p&gt;Really weird, will have to slowly understand the code, in order to fully understand what&apos;s going on. Thanks again for the input samples.&lt;/p&gt;</comment>
                            <comment id="16258968" author="kinow" created="Mon, 20 Nov 2017 09:02:09 +0000"  >&lt;p&gt;Hi Joakim,&lt;/p&gt;

&lt;p&gt;So I&apos;ve found a way to get exiftool&apos;s htmldump to have no odd offsets. Push a single commit here &lt;a href=&quot;https://github.com/kinow/commons-imaging/tree/tiff-odd-offsets-1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/kinow/commons-imaging/tree/tiff-odd-offsets-1&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I slowly read the code, and found that these two parts were simply adding the length in bytes of the field plus a previous offset. Which could result in odd offsets. It would help me a lot if you were able to checkout my branch, `mvn clean package`, use the jar in your app, and let me know if that works fine for you.&lt;/p&gt;

&lt;p&gt;Once I realized where the odd bytes were coming from, this seemed like the simplest solution (occam&apos;s razor). But before we consider this naive solution as a definitive solution, I&apos;d like to:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;have a confirmation that the odd bytes is gone and the metadata and image are still &lt;b&gt;valid/good/correct/etc&lt;/b&gt;&lt;/li&gt;
	&lt;li&gt;have a better understand of the different between a TIFFOutputItem and TIFFOutputField. The latter has a method, writeField, that seems to be correctly handling offsets oddness.&lt;/li&gt;
	&lt;li&gt;write a unit test&lt;/li&gt;
	&lt;li&gt;find the parts of the specification that define that behaviour, and add links to them here, in the unit test, and in the javadoc of the class where the fix is applied&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16259826" author="joakimk" created="Mon, 20 Nov 2017 20:57:55 +0000"  >&lt;p&gt;Hello Bruno,&lt;/p&gt;

&lt;p&gt;that is truly an impressive job &amp;#8211; the code in the `tiff-odd-offsets-1` branch (compiled into a JAR and included in a separate test project) does indeed seem to fix the problems! The sample code, setting the Aperture and GPS tags, produces no warnings and simply &quot;validates OK&quot; by ExifTool. Furthermore, I ventured to add my code for writing the UserComment EXIF tag (which requires a bit of manual work, with padding and an &quot;ASCII marker&quot;), and also that seems to pass the validation! I&apos;ve added this code below, and I&apos;ve also attached a new set of images.&lt;/p&gt;

&lt;p&gt;I think this seems to be a very good starting point for further work &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;What I want to try next is to see if this current snapshot of Commons Imaging can work on Android &quot;as is&quot;, even though it depends on java.awt which is apparently not supported on Android. You see, I realize I&apos;ve been running Sanselan v0.97 on Android in my app, and &lt;em&gt;not&lt;/em&gt; some &quot;Android port&quot; of Sanselan. Even though my app produces errors and warnings on java.awt, it is indeed working on Android &amp;#8211; at least the parts I&apos;ve been using... &lt;/p&gt;

&lt;p&gt;Here&apos;s my code for updating the UserComment tag:&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
            {
                &lt;span class=&quot;code-comment&quot;&gt;// TEST: Try setting UserComment (in Exif dir)
&lt;/span&gt;                &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; textToSet = &lt;span class=&quot;code-quote&quot;&gt;&quot;This is a test comment&quot;&lt;/span&gt;;
                &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; TiffOutputDirectory exifDirectory = outputSet.getOrCreateExifDirectory();

                &lt;span class=&quot;code-comment&quot;&gt;// use Unicode (UTF-16) -- with padding (windows is not so happy with utf8)
&lt;/span&gt;                &lt;span class=&quot;code-comment&quot;&gt;// the marker has to be written with ASCII bytes, regardless of the encoding it actually describes (and which the following content is encoded in)!
&lt;/span&gt;                &lt;span class=&quot;code-comment&quot;&gt;// https://forums.adobe.com/thread/375932
&lt;/span&gt;                &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] ASCIIMarker = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[]{ 0x55, 0x4E, 0x49, 0x43, 0x4F, 0x44, 0x45, 0x00 }; &lt;span class=&quot;code-comment&quot;&gt;// spells out UNICODE\0
&lt;/span&gt;                &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] comment = textToSet.getBytes(ENCODING_UTF16);  &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; ENCODING_UTF16 = &lt;span class=&quot;code-quote&quot;&gt;&quot;UTF-16LE&quot;&lt;/span&gt;;
&lt;/span&gt;
                &lt;span class=&quot;code-comment&quot;&gt;// pad with \0 &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (total) length is odd (\0 &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt; automatically added by arraycopy)
&lt;/span&gt;                &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; pad = (ASCIIMarker.length + comment.length) % 2;

                &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] bytesComment = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[ASCIIMarker.length + comment.length + pad];
                &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.arraycopy(ASCIIMarker, 0, bytesComment, 0, ASCIIMarker.length);
                &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.arraycopy(comment, 0, bytesComment, ASCIIMarker.length, comment.length);
                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (pad &amp;gt; 0) bytesComment[bytesComment.length-1] = 0x00;

                TiffOutputField exif_comment = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TiffOutputField(ExifTagConstants.EXIF_TAG_USER_COMMENT,
                        FieldType.UNDEFINED,
                        bytesComment.length - pad, bytesComment);

                &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;ExifWriter UserComment, writing &quot;&lt;/span&gt; + bytesComment.length + &lt;span class=&quot;code-quote&quot;&gt;&quot; bytes (pad &quot;&lt;/span&gt; + pad + &lt;span class=&quot;code-quote&quot;&gt;&quot;)&quot;&lt;/span&gt;);

                &lt;span class=&quot;code-comment&quot;&gt;// remove old field
&lt;/span&gt;                exifDirectory.removeField(ExifTagConstants.EXIF_TAG_USER_COMMENT);

                &lt;span class=&quot;code-comment&quot;&gt;// add &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; field
&lt;/span&gt;                exifDirectory.add(exif_comment);

            }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;b&gt;New sample images:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;DSC_3338.JPG&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Original image (Sony Z5 Compact)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;DSC_3338_imaging_205.JPG&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Aperture and GPS modified (sample code)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;DSC_3338_imaging_205_UC.JPG&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;UserComment also added &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;

</comment>
                            <comment id="16259836" author="joakimk" created="Mon, 20 Nov 2017 21:03:11 +0000"  >&lt;p&gt;New sample images&lt;/p&gt;</comment>
                            <comment id="16264335" author="joakimk" created="Thu, 23 Nov 2017 13:38:18 +0000"  >&lt;p&gt;I&apos;ve tried using the JAR in my app, running it on Android (on actual devices) and, although errors and warnings are logged, the library works. I.e., to the same degree as Sanselan did, except that the JPEGs produced now actually validate &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Perhaps it might be possible to factor out the parts of the library which are not compatible with Android, and thus make an Android release? Guess that&apos;s another task/issue, though. &lt;/p&gt;

&lt;p&gt;I&apos;m attaching a JPEG edited on Android.&lt;/p&gt;</comment>
                            <comment id="16278202" author="kinow" created="Tue, 5 Dec 2017 08:40:02 +0000"  >&lt;p&gt;Updating the check list.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[ X ] have a confirmation that the odd bytes is gone and the metadata and image are still valid/good/correct/etc
    * Thanks for testing Joakim!
[ X ] have a better understand of the different between a TIFFOutputItem and TIFFOutputField. The latter has a method, writeField, that seems to be correctly handling offsets oddness.
    * Will attach a screen shot of my notes. But basically, TiffOutputField uses TifOutputItem. The item contains the offset, length, value (another item), etc. And the output field has the bytes, field type, tag, count, etc. The field is properly writing TIFF data with the correct number of bytes. The item just holds that data, and its write method writes the bytes as is.
[ ] write a unit test
    * Pending now. Just need to craft the example files for pass/fail tests.
[ X ] find the parts of the specification that define that behaviour, and add links to them here, in the unit test, and in the javadoc of the class where the fix is applied
    * The library of the US congress holds some interesting archival information https://www.loc.gov/preservation/digital/formats/fdd/fdd000022.shtml, with links to many documents. I&apos;m using this file https://www.itu.int/itudoc/itu-t/com16/tiff-fx/docs/tiff6.pdf. In the IFD and following sections it is possible to find text supporting the issue here. Page 21 for instance: &quot;providing the offset was an even number greater than or equal to 8&quot;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I&apos;m intending to proceed with the change as is, provided with a unit test. Unless there&apos;s objection here or in the mailing list.&lt;/p&gt;</comment>
                            <comment id="16278210" author="kinow" created="Tue, 5 Dec 2017 08:47:16 +0000"  >&lt;p&gt;Even though it didn&apos;t happen with TiffImageWriterLossy, the same &lt;b&gt;could&lt;/b&gt; happen there. Provided that you give as input a file with odd offsets, I believe we would get a resulting file with odd offsets too. The TiffImageWriterLossy seems to not alter the location of the fields, whereas TiffImageWriterLossless does, finding some times that the new offset is odd (and which is being fixed in this ticket).&lt;/p&gt;</comment>
                            <comment id="16281758" author="kinow" created="Thu, 7 Dec 2017 12:01:17 +0000"  >&lt;p&gt;Fixed in master + unit test! Thanks!!!&lt;/p&gt;</comment>
                            <comment id="16282613" author="joakimk" created="Thu, 7 Dec 2017 22:16:00 +0000"  >&lt;p&gt;Wonderful news! Great job and thanks :-D&lt;/p&gt;

</comment>
                            <comment id="16283311" author="joakimk" created="Fri, 8 Dec 2017 10:21:00 +0000"  >&lt;p&gt;Regarding the code snippet I posted earlier, about writing the UserComment&lt;br/&gt;
field. I had to do quite a bit of manual work to ensure adhering to the&lt;br/&gt;
Exif specification. Should some of this perhaps be incorporated into the&lt;br/&gt;
library?&lt;/p&gt;


&lt;p&gt;Joakim&lt;/p&gt;

&lt;p&gt;7. des. 2017 10.50 p.m. skrev &quot;Joakim Knudsen&quot; &amp;lt;joakim.grahl@gmail.com&amp;gt;:&lt;/p&gt;

&lt;p&gt;Wonderful news! Great job and thanks :-D&lt;/p&gt;

</comment>
                            <comment id="16283314" author="kinow" created="Fri, 8 Dec 2017 10:26:44 +0000"  >&lt;blockquote&gt;&lt;p&gt;Regarding the code snippet I posted earlier, about writing the UserComment&lt;br/&gt;
field. I had to do quite a bit of manual work to ensure adhering to the&lt;br/&gt;
Exif specification. Should some of this perhaps be incorporated into the&lt;br/&gt;
library?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I am not sure when/where users would want to use it, but only because I am slowly understanding the code base, and for TIFF/EXIF, I don&apos;t really have much practical use (my use case is more properly handling images for IIIF, and in getting a release of Imaging out of the door so I can experiment imaging with Cantaloupe image server).&lt;/p&gt;

&lt;p&gt;But I assume it would be a different issue? If you could create a new issue, explaining the use case for that, and where you think it should go in Imaging, I&apos;d be more than happy to review it.&lt;/p&gt;

&lt;p&gt;Thanks Joakim!!!&lt;br/&gt;
Bruno&lt;/p&gt;
</comment>
                            <comment id="17172845" author="kinow" created="Fri, 7 Aug 2020 04:32:05 +0000"  >&lt;p&gt;Apache Commons Imaging 1.0-alpha1 released (long ago, just closing the remaining issues marked as Resolved)&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12897861" name="20171030_214812.jpg" size="959572" author="joakimk" created="Wed, 15 Nov 2017 22:27:00 +0000"/>
                            <attachment id="12897860" name="20171030_214812_copy_desktop.JPG" size="959703" author="joakimk" created="Wed, 15 Nov 2017 22:27:00 +0000"/>
                            <attachment id="12894853" name="20171030_21481_COPY.jpg" size="959703" author="joakimk" created="Mon, 30 Oct 2017 22:01:11 +0000"/>
                            <attachment id="12898543" name="DSC_3338.JPG" size="2797678" author="joakimk" created="Mon, 20 Nov 2017 21:03:00 +0000"/>
                            <attachment id="12898542" name="DSC_3338_imaging_205.JPG" size="2797806" author="joakimk" created="Mon, 20 Nov 2017 21:03:00 +0000"/>
                            <attachment id="12898541" name="DSC_3338_imaging_205_UC.JPG" size="2797874" author="joakimk" created="Mon, 20 Nov 2017 21:03:02 +0000"/>
                            <attachment id="12897859" name="DSC_5506.JPG" size="2572888" author="joakimk" created="Wed, 15 Nov 2017 22:27:01 +0000"/>
                            <attachment id="12897858" name="DSC_5506_copy_desktop.JPG" size="2572999" author="joakimk" created="Wed, 15 Nov 2017 22:27:00 +0000"/>
                            <attachment id="12897510" name="Gaboxjellyfish-changedexifmetadata.jpg" size="3328285" author="kinow" created="Tue, 14 Nov 2017 08:16:48 +0000"/>
                            <attachment id="12897511" name="Gaboxjellyfish.jpg" size="3328181" author="kinow" created="Tue, 14 Nov 2017 08:16:48 +0000"/>
                            <attachment id="12899064" name="Samsung Note 8 Android.jpg" size="1168574" author="joakimk" created="Thu, 23 Nov 2017 13:38:52 +0000"/>
                            <attachment id="12897513" name="after.html" size="46752" author="kinow" created="Tue, 14 Nov 2017 08:16:42 +0000"/>
                            <attachment id="12897512" name="before.html" size="44565" author="kinow" created="Tue, 14 Nov 2017 08:16:42 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>13.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 14 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3lvvz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>