{"url":"https://api.github.com/repos/pallets/jinja/issues/857","repository_url":"https://api.github.com/repos/pallets/jinja","labels_url":"https://api.github.com/repos/pallets/jinja/issues/857/labels{/name}","comments_url":"https://api.github.com/repos/pallets/jinja/issues/857/comments","events_url":"https://api.github.com/repos/pallets/jinja/issues/857/events","html_url":"https://github.com/pallets/jinja/issues/857","id":326802125,"node_id":"MDU6SXNzdWUzMjY4MDIxMjU=","number":857,"title":"Template parsing (lexing) can have quadratic time complexity","user":{"login":"petee-d","id":7727916,"node_id":"MDQ6VXNlcjc3Mjc5MTY=","avatar_url":"https://avatars.githubusercontent.com/u/7727916?v=4","gravatar_id":"","url":"https://api.github.com/users/petee-d","html_url":"https://github.com/petee-d","followers_url":"https://api.github.com/users/petee-d/followers","following_url":"https://api.github.com/users/petee-d/following{/other_user}","gists_url":"https://api.github.com/users/petee-d/gists{/gist_id}","starred_url":"https://api.github.com/users/petee-d/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/petee-d/subscriptions","organizations_url":"https://api.github.com/users/petee-d/orgs","repos_url":"https://api.github.com/users/petee-d/repos","events_url":"https://api.github.com/users/petee-d/events{/privacy}","received_events_url":"https://api.github.com/users/petee-d/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2018-05-27T09:39:05Z","updated_at":"2020-11-13T20:34:05Z","closed_at":"2019-10-07T06:41:06Z","author_association":"NONE","type":null,"active_lock_reason":"resolved","sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## Expected Behavior\r\nParsing the following template should have linear complexity and be done in reasonable time.\r\n```\r\nfrom jinja2 import Environment\r\nEnvironment().from_string(' ' * 20000)\r\n```\r\n\r\n## Actual Behavior\r\nIt has quadratic complexity and takes a few seconds at 20000, a minute at 100k.\r\n\r\n**In general, it appears any large segments of whitespace (\" \\t\\n\") without jinja tags that consume whitespace will degrade template parsing performance significantly.**\r\n\r\n```\r\n# This parses quickly due to \"-\"\r\nEnvironment().from_string('{{ 0 -}}' + ' ' * 20000)\r\nEnvironment().from_string(' ' * 20000 + '{{- 0 }}')\r\n# This is very slow\r\nEnvironment().from_string('{{ 0 }}' + ' ' * 20000)\r\nEnvironment().from_string(' ' * 20000 + '{{ 0 }}')\r\n```\r\n\r\n## Cause\r\nI investigated the cause of the slow rendering and it lies in two pathological regular expressions used in Jinja lexer, \"root\" and TOKEN_RAW_BEGIN (not illustrated in examples but suffers from the same issue). In the **extremely simplified** version of the root lexer regex shown below, notice whitespace may be consumed either by `(.*?)` or by `\\s*`, with the latter having priority due to being greedy, but only in case the block of whitespace is followed by variable (or block/comment) opening tag with the \"-\" modifier (that forces left-stripping whitespace). This is a pathological case for the built-in Python `re` module and will have quadratic complexity due to backtracking done after consuming every single whitespace character (don't quote me on that though).\r\n```\r\nr'(.*?)(?:(?P<variable_begin>\\s*{{-|{{))'\r\n```\r\nJinja lexer does that to implement the whitespace stripping feature on the left side of tags, but this approach is extremely inefficient with built in Python `re` module (note the `regex` library doesn't suffer from this, but it is slower in general). \r\n\r\n## Proposed fix\r\nI created a fix for this issue by re-implementing the way striping whitespace on the left side of tags is done (including the lstrip_blocks environment flag) by doing this outside of regular expressions, which in my opinion simply are not the right tool for this task. I didn't change the implementation of striping whitespace to the right of tags as the \"-\" character is matched **before** any whitespace, changing the state of the regex automaton before any backtracking needs to be done.\r\n\r\nhttps://github.com/pallets/jinja/pull/858\r\n\r\n## Implications\r\nThe most significant implication is Jinja being extremely slow when parsing templates with segments of whitespace in tens of thousands. Such templates should be rare, but may occur. The application where I discovered this issue has almost 100k Jinja templates created by semi-technical users and a few of them contained such large segments of whitespace, most likely added by accident.\r\n\r\nThe more frequent implication is Jinja template parsing being sub optimal, as most Jinja templates will contains blocks of whitespace in tens or hundreds of characters. The performance impact of quadratic complexity on such small scale won't be that dramatic, but I measured over 2x average improvement in template parsing speeds after applying the fix on the above mentioned almost 100k different templates. I will post a histogram in the PR description.\r\n\r\n## Environment\r\n* Python version: tested with 2.7, 3.6, apparently any Python version\r\n* Jinja version: 2.8.1, current master, apparently any Jinja version in last few years","closed_by":{"login":"davidism","id":1242887,"node_id":"MDQ6VXNlcjEyNDI4ODc=","avatar_url":"https://avatars.githubusercontent.com/u/1242887?v=4","gravatar_id":"","url":"https://api.github.com/users/davidism","html_url":"https://github.com/davidism","followers_url":"https://api.github.com/users/davidism/followers","following_url":"https://api.github.com/users/davidism/following{/other_user}","gists_url":"https://api.github.com/users/davidism/gists{/gist_id}","starred_url":"https://api.github.com/users/davidism/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/davidism/subscriptions","organizations_url":"https://api.github.com/users/davidism/orgs","repos_url":"https://api.github.com/users/davidism/repos","events_url":"https://api.github.com/users/davidism/events{/privacy}","received_events_url":"https://api.github.com/users/davidism/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/pallets/jinja/issues/857/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/pallets/jinja/issues/857/timeline","performed_via_github_app":null,"state_reason":"completed"}