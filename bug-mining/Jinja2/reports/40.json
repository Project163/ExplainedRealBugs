{"url":"https://api.github.com/repos/pallets/jinja/issues/401","repository_url":"https://api.github.com/repos/pallets/jinja","labels_url":"https://api.github.com/repos/pallets/jinja/issues/401/labels{/name}","comments_url":"https://api.github.com/repos/pallets/jinja/issues/401/comments","events_url":"https://api.github.com/repos/pallets/jinja/issues/401/events","html_url":"https://github.com/pallets/jinja/issues/401","id":55823513,"node_id":"MDU6SXNzdWU1NTgyMzUxMw==","number":401,"title":"Multiple Custom Tests in Condition Not Parsed Correctly","user":{"login":"codyaray","id":44062,"node_id":"MDQ6VXNlcjQ0MDYy","avatar_url":"https://avatars.githubusercontent.com/u/44062?v=4","gravatar_id":"","url":"https://api.github.com/users/codyaray","html_url":"https://github.com/codyaray","followers_url":"https://api.github.com/users/codyaray/followers","following_url":"https://api.github.com/users/codyaray/following{/other_user}","gists_url":"https://api.github.com/users/codyaray/gists{/gist_id}","starred_url":"https://api.github.com/users/codyaray/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/codyaray/subscriptions","organizations_url":"https://api.github.com/users/codyaray/orgs","repos_url":"https://api.github.com/users/codyaray/repos","events_url":"https://api.github.com/users/codyaray/events{/privacy}","received_events_url":"https://api.github.com/users/codyaray/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2015-01-28T22:10:24Z","updated_at":"2020-11-13T21:23:28Z","closed_at":"2017-01-07T14:15:14Z","author_association":"NONE","type":null,"active_lock_reason":"resolved","sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"It appears that conditions with multiple custom tests aren't parsed as a user would expect. For example, if you define an `is_matching` test as follows\n\n```\ndef is_matching(string, pattern):\n  return match(pattern, string) is not None\n```\n\nthen the following custom test should succeed.\n\n```\n{% if 'us-west-1' is matching '(us-east-1|ap-northeast-1)' or 'stage' is matching '(dev|stage)' %}\n  ...\n{% endif %}\n```\n\nshould be met but its not.\n\nHere's a [runnable example](http://runnable.com/VMlOjoR7mw4_m0cu) that demonstrates the issue. \n\n```\n'us-west-1' == 'us-east-1' or 'stage' is matching '(dev|stage)'\n  => True # should be True\n\n'stage' is matching '(dev|stage)' or 'us-west-1' == 'us-east-1'\n  => True # should be True\n\n'us-west-1' is matching '(us-east-1|ap-northeast-1)' or 'stage' is matching '(dev|stage)'\n  => False # should be True\n```\n\nAs you can see, the custom test works if there is only one in the condition. However, it appears that the second custom test condition (following the `or`) is never executed if the first isn't met. (This can be seen in the output of the runnable, where I've printed the arguments to the custom test function for each invocation.)\n\nI suspect that this is due to the expected order of operations not being respected. For example\n\n```\n'stage' is matching '(dev|stage)' and 'us-west-1' is matching '(us-east-1|ap-northeast-1)'\n```\n\nresults in an exception for my custom test:\n\n```\nTraceback (most recent call last):\n  File \"/Users/codyaray/dev/brighttag/ops/management/haproxygen/bug.py\", line 20, in <module>\n    print template.render()\n  File \"/Users/codyaray/.virtualenv/haproxygen/lib/python2.7/site-packages/jinja2/environment.py\", line 969, in render\n    return self.environment.handle_exception(exc_info, True)\n  File \"/Users/codyaray/.virtualenv/haproxygen/lib/python2.7/site-packages/jinja2/environment.py\", line 742, in handle_exception\n    reraise(exc_type, exc_value, tb)\n  File \"/Users/codyaray/dev/brighttag/ops/management/haproxygen/templates/buggy.txt\", line 18, in top-level template code\n    => {{ 'stage' is matching '(dev|stage)' and 'us-west-1' is matching '(us-east-1|ap-northeast-1)' }} # should be False\n  File \"/Users/codyaray/dev/brighttag/ops/management/haproxygen/bug.py\", line 13, in is_matching\n    return match(pattern, string) is not None\n  File \"/Users/codyaray/.virtualenv/haproxygen/lib/python2.7/re.py\", line 137, in match\n    return _compile(pattern, flags).match(string)\n  File \"/Users/codyaray/.virtualenv/haproxygen/lib/python2.7/re.py\", line 238, in _compile\n    raise TypeError, \"first argument must be string or compiled pattern\"\nTypeError: first argument must be string or compiled pattern\n```\n\nPrinting the args to the custom function shows that it was called as `is_matching('stage', False)` instead of the expected `is_matching('stage', '(dev|stage)')` invocation. It seems like the second condition is actually tested here, resulting in False, which is then `and`ed with the search string '(dev|stage)' which yields a logical False to the next invocation of the custom test function.\n","closed_by":{"login":"mitsuhiko","id":7396,"node_id":"MDQ6VXNlcjczOTY=","avatar_url":"https://avatars.githubusercontent.com/u/7396?v=4","gravatar_id":"","url":"https://api.github.com/users/mitsuhiko","html_url":"https://github.com/mitsuhiko","followers_url":"https://api.github.com/users/mitsuhiko/followers","following_url":"https://api.github.com/users/mitsuhiko/following{/other_user}","gists_url":"https://api.github.com/users/mitsuhiko/gists{/gist_id}","starred_url":"https://api.github.com/users/mitsuhiko/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mitsuhiko/subscriptions","organizations_url":"https://api.github.com/users/mitsuhiko/orgs","repos_url":"https://api.github.com/users/mitsuhiko/repos","events_url":"https://api.github.com/users/mitsuhiko/events{/privacy}","received_events_url":"https://api.github.com/users/mitsuhiko/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/pallets/jinja/issues/401/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/pallets/jinja/issues/401/timeline","performed_via_github_app":null,"state_reason":"completed"}