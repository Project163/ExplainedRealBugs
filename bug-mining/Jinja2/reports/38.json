{"url":"https://api.github.com/repos/pallets/jinja/issues/548","repository_url":"https://api.github.com/repos/pallets/jinja","labels_url":"https://api.github.com/repos/pallets/jinja/issues/548/labels{/name}","comments_url":"https://api.github.com/repos/pallets/jinja/issues/548/comments","events_url":"https://api.github.com/repos/pallets/jinja/issues/548/events","html_url":"https://github.com/pallets/jinja/issues/548","id":135631111,"node_id":"MDU6SXNzdWUxMzU2MzExMTE=","number":548,"title":"Bug (and fix) in nodes.py that affects custom filters","user":{"login":"DavidRueter","id":5694184,"node_id":"MDQ6VXNlcjU2OTQxODQ=","avatar_url":"https://avatars.githubusercontent.com/u/5694184?v=4","gravatar_id":"","url":"https://api.github.com/users/DavidRueter","html_url":"https://github.com/DavidRueter","followers_url":"https://api.github.com/users/DavidRueter/followers","following_url":"https://api.github.com/users/DavidRueter/following{/other_user}","gists_url":"https://api.github.com/users/DavidRueter/gists{/gist_id}","starred_url":"https://api.github.com/users/DavidRueter/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DavidRueter/subscriptions","organizations_url":"https://api.github.com/users/DavidRueter/orgs","repos_url":"https://api.github.com/users/DavidRueter/repos","events_url":"https://api.github.com/users/DavidRueter/events{/privacy}","received_events_url":"https://api.github.com/users/DavidRueter/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2016-02-23T04:39:12Z","updated_at":"2020-11-13T21:23:36Z","closed_at":"2017-01-06T22:08:30Z","author_association":"NONE","type":null,"active_lock_reason":"resolved","sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"According to http://jinja.pocoo.org/docs/dev/api/#writing-filters we can use the decorator @environmentfilter on a custom filter function:\n\n> \"...for marking environment dependent filters. The current Environment is passed to the filter as first argument.\"\n\nHowever a bug in nodes.py (see Filter.as_const at approx. line 568) causes the Environment to be passed as the SECOND parameter under certain conditions.  Specifically, when the filter is called on a static string, the as_const() method does not work properly.\n\nThe solution is simple:\n1. Immediately after the line:\n   `args = [x.as_const(eval_ctx) for x in self.args]`\n   - Add two new lines:\n   - `main_args = []`\n   - `main_args.insert(0, obj)`\n2. Then replace the line:\n   -`args.insert(0, eval_ctx)`\n   - Replace with::\n   - `main_args.insert(0, eval_ctx))`\n3. Then replace the line:\n   -`args.insert(0, self.environment)`\n   - Replace with::\n   - `main_args.insert(0, self.environment)`\n4. Then replace the line:\n   -`return filter_(obj, *args, **kwargs)`\n   - Replace with::\n   - `return filter_(main_args, *args, **kwargs)`\n\nThis seems to solve the problem.\n\nYou can easily see the error in the original code:  `return filter_(obj, *args, **kwargs)` is not going to pass in the Environment as the first argument.\n\nThe fix simply uses a new local variable main_args to properly sequence `obj`, `eval_ctx` and `_self.environment` as needed, and use these in the call to `filter_()`.  Separately. `*args` and `**kwargs` are passed through as well.\n\nIf I am misunderstanding something, please let me know.\n\nOtherwise, please consider including this fix in a future release.  I am currently using Jinja 2.8\n","closed_by":{"login":"mitsuhiko","id":7396,"node_id":"MDQ6VXNlcjczOTY=","avatar_url":"https://avatars.githubusercontent.com/u/7396?v=4","gravatar_id":"","url":"https://api.github.com/users/mitsuhiko","html_url":"https://github.com/mitsuhiko","followers_url":"https://api.github.com/users/mitsuhiko/followers","following_url":"https://api.github.com/users/mitsuhiko/following{/other_user}","gists_url":"https://api.github.com/users/mitsuhiko/gists{/gist_id}","starred_url":"https://api.github.com/users/mitsuhiko/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mitsuhiko/subscriptions","organizations_url":"https://api.github.com/users/mitsuhiko/orgs","repos_url":"https://api.github.com/users/mitsuhiko/repos","events_url":"https://api.github.com/users/mitsuhiko/events{/privacy}","received_events_url":"https://api.github.com/users/mitsuhiko/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/pallets/jinja/issues/548/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/pallets/jinja/issues/548/timeline","performed_via_github_app":null,"state_reason":"completed"}