{"url":"https://api.github.com/repos/pallets/jinja/issues/431","repository_url":"https://api.github.com/repos/pallets/jinja","labels_url":"https://api.github.com/repos/pallets/jinja/issues/431/labels{/name}","comments_url":"https://api.github.com/repos/pallets/jinja/issues/431/comments","events_url":"https://api.github.com/repos/pallets/jinja/issues/431/events","html_url":"https://github.com/pallets/jinja/issues/431","id":64631184,"node_id":"MDU6SXNzdWU2NDYzMTE4NA==","number":431,"title":"Support a context finalize","user":{"login":"dstufft","id":145979,"node_id":"MDQ6VXNlcjE0NTk3OQ==","avatar_url":"https://avatars.githubusercontent.com/u/145979?v=4","gravatar_id":"","url":"https://api.github.com/users/dstufft","html_url":"https://github.com/dstufft","followers_url":"https://api.github.com/users/dstufft/followers","following_url":"https://api.github.com/users/dstufft/following{/other_user}","gists_url":"https://api.github.com/users/dstufft/gists{/gist_id}","starred_url":"https://api.github.com/users/dstufft/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dstufft/subscriptions","organizations_url":"https://api.github.com/users/dstufft/orgs","repos_url":"https://api.github.com/users/dstufft/repos","events_url":"https://api.github.com/users/dstufft/events{/privacy}","received_events_url":"https://api.github.com/users/dstufft/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2015-03-26T20:56:58Z","updated_at":"2020-11-13T21:43:42Z","closed_at":"2015-05-25T10:24:17Z","author_association":"NONE","type":null,"active_lock_reason":"resolved","sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Jinja2 has the ability to configure a `finalize` function which will be called right before a value is finally rendered to do any last minute changes to the values. This hooks into the exact place that I need something, however it has one problem... it doesn't have access to the context.\n\nLooking at the code, it appears that it wouldn't be very difficult to make the change so that the context is passed into the `finalize` function (infact I've got a proof of [concept branch](https://github.com/mitsuhiko/jinja2/compare/master...dstufft:contextfinalize)) but it has one major snag. If I understand the code, for nodes that can be rendered as a constant value the `finalize` function is called at compile time instead of at render time, which means that their is no context available at that time.\n\nI see a few possible solutions to this problem:\n- Add an `Environment().contextfinalize` function which is only called as a finalize function in the situations where we have a context available.\n- Make the `Environment().finalize` function able to be decorated by the `@contextfunction` decorator, and pass `None` for the context if we're doing the finalize during the compilation step.\n- Make the `Environment().finalize` function able to be decorated by the `@contextfunction` decorator, and disable the finalize during compilation step optimization if it wants a context.\n\nOf these, I prefer passing a `None` as a context, this can degrade into the final option by simply raising an exception in the finalize function which will skip the optimization for that node and can be made to act like the first one by just doing a check for `None` and returning early in that case.\n\nThoughts?\n","closed_by":{"login":"mitsuhiko","id":7396,"node_id":"MDQ6VXNlcjczOTY=","avatar_url":"https://avatars.githubusercontent.com/u/7396?v=4","gravatar_id":"","url":"https://api.github.com/users/mitsuhiko","html_url":"https://github.com/mitsuhiko","followers_url":"https://api.github.com/users/mitsuhiko/followers","following_url":"https://api.github.com/users/mitsuhiko/following{/other_user}","gists_url":"https://api.github.com/users/mitsuhiko/gists{/gist_id}","starred_url":"https://api.github.com/users/mitsuhiko/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mitsuhiko/subscriptions","organizations_url":"https://api.github.com/users/mitsuhiko/orgs","repos_url":"https://api.github.com/users/mitsuhiko/repos","events_url":"https://api.github.com/users/mitsuhiko/events{/privacy}","received_events_url":"https://api.github.com/users/mitsuhiko/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/pallets/jinja/issues/431/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/pallets/jinja/issues/431/timeline","performed_via_github_app":null,"state_reason":"completed"}