{"url":"https://api.github.com/repos/pallets/jinja/issues/631","repository_url":"https://api.github.com/repos/pallets/jinja","labels_url":"https://api.github.com/repos/pallets/jinja/issues/631/labels{/name}","comments_url":"https://api.github.com/repos/pallets/jinja/issues/631/comments","events_url":"https://api.github.com/repos/pallets/jinja/issues/631/events","html_url":"https://github.com/pallets/jinja/issues/631","id":196626893,"node_id":"MDU6SXNzdWUxOTY2MjY4OTM=","number":631,"title":"AttributeError on getting attrs from old-style classes","user":{"login":"nolar","id":544296,"node_id":"MDQ6VXNlcjU0NDI5Ng==","avatar_url":"https://avatars.githubusercontent.com/u/544296?v=4","gravatar_id":"","url":"https://api.github.com/users/nolar","html_url":"https://github.com/nolar","followers_url":"https://api.github.com/users/nolar/followers","following_url":"https://api.github.com/users/nolar/following{/other_user}","gists_url":"https://api.github.com/users/nolar/gists{/gist_id}","starred_url":"https://api.github.com/users/nolar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nolar/subscriptions","organizations_url":"https://api.github.com/users/nolar/orgs","repos_url":"https://api.github.com/users/nolar/repos","events_url":"https://api.github.com/users/nolar/events{/privacy}","received_events_url":"https://api.github.com/users/nolar/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2016-12-20T09:41:35Z","updated_at":"2020-11-13T21:34:25Z","closed_at":"2016-12-30T23:47:24Z","author_association":"NONE","type":null,"active_lock_reason":"resolved","sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**The problem:**\r\n\r\nWhen the templates refer to the old-style classes, the `AttributeError` raises when trying to retrieve or filter or group by attributes (both existing & non-existing), while only `TypeError` & `LookupError` are expected.\r\n\r\n**Code sample:**\r\n\r\n```\r\nfrom jinja2 import Template\r\n\r\n\r\nclass NewStyle(object):\r\n    pass\r\n    # myattr = None\r\n\r\n\r\nclass OldStyle:\r\n    pass\r\n    # myattr = None\r\n\r\n\r\ntpl = Template(u'''\r\n============== BEGIN {{mode}}\r\n{% for item in items|selectattr('myattr') %}\r\n    * {{item}}: {{item.myattr}}\r\n{% endfor -%}\r\n============== END\r\n''')\r\n\r\nprint(tpl.render(mode='NewStyled', items=[NewStyle() for _ in xrange(5)]))\r\nprint(tpl.render(mode='OldStyled', items=[OldStyle() for _ in xrange(5)]))\r\n```\r\n\r\n**Actual behaviour:**\r\n\r\n```\r\n============== BEGIN NewStyled\r\n============== END\r\nTraceback (most recent call last):\r\n  File \"j.py\", line 23, in <module>\r\n    print(tpl.render(mode='OldStyled', items=[OldStyle() for _ in xrange(5)]))\r\n  File \".../lib/python2.7/site-packages/jinja2/environment.py\", line 989, in render\r\n    return self.environment.handle_exception(exc_info, True)\r\n  File \".../lib/python2.7/site-packages/jinja2/environment.py\", line 754, in handle_exception\r\n    reraise(exc_type, exc_value, tb)\r\n  File \"<template>\", line 3, in top-level template code\r\n  File \".../lib/python2.7/site-packages/jinja2/filters.py\", line 942, in _select_or_reject\r\n    if modfunc(func(transfunc(item))):\r\n  File \".../lib/python2.7/site-packages/jinja2/filters.py\", line 62, in <lambda>\r\n    return lambda x: environment.getitem(x, attribute)\r\n  File \".../lib/python2.7/site-packages/jinja2/environment.py\", line 389, in getitem\r\n    return obj[argument]\r\nAttributeError: OldStyle instance has no attribute '__getitem__'\r\n```\r\n\r\n**Expected behaviour:**\r\n\r\nBoth rendering cases return the same output (with or without the list, depending on the presence of the attribute in the classes).\r\n\r\n**Cause:**\r\n\r\nThe error is caused by this fragment in the code (both in `Environment` & `SandboxedEnvironment`):\r\n\r\n```\r\n    def getitem(self, obj, argument):\r\n        try:\r\n            return obj[argument]\r\n        except (TypeError, LookupError):\r\n            ………\r\n```\r\n\r\nFor new-style classes, the `TypeError` is raised when accessing an item when the class does not support those. For old-style classes, the `AttributeError` is raised, and it is not expected here:\r\n\r\n```\r\n>>> NewStyle()['x']\r\nTypeError: 'NewStyle' object has no attribute '__getitem__'\r\n\r\n>>> OldStyle()['x']\r\nAttributeError: OldStyle instance has no attribute '__getitem__'\r\n```\r\n\r\n**Affected cases:**\r\n\r\nInitially detected while using `autoapi` extension for Sphinx with custom Jinja2 templates and custom pytest \"marks\" to be auto-documented — but this should be irrelevant.\r\n\r\nThis also happens when the objects to be rendered (or checked) are python's built-in `_Feature` (as in `from __future__ import absolute_imports`), python modules, etc. Python2.7 still has a lot of old-style objects internally and in its stdlib.\r\n\r\nIt seems that support for the old-style classes should be expected in Jinja, rather than the absence of the old-style should be expected in the arbitrary libraries or in python itself. Hence, the bug is for Jinja, not for `pytest` or `autoapi`.\r\n\r\n\r\n**Notes:**\r\n\r\nPython 2.7.10\r\nJinja 2.8 (the most recent one)","closed_by":{"login":"mitsuhiko","id":7396,"node_id":"MDQ6VXNlcjczOTY=","avatar_url":"https://avatars.githubusercontent.com/u/7396?v=4","gravatar_id":"","url":"https://api.github.com/users/mitsuhiko","html_url":"https://github.com/mitsuhiko","followers_url":"https://api.github.com/users/mitsuhiko/followers","following_url":"https://api.github.com/users/mitsuhiko/following{/other_user}","gists_url":"https://api.github.com/users/mitsuhiko/gists{/gist_id}","starred_url":"https://api.github.com/users/mitsuhiko/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mitsuhiko/subscriptions","organizations_url":"https://api.github.com/users/mitsuhiko/orgs","repos_url":"https://api.github.com/users/mitsuhiko/repos","events_url":"https://api.github.com/users/mitsuhiko/events{/privacy}","received_events_url":"https://api.github.com/users/mitsuhiko/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/pallets/jinja/issues/631/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/pallets/jinja/issues/631/timeline","performed_via_github_app":null,"state_reason":"completed"}