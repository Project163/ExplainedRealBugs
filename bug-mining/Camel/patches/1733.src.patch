diff --git a/components/camel-freemarker/src/main/java/org/apache/camel/component/freemarker/FreemarkerEndpoint.java b/components/camel-freemarker/src/main/java/org/apache/camel/component/freemarker/FreemarkerEndpoint.java
index 0d850198fb3..f2c18490e39 100644
--- a/components/camel-freemarker/src/main/java/org/apache/camel/component/freemarker/FreemarkerEndpoint.java
+++ b/components/camel-freemarker/src/main/java/org/apache/camel/component/freemarker/FreemarkerEndpoint.java
@@ -20,7 +20,6 @@ import java.io.Reader;
 import java.io.StringReader;
 import java.io.StringWriter;
 import java.util.Map;
-import java.util.Map.Entry;
 
 import freemarker.template.Configuration;
 import freemarker.template.Template;
@@ -96,7 +95,6 @@ public class FreemarkerEndpoint extends ResourceEndpoint {
     }
 
     @Override
-    @SuppressWarnings("unchecked")
     protected void onExchange(Exchange exchange) throws Exception {
         String path = getResourceUri();
         ObjectHelper.notNull(configuration, "configuration");
@@ -121,7 +119,7 @@ public class FreemarkerEndpoint extends ResourceEndpoint {
             exchange.getIn().removeHeader(FreemarkerConstants.FREEMARKER_TEMPLATE);
         }
 
-        Map variableMap = ExchangeHelper.createVariableMap(exchange);
+        Map<String, Object> variableMap = ExchangeHelper.createVariableMap(exchange);
         // let freemarker parse and generate the result in buffer
         Template template;
 
@@ -143,9 +141,7 @@ public class FreemarkerEndpoint extends ResourceEndpoint {
         // now lets output the results to the exchange
         Message out = exchange.getOut();
         out.setBody(buffer.toString());
-        Map<String, Object> headers = (Map<String, Object>) variableMap.get("headers");
-        for (Entry<String, Object> entry : headers.entrySet()) {
-            out.setHeader(entry.getKey(), entry.getValue());
-        }
+        out.setHeaders(exchange.getIn().getHeaders());
+        out.setAttachments(exchange.getIn().getAttachments());
     }
 }
\ No newline at end of file
diff --git a/components/camel-freemarker/src/test/java/org/apache/camel/component/freemarker/FreemarkerHeaderSetTemplateTest.java b/components/camel-freemarker/src/test/java/org/apache/camel/component/freemarker/FreemarkerHeaderSetTemplateTest.java
deleted file mode 100644
index a30e8ac6c33..00000000000
--- a/components/camel-freemarker/src/test/java/org/apache/camel/component/freemarker/FreemarkerHeaderSetTemplateTest.java
+++ /dev/null
@@ -1,63 +0,0 @@
-/**
- * Licensed to the Apache Software Foundation (ASF) under one or more
- * contributor license agreements.  See the NOTICE file distributed with
- * this work for additional information regarding copyright ownership.
- * The ASF licenses this file to You under the Apache License, Version 2.0
- * (the "License"); you may not use this file except in compliance with
- * the License.  You may obtain a copy of the License at
- *
- *      http://www.apache.org/licenses/LICENSE-2.0
- *
- * Unless required by applicable law or agreed to in writing, software
- * distributed under the License is distributed on an "AS IS" BASIS,
- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
- * See the License for the specific language governing permissions and
- * limitations under the License.
- */
-package org.apache.camel.component.freemarker;
-
-import org.apache.camel.Exchange;
-import org.apache.camel.Message;
-import org.apache.camel.Processor;
-import org.apache.camel.builder.RouteBuilder;
-import org.apache.camel.test.junit4.CamelTestSupport;
-import org.junit.Test;
-
-/**
- * Freemarker unit test
- */
-public class FreemarkerHeaderSetTemplateTest extends CamelTestSupport {
-
-    @Test
-    public void testReceivesFooResponse() throws Exception {
-        assertRespondsWith("foo", "<hello>foo</hello>");
-    }
-
-    @Test
-    public void testReceivesBarResponse() throws Exception {
-        assertRespondsWith("bar", "<hello>bar</hello>");
-    }
-
-    protected void assertRespondsWith(final String value, String expectedBody) throws Exception {
-        Exchange response = template.request("direct:a", new Processor() {
-            public void process(Exchange exchange) throws Exception {
-                Message in = exchange.getIn();
-                in.setBody("answer");
-                in.setHeader("cheese", value);
-            }
-        });
-        assertOutMessageBodyEquals(response, expectedBody);
-    }
-
-    protected RouteBuilder createRouteBuilder() {
-        return new RouteBuilder() {
-            public void configure() {
-                // START SNIPPET: example
-                from("direct:a").
-                        setHeader(FreemarkerConstants.FREEMARKER_RESOURCE_URI).constant("org/apache/camel/component/freemarker/example.ftl").
-                        to("freemarker:dummy");
-                // END SNIPPET: example
-            }
-        };
-    }
-}
diff --git a/components/camel-freemarker/src/test/java/org/apache/camel/component/freemarker/FreemarkerTest.java b/components/camel-freemarker/src/test/java/org/apache/camel/component/freemarker/FreemarkerTest.java
index d6270e7daa7..3ebea65d3f8 100644
--- a/components/camel-freemarker/src/test/java/org/apache/camel/component/freemarker/FreemarkerTest.java
+++ b/components/camel-freemarker/src/test/java/org/apache/camel/component/freemarker/FreemarkerTest.java
@@ -16,8 +16,9 @@
  */
 package org.apache.camel.component.freemarker;
 
+import javax.activation.DataHandler;
+
 import org.apache.camel.Exchange;
-import org.apache.camel.Message;
 import org.apache.camel.Processor;
 import org.apache.camel.builder.RouteBuilder;
 import org.apache.camel.test.junit4.CamelTestSupport;
@@ -29,24 +30,21 @@ import org.junit.Test;
 public class FreemarkerTest extends CamelTestSupport {
 
     @Test
-    public void testReceivesFooResponse() throws Exception {
-        assertRespondsWith("foo", "<hello>foo</hello>");
-    }
-
-    @Test
-    public void testReceivesBarResponse() throws Exception {
-        assertRespondsWith("bar", "<hello>bar</hello>");
-    }
-
-    protected void assertRespondsWith(final String value, String expectedBody) throws Exception {
-        Exchange response = template.request("direct:a", new Processor() {
+    public void testVelocityLetter() throws Exception {
+        final DataHandler dataHandler = new DataHandler("my attachment", "text/plain");
+        Exchange exchange = template.request("direct:a", new Processor() {
+            @Override
             public void process(Exchange exchange) throws Exception {
-                Message in = exchange.getIn();
-                in.setBody("answer");
-                in.setHeader("cheese", value);
+                exchange.getIn().addAttachment("item", dataHandler);
+                exchange.getIn().setBody("Monday");
+                exchange.getIn().setHeader("name", "Christian");
+                exchange.setProperty("item", "7");
             }
         });
-        assertOutMessageBodyEquals(response, expectedBody);
+
+        assertEquals("Dear Christian. You ordered item 7 on Monday.", exchange.getOut().getBody());
+        assertEquals("Christian", exchange.getOut().getHeader("name"));
+        assertSame(dataHandler, exchange.getOut().getAttachment("item"));
     }
 
     protected RouteBuilder createRouteBuilder() {
diff --git a/components/camel-freemarker/src/test/resources/org/apache/camel/component/freemarker/example.ftl b/components/camel-freemarker/src/test/resources/org/apache/camel/component/freemarker/example.ftl
index a31b72e242e..9ac4a882d73 100644
--- a/components/camel-freemarker/src/test/resources/org/apache/camel/component/freemarker/example.ftl
+++ b/components/camel-freemarker/src/test/resources/org/apache/camel/component/freemarker/example.ftl
@@ -16,4 +16,4 @@
 ## limitations under the License.
 ## ------------------------------------------------------------------------
 -->
-<hello>${headers.cheese}</hello>
\ No newline at end of file
+Dear ${headers.name}. You ordered item ${exchange.properties.item} on ${body}.
\ No newline at end of file
diff --git a/components/camel-stringtemplate/src/main/java/org/apache/camel/component/stringtemplate/StringTemplateEndpoint.java b/components/camel-stringtemplate/src/main/java/org/apache/camel/component/stringtemplate/StringTemplateEndpoint.java
index 367b868c113..619009aee78 100644
--- a/components/camel-stringtemplate/src/main/java/org/apache/camel/component/stringtemplate/StringTemplateEndpoint.java
+++ b/components/camel-stringtemplate/src/main/java/org/apache/camel/component/stringtemplate/StringTemplateEndpoint.java
@@ -18,7 +18,6 @@ package org.apache.camel.component.stringtemplate;
 
 import java.io.StringWriter;
 import java.util.Map;
-import java.util.Map.Entry;
 
 import org.antlr.stringtemplate.AutoIndentWriter;
 import org.antlr.stringtemplate.StringTemplate;
@@ -52,7 +51,6 @@ public class StringTemplateEndpoint extends ResourceEndpoint {
     }
 
     @Override
-    @SuppressWarnings("unchecked")
     protected void onExchange(Exchange exchange) throws Exception {
         StringWriter buffer = new StringWriter();
         Map<String, Object> variableMap = ExchangeHelper.createVariableMap(exchange);
@@ -67,10 +65,8 @@ public class StringTemplateEndpoint extends ResourceEndpoint {
         // now lets output the results to the exchange
         Message out = exchange.getOut();
         out.setBody(buffer.toString());
+        out.setHeaders(exchange.getIn().getHeaders());
         out.setHeader(StringTemplateConstants.STRINGTEMPLATE_RESOURCE_URI, getResourceUri());
-        Map<String, Object> headers = (Map<String, Object>) variableMap.get("headers");
-        for (Entry<String, Object> entry : headers.entrySet()) {
-            out.setHeader(entry.getKey(), entry.getValue());
-        }
+        out.setAttachments(exchange.getIn().getAttachments());
     }
 }
\ No newline at end of file
diff --git a/components/camel-stringtemplate/src/test/java/org/apache/camel/component/stringtemplate/StringTemplateOutHeaderTest.java b/components/camel-stringtemplate/src/test/java/org/apache/camel/component/stringtemplate/StringTemplateOutHeaderTest.java
deleted file mode 100644
index dabd7aaeed4..00000000000
--- a/components/camel-stringtemplate/src/test/java/org/apache/camel/component/stringtemplate/StringTemplateOutHeaderTest.java
+++ /dev/null
@@ -1,82 +0,0 @@
-/**
- * Licensed to the Apache Software Foundation (ASF) under one or more
- * contributor license agreements.  See the NOTICE file distributed with
- * this work for additional information regarding copyright ownership.
- * The ASF licenses this file to You under the Apache License, Version 2.0
- * (the "License"); you may not use this file except in compliance with
- * the License.  You may obtain a copy of the License at
- *
- *      http://www.apache.org/licenses/LICENSE-2.0
- *
- * Unless required by applicable law or agreed to in writing, software
- * distributed under the License is distributed on an "AS IS" BASIS,
- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
- * See the License for the specific language governing permissions and
- * limitations under the License.
- */
-package org.apache.camel.component.stringtemplate;
-
-import java.util.Map;
-import java.util.Set;
-
-import org.apache.camel.Exchange;
-import org.apache.camel.InvalidPayloadException;
-import org.apache.camel.Message;
-import org.apache.camel.Processor;
-import org.apache.camel.builder.RouteBuilder;
-import org.apache.camel.test.junit4.CamelTestSupport;
-import org.junit.Test;
-
-/**
- * @version 
- */
-public class StringTemplateOutHeaderTest extends CamelTestSupport {
-
-    @Test
-    public void testReceivesFooResponse() throws Exception {
-        assertRespondsWith("cheese", "foo", "<hello>foo</hello>");
-    }
-
-    @Test
-    public void testReceivesBarResponse() throws Exception {
-        assertRespondsWith("cheese", "bar", "<hello>bar</hello>");
-    }
-
-    @Test
-    public void testRespectHeaderNamesUpperCase() throws Exception {
-        assertRespondsWith("Cheese", "bar", "<hello>bar</hello>");
-    }
-
-    @Test
-    public void testRespectHeaderNamesCamelCase() throws Exception {
-        assertRespondsWith("CheesE", "bar", "<hello>bar</hello>");
-    }
-
-    protected void assertRespondsWith(final String headerName, final String headerValue, String expectedBody) throws InvalidPayloadException {
-        Exchange response = template.request("direct:a", new Processor() {
-            public void process(Exchange exchange) throws Exception {
-                Message in = exchange.getIn();
-                in.setHeader(headerName, headerValue);
-            }
-        });
-        assertOutMessageBodyEquals(response, expectedBody);
-
-        Set<Map.Entry<String, Object>> entrySet = response.getOut().getHeaders().entrySet();
-        boolean keyFound = false;
-        for (Map.Entry<String, Object> entry : entrySet) {
-            if (entry.getKey().equals(headerName)) {
-                keyFound = true;
-            }
-        }
-        assertTrue("Header should been found", keyFound);
-    }
-
-    protected RouteBuilder createRouteBuilder() {
-        return new RouteBuilder() {
-            public void configure() {
-                from("direct:a").to("string-template:org/apache/camel/component/stringtemplate/template.tm");
-            }
-        };
-    }
-}
-
diff --git a/components/camel-stringtemplate/src/test/java/org/apache/camel/component/stringtemplate/StringTemplateTest.java b/components/camel-stringtemplate/src/test/java/org/apache/camel/component/stringtemplate/StringTemplateTest.java
index 24132e75039..56b983e8d22 100644
--- a/components/camel-stringtemplate/src/test/java/org/apache/camel/component/stringtemplate/StringTemplateTest.java
+++ b/components/camel-stringtemplate/src/test/java/org/apache/camel/component/stringtemplate/StringTemplateTest.java
@@ -16,38 +16,33 @@
  */
 package org.apache.camel.component.stringtemplate;
 
+import javax.activation.DataHandler;
+
 import org.apache.camel.Exchange;
-import org.apache.camel.InvalidPayloadException;
-import org.apache.camel.Message;
 import org.apache.camel.Processor;
 import org.apache.camel.builder.RouteBuilder;
 import org.apache.camel.test.junit4.CamelTestSupport;
 import org.junit.Test;
 
-/**
- * @version 
- */
 public class StringTemplateTest extends CamelTestSupport {
-
+    
     @Test
-    public void testReceivesFooResponse() throws Exception {
-        assertRespondsWith("foo", "<hello>foo</hello>");
-    }
-
-    @Test
-    public void testReceivesBarResponse() throws Exception {
-        assertRespondsWith("bar", "<hello>bar</hello>");
-    }
-
-    protected void assertRespondsWith(final String value, String expectedBody) throws InvalidPayloadException {
+    public void test() throws Exception {
+        final DataHandler dataHandler = new DataHandler("my attachment", "text/plain");
+        
         Exchange response = template.request("direct:a", new Processor() {
             public void process(Exchange exchange) throws Exception {
-                Message in = exchange.getIn();
-                in.setBody("answer");
-                in.setHeader("cheese", value);
+                exchange.getIn().addAttachment("item", dataHandler);
+                exchange.getIn().setBody("Monday");
+                exchange.getIn().setHeader("name", "Christian");
+                exchange.setProperty("item", "7");
             }
         });
-        assertOutMessageBodyEquals(response, expectedBody);
+        
+        assertEquals("Dear Christian. You ordered item 7 on Monday.", response.getOut().getBody());
+        assertEquals("org/apache/camel/component/stringtemplate/template.tm", response.getOut().getHeader(StringTemplateConstants.STRINGTEMPLATE_RESOURCE_URI));
+        assertEquals("Christian", response.getOut().getHeader("name"));
+        assertSame(dataHandler, response.getOut().getAttachment("item"));
     }
 
     protected RouteBuilder createRouteBuilder() {
diff --git a/components/camel-stringtemplate/src/test/resources/org/apache/camel/component/stringtemplate/template.tm b/components/camel-stringtemplate/src/test/resources/org/apache/camel/component/stringtemplate/template.tm
index 6ae5acfd312..2fb77fd74fb 100644
--- a/components/camel-stringtemplate/src/test/resources/org/apache/camel/component/stringtemplate/template.tm
+++ b/components/camel-stringtemplate/src/test/resources/org/apache/camel/component/stringtemplate/template.tm
@@ -14,4 +14,4 @@ $!-----------------------------------------------------------------------
  See the License for the specific language governing permissions and
  limitations under the License.
  ------------------------------------------------------------------------
-!$<hello>$headers.cheese$</hello>
\ No newline at end of file
+!$Dear $headers.name$. You ordered item $exchange.properties.item$ on $body$.
\ No newline at end of file
diff --git a/components/camel-velocity/src/main/java/org/apache/camel/component/velocity/VelocityEndpoint.java b/components/camel-velocity/src/main/java/org/apache/camel/component/velocity/VelocityEndpoint.java
index 71b7e873606..27e47be25a2 100644
--- a/components/camel-velocity/src/main/java/org/apache/camel/component/velocity/VelocityEndpoint.java
+++ b/components/camel-velocity/src/main/java/org/apache/camel/component/velocity/VelocityEndpoint.java
@@ -22,7 +22,6 @@ import java.io.Reader;
 import java.io.StringReader;
 import java.io.StringWriter;
 import java.util.Map;
-import java.util.Map.Entry;
 import java.util.Properties;
 
 import org.apache.camel.Exchange;
@@ -39,10 +38,8 @@ import org.apache.velocity.app.VelocityEngine;
 import org.apache.velocity.context.Context;
 import org.apache.velocity.runtime.log.CommonsLogLogChute;
 
-/**
- * @version 
- */
 public class VelocityEndpoint extends ResourceEndpoint {
+    
     private VelocityEngine velocityEngine;
     private boolean loaderCache = true;
     private String encoding;
@@ -150,7 +147,6 @@ public class VelocityEndpoint extends ResourceEndpoint {
         return getCamelContext().getEndpoint(newUri, VelocityEndpoint.class);
     }
 
-    @SuppressWarnings("unchecked")
     @Override
     protected void onExchange(Exchange exchange) throws Exception {
         String path = getResourceUri();
@@ -186,7 +182,7 @@ public class VelocityEndpoint extends ResourceEndpoint {
         // getResourceAsInputStream also considers the content cache
         StringWriter buffer = new StringWriter();
         String logTag = getClass().getName();
-        Map variableMap = ExchangeHelper.createVariableMap(exchange);
+        Map<String, Object> variableMap = ExchangeHelper.createVariableMap(exchange);
         Context velocityContext = new VelocityContext(variableMap);
 
         // let velocity parse and generate the result in buffer
@@ -197,11 +193,7 @@ public class VelocityEndpoint extends ResourceEndpoint {
         // now lets output the results to the exchange
         Message out = exchange.getOut();
         out.setBody(buffer.toString());
-
-        Map<String, Object> headers = (Map<String, Object>) velocityContext.get("headers");
-        for (Entry<String, Object> entry : headers.entrySet()) {
-            out.setHeader(entry.getKey(), entry.getValue());
-        }
+        out.setHeaders(exchange.getIn().getHeaders());
+        out.setAttachments(exchange.getIn().getAttachments());
     }
-
 }
\ No newline at end of file
diff --git a/components/camel-velocity/src/test/java/org/apache/camel/component/velocity/VelocityTest.java b/components/camel-velocity/src/test/java/org/apache/camel/component/velocity/VelocityTest.java
index 6d14e41ccdb..94a56f53b26 100644
--- a/components/camel-velocity/src/test/java/org/apache/camel/component/velocity/VelocityTest.java
+++ b/components/camel-velocity/src/test/java/org/apache/camel/component/velocity/VelocityTest.java
@@ -16,37 +16,32 @@
  */
 package org.apache.camel.component.velocity;
 
+import javax.activation.DataHandler;
+
 import org.apache.camel.Exchange;
-import org.apache.camel.InvalidPayloadException;
-import org.apache.camel.Message;
 import org.apache.camel.Processor;
 import org.apache.camel.builder.RouteBuilder;
 import org.apache.camel.test.junit4.CamelTestSupport;
 import org.junit.Test;
 
-/**
- * @version 
- */
 public class VelocityTest extends CamelTestSupport {
+    
     @Test
-    public void testReceivesFooResponse() throws Exception {
-        assertRespondsWith("foo", "<hello>foo</hello>");
-    }
-
-    @Test
-    public void testReceivesBarResponse() throws Exception {
-        assertRespondsWith("bar", "<hello>bar</hello>");
-    }
-
-    protected void assertRespondsWith(final String value, String expectedBody) throws InvalidPayloadException {
-        Exchange response = template.request("direct:a", new Processor() {
+    public void testVelocityLetter() throws Exception {
+        final DataHandler dataHandler = new DataHandler("my attachment", "text/plain");
+        Exchange exchange = template.request("direct:a", new Processor() {
+            @Override
             public void process(Exchange exchange) throws Exception {
-                Message in = exchange.getIn();
-                in.setBody("answer");
-                in.setHeader("cheese", value);
+                exchange.getIn().addAttachment("item", dataHandler);
+                exchange.getIn().setBody("Monday");
+                exchange.getIn().setHeader("name", "Christian");
+                exchange.setProperty("item", "7");
             }
         });
-        assertOutMessageBodyEquals(response, expectedBody);
+
+        assertEquals("Dear Christian. You ordered item 7 on Monday.", exchange.getOut().getBody());
+        assertEquals("Christian", exchange.getOut().getHeader("name"));
+        assertSame(dataHandler, exchange.getOut().getAttachment("item"));
     }
 
     protected RouteBuilder createRouteBuilder() {
diff --git a/components/camel-velocity/src/test/resources/org/apache/camel/component/velocity/example.vm b/components/camel-velocity/src/test/resources/org/apache/camel/component/velocity/example.vm
index f024389a43e..13bb870c5ff 100644
--- a/components/camel-velocity/src/test/resources/org/apache/camel/component/velocity/example.vm
+++ b/components/camel-velocity/src/test/resources/org/apache/camel/component/velocity/example.vm
@@ -14,4 +14,4 @@
 ## See the License for the specific language governing permissions and
 ## limitations under the License.
 ## ------------------------------------------------------------------------
-<hello>${headers.cheese}</hello>
\ No newline at end of file
+Dear ${headers.name}. You ordered item ${exchange.properties.item} on ${body}.
\ No newline at end of file
