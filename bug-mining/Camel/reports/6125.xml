<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:53:39 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-17613] camel-sql - Race condition in AggregateProcessor with Jdbc Repository</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-17613</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;using aggregate with a JdbcAggregationRepository, we are encountering a race condition that may leave a completed exchange in completed table even after that completed exchange has been sent. Unfortunately, that leads to duplicates since recovery task will eventually try and recover it.&lt;/p&gt;

&lt;p&gt;Normally, when the exchange completes, it is deleted from repo exchange table and inserted into repo completed exchange table. Then exchange is sent and deleted from repo completed exchange table.&lt;/p&gt;

&lt;p&gt;But, due to the fact those two actions are run by different threads (and in different transactions) that order may vary.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Here is a normal sequence :&#160;&lt;/p&gt;

&lt;p&gt;AggregateProcessor.doProcess&lt;br/&gt;
&#160; doAggregation&lt;br/&gt;
&#160; &#160; doAggregationComplete&lt;br/&gt;
&#160; &#160; &#160; onCompletion&lt;br/&gt;
&#160; &#160; &#160; &#160; JdbcAggregationRepository.remove : =&amp;gt; INSERT ... INTO _completed&#160;&#160;&lt;br/&gt;
&#160; onSubmitCompletion &#160;&lt;br/&gt;
&#160; &#160; AggregateOnCompletion.onComplete &#160; (via executorService)&lt;br/&gt;
&#160; &#160; &#160; JdbcAggregationRepository.confirm&#160; : =&amp;gt; DELETE FROM _completed&lt;/p&gt;

&lt;p&gt;With the use of executorService, confirm is run by another thread and may commit before remove commits. Eventually, when that occurs, one can check that DELETE statement returns 0 (number of deleted rows) instead of 1.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13426970">CAMEL-17613</key>
            <summary>camel-sql - Race condition in AggregateProcessor with Jdbc Repository</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="klease78">Karen Lease</assignee>
                                    <reporter username="bbonnet">Benjamin BONNET</reporter>
                        <labels>
                    </labels>
                <created>Mon, 7 Feb 2022 16:23:52 +0000</created>
                <updated>Tue, 26 Apr 2022 07:52:12 +0000</updated>
                            <resolved>Tue, 26 Apr 2022 07:52:12 +0000</resolved>
                                    <version>3.11.2</version>
                                    <fixVersion>3.17.0</fixVersion>
                                    <component>camel-core</component>
                    <component>camel-sql</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17488721" author="davsclaus" created="Tue, 8 Feb 2022 10:06:50 +0000"  >&lt;p&gt;Oh that is a great analysis. &lt;/p&gt;</comment>
                            <comment id="17489745" author="davsclaus" created="Wed, 9 Feb 2022 18:50:01 +0000"  >&lt;p&gt;Are you able to to work on this, or provide an unit test / example to help reproduce this?&lt;/p&gt;

&lt;p&gt;Also I wonder if we need some new API or something to aggregation repostiory to maybe ensure that work items for same exchange IDs are executed sequentially or something we can ensure that remove / confirm is executed in right order&lt;/p&gt;</comment>
                            <comment id="17490229" author="bbonnet" created="Thu, 10 Feb 2022 13:37:22 +0000"  >&lt;p&gt;I could not isolate the issue in a unit test, but here is an execution log extract (I added some debug log after insert and delete statement):&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13039879/13039879_CAMEL-17613-log.txt&quot; title=&quot;CAMEL-17613-log.txt attached to CAMEL-17613&quot;&gt;CAMEL-17613-log.txt&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;According to log, INSERT occurs before DELETE, but when DELETE is executed, row is not yet visible. I wonder how it is possible :&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;transactions are run very close one with each other, probably using different JDBC connections. The DB (PostgreSQL) guarantees isolation, but I am not sure order is guaranteed too.&lt;/li&gt;
	&lt;li&gt;we are using XA transactions (with Atomikos as a transaction manager) and we have to check that it does not add asynchronee somewhere on commit path.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17490566" author="klease78" created="Thu, 10 Feb 2022 22:43:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bbonnet&quot; class=&quot;user-hover&quot; rel=&quot;bbonnet&quot;&gt;bbonnet&lt;/a&gt; JdbcAggregationRepository uses a Spring TransactionTemplate which has &quot;default&quot; transaction isolation so it&apos;s not clear what level that provides.&lt;br/&gt;
Maybe you&apos;ve set a specific value on the Atomikos manager or configured the DB itself.&lt;br/&gt;
I also noticed this in the Camel SQL component documentation which might be relevant if the JMS route is also transacted:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;JdbcAggregationRepository uses two distinct transaction templates from Spring-TX. One is read-only and one is used for read-write operations.&lt;br/&gt;
However, when using JdbcAggregationRepository within a route that itself uses &amp;lt;transacted /&amp;gt; and there&#8217;s common PlatformTransactionManager used, there may be a need to configure propagation behavior used by transaction templates inside JdbcAggregationRepository.&lt;/p&gt;&lt;/blockquote&gt;</comment>
                            <comment id="17490737" author="bbonnet" created="Fri, 11 Feb 2022 08:19:36 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=klease78&quot; class=&quot;user-hover&quot; rel=&quot;klease78&quot;&gt;klease78&lt;/a&gt;, isolation level&#160; is implicitly set to PostgreSQL default isolation level : Read Committed. Propagation behaviour is explicitly set to PROPAGATION_REQUIRED.&lt;/p&gt;</comment>
                            <comment id="17491037" author="klease78" created="Fri, 11 Feb 2022 16:52:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bbonnet&quot; class=&quot;user-hover&quot; rel=&quot;bbonnet&quot;&gt;bbonnet&lt;/a&gt; Thanks for the info. Maybe you could try debug logging at the level of the transaction manager to get an even finer-grained view of the issue. &lt;br/&gt;
&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13039939/13039939_Spring_jdbc_transactions.log&quot; title=&quot;Spring_jdbc_transactions.log attached to CAMEL-17613&quot;&gt;Spring_jdbc_transactions.log&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; shows the result in one of the unit tests which uses the built-in Spring DataSourceTransactionManager. According to the log, the transaction which deletes the exchange from the initial repo and inserts it in the completed repo is committed &lt;b&gt;before&lt;/b&gt; the main thread continues to process the exchange so the behavior you see shouldn&apos;t occur.&lt;br/&gt;
But in this simple case, the transaction is initiated in the call to JdbcAggregationRepository.remove(). I&apos;m not familiar with Atomikos or with JMS either but maybe if your transaction is initiated in the JMS handling and propagated to the remove() call, it is committed a bit later in the sequence which could explain why the inserted row isn&apos;t yet visible in the Aggregator-initiated transaction.&lt;/p&gt;</comment>
                            <comment id="17517446" author="bbonnet" created="Tue, 5 Apr 2022 13:43:41 +0000"  >&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;I have made a unit test that shows how transactions might execute in reverse order.&lt;/p&gt;

&lt;p&gt;See &lt;a href=&quot;https://github.com/bonnetb/camel/tree/CAMEL-17613,&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/bonnetb/camel/tree/CAMEL-17613,&lt;/a&gt;&#160; (commit &lt;a href=&quot;https://github.com/bonnetb/camel/commit/4da7abe5543434cba48f3e0f7f0a1d7fdb160462&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/bonnetb/camel/commit/4da7abe5543434cba48f3e0f7f0a1d7fdb160462&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;This test uses an Atomikos transaction manager and an XA datasource (H2). By extending Atomikos transaction manager, I added some delay at commit time for the transaction that should occur first. As a result, the other transaction (DELETE) occurs first and you may see an ERROR log &quot;DELETE statement did not return 1 but 0&quot;.&lt;/p&gt;

&lt;p&gt;I noticed you set 3.17.0 as fix version : have you already worked on a fix ?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17517449" author="davsclaus" created="Tue, 5 Apr 2022 13:49:40 +0000"  >&lt;p&gt;No we just move the ticket forward - an unit test surely helps. You are welcome to dive in and see if you can come up with a suggest fix/improvement&lt;/p&gt;</comment>
                            <comment id="17518890" author="klease78" created="Thu, 7 Apr 2022 13:43:52 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bbonnet&quot; class=&quot;user-hover&quot; rel=&quot;bbonnet&quot;&gt;bbonnet&lt;/a&gt; Many thanks for the test. I have finally understood how this can happen. Since the route is transacted, the commit does not actually happen in the methods in the JdbcAggregationRepository but in a task which is run on the main thread after the aggregate processor returns from its process() call. So it could happen that the thread started to&#160; process the completed aggregation runs first and completes before the commit on the insert.&lt;/p&gt;

&lt;p&gt;One idea is to slightly delay the start of the Aggregator thread, for example by using a ScheduledThreadPoolExecutor.&lt;/p&gt;

&lt;p&gt;Another idea is to handle the non-deleted exchange in the RecoveryTask. It doesn&apos;t need to be redelivered but this could call the confirm() method again.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17518908" author="davsclaus" created="Thu, 7 Apr 2022 14:14:06 +0000"  >&lt;p&gt;I wonder if we can house-keep the jdbc repo so we can handle that if a DELETE comes before INSERT then we do not need to execute the INSERT&lt;/p&gt;</comment>
                            <comment id="17519018" author="klease78" created="Thu, 7 Apr 2022 16:54:21 +0000"  >&lt;p&gt;I don&apos;t think so. In fact the INSERT is already executed but the transaction is not committed, which is done in the TransactionErrorHandler. And the transaction also contains the DELETE from the main aggregation repository so we can&apos;t try to roll it back. But I think it is not so difficult to change the AggregateProcessor so it could retry the DELETE from the complete repository.&lt;/p&gt;</comment>
                            <comment id="17527980" author="klease78" created="Tue, 26 Apr 2022 07:52:12 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bbonnet&quot; class=&quot;user-hover&quot; rel=&quot;bbonnet&quot;&gt;bbonnet&lt;/a&gt; I adapted your test a bit to remove the Atomix and JTA dependencies and still managed to reproduce and fix the issue with H2 as the database.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13039879" name="CAMEL-17613-log.txt" size="3322" author="bbonnet" created="Thu, 10 Feb 2022 13:24:40 +0000"/>
                            <attachment id="13039939" name="Spring_jdbc_transactions.log" size="4082" author="klease78" created="Fri, 11 Feb 2022 16:37:44 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 29 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0zbjc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>