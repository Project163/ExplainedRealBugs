<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 11:05:20 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-18017] camel-as2 - Signed content in MDN gets corrupted and is not possible to validate</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-18017</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;When the http response with an MDN is received it is parsed to a MultipartSignedEntity-object. &lt;br/&gt;
When the object is serialized back to an outputstream using the method AS2MessageDispositionNotificationEntity#writeTo the string is not guaranteed to be identical to the the string received in the original http-response.&lt;/p&gt;

&lt;p&gt;This makes it impossible to calculate an correct message-digest and the method MultipartSignedEntity#isValid returns false because the following exception is thrown:&lt;br/&gt;
&quot;org.bouncycastle.cms.CMSSignerDigestMismatchException: message-digest attribute value does not match calculated value&quot;&lt;br/&gt;
when calling:&#160;&lt;br/&gt;
signer.verify(new JcaSimpleSignerInfoVerifierBuilder().setProvider(&quot;BC&quot;).build(cert)&lt;/p&gt;

&lt;p&gt;I tried to use the AS2-client to send messeages to both IBM Datapower and ArcESB and it was not possible to validate the MDN from neither of them.&lt;/p&gt;

&lt;p&gt;A few examples of differences between the actual received string and the reconstructed string are (see the full examples further down):&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;The order of the fields in the disposition-notification was in the wrong order:&lt;br/&gt;
In the original string they where ordered as follows:&lt;br/&gt;
Reporting-UA&lt;br/&gt;
Original-Recipient&lt;br/&gt;
Final-Recipient&lt;br/&gt;
Original-Message-ID&lt;br/&gt;
Disposition&lt;br/&gt;
Received-content-MIC&lt;br/&gt;
But in the reconstructed string the field Original-Recipient had been moved down and was placed before Received-content-MIC.&lt;/li&gt;
	&lt;li&gt;Received-content-MIC returned from both Datapower and ArcESB had a space between the comma-sign and the algorithmId.&lt;br/&gt;
In the reconstructed string the space-character was removed.&lt;br/&gt;
According to the example in RFC4130 (&lt;a href=&quot;https://datatracker.ietf.org/doc/html/rfc4130)&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://datatracker.ietf.org/doc/html/rfc4130)&lt;/a&gt; is seems as if it should be ok to have a space-character.&lt;/li&gt;
	&lt;li&gt;In the MDN from ArcESB the field Received-content-MIC the word content was written with a capital &apos;C&apos; i.e. Received-Content-MIC.&lt;br/&gt;
I&apos;m not sure if that is valid according to the standard or not.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;The actual string received in the http-response:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Content-Type: multipart/report; report-type=disposition-notification; boundary=8e7e662d-3449-4777-96dc-7a6ba5ddbfb3

--8e7e662d-3449-4777-96dc-7a6ba5ddbfb3
Content-Type: text/plain; charset=us-asciiThis MDN response message is &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;:Original-Message-ID: &amp;lt;52vncg5lq4.1sqyji9ko4yxk@camel.apache.org&amp;gt;
From: AMFAutoTest_AS2--8e7e662d-3449-4777-96dc-7a6ba5ddbfb3
Content-Type: message/disposition-notificationReporting-UA: DataPower
Original-Recipient: rfc822; &lt;span class=&quot;code-quote&quot;&gt;&quot;TEST&quot;&lt;/span&gt;
Final-Recipient: rfc822; &lt;span class=&quot;code-quote&quot;&gt;&quot;TEST&quot;&lt;/span&gt;
Original-Message-ID: &amp;lt;52vncg5lq4.1sqyji9ko4yxk@camel.apache.org&amp;gt;
Disposition: automatic-action/MDN-sent-automatically; processed
Received-content-MIC: vUE91/gKwRCPdosfVE3H/VQNy1xHgZ+YWoVgcM5mVBya/ggZb7KxjozNUk7ewsrHOxoI9BDY2uURCcxpKU9dYA==, sha-512

--8e7e662d-3449-4777-96dc-7a6ba5ddbfb3-- &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The String reconstructed from the MultipartSignedEntity:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Content-Type: multipart/report; report-type=disposition-notification; boundary=8e7e662d-3449-4777-96dc-7a6ba5ddbfb3

--8e7e662d-3449-4777-96dc-7a6ba5ddbfb3
Content-Type: text/plain; charset=us-asciiThis MDN response message is &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;:Original-Message-ID: &amp;lt;52vncg5lq4.1sqyji9ko4yxk@camel.apache.org&amp;gt;
From: AMFAutoTest_AS2--8e7e662d-3449-4777-96dc-7a6ba5ddbfb3
Content-Type: message/disposition-notificationReporting-UA: DataPower
Final-Recipient: rfc822;&lt;span class=&quot;code-quote&quot;&gt;&quot;TEST&quot;&lt;/span&gt;
Original-Message-ID: &amp;lt;52vncg5lq4.1sqyji9ko4yxk@camel.apache.org&amp;gt;
Disposition: automatic-action/MDN-sent-automatically;processed
Original-Recipient: rfc822; &lt;span class=&quot;code-quote&quot;&gt;&quot;TEST&quot;&lt;/span&gt;
Received-content-MIC: vUE91/gKwRCPdosfVE3H/VQNy1xHgZ+YWoVgcM5mVBya/ggZb7KxjozNUk7ewsrHOxoI9BDY2uURCcxpKU9dYA==,sha-512

--8e7e662d-3449-4777-96dc-7a6ba5ddbfb3-- &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;In order to always being able to calculate a correct digest the original string that was signed should be preserved as is.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13441987">CAMEL-18017</key>
            <summary>camel-as2 - Signed content in MDN gets corrupted and is not possible to validate</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jono">Jono Morris</assignee>
                                    <reporter username="TedL">Ted Lundqvist</reporter>
                        <labels>
                    </labels>
                <created>Wed, 27 Apr 2022 06:56:03 +0000</created>
                <updated>Fri, 12 Apr 2024 16:36:01 +0000</updated>
                            <resolved>Fri, 12 Apr 2024 16:35:49 +0000</resolved>
                                    <version>3.16.0</version>
                                    <fixVersion>4.4.2</fixVersion>
                    <fixVersion>4.6.0</fixVersion>
                                    <component>camel-as2</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17654365" author="davsclaus" created="Wed, 4 Jan 2023 09:31:54 +0000"  >&lt;p&gt;Ah you mean the reconstructed string can reorder the ket/value lines ?&lt;/p&gt;</comment>
                            <comment id="17654383" author="tedl" created="Wed, 4 Jan 2023 10:27:41 +0000"  >&lt;p&gt;Yes! But also the format is changed as I mentioned regarding the field name Received-Content-MIC&lt;/p&gt;

&lt;p&gt;One way to get around this problem would be to save an exact copy of the signed string instead of parsing it and then create a new string from the object.&lt;/p&gt;</comment>
                            <comment id="17654400" author="davsclaus" created="Wed, 4 Jan 2023 11:22:28 +0000"  >&lt;p&gt;Yes that sounds like a good plan, would you be able to try and implement this and send a PR or patch file.&lt;/p&gt;</comment>
                            <comment id="17676058" author="tedl" created="Thu, 12 Jan 2023 14:59:25 +0000"  >&lt;p&gt;Sorry for the late response.&lt;br/&gt;
Unfortunately we gave up our attempt to use Camel for AS2 communication and I have moved on to other things.&lt;/p&gt;

&lt;p&gt;I created att workaround that solves this problem but I think that in order to make a proper fix a major rework is needed.&lt;br/&gt;
You can find my solution here if you would like to have look: &lt;a href=&quot;https://github.com/apache/camel/commit/810c7dea0758a049c06bc5927f18ca9d9938b9d4&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/commit/810c7dea0758a049c06bc5927f18ca9d9938b9d4&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17834699" author="davsclaus" created="Sun, 7 Apr 2024 16:39:29 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jono&quot; class=&quot;user-hover&quot; rel=&quot;jono&quot;&gt;jono&lt;/a&gt; do you think we can backport your patch to 4.4.x branch as well ?&lt;/p&gt;</comment>
                            <comment id="17835332" author="jono" created="Tue, 9 Apr 2024 09:38:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davsclaus&quot; class=&quot;user-hover&quot; rel=&quot;davsclaus&quot;&gt;davsclaus&lt;/a&gt; , I backported the patch to the 4.4.x branch &lt;a href=&quot;https://github.com/apache/camel/pull/13719&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/13719&lt;/a&gt;.&#160; Let me know if you have any further instructions for this issue, otherwise I think it can be closed.&lt;/p&gt;</comment>
                            <comment id="17836685" author="davsclaus" created="Fri, 12 Apr 2024 16:36:01 +0000"  >&lt;p&gt;Thanks&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13518341">CAMEL-18917</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 30 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z11uvs:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>