<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 11:07:37 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-21112] camel-sql - Simple language to lookup parameter value is not compatible with batch mode </title>
                <link>https://issues.apache.org/jira/browse/CAMEL-21112</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;It seems there is an issue when using simple language to lookup parameters on producer endpoint in batch mode, like the following:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
to(&lt;span class=&quot;code-quote&quot;&gt;&quot;sql:insert into Table1 ( col1) values ( :#${myBean.field1})?batch=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt;) &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;DefaultSqlPrepareStatementStrategy and particular method lookupParameter(&#8230;)&#160; in class PopulateIterator tries to evaluate the specified simple expression on a body of the exchange. However when body is iterator that contains the parameter iterators for batch mode (as told in the doc: &lt;a href=&quot;https://camel.apache.org/components/4.4.x/sql-component.html#_treatment_of_the_message_body&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://camel.apache.org/components/4.4.x/sql-component.html#_treatment_of_the_message_body&lt;/a&gt;) then simple language expression written for an object to be returned by the parameter iterator makes no sense and will always fail.&lt;/p&gt;

&lt;p&gt;It seems when batch mode is enabled than DefaultSqlPrepareStatementStrategy.PopulateIterator needs to create a kind of fake Exchange from an object to be returned by the parameter iterator and pass to the simple language engine.&lt;/p&gt;

&lt;p&gt;Vanilla code&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/camel/blob/0e6dd1ea1ddb566fc4ee4eb4757d4a3c703ca06f/components/camel-sql/src/main/java/org/apache/camel/component/sql/DefaultSqlPrepareStatementStrategy.java#L262&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/blob/0e6dd1ea1ddb566fc4ee4eb4757d4a3c703ca06f/components/camel-sql/src/main/java/org/apache/camel/component/sql/DefaultSqlPrepareStatementStrategy.java#L262&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Suggested code change:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
org.apache.camel.component.sql.DefaultSqlPrepareStatementStrategy.PopulateIterato
r
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.camel.builder.ExchangeBuilder
    &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; lookupParameter(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; nextParam, Exchange exchange, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; body) {
&#8230;
	Exchange  fakeExchange = ExchangeBuilder.anExchange(camelContext).withBody(body).build();
            answer = exchange.getContext().resolveLanguage(&lt;span class=&quot;code-quote&quot;&gt;&quot;simple&quot;&lt;/span&gt;).createExpression(nextParam).evaluate(fakeExchange,
&#8230;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13589764">CAMEL-21112</key>
            <summary>camel-sql - Simple language to lookup parameter value is not compatible with batch mode </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="alexanderz">Alexander Zobkov</reporter>
                        <labels>
                    </labels>
                <created>Thu, 22 Aug 2024 13:14:16 +0000</created>
                <updated>Tue, 27 Aug 2024 13:11:25 +0000</updated>
                            <resolved>Mon, 26 Aug 2024 13:36:47 +0000</resolved>
                                    <version>3.22.1</version>
                    <version>4.7.0</version>
                                    <fixVersion>3.22.3</fixVersion>
                    <fixVersion>4.4.4</fixVersion>
                    <fixVersion>4.8.0</fixVersion>
                                    <component>camel-sql</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17876634" author="davsclaus" created="Mon, 26 Aug 2024 08:43:36 +0000"  >&lt;p&gt;Can you perhaps provide an unit test in this batch mode that tests this, we can use for looking into implemented a fix.&lt;/p&gt;</comment>
                            <comment id="17876696" author="davsclaus" created="Mon, 26 Aug 2024 12:10:27 +0000"  >&lt;p&gt;Okay I am working on an unit test&lt;/p&gt;</comment>
                            <comment id="17876698" author="davsclaus" created="Mon, 26 Aug 2024 12:16:10 +0000"  >&lt;p&gt;Here is a PR&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/camel/pull/15315&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/15315&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17876812" author="alexanderz" created="Mon, 26 Aug 2024 18:08:30 +0000"  >&lt;p&gt;Thank you for the fix! Would you please backport the fix to Camel 3.22.x line?&#160;&lt;/p&gt;

&lt;p&gt;As of now, it would be problematic for us migrate to Camel 4.x line but willing eagerly to get rid of applied workaround for the issue.&lt;/p&gt;</comment>
                            <comment id="17876939" author="davsclaus" created="Tue, 27 Aug 2024 07:42:55 +0000"  >&lt;p&gt;Okay I found some time to backport to 3.x&lt;/p&gt;</comment>
                            <comment id="17877015" author="alexanderz" created="Tue, 27 Aug 2024 13:11:25 +0000"  >&lt;p&gt;Great! Thanks&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 11 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1r0ns:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>