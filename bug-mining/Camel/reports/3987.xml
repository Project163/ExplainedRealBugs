<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:21:49 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-10782] SFTP: cannot get files from users home with readlock changed</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-10782</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;Camel cannot fetch files from users home directory when using readlock=changed. &lt;/p&gt;

&lt;p&gt;Route from URI is defined like this:&lt;/p&gt;

&lt;p&gt;&amp;lt;from uri=&quot;sftp://testi@server:22?password=password&amp;amp;include=PSOP_123-.*\.(xml|pdf)&amp;amp;delete=true&amp;amp;readLock=changed&amp;amp;readLockTimeout=360000&amp;amp;readLockCheckInterval=180000&amp;amp;readLockMinAge=10s&amp;amp;maxMessagesPerPoll=100&quot;/&amp;gt;&lt;/p&gt;

&lt;p&gt;And from TRACE logs I can see stuff like this:&lt;/p&gt;

&lt;p&gt;2017-02-03 10:59:45,146 | TRACE | //testi@infra:22 | ChangedExclusiveReadLockStrategy | 225 - org.apache.camel.camel-ftp - 2.16.4 | Using full directory listing to update file information for RemoteFile&lt;span class=&quot;error&quot;&gt;&amp;#91;PSOP_123-sdfsd.xml&amp;#93;&lt;/span&gt;. Consider enabling fastExistsCheck option.&lt;br/&gt;
2017-02-03 10:59:45,146 | TRACE | //testi@infra:22 | SftpOperations                   | 225 - org.apache.camel.camel-ftp - 2.16.4 | listFiles&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/check.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
2017-02-03 10:59:45,150 | TRACE | //testi@infra:22 | ChangedExclusiveReadLockStrategy | 225 - org.apache.camel.camel-ftp - 2.16.4 | List files PSOP_123-sdfsd.xml found 23 files&lt;br/&gt;
2017-02-03 10:59:45,150 | TRACE | //testi@infra:22 | ChangedExclusiveReadLockStrategy | 225 - org.apache.camel.camel-ftp - 2.16.4 | Previous last modified: 0, new last modified: 0&lt;br/&gt;
2017-02-03 10:59:45,150 | TRACE | //testi@infra:22 | ChangedExclusiveReadLockStrategy | 225 - org.apache.camel.camel-ftp - 2.16.4 | Previous length: 0, new length: 0&lt;br/&gt;
2017-02-03 10:59:45,150 | TRACE | //testi@infra:22 | ChangedExclusiveReadLockStrategy | 225 - org.apache.camel.camel-ftp - 2.16.4 | New older than threshold: 1486112375150&lt;br/&gt;
2017-02-03 10:59:45,150 | TRACE | //testi@infra:22 | ChangedExclusiveReadLockStrategy | 225 - org.apache.camel.camel-ftp - 2.16.4 | Exclusive read lock not granted. Sleeping for 20000 millis.&lt;/p&gt;


&lt;p&gt;User home directory contains only 1 file, which does match to include parameter. It does seem, that camel-ftp is trying to check file readlock from the server root. &lt;/p&gt;

&lt;p&gt;When placing the files to a subdirectory in users home, this does not happen. &lt;/p&gt;
</description>
                <environment>&lt;p&gt;servicemix 7.0.0, Linux SFTP server&lt;/p&gt;</environment>
        <key id="13040087">CAMEL-10782</key>
            <summary>SFTP: cannot get files from users home with readlock changed</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="StefanR">Stefan Roos</reporter>
                        <labels>
                    </labels>
                <created>Fri, 3 Feb 2017 09:56:46 +0000</created>
                <updated>Tue, 28 Feb 2017 10:01:01 +0000</updated>
                            <resolved>Tue, 28 Feb 2017 10:01:01 +0000</resolved>
                                    <version>2.16.4</version>
                    <version>2.18.2</version>
                                    <fixVersion>2.17.6</fixVersion>
                    <fixVersion>2.18.3</fixVersion>
                    <fixVersion>2.19.0</fixVersion>
                                    <component>camel-ftp</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="15851283" author="davsclaus" created="Fri, 3 Feb 2017 09:59:28 +0000"  >&lt;p&gt;Can rely on the FTP client to provide the timstampe / file size. And if the client returns 0 all the time, then there is nothing Camel can do.&lt;/p&gt;

&lt;p&gt;Can you do TRACE logging from the sub folders where it shows those values.&lt;/p&gt;

&lt;p&gt;Then try to reach out to the FTP client project and see if they can find an issue/bug in their library.&lt;/p&gt;</comment>
                            <comment id="15851411" author="stefanr" created="Fri, 3 Feb 2017 12:14:10 +0000"  >&lt;p&gt;What was apparrently happening was that, when file was created it was zero in length. So camel-ftp went sleeping for short time, because it could not get readlock (minsize 1). After that it tried to reCheck the file, but for some reason from the server root, / , and not from users home, /home/testi/. File count which was reported by camel-ftp, matches the count from that servers root (home dir count would be less than 10 files/dirs).&lt;/p&gt;

&lt;p&gt;I found a way around this by setting source directory to &quot;./&quot; like this:&lt;br/&gt;
&amp;lt;from uri=&quot;sftp://testi@infra:22/./?password=passu&amp;amp;.....&lt;/p&gt;

&lt;p&gt;With that kind of from URI it does seem to work normally.&lt;/p&gt;</comment>
                            <comment id="15851419" author="davsclaus" created="Fri, 3 Feb 2017 12:19:06 +0000"  >&lt;p&gt;Can you try test with latest 2.18.2 release&lt;/p&gt;</comment>
                            <comment id="15855457" author="stefanr" created="Tue, 7 Feb 2017 07:08:08 +0000"  >&lt;p&gt;Yes its the same thing with Camel 2.18.2.&lt;/p&gt;

&lt;p&gt;I created and started following route:&lt;/p&gt;

&lt;p&gt;        from(&quot;sftp://testi@infra:22/&quot;&lt;br/&gt;
        		+&quot;?password=passu&quot;&lt;br/&gt;
        		+&quot;&amp;amp;include=.*xml&quot;&lt;br/&gt;
        		+&quot;&amp;amp;delete=true&quot;&lt;br/&gt;
        		+&quot;&amp;amp;readLock=changed&quot;&lt;br/&gt;
        		+&quot;&amp;amp;readLockTimeout=30000&quot;&lt;br/&gt;
        		+&quot;&amp;amp;readLockCheckInterval=10000&quot;&lt;br/&gt;
        		+&quot;&amp;amp;readLockMinAge=5s&quot;&lt;br/&gt;
        		+&quot;&amp;amp;maxMessagesPerPoll=100&quot;&lt;br/&gt;
        		).routeId(&quot;SFTP-TEST-ROUTE&quot;)&lt;br/&gt;
        .log(&quot;got file ${in.header.camelFileName}&quot;)&lt;br/&gt;
        .to(&quot;file:sftp-files&quot;);&lt;/p&gt;

&lt;p&gt;And then created a file with &quot;cat &amp;gt; test.xml&quot;, now camel firts sees it as empty, so it will sleep.&lt;br/&gt;
Then when trying to check it again:&lt;br/&gt;
[                          main] DefaultCamelContext            INFO  Apache Camel 2.18.2 (CamelContext: camel-1) started in 1.159 seconds&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;ad #0 - sftp://testi@infra:22/&amp;#93;&lt;/span&gt; angedExclusiveReadLockStrategy WARN  Cannot acquire read lock within 30000 millis. Will skip the file: RemoteFile&lt;span class=&quot;error&quot;&gt;&amp;#91;test.xml&amp;#93;&lt;/span&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;ad #0 - sftp://testi@infra:22/&amp;#93;&lt;/span&gt; angedExclusiveReadLockStrategy WARN  Cannot acquire read lock within 30000 millis. Will skip the file: RemoteFile&lt;span class=&quot;error&quot;&gt;&amp;#91;test.xml&amp;#93;&lt;/span&gt;&lt;/p&gt;


&lt;p&gt;And after modifying the route by changing the directory from &quot;/&quot; to &quot;/./&quot;:&lt;br/&gt;
        from(&quot;sftp://testi@infra:22/./&quot;&lt;/p&gt;

&lt;p&gt;And starting it:&lt;/p&gt;

&lt;p&gt;[                          main] DefaultCamelContext            INFO  Apache Camel 2.18.2 (CamelContext: camel-1) started in 1.060 seconds&lt;br/&gt;
[ #0 - sftp://testi@infra:22/./] SFTP-TEST-ROUTE                INFO  got file test.xml&lt;/p&gt;



</comment>
                            <comment id="15855526" author="stefanr" created="Tue, 7 Feb 2017 08:00:36 +0000"  >&lt;p&gt;Added full trace log from camel 2.18.2 session with similar incident. Notice how list file count changes after camel goes to sleeping (from 10 files to 23).&lt;/p&gt;</comment>
                            <comment id="15871638" author="stefanr" created="Fri, 17 Feb 2017 10:42:56 +0000"  >&lt;p&gt;Actually camel is not able to retrieve the files ever from the root of the users home directory, when readLock=changed.&lt;br/&gt;
This is because parent dir is resolved to &quot;/&quot; in SftpChangedExclusiveReadLockStrategy:&lt;/p&gt;

&lt;p&gt;line 81:&lt;br/&gt;
                files = operations.listFiles(file.getParent());&lt;/p&gt;

&lt;p&gt;File absolute path is &quot;test.xml&quot; because leading slash is stripped away from the path,&lt;br/&gt;
so in getParent the parent is resolved to &quot;//&quot;, which will the be normalized in the methods last line to &quot;/&quot;.&lt;br/&gt;
So getParent method returns server root as an argument to listFiles method.&lt;/p&gt;

&lt;p&gt;I don&apos;t know what would be the best way to fix this, but I will continue to investigate it if I have the time...&lt;/p&gt;
</comment>
                            <comment id="15887659" author="davsclaus" created="Tue, 28 Feb 2017 09:36:27 +0000"  >&lt;p&gt;Can you try with fastExistsCheck=true&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12851327" name="camel_2.18.2_sftp_problem_with_homedir" size="87249" author="StefanR" created="Tue, 7 Feb 2017 08:00:36 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 38 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i39klr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>