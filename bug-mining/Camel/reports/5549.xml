<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:44:59 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-13553] OnCompletion behaves strange in combination with direct subroutes</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-13553</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;There is a strange behaviour in .onCompletion().modeBeforeConsumer() when used in combination with direct sub-routes.&lt;/p&gt;

&lt;p&gt;The route behaves differently depending on where onCompletion is declared. When declared in the top of the route it will&#160;execute&#160;several times. Once&#160;for every route, including the subroutes.&lt;/p&gt;

&lt;p&gt;I have made a small spring-boot sample app where I try to demonstrate this behaviour.&lt;br/&gt;
 &lt;a href=&quot;https://github.com/jakobthun/camel-oncompletion-bug&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/jakobthun/camel-oncompletion-bug&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This route:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; ORIGINAL_ROUTE_NAME  = &lt;span class=&quot;code-quote&quot;&gt;&quot;PossibleBug-original-route&quot;&lt;/span&gt;;
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; SUBROUTE_NAME        = &lt;span class=&quot;code-quote&quot;&gt;&quot;PossibleBug-subroute&quot;&lt;/span&gt;;
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; DIRECT_ENDPOINT      = &lt;span class=&quot;code-quote&quot;&gt;&quot;direct:possiblebug&quot;&lt;/span&gt;;

    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void configure() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {

        from(&lt;span class=&quot;code-quote&quot;&gt;&quot;timer:expected?period=10000&amp;amp;delay=5000&quot;&lt;/span&gt;)
                .routeId(ORIGINAL_ROUTE_NAME)
                .onCompletion().modeBeforeConsumer()
                    .log(&lt;span class=&quot;code-quote&quot;&gt;&quot;This should be done once, when the original route is completed i.e. after log 3. But when onCompletion is defined in top of route AND it is in modeBeforeConsumer() it will also be applied to when the direct-route is completed. So it will be executed twice.&quot;&lt;/span&gt;)
                .end()
                .log(&lt;span class=&quot;code-quote&quot;&gt;&quot;1&quot;&lt;/span&gt;)
                .to(DIRECT_ENDPOINT)
                .log(&lt;span class=&quot;code-quote&quot;&gt;&quot;3&quot;&lt;/span&gt;);

        from(DIRECT_ENDPOINT)
                .routeId(SUBROUTE_NAME)
                .log(&lt;span class=&quot;code-quote&quot;&gt;&quot;2&quot;&lt;/span&gt;);

    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;Generates the following log:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2019-05-21 14:50:24.545  INFO 138880 --- [imer://expected] PossibleBug-original-route               : 1
2019-05-21 14:50:24.545  INFO 138880 --- [imer://expected] PossibleBug-subroute                     : 2
2019-05-21 14:50:24.545  INFO 138880 --- [imer://expected] PossibleBug-original-route               : This should be done once, when the original route is completed i.e. after log 3. When onCompletion is defined in top of route it is also applied to the direct-route
2019-05-21 14:50:24.545  INFO 138880 --- [imer://expected] PossibleBug-original-route               : 3
2019-05-21 14:50:24.545  INFO 138880 --- [imer://expected] PossibleBug-original-route               : This should be done once, when the original route is completed i.e. after log 3. When onCompletion is defined in top of route it is also applied to the direct-route

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;As can be seen above the log message defined in onCompletion shows up twice. If onCompletion is defined in the end of the route this will not be the case. Also when using modeAfterConsumer (or not specifying mode) it will&#160;only show up once. See github project to see this example in action.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13234605">CAMEL-13553</key>
            <summary>OnCompletion behaves strange in combination with direct subroutes</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="jakob.thun">Jakob Thun</reporter>
                        <labels>
                    </labels>
                <created>Tue, 21 May 2019 13:06:12 +0000</created>
                <updated>Fri, 8 Jan 2021 13:42:15 +0000</updated>
                            <resolved>Fri, 8 Jan 2021 13:42:15 +0000</resolved>
                                    <version>2.23.2</version>
                    <version>2.24.0</version>
                    <version>3.7.0</version>
                                    <fixVersion>3.7.1</fixVersion>
                    <fixVersion>3.8.0</fixVersion>
                                    <component>came-core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="16845521" author="jakob.thun" created="Wed, 22 May 2019 05:04:32 +0000"  >&lt;p&gt;&lt;b&gt;Made I should add:&lt;/b&gt; If this is the exptected behaviour I think it needs to&#160;be better described in the documenentation.&lt;/p&gt;</comment>
                            <comment id="17260556" author="davsclaus" created="Thu, 7 Jan 2021 14:41:40 +0000"  >&lt;p&gt;Thanks for reporting, I have reproduced this with latest code.&lt;/p&gt;</comment>
                            <comment id="17261272" author="davsclaus" created="Fri, 8 Jan 2021 12:22:32 +0000"  >&lt;p&gt;I have a fix for this. And then I will also look at fixing so if you use global scoped onCompletion then its only triggered once per exchange (currently it is mistakenly called twice).&lt;/p&gt;

&lt;p&gt;The docs is also being cleaned up.&lt;/p&gt;</comment>
                            <comment id="17261309" author="davsclaus" created="Fri, 8 Jan 2021 13:42:15 +0000"  >&lt;p&gt;Thanks for reporting and the test case.&lt;/p&gt;

&lt;p&gt;Sorry for the late response and fix&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 44 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z02wpk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>