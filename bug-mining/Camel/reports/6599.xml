<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 11:03:29 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-20035] Program terminates with OutOfMemoryError</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-20035</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;Given the following route:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Timer {
  ...
  &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; RouteBuilder timerRoute() {
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RouteBuilder() {
      &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; AtomicInteger calls = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; AtomicInteger();

      @Override
      &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void configure() {
        &lt;span class=&quot;code-comment&quot;&gt;// @formatter:off
&lt;/span&gt;        from(
            timer(&lt;span class=&quot;code-quote&quot;&gt;&quot;timer&quot;&lt;/span&gt;)
                .period(Duration.ofMillis(100).toMillis())
                .fixedRate(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;))
            .process(exchange -&amp;gt; {
              log.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;calls: {}&quot;&lt;/span&gt;, calls.incrementAndGet());
              exchange.getIn().setBody(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; LargeObject());
            })
            .log(&lt;span class=&quot;code-quote&quot;&gt;&quot;${body.fieldTwo}&quot;&lt;/span&gt;);
        &lt;span class=&quot;code-comment&quot;&gt;// @formatter:on
&lt;/span&gt;      }
    };
  }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;and the following implementation of &lt;tt&gt;LargeObject&lt;/tt&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;LargeObject {
  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Random RANDOM = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Random();

  &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] data;
  &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; fieldOne;
  &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; fieldTwo;

  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; LargeObject() {
    &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.data = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[100 * 1024 * 1024]; &lt;span class=&quot;code-comment&quot;&gt;// 100 MB
&lt;/span&gt;    RANDOM.nextBytes(data);
    fieldOne = UUID.randomUUID().toString();
    fieldTwo = UUID.randomUUID().toString();
  }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;We would expect that the program runs indefinitely. But if we limit the memory to e.g. ~3.2 GB (which is 10% of the whole system memory in my case) by running:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-bash&quot;&gt;
java \
  -XX:MinRAMPercentage=10 \
  -XX:MaxRAMPercentage=10 \
  -XX:+ExitOnOutOfMemoryError \
  -jar ...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The program terminates with an &lt;tt&gt;OutOfMemoryError&lt;/tt&gt; in the 32nd execution of the route.&lt;/p&gt;

&lt;p&gt;&#8212;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/turing85/camel-lru-cache&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Reproducer 1 (pure camel, &lt;tt&gt;github.com&lt;/tt&gt;)&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://github.com/turing85/quarkus-camel-lru-cache&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Reproducer 2 (quarkus camel, allow to define the size of the &lt;tt&gt;LargeObject&lt;/tt&gt;, &lt;tt&gt;github.com&lt;/tt&gt;)&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;For both repositories, please read the &lt;tt&gt;README.adoc&lt;/tt&gt; for instructions.&lt;/p&gt;

&lt;p&gt;&#8212;&lt;/p&gt;

&lt;p&gt;Observations:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;For the quarkus-sample and a heap-limitation of ~3.2 GB, the breaking point is an &lt;tt&gt;object.size&lt;/tt&gt; of &lt;tt&gt;2047K&lt;/tt&gt;/&lt;tt&gt;2048K&lt;/tt&gt;. With &lt;tt&gt;2047K&lt;/tt&gt;, the program runs indefinitely, with &lt;tt&gt;2048K&lt;/tt&gt;, the program crashes.&lt;/li&gt;
	&lt;li&gt;The problem also exist in native mode, but the breaking point is different&lt;/li&gt;
	&lt;li&gt;Looking at the implementation of the &lt;a href=&quot;https://github.com/apache/camel/blob/HEAD/core/camel-support/src/main/java/org/apache/camel/support/DefaultLRUCacheFactory.java#L150&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;SimpleLRUCache&lt;/tt&gt; (&lt;tt&gt;github.com&lt;/tt&gt;)&lt;/a&gt;, it seems that this class is not using &lt;tt&gt;SoftReference&lt;/tt&gt; s or &lt;tt&gt;WeakReference&lt;/tt&gt; s. As far as I understand it, this means that if 1000 elements of whatever is stored in this cache exceed the heap limit of the JVM, the program will throw an &lt;tt&gt;OutOfMemoryError&lt;/tt&gt; .&lt;/li&gt;
	&lt;li&gt;Conversely, this means that if a program &quot;survives&quot; the first 1000 calls, it will (most likely) run indefinitely.&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="13555232">CAMEL-20035</key>
            <summary>Program terminates with OutOfMemoryError</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="turing85">Marco Bungart</reporter>
                        <labels>
                    </labels>
                <created>Mon, 23 Oct 2023 18:47:29 +0000</created>
                <updated>Wed, 25 Oct 2023 07:27:23 +0000</updated>
                            <resolved>Wed, 25 Oct 2023 07:27:23 +0000</resolved>
                                    <version>4.0.0</version>
                                    <fixVersion>3.20.9</fixVersion>
                    <fixVersion>3.21.3</fixVersion>
                    <fixVersion>3.22.0</fixVersion>
                    <fixVersion>4.0.3</fixVersion>
                    <fixVersion>4.2.0</fixVersion>
                                    <component>camel-core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17778793" author="JIRAUSER297305" created="Mon, 23 Oct 2023 19:17:01 +0000"  >&lt;p&gt;I think using SoftReference is interesting in this case.&#160;&lt;/p&gt;</comment>
                            <comment id="17778800" author="JIRAUSER285210" created="Mon, 23 Oct 2023 19:43:39 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rhuanrocha&quot; class=&quot;user-hover&quot; rel=&quot;rhuanrocha&quot;&gt;rhuanrocha&lt;/a&gt; If we look around in the class where &lt;tt&gt;SimpleLRUCache&lt;/tt&gt; is defined, we find &lt;a href=&quot;https://github.com/apache/camel/blob/HEAD/core/camel-support/src/main/java/org/apache/camel/support/DefaultLRUCacheFactory.java#L98-L148&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;methods that suggest that there should be implementations for both &lt;tt&gt;SoftReference&lt;/tt&gt; s and &lt;tt&gt;WeakReference&lt;/tt&gt; s&lt;/a&gt;. I suspect that, historically, there we such implementations, but that they got removed.&lt;/p&gt;</comment>
                            <comment id="17778811" author="JIRAUSER297305" created="Mon, 23 Oct 2023 20:05:49 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=turing85&quot; class=&quot;user-hover&quot; rel=&quot;turing85&quot;&gt;turing85&lt;/a&gt;, make sense! Looks like the implementation has changed to use the Caffeine, and after the Caffeine was removed. Look at the commit below.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/camel/commit/98db54340e3c6071afedc3f129147b552eae4fb9&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/commit/98db54340e3c6071afedc3f129147b552eae4fb9&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17778969" author="davsclaus" created="Tue, 24 Oct 2023 07:31:11 +0000"  >&lt;p&gt;Its &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-19487&quot; title=&quot;camel-core / camel-bean - Dynamic router instances pass messages to wrong endpoints with @DynamicRouter annotation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-19487&quot;&gt;&lt;del&gt;CAMEL-19487&lt;/del&gt;&lt;/a&gt; that is causing a problem, the cache is not reusing as its per instance based instead of class type.&lt;/p&gt;</comment>
                            <comment id="17778977" author="davsclaus" created="Tue, 24 Oct 2023 08:00:47 +0000"  >&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;l-1) thread #1 - timer://timer&amp;#93;&lt;/span&gt; route1                         INFO  f9c92be3-d97e-4b40-926e-c1e9781364aa&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;l-1) thread #1 - timer://timer&amp;#93;&lt;/span&gt; Timer$1                        INFO  calls: 131&lt;/p&gt;</comment>
                            <comment id="17779011" author="davsclaus" created="Tue, 24 Oct 2023 09:50:59 +0000"  >&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;l-1) thread #1 - timer://timer&amp;#93;&lt;/span&gt; route1                         INFO  b705b8cb-946e-479b-b1d6-66b1868f5210&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;l-1) thread #1 - timer://timer&amp;#93;&lt;/span&gt; Timer$1                        INFO  calls: 3875&lt;/p&gt;</comment>
                            <comment id="17779014" author="davsclaus" created="Tue, 24 Oct 2023 10:11:20 +0000"  >&lt;p&gt;Okay so there are two things&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;the bean info cache was instance based (&lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-19487&quot; title=&quot;camel-core / camel-bean - Dynamic router instances pass messages to wrong endpoints with @DynamicRouter annotation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-19487&quot;&gt;&lt;del&gt;CAMEL-19487&lt;/del&gt;&lt;/a&gt;) which is only in need for a rare use-case &lt;b&gt;DONE&lt;/b&gt;&lt;/li&gt;
	&lt;li&gt;soft reference was no longer in use which needs to be added into the simple lru cache&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17779038" author="davsclaus" created="Tue, 24 Oct 2023 12:03:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/apache/camel/blob/camel-2.10.6/camel-core/src/main/java/org/apache/camel/util/LRUSoftCache.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/blob/camel-2.10.6/camel-core/src/main/java/org/apache/camel/util/LRUSoftCache.java&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13541003">CAMEL-19487</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13555336">CAMEL-20038</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13555338">CAMEL-20039</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13554382">CAMEL-19999</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 3 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1l50g:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>