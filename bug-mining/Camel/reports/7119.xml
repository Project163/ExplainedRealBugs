<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 11:11:00 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-22021] camel-test - NPE on DefaultMessage.typeConverter in CSB with AdviceWith happens randomly</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-22021</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;When upgrading from Camel 4.4.5 to Camel 4.8.6 or 4.10.3 or 4.11.0, some unit tests fail randomly with the following error:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.NullPointerException: Cannot invoke &lt;span class=&quot;code-quote&quot;&gt;&quot;org.apache.camel.TypeConverter.convertTo(java.lang.&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;, org.apache.camel.Exchange, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;)&quot;&lt;/span&gt; because &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.typeConverter&quot;&lt;/span&gt; is &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
&#160; &#160; &#160;at org.apache.camel.support.DefaultMessage.getHeader(DefaultMessage.java:173)
&#160; &#160; &#160;at org.apache.camel.processor.aggregate.AggregateProcessor.isCompleteAllGroups(AggregateProcessor.java:447)
&#160; &#160; &#160;at org.apache.camel.processor.aggregate.AggregateProcessor.doProcess(AggregateProcessor.java:333)
&#160; &#160; &#160;at org.apache.camel.processor.aggregate.AggregateProcessor.process(AggregateProcessor.java:319)
&#160; &#160; &#160;at org.apache.camel.processor.errorhandler.RedeliveryErrorHandler$SimpleTask.handleFirst(RedeliveryErrorHandler.java:440)
&#160; &#160; &#160;at org.apache.camel.processor.errorhandler.RedeliveryErrorHandler$SimpleTask.run(RedeliveryErrorHandler.java:416)
&#160; &#160; &#160;at org.apache.camel.impl.engine.DefaultReactiveExecutor$Worker.doRun(DefaultReactiveExecutor.java:199)
&#160; &#160; &#160;at org.apache.camel.impl.engine.DefaultReactiveExecutor$Worker.executeReactiveWork(DefaultReactiveExecutor.java:189)
&#160; &#160; &#160;at org.apache.camel.impl.engine.DefaultReactiveExecutor$Worker.tryExecuteReactiveWork(DefaultReactiveExecutor.java:166)
&#160; &#160; &#160;at org.apache.camel.impl.engine.DefaultReactiveExecutor$Worker.schedule(DefaultReactiveExecutor.java:148)
&#160; &#160; &#160;at org.apache.camel.impl.engine.DefaultReactiveExecutor.scheduleMain(DefaultReactiveExecutor.java:59)
&#160; &#160; &#160;at org.apache.camel.processor.Pipeline.process(Pipeline.java:163)
&#160; &#160; &#160;at org.apache.camel.impl.engine.CamelInternalProcessor.processNonTransacted(CamelInternalProcessor.java:347)
&#160; &#160; &#160;at org.apache.camel.impl.engine.CamelInternalProcessor.process(CamelInternalProcessor.java:323)
&#160; &#160; &#160;at org.apache.camel.impl.engine.DefaultAsyncProcessorAwaitManager.process(DefaultAsyncProcessorAwaitManager.java:82)
&#160; &#160; &#160;at org.apache.camel.support.AsyncProcessorSupport.process(AsyncProcessorSupport.java:32)
&#160; &#160; &#160;at org.apache.camel.component.google.pubsub.consumer.CamelMessageReceiver.receiveMessage(CamelMessageReceiver.java:70)
&#160; &#160; &#160;at com.google.cloud.pubsub.v1.MessageDispatcher$3.run(MessageDispatcher.java:552)
&#160; &#160; &#160;at java.base/java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:572)
&#160; &#160; &#160;at java.base/java.util.concurrent.FutureTask.run(FutureTask.java:317)
&#160; &#160; &#160;at java.base/java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:304)
&#160; &#160; &#160;at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1144)
&#160; &#160; &#160;at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:642)
&#160; &#160; &#160;at java.base/java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:1583)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The failure is random (once every 3-4 runs)&lt;/li&gt;
	&lt;li&gt;The unit tests use @CamelSpringBootTest and @UseAdviceWith and start the context manually: context.start()&lt;/li&gt;
	&lt;li&gt;The tests that fail seem to always use message aggregation (org.apache.camel.processor.aggregate.AggregateProcessor)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The error being triggered randomly I cannot come up with a simple reproducer test case.&lt;br/&gt;
I can share code and more details if needed.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13616358">CAMEL-22021</key>
            <summary>camel-test - NPE on DefaultMessage.typeConverter in CSB with AdviceWith happens randomly</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="vpaturet">Vincent Paturet</reporter>
                        <labels>
                    </labels>
                <created>Fri, 25 Apr 2025 09:12:10 +0000</created>
                <updated>Sun, 2 Nov 2025 09:36:58 +0000</updated>
                                            <version>4.8.6</version>
                    <version>4.10.3</version>
                    <version>4.11.0</version>
                                    <fixVersion>4.x</fixVersion>
                                    <component>camel-spring-boot</component>
                    <component>camel-test</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17947337" author="davsclaus" created="Fri, 25 Apr 2025 14:05:33 +0000"  >&lt;p&gt;Can you investigate more about &quot;some unit test&quot; that fails. Is it always the same unit tests, and do they all start from pubsub or are there a mix of different components.&lt;/p&gt;

&lt;p&gt;And since this is just testing then its not so important. Do you see any issue in production. Also are this only the tests that use advice-with. And then try to use older Camel versions so you can see if you can find out a version where it started changing, as the gap between 4.4 to 4.8 is big. So try with 4.8.0, and then go backwards.&lt;/p&gt;</comment>
                            <comment id="17947811" author="JIRAUSER279918" created="Mon, 28 Apr 2025 12:28:30 +0000"  >&lt;p&gt;As far as I can see, it is always the same unit tests that fail, and they all start from pubsub, and they all use advice-with.&lt;/p&gt;

&lt;p&gt;The error is triggered from a thread belonging to the pubsub thread pool (thead name = &lt;span class=&quot;error&quot;&gt;&amp;#91;GAX-n&amp;#93;&lt;/span&gt;).&lt;br/&gt;
I cannot confirm that it affects only unit tests: we did not take the risk to roll out this version in production before clarifying the root cause of this bug.&lt;br/&gt;
The bug can be reproduced with Camel 4.7.0. I cannot reproduce it with Camel 4.6.0.&lt;/p&gt;</comment>
                            <comment id="17949244" author="davsclaus" created="Sun, 4 May 2025 08:24:07 +0000"  >&lt;p&gt;Can you put together your unit test and attach as .zip to this Jira then its easier to try to take a look&lt;/p&gt;</comment>
                            <comment id="17949380" author="JIRAUSER279918" created="Mon, 5 May 2025 07:14:13 +0000"  >&lt;p&gt;This is open-source: &lt;a href=&quot;https://github.com/entur/marduk/pull/674&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/entur/marduk/pull/674&lt;/a&gt;&lt;br/&gt;
But I can also attach a zip if you find it more convenient?&lt;/p&gt;</comment>
                            <comment id="17949460" author="davsclaus" created="Mon, 5 May 2025 14:54:44 +0000"  >&lt;p&gt;Thanks the GH link is okay - then we can checkout the code from there. A bit busy currently but will report back when we have time to look into this.&lt;/p&gt;

&lt;p&gt;In the mean time I did polish the main branch a bit in terms of pubsub start/stop ordering. But this is SNAPSHOT code so not as easy for you guys to try and test with&lt;/p&gt;</comment>
                            <comment id="17949690" author="davsclaus" created="Tue, 6 May 2025 11:38:47 +0000"  >&lt;p&gt;I cannot build your PR&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;ERROR&amp;#93;&lt;/span&gt; Failed to execute goal org.apache.maven.plugins:maven-dependency-plugin:3.8.1:copy (copy-pubsub-emulator) on project marduk: Unable to find/resolve artifact.: The following artifacts could not be resolved: com.google.cloud:pubsub-emulator:jar:0.1.2 (absent): Could not find artifact com.google.cloud:pubsub-emulator:jar:0.1.2 in central (&lt;a href=&quot;https://repo.maven.apache.org/maven2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://repo.maven.apache.org/maven2&lt;/a&gt;) -&amp;gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;Help 1&amp;#93;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="17949909" author="JIRAUSER279918" created="Wed, 7 May 2025 06:45:15 +0000"  >&lt;p&gt;In our CI environment we download the Google PubSub emulator from a private Maven repository.&lt;br/&gt;
If you want to run the tests locally, you need some additional configuration:&lt;br/&gt;
1) install the Google Cloud SDK with the PubSub emulator&lt;br/&gt;
2) switch this property to true: &lt;a href=&quot;https://github.com/entur/marduk/blob/40bddd88ed650ef132b810ebbd4e41fbc55184e5/pom.xml#L28&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/entur/marduk/blob/40bddd88ed650ef132b810ebbd4e41fbc55184e5/pom.xml#L28&lt;/a&gt;&lt;br/&gt;
3) update this property to point to the pubsub emulator jar file that is shipped with the Google Cloud SDK: &lt;a href=&quot;https://github.com/entur/marduk/blob/40bddd88ed650ef132b810ebbd4e41fbc55184e5/src/test/resources/application.properties#L51&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/entur/marduk/blob/40bddd88ed650ef132b810ebbd4e41fbc55184e5/src/test/resources/application.properties#L51&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;(I have updated the PR to make it easier to configure)&lt;/p&gt;

&lt;p&gt;If this is not practical for you, I can switch the test configuration to TestContainers (but then the tests will not run in parallel anymore and the bug might be more difficult to reproduce)&lt;/p&gt;</comment>
                            <comment id="17950202" author="davsclaus" created="Thu, 8 May 2025 07:18:35 +0000"  >&lt;p&gt;Can you add the emulator JAR to the PR and make the pom xml use the local JAR file so its easy to run without installing anything from google&lt;/p&gt;</comment>
                            <comment id="17950215" author="JIRAUSER279918" created="Thu, 8 May 2025 08:34:44 +0000"  >&lt;p&gt;Sure, the PR contains now the jar file and the required configuration.&lt;/p&gt;</comment>
                            <comment id="17950225" author="davsclaus" created="Thu, 8 May 2025 09:17:07 +0000"  >&lt;p&gt;okay I cannot get this kind of error. But your project is way to big for anyone to want to try to track down anything.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Camel 4.10.3 or 4.10.4&lt;/p&gt;

&lt;p&gt;$ mvn clean instal&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;INFO&amp;#93;&lt;/span&gt; Results:&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;INFO&amp;#93;&lt;/span&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;INFO&amp;#93;&lt;/span&gt; Tests run: 101, Failures: 0, Errors: 0, Skipped: 0&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;You need to make some smaller project isolated on something. Also when using advice with you need to mark this in your tests with&#160; @UseAdviceWith&lt;/p&gt;</comment>
                            <comment id="17950229" author="JIRAUSER279918" created="Thu, 8 May 2025 09:39:51 +0000"  >&lt;p&gt;All the tests that use advice with have the annotation &#160;@UseAdviceWith set through their superclass.&lt;br/&gt;
&lt;a href=&quot;https://github.com/entur/marduk/blob/3cd23285cd761a7f982a7431a6edaa2c4ce313da/src/test/java/no/rutebanken/marduk/MardukRouteBuilderIntegrationTestBase.java#L35&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/entur/marduk/blob/3cd23285cd761a7f982a7431a6edaa2c4ce313da/src/test/java/no/rutebanken/marduk/MardukRouteBuilderIntegrationTestBase.java#L35&lt;/a&gt;&lt;br/&gt;
Do you mean the annotation is not inherited?&lt;/p&gt;</comment>
                            <comment id="17959714" author="davsclaus" created="Wed, 11 Jun 2025 11:06:13 +0000"  >&lt;p&gt;I think its inherited - but again if you can reduce the code base to only be the random failing tests then that can help investigate. Otherwise we can&apos;t really help you.&lt;/p&gt;</comment>
                            <comment id="18034828" author="davsclaus" created="Sun, 2 Nov 2025 09:36:58 +0000"  >&lt;p&gt;If you get a chance then you are welcome to try with latest 4.14.2 release or 4.16.0 etc&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13627774">CAMEL-22396</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 week, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1vju0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>