<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 11:01:19 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-19409] camel-salesforce - Can not re-subscribe to CDC channel data/ChangeEvents</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-19409</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;Hello, I have problem with connection to the salesforce channel ChangeEvents. I am using quarkus - version 2.13.7 and camel with version 3.18.3 and when an error occurs my application is not re-subscribing to the channel after that. Do you know if it is problem from the camel version or do you have any idea how I can fix it? Thank you in advance&lt;/p&gt;

&lt;p&gt;Edit 1: You can find the stacktrace of the exception in this file &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13058750/13058750_stacktrace.txt&quot; title=&quot;stacktrace.txt attached to CAMEL-19409&quot;&gt;stacktrace.txt&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&#160;&lt;/p&gt;

&lt;p&gt;The problem seems to be fixed after a restart of the pod but it is not relevant solution. I have seen similar issue that is said to be fixed in version 3.14&#160; but it looks like now I have the same problem in latest version &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-16370&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CAMEL-16370&lt;/a&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13538587">CAMEL-19409</key>
            <summary>camel-salesforce - Can not re-subscribe to CDC channel data/ChangeEvents</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="5">Cannot Reproduce</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="iva123">Iva</reporter>
                        <labels>
                    </labels>
                <created>Fri, 2 Jun 2023 11:41:25 +0000</created>
                <updated>Sat, 16 Dec 2023 16:32:07 +0000</updated>
                            <resolved>Mon, 27 Nov 2023 09:29:58 +0000</resolved>
                                    <version>3.18.3</version>
                    <version>3.19.0</version>
                                    <fixVersion>4.x</fixVersion>
                                    <component>camel-salesforce</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="17728719" author="davsclaus" created="Fri, 2 Jun 2023 12:15:43 +0000"  >&lt;p&gt;Its salesforce that says that the login is invalid 401. Try with newer Camel version and try without Quarkus if you can use 3.20.x or newer.&lt;/p&gt;</comment>
                            <comment id="17729492" author="jsight" created="Mon, 5 Jun 2023 22:23:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davsclaus&quot; class=&quot;user-hover&quot; rel=&quot;davsclaus&quot;&gt;davsclaus&lt;/a&gt; We are having the same issue. I have found that restarting SubscriptionHelper via .stop() and .start() resolves the issue, but there are no public methods to do this.&lt;/p&gt;

&lt;p&gt;Consumer.stop() and Consumer.start() do not do the same thing. Is there some way that this could be exposed via the API?&lt;/p&gt;</comment>
                            <comment id="17730005" author="davsclaus" created="Wed, 7 Jun 2023 08:39:17 +0000"  >&lt;p&gt;We can add public methods to that helper, and maybe we can find a way to restart the helper (the code is a bit complex, and salesforce uses old cometd protocol, that is harder to maintain)&lt;/p&gt;</comment>
                            <comment id="17730006" author="davsclaus" created="Wed, 7 Jun 2023 08:40:54 +0000"  >&lt;p&gt;Jesse, you are welcome to add those methods and send a PR - use the camel-3.x branch as 3.19.0 is not a LTS release, so a fix will be intended for 3.20.x, 3.21.x etc. &lt;/p&gt;</comment>
                            <comment id="17730007" author="davsclaus" created="Wed, 7 Jun 2023 08:45:52 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jeremyross&quot; class=&quot;user-hover&quot; rel=&quot;jeremyross&quot;&gt;jeremyross&lt;/a&gt; not sure if you may have seen similar issue with your use of camel-salesforce ?&lt;/p&gt;</comment>
                            <comment id="17730193" author="jsight" created="Wed, 7 Jun 2023 16:28:59 +0000"  >&lt;p&gt;We are finding that this happens any time that the underlying access token is invalidated. I can work on sending an MR for it.&lt;/p&gt;</comment>
                            <comment id="17730198" author="jsight" created="Wed, 7 Jun 2023 16:44:56 +0000"  >&lt;p&gt;I have sent a PR here: &lt;a href=&quot;https://github.com/apache/camel/pull/10286&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/10286&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;One odd thing that I noticed while doing this... subscriptionhelper calls session.logout() during its stop method. Is that intentional? It seems to me that session.logout() is normally called via session.stop() anyway?&lt;/p&gt;</comment>
                            <comment id="17731323" author="davsclaus" created="Sun, 11 Jun 2023 09:48:17 +0000"  >&lt;p&gt;Jesse, your PR will not fix this out of the box, but allow you to do some manual re-connect by forcing a stop and start of the subscription helper.&lt;/p&gt;

&lt;p&gt;The code/logic for handling salesforce connection and self-healing in camel-salesforce is a bit complex and &quot;ugly&quot;. The salesforce API is using old cometd protocols so its not a commonly used standard today.&lt;/p&gt;
</comment>
                            <comment id="17731324" author="davsclaus" created="Sun, 11 Jun 2023 09:50:13 +0000"  >&lt;p&gt;Sometimes when you have such complex logic for trying to self-heal, then its easier to do like &quot;connection pools&quot; that would just invalidate a connection, and create a new fresh. However camel-salesforce have 1 shared instance of subscription helper, and 1 shared instance of session.&lt;/p&gt;
</comment>
                            <comment id="17731922" author="davsclaus" created="Tue, 13 Jun 2023 07:23:12 +0000"  >&lt;p&gt;The stop method from Jesse has been backported to 3.21 and 3.20.6 as well. This can be used as work-around, but requires to call it via Java&lt;/p&gt;</comment>
                            <comment id="17731926" author="JIRAUSER300706" created="Tue, 13 Jun 2023 07:40:06 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jsight&quot; class=&quot;user-hover&quot; rel=&quot;jsight&quot;&gt;jsight&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davsclaus&quot; class=&quot;user-hover&quot; rel=&quot;davsclaus&quot;&gt;davsclaus&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;Does this mean we would have to catch the SalesForce exception and invoke the added public methods .stop + .start?&lt;/p&gt;</comment>
                            <comment id="17731987" author="davsclaus" created="Tue, 13 Jun 2023 08:37:28 +0000"  >&lt;p&gt;As a workaround you can do that, or have some manual code you can invoke that calls the stop(true) method.&lt;/p&gt;

&lt;p&gt;To make a real fix then we need more time to reproduce, and catch that 401, and make it restart automatic.&lt;br/&gt;
However there are some code in other places where 401 is caught and &quot;restarted&quot; so if anyone has time to investigate then check this code, and see if you can do something similar in the place where you get this exception (see stacktrace file).&lt;/p&gt;

&lt;p&gt;And if you have a test platform where you can test this, then that would be great.&lt;/p&gt;</comment>
                            <comment id="17732748" author="jsightle@redhat.com" created="Wed, 14 Jun 2023 20:24:03 +0000"  >&lt;p&gt;Yes, in our case we already had the logic to retry by stop/start when we saw unexpectedly low message volume. It just didn&apos;t work since the connection wasn&apos;t there.&lt;/p&gt;

&lt;p&gt;I did notice that that code for picking up 401, but for some reason this doesn&apos;t seem to recover on its own.&lt;/p&gt;</comment>
                            <comment id="17732749" author="jsightle@redhat.com" created="Wed, 14 Jun 2023 20:24:39 +0000"  >&lt;p&gt;I found it was possible to reproduce it by manually logging out the current token while still connected. It would never recover once that happened.&lt;/p&gt;</comment>
                            <comment id="17736775" author="jeremyross" created="Sat, 24 Jun 2023 18:47:17 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jsightle%40redhat.com&quot; class=&quot;user-hover&quot; rel=&quot;jsightle@redhat.com&quot;&gt;jsightle@redhat.com&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iva123&quot; class=&quot;user-hover&quot; rel=&quot;iva123&quot;&gt;iva123&lt;/a&gt; It&apos;s not clear to me why you&apos;d receive a 401 in the META_SUBSCRIBE channel, but I created a PR (&lt;a href=&quot;https://github.com/apache/camel/pull/10286&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/10286&lt;/a&gt;) which will re-login and re-subscribe if this happens. I can&apos;t reproduce this situation, so can someone please see if this helps?&#160;&lt;/p&gt;</comment>
                            <comment id="17736789" author="jeremyross" created="Sat, 24 Jun 2023 20:25:25 +0000"  >&lt;p&gt;Side note, I recommend checking out Camel&apos;s upcoming support for salesforce&apos;s Pub/Sub API. This API has many advantages, and is the future of event streaming from salesforce. I would really appreciate some folks kicking the tires on this one.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://camel.apache.org/components/next/salesforce-component.html#PubSubAPI&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://camel.apache.org/components/next/salesforce-component.html#PubSubAPI&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17737311" author="jsightle@redhat.com" created="Mon, 26 Jun 2023 18:57:13 +0000"  >&lt;p&gt;It is reproducible, but the steps are a bit convoluted.&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Start multiple processes, at least one of which is running and one has the route defined, but the route is not started&lt;/li&gt;
	&lt;li&gt;Shutdown the one that is running. This will trigger logout and invalidate the token&lt;/li&gt;
	&lt;li&gt;Without restarting any processes, tell the one that was stopped to start its routes. At this point, this one will start throwing errors and cannot recover.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Interestingly, this means that normal manual intervention steps, like restarting containers, can have damaging consequences.&lt;/p&gt;

&lt;p&gt;I will try out your PR.&lt;/p&gt;

&lt;p&gt;FYI - We do plan to look at the pubsub approach with grpc when it is available. I&apos;m not sure if our salesforce instance has it at this time.&lt;/p&gt;</comment>
                            <comment id="17737340" author="jsightle@redhat.com" created="Mon, 26 Jun 2023 20:31:06 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jeremyross&quot; class=&quot;user-hover&quot; rel=&quot;jeremyross&quot;&gt;jeremyross&lt;/a&gt; - I have tried the PR, and it failed in a different way. It seems that the error text is in msg, and failureReason is null.&lt;/p&gt;</comment>
                            <comment id="17737345" author="jsightle@redhat.com" created="Mon, 26 Jun 2023 20:55:45 +0000"  >&lt;p&gt;I made a few changes:&lt;br/&gt;
&lt;tt&gt;code&lt;/tt&gt;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;} else if (failureReason.equals(AUTHENTICATION_INVALID)) 
{
+                        }
&lt;p&gt; else if (error != null &amp;amp;&amp;amp; error.equals(AUTHENTICATION_INVALID)) &lt;/p&gt;
{
+                            LOG.info(
+                                    &quot;attempting login due to handshake error: 403 -&amp;gt; 401::Authentication invalid&quot;);
+                            attemptLoginUntilSuccessful();
+                            subscribe(topicName, consumer, true);
+                        }
&lt;p&gt; else if (msg != null &amp;amp;&amp;amp; msg.equals(AUTHENTICATION_INVALID)) &lt;/p&gt;
{
+                            LOG.info(
+                                    &quot;attempting login due to handshake error: 403 -&amp;gt; 401::Authentication invalid&quot;);
+                            attemptLoginUntilSuccessful();
+                            subscribe(topicName, consumer, true);
+                        }
&lt;p&gt; else if (failureReason != null &amp;amp;&amp;amp; failureReason.equals(AUTHENTICATION_INVALID)) {&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&lt;tt&gt;code&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;With these changes, it seems to momentraily get stuck in a loop trying to auth. However, after some minutes it does seem to recover on its own. I guess that is an improvement? &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;IMO, the ideal response in this state is actually to restart the whole connection instead of just subscribing again, though. Just subscribing again on the same connection doesn&apos;t seem to be enough, as the underlying connection has been invalidated by the other end.&lt;/p&gt;</comment>
                            <comment id="17743244" author="davsclaus" created="Fri, 14 Jul 2023 17:50:39 +0000"  >&lt;p&gt;Yeah I wonder if its possible at all to use a &lt;em&gt;connection pooling&lt;/em&gt; approach (we can use commons-pool) where a new connection will always be created again if there is a problem with any existing. This is what usually is done by old tech like JDBC and JMS.&lt;/p&gt;</comment>
                            <comment id="17789872" author="jeremyross" created="Mon, 27 Nov 2023 00:33:00 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jsightle%40redhat.com&quot; class=&quot;user-hover&quot; rel=&quot;jsightle@redhat.com&quot;&gt;jsightle@redhat.com&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davsclaus&quot; class=&quot;user-hover&quot; rel=&quot;davsclaus&quot;&gt;davsclaus&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iva123&quot; class=&quot;user-hover&quot; rel=&quot;iva123&quot;&gt;iva123&lt;/a&gt; I&apos;ve spent the weekend trying to reproduce this issue, without success. &lt;/p&gt;

&lt;p&gt;Here&apos;s what I&apos;ve tried:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Single camel context
	&lt;ul&gt;
		&lt;li&gt;Two streaming api consumer routes, only 1 set to auto-start.&lt;/li&gt;
		&lt;li&gt;After 5 minutes, stop the running route.&lt;/li&gt;
		&lt;li&gt;After 5 minutes, start the route that was never started.&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Single camel context
	&lt;ul&gt;
		&lt;li&gt;After 5 minutes, call session.logout()&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Single camel context
	&lt;ul&gt;
		&lt;li&gt;After 5 minutes, call set session token to a random string&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Multiple camel contexts, all with a single streaming api consumer route
	&lt;ul&gt;
		&lt;li&gt;Context A: Auto-started route. Stop and start the route at random intervals&lt;/li&gt;
		&lt;li&gt;Context B: Initially stopped route. Stop and start the route at random intervals&lt;/li&gt;
		&lt;li&gt;Context C: Auto-started route that is never stopped&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Is anyone still having this issue? If we can&apos;t get a reproducer, I&apos;d be inclined to close this issue.&lt;/p&gt;</comment>
                            <comment id="17789992" author="davsclaus" created="Mon, 27 Nov 2023 09:29:50 +0000"  >&lt;p&gt;okay lets close this - and end users can report back here or create a new ticket (as they often do).&lt;/p&gt;</comment>
                            <comment id="17790162" author="jsightle@redhat.com" created="Mon, 27 Nov 2023 16:19:15 +0000"  >&lt;p&gt;Were these running in separate VMs?&lt;/p&gt;</comment>
                            <comment id="17790213" author="jeremyross" created="Mon, 27 Nov 2023 18:46:40 +0000"  >&lt;p&gt;The multiple camel context test was separate processes, but on same machine.&lt;/p&gt;</comment>
                            <comment id="17790218" author="jsightle@redhat.com" created="Mon, 27 Nov 2023 18:49:50 +0000"  >&lt;p&gt;For me, that was the scenarios that caused issues. Once one of the VMs called .logout(), the token would no longer be valid and others would fail. This means another precondition is that sfdc is giving the same auth token to all clients. I&apos;m not sure if an sfdc setting controls that behavior or not, but I&apos;ve seen it a lot with our clients.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13060873" name="stack-with-pr.txt" size="7965" author="jsightle@redhat.com" created="Mon, 26 Jun 2023 20:30:23 +0000"/>
                            <attachment id="13058750" name="stacktrace.txt" size="5268" author="iva123" created="Fri, 2 Jun 2023 11:56:38 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 50 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1iats:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>