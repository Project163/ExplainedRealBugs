<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:44:23 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-15718] Camel lumberjack server component not thread safe</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-15718</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;I am new to camel. I use a filebeat source that delivers logfile data over the lumberjack v2 batch protocol. As a receiving server I use the camel lumberjack component to further process the data in a camel pipeline.&lt;/p&gt;

&lt;p&gt;I realized that the LumberjackSessionHandler of camels lumberjack component is not stateless but is being used by camel for all parallel lumberjack connection requests. Thus, new incoming connections with their own batch windows mess up any ongoing process of the already existing window, e.g. window size settings and counting acknowledges.&lt;/p&gt;

&lt;p&gt;Many different combinations of multicast().parallelProcessing().threads(...) with filebeats workers/pipelines showed the same result.&lt;/p&gt;

&lt;p&gt;The states of the stateful LumberjackSessionHandler are mixed up and the handling of parallel windows is broken which results in unwanted/unfinished acknowledges. As a result it hangs up the whole communication process to the filebeat source.&lt;/p&gt;

&lt;p&gt;The LumberjackSessionHandler is not able to handle multiple threads, but camel uses it as it would be able to. &lt;/p&gt;

&lt;p&gt;How can I tell camel to use separate LumberjackSessionHandlers and processing pipelines for each lumberjack batch request? Or do I misunderstand the concept of how camel uses components?&lt;/p&gt;

&lt;p&gt;Sorry, I wasn&apos;t able to find a more specific &quot;camel-lumberjack&quot; component in the list of issue proposals above so I selected camel-core...&lt;/p&gt;</description>
                <environment>&lt;p&gt;camel 3.5.0, filebeat 7.9.1, jdk 1.8.0_242, Debian 10, Linux 4.19.0-6-amd64&lt;/p&gt;</environment>
        <key id="13336367">CAMEL-15718</key>
            <summary>Camel lumberjack server component not thread safe</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="zbendhiba">Zineb Bendhiba</assignee>
                                    <reporter username="ezett">Erik Zimmermann</reporter>
                        <labels>
                    </labels>
                <created>Tue, 20 Oct 2020 20:11:14 +0000</created>
                <updated>Tue, 8 Dec 2020 06:15:15 +0000</updated>
                            <resolved>Tue, 8 Dec 2020 06:15:15 +0000</resolved>
                                    <version>3.5.0</version>
                    <version>3.6.0</version>
                                    <fixVersion>3.7.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17217910" author="bedla" created="Tue, 20 Oct 2020 20:22:06 +0000"  >&lt;p&gt;All session data in&#160;LumberjackSessionHandler are stored as field variables and thus shared between different threads/channels.&lt;/p&gt;

&lt;p&gt;These variables needs to be moved to Channel attributes - &lt;a href=&quot;https://netty.io/4.0/api/io/netty/util/AttributeMap.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://netty.io/4.0/api/io/netty/util/AttributeMap.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Like:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ctx.channel().attr(AttributeKey.valueOf(&lt;span class=&quot;code-quote&quot;&gt;&quot;LumberjackSessionHandler.state&quot;&lt;/span&gt;)).set(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; LumberjackSessionState());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17219660" author="zbendhiba" created="Fri, 23 Oct 2020 12:50:49 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bedla&quot; class=&quot;user-hover&quot; rel=&quot;bedla&quot;&gt;bedla&lt;/a&gt; for the analyse.&lt;br/&gt;
I&apos;ll work on this issue !!&lt;/p&gt;</comment>
                            <comment id="17221247" author="zbendhiba" created="Tue, 27 Oct 2020 08:39:09 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ezett&quot; class=&quot;user-hover&quot; rel=&quot;ezett&quot;&gt;ezett&lt;/a&gt; can you tell me what kind of the unwanted acknowledges, and can you tell how many threads do you run in parallel + characteristics on the machine ? Do you know how much time the channel of client waits before closing the channel ?&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bedla&quot; class=&quot;user-hover&quot; rel=&quot;bedla&quot;&gt;bedla&lt;/a&gt; : the camel consumer creates a dedicated LumberjackSessionHandler for each channel. Each channel has its own LumberjackSessionHandler dedicated.  The solution you gave, gets it worse, as I can&apos;t even run 100 threads with complete acknowledges, while I can do up to 750 with good acknowledges. Is that consumes more time ?&lt;/p&gt;

&lt;p&gt;This is why I&apos;ve done so far:&lt;br/&gt;
I&apos;ve been running multiple threads in parallel to have the same bug. (RHEL 8 with 32GB M)&lt;br/&gt;
From 2 to 20 threads executing in parallel this example &lt;a href=&quot;https://github.com/apache/camel/blob/f7e2147eb059edbb0bf6a5e0d40ced00706a7251/components/camel-lumberjack/src/test/java/org/apache/camel/component/lumberjack/LumberjackComponentTest.java#L58&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/blob/f7e2147eb059edbb0bf6a5e0d40ced00706a7251/components/camel-lumberjack/src/test/java/org/apache/camel/component/lumberjack/LumberjackComponentTest.java#L58&lt;/a&gt; , I can debug easily and confirm that the ChannelIntializer creates a LumberjackSessionHandler for every channel.&lt;br/&gt;
Up to 750 threads executing this example in parallel, I have all the wanted acknowledges.&lt;br/&gt;
Between 800 and 1000 threads, I begin to experience that problem : Some acknowledges are not received or are incomplete. But I&apos;ve never experienced wrong acknowledges, just incomplete or empty.&lt;/p&gt;

&lt;p&gt;I&apos;m still investigating. But I&apos;d need help to know more about what you&apos;ve experienced as behavior.&lt;/p&gt;
</comment>
                            <comment id="17221420" author="ezett" created="Tue, 27 Oct 2020 13:17:06 +0000"  >&lt;p&gt;Hi Zineb, many thanks for your investigations so far! &lt;br/&gt;
I&apos;m running Debian 10, kernel 4.19.67-2, 16GB, Camel 3.5.0, Filebeat 7.9.1, JDK 1.8.0_242. In my integration test scenario I use 2 parallel threads.&lt;/p&gt;

&lt;p&gt;When I use my tests with mocking I can easily process 100k messages without any error. The effect came up on integration tests in combination with filebeat. &lt;br/&gt;
When I set filebeats bulk_max_size=8, flush.timeout=1s (see attached filebeat config), new log messages are packed to bulks windows with the max size of 8 and sent to camel via lumberjack. Sending 10 messages with this configuration will result in two lumberjack bulks: one containing 8 and one 2 messages.&lt;/p&gt;

&lt;p&gt;Correct behaviour: The first bulk window of 8 messages is processed in the LumberjackSessionHandler and receives a notifyMessageProcessed call on each processed message in the further channel. Thus, after the last sequence number of 8 it sends only one accumulated acknowledge back to filebeat for the whole bulk, closing the channel and everything is well.&lt;/p&gt;

&lt;p&gt;My experience now is that while processing the 8 messages of the first bulk (say camel-thread-8), filebeat also sends the second bulk with 2 messages (camel-thread-2) which is totally fine so far. Unfortunately, this second bulk is processed by the same LumberjackMessageHandler instance which is already processing the first bulk. &lt;br/&gt;
The windowSize and nextAck instance variables of the LumberjackMessageHandler are newly initialized in the middle of an already ongoing process. As a result the handler awaits a&#160; different acknowledged sequence number to complete its bulk communication with filebeat, here 2.&lt;/p&gt;

&lt;p&gt;&lt;em&gt;&lt;b&gt;Lost acks&lt;/b&gt;&lt;/em&gt;: The camel-thread-8 might be finished with the 8th ack but the LumberjackMessageHandler now awaits the new ack sequence number of 2. The final ack of 8 from the first bulk is never checked again so no accumulated ack is sent to filebeat anymore for the first bulk. The connection stays stalled until it times out.&lt;br/&gt;
&lt;em&gt;&lt;b&gt;Unwanted acks&lt;/b&gt;&lt;/em&gt;: The camel-thread-8 might just notifyMessageProcessed its second message and as the handler now waits for the new ack sequence number of 2 from camel-thread-2 it acknowledges the finalization of the second bulk back to filebeat - although it was the second acknowledge coming in from the first bulk. &lt;br/&gt;
The second bulk communication with filebeat is finalized with the &quot;wrong&quot; acknowledge from the first bulk. The first bulk on the other side can never be finished as 8 will never be checked again.&lt;/p&gt;

&lt;p&gt;From the observer perspective both cases show the same effect by inappropriately stalled or hung up lumberjack bulk connections.&lt;/p&gt;

&lt;p&gt;&quot;Do you know how much time the channel of client waits before closing the channel ?&quot; The lumberjack channel immediately finalizes the connection after a suitable ack sequence number was received or&#160; stalles the connection if acks come in that are not expected anymore.&lt;/p&gt;</comment>
                            <comment id="17221466" author="zbendhiba" created="Tue, 27 Oct 2020 14:18:09 +0000"  >&lt;p&gt;thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ezett&quot; class=&quot;user-hover&quot; rel=&quot;ezett&quot;&gt;ezett&lt;/a&gt;. I need to do a test with filebeat. I&apos;m not sure but I feel that filebeat will create one channel for the two messages (so the same session), to send the two window.&lt;/p&gt;

&lt;p&gt;Maybe configuring more flush time would help.&lt;br/&gt;
In this &lt;a href=&quot;https://github.com/apache/camel/blob/master/components/camel-lumberjack/src/test/java/org/apache/camel/component/lumberjack/LumberjackComponentTest.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;integration test&lt;/a&gt; , we have a test with one connection sending 2 window. If we remove &lt;a href=&quot;https://github.com/apache/camel/blob/a25e9911b5a250116292a8f7bf0ca24df75f4376/components/camel-lumberjack/src/test/java/org/apache/camel/component/lumberjack/LumberjackUtil.java#L88&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this line of code&lt;/a&gt;, we will have unwanted acknowledges.&lt;/p&gt;</comment>
                            <comment id="17221530" author="ezett" created="Tue, 27 Oct 2020 15:54:49 +0000"  >&lt;p&gt;I used flush.timeout=1s to not wait too long in the debugger for the second window to show up. But I think the solution should rather not be dependent on any value of the flush.timeout as thousands of messages/bulks can arrive at any time. It might be a solution for my described 8-2-test case though... &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="17221636" author="zbendhiba" created="Tue, 27 Oct 2020 18:17:23 +0000"  >&lt;p&gt;The right problem is withing the same session, if we treat the window in parallel, there is a big mess with the windowSize. &lt;/p&gt;

&lt;p&gt;I&apos;ll continue investigating on that one.&lt;/p&gt;</comment>
                            <comment id="17223554" author="zbendhiba" created="Fri, 30 Oct 2020 10:24:09 +0000"  >&lt;p&gt;Hello, I&apos;ve proposed a PR : &lt;a href=&quot;https://github.com/apache/camel/pull/4540&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/4540&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Each channel/session is thread safe in Netty. However, while using lumberjack component, one single session can process multiple windows in parallel, and that causes mess while updating session data.&lt;br/&gt;
My solution to that : for each Lumberjack session, a new window to process has to wait the ACK sent from the previous one, if exists. In that way, we can assure that session data are not changed by another process.     &lt;/p&gt;

&lt;p&gt;While doing several tests, I&apos;ve noticed when using Lumberjack without SSL, messages go too fast. I guess it&apos;s due to absence of the additional SSL pipeline. And so client loses some messages.&lt;br/&gt;
I&apos;ve added a pause of 10 milliseconds and it resolves the problem.&lt;br/&gt;
I&apos;ve updated the integration tests to stop pausing between windows and send more windows to the server. I&apos;ve also added a new integration test for multi threads, to assure that lumberjack is thread safe while processing different sessions.&lt;/p&gt;</comment>
                            <comment id="17233444" author="ezett" created="Tue, 17 Nov 2020 08:41:12 +0000"  >&lt;p&gt;Thanks a lot for the fix &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zbendhiba&quot; class=&quot;user-hover&quot; rel=&quot;zbendhiba&quot;&gt;zbendhiba&lt;/a&gt; !&lt;/p&gt;

&lt;p&gt;I&apos;m not sure if this fix is able to handle processing mass data, e.g., coming from external filebeat instances:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;If all threads in a session have finished processing the current batches of data and the last one finally passes phaser.arriveAndDeregister(), the phaser itself terminates permanently. As I understand the phaser, it does not accept any further registration and stops its service from that point on.&lt;br/&gt;
 Thus, data arriving afterwards will be treated as without the fix.&lt;/li&gt;
	&lt;li&gt;If a thread passes the phaser.arriveAndDeregister(), all waiting threads at the phaser.arriveAndAwaitAdvance() start running all at once and not one after another.&lt;br/&gt;
 As a result the window.size is concurrently messed up again.&lt;/li&gt;
	&lt;li&gt;I don&apos;t clearly understand the flush pause during the Ack which might also cause performance reduction?&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Is it possible to teach camel to also use the LumberjackSessionHandler multi threaded correctly? This would prevent all the messy behaviour of the handler.&lt;/p&gt;

&lt;p&gt;I saw that camel creates a pool of lumberjack handlers but it only uses the first instance for all sessions. Maybe there is an issue of camels pool handling that leads to the observed behaviour?&lt;/p&gt;</comment>
                            <comment id="17235321" author="zbendhiba" created="Thu, 19 Nov 2020 09:55:40 +0000"  >&lt;p&gt;Hello &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ezett&quot; class=&quot;user-hover&quot; rel=&quot;ezett&quot;&gt;ezett&lt;/a&gt;,  I&apos;ll look again at this phaser.arriveAndDeregister(), to see if there&apos;s a bug.&lt;br/&gt;
There are 2 things: &lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;The bug exists because it is multi-threaded. (there is at least the event loop thread who has to in the same thread, so I guess this is why you said there is one thread for all sessions)&lt;/li&gt;
&lt;/ol&gt;
&lt;ul&gt;
	&lt;li&gt;The main problem is that the read method in our Netty Handler handles each of the messages in the window, instead of handling all the window. And in Netty, we can send the ACK only from that method. In the way the camel component is developed today : it is impossible to let the session handle multiple windows in parallel and send right ACKs.&lt;br/&gt;
I&apos;m thinking about changing the solution but it needs a little more time.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17245336" author="zbendhiba" created="Mon, 7 Dec 2020 16:43:50 +0000"  >&lt;p&gt;I have[ a new PR | &lt;a href=&quot;https://github.com/apache/camel/pull/4733&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/4733&lt;/a&gt;] handling windows instead of single messages (inspired by logstash-input-beats)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ezett&quot; class=&quot;user-hover&quot; rel=&quot;ezett&quot;&gt;ezett&lt;/a&gt; I did a test with filebeat + camel with flush.timeout: 1s, and all ACKs are received.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13014200" name="filebeat.CAMEL-15718.yml" size="5796" author="ezett" created="Tue, 27 Oct 2020 13:18:51 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12311020" key="com.atlassian.jira.plugin.system.customfieldtypes:url">
                        <customfieldname>External issue URL</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[https://stackoverflow.com/questions/64433933/apache-camel-lumberjack-component-not-thread-safe]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 49 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0jv0o:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>