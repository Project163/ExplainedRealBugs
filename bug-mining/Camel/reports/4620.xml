<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:31:01 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-12769] Combination of File consumer with charset and Split DSL with XPath doesn&apos;t parse XML correctly</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-12769</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;This route:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
from(&lt;span class=&quot;code-quote&quot;&gt;&quot;file:/...?charset=iso-8859-1&amp;amp;&amp;amp;include=.*\.xml&quot;&lt;/span&gt;)
    .split(xpath(&lt;span class=&quot;code-quote&quot;&gt;&quot;/foo/bar&quot;&lt;/span&gt;))
        ...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;does not read and split XML like the following with the correct encoding:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-xml&quot;&gt;
&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;?xml version=&lt;span class=&quot;code-quote&quot;&gt;&quot;1.0&quot;&lt;/span&gt; encoding=&lt;span class=&quot;code-quote&quot;&gt;&quot;ISO-8859-1&quot;&lt;/span&gt;?&amp;gt;&lt;/span&gt;
&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;foo&amp;gt;&lt;/span&gt;
	&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;bar&amp;gt;&lt;/span&gt;abc&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/bar&amp;gt;&lt;/span&gt;
	&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;bar&amp;gt;&lt;/span&gt;xyz&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/bar&amp;gt;&lt;/span&gt;
	&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;bar&amp;gt;&lt;/span&gt;&#229;&#228;&#246;&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/bar&amp;gt;&lt;/span&gt;
&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/root&amp;gt;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The root cause is due to the spec of &lt;tt&gt;IOConverter.toInputStream(File, String)&lt;/tt&gt;:&lt;br/&gt;
 &lt;a href=&quot;https://github.com/apache/camel/blob/camel-2.22.1/camel-core/src/main/java/org/apache/camel/converter/IOConverter.java#L84-L119&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/blob/camel-2.22.1/camel-core/src/main/java/org/apache/camel/converter/IOConverter.java#L84-L119&lt;/a&gt;&lt;br/&gt;
 which was clarified at &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-8346&quot; title=&quot;JsonPathEngine skips file encoding&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-8346&quot;&gt;&lt;del&gt;CAMEL-8346&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-8356&quot; title=&quot;IOConverter.toInputStream(file, charset) returns strange behaving stream&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-8356&quot;&gt;&lt;del&gt;CAMEL-8356&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;This method converts a &lt;tt&gt;File&lt;/tt&gt; with a charset to an &lt;tt&gt;InputStream&lt;/tt&gt; with the &lt;b&gt;JVM default charset&lt;/b&gt; encoding whatever the format of the file is. However, in turn &lt;a href=&quot;https://github.com/apache/camel/blob/camel-2.22.1/camel-core/src/main/java/org/apache/camel/converter/jaxp/XmlConverter.java#L870-L872&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;XmlConverter.toDOMDocument(...)&lt;/a&gt; uses &lt;tt&gt;DocumentBuilder&lt;/tt&gt; to convert the input stream to a DOM &lt;tt&gt;Document&lt;/tt&gt; and &lt;tt&gt;DocumentBuilder&lt;/tt&gt; is aware of the XML declaration:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-xml&quot;&gt;
&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;?xml version=&lt;span class=&quot;code-quote&quot;&gt;&quot;1.0&quot;&lt;/span&gt; encoding=&lt;span class=&quot;code-quote&quot;&gt;&quot;ISO-8859-1&quot;&lt;/span&gt;?&amp;gt;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;to detect the file encoding, and there is a mismatch between the actual encoding of the input stream (JVM default) and the encoding declared in XML.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13182580">CAMEL-12769</key>
            <summary>Combination of File consumer with charset and Split DSL with XPath doesn&apos;t parse XML correctly</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tadayosi">Tadayoshi Sato</assignee>
                                    <reporter username="tadayosi">Tadayoshi Sato</reporter>
                        <labels>
                    </labels>
                <created>Mon, 3 Sep 2018 08:22:06 +0000</created>
                <updated>Tue, 14 May 2019 10:18:44 +0000</updated>
                            <resolved>Tue, 4 Sep 2018 14:37:47 +0000</resolved>
                                    <version>2.22.0</version>
                                    <fixVersion>2.21.3</fixVersion>
                    <fixVersion>2.22.2</fixVersion>
                    <fixVersion>2.23.0</fixVersion>
                                    <component>camel-core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16601888" author="githubbot" created="Mon, 3 Sep 2018 08:28:44 +0000"  >&lt;p&gt;tadayosi opened a new pull request #2505: &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12769&quot; title=&quot;Combination of File consumer with charset and Split DSL with XPath doesn&amp;#39;t parse XML correctly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12769&quot;&gt;&lt;del&gt;CAMEL-12769&lt;/del&gt;&lt;/a&gt;: Combination of File consumer with charset and Split DSL &#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2505&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2505&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   &#8230;with XPath doesn&apos;t parse XML correctly&lt;/p&gt;

&lt;p&gt;   &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12769&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CAMEL-12769&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16601889" author="githubbot" created="Mon, 3 Sep 2018 08:28:45 +0000"  >&lt;p&gt;GitHub user tadayosi opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/camel/pull/2505&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2505&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12769&quot; title=&quot;Combination of File consumer with charset and Split DSL with XPath doesn&amp;#39;t parse XML correctly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12769&quot;&gt;&lt;del&gt;CAMEL-12769&lt;/del&gt;&lt;/a&gt;: Combination of File consumer with charset and Split DSL &#8230;&lt;/p&gt;

&lt;p&gt;    &#8230;with XPath doesn&apos;t parse XML correctly&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12769&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CAMEL-12769&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/tadayosi/camel&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/tadayosi/camel&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12769&quot; title=&quot;Combination of File consumer with charset and Split DSL with XPath doesn&amp;#39;t parse XML correctly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12769&quot;&gt;&lt;del&gt;CAMEL-12769&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/camel/pull/2505.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2505.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #2505&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit b8dd9d2c9a4f9a0616ed3016b91fa547b138ae0f&lt;br/&gt;
Author: Tadayoshi Sato &amp;lt;sato.tadayoshi@...&amp;gt;&lt;br/&gt;
Date:   2018-09-03T08:24:05Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12769&quot; title=&quot;Combination of File consumer with charset and Split DSL with XPath doesn&amp;#39;t parse XML correctly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12769&quot;&gt;&lt;del&gt;CAMEL-12769&lt;/del&gt;&lt;/a&gt;: Combination of File consumer with charset and Split DSL with XPath doesn&apos;t parse XML correctly&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16601896" author="githubbot" created="Mon, 3 Sep 2018 08:37:12 +0000"  >&lt;p&gt;oscerd commented on issue #2505: &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12769&quot; title=&quot;Combination of File consumer with charset and Split DSL with XPath doesn&amp;#39;t parse XML correctly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12769&quot;&gt;&lt;del&gt;CAMEL-12769&lt;/del&gt;&lt;/a&gt;: Combination of File consumer with charset and Split DSL &#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2505#issuecomment-418042984&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2505#issuecomment-418042984&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   LGTM. I&apos;d like to have feedback from @davsclaus and @onderson too&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16601906" author="githubbot" created="Mon, 3 Sep 2018 08:49:34 +0000"  >&lt;p&gt;davsclaus commented on issue #2505: &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12769&quot; title=&quot;Combination of File consumer with charset and Split DSL with XPath doesn&amp;#39;t parse XML correctly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12769&quot;&gt;&lt;del&gt;CAMEL-12769&lt;/del&gt;&lt;/a&gt;: Combination of File consumer with charset and Split DSL &#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2505#issuecomment-418046264&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2505#issuecomment-418046264&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Have you run all the unit tests of camel-core, camel-spring and also since this is XML, then try camel-saxon and maybe camel-cxf.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16601931" author="githubbot" created="Mon, 3 Sep 2018 09:20:16 +0000"  >&lt;p&gt;onderson commented on a change in pull request #2505: &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12769&quot; title=&quot;Combination of File consumer with charset and Split DSL with XPath doesn&amp;#39;t parse XML correctly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12769&quot;&gt;&lt;del&gt;CAMEL-12769&lt;/del&gt;&lt;/a&gt;: Combination of File consumer with charset and Split DSL &#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2505#discussion_r214624570&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2505#discussion_r214624570&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: camel-core/src/main/java/org/apache/camel/converter/IOConverter.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -500,6 +478,53 @@ public static String getCharsetName(Exchange exchange) &lt;/p&gt;
{
         return getCharsetName(exchange, true);
     }

&lt;p&gt;+    /**&lt;br/&gt;
+     * Encoding-aware input stream.&lt;br/&gt;
+     */&lt;br/&gt;
+    public static class EncodingInputStream extends InputStream {&lt;br/&gt;
+&lt;br/&gt;
+        private final File file;&lt;br/&gt;
+        private final BufferedReader reader;&lt;br/&gt;
+        private final Charset defaultStreamCharset;&lt;br/&gt;
+&lt;br/&gt;
+        private ByteBuffer bufferBytes;&lt;br/&gt;
+        private CharBuffer bufferedChars = CharBuffer.allocate(4096);&lt;br/&gt;
+&lt;br/&gt;
+        public EncodingInputStream(File file, String charset) throws IOException {&lt;br/&gt;
+            this.file = file;&lt;br/&gt;
+            reader = toReader(file, charset);&lt;br/&gt;
+            defaultStreamCharset = defaultCharset.get();&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   isn&apos;t it still that the given `String charset` and defaultStreamCharset should match and default fileinputstream&apos;s encoding resolves it?&lt;br/&gt;
   and yes full CI test build would be good to see, before merging.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16601934" author="githubbot" created="Mon, 3 Sep 2018 09:21:43 +0000"  >&lt;p&gt;onderson commented on a change in pull request #2505: &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12769&quot; title=&quot;Combination of File consumer with charset and Split DSL with XPath doesn&amp;#39;t parse XML correctly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12769&quot;&gt;&lt;del&gt;CAMEL-12769&lt;/del&gt;&lt;/a&gt;: Combination of File consumer with charset and Split DSL &#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2505#discussion_r214624993&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2505#discussion_r214624993&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: camel-core/src/main/java/org/apache/camel/converter/jaxp/XmlConverter.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -869,7 +870,14 @@ public Document toDOMDocument(InputStream in) throws IOException, SAXException,&lt;br/&gt;
     @Converter&lt;br/&gt;
     public Document toDOMDocument(InputStream in, Exchange exchange) throws IOException, SAXException, ParserConfigurationException {&lt;br/&gt;
         DocumentBuilder documentBuilder = createDocumentBuilder(getDocumentBuilderFactory(exchange));&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;return documentBuilder.parse(in);&lt;br/&gt;
+        if (in instanceof IOConverter.EncodingInputStream) {&lt;br/&gt;
+            // DocumentBuilder detects encoding from XML declaration, so we need to&lt;br/&gt;
+            // revert the converted encoding for the input stream&lt;br/&gt;
+            IOConverter.EncodingInputStream encIn = (IOConverter.EncodingInputStream) in;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   as we have instance of, type casting is good. maybe objecthelper.cast can be used.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16601944" author="githubbot" created="Mon, 3 Sep 2018 09:35:24 +0000"  >&lt;p&gt;tadayosi commented on a change in pull request #2505: &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12769&quot; title=&quot;Combination of File consumer with charset and Split DSL with XPath doesn&amp;#39;t parse XML correctly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12769&quot;&gt;&lt;del&gt;CAMEL-12769&lt;/del&gt;&lt;/a&gt;: Combination of File consumer with charset and Split DSL &#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2505#discussion_r214628894&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2505#discussion_r214628894&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: camel-core/src/main/java/org/apache/camel/converter/IOConverter.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -500,6 +478,53 @@ public static String getCharsetName(Exchange exchange) &lt;/p&gt;
{
         return getCharsetName(exchange, true);
     }

&lt;p&gt;+    /**&lt;br/&gt;
+     * Encoding-aware input stream.&lt;br/&gt;
+     */&lt;br/&gt;
+    public static class EncodingInputStream extends InputStream {&lt;br/&gt;
+&lt;br/&gt;
+        private final File file;&lt;br/&gt;
+        private final BufferedReader reader;&lt;br/&gt;
+        private final Charset defaultStreamCharset;&lt;br/&gt;
+&lt;br/&gt;
+        private ByteBuffer bufferBytes;&lt;br/&gt;
+        private CharBuffer bufferedChars = CharBuffer.allocate(4096);&lt;br/&gt;
+&lt;br/&gt;
+        public EncodingInputStream(File file, String charset) throws IOException {&lt;br/&gt;
+            this.file = file;&lt;br/&gt;
+            reader = toReader(file, charset);&lt;br/&gt;
+            defaultStreamCharset = defaultCharset.get();&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   If I understand your question correctly, I don&apos;t think it resolves the bug. We read files with encodings other than default and IIUC the purpose of `IOConverter.toInputStream(File, String)` is to convert a File with a charset to an InputStream with the JVM default charset encoding. So we should handle cases where the given charset and the default one differ.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16601946" author="githubbot" created="Mon, 3 Sep 2018 09:36:59 +0000"  >&lt;p&gt;tadayosi commented on issue #2505: &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12769&quot; title=&quot;Combination of File consumer with charset and Split DSL with XPath doesn&amp;#39;t parse XML correctly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12769&quot;&gt;&lt;del&gt;CAMEL-12769&lt;/del&gt;&lt;/a&gt;: Combination of File consumer with charset and Split DSL &#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2505#issuecomment-418059234&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2505#issuecomment-418059234&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   I ran camel-core, camel-spring, camel-saxon, and camel-cxf, and all the unit tests passed. Should I run the full test suite locally?&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16601970" author="githubbot" created="Mon, 3 Sep 2018 10:05:48 +0000"  >&lt;p&gt;onderson commented on a change in pull request #2505: &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12769&quot; title=&quot;Combination of File consumer with charset and Split DSL with XPath doesn&amp;#39;t parse XML correctly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12769&quot;&gt;&lt;del&gt;CAMEL-12769&lt;/del&gt;&lt;/a&gt;: Combination of File consumer with charset and Split DSL &#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2505#discussion_r214637601&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2505#discussion_r214637601&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: camel-core/src/main/java/org/apache/camel/converter/IOConverter.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -500,6 +478,53 @@ public static String getCharsetName(Exchange exchange) &lt;/p&gt;
{
         return getCharsetName(exchange, true);
     }

&lt;p&gt;+    /**&lt;br/&gt;
+     * Encoding-aware input stream.&lt;br/&gt;
+     */&lt;br/&gt;
+    public static class EncodingInputStream extends InputStream {&lt;br/&gt;
+&lt;br/&gt;
+        private final File file;&lt;br/&gt;
+        private final BufferedReader reader;&lt;br/&gt;
+        private final Charset defaultStreamCharset;&lt;br/&gt;
+&lt;br/&gt;
+        private ByteBuffer bufferBytes;&lt;br/&gt;
+        private CharBuffer bufferedChars = CharBuffer.allocate(4096);&lt;br/&gt;
+&lt;br/&gt;
+        public EncodingInputStream(File file, String charset) throws IOException {&lt;br/&gt;
+            this.file = file;&lt;br/&gt;
+            reader = toReader(file, charset);&lt;br/&gt;
+            defaultStreamCharset = defaultCharset.get();&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   yes, that&apos;s my point too. I am unsure if it is right approach. &lt;a href=&quot;https://github.com/apache/camel/pull/2505/files#diff-cf527fa70918461b67c399c1a1be9f4eR508&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2505/files#diff-cf527fa70918461b67c399c1a1be9f4eR508&lt;/a&gt; encodes with the default charset even if you have BufferedReader with a given charset. or could it be the otherway around?&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16601971" author="githubbot" created="Mon, 3 Sep 2018 10:06:11 +0000"  >&lt;p&gt;onderson commented on a change in pull request #2505: &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12769&quot; title=&quot;Combination of File consumer with charset and Split DSL with XPath doesn&amp;#39;t parse XML correctly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12769&quot;&gt;&lt;del&gt;CAMEL-12769&lt;/del&gt;&lt;/a&gt;: Combination of File consumer with charset and Split DSL &#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2505#discussion_r214637601&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2505#discussion_r214637601&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: camel-core/src/main/java/org/apache/camel/converter/IOConverter.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -500,6 +478,53 @@ public static String getCharsetName(Exchange exchange) &lt;/p&gt;
{
         return getCharsetName(exchange, true);
     }

&lt;p&gt;+    /**&lt;br/&gt;
+     * Encoding-aware input stream.&lt;br/&gt;
+     */&lt;br/&gt;
+    public static class EncodingInputStream extends InputStream {&lt;br/&gt;
+&lt;br/&gt;
+        private final File file;&lt;br/&gt;
+        private final BufferedReader reader;&lt;br/&gt;
+        private final Charset defaultStreamCharset;&lt;br/&gt;
+&lt;br/&gt;
+        private ByteBuffer bufferBytes;&lt;br/&gt;
+        private CharBuffer bufferedChars = CharBuffer.allocate(4096);&lt;br/&gt;
+&lt;br/&gt;
+        public EncodingInputStream(File file, String charset) throws IOException {&lt;br/&gt;
+            this.file = file;&lt;br/&gt;
+            reader = toReader(file, charset);&lt;br/&gt;
+            defaultStreamCharset = defaultCharset.get();&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   yes, that&apos;s my point too. I am unsure if it is right approach. &lt;a href=&quot;https://github.com/apache/camel/pull/2505/files#diff-cf527fa70918461b67c399c1a1be9f4eR508&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2505/files#diff-cf527fa70918461b67c399c1a1be9f4eR508&lt;/a&gt; encodes with the default charset even if you have BufferedReader with a given charset. or could it be the otherway around? if UTs are good, i think it is good to go.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16602042" author="githubbot" created="Mon, 3 Sep 2018 11:02:31 +0000"  >&lt;p&gt;tadayosi commented on a change in pull request #2505: &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12769&quot; title=&quot;Combination of File consumer with charset and Split DSL with XPath doesn&amp;#39;t parse XML correctly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12769&quot;&gt;&lt;del&gt;CAMEL-12769&lt;/del&gt;&lt;/a&gt;: Combination of File consumer with charset and Split DSL &#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2505#discussion_r214651061&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2505#discussion_r214651061&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: camel-core/src/main/java/org/apache/camel/converter/IOConverter.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -500,6 +478,53 @@ public static String getCharsetName(Exchange exchange) &lt;/p&gt;
{
         return getCharsetName(exchange, true);
     }

&lt;p&gt;+    /**&lt;br/&gt;
+     * Encoding-aware input stream.&lt;br/&gt;
+     */&lt;br/&gt;
+    public static class EncodingInputStream extends InputStream {&lt;br/&gt;
+&lt;br/&gt;
+        private final File file;&lt;br/&gt;
+        private final BufferedReader reader;&lt;br/&gt;
+        private final Charset defaultStreamCharset;&lt;br/&gt;
+&lt;br/&gt;
+        private ByteBuffer bufferBytes;&lt;br/&gt;
+        private CharBuffer bufferedChars = CharBuffer.allocate(4096);&lt;br/&gt;
+&lt;br/&gt;
+        public EncodingInputStream(File file, String charset) throws IOException {&lt;br/&gt;
+            this.file = file;&lt;br/&gt;
+            reader = toReader(file, charset);&lt;br/&gt;
+            defaultStreamCharset = defaultCharset.get();&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   I didn&apos;t create this but the line came from the existing code. I just made the anonymous class in the method to a named static class. It was brought from &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-8346&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CAMEL-8346&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-8356&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CAMEL-8356&lt;/a&gt; so we need to understand their backgrounds to see if it&apos;s really a right approach or not.&lt;/p&gt;

&lt;p&gt;   My understanding is that we already have the other method  `IOConverter.toInputStream(File)` so unless the following is the specification of the method, there is no reason for the existence of `IOConverter.toInputStream(File, String)`:&lt;br/&gt;
   ```&lt;br/&gt;
       /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Converts the given 
{@link File}
&lt;p&gt; with the given charset to &lt;/p&gt;
{@link InputStream}
&lt;p&gt; with the JVM default charset&lt;br/&gt;
        *&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;@param file the file to be converted&lt;/li&gt;
	&lt;li&gt;@param charset the charset the file is read with&lt;/li&gt;
	&lt;li&gt;@return the input stream with the JVM default charset&lt;br/&gt;
        */&lt;br/&gt;
   ```&lt;br/&gt;
   Let&apos;s think that you have a file with `iso-8859-1` and want the input stream with `iso-8859-1` encoding. Then you can just use `IOConverter.toInputStream(File)`. `IOConverter.toInputStream(File, String)` is necessary only when you want the input stream with something other than `iso-8859-1`, but what encoding should the method return?  The only sensible choice would be `UTF-8` or the JVM default, but AFAIK `UTF-8` has a problem at &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-8346&quot; title=&quot;JsonPathEngine skips file encoding&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-8346&quot;&gt;&lt;del&gt;CAMEL-8346&lt;/del&gt;&lt;/a&gt;.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16602860" author="githubbot" created="Tue, 4 Sep 2018 10:17:55 +0000"  >&lt;p&gt;tadayosi commented on issue #2505: &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12769&quot; title=&quot;Combination of File consumer with charset and Split DSL with XPath doesn&amp;#39;t parse XML correctly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12769&quot;&gt;&lt;del&gt;CAMEL-12769&lt;/del&gt;&lt;/a&gt;: Combination of File consumer with charset and Split DSL &#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2505#issuecomment-418315454&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2505#issuecomment-418315454&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   I finally ran through `mvn clean install` on the project but got a few test failures on some components:&lt;br/&gt;
   ```&lt;br/&gt;
   &lt;span class=&quot;error&quot;&gt;&amp;#91;INFO&amp;#93;&lt;/span&gt; Camel :: ElasticSearch5 (deprecated) 2.23.0-SNAPSHOT FAILURE &lt;span class=&quot;error&quot;&gt;&amp;#91;05:10 min&amp;#93;&lt;/span&gt;&lt;br/&gt;
   &lt;span class=&quot;error&quot;&gt;&amp;#91;INFO&amp;#93;&lt;/span&gt; Camel :: Netty HTTP (deprecated) ................... FAILURE &lt;span class=&quot;error&quot;&gt;&amp;#91;05:05 min&amp;#93;&lt;/span&gt;&lt;br/&gt;
   &lt;span class=&quot;error&quot;&gt;&amp;#91;INFO&amp;#93;&lt;/span&gt; Camel :: Tika ...................................... FAILURE [  7.036 s]&lt;br/&gt;
   &lt;span class=&quot;error&quot;&gt;&amp;#91;INFO&amp;#93;&lt;/span&gt; Camel :: XChange ................................... FAILURE [  9.915 s]&lt;br/&gt;
   &lt;span class=&quot;error&quot;&gt;&amp;#91;INFO&amp;#93;&lt;/span&gt; Camel :: Zookeeper ................................. FAILURE &lt;span class=&quot;error&quot;&gt;&amp;#91;10:04 min&amp;#93;&lt;/span&gt;&lt;br/&gt;
   &lt;span class=&quot;error&quot;&gt;&amp;#91;INFO&amp;#93;&lt;/span&gt; Camel :: Zookeeper Master .......................... FAILURE [ 41.479 s]&lt;br/&gt;
   &lt;span class=&quot;error&quot;&gt;&amp;#91;INFO&amp;#93;&lt;/span&gt; Camel :: Platforms :: Camel Catalog ................ FAILURE [ 20.017 s]&lt;br/&gt;
   ```&lt;br/&gt;
   For camel-netty-http, camel-zookeeper, and camel-zookeeper-master, I re-ran their tests individually and they passed with my patch. For the others, I re-ran them without my patch and still got the same failures, so probably it&apos;s not my fault.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16602903" author="githubbot" created="Tue, 4 Sep 2018 10:57:28 +0000"  >&lt;p&gt;davsclaus commented on issue #2505: &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12769&quot; title=&quot;Combination of File consumer with charset and Split DSL with XPath doesn&amp;#39;t parse XML correctly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12769&quot;&gt;&lt;del&gt;CAMEL-12769&lt;/del&gt;&lt;/a&gt;: Combination of File consumer with charset and Split DSL &#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2505#issuecomment-418324881&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2505#issuecomment-418324881&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   The CI server also have some unit test failures in zookeeper etc.&lt;br/&gt;
   &lt;a href=&quot;https://builds.apache.org/job/Camel/job/master/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Camel/job/master/lastCompletedBuild/testReport/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;   LGTM&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16603118" author="githubbot" created="Tue, 4 Sep 2018 14:36:34 +0000"  >&lt;p&gt;davsclaus closed pull request #2505: &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12769&quot; title=&quot;Combination of File consumer with charset and Split DSL with XPath doesn&amp;#39;t parse XML correctly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12769&quot;&gt;&lt;del&gt;CAMEL-12769&lt;/del&gt;&lt;/a&gt;: Combination of File consumer with charset and Split DSL &#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2505&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2505&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/camel-core/src/main/java/org/apache/camel/converter/IOConverter.java b/camel-core/src/main/java/org/apache/camel/converter/IOConverter.java&lt;br/&gt;
index 073547ea36c..ae02a2c8e39 100644&lt;br/&gt;
&amp;#8212; a/camel-core/src/main/java/org/apache/camel/converter/IOConverter.java&lt;br/&gt;
+++ b/camel-core/src/main/java/org/apache/camel/converter/IOConverter.java&lt;br/&gt;
@@ -81,40 +81,18 @@ public static InputStream toInputStream(File file) throws IOException &lt;/p&gt;
{
         return IOHelper.buffered(new FileInputStream(file));
     }

&lt;p&gt;+    /**&lt;br/&gt;
+     * Converts the given &lt;/p&gt;
{@link File}
&lt;p&gt; with the given charset to &lt;/p&gt;
{@link InputStream}
&lt;p&gt; with the JVM default charset&lt;br/&gt;
+     *&lt;br/&gt;
+     * @param file the file to be converted&lt;br/&gt;
+     * @param charset the charset the file is read with&lt;br/&gt;
+     * @return the input stream with the JVM default charset&lt;br/&gt;
+     */&lt;br/&gt;
     public static InputStream toInputStream(File file, String charset) throws IOException {&lt;br/&gt;
         if (charset != null) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final BufferedReader reader = toReader(file, charset);&lt;/li&gt;
	&lt;li&gt;final Charset defaultStreamCharset = defaultCharset.get();&lt;/li&gt;
	&lt;li&gt;return new InputStream() {&lt;/li&gt;
	&lt;li&gt;private ByteBuffer bufferBytes;&lt;/li&gt;
	&lt;li&gt;private CharBuffer bufferedChars = CharBuffer.allocate(4096);&lt;br/&gt;
-&lt;/li&gt;
	&lt;li&gt;@Override&lt;/li&gt;
	&lt;li&gt;public int read() throws IOException {&lt;/li&gt;
	&lt;li&gt;if (bufferBytes == null || bufferBytes.remaining() &amp;lt;= 0) {&lt;/li&gt;
	&lt;li&gt;bufferedChars.clear();&lt;/li&gt;
	&lt;li&gt;int len = reader.read(bufferedChars);&lt;/li&gt;
	&lt;li&gt;bufferedChars.flip();&lt;/li&gt;
	&lt;li&gt;if (len == -1) 
{
-                            return -1;
-                        }&lt;/li&gt;
	&lt;li&gt;bufferBytes = defaultStreamCharset.encode(bufferedChars);&lt;/li&gt;
	&lt;li&gt;}&lt;/li&gt;
	&lt;li&gt;return bufferBytes.get();&lt;/li&gt;
	&lt;li&gt;}&lt;br/&gt;
-&lt;/li&gt;
	&lt;li&gt;@Override&lt;/li&gt;
	&lt;li&gt;public void close() throws IOException 
{
-                    reader.close();
-                }
&lt;p&gt;-&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;@Override&lt;/li&gt;
	&lt;li&gt;public void reset() throws IOException 
{
-                    reader.reset();
-                }&lt;/li&gt;
	&lt;li&gt;};&lt;br/&gt;
+            return new EncodingInputStream(file, charset);&lt;br/&gt;
         } else 
{
-            return IOHelper.buffered(new FileInputStream(file));
+            return toInputStream(file);
         }
&lt;p&gt;     }&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;@@ -500,6 +478,53 @@ public static String getCharsetName(Exchange exchange) &lt;/p&gt;
{
         return getCharsetName(exchange, true);
     }

&lt;p&gt;+    /**&lt;br/&gt;
+     * Encoding-aware input stream.&lt;br/&gt;
+     */&lt;br/&gt;
+    public static class EncodingInputStream extends InputStream {&lt;br/&gt;
+&lt;br/&gt;
+        private final File file;&lt;br/&gt;
+        private final BufferedReader reader;&lt;br/&gt;
+        private final Charset defaultStreamCharset;&lt;br/&gt;
+&lt;br/&gt;
+        private ByteBuffer bufferBytes;&lt;br/&gt;
+        private CharBuffer bufferedChars = CharBuffer.allocate(4096);&lt;br/&gt;
+&lt;br/&gt;
+        public EncodingInputStream(File file, String charset) throws IOException &lt;/p&gt;
{
+            this.file = file;
+            reader = toReader(file, charset);
+            defaultStreamCharset = defaultCharset.get();
+        }
&lt;p&gt;+&lt;br/&gt;
+        @Override&lt;br/&gt;
+        public int read() throws IOException {&lt;br/&gt;
+            if (bufferBytes == null || bufferBytes.remaining() &amp;lt;= 0) {&lt;br/&gt;
+                bufferedChars.clear();&lt;br/&gt;
+                int len = reader.read(bufferedChars);&lt;br/&gt;
+                bufferedChars.flip();&lt;br/&gt;
+                if (len == -1) &lt;/p&gt;
{
+                    return -1;
+                }
&lt;p&gt;+                bufferBytes = defaultStreamCharset.encode(bufferedChars);&lt;br/&gt;
+            }&lt;br/&gt;
+            return bufferBytes.get();&lt;br/&gt;
+        }&lt;br/&gt;
+&lt;br/&gt;
+        @Override&lt;br/&gt;
+        public void close() throws IOException &lt;/p&gt;
{
+            reader.close();
+        }
&lt;p&gt;+&lt;br/&gt;
+        @Override&lt;br/&gt;
+        public void reset() throws IOException &lt;/p&gt;
{
+            reader.reset();
+        }
&lt;p&gt;+&lt;br/&gt;
+        public InputStream toOriginalInputStream() throws FileNotFoundException &lt;/p&gt;
{
+            return new FileInputStream(file);
+        }
&lt;p&gt;+    }&lt;br/&gt;
+&lt;br/&gt;
     /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Encoding-aware file reader.&lt;br/&gt;
      */&lt;br/&gt;
diff --git a/camel-core/src/main/java/org/apache/camel/converter/jaxp/XmlConverter.java b/camel-core/src/main/java/org/apache/camel/converter/jaxp/XmlConverter.java&lt;br/&gt;
index f8a876637d4..6d7c06379a3 100644
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/camel-core/src/main/java/org/apache/camel/converter/jaxp/XmlConverter.java&lt;br/&gt;
+++ b/camel-core/src/main/java/org/apache/camel/converter/jaxp/XmlConverter.java&lt;br/&gt;
@@ -54,7 +54,6 @@&lt;br/&gt;
 import javax.xml.transform.stream.StreamResult;&lt;br/&gt;
 import javax.xml.transform.stream.StreamSource;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;-import org.apache.camel.util.StringHelper;&lt;br/&gt;
 import org.w3c.dom.Document;&lt;br/&gt;
 import org.w3c.dom.Element;&lt;br/&gt;
 import org.w3c.dom.Node;&lt;br/&gt;
@@ -70,8 +69,10 @@&lt;br/&gt;
 import org.apache.camel.Converter;&lt;br/&gt;
 import org.apache.camel.Exchange;&lt;br/&gt;
 import org.apache.camel.StringSource;&lt;br/&gt;
+import org.apache.camel.converter.IOConverter;&lt;br/&gt;
 import org.apache.camel.util.IOHelper;&lt;br/&gt;
 import org.apache.camel.util.ObjectHelper;&lt;br/&gt;
+import org.apache.camel.util.StringHelper;&lt;br/&gt;
 import org.slf4j.Logger;&lt;br/&gt;
 import org.slf4j.LoggerFactory;&lt;/p&gt;

&lt;p&gt;@@ -870,7 +871,14 @@ public Document toDOMDocument(InputStream in) throws IOException, SAXException,&lt;br/&gt;
     @Converter&lt;br/&gt;
     public Document toDOMDocument(InputStream in, Exchange exchange) throws IOException, SAXException, ParserConfigurationException {&lt;br/&gt;
         DocumentBuilder documentBuilder = createDocumentBuilder(getDocumentBuilderFactory(exchange));&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;return documentBuilder.parse(in);&lt;br/&gt;
+        if (in instanceof IOConverter.EncodingInputStream) 
{
+            // DocumentBuilder detects encoding from XML declaration, so we need to
+            // revert the converted encoding for the input stream
+            IOConverter.EncodingInputStream encIn = (IOConverter.EncodingInputStream) in;
+            return documentBuilder.parse(encIn.toOriginalInputStream());
+        }
&lt;p&gt; else &lt;/p&gt;
{
+            return documentBuilder.parse(in);
+        }
&lt;p&gt;     }&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     /**&lt;br/&gt;
diff --git a/camel-core/src/test/java/org/apache/camel/converter/IOConverterCharsetTest.java b/camel-core/src/test/java/org/apache/camel/converter/IOConverterCharsetTest.java&lt;br/&gt;
index 9d82ade477f..c192349b531 100644&lt;br/&gt;
&amp;#8212; a/camel-core/src/test/java/org/apache/camel/converter/IOConverterCharsetTest.java&lt;br/&gt;
+++ b/camel-core/src/test/java/org/apache/camel/converter/IOConverterCharsetTest.java&lt;br/&gt;
@@ -38,8 +38,8 @@ public void testToInputStreamFileWithCharsetUTF8() throws Exception {&lt;br/&gt;
         switchToDefaultCharset(StandardCharsets.UTF_8);&lt;br/&gt;
         File file = new File(&quot;src/test/resources/org/apache/camel/converter/german.utf-8.txt&quot;);&lt;br/&gt;
         try (InputStream in = IOConverter.toInputStream(file, &quot;UTF-8&quot;);&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;BufferedReader reader = new BufferedReader(new InputStreamReader(in, StandardCharsets.UTF_8));&lt;/li&gt;
	&lt;li&gt;BufferedReader naiveReader = new BufferedReader(new InputStreamReader(Files.newInputStream(Paths.get(file.getAbsolutePath())), StandardCharsets.UTF_8))) {&lt;br/&gt;
+             BufferedReader reader = new BufferedReader(new InputStreamReader(in, StandardCharsets.UTF_8));&lt;br/&gt;
+             BufferedReader naiveReader = new BufferedReader(new InputStreamReader(Files.newInputStream(Paths.get(file.getAbsolutePath())), StandardCharsets.UTF_8))) {&lt;br/&gt;
             String line = reader.readLine();&lt;br/&gt;
             String naiveLine = naiveReader.readLine();&lt;br/&gt;
             assertEquals(naiveLine, line);&lt;br/&gt;
@@ -52,8 +52,8 @@ public void testToInputStreamFileWithCharsetUTF8withOtherDefaultEncoding() throw&lt;br/&gt;
         switchToDefaultCharset(StandardCharsets.ISO_8859_1);&lt;br/&gt;
         File file = new File(&quot;src/test/resources/org/apache/camel/converter/german.utf-8.txt&quot;);&lt;br/&gt;
         try (InputStream in = IOConverter.toInputStream(file, &quot;UTF-8&quot;);&lt;/li&gt;
	&lt;li&gt;BufferedReader reader = new BufferedReader(new InputStreamReader(in, StandardCharsets.ISO_8859_1));&lt;/li&gt;
	&lt;li&gt;BufferedReader naiveReader = new BufferedReader(new InputStreamReader(Files.newInputStream(Paths.get(file.getAbsolutePath())), StandardCharsets.UTF_8))) {&lt;br/&gt;
+             BufferedReader reader = new BufferedReader(new InputStreamReader(in, StandardCharsets.ISO_8859_1));&lt;br/&gt;
+             BufferedReader naiveReader = new BufferedReader(new InputStreamReader(Files.newInputStream(Paths.get(file.getAbsolutePath())), StandardCharsets.UTF_8))) {&lt;br/&gt;
             String line = reader.readLine();&lt;br/&gt;
             String naiveLine = naiveReader.readLine();&lt;br/&gt;
             assertEquals(naiveLine, line);&lt;br/&gt;
@@ -66,8 +66,8 @@ public void testToInputStreamFileWithCharsetLatin1() throws Exception {&lt;br/&gt;
         switchToDefaultCharset(StandardCharsets.UTF_8);&lt;br/&gt;
         File file = new File(&quot;src/test/resources/org/apache/camel/converter/german.iso-8859-1.txt&quot;);&lt;br/&gt;
         try (InputStream in = IOConverter.toInputStream(file, &quot;ISO-8859-1&quot;);&lt;/li&gt;
	&lt;li&gt;BufferedReader reader = new BufferedReader(new InputStreamReader(in, StandardCharsets.UTF_8));&lt;/li&gt;
	&lt;li&gt;BufferedReader naiveReader = new BufferedReader(new InputStreamReader(Files.newInputStream(Paths.get(file.getAbsolutePath())), &quot;ISO-8859-1&quot;))) {&lt;br/&gt;
+             BufferedReader reader = new BufferedReader(new InputStreamReader(in, StandardCharsets.UTF_8));&lt;br/&gt;
+             BufferedReader naiveReader = new BufferedReader(new InputStreamReader(Files.newInputStream(Paths.get(file.getAbsolutePath())), &quot;ISO-8859-1&quot;))) {&lt;br/&gt;
             String line = reader.readLine();&lt;br/&gt;
             String naiveLine = naiveReader.readLine();&lt;br/&gt;
             assertEquals(naiveLine, line);&lt;br/&gt;
@@ -80,7 +80,7 @@ public void testToInputStreamFileDirectByteDumpWithCharsetLatin1() throws Except&lt;br/&gt;
         switchToDefaultCharset(StandardCharsets.UTF_8);&lt;br/&gt;
         File file = new File(&quot;src/test/resources/org/apache/camel/converter/german.iso-8859-1.txt&quot;);&lt;br/&gt;
         try (InputStream in = IOConverter.toInputStream(file, &quot;ISO-8859-1&quot;);&lt;/li&gt;
	&lt;li&gt;InputStream naiveIn = Files.newInputStream(Paths.get(file.getAbsolutePath()))) {&lt;br/&gt;
+             InputStream naiveIn = Files.newInputStream(Paths.get(file.getAbsolutePath()))) {&lt;br/&gt;
             byte[] bytes = new byte&lt;span class=&quot;error&quot;&gt;&amp;#91;8192&amp;#93;&lt;/span&gt;;&lt;br/&gt;
             in.read(bytes);&lt;br/&gt;
             byte[] naiveBytes = new byte&lt;span class=&quot;error&quot;&gt;&amp;#91;8192&amp;#93;&lt;/span&gt;;&lt;br/&gt;
@@ -93,7 +93,7 @@ public void testToInputStreamFileDirectByteDumpWithCharsetLatin1() throws Except&lt;br/&gt;
     public void testToReaderFileWithCharsetUTF8() throws Exception {&lt;br/&gt;
         File file = new File(&quot;src/test/resources/org/apache/camel/converter/german.utf-8.txt&quot;);&lt;br/&gt;
         try (BufferedReader reader = IOConverter.toReader(file, &quot;UTF-8&quot;);&lt;/li&gt;
	&lt;li&gt;BufferedReader naiveReader = new BufferedReader(new InputStreamReader(Files.newInputStream(Paths.get(file.getAbsolutePath())), StandardCharsets.UTF_8))) {&lt;br/&gt;
+             BufferedReader naiveReader = new BufferedReader(new InputStreamReader(Files.newInputStream(Paths.get(file.getAbsolutePath())), StandardCharsets.UTF_8))) {&lt;br/&gt;
             String line = reader.readLine();&lt;br/&gt;
             String naiveLine = naiveReader.readLine();&lt;br/&gt;
             assertEquals(naiveLine, line);&lt;br/&gt;
@@ -105,7 +105,7 @@ public void testToReaderFileWithCharsetUTF8() throws Exception {&lt;br/&gt;
     public void testToReaderFileWithCharsetLatin1() throws Exception {&lt;br/&gt;
         File file = new File(&quot;src/test/resources/org/apache/camel/converter/german.iso-8859-1.txt&quot;);&lt;br/&gt;
         try (BufferedReader reader = IOConverter.toReader(file, &quot;ISO-8859-1&quot;);&lt;/li&gt;
	&lt;li&gt;BufferedReader naiveReader = new BufferedReader(new InputStreamReader(Files.newInputStream(Paths.get(file.getAbsolutePath())), &quot;ISO-8859-1&quot;))) {&lt;br/&gt;
+             BufferedReader naiveReader = new BufferedReader(new InputStreamReader(Files.newInputStream(Paths.get(file.getAbsolutePath())), &quot;ISO-8859-1&quot;))) {&lt;br/&gt;
             String line = reader.readLine();&lt;br/&gt;
             String naiveLine = naiveReader.readLine();&lt;br/&gt;
             assertEquals(naiveLine, line);&lt;/li&gt;
&lt;/ul&gt;





&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16603119" author="githubbot" created="Tue, 4 Sep 2018 14:36:35 +0000"  >&lt;p&gt;Github user davsclaus closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/camel/pull/2505&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2505&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16603123" author="davsclaus" created="Tue, 4 Sep 2018 14:37:47 +0000"  >&lt;p&gt;Thanks for reporting and the PR&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13212261">CAMEL-13136</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 11 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3xo1j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>