<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 09:39:50 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-2980] camel-jpa doesn&apos;t use EntityManager.merge(entity) in the right way</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-2980</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;The EntityManager.merge(entity) method returns the merged entity. The exchange in message body should be updated with the merged entity (what camel-jpa currently not do).&lt;br/&gt;
I running into this problem, because after saving an entity in the database, the id field was still null. So, we don&apos;t know, which entity in the database is the corresponding to this entity... &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Have a look in the process method of &lt;a href=&quot;http://svn.apache.org/viewvc/camel/trunk/components/camel-jpa/src/main/java/org/apache/camel/component/jpa/JpaProducer.java?view=markup&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;JpaProducer&lt;/a&gt; and the Java doc from the &lt;a href=&quot;http://download.oracle.com/docs/cd/E17477_01/javaee/5/api/javax/persistence/EntityManager.html#merge%28T%29&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;EntityManager&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Christian&lt;/p&gt;</description>
                <environment>&lt;p&gt;All&lt;/p&gt;</environment>
        <key id="12485488">CAMEL-2980</key>
            <summary>camel-jpa doesn&apos;t use EntityManager.merge(entity) in the right way</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="muellerc">Christian M&#252;ller</assignee>
                                    <reporter username="muellerc">Christian M&#252;ller</reporter>
                        <labels>
                    </labels>
                <created>Wed, 21 Jul 2010 14:55:03 +0000</created>
                <updated>Sun, 24 Apr 2011 09:57:46 +0000</updated>
                            <resolved>Thu, 5 Aug 2010 12:35:59 +0000</resolved>
                                    <version>2.4.0</version>
                                    <fixVersion>2.5.0</fixVersion>
                                    <component>camel-jpa</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12955542" author="muellerc" created="Wed, 21 Jul 2010 22:30:09 +0000"  >&lt;p&gt;I modified in my workspace the &lt;a href=&quot;http://svn.apache.org/viewvc/camel/trunk/components/camel-jpa/src/test/java/org/apache/camel/component/jpa/JpaTest.java?view=markup&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;JpaTest.java&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;old:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        template.send(endpoint, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Processor() {
            &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void process(Exchange exchange) {
                exchange.getIn().setBody(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SendEmail(&lt;span class=&quot;code-quote&quot;&gt;&quot;foo@bar.com&quot;&lt;/span&gt;));
            }
        });
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;new:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        Exchange returnedExchange = template.send(endpoint, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Processor() {
            &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void process(Exchange exchange) {
                exchange.getIn().setBody(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SendEmail(&lt;span class=&quot;code-quote&quot;&gt;&quot;foo@bar.com&quot;&lt;/span&gt;));
            }
        });
        
        SendEmail sendEmail = returnedExchange.getIn().getBody(SendEmail.class);
        assertEquals(&lt;span class=&quot;code-quote&quot;&gt;&quot;address property&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;foo@bar.com&quot;&lt;/span&gt;, sendEmail.getAddress());
        assertNotNull(&lt;span class=&quot;code-quote&quot;&gt;&quot;id property should set&quot;&lt;/span&gt;, sendEmail.getId());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This fails with:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;java.lang.AssertionError: id property should set
	at org.junit.Assert.fail(Assert.java:91)
	...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;After switching from EntityManager.merge(entity) to EntityManager.persist(entity), the test succeed.&lt;/p&gt;

&lt;p&gt;Because of this and &lt;a href=&quot;https://issues.apache.org/activemq/browse/CAMEL-2982&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CAMEL-2982&lt;/a&gt;, my question is: &quot;Should we in general switch from EntityManager.merge(entity) to EntityManager.persist(entity)?&quot; Is there a reason to use EntityManager.merge(entity)?&lt;/p&gt;

&lt;p&gt;Christian&lt;/p&gt;</comment>
                            <comment id="12955538" author="muellerc" created="Thu, 22 Jul 2010 21:30:53 +0000"  >&lt;p&gt;The following two posts explains, why we need the EntityManager.merge(entity) method. In short, we need it (only) for updates:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;a href=&quot;http://openjpa.apache.org/builds/1.2.2/apache-openjpa-1.2.2/docs/manual/jpa_overview_em_lifecycle.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://openjpa.apache.org/builds/1.2.2/apache-openjpa-1.2.2/docs/manual/jpa_overview_em_lifecycle.html&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;http://openjpa.208410.n2.nabble.com/persisting-an-entity-and-JPA-behaviour-with-referenced-entities-td210469.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://openjpa.208410.n2.nabble.com/persisting-an-entity-and-JPA-behaviour-with-referenced-entities-td210469.html&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I&apos;m wondering, if EntityManager.persist(entity) is a better default than EntityManager.merge(entity)? I could imagine, that most of the user insert a new entity in the database instead of updating an existing entity.&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Pro: EntityManager.persist(entity) do not execute a select query for each entity which should be stored.&lt;/li&gt;
	&lt;li&gt;Con: EntityManager.persist(entity) doesn&apos;t work for detached entities (executing an UPDATE instead of an INSERT).&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Christian&lt;/p&gt;</comment>
                            <comment id="12949730" author="davsclaus" created="Fri, 23 Jul 2010 04:48:55 +0000"  >&lt;p&gt;Christian I think we should add an option so end users can choose if they want to use &lt;tt&gt;merge&lt;/tt&gt; or &lt;tt&gt;persist&lt;/tt&gt;. The default value could be the current one.&lt;/p&gt;</comment>
                            <comment id="12949032" author="davsclaus" created="Sun, 25 Jul 2010 12:23:22 +0000"  >&lt;p&gt;Christian I think you have fixed this with the new option? If so close this ticket&lt;/p&gt;</comment>
                            <comment id="12954382" author="muellerc" created="Mon, 26 Jul 2010 21:28:25 +0000"  >&lt;p&gt;Unfortunately not. I have fixed &lt;a href=&quot;https://issues.apache.org/activemq/browse/CAMEL-2982&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CAMEL-2982&lt;/a&gt; with the new &apos;usePersist&apos; option. What I have to change for this issue is something like this:&lt;/p&gt;

&lt;p&gt;is:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;entityManager.merge(entity); 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;shall:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; managedEntity = entityManager.merge(entity);
exchange.getIn().setBody(managedEntity);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;But this is not so trivial, because the input could be not only an annotated entity, it could also be a list, map, ... and in the current implementation we iterate over a collection (which may be only have one entry):&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void process(Exchange exchange) {
  exchange.getIn().setHeader(JpaConstants.JPA_TEMPLATE, endpoint.getTemplate());
  &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; values = expression.evaluate(exchange, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.class);
  &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (values != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
    template.execute(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; JpaCallback() {
      &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; doInJpa(EntityManager entityManager) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; PersistenceException {
        Iterator iter = ObjectHelper.createIterator(values);
          &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; value = iter.next();
          &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (endpoint.isUsePersist()) {
            entityManager.persist(value);
          } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
            entityManager.merge(value);
          }
        }
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (endpoint.isFlushOnSend()) {
          entityManager.flush();
        }
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
      }
    });
  }
  exchange.getIn().removeHeader(JpaConstants.JPA_TEMPLATE);
} 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Christian&lt;/p&gt;</comment>
                            <comment id="12949119" author="muellerc" created="Mon, 26 Jul 2010 21:52:47 +0000"  >&lt;p&gt;The Camel JPA &lt;a href=&quot;http://camel.apache.org/jpa.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;wiki page&lt;/a&gt; explains, that: &quot;&lt;em&gt;The body of the In message is assumed to be an entity bean (that is, a POJO with an @Entity annotation on it).&lt;/em&gt;&quot;&lt;br/&gt;
I wonder, whether the wiki page is outdated (because the code looks like that we support also collections, ... as body). To be sure, first I will write some unit tests for this...&lt;/p&gt;

&lt;p&gt;Christian&lt;/p&gt;</comment>
                            <comment id="13023934" author="davsclaus" created="Sun, 24 Apr 2011 09:57:46 +0000"  >&lt;p&gt;Closing all resolved tickets from 2010 or older&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>76381</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 31 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i01rx3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>8292</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>