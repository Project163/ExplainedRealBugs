<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 11:10:16 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-21888] High CPU usage at startup due to Deque.size() iteration in SimpleLRUCache</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-21888</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;Hello,&lt;/p&gt;

&lt;p&gt;Starting with &lt;b&gt;Camel 4.7.0,&lt;/b&gt; a change was introduced in &lt;b&gt;SimpleLRUCache,&lt;/b&gt;&#160;where a&#160;&lt;b&gt;Deque&lt;/b&gt;&#160;is now used to track &lt;b&gt;lastChanges.&lt;/b&gt;&#160;&lt;/p&gt;

&lt;p&gt;Please see: &lt;a href=&quot;https://github.com/apache/camel/commit/a7e696927dea30795a49a4c0ac4a36ee700131ff&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/commit/a7e696927dea30795a49a4c0ac4a36ee700131ff&lt;/a&gt; and&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-20850&quot; title=&quot;LRUCache evicts entries unexpectedly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-20850&quot;&gt;&lt;del&gt;CAMEL-20850&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This change causes &lt;b&gt;high CPU usage at startup&lt;/b&gt; when the cache is populated, as&#160;&lt;b&gt;Deque.size() iterates over all cache entries.&lt;/b&gt; This results in 100% CPU usage, and the &lt;b&gt;application failed to start.&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;This issue was observed only in production, after migrating to Camel 4.7.0, where the cache size is significantly large (1,200,000 entries at that time). Current stable version is Camel 4.6.0. The behavior was reproduced with Camel 4.10.0 as well.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;We are using&#160;&lt;b&gt;KafkaIdempotentRepository&lt;/b&gt;, which relies on SimpleLRUCache. In our app, we expose a metric that contains the size of the cache at a certain point.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@Bean
@ConditionalOnBean(KafkaIdempotentRepository.class)
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; MeterBinder cacheSize(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; KafkaIdempotentRepository idempotentRepository) {
  &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; registry -&amp;gt; Gauge.builder(&lt;span class=&quot;code-quote&quot;&gt;&quot;cacheSize&quot;&lt;/span&gt;,idempotentRepository::getCacheSize)
.register(registry);
}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Would appreciate any insights on this issue.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13612552">CAMEL-21888</key>
            <summary>High CPU usage at startup due to Deque.size() iteration in SimpleLRUCache</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="nfilotto">Nicolas Filotto</assignee>
                                    <reporter username="nadinaf">Nadina Florea</reporter>
                        <labels>
                    </labels>
                <created>Thu, 20 Mar 2025 16:28:14 +0000</created>
                <updated>Thu, 19 Jun 2025 05:07:25 +0000</updated>
                            <resolved>Mon, 24 Mar 2025 15:30:40 +0000</resolved>
                                    <version>4.7.0</version>
                                    <fixVersion>4.8.6</fixVersion>
                    <fixVersion>4.10.3</fixVersion>
                    <fixVersion>4.11.0</fixVersion>
                                    <component>came-core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17937160" author="JIRAUSER285918" created="Thu, 20 Mar 2025 16:39:55 +0000"  >&lt;p&gt;We have actually fixed several issues related to it since 4.7 as you can see in the history &lt;a href=&quot;https://github.com/apache/camel/commits/main/core/camel-support/src/main/java/org/apache/camel/support/cache/SimpleLRUCache.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/commits/main/core/camel-support/src/main/java/org/apache/camel/support/cache/SimpleLRUCache.java&lt;/a&gt;&lt;br/&gt;
Please retry with the latest version of Camel or with the latest version of 4.8 (LTS version), as they both include all the fixes.&lt;br/&gt;
Note that 4.7 is not an LTS so that we won&apos;t provide a fix for this particular version&lt;/p&gt;</comment>
                            <comment id="17937161" author="JIRAUSER308349" created="Thu, 20 Mar 2025 16:47:44 +0000"  >&lt;p&gt;We reproduced this behavior with both&#160;&lt;b&gt;4.8.1&lt;/b&gt;&#160;and&#160;&lt;b&gt;4.10.0.&lt;/b&gt;&lt;/p&gt;</comment>
                            <comment id="17937164" author="JIRAUSER285918" created="Thu, 20 Mar 2025 17:01:52 +0000"  >&lt;p&gt;Please provide steps to reproduce, ideally a small GitHub project.&lt;/p&gt;

&lt;p&gt;By &lt;b&gt;high CPU usage at startup&lt;/b&gt;, do you mean that once started, the CPU goes back to normal or it never ends? &lt;/p&gt;</comment>
                            <comment id="17937166" author="JIRAUSER308349" created="Thu, 20 Mar 2025 17:06:33 +0000"  >&lt;p&gt;The CPU reaches 100% and the application fails to start (it doesn&apos;t recover after a while)&lt;/p&gt;</comment>
                            <comment id="17937180" author="JIRAUSER285918" created="Thu, 20 Mar 2025 17:44:33 +0000"  >&lt;p&gt;Without any steps to reproduce in order to better understand the problem, I don&apos;t see what I can do.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davsclaus&quot; class=&quot;user-hover&quot; rel=&quot;davsclaus&quot;&gt;davsclaus&lt;/a&gt; Do you remember why camel-caffeine-lrucache has been removed from Camel 4? Maybe it could be re-added to manage this kind of usecase?&lt;/p&gt;</comment>
                            <comment id="17937534" author="ben.manes" created="Sat, 22 Mar 2025 03:05:50 +0000"  >&lt;p&gt;I don&apos;t know how your simple lru works, but for small concurrent caches w/o dependencies then I&apos;d recommend using the Clock algorithm (1960s) as a pseudo lru. It is often referred to as Second Chance. This is very simple to implement as it is merely a FIFO with a &quot;marked&quot; bit set on read, and on eviction it locks to scan the fifo resetting the bit until it finds an unset one to evict. Thus it has excellent concurrent read performance (no movement or locking), has LRU like hit rates, and a worst-case O( N )&#160;eviction cost. For a small cache that&apos;s perfectly fine and it is very simple to implement. For larger caches one could simply use a scan threshold to limit the worst case.&lt;/p&gt;

&lt;p&gt;When I was originally exploring algorithms that was my first &lt;a href=&quot;https://github.com/ben-manes/concurrentlinkedhashmap/blob/cc3e11603e8a91185c1748633be2c703e218219e/src/test/java/com/googlecode/concurrentlinkedhashmap/caches/ProductionMap.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;proof-of-concept&lt;/a&gt; and it was perfect for spot issues at work. I don&apos;t like it as a general library algorithm where the workloads and user needs vary significantly and many more features would be needed so a more general concurrency mechanism (e.g. to cover TTL) was preferable. For a stand in while exploring the options it was my go to and I still think it is a great fit for modest sized, zero dependency use cases.&lt;/p&gt;</comment>
                            <comment id="17937558" author="JIRAUSER285918" created="Sat, 22 Mar 2025 08:12:40 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ben.manes&quot; class=&quot;user-hover&quot; rel=&quot;ben.manes&quot;&gt;ben.manes&lt;/a&gt; Hi, thanks for sharing. It is always priceless to have your feedback on the subject. I proposed a new PR to manage the second chance by providing a unique ID to each value to avoid evicting the same key/value pair that has been put multiple times in the cache, it allows me to avoid compressing the changes too often which seems to be the root cause of the problem in this case. &lt;/p&gt;

&lt;p&gt;If this new PR doesn&apos;t allow fixing the problem, I will definitively drop the queue of changes for something similar to your LRU algorithm based on a global lock to manage the update of the two links, which I initially wanted to avoid to keep a globally &quot;lock-free&quot; approach. &lt;/p&gt;

&lt;p&gt;Regarding your algorithm Second Chance, it could have been a good trade-off but it has some drawbacks as it could evict more recent key/value pairs in some situations like the following, and it could be seen as a bug by end-users:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        ProductionMap&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; map = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ProductionMap&amp;lt;&amp;gt;(16, 3, EvictionPolicy.SECOND_CHANCE);
        map.put(&lt;span class=&quot;code-quote&quot;&gt;&quot;A&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;1&quot;&lt;/span&gt;);
        map.put(&lt;span class=&quot;code-quote&quot;&gt;&quot;A&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;2&quot;&lt;/span&gt;); &lt;span class=&quot;code-comment&quot;&gt;// Marked
&lt;/span&gt;        map.put(&lt;span class=&quot;code-quote&quot;&gt;&quot;B&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;1&quot;&lt;/span&gt;);
        map.put(&lt;span class=&quot;code-quote&quot;&gt;&quot;B&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;2&quot;&lt;/span&gt;); &lt;span class=&quot;code-comment&quot;&gt;// Marked
&lt;/span&gt;        map.put(&lt;span class=&quot;code-quote&quot;&gt;&quot;C&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;1&quot;&lt;/span&gt;);
        map.put(&lt;span class=&quot;code-quote&quot;&gt;&quot;C&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;2&quot;&lt;/span&gt;); &lt;span class=&quot;code-comment&quot;&gt;// Marked
&lt;/span&gt;        map.put(&lt;span class=&quot;code-quote&quot;&gt;&quot;D&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;1&quot;&lt;/span&gt;); &lt;span class=&quot;code-comment&quot;&gt;// last entry is evicted as it is the first non-marked entry&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17937633" author="ben.manes" created="Sat, 22 Mar 2025 21:09:19 +0000"  >&lt;p&gt;Oh good, I&#8217;ll need to look into your approach! I hope your fix nails the problem.&lt;/p&gt;

&lt;p&gt;The design that I use is to record the access into a queue (ring buffer) that is drained when full using a tryLock. That can guard a normal lru so it just batches the work under the lock for replay instead of lru lock contention.&lt;/p&gt;

&lt;p&gt;It&#8217;s surprisingly hard to get whatever scheme to work as desired. Ehcache uses sampling for their lru and &lt;a href=&quot;https://gist.github.com/ben-manes/6312727adfa2235cb7c5e25cae523ad0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;busted&lt;/a&gt; it up really badly by not understanding how hash tables work.&lt;/p&gt;</comment>
                            <comment id="17937635" author="ben.manes" created="Sat, 22 Mar 2025 21:24:33 +0000"  >&lt;p&gt;Oh fwiw, &lt;a href=&quot;https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/concurrent/ConcurrentLinkedDeque.html#size()&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;ConcurrentLinkedDeque&#8217;s size()&lt;/a&gt; method is O( N ) so you might want a separate counter since that may be called often wrt evictionNeeded().&lt;/p&gt;</comment>
                            <comment id="17937677" author="JIRAUSER285918" created="Sun, 23 Mar 2025 07:50:03 +0000"  >&lt;p&gt;Good catch, thank you for the reminder, let me fix that&lt;/p&gt;</comment>
                            <comment id="17937702" author="JIRAUSER285918" created="Sun, 23 Mar 2025 12:18:56 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nadinaf&quot; class=&quot;user-hover&quot; rel=&quot;nadinaf&quot;&gt;nadinaf&lt;/a&gt; The latest snapshot of Camel 4.11.0-SNAPSHOT contains a fix and has been published to &lt;a href=&quot;https://repository.apache.org/snapshots/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://repository.apache.org/snapshots/&lt;/a&gt;. Could you please test it?&lt;/p&gt;</comment>
                            <comment id="17937845" author="JIRAUSER285918" created="Mon, 24 Mar 2025 10:34:16 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shmyer&quot; class=&quot;user-hover&quot; rel=&quot;shmyer&quot;&gt;shmyer&lt;/a&gt; If somehow you can test it too to ensure there is no regression before I backport the fix, it would be very helpful&lt;/p&gt;</comment>
                            <comment id="17937914" author="JIRAUSER308349" created="Mon, 24 Mar 2025 14:14:42 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nfilotto&quot; class=&quot;user-hover&quot; rel=&quot;nfilotto&quot;&gt;nfilotto&lt;/a&gt; Tested with the provided snapshot, and the issue seems to be resolved. Thank you, really appreciate the effort in diagnosing and fixing this!&#160;&lt;/p&gt;

&lt;p&gt;Will this fix be included in 4.11.0?&lt;/p&gt;</comment>
                            <comment id="17937921" author="JIRAUSER285918" created="Mon, 24 Mar 2025 14:37:45 +0000"  >&lt;p&gt;It will be included in 4.11, corresponding to the main branch, but also the still supported LTS versions, which are 4.8 and 4.10&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13621205">CAMEL-22176</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13621205">CAMEL-22176</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            33 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1uwdk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>