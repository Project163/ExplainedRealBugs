<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:46:43 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-12078] MIME-Mutipart DataFormat reads attachment DataSource twice</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-12078</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;As reported on mailing list if an attachment for MIME-Mutipart DataFormat is defined using a DataSource that can only be read once you get an exception.&lt;br/&gt;
&lt;a href=&quot;http://mail-archives.apache.org/mod_mbox/camel-users/201712.mbox/%3C0e0d4b2e-dc32-c61e-3ccd-7ee14238c485%40gmail.com%3E&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://mail-archives.apache.org/mod_mbox/camel-users/201712.mbox/%3C0e0d4b2e-dc32-c61e-3ccd-7ee14238c485%40gmail.com%3E&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;For instance, this happens if the DataSource is created using an InputStream that cannot be read multiple times&lt;br/&gt;
It should be possible to post the data only reading the input a single time.&lt;/p&gt;

&lt;p&gt;I will add a test case shortly.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13124429">CAMEL-12078</key>
            <summary>MIME-Mutipart DataFormat reads attachment DataSource twice</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="tdudgeon">Tim Dudgeon</reporter>
                        <labels>
                    </labels>
                <created>Tue, 12 Dec 2017 17:49:33 +0000</created>
                <updated>Tue, 23 Mar 2021 11:04:46 +0000</updated>
                            <resolved>Tue, 23 Mar 2021 11:04:46 +0000</resolved>
                                    <version>2.20.1</version>
                                    <fixVersion>3.10.0</fixVersion>
                                    <component>camel-mail</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16287969" author="tdudgeon" created="Tue, 12 Dec 2017 17:53:29 +0000"  >&lt;p&gt;Here is a unit test that fails currently as the DataSoruce is read twice:&lt;br/&gt;
&lt;a href=&quot;https://github.com/tdudgeon/camel/commit/721b9851f5537a22b5353a2f7c5da62d8bcfe766&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/tdudgeon/camel/commit/721b9851f5537a22b5353a2f7c5da62d8bcfe766&lt;/a&gt;&lt;br/&gt;
It&apos;s on my fork. Do you want a PR (the test fails at present)?&lt;/p&gt;</comment>
                            <comment id="16323708" author="davsclaus" created="Fri, 12 Jan 2018 08:41:06 +0000"  >&lt;p&gt;Yes a PR with the test would be good, thanks&lt;/p&gt;</comment>
                            <comment id="16331155" author="aldettinger" created="Thu, 18 Jan 2018 20:27:27 +0000"  >&lt;p&gt;Given a quick look at this test case and I can&apos;t reproduce any issue.&lt;br/&gt;
Indeed, &lt;tt&gt;DataSource.getInputStream()&lt;/tt&gt; is called twice, but returns a &lt;tt&gt;SharedByteArrayInputStream&lt;/tt&gt; instance which support multiple readers.&lt;br/&gt;
Changing the test to use &lt;tt&gt;FileDataSource/FileInputStream&lt;/tt&gt; does not produce either exception.&lt;/p&gt;

&lt;p&gt;Could one reproduce the exception ?&lt;/p&gt;</comment>
                            <comment id="16332253" author="davsclaus" created="Fri, 19 Jan 2018 13:31:30 +0000"  >&lt;p&gt;I guess you may have some kind of input that is a stream that is only readable once, eg some http server stream or something. And they may not support reset / mark of input stream and all of that, hence you would need to use Camel&apos;s stream caching. Or in this case may try to avoid reading it 2 times. But a reproducer is best to have first.&lt;/p&gt;</comment>
                            <comment id="16332269" author="githubbot" created="Fri, 19 Jan 2018 13:45:12 +0000"  >&lt;p&gt;tdudgeon opened a new pull request #2185: Failing test for &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12078&quot; title=&quot;MIME-Mutipart DataFormat reads attachment DataSource twice&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12078&quot;&gt;&lt;del&gt;CAMEL-12078&lt;/del&gt;&lt;/a&gt;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2185&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2185&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   This PR provides a failing test for &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12078&quot; title=&quot;MIME-Mutipart DataFormat reads attachment DataSource twice&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12078&quot;&gt;&lt;del&gt;CAMEL-12078&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
   It shows that the DataSource for an attachment  is read twice.&lt;br/&gt;
   The test to look at is MimeMultipartDataFormatTest.attachmentReadOnce()&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16332270" author="githubbot" created="Fri, 19 Jan 2018 13:45:13 +0000"  >&lt;p&gt;GitHub user tdudgeon opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/camel/pull/2185&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2185&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Failing test for &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12078&quot; title=&quot;MIME-Mutipart DataFormat reads attachment DataSource twice&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12078&quot;&gt;&lt;del&gt;CAMEL-12078&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    This PR provides a failing test for &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12078&quot; title=&quot;MIME-Mutipart DataFormat reads attachment DataSource twice&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12078&quot;&gt;&lt;del&gt;CAMEL-12078&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    It shows that the DataSource for an attachment  is read twice.&lt;br/&gt;
    The test to look at is MimeMultipartDataFormatTest.attachmentReadOnce()&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/tdudgeon/camel&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/tdudgeon/camel&lt;/a&gt; master&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/camel/pull/2185.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2185.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #2185&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 721b9851f5537a22b5353a2f7c5da62d8bcfe766&lt;br/&gt;
Author: Tim Dudgeon &amp;lt;tdudgeon@...&amp;gt;&lt;br/&gt;
Date:   2017-12-12T17:51:05Z&lt;/p&gt;

&lt;p&gt;    failing test for &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12078&quot; title=&quot;MIME-Mutipart DataFormat reads attachment DataSource twice&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12078&quot;&gt;&lt;del&gt;CAMEL-12078&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;commit 0fcd0b28865e424871975f80073cfc3dd887f337&lt;br/&gt;
Author: Tim Dudgeon &amp;lt;tdudgeon@...&amp;gt;&lt;br/&gt;
Date:   2018-01-19T08:40:39Z&lt;/p&gt;

&lt;p&gt;    Merge branch &apos;master&apos; of &lt;a href=&quot;https://github.com/apache/camel&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;commit 3350601da20d02d439b6d0cbbb639871988c66ce&lt;br/&gt;
Author: Tim Dudgeon &amp;lt;tdudgeon@...&amp;gt;&lt;br/&gt;
Date:   2018-01-19T13:38:48Z&lt;/p&gt;

&lt;p&gt;    Merge branch &apos;master&apos; of &lt;a href=&quot;https://github.com/apache/camel&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel&lt;/a&gt;&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16332272" author="githubbot" created="Fri, 19 Jan 2018 13:46:59 +0000"  >&lt;p&gt;oscerd commented on issue #2185: Failing test for &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12078&quot; title=&quot;MIME-Mutipart DataFormat reads attachment DataSource twice&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12078&quot;&gt;&lt;del&gt;CAMEL-12078&lt;/del&gt;&lt;/a&gt;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2185#issuecomment-358970234&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2185#issuecomment-358970234&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Can you please rebase?&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16332273" author="githubbot" created="Fri, 19 Jan 2018 13:47:20 +0000"  >&lt;p&gt;oscerd commented on issue #2185: Failing test for &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12078&quot; title=&quot;MIME-Mutipart DataFormat reads attachment DataSource twice&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12078&quot;&gt;&lt;del&gt;CAMEL-12078&lt;/del&gt;&lt;/a&gt;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2185#issuecomment-358970234&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2185#issuecomment-358970234&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Can you please rebase and squash commit? Otherwise I&apos;ll take care of this.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16332276" author="tdudgeon" created="Fri, 19 Jan 2018 13:49:44 +0000"  >&lt;p&gt;I created a PR with a test that illustrates this.&lt;/p&gt;</comment>
                            <comment id="16332286" author="githubbot" created="Fri, 19 Jan 2018 13:58:48 +0000"  >&lt;p&gt;oscerd commented on issue #2185: Failing test for &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12078&quot; title=&quot;MIME-Mutipart DataFormat reads attachment DataSource twice&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12078&quot;&gt;&lt;del&gt;CAMEL-12078&lt;/del&gt;&lt;/a&gt;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2185#issuecomment-358973199&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2185#issuecomment-358973199&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Ok, this is an example test to show a failing scenario, so no need for rebase. Thanks @tdudgeon &lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16335839" author="davsclaus" created="Tue, 23 Jan 2018 14:34:15 +0000"  >&lt;p&gt;This is harder to avoid as its the java-mail mime multipart itself that does this. I cannot see an easy solution.&#160;&lt;/p&gt;

&lt;p&gt;From where do you have those attachments in your use-case that is only readable once?&lt;br/&gt;
You can try to re-attach them with some custom DataHandler / DataSource where the DataSource is re-readable via byte array input stream or stored as files.&lt;/p&gt;

&lt;p&gt;Even if you remove that line 140 with the saveChanges then the java-mail multipart will auto do that later when you call the write call where it then will do a saveChanges first.&#160;&lt;/p&gt;</comment>
                            <comment id="16515591" author="githubbot" created="Mon, 18 Jun 2018 11:10:37 +0000"  >&lt;p&gt;onderson commented on a change in pull request #2185: Failing test for &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12078&quot; title=&quot;MIME-Mutipart DataFormat reads attachment DataSource twice&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12078&quot;&gt;&lt;del&gt;CAMEL-12078&lt;/del&gt;&lt;/a&gt;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2185#discussion_r196040361&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2185#discussion_r196040361&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: components/camel-mail/src/test/java/org/apache/camel/dataformat/mime/multipart/MimeMultipartDataFormatTest.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -351,6 +351,41 @@ public void unmarshalInlineHeadersNonMimeBodyStream() throws UnsupportedEncoding&lt;br/&gt;
         assertEquals(&quot;This is not a MIME-Multipart&quot;, bodyStr);&lt;br/&gt;
     }&lt;/p&gt;

&lt;p&gt;+    @Test&lt;br/&gt;
+    public void attachmentReadOnce() throws IOException {&lt;br/&gt;
+        String attContentType = &quot;text/plain&quot;;&lt;br/&gt;
+        String attText = &quot;Attachment Text&quot;;&lt;br/&gt;
+        InputStream attInputStream = new ByteArrayInputStream(attText.getBytes());&lt;br/&gt;
+        String attFileName = &quot;Attachment File Name&quot;;&lt;br/&gt;
+        in.setBody(&quot;Body text&quot;);&lt;br/&gt;
+        in.setHeader(Exchange.CONTENT_TYPE, &quot;text/plain;charset=iso8859-1;other-parameter=true&quot;);&lt;br/&gt;
+        in.setHeader(Exchange.CONTENT_ENCODING, &quot;UTF8&quot;);&lt;br/&gt;
+        Map&amp;lt;String, String&amp;gt; headers = new HashMap&amp;lt;String, String&amp;gt;();&lt;br/&gt;
+        headers.put(&quot;Content-Description&quot;, &quot;Sample Attachment Data&quot;);&lt;br/&gt;
+        headers.put(&quot;X-AdditionalData&quot;, &quot;additional data&quot;);&lt;br/&gt;
+        CountingByteArrayDataSource attachmentDs = new CountingByteArrayDataSource(attInputStream, attContentType);&lt;br/&gt;
+        addAttachment(attachmentDs, attFileName, headers);&lt;br/&gt;
+        Exchange result = template.send(&quot;direct:roundtrip&quot;, exchange);&lt;br/&gt;
+        Message out = result.getOut();&lt;br/&gt;
+        assertEquals(&quot;Body text&quot;, out.getBody(String.class));&lt;br/&gt;
+        assertThat(out.getHeader(Exchange.CONTENT_TYPE, String.class), startsWith(&quot;text/plain&quot;));&lt;br/&gt;
+        assertEquals(&quot;UTF8&quot;, out.getHeader(Exchange.CONTENT_ENCODING));&lt;br/&gt;
+        assertTrue(out.hasAttachments());&lt;br/&gt;
+        assertEquals(1, out.getAttachmentNames().size());&lt;br/&gt;
+        assertThat(out.getAttachmentNames(), hasItem(attFileName));&lt;br/&gt;
+        Attachment att = out.getAttachmentObject(attFileName);&lt;br/&gt;
+        DataHandler dh = att.getDataHandler();&lt;br/&gt;
+        assertNotNull(dh);&lt;br/&gt;
+        assertEquals(attContentType, dh.getContentType());&lt;br/&gt;
+        InputStream is = dh.getInputStream();&lt;br/&gt;
+        ByteArrayOutputStream os = new ByteArrayOutputStream();&lt;br/&gt;
+        IOHelper.copyAndCloseInput(is, os);&lt;br/&gt;
+        assertEquals(attText, new String(os.toByteArray()));&lt;br/&gt;
+        assertEquals(&quot;Sample Attachment Data&quot;, att.getHeader(&quot;content-description&quot;));&lt;br/&gt;
+        assertEquals(&quot;additional data&quot;, att.getHeader(&quot;X-AdditionalData&quot;));&lt;br/&gt;
+        assertEquals(1, attachmentDs.readCounts); // Fails - input is read twice&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   @tdudgeon , do you have any input to @aldettinger &apos;s question? &lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16515615" author="githubbot" created="Mon, 18 Jun 2018 11:46:40 +0000"  >&lt;p&gt;tdudgeon commented on a change in pull request #2185: Failing test for &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12078&quot; title=&quot;MIME-Mutipart DataFormat reads attachment DataSource twice&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12078&quot;&gt;&lt;del&gt;CAMEL-12078&lt;/del&gt;&lt;/a&gt;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2185#discussion_r196048187&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2185#discussion_r196048187&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: components/camel-mail/src/test/java/org/apache/camel/dataformat/mime/multipart/MimeMultipartDataFormatTest.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -351,6 +351,41 @@ public void unmarshalInlineHeadersNonMimeBodyStream() throws UnsupportedEncoding&lt;br/&gt;
         assertEquals(&quot;This is not a MIME-Multipart&quot;, bodyStr);&lt;br/&gt;
     }&lt;/p&gt;

&lt;p&gt;+    @Test&lt;br/&gt;
+    public void attachmentReadOnce() throws IOException {&lt;br/&gt;
+        String attContentType = &quot;text/plain&quot;;&lt;br/&gt;
+        String attText = &quot;Attachment Text&quot;;&lt;br/&gt;
+        InputStream attInputStream = new ByteArrayInputStream(attText.getBytes());&lt;br/&gt;
+        String attFileName = &quot;Attachment File Name&quot;;&lt;br/&gt;
+        in.setBody(&quot;Body text&quot;);&lt;br/&gt;
+        in.setHeader(Exchange.CONTENT_TYPE, &quot;text/plain;charset=iso8859-1;other-parameter=true&quot;);&lt;br/&gt;
+        in.setHeader(Exchange.CONTENT_ENCODING, &quot;UTF8&quot;);&lt;br/&gt;
+        Map&amp;lt;String, String&amp;gt; headers = new HashMap&amp;lt;String, String&amp;gt;();&lt;br/&gt;
+        headers.put(&quot;Content-Description&quot;, &quot;Sample Attachment Data&quot;);&lt;br/&gt;
+        headers.put(&quot;X-AdditionalData&quot;, &quot;additional data&quot;);&lt;br/&gt;
+        CountingByteArrayDataSource attachmentDs = new CountingByteArrayDataSource(attInputStream, attContentType);&lt;br/&gt;
+        addAttachment(attachmentDs, attFileName, headers);&lt;br/&gt;
+        Exchange result = template.send(&quot;direct:roundtrip&quot;, exchange);&lt;br/&gt;
+        Message out = result.getOut();&lt;br/&gt;
+        assertEquals(&quot;Body text&quot;, out.getBody(String.class));&lt;br/&gt;
+        assertThat(out.getHeader(Exchange.CONTENT_TYPE, String.class), startsWith(&quot;text/plain&quot;));&lt;br/&gt;
+        assertEquals(&quot;UTF8&quot;, out.getHeader(Exchange.CONTENT_ENCODING));&lt;br/&gt;
+        assertTrue(out.hasAttachments());&lt;br/&gt;
+        assertEquals(1, out.getAttachmentNames().size());&lt;br/&gt;
+        assertThat(out.getAttachmentNames(), hasItem(attFileName));&lt;br/&gt;
+        Attachment att = out.getAttachmentObject(attFileName);&lt;br/&gt;
+        DataHandler dh = att.getDataHandler();&lt;br/&gt;
+        assertNotNull(dh);&lt;br/&gt;
+        assertEquals(attContentType, dh.getContentType());&lt;br/&gt;
+        InputStream is = dh.getInputStream();&lt;br/&gt;
+        ByteArrayOutputStream os = new ByteArrayOutputStream();&lt;br/&gt;
+        IOHelper.copyAndCloseInput(is, os);&lt;br/&gt;
+        assertEquals(attText, new String(os.toByteArray()));&lt;br/&gt;
+        assertEquals(&quot;Sample Attachment Data&quot;, att.getHeader(&quot;content-description&quot;));&lt;br/&gt;
+        assertEquals(&quot;additional data&quot;, att.getHeader(&quot;X-AdditionalData&quot;));&lt;br/&gt;
+        assertEquals(1, attachmentDs.readCounts); // Fails - input is read twice&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   @aldettinger Yes, it can matter (and sorry for slow response). Some types of DataSource cannot be read repeatedly so you get an exception when it read a second time. &lt;br/&gt;
   I&apos;m sure this was discussed on the users mailing list, but I can&apos;t find the topic right now &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16515714" author="githubbot" created="Mon, 18 Jun 2018 13:42:07 +0000"  >&lt;p&gt;onderson commented on a change in pull request #2185: Failing test for &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12078&quot; title=&quot;MIME-Mutipart DataFormat reads attachment DataSource twice&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12078&quot;&gt;&lt;del&gt;CAMEL-12078&lt;/del&gt;&lt;/a&gt;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2185#discussion_r196081306&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2185#discussion_r196081306&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: components/camel-mail/src/test/java/org/apache/camel/dataformat/mime/multipart/MimeMultipartDataFormatTest.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -351,6 +351,41 @@ public void unmarshalInlineHeadersNonMimeBodyStream() throws UnsupportedEncoding&lt;br/&gt;
         assertEquals(&quot;This is not a MIME-Multipart&quot;, bodyStr);&lt;br/&gt;
     }&lt;/p&gt;

&lt;p&gt;+    @Test&lt;br/&gt;
+    public void attachmentReadOnce() throws IOException {&lt;br/&gt;
+        String attContentType = &quot;text/plain&quot;;&lt;br/&gt;
+        String attText = &quot;Attachment Text&quot;;&lt;br/&gt;
+        InputStream attInputStream = new ByteArrayInputStream(attText.getBytes());&lt;br/&gt;
+        String attFileName = &quot;Attachment File Name&quot;;&lt;br/&gt;
+        in.setBody(&quot;Body text&quot;);&lt;br/&gt;
+        in.setHeader(Exchange.CONTENT_TYPE, &quot;text/plain;charset=iso8859-1;other-parameter=true&quot;);&lt;br/&gt;
+        in.setHeader(Exchange.CONTENT_ENCODING, &quot;UTF8&quot;);&lt;br/&gt;
+        Map&amp;lt;String, String&amp;gt; headers = new HashMap&amp;lt;String, String&amp;gt;();&lt;br/&gt;
+        headers.put(&quot;Content-Description&quot;, &quot;Sample Attachment Data&quot;);&lt;br/&gt;
+        headers.put(&quot;X-AdditionalData&quot;, &quot;additional data&quot;);&lt;br/&gt;
+        CountingByteArrayDataSource attachmentDs = new CountingByteArrayDataSource(attInputStream, attContentType);&lt;br/&gt;
+        addAttachment(attachmentDs, attFileName, headers);&lt;br/&gt;
+        Exchange result = template.send(&quot;direct:roundtrip&quot;, exchange);&lt;br/&gt;
+        Message out = result.getOut();&lt;br/&gt;
+        assertEquals(&quot;Body text&quot;, out.getBody(String.class));&lt;br/&gt;
+        assertThat(out.getHeader(Exchange.CONTENT_TYPE, String.class), startsWith(&quot;text/plain&quot;));&lt;br/&gt;
+        assertEquals(&quot;UTF8&quot;, out.getHeader(Exchange.CONTENT_ENCODING));&lt;br/&gt;
+        assertTrue(out.hasAttachments());&lt;br/&gt;
+        assertEquals(1, out.getAttachmentNames().size());&lt;br/&gt;
+        assertThat(out.getAttachmentNames(), hasItem(attFileName));&lt;br/&gt;
+        Attachment att = out.getAttachmentObject(attFileName);&lt;br/&gt;
+        DataHandler dh = att.getDataHandler();&lt;br/&gt;
+        assertNotNull(dh);&lt;br/&gt;
+        assertEquals(attContentType, dh.getContentType());&lt;br/&gt;
+        InputStream is = dh.getInputStream();&lt;br/&gt;
+        ByteArrayOutputStream os = new ByteArrayOutputStream();&lt;br/&gt;
+        IOHelper.copyAndCloseInput(is, os);&lt;br/&gt;
+        assertEquals(attText, new String(os.toByteArray()));&lt;br/&gt;
+        assertEquals(&quot;Sample Attachment Data&quot;, att.getHeader(&quot;content-description&quot;));&lt;br/&gt;
+        assertEquals(&quot;additional data&quot;, att.getHeader(&quot;X-AdditionalData&quot;));&lt;br/&gt;
+        assertEquals(1, attachmentDs.readCounts); // Fails - input is read twice&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   I think this is &lt;a href=&quot;http://camel.465427.n5.nabble.com/MIME-Mutipart-DataFormat-streaming-td5789219.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://camel.465427.n5.nabble.com/MIME-Mutipart-DataFormat-streaming-td5789219.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16539601" author="githubbot" created="Wed, 11 Jul 2018 06:05:12 +0000"  >&lt;p&gt;onderson commented on a change in pull request #2185: Failing test for &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12078&quot; title=&quot;MIME-Mutipart DataFormat reads attachment DataSource twice&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12078&quot;&gt;&lt;del&gt;CAMEL-12078&lt;/del&gt;&lt;/a&gt;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2185#discussion_r201573099&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2185#discussion_r201573099&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: components/camel-mail/src/test/java/org/apache/camel/dataformat/mime/multipart/MimeMultipartDataFormatTest.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -351,6 +351,41 @@ public void unmarshalInlineHeadersNonMimeBodyStream() throws UnsupportedEncoding&lt;br/&gt;
         assertEquals(&quot;This is not a MIME-Multipart&quot;, bodyStr);&lt;br/&gt;
     }&lt;/p&gt;

&lt;p&gt;+    @Test&lt;br/&gt;
+    public void attachmentReadOnce() throws IOException {&lt;br/&gt;
+        String attContentType = &quot;text/plain&quot;;&lt;br/&gt;
+        String attText = &quot;Attachment Text&quot;;&lt;br/&gt;
+        InputStream attInputStream = new ByteArrayInputStream(attText.getBytes());&lt;br/&gt;
+        String attFileName = &quot;Attachment File Name&quot;;&lt;br/&gt;
+        in.setBody(&quot;Body text&quot;);&lt;br/&gt;
+        in.setHeader(Exchange.CONTENT_TYPE, &quot;text/plain;charset=iso8859-1;other-parameter=true&quot;);&lt;br/&gt;
+        in.setHeader(Exchange.CONTENT_ENCODING, &quot;UTF8&quot;);&lt;br/&gt;
+        Map&amp;lt;String, String&amp;gt; headers = new HashMap&amp;lt;String, String&amp;gt;();&lt;br/&gt;
+        headers.put(&quot;Content-Description&quot;, &quot;Sample Attachment Data&quot;);&lt;br/&gt;
+        headers.put(&quot;X-AdditionalData&quot;, &quot;additional data&quot;);&lt;br/&gt;
+        CountingByteArrayDataSource attachmentDs = new CountingByteArrayDataSource(attInputStream, attContentType);&lt;br/&gt;
+        addAttachment(attachmentDs, attFileName, headers);&lt;br/&gt;
+        Exchange result = template.send(&quot;direct:roundtrip&quot;, exchange);&lt;br/&gt;
+        Message out = result.getOut();&lt;br/&gt;
+        assertEquals(&quot;Body text&quot;, out.getBody(String.class));&lt;br/&gt;
+        assertThat(out.getHeader(Exchange.CONTENT_TYPE, String.class), startsWith(&quot;text/plain&quot;));&lt;br/&gt;
+        assertEquals(&quot;UTF8&quot;, out.getHeader(Exchange.CONTENT_ENCODING));&lt;br/&gt;
+        assertTrue(out.hasAttachments());&lt;br/&gt;
+        assertEquals(1, out.getAttachmentNames().size());&lt;br/&gt;
+        assertThat(out.getAttachmentNames(), hasItem(attFileName));&lt;br/&gt;
+        Attachment att = out.getAttachmentObject(attFileName);&lt;br/&gt;
+        DataHandler dh = att.getDataHandler();&lt;br/&gt;
+        assertNotNull(dh);&lt;br/&gt;
+        assertEquals(attContentType, dh.getContentType());&lt;br/&gt;
+        InputStream is = dh.getInputStream();&lt;br/&gt;
+        ByteArrayOutputStream os = new ByteArrayOutputStream();&lt;br/&gt;
+        IOHelper.copyAndCloseInput(is, os);&lt;br/&gt;
+        assertEquals(attText, new String(os.toByteArray()));&lt;br/&gt;
+        assertEquals(&quot;Sample Attachment Data&quot;, att.getHeader(&quot;content-description&quot;));&lt;br/&gt;
+        assertEquals(&quot;additional data&quot;, att.getHeader(&quot;X-AdditionalData&quot;));&lt;br/&gt;
+        assertEquals(1, attachmentDs.readCounts); // Fails - input is read twice&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   @tdudgeon , @aldettinger any update on this topic?&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16539639" author="githubbot" created="Wed, 11 Jul 2018 07:01:27 +0000"  >&lt;p&gt;tdudgeon commented on a change in pull request #2185: Failing test for &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12078&quot; title=&quot;MIME-Mutipart DataFormat reads attachment DataSource twice&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12078&quot;&gt;&lt;del&gt;CAMEL-12078&lt;/del&gt;&lt;/a&gt;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2185#discussion_r201582751&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2185#discussion_r201582751&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: components/camel-mail/src/test/java/org/apache/camel/dataformat/mime/multipart/MimeMultipartDataFormatTest.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -351,6 +351,41 @@ public void unmarshalInlineHeadersNonMimeBodyStream() throws UnsupportedEncoding&lt;br/&gt;
         assertEquals(&quot;This is not a MIME-Multipart&quot;, bodyStr);&lt;br/&gt;
     }&lt;/p&gt;

&lt;p&gt;+    @Test&lt;br/&gt;
+    public void attachmentReadOnce() throws IOException {&lt;br/&gt;
+        String attContentType = &quot;text/plain&quot;;&lt;br/&gt;
+        String attText = &quot;Attachment Text&quot;;&lt;br/&gt;
+        InputStream attInputStream = new ByteArrayInputStream(attText.getBytes());&lt;br/&gt;
+        String attFileName = &quot;Attachment File Name&quot;;&lt;br/&gt;
+        in.setBody(&quot;Body text&quot;);&lt;br/&gt;
+        in.setHeader(Exchange.CONTENT_TYPE, &quot;text/plain;charset=iso8859-1;other-parameter=true&quot;);&lt;br/&gt;
+        in.setHeader(Exchange.CONTENT_ENCODING, &quot;UTF8&quot;);&lt;br/&gt;
+        Map&amp;lt;String, String&amp;gt; headers = new HashMap&amp;lt;String, String&amp;gt;();&lt;br/&gt;
+        headers.put(&quot;Content-Description&quot;, &quot;Sample Attachment Data&quot;);&lt;br/&gt;
+        headers.put(&quot;X-AdditionalData&quot;, &quot;additional data&quot;);&lt;br/&gt;
+        CountingByteArrayDataSource attachmentDs = new CountingByteArrayDataSource(attInputStream, attContentType);&lt;br/&gt;
+        addAttachment(attachmentDs, attFileName, headers);&lt;br/&gt;
+        Exchange result = template.send(&quot;direct:roundtrip&quot;, exchange);&lt;br/&gt;
+        Message out = result.getOut();&lt;br/&gt;
+        assertEquals(&quot;Body text&quot;, out.getBody(String.class));&lt;br/&gt;
+        assertThat(out.getHeader(Exchange.CONTENT_TYPE, String.class), startsWith(&quot;text/plain&quot;));&lt;br/&gt;
+        assertEquals(&quot;UTF8&quot;, out.getHeader(Exchange.CONTENT_ENCODING));&lt;br/&gt;
+        assertTrue(out.hasAttachments());&lt;br/&gt;
+        assertEquals(1, out.getAttachmentNames().size());&lt;br/&gt;
+        assertThat(out.getAttachmentNames(), hasItem(attFileName));&lt;br/&gt;
+        Attachment att = out.getAttachmentObject(attFileName);&lt;br/&gt;
+        DataHandler dh = att.getDataHandler();&lt;br/&gt;
+        assertNotNull(dh);&lt;br/&gt;
+        assertEquals(attContentType, dh.getContentType());&lt;br/&gt;
+        InputStream is = dh.getInputStream();&lt;br/&gt;
+        ByteArrayOutputStream os = new ByteArrayOutputStream();&lt;br/&gt;
+        IOHelper.copyAndCloseInput(is, os);&lt;br/&gt;
+        assertEquals(attText, new String(os.toByteArray()));&lt;br/&gt;
+        assertEquals(&quot;Sample Attachment Data&quot;, att.getHeader(&quot;content-description&quot;));&lt;br/&gt;
+        assertEquals(&quot;additional data&quot;, att.getHeader(&quot;X-AdditionalData&quot;));&lt;br/&gt;
+        assertEquals(1, attachmentDs.readCounts); // Fails - input is read twice&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   @onderson Not sure what update you want on this. The code does seem to read the InputStream twice, and that can cause problems when the stream can&apos;t be read multiple times.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16539668" author="githubbot" created="Wed, 11 Jul 2018 07:46:46 +0000"  >&lt;p&gt;onderson commented on a change in pull request #2185: Failing test for &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12078&quot; title=&quot;MIME-Mutipart DataFormat reads attachment DataSource twice&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12078&quot;&gt;&lt;del&gt;CAMEL-12078&lt;/del&gt;&lt;/a&gt;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2185#discussion_r201593292&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2185#discussion_r201593292&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: components/camel-mail/src/test/java/org/apache/camel/dataformat/mime/multipart/MimeMultipartDataFormatTest.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -351,6 +351,41 @@ public void unmarshalInlineHeadersNonMimeBodyStream() throws UnsupportedEncoding&lt;br/&gt;
         assertEquals(&quot;This is not a MIME-Multipart&quot;, bodyStr);&lt;br/&gt;
     }&lt;/p&gt;

&lt;p&gt;+    @Test&lt;br/&gt;
+    public void attachmentReadOnce() throws IOException {&lt;br/&gt;
+        String attContentType = &quot;text/plain&quot;;&lt;br/&gt;
+        String attText = &quot;Attachment Text&quot;;&lt;br/&gt;
+        InputStream attInputStream = new ByteArrayInputStream(attText.getBytes());&lt;br/&gt;
+        String attFileName = &quot;Attachment File Name&quot;;&lt;br/&gt;
+        in.setBody(&quot;Body text&quot;);&lt;br/&gt;
+        in.setHeader(Exchange.CONTENT_TYPE, &quot;text/plain;charset=iso8859-1;other-parameter=true&quot;);&lt;br/&gt;
+        in.setHeader(Exchange.CONTENT_ENCODING, &quot;UTF8&quot;);&lt;br/&gt;
+        Map&amp;lt;String, String&amp;gt; headers = new HashMap&amp;lt;String, String&amp;gt;();&lt;br/&gt;
+        headers.put(&quot;Content-Description&quot;, &quot;Sample Attachment Data&quot;);&lt;br/&gt;
+        headers.put(&quot;X-AdditionalData&quot;, &quot;additional data&quot;);&lt;br/&gt;
+        CountingByteArrayDataSource attachmentDs = new CountingByteArrayDataSource(attInputStream, attContentType);&lt;br/&gt;
+        addAttachment(attachmentDs, attFileName, headers);&lt;br/&gt;
+        Exchange result = template.send(&quot;direct:roundtrip&quot;, exchange);&lt;br/&gt;
+        Message out = result.getOut();&lt;br/&gt;
+        assertEquals(&quot;Body text&quot;, out.getBody(String.class));&lt;br/&gt;
+        assertThat(out.getHeader(Exchange.CONTENT_TYPE, String.class), startsWith(&quot;text/plain&quot;));&lt;br/&gt;
+        assertEquals(&quot;UTF8&quot;, out.getHeader(Exchange.CONTENT_ENCODING));&lt;br/&gt;
+        assertTrue(out.hasAttachments());&lt;br/&gt;
+        assertEquals(1, out.getAttachmentNames().size());&lt;br/&gt;
+        assertThat(out.getAttachmentNames(), hasItem(attFileName));&lt;br/&gt;
+        Attachment att = out.getAttachmentObject(attFileName);&lt;br/&gt;
+        DataHandler dh = att.getDataHandler();&lt;br/&gt;
+        assertNotNull(dh);&lt;br/&gt;
+        assertEquals(attContentType, dh.getContentType());&lt;br/&gt;
+        InputStream is = dh.getInputStream();&lt;br/&gt;
+        ByteArrayOutputStream os = new ByteArrayOutputStream();&lt;br/&gt;
+        IOHelper.copyAndCloseInput(is, os);&lt;br/&gt;
+        assertEquals(attText, new String(os.toByteArray()));&lt;br/&gt;
+        assertEquals(&quot;Sample Attachment Data&quot;, att.getHeader(&quot;content-description&quot;));&lt;br/&gt;
+        assertEquals(&quot;additional data&quot;, att.getHeader(&quot;X-AdditionalData&quot;));&lt;br/&gt;
+        assertEquals(1, attachmentDs.readCounts); // Fails - input is read twice&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   By just looking into your failing test case, it is hard to estimate your use case from my side. And as of an initial look, it seems like an issue/limitation about ByteArrayDataSource and maybe mail component needs another implementation of DataSource so user will be able to read attachments multiple times? Is this the solution you need and which requires such exploration on the component and mail API as well?&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16554671" author="githubbot" created="Tue, 24 Jul 2018 18:57:13 +0000"  >&lt;p&gt;aldettinger commented on a change in pull request #2185: Failing test for &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12078&quot; title=&quot;MIME-Mutipart DataFormat reads attachment DataSource twice&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12078&quot;&gt;&lt;del&gt;CAMEL-12078&lt;/del&gt;&lt;/a&gt;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2185#discussion_r204873667&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2185#discussion_r204873667&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: components/camel-mail/src/test/java/org/apache/camel/dataformat/mime/multipart/MimeMultipartDataFormatTest.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -351,6 +351,41 @@ public void unmarshalInlineHeadersNonMimeBodyStream() throws UnsupportedEncoding&lt;br/&gt;
         assertEquals(&quot;This is not a MIME-Multipart&quot;, bodyStr);&lt;br/&gt;
     }&lt;/p&gt;

&lt;p&gt;+    @Test&lt;br/&gt;
+    public void attachmentReadOnce() throws IOException {&lt;br/&gt;
+        String attContentType = &quot;text/plain&quot;;&lt;br/&gt;
+        String attText = &quot;Attachment Text&quot;;&lt;br/&gt;
+        InputStream attInputStream = new ByteArrayInputStream(attText.getBytes());&lt;br/&gt;
+        String attFileName = &quot;Attachment File Name&quot;;&lt;br/&gt;
+        in.setBody(&quot;Body text&quot;);&lt;br/&gt;
+        in.setHeader(Exchange.CONTENT_TYPE, &quot;text/plain;charset=iso8859-1;other-parameter=true&quot;);&lt;br/&gt;
+        in.setHeader(Exchange.CONTENT_ENCODING, &quot;UTF8&quot;);&lt;br/&gt;
+        Map&amp;lt;String, String&amp;gt; headers = new HashMap&amp;lt;String, String&amp;gt;();&lt;br/&gt;
+        headers.put(&quot;Content-Description&quot;, &quot;Sample Attachment Data&quot;);&lt;br/&gt;
+        headers.put(&quot;X-AdditionalData&quot;, &quot;additional data&quot;);&lt;br/&gt;
+        CountingByteArrayDataSource attachmentDs = new CountingByteArrayDataSource(attInputStream, attContentType);&lt;br/&gt;
+        addAttachment(attachmentDs, attFileName, headers);&lt;br/&gt;
+        Exchange result = template.send(&quot;direct:roundtrip&quot;, exchange);&lt;br/&gt;
+        Message out = result.getOut();&lt;br/&gt;
+        assertEquals(&quot;Body text&quot;, out.getBody(String.class));&lt;br/&gt;
+        assertThat(out.getHeader(Exchange.CONTENT_TYPE, String.class), startsWith(&quot;text/plain&quot;));&lt;br/&gt;
+        assertEquals(&quot;UTF8&quot;, out.getHeader(Exchange.CONTENT_ENCODING));&lt;br/&gt;
+        assertTrue(out.hasAttachments());&lt;br/&gt;
+        assertEquals(1, out.getAttachmentNames().size());&lt;br/&gt;
+        assertThat(out.getAttachmentNames(), hasItem(attFileName));&lt;br/&gt;
+        Attachment att = out.getAttachmentObject(attFileName);&lt;br/&gt;
+        DataHandler dh = att.getDataHandler();&lt;br/&gt;
+        assertNotNull(dh);&lt;br/&gt;
+        assertEquals(attContentType, dh.getContentType());&lt;br/&gt;
+        InputStream is = dh.getInputStream();&lt;br/&gt;
+        ByteArrayOutputStream os = new ByteArrayOutputStream();&lt;br/&gt;
+        IOHelper.copyAndCloseInput(is, os);&lt;br/&gt;
+        assertEquals(attText, new String(os.toByteArray()));&lt;br/&gt;
+        assertEquals(&quot;Sample Attachment Data&quot;, att.getHeader(&quot;content-description&quot;));&lt;br/&gt;
+        assertEquals(&quot;additional data&quot;, att.getHeader(&quot;X-AdditionalData&quot;));&lt;br/&gt;
+        assertEquals(1, attachmentDs.readCounts); // Fails - input is read twice&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   @tdudgeon, IMHO the proposed test does not yet exhibit an issue as a valid DataSource.getInputStream() implementation would return &lt;span class=&quot;error&quot;&gt;&amp;#91;a new stream positioned at the beginning of the data each time it is called&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://docs.oracle.com/javase/8/docs/api/javax/activation/DataSource.html#getInputStream--&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://docs.oracle.com/javase/8/docs/api/javax/activation/DataSource.html#getInputStream--&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;   There I have 2 questions:&lt;br/&gt;
   Could it be that you faced an issue involving a wrong DataSource implementation ?&lt;br/&gt;
   Or, was your issue linked to a DataSource returning an input stream that don&apos;t support mark / reset ?&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16691643" author="githubbot" created="Mon, 19 Nov 2018 12:25:58 +0000"  >&lt;p&gt;onderson commented on issue #2185: Failing test for &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12078&quot; title=&quot;MIME-Mutipart DataFormat reads attachment DataSource twice&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12078&quot;&gt;&lt;del&gt;CAMEL-12078&lt;/del&gt;&lt;/a&gt;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2185#issuecomment-439876214&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2185#issuecomment-439876214&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Since there is no activity on this feature. can we close this? There is already a request through JIRA.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16691644" author="githubbot" created="Mon, 19 Nov 2018 12:27:36 +0000"  >&lt;p&gt;oscerd commented on issue #2185: Failing test for &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12078&quot; title=&quot;MIME-Mutipart DataFormat reads attachment DataSource twice&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12078&quot;&gt;&lt;del&gt;CAMEL-12078&lt;/del&gt;&lt;/a&gt;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2185#issuecomment-439876600&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2185#issuecomment-439876600&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Sure, go ahead @onderson &lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16691647" author="githubbot" created="Mon, 19 Nov 2018 12:31:27 +0000"  >&lt;p&gt;onderson commented on issue #2185: Failing test for &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12078&quot; title=&quot;MIME-Mutipart DataFormat reads attachment DataSource twice&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12078&quot;&gt;&lt;del&gt;CAMEL-12078&lt;/del&gt;&lt;/a&gt;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2185#issuecomment-439877567&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2185#issuecomment-439877567&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Closing. to be followed upon &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12078&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CAMEL-12078&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16691648" author="githubbot" created="Mon, 19 Nov 2018 12:31:28 +0000"  >&lt;p&gt;onderson closed pull request #2185: Failing test for &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12078&quot; title=&quot;MIME-Mutipart DataFormat reads attachment DataSource twice&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12078&quot;&gt;&lt;del&gt;CAMEL-12078&lt;/del&gt;&lt;/a&gt;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2185&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2185&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/components/camel-mail/src/test/java/org/apache/camel/dataformat/mime/multipart/MimeMultipartDataFormatTest.java b/components/camel-mail/src/test/java/org/apache/camel/dataformat/mime/multipart/MimeMultipartDataFormatTest.java&lt;br/&gt;
index ada79c017fc..a96072de28f 100644&lt;br/&gt;
&amp;#8212; a/components/camel-mail/src/test/java/org/apache/camel/dataformat/mime/multipart/MimeMultipartDataFormatTest.java&lt;br/&gt;
+++ b/components/camel-mail/src/test/java/org/apache/camel/dataformat/mime/multipart/MimeMultipartDataFormatTest.java&lt;br/&gt;
@@ -351,6 +351,41 @@ public void unmarshalInlineHeadersNonMimeBodyStream() throws UnsupportedEncoding&lt;br/&gt;
         assertEquals(&quot;This is not a MIME-Multipart&quot;, bodyStr);&lt;br/&gt;
     }&lt;/p&gt;

&lt;p&gt;+    @Test&lt;br/&gt;
+    public void attachmentReadOnce() throws IOException &lt;/p&gt;
{
+        String attContentType = &quot;text/plain&quot;;
+        String attText = &quot;Attachment Text&quot;;
+        InputStream attInputStream = new ByteArrayInputStream(attText.getBytes());
+        String attFileName = &quot;Attachment File Name&quot;;
+        in.setBody(&quot;Body text&quot;);
+        in.setHeader(Exchange.CONTENT_TYPE, &quot;text/plain;charset=iso8859-1;other-parameter=true&quot;);
+        in.setHeader(Exchange.CONTENT_ENCODING, &quot;UTF8&quot;);
+        Map&amp;lt;String, String&amp;gt; headers = new HashMap&amp;lt;String, String&amp;gt;();
+        headers.put(&quot;Content-Description&quot;, &quot;Sample Attachment Data&quot;);
+        headers.put(&quot;X-AdditionalData&quot;, &quot;additional data&quot;);
+        CountingByteArrayDataSource attachmentDs = new CountingByteArrayDataSource(attInputStream, attContentType);
+        addAttachment(attachmentDs, attFileName, headers);
+        Exchange result = template.send(&quot;direct:roundtrip&quot;, exchange);
+        Message out = result.getOut();
+        assertEquals(&quot;Body text&quot;, out.getBody(String.class));
+        assertThat(out.getHeader(Exchange.CONTENT_TYPE, String.class), startsWith(&quot;text/plain&quot;));
+        assertEquals(&quot;UTF8&quot;, out.getHeader(Exchange.CONTENT_ENCODING));
+        assertTrue(out.hasAttachments());
+        assertEquals(1, out.getAttachmentNames().size());
+        assertThat(out.getAttachmentNames(), hasItem(attFileName));
+        Attachment att = out.getAttachmentObject(attFileName);
+        DataHandler dh = att.getDataHandler();
+        assertNotNull(dh);
+        assertEquals(attContentType, dh.getContentType());
+        InputStream is = dh.getInputStream();
+        ByteArrayOutputStream os = new ByteArrayOutputStream();
+        IOHelper.copyAndCloseInput(is, os);
+        assertEquals(attText, new String(os.toByteArray()));
+        assertEquals(&quot;Sample Attachment Data&quot;, att.getHeader(&quot;content-description&quot;));
+        assertEquals(&quot;additional data&quot;, att.getHeader(&quot;X-AdditionalData&quot;));
+        assertEquals(1, attachmentDs.readCounts); // Fails - input is read twice
+    }
&lt;p&gt;+&lt;br/&gt;
     private Attachment unmarshalAndCheckAttachmentName(String matcher) throws IOException, UnsupportedEncodingException &lt;/p&gt;
{
         Exchange intermediate = template.send(&quot;direct:unmarshalonlyinlineheaders&quot;, exchange);
         assertNotNull(intermediate.getOut());
@@ -384,6 +419,34 @@ private void addAttachment(String attContentType, String attText, String attFile
         in.addAttachmentObject(attFileName, attachment);
     }

&lt;p&gt;+    private void addAttachment(DataSource ds, String attFileName, Map&amp;lt;String, String&amp;gt; headers) throws IOException {&lt;br/&gt;
+        DefaultAttachment attachment = new DefaultAttachment(ds);&lt;br/&gt;
+        if (headers != null) {&lt;br/&gt;
+            for (String headerName : headers.keySet()) &lt;/p&gt;
{
+                attachment.addHeader(headerName, headers.get(headerName));
+            }
&lt;p&gt;+        }&lt;br/&gt;
+        in.addAttachmentObject(attFileName, attachment);&lt;br/&gt;
+    }&lt;br/&gt;
+&lt;br/&gt;
+    class CountingByteArrayDataSource extends ByteArrayDataSource {&lt;br/&gt;
+&lt;br/&gt;
+        int readCounts = 0;&lt;br/&gt;
+&lt;br/&gt;
+        CountingByteArrayDataSource(InputStream is, String attContentType) throws IOException &lt;/p&gt;
{
+            super(is, attContentType);
+        }
&lt;p&gt;+&lt;br/&gt;
+        @Override&lt;br/&gt;
+        public InputStream getInputStream() throws IOException &lt;/p&gt;
{
+            //Thread.dumpStack();
+            readCounts++;
+            return super.getInputStream();
+        }
&lt;p&gt;+&lt;br/&gt;
+    }&lt;br/&gt;
+&lt;br/&gt;
+&lt;br/&gt;
     @Override&lt;br/&gt;
     protected RouteBuilder createRouteBuilder() throws Exception {&lt;br/&gt;
         return new RouteBuilder() {&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="17306972" author="davsclaus" created="Tue, 23 Mar 2021 11:04:41 +0000"  >&lt;p&gt;Thanks, Tim for the test case.&lt;/p&gt;

&lt;p&gt;This one was a bit more tricky to get to the bottom, as it is javax-mail that reads the stream to determine encoding for each part that build up the multipart message.&lt;br/&gt;
So we can fix this by setting explicit the Content-Transfer-Encoding header on every part so this does not happen.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 34 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3ntd3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>