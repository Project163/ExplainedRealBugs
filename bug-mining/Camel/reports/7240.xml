<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 11:12:35 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-22364] camel-jms - Rare ConcurrentModificationException on message header map when using multiple camel-jms calls after each other in route</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-22364</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;When calling multiple camel-jms endpoints in sequence in one route, there is a random possibility of ConcurrentModificationException on header map during route execution when using more than 1 thread to run the route (see stacktrace on line 12 in attached log file camel.log) for details.&lt;br/&gt;
I wrote simple program to simulate the issue (&lt;a href=&quot;https://github.com/vdobos-tr/TestJmsConcurrentModification&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/vdobos-tr/TestJmsConcurrentModification&lt;/a&gt;), program contains both client (RageCallMQ.java using jmh, run by jmh.sh) and backend (CamelMain, executed usually from my IDE) part, client uses JMH to tax the camel-jms endpoints and cause the exception. We use IBM MQ as a message broker (added example compose in directory mq-compose, requires path modification to run).&lt;br/&gt;
Probability and time until the exception happens depends heavily on hardware and general setup of the host machine. Our customers can easily replicate the issue in their test environments running 20 consumers and simple route (from(jms, in only).process().to(jms, inout).process(...).to(jms, out only)) whereas we had to run 50-75 threads and up to 6 orchestrations to get one exception within 30 minutes of execution (from(jms, in only).process().&lt;span class=&quot;error&quot;&gt;&amp;#91;to(jms, inout).process(...)&amp;lt;repeat 6 times&amp;gt;&amp;#93;&lt;/span&gt;.to(jms, out only)). As a race condition, unfortunatelly, the timing when the exception occuring is very random, sometimes it can occur within first minute, sometimes it can take 30+ minutes &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.&lt;br/&gt;
Exception occurs regardless if CachingConnectionFactory is used and regardles of asyncConsumer setting. ConcurrentModificationException is caused by parallel acces of two threads to headers map on message (I used custom HeadersMapFactory and custom map implementation with some Proxy classes to trace the issue, see package cz.trask.bi.mq.camel.debugmap in application)&lt;br/&gt;
I was able to trace the issue to change in camel 4.4.0 (&lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-20338&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CAMEL-20338&lt;/a&gt;, see file access_history.txt, lines 78 to 200 and line 202 created by custom Headers Map that shows thread acces causing the issue).&lt;br/&gt;
As far as I understand the problem, it is posible for doSend(...) on line 260 in JmsProducer to not finish (maybe OS schduler parking threads ?) until next thread processing next part of route received response from backend and is already sending next request (or final response) in route (header map iteration on line 368 of JmsBinfding, where the stacktrace originates), during this iteration original doSend(...) on line &#160;on line 260 in JmsProducer resumes and hits lines 260-262, added by &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-20338&quot; title=&quot;Camel JMS producer should add headers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-20338&quot;&gt;&lt;del&gt;CAMEL-20338&lt;/del&gt;&lt;/a&gt;, causing ConcurrentModificationException on next loop iteration in JmsBinding, line 368.&lt;br/&gt;
I tested the issue on camel 4.4.0, 4.8.3 - the version of apache camel we and our customers are currently using, 4.10.6, 4.13.0 and also newly relased 4.14.0 and it occurs on all of them.&lt;br/&gt;
Apache camel releases before canel 4.4.0 (4.3.0, 4.2.0, 4.1.0, 4.0.0) do not manifest the issue.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13626929">CAMEL-22364</key>
            <summary>camel-jms - Rare ConcurrentModificationException on message header map when using multiple camel-jms calls after each other in route</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="vdobos">Vladimir Dobos</reporter>
                        <labels>
                    </labels>
                <created>Thu, 21 Aug 2025 08:26:50 +0000</created>
                <updated>Tue, 26 Aug 2025 08:50:35 +0000</updated>
                            <resolved>Tue, 26 Aug 2025 08:50:35 +0000</resolved>
                                    <version>4.4.5</version>
                    <version>4.5.0</version>
                    <version>4.6.0</version>
                    <version>4.8.8</version>
                    <version>4.9.0</version>
                    <version>4.10.6</version>
                    <version>4.11.0</version>
                    <version>4.12.0</version>
                    <version>4.13.0</version>
                    <version>4.14.0</version>
                                    <fixVersion>4.8.9</fixVersion>
                    <fixVersion>4.10.7</fixVersion>
                    <fixVersion>4.14.1</fixVersion>
                    <fixVersion>4.15.0</fixVersion>
                                    <component>camel-jms</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="18016195" author="davsclaus" created="Tue, 26 Aug 2025 05:46:31 +0000"  >&lt;p&gt;Thanks for reporting and with the analysis and reproducer.&lt;/p&gt;

&lt;p&gt;You are welcome to give this PR a test in your lab&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/camel/pull/18996&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/18996&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                                                <inwardlinks description="is broken by">
                                        <issuelink>
            <issuekey id="13565125">CAMEL-20338</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13078059" name="access_history.txt" size="109797" author="vdobos" created="Thu, 21 Aug 2025 08:26:33 +0000"/>
                            <attachment id="13078058" name="camel.log" size="92202" author="vdobos" created="Thu, 21 Aug 2025 08:26:33 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1xcps:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>