<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 11:10:56 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-22026] Camel SJMS &amp; SJMS2 component cause thread leak when the route is stopped.</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-22026</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;The camel sjms and sjms2 component cause thread to leak and the connection is kept open despite the route is stopped.&#160;&lt;/p&gt;

&lt;p&gt;I am using ActiveMQ broker with apache Qpid library and I can see the below 2 threads will keep running despite calling route stop.&#160;&lt;/p&gt;

&lt;p&gt;The issue comes is caused by &quot;&lt;b&gt;SimpleMessageListenerContainer.java#stopConnection()&quot;&lt;/b&gt; function&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; void stopConnection() {
    &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.connectionLock) {
        &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.connectionStarted = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.connection != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
            &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.connection.stop();
            } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception e) {
                LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Error stopping connection. This exception is ignored.&quot;&lt;/span&gt;, e);
            }
        }
    }
} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;We should call &quot;this.connection.close()&quot;&#160; in doShutdown() function not doing this will only close &lt;b&gt;JMSSession&lt;/b&gt; but keeps the underlying QPID Executor service and connection open to the broker.&lt;/p&gt;

&lt;p&gt;&#160;Below simple code will replicate the issue.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
CamelContext context = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; DefaultCamelContext(); context.addRoutes(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RouteBuilder()
{
    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void configure() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception
    {
        JmsConnectionFactory connectionFactory = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; JmsConnectionFactory(&lt;span class=&quot;code-quote&quot;&gt;&quot;amqp:&lt;span class=&quot;code-comment&quot;&gt;//localhost:5672&quot;&lt;/span&gt;);
&lt;/span&gt;        getCamelContext().getRegistry().bind(&lt;span class=&quot;code-quote&quot;&gt;&quot;qpidConnectionFactory&quot;&lt;/span&gt;, connectionFactory);

        from(&lt;span class=&quot;code-quote&quot;&gt;&quot;sjms:topic:demo?connectionFactory=#qpidConnectionFactory&quot;&lt;/span&gt;)
                .process(exchange -&amp;gt; {
                    &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(exchange.getIn().getBody());
                });
    }
});
context.start();

&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;Started&quot;&lt;/span&gt;);
&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;Stopping route&quot;&lt;/span&gt;);

context.stop();

&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(100000L); 

&lt;span class=&quot;code-comment&quot;&gt;// Take thread dump&lt;/span&gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;When I take thread dump after stopping the camel context I still see below 2 threads running and I see an active connection in ActiveMQ broker also.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-quote&quot;&gt;&quot;QpidJMS Connection Executor: ID:e8acc451-5008-4cb2-a867-d64b9e5350d6:1&quot;&lt;/span&gt; #16 prio=5 os_prio=0 cpu=0.00ms elapsed=11.30s allocated=3856B defined_classes=0 tid=0x000001f1e7cf1000 nid=0x670c waiting on condition&#160; [0x000000cd040fe000]&#160; &#160;java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: WAITING (parking)&#160; &#160; &#160; &#160; at jdk.internal.misc.Unsafe.park(java.base@11.0.15/Native Method)&#160; &#160; &#160; &#160; - parking to wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;&#160; &amp;lt;0x00000006241900f0&amp;gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)&#160; &#160; &#160; &#160; at java.util.concurrent.locks.LockSupport.park(java.base@11.0.15/LockSupport.java:194)&#160; &#160; &#160; &#160; at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(java.base@11.0.15/AbstractQueuedSynchronizer.java:2081)&#160; &#160; &#160; &#160; at java.util.concurrent.LinkedBlockingQueue.take(java.base@11.0.15/LinkedBlockingQueue.java:433)&#160; &#160; &#160; &#160; at java.util.concurrent.ThreadPoolExecutor.getTask(java.base@11.0.15/ThreadPoolExecutor.java:1054)&#160; &#160; &#160; &#160; at java.util.concurrent.ThreadPoolExecutor.runWorker(java.base@11.0.15/ThreadPoolExecutor.java:1114)&#160; &#160; &#160; &#160; at java.util.concurrent.ThreadPoolExecutor$Worker.run(java.base@11.0.15/ThreadPoolExecutor.java:628)&#160; &#160; &#160; &#160; at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(java.base@11.0.15/&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:829)




&lt;span class=&quot;code-quote&quot;&gt;&quot;AmqpProvider :(1):[amqp:&lt;span class=&quot;code-comment&quot;&gt;//localhost:5672]&quot;&lt;/span&gt; #17 daemon prio=5 os_prio=0 cpu=46.88ms elapsed=9.96s allocated=8634K defined_classes=176 tid=0x000001f1e72ac000 nid=0x6298 runnable&#160; [0x000000cd041fe000]&#160; &#160;java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: RUNNABLE&#160; &#160; &#160; &#160; at sun.nio.ch.WindowsSelectorImpl$SubSelector.poll0(java.base@11.0.15/Native Method)&#160; &#160; &#160; &#160; at sun.nio.ch.WindowsSelectorImpl$SubSelector.poll(java.base@11.0.15/WindowsSelectorImpl.java:357)&#160; &#160; &#160; &#160; at sun.nio.ch.WindowsSelectorImpl.doSelect(java.base@11.0.15/WindowsSelectorImpl.java:182)&#160; &#160; &#160; &#160; at sun.nio.ch.SelectorImpl.lockAndDoSelect(java.base@11.0.15/SelectorImpl.java:124)&#160; &#160; &#160; &#160; - locked &amp;lt;0x00000006235200f8&amp;gt; (a io.netty.channel.nio.SelectedSelectionKeySet)&#160; &#160; &#160; &#160; - locked &amp;lt;0x000000062350c728&amp;gt; (a sun.nio.ch.WindowsSelectorImpl)&#160; &#160; &#160; &#160; at sun.nio.ch.SelectorImpl.select(java.base@11.0.15/SelectorImpl.java:136)&#160; &#160; &#160; &#160; at io.netty.channel.nio.SelectedSelectionKeySetSelector.select(SelectedSelectionKeySetSelector.java:62)&#160; &#160; &#160; &#160; at io.netty.channel.nio.NioEventLoop.select(NioEventLoop.java:891)&#160; &#160; &#160; &#160; at io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:526)&#160; &#160; &#160; &#160; at io.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:998)&#160; &#160; &#160; &#160; at io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)&#160; &#160; &#160; &#160; at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(java.base@11.0.15/&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:829) &lt;/span&gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13076296/13076296_image-2025-04-28-16-51-43-419.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;</description>
                <environment>&lt;p&gt;Java 17&lt;/p&gt;

&lt;p&gt;Tried with Camel 3.14.9, Latest 3.x and 4.x issue is seen even in latest build&lt;/p&gt;

&lt;p&gt;ActiveMQ broker 6.x&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</environment>
        <key id="13616568">CAMEL-22026</key>
            <summary>Camel SJMS &amp; SJMS2 component cause thread leak when the route is stopped.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="kartikvk1996">Kartik</reporter>
                        <labels>
                    </labels>
                <created>Mon, 28 Apr 2025 11:22:46 +0000</created>
                <updated>Tue, 29 Apr 2025 10:01:04 +0000</updated>
                            <resolved>Tue, 29 Apr 2025 08:52:38 +0000</resolved>
                                    <version>3.22.3</version>
                    <version>4.11.0</version>
                                    <fixVersion>4.8.7</fixVersion>
                    <fixVersion>4.10.5</fixVersion>
                    <fixVersion>4.12.0</fixVersion>
                                    <component>camel-sjms</component>
                    <component>camel-sjms2</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17947800" author="kartikvk1996" created="Mon, 28 Apr 2025 11:26:17 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davsclaus&quot; class=&quot;user-hover&quot; rel=&quot;davsclaus&quot;&gt;davsclaus&lt;/a&gt; Kindly review and adjust the priority I have made it as major issue&lt;/p&gt;</comment>
                            <comment id="17948052" author="davsclaus" created="Tue, 29 Apr 2025 07:57:44 +0000"  >&lt;p&gt;You are stopping the entire camel and not only a route. So its when camel is shutting down then something needs to be closed in those components. And for container apps that does not matter as the JVM terminates. But for old fashioned app server then the JVM keeps around and you may have something dangling.&lt;/p&gt;</comment>
                            <comment id="17948138" author="kartikvk1996" created="Tue, 29 Apr 2025 09:56:27 +0000"  >&lt;p&gt;This is just a repro snippet I wrote just to boil down the issue, Ideally the app we use has the camel context running through entire JVM lifecycle and we stop and start the routes as and when needed. But when stopped the threads are still running resulting in message being consumed and and routed to DLQ.&lt;/p&gt;

&lt;p&gt;I took latest code and modified by adding &lt;em&gt;&lt;b&gt;connection.close()&lt;/b&gt;&lt;/em&gt; in #stopConnection() function which resolved the issue.&lt;/p&gt;</comment>
                            <comment id="17948139" author="kartikvk1996" created="Tue, 29 Apr 2025 10:01:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davsclaus&quot; class=&quot;user-hover&quot; rel=&quot;davsclaus&quot;&gt;davsclaus&lt;/a&gt; I see you have committed the changes. Thanks.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13076296" name="image-2025-04-28-16-51-43-419.png" size="21827" author="kartikvk1996" created="Mon, 28 Apr 2025 11:21:42 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            28 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1vl4o:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>