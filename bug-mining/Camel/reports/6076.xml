<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:52:48 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-17712] Memory leak in DefaultCamelContext reported by Tomcat 10</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-17712</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;Hello,&lt;br/&gt;
we are using Camel inside a Tomcat application. The application also supports reloading of the context.&lt;br/&gt;
Unfortunately, we are getting a memory leak report, e.g.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[Catalina-utility-1] org.apache.catalina.loader.WebappClassLoaderBase.checkThreadLocalMapForLeaks The web application [ROOT] created a ThreadLocal with key of type [java.lang.ThreadLocal.SuppliedThreadLocal] (value [java.lang.ThreadLocal$SuppliedThreadLocal@588bee00]) and a value of type [org.apache.camel.impl.DefaultCamelContext.OptionHolder] (value [org.apache.camel.impl.DefaultCamelContext$OptionHolder@1d5c4495]) but failed to remove it when the web application was stopped. Threads are going to be renewed over time to &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; and avoid a probable memory leak.&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Looking at the code, the problem is within the java class DefaultCamelContext&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/camel/blob/main/core/camel-core-engine/src/main/java/org/apache/camel/impl/DefaultCamelContext.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/blob/main/core/camel-core-engine/src/main/java/org/apache/camel/impl/DefaultCamelContext.java&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;It contains a class variable which is always instantiated with:&lt;br/&gt;
ThreadLocal&amp;lt;OptionHolder&amp;gt; OPTIONS = ThreadLocal.withInitial(OptionHolder::new);&lt;/p&gt;

&lt;p&gt;This ThreadLocal is never cleaned up by OPTIONS.remove(), This should be added to the shutdown() or stop() handler maybe&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/help_16.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
Some additional null checks would have to be implemented as well to make it safe.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
Thomas&lt;/p&gt;</description>
                <environment>&lt;p&gt;Apache Camel 3.14.1&lt;/p&gt;

&lt;p&gt;Tomcat 10&lt;/p&gt;

&lt;p&gt;Java 17&lt;/p&gt;</environment>
        <key id="13430620">CAMEL-17712</key>
            <summary>Memory leak in DefaultCamelContext reported by Tomcat 10</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="tom_s4t">Thomas Hoffmann</reporter>
                        <labels>
                    </labels>
                <created>Fri, 25 Feb 2022 07:50:15 +0000</created>
                <updated>Thu, 4 Apr 2024 13:04:39 +0000</updated>
                            <resolved>Thu, 31 Mar 2022 10:43:34 +0000</resolved>
                                    <version>3.14.1</version>
                                    <fixVersion>3.17.0</fixVersion>
                                    <component>came-core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17514929" author="tom_s4t" created="Wed, 30 Mar 2022 20:27:14 +0000"  >&lt;p&gt;Hello,&lt;/p&gt;

&lt;p&gt;I tried the new version 3.14.2 but the memory leak is not fully fixed unfortunately.&lt;/p&gt;

&lt;p&gt;Therefore I digged deeper into the problem and figured out the problem which lies a bit deeper than I tought.&lt;/p&gt;

&lt;p&gt;The problem is when using ThreadLocal variables within CAMEL in multithreaded environments like application servers. The last fix only works in single threaded environments unfortunately.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Background:&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;Each thread in Java has a member variable or map &quot;threadlocals&quot; which stores the values which are managed by the Helper-Class &quot;ThreadLocal&quot;, see:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/AdoptOpenJDK/openjdk-jdk11/blob/master/src/java.base/share/classes/java/lang/Thread.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/AdoptOpenJDK/openjdk-jdk11/blob/master/src/java.base/share/classes/java/lang/Thread.java&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The Java-Class ThreadLocal therefore doesn&apos;t store any variable by itself but attaches every value to the current thread (within their threadlocals map).&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Reason for the memory leak:&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;I explain the problem with the example of DefaultCamelContext:&lt;/p&gt;

&lt;p&gt;The ThreadLocal variable was introduced there in version 3.9:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/camel/blob/camel-3.9.x/core/camel-core-engine/src/main/java/org/apache/camel/impl/DefaultCamelContext.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/blob/camel-3.9.x/core/camel-core-engine/src/main/java/org/apache/camel/impl/DefaultCamelContext.java&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;When a multithreaded application server (e.g. Tomcat or glassfish) starts a CamelContext, the DefaultCamelContext.java stores via the ThreadLocal-class and member variable OPTIONS the values (OptionHolder) into the current worker thread. This worker thread might be e.g. the thread worker-1. Some http calls to the webserver might be processed with the thread worker-2. This thread gets it&apos;s own option values when working with the started CamelContext. This new options are again attached to the current thread, in this case attached to worker-2.&lt;br/&gt;
If the application is undeployed, this might be processed by worker-3 but worker-3 can&apos;t clean up the options of the DefaultCamelContext which are stored in other worker-threads. Therefore the worker-1 and worker-2 thread still hold references to the CAMEL objects and thus they won&apos;t get garbage collected.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Further occurences:&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;The same problem occurs in class DefaultReactiveExecutor.java.&lt;/p&gt;

&lt;p&gt;When using ThreadLocal-classes, the worker-threads of the application server get &quot;polluted&quot; with Camel-classes and the instances stay in memory, even when the application is undeployed because the worker-thread of the applicatoin server are re-used for subsequent http requests across the hosted applications. Thus the worker threads hold references to Camel classes and can&apos;t be garbage collected.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Possible solutions:&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;I am not sure, why there is a need to use ThreadLocal class in the mentioned Camel classes because I see no reason that every (worker) thread should have their own set of camel options, camel workers etc. Maybe the ThreadLocal classes where just used to prevent multi-threaded issues?&lt;/p&gt;

&lt;p&gt;I currently see two options to solve the problem:&lt;/p&gt;

&lt;p&gt;1) Make sure the ThreadLocal values are cleaned up before the method exits (via remove() method). Even a get() will have the effect, that a default value gets attached to the current thread!&lt;/p&gt;

&lt;p&gt;2) Replace the ThreadLocal variable with something else, if a per-thread variable is not needed.&lt;/p&gt;

&lt;p&gt;I hope I could explain the complex problem well enough. If further information is needed, just drop a line.&#160;&lt;/p&gt;

&lt;p&gt;Thank you in advance! Thomas&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17515072" author="davsclaus" created="Thu, 31 Mar 2022 04:43:53 +0000"  >&lt;p&gt;Thanks for the deep analysis, but we cannot do #1 and will not replace it #2.&lt;/p&gt;

&lt;p&gt;Its not a leak as the variables are stored as weak references so the JVM can unload the classes fine, its only tomcat as the app server that does this logging, and it happens for other java  framework and libraries - not only Camel.&lt;/p&gt;</comment>
                            <comment id="17515137" author="tom_s4t" created="Thu, 31 Mar 2022 07:42:50 +0000"  >&lt;p&gt;Hello Claus,&lt;/p&gt;

&lt;p&gt;sorry for reopening again.&lt;/p&gt;

&lt;p&gt;We are currently using around 50 libraries and Camel is currently the only one which is reported for a memory leak. I can&apos;t confirm &quot;it happens for other java libraries&quot;. Maybe there are others which we don&apos;t use and have this problem but it&apos;s not an argument for not fixing it in my point of view.&#160;&lt;/p&gt;

&lt;p&gt;The weak reference you mentioned referes to the reference betweek the variable/value and the thread. But the threads are from the webservers application pool and they remain after undeployment. Thus the weak reference doesn&apos;t help out in this case as the threads are still alive.&lt;/p&gt;

&lt;p&gt;Please also take a look at the discussion there:&lt;br/&gt;
&lt;a href=&quot;https://stackoverflow.com/questions/17968803/threadlocal-memory-leak&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://stackoverflow.com/questions/17968803/threadlocal-memory-leak&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;For the DefaultCamelContext, a public method to remove the ThreadLocal would already be enough.&lt;/p&gt;

&lt;p&gt;For DefaultReactiveExecutor I am not sure how it&apos;s used. A public method in the interface ReactiveExecutor to cleanup the reference will help as well.&lt;/p&gt;

&lt;p&gt;If your conclusion is, that you won&apos;t fix it it&apos;s ok. But I wanted to reply that it is indeed a leak because the weak reference is hold by the webservers worker thread which stays alive.&lt;/p&gt;

&lt;p&gt;I could also provide a pull request for the cleanup methods, if it helps.&lt;/p&gt;

&lt;p&gt;Thank you very much! Thomas&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17515231" author="davsclaus" created="Thu, 31 Mar 2022 10:43:34 +0000"  >&lt;p&gt;There is a camel-reactive-executor-tomcat in Camel 3.17 you can use that tracks and clear on unload.&lt;/p&gt;

&lt;p&gt;And the options on camel context is now only using JDK classes and also cleared on shutdown&lt;/p&gt;</comment>
                            <comment id="17515349" author="davsclaus" created="Thu, 31 Mar 2022 13:56:59 +0000"  >&lt;p&gt;Created a ticket to potential remove the need for OPTIONS as it&apos;s there for legacy reasons mostly.&lt;/p&gt;</comment>
                            <comment id="17515361" author="tom_s4t" created="Thu, 31 Mar 2022 14:19:10 +0000"  >&lt;p&gt;Thank you very much! &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;I am waiting for the 3.17 release.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13433449">CAMEL-17785</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13436912">CAMEL-17891</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13426229">CAMEL-17588</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10062"><![CDATA[Moderate]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 32 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0zxw8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>