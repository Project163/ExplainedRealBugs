<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 11:09:12 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-21495] camel-quarkus: REST route inlining works incorrectly when testing</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-21495</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;h2&gt;&lt;a name=&quot;TheIssue%3ARESTrouteinliningworksincorrectly%2Finconsistentlywhentesting&quot;&gt;&lt;/a&gt;The Issue: REST-route inlining works incorrectly/inconsistently when testing&lt;/h2&gt;

&lt;p&gt;Encountered when running tests, sometimes the wrong subroute gets inlined to the rest-route and causes failures.&lt;/p&gt;

&lt;p&gt;Referring to: &lt;a href=&quot;https://camel.apache.org/manual/rest-dsl.html#_inline_rest_dsl_as_a_single_route&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://camel.apache.org/manual/rest-dsl.html#_inline_rest_dsl_as_a_single_route&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;I&apos;ve attached an example project. When running the tests, a test called &quot;FailingTest&quot; should have &quot;camel.rest.inline-routes&quot; enabled and should fail, as opposed to &quot;SucceedingTest&quot; which has the option disabled and does not fail.&lt;/p&gt;

&lt;p&gt;It seems like when inlining the routes, the subroute &quot;get-from-db-route&quot; gets inlined when actually route &quot;quarkuscamelexampleservice-http-get-route&quot; should be inlined as it is the subroute that is called from the REST-route.&lt;/p&gt;

&lt;p&gt;For some reason, the tests failing also seems a bit flaky, so you might have to run all the tests in a loop to replicate the issue, i&apos;ve included a script &quot;run-test-in-loop.sh&quot;.&lt;/p&gt;

&lt;p&gt;When the test fails, it only shows routes:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2024-12-02 10:45:20,687 INFO  [org.apa.cam.qua.cor.CamelBootstrapRecorder] (main) Apache Camel Quarkus 3.16.0 is starting
2024-12-02 10:45:20,687 INFO  [org.apa.cam.mai.MainSupport] (main) Apache Camel (Main) 4.8.1 is starting
2024-12-02 10:45:20,716 INFO  [org.apa.cam.mai.BaseMainSupport] (main) Auto-configuration summary
2024-12-02 10:45:20,716 INFO  [org.apa.cam.mai.BaseMainSupport] (main)     [MicroProfilePropertiesSource] camel.main.dumpRoutes = xml
2024-12-02 10:45:20,716 INFO  [org.apa.cam.mai.BaseMainSupport] (main)     [JVM &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt; Property]          camel.&lt;span class=&quot;code-keyword&quot;&gt;rest&lt;/span&gt;.inlineRoutes = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
2024-12-02 10:45:20,882 INFO  [org.apa.cam.imp.eng.AbstractCamelContext] (main) Apache Camel 4.8.1 (camel-1) is starting
2024-12-02 10:45:20,894 INFO  [org.apa.cam.imp.DefaultDumpRoutesStrategy] (main) Dumping 5 routes as XML
2024-12-02 10:45:20,895 INFO  [org.apa.cam.imp.DefaultDumpRoutesStrategy] (main)


    &amp;lt;route id=&lt;span class=&quot;code-quote&quot;&gt;&quot;get-from-db-route&quot;&lt;/span&gt; streamCache=&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt;&amp;gt;
        &amp;lt;from uri=&lt;span class=&quot;code-quote&quot;&gt;&quot;direct:get-from-db&quot;&lt;/span&gt;/&amp;gt;
        &amp;lt;onException&amp;gt;
            &amp;lt;exception&amp;gt;java.lang.Exception&amp;lt;/exception&amp;gt;
            &amp;lt;redeliveryPolicy logHandled=&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt;/&amp;gt;
            &amp;lt;setBody&amp;gt;
                &amp;lt;simple&amp;gt;Error with database backend: ${exception.message}&amp;lt;/simple&amp;gt;
            &amp;lt;/setBody&amp;gt;
            &amp;lt;removeHeaders pattern=&lt;span class=&quot;code-quote&quot;&gt;&quot;*&quot;&lt;/span&gt;/&amp;gt;
            &amp;lt;stop/&amp;gt;
        &amp;lt;/onException&amp;gt;
        &amp;lt;process/&amp;gt;
    &amp;lt;/route&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Sometimes it works correctly, and shows how it actually should have inlined the routes with the route &quot;subroute-for-get&quot; not being inlined to the REST-route,but instead existing as a separate route in the context:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2024-12-02 10:40:11,095 INFO  [org.apa.cam.qua.cor.CamelBootstrapRecorder] (main) Apache Camel Quarkus 3.16.0 is starting
2024-12-02 10:40:11,096 INFO  [org.apa.cam.mai.MainSupport] (main) Apache Camel (Main) 4.8.1 is starting
2024-12-02 10:40:11,198 INFO  [org.apa.cam.mai.BaseMainSupport] (main) Auto-configuration summary
2024-12-02 10:40:11,198 INFO  [org.apa.cam.mai.BaseMainSupport] (main)     [MicroProfilePropertiesSource] camel.main.dumpRoutes = xml
2024-12-02 10:40:11,199 INFO  [org.apa.cam.mai.BaseMainSupport] (main)     [JVM &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt; Property]          camel.&lt;span class=&quot;code-keyword&quot;&gt;rest&lt;/span&gt;.inlineRoutes = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
2024-12-02 10:40:11,857 INFO  [org.apa.cam.imp.eng.AbstractCamelContext] (main) Apache Camel 4.8.1 (camel-1) is starting
2024-12-02 10:40:11,923 INFO  [org.apa.cam.imp.DefaultDumpRoutesStrategy] (main) Dumping 6 routes as XML
2024-12-02 10:40:11,924 INFO  [org.apa.cam.imp.DefaultDumpRoutesStrategy] (main) 


    &amp;lt;route id=&lt;span class=&quot;code-quote&quot;&gt;&quot;get-from-db-route&quot;&lt;/span&gt; streamCache=&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt;&amp;gt;
        &amp;lt;from uri=&lt;span class=&quot;code-quote&quot;&gt;&quot;direct:get-from-db&quot;&lt;/span&gt;/&amp;gt;
        &amp;lt;onException&amp;gt;
            &amp;lt;exception&amp;gt;java.lang.Exception&amp;lt;/exception&amp;gt;
            &amp;lt;redeliveryPolicy logHandled=&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt;/&amp;gt;
            &amp;lt;setBody&amp;gt;
                &amp;lt;simple&amp;gt;Error with database backend: ${exception.message}&amp;lt;/simple&amp;gt;
            &amp;lt;/setBody&amp;gt;
            &amp;lt;removeHeaders pattern=&lt;span class=&quot;code-quote&quot;&gt;&quot;*&quot;&lt;/span&gt;/&amp;gt;
            &amp;lt;stop/&amp;gt;
        &amp;lt;/onException&amp;gt;
        &amp;lt;process/&amp;gt;
    &amp;lt;/route&amp;gt;

    &amp;lt;route id=&lt;span class=&quot;code-quote&quot;&gt;&quot;subroute-&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;-get&quot;&lt;/span&gt;&amp;gt;
        &amp;lt;from uri=&lt;span class=&quot;code-quote&quot;&gt;&quot;direct:subroute-&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;-get&quot;&lt;/span&gt;/&amp;gt;
        &amp;lt;onException&amp;gt;
            &amp;lt;exception&amp;gt;java.lang.Exception&amp;lt;/exception&amp;gt;
            &amp;lt;redeliveryPolicy logHandled=&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt;/&amp;gt;
            &amp;lt;setBody&amp;gt;
                &amp;lt;simple&amp;gt;Error with http backend: ${exception.message}&amp;lt;/simple&amp;gt;
            &amp;lt;/setBody&amp;gt;
            &amp;lt;removeHeaders pattern=&lt;span class=&quot;code-quote&quot;&gt;&quot;*&quot;&lt;/span&gt;/&amp;gt;
            &amp;lt;stop/&amp;gt;
        &amp;lt;/onException&amp;gt;
        &amp;lt;process/&amp;gt;
    &amp;lt;/route&amp;gt;

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I have not had any issues when running in quarkus dev-mode, so i am assuming this only affects testing.&lt;/p&gt;
&lt;h2&gt;&lt;a name=&quot;Workaround&quot;&gt;&lt;/a&gt;Workaround&lt;/h2&gt;

&lt;p&gt;For tests, disabled inlining the routes with:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
camel.&lt;span class=&quot;code-keyword&quot;&gt;rest&lt;/span&gt;.inline-routes = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13600554">CAMEL-21495</key>
            <summary>camel-quarkus: REST route inlining works incorrectly when testing</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="samipeltola">Sami Peltola</reporter>
                        <labels>
                    </labels>
                <created>Mon, 2 Dec 2024 08:59:59 +0000</created>
                <updated>Thu, 26 Dec 2024 15:10:36 +0000</updated>
                            <resolved>Thu, 26 Dec 2024 15:09:54 +0000</resolved>
                                    <version>4.8.1</version>
                                    <fixVersion>4.8.3</fixVersion>
                    <fixVersion>4.10.0</fixVersion>
                                    <component>camel-core</component>
                    <component>camel-rest-openapi</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17902622" author="davsclaus" created="Tue, 3 Dec 2024 12:36:31 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jamesnetherton&quot; class=&quot;user-hover&quot; rel=&quot;jamesnetherton&quot;&gt;jamesnetherton&lt;/a&gt;&#160; something to look into for CEQ&lt;/p&gt;</comment>
                            <comment id="17902623" author="davsclaus" created="Tue, 3 Dec 2024 12:37:49 +0000"  >&lt;p&gt;Sami, can you try to build an vanilla project to help identify if its only when using Quarkus or not.&lt;/p&gt;</comment>
                            <comment id="17902993" author="jamesnetherton" created="Wed, 4 Dec 2024 13:11:39 +0000"  >&lt;p&gt;I converted the reproducer app to use camel-main, did 100 tests runs and it passed.&lt;/p&gt;

&lt;p&gt;Something strange is happening on CQ. The test passes sometimes but fails on other runs.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=samipeltola&quot; class=&quot;user-hover&quot; rel=&quot;samipeltola&quot;&gt;samipeltola&lt;/a&gt; is this only an issue when running tests? Or do you observe it when running from quarkus-run.jar? I only see the issue happen at test time.&lt;/p&gt;</comment>
                            <comment id="17903207" author="samipeltola" created="Thu, 5 Dec 2024 07:18:44 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jamesnetherton&quot; class=&quot;user-hover&quot; rel=&quot;jamesnetherton&quot;&gt;jamesnetherton&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;I&apos;ve also only encountered this while testing. I haven&apos;t yet run the service in production or or any lower env, it&apos;s still a PoC, but while running in dev-mode, there haven&apos;t been any issues.&lt;/p&gt;

&lt;p&gt;FYI, it seemed like when I had an actual http endpoint request in the route and Wiremock mocking it in the tests, the exception seemed to happen more often.&lt;/p&gt;</comment>
                            <comment id="17903242" author="jamesnetherton" created="Thu, 5 Dec 2024 08:22:24 +0000"  >&lt;p&gt;I created an issue in the camel-quarkus project to track a fix:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/camel-quarkus/issues/6842&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel-quarkus/issues/6842&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;From what I can tell, this issue first shows up in Quarkus 3.13.0 / Camel Quarkus 3.13.0 / Camel 4.7.0. &lt;/p&gt;</comment>
                            <comment id="17903253" author="davsclaus" created="Thu, 5 Dec 2024 08:41:14 +0000"  >&lt;p&gt;okay tracking this in CEQ closing this&lt;/p&gt;</comment>
                            <comment id="17903373" author="jamesnetherton" created="Thu, 5 Dec 2024 13:19:29 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davsclaus&quot; class=&quot;user-hover&quot; rel=&quot;davsclaus&quot;&gt;davsclaus&lt;/a&gt; I think we should reopen this as it&apos;s maybe a general Camel issue.&lt;/p&gt;

&lt;p&gt;I&apos;ve not found exactly what&apos;s going on, but I think it&apos;s related to the order that the routes are loaded.&lt;/p&gt;

&lt;p&gt;This order of route loading works:&lt;/p&gt;

&lt;p&gt;ExternalHttpServiceRoute&lt;br/&gt;
QuarkusExampleAPI&lt;br/&gt;
DatabaseRoute&lt;/p&gt;

&lt;p&gt;This order does not:&lt;/p&gt;

&lt;p&gt;QuarkusExampleAPI&lt;br/&gt;
DatabaseRoute&lt;br/&gt;
ExternalHttpServiceRoute&#160;&lt;/p&gt;

&lt;p&gt;On CQ, the ordering turns out to be random due to how RouteBuilder impls are discovered at build time.&lt;/p&gt;

&lt;p&gt;With camel-main, the ordering is based on the ordering of Set&amp;lt;Class&amp;lt;?&amp;gt;&amp;gt;:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/camel/blob/4e8549a480287554dec9f7a9b99963078e2fb4bc/core/camel-main/src/main/java/org/apache/camel/main/RoutesConfigurer.java#L197-L198&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/blob/4e8549a480287554dec9f7a9b99963078e2fb4bc/core/camel-main/src/main/java/org/apache/camel/main/RoutesConfigurer.java#L197-L198&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;If in the reproducer app I rename the classes so that the class order is different, then I can reproduce the problem with camel-main.&lt;/p&gt;

&lt;p&gt;I attached a new camel-main version of the reproducer app.&lt;/p&gt;</comment>
                            <comment id="17908300" author="davsclaus" created="Thu, 26 Dec 2024 12:47:34 +0000"  >&lt;p&gt;Thanks James for the reproducer.&lt;/p&gt;</comment>
                            <comment id="17908301" author="davsclaus" created="Thu, 26 Dec 2024 13:05:01 +0000"  >&lt;p&gt;Okay so the problem is that when having multiple route builder classes, then the routes gets inlined multiple times. So we should avoid this duplicate inline and then it works.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13602449">CAMEL-21556</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13073303" name="quarkus-camel-rest-inline-issue-main.zip" size="96967" author="jamesnetherton" created="Thu, 5 Dec 2024 13:18:36 +0000"/>
                            <attachment id="13073139" name="quarkus-camel-rest-inline-issue.zip" size="91888" author="samipeltola" created="Mon, 2 Dec 2024 08:50:02 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            45 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1suzs:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>