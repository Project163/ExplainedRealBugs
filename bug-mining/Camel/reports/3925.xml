<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:20:49 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-10653] XQuery support broken in Camel 2.18.x</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-10653</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;The camel xquery support no longer works correctly as of 2.18.x&lt;/p&gt;

&lt;p&gt;I identified two main issues so far:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;A java.lang.NullPointerException is thrown when exchange contains any null headers or properties:
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;java.lang.NullPointerException: External object cannot wrap a Java &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
	at net.sf.saxon.value.ObjectValue.&amp;lt;init&amp;gt;(ObjectValue.java:55)
	at org.apache.camel.component.xquery.XQueryBuilder.addParameters(XQueryBuilder.java:640)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
	&lt;li&gt;An error in execution whenever a header or a property are referenced in the xquery as an external variable:
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;java.lang.AssertionError: Unknown event
	at net.sf.saxon.evpull.ComplexContentProcessor.advance(ComplexContentProcessor.java:198)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Attached is a maven project with junit test illustrating the issues.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13030419">CAMEL-10653</key>
            <summary>XQuery support broken in Camel 2.18.x</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="nvoskresenskiy">Nikolay Voskresenskiy</reporter>
                        <labels>
                    </labels>
                <created>Fri, 23 Dec 2016 17:37:36 +0000</created>
                <updated>Fri, 23 Dec 2016 19:07:12 +0000</updated>
                            <resolved>Fri, 23 Dec 2016 18:22:17 +0000</resolved>
                                    <version>2.18.0</version>
                    <version>2.18.1</version>
                                    <fixVersion>2.18.2</fixVersion>
                    <fixVersion>2.19.0</fixVersion>
                                    <component>camel-saxon</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="15773394" author="davsclaus" created="Fri, 23 Dec 2016 18:06:02 +0000"  >&lt;p&gt;Thanks its only a problem when you have null values in your headers, which is bad to have anyway.&lt;/p&gt;</comment>
                            <comment id="15773401" author="nvoskresenskiy" created="Fri, 23 Dec 2016 18:10:26 +0000"  >&lt;p&gt;Null values in headers is a very common scenario e.g. in case of an exchange originating from a JMS endpoint, a lot of JMS and JMSX headers will be null by default.&lt;/p&gt;

&lt;p&gt;The second part of the issue is also much more serious - basically any xquery that uses headers or properties no longer works.&lt;/p&gt;</comment>
                            <comment id="15773412" author="davsclaus" created="Fri, 23 Dec 2016 18:16:43 +0000"  >&lt;p&gt;It would be good if you can search saxon or whatever about that external header thingy, as its their library and how its supposed to work with those.&lt;/p&gt;

&lt;p&gt;And log a 2nd ticket about that. As we will closed this when the null header is fixed.&lt;/p&gt;</comment>
                            <comment id="15773425" author="davsclaus" created="Fri, 23 Dec 2016 18:22:08 +0000"  >&lt;p&gt;It seems that external is @deprecated according to their own docs&lt;br/&gt;
&lt;a href=&quot;http://www.saxonica.com/html/documentation/using-xquery/extensions.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.saxonica.com/html/documentation/using-xquery/extensions.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Something about using xquery 3.0 syntax instead. So it could be that in saxon 9.7 they have removed support for that old style. Camel 2.18 is using Saxon 9.7.&lt;/p&gt;</comment>
                            <comment id="15773435" author="nvoskresenskiy" created="Fri, 23 Dec 2016 18:30:30 +0000"  >&lt;p&gt;The external variables thing is not a feature of saxon library, it is a common feature of XQuery 1.0 specification, and also documented at &lt;a href=&quot;http://camel.apache.org/xquery.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://camel.apache.org/xquery.html&lt;/a&gt;. The same test passes in camel 2.17.4&lt;/p&gt;

&lt;p&gt;I believe the issue was caused by upgrade to saxon 9.7.&lt;/p&gt;

&lt;p&gt;In Camel 2.17 the following code is responsible for this functionality in XQueryBuilder class:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; void addParameters(DynamicQueryContext dynamicQueryContext, Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;&amp;gt; map, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; parameterPrefix) {
        Set&amp;lt;Map.Entry&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;&amp;gt;&amp;gt; propertyEntries = map.entrySet();
        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (Map.Entry&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;&amp;gt; entry : propertyEntries) {
            dynamicQueryContext.setParameter(parameterPrefix + entry.getKey(), entry.getValue());
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In camel 2.18 it is now:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; void addParameters(DynamicQueryContext dynamicQueryContext, Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;&amp;gt; map, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; parameterPrefix) {
        Set&amp;lt;Map.Entry&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;&amp;gt;&amp;gt; propertyEntries = map.entrySet();
        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (Map.Entry&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;&amp;gt; entry : propertyEntries) {
            dynamicQueryContext.setParameter(
                StructuredQName.fromClarkName(parameterPrefix + entry.getKey()),
                &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ObjectValue(entry.getValue())
            );
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Which apparently doesn&apos;t work, it seems the value container needs to be one of the subtypes for net.sf.saxon.value.AtomicValue. And no, external variable declaration is not a deprecated feature, it is part of core xquery specification and supported by all popular processors including saxon.&lt;/p&gt;

&lt;p&gt;Anyway, this is a regression compared to camel 2.17, and either needs to be fixed, or the documentation on camel-xquery needs to be updated accordingly&lt;/p&gt;</comment>
                            <comment id="15773469" author="nvoskresenskiy" created="Fri, 23 Dec 2016 18:51:13 +0000"  >&lt;p&gt;Looks like explicitly specifying the type of the external variable now seems to make it work:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;declare variable $in.headers.testHeader as xs:string external;

&amp;lt;header&amp;gt;{$in.headers.testHeader}&amp;lt;/header&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I would suggest clarifying how to use the Variables as parameters in the xquery component documentation&lt;/p&gt;</comment>
                            <comment id="15773492" author="davsclaus" created="Fri, 23 Dec 2016 19:06:52 +0000"  >&lt;p&gt;You are welcome to submit github PRs for documentation updates&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/camel/blob/master/components/camel-saxon/src/main/docs/xquery-component.adoc&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/blob/master/components/camel-saxon/src/main/docs/xquery-component.adoc&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15773493" author="davsclaus" created="Fri, 23 Dec 2016 19:07:12 +0000"  >&lt;p&gt;Here is some pointers how to contribute&lt;br/&gt;
&lt;a href=&quot;http://camel.apache.org/contributing&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://camel.apache.org/contributing&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12835185">CAMEL-8830</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12844596" name="camel-xquery-test.zip" size="2967" author="nvoskresenskiy" created="Fri, 23 Dec 2016 17:37:50 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 47 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i37znr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>