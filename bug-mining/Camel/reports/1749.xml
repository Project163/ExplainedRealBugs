<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 09:49:57 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-4925] ThreadsProcessor configured with ExecutorService with DiscardPolicy or DiscardOldestPolicy leaves inflight exchanges for discarded tasks unprocessed.</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-4925</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;ThreadsProcessor configured with ExecutorService with DiscardPolicy or DiscardOldestPolicy leaves inflight exchanges for discarded tasks unprocessed.&lt;/p&gt;

&lt;p&gt;Here is the code from ThreadsProcessor. In case of DiscardPolicy or DiscardOldestPolicy executorService will no throw RejectedExecutionException, so exchange remains unprocessed and count of inflight exchanges will not be decremented for such discarded exchanges.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;ThreadsProcessor#process(Exchange, AsyncCallback)&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; process(Exchange exchange, AsyncCallback callback) {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (shutdown.get()) {
        &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IllegalStateException(&lt;span class=&quot;code-quote&quot;&gt;&quot;ThreadsProcessor is not running.&quot;&lt;/span&gt;);
    }

    ProcessCall call = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ProcessCall(exchange, callback);
    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
        executorService.submit(call);
        &lt;span class=&quot;code-comment&quot;&gt;// tell Camel routing engine we &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt; routing asynchronous
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (RejectedExecutionException e) {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (isCallerRunsWhenRejected()) {
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (shutdown.get()) {
                exchange.setException(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RejectedExecutionException());
            } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
                callback.done(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
            }
        } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
            exchange.setException(e);
        }
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Unit test is attached.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12539115">CAMEL-4925</key>
            <summary>ThreadsProcessor configured with ExecutorService with DiscardPolicy or DiscardOldestPolicy leaves inflight exchanges for discarded tasks unprocessed.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="szhemzhitsky">Sergey Zhemzhitsky</reporter>
                        <labels>
                    </labels>
                <created>Fri, 20 Jan 2012 10:02:31 +0000</created>
                <updated>Mon, 23 Jan 2012 17:00:43 +0000</updated>
                            <resolved>Mon, 23 Jan 2012 12:44:11 +0000</resolved>
                                    <version>2.8.0</version>
                                    <fixVersion>2.10.0</fixVersion>
                                    <component>camel-core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="13189737" author="davsclaus" created="Fri, 20 Jan 2012 11:15:38 +0000"  >&lt;p&gt;We would need to wrap those 2 policies, and then remove the exchange from them inflight registry, when the rejectedExecutor callback is invoked.&lt;/p&gt;</comment>
                            <comment id="13189748" author="szhemzhitsky" created="Fri, 20 Jan 2012 11:44:56 +0000"  >&lt;p&gt;So if we wrap these two policies, how to know which exchange must be removed from the inflight repository?&lt;/p&gt;</comment>
                            <comment id="13189758" author="davsclaus" created="Fri, 20 Jan 2012 12:25:10 +0000"  >&lt;p&gt;Yeah we would need to check in ThreadsDefinition if you have configured Discard and DiscardOldest. And then wrap those policies with a custom policy, so we get the callback from the JDK when the task is rejected.&lt;/p&gt;

&lt;p&gt;The discard, would possible not be needed, as I would assume the thread pool will reject it asap, when you try to submit it. But the discard oldest, is an existing task from the task queue, so that is a different story.&lt;/p&gt;

&lt;p&gt;Then we need to provide this as a callback to the ThreadsProcessor, so it can do custom logic when the RejectedExecutionHandler#rejectedExecution is invoked. We can then from the Runnable parameter cast that to ProcessCall, and then get access to the Exchange. Then we can set on the Exchange a RejectedExecutionException as exception, and invoke its callback. Then Camel will take it from there to remove the exchange from inflight registry and whatnot.&lt;/p&gt;

&lt;p&gt;Something along the lines of that. Its a shame the API of the ExecutorService do not have a 2nd optional runnable parameter for rejected execution. Then it would have been easier. As you just submit 2 runnable&apos;s. And the JDK will invoke the appropriate.&lt;/p&gt;</comment>
                            <comment id="13190435" author="davsclaus" created="Sat, 21 Jan 2012 14:56:02 +0000"  >&lt;p&gt;After looking into this for a bit, then the JDK does &lt;b&gt;not&lt;/b&gt; offer good APIs for being able to do custom logic when rejected, by which you get access to the inner details of the runnable task you submitted to the thread pool. That means for DiscardOldest, you do &lt;b&gt;not&lt;/b&gt; know which Exchange is to be discarded, as you cannot get access to the Exchange. The JDK ThreadPoolExecutor will wrap the runnable/FutureTask using an adapter, which does not expose API for you to get access to the Exchange.&lt;/p&gt;

&lt;p&gt;Even if you create a custom FutureTask and submit that, then it&apos;s the adapter you get when the task is rejected. And the adapter does not allow to get you to your custom FutureTask.&lt;/p&gt;

&lt;p&gt;So the best we can do is to deny supporting DiscardOldest, and then we can handle Abort and Discard in the ThreadsProcessor, where we can mark the exchange to stop routing, so the exchange will be done, which means that it will be unregistered from the inflight registry and whatnot.&lt;/p&gt;</comment>
                            <comment id="13190471" author="szhemzhitsky" created="Sat, 21 Jan 2012 17:14:39 +0000"  >&lt;p&gt;Hi Claus,&lt;br/&gt;
I noticed the same things you mentioned and attached a sample patch that can possibly be used to support correct rejection of submitted tasks. The idea is to provide our own &lt;em&gt;ThreadPoolExecutor&lt;/em&gt; and &lt;em&gt;ScheduledThreadPoolExecutor&lt;/em&gt; from &lt;em&gt;DefaultThreadPoolFactory&lt;/em&gt;. These pools wrap submitted tasks with custom &lt;em&gt;FutureTask&lt;/em&gt; that supports rejection. &lt;em&gt;RejectedExecutionHandlers&lt;/em&gt; in the &lt;em&gt;ThreadPoolRejectedPolicy&lt;/em&gt; are also changed to check whether the discarded tasks can be rejected (I also added blocking policy into the &lt;em&gt;ThreadPoolRejectedPolicy&lt;/em&gt;).&lt;/p&gt;

&lt;p&gt;So if submitted tasks do not implement &lt;em&gt;Rejectable&lt;/em&gt; interface the behavior is exactly the same as with ordinary &lt;em&gt;ThreadPoolExecutor&lt;/em&gt; and &lt;em&gt;ScheduledThreadPoolExecutor&lt;/em&gt;. If these tasks are &lt;em&gt;Rejectable&lt;/em&gt;, their &lt;em&gt;reject()&lt;/em&gt; method will be called. &lt;/p&gt;

&lt;p&gt;The only problem is what to do if the user provides its own ExecutorService to configure the ThreadsProcessor. I suppose in that case this user should be fully responsible for handling rejections correctly (it should be mentions in camel docs or somewhere else).&lt;/p&gt;</comment>
                            <comment id="13190647" author="davsclaus" created="Sun, 22 Jan 2012 11:06:49 +0000"  >&lt;p&gt;Sergey,&lt;/p&gt;

&lt;p&gt;Thanks for the patch. This seems promising. I am polishing this a bit&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;discard and discard oldest = the exchange will not continue routing, done successfully&lt;/li&gt;
	&lt;li&gt;abort = the exchange will not continue routing, an exception will be set, done with a failure&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Then you can decide to use between abort or discard, to chose between whether the exchange should done with a failure or not.&lt;/p&gt;

&lt;p&gt;I am removing the blocked policy, as its not tested, and we have no people asking for it. Don&apos;t give people robe to hang themselves.&lt;/p&gt;

&lt;p&gt;And yeah if end user provide their own thread pool, then they are responsible for handling that situation. &lt;/p&gt;</comment>
                            <comment id="13190696" author="szhemzhitsky" created="Sun, 22 Jan 2012 15:33:21 +0000"  >&lt;p&gt;Claus, thanks a lot.&lt;/p&gt;

&lt;p&gt;I&apos;ve done some experiments with the blocking policy that seems rather dangerous, as threads in the pool may become timed out before the rejected task will be put into the queue. So you&apos;re right that this policy has to be removed.&lt;/p&gt;</comment>
                            <comment id="13191133" author="davsclaus" created="Mon, 23 Jan 2012 12:33:25 +0000"  >&lt;p&gt;Thanks for the contribution. I polished it a bit, and fixed CS. You may want to read about building with checkstyle here:&lt;br/&gt;
&lt;a href=&quot;http://camel.apache.org/building.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://camel.apache.org/building.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This outputs a report if the source code is not aligned with the checkstyle we have in place. eg checking for missing license headers, and code formatting and the likes.&lt;/p&gt;</comment>
                            <comment id="13191252" author="szhemzhitsky" created="Mon, 23 Jan 2012 17:00:43 +0000"  >&lt;blockquote&gt;
&lt;p&gt;I polished it a bit, and fixed CS. You may want to read about building with checkstyle here:&lt;br/&gt;
&lt;a href=&quot;http://camel.apache.org/building.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://camel.apache.org/building.html&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Hi Claus, thanks for providing this useful link.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12511394" name="CAMEL-4925.patch" size="12896" author="szhemzhitsky" created="Sat, 21 Jan 2012 16:55:40 +0000"/>
                            <attachment id="12511245" name="CamelRoutingTest.java" size="10404" author="szhemzhitsky" created="Fri, 20 Jan 2012 10:02:52 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>224617</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 44 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i023x3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>10236</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>