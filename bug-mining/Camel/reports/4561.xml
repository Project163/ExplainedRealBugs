<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:30:06 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-12603] Thread stuck in re-delivery loop after interrupting it</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-12603</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;I have experienced an issue where we could not cancel a message stuck in a re-delivery cycle. I was using Jolokia and calling the interrupt method on the DefaultAsyncProcessorAwaitManager for the blocked exchange and I had expected the re-delivery cycle to stop.&lt;/p&gt;

&lt;p&gt;This does not happen, and the blocked message continues to get executed and re-delivered. The mapping does get removed from the in-flight messages&#160;though. I can see also that the&#160;RejectedExecutionException set by the interrupt is also overwritten by the exception thrown by our failing bean. I think the problem here is that there are no checks for this&#160;RejectedExecutionException during the re-delivery cycle.&lt;/p&gt;

&lt;p&gt;It seems like the following part of the RedeliveryErrorHandler::call should pick up the fact that the exchange has been interrupted:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// only process &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; the exchange hasn&apos;t failed
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// and it has not been handled by the error processor
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (isDone(exchange)) {
 callback.done(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
 &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This is an issue if you have configured a long re-delivery cycle and you have a message retrying that you know will never succeed.&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13168795">CAMEL-12603</key>
            <summary>Thread stuck in re-delivery loop after interrupting it</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="acosentino">Andrea Cosentino</assignee>
                                    <reporter username="NickUK">Nick Horne</reporter>
                        <labels>
                    </labels>
                <created>Thu, 28 Jun 2018 07:55:57 +0000</created>
                <updated>Wed, 4 Jul 2018 08:15:59 +0000</updated>
                            <resolved>Wed, 4 Jul 2018 08:15:59 +0000</resolved>
                                                    <fixVersion>2.21.2</fixVersion>
                    <fixVersion>2.22.1</fixVersion>
                    <fixVersion>2.23.0</fixVersion>
                                    <component>camel-core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="16531262" author="githubbot" created="Tue, 3 Jul 2018 12:07:10 +0000"  >&lt;p&gt;davsclaus commented on issue #2396: &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12603&quot; title=&quot;Thread stuck in re-delivery loop after interrupting it&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12603&quot;&gt;&lt;del&gt;CAMEL-12603&lt;/del&gt;&lt;/a&gt; - Interrupt fix for messages stuck in a re-delivery loop&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2396#issuecomment-402132134&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2396#issuecomment-402132134&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Lets wait to merge this until we get the 2.22.x branch&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16531273" author="githubbot" created="Tue, 3 Jul 2018 12:12:24 +0000"  >&lt;p&gt;dmvolod commented on a change in pull request #2396: &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12603&quot; title=&quot;Thread stuck in re-delivery loop after interrupting it&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12603&quot;&gt;&lt;del&gt;CAMEL-12603&lt;/del&gt;&lt;/a&gt; - Interrupt fix for messages stuck in a re-delivery loop&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2396#discussion_r199783067&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2396#discussion_r199783067&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: camel-core/src/test/java/org/apache/camel/processor/async/AsyncProcessorAwaitManagerInterruptWithRedeliveryTest.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -0,0 +1,136 @@&lt;br/&gt;
+/**&lt;br/&gt;
+ * Licensed to the Apache Software Foundation (ASF) under one or more&lt;br/&gt;
+ * contributor license agreements.  See the NOTICE file distributed with&lt;br/&gt;
+ * this work for additional information regarding copyright ownership.&lt;br/&gt;
+ * The ASF licenses this file to You under the Apache License, Version 2.0&lt;br/&gt;
+ * (the &quot;License&quot;); you may not use this file except in compliance with&lt;br/&gt;
+ * the License.  You may obtain a copy of the License at&lt;br/&gt;
+ *&lt;br/&gt;
+ *      &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
+ *&lt;br/&gt;
+ * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
+ * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
+ * See the License for the specific language governing permissions and&lt;br/&gt;
+ * limitations under the License.&lt;br/&gt;
+ */&lt;br/&gt;
+package org.apache.camel.processor.async;&lt;br/&gt;
+&lt;br/&gt;
+import org.apache.camel.CamelExecutionException;&lt;br/&gt;
+import org.apache.camel.ContextTestSupport;&lt;br/&gt;
+import org.apache.camel.builder.RouteBuilder;&lt;br/&gt;
+import org.apache.camel.spi.AsyncProcessorAwaitManager;&lt;br/&gt;
+import org.apache.camel.util.jndi.JndiContext;&lt;br/&gt;
+&lt;br/&gt;
+import javax.naming.Context;&lt;br/&gt;
+import java.util.Collection;&lt;br/&gt;
+import java.util.concurrent.CountDownLatch;&lt;br/&gt;
+import java.util.concurrent.RejectedExecutionException;&lt;br/&gt;
+import java.util.concurrent.TimeUnit;&lt;br/&gt;
+&lt;br/&gt;
+import static org.mockito.Mockito.atMost;&lt;br/&gt;
+import static org.mockito.Mockito.spy;&lt;br/&gt;
+import static org.mockito.Mockito.verify;&lt;br/&gt;
+&lt;br/&gt;
+public class AsyncProcessorAwaitManagerInterruptWithRedeliveryTest extends ContextTestSupport {&lt;br/&gt;
+    private CountDownLatch latch;&lt;br/&gt;
+    private MyBean bean;&lt;br/&gt;
+&lt;br/&gt;
+    @Override&lt;br/&gt;
+    protected void setUp() throws Exception &lt;/p&gt;
{
+        latch = new CountDownLatch(2);
+        bean = spy(new MyBean(latch));
+        super.setUp();
+    }
&lt;p&gt;+&lt;br/&gt;
+    public void testAsyncAwaitInterrupt() throws Exception {&lt;br/&gt;
+        context.getAsyncProcessorAwaitManager().getStatistics().setStatisticsEnabled(true);&lt;br/&gt;
+&lt;br/&gt;
+        assertEquals(0, context.getAsyncProcessorAwaitManager().size());&lt;br/&gt;
+&lt;br/&gt;
+        getMockEndpoint(&quot;mock:before&quot;).expectedBodiesReceived(&quot;Hello Camel&quot;);&lt;br/&gt;
+        getMockEndpoint(&quot;mock:result&quot;).expectedMessageCount(0);&lt;br/&gt;
+        getMockEndpoint(&quot;mock:error&quot;).expectedMessageCount(0);&lt;br/&gt;
+&lt;br/&gt;
+        createThreadToInterrupt();&lt;br/&gt;
+        try &lt;/p&gt;
{
+            template.sendBody(&quot;direct:start&quot;, &quot;Hello Camel&quot;);
+            fail(&quot;Should throw exception&quot;);
+        }
&lt;p&gt; catch (CamelExecutionException e) &lt;/p&gt;
{
+            RejectedExecutionException cause = assertIsInstanceOf(RejectedExecutionException.class, e.getCause());
+            assertTrue(cause.getMessage().startsWith(&quot;Interrupted while waiting for asynchronous callback&quot;));
+        }
&lt;p&gt;+&lt;br/&gt;
+        assertMockEndpointsSatisfied();&lt;br/&gt;
+&lt;br/&gt;
+        // Check we have not reached the full 5 re-deliveries&lt;br/&gt;
+        verify(bean, atMost(4)).callMe();&lt;br/&gt;
+&lt;br/&gt;
+        assertEquals(0, context.getAsyncProcessorAwaitManager().size());&lt;br/&gt;
+        assertEquals(1, context.getAsyncProcessorAwaitManager().getStatistics().getThreadsBlocked());&lt;br/&gt;
+        assertEquals(1, context.getAsyncProcessorAwaitManager().getStatistics().getThreadsInterrupted());&lt;br/&gt;
+    }&lt;br/&gt;
+&lt;br/&gt;
+    private void createThreadToInterrupt() {&lt;br/&gt;
+        new Thread(() -&amp;gt; {&lt;br/&gt;
+            // Allow some time for camel exchange to enter the re-deliveries&lt;br/&gt;
+            try &lt;/p&gt;
{
+                latch.await(1, TimeUnit.SECONDS);
+            }
&lt;p&gt; catch (InterruptedException e) &lt;/p&gt;
{
+                e.printStackTrace();
+            }
&lt;p&gt;+&lt;br/&gt;
+            // Get our blocked thread&lt;br/&gt;
+            int size = context.getAsyncProcessorAwaitManager().size();&lt;br/&gt;
+            System.out.println(&quot;In-flight messages: &quot; + size);&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   Please avoid using System.out.println if it&apos;s not required for use-case. Use logs for it. &lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16531374" author="githubbot" created="Tue, 3 Jul 2018 13:21:32 +0000"  >&lt;p&gt;NickUK commented on a change in pull request #2396: &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12603&quot; title=&quot;Thread stuck in re-delivery loop after interrupting it&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12603&quot;&gt;&lt;del&gt;CAMEL-12603&lt;/del&gt;&lt;/a&gt; - Interrupt fix for messages stuck in a re-delivery loop&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2396#discussion_r199804106&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2396#discussion_r199804106&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: camel-core/src/test/java/org/apache/camel/processor/async/AsyncProcessorAwaitManagerInterruptWithRedeliveryTest.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -0,0 +1,136 @@&lt;br/&gt;
+/**&lt;br/&gt;
+ * Licensed to the Apache Software Foundation (ASF) under one or more&lt;br/&gt;
+ * contributor license agreements.  See the NOTICE file distributed with&lt;br/&gt;
+ * this work for additional information regarding copyright ownership.&lt;br/&gt;
+ * The ASF licenses this file to You under the Apache License, Version 2.0&lt;br/&gt;
+ * (the &quot;License&quot;); you may not use this file except in compliance with&lt;br/&gt;
+ * the License.  You may obtain a copy of the License at&lt;br/&gt;
+ *&lt;br/&gt;
+ *      &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
+ *&lt;br/&gt;
+ * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
+ * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
+ * See the License for the specific language governing permissions and&lt;br/&gt;
+ * limitations under the License.&lt;br/&gt;
+ */&lt;br/&gt;
+package org.apache.camel.processor.async;&lt;br/&gt;
+&lt;br/&gt;
+import org.apache.camel.CamelExecutionException;&lt;br/&gt;
+import org.apache.camel.ContextTestSupport;&lt;br/&gt;
+import org.apache.camel.builder.RouteBuilder;&lt;br/&gt;
+import org.apache.camel.spi.AsyncProcessorAwaitManager;&lt;br/&gt;
+import org.apache.camel.util.jndi.JndiContext;&lt;br/&gt;
+&lt;br/&gt;
+import javax.naming.Context;&lt;br/&gt;
+import java.util.Collection;&lt;br/&gt;
+import java.util.concurrent.CountDownLatch;&lt;br/&gt;
+import java.util.concurrent.RejectedExecutionException;&lt;br/&gt;
+import java.util.concurrent.TimeUnit;&lt;br/&gt;
+&lt;br/&gt;
+import static org.mockito.Mockito.atMost;&lt;br/&gt;
+import static org.mockito.Mockito.spy;&lt;br/&gt;
+import static org.mockito.Mockito.verify;&lt;br/&gt;
+&lt;br/&gt;
+public class AsyncProcessorAwaitManagerInterruptWithRedeliveryTest extends ContextTestSupport {&lt;br/&gt;
+    private CountDownLatch latch;&lt;br/&gt;
+    private MyBean bean;&lt;br/&gt;
+&lt;br/&gt;
+    @Override&lt;br/&gt;
+    protected void setUp() throws Exception &lt;/p&gt;
{
+        latch = new CountDownLatch(2);
+        bean = spy(new MyBean(latch));
+        super.setUp();
+    }
&lt;p&gt;+&lt;br/&gt;
+    public void testAsyncAwaitInterrupt() throws Exception {&lt;br/&gt;
+        context.getAsyncProcessorAwaitManager().getStatistics().setStatisticsEnabled(true);&lt;br/&gt;
+&lt;br/&gt;
+        assertEquals(0, context.getAsyncProcessorAwaitManager().size());&lt;br/&gt;
+&lt;br/&gt;
+        getMockEndpoint(&quot;mock:before&quot;).expectedBodiesReceived(&quot;Hello Camel&quot;);&lt;br/&gt;
+        getMockEndpoint(&quot;mock:result&quot;).expectedMessageCount(0);&lt;br/&gt;
+        getMockEndpoint(&quot;mock:error&quot;).expectedMessageCount(0);&lt;br/&gt;
+&lt;br/&gt;
+        createThreadToInterrupt();&lt;br/&gt;
+        try &lt;/p&gt;
{
+            template.sendBody(&quot;direct:start&quot;, &quot;Hello Camel&quot;);
+            fail(&quot;Should throw exception&quot;);
+        }
&lt;p&gt; catch (CamelExecutionException e) &lt;/p&gt;
{
+            RejectedExecutionException cause = assertIsInstanceOf(RejectedExecutionException.class, e.getCause());
+            assertTrue(cause.getMessage().startsWith(&quot;Interrupted while waiting for asynchronous callback&quot;));
+        }
&lt;p&gt;+&lt;br/&gt;
+        assertMockEndpointsSatisfied();&lt;br/&gt;
+&lt;br/&gt;
+        // Check we have not reached the full 5 re-deliveries&lt;br/&gt;
+        verify(bean, atMost(4)).callMe();&lt;br/&gt;
+&lt;br/&gt;
+        assertEquals(0, context.getAsyncProcessorAwaitManager().size());&lt;br/&gt;
+        assertEquals(1, context.getAsyncProcessorAwaitManager().getStatistics().getThreadsBlocked());&lt;br/&gt;
+        assertEquals(1, context.getAsyncProcessorAwaitManager().getStatistics().getThreadsInterrupted());&lt;br/&gt;
+    }&lt;br/&gt;
+&lt;br/&gt;
+    private void createThreadToInterrupt() {&lt;br/&gt;
+        new Thread(() -&amp;gt; {&lt;br/&gt;
+            // Allow some time for camel exchange to enter the re-deliveries&lt;br/&gt;
+            try &lt;/p&gt;
{
+                latch.await(1, TimeUnit.SECONDS);
+            }
&lt;p&gt; catch (InterruptedException e) &lt;/p&gt;
{
+                e.printStackTrace();
+            }
&lt;p&gt;+&lt;br/&gt;
+            // Get our blocked thread&lt;br/&gt;
+            int size = context.getAsyncProcessorAwaitManager().size();&lt;br/&gt;
+            System.out.println(&quot;In-flight messages: &quot; + size);&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   I have removed these&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16532322" author="githubbot" created="Wed, 4 Jul 2018 06:33:27 +0000"  >&lt;p&gt;oscerd commented on issue #2396: &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12603&quot; title=&quot;Thread stuck in re-delivery loop after interrupting it&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12603&quot;&gt;&lt;del&gt;CAMEL-12603&lt;/del&gt;&lt;/a&gt; - Interrupt fix for messages stuck in a re-delivery loop&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2396#issuecomment-402377752&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2396#issuecomment-402377752&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   I&apos;m preparing to merge this one.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16532414" author="githubbot" created="Wed, 4 Jul 2018 08:15:21 +0000"  >&lt;p&gt;oscerd commented on issue #2396: &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12603&quot; title=&quot;Thread stuck in re-delivery loop after interrupting it&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12603&quot;&gt;&lt;del&gt;CAMEL-12603&lt;/del&gt;&lt;/a&gt; - Interrupt fix for messages stuck in a re-delivery loop&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2396#issuecomment-402401097&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2396#issuecomment-402401097&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Merged on master, 2.22.x and 2.21.x&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16532415" author="githubbot" created="Wed, 4 Jul 2018 08:15:27 +0000"  >&lt;p&gt;oscerd closed pull request #2396: &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12603&quot; title=&quot;Thread stuck in re-delivery loop after interrupting it&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12603&quot;&gt;&lt;del&gt;CAMEL-12603&lt;/del&gt;&lt;/a&gt; - Interrupt fix for messages stuck in a re-delivery loop&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2396&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2396&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/camel-core/src/main/java/org/apache/camel/impl/DefaultAsyncProcessorAwaitManager.java b/camel-core/src/main/java/org/apache/camel/impl/DefaultAsyncProcessorAwaitManager.java&lt;br/&gt;
index c8dafaa19d7..4a9ef4ddf53 100644&lt;br/&gt;
&amp;#8212; a/camel-core/src/main/java/org/apache/camel/impl/DefaultAsyncProcessorAwaitManager.java&lt;br/&gt;
+++ b/camel-core/src/main/java/org/apache/camel/impl/DefaultAsyncProcessorAwaitManager.java&lt;br/&gt;
@@ -161,6 +161,7 @@ public void interrupt(Exchange exchange) &lt;/p&gt;
{
                     interruptedCounter.incrementAndGet();
                 }
&lt;p&gt;                 exchange.setException(new RejectedExecutionException(&quot;Interrupted while waiting for asynchronous callback for exchangeId: &quot; + exchange.getExchangeId()));&lt;br/&gt;
+                exchange.setProperty(Exchange.INTERRUPTED, Boolean.TRUE);&lt;br/&gt;
                 entry.getLatch().countDown();&lt;br/&gt;
             }&lt;br/&gt;
         }&lt;br/&gt;
diff --git a/camel-core/src/test/java/org/apache/camel/processor/async/AsyncProcessorAwaitManagerInterruptWithRedeliveryTest.java b/camel-core/src/test/java/org/apache/camel/processor/async/AsyncProcessorAwaitManagerInterruptWithRedeliveryTest.java&lt;br/&gt;
new file mode 100644&lt;br/&gt;
index 00000000000..c400d4d9756&lt;br/&gt;
&amp;#8212; /dev/null&lt;br/&gt;
+++ b/camel-core/src/test/java/org/apache/camel/processor/async/AsyncProcessorAwaitManagerInterruptWithRedeliveryTest.java&lt;br/&gt;
@@ -0,0 +1,134 @@&lt;br/&gt;
+/**&lt;br/&gt;
+ * Licensed to the Apache Software Foundation (ASF) under one or more&lt;br/&gt;
+ * contributor license agreements.  See the NOTICE file distributed with&lt;br/&gt;
+ * this work for additional information regarding copyright ownership.&lt;br/&gt;
+ * The ASF licenses this file to You under the Apache License, Version 2.0&lt;br/&gt;
+ * (the &quot;License&quot;); you may not use this file except in compliance with&lt;br/&gt;
+ * the License.  You may obtain a copy of the License at&lt;br/&gt;
+ *&lt;br/&gt;
+ *      &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
+ *&lt;br/&gt;
+ * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
+ * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
+ * See the License for the specific language governing permissions and&lt;br/&gt;
+ * limitations under the License.&lt;br/&gt;
+ */&lt;br/&gt;
+package org.apache.camel.processor.async;&lt;br/&gt;
+&lt;br/&gt;
+import org.apache.camel.CamelExecutionException;&lt;br/&gt;
+import org.apache.camel.ContextTestSupport;&lt;br/&gt;
+import org.apache.camel.builder.RouteBuilder;&lt;br/&gt;
+import org.apache.camel.spi.AsyncProcessorAwaitManager;&lt;br/&gt;
+import org.apache.camel.util.jndi.JndiContext;&lt;br/&gt;
+&lt;br/&gt;
+import javax.naming.Context;&lt;br/&gt;
+import java.util.Collection;&lt;br/&gt;
+import java.util.concurrent.CountDownLatch;&lt;br/&gt;
+import java.util.concurrent.RejectedExecutionException;&lt;br/&gt;
+import java.util.concurrent.TimeUnit;&lt;br/&gt;
+&lt;br/&gt;
+import static org.mockito.Mockito.atMost;&lt;br/&gt;
+import static org.mockito.Mockito.spy;&lt;br/&gt;
+import static org.mockito.Mockito.verify;&lt;br/&gt;
+&lt;br/&gt;
+public class AsyncProcessorAwaitManagerInterruptWithRedeliveryTest extends ContextTestSupport {&lt;br/&gt;
+    private CountDownLatch latch;&lt;br/&gt;
+    private MyBean bean;&lt;br/&gt;
+&lt;br/&gt;
+    @Override&lt;br/&gt;
+    protected void setUp() throws Exception &lt;/p&gt;
{
+        latch = new CountDownLatch(2);
+        bean = spy(new MyBean(latch));
+        super.setUp();
+    }
&lt;p&gt;+&lt;br/&gt;
+    public void testAsyncAwaitInterrupt() throws Exception {&lt;br/&gt;
+        context.getAsyncProcessorAwaitManager().getStatistics().setStatisticsEnabled(true);&lt;br/&gt;
+&lt;br/&gt;
+        assertEquals(0, context.getAsyncProcessorAwaitManager().size());&lt;br/&gt;
+&lt;br/&gt;
+        getMockEndpoint(&quot;mock:before&quot;).expectedBodiesReceived(&quot;Hello Camel&quot;);&lt;br/&gt;
+        getMockEndpoint(&quot;mock:result&quot;).expectedMessageCount(0);&lt;br/&gt;
+        getMockEndpoint(&quot;mock:error&quot;).expectedMessageCount(0);&lt;br/&gt;
+&lt;br/&gt;
+        createThreadToInterrupt();&lt;br/&gt;
+        try &lt;/p&gt;
{
+            template.sendBody(&quot;direct:start&quot;, &quot;Hello Camel&quot;);
+            fail(&quot;Should throw exception&quot;);
+        }
&lt;p&gt; catch (CamelExecutionException e) &lt;/p&gt;
{
+            RejectedExecutionException cause = assertIsInstanceOf(RejectedExecutionException.class, e.getCause());
+            assertTrue(cause.getMessage().startsWith(&quot;Interrupted while waiting for asynchronous callback&quot;));
+        }
&lt;p&gt;+&lt;br/&gt;
+        assertMockEndpointsSatisfied();&lt;br/&gt;
+&lt;br/&gt;
+        // Check we have not reached the full 5 re-deliveries&lt;br/&gt;
+        verify(bean, atMost(4)).callMe();&lt;br/&gt;
+&lt;br/&gt;
+        assertEquals(0, context.getAsyncProcessorAwaitManager().size());&lt;br/&gt;
+        assertEquals(1, context.getAsyncProcessorAwaitManager().getStatistics().getThreadsBlocked());&lt;br/&gt;
+        assertEquals(1, context.getAsyncProcessorAwaitManager().getStatistics().getThreadsInterrupted());&lt;br/&gt;
+    }&lt;br/&gt;
+&lt;br/&gt;
+    private void createThreadToInterrupt() {&lt;br/&gt;
+        new Thread(() -&amp;gt; {&lt;br/&gt;
+            // Allow some time for camel exchange to enter the re-deliveries&lt;br/&gt;
+            try &lt;/p&gt;
{
+                latch.await(1, TimeUnit.SECONDS);
+            }
&lt;p&gt; catch (InterruptedException e) &lt;/p&gt;
{
+                e.printStackTrace();
+            }
&lt;p&gt;+&lt;br/&gt;
+            // Get our blocked thread&lt;br/&gt;
+            int size = context.getAsyncProcessorAwaitManager().size();&lt;br/&gt;
+            assertEquals(1, size);&lt;br/&gt;
+&lt;br/&gt;
+            Collection&amp;lt;AsyncProcessorAwaitManager.AwaitThread&amp;gt; threads = context.getAsyncProcessorAwaitManager().browse();&lt;br/&gt;
+            AsyncProcessorAwaitManager.AwaitThread thread = threads.iterator().next();&lt;br/&gt;
+&lt;br/&gt;
+            // Interrupt it&lt;br/&gt;
+            String id = thread.getExchange().getExchangeId();&lt;br/&gt;
+            context.getAsyncProcessorAwaitManager().interrupt(id);&lt;br/&gt;
+        }).start();&lt;br/&gt;
+    }&lt;br/&gt;
+&lt;br/&gt;
+    @Override&lt;br/&gt;
+    protected Context createJndiContext() throws Exception &lt;/p&gt;
{
+        JndiContext jndiContext = new JndiContext();
+
+        jndiContext.bind(&quot;myBean&quot;, bean);
+        return jndiContext;
+    }
&lt;p&gt;+&lt;br/&gt;
+    @Override&lt;br/&gt;
+    protected RouteBuilder createRouteBuilder() throws Exception {&lt;br/&gt;
+        return new RouteBuilder() {&lt;br/&gt;
+            @Override&lt;br/&gt;
+            public void configure() &lt;/p&gt;
{
+                errorHandler(deadLetterChannel(&quot;mock:error&quot;)
+                    .maximumRedeliveries(5)
+                    .redeliveryDelay(100)
+                    .asyncDelayedRedelivery());
+
+                from(&quot;direct:start&quot;).routeId(&quot;myRoute&quot;)
+                    .to(&quot;mock:before&quot;)
+                    .bean(&quot;myBean&quot;, &quot;callMe&quot;)
+                    .to(&quot;mock:result&quot;);
+            }
&lt;p&gt;+        };&lt;br/&gt;
+    }&lt;br/&gt;
+&lt;br/&gt;
+    public static class MyBean {&lt;br/&gt;
+        private CountDownLatch latch;&lt;br/&gt;
+&lt;br/&gt;
+        public MyBean(CountDownLatch latch) &lt;/p&gt;
{
+            this.latch = latch;
+        }
&lt;p&gt;+&lt;br/&gt;
+        public void callMe() throws Exception &lt;/p&gt;
{
+            latch.countDown();
+            throw new Exception();
+        }
&lt;p&gt;+    }&lt;br/&gt;
+}&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16532416" author="githubbot" created="Wed, 4 Jul 2018 08:15:27 +0000"  >&lt;p&gt;Github user oscerd closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/camel/pull/2396&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2396&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 20 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3vbnz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>