<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:30:54 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-12727] java.util.ConcurrentModificationException at org.apache.camel.impl.DefaultExchange.createProperties(DefaultExchange.java:550) in 2.20.1</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-12727</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;A concurrent access exception occurs during our load tests while consuming messages from a rabbitmq queue.&lt;/p&gt;

&lt;p&gt;The call stack embedded below shows that the issue is related to an &quot;optimization&quot; which was introduced in &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-11330&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CAMEL-11330&lt;/a&gt;&#160;to replace a ConcurrentHashMap with a regular one from version 2.19.5 to 2.20.0 onward.&lt;/p&gt;

&lt;p&gt;The faulty code is still present in latest 2.22.0.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment>&lt;p&gt;Camel 2.20.1.&lt;/p&gt;

&lt;p&gt;The exception occurs within a aggregation processor using a custom aggregation strategy and optimistic locking.&lt;/p&gt;</environment>
        <key id="13178648">CAMEL-12727</key>
            <summary>java.util.ConcurrentModificationException at org.apache.camel.impl.DefaultExchange.createProperties(DefaultExchange.java:550) in 2.20.1</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="boutblock">Philippe Bouteleux</reporter>
                        <labels>
                    </labels>
                <created>Mon, 13 Aug 2018 17:23:41 +0000</created>
                <updated>Mon, 27 Aug 2018 11:58:45 +0000</updated>
                            <resolved>Mon, 27 Aug 2018 11:58:45 +0000</resolved>
                                    <version>2.20.0</version>
                                    <fixVersion>2.23.0</fixVersion>
                                    <component>camel-core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16579417" author="dmvolod" created="Tue, 14 Aug 2018 08:16:22 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=boutblock&quot; class=&quot;user-hover&quot; rel=&quot;boutblock&quot;&gt;boutblock&lt;/a&gt;, could you please provide a reproducer as simple as possible.&lt;/p&gt;</comment>
                            <comment id="16579451" author="davsclaus" created="Tue, 14 Aug 2018 08:45:38 +0000"  >&lt;p&gt;Optimistick locking implies concurrent access and is not always safe to be used. We may need to do a synchronization point in the aggregator at a certain point&lt;/p&gt;</comment>
                            <comment id="16579457" author="boutblock" created="Tue, 14 Aug 2018 08:50:11 +0000"  >&lt;p&gt;Hi,&#160;&lt;/p&gt;

&lt;p&gt;I&apos;m sorry this cannot be easily reproduced with a simple unit test as it only occurs under heavy workload on our perf platform of test.&lt;/p&gt;

&lt;p&gt;The route looks like this:&lt;/p&gt;

&lt;p&gt;from(auditQueueProperties.getAuditQueueUri()) // rabbitmq queue&lt;br/&gt;
 .routeId(ROUTE_NAME)&lt;br/&gt;
 .autoStartup(true)&lt;br/&gt;
 .split().method(batchUnfoldPlugin) // extract individual xml audit messages from the input batch&lt;br/&gt;
 .aggregate(simple(&quot;${header.&quot; + AUDIT_TYPE + &quot;}&quot;), aggregationStrategy) // aggregate the audit messages by appending them directly into files on disk, spread by type&lt;br/&gt;
 .optimisticLocking() // as exclusive pessimistic locking is directly managed by the file system for each individual file instead of a less efficient global lock.&lt;br/&gt;
 .completionSize(stagingAreaProperties.getCompletionSize())&lt;br/&gt;
 .completionInterval(stagingAreaProperties.getCompletionInterval())&lt;br/&gt;
 // copy each completed file to another location&lt;br/&gt;
 .process(ex -&amp;gt; stagingArea.push(ex.getIn().getHeader(TRANSACTION_TYPE).toString(), ex.getIn().getHeader(AUDIT_DATA_PATH).toString(), ex.getIn().getBody()))&lt;br/&gt;
 .end();&lt;/p&gt;

&lt;p&gt;The custom aggregation strategy implements&#160;CompletionAwareAggregationStrategy and TimeoutAwareAggregationStrategy to save each incoming message by appending it to the correct file by type, date etc... protected by a FileLock and retries on&#160;OverlappingFileLockException.&lt;/p&gt;

&lt;p&gt;We are currently in the process to downgrade from our current version 2.20.1 to version 2.19.5 to validate our assumption on the issue but we are facing other incompatibility problems&#160;doing so that needs to be fixed/circumvented.&lt;/p&gt;</comment>
                            <comment id="16579480" author="boutblock" created="Tue, 14 Aug 2018 09:02:26 +0000"  >&lt;p&gt;You are certainly right as the lines of code where the exception occurs depends on tests on optimisticLocking and&#160; aggregationRepository being in-memory (AggregateProcessor.java line 398 in 2.20.1):&lt;/p&gt;

&lt;p&gt;// hack to support legacy AggregationStrategy&apos;s that modify and return the oldExchange, these will not&lt;br/&gt;
// working when using an identify based approach for optimistic locking like the MemoryAggregationRepository.&lt;br/&gt;
if (optimisticLocking &amp;amp;&amp;amp; aggregationRepository instanceof MemoryAggregationRepository) &lt;/p&gt;
{
 oldExchange = originalExchange.copy();
}

&lt;p&gt;Please note that we did&#160; not choose to follow the repository pattern to save each individual message to disk but we chose to directly save them in the aggregation strategy class we provided.&lt;/p&gt;

&lt;p&gt;Actually, the default MemoryAggregationRepository is of no use in our use case and shall may be replaced by our own &apos;null repository&apos; to not put pressure on the garbage collector for nothing. This may also workaround the issue as the conditional test would be false and the exchange would not be copied and would not crash.&lt;/p&gt;</comment>
                            <comment id="16579559" author="boutblock" created="Tue, 14 Aug 2018 09:48:01 +0000"  >&lt;p&gt;So. I added a custom &apos;NullAggregationRepository&apos; to my route which is a copy of the original MemoryAggregationRepository to avoid the internal copy of the exchange. I will unfortunately only have a result when our perf platform is ready to upgrade.&lt;/p&gt;

&lt;p&gt;I&apos;ll give back more information ASAP.&lt;/p&gt;

&lt;p&gt;Note that I couldn&apos;t avoid the in-memory cache of the exchanges in the repository without breaking the internal logic of the aggregator.&lt;/p&gt;</comment>
                            <comment id="16581003" author="davsclaus" created="Wed, 15 Aug 2018 12:23:27 +0000"  >&lt;p&gt;Thanks, when you have feedback then provide it here for us&lt;/p&gt;</comment>
                            <comment id="16581023" author="davsclaus" created="Wed, 15 Aug 2018 12:40:02 +0000"  >&lt;p&gt;We could synchronize that hack&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
                &lt;span class=&quot;code-comment&quot;&gt;// need to synchronize &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; to avoid concurrency issue
&lt;/span&gt;                &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;) {
                    oldExchange = originalExchange.copy();
                }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We could also consider going back to ConcurrentHashMap. The implementation in newer JVMs are much better now.&lt;/p&gt;</comment>
                            <comment id="16588894" author="davsclaus" created="Wed, 22 Aug 2018 14:05:00 +0000"  >&lt;p&gt;Any feedback &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=boutblock&quot; class=&quot;user-hover&quot; rel=&quot;boutblock&quot;&gt;boutblock&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16588948" author="boutblock" created="Wed, 22 Aug 2018 14:46:57 +0000"  >&lt;p&gt;No definitive results yet from our full perf platform. However, from our CI smaller stress test, after having integrated our own&#160;&#160;aggregation repository bypassing the hack and therefore the copy, no more exception occurred for now. Which sounds good.&lt;/p&gt;

&lt;p&gt;Now, IMHO, re-introducing the ConcurrentHashMap is the proper and safer solution. However, adding the lock within the hack only has less impacts on performances. Q: is this hack really still useful ?&lt;/p&gt;</comment>
                            <comment id="16593359" author="davsclaus" created="Mon, 27 Aug 2018 09:04:56 +0000"  >&lt;p&gt;Yeah the hack would be needed as the locking is optimistick and therefore concurrent access on the copy method. But as you say the concurrent hash map smells like the better option and it was also what was used in the past.&lt;/p&gt;</comment>
                            <comment id="16593560" author="davsclaus" created="Mon, 27 Aug 2018 11:58:45 +0000"  >&lt;p&gt;Okay going back to ConcurrentMap so its safe as it was in Camel 2.19.x and older.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13074869">CAMEL-11330</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12935407" name="dih-error.queue_2 (1).txt" size="9386" author="boutblock" created="Mon, 13 Aug 2018 17:16:54 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 12 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3wzun:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310080" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Regression</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10091"><![CDATA[Regression]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>