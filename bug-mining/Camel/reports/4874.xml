<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:34:58 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-13433] S3: Exchange body stream is loaded into memory to calculate content length which is already set via headers</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-13433</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;My code uploads large files to S3 storage (500 MB and bigger). I create an exchange with properly set meta information headers including the&#160;&lt;em&gt;CamelAwsS3ContentLength&lt;/em&gt;, as a body I provide a stream. Everything worked well in Camel 2.14.3 but when I upgraded to Camel ti version 2.22.1 I suddenly began getting OOM issues from time to time. I did some debugging and found that the issue is in &lt;b&gt;S3Producer&lt;/b&gt; that loads content of the body stream into memory.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void processSingleOp(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Exchange exchange) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {

ObjectMetadata objectMetadata = determineMetadata(exchange);  &amp;lt;== here we already set length

File filePayload = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
InputStream is = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
ByteArrayOutputStream baos = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; obj = exchange.getIn().getMandatoryBody();
PutObjectRequest putObjectRequest = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;// Need to check &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; the message body is WrappedFile
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (obj &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; WrappedFile) {
   obj = ((WrappedFile&amp;lt;?&amp;gt;)obj).getFile();
}
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (obj &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; File) {
   filePayload = (File)obj;
   is = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; FileInputStream(filePayload);
} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
   is = exchange.getIn().getMandatoryBody(InputStream.class);
   baos = determineLengthInputStream(is);        &amp;lt;====== the issue is here
   objectMetadata.setContentLength(baos.size());
   is = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ByteArrayInputStream(baos.toByteArray());
}

...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This is a defect since, as I mentioned, I already provide content length via headers and in the first line of the method populates that information into object metadata.&lt;/p&gt;

&lt;p&gt;I think there should be some if check that skips content length size calculation if it is already known.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13228821">CAMEL-13433</key>
            <summary>S3: Exchange body stream is loaded into memory to calculate content length which is already set via headers</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="acosentino">Andrea Cosentino</assignee>
                                    <reporter username="mvlakh">MykhailoVlakh</reporter>
                        <labels>
                    </labels>
                <created>Thu, 18 Apr 2019 10:20:46 +0000</created>
                <updated>Tue, 23 Apr 2019 09:17:34 +0000</updated>
                            <resolved>Tue, 23 Apr 2019 09:17:34 +0000</resolved>
                                    <version>2.22.1</version>
                    <version>2.23.2</version>
                    <version>3.0.0-M1</version>
                                    <fixVersion>2.24.0</fixVersion>
                    <fixVersion>3.0.0-M3</fixVersion>
                    <fixVersion>2.23.3</fixVersion>
                    <fixVersion>3.0.0</fixVersion>
                                    <component>camel-aws</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16821012" author="ancosen" created="Thu, 18 Apr 2019 12:02:38 +0000"  >&lt;p&gt;The problem is the overidding of the lenght or the input stream read?&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Because if it&apos;s the overidding we can do&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
is = exchange.getIn().getMandatoryBody(InputStream.class);
baos = determineLengthInputStream(is);
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!(objectMetadata.getContentLength() &amp;gt; 0)) {
objectMetadata.setContentLength(baos.size());
is = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ByteArrayInputStream(baos.toByteArray());
} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
is = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ByteArrayInputStream(baos.toByteArray());
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16821019" author="ancosen" created="Thu, 18 Apr 2019 12:16:12 +0000"  >&lt;p&gt;This should be sufficient. In one case we set the size from baos, in the other case we use baos but we already know the lenght from objectMetadata&lt;/p&gt;</comment>
                            <comment id="16821927" author="mvlakh" created="Fri, 19 Apr 2019 13:53:20 +0000"  >&lt;p&gt;Hello &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ancosen&quot; class=&quot;user-hover&quot; rel=&quot;ancosen&quot;&gt;ancosen&lt;/a&gt;, thank you for your time spent on this issue.&lt;/p&gt;

&lt;p&gt;The biggest issue is that the producer loads entire content into memory and this causes OOM if content is large. I believe this is incorrect, especially if it does this only to calculate size of the provided content that is already known. Cannot we just process input as stream to make sure that we won&apos;t occupy all heap space when we upload large content? I think this should be the right fix. Do you agree?&lt;/p&gt;</comment>
                            <comment id="16821931" author="ancosen" created="Fri, 19 Apr 2019 14:00:31 +0000"  >&lt;p&gt;I think we still need to know the size if it&apos;s not provided, but yes, we can skip that part if the content length has been already provided. I&apos;ll try to push a fix next week.&lt;/p&gt;</comment>
                            <comment id="16821934" author="ancosen" created="Fri, 19 Apr 2019 14:03:33 +0000"  >&lt;p&gt;Just to give a bit of context, the original fix was related to &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-11728&quot; title=&quot;Camel-AWS S3: Avoid warn log message about content length&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-11728&quot;&gt;&lt;del&gt;CAMEL-11728&lt;/del&gt;&lt;/a&gt;, to avoid a warn message.&lt;/p&gt;

&lt;p&gt;I&apos;m blaming myself for this. Let me work on this&lt;/p&gt;</comment>
                            <comment id="16822377" author="mvlakh" created="Sat, 20 Apr 2019 06:36:05 +0000"  >&lt;p&gt;yes this is what I think should be done. Thank you very much for your work on this. I think i will need to find some time to get sources so that next time i can provide a patch along with a reported issue to help you guys&lt;/p&gt;</comment>
                            <comment id="16823747" author="davsclaus" created="Tue, 23 Apr 2019 06:49:31 +0000"  >&lt;p&gt;Yeah good idea to grab the content-length if its already provided as a header and use that. And maybe add a little DEBUG logging that we are doing this, or that the length is to be determined by reading the data into memory. &lt;/p&gt;

&lt;p&gt;Also if you stream from eg http to s3 then we can maybe use the content-length header from HTTP, and read the stream as-is. There is an Exchange.CONTENT-LENGTH constant AFAIR.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10061"><![CDATA[Novice]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 30 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z01x3s:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310080" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Regression</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10091"><![CDATA[Regression]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>