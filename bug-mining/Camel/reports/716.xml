<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 09:34:19 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-1867] JmsKeyFormatStrategy not used consistently and JmsMessage.getHeader() not returning correct value</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-1867</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;On entry to a route from a JMS endpoint configured with PassthroughJmsKeyFormatStrategy the headers with underscores (_) are passed through correctly.&lt;/p&gt;

&lt;p&gt;However, when any header value in the message is then changed, the original headers are added back into the message using the DefaultJmsKeyFormatStrategy.  For example, sending a JMS message with headers;&lt;/p&gt;

&lt;p&gt;HEADER_1=VALUE_1&lt;br/&gt;
HEADER_2=VALUE_1&lt;/p&gt;

&lt;p&gt;we do see just these two headers in the message received into the route.&lt;/p&gt;

&lt;p&gt;However, if we then set a header value in the route, say HEADER_1=VALUE_2, we now see the headers;&lt;/p&gt;

&lt;p&gt;HEADER.1=VALUE_1&lt;br/&gt;
HEADER.2=VALUE_1&lt;br/&gt;
HEADER_1=VALUE_2&lt;br/&gt;
HEADER_2=VALUE_1&lt;/p&gt;

&lt;p&gt;For some reason in the set header process the original message headers and values get added into the message after being passed through the DefaultJmsKeyFormatStrategy.  This has the implication of unnecessary duplication of the headers.&lt;/p&gt;

&lt;p&gt;Also, when a message header is accessed using the getHeader(key) method it also goes through the DefaultJmsKeyFormatStrategy to decode the key that is passed.  &lt;/p&gt;

&lt;p&gt;In the example above, if after we have updated &apos;HEADER_1&apos; to &apos;VALUE_2&apos;, we do;&lt;/p&gt;

&lt;p&gt;message.getHeader(&quot;HEADER_1&quot;) this goes through the DefaultJmsKeyFormatStrategy and actually gets executed as message.getHeader(&quot;HEADER.1&quot;) which returns VALUE_1 (wrong!).&lt;/p&gt;

&lt;p&gt;Note: if instead we lookup the header through message.getHeaders() which returns the all headers in a Map, we can correctly access the &apos;HEADER_1&apos; key.  (Why is getHeader(key) even going through the KeyFormatStrategy anyway if setHeader() isn&apos;t?)&lt;/p&gt;</description>
                <environment>&lt;p&gt;2.0-M3&lt;/p&gt;</environment>
        <key id="12486586">CAMEL-1867</key>
            <summary>JmsKeyFormatStrategy not used consistently and JmsMessage.getHeader() not returning correct value</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="msjwhite">Mark White</reporter>
                        <labels>
                    </labels>
                <created>Thu, 30 Jul 2009 15:11:50 +0000</created>
                <updated>Wed, 5 Aug 2009 16:39:36 +0000</updated>
                            <resolved>Wed, 5 Aug 2009 11:30:29 +0000</resolved>
                                    <version>2.0-M3</version>
                                    <fixVersion>2.0.0</fixVersion>
                                    <component>camel-jms</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12946203" author="msjwhite" created="Thu, 30 Jul 2009 15:17:40 +0000"  >&lt;p&gt;Here is the Spring bean configuration we use to test;&lt;/p&gt;

&lt;p&gt;	&amp;lt;bean id=&quot;ConnectionFactory&quot; class=&quot;org.apache.activemq.pool.PooledConnectionFactory&quot; destroy-method=&quot;stop&quot;&amp;gt;&lt;br/&gt;
		&amp;lt;property name=&quot;connectionFactory&quot;&amp;gt;&lt;br/&gt;
			&amp;lt;bean class=&quot;org.apache.activemq.ActiveMQConnectionFactory&quot;&amp;gt;&lt;br/&gt;
				&amp;lt;property name=&quot;brokerURL&quot; value=&quot;failover:tcp://localhost:61616&quot;/&amp;gt;&lt;br/&gt;
			&amp;lt;/bean&amp;gt;&lt;br/&gt;
		&amp;lt;/property&amp;gt;&lt;br/&gt;
	&amp;lt;/bean&amp;gt;&lt;/p&gt;

&lt;p&gt;	&amp;lt;bean id=&quot;PassThroughHeader&quot; class=&quot;org.apache.camel.component.jms.PassThroughJmsKeyFormatStrategy&quot;/&amp;gt;&lt;/p&gt;

&lt;p&gt;	&amp;lt;bean id=&quot;jmsConfig&quot; class=&quot;org.apache.camel.component.jms.JmsConfiguration&quot;&amp;gt;&lt;br/&gt;
		&amp;lt;property name=&quot;connectionFactory&quot; ref=&quot;ConnectionFactory&quot;/&amp;gt;&lt;br/&gt;
		&amp;lt;property name=&quot;jmsKeyFormatStrategy&quot; ref=&quot;PassThroughHeader&quot;/&amp;gt;&lt;br/&gt;
		&amp;lt;property name=&quot;explicitQosEnabled&quot; value=&quot;true&quot;/&amp;gt;&lt;br/&gt;
		&amp;lt;property name=&quot;deliveryPersistent&quot; value=&quot;false&quot;/&amp;gt;&lt;br/&gt;
		&amp;lt;property name=&quot;concurrentConsumers&quot; value=&quot;1&quot;/&amp;gt;&lt;br/&gt;
	&amp;lt;/bean&amp;gt;&lt;/p&gt;

&lt;p&gt;	&amp;lt;bean id=&quot;jms&quot; class=&quot;org.apache.camel.component.jms.JmsComponent&quot;&amp;gt;&lt;br/&gt;
		&amp;lt;property name=&quot;configuration&quot; ref=&quot;jmsConfig&quot;/&amp;gt;&lt;br/&gt;
	&amp;lt;/bean&amp;gt;&lt;/p&gt;</comment>
                            <comment id="12946213" author="msjwhite" created="Thu, 30 Jul 2009 15:20:03 +0000"  >&lt;p&gt;Here is the Camel route we use to test;&lt;/p&gt;

&lt;p&gt;	&amp;lt;bean id=&quot;MessageTester&quot; class=&quot;route.test.camel.bean.MessageTester&quot;/&amp;gt;&lt;/p&gt;

&lt;p&gt;	&amp;lt;camelContext id=&quot;myroute&quot; trace=&quot;true&quot; xmlns=&quot;http://camel.apache.org/schema/spring&quot;&amp;gt;&lt;/p&gt;

&lt;p&gt;		&amp;lt;route&amp;gt;&lt;br/&gt;
			&amp;lt;from uri=&quot;jms:IN_QUEUE&quot;/&amp;gt;&lt;br/&gt;
			&amp;lt;bean ref=&quot;MessageTester&quot; method=&quot;prettyPrintHeaders&quot;/&amp;gt;&lt;br/&gt;
			&amp;lt;setHeader headerName=&quot;HEADER_1&quot;&amp;gt;&amp;lt;constant&amp;gt;VALUE_2&amp;lt;/constant&amp;gt;&amp;lt;/setHeader&amp;gt;&lt;br/&gt;
			&amp;lt;bean ref=&quot;MessageTester&quot; method=&quot;prettyPrintHeaders&quot;/&amp;gt;&lt;br/&gt;
			&amp;lt;bean ref=&quot;MessageTester&quot; method=&quot;setHeader&quot;/&amp;gt;&lt;br/&gt;
			&amp;lt;bean ref=&quot;MessageTester&quot; method=&quot;prettyPrintHeaders&quot;/&amp;gt;&lt;br/&gt;
			&amp;lt;to uri=&quot;log:route.log&quot;/&amp;gt;&lt;br/&gt;
		&amp;lt;/route&amp;gt;&lt;/p&gt;

&lt;p&gt;	&amp;lt;/camelContext&amp;gt;&lt;/p&gt;</comment>
                            <comment id="12946350" author="msjwhite" created="Thu, 30 Jul 2009 15:25:12 +0000"  >&lt;p&gt;And attached;&lt;/p&gt;

&lt;p&gt;1. the bean to print out headers from map and through getHeader()&lt;/p&gt;

&lt;p&gt;2. the log output &lt;/p&gt;</comment>
                            <comment id="12946355" author="davsclaus" created="Thu, 30 Jul 2009 15:42:50 +0000"  >&lt;p&gt;How do you send a message to the jms:IN_QUEUE ?&lt;/p&gt;</comment>
                            <comment id="12946358" author="davsclaus" created="Thu, 30 Jul 2009 15:59:51 +0000"  >&lt;p&gt;Added unit test to trunk where it works nicely: 799342.&lt;/p&gt;</comment>
                            <comment id="12946473" author="msjwhite" created="Thu, 30 Jul 2009 16:33:38 +0000"  >&lt;p&gt;We use a Spring test to wrap the route we&apos;re testing with other routes to generate input and trap output; &apos;direct:&apos; input and &apos;mock:&apos; outputs.  So we go through;&lt;/p&gt;

&lt;p&gt;So, say the route we&apos;re testing&lt;/p&gt;

&lt;p&gt;&amp;lt;route&amp;gt;&lt;br/&gt;
&amp;lt;from uri=&quot;jms:IN_QUEUE&quot;/&amp;gt;&lt;br/&gt;
...&lt;br/&gt;
&amp;lt;to uri=&quot;jms:OUT_QUEUE&quot;/&amp;gt;&lt;br/&gt;
&amp;lt;/route&amp;gt;&lt;/p&gt;

&lt;p&gt;and so the Spring test creates;&lt;/p&gt;

&lt;p&gt;from(&quot;direct:RouteTestProducer&quot;).to(&quot;jms:IN_QUEUE&quot;);&lt;br/&gt;
from(&quot;jms:OUT_QUEUE&quot;).to(&quot;mock:OutConsumer&quot;);&lt;br/&gt;
from(&quot;jms:ERROR&quot;).to(&quot;mock:ErrorConsumer&quot;)&lt;/p&gt;

&lt;p&gt;We then ProducerTemplate.send() to send an Exchange created from DefaultExchange.&lt;/p&gt;

&lt;p&gt;I&apos;ll look at the UnitTest and see if I can&apos;t reproduce through that somehow.&lt;/p&gt;</comment>
                            <comment id="12946868" author="msjwhite" created="Thu, 30 Jul 2009 17:36:40 +0000"  >&lt;p&gt;I tried running the tests against M3 and indeed the &apos;HEADER.1&apos; key is added to the message in M3 but not in trunk, so that appears to be an improvement.  But there is still a problem on the getHeader() in trunk.&lt;/p&gt;

&lt;p&gt;The unit test doesn&apos;t do enough to show - instead of testing the new header value, I changed it to test the change of the input header value, this then causes the error where getHeader(key) is returning a different value from getHeaders().get(key) and so test fails - code is attached.  I also added some output of the headers in my copy and you can see difference in the two values:&lt;/p&gt;

&lt;p&gt;--Start Message Headers (from getHeaders().get(key)) &amp;#8211;&lt;br/&gt;
HEADER_1=VALUE_2&lt;br/&gt;
-&lt;del&gt;End Message Headers&lt;/del&gt;-&lt;br/&gt;
--Start Message Headers (from getHeader(key)) &amp;#8211;&lt;br/&gt;
HEADER_1=VALUE_1&lt;br/&gt;
-&lt;del&gt;End Message Headers&lt;/del&gt;-&lt;/p&gt;</comment>
                            <comment id="12950073" author="msjwhite" created="Fri, 31 Jul 2009 14:04:03 +0000"  >&lt;p&gt;In JmsMessage the getHeader() always looks for the original message property and doesn&apos;t use message header map unless the header doesn&apos;t exist in the original;&lt;/p&gt;

&lt;p&gt;public Object getHeader(String name) {&lt;br/&gt;
...&lt;br/&gt;
            answer = jmsMessage.getObjectProperty(name);&lt;br/&gt;
...&lt;/p&gt;

&lt;p&gt;This dates back to the original implementation, but at that time the setHeader() also used jmsMessage.setObjectProperty(), so it probably made sense then.&lt;/p&gt;

&lt;p&gt;Why does the JmsMessage getHeader() still use the jmsMessage.getObjectProperty() to return the original value rather than the message value (which can be modified)?&lt;/p&gt;
</comment>
                            <comment id="12951077" author="davsclaus" created="Mon, 3 Aug 2009 09:28:49 +0000"  >&lt;p&gt;getHeader(String name) should also consider jms key format strategy so it can do lookup based on key decoded&lt;/p&gt;

&lt;p&gt;So you can lookup with &lt;tt&gt;Content-Type&lt;/tt&gt; and where the key has been decoded to &lt;tt&gt;Content_HYPHEN_Type&lt;/tt&gt;. That should be tested without the passthrough ket strategy but the default one.&lt;/p&gt;</comment>
                            <comment id="12951076" author="davsclaus" created="Mon, 3 Aug 2009 11:11:52 +0000"  >&lt;p&gt;Created &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-1871&quot; title=&quot;camel-jms - DefaultJmsKeyFormatStrategy should replace . with _DOT_ to avoid conflicting with end user using _&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-1871&quot;&gt;&lt;del&gt;CAMEL-1871&lt;/del&gt;&lt;/a&gt; to let Camel not mess with header keys using underscore, so it can preserve HEADER_1 out of the box.&lt;/p&gt;</comment>
                            <comment id="12951185" author="davsclaus" created="Tue, 4 Aug 2009 07:54:53 +0000"  >&lt;p&gt;trunk: 800694.&lt;/p&gt;</comment>
                            <comment id="12951184" author="davsclaus" created="Tue, 4 Aug 2009 07:56:17 +0000"  >&lt;p&gt;Mark can you test on your side by using latest code from SVN?&lt;/p&gt;

&lt;p&gt;I have just commit a fix to make:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;working with the headers consistent&lt;/li&gt;
	&lt;li&gt;you do not need to use the pass through strategy to be able to send HEADER_1 headers anymore. Camel handles that by default as well now (&lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-1871&quot; title=&quot;camel-jms - DefaultJmsKeyFormatStrategy should replace . with _DOT_ to avoid conflicting with end user using _&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-1871&quot;&gt;&lt;del&gt;CAMEL-1871&lt;/del&gt;&lt;/a&gt;)&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12951190" author="msjwhite" created="Wed, 5 Aug 2009 16:39:36 +0000"  >&lt;p&gt;Confirmed fixed in 2.0 trunk.&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12462756" name="JmsPassThroughtJmsKeyFormatStrategyTest.java" size="3397" author="msjwhite" created="Thu, 30 Jul 2009 17:36:40 +0000"/>
                            <attachment id="12462770" name="MessageTester.java" size="1856" author="msjwhite" created="Thu, 30 Jul 2009 15:25:12 +0000"/>
                            <attachment id="12462772" name="log.out" size="5831" author="msjwhite" created="Thu, 30 Jul 2009 15:25:12 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>76710</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            16 years, 16 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i01l27:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>7181</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>