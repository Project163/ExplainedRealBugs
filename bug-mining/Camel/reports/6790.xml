<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 11:06:21 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-20850] LRUCache evicts entries unexpectedly</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-20850</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;h1&gt;&lt;a name=&quot;Summary&quot;&gt;&lt;/a&gt;Summary&lt;/h1&gt;

&lt;p&gt;We encountered an infinite loop while downloading files using the SFTP endpoint.&lt;br/&gt;
During our investigation, we discovered the &lt;tt&gt;InProgressRepository&lt;/tt&gt; utilizing the &lt;tt&gt;SimpleLRUCache&lt;/tt&gt;. This cache incorporates an unconventional eviction implementation that involves a changes tracking queue.&lt;/p&gt;

&lt;p&gt;Any attempt to modify the cache, even when putting the same element, results in an increase in the cache size, potentially causing eviction to occur even for a single element.&lt;br/&gt;
The code is as follows:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;&amp;gt; lruCache = LRUCacheFactory.newLRUCache(1, 1);
&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; numberOfInserts = 0;
lruCache.put(&lt;span class=&quot;code-quote&quot;&gt;&quot;key&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;value&quot;&lt;/span&gt;);
&lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt;  (lruCache.size() &amp;gt; 0) {
      lruCache.put(&lt;span class=&quot;code-quote&quot;&gt;&quot;key&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;value&quot;&lt;/span&gt;);
      numberOfInserts++;
}
&lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IllegalStateException(&lt;span class=&quot;code-quote&quot;&gt;&quot;We should never reach &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; point, we inserted the same element &quot;&lt;/span&gt; + numberOfInserts + &lt;span class=&quot;code-quote&quot;&gt;&quot; times&quot;&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In the provided code, the failure occurs when the number of inserts reaches 2.&lt;/p&gt;

&lt;h1&gt;&lt;a name=&quot;ExpectedResult&quot;&gt;&lt;/a&gt;Expected Result&lt;/h1&gt;
&lt;p&gt;Utilize the LRU Cache limited only by the maximum size passed into it, rather than by some internal implementation limits.&lt;/p&gt;

&lt;h1&gt;&lt;a name=&quot;ProposedSolution&quot;&gt;&lt;/a&gt;Proposed Solution&lt;/h1&gt;
&lt;p&gt;Implement a standard LRUCache, say, by leveraging a &lt;tt&gt;LRUMap&lt;/tt&gt; from Apache Commons.&lt;br/&gt;
We may provide the PR later on.&lt;/p&gt;

&lt;h1&gt;&lt;a name=&quot;TheBackground&quot;&gt;&lt;/a&gt;The Background&lt;/h1&gt;
&lt;p&gt;We need to use a dynamic SFTP route (the download parameters depend on some configuration passed from the outside). By default, this is impossible, so we will have to use &lt;tt&gt;pollEnrich&lt;/tt&gt;:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
.pollEnrich().simple(SFTP_DYNAMIC_URI)
             .timeout(RETURN_CURRENT_RESULT_WITHOUT_WAIT)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The pollEnrich takes only one element (see &lt;tt&gt;GenericFilePollingConsumer&lt;/tt&gt;). The file consumer requests from the SFTP endpoint the list of all files, then takes the first, then gets the list again and takes the second file, and so on.&lt;/p&gt;

&lt;p&gt;The combination of &lt;tt&gt;InProgressRepository&lt;/tt&gt; and idempotent consumer is used to avoid handling the same files again.&lt;br/&gt;
However, every time the SFTP endpoint lists files, the endpoints and polling consumers adjust the list in the &lt;tt&gt;InProgressRepository&lt;/tt&gt;, thus affecting the &lt;tt&gt;SimpleLRUCache&lt;/tt&gt;.&lt;br/&gt;
The number of elements in the cache doesn&apos;t grow, however, the number of changes grows with almost n^2 speed.&lt;/p&gt;

&lt;p&gt;With the limit of 50k files, the SimpleLRUCache is evicted already on ~600&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/warning.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; files. This leads to an infinite loop while processing the files.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13581962">CAMEL-20850</key>
            <summary>LRUCache evicts entries unexpectedly</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="nfilotto">Nicolas Filotto</assignee>
                                    <reporter username="Nizametdinov">Timur</reporter>
                        <labels>
                    </labels>
                <created>Fri, 7 Jun 2024 14:23:33 +0000</created>
                <updated>Tue, 11 Jun 2024 17:16:59 +0000</updated>
                            <resolved>Tue, 11 Jun 2024 17:16:59 +0000</resolved>
                                    <version>4.0.3</version>
                    <version>4.2.0</version>
                                    <fixVersion>4.0.6</fixVersion>
                    <fixVersion>4.4.3</fixVersion>
                    <fixVersion>4.7.0</fixVersion>
                                    <component>came-core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17853183" author="davsclaus" created="Fri, 7 Jun 2024 14:54:44 +0000"  >&lt;p&gt;What version of Camel do you use&lt;/p&gt;</comment>
                            <comment id="17853193" author="JIRAUSER285918" created="Fri, 7 Jun 2024 15:35:53 +0000"  >&lt;p&gt;Thx for reporting let me check&lt;/p&gt;</comment>
                            <comment id="17853239" author="nizametdinov" created="Fri, 7 Jun 2024 18:05:45 +0000"  >&lt;p&gt;We use &lt;tt&gt;4.2.0&lt;/tt&gt;. I checked the latest version as well - the implementation is still the same.&lt;/p&gt;</comment>
                            <comment id="17853245" author="nizametdinov" created="Fri, 7 Jun 2024 18:14:31 +0000"  >&lt;p&gt;May I ask why the priority was set to Minor? Maybe not critical, as dynamic routes is not the most used case. Likely.&lt;/p&gt;

&lt;p&gt;But at least where dynamic routes are needed, the issue leads to infinite loops and might cause severe problems in other components.&lt;br/&gt;
At least if our hypothesis is correct.&lt;/p&gt;</comment>
                            <comment id="17853669" author="JIRAUSER285918" created="Mon, 10 Jun 2024 13:26:49 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Nizametdinov&quot; class=&quot;user-hover&quot; rel=&quot;Nizametdinov&quot;&gt;Nizametdinov&lt;/a&gt; could you please test with the fix in this PR &lt;a href=&quot;https://github.com/apache/camel/pull/14424&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/14424&lt;/a&gt; before I merge it? Or at least provide a use case to reproduce&lt;/p&gt;</comment>
                            <comment id="17853771" author="nizametdinov" created="Mon, 10 Jun 2024 18:23:22 +0000"  >&lt;p&gt;Actually, the snippet provided in the summary can be used as a reproducer.&lt;br/&gt;
Regarding end-to-end scenarios, we tested the change and it works!&lt;br/&gt;
Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nfilotto&quot; class=&quot;user-hover&quot; rel=&quot;nfilotto&quot;&gt;nfilotto&lt;/a&gt;!&lt;/p&gt;</comment>
                            <comment id="17853914" author="JIRAUSER285918" created="Tue, 11 Jun 2024 06:31:49 +0000"  >&lt;p&gt;Good news, thx for the feedback&lt;/p&gt;</comment>
                            <comment id="17854102" author="JIRAUSER285918" created="Tue, 11 Jun 2024 15:38:58 +0000"  >&lt;p&gt;Corresponding PRs:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;4.7 &lt;a href=&quot;https://github.com/apache/camel/pull/14424&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/14424&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;4.4 &lt;a href=&quot;https://github.com/apache/camel/pull/14482&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/14482&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;4.0 &lt;a href=&quot;https://github.com/apache/camel/pull/14483&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/14483&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13555338">CAMEL-20039</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 22 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1poko:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>