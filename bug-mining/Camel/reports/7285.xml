<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 11:13:04 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-22627] Camel fails graceful shutdown with wiretap/kamelet</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-22627</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;We have long running tasks and set a large grace period during termination to clear these. What we see is errors like:&lt;/p&gt;

&lt;p&gt;org.apache.camel.component.kamelet.KameletConsumerNotAvailableException: No consumers available on endpoint: kamelet://&amp;lt;removed&amp;gt;?&amp;lt;removed&amp;gt;&lt;/p&gt;

&lt;p&gt;The code around this is called from a wiretap:&lt;/p&gt;


&lt;p&gt;.wireTap( kamelet://&amp;lt;removed&amp;gt;?&amp;lt;removed&amp;gt;&quot;) like so.&#160; If I replace it with .toD then we do not see the issue.&#160;&#160;&lt;/p&gt;

&lt;p&gt;During normal operation the logs show:&lt;/p&gt;


&lt;p&gt;&lt;a href=&quot;#45 - WireTap&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;d #45 - WireTap&lt;/a&gt; o.a.c.i.e.AbstractCamelContext &#160; &#160; &#160; &#160; &#160; : kamelet://&amp;lt;redacted&amp;gt; converted to endpoint: kamelet://&amp;lt;redacted&amp;gt; by component: org.apache.camel.component.kamelet.KameletComponent@320aecd3&lt;br/&gt;
&lt;a href=&quot;#45 - WireTap&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;d #45 - WireTap&lt;/a&gt; o.a.c.s.s.BaseService$Holder &#160; &#160; &#160; &#160; &#160; &#160; : Starting service: kamelet://&amp;lt;redacted&amp;gt;&lt;br/&gt;
&lt;a href=&quot;#45 - WireTap&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;d #45 - WireTap&lt;/a&gt; o.a.c.s.s.BaseService$Holder &#160; &#160; &#160; &#160; &#160; &#160; : Started service: kamelet://&amp;lt;redacted&amp;gt;&lt;br/&gt;
&lt;a href=&quot;#45 - WireTap&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;d #45 - WireTap&lt;/a&gt; o.a.c.s.c.ServicePool &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;: Creating service from endpoint: kamelet://&amp;lt;redacted&amp;gt;&lt;/p&gt;

&lt;p&gt;If camel is shutting down then it forgoese any starting service calls:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;#46 - WireTap&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;d #46 - WireTap&lt;/a&gt; o.a.c.i.e.AbstractCamelContext &#160; &#160; &#160; &#160; &#160; : kamelet://&amp;lt;redacted&amp;gt; converted to endpoint: kamelet://&amp;lt;redacted&amp;gt; by component: org.apache.camel.component.kamelet.KameletComponent@3d1cb317&lt;br/&gt;
&lt;a href=&quot;#46 - WireTap&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;d #46 - WireTap&lt;/a&gt; o.a.c.s.c.ServicePool &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;: Creating service from endpoint: kamelet://&amp;lt;redacted&amp;gt;&lt;/p&gt;

&lt;p&gt;And then leads later to the KameletConsumerNotAvailableException.&#160;&lt;/p&gt;

&lt;p&gt;Which makes sense because the code around the starting only starts if camel is started and running from what I can see. However this means we cannot gracefully complete shutdown.&lt;/p&gt;

&lt;p&gt;I entered this as a bug because it seems to be a problem with wiretap/kamelets more specifically but advice regarding a work around for this would be appreciated.&#160; I havent managed to repeat this with non kamelets.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13632790">CAMEL-22627</key>
            <summary>Camel fails graceful shutdown with wiretap/kamelet</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="dvine">dvine</reporter>
                        <labels>
                    </labels>
                <created>Wed, 29 Oct 2025 15:50:10 +0000</created>
                <updated>Mon, 3 Nov 2025 13:13:53 +0000</updated>
                            <resolved>Sun, 2 Nov 2025 13:51:07 +0000</resolved>
                                    <version>4.15.0</version>
                                    <fixVersion>4.14.3</fixVersion>
                    <fixVersion>4.17.0</fixVersion>
                                    <component>camel-core</component>
                    <component>camel-kamelet</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="18033876" author="davsclaus" created="Wed, 29 Oct 2025 15:59:27 +0000"  >&lt;p&gt;put together a sample project / code that reproduces this and attach here as .zip or put somewhere on github&lt;/p&gt;</comment>
                            <comment id="18034388" author="JIRAUSER308825" created="Fri, 31 Oct 2025 12:26:59 +0000"  >&lt;p&gt;Sorry for the delay:&lt;/p&gt;

&lt;p&gt;Finally managed to make a simplified example.&#160; The problem seems is related to kamelets (I couldnt repeat with anything else), wiretap and also toD and dynamic paths.&lt;/p&gt;

&lt;p&gt;If you run the attached, wait for the log &quot;You can now init shutdown&quot;, close then you will see 1 item in flight. After the timer expires it will you will eventually see it leaps to 4 inflight and eventually &quot;org.apache.camel.component.kamelet.KameletConsumerNotAvailableException: No consumers available on endpoint: kamelet://testKamelet?dummy1=&amp;lt;UUID&amp;gt;. &quot;&#160;&lt;/p&gt;

&lt;p&gt;If UUID remains the same and the route has run once then it occur, hence the new UUID each time to force the error and also simulates our use case closer.&lt;/p&gt;

&lt;p&gt;You need to extend the shutdown grace period as well, we have 15 minutes to prevent forced shut down.&lt;/p&gt;

&lt;p&gt;Route: &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13079032/13079032_camelerror.txt&quot; title=&quot;camelerror.txt attached to CAMEL-22627&quot;&gt;camelerror.txt&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="18034768" author="davsclaus" created="Sat, 1 Nov 2025 17:35:01 +0000"  >&lt;p&gt;Thanks for the sample. This is a bit smaller&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&#160; &#160; from(&lt;span class=&quot;code-quote&quot;&gt;&quot;timer:simpleTimer?period=10000&quot;&lt;/span&gt;)
&#160; &#160; &#160; .routeId(&lt;span class=&quot;code-quote&quot;&gt;&quot;simple-timer-route&quot;&lt;/span&gt;)
&#160; &#160; &#160; .setHeader(&lt;span class=&quot;code-quote&quot;&gt;&quot;dummy&quot;&lt;/span&gt;, () -&amp;gt; UUID.randomUUID().toString())
&#160; &#160; &#160; .process(e -&amp;gt; {
&#160; &#160; &#160; &#160; log.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;You can now init shutdown&quot;&lt;/span&gt;);
&#160; &#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; 3; i++) {
&#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(2000);
&#160; &#160; &#160; &#160; &#160; log.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Waiting&quot;&lt;/span&gt;, i);
&#160; &#160; &#160; &#160; }
&#160; &#160; &#160; })
&#160; &#160; &#160; .toD(&lt;span class=&quot;code-quote&quot;&gt;&quot;kamelet:log-sink&quot;&lt;/span&gt;); &#160; &#160;&lt;span class=&quot;code-comment&quot;&gt;// DOESNT WORK
&lt;/span&gt; &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="18034818" author="davsclaus" created="Sun, 2 Nov 2025 08:58:10 +0000"  >&lt;p&gt;Okay this is also a really edge case that during graceful shutdown then you call a dynamic endpoint that is a kamelet, which then need to create a new route to process the message during shutdown.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="18035047" author="JIRAUSER308825" created="Mon, 3 Nov 2025 13:13:53 +0000"  >&lt;p&gt;Super, thanks!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13079032" name="camelerror.txt" size="1107" author="dvine" created="Fri, 31 Oct 2025 12:26:34 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 week, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1ycw0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>