<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:42:32 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-12971] SJMS Component javax.jms.JMSException: Unmatched acknowledge: MessageAck when transactionBatchTimeout expired</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-12971</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;We use Apache ActiveMQ 5.15.2 and Camel 2.20.2.&lt;br/&gt;
 When we switched to use camel-sjms instead of camel-jms we sometimes get this error:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2018-11-30 20:39:33,264 +0300 INFO  19 [TransactionContext] commit failed &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; transaction TX:ID:a-kachalov-61507-1543599563462-1:1:2
javax.jms.JMSException: COMMIT FAILED: Transaction marked rollback only xaErrorCode:100
	at org.apache.activemq.util.JMSExceptionSupport.create(JMSExceptionSupport.java:54) ~[activemq-client-5.15.2.jar:5.15.2]
	at org.apache.activemq.ActiveMQConnection.syncSendPacket(ActiveMQConnection.java:1399) ~[activemq-client-5.15.2.jar:?]
	at org.apache.activemq.ActiveMQConnection.syncSendPacket(ActiveMQConnection.java:1428) ~[activemq-client-5.15.2.jar:?]
	at org.apache.activemq.BatchSynchronizationReproduceTest$2.answer(BatchSynchronizationReproduceTest.java:66) ~[classes/:?]
	at org.apache.activemq.TransactionContext.commit(TransactionContext.java:330) ~[activemq-client-5.15.2.jar:?]
	at org.apache.activemq.ActiveMQSession.commit(ActiveMQSession.java:582) [activemq-client-5.15.2.jar:?]
	at org.apache.camel.component.sjms.tx.SessionBatchTransactionSynchronization$TimeoutTask.run(SessionBatchTransactionSynchronization.java:135) [camel-sjms-2.20.2.jar:2.20.2]
	at java.util.TimerThread.mainLoop(Timer.java:555) [?:1.8.0_73]
	at java.util.TimerThread.run(Timer.java:505) [?:1.8.0_73]
Caused by: javax.transaction.xa.XAException: COMMIT FAILED: Transaction marked rollback only xaErrorCode:100
	at org.apache.activemq.transaction.Transaction.newXAException(Transaction.java:213) ~[activemq-broker-5.15.2.jar:5.15.2]
	at org.apache.activemq.transaction.Transaction.prePrepare(Transaction.java:115) ~[activemq-broker-5.15.2.jar:5.15.2]
	at org.apache.activemq.transaction.LocalTransaction.commit(LocalTransaction.java:54) ~[activemq-broker-5.15.2.jar:5.15.2]
	at org.apache.activemq.broker.TransactionBroker.commitTransaction(TransactionBroker.java:252) ~[activemq-broker-5.15.2.jar:5.15.2]
	at org.apache.activemq.broker.BrokerFilter.commitTransaction(BrokerFilter.java:114) ~[activemq-broker-5.15.2.jar:5.15.2]
	at org.apache.activemq.broker.TransportConnection.processCommitTransactionOnePhase(TransportConnection.java:529) ~[activemq-broker-5.15.2.jar:5.15.2]
	at org.apache.activemq.command.TransactionInfo.visit(TransactionInfo.java:100) ~[activemq-client-5.15.2.jar:5.15.2]
	at org.apache.activemq.broker.TransportConnection.service(TransportConnection.java:330) ~[activemq-broker-5.15.2.jar:5.15.2]
	at org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:194) ~[activemq-broker-5.15.2.jar:5.15.2]
	at org.apache.activemq.transport.MutexTransport.onCommand(MutexTransport.java:50) ~[activemq-client-5.15.2.jar:5.15.2]
	at org.apache.activemq.transport.WireFormatNegotiator.onCommand(WireFormatNegotiator.java:125) ~[activemq-client-5.15.2.jar:5.15.2]
	at org.apache.activemq.transport.AbstractInactivityMonitor.onCommand(AbstractInactivityMonitor.java:301) ~[activemq-client-5.15.2.jar:5.15.2]
	at org.apache.activemq.transport.TransportSupport.doConsume(TransportSupport.java:83) ~[activemq-client-5.15.2.jar:5.15.2]
	at org.apache.activemq.transport.tcp.TcpTransport.doRun(TcpTransport.java:235) ~[activemq-client-5.15.2.jar:5.15.2]
	at org.apache.activemq.transport.tcp.TcpTransport.run(TcpTransport.java:216) ~[activemq-client-5.15.2.jar:5.15.2]
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745) ~[?:1.8.0_73]
Caused by: javax.jms.TransactionRolledBackException: COMMIT FAILED: Transaction marked rollback only xaErrorCode:100
	at org.apache.activemq.transaction.Transaction.prePrepare(Transaction.java:116) ~[activemq-broker-5.15.2.jar:5.15.2]
	at org.apache.activemq.transaction.LocalTransaction.commit(LocalTransaction.java:54) ~[activemq-broker-5.15.2.jar:5.15.2]
	at org.apache.activemq.broker.TransactionBroker.commitTransaction(TransactionBroker.java:252) ~[activemq-broker-5.15.2.jar:5.15.2]
	at org.apache.activemq.broker.BrokerFilter.commitTransaction(BrokerFilter.java:114) ~[activemq-broker-5.15.2.jar:5.15.2]
	at org.apache.activemq.broker.TransportConnection.processCommitTransactionOnePhase(TransportConnection.java:529) ~[activemq-broker-5.15.2.jar:5.15.2]
	at org.apache.activemq.command.TransactionInfo.visit(TransactionInfo.java:100) ~[activemq-client-5.15.2.jar:5.15.2]
	at org.apache.activemq.broker.TransportConnection.service(TransportConnection.java:330) ~[activemq-broker-5.15.2.jar:5.15.2]
	at org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:194) ~[activemq-broker-5.15.2.jar:5.15.2]
	at org.apache.activemq.transport.MutexTransport.onCommand(MutexTransport.java:50) ~[activemq-client-5.15.2.jar:5.15.2]
	at org.apache.activemq.transport.WireFormatNegotiator.onCommand(WireFormatNegotiator.java:125) ~[activemq-client-5.15.2.jar:5.15.2]
	at org.apache.activemq.transport.AbstractInactivityMonitor.onCommand(AbstractInactivityMonitor.java:301) ~[activemq-client-5.15.2.jar:5.15.2]
	at org.apache.activemq.transport.TransportSupport.doConsume(TransportSupport.java:83) ~[activemq-client-5.15.2.jar:5.15.2]
	at org.apache.activemq.transport.tcp.TcpTransport.doRun(TcpTransport.java:235) ~[activemq-client-5.15.2.jar:5.15.2]
	at org.apache.activemq.transport.tcp.TcpTransport.run(TcpTransport.java:216) ~[activemq-client-5.15.2.jar:5.15.2]
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745) ~[?:1.8.0_73]
Caused by: javax.jms.JMSException: Unmatched acknowledge: MessageAck {commandId = 9, responseRequired = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, ackType = 2, consumerId = ID:a-kachalov-61507-1543599563462-1:1:1:1, firstMessageId = ID:a-kachalov-61507-1543599563462-1:2:1:1:1, lastMessageId = ID:a-kachalov-61507-1543599563462-1:2:1:1:2, destination = queue:&lt;span class=&quot;code-comment&quot;&gt;//TEST.QUEUE, transactionId = TX:ID:a-kachalov-61507-1543599563462-1:1:2, messageCount = 2, poisonCause = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;}; Could not find Message-ID ID:a-kachalov-61507-1543599563462-1:2:1:1:1 in dispatched-list (start of ack)
&lt;/span&gt;	at org.apache.activemq.broker.region.PrefetchSubscription.assertAckMatchesDispatched(PrefetchSubscription.java:473) ~[activemq-broker-5.15.2.jar:5.15.2]
	at org.apache.activemq.broker.region.PrefetchSubscription.acknowledge(PrefetchSubscription.java:213) ~[activemq-broker-5.15.2.jar:5.15.2]
	at org.apache.activemq.broker.region.AbstractRegion.acknowledge(AbstractRegion.java:528) ~[activemq-broker-5.15.2.jar:5.15.2]
	at org.apache.activemq.broker.region.RegionBroker.acknowledge(RegionBroker.java:475) ~[activemq-broker-5.15.2.jar:5.15.2]
	at org.apache.activemq.broker.BrokerFilter.acknowledge(BrokerFilter.java:89) ~[activemq-broker-5.15.2.jar:5.15.2]
	at org.apache.activemq.broker.TransactionBroker.acknowledge(TransactionBroker.java:276) ~[activemq-broker-5.15.2.jar:5.15.2]
	at org.apache.activemq.broker.BrokerFilter.acknowledge(BrokerFilter.java:89) ~[activemq-broker-5.15.2.jar:5.15.2]
	at org.apache.activemq.broker.TransportConnection.processMessageAck(TransportConnection.java:581) ~[activemq-broker-5.15.2.jar:5.15.2]
	at org.apache.activemq.command.MessageAck.visit(MessageAck.java:245) ~[activemq-client-5.15.2.jar:5.15.2]
	at org.apache.activemq.broker.TransportConnection.service(TransportConnection.java:330) ~[activemq-broker-5.15.2.jar:5.15.2]
	at org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:194) ~[activemq-broker-5.15.2.jar:5.15.2]
	at org.apache.activemq.transport.MutexTransport.onCommand(MutexTransport.java:50) ~[activemq-client-5.15.2.jar:5.15.2]
	at org.apache.activemq.transport.WireFormatNegotiator.onCommand(WireFormatNegotiator.java:125) ~[activemq-client-5.15.2.jar:5.15.2]
	at org.apache.activemq.transport.AbstractInactivityMonitor.onCommand(AbstractInactivityMonitor.java:301) ~[activemq-client-5.15.2.jar:5.15.2]
	at org.apache.activemq.transport.TransportSupport.doConsume(TransportSupport.java:83) ~[activemq-client-5.15.2.jar:5.15.2]
	at org.apache.activemq.transport.tcp.TcpTransport.doRun(TcpTransport.java:235) ~[activemq-client-5.15.2.jar:5.15.2]
	at org.apache.activemq.transport.tcp.TcpTransport.run(TcpTransport.java:216) ~[activemq-client-5.15.2.jar:5.15.2]
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745) ~[?:1.8.0_73]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This happens because Batch Transaction Timer expires and commit is done in it own thread.&lt;br/&gt;
 We use a route such as&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
sjms:queue:TEST.QUEUE?transacted=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&amp;amp;transactionBatchCount=30&amp;amp;transactionBatchTimeout=1000
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Steps of reproducing:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;The first message is dispatched to&#160;consumer&lt;/li&gt;
	&lt;li&gt;Consumer waits the next message, but Timer expired and&#160;SessionBatchTransactionSynchronization.TimeoutTask executes in another thread and invokes commit() method&lt;/li&gt;
	&lt;li&gt;Commit consist of 3 operations: beforeEnd(), asyncSendPacket(...) and afterCommit() methods&lt;/li&gt;
	&lt;li&gt;When beforeEnd() finishes, transactionId is set to NULL, and consumer sends an acknowledgement to ActiveMQ via method ActiveMQConnection.asyncSendPacket.&lt;/li&gt;
	&lt;li&gt;While asyncSendPacket() is executing, new message can be&#160;dispatched&#160;to consumer&lt;/li&gt;
	&lt;li&gt;Because transactionId = null method TransactionContext.begin() produces new TransactionId in TransactionContext and set synchronizations list to NULL (but we remember that asyncSendPacket is still executing)&lt;/li&gt;
	&lt;li&gt;After asyncSendPacket() method finished afterCommit() method&#160;does nothing, because synchronizations = NULL, that means deliveredMessages collection with commited message of ActiveMQMessageConsumer&#160;can not be cleared&lt;/li&gt;
	&lt;li&gt;when Consumer sends the next acknowledgement, it sends acknowledgement for this message again, but ActimeMQ removed it before.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I wrote a test reproducing&#160;the error. Real case is more complex in production and now we can&apos;t use batch transactions with SJMS.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13201680">CAMEL-12971</key>
            <summary>SJMS Component javax.jms.JMSException: Unmatched acknowledge: MessageAck when transactionBatchTimeout expired</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="10101">Abandoned</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="alexeykachalov">Alexey Kachalov</reporter>
                        <labels>
                    </labels>
                <created>Fri, 30 Nov 2018 17:47:05 +0000</created>
                <updated>Tue, 4 Aug 2020 05:27:10 +0000</updated>
                            <resolved>Tue, 4 Aug 2020 05:11:21 +0000</resolved>
                                    <version>2.20.2</version>
                                    <fixVersion>3.4.3</fixVersion>
                    <fixVersion>3.5.0</fixVersion>
                                    <component>camel-sjms</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17169840" author="davsclaus" created="Mon, 3 Aug 2020 09:10:20 +0000"  >&lt;p&gt;Yeah I can see this gets complex as there dont seem to be a good neutral hook in the JMS API for being able to commit the transaction on timeout safely, without the session being used to receive another message.&lt;/p&gt;

&lt;p&gt;There may be some ActiveMQ specific API but then it should be in camel-activemq or some camel-activemq-sjms component that has special support for the old classic ActiveMQ broker.&lt;/p&gt;</comment>
                            <comment id="17170557" author="davsclaus" created="Tue, 4 Aug 2020 05:11:21 +0000"  >&lt;p&gt;Had to mark the feature as deprecated and added note in the docs.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12950216" name="BatchSynchronizationReproduceTest.java" size="4518" author="alexeykachalov" created="Fri, 30 Nov 2018 19:39:51 +0000"/>
                            <attachment id="12950197" name="test-result.log" size="19164" author="alexeykachalov" created="Fri, 30 Nov 2018 17:43:03 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 15 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|s011w8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>