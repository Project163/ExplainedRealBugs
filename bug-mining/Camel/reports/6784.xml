<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 11:06:15 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-20660] camel-azure-servicebus: Consumer fails to acknowledge messages</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-20660</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;We have observed issues with the Service Bus consumer from Camel 4.4+ where consumed messages are not acknowledged/completed correctly and landing in the dead-letter queue, despite the Exchange having successfully delivered the message to its destination.&lt;/p&gt;

&lt;p&gt;Our routes all follow the general form:&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;from(azureServicebus(...))&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; // ...&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; .to(https(...))&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; .log(&quot;Message delivered to...&quot;);&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;In our logs, we are seeing the message from the final &lt;tt&gt;log&lt;/tt&gt; EIP and we can confirm that the message has been delivered to the destination service, but this is often followed by a log message from the &lt;tt&gt;com.azure.messaging.servicebus.ServiceBusReceiverAsyncClient&lt;/tt&gt; logger:&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;Cannot perform operation &apos;completed&apos; on a disposed receiver.&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;We then see many of these messages arriving in the DLQ, once the retry count is exceeded.&lt;/p&gt;

&lt;p&gt;The issue is difficult to create a reproduction for: it is intermittent and occurs most frequently during a spike in message volumes.&lt;/p&gt;

&lt;p&gt;The issue disappears after downgrading Camel to 4.3.0.&lt;/p&gt;

&lt;p&gt;Whilst we do not know the root cause for sure, we suspect this may be a defect of &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-19262&quot; title=&quot;camel-azure-eventbus - Apache Camel wrapper for Service Bus stops receiving message.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-19262&quot;&gt;&lt;del&gt;CAMEL-19262&lt;/del&gt;&lt;/a&gt;, occurring if the client is closed and recreated while an Exchange is in flight.&lt;/p&gt;

&lt;p&gt;Related Zulip chat discussion: &lt;a href=&quot;https://camel.zulipchat.com/#narrow/stream/257298-camel/topic/Azure.20Service.20Bus.20Consumer.20failing.20to.20acknowledge.20messages&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://camel.zulipchat.com/#narrow/stream/257298-camel/topic/Azure.20Service.20Bus.20Consumer.20failing.20to.20acknowledge.20messages&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13575175">CAMEL-20660</key>
            <summary>camel-azure-servicebus: Consumer fails to acknowledge messages</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dlp">Dylan Piergies</assignee>
                                    <reporter username="dylan.piergies">Dylan Piergies</reporter>
                        <labels>
                    </labels>
                <created>Tue, 9 Apr 2024 12:45:52 +0000</created>
                <updated>Wed, 5 Jun 2024 09:24:49 +0000</updated>
                            <resolved>Wed, 5 Jun 2024 09:24:49 +0000</resolved>
                                    <version>4.4.0</version>
                    <version>4.4.1</version>
                    <version>4.5.0</version>
                                    <fixVersion>4.7.0</fixVersion>
                                    <component>camel-azure</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17838671" author="davsclaus" created="Thu, 18 Apr 2024 14:23:47 +0000"  >&lt;p&gt;Oh this is a bit hard to re-create the client while messages are inflight - then you may need to mark the client for dispose and then let last pending inflight close the client, or some background task that can try to close when no longer in use. Ideally there was some better connection pool from azure that could be used.&lt;/p&gt;</comment>
                            <comment id="17841121" author="davsclaus" created="Fri, 26 Apr 2024 09:34:53 +0000"  >&lt;p&gt;Try with 4.6.0 that has &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-20266&quot; title=&quot;camel-azure-eventbus - Use high-level client (ServiceBusProcessorClient)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-20266&quot;&gt;&lt;del&gt;CAMEL-20266&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17851737" author="dylan.piergies" created="Mon, 3 Jun 2024 17:18:55 +0000"  >&lt;p&gt;4.6.0 does resolve this issue, but we have a new issue whereby the callback to complete the message gets executed in a Reactor thread if the destination is another Service Bus queue/topic. This is an issue since the high-level synchronous client uses the async client under the hood and the completion results in an invocation of &lt;tt&gt;Mono#block&lt;/tt&gt;. Since invocation of &lt;tt&gt;Mono#block&lt;/tt&gt; is not allowed on a Reactor thread, this in turn fails with an exception such as:&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;2024-06-03 18:14:39,069 &lt;span class=&quot;error&quot;&gt;&amp;#91;ctor-executor-5&amp;#93;&lt;/span&gt; WARN UnitOfWorkHelper - Exception occurred during onCompletion. This exception will be ignored.&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;java.lang.IllegalStateException: block()/blockFirst()/blockLast() are blocking, which is not supported in thread reactor-executor-5&lt;/tt&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13562489">CAMEL-20266</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13576476">CAMEL-20693</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 23 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1oiuo:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>