<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:44:59 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-16005] Route built from template with parallel processing recipient list fails to start because of duplicate node id.</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-16005</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;Adding multiple route instances using a route template with a recipient list configured for &lt;em&gt;parallel processing&lt;/em&gt;, fails with a &lt;b&gt;FailedToStartRouteException&lt;/b&gt; when starting the second route instance, due to duplicate id on recipientList node.&lt;/p&gt;

&lt;p&gt;To reproduce, define a route template as following&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
routeTemplate(&lt;span class=&quot;code-quote&quot;&gt;&quot;myTemplate&quot;&lt;/span&gt;)
 .templateParameter(&lt;span class=&quot;code-quote&quot;&gt;&quot;input&quot;&lt;/span&gt;)
 .from(&lt;span class=&quot;code-quote&quot;&gt;&quot;direct:input&quot;&lt;/span&gt;)
 .recipientList(constant(&lt;span class=&quot;code-quote&quot;&gt;&quot;mock:a,mock:b&quot;&lt;/span&gt;)).parallelProcessing().end()
 .to(&lt;span class=&quot;code-quote&quot;&gt;&quot;mock:result&quot;&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;and then add multiple routes to the context&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
context.addRouteFromTemplate(&lt;span class=&quot;code-quote&quot;&gt;&quot;testRouteId1&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;myTemplate&quot;&lt;/span&gt;, Map.of(&lt;span class=&quot;code-quote&quot;&gt;&quot;input&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;a&quot;&lt;/span&gt;));
context.addRouteFromTemplate(&lt;span class=&quot;code-quote&quot;&gt;&quot;testRouteId2&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;myTemplate&quot;&lt;/span&gt;, Map.of(&lt;span class=&quot;code-quote&quot;&gt;&quot;input&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;b&quot;&lt;/span&gt;));&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;when Camel Context starts, the following exception is throw&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Caused by: org.apache.camel.FailedToStartRouteException: Failed to start route testRouteId2 because of duplicate id detected: recipientList1. Please correct ids to be unique among all your routes.
 at org.apache.camel.impl.DefaultCamelContext.startRouteDefinitions(DefaultCamelContext.java:581)
 at org.apache.camel.impl.DefaultCamelContext.startRouteDefinitions(DefaultCamelContext.java:557)
 at org.apache.camel.impl.engine.AbstractCamelContext.doInit(AbstractCamelContext.java:2642)
 at org.apache.camel.support.service.BaseService.init(BaseService.java:83)
 at org.apache.camel.impl.engine.AbstractCamelContext.init(AbstractCamelContext.java:2414)
 at org.apache.camel.support.service.BaseService.start(BaseService.java:111)
 at org.apache.camel.impl.engine.AbstractCamelContext.start(AbstractCamelContext.java:2431)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;br/&gt;
 This happens with Camel 3.7, but not with 3.6. It seems to me that the problem may be in the new implementation of &lt;b&gt;DefaultExecutorServiceManager.forceId&lt;/b&gt;;&lt;br/&gt;
 on camel 3.6 the method was defined as&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; forceId(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; source) {
  &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (source &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; OptionalIdentifiedDefinition) { 
    NodeIdFactory factory = getCamelContext().adapt(ExtendedCamelContext.class).getNodeIdFactory();
    ((OptionalIdentifiedDefinition) source).idOrCreate(factory); 
  }
  &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; source;
 }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;in 3.7 the implementation is&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; forceId(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; source) {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (source &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; NamedNode &amp;amp;&amp;amp; source &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; IdAware) {
        NamedNode node = (NamedNode) source;
        NodeIdFactory factory = getCamelContext().adapt(ExtendedCamelContext.class).getNodeIdFactory();
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (node.getId() == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) { 
            &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; id = factory.createId(node);
            ((IdAware) source).setId(id); 
       }
    }
 &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; source;
 }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The main difference I noticed here is that using &lt;b&gt;idOrCreate&lt;/b&gt; on source object does not set the internal &lt;b&gt;customId&lt;/b&gt;&#160;flag, whereas &lt;b&gt;setId&lt;/b&gt;&#160;sets the flag to true.&lt;br/&gt;
 if I have correctly understood, &lt;b&gt;RouteDefinitionHelper.validateUniqueIds&lt;/b&gt;&#160;only takes care of custom ids when searching for duplicates, so using &lt;b&gt;setId&lt;/b&gt;&#160;may be the culprit&lt;br/&gt;
 of the problem.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Attached source code to reproduce the error&lt;/p&gt;</description>
                <environment></environment>
        <key id="13350948">CAMEL-16005</key>
            <summary>Route built from template with parallel processing recipient list fails to start because of duplicate node id.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="mcollovati">Marco Collovati</reporter>
                        <labels>
                    </labels>
                <created>Thu, 7 Jan 2021 18:43:46 +0000</created>
                <updated>Fri, 8 Jan 2021 10:37:53 +0000</updated>
                            <resolved>Fri, 8 Jan 2021 10:37:53 +0000</resolved>
                                    <version>3.7.0</version>
                                    <fixVersion>3.7.1</fixVersion>
                    <fixVersion>3.8.0</fixVersion>
                                    <component>camel-core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17260806" author="davsclaus" created="Thu, 7 Jan 2021 20:38:49 +0000"  >&lt;p&gt;Oh very good catch. You are welcome to provide a PR with a fix. Yes the fix should be to use idOrCreate so it assings customId = true.&lt;br/&gt;
And you are welcome to include the unit test in the PR.&lt;/p&gt;</comment>
                            <comment id="17261073" author="mcollovati" created="Fri, 8 Jan 2021 07:31:38 +0000"  >&lt;p&gt;I would be glad to create a PR, but I need some help.&lt;br/&gt;
&lt;b&gt;IdAware&lt;/b&gt; interface does not expose a &lt;b&gt;idOrCreate&lt;/b&gt;&#160;method, so I can see one of this options:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;revert to the former &lt;b&gt;forceId&lt;/b&gt; implementation&lt;/li&gt;
	&lt;li&gt;add &lt;b&gt;idOrCreate&lt;/b&gt;&#160;method to the &lt;b&gt;IdAware&lt;/b&gt;&#160;interface&lt;/li&gt;
	&lt;li&gt;introduce a new interface for &lt;b&gt;idOrCreate&lt;/b&gt;&#160;method and handle it in &lt;b&gt;forceId&lt;/b&gt;&#160;togheter with &lt;b&gt;IdAware&lt;/b&gt;&lt;/li&gt;
	&lt;li&gt;simply add an additional instance check for &lt;b&gt;OptionalIdentifiedDefinition&lt;/b&gt;&#160;to actual &lt;b&gt;forceId&lt;/b&gt;&#160;method, and invoke &lt;b&gt;idOrCreate&lt;/b&gt;&#160;or &lt;b&gt;setId&lt;/b&gt;&#160;accordingly.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I don&apos;t like very much option one and two. I think the last option will be the one with less impact on existing code, but it couples the fix to a specific class (&lt;b&gt;OptionalIdentifiedDefinition&lt;/b&gt;); the third one may be a better fit and may leave doors open to fix similar cases on other type of &lt;b&gt;source&lt;/b&gt; objects, but requires a bit more work.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davsclaus&quot; class=&quot;user-hover&quot; rel=&quot;davsclaus&quot;&gt;davsclaus&lt;/a&gt; , maybe you have a better solution in mind; can you give me some advice?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17261152" author="davsclaus" created="Fri, 8 Jan 2021 09:13:26 +0000"  >&lt;p&gt;Thanks Marco.&lt;/p&gt;

&lt;p&gt;Yeah I looked into this, and I am adding a setGeneatedId method on IdAware so we can use this method instead to know it was an auto assigned ID. &lt;/p&gt;

&lt;p&gt;You are welcome to create a PR with your unit test so we have that to help test my change.&lt;/p&gt;</comment>
                            <comment id="17261169" author="davsclaus" created="Fri, 8 Jan 2021 09:40:01 +0000"  >&lt;p&gt;Ah okay there is actually a bit more to this - the auto assigned ids, should be scrubbed before a route is created from the template, as currently it mistakenly would reuse pervious auto assigned ids, that cause the clash, but its often not a problem. But would be if you use JMX etc.&lt;/p&gt;</comment>
                            <comment id="17261180" author="mcollovati" created="Fri, 8 Jan 2021 09:49:59 +0000"  >&lt;p&gt;You&apos;re right. This was a concern I forgot to mention.&lt;/p&gt;</comment>
                            <comment id="17261210" author="davsclaus" created="Fri, 8 Jan 2021 10:37:53 +0000"  >&lt;p&gt;Thanks its fixed now&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13018330" name="TemplateRouteTest.java" size="1288" author="mcollovati" created="Thu, 7 Jan 2021 18:41:59 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 44 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0md34:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>