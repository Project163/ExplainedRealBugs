<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 09:58:51 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-6447] endChoice() has no effect in nested choice definition</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-6447</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;I just upgraded from 2.10.4 to 2.11.0 and noticed that nested choice definitions started acting strangely. For example:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;            .choice()
                .when(header(Exchange.EXCEPTION_CAUGHT).isNotNull())
                    &lt;span class=&quot;code-comment&quot;&gt;// 1
&lt;/span&gt;                    .setBody(exceptionMessage().append(SystemUtils.LINE_SEPARATOR).append(exceptionStackTrace()))
                    .choice()
                        .when(header(HEADER_CONTROLLER_ID).isNotNull())
                            &lt;span class=&quot;code-comment&quot;&gt;// 1a
&lt;/span&gt;                            .setHeader(Exchange.FILE_NAME, simple(AUDIT_CONTROLLER_FAILED_FILENAME + &lt;span class=&quot;code-quote&quot;&gt;&quot;.error.log&quot;&lt;/span&gt;))
                            .to(ENDPOINT_AUDIT_DIR)
                        .otherwise()
                            &lt;span class=&quot;code-comment&quot;&gt;// 1b
&lt;/span&gt;                            .setHeader(Exchange.FILE_NAME, simple(AUDIT_FAILED_FILENAME + &lt;span class=&quot;code-quote&quot;&gt;&quot;.error.log&quot;&lt;/span&gt;))
                            .to(ENDPOINT_AUDIT_DIR)
                            &lt;span class=&quot;code-comment&quot;&gt;// INSERTING .end() here solves the issue
&lt;/span&gt;                        .endChoice()
                    .log(LoggingLevel.WARN, &lt;span class=&quot;code-quote&quot;&gt;&quot;DLQ written: ${in.header.CamelExceptionCaught}&quot;&lt;/span&gt;
                .otherwise()
                    &lt;span class=&quot;code-comment&quot;&gt;// 2
&lt;/span&gt;                    .log(LoggingLevel.WARN, &lt;span class=&quot;code-quote&quot;&gt;&quot;DLQ written&quot;&lt;/span&gt; + MESSAGE_LOG_FORMAT)
                .end()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I have a test that is supposed to go through 1 and 1a. However it now passes through 1 and 2!&lt;br/&gt;
It looks like the endChoice() in 1b has no effect and the otherwise() in 2 is executed instead of 1b. Inserting and end() statement as shown seems to solve the issue, but it looks suspicious.&lt;/p&gt;

&lt;p&gt;It&apos;s probably a regression introduced by the fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-5953&quot; title=&quot;Java DSL: unmarshal() inside choice() blocks adding more conditions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-5953&quot;&gt;&lt;del&gt;CAMEL-5953&lt;/del&gt;&lt;/a&gt;, but I&apos;m not 100% sure. &lt;/p&gt;</description>
                <environment></environment>
        <key id="12652166">CAMEL-6447</key>
            <summary>endChoice() has no effect in nested choice definition</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="syberyan">Christian Tytgat</reporter>
                        <labels>
                    </labels>
                <created>Tue, 11 Jun 2013 07:22:47 +0000</created>
                <updated>Thu, 22 Aug 2013 20:42:16 +0000</updated>
                            <resolved>Thu, 22 Aug 2013 20:38:27 +0000</resolved>
                                    <version>2.11.0</version>
                                    <fixVersion>2.11.2</fixVersion>
                    <fixVersion>2.12.0</fixVersion>
                                    <component>camel-core</component>
                        <due></due>
                            <votes>2</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="13736725" author="robinbezuijen" created="Mon, 12 Aug 2013 09:59:08 +0000"  >&lt;p&gt;It looks like this issue was introduced in 2.10.4&lt;/p&gt;

&lt;p&gt;The problem is that adding the end() before the endChoice() will only work for 2.10.4 and above because it will break when using 2.10.3 with the following exception:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;org.springframework.beans.factory.BeanCreationException: Error creating bean with name &lt;span class=&quot;code-quote&quot;&gt;&apos;test-route&apos;&lt;/span&gt;: Invocation of init method failed; nested exception is java.lang.ClassCastException: org.apache.camel.model.RouteDefinition cannot be &lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt; to org.apache.camel.model.ChoiceDefinition
	at org.apache.camel.model.ProcessorDefinition.endChoice(ProcessorDefinition.java:1256)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

</comment>
                            <comment id="13744996" author="dalewking" created="Tue, 20 Aug 2013 14:19:42 +0000"  >&lt;p&gt;I see a slightly different but probably related problem. Here is a simple route to test it:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;    &amp;lt;route&amp;gt;
        &amp;lt;from uri=&quot;timer://myTimer?period=1&amp;amp;amp;repeatCount=1&quot; /&amp;gt;
        &amp;lt;setHeader headerName=&quot;test&quot;&amp;gt;
            &amp;lt;constant&amp;gt;1&amp;lt;/constant&amp;gt;
        &amp;lt;/setHeader&amp;gt;
        &amp;lt;choice&amp;gt;
            &amp;lt;when&amp;gt;
                &amp;lt;simple&amp;gt;${header.test} &amp;amp;gt; 0&amp;lt;/simple&amp;gt;
                &amp;lt;choice&amp;gt;
                    &amp;lt;when&amp;gt;
                        &amp;lt;simple&amp;gt;${header.test} &amp;amp;gt; 5&amp;lt;/simple&amp;gt;
                        &amp;lt;log message=&quot;Should not get here&quot; /&amp;gt;
                    &amp;lt;/when&amp;gt;
                    &amp;lt;otherwise&amp;gt;
                        &amp;lt;log message=&quot;Should get here&quot; /&amp;gt;
                    &amp;lt;/otherwise&amp;gt;
                &amp;lt;/choice&amp;gt;
            &amp;lt;/when&amp;gt;
            &amp;lt;otherwise&amp;gt;
                &amp;lt;log message=&quot;Why do I get here???&quot; /&amp;gt;
            &amp;lt;/otherwise&amp;gt;
        &amp;lt;/choice&amp;gt;
    &amp;lt;/route&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The output is:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;    Should get here 
    Why do I get here???
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So it executes both otherwise clauses, which is definitely wrong. I realize that the nesting is not necessary in this simple example, but where I found it, the inner choice was within a split and could not be eliminated. The outer choice was to actually handle the case for when the split would have nothing to split.&lt;/p&gt;</comment>
                            <comment id="13747871" author="davsclaus" created="Thu, 22 Aug 2013 20:42:16 +0000"  >&lt;p&gt;The problem mentioned by Dale, was caused by &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-6364&quot; title=&quot;Improve processors wrapping&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-6364&quot;&gt;&lt;del&gt;CAMEL-6364&lt;/del&gt;&lt;/a&gt;] and only affected trunk (eg 2.12). This has been fixed now.&lt;/p&gt;

&lt;p&gt;The endChoice has been fixed on both trunk and 2.11 branch.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>332490</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 13 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1lcwf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>332819</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310080" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Regression</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10091"><![CDATA[Regression]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>