<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 09:58:15 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-6452] FileUtil.getDefaultTempDir() causes a classloader leak in webapps</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-6452</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;FileUtil.getDefaultTempDir() registers a JVM shutdown hook to delete the temporary directory it creates. We are using camel in a web application in Tomcat that gets dynamically reloaded as updates are available, so the JVM is normally never shut down. This is causing &apos;camel-tmp-*&apos; directories to linger in $CATALINA_HOME/temp, and - more importantly - classloader leaks, which are a major problem for us.&lt;/p&gt;

&lt;p&gt;If the thread that gets registered as the shutdown hook were stored in a class variable, I could unregister it when the application is being unloaded.&lt;/p&gt;</description>
                <environment>&lt;p&gt;tomcat 7, spring 3.2&lt;/p&gt;</environment>
        <key id="12652556">CAMEL-6452</key>
            <summary>FileUtil.getDefaultTempDir() causes a classloader leak in webapps</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="sanjayd">Sanjay Deshmukh</reporter>
                        <labels>
                    </labels>
                <created>Thu, 13 Jun 2013 04:29:32 +0000</created>
                <updated>Wed, 17 Jul 2013 11:41:53 +0000</updated>
                            <resolved>Wed, 17 Jul 2013 11:41:53 +0000</resolved>
                                    <version>2.10.4</version>
                                    <fixVersion>2.10.7</fixVersion>
                    <fixVersion>2.11.2</fixVersion>
                    <fixVersion>2.12.0</fixVersion>
                                    <component>camel-core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13682810" author="sanjayd" created="Thu, 13 Jun 2013 21:57:33 +0000"  >&lt;p&gt;Patch to fix issue&lt;/p&gt;</comment>
                            <comment id="13682948" author="njiang" created="Fri, 14 Jun 2013 00:35:56 +0000"  >&lt;p&gt;Hi Sanjay,&lt;/p&gt;

&lt;p&gt;I just have a quick look of the path, it looks like you add a cleanup to the FileUtil, but I didn&apos;t found the place where you call it. &lt;br/&gt;
Can you give us more detail about unload the application?&lt;/p&gt;

&lt;p&gt;Willem&lt;/p&gt;</comment>
                            <comment id="13683022" author="sanjayd" created="Fri, 14 Jun 2013 02:34:19 +0000"  >&lt;p&gt;Hey Willem,&lt;/p&gt;

&lt;p&gt;I had planned on leaving it up to the application to call this method when it is unloaded from the app container. I suppose it could also be called from the shutdown routine of a CamelContext, but then that assumes that the app only has one context.&lt;/p&gt;

&lt;p&gt;The problem I&apos;m running into is basically that any webapp that runs in an app container and expects to be periodically reloaded will register a new shutdown hook in the same JVM each time the app is loaded. Unless these hooks are removed when each instance is unloaded, all the classloaders will remain in memory and the app container will eventually run out of PermGen space.&lt;/p&gt;

&lt;p&gt;Adding this optional cleanup method will enable apps that run in an app container to remove their shutdown hook on their own so their classloaders can be garbage collected, and the app container can continue on. Those apps who expect the JVM to terminate when they are finished executing won&apos;t have to call it, and they will continue working as they do now.&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;

&lt;p&gt;Sanjay&lt;/p&gt;</comment>
                            <comment id="13683135" author="davsclaus" created="Fri, 14 Jun 2013 06:22:36 +0000"  >&lt;p&gt;First thanks for reporting this issue with the leak.&lt;/p&gt;

&lt;p&gt;I think a better approach is to add a UtilService class in the util package. This class should extends ServiceSupport from the support package. Then we register this as a service to DefaultCamelContext in its doStartCamel() method.&lt;/p&gt;

&lt;p&gt;Then we have callbacks for doStart / doStop in the UtilService class where we can do out needed logic, when Camel is starting / stopping.&lt;/p&gt;

&lt;p&gt;This also means the default temp dir logic should be &lt;b&gt;per CamelContext&lt;/b&gt; instead of &lt;b&gt;per JVM&lt;/b&gt;. This also works much better in WAR containers / OSGi containers et all; where people can hot and redeploy apps. Having JVM hooks and static classes that are initialized with a == null check is (becoming) a bad practice IMHO.&lt;/p&gt;
</comment>
                            <comment id="13683150" author="davsclaus" created="Fri, 14 Jun 2013 06:50:13 +0000"  >&lt;p&gt;Well even better this FileUtil temp dir logic is only used when stream caching is enabled. We should ideally IMHO have StreamCaching setup its temp dir it want to use, and cleanup it as well. And remove the logic from the FileUtil so its not required to delete using a JVM shutdown hook.&lt;/p&gt;

&lt;p&gt;Then we should also make configuring this on stream caching easier and more &quot;Camelish&quot; as today you set some properties on CamelContext. Instead of using a &amp;lt;streamCache tempDir=&quot;xxx&quot; threshold=&quot;64mb&quot; xxx/&amp;gt; or something. And then we should expose this in JMX so people can see StreamCacheService in JMX and how its configured. And maybe even reconfigured it at runtime etc.&lt;/p&gt;</comment>
                            <comment id="13684235" author="sanjayd" created="Sat, 15 Jun 2013 16:24:38 +0000"  >&lt;p&gt;Awesome - that gives me a lot more context and definitely sounds like the way to go. I like the per-context or per-streamcache temp dir that gets removed when the context or cache shuts down.&lt;/p&gt;

&lt;p&gt;In the meantime, in case anyone else runs into this issue, here&apos;s the workaround (i.e. hack) that I added to the cleanup routine of our project:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void cleanShutdownHook() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
        &lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;&amp;lt;?&amp;gt; klass = &lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;.forName(&lt;span class=&quot;code-quote&quot;&gt;&quot;java.lang.ApplicationShutdownHooks&quot;&lt;/span&gt;);
        Field field = klass.getDeclaredField(&lt;span class=&quot;code-quote&quot;&gt;&quot;hooks&quot;&lt;/span&gt;);
        field.setAccessible(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);

        @SuppressWarnings(&lt;span class=&quot;code-quote&quot;&gt;&quot;unchecked&quot;&lt;/span&gt;)
        Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;&amp;gt; hooks = (Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;&amp;gt;) field.get(&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
        &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; target = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; thread: hooks.values()) {
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (thread.getClass().getName().equals(&lt;span class=&quot;code-quote&quot;&gt;&quot;org.apache.camel.util.FileUtil$1&quot;&lt;/span&gt;)) {
                target = thread;
                &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
            }
        }

        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (target != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
            &lt;span class=&quot;code-object&quot;&gt;Runtime&lt;/span&gt;.getRuntime().removeShutdownHook(target);
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13710992" author="davsclaus" created="Wed, 17 Jul 2013 11:41:53 +0000"  >&lt;p&gt;Thanks for the patch.&lt;/p&gt;

&lt;p&gt;There is a static shutdown method on FileUtil you can use to cleanup this in 2.11 and 2.10 releases.&lt;/p&gt;

&lt;p&gt;For Camel 2.12 we introduce StreamCachingStrategy that handles this out of the box, and avoid using static stuff etc. So it becomes per CamelContext instead.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310051">
                    <name>Supercedes</name>
                                                                <inwardlinks description="is superceded by">
                                        <issuelink>
            <issuekey id="12654141">CAMEL-6476</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12587716" name="0001-Fixed-CAMEL-6452-by-adding-a-cleanup-routine-to-remo.patch" size="2810" author="sanjayd" created="Thu, 13 Jun 2013 21:57:33 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>332880</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 18 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1lfan:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>333208</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>