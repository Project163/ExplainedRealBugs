<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:25:56 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-10225] Camel-Saxon is not thread safe</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-10225</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>
&lt;p&gt;We perform an XSLT transform within a Split. We added camel-saxon so that we could use XSLT 2 for one particular transformation. This works fine when run synchronously but when we switch parallel to true on the split we get the following errors:-&lt;/p&gt;

&lt;p&gt;2016-08-07T16:09:02,142 &lt;a href=&quot;#4 - Split&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Camel (camel-1) thread #4 - Split&lt;/a&gt; ERROR org.apache.camel.processor.DefaultErrorHandler |  |  |  |  &lt;br/&gt;
 Failed delivery for (MessageId: ID-dave-ThinkPad-Edge-E540-35771-1470582541027-0-27 on ExchangeId: ID-dave-ThinkPad-Edge-E540-35771-1470582541027-0-32). Exhausted after delivery attempt: 1 caught: org.apache.camel.TypeConversionException: Error during type conversion from type: java.lang.String to the required type: java.lang.String with value &amp;lt;OrderResponseItem xmlns=&quot;http://api.channeladvisor.com/webservices/&quot; xmlns:q3=&quot;http://api.channeladvisor.com/datacontracts/orders&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:type=&quot;q3:OrderResponseDetailComplete&quot;&amp;gt;&lt;br/&gt;
                &amp;lt;q3:NumberOfMatches&amp;gt;3&amp;lt;/q3:NumberOfMatches&amp;gt;&lt;br/&gt;
                &amp;lt;q3:OrderTimeGMT&amp;gt;2016-07-04T08:07:38.893&amp;lt;/q3:OrderTimeGMT&amp;gt;&lt;br/&gt;
                &amp;lt;q3:LastUpdateDate&amp;gt;2016-07-04T08:07:40.217&amp;lt;/q3:LastUpdateDate&amp;gt;&lt;br/&gt;
                &amp;lt;q3:TotalOrderAmount&amp;gt;357.0000&amp;lt;/q3:TotalOrderAmount&amp;gt;&lt;br/&gt;
                &amp;lt;q3:OrderState&amp;gt;Active&amp;lt;/q3:OrderState&amp;gt;&lt;br/&gt;
                &amp;lt;q3:DateCancelledGMT xsi:nil=&quot;true&quot;/&amp;gt;&lt;br/&gt;
                &amp;lt;q3:OrderID&amp;gt;9564205&amp;lt;/q3:OrderID&amp;gt;&lt;br/&gt;
                &amp;lt;q3:ClientOrderIdentifier&amp;gt;1000008&amp;lt;/q3:ClientOrderIdentifier&amp;gt;&lt;br/&gt;
                &amp;lt;q3:SellerOrderID/&amp;gt;&lt;br/&gt;
                &amp;lt;q3:OrderStatus&amp;gt;&lt;br/&gt;
                    &amp;lt;q3:CheckoutStatus&amp;gt;Completed&amp;lt;/q3:CheckoutStatus&amp;gt;&lt;br/&gt;
                    &amp;lt;q3:CheckoutDateGMT&amp;gt;2016-07-04T08:07:38.893&amp;lt;/q3:CheckoutDateGMT&amp;gt;&lt;br/&gt;
                    &amp;lt;q3:PaymentSt... &lt;span class=&quot;error&quot;&gt;&amp;#91;Body clipped after 1000 chars, total length is 14996&amp;#93;&lt;/span&gt; due java.lang.NullPointerException. Processed by failure processor: FatalFallbackErrorHandler[Channel[Log(route2)&lt;span class=&quot;error&quot;&gt;&amp;#91;Error processing route: ${exception.stacktrace}&amp;#93;&lt;/span&gt;]]&lt;/p&gt;

&lt;p&gt;Message History&lt;br/&gt;
---------------------------------------------------------------------------------------------------------------------------------------&lt;br/&gt;
RouteId              ProcessorId          Processor                                                                        Elapsed (ms)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;route1            &amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;route1            &amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;direct://in                                                                   &amp;#93;&lt;/span&gt; [       378]&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;route1            &amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;to1               &amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;direct:transformOrderResponseItemToConsignmentRoute                           &amp;#93;&lt;/span&gt; [        12]&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;route2            &amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;log5              &amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;log                                                                           &amp;#93;&lt;/span&gt; [        11]&lt;br/&gt;
[                  ] &lt;span class=&quot;error&quot;&gt;&amp;#91;GeneralExceptionLo&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;log                                                                           &amp;#93;&lt;/span&gt; [         3]&lt;/p&gt;

&lt;p&gt;Stacktrace&lt;br/&gt;
--------------------------------------------------------------------------------------------------------------------------------------- &lt;br/&gt;
org.apache.camel.TypeConversionException: Error during type conversion from type: java.lang.String to the required type: java.lang.String with value &amp;lt;OrderResponseItem xmlns=&quot;http://api.channeladvisor.com/webservices/&quot; xmlns:q3=&quot;http://api.channeladvisor.com/datacontracts/orders&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:type=&quot;q3:OrderResponseDetailComplete&quot;&amp;gt;&lt;br/&gt;
                &amp;lt;q3:NumberOfMatches&amp;gt;3&amp;lt;/q3:NumberOfMatches&amp;gt;&lt;br/&gt;
                &amp;lt;q3:OrderTimeGMT&amp;gt;2016-07-04T08:07:38.893&amp;lt;/q3:OrderTimeGMT&amp;gt;&lt;br/&gt;
                &amp;lt;q3:LastUpdateDate&amp;gt;2016-07-04T08:07:40.217&amp;lt;/q3:LastUpdateDate&amp;gt;&lt;br/&gt;
                &amp;lt;q3:TotalOrderAmount&amp;gt;357.0000&amp;lt;/q3:TotalOrderAmount&amp;gt;&lt;br/&gt;
                &amp;lt;q3:OrderState&amp;gt;Active&amp;lt;/q3:OrderState&amp;gt;&lt;br/&gt;
                &amp;lt;q3:DateCancelledGMT xsi:nil=&quot;true&quot;/&amp;gt;&lt;br/&gt;
                &amp;lt;q3:OrderID&amp;gt;9564205&amp;lt;/q3:OrderID&amp;gt;&lt;br/&gt;
                &amp;lt;q3:ClientOrderIdentifier&amp;gt;1000008&amp;lt;/q3:ClientOrderIdentifier&amp;gt;&lt;br/&gt;
                &amp;lt;q3:SellerOrderID/&amp;gt;&lt;br/&gt;
                &amp;lt;q3:OrderStatus&amp;gt;&lt;br/&gt;
                    &amp;lt;q3:CheckoutStatus&amp;gt;Completed&amp;lt;/q3:CheckoutStatus&amp;gt;&lt;br/&gt;
                    &amp;lt;q3:CheckoutDateGMT&amp;gt;2016-07-04T08:07:38.893&amp;lt;/q3:CheckoutDateGMT&amp;gt;&lt;br/&gt;
                    &amp;lt;q3:PaymentSt... &lt;span class=&quot;error&quot;&gt;&amp;#91;Body clipped after 1000 chars, total length is 14996&amp;#93;&lt;/span&gt; due java.lang.NullPointerException&lt;br/&gt;
	at org.apache.camel.impl.converter.BaseTypeConverterRegistry.createTypeConversionException(BaseTypeConverterRegistry.java:629) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.17.2.jar:2.17.2&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.camel.impl.converter.BaseTypeConverterRegistry.convertTo(BaseTypeConverterRegistry.java:150) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.17.2.jar:2.17.2&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.camel.support.ExpressionAdapter.evaluate(ExpressionAdapter.java:41) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.17.2.jar:2.17.2&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.camel.builder.ExpressionBuilder$64.evaluate(ExpressionBuilder.java:1533) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.17.2.jar:2.17.2&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.camel.support.ExpressionAdapter.evaluate(ExpressionAdapter.java:36) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.17.2.jar:2.17.2&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.camel.processor.LogProcessor.process(LogProcessor.java:53) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.17.2.jar:2.17.2&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.camel.processor.RedeliveryErrorHandler.process(RedeliveryErrorHandler.java:468) &lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.17.2.jar:2.17.2&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.camel.processor.CamelInternalProcessor.process(CamelInternalProcessor.java:190) &lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.17.2.jar:2.17.2&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.camel.processor.Pipeline.process(Pipeline.java:121) &lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.17.2.jar:2.17.2&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.camel.processor.Pipeline.process(Pipeline.java:83) &lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.17.2.jar:2.17.2&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.camel.processor.CamelInternalProcessor.process(CamelInternalProcessor.java:190) &lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.17.2.jar:2.17.2&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.camel.component.direct.DirectProducer.process(DirectProducer.java:62) &lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.17.2.jar:2.17.2&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.camel.processor.SendProcessor.process(SendProcessor.java:145) &lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.17.2.jar:2.17.2&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.camel.processor.RedeliveryErrorHandler.process(RedeliveryErrorHandler.java:468) &lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.17.2.jar:2.17.2&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.camel.processor.CamelInternalProcessor.process(CamelInternalProcessor.java:190) &lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.17.2.jar:2.17.2&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.camel.processor.Pipeline.process(Pipeline.java:121) &lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.17.2.jar:2.17.2&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.camel.processor.Pipeline.process(Pipeline.java:83) &lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.17.2.jar:2.17.2&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.camel.processor.RedeliveryErrorHandler.process(RedeliveryErrorHandler.java:468) &lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.17.2.jar:2.17.2&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.camel.processor.CamelInternalProcessor.process(CamelInternalProcessor.java:190) &lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.17.2.jar:2.17.2&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.camel.util.AsyncProcessorHelper.process(AsyncProcessorHelper.java:109) &lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.17.2.jar:2.17.2&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.camel.processor.MulticastProcessor.doProcessParallel(MulticastProcessor.java:827) &lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.17.2.jar:2.17.2&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.camel.processor.MulticastProcessor.access$200(MulticastProcessor.java:85) &lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.17.2.jar:2.17.2&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.camel.processor.MulticastProcessor$1.call(MulticastProcessor.java:320) &lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.17.2.jar:2.17.2&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.camel.processor.MulticastProcessor$1.call(MulticastProcessor.java:305) &lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.17.2.jar:2.17.2&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at java.util.concurrent.FutureTask.run(FutureTask.java:266) &lt;span class=&quot;error&quot;&gt;&amp;#91;?:1.8.0_66&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) &lt;span class=&quot;error&quot;&gt;&amp;#91;?:1.8.0_66&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) &lt;span class=&quot;error&quot;&gt;&amp;#91;?:1.8.0_66&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:745) &lt;span class=&quot;error&quot;&gt;&amp;#91;?:1.8.0_66&amp;#93;&lt;/span&gt;&lt;br/&gt;
Caused by: org.apache.camel.RuntimeCamelException: java.lang.NullPointerException&lt;br/&gt;
	at org.apache.camel.util.ObjectHelper.wrapRuntimeCamelException(ObjectHelper.java:1690) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.17.2.jar:2.17.2&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.camel.util.ObjectHelper.invokeMethod(ObjectHelper.java:1285) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.17.2.jar:2.17.2&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.camel.impl.converter.InstanceMethodTypeConverter.convertTo(InstanceMethodTypeConverter.java:78) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.17.2.jar:2.17.2&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.camel.impl.converter.BaseTypeConverterRegistry.doConvertTo(BaseTypeConverterRegistry.java:306) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.17.2.jar:2.17.2&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.camel.impl.converter.BaseTypeConverterRegistry.convertTo(BaseTypeConverterRegistry.java:133) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.17.2.jar:2.17.2&amp;#93;&lt;/span&gt;&lt;br/&gt;
	... 26 more&lt;br/&gt;
Caused by: java.lang.NullPointerException&lt;br/&gt;
	at org.xml.sax.helpers.NamespaceSupport$Context.declarePrefix(NamespaceSupport.java:628) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;?:1.8.0_66&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.xml.sax.helpers.NamespaceSupport.declarePrefix(NamespaceSupport.java:319) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;?:1.8.0_66&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at net.sf.saxon.dom.DOMSender.gatherNamespaces(DOMSender.java:304) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;Saxon-HE-9.5.1-5.jar:?&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at net.sf.saxon.dom.DOMSender.sendElement(DOMSender.java:125) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;Saxon-HE-9.5.1-5.jar:?&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at net.sf.saxon.dom.DOMSender.send(DOMSender.java:93) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;Saxon-HE-9.5.1-5.jar:?&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at net.sf.saxon.dom.DOMObjectModel.sendSource(DOMObjectModel.java:242) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;Saxon-HE-9.5.1-5.jar:?&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at net.sf.saxon.event.Sender.send(Sender.java:219) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;Saxon-HE-9.5.1-5.jar:?&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at net.sf.saxon.IdentityTransformer.transform(IdentityTransformer.java:46) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;Saxon-HE-9.5.1-5.jar:?&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.camel.converter.jaxp.XmlConverter.toResult(XmlConverter.java:132) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.17.2.jar:2.17.2&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.camel.converter.jaxp.XmlConverter.toResult(XmlConverter.java:116) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.17.2.jar:2.17.2&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.camel.converter.jaxp.XmlConverter.toString(XmlConverter.java:238) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.17.2.jar:2.17.2&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.camel.converter.jaxp.XmlConverter.toString(XmlConverter.java:282) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.17.2.jar:2.17.2&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;?:1.8.0_66&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;?:1.8.0_66&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;?:1.8.0_66&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at java.lang.reflect.Method.invoke(Method.java:497) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;?:1.8.0_66&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.camel.util.ObjectHelper.invokeMethod(ObjectHelper.java:1281) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.17.2.jar:2.17.2&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.camel.impl.converter.InstanceMethodTypeConverter.convertTo(InstanceMethodTypeConverter.java:78) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.17.2.jar:2.17.2&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.camel.impl.converter.BaseTypeConverterRegistry.doConvertTo(BaseTypeConverterRegistry.java:306) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.17.2.jar:2.17.2&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.camel.impl.converter.BaseTypeConverterRegistry.convertTo(BaseTypeConverterRegistry.java:133) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.17.2.jar:2.17.2&amp;#93;&lt;/span&gt;&lt;br/&gt;
	... 26 more&lt;/p&gt;


&lt;p&gt;I  created a test project (which I will try to attach) with a simple unit test. I found that if I remove camel-saxon then parallel appears to run fine (The unit test is not multithreaded but I can reach 20 runs without a problem). If I include camel-saxon the I start getting the problem above (usually within 8 runs of the unit test)&lt;/p&gt;

&lt;p&gt;I noticed that camel-saxon uses an old version of Saxon (Saxon-HE-9.5.1-5) so I overrode this with the latest version (9.7.0-7) but I still get the problem.&lt;/p&gt;

&lt;p&gt;I have tried against camel-saxon 2.17.2,2.17.1,2.17.0 and 2.16.3 (which required further Saxon fiddling).&lt;/p&gt;

&lt;p&gt;I originally raised this problem on the mailing list here: &lt;a href=&quot;http://camel.465427.n5.nabble.com/Camel-XSLT-Saxon-not-thread-safe-tc5785086.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://camel.465427.n5.nabble.com/Camel-XSLT-Saxon-not-thread-safe-tc5785086.html&lt;/a&gt;&lt;/p&gt;</description>
                <environment>&lt;p&gt;Java 1.8.0_66-b17 Ubuntu 15.10 and Windows 10&lt;/p&gt;</environment>
        <key id="12995484">CAMEL-10225</key>
            <summary>Camel-Saxon is not thread safe</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="dave_bennison">David Bennison</reporter>
                        <labels>
                    </labels>
                <created>Sun, 7 Aug 2016 15:24:28 +0000</created>
                <updated>Thu, 21 Sep 2017 15:48:57 +0000</updated>
                            <resolved>Thu, 21 Sep 2017 15:48:57 +0000</resolved>
                                    <version>2.16.3</version>
                    <version>2.17.0</version>
                    <version>2.17.1</version>
                    <version>2.17.2</version>
                                    <fixVersion>2.20.0</fixVersion>
                                    <component>camel-saxon</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15410965" author="dave_bennison" created="Sun, 7 Aug 2016 15:32:10 +0000"  >&lt;p&gt;Attached test Eclipse project.&lt;/p&gt;

&lt;p&gt;Run &lt;tt&gt;OrderConsignmentRouteBuilderTest.testParrallel()&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;camel-saxon can be removed from the POM and I&apos;ve included a dependency to the latest version of Saxon so that the current (old) version of Saxon in camel-saxon can be over-ridden.&lt;/p&gt;</comment>
                            <comment id="16174750" author="davsclaus" created="Thu, 21 Sep 2017 13:28:28 +0000"  >&lt;p&gt;The problem is that you log the message body, which then forces a type conversion to a String value which is not thread-safe in saxon.&lt;/p&gt;

&lt;p&gt;Remove this line&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;            .log(LoggingLevel.INFO, &lt;span class=&quot;code-quote&quot;&gt;&quot;Found order:-\n${body}&quot;&lt;/span&gt;)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Then it works with parallel processing&lt;/p&gt;

&lt;p&gt;The DOM structure under the hood is xerces based&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;com.sun.org.apache.xerces.internal.dom.DeferredElementNSImpl
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Which is not a thread-safe DOM. I guess they somehow are linked together as they are split from the same original input source.&lt;/p&gt;</comment>
                            <comment id="16174759" author="davsclaus" created="Thu, 21 Sep 2017 13:36:44 +0000"  >&lt;p&gt;Another alternative is to convert it to Document after the split&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        .split(xp).parallelProcessing(isSplitParrallel)
            .convertBodyTo(Document.class)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16174920" author="davsclaus" created="Thu, 21 Sep 2017 15:17:18 +0000"  >&lt;p&gt;I have now a solution. There is a new option you can turn on | off to enable thread safety. When enabled your test case passes.&lt;br/&gt;
The overhead is that camel needs to do a little bit of defensive copy of the DOM that the xpath expression evaluated as, so the DOM is thread-safe and can be processed individually by different threads concurrently.&lt;/p&gt;

&lt;p&gt;Its likely safer to turn this on by default so end users don&apos;t hit these weird issues OOTB. And for people that really care then they can turn it off, if they don&apos;t use saxon or don&apos;t have problems. The overhead is as said that a clone of the node is created which takes up CPU and memory space.&lt;/p&gt;</comment>
                            <comment id="16174982" author="davsclaus" created="Thu, 21 Sep 2017 15:48:40 +0000"  >&lt;p&gt;Okay we had to keep it backwards compatible as before, but you can now easily turn on thread safety mode for when you use saxon&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        XPathExpression xp = orderResponseNamespaces.xpath(ORDER_RESPONSE_ITEM_SPLIT_XPATH);
        xp.setThreadSafety(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12822473" name="camel-split-parrallel-xslt-bug.zip" size="30976" author="dave_bennison" created="Sun, 7 Aug 2016 15:32:10 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 8 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i320c7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>