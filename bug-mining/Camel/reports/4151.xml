<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:24:15 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-11437] Bug using file endpoint probeContentType and preMove attributes together causes Exchange.FILE_CONTENT_TYPE to get dropped. (2.19.0) </title>
                <link>https://issues.apache.org/jira/browse/CAMEL-11437</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;We have a route:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;from(&quot;file:inbox?probeContentType=true&amp;amp;preMove=inprogress/${&lt;a href=&quot;file:name&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;file:name&lt;/a&gt;}&amp;amp;renameUsingCopy=true&quot;)&lt;br/&gt;
        .transacted()&lt;br/&gt;
        .bean(MimeTypeParser.class, &quot;populateFileTypeHeaderFields&quot;)&lt;br/&gt;
        .to(&quot;seda:somewhere&quot;)&lt;/p&gt;&lt;/blockquote&gt; 

&lt;p&gt;The probeContentType executes before preMove &amp;amp; renameUsingCopy and correctly sets the Exchange.FILE_CONTENT_TYPE header.&lt;/p&gt;

&lt;p&gt;The problem happens during the preMove &amp;amp; renameUsingCopy part where GenericFileExpressionRenamer calls the GenericFile method GenericFile&amp;lt;T&amp;gt; copyFrom(GenericFile&amp;lt;T&amp;gt; source).&lt;/p&gt;

&lt;p&gt;This &quot;copy constructor&quot; method does not copy the header Exchange.FILE_CONTENT_TYPE, nor does it preserve the value of the GenericFile probeContentType field.&lt;/p&gt;

&lt;p&gt;The class GenericFileRenameProcessStrategy calls GenericFileExpressionRenamer from the method begin() which in turn calls GenericFile.bindToExchange(Exchange exchange).&lt;/p&gt;

&lt;p&gt;GenericFile.bindToExchange() clears all &quot;CamelFile*&quot; headers and then calls GenericFile.populateHeaders(GenericFileMessage&amp;lt;T&amp;gt; message) which would call Files.probeContentType(Path path) if the GenericFile probeContentType field weren&apos;t now false.&lt;/p&gt;

&lt;p&gt;When our route gets to the MimeTypeParser bean the &quot;CamelFileContentType&quot; header is lost, and that is what we are looking for.&lt;/p&gt;

&lt;p&gt;One work-around is to put something like this between .transacted() and the .bean():&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;.process(exchange -&amp;gt;  {&lt;br/&gt;
     Path path = exchange.getIn().getBody(File.class).toPath();&lt;br/&gt;
     exchange.getIn().setHeader(Exchange.FILE_CONTENT_TYPE, Files.probeContentType(path));&lt;br/&gt;
})&lt;/p&gt;&lt;/blockquote&gt;</description>
                <environment></environment>
        <key id="13081997">CAMEL-11437</key>
            <summary>Bug using file endpoint probeContentType and preMove attributes together causes Exchange.FILE_CONTENT_TYPE to get dropped. (2.19.0) </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="onders">Onder Sezgin</assignee>
                                    <reporter username="dr_hoffman">David R. Hoffman</reporter>
                        <labels>
                    </labels>
                <created>Fri, 23 Jun 2017 04:48:19 +0000</created>
                <updated>Tue, 27 Jun 2017 06:09:27 +0000</updated>
                            <resolved>Sat, 24 Jun 2017 21:04:19 +0000</resolved>
                                    <version>2.19.0</version>
                                    <fixVersion>2.19.2</fixVersion>
                    <fixVersion>2.20.0</fixVersion>
                                    <component>camel-core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16060621" author="githubbot" created="Fri, 23 Jun 2017 09:26:37 +0000"  >&lt;p&gt;GitHub user onders86 opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/camel/pull/1781&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/1781&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-11437&quot; title=&quot;Bug using file endpoint probeContentType and preMove attributes together causes Exchange.FILE_CONTENT_TYPE to get dropped. (2.19.0) &quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-11437&quot;&gt;&lt;del&gt;CAMEL-11437&lt;/del&gt;&lt;/a&gt; - probeContentType and preMove attributes causes Exchange&#8230;&lt;/p&gt;

&lt;p&gt;    &#8230;.FILE_CONTENT_TYPE to get dropped&lt;/p&gt;

&lt;p&gt;    This is a very specific fix for the issue.&lt;/p&gt;

&lt;p&gt;    Better solution would be passing endpoint where bindToExchange method call done on GenericFile. I guess the design may need such a change on GenericFile. because in populateHeaders method there are specific conditions tied to FileEndpoint properties which are not set when concrete instances of GenericFileProcessStrategy are created without the settings bound to endpoint like GenericFileRenameProcessStrategy, GenericDeleteProcessStrategy etc. (where probeContentType is lost)&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/onders86/camel&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/onders86/camel&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-11437&quot; title=&quot;Bug using file endpoint probeContentType and preMove attributes together causes Exchange.FILE_CONTENT_TYPE to get dropped. (2.19.0) &quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-11437&quot;&gt;&lt;del&gt;CAMEL-11437&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/camel/pull/1781.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/1781.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #1781&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 351c6d01585b25967e5a0100a87de4b6d20a5a2e&lt;br/&gt;
Author: onders86 &amp;lt;ondersezgin@gmail.com&amp;gt;&lt;br/&gt;
Date:   2017-06-23T09:17:22Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-11437&quot; title=&quot;Bug using file endpoint probeContentType and preMove attributes together causes Exchange.FILE_CONTENT_TYPE to get dropped. (2.19.0) &quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-11437&quot;&gt;&lt;del&gt;CAMEL-11437&lt;/del&gt;&lt;/a&gt; - probeContentType and preMove attributes causes Exchange.FILE_CONTENT_TYPE to get dropped&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16062127" author="githubbot" created="Sat, 24 Jun 2017 20:53:59 +0000"  >&lt;p&gt;Github user onders86 closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/camel/pull/1781&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/1781&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16062332" author="davsclaus" created="Sun, 25 Jun 2017 14:28:50 +0000"  >&lt;p&gt;Onder can you cherry-pick this fix to the 2.19.x branch so the fix is also there. &lt;/p&gt;</comment>
                            <comment id="16062376" author="onders" created="Sun, 25 Jun 2017 16:40:26 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davsclaus&quot; class=&quot;user-hover&quot; rel=&quot;davsclaus&quot;&gt;davsclaus&lt;/a&gt; i think i am at first messed up with cherry pick and then corrected. sorry for commits noise :/&lt;/p&gt;</comment>
                            <comment id="16063861" author="dr_hoffman" created="Mon, 26 Jun 2017 21:50:48 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=onders&quot; class=&quot;user-hover&quot; rel=&quot;onders&quot;&gt;onders&lt;/a&gt;; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davsclaus&quot; class=&quot;user-hover&quot; rel=&quot;davsclaus&quot;&gt;davsclaus&lt;/a&gt; - It seems to me that while this will fix the issue it will also cause probeContentType to get called multiple times.  It would appear from the new code that it would get called anytime GenericFileRenameProcessStrategy.begin() gets called, but also anytime GenericFile.bindToExchange(Exchange exchange) gets called and GenericFile.probeConentType == true.  If the route attributes have &amp;amp;probeContentType, &amp;amp;preMove and &amp;amp;move with this solution wouldn&apos;t probeContentType get called three times per file on the FileEndpoint.  Probing a file&apos;s content time could be fairly costly from a computational point of view, so I&apos;d think you wouldn&apos;t want to do it more than absolutely necessarily - imho.&lt;/p&gt;</comment>
                            <comment id="16064332" author="onders" created="Tue, 27 Jun 2017 06:09:27 +0000"  >&lt;p&gt;well yes that s for sure that unnecessary multiple probing for the file content is not what we would want, imho, too. however, what you secondly describe is another issue and requires a bit more investigation,imho. initially and what you reported was correct because probeXontentType is not passed right to renameprocess strategy. and that s what we fixed. feel free to lg another jira. we can look into it&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311020" key="com.atlassian.jira.plugin.system.customfieldtypes:url">
                        <customfieldname>External issue URL</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[http://camel.465427.n5.nabble.com/Bug-using-File-endpoint-probeContentType-and-preMove-attributes-together-causes-Exchange-FILE-CONTEN-td5805088.html]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 21 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3gn7r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>