<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 11:06:26 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-20835] OOM using RecipientList</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-20835</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;Out Of Memory (OOM) occurs when using the Recipient List with a large number of dynamic URLs.&#160; For example:&lt;br/&gt;
&#160;&lt;br/&gt;
&#160; &#160;&#160;.recipientList(simple(&quot;http://&lt;tt&gt;downstream-server&lt;/tt&gt;/employee/${header.emplId}&quot;))&lt;br/&gt;
&#160;&lt;br/&gt;
with a large number of values for&#160;${header.emplId}&#160;leads to the OOM.&lt;br/&gt;
&#160;&lt;br/&gt;
&lt;b&gt;REPRODUCER:&lt;/b&gt;&lt;br/&gt;
&lt;b&gt;=============&lt;/b&gt;&lt;br/&gt;
&lt;a href=&quot;https://github.com/artnaseef/camel-recipient-list-oom-reproducer&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/artnaseef/camel-recipient-list-oom-reproducer&lt;/a&gt;&lt;br/&gt;
&#160;&lt;/p&gt;

&lt;p&gt;See the README.md for instructions to reproduce and detect the problem&lt;br/&gt;
&#160;&lt;br/&gt;
&lt;b&gt;DETAILS&lt;/b&gt;&lt;br/&gt;
&lt;b&gt;=======&lt;/b&gt;&lt;br/&gt;
&#160;The MulticastProcessor, which RecipientListProcessor extends, has the following &quot;unlimited&quot; cache:&lt;br/&gt;
&#160;&lt;br/&gt;
&#160; &#160;&#160;private final ConcurrentMap&amp;lt;Processor, Processor&amp;gt; errorHandlers = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;br/&gt;
&#160;&lt;br/&gt;
Entries are added to this map for every unique processor created - every unique URL generates a unique processor.&#160; The entries themselves are wrapped processor instances for error handling IIUC (to support the custom error handling used by multicast and recipient-list).&#160; Entries are only removed from this map on shutdown.&#160; Ironically, there is an LRUCache for the processors themselves, with a default maximum size of 1000, so the wrapped processors may get recreated even though the error handler remains in the map indefinitely.&lt;br/&gt;
&#160;&lt;br/&gt;
&lt;b&gt;IMPACT VERSIONS:&lt;/b&gt;&lt;br/&gt;
&lt;b&gt;================&lt;/b&gt;&lt;br/&gt;
Appears to impact versions &amp;gt;= 3.10.0&lt;/p&gt;


&lt;p&gt;&lt;b&gt;COMMIT: 0d9227ff16fb00e047fdd087740c87cce01bb545&lt;/b&gt;&lt;br/&gt;
&lt;b&gt;=======&lt;/b&gt;&lt;br/&gt;
It appears this commit introduced the use of the errorHandlers &quot;unlimited&quot; cache for recipient lists.&lt;br/&gt;
&#160;&lt;br/&gt;
&lt;b&gt;FOLLOW-UP&lt;/b&gt;&lt;br/&gt;
&lt;b&gt;==========&lt;/b&gt;&lt;br/&gt;
I have ideas and questions for implemeting a fix:&lt;br/&gt;
&#160; &#160; - IDEA 1: We can use an LRUCache for this data structure as well.&lt;br/&gt;
&#160; &#160; - Does it make more sense to remove the entries from errorHandlers when the related Processor entry is removed from it&apos;s LRUCache?&lt;br/&gt;
&#160; &#160; - IDEA 2: setting on recipient list to disable the errorHandler cache (for dyamic urls with little chance of duplicates, this could be the best)&lt;/p&gt;</description>
                <environment></environment>
        <key id="13581582">CAMEL-20835</key>
            <summary>OOM using RecipientList</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="artnaseef">Arthur Naseef</reporter>
                        <labels>
                    </labels>
                <created>Tue, 4 Jun 2024 22:18:54 +0000</created>
                <updated>Tue, 12 Nov 2024 08:21:25 +0000</updated>
                            <resolved>Mon, 17 Jun 2024 10:19:39 +0000</resolved>
                                    <version>3.10.0</version>
                    <version>4.6.0</version>
                                    <fixVersion>3.22.3</fixVersion>
                    <fixVersion>4.0.6</fixVersion>
                    <fixVersion>4.4.3</fixVersion>
                    <fixVersion>4.7.0</fixVersion>
                                    <component>camel-core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17852213" author="artnaseef" created="Tue, 4 Jun 2024 22:21:55 +0000"  >&lt;p&gt;POC commits can be found here: &lt;a href=&quot;https://github.com/apache/camel/compare/main...artnaseef:camel:asn/disable-error-handler-cache-setting&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/compare/main...artnaseef:camel:asn/disable-error-handler-cache-setting&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17855530" author="davsclaus" created="Mon, 17 Jun 2024 08:09:51 +0000"  >&lt;p&gt;You should turn off the cache on recipient list / toD, or use a header with the HTTP_PATH and a static endpoint - when you essentially have unique endpoints&lt;/p&gt;</comment>
                            <comment id="17855542" author="davsclaus" created="Mon, 17 Jun 2024 08:48:48 +0000"  >&lt;p&gt;But yeah we should use a LRUCache with same cache size as recipient list out of the box. And also allow to turn it off, if you set the size to -1&lt;/p&gt;</comment>
                            <comment id="17855544" author="davsclaus" created="Mon, 17 Jun 2024 08:49:33 +0000"  >&lt;p&gt;But for unlimited HTTP endpoints then use toD which has special optimizations for this then it should work out of the box.&lt;/p&gt;</comment>
                            <comment id="17855548" author="davsclaus" created="Mon, 17 Jun 2024 09:07:32 +0000"  >&lt;p&gt;With a fix then Camel does not leak memory. The biggest objects are (after GC)&lt;/p&gt;

&lt;p&gt;&#160;193: &#160; &#160; &#160; &#160; &#160; 239 &#160; &#160; &#160; &#160; &#160; 5736 &#160;org.apache.camel.spi.TypeConvertible&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17855558" author="davsclaus" created="Mon, 17 Jun 2024 09:19:46 +0000"  >&lt;p&gt;And with 1000 as default cache size&lt;/p&gt;

&lt;p&gt;&#160; 26: &#160; &#160; &#160; &#160; &#160;1000 &#160; &#160; &#160; &#160; 224000 &#160;org.apache.camel.component.log.LogEndpoint&lt;br/&gt;
&#160; 53: &#160; &#160; &#160; &#160; &#160;1000 &#160; &#160; &#160; &#160; &#160;48000 &#160;org.apache.camel.support.processor.CamelLogProcessor&lt;br/&gt;
&#160; 62: &#160; &#160; &#160; &#160; &#160;1000 &#160; &#160; &#160; &#160; &#160;32000 &#160;org.apache.camel.component.log.LogProducer&lt;br/&gt;
&#160; 74: &#160; &#160; &#160; &#160; &#160;1044 &#160; &#160; &#160; &#160; &#160;25056 &#160;org.apache.camel.spi.CamelLogger&lt;br/&gt;
&#160; 75: &#160; &#160; &#160; &#160; &#160;1000 &#160; &#160; &#160; &#160; &#160;24000 &#160;org.apache.camel.support.cache.ServicePool$SinglePool&lt;br/&gt;
&#160;103: &#160; &#160; &#160; &#160; &#160;1008 &#160; &#160; &#160; &#160; &#160;16128 &#160;org.apache.camel.support.NormalizedUri&lt;br/&gt;
&#160;105: &#160; &#160; &#160; &#160; &#160;1000 &#160; &#160; &#160; &#160; &#160;16000 &#160;org.apache.camel.support.DefaultPollingConsumerPollStrategy&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13598375">CAMEL-21432</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 21 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1pm88:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>