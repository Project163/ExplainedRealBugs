<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:51:51 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-17489] camel-kafka - Unsubscribing fails due to already closed consumer</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-17489</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;In &lt;b&gt;KafkaFetchRecords&lt;/b&gt;, when an exception occurs inside &lt;b&gt;startPolling&lt;/b&gt; method, the consumer is closed in finally block:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
    lock.unlock();

    &lt;span class=&quot;code-comment&quot;&gt;// only close &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; not retry
&lt;/span&gt;    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!isRetrying()) {
        LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Closing consumer {}&quot;&lt;/span&gt;, threadId);
        IOHelper.close(consumer);
    }
} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;and then unsubscribing in &lt;b&gt;run&lt;/b&gt; method fails with &quot;This consumer has already been closed&quot;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Terminating KafkaConsumer thread: {} receiving from topic: {}&quot;&lt;/span&gt;, threadId, topicName);
safeUnsubscribe();
IOHelper.close(consumer); &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13422727">CAMEL-17489</key>
            <summary>camel-kafka - Unsubscribing fails due to already closed consumer</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="rgala">Rafa&#322; Ga&#322;a</reporter>
                        <labels>
                    </labels>
                <created>Fri, 14 Jan 2022 11:15:58 +0000</created>
                <updated>Mon, 24 Jan 2022 05:56:27 +0000</updated>
                            <resolved>Mon, 24 Jan 2022 05:56:27 +0000</resolved>
                                    <version>3.14.0</version>
                                    <fixVersion>3.14.1</fixVersion>
                    <fixVersion>3.15.0</fixVersion>
                                    <component>camel-kafka</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17476074" author="davsclaus" created="Fri, 14 Jan 2022 11:24:08 +0000"  >&lt;p&gt;Can you post the stractrace / error you see from the logs&lt;/p&gt;</comment>
                            <comment id="17476075" author="rgala" created="Fri, 14 Jan 2022 11:26:15 +0000"  >&lt;p&gt;There you go:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2022-01-14 11:59:27.612 [Camel (camel-1) thread #778 - KafkaConsumer[***masked***]] WARN &#160;org.apache.camel.component.kafka.KafkaConsumer.log:214 - Error unsubscribing ***masked***-Thread 0 from kafka topic ***masked***. Caused by: [java.lang.IllegalStateException - This consumer has already been closed.]
java.lang.IllegalStateException: This consumer has already been closed.
&#160; &#160; at org.apache.kafka.clients.consumer.KafkaConsumer.acquireAndEnsureOpen(KafkaConsumer.java:2437)
&#160; &#160; at org.apache.kafka.clients.consumer.KafkaConsumer.unsubscribe(KafkaConsumer.java:1062)
&#160; &#160; at org.apache.camel.component.kafka.KafkaFetchRecords.safeUnsubscribe(KafkaFetchRecords.java:239)
&#160; &#160; at org.apache.camel.component.kafka.KafkaFetchRecords.run(KafkaFetchRecords.java:105)
&#160; &#160; at java.base/java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:515)
&#160; &#160; at java.base/java.util.concurrent.FutureTask.run(FutureTask.java:264)
&#160; &#160; at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128)
&#160; &#160; at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)
&#160; &#160; at java.base/java.lang.Thread.run(Thread.java:834)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17476139" author="davsclaus" created="Fri, 14 Jan 2022 13:17:16 +0000"  >&lt;p&gt;So with your PR then you do not see this exception anymore?&lt;/p&gt;

&lt;p&gt;I think the safeUnsubscribe method should catch IllegalStateException and then catch&lt;br/&gt;
throw new IllegalStateException(&quot;This consumer has already been closed.&quot;);&lt;br/&gt;
As that is what kafka throws on purpose.&lt;/p&gt;

&lt;p&gt;And you cannot know if its closed already, as there are no method like isClosed()&lt;/p&gt;</comment>
                            <comment id="17476149" author="rgala" created="Fri, 14 Jan 2022 13:41:50 +0000"  >&lt;p&gt;My solution will only make sure the unsubscribe is called before a consumer instance is called so it will most probably not prevent the error from occuring.&#160;I think that to prevent this error from occuring a boolean variable should be created and set to true after a consumer has been closed. The variable would then be checked inside &lt;b&gt;safeUnsubscribe&lt;/b&gt; to prevent calls to unsubscribe on an already closed consumer.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;What I could also try is to introduce a check in &lt;b&gt;safeUnsubscribe&lt;/b&gt; method that would check a result of &lt;b&gt;consumer.subscription()&lt;/b&gt; and call unsubscribe only in a case where non empty set has been returned. I could also introduce a boolean variable that I would set to true after first call to unsubscribe to prevent multiple calls.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Let me know what you think and I&apos;ll make changes in the code &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="17476293" author="orpiske" created="Fri, 14 Jan 2022 17:33:15 +0000"  >&lt;p&gt;FYI: I logged &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-17493&quot; title=&quot;camel-kafka: safe unsubscription should ignore safe exceptions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-17493&quot;&gt;&lt;del&gt;CAMEL-17493&lt;/del&gt;&lt;/a&gt; for the safeUnsubscribe change.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17480673" author="davsclaus" created="Sun, 23 Jan 2022 16:47:40 +0000"  >&lt;p&gt;Is there more work to do in this ticket?&lt;/p&gt;</comment>
                            <comment id="17480674" author="orpiske" created="Sun, 23 Jan 2022 16:48:59 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davsclaus&quot; class=&quot;user-hover&quot; rel=&quot;davsclaus&quot;&gt;davsclaus&lt;/a&gt; no, we are done w/ this one. I also back-ported it to 3.14.x.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13422781">CAMEL-17493</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 42 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0ylgw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>