<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:56:40 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-18027] camel-netty (producer) wrongly closes client channels</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-18027</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;The Camel Netty component (NettyProducer) is wrongly closing TCP/IP client channels when the&#160;&lt;tt&gt;requestTimeout&lt;/tt&gt;&#160;option is configured.&lt;/p&gt;

&lt;p&gt;See logs:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2022-04-21 15:21:46.410 &#160;INFO 18420 --- [ &#160; &#160; &#160; &#160; &#160; main] o.a.c.component.netty.NettyComponent &#160; &#160; : Creating shared NettyConsumerExecutorGroup with 17 threads
2022-04-21 15:21:46.683 DEBUG 18420 --- [ &#160; &#160; &#160; &#160; &#160; main] o.a.camel.component.netty.NettyProducer &#160;: Created NettyProducer pool[maxTotal=1, minIdle=100, maxIdle=100, minEvictableIdleDuration=PT-0.001S] -&amp;gt; GenericObjectPool [maxTotal=1, blockWhenExhausted=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, maxWaitDuration=PT-0.001S, lifo=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, fairness=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, testOnCreate=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, testOnBorrow=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, testOnReturn=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, testWhileIdle=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, durationBetweenEvictionRuns=PT30S, numTestsPerEvictionRun=3, minEvictableIdleTimeDuration=PT-0.001S, softMinEvictableIdleTimeDuration=PT-0.001S, evictionPolicy=org.apache.commons.pool2.impl.DefaultEvictionPolicy@580d3612, closeLock=java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;@5b0039aa, closed=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, evictionLock=java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;@52bf5065, evictor=org.apache.commons.pool2.impl.BaseGenericObjectPool$Evictor@263cece5, evictionIterator=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, factoryClassLoader=java.lang.ref.WeakReference@1730f396, oname=org.apache.commons.pool2:type=GenericObjectPool,name=pool, creationStackTrace=java.lang.Exception
[...]
, borrowedCount=0, returnedCount=0, createdCount=0, destroyedCount=0, destroyedByEvictorCount=0, destroyedByBorrowValidationCount=0, activeTimes=StatsStore [[]], size=100, index=0], idleTimes=StatsStore [[]], size=100, index=0], waitTimes=StatsStore [[]], size=100, index=0], maxBorrowWaitDuration=PT0S, swallowedExceptionListener=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, factoryType=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, maxIdle=100, minIdle=0, factory=org.apache.camel.component.netty.NettyProducer$NettyProducerPoolableObjectFactory@4d2745b3, allObjects={}, createCount=0, idleObjects=[], abandonedConfig=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;]
2022-04-21 15:51:11.502 TRACE 18420 --- [roducerTemplate] o.a.camel.component.netty.NettyProducer &#160;: Pool[active=0, idle=0]
2022-04-21 15:51:11.504 DEBUG 18420 --- [roducerTemplate] o.a.camel.component.netty.NettyProducer &#160;: Created &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TCP client bootstrap connecting to localhost:19001 with options: Bootstrap(BootstrapConfig(group: NioEventLoopGroup, channelFactory: ReflectiveChannelFactory(NioSocketChannel.class), options: {SO_KEEPALIVE=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, SO_REUSEADDR=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, TCP_NODELAY=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, CONNECT_TIMEOUT_MILLIS=2000}, handler: org.apache.camel.component.netty.DefaultClientInitializerFactory@624ce9ff, resolver: io.netty.resolver.DefaultAddressResolverGroup@6e4616a3))
2022-04-21 15:51:11.505 TRACE 18420 --- [roducerTemplate] o.a.camel.component.netty.NettyProducer &#160;: Requested channel: AbstractBootstrap$PendingRegistrationPromise@270856c0(incomplete)
2022-04-21 15:51:11.505 TRACE 18420 --- [roducerTemplate] o.a.camel.component.netty.NettyProducer &#160;: activateObject channel request: AbstractBootstrap$PendingRegistrationPromise@270856c0(incomplete)
2022-04-21 15:51:11.505 TRACE 18420 --- [roducerTemplate] o.a.camel.component.netty.NettyProducer &#160;: Validating connecting channel request: AbstractBootstrap$PendingRegistrationPromise@270856c0(incomplete) -&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
2022-04-21 15:51:11.505 TRACE 18420 --- [roducerTemplate] o.a.camel.component.netty.NettyProducer &#160;: Got channel request from pool AbstractBootstrap$PendingRegistrationPromise@270856c0(incomplete)
2022-04-21 15:51:11.509 DEBUG 18420 --- [ClientTCPWorker] .a.c.c.n.DefaultClientInitializerFactory : Client SSL handler configured and added to the ChannelPipeline: io.netty.handler.ssl.SslHandler@735dd507
2022-04-21 15:51:11.509 TRACE 18420 --- [ClientTCPWorker] .a.c.c.n.DefaultClientInitializerFactory : Using request timeout 5000 millis
2022-04-21 15:51:11.509 TRACE 18420 --- [ClientTCPWorker] .a.c.c.n.DefaultClientInitializerFactory : Created ChannelPipeline: DefaultChannelPipeline{(DefaultClientInitializerFactory#0 = org.apache.camel.component.netty.DefaultClientInitializerFactory), (ssl = io.netty.handler.ssl.SslHandler), (decoder-0 = io.netty.handler.codec.LengthFieldBasedFrameDecoder), (decoder-1 = util.SharableByteArrayDecoder), (encoder-0 = io.netty.handler.codec.LengthFieldPrepender), (encoder-1 = io.netty.handler.codec.bytes.ByteArrayEncoder), (timeout = io.netty.handler.timeout.ReadTimeoutHandler), (handler = org.apache.camel.component.netty.handlers.ClientChannelHandler)}
2022-04-21 15:51:11.511 TRACE 18420 --- [ClientTCPWorker] o.a.camel.component.netty.NettyProducer &#160;: Channel open finished with AbstractBootstrap$PendingRegistrationPromise@270856c0(success)
2022-04-21 15:51:11.511 DEBUG 18420 --- [ClientTCPWorker] o.a.camel.component.netty.NettyProducer &#160;: Creating connector to address: localhost:19001
2022-04-21 15:51:11.511 DEBUG 18420 --- [ClientTCPWorker] o.a.camel.component.netty.NettyProducer &#160;: Channel: [id: 0x80278f7c, L:/127.0.0.1:61770 - R:localhost/127.0.0.1:19001] writing body: OMITTED
2022-04-21 15:51:11.517 TRACE 18420 --- [ClientTCPWorker] o.a.camel.component.netty.NettyProducer &#160;: Channel open: [id: 0x80278f7c, L:/127.0.0.1:61770 - R:localhost/127.0.0.1:19001]
2022-04-21 15:51:11.637 TRACE 18420 --- [ClientTCPWorker] o.a.camel.component.netty.NettyProducer &#160;: Operation complete DefaultChannelPromise@1835894c(success)
2022-04-21 15:51:11.642 TRACE 18420 --- [ClientTCPWorker] o.a.camel.component.netty.NettyProducer &#160;: Message received: OMITTED
2022-04-21 15:51:11.642 TRACE 18420 --- [ClientTCPWorker] o.a.camel.component.netty.NettyProducer &#160;: Removing timeout channel as we received message
2022-04-21 15:51:11.642 DEBUG 18420 --- [ClientTCPWorker] o.a.camel.component.netty.NettyProducer &#160;: Channel: [id: 0x80278f7c, L:/127.0.0.1:61770 - R:localhost/127.0.0.1:19001] received body: OMITTED
2022-04-21 15:51:11.643 TRACE 18420 --- [ClientTCPWorker] o.a.camel.component.netty.NettyProducer &#160;: Putting channel back to pool [id: 0x80278f7c, L:/127.0.0.1:61770 - R:localhost/127.0.0.1:19001]
2022-04-21 15:51:11.643 TRACE 18420 --- [ClientTCPWorker] o.a.camel.component.netty.NettyProducer &#160;: passivateObject channel request: AbstractBootstrap$PendingRegistrationPromise@270856c0(success)
2022-04-21 15:51:11.645 DEBUG 18420 --- [nio-8087-exec-5] eHttpServletFilter$AsyncExceptionHandler : handling on complete &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; async event
2022-04-21 15:51:16.770 TRACE 18420 --- [ns-pool-evictor] o.a.camel.component.netty.NettyProducer &#160;: activateObject channel request: AbstractBootstrap$PendingRegistrationPromise@270856c0(success)
2022-04-21 15:51:16.771 TRACE 18420 --- [ns-pool-evictor] o.a.camel.component.netty.NettyProducer &#160;: reset the request timeout as we activate the channel
2022-04-21 15:51:16.771 TRACE 18420 --- [ns-pool-evictor] o.a.camel.component.netty.NettyProducer &#160;: Validating channel: [id: 0x80278f7c, L:/127.0.0.1:61770 - R:localhost/127.0.0.1:19001] -&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
2022-04-21 15:51:16.771 TRACE 18420 --- [ns-pool-evictor] o.a.camel.component.netty.NettyProducer &#160;: passivateObject channel request: AbstractBootstrap$PendingRegistrationPromise@270856c0(success)
2022-04-21 15:51:21.771 TRACE 18420 --- [ClientTCPWorker] o.a.camel.component.netty.NettyProducer &#160;: Exception caught at Channel: [id: 0x80278f7c, L:/127.0.0.1:61770 - R:localhost/127.0.0.1:19001]
io.netty.handler.timeout.ReadTimeoutException: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
2022-04-21 15:51:21.772 DEBUG 18420 --- [ClientTCPWorker] o.a.camel.component.netty.NettyProducer &#160;: Closing channel as an exception was thrown from Netty
io.netty.handler.timeout.ReadTimeoutException: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
2022-04-21 15:51:21.772 TRACE 18420 --- [ClientTCPWorker] o.a.camel.component.netty.NettyHelper &#160; &#160;: Channel closed: [id: 0x80278f7c, L:/127.0.0.1:61770 ! R:localhost/127.0.0.1:19001]
2022-04-21 15:51:21.773 TRACE 18420 --- [ClientTCPWorker] o.a.camel.component.netty.NettyProducer &#160;: Channel closed: [id: 0x80278f7c, L:/127.0.0.1:61770 ! R:localhost/127.0.0.1:19001]
2022-04-21 15:51:46.773 TRACE 18420 --- [ns-pool-evictor] o.a.camel.component.netty.NettyProducer &#160;: activateObject channel request: AbstractBootstrap$PendingRegistrationPromise@270856c0(success)
2022-04-21 15:51:46.773 TRACE 18420 --- [ns-pool-evictor] o.a.camel.component.netty.NettyProducer &#160;: reset the request timeout as we activate the channel
2022-04-21 15:51:46.773 TRACE 18420 --- [ns-pool-evictor] o.a.camel.component.netty.NettyProducer &#160;: Destroying channel request: AbstractBootstrap$PendingRegistrationPromise@270856c0(success)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The offending code seems to be:&#160;&lt;a href=&quot;https://github.com/apache/camel/blob/main/components/camel-netty/src/main/java/org/apache/camel/component/netty/NettyProducer.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/blob/main/components/camel-netty/src/main/java/org/apache/camel/component/netty/NettyProducer.java&lt;/a&gt;&lt;/p&gt;



&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&#160; &#160; &#160; &#160; @Override
&#160; &#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void activateObject(PooledObject&amp;lt;ChannelFuture&amp;gt; p) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
&#160; &#160; &#160; &#160; &#160; &#160; ChannelFuture channelFuture = p.getObject();
&#160; &#160; &#160; &#160; &#160; &#160; LOG.trace(&lt;span class=&quot;code-quote&quot;&gt;&quot;activateObject channel request: {}&quot;&lt;/span&gt;, channelFuture);
&#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (channelFuture.isSuccess() &amp;amp;&amp;amp; producer.getConfiguration().getRequestTimeout() &amp;gt; 0) {
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; LOG.trace(&lt;span class=&quot;code-quote&quot;&gt;&quot;reset the request timeout as we activate the channel&quot;&lt;/span&gt;);
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; Channel channel = channelFuture.channel();
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; ChannelHandler handler = channel.pipeline().get(&lt;span class=&quot;code-quote&quot;&gt;&quot;timeout&quot;&lt;/span&gt;);
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (handler == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; ChannelHandler timeout
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ReadTimeoutHandler(producer.getConfiguration().getRequestTimeout(), TimeUnit.MILLISECONDS);
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; channel.pipeline().addBefore(&lt;span class=&quot;code-quote&quot;&gt;&quot;handler&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;timeout&quot;&lt;/span&gt;, timeout);
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; }
&#160; &#160; &#160; &#160; &#160; &#160; }
&#160; &#160; &#160; &#160; }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13442260">CAMEL-18027</key>
            <summary>camel-netty (producer) wrongly closes client channels</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="vincenzo.galluccio">Vincenzo Galluccio</reporter>
                        <labels>
                    </labels>
                <created>Thu, 28 Apr 2022 08:52:57 +0000</created>
                <updated>Mon, 20 Jun 2022 17:21:25 +0000</updated>
                            <resolved>Mon, 20 Jun 2022 17:21:25 +0000</resolved>
                                    <version>3.14.2</version>
                    <version>3.16.0</version>
                                    <fixVersion>3.14.4</fixVersion>
                    <fixVersion>3.18.0</fixVersion>
                                    <component>camel-netty</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17534147" author="davsclaus" created="Tue, 10 May 2022 05:32:47 +0000"  >&lt;p&gt;Why do you think its wrong - the timeout was hit and as such the channel can be regarded as invalid from the client point of view, and therefore is closed to avoid using a stale channel on next use.&lt;/p&gt;</comment>
                            <comment id="17534192" author="JIRAUSER285695" created="Tue, 10 May 2022 07:22:00 +0000"  >&lt;p&gt;Good morning Claus,&lt;/p&gt;

&lt;p&gt;It is wrong because, as you can see from the logs (at 2022-04-21 15:51:11.642), the response is received on time, therefore the request timeout should not be hit and channel should not be closed.&#160;&lt;/p&gt;</comment>
                            <comment id="17556471" author="davsclaus" created="Mon, 20 Jun 2022 17:18:30 +0000"  >&lt;p&gt;Thanks for reporting I can see the problem and have a fix&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12311020" key="com.atlassian.jira.plugin.system.customfieldtypes:url">
                        <customfieldname>External issue URL</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[https://camel.zulipchat.com/#narrow/stream/257298-camel/topic/camel-netty.20.28producer.29.20wrongly.20closes.20client.20channels/near/279684447]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 21 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z11wk0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>