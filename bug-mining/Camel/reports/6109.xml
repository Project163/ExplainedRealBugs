<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:53:26 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-17859] camel-smpp: Consumer sometimes tries to reconnect only once</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-17859</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;We have been running multiple applications using Camel SMPP with a consumer with lazy session creation for years without any problems.&lt;/p&gt;

&lt;p&gt;Recently we observed that sometimes Camel 3.15.0 only tries to reconnect once.&lt;/p&gt;

&lt;p&gt;Log:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Time - thread_name - logger_name - message
Mar 22, 2022 @ 01:16:59.798 - PDUReaderWorker-b333f18a - org.jsmpp.session.SMPPSession - Reading PDU session b333f18a in state BOUND_TX: Connection reset
Mar 22, 2022 @ 01:16:59.801 - EnquireLinkSender-b333f18a - org.jsmpp.session.AbstractSession - Response timeout on enquireLink
Mar 22, 2022 @ 01:16:59.801 - EnquireLinkSender-b333f18a - org.apache.camel.component.smpp.SmppProducer - Lost connection to: smpp:&lt;span class=&quot;code-comment&quot;&gt;//USER@HOST:PORT - trying to reconnect...
&lt;/span&gt;Mar 22, 2022 @ 01:16:59.824 - EnquireLinkSender-b333f18a - org.apache.camel.support.task.BackgroundTask - Interrupted &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; waiting &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the repeatable task to execute: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
java.lang.InterruptedException: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
               at java.base/java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireSharedInterruptibly(Unknown Source)
               at java.base/java.util.concurrent.CountDownLatch.await(Unknown Source)
               at org.apache.camel.support.task.BackgroundTask.waitForTaskCompletion(BackgroundTask.java:153)
               at org.apache.camel.support.task.BackgroundTask.run(BackgroundTask.java:144)
               at org.apache.camel.component.smpp.SmppProducer.reconnect(SmppProducer.java:197)
               at org.apache.camel.component.smpp.SmppProducer.lambda$&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt;$0(SmppProducer.java:76)
               at org.apache.camel.component.smpp.SmppProducer$$Lambda$1087/0x000000002b4df3c8.onStateChange(Unknown Source)
               at org.jsmpp.session.AbstractSessionContext.fireStateChanged(AbstractSessionContext.java:85)
               at org.jsmpp.session.SMPPSessionContext.changeState(SMPPSessionContext.java:61)
               at org.jsmpp.session.AbstractSessionContext.close(AbstractSessionContext.java:66)
               at org.jsmpp.session.AbstractSession.close(AbstractSession.java:257)
               at org.jsmpp.session.AbstractSession$EnquireLinkSender.run(AbstractSession.java:503)
Mar 22, 2022 @ 01:17:04.824 - Camel (camel-1) thread #3797 - smpp-producer-reconnect - org.apache.camel.component.smpp.SmppProducer - Trying to reconnect to smpp:&lt;span class=&quot;code-comment&quot;&gt;//USER@HOST:PORT
&lt;/span&gt;Mar 22, 2022 @ 01:17:04.833 - Camel (camel-1) thread #3797 - smpp-producer-reconnect - org.jsmpp.session.SMPPSession - Connected from port 59810 to /PORT:PORT
Mar 22, 2022 @ 01:17:04.834 - PDUReaderWorker-d0566380 - org.jsmpp.session.SMPPSession - Starting PDUReaderWorker
Mar 22, 2022 @ 01:17:04.844 - PDUReaderWorker-d0566380 - org.jsmpp.session.SMPPSession - Reading PDU session d0566380 in state OPEN: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
Mar 22, 2022 @ 01:17:04.845 - pool-58909-thread-1 - org.jsmpp.session.SMPPSession - Failed setting so_timeout &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; session timer
java.net.SocketException: Socket is closed
               at java.base/java.net.Socket.setSoTimeout(Unknown Source)
               at org.jsmpp.session.connection.socket.SocketConnection.setSoTimeout(SocketConnection.java:60)
               at org.jsmpp.session.SMPPSession$BoundSessionStateListener.onStateChange(SMPPSession.java:721)
               at org.jsmpp.session.AbstractSessionContext.fireStateChanged(AbstractSessionContext.java:85)
               at org.jsmpp.session.SMPPSessionContext.changeState(SMPPSessionContext.java:61)
               at org.jsmpp.session.AbstractSessionContext.bound(AbstractSessionContext.java:49)
               at org.jsmpp.session.state.SMPPSessionOpen.processBindResp(SMPPSessionOpen.java:73)
               at org.jsmpp.session.PDUProcessTask.run(PDUProcessTask.java:62)
               at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(Unknown Source)
               at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(Unknown Source)
               at java.base/java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(Unknown Source)
Mar 22, 2022 @ 01:17:04.845 - pool-58909-thread-1 - org.jsmpp.session.SMPPSession - Changing processor degree to 1
Mar 22, 2022 @ 01:17:04.847 - Camel (camel-1) thread #3797 - smpp-producer-reconnect - org.jsmpp.session.SMPPSession - Receive negative bind response
Mar 22, 2022 @ 01:17:04.847 - PDUReaderWorker-d0566380 - org.apache.camel.component.smpp.SmppProducer - Lost connection to: smpp:&lt;span class=&quot;code-comment&quot;&gt;//USER@HOST:PORT - trying to reconnect...
&lt;/span&gt;
[no further reconnects or anything related to smpp producing]

[almost seven hours later the application tries to produce the first sms (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; and all further tries to produce fail):] 
org.apache.camel.processor.errorhandler.DefaultErrorHandler - Failed delivery &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (MessageId: XZY on ExchangeId: XZY). Exhausted after delivery attempt: 1 caught: java.io.IOException: Lost connection to smpp:&lt;span class=&quot;code-comment&quot;&gt;//USER@HOST:PORT and yet not reconnected&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The log of another instance showed the same behavior.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=orpiske&quot; class=&quot;user-hover&quot; rel=&quot;orpiske&quot;&gt;orpiske&lt;/a&gt; I am not sure, but I think this may be another regression caused by &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-17121&quot; title=&quot;Investigate and consolidate do-wait-retry logic in components&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-17121&quot;&gt;&lt;del&gt;CAMEL-17121&lt;/del&gt;&lt;/a&gt; It would be great if you could have a look at this. Thank you very much!&lt;/p&gt;</description>
                <environment></environment>
        <key id="13436033">CAMEL-17859</key>
            <summary>camel-smpp: Consumer sometimes tries to reconnect only once</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="orpiske">Otavio Rodolfo Piske</assignee>
                                    <reporter username="pascalschumacher">Pascal Schumacher</reporter>
                        <labels>
                    </labels>
                <created>Sun, 27 Mar 2022 17:50:01 +0000</created>
                <updated>Thu, 1 Dec 2022 07:23:56 +0000</updated>
                            <resolved>Thu, 1 Dec 2022 07:23:56 +0000</resolved>
                                    <version>3.15.0</version>
                                    <fixVersion>3.18.3</fixVersion>
                    <fixVersion>3.19.0</fixVersion>
                                    <component>camel-smpp</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17513149" author="orpiske" created="Mon, 28 Mar 2022 05:30:05 +0000"  >&lt;p&gt;Thanks for the heads up. I&apos;ll take a look.&lt;/p&gt;</comment>
                            <comment id="17513201" author="orpiske" created="Mon, 28 Mar 2022 07:24:01 +0000"  >&lt;p&gt;I haven&apos;t been able to reproduce this one yet. If you have any additional details about your scenario (or maybe a reproducer?), that would be very helpful. &lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I have been using the producer &lt;a href=&quot;https://github.com/apache/camel/blob/main/components/camel-smpp/src/test/java/org/apache/camel/component/smpp/integration/SmppProducerReconnectManualIT.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;reconnect test&lt;/a&gt; along with the options &quot;&amp;amp;lazySessionCreation=true&amp;amp;lazyStartProducer=true&quot;&#160; to do so.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Maybe something&apos;s missing on the test?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17513533" author="pascalschumacher" created="Mon, 28 Mar 2022 17:50:36 +0000"  >&lt;p&gt;Thank you very much for locking into this! &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;I should have mentioned that we are only using &lt;tt&gt;lazySessionCreation&lt;/tt&gt; (not &lt;tt&gt;lazyStartProducer&lt;/tt&gt;).&lt;/p&gt;

&lt;p&gt;I fear that the problem is more complex than the scenario tested by the reconnect test.&lt;/p&gt;

&lt;p&gt;Sadly I do not have I reproducer.&lt;/p&gt;

&lt;p&gt;In the logs I see multiple threads accessing &lt;tt&gt;SmppProducer&lt;/tt&gt;. My best guess is that another thread must still hold the &lt;tt&gt;connectLock&lt;/tt&gt;. Therefore &lt;tt&gt;connectLock.tryLock()&lt;/tt&gt; in &lt;a href=&quot;https://github.com/apache/camel/blob/bc487f3f1645702e0ac9329bdb30b380a0380f7d/components/camel-smpp/src/main/java/org/apache/camel/component/smpp/SmppProducer.java#L192&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/blob/bc487f3f1645702e0ac9329bdb30b380a0380f7d/components/camel-smpp/src/main/java/org/apache/camel/component/smpp/SmppProducer.java#L192&lt;/a&gt; returns &lt;tt&gt;false&lt;/tt&gt; for the &lt;tt&gt;PDUReaderWorker-d0566380&lt;/tt&gt; thread and no &lt;tt&gt;reconnectTask&lt;/tt&gt; is started.&lt;/p&gt;</comment>
                            <comment id="17513897" author="orpiske" created="Tue, 29 Mar 2022 08:00:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pascalschumacher&quot; class=&quot;user-hover&quot; rel=&quot;pascalschumacher&quot;&gt;pascalschumacher&lt;/a&gt; that helps a lot, actually. I think your assessment could be correct.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;If you are OK with it, I&apos;d like to propose a two-step approach as I am unable to reproduce it: let me create a PR with some additional logs around that part (and others), and then I can create a fix for it. I&apos;ll do that later today and if you are able to test it, it would be awesome.&lt;/p&gt;</comment>
                            <comment id="17514259" author="pascalschumacher" created="Tue, 29 Mar 2022 18:05:26 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=orpiske&quot; class=&quot;user-hover&quot; rel=&quot;orpiske&quot;&gt;orpiske&lt;/a&gt; Thank you very much!&lt;/p&gt;

&lt;p&gt;I do not know if I will be able to reproduce the problem in a test environment, but I will give it a try.&lt;/p&gt;</comment>
                            <comment id="17612917" author="orpiske" created="Wed, 5 Oct 2022 09:02:51 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pascalschumacher&quot; class=&quot;user-hover&quot; rel=&quot;pascalschumacher&quot;&gt;pascalschumacher&lt;/a&gt; is this still an issue? I am wondering if the recent versions gave you more information about this?&lt;/p&gt;</comment>
                            <comment id="17641334" author="pascalschumacher" created="Wed, 30 Nov 2022 14:21:02 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=orpiske&quot; class=&quot;user-hover&quot; rel=&quot;orpiske&quot;&gt;orpiske&lt;/a&gt;&#160; Sorry for the late reply. The issue did not reoccur. My guess it that it is still present, but a very a rare race condition (or did you or anybody else fix something I am not aware of?). As there has been no new information for a long time it is o.k. to close it. We can always reopen or create a new issue.&lt;/p&gt;</comment>
                            <comment id="17641718" author="orpiske" created="Thu, 1 Dec 2022 07:22:28 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pascalschumacher&quot; class=&quot;user-hover&quot; rel=&quot;pascalschumacher&quot;&gt;pascalschumacher&lt;/a&gt; there were no other fixes I am aware of, so I guess it&apos;s a rare condition. I agree with closing the ticket for now ... In case it happens, we can reopen. &lt;/p&gt;

&lt;p&gt;Thanks for the update!&lt;/p&gt;</comment>
                            <comment id="17641719" author="orpiske" created="Thu, 1 Dec 2022 07:23:56 +0000"  >&lt;p&gt;It may have been fixed as part of 3.18.x, so closing it for now.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 49 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z10v5c:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310080" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Regression</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10091"><![CDATA[Regression]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>