<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 11:03:57 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-20214] camel-core - Timeout tasks of parallel splitter block further message processing</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-20214</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;After an update from Camel 2.x to Camel 3.14.7 we noticed the following issue in all newer Camel 3 versions:&lt;/p&gt;

&lt;p&gt;A parallel splitter uses per default a ThreadPoolProfile with maxQueueSize = 1000.&lt;br/&gt;
If the route is called 1001 times within the configured splitter timeout one message failes with &quot;java.util.concurrent.RejectedExecutionException: Task rejected due queue size limit reached&quot; which is thrown by the SizedScheduledExecutorService class.&lt;/p&gt;

&lt;p&gt;For each call of the route one &quot;timeout&quot; task is added to the DelayedWorkQueue which is used by the &quot;Splitter- AggregateTask&quot; thread. Each of this &quot;timeout&quot; tasks wait until its timeout is reached although the message processing is already completed. That means the 1000 messages are already processed sucessfully but the 1000 &quot;timeout&quot; tasks are still in the DelayedWorkQueue and block further message processing (until the timeout is reached) because the queue is full.&lt;/p&gt;

&lt;p&gt;We found some comments in the MulticastProcessor.doStart() method that an unbounded thread pool has to be used for the &quot;Splitter-AggregateTask&quot; thread to avoid issues.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* use unbounded thread pool so we ensure the aggregate on-the-fly task always will have assigned a thread and run the tasks when the task is submitted. If not then the aggregate task may not be able to run and signal completion during processing, which would lead to what would appear as a dead-lock or a slow processing */&lt;/span&gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Therefore we assume the maxQueueSize should also be unlimited when the thread pool is created in MulticastProcessor.createAggregateExcutorService().&lt;/p&gt;

&lt;p&gt;A short test to reproduce the mentioned issue (maxQueueSize is set to 1 to reproduce the issue with only two calls):&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;SplitterTest &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; CamelTestSupport {&#160; &#160; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; payload1 = &lt;span class=&quot;code-quote&quot;&gt;&quot;&amp;lt;items&amp;gt;&amp;lt;item&amp;gt;&amp;lt;id&amp;gt;1&amp;lt;/id&amp;gt;&amp;lt;name&amp;gt;one&amp;lt;/name&amp;gt;&amp;lt;/item&amp;gt;&amp;lt;item&amp;gt;&amp;lt;id&amp;gt;2&amp;lt;/id&amp;gt;&amp;lt;name&amp;gt;two&amp;lt;/name&amp;gt;&amp;lt;/item&amp;gt;&amp;lt;/items&amp;gt;&quot;&lt;/span&gt;;
&#160; &#160; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; payload2 = &lt;span class=&quot;code-quote&quot;&gt;&quot;&amp;lt;items&amp;gt;&amp;lt;item&amp;gt;&amp;lt;id&amp;gt;3&amp;lt;/id&amp;gt;&amp;lt;name&amp;gt;three&amp;lt;/name&amp;gt;&amp;lt;/item&amp;gt;&amp;lt;item&amp;gt;&amp;lt;id&amp;gt;4&amp;lt;/id&amp;gt;&amp;lt;name&amp;gt;four&amp;lt;/name&amp;gt;&amp;lt;/item&amp;gt;&amp;lt;/items&amp;gt;&quot;&lt;/span&gt;;
&#160; &#160;&#160;
&#160; &#160; @Test
&#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testSplitter() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; InterruptedException, IOException {
&#160; &#160; &#160; &#160; MockEndpoint mockEndpoint = getMockEndpoint(&lt;span class=&quot;code-quote&quot;&gt;&quot;mock:split&quot;&lt;/span&gt;);
&#160; &#160; &#160; &#160; mockEndpoint.expectedMessageCount(4);&#160; &#160; &#160; &#160; template.sendBody(&lt;span class=&quot;code-quote&quot;&gt;&quot;direct:start&quot;&lt;/span&gt;, payload1);
&#160; &#160; &#160; &#160; template.sendBody(&lt;span class=&quot;code-quote&quot;&gt;&quot;direct:start&quot;&lt;/span&gt;, payload2);&#160; &#160; &#160; &#160; assertMockEndpointsSatisfied();
&#160; &#160; }&#160; &#160; @Override
&#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; RouteBuilder createRouteBuilder() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
&#160; &#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RouteBuilder() {
&#160; &#160; &#160; &#160; &#160; &#160; @Override
&#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void configure() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; ThreadPoolProfile myThreadPoolProfile = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ThreadPoolProfile(&lt;span class=&quot;code-quote&quot;&gt;&quot;testProfile&quot;&lt;/span&gt;);
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; myThreadPoolProfile.setMaxPoolSize(20);
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; myThreadPoolProfile.setPoolSize(10);
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; myThreadPoolProfile.setMaxQueueSize(1);
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; getContext().getExecutorServiceManager().setDefaultThreadPoolProfile(myThreadPoolProfile);&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; from(&lt;span class=&quot;code-quote&quot;&gt;&quot;direct:start&quot;&lt;/span&gt;)
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; .split()
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; .xpath(&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-comment&quot;&gt;//items/item&quot;&lt;/span&gt;)
&lt;/span&gt;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; .parallelProcessing(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; .streaming(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; .stopOnException(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; .timeout(&lt;span class=&quot;code-quote&quot;&gt;&quot;300000&quot;&lt;/span&gt;)
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; .executorServiceRef(&lt;span class=&quot;code-quote&quot;&gt;&quot;testProfile&quot;&lt;/span&gt;)
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; .to(&lt;span class=&quot;code-quote&quot;&gt;&quot;mock:split&quot;&lt;/span&gt;);
&#160; &#160; &#160; &#160; &#160; &#160; }
&#160; &#160; &#160; &#160; };
&#160; &#160; }
&#160; &#160;&#160;
}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13561351">CAMEL-20214</key>
            <summary>camel-core - Timeout tasks of parallel splitter block further message processing</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="AWeickel">Andre Weickel</reporter>
                        <labels>
                    </labels>
                <created>Mon, 11 Dec 2023 09:45:25 +0000</created>
                <updated>Mon, 11 Dec 2023 14:24:36 +0000</updated>
                            <resolved>Mon, 11 Dec 2023 14:24:36 +0000</resolved>
                                    <version>3.14.10</version>
                    <version>3.21.2</version>
                                    <fixVersion>3.21.4</fixVersion>
                    <fixVersion>3.22.0</fixVersion>
                    <fixVersion>4.0.4</fixVersion>
                    <fixVersion>4.3.0</fixVersion>
                                    <component>came-core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17795358" author="davsclaus" created="Mon, 11 Dec 2023 13:15:51 +0000"  >&lt;p&gt;Thanks for reporting, the analysis, and the unit test.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 48 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1m6fc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>