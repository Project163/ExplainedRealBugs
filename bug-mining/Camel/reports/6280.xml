<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:58:15 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-18612] Inconsistency in JsonPath component causes problems with databinding</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-18612</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;Inconsistent treatment of jsonpath expression result causes problems with data binding. When jsonpath evaluates to an array element, this piece of code threats it as a single object, making it impossible to bind to an array of objects.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
(singleElement &amp;amp;&amp;amp; !resultIsCollection) {
    result = ((List) result).get(0);
    ...
}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Steps to reproduce:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Create this Camel route&#160;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
from(&lt;span class=&quot;code-quote&quot;&gt;&quot;file:work/&quot;&lt;/span&gt;)
        .routeId(&lt;span class=&quot;code-quote&quot;&gt;&quot;file-route&quot;&lt;/span&gt;)
        .to(&lt;span class=&quot;code-quote&quot;&gt;&quot;direct:transform&quot;&lt;/span&gt;);

from(&lt;span class=&quot;code-quote&quot;&gt;&quot;direct:transform&quot;&lt;/span&gt;)
        .routeId(&lt;span class=&quot;code-quote&quot;&gt;&quot;direct-transform&quot;&lt;/span&gt;)
        .streamCaching()
        .log(&lt;span class=&quot;code-quote&quot;&gt;&quot;Before jsonpath transformation &amp;gt;&amp;gt;&amp;gt; ${body}&quot;&lt;/span&gt;)
        .setBody().jsonpath(&lt;span class=&quot;code-quote&quot;&gt;&quot;$.d.results&quot;&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.class)
        .log(&lt;span class=&quot;code-quote&quot;&gt;&quot;After jsonpath transformation &amp;gt;&amp;gt;&amp;gt; ${body}&quot;&lt;/span&gt;)
        .process(exchange -&amp;gt; {
            log.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Before Jackson deserialization&quot;&lt;/span&gt;);

            &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; testResponse = exchange.getMessage().getBody(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.class);
            objectMapper.readValue(testResponse, TestResultsInfo[].class);

            log.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;After Jackson deserialization&quot;&lt;/span&gt;);
        })
        .to(&lt;span class=&quot;code-quote&quot;&gt;&quot;mock:test&quot;&lt;/span&gt;);&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ol&gt;


&lt;ol&gt;
	&lt;li&gt;Use the &lt;em&gt;single-item-array.json&lt;/em&gt; file from the attachment&lt;/li&gt;
	&lt;li&gt;Try to bind the message body to these classes
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@Data
@NoArgsConstructor
@JsonIgnoreProperties(ignoreUnknown = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;TestResultsInfo {

    &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; resultText;
    @JsonProperty(value = &lt;span class=&quot;code-quote&quot;&gt;&quot;AddressInfo&quot;&lt;/span&gt;)
    TestAddressInfo addressInfo;

}

@Data
@NoArgsConstructor
@JsonIgnoreProperties(ignoreUnknown = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;TestAddressInfo {

    @JsonProperty(value = &lt;span class=&quot;code-quote&quot;&gt;&quot;City&quot;&lt;/span&gt;)
    &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; city;
    @JsonProperty(value = &lt;span class=&quot;code-quote&quot;&gt;&quot;State&quot;&lt;/span&gt;)
    &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; street;

}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;It will fail because it&apos;s not possible to bind it to &lt;em&gt;TestResultsInfo[].&lt;/em&gt;&#160;If you add a second element to the array (or use &lt;em&gt;multiple-item-array.json&lt;/em&gt; file instead), it will work fine.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13486331">CAMEL-18612</key>
            <summary>Inconsistency in JsonPath component causes problems with databinding</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rnetuka">Radovan Netuka</assignee>
                                    <reporter username="rnetuka">Radovan Netuka</reporter>
                        <labels>
                    </labels>
                <created>Fri, 14 Oct 2022 12:52:24 +0000</created>
                <updated>Thu, 20 Oct 2022 13:52:27 +0000</updated>
                            <resolved>Thu, 20 Oct 2022 12:58:58 +0000</resolved>
                                                    <fixVersion>3.18.3</fixVersion>
                    <fixVersion>3.20.0</fixVersion>
                                    <component>camel-jsonpath</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17618826" author="davsclaus" created="Mon, 17 Oct 2022 10:59:43 +0000"  >&lt;p&gt;Why do you convert the result to a String when its an array type? When you convert to String then the JDK will convert the List to a string by calling toString, which does a string dump that happens to look like json but it is not.&lt;/p&gt;

&lt;p&gt;In the PR unit test the result is:&lt;/p&gt;

&lt;p&gt;[&lt;/p&gt;
{category=programming, author=Claus Ibsen,Jonathan Anstey, title=Camel in Action, price=39.99, isbn=978-193-518-236-8}
&lt;p&gt;]&lt;/p&gt;
</comment>
                            <comment id="17618830" author="davsclaus" created="Mon, 17 Oct 2022 11:09:39 +0000"  >&lt;p&gt;I think the conversion to String is not correct as its not json string, but a JDK toString from a List. So instead you can change test as follows&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; books = getMockEndpoint(&lt;span class=&quot;code-quote&quot;&gt;&quot;mock:books&quot;&lt;/span&gt;).getReceivedExchanges().get(0).getIn().getBody();

        ObjectMapper objectMapper = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ObjectMapper();
        &lt;span class=&quot;code-comment&quot;&gt;// convert the result to valid Json string
&lt;/span&gt;        &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; json = objectMapper.writeValueAsString(books);
        &lt;span class=&quot;code-comment&quot;&gt;// and convert json to pojo via jackson
&lt;/span&gt;        Book[] result = objectMapper.readValue(json, Book[].class);

        Book[] expected = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Book[] { &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Book(&lt;span class=&quot;code-quote&quot;&gt;&quot;programming&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;Claus Ibsen,Jonathan Anstey&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;Camel in Action&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;39.99&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;978-193-518-236-8&quot;&lt;/span&gt;) };
        assertArrayEquals(expected, result);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And in the route you do&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
      &amp;lt;transform&amp;gt;
        &amp;lt;jsonpath&amp;gt;$.store.book&amp;lt;/jsonpath&amp;gt;
      &amp;lt;/transform&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Then its more correct&lt;/p&gt;</comment>
                            <comment id="17618874" author="rnetuka" created="Mon, 17 Oct 2022 12:39:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davsclaus&quot; class=&quot;user-hover&quot; rel=&quot;davsclaus&quot;&gt;davsclaus&lt;/a&gt; &quot;Why do you convert the result to a String when its an array type?&quot; Because that&apos;s the use case that&apos;s failing. If you use returnType=String to get a Json string a then try to bind it with Jackson-databind.&lt;/p&gt;

&lt;p&gt;Note: if you don&apos;t specify any return type, it will work because it will fall into an else branch&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;With the databind, it&apos;s more visible there is a fault, but you can check it even without it:&lt;/p&gt;

&lt;p&gt;assertTrue(books.startsWith(&quot;[&quot;));&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The suggested code doesn&apos;t help. The bug is reproducable only when a resultType is specified as String.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;When combined with camel-jackson, there is a &lt;em&gt;JacksonTypeConverters&lt;/em&gt; that kicks in and returns the json string. Unfortunately, it seems it can&apos;t be used in the unit test, since it&apos;s an independant component.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17618927" author="rnetuka" created="Mon, 17 Oct 2022 14:13:25 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davsclaus&quot; class=&quot;user-hover&quot; rel=&quot;davsclaus&quot;&gt;davsclaus&lt;/a&gt; Also, I think the following code might also fix the issue:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; resultIsCollection = Collection.&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;isAssignableFrom(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.resultType);
&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; singleElement = result &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; List &amp;amp;&amp;amp; ((List)result).size() == 1;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (singleElement &amp;amp;&amp;amp; !resultIsCollection &amp;amp;&amp;amp; !(resultType==&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.class)) {
    result = ((List)result).get(0);
    LOG.trace(&lt;span class=&quot;code-quote&quot;&gt;&quot;Unwrapping result: {} from single element List before converting to: {}&quot;&lt;/span&gt;, result, &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.resultType);
} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Note the added&#160;&lt;b&gt;&amp;amp;&amp;amp; !(resultType==String.class)&lt;/b&gt;. Just tell me, if you prefer this solution.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I still think the code above smells. A single-element list is still a list and shouldn&apos;t be returned as a member of itself.&lt;/p&gt;</comment>
                            <comment id="17619356" author="davsclaus" created="Tue, 18 Oct 2022 08:46:54 +0000"  >&lt;p&gt;I think the code is used when you use jsonpath to filter, where you then filter and have 1 element as the result List(size 1), and want to grab it as X type instead of List(size 1)&amp;lt;X&amp;gt;.&lt;/p&gt;</comment>
                            <comment id="17619476" author="davsclaus" created="Tue, 18 Oct 2022 12:01:25 +0000"  >&lt;p&gt;Yeah its a bit of hack with the list unwrap if size == 1.&lt;/p&gt;

&lt;p&gt;I think we should not do this by default, but add a new option on camel-jsonpath, so end users can turn back the old behaviour in case of backwards compatible.&lt;br/&gt;
However to find a good name for such option is &quot;hard&quot;.&lt;/p&gt;

&lt;p&gt;unwrapSingleArray=true|false&lt;/p&gt;
</comment>
                            <comment id="17619610" author="rnetuka" created="Tue, 18 Oct 2022 14:29:32 +0000"  >&lt;p&gt;I agree with the new option solution. This will fix the issue while maintaining backwards compatibility (if the option is enabled).&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;PR: &lt;a href=&quot;https://github.com/apache/camel/pull/8571&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/8571&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17620450" author="davsclaus" created="Wed, 19 Oct 2022 16:30:59 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rnetuka&quot; class=&quot;user-hover&quot; rel=&quot;rnetuka&quot;&gt;rnetuka&lt;/a&gt; can you send a PR to update the upgrade guide at&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/camel/blob/main/docs/user-manual/modules/ROOT/pages/camel-3x-upgrade-guide-3_20.adoc&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/blob/main/docs/user-manual/modules/ROOT/pages/camel-3x-upgrade-guide-3_20.adoc&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;We can then take that and also put in the 3.18 guide and mention that this is for Camel 3.18.3 onwards.&lt;/p&gt;</comment>
                            <comment id="17620997" author="davsclaus" created="Thu, 20 Oct 2022 10:47:11 +0000"  >&lt;p&gt;This is the last ticket for 3.18.x, would you be able to send a PR today&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13103688">CAMEL-11796</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13050943" name="multiple-item-array.json" size="257" author="rnetuka" created="Fri, 14 Oct 2022 12:53:03 +0000"/>
                            <attachment id="13050944" name="single-item-array.json" size="150" author="rnetuka" created="Fri, 14 Oct 2022 12:53:03 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 3 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z19dhc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>