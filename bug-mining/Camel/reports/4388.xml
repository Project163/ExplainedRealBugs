<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:27:31 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-12111] Reconnect doesn&apos;t work if camel is started with rabbit broker initially inaccessible and automaticRecoveryEnabled=true or not set</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-12111</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;Starting a camel rabbit consumer with the rabbitmq broker down and then bringing the broker up used to work before 2.20.1 with automaticRecoveryEnabled=true.  &lt;/p&gt;

&lt;p&gt;The logic added in line 298 of the RabbitConsumer and line 301 now only will recover in the case if automaticRecoveryEnabled=false by allowing it through to line 303 and opening a connection for the FIRST TIME.  &lt;/p&gt;

&lt;p&gt; In addition line 298 null pointers on &apos;&amp;amp;&amp;amp; null&apos; if automaticRecoveryEnabled wasn&apos;t specified at all.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/camel/blob/bad9ed4bb2ce1e258039d96ac80c71a746b0520d/components/camel-rabbitmq/src/main/java/org/apache/camel/component/rabbitmq/RabbitConsumer.java#L298&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/blob/bad9ed4bb2ce1e258039d96ac80c71a746b0520d/components/camel-rabbitmq/src/main/java/org/apache/camel/component/rabbitmq/RabbitConsumer.java#L298&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;As of now you can not have automaticRecoveryEnabled either not set or true and handle have camel work in the startup with broker down and then up use case.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13128065">CAMEL-12111</key>
            <summary>Reconnect doesn&apos;t work if camel is started with rabbit broker initially inaccessible and automaticRecoveryEnabled=true or not set</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="jisikoff">Jeremy M Isikoff</reporter>
                        <labels>
                    </labels>
                <created>Tue, 2 Jan 2018 20:09:13 +0000</created>
                <updated>Sat, 6 Jan 2018 12:03:55 +0000</updated>
                            <resolved>Sat, 6 Jan 2018 12:03:55 +0000</resolved>
                                    <version>2.20.1</version>
                                    <fixVersion>2.20.2</fixVersion>
                    <fixVersion>2.21.0</fixVersion>
                                    <component>camel-rabbitmq</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16309521" author="davsclaus" created="Wed, 3 Jan 2018 11:32:48 +0000"  >&lt;p&gt;You are welcome to work on a fix/patch, such as a github PR&lt;br/&gt;
&lt;a href=&quot;http://camel.apache.org/contributing&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://camel.apache.org/contributing&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16311501" author="githubbot" created="Thu, 4 Jan 2018 15:28:47 +0000"  >&lt;p&gt;jisikoff opened a new pull request #2164: &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12111&quot; title=&quot;Reconnect doesn&amp;#39;t work if camel is started with rabbit broker initially inaccessible and automaticRecoveryEnabled=true or not set&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12111&quot;&gt;&lt;del&gt;CAMEL-12111&lt;/del&gt;&lt;/a&gt;: Fix reconnect if broker is down on startup.  Also fix so&#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2164&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2164&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   &#8230; channels share connections again.  Also fix consumers getting started twice on reconnect at startup.  Also fix null pointers if automaticRecoveryEnabled is not set on the endpoint.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16311502" author="githubbot" created="Thu, 4 Jan 2018 15:28:48 +0000"  >&lt;p&gt;GitHub user jisikoff opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/camel/pull/2164&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2164&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12111&quot; title=&quot;Reconnect doesn&amp;#39;t work if camel is started with rabbit broker initially inaccessible and automaticRecoveryEnabled=true or not set&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12111&quot;&gt;&lt;del&gt;CAMEL-12111&lt;/del&gt;&lt;/a&gt;: Fix reconnect if broker is down on startup.  Also fix so&#8230;&lt;/p&gt;

&lt;p&gt;    &#8230; channels share connections again.  Also fix consumers getting started twice on reconnect at startup.  Also fix null pointers if automaticRecoveryEnabled is not set on the endpoint.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/cinch-financial/camel&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/cinch-financial/camel&lt;/a&gt; feature/&lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12111&quot; title=&quot;Reconnect doesn&amp;#39;t work if camel is started with rabbit broker initially inaccessible and automaticRecoveryEnabled=true or not set&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12111&quot;&gt;&lt;del&gt;CAMEL-12111&lt;/del&gt;&lt;/a&gt;-reconnect-on-start&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/camel/pull/2164.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2164.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #2164&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 17216a11c6996992a64e3f254c48a5e82b50c12d&lt;br/&gt;
Author: Jeremy Isikoff &amp;lt;jisikoff@...&amp;gt;&lt;br/&gt;
Date:   2018-01-04T14:42:37Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12111&quot; title=&quot;Reconnect doesn&amp;#39;t work if camel is started with rabbit broker initially inaccessible and automaticRecoveryEnabled=true or not set&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12111&quot;&gt;&lt;del&gt;CAMEL-12111&lt;/del&gt;&lt;/a&gt;: Fix reconnect if broker is down on startup.  Also fix so channels share connections again.  Also fix consumers getting started twice on reconnect at startup.  Also fix null pointers if automaticRecoveryEnabled is not set on the endpoint.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16314523" author="githubbot" created="Sat, 6 Jan 2018 12:02:47 +0000"  >&lt;p&gt;davsclaus closed pull request #2164: &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12111&quot; title=&quot;Reconnect doesn&amp;#39;t work if camel is started with rabbit broker initially inaccessible and automaticRecoveryEnabled=true or not set&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12111&quot;&gt;&lt;del&gt;CAMEL-12111&lt;/del&gt;&lt;/a&gt;: Fix reconnect if broker is down on startup.  Also fix so&#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2164&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2164&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/components/camel-rabbitmq/src/main/java/org/apache/camel/component/rabbitmq/RabbitConsumer.java b/components/camel-rabbitmq/src/main/java/org/apache/camel/component/rabbitmq/RabbitConsumer.java&lt;br/&gt;
index e96367c6e2f..ffef62d003c 100644&lt;br/&gt;
&amp;#8212; a/components/camel-rabbitmq/src/main/java/org/apache/camel/component/rabbitmq/RabbitConsumer.java&lt;br/&gt;
+++ b/components/camel-rabbitmq/src/main/java/org/apache/camel/component/rabbitmq/RabbitConsumer.java&lt;br/&gt;
@@ -295,10 +295,10 @@ public void reconnect() throws IOException, TimeoutException {&lt;br/&gt;
         if (isChannelOpen()) &lt;/p&gt;
{
             // The connection is good, so nothing to do
             return;
-        }
&lt;p&gt; else if (!isChannelOpen() &amp;amp;&amp;amp; this.consumer.getEndpoint().getAutomaticRecoveryEnabled()) &lt;/p&gt;
{
+        } else if (channel != null &amp;amp;&amp;amp; !channel.isOpen() &amp;amp;&amp;amp; isAutomaticRecoveryEnabled()) {
             // Still need to wait for channel to re-open
             throw new IOException(&quot;Waiting for channel to re-open.&quot;);
-        } else if (!this.consumer.getEndpoint().getAutomaticRecoveryEnabled()) {+        }
&lt;p&gt; else if (channel == null || !isAutomaticRecoveryEnabled()) {&lt;br/&gt;
             log.info(&quot;Attempting to open a new rabbitMQ channel&quot;);&lt;br/&gt;
             Connection conn = consumer.getConnection();&lt;br/&gt;
             channel = openChannel(conn);&lt;br/&gt;
@@ -307,6 +307,11 @@ public void reconnect() throws IOException, TimeoutException {&lt;br/&gt;
         }&lt;br/&gt;
     }&lt;/p&gt;

&lt;p&gt;+    private boolean isAutomaticRecoveryEnabled() &lt;/p&gt;
{
+        return this.consumer.getEndpoint().getAutomaticRecoveryEnabled() != null
+            &amp;amp;&amp;amp; this.consumer.getEndpoint().getAutomaticRecoveryEnabled();
+    }
&lt;p&gt;+&lt;br/&gt;
     private boolean isChannelOpen() &lt;/p&gt;
{
         return channel != null &amp;amp;&amp;amp; channel.isOpen();
     }
&lt;p&gt;diff --git a/components/camel-rabbitmq/src/main/java/org/apache/camel/component/rabbitmq/RabbitMQConsumer.java b/components/camel-rabbitmq/src/main/java/org/apache/camel/component/rabbitmq/RabbitMQConsumer.java&lt;br/&gt;
index 95a660925ee..c0aaa6d5d03 100644&lt;br/&gt;
&amp;#8212; a/components/camel-rabbitmq/src/main/java/org/apache/camel/component/rabbitmq/RabbitMQConsumer.java&lt;br/&gt;
+++ b/components/camel-rabbitmq/src/main/java/org/apache/camel/component/rabbitmq/RabbitMQConsumer.java&lt;br/&gt;
@@ -74,7 +74,7 @@ protected synchronized Connection getConnection() throws IOException, TimeoutExc&lt;br/&gt;
         if (this.conn == null) &lt;/p&gt;
{
             openConnection();
             return this.conn;
-        }
&lt;p&gt; else if (!this.conn.isOpen() &amp;amp;&amp;amp; this.endpoint.getAutomaticRecoveryEnabled()) &lt;/p&gt;
{
+        }
&lt;p&gt; else if (this.conn.isOpen() || (!this.conn.isOpen() &amp;amp;&amp;amp; isAutomaticRecoveryEnabled())) &lt;/p&gt;
{
             return this.conn;
         }
&lt;p&gt; else &lt;/p&gt;
{
             log.debug(&quot;The existing connection is closed&quot;);
@@ -83,16 +83,24 @@ protected synchronized Connection getConnection() throws IOException, TimeoutExc
         }
&lt;p&gt;     }&lt;/p&gt;

&lt;p&gt;-&lt;br/&gt;
+    private boolean isAutomaticRecoveryEnabled() &lt;/p&gt;
{
+        return this.endpoint.getAutomaticRecoveryEnabled() != null
+            &amp;amp;&amp;amp; this.endpoint.getAutomaticRecoveryEnabled();
+    }
&lt;p&gt;     /**&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;* Add a consumer thread for given channel&lt;br/&gt;
+     * Create the consumers but don&apos;t start yet&lt;br/&gt;
      */&lt;/li&gt;
	&lt;li&gt;private void startConsumers() throws IOException {&lt;br/&gt;
-&lt;br/&gt;
+    private void createConsumers() throws IOException 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {         // Create consumers but don&amp;#39;t start yet         for (int i = 0; i &amp;lt; endpoint.getConcurrentConsumers(); i++) {
             createConsumer();
         }+    }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;+&lt;br/&gt;
+    /**&lt;br/&gt;
+     * Start the consumers (already created)&lt;br/&gt;
+     */&lt;br/&gt;
+    private void startConsumers() {&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         // Try starting consumers (which will fail if RabbitMQ can&apos;t connect)&lt;br/&gt;
         try {&lt;br/&gt;
@@ -160,6 +168,7 @@ protected void doResume() throws Exception {&lt;br/&gt;
     protected void doStart() throws Exception {&lt;br/&gt;
         executor = endpoint.createExecutor();&lt;br/&gt;
         log.debug(&quot;Using executor {}&quot;, executor);&lt;br/&gt;
+        createConsumers();&lt;br/&gt;
         startConsumers();&lt;br/&gt;
     }&lt;/p&gt;

&lt;p&gt;@@ -211,9 +220,6 @@ public Void call() throws Exception &lt;/p&gt;
{
                     Thread.sleep(connectionRetryInterval);
                 }
&lt;p&gt;             }&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (!connectionFailed) 
{
-                startConsumers();
-            }
&lt;p&gt;             stop();&lt;br/&gt;
             return null;&lt;br/&gt;
         }&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;





&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16314524" author="githubbot" created="Sat, 6 Jan 2018 12:02:48 +0000"  >&lt;p&gt;Github user davsclaus closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/camel/pull/2164&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2164&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16314525" author="davsclaus" created="Sat, 6 Jan 2018 12:03:55 +0000"  >&lt;p&gt;Thanks for reporting and the PR&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 45 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3ofpb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>