<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 11:04:12 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-19849] camel-zipfile: fails to release exchange due to Exceptions</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-19849</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;&lt;b&gt;Note&lt;/b&gt;: this issue is still under investigation.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2023-09-12 10:48:41,210 DEBUG [org.apa.cam.dat.zip.ZipIterator] (Camel (camel-1) thread #10 - Split) read zipEntry META-INF/services/io.quarkus.dev.spi.HotReplacementSetup
2023-09-12 10:48:41,211 WARN  [org.apa.cam.pro.MulticastProcessor] (Camel (camel-1) thread #4 - Split) Error releasing exchange due to java.util.zip.ZipException: invalid code -- missing end-of-block. This exception is ignored.: org.apache.camel.RuntimeCamelException: java.util.zip.ZipException: invalid code -- missing end-of-block
	at org.apache.camel.dataformat.zipfile.ZipIterator.getNextElement(ZipIterator.java:129)
	at org.apache.camel.dataformat.zipfile.ZipIterator.next(ZipIterator.java:93)
	at org.apache.camel.dataformat.zipfile.ZipIterator.next(ZipIterator.java:40)
	at org.apache.camel.processor.Splitter$SplitterIterable$1.next(Splitter.java:230)
	at org.apache.camel.processor.Splitter$SplitterIterable$1.next(Splitter.java:203)
	at org.apache.camel.processor.MulticastProcessor.doDone(MulticastProcessor.java:816)
	at org.apache.camel.processor.MulticastProcessor$MulticastTask.doDone(MulticastProcessor.java:484)
	at org.apache.camel.processor.MulticastProcessor$MulticastReactiveTask.run(MulticastProcessor.java:584)
	at org.apache.camel.impl.engine.DefaultReactiveExecutor$Worker.schedule(DefaultReactiveExecutor.java:189)
	at org.apache.camel.impl.engine.DefaultReactiveExecutor.schedule(DefaultReactiveExecutor.java:56)
	at org.apache.camel.processor.MulticastProcessor.lambda$schedule$1(MulticastProcessor.java:336)
	at java.base/java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:539)
	at java.base/java.util.concurrent.FutureTask.run(FutureTask.java:264)
	at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1136)
	at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:635)
	at java.base/java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:833)
Caused by: java.util.zip.ZipException: invalid code -- missing end-of-block
	at java.base/java.util.zip.InflaterInputStream.read(InflaterInputStream.java:164)
	at java.base/java.util.zip.ZipInputStream.read(ZipInputStream.java:196)
	at java.base/java.util.zip.ZipInputStream.closeEntry(ZipInputStream.java:142)
	at java.base/java.util.zip.ZipInputStream.getNextEntry(ZipInputStream.java:120)
	at org.apache.camel.dataformat.zipfile.ZipIterator.getNextEntry(ZipIterator.java:143)
	at org.apache.camel.dataformat.zipfile.ZipIterator.getNextElement(ZipIterator.java:114)
	... 15 more

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13550336">CAMEL-19849</key>
            <summary>camel-zipfile: fails to release exchange due to Exceptions</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="10008">Information Provided</resolution>
                                        <assignee username="orpiske">Otavio Rodolfo Piske</assignee>
                                    <reporter username="orpiske">Otavio Rodolfo Piske</reporter>
                        <labels>
                    </labels>
                <created>Tue, 12 Sep 2023 09:05:20 +0000</created>
                <updated>Sun, 24 Dec 2023 08:45:58 +0000</updated>
                            <resolved>Sun, 24 Dec 2023 08:45:58 +0000</resolved>
                                                    <fixVersion>4.4.0</fixVersion>
                                    <component>camel-zipfile</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17764110" author="orpiske" created="Tue, 12 Sep 2023 09:33:07 +0000"  >&lt;p&gt;This seems to happen with parallelProcessing on the route.&lt;/p&gt;</comment>
                            <comment id="17764669" author="orpiske" created="Wed, 13 Sep 2023 13:20:01 +0000"  >&lt;p&gt;We found that: &lt;/p&gt;

&lt;p&gt;1. This happens only when using parallelProcessing &lt;br/&gt;
2. We also found that in that case, it call the &lt;a href=&quot;https://github.com/apache/camel/blob/09db270a944fdb43c51635f1a8b1ea03bc46c378/components/camel-zipfile/src/main/java/org/apache/camel/dataformat/zipfile/ZipIterator.java#L133&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;close on checkNullAnswer&lt;/a&gt; and &lt;a href=&quot;https://github.com/apache/camel/blob/09db270a944fdb43c51635f1a8b1ea03bc46c378/components/camel-zipfile/src/main/java/org/apache/camel/dataformat/zipfile/ZipIterator.java#L162&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;the close on the ZipIterator&lt;/a&gt; before the &lt;a href=&quot;https://github.com/apache/camel/blob/09db270a944fdb43c51635f1a8b1ea03bc46c378/components/camel-zipfile/src/main/java/org/apache/camel/dataformat/zipfile/ZipInputStreamWrapper.java#L34&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;close on the ZipInputStreamWrapper&lt;/a&gt;. This is the contrary of the non-parallel mode, in which it calls the close on the ZipInputstream before the one in hasNext and the one in close (see below) &lt;/p&gt;



&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
#### Baseline (running in non parallel)

Calling close on ZipInputStreamWrapper # 1
Calling close on ZipInputStreamWrapper # 2
Calling close on ZipInputStreamWrapper # 3
Calling close on ZipInputStreamWrapper # 4
Calling close on ZipInputStreamWrapper # 5
Calling hasNext # 1
Calling close # 1


###### With parallelProcessing

Calling checkNullAnswer # 1
Calling close # 1
Calling close on ZipInputStreamWrapper # 1
Calling close on ZipInputStreamWrapper # 3
Calling close on ZipInputStreamWrapper # 4
Calling close on ZipInputStreamWrapper # 2
Calling close on ZipInputStreamWrapper # 5
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;A reproducer can be &lt;a href=&quot;https://github.com/orpiske/camel/blob/camel-19849/components/camel-zipfile/src/test/java/org/apache/camel/dataformat/zipfile/ZipSplitterRouteParallelTest.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;found here&lt;/a&gt;. Essentially it can be reproduced using a route like: &lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void configure() {
                &lt;span class=&quot;code-comment&quot;&gt;// Unzip file and Split it according to FileEntry
&lt;/span&gt;                from(&lt;span class=&quot;code-quote&quot;&gt;&quot;file:src/test/resources/org/apache/camel/dataformat/zipfile/data?delay=1000&amp;amp;noop=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt;)
                        .log(&lt;span class=&quot;code-quote&quot;&gt;&quot;Start processing big file: ${header.CamelFileName}&quot;&lt;/span&gt;)
                        .split(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ZipSplitter()).streaming().parallelProcessing()
                        .to(&lt;span class=&quot;code-quote&quot;&gt;&quot;log:entry&quot;&lt;/span&gt;)
                        .convertBodyTo(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.class).to(&lt;span class=&quot;code-quote&quot;&gt;&quot;mock:processZipEntry&quot;&lt;/span&gt;)
                        .end()
                        .log(&lt;span class=&quot;code-quote&quot;&gt;&quot;Done processing big file: ${header.CamelFileName}&quot;&lt;/span&gt;);
            }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;




</comment>
                            <comment id="17767074" author="davsclaus" created="Wed, 20 Sep 2023 10:35:55 +0000"  >&lt;p&gt;I think its the ZipSplitter that is some kind of Iterator that would be hard to make it close correctly in all situations.&lt;/p&gt;

&lt;p&gt;btw camel-tarfile is similar to zipfile so it may have same situation.&lt;/p&gt;</comment>
                            <comment id="17800144" author="davsclaus" created="Sun, 24 Dec 2023 08:42:45 +0000"  >&lt;p&gt;This cannot support parallel processing as the input stream being read is shared&lt;/p&gt;</comment>
                            <comment id="17800145" author="davsclaus" created="Sun, 24 Dec 2023 08:45:58 +0000"  >&lt;p&gt;Update docs about limitation&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 46 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1kats:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>