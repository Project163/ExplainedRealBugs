<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 11:12:44 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-22410] SchedulingPollConsumer is not thread safe during graceful shutdown.</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-22410</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;SchedulingPollConsumer has a race condition that causes the SQS library to throw an SdkInterruptedException during shutdown. This results in timed-out messages delivered to the dead-letter-queue.&lt;br/&gt;
The bug is rare when concurrentConsumers=1 but can be reliably triggered when concurrentConsumers&amp;gt;=2.&lt;/p&gt;
&lt;h6&gt;&lt;a name=&quot;Replication%3A&quot;&gt;&lt;/a&gt;Replication:&lt;/h6&gt;
&lt;ul&gt;
	&lt;li&gt;Connect to&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
- route:
&#160; &#160; id: &lt;span class=&quot;code-quote&quot;&gt;&quot;test-route&quot;&lt;/span&gt;
&#160; &#160; shutdownRunningTask: &lt;span class=&quot;code-quote&quot;&gt;&quot;CompleteAllTasks&quot;&lt;/span&gt;
&#160; &#160; from:
&#160; &#160; &#160; uri: aws2-sqs:&lt;span class=&quot;code-comment&quot;&gt;//sqs-queue?concurrentConsumers=2&amp;amp;waitTimeSeconds=20&amp;amp;maxMessagesPerPoll=1
&lt;/span&gt;&#160; &#160; &#160; steps:
&#160; &#160; &#160; &#160; - log:
&#160; &#160; &#160; &#160; &#160; &#160; message: Endpoint result is ${body} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;ul&gt;
	&lt;li&gt;Trigger a shutdown.&lt;/li&gt;
	&lt;li&gt;Send three messages staggered two seconds apart.&lt;/li&gt;
	&lt;li&gt;Observe SdkInterruptedException for the second message&lt;/li&gt;
&lt;/ul&gt;


&lt;h6&gt;&lt;a name=&quot;Cause%3A&quot;&gt;&lt;/a&gt;Cause:&lt;/h6&gt;

&lt;p&gt;I am viewing the source code commit 7b766867.&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;For concurrentConsumers = 2 or more&lt;br/&gt;
When concurrentConsumers = 2 then two threads poll at the same time. Thus when each starts a poll, both set the shared boolean variable &apos;polling&apos; to true &lt;span class=&quot;error&quot;&gt;&amp;#91;line 203 of ScheduledPollConsumer&amp;#93;&lt;/span&gt;. The first to finish polling, e.g. by receiving sufficient messages, resets &apos;polling&apos; to false &lt;span class=&quot;error&quot;&gt;&amp;#91;line 236&amp;#93;&lt;/span&gt;. This allows the DefaultShutdownStrategy to progress to interrupting the threads past the wait-loop checking for pendingInflightExchanges &lt;span class=&quot;error&quot;&gt;&amp;#91;lines 674, 782&amp;#93;&lt;/span&gt;.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The SQS library checks after receiving messages and before processing them whether the Thread was interrupted. (I consider this reasonable behaviour.)&lt;/p&gt;

&lt;p&gt;The end result is a race condition where messages time out after being received because they are not fully processed.&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;For concurrentConsumers = 1&lt;br/&gt;
In ScheduledPollConsumer line 194 to line 201 there is a gap during which a thread can sleep while the DefaultShutdownStrategy can progress from deferring the Shutdown to waiting for inflight messages to interrupting the threads of the deferredConsumers.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The same race condition is as before is possible though with reduced scope.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13628651">CAMEL-22410</key>
            <summary>SchedulingPollConsumer is not thread safe during graceful shutdown.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="rubenlapauw">Ruben Lapauw</reporter>
                        <labels>
                            <label>sqs</label>
                    </labels>
                <created>Thu, 11 Sep 2025 08:29:30 +0000</created>
                <updated>Thu, 18 Sep 2025 08:19:11 +0000</updated>
                            <resolved>Thu, 18 Sep 2025 07:49:15 +0000</resolved>
                                    <version>4.10.6</version>
                    <version>4.12.0</version>
                    <version>4.14.0</version>
                                    <fixVersion>4.10.7</fixVersion>
                    <fixVersion>4.14.1</fixVersion>
                    <fixVersion>4.15.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="18020333" author="davsclaus" created="Mon, 15 Sep 2025 12:13:09 +0000"  >&lt;p&gt;What camel version do you use&lt;/p&gt;</comment>
                            <comment id="18020336" author="JIRAUSER310872" created="Mon, 15 Sep 2025 12:18:56 +0000"  >&lt;p&gt;Thank you for looking at this ticket. We use Camel 4.12.0. If required I will replicate with the newest version.&#160;&lt;/p&gt;</comment>
                            <comment id="18020401" author="davsclaus" created="Mon, 15 Sep 2025 16:05:47 +0000"  >&lt;p&gt;Yes always test with latest release&lt;/p&gt;</comment>
                            <comment id="18021070" author="davsclaus" created="Thu, 18 Sep 2025 07:42:20 +0000"  >&lt;p&gt;Yeah we should not use a boolean but a counter so when there are concurrent consumers then the state is correctly calculated&lt;/p&gt;</comment>
                            <comment id="18021073" author="davsclaus" created="Thu, 18 Sep 2025 07:49:15 +0000"  >&lt;p&gt;Thanks for reporting and with the analyse of the issue&lt;/p&gt;</comment>
                            <comment id="18021081" author="JIRAUSER310872" created="Thu, 18 Sep 2025 08:18:56 +0000"  >&lt;p&gt;Thank you for the speedy resolution. However I think one race condition may remain: the counter should be incremented before the isPollAllowed check. This would put the if-check inside of the try-finally block. Do I create a second story for this?&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1xncg:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>