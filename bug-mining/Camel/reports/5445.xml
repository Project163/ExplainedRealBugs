<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:43:16 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-15580] SJMS Batch Consumer startup race condition</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-15580</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;There is a race condition between the SJMS Batch Consumer route start thread and the batch consumption loop thread.&#160; When it triggers the batch consumption loop exits early and the SJMS Batch Consumer does not read any JMS messages.&lt;/p&gt;

&lt;p&gt;In short:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;The AtomicBoolean running is used as a flag to shut down the batch consumption loop&lt;/li&gt;
	&lt;li&gt;The batch consumption loop is submitted to another thread and only after that running is changed to true&lt;/li&gt;
	&lt;li&gt;This means sometimes the batch consumption loop sees running as false during startup&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The easiest way to reproduce it is to add a sleep into SJMSBatchConsumer$StartConsumerTask#run&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; List&amp;lt;AtomicBoolean&amp;gt; triggers = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ArrayList&amp;lt;&amp;gt;();
&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; consumerCount; i++) {
    BatchConsumptionLoop loop = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; BatchConsumptionLoop();
    loop.setKeepAliveDelay(keepAliveDelay);
    triggers.add(loop.getCompletionTimeoutTrigger());
    /*
     * Note: Batch consumption loop is submitted to another thread here
     */
    jmsConsumerExecutors.submit(loop);
}

&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (completionInterval &amp;gt; 0) {
    &lt;span class=&quot;code-comment&quot;&gt;// trigger completion based on interval
&lt;/span&gt;    timeoutCheckerExecutorService.scheduleAtFixedRate(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CompletionIntervalTask(triggers), completionInterval, completionInterval, TimeUnit.MILLISECONDS);
}

&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (attempt &amp;gt; 1) {
    LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Successfully refreshed connection after {} attempts.&quot;&lt;/span&gt;, attempt);
}
/*
 * Note: Add &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; sleep to reproduce the race condition, simulating
 * &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; thread being pre-empted by other work
 */
&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(100);  
LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Started {} consumer(s) &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; {}:{}&quot;&lt;/span&gt;, consumerCount, destinationName, completionSize);
/*
 * Note: running is only changed to &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; here but the batch consumption loop
 * that reads &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; values was submitted to another thread earlier
 */
running.set(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
 &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The batch consumption loop checks the running flag like this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
            &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void consumeBatchesOnLoop(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Session session, &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; MessageConsumer consumer) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; JMSException {
                &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; usingTimeout = completionTimeout &amp;gt; 0;

                LOG.trace(&lt;span class=&quot;code-quote&quot;&gt;&quot;BatchConsumptionTask +++ start +++&quot;&lt;/span&gt;);

                &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (running.get()) { &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Usually there&apos;s a second check that would cause everything to loop again - it may see running as false but see isStarting() as true.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
                }&lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (running.get() || isStarting()); &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;But with asyncStartListener enabled I think that isStarting() is likely to be false as well.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I believe this issue is causing fairly frequent intermittent test failures in our CI environment (jenkins slaves in kubernetes, linux).&#160; But I&apos;ve been unable to reproduce it on my laptop (windows) without adding the artificial delay on the main thread.&#160;&#160;&lt;/p&gt;

&lt;p&gt;I&apos;ve been able to get thread dumps from the CI environment showing the executor waiting for a task instead of executing the batch consumption loop&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-quote&quot;&gt;&quot;Camel (camel-8) thread #125 - SjmsBatchConsumer&quot;&lt;/span&gt; 
   java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: WAITING
        at sun.misc.Unsafe.park(Native Method)
        at java.util.concurrent.locks.LockSupport.park(LockSupport.java:175)
        at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:2039)
        at java.util.concurrent.LinkedBlockingQueue.take(LinkedBlockingQueue.java:442)
        at java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:1074)
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1134)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)
 &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Usually they should look like this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-quote&quot;&gt;&quot;Camel (camel-8) thread #123 - SjmsBatchConsumer&quot;&lt;/span&gt; 
   java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: TIMED_WAITING
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait(Native Method)
        at org.apache.activemq.FifoMessageDispatchChannel.dequeue(FifoMessageDispatchChannel.java:74)
        at org.apache.activemq.ActiveMQMessageConsumer.dequeue(ActiveMQMessageConsumer.java:486)
        at org.apache.activemq.ActiveMQMessageConsumer.receive(ActiveMQMessageConsumer.java:653)
        at org.apache.camel.component.sjms.batch.SjmsBatchConsumer$BatchConsumptionLoop$BatchConsumptionTask.consumeBatchesOnLoop(SjmsBatchConsumer.java:429)
        at org.apache.camel.component.sjms.batch.SjmsBatchConsumer$BatchConsumptionLoop$BatchConsumptionTask.access$1300(SjmsBatchConsumer.java:383)
        at org.apache.camel.component.sjms.batch.SjmsBatchConsumer$BatchConsumptionLoop.run(SjmsBatchConsumer.java:326)
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
        at java.util.concurrent.FutureTask.run(FutureTask.java:266)
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748) &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I also get tracing logs where the batch consumption tasks starts &amp;amp; ends very quickly.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
	Line 4377: 2020-09-24 03:16:41.567 DEBUG||| 4604 --- [artStopListener] o.a.c.c.sjms.batch.SjmsBatchConsumer     : Attempt #1. Starting 1 consumer(s) &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; myqueue:300
	Line 4415: 2020-09-24 03:16:41.576 TRACE||| 4604 --- [msBatchConsumer] o.a.c.c.sjms.batch.SjmsBatchConsumer     : BatchConsumptionTask +++ start +++
	Line 4416: 2020-09-24 03:16:41.576 TRACE||| 4604 --- [msBatchConsumer] o.a.c.c.sjms.batch.SjmsBatchConsumer     : BatchConsumptionTask +++ end +++
	Line 4435: 2020-09-24 03:16:41.568 INFO ||| 4604 --- [artStopListener] o.a.c.c.sjms.batch.SjmsBatchConsumer     : Started 1 consumer(s) &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; myqueue:300 &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Side note: Could the queue name be added to the thread name?&#160; The JMS component consumers do that.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13329427">CAMEL-15580</key>
            <summary>SJMS Batch Consumer startup race condition</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="vrlgohel">Viral Gohel</assignee>
                                    <reporter username="bradhgbst">Brad Harvey</reporter>
                        <labels>
                    </labels>
                <created>Fri, 25 Sep 2020 15:10:51 +0000</created>
                <updated>Wed, 30 Sep 2020 18:17:38 +0000</updated>
                            <resolved>Wed, 30 Sep 2020 18:17:26 +0000</resolved>
                                    <version>3.4.3</version>
                                    <fixVersion>3.6.0</fixVersion>
                    <fixVersion>3.4.5</fixVersion>
                                    <component>camel-sjms</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17202234" author="bradhgbst" created="Fri, 25 Sep 2020 15:13:12 +0000"  >&lt;p&gt;I added this to SjmsBatchConsumerTest to try to reproduce.&#160; I didn&apos;t have any luck reproducing on my laptop until I added the Thread.sleep mentioned in the description - a sleep of 10 ms causes it to fail about half the time, higher sleeps fail more often.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@Test
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testStartupRaceCondition() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; routeCount = 10;
    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; consumerCount = 1;

    List&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; queues = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ArrayList&amp;lt;&amp;gt;();

    &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; queueNamePrefix = getQueueName();

    &lt;span class=&quot;code-comment&quot;&gt;// setup routeCount routes, each reading from its own queue but all writing to the same mock endpoint
&lt;/span&gt;    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; routeCount; i++) {
        &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; queueName = queueNamePrefix + &lt;span class=&quot;code-quote&quot;&gt;&quot;_&quot;&lt;/span&gt; + i;
        queues.add(queueName);
        &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; routeId = &lt;span class=&quot;code-quote&quot;&gt;&quot;batchConsumer_&quot;&lt;/span&gt; + i;
        context.addRoutes(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RouteBuilder() {
            &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void configure() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {

                &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; completionTimeout = 1000;
                &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; completionSize = 1;

                fromF(&lt;span class=&quot;code-quote&quot;&gt;&quot;sjms-batch:%s?completionTimeout=%s&amp;amp;completionSize=%s&amp;amp;consumerCount=%s&amp;amp;aggregationStrategy=#testStrategy&amp;amp;keepAliveDelay=100&amp;amp;asyncStartListener=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt;,
                        queueName, completionTimeout, completionSize, consumerCount)
                        .routeId(routeId).autoStartup(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)
                        .split(body())
                        .to(&lt;span class=&quot;code-quote&quot;&gt;&quot;mock:split&quot;&lt;/span&gt;);
            }
        });
    }

    context.start();

    &lt;span class=&quot;code-comment&quot;&gt;// expect to receive routeCount messages to the mock endpoint
&lt;/span&gt;    MockEndpoint mockSplit = getMockEndpoint(&lt;span class=&quot;code-quote&quot;&gt;&quot;mock:split&quot;&lt;/span&gt;);
    mockSplit.setExpectedMessageCount(routeCount);

    &lt;span class=&quot;code-comment&quot;&gt;// send one message to all the queues
&lt;/span&gt;    queues.forEach(queueName -&amp;gt; template.sendBody(&lt;span class=&quot;code-quote&quot;&gt;&quot;sjms:queue:&quot;&lt;/span&gt; + queueName, queueName));

    assertMockEndpointsSatisfied();

} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17202242" author="bradhgbst" created="Fri, 25 Sep 2020 15:22:21 +0000"  >&lt;p&gt;I suspect setting running to true prior to kicking off the batch consumption tasks will solve it.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13012138/13012138_potentialPatch.txt&quot; title=&quot;potentialPatch.txt attached to CAMEL-15580&quot;&gt;potentialPatch.txt&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="17202537" author="davsclaus" created="Sat, 26 Sep 2020 06:57:12 +0000"  >&lt;p&gt;Yeah that sounds reasonable.&lt;/p&gt;</comment>
                            <comment id="17204945" author="davsclaus" created="Wed, 30 Sep 2020 18:17:38 +0000"  >&lt;p&gt;I have backported to 3.4.x branch&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13012138" name="potentialPatch.txt" size="1239" author="bradhgbst" created="Fri, 25 Sep 2020 15:21:07 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 6 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0ix68:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>