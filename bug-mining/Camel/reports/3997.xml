<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:21:56 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-10084] AggregateProcessor/JdbcAggregationRepository : table COMPLETED not cleaned when AggregationStrategy.aggregate does not return oldExchange </title>
                <link>https://issues.apache.org/jira/browse/CAMEL-10084</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;in AggregateProcessor + JdbcAggregationRepository :&lt;br/&gt;
the table _AGG_COMPLETED is not cleaned when AggregationStrategy.aggregate() does returns newExchange .&lt;/p&gt;

&lt;p&gt;it is ok when aggregate() returns oldExchange,&lt;/p&gt;

&lt;p&gt;looking at the code at these places:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/camel/blob/master/camel-core/src/main/java/org/apache/camel/processor/aggregate/AggregateProcessor.java#L662&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/blob/master/camel-core/src/main/java/org/apache/camel/processor/aggregate/AggregateProcessor.java#L662&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/camel/blob/master/components/camel-sql/src/main/java/org/apache/camel/processor/aggregate/jdbc/JdbcAggregationRepository.java#L317&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/blob/master/components/camel-sql/src/main/java/org/apache/camel/processor/aggregate/jdbc/JdbcAggregationRepository.java#L317&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/camel/blob/master/camel-core/src/main/java/org/apache/camel/processor/aggregate/AggregateProcessor.java#L694&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/blob/master/camel-core/src/main/java/org/apache/camel/processor/aggregate/AggregateProcessor.java#L694&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;it works as follow:&lt;br/&gt;
1. AggregateProcessor asks to remove oldExchange from _AGG. it gives correlationKey and oldExcange as parameter&lt;br/&gt;
2. JdbcAggregationRepository deletes exchange from _AGG with correlationKey and insert given exchange (oldExchange) in _AGG_COMPLETED &lt;br/&gt;
3. AggregateProcessor confirms exchange is complete, and ask JdbcAggregationRepository to delete aggregated exchange from _AGG_COMPLETED&lt;/p&gt;

&lt;p&gt;&lt;b&gt;if aggregated exchange does not have the same id as oldExchange, point 3 does nothing and oldExchange stays in _AGG_COMPLETED&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;the problem seems to be in point 2, the aggregatedExchange should be given instead of oldExchange.&lt;/p&gt;


&lt;p&gt;the aggregation works fine, but the _AGG_COMPLETED fills up and recovery will definitely not work in this scenario.&lt;/p&gt;


&lt;p&gt;workaround: always return oldExchange in AggregationStrategy.aggregate()&lt;/p&gt;</description>
                <environment></environment>
        <key id="12981813">CAMEL-10084</key>
            <summary>AggregateProcessor/JdbcAggregationRepository : table COMPLETED not cleaned when AggregationStrategy.aggregate does not return oldExchange </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="2">Won&apos;t Fix</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="rvigniel">Richard Vigniel</reporter>
                        <labels>
                    </labels>
                <created>Wed, 22 Jun 2016 08:39:28 +0000</created>
                <updated>Fri, 3 Mar 2017 10:53:41 +0000</updated>
                            <resolved>Fri, 3 Mar 2017 10:28:20 +0000</resolved>
                                    <version>2.16.2</version>
                                    <fixVersion>2.19.0</fixVersion>
                                    <component>camel-core</component>
                    <component>camel-sql</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15347855" author="davsclaus" created="Fri, 24 Jun 2016 06:42:09 +0000"  >&lt;p&gt;Can you work on a code patch that shows what code changes you suggest? And if possible an unit test to verify this.&lt;/p&gt;</comment>
                            <comment id="15357057" author="rvigniel" created="Thu, 30 Jun 2016 13:14:16 +0000"  >&lt;p&gt;suggested patch on camel-core and camel-sql&lt;/p&gt;

&lt;p&gt;other RecoverableAggregationRepositories have to be adapted. I introduced a new method &quot;preConfirm&quot; in RecoverableAggregationRepository&lt;/p&gt;</comment>
                            <comment id="15358616" author="rvigniel" created="Fri, 1 Jul 2016 08:06:05 +0000"  >&lt;p&gt;we can even optimise the repository, testing    &lt;br/&gt;
         if(isUseRecovery()) {&lt;br/&gt;
...&lt;br/&gt;
}&lt;/p&gt;

&lt;p&gt;before inserting and removing the aggregated exchange, in preConfirm() and confirm() methods.&lt;/p&gt;</comment>
                            <comment id="15894011" author="davsclaus" created="Fri, 3 Mar 2017 09:46:43 +0000"  >&lt;p&gt;Yes users should favor returning oldExchange in the aggregation repository, as that holds the base for the aggregated group&lt;/p&gt;</comment>
                            <comment id="15894021" author="davsclaus" created="Fri, 3 Mar 2017 09:50:15 +0000"  >&lt;p&gt;We cannot optimize as confirm is always called according to the contract&lt;/p&gt;</comment>
                            <comment id="15894084" author="davsclaus" created="Fri, 3 Mar 2017 10:21:47 +0000"  >&lt;p&gt;Your patch file is sadly incomplete and do NOT include all the files / changes.&lt;/p&gt;</comment>
                            <comment id="15894090" author="davsclaus" created="Fri, 3 Mar 2017 10:27:40 +0000"  >&lt;p&gt;There is a slight chance that you will delete and insert using separate methods (not in same TX) and it can do the first but fail on the 2nd.&lt;/p&gt;</comment>
                            <comment id="15894091" author="davsclaus" created="Fri, 3 Mar 2017 10:28:20 +0000"  >&lt;p&gt;I have amended the javadoc to indicate to favor returning old exchange&lt;/p&gt;</comment>
                            <comment id="15894131" author="davsclaus" created="Fri, 3 Mar 2017 10:53:41 +0000"  >&lt;p&gt;Camel will now log a WARN if it detect newExchange being returned so users can take not and correct their code&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12815453" name="CAMEL-10084.patch" size="10969" author="rvigniel" created="Thu, 30 Jun 2016 13:14:16 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10062"><![CDATA[Moderate]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 37 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2zw3b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>