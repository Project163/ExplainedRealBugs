<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 09:58:39 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-6561] Inserting JSON like data with sql component cause a java.lang.StackOverflowError</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-6561</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;I have a simple route use case like this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&amp;lt;camel:camelContext id=&lt;span class=&quot;code-quote&quot;&gt;&quot;camel-server&quot;&lt;/span&gt; xmlns=&lt;span class=&quot;code-quote&quot;&gt;&quot;http:&lt;span class=&quot;code-comment&quot;&gt;//camel.apache.org/schema/spring&quot;&lt;/span&gt;&amp;gt;
&lt;/span&gt;		&amp;lt;template id=&lt;span class=&quot;code-quote&quot;&gt;&quot;producerTemplate&quot;&lt;/span&gt;/&amp;gt;
        &amp;lt;route&amp;gt;
			&amp;lt;from uri=&lt;span class=&quot;code-quote&quot;&gt;&quot;direct:SEND_MEMQ&quot;&lt;/span&gt;/&amp;gt;
			&amp;lt;to uri=&lt;span class=&quot;code-quote&quot;&gt;&quot;sql:INSERT INTO CAMEL_TEST(MSG) VALUES(#)?dataSource=testdbDataSource&quot;&lt;/span&gt;/&amp;gt;
			&amp;lt;to uri=&lt;span class=&quot;code-quote&quot;&gt;&quot;log:camel.demos.throughputtest.tcp.Stat?level=INFO&amp;amp;amp;groupSize=100&quot;&lt;/span&gt;/&amp;gt;
        &amp;lt;/route&amp;gt;
    &amp;lt;/camel:camelContext&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The DB table is simple one like this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-comment&quot;&gt;/* H2Database */&lt;/span&gt;
DROP TABLE CAMEL_TEST;
CREATE TABLE CAMEL_TEST ( 
  ID BIGINT PRIMARY KEY AUTO_INCREMENT,
  MSG VARCHAR(10240),
  CREATE_TS TIMESTAMP DEFAULT NOW()
);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And then I use the producerTemplate to send a sample JSON content like data message (see attachment) into the &quot;direct:SEND_MEMQ&quot; (I read the full file and send it as String), and it produced the following severe error:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;2013-07-18 08:34:00,593 ERROR pool-1-thread-1 [org.apache.camel.processor.DefaultErrorHandler] - Failed delivery &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (MessageId: ID-L328BDS002012US-56371-1374150839469-0-1 on ExchangeId: ID-L328BDS002012US-56371-1374150839469-0-2). Exhausted after delivery attempt: 1 caught: org.apache.camel.CamelExecutionException: Exception occurred during execution on the exchange: Exchange[Message: {&lt;span class=&quot;code-quote&quot;&gt;&quot;web-app&quot;&lt;/span&gt;: {
... 
... [Body clipped after 1000 chars, total length is 3467]]
        at org.apache.camel.util.ObjectHelper.wrapCamelExecutionException(ObjectHelper.java:1354)
        at org.apache.camel.impl.DefaultExchange.setException(DefaultExchange.java:272)
        at org.apache.camel.util.AsyncProcessorConverterHelper$ProcessorToAsyncProcessorBridge.process(AsyncProcessorConverterHelper.java:64)
        at org.apache.camel.util.AsyncProcessorHelper.process(AsyncProcessorHelper.java:73)
        at org.apache.camel.processor.SendProcessor$2.doInAsyncProducer(SendProcessor.java:122)
        at org.apache.camel.impl.ProducerCache.doInAsyncProducer(ProducerCache.java:298)
        at org.apache.camel.processor.SendProcessor.process(SendProcessor.java:117)
        at org.apache.camel.util.AsyncProcessorHelper.process(AsyncProcessorHelper.java:73)
        at org.apache.camel.processor.DelegateAsyncProcessor.processNext(DelegateAsyncProcessor.java:99)
        at org.apache.camel.processor.DelegateAsyncProcessor.process(DelegateAsyncProcessor.java:90)
        at org.apache.camel.management.InstrumentationProcessor.process(InstrumentationProcessor.java:72)
        at org.apache.camel.util.AsyncProcessorHelper.process(AsyncProcessorHelper.java:73)
        at org.apache.camel.processor.DelegateAsyncProcessor.processNext(DelegateAsyncProcessor.java:99)
        at org.apache.camel.processor.DelegateAsyncProcessor.process(DelegateAsyncProcessor.java:90)
        at org.apache.camel.processor.interceptor.BacklogTracerInterceptor.process(BacklogTracerInterceptor.java:84)
        at org.apache.camel.util.AsyncProcessorHelper.process(AsyncProcessorHelper.java:73)
        at org.apache.camel.processor.DelegateAsyncProcessor.processNext(DelegateAsyncProcessor.java:99)
        at org.apache.camel.processor.DelegateAsyncProcessor.process(DelegateAsyncProcessor.java:90)
        at org.apache.camel.processor.interceptor.TraceInterceptor.process(TraceInterceptor.java:91)
        at org.apache.camel.util.AsyncProcessorHelper.process(AsyncProcessorHelper.java:73)
        at org.apache.camel.processor.RedeliveryErrorHandler.processErrorHandler(RedeliveryErrorHandler.java:390)
        at org.apache.camel.processor.RedeliveryErrorHandler.process(RedeliveryErrorHandler.java:273)
        at org.apache.camel.processor.RouteContextProcessor.processNext(RouteContextProcessor.java:46)
        at org.apache.camel.processor.DelegateAsyncProcessor.process(DelegateAsyncProcessor.java:90)
        at org.apache.camel.processor.interceptor.DefaultChannel.process(DefaultChannel.java:335)
        at org.apache.camel.util.AsyncProcessorHelper.process(AsyncProcessorHelper.java:73)
        at org.apache.camel.processor.Pipeline.process(Pipeline.java:117)
        at org.apache.camel.processor.Pipeline.process(Pipeline.java:80)
        at org.apache.camel.processor.RouteContextProcessor.processNext(RouteContextProcessor.java:46)
        at org.apache.camel.processor.DelegateAsyncProcessor.process(DelegateAsyncProcessor.java:90)
        at org.apache.camel.processor.UnitOfWorkProcessor.process(UnitOfWorkProcessor.java:122)
        at org.apache.camel.processor.RouteInflightRepositoryProcessor.processNext(RouteInflightRepositoryProcessor.java:48)
        at org.apache.camel.processor.DelegateAsyncProcessor.process(DelegateAsyncProcessor.java:90)
        at org.apache.camel.util.AsyncProcessorHelper.process(AsyncProcessorHelper.java:73)
        at org.apache.camel.processor.DelegateAsyncProcessor.processNext(DelegateAsyncProcessor.java:99)
        at org.apache.camel.processor.DelegateAsyncProcessor.process(DelegateAsyncProcessor.java:90)
        at org.apache.camel.management.InstrumentationProcessor.process(InstrumentationProcessor.java:72)
        at org.apache.camel.util.AsyncProcessorHelper.process(AsyncProcessorHelper.java:73)
        at org.apache.camel.component.direct.DirectProducer.process(DirectProducer.java:60)
        at org.apache.camel.processor.UnitOfWorkProcessor.processAsync(UnitOfWorkProcessor.java:150)
        at org.apache.camel.processor.UnitOfWorkProcessor.process(UnitOfWorkProcessor.java:117)
        at org.apache.camel.util.AsyncProcessorHelper.process(AsyncProcessorHelper.java:99)
        at org.apache.camel.processor.DelegateAsyncProcessor.process(DelegateAsyncProcessor.java:86)
        at org.apache.camel.processor.UnitOfWorkProducer.process(UnitOfWorkProducer.java:63)
        at org.apache.camel.impl.ProducerCache$2.doInProducer(ProducerCache.java:366)
        at org.apache.camel.impl.ProducerCache$2.doInProducer(ProducerCache.java:337)
        at org.apache.camel.impl.ProducerCache.doInProducer(ProducerCache.java:233)
        at org.apache.camel.impl.ProducerCache.sendExchange(ProducerCache.java:337)
        at org.apache.camel.impl.ProducerCache.send(ProducerCache.java:175)
        at org.apache.camel.impl.DefaultProducerTemplate.send(DefaultProducerTemplate.java:111)
        at org.apache.camel.impl.DefaultProducerTemplate.sendBody(DefaultProducerTemplate.java:124)
        at org.apache.camel.impl.DefaultProducerTemplate.sendBody(DefaultProducerTemplate.java:131)
        at throughputtest.FileSampleProducer$1.run(FileSampleProducer.java:64)
        at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:895)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:918)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:662)
Caused by: java.lang.StackOverflowError
        at java.util.regex.Pattern$GroupHead.match(Pattern.java:4168)
        at java.util.regex.Pattern$Loop.match(Pattern.java:4295)
        at java.util.regex.Pattern$GroupTail.match(Pattern.java:4227)
        at java.util.regex.Pattern$BranchConn.match(Pattern.java:4078)
        at java.util.regex.Pattern$CharProperty.match(Pattern.java:3345)
        at java.util.regex.Pattern$Branch.match(Pattern.java:4114)
        at java.util.regex.Pattern$GroupHead.match(Pattern.java:4168)
        at java.util.regex.Pattern$Loop.match(Pattern.java:4295)
        at java.util.regex.Pattern$GroupTail.match(Pattern.java:4227)
        at java.util.regex.Pattern$BranchConn.match(Pattern.java:4078)
        at java.util.regex.Pattern$CharProperty.match(Pattern.java:3345)
        at java.util.regex.Pattern$Branch.match(Pattern.java:4114)
        at java.util.regex.Pattern$GroupHead.match(Pattern.java:4168)
        at java.util.regex.Pattern$Loop.match(Pattern.java:4295)
        at java.util.regex.Pattern$GroupTail.match(Pattern.java:4227)

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12658514">CAMEL-6561</key>
            <summary>Inserting JSON like data with sql component cause a java.lang.StackOverflowError</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="saltnlight5">Zemian Deng</reporter>
                        <labels>
                    </labels>
                <created>Thu, 18 Jul 2013 13:06:32 +0000</created>
                <updated>Wed, 7 Aug 2013 10:05:24 +0000</updated>
                            <resolved>Wed, 7 Aug 2013 10:05:24 +0000</resolved>
                                    <version>2.11.0</version>
                                    <fixVersion>2.11.2</fixVersion>
                    <fixVersion>2.12.0</fixVersion>
                                    <component>camel-sql</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13712296" author="saltnlight5" created="Thu, 18 Jul 2013 13:10:09 +0000"  >&lt;p&gt;Sample data that cause the error.&lt;/p&gt;</comment>
                            <comment id="13713284" author="saltnlight5" created="Fri, 19 Jul 2013 02:41:22 +0000"  >&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;I see where the problem is now. Since I send input message as plain String, the &quot;sql&quot; component automatically converts it to Iterator type for SQL parameters bindings. What&apos;s hidden is that default converter will also use a delimiter to parse the string! (I see this in ObjectHelper.java line 601, which uses a RegExp that happens to cause StackOverflowError with the input I give.&lt;/p&gt;

&lt;p&gt;I can work around this by actually just send an Iterator type (List&amp;lt;String&amp;gt;) as message type instead of String. It then works as intended and not get the StackOverflowError problem. I should have done this in first place anyway since my input is large and not typical.&lt;/p&gt;

&lt;p&gt;If you guys don&apos;t see this as problem to fix or improve, then please close it.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
Zemian Deng&lt;/p&gt;</comment>
                            <comment id="13715295" author="davsclaus" created="Mon, 22 Jul 2013 15:35:56 +0000"  >&lt;p&gt;Yeah we could possible add a new option which tells the sql component to not iterate the body but use it as is, when you have only 1 parameter etc.&lt;/p&gt;</comment>
                            <comment id="13715297" author="davsclaus" created="Mon, 22 Jul 2013 15:36:44 +0000"  >&lt;p&gt;Zemian, do you want to work on a patch for such a new option?&lt;/p&gt;

&lt;p&gt;Maybe the option is just named &lt;tt&gt;useIterator&lt;/tt&gt; and is default &lt;tt&gt;true&lt;/tt&gt;. Then ppl can turn that off.&lt;/p&gt;</comment>
                            <comment id="13715993" author="saltnlight5" created="Tue, 23 Jul 2013 02:48:44 +0000"  >&lt;p&gt;Sure Claus,&lt;/p&gt;

&lt;p&gt;But before I add new option you suggested, I&apos;ve discovered couple things that I would like to discuss first:&lt;/p&gt;

&lt;p&gt;1) It looks like the latest code in master has a change in DefaultSqlPrepareStatementStrategy.java line  129 that prevented my test case to generate StackOverflowError. With this, it went and parsed the input into array and obviously give error because the size is mismatch to SQL binding parameters count. Which is expected.&lt;/p&gt;

&lt;p&gt;However I see that DefaultSqlPrepareStatementStrategy did not check for this String input type when query has namedParameters (starting line 68) though. Is this intended?&lt;/p&gt;

&lt;p&gt;2) As I hinted in previous comment, the StackOverflowError is really comes from ObjectHelper class. This is more concern to me. You can duplicate this bug by the following simple test case:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    @Test
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testCreateIteratorWithJsonThatBreakDelimiter() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
        &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; input = readFromClasspath(&lt;span class=&quot;code-quote&quot;&gt;&quot;sample1.json&quot;&lt;/span&gt;);
        Iterator&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;&amp;gt; result = ObjectHelper.createIterator(input);
        Assert.assertEquals(input, result.next());
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;That means whoever calls any of these creatIterator() with bad input could potential get into StackOverflowError. The root cause is from ObjectHelper.java line 601. It parses input with some fancy regexp. Since its part of Camel Core, this is too risky and a bad error to expose to users by simply having bad inputs. I would recommend NOT to use that regexp but keep it minimal, fixed delimiter String to avoid this. What&apos;s your thought on this?&lt;/p&gt;

&lt;p&gt;Zemian&lt;/p&gt;</comment>
                            <comment id="13723683" author="davsclaus" created="Tue, 30 Jul 2013 10:30:11 +0000"  >&lt;p&gt;Ad 2)&lt;br/&gt;
Working as designed, read the javadoc of the API&lt;/p&gt;

&lt;p&gt;Ad 1)&lt;br/&gt;
Yes intended as named parameters requires Map like structure (key=value).&lt;/p&gt;</comment>
                            <comment id="13724429" author="saltnlight5" created="Tue, 30 Jul 2013 21:07:39 +0000"  >&lt;p&gt;Hi Claus,&lt;/p&gt;

&lt;p&gt;For 1) Okay I see. Thanks for clarifying.&lt;/p&gt;

&lt;p&gt;For 2) Do you mean to read the inline comment in ObjectHelper.java line 591-601, or the ObjectHelper#createIterator() method javadoc. I read both cases, and it doesn&apos;t indicate to me that it might throws StackOverflowError if input is String.&lt;/p&gt;

&lt;p&gt;Well, I don&apos;t want to beat this defect to death. As I said, what changes you guys have in master branch already prevented this StackOverflowError when used with camel-sql in my particular case. Thus you may close this issue as it intended. &lt;/p&gt;

&lt;p&gt;However, I would just like to point out the ObjectHelper#createIterator() could still give StackOverflowError if user give a certain String as input.&lt;/p&gt;</comment>
                            <comment id="13731827" author="davsclaus" created="Wed, 7 Aug 2013 09:43:03 +0000"  >&lt;p&gt;If the expected parameters == 1 then we will use the body as is. This will fix this problem.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12592967" name="sample1.json" size="3467" author="saltnlight5" created="Thu, 18 Jul 2013 13:10:09 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>338708</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 16 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1mf5b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>339028</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>