<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:03:26 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-7598] Camel does not clear the jpa session after each processed message batch</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-7598</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;We are using apache camel to poll from a database. As we want processed rows only to be updated we have disabled consumeDelete on the JPA endpoint. &lt;/p&gt;

&lt;p&gt;During testing we found a large memory leak: all polled entities are kept in the session cache (we are using hibernate as persistence provider). &lt;/p&gt;

&lt;p&gt;The issue seems to be in the JpaConsumer. In method poll() it calls enitityManager.joinTransaction() at the beginning and entitiyManager.flush() at the end of the method but it never calls  entityManager.clear(). As camel is reusing the underlying session during each poll() this causes the first level entity cache to grow indefinitely. &lt;/p&gt;</description>
                <environment></environment>
        <key id="12727081">CAMEL-7598</key>
            <summary>Camel does not clear the jpa session after each processed message batch</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="dseidewitz">Daniel Seidewitz</reporter>
                        <labels>
                    </labels>
                <created>Mon, 14 Jul 2014 12:58:57 +0000</created>
                <updated>Thu, 24 Jul 2014 13:23:07 +0000</updated>
                            <resolved>Thu, 24 Jul 2014 13:23:07 +0000</resolved>
                                    <version>2.12.3</version>
                                    <fixVersion>2.12.5</fixVersion>
                    <fixVersion>2.13.3</fixVersion>
                    <fixVersion>2.14.0</fixVersion>
                                    <component>camel-jpa</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14067570" author="davsclaus" created="Sat, 19 Jul 2014 16:01:28 +0000"  >&lt;p&gt;Thanks, so do you mean that we should just call clear after the flush?&lt;/p&gt;

&lt;p&gt;A patch is welcome&lt;/p&gt;</comment>
                            <comment id="14073170" author="dseidewitz" created="Thu, 24 Jul 2014 13:04:21 +0000"  >&lt;p&gt;Yes, i think the correct patch would be to call clear after the flush. &lt;/p&gt;

&lt;p&gt;I&apos;ve implemented this fix and we now don&apos;t see any rise in used heap on our production system (system is running since 2 days and was showing heap rises of 100 MB / day before). &lt;/p&gt;

&lt;p&gt;Do you think it&apos;s possible to include the patch in release 2.12.5?&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Index: components/camel-jpa/src/main/java/org/apache/camel/component/jpa/JpaConsumer.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
&amp;lt;+&amp;gt;UTF-8
===================================================================
--- components/camel-jpa/src/main/java/org/apache/camel/component/jpa/JpaConsumer.java             (revision 89bf25387d3798620dc6972067e4a563e11f0b5a)
+++ components/camel-jpa/src/main/java/org/apache/camel/component/jpa/JpaConsumer.java             (revision )
@@ -135,6 +135,7 @@
                 &lt;span class=&quot;code-comment&quot;&gt;// commit
&lt;/span&gt;                 LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Flushing EntityManager&quot;&lt;/span&gt;);
                 entityManager.flush();
+                entityManager.clear();
                 &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; messagePolled;
             }
         });
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14073177" author="davsclaus" created="Thu, 24 Jul 2014 13:23:07 +0000"  >&lt;p&gt;Thanks for reporting and the patch.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>405188</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 17 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1xqd3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>405223</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>