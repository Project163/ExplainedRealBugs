<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:02:24 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-7415] lazyLoad with CSV blows up on last line</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-7415</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
CsvDataFormat csv = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CsvDataFormat() 
csv.setDelimiter(&lt;span class=&quot;code-quote&quot;&gt;&apos; &apos;&lt;/span&gt;) 
csv.setSkipFirstLine(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;) 
csv.setLazyLoad(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;) 

CamelContext camelContext = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; DefaultCamelContext() 
camelContext.addRoutes(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RouteBuilder() { 
def void configure() { 
from(&lt;span class=&quot;code-quote&quot;&gt;&apos;direct:start&apos;&lt;/span&gt;) 
.unmarshal(csv) 
.split(body()).streaming() 
.log(&lt;span class=&quot;code-quote&quot;&gt;&apos;row: ${body}&apos;&lt;/span&gt;) 
} 
}) 
camelContext.start() 

ProducerTemplate t = camelContext.createProducerTemplate() 
t.sendBody(&lt;span class=&quot;code-quote&quot;&gt;&apos;direct:start&apos;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; File(&lt;span class=&quot;code-quote&quot;&gt;&apos;/Users/timbo/data/test.txt&apos;&lt;/span&gt;)) 

camelContext.stop() 

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Here is the exception when camel try to access the last line of the file.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.IllegalStateException: java.io.IOException: Stream closed 
at 
org.apache.camel.dataformat.csv.CsvIterator.next(CsvIterator.java:61) 
at 
org.apache.camel.processor.Splitter$SplitterIterable$1.next(Splitter.java:170) 
at 
org.apache.camel.processor.Splitter$SplitterIterable$1.next(Splitter.java:146) 
at 
org.apache.camel.processor.MulticastProcessor.doProcessSequential(MulticastProcessor.java:502) 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12712508">CAMEL-7415</key>
            <summary>lazyLoad with CSV blows up on last line</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="njiang">Willem Jiang</assignee>
                                    <reporter username="njiang">Willem Jiang</reporter>
                        <labels>
                    </labels>
                <created>Tue, 6 May 2014 06:51:59 +0000</created>
                <updated>Sat, 24 May 2014 10:23:34 +0000</updated>
                            <resolved>Sat, 24 May 2014 09:44:28 +0000</resolved>
                                    <version>2.12.3</version>
                    <version>2.13.0</version>
                                    <fixVersion>2.12.4</fixVersion>
                    <fixVersion>2.13.2</fixVersion>
                    <fixVersion>2.14.0</fixVersion>
                                    <component>camel-csv</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="13990360" author="njiang" created="Tue, 6 May 2014 06:58:55 +0000"  >&lt;p&gt;This issue is caused by the UnmarshalProcessor always wants to close the inputstream even the marshalled object is iterator.&lt;br/&gt;
The input stream can be closed by the iterator, so leave the input stream if the result object is iterator solve the issue.&lt;/p&gt;</comment>
                            <comment id="14008067" author="antoine.dessaigne" created="Sat, 24 May 2014 07:47:12 +0000"  >&lt;p&gt;Hi Willem,&lt;/p&gt;

&lt;p&gt;Correct me if I&apos;m wrong but the InputStream won&apos;t be closed if the iterator is not processed until the end. This case can happen if you&apos;re processing manually the iterator and not rely on split.&lt;/p&gt;

&lt;p&gt;For my pull request of &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-7447&quot; title=&quot;Allow to stream the result of a database query&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-7447&quot;&gt;&lt;del&gt;CAMEL-7447&lt;/del&gt;&lt;/a&gt;, I&apos;ve called exchange.addOnCompletion in order to close the inputstream.&lt;/p&gt;

&lt;p&gt;Is it correct ?&lt;/p&gt;</comment>
                            <comment id="14008086" author="njiang" created="Sat, 24 May 2014 09:41:22 +0000"  >&lt;p&gt;Hi Antoine &lt;/p&gt;

&lt;p&gt;I think we need to let the user close the iterator or the input stream when he finish the process.&lt;/p&gt;

&lt;p&gt;Closing the stream in exchange.onCompletion could cause some trouble if we just route the message to other system which is not part of camel route,  As the exchange onCompletion is called when the route processes the exchange. we may hit the same issue as we meet in &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-7415&quot; title=&quot;lazyLoad with CSV blows up on last line&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-7415&quot;&gt;&lt;del&gt;CAMEL-7415&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Regards,&lt;/p&gt;

&lt;p&gt;Willem&lt;/p&gt;</comment>
                            <comment id="14008088" author="njiang" created="Sat, 24 May 2014 09:44:28 +0000"  >&lt;p&gt;Applied the patch into master, camel-2.12.x and camel-2.13.x branches.&lt;/p&gt;</comment>
                            <comment id="14008094" author="antoine.dessaigne" created="Sat, 24 May 2014 10:23:34 +0000"  >&lt;p&gt;Hi Willem,&lt;/p&gt;

&lt;p&gt;Thanks you very much for sharing your insights.&lt;/p&gt;

&lt;p&gt;Antoine&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>390824</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 26 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1vbdr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>391062</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>