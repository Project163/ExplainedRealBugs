<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 11:06:34 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-16829] camel-core - Stuck processing with nested parallel splits and custom thread pool</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-16829</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;The cause of this issue is difficult to pinpoint, but running the following code, the route will be stuck indefinitely in processing:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@Component
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Route &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; RouteBuilder {
	@Override
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void configure() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
		&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; executorService = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ThreadPoolBuilder(getContext())
				.poolSize(1)
				.maxPoolSize(1)
				.maxQueueSize(0)
				.build(&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;inner&lt;/span&gt;&quot;&lt;/span&gt;);

		from(&lt;span class=&quot;code-quote&quot;&gt;&quot;direct:main&quot;&lt;/span&gt;)
				.split(body()).parallelProcessing()
				.to(&lt;span class=&quot;code-quote&quot;&gt;&quot;direct:&lt;span class=&quot;code-keyword&quot;&gt;inner&lt;/span&gt;?synchronous=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt;);

		from(&lt;span class=&quot;code-quote&quot;&gt;&quot;direct:&lt;span class=&quot;code-keyword&quot;&gt;inner&lt;/span&gt;&quot;&lt;/span&gt;)
				.split(body()).executorService(executorService)
				.log(&lt;span class=&quot;code-quote&quot;&gt;&quot;${body}&quot;&lt;/span&gt;);
	}
}

@Component
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Runner &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; CommandLineRunner {

	@Autowired
	&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; CamelContext camelContext;

	@Autowired
	&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; ProducerTemplate producerTemplate;

	@Override
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void run(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;... args) {
		&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; exchange = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; DefaultExchange(camelContext);
		exchange.getIn().setBody(List.of(List.of(&lt;span class=&quot;code-quote&quot;&gt;&quot;0-0&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;0-1&quot;&lt;/span&gt;), List.of(&lt;span class=&quot;code-quote&quot;&gt;&quot;1-0&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;1-1&quot;&lt;/span&gt;)));
		producerTemplate.send(&lt;span class=&quot;code-quote&quot;&gt;&quot;direct:main&quot;&lt;/span&gt;, exchange);
	}
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;There are two important parts to reproduce the issue:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;The forward to direct:inner with synchronous=true. This will cause an await here and it is the point where the route processing is stuck.&lt;/li&gt;
	&lt;li&gt;The inner executor, with a small pool and no queue, which will trigger the default CallerRuns rejection policy and run the split in the original thread instead of as new one.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The cause of the stuck await seems to be linked to the way the AsyncProcessorAwaitManager and DefaultReactiveExecutor.executeFromQueue() interacts. Here the await callback to decrement the latch have been pushed in a back queue of the reactive worker (probably by a scheduleMain in the middle), but the executeFromQueue does not process the worker back queues so the callback is not executed and we are stuck on the await.&lt;/p&gt;

&lt;p&gt;I&apos;m not sure what the solution is here, maybe the executeFromQueue should process back queues, or the CallerRuns rejection policy is just not supported in the first place but it should probably not be the default then.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13392521">CAMEL-16829</key>
            <summary>camel-core - Stuck processing with nested parallel splits and custom thread pool</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="spadou">Samuel Padou</reporter>
                        <labels>
                    </labels>
                <created>Thu, 29 Jul 2021 11:22:51 +0000</created>
                <updated>Fri, 28 Jun 2024 12:27:17 +0000</updated>
                            <resolved>Fri, 28 Jun 2024 12:27:17 +0000</resolved>
                                    <version>3.11.0</version>
                                    <fixVersion>4.7.0</fixVersion>
                                    <component>camel-core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17423543" author="davsclaus" created="Sat, 2 Oct 2021 14:46:38 +0000"  >&lt;p&gt;Thanks for reporting.&lt;/p&gt;

&lt;p&gt;It&apos;s an unusual situation with a thread starvation due to thread pool exhausted.&lt;/p&gt;

&lt;p&gt;I was looking into another case today and this helped me to work on a solution for this one as well.&lt;br/&gt;
The work need some more polish, but I can get the unit test to pass now in both synchronous=true and false mode for the direct endpoint.&lt;/p&gt;

&lt;p&gt;But its some changes in the core / direct component so need to check for regressions and whatnot&lt;/p&gt;</comment>
                            <comment id="17423857" author="davsclaus" created="Mon, 4 Oct 2021 09:31:41 +0000"  >&lt;p&gt;Okay this is more complex, I created a ticket &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-17038&quot; title=&quot;camel-core - EIPs with thread pools vs reactive engine&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-17038&quot;&gt;CAMEL-17038&lt;/a&gt; as there is a disconnect between JDK thread pools vs EIP parallel work&lt;/p&gt;</comment>
                            <comment id="17632385" author="JIRAUSER298364" created="Fri, 11 Nov 2022 14:30:16 +0000"  >&lt;p&gt;I just ran into the same problem, although my snippet to reliably reproduce the Problem isn&apos;t quite as brief: &lt;a href=&quot;https://github.com/TxKroar/camel-repro&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/TxKroar/camel-repro&#160;&lt;/a&gt; (I took the liberty to post it here in addition to what Samuel provided on the off chance that it is somehow useful while fixing this issue)&lt;/p&gt;

&lt;p&gt;I compared it with the snippet provided with Samuel and it is indeed the exact same problem:&lt;/p&gt;

&lt;p&gt;Just as with the example provided by Samuel, the bug happens when the ThreadPool used by camel is exhausted and the Caller Thread is used for further processing: the &lt;tt&gt;Worker&lt;/tt&gt; in the &lt;tt&gt;DefaultReactiveExecutor&lt;/tt&gt; of the Caller Thread has &lt;tt&gt;running&lt;/tt&gt; set to &lt;tt&gt;true&lt;/tt&gt; and then &lt;tt&gt;DefaultReactiveExecutor#scheduleMain&lt;/tt&gt; gets called further down the pipeline - the provided &lt;tt&gt;Runnable&lt;/tt&gt; never gets called and thus the Caller Thread gets stuck in &lt;tt&gt;DefaultAsyncProcessorAwaitManager#await.&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17860752" author="davsclaus" created="Fri, 28 Jun 2024 08:37:18 +0000"  >&lt;p&gt;Thanks Frank, so your example is using Aggreagte EIP in parallel mode, and have a higher thread pool, but in case of high volume processing the thread-pool is exhausted and the task is rejected, but camel does not catch this and the routing engine does not continue. I assume you had&#160; some blocked threads or what ?&lt;/p&gt;</comment>
                            <comment id="17860761" author="JIRAUSER298364" created="Fri, 28 Jun 2024 09:14:24 +0000"  >&lt;p&gt;Hi Claus,&lt;/p&gt;

&lt;p&gt;We noticed the problem when we were doing resource intensive work on some Servers that only affected the output side of the camel-pipeline, but not the input side: The temporary slowdown of the system lead to the thread-pool exhaustion.&lt;/p&gt;</comment>
                            <comment id="17860765" author="davsclaus" created="Fri, 28 Jun 2024 09:26:42 +0000"  >&lt;p&gt;Your thread pool for the aggregate EiP should not be using caller-runs as all threads in your consumer bean are busy waiting, and then the thread pool gets exhausted under high load, and the JMS thread will then also be sleeping 5s in the consumer bean, and then you end up with this forever. At least in the linked test project.&lt;/p&gt;

&lt;p&gt;It may be wiser to set thread pool to abort task when its full, and instead have a queue size that can handle the usual load.&lt;/p&gt;</comment>
                            <comment id="17860795" author="davsclaus" created="Fri, 28 Jun 2024 11:56:42 +0000"  >&lt;p&gt;Okay found a better solution so I can get it to work with caller runs as well, and when the thread pool is exhausted.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310660">
                    <name>Completes</name>
                                                                <inwardlinks description="is fixed by">
                                        <issuelink>
            <issuekey id="13404748">CAMEL-17038</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13584163">CAMEL-20927</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10063"><![CDATA[Advanced]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 19 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0tfuw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>