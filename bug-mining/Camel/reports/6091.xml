<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:53:16 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-17798] camel-kafka - Offsets resetting when another Camel node is shutdown</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-17798</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;After upgrading to 3.15.0 we began to experience lots of situations where offsets on topics get reset when one of the JVMs running Camel gets shut down (Camel is shut down gracefully, we have at least 2 JVMs running in parallel that consume events from topics for the same consumer group). This is a problem when a topic contains millions of events because we need to retrieve all of them again. We have auto commit enabled and do not use any manual commit management.&lt;/p&gt;

&lt;p&gt;This what gets logged on a running JVM when we shut down the other one:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2022-03-15 09:59:40.285 [Camel (camel-1) thread #17 - KafkaConsumer[*masked*]] INFO &#160;org.apache.kafka.clients.consumer.internals.Fetcher.handleOffsetOutOfRange:1413 - [Consumer clientId=consumer-*masked*-40, groupId=*masked*] Fetch position FetchPosition{offset=0, offsetEpoch=Optional.empty, currentLeader=LeaderAndEpoch{leader=Optional[*masked*:9093 (id: 2 rack: O66)], epoch=643}} is out of range for partition *masked*-3, resetting offset 

2022-03-15 09:59:40.519 [kafka-coordinator-heartbeat-thread | *masked*] INFO &#160;org.apache.kafka.clients.consumer.internals.SubscriptionState.maybeSeekUnvalidated:398 - [Consumer clientId=consumer-*masked*-40, groupId=*masked*] Resetting offset for partition *masked*-3 to position FetchPosition{offset=2193522, offsetEpoch=Optional.empty, currentLeader=LeaderAndEpoch{leader=Optional[*masked*:9093 (id: 2 rack: O66)], epoch=643}}.&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This does not occur on 3.14.2. I believe this may be related to commit manager introduced in 3.15.0, but I have not managed to confirm it yet.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13433830">CAMEL-17798</key>
            <summary>camel-kafka - Offsets resetting when another Camel node is shutdown</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="rgala">Rafa&#322; Ga&#322;a</reporter>
                        <labels>
                    </labels>
                <created>Tue, 15 Mar 2022 09:34:33 +0000</created>
                <updated>Wed, 16 Mar 2022 06:30:46 +0000</updated>
                            <resolved>Wed, 16 Mar 2022 06:30:46 +0000</resolved>
                                    <version>3.15.0</version>
                                    <fixVersion>3.16.0</fixVersion>
                                    <component>camel-kafka</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17506847" author="rgala" created="Tue, 15 Mar 2022 10:53:01 +0000"  >&lt;p&gt;I think I got it. It looks like the problem is in PartitionAssignmentListener&apos;s &lt;b&gt;onPartitionsRevoked&lt;/b&gt; method that gets called when the other JVM is shut down:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
            &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; offsetKey = serializeOffsetKey(partition);
            &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt; offset = lastProcessedOffset.get(offsetKey);
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (offset == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
                offset = -1L;
            }
            &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                &lt;span class=&quot;code-comment&quot;&gt;// only commit offsets &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; the component has control
&lt;/span&gt;                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (configuration.getAutoCommitEnable()) {
                    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (stopping) {
                        commitManager.commitOffsetOnStop(partition, offset);
                    } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
                        commitManager.commitOffset(partition, offset);
                    }

                }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;When there were no message consumed from the topic (no new messages arrived since the consumer subscribed) the &lt;b&gt;offset&lt;/b&gt; variable here is null because &lt;b&gt;lastProcessedOffset&lt;/b&gt; map does not contain infomation about last processed offset for the partition . It is then set to -1 and passed to &lt;b&gt;commitManager.commitOffset(partition, offset)&lt;/b&gt; method:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void commitSync(TopicPartition partition, &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; partitionLastOffset) {
    &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; timeout = configuration.getCommitTimeoutMs();
    consumer.commitSync(
            Collections.singletonMap(partition, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; OffsetAndMetadata(partitionLastOffset + 1)),
            Duration.ofMillis(timeout));
} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;which commits offset 0 for the partition causing all events to be received again.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I think that last commited offset for a consumer group and partition should be retrieved from Kafka somehow and assigned to &lt;b&gt;lastProcessedOffset&lt;/b&gt; map upon subscription, or the commit should not happen at all when auto commit is enabled. Just let Kafka handle this and consumers should receive events that arrived since last auto commit.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Shouldn&apos;t the&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (configuration.getAutoCommitEnable()) { &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;be&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!configuration.getAutoCommitEnable()) { &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;instead ?&lt;/p&gt;</comment>
                            <comment id="17506881" author="davsclaus" created="Tue, 15 Mar 2022 12:37:03 +0000"  >&lt;p&gt;Yeah I think that too&lt;/p&gt;

&lt;p&gt;1) Dont commit if offset == -1&lt;br/&gt;
2) Only do this if auto commit is disabled&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=orpiske&quot; class=&quot;user-hover&quot; rel=&quot;orpiske&quot;&gt;orpiske&lt;/a&gt; any thoughts?&lt;/p&gt;</comment>
                            <comment id="17506888" author="orpiske" created="Tue, 15 Mar 2022 12:55:27 +0000"  >&lt;p&gt;I think you all got the analysis correct. In short, I think we can try what Claus suggested (quotting):&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&quot;&lt;/p&gt;

&lt;p&gt;1) Dont commit if offset == -1&lt;br/&gt;
2) Only do this if auto commit is disabled&lt;/p&gt;

&lt;p&gt;&quot;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I&apos;ll take a look at it this week - unless someone wants to go ahead and do the fix.&lt;/p&gt;</comment>
                            <comment id="17506910" author="rgala" created="Tue, 15 Mar 2022 13:33:22 +0000"  >&lt;p&gt;I have made a pull request.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I am also wondering about this part of &lt;b&gt;CommitManagers&lt;/b&gt;:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (configuration.isAutoCommitEnable()) {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-quote&quot;&gt;&quot;async&quot;&lt;/span&gt;.equals(configuration.getAutoCommitOnStop())) {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; AsyncCommitManager(consumer, kafkaConsumer, threadId, printableTopic);
    } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-quote&quot;&gt;&quot;sync&quot;&lt;/span&gt;.equals(configuration.getAutoCommitOnStop())) {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SyncCommitManager(consumer, kafkaConsumer, threadId, printableTopic);
    } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-quote&quot;&gt;&quot;none&quot;&lt;/span&gt;.equals(configuration.getAutoCommitOnStop())) {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; NoopCommitManager(consumer, kafkaConsumer, threadId, printableTopic);
    }
} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Do we really need commit managers in case of auto commit?&lt;/p&gt;</comment>
                            <comment id="17506914" author="orpiske" created="Tue, 15 Mar 2022 13:43:01 +0000"  >&lt;p&gt;Yes we do. We have to manage the &lt;b&gt;autoCommitOnStop&lt;/b&gt;&lt;/p&gt;</comment>
                            <comment id="17506926" author="rgala" created="Tue, 15 Mar 2022 14:13:23 +0000"  >&lt;p&gt;I think the commit is done automatically by Kafka client when the consumer is closed.&lt;/p&gt;</comment>
                            <comment id="17506929" author="orpiske" created="Tue, 15 Mar 2022 14:17:39 +0000"  >&lt;p&gt;&amp;gt; I think the commit is done automatically by Kafka client when the consumer is closed.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;That&apos;s certainly possible (but I wouldn&apos;t know for sure).&lt;/p&gt;

&lt;p&gt;This could be a left-over from when Camel used older clients. If you get a chance, would you mind opening a ticket for us/me to investigate that, please?&lt;/p&gt;</comment>
                            <comment id="17506936" author="rgala" created="Tue, 15 Mar 2022 14:26:44 +0000"  >&lt;p&gt;There you go - &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-17802&quot; title=&quot;Check whether we need to manually commit offset upon stop when auto commit is enabled&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-17802&quot;&gt;&lt;del&gt;CAMEL-17802&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17506979" author="rgala" created="Tue, 15 Mar 2022 15:24:21 +0000"  >&lt;p&gt;I managed to workaround the issue by setting &lt;b&gt;autoCommitOnStop=none&lt;/b&gt;, thanks to this the commit manager does nothing now &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="17506997" author="rgala" created="Tue, 15 Mar 2022 15:45:30 +0000"  >&lt;p&gt;I think that my today&apos;s change should be reconsidered cause it conflicts with the following CommitManager&apos;s part:&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (configuration.isAutoCommitEnable()) {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-quote&quot;&gt;&quot;async&quot;&lt;/span&gt;.equals(configuration.getAutoCommitOnStop())) {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; AsyncCommitManager(consumer, kafkaConsumer, threadId, printableTopic);
    } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-quote&quot;&gt;&quot;sync&quot;&lt;/span&gt;.equals(configuration.getAutoCommitOnStop())) {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SyncCommitManager(consumer, kafkaConsumer, threadId, printableTopic);
    } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-quote&quot;&gt;&quot;none&quot;&lt;/span&gt;.equals(configuration.getAutoCommitOnStop())) {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; NoopCommitManager(consumer, kafkaConsumer, threadId, printableTopic);
    }
} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;because it will cause commit managers to never be used (at least not in &lt;b&gt;PartitionAssignmentListener&lt;/b&gt;) in case of auto commit enabled and the &lt;b&gt;autoCommitOnStop&lt;/b&gt; attribute will not work as designed anymore. I would leave only the -1 check for now until it is confirmed that we do not need manual commits at all when using auto commiting (&lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-17802&quot; title=&quot;Check whether we need to manually commit offset upon stop when auto commit is enabled&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-17802&quot;&gt;&lt;del&gt;CAMEL-17802&lt;/del&gt;&lt;/a&gt;).&lt;/p&gt;</comment>
                            <comment id="17507367" author="davsclaus" created="Wed, 16 Mar 2022 06:30:46 +0000"  >&lt;p&gt;Thanks for reporting and the PR&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13433890">CAMEL-17802</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 35 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z10hm8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>