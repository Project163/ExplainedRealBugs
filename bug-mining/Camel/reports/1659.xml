<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 09:47:40 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-4668] JpaConsumer - Should rollback if processing of an exchange failed</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-4668</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;If a JPA consumer pickup X messages and then one of those messages fails to be processed and throws an exception, then the JPA consumer should detect this and mark the TX as rollback.&lt;/p&gt;

&lt;p&gt;Currently there is a flaw which causes the JPA consumer to commit the batch.&lt;/p&gt;

&lt;p&gt;See nabble&lt;br/&gt;
&lt;a href=&quot;http://camel.465427.n5.nabble.com/Misleading-jmx-statistics-on-jpa-component-tp4960503p4960503.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://camel.465427.n5.nabble.com/Misleading-jmx-statistics-on-jpa-component-tp4960503p4960503.html&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12531128">CAMEL-4668</key>
            <summary>JpaConsumer - Should rollback if processing of an exchange failed</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="davsclaus">Claus Ibsen</reporter>
                        <labels>
                    </labels>
                <created>Fri, 11 Nov 2011 12:46:36 +0000</created>
                <updated>Sun, 13 Nov 2011 13:53:27 +0000</updated>
                            <resolved>Sat, 12 Nov 2011 09:48:09 +0000</resolved>
                                    <version>2.7.4</version>
                    <version>2.8.2</version>
                                    <fixVersion>2.7.5</fixVersion>
                    <fixVersion>2.8.3</fixVersion>
                    <fixVersion>2.9.0</fixVersion>
                                    <component>camel-jpa</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13148497" author="bvahdat" created="Fri, 11 Nov 2011 13:56:39 +0000"  >&lt;p&gt;There&apos;s something baffling me here, which I like to understand/learn how it&apos;s possible that it works!&lt;/p&gt;

&lt;p&gt;Looking at &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; there&apos;s no try/catch or onException(....).handled(true) or the likes on the route, so sending the payload SendEmail(&quot;kaboom@beer.org&quot;) should blow up with a CamelExecutionException wrapping the thrown IllegalArgumentException(&quot;Forced&quot;) through the usage of the template on the client side (in this case the test method testTXRollback()) but it doesn&apos;t!!!&lt;/p&gt;

&lt;p&gt;For sure I&apos;m missing some pieces of this tricky puzzle...&lt;/p&gt;


&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://svn.apache.org/repos/asf/camel/trunk/components/camel-jpa/src/test/java/org/apache/camel/processor/jpa/JpaTXRollbackTest.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/repos/asf/camel/trunk/components/camel-jpa/src/test/java/org/apache/camel/processor/jpa/JpaTXRollbackTest.java&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13148503" author="davsclaus" created="Fri, 11 Nov 2011 14:04:37 +0000"  >&lt;p&gt;Its 2 different things:&lt;br/&gt;
1: The template send 3 messages to INSERT data into the database.&lt;br/&gt;
2: Then the route is started, which starts the consumer, it then pickup the 3 messages. And fail processing the last message. Which forces all 3 to rollback. So when it poll again, it find the 3 messages, and try again etc.&lt;/p&gt;</comment>
                            <comment id="13148505" author="bvahdat" created="Fri, 11 Nov 2011 14:13:43 +0000"  >&lt;p&gt;But if I start the route as the first step in the test method it &lt;b&gt;still&lt;/b&gt; passes:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    @Test
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testTXRollback() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
        &lt;span class=&quot;code-comment&quot;&gt;// start route
&lt;/span&gt;        context.startRoute(&lt;span class=&quot;code-quote&quot;&gt;&quot;foo&quot;&lt;/span&gt;);

        &lt;span class=&quot;code-comment&quot;&gt;// first create three records
&lt;/span&gt;        template.sendBody(&lt;span class=&quot;code-quote&quot;&gt;&quot;jpa:&lt;span class=&quot;code-comment&quot;&gt;//&quot;&lt;/span&gt; + SendEmail.&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;getName(), &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SendEmail(&lt;span class=&quot;code-quote&quot;&gt;&quot;foo@beer.org&quot;&lt;/span&gt;));
&lt;/span&gt;        template.sendBody(&lt;span class=&quot;code-quote&quot;&gt;&quot;jpa:&lt;span class=&quot;code-comment&quot;&gt;//&quot;&lt;/span&gt; + SendEmail.&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;getName(), &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SendEmail(&lt;span class=&quot;code-quote&quot;&gt;&quot;bar@beer.org&quot;&lt;/span&gt;));
&lt;/span&gt;        template.sendBody(&lt;span class=&quot;code-quote&quot;&gt;&quot;jpa:&lt;span class=&quot;code-comment&quot;&gt;//&quot;&lt;/span&gt; + SendEmail.&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;getName(), &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SendEmail(&lt;span class=&quot;code-quote&quot;&gt;&quot;kaboom@beer.org&quot;&lt;/span&gt;));
&lt;/span&gt;
        &lt;span class=&quot;code-comment&quot;&gt;// should rollback the entire
&lt;/span&gt;        MockEndpoint mock = getMockEndpoint(&lt;span class=&quot;code-quote&quot;&gt;&quot;mock:result&quot;&lt;/span&gt;);
        &lt;span class=&quot;code-comment&quot;&gt;// we should retry and &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; again
&lt;/span&gt;        mock.expectedMinimumMessageCount(4);

        assertMockEndpointsSatisfied();

        assertTrue(&lt;span class=&quot;code-quote&quot;&gt;&quot;Should be &amp;gt;= 2, was: &quot;&lt;/span&gt; + foo.intValue(), foo.intValue() &amp;gt;= 2);
        assertTrue(&lt;span class=&quot;code-quote&quot;&gt;&quot;Should be &amp;gt;= 2, was: &quot;&lt;/span&gt; + bar.intValue(), bar.intValue() &amp;gt;= 2);
    }

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And what I&apos;ve learned is that the call at the line:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;template.sendBody(&lt;span class=&quot;code-quote&quot;&gt;&quot;jpa:&lt;span class=&quot;code-comment&quot;&gt;//&quot;&lt;/span&gt; + SendEmail.&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;getName(), &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SendEmail(&lt;span class=&quot;code-quote&quot;&gt;&quot;kaboom@beer.org&quot;&lt;/span&gt;));&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;should at the latest by now blow up with a CamelExecutionException but still it doesn&apos;t!&lt;/p&gt;</comment>
                            <comment id="13149027" author="davsclaus" created="Sat, 12 Nov 2011 09:50:02 +0000"  >&lt;p&gt;Sending to JPA does &lt;b&gt;not&lt;/b&gt; fail. So the 3 template code lines works fine.&lt;/p&gt;

&lt;p&gt;Its the Camel route that fails. The JPA consumer is scheduled, so it will poll again later (after 2sec). And it will keep failing due that hardcoded exception being thrown. But foo and bar records will be fine, but as they are part of the same TX, they will also rollback. So the foo and bar counter will keep incrementing.&lt;/p&gt;</comment>
                            <comment id="13149055" author="preben" created="Sat, 12 Nov 2011 12:17:17 +0000"  >&lt;p&gt;@Claus&lt;/p&gt;

&lt;p&gt;Regarding the jmx statistics I added this to your test:&lt;/p&gt;

&lt;p&gt;        MBeanServer mBeanServer = context.getManagementStrategy().getManagementAgent().getMBeanServer();&lt;br/&gt;
        Set&amp;lt;ObjectName&amp;gt; objNameSet = mBeanServer.queryNames(new ObjectName(&quot;org.apache.camel:type=routes,name=\&quot;foo\&quot;,*&quot;), null);&lt;br/&gt;
        ObjectName managedObjName = new ArrayList&amp;lt;ObjectName&amp;gt;(objNameSet).get(0);&lt;br/&gt;
        Long exchangesCompleted = (Long) mBeanServer.invoke(managedObjName, &quot;getExchangesCompleted&quot;, null, null);&lt;br/&gt;
        Long exchangesFailed = (Long) mBeanServer.invoke(managedObjName, &quot;getExchangesFailed&quot;, null, null);&lt;/p&gt;

&lt;p&gt;        assertTrue(&quot;Should be 0 since they are rolled back, was : &quot; + exchangesCompleted, 0 == exchangesCompleted);&lt;br/&gt;
        assertTrue(&quot;Should be &amp;gt;=2, was: &quot; + exchangesFailed , exchangesFailed &amp;gt;= 2);&lt;/p&gt;

&lt;p&gt;Now the test fails since there are completed exchanges. Shouldn&apos;t the jmx statistics reflect that the exchange actual did not complete (rolled back) as the test implies ?&lt;/p&gt;
</comment>
                            <comment id="13149180" author="bvahdat" created="Sat, 12 Nov 2011 23:14:08 +0000"  >&lt;p&gt;@Claus,&lt;/p&gt;

&lt;p&gt;As Preben tries to push his JMX expectations I insist on my Routing expectations. Really not an easy job for you, but I really appreciate your contribution.&lt;/p&gt;

&lt;p&gt;You said:&lt;/p&gt;

&lt;p&gt;2: Then the route is started, which starts the consumer, it then pickup the 3 messages. And fail processing the last message. Which forces all 3 to rollback. So when it poll again, it find the 3 messages, and try again etc.&lt;/p&gt;

&lt;p&gt;However a slight modification of this test case by me (see the attachment) proves the opposite, that is, after routing is completed there&apos;re &lt;b&gt;3&lt;/b&gt; rows in the table! I&apos;ve a suspection that somewhere along the way the thrown IllegalArgumentException(&quot;Forced&quot;) is simply swallowed!&lt;/p&gt;

&lt;p&gt;Again my expectation is that the call to&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;template.sendBody(&lt;span class=&quot;code-quote&quot;&gt;&quot;jpa:&lt;span class=&quot;code-comment&quot;&gt;//&quot;&lt;/span&gt; + SendEmail.&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;getName(), &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SendEmail(&lt;span class=&quot;code-quote&quot;&gt;&quot;kaboom@beer.org&quot;&lt;/span&gt;));&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Should blow up with a CamelExecutionException, but that&apos;s another story which I still don&apos;t understand &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13149273" author="preben" created="Sun, 13 Nov 2011 10:53:44 +0000"  >&lt;p&gt;@Babak&lt;/p&gt;

&lt;p&gt;When you send using the template the records are inserted in its own tx so they should be committed as base for the test to run, and not rolled back. See attached patch.&lt;/p&gt;

&lt;p&gt;I&apos;m still not happy about the jmx stats though. &lt;/p&gt;</comment>
                            <comment id="13149281" author="bvahdat" created="Sun, 13 Nov 2011 12:07:30 +0000"  >&lt;p&gt;@Prebsen,&lt;/p&gt;

&lt;p&gt;thanks for you comment, but the patch you attached reveals exactly the same behaviour as my attached patch also does, as you added the following assertion:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;List&amp;lt;?&amp;gt; foundSendEmails = jpaTemplate.find(SELECT_ALL_STRING);
assertTrue(&lt;span class=&quot;code-quote&quot;&gt;&quot;Expect table 3 elements in SendEmail, was: &quot;&lt;/span&gt; + foundSendEmails.size(), foundSendEmails.size() == 3);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And this is &lt;b&gt;exactly&lt;/b&gt; what I do &lt;b&gt;NOT&lt;/b&gt; expect. Apparently according to what Claus said, the transaction should have been &lt;b&gt;rollbacked&lt;/b&gt;. So after the routing of those 3 payloads completes the transaction through the spring&apos;s JpaTransactionManager should have been &lt;b&gt;rollbacked&lt;/b&gt;, &lt;b&gt;but it&apos;s NOT&lt;/b&gt;, as there&apos;re three rows on that table having the addresses &apos;foo@beer.org&apos;, &apos;bar@beer.org&apos;, and &apos;kaboom@beer.org&apos;.&lt;/p&gt;

&lt;p&gt;Maybe it&apos;s because of my poor english why I don&apos;t get the point. Anyone available who could explain it to me in german, or may be even better in my mother tongue persian &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Thanks anyway.&lt;/p&gt;</comment>
                            <comment id="13149288" author="bvahdat" created="Sun, 13 Nov 2011 13:53:27 +0000"  >&lt;p&gt;O.K. it took long for me to get the point but now I&apos;ve got it! Sorry for my misapprehension. &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12503507" name="JpaTXRollbackTest.patch" size="2204" author="bvahdat" created="Sat, 12 Nov 2011 23:14:27 +0000"/>
                            <attachment id="12503529" name="JpaTXRollbackTest2.patch" size="2966" author="preben" created="Sun, 13 Nov 2011 10:54:48 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>216866</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 2 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i022cv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9983</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>