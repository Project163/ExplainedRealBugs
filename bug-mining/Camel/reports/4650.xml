<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:31:30 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-12830] FTP producer stuck if timeout occurs just after connect</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-12830</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;In our production systems, we had several threads stuck indefinitely while trying to send a file to an FtpEndpoint. We had both &lt;em&gt;connectTimeout&lt;/em&gt; and &lt;em&gt;soTimeout&lt;/em&gt; properties set so it surprised us a little bit.&lt;/p&gt;

&lt;p&gt;After digging a bit, we found that the scenario is quite simple to reproduce: this happens every time the &lt;tt&gt;FTPClient&lt;/tt&gt;&#160;establishes the TCP connection with a server that does not respond anything.&lt;/p&gt;

&lt;p&gt;Here is a simplified view of what happens when establishing a connection using a &lt;tt&gt;FTPClient&lt;/tt&gt;:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// within Socket Client
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void connect(InetAddress host, &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; port) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; SocketException,IOException {
    _socket_.connect(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; InetSocketAddress(host, port), connectTimeout);
    _connectAction_();
}
&lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; void _connectAction_() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException { 
    _socket_.setSoTimeout(_timeout_); &lt;span class=&quot;code-comment&quot;&gt;// _timeout_ is the &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt; timeout of the socket
&lt;/span&gt;}

&lt;span class=&quot;code-comment&quot;&gt;// overridden within FTP
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; void _connectAction_() {
    &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;._connectAction_();
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (connectTimeout &amp;gt; 0) {
        &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; original = _socket_.getSoTimeout();
        _socket_.setSoTimeout(connectTimeout);
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            __getReply();
        } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
             _socket_.setSoTimeout(original);
        }
    }
}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;A&#160;&lt;tt&gt;SocketTimeoutException&lt;/tt&gt; can be thrown either during the initial socket &lt;em&gt;connect&lt;/em&gt; action, either during the __&lt;em&gt;getReply()&lt;/em&gt; where the FTPClient waits for the hello message from the server.&#160; Both are using&#160;&lt;em&gt;connectTimeout&lt;/em&gt;, after which the original (default) timeout is restored.&#160;The &lt;em&gt;soTimeout&lt;/em&gt;&#160;we specified in the URI is configured by FTPOperations only when the connection is successful. In this case, the Socket is connected, but an exception is thrown afterwards and the &lt;em&gt;soTimeout&lt;/em&gt; is left at 0.&#160;&lt;/p&gt;

&lt;p&gt;Within Camel, when the RemoteFileProducer encounters an exception while processing an Exchange, it tries&#160;to disconnect the endpoint properly with a &lt;em&gt;logout&lt;/em&gt; followed by a &lt;em&gt;disconnect&lt;/em&gt;.&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// RemoteFileProducer
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void handleFailedWrite(Exchange exchange, Exception exception) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (getOperations().isConnected()) { &lt;span class=&quot;code-comment&quot;&gt;// &amp;lt;== in our &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; returns &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; because the socket is actually connected
&lt;/span&gt;            getOperations().disconnect();
        }
    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (...) {
        ...
    }
}
&lt;span class=&quot;code-comment&quot;&gt;// FTPOperations
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; void doDisconnect() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; GenericFileOperationFailedException {
    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
        client.logout();
    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException e) {
         &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; GenericFileOperationFailedException
    } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            client.disconnect();
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException e) {
            &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; GenericFileOperationFailedException
        }
    }
}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Unfortunately, at this point, the &lt;tt&gt;client.logout()&lt;/tt&gt; sends the FTP &lt;tt&gt;QUIT&lt;/tt&gt;&#160;command, then waits for the response still using the default timeout of the Socket. Since the misbehaving server/firewall never sent any form of response, the thread is left waiting forever.&lt;/p&gt;

&lt;p&gt;I attached a simple test case to illustrate the scenario, simply using a ServerSocket that never accepts any connection. Also included is an easy workaround that uses a custom FTPClient on which the &lt;em&gt;default timeout&lt;/em&gt; is set.&#160;&lt;/p&gt;

&lt;p&gt;A possible fix would be to always set the &lt;em&gt;default timeout&lt;/em&gt; on the socket, before connecting it.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13187062">CAMEL-12830</key>
            <summary>FTP producer stuck if timeout occurs just after connect</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="acosentino">Andrea Cosentino</assignee>
                                    <reporter username="lchdev">Laurent Chiarello</reporter>
                        <labels>
                    </labels>
                <created>Mon, 24 Sep 2018 15:19:55 +0000</created>
                <updated>Tue, 2 Oct 2018 07:08:26 +0000</updated>
                            <resolved>Tue, 2 Oct 2018 07:08:26 +0000</resolved>
                                    <version>2.22.1</version>
                                    <fixVersion>2.22.2</fixVersion>
                    <fixVersion>2.23.0</fixVersion>
                                    <component>camel-ftp</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="16626225" author="davsclaus" created="Mon, 24 Sep 2018 18:31:42 +0000"  >&lt;p&gt;Thanks for reporting. Can you maybe add a patch file with your suggested fix, or as a github PR&lt;/p&gt;</comment>
                            <comment id="16628622" author="lchdev" created="Wed, 26 Sep 2018 11:35:07 +0000"  >&lt;p&gt;The suggestion I made was more a workaround than a true fix. I attached a patch with another fix that tackles the true issue: a &lt;em&gt;logout&lt;/em&gt; should not be performed if the &lt;em&gt;connect&lt;/em&gt; was not successful.&lt;/p&gt;

&lt;p&gt;If an exception is raised during the &lt;em&gt;connect&lt;/em&gt; of the &lt;tt&gt;FtpClient&lt;/tt&gt;, a &lt;em&gt;disconnect&lt;/em&gt; should be issued to ensure that the underlying &lt;tt&gt;Socket&lt;/tt&gt;&#160;is properly closed and disposed. This also avoids potential resources leaks (in the situation of a server accepting connections without sending FTP replies, each reconnect attempt created and connected a new Socket without closing the previous one).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12941377" name="FtpOperations.patch" size="1060" author="lchdev" created="Wed, 26 Sep 2018 11:28:29 +0000"/>
                            <attachment id="12941065" name="FtpSoTimeoutTest.java" size="2815" author="lchdev" created="Mon, 24 Sep 2018 15:29:58 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 7 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3yfe7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>