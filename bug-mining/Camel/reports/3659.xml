<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:16:20 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-6256] Camel xmpp dynamic router is not sending incoming messages to openfire upon first failed groupchatroom join</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-6256</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;Reference : &lt;a href=&quot;http://camel.465427.n5.nabble.com/Camel-xmpp-dynamic-router-is-not-connecting-to-openfire-td5730506.html#a5730537&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://camel.465427.n5.nabble.com/Camel-xmpp-dynamic-router-is-not-connecting-to-openfire-td5730506.html#a5730537&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-xml&quot;&gt; 
&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;camel:route id=&lt;span class=&quot;code-quote&quot;&gt;&quot;eventSubscriber&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;
                        &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;camel:from uri=&lt;span class=&quot;code-quote&quot;&gt;&quot;ref:eventReceiverUri&quot;&lt;/span&gt; /&amp;gt;&lt;/span&gt;
                         &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;camel:dynamicRouter&amp;gt;&lt;/span&gt;                  
                    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;camel:method ref=&lt;span class=&quot;code-quote&quot;&gt;&quot;eventRouterBean&quot;&lt;/span&gt; method=&lt;span class=&quot;code-quote&quot;&gt;&quot;processEvent&quot;&lt;/span&gt;/&amp;gt;&lt;/span&gt;
                &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/camel:dynamicRouter&amp;gt;&lt;/span&gt;
                &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/camel:route&amp;gt;&lt;/span&gt; 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In eventRouterBean&apos;s processEvent method, we are building xmpp groupchat room url depending upon the message and forwading the same message into respective groupchatrooms. &lt;br/&gt;
If resulting groupchat room is not existing, it will log message &lt;br/&gt;
WARN 2013-04-05 17:55:48,190 (UnitOfWorkProcessor.java processAsync:162) - Caught unhandled exception while processing ExchangeId: ID-INGBTCPIC8NB038-63130-1365164745141-0-3 &lt;br/&gt;
org.apache.camel.FailedToCreateProducerException: Failed to create Producer for endpoint: Endpoint&lt;span class=&quot;error&quot;&gt;&amp;#91;xmpp://&amp;lt;ip&amp;gt;:5222/?password=******&amp;amp;resource=zone_4fc100e4-d004-4a0b-a7e2-7cf910585af6_51&amp;amp;room=zone_4fc100e4-d004-4a0b-a7e2-7cf910585af6_51%40conference.test.com&amp;amp;serviceName=ispf.com&amp;amp;user=messagepublisher%40test.com&amp;#93;&lt;/span&gt;. Reason: not-allowed(405) &lt;br/&gt;
        at org.apache.camel.impl.ProducerCache.doGetProducer(ProducerCache.java:395) &lt;br/&gt;
        at org.apache.camel.impl.ProducerCache.doInAsyncProducer(ProducerCache.java:278) &lt;br/&gt;
        at org.apache.camel.processor.RoutingSlip.processExchange(RoutingSlip.java:280) &lt;br/&gt;
        at org.apache.camel.processor.RoutingSlip.doRoutingSlip(RoutingSlip.java:205) &lt;br/&gt;
        at org.apache.camel.processor.RoutingSlip.process(RoutingSlip.java:135) &lt;br/&gt;
        at org.apache.camel.util.AsyncProcessorHelper.process(AsyncProcessorHelper.java:73) &lt;br/&gt;
        at org.apache.camel.processor.DelegateAsyncProcessor.processNext(DelegateAsyncProcessor.java:99) &lt;br/&gt;
        at org.apache.camel.processor.DelegateAsyncProcessor.process(DelegateAsyncProcessor.java:90) &lt;br/&gt;
        at org.apache.camel.management.InstrumentationProcessor.process(InstrumentationProcessor.java:73) &lt;br/&gt;
        at org.apache.camel.util.AsyncProcessorHelper.process(AsyncProcessorHelper.java:73) &lt;br/&gt;
and ...... &lt;br/&gt;
Caused by: not-allowed(405) &lt;br/&gt;
        at org.jivesoftware.smackx.muc.MultiUserChat.join(MultiUserChat.java:501) &lt;br/&gt;
        at org.apache.camel.component.xmpp.XmppGroupChatProducer.doStart(XmppGroupChatProducer.java:84) &lt;br/&gt;
        at org.apache.camel.support.ServiceSupport.start(ServiceSupport.java:60) &lt;br/&gt;
        at org.apache.camel.util.ServiceHelper.startService(ServiceHelper.java:62) &lt;br/&gt;
        at org.apache.camel.impl.ProducerCache.doGetProducer(ProducerCache.java:393) &lt;br/&gt;
        ... 40 more &lt;/p&gt;

&lt;p&gt;This is still fine. &lt;br/&gt;
But issue is if I create a groupchat room in openfire, it should forward new incoming message to same groupchat room. But it is not forwarding.&lt;br/&gt;
It is keep on logging error message as &apos;Not connected to the server&apos; repeatedly for all messages.&lt;/p&gt;

&lt;p&gt;But if I restart the camel context, then it starts working. &lt;br/&gt;
Looks like it is caching url and its connection as not allowed in dynamic router. &lt;br/&gt;
What will be the solution? &lt;br/&gt;
And even the exception is thowing at ProducerCache.doGetProducer().. &lt;br/&gt;
So how to clear cache for failed connections?&lt;/p&gt;
</description>
                <environment>&lt;p&gt;camel xmpp routing with openfire xmpp server.  Used groupchat configurations&lt;/p&gt;</environment>
        <key id="12641635">CAMEL-6256</key>
            <summary>Camel xmpp dynamic router is not sending incoming messages to openfire upon first failed groupchatroom join</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="pshetty.kateel">Prakash Shetty</reporter>
                        <labels>
                            <label>connection</label>
                            <label>groupchat</label>
                            <label>xmpp</label>
                    </labels>
                <created>Tue, 9 Apr 2013 14:57:28 +0000</created>
                <updated>Thu, 28 Apr 2016 14:05:32 +0000</updated>
                            <resolved>Thu, 28 Apr 2016 14:05:32 +0000</resolved>
                                    <version>2.10.3</version>
                                    <fixVersion>2.16.4</fixVersion>
                    <fixVersion>2.17.1</fixVersion>
                    <fixVersion>2.18.0</fixVersion>
                                    <component>camel-xmpp</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13626687" author="pshetty.kateel" created="Tue, 9 Apr 2013 15:01:50 +0000"  >&lt;p&gt;I just debugged using source code. &lt;br/&gt;
It looks like bug in XmppEndpoint.createConnection method. &lt;/p&gt;

&lt;p&gt;If no groupchat room is avalilable, then XmppGroupChatProducer&apos;s method doStart;  chat.join() statement will throw exception. &lt;br/&gt;
Upon this exception, ServiceSupport.stop() is trggered. This triggers XmppGroupChatProducer&apos;s doStop() method.  Here it disconnects the connection and sets to null. Till here pretty much ok. &lt;br/&gt;
But XmppEndpoint&apos;s connection variable still holds the old connection object and it is in disconnected and unauthorised state. &lt;/p&gt;

&lt;p&gt;For next successive messages, XmppEndpoint.createConnection will return the old connection object, but it is in disconnected state.&lt;br/&gt;
Because of this, always we will have connection with disconnected and unauthenticated state. &lt;br/&gt;
So I feel &apos;createConnection&apos; not only need to check  for null, but also it should also check for connected state and authenticated state. &lt;/p&gt;


&lt;p&gt;If anyone feels &apos;XmppEndpoint.createConnection&apos; is very much correct, then we need to modify XMPPGroupChatProducer&apos;s doStart() or doStop() method. &lt;/p&gt;

&lt;p&gt;I still feel need to correct XmppEndpoint.createConnection  method changes. &lt;/p&gt;

&lt;p&gt;&amp;#8212;&lt;br/&gt;
Exception is thrown for 2nd and later messages at  chat = new MultiUserChat(connection, room); statement of XmppGroupChatProducer&apos;s doStart() method. &lt;br/&gt;
Exception says &apos;Not connected to the server&apos;. So It means that we need to reconnect and authenticate it if disconnected from earlier unit of work.&lt;/p&gt;
</comment>
                            <comment id="13632772" author="pshetty.kateel" created="Tue, 16 Apr 2013 11:39:47 +0000"  >&lt;p&gt;I just observed the codebase at head vesrion of  &lt;a href=&quot;https://svn.apache.org/repos/asf/camel/trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/repos/asf/camel/trunk&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Here I can see the code changes as below.&lt;/p&gt;

&lt;p&gt;File : org.apache.camel.component.xmpp.XmppEndpoint&lt;br/&gt;
Method : public synchronized XMPPConnection createConnection()&lt;br/&gt;
Changes : if (connection != null &amp;amp;&amp;amp; connection.isConnected()) {       FROM     if (connection != null) {&lt;/p&gt;

&lt;p&gt;Looks like, this change will fix this defect, I feel.   Need to test more.&lt;/p&gt;

&lt;p&gt;Will this changes  go for Camel 2.11.0 release?&lt;br/&gt;
I tried to download src from &lt;a href=&quot;http://apache.techartifact.com/mirror/camel/apache-camel/2.11.0/apache-camel-2.11.0-src.zip&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://apache.techartifact.com/mirror/camel/apache-camel/2.11.0/apache-camel-2.11.0-src.zip&lt;/a&gt; to verify the inclusion of this changes.&lt;br/&gt;
But link is not working yet.&lt;/p&gt;


</comment>
                            <comment id="13632918" author="njiang" created="Tue, 16 Apr 2013 15:17:10 +0000"  >&lt;p&gt;Hi Prakash&lt;/p&gt;

&lt;p&gt;I just checked the change log of XmppEndpoint, the change is introduced by the patch of &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-4224&quot; title=&quot;Add Lazy Connection to XMPP&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-4224&quot;&gt;&lt;del&gt;CAMEL-4224&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
This change will be part of camel 2.11.0.&lt;/p&gt;</comment>
                            <comment id="13633842" author="pshetty.kateel" created="Wed, 17 Apr 2013 07:03:07 +0000"  >&lt;p&gt;Thanks Willem for update.&lt;/p&gt;

&lt;p&gt;I took only org.apache.camel.component.xmpp.XmppEndpoint class and testing my application.  It works fine and it is getting reconnected successfully and I can send messages 2nd time onwards.&lt;/p&gt;

&lt;p&gt;But one more issue poped up.&lt;br/&gt;
On restarting of Openfire XMPP server and recreation of same group chat room, the connection is not re-joining to the particular groupchat room, but connection is really connected and authenticated.&lt;/p&gt;

&lt;p&gt;I can see the following error code in Openfire server.&lt;br/&gt;
 &amp;lt;error code=&quot;406&quot; type=&quot;modify&quot;&amp;gt;&amp;lt;not-acceptable xmlns=&quot;urn:ietf:params:xml:ns:xmpp-stanzas&quot;/&amp;gt;&amp;lt;/error&amp;gt;&amp;lt;/message&amp;gt;&lt;br/&gt;
This comes generally, when user is not joined the groupchatroom.&lt;/p&gt;

&lt;p&gt;I debuged the code.  Following is the observation:&lt;br/&gt;
In ProducerCache&apos;s doGetProducer method, it will return old &apos;XmppGroupCHatProducer&apos; through statement Producer answer = producers.get(key);&lt;br/&gt;
It is always not null even after XMPP restart.  So it wont create new producer and it wont call ServiceHelper.startService(answer);  So XmppGroupCHatProducer&apos;s doStart() wont be called.&lt;br/&gt;
One more strange thing is org.jivesoftware.smackx.muc.MultiUserChat&apos;s isJoined is always true, event if connection is no joined the room. So we cannot use this flag also to rejoin.&lt;/p&gt;

&lt;p&gt;I am not sure how to solve this.&lt;br/&gt;
This issue is on 2.10.3&lt;/p&gt;

&lt;p&gt;I feel, I need to check with whole new 2.11.0 codebase.&lt;/p&gt;

&lt;p&gt;Or I probably need to raise one more defect..&lt;/p&gt;

</comment>
                            <comment id="13633851" author="pshetty.kateel" created="Wed, 17 Apr 2013 07:15:51 +0000"  >&lt;p&gt;Also note that, on restarting of Openfire, we are deleting groupchat rooms.  I mean we are creating non-Persistent chat rooms. So it goes off on restart and our application will recreate based on user request dynamically. &lt;br/&gt;
That is the reason we are using dynamic router and also creating dynamic resource for same user in xmpp connection url to avoid &apos;Already logged in&apos; error.&lt;/p&gt;</comment>
                            <comment id="15262188" author="davsclaus" created="Thu, 28 Apr 2016 14:05:32 +0000"  >&lt;p&gt;The stale connection is not kept anymore, but only a working connection is set to be used.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10062"><![CDATA[Moderate]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>322051</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 29 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1jkdj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>322396</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>